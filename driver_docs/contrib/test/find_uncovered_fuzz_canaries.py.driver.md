# Purpose
This Python script is designed to analyze code coverage, specifically focusing on identifying "canaries" within a codebase that have not been covered by fuzz testing. The script is intended to be run from the top of a repository and processes one or more lcov files, which are coverage data files generated by tools like gcov. The script identifies lines in the source code marked with a specific tag (`FD_FUZZ_MUST_BE_COVERED`) and checks if these lines have been executed during fuzz testing. If any of these lines, referred to as "canaries," remain uncovered, the script outputs warnings indicating the file and line number of each uncovered canary.

The script is structured around several key components. It defines a `Canary` class to represent a canary's file and line number. The [`find_canaries`](#find_canaries) function uses the `grep` command to locate all instances of the canary tag in the source code, excluding certain files. The [`eliminate_canaries_with_lcov`](#eliminate_canaries_with_lcov) function processes each lcov file to determine which canaries have been covered by tests. The script also includes a check for a specific "canary canary" file to ensure the tool's integrity. If this file is not found as uncovered, the script exits with an error, indicating a failure in the tool's operation. The script is designed to be executed as a standalone script, taking lcov file paths as command-line arguments.
# Imports and Dependencies

---
- `collections.defaultdict`
- `functools`
- `os`
- `subprocess`
- `sys`


# Global Variables

---
### canary\_canary\_path
- **Type**: `string`
- **Description**: The variable `canary_canary_path` is a string that holds the file path to a specific C source file, 'src/util/sanitize/test_fuzz_canary_canary.c'. This file is likely used as a test or marker within the codebase to ensure certain functionalities are working correctly.
- **Use**: This variable is used to verify the presence of a 'canary' in the specified file, ensuring the tool's functionality is intact.


# Classes

---
### Canary<!-- {{#class:firedancer/contrib/test/find_uncovered_fuzz_canaries.Canary}} -->
- **Members**:
    - `file`: The file attribute stores the name of the file where the canary is located.
    - `linum`: The linum attribute stores the line number within the file where the canary is found.
- **Description**: The Canary class is a simple data structure used to represent a 'canary' in the source code, which is identified by a specific file and line number. It is primarily used to track and manage code coverage in the context of fuzz testing, helping to identify parts of the code that must be covered by tests. Instances of this class are created with a file name and a line number, which are stored as instance variables.
- **Methods**:
    - [`firedancer/contrib/test/find_uncovered_fuzz_canaries.Canary.__init__`](#Canary__init__)

**Methods**

---
#### Canary\.\_\_init\_\_<!-- {{#callable:firedancer/contrib/test/find_uncovered_fuzz_canaries.Canary.__init__}} -->
The `__init__` method initializes a `Canary` object with a file name and line number.
- **Inputs**:
    - `file`: The name of the file associated with the canary.
    - `linum`: The line number in the file where the canary is located.
- **Control Flow**:
    - Assigns the input parameter `file` to the instance variable `self.file`.
    - Assigns the input parameter `linum` to the instance variable `self.linum`.
- **Output**: This method does not return any value; it initializes the instance variables of the `Canary` object.
- **See also**: [`firedancer/contrib/test/find_uncovered_fuzz_canaries.Canary`](#Canary)  (Base Class)



# Functions

---
### main<!-- {{#callable:firedancer/contrib/test/find_uncovered_fuzz_canaries.main}} -->
The `main` function processes a list of lcov files to identify and report source code lines marked as 'canaries' that are not covered by fuzz testing.
- **Inputs**:
    - `lcov_files`: A list of file paths to lcov files that contain coverage data.
- **Control Flow**:
    - Invoke [`find_canaries`](#find_canaries) to retrieve a list of canaries, which are instances of the `Canary` class representing lines in source files that must be covered.
    - Use `functools.reduce` with a helper function `add` to transform the list of canaries into a dictionary mapping file names to sets of line numbers.
    - Print the number of canaries found and their distribution across files.
    - Iterate over each lcov file path in `lcov_files`, calling [`eliminate_canaries_with_lcov`](#eliminate_canaries_with_lcov) to update the dictionary by removing covered canaries.
    - Check if the special 'canary canary' is present in the live canaries; if not, print an error message and exit with a failure code.
    - Remove the 'canary canary' from the live canaries dictionary.
    - Filter out any files from the live canaries dictionary that have no uncovered canaries remaining.
    - Print a message if no uncovered canaries remain, otherwise print warnings for each uncovered canary.
- **Output**: The function does not return a value; it prints messages to the console indicating the status of canaries and exits the program if a critical error is detected.
- **Functions called**:
    - [`firedancer/contrib/test/find_uncovered_fuzz_canaries.find_canaries`](#find_canaries)
    - [`firedancer/contrib/test/find_uncovered_fuzz_canaries.eliminate_canaries_with_lcov`](#eliminate_canaries_with_lcov)


---
### find\_canaries<!-- {{#callable:firedancer/contrib/test/find_uncovered_fuzz_canaries.find_canaries}} -->
The `find_canaries` function searches for specific markers in source files and returns their locations as Canary objects.
- **Inputs**: None
- **Control Flow**:
    - Define a command to search for the string 'FD_FUZZ_MUST_BE_COVERED' in source files, excluding 'fd_fuzz.h'.
    - Execute the command using `subprocess.run` to capture the output.
    - Split the command output into lines and iterate over each line.
    - For each line, split it into components to extract the file name and line number.
    - Create a [`Canary`](#Canary) object for each line and append it to the `output_tokens` list.
    - Return the list of [`Canary`](#Canary) objects.
    - If an error occurs during command execution, catch the exception and return an error message.
- **Output**: A list of [`Canary`](#Canary) objects representing the file names and line numbers where the specified marker is found, or an error message if the command fails.
- **Functions called**:
    - [`firedancer/contrib/test/find_uncovered_fuzz_canaries.Canary`](#Canary)


---
### eliminate\_canaries\_with\_lcov<!-- {{#callable:firedancer/contrib/test/find_uncovered_fuzz_canaries.eliminate_canaries_with_lcov}} -->
The function `eliminate_canaries_with_lcov` processes an lcov file to identify and return canaries that are not covered by tests.
- **Inputs**:
    - `path_to_lcov`: The file path to the lcov file that needs to be processed.
    - `canaries`: A dictionary mapping file names to sets of line numbers representing canaries that need to be checked for coverage.
- **Control Flow**:
    - Prints the path of the lcov file being processed.
    - Retrieves the current working directory.
    - Opens the lcov file for reading.
    - Initializes loop state variables `node_of_interest` and `source_path` to `None`.
    - Enters a loop to read each line of the lcov file until the end of the file is reached.
    - If a line starts with 'SF:', it extracts the source file path, makes it relative to the current working directory, and updates `node_of_interest` to the corresponding set of line numbers from `canaries`.
    - If a line starts with 'end_of_context', it resets `source_path` and `node_of_interest` to `None`.
    - If a line starts with 'DA:' and `node_of_interest` is not `None`, it splits the line to get the line number and hit count.
    - If the hit count is not zero, it removes the line number from `node_of_interest`.
    - Continues the loop until all lines are processed.
    - Returns the updated `canaries` dictionary.
- **Output**: The function returns the updated `canaries` dictionary, with line numbers removed for lines that are covered according to the lcov file.


