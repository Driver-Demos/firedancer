<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a gRPC server with authentication and block engine validation services, including command handling and stream management.

# Purpose
This Rust code defines a gRPC server that provides services for authentication and block engine validation. The server implements two main interfaces: `AuthService` and `BlockEngineValidator`. The `AuthService` interface includes methods for generating authentication challenges and tokens, as well as refreshing access tokens. The `BlockEngineValidator` interface provides methods for subscribing to packet and bundle streams and retrieving block builder fee information. The server uses the `tonic` library to handle gRPC communication and the `tokio` library for asynchronous operations.

The code also includes a command-line interface (CLI) that allows users to interact with the server through a read-eval-print loop (REPL). The CLI supports commands such as `help`, `exit`, `kill-streams`, and `kill-server`, which provide information, terminate the server, or manage active streams. The server runs on a separate thread, and the CLI operates on the main thread, allowing users to issue commands while the server is running. The server listens on a specified socket address and can restart itself upon receiving a kill signal. The code uses several external crates, including `futures`, `log`, `prost_types`, and `rustyline`, to facilitate asynchronous operations, logging, protocol buffer handling, and command-line input, respectively.
# Imports and Dependencies

---
- `std::pin::Pin`
- `crate::proto::auth::auth_service_server::AuthService`
- `crate::proto::auth::auth_service_server::AuthServiceServer`
- `crate::proto::auth`
- `crate::proto::bundle::Bundle`
- `crate::proto::bundle::BundleUuid`
- `crate::proto::packet::Packet`
- `crate::proto::packet::PacketBatch`
- `base64::prelude::*`
- `chrono::Duration`
- `chrono::Utc`
- `futures::select`
- `futures::FutureExt`
- `futures_util::stream::Stream`
- `log::info`
- `prost_types::Timestamp`
- `rustyline::error::ReadlineError`
- `rustyline::DefaultEditor`
- `std::net::SocketAddr`
- `std::sync::Arc`
- `tokio::sync::broadcast`
- `tokio::sync::mpsc`
- `tonic::transport::Server`
- `tonic::Request`
- `tonic::Response`
- `tonic::Status`
- `crate::proto::block_engine::block_engine_validator_server::BlockEngineValidator`
- `crate::proto::block_engine::block_engine_validator_server::BlockEngineValidatorServer`
- `crate::proto::block_engine::BlockBuilderFeeInfoRequest`
- `crate::proto::block_engine::BlockBuilderFeeInfoResponse`
- `crate::proto::block_engine::SubscribeBundlesRequest`
- `crate::proto::block_engine::SubscribeBundlesResponse`
- `crate::proto::block_engine::SubscribePacketsRequest`
- `crate::proto::block_engine::SubscribePacketsResponse`
- `tokio_stream::wrappers::ReceiverStream`
- `bs58::encode`
- `std::process::exit`
- `std::thread::spawn`
- `tokio::runtime::Builder`
- `env_logger::Builder`
- `env_logger::Env`


# Data Structures

---
### Cnc
- **Type**: `struct`
- **Members**:
    - ``kill_streams_tx``: A `broadcast::Sender` used to send kill signals to active streams.
    - ``kill_server_tx``: A `broadcast::Sender` used to send kill signals to the server.
- **Description**: Manages control signals for terminating streams and restarting the server. It contains two broadcast channels, `kill_streams_tx` and `kill_server_tx`, which send signals to terminate active streams and restart the server, respectively.


---
### Service
- **Type**: `struct`
- **Members**:
    - ``kill_streams``: A `broadcast::Receiver` that receives kill signals for streams.
- **Description**: Manages the lifecycle of streams by using a `broadcast::Receiver` to listen for termination signals. This struct is part of a gRPC server implementation that handles packet and bundle subscriptions, as well as authentication services.


---
### ServiceHandle
- **Type**: `struct`
- **Members**:
    - `0`: Holds an `Arc<Service>` which provides shared ownership of a `Service` instance.
- **Description**: Encapsulates a handle to a `Service` instance, allowing for shared access and manipulation of the service's state and behavior. Implements the `BlockEngineValidator` and `AuthService` traits to provide gRPC service functionalities.
- **Trait Bounds**:
    - Clone

**Methods**

---
#### ServiceHandle::generate\_auth\_challenge
Generates an authentication challenge response for a given request.
- **Inputs**:
    - `&self`: A reference to the `ServiceHandle` instance.
    - `request`: A `Request` object containing a `GenerateAuthChallengeRequest` with the public key data.
- **Logic and Control Flow**:
    - Extracts the inner `GenerateAuthChallengeRequest` from the `request` object.
    - Logs the received public key using base58 encoding.
    - Creates a `GenerateAuthChallengeResponse` with a static challenge string '012345678'.
    - Wraps the response in a `Response` object and returns it.
- **Output**: A `Result` containing a `Response` with a `GenerateAuthChallengeResponse` or a `Status` error.


---
#### ServiceHandle::generate\_auth\_tokens
Generates authentication tokens with expiration timestamps.
- **Inputs**:
    - `&self`: A reference to the `ServiceHandle` instance.
    - `_request`: A `Request` object containing a `GenerateAuthTokensRequest`.
- **Logic and Control Flow**:
    - Create an `access_token` with a value of "token" and an expiration time 60 seconds from the current UTC time.
    - Create a `refresh_token` with a value of "token" and an expiration time 60 seconds from the current UTC time.
    - Return a `GenerateAuthTokensResponse` containing the `access_token` and `refresh_token`.
- **Output**: A `Result` containing a `Response` with a `GenerateAuthTokensResponse` object, or a `Status` error.


---
#### ServiceHandle::get\_block\_builder\_fee\_info
Returns a `BlockBuilderFeeInfoResponse` with predefined commission and public key values.
- **Inputs**:
    - `&self`: A reference to the `ServiceHandle` instance.
    - `_request`: A `Request` object containing a `BlockBuilderFeeInfoRequest`, which is not used in the method.
- **Logic and Control Flow**:
    - Create a `BlockBuilderFeeInfoResponse` with a commission of 5 and a predefined public key.
    - Return the response wrapped in a `Result` with `Ok`.
- **Output**: A `Result` containing a `Response` with a `BlockBuilderFeeInfoResponse`.


---
#### ServiceHandle::refresh\_access\_token
Generates a new access token with a fixed value and expiration time.
- **Inputs**:
    - `&self`: A reference to the `ServiceHandle` instance.
    - `_request`: A `Request` object containing a `RefreshAccessTokenRequest`, which is not used in the method.
- **Logic and Control Flow**:
    - Create a `RefreshAccessTokenResponse` with a new `Token` object.
    - Set the `value` of the `Token` to a fixed string "012345678".
    - Set the `expires_at_utc` of the `Token` to the current UTC time plus 60 seconds.
    - Return the `RefreshAccessTokenResponse` wrapped in a `Response` object.
- **Output**: A `Result` containing a `Response` with a `RefreshAccessTokenResponse` that includes a new access token.


---
#### ServiceHandle::subscribe\_bundles
Streams bundles to clients until a termination signal is received.
- **Inputs**:
    - `&self`: A reference to the `ServiceHandle` instance, which contains the `kill_streams` receiver for managing stream termination.
    - `_request`: A `Request` object containing a `SubscribeBundlesRequest`, which is not used in the method.
- **Logic and Control Flow**:
    - Create a new subscription to the `kill_streams` broadcast channel to listen for termination signals.
    - Create a new mpsc channel with a buffer size of 16 to send `SubscribeBundlesResponse` messages.
    - Spawn a new asynchronous task to handle the streaming of bundles.
    - Log the start of the bundle stream.
    - Create a `SubscribeBundlesResponse` message containing a list of `BundleUuid` objects, each with a `Bundle` containing `Packet` data decoded from base64.
    - Enter a loop where the task waits for either a termination signal from `kill_streams` or a successful send of the `SubscribeBundlesResponse` message to the mpsc channel.
    - Break the loop if a termination signal is received or if sending the message fails.
    - Log the stop of the bundle stream after exiting the loop.
    - Return a `Response` containing a pinned `ReceiverStream` wrapping the mpsc receiver.
- **Output**: A `Result` containing a `Response` with a `SubscribeBundlesStream`, or a `Status` error if the operation fails.


---
#### ServiceHandle::subscribe\_packets
Streams packets to a client until a termination signal is received.
- **Inputs**:
    - `&self`: A reference to the `ServiceHandle` instance, which contains the `kill_streams` receiver for managing stream termination.
    - `_request`: A `Request` object containing a `SubscribePacketsRequest`, which is not used in the method.
- **Logic and Control Flow**:
    - Resubscribe to the `kill_streams` broadcast channel to receive termination signals.
    - Create a new mpsc channel with a buffer size of 16 for sending packet responses.
    - Spawn a new asynchronous task to handle the packet streaming logic.
    - Log the start of the packet stream.
    - Create a `SubscribePacketsResponse` message containing a batch of packets with predefined data.
    - Enter a loop where it waits for either a termination signal from `kill_streams` or attempts to send the packet response through the mpsc channel.
    - Break the loop if a termination signal is received or if sending the packet response fails.
    - Log the stop of the packet stream after exiting the loop.
    - Return a `Response` containing a pinned `ReceiverStream` that wraps the mpsc receiver.
- **Output**: A `Result` containing a `Response` with a `SubscribePacketsStream`, which is a stream of `SubscribePacketsResponse` messages.



# Functions

---
### handle\_line
Processes a command line input and executes corresponding actions for a control server.
- **Inputs**:
    - `cnc`: A mutable reference to a `Cnc` struct, which contains broadcast senders for controlling streams and server operations.
    - `line`: A string slice representing the command line input to process.
- **Logic and Control Flow**:
    - Match the input `line` against predefined command strings.
    - If `line` is an empty string, return `false`.
    - If `line` is "help", print available commands and return `true`.
    - If `line` is "exit" or "quit", print an exit message and terminate the process.
    - If `line` is "kill-streams", send a kill signal to all active streams using `cnc.kill_streams_tx`.
    - If `line` is "kill-server", send a kill signal to restart the server using `cnc.kill_server_tx`.
    - For any other command, print an unknown command message and return `false`.
- **Output**: Returns a boolean indicating whether the command was successfully processed and executed.


---
### main
Initializes the logging system, sets up communication channels, spawns a gRPC server thread, and runs a command-line interface for server control.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize the logging system using `env_logger` with a default filter level of 'info'.
    - Create two broadcast channels: `kill_streams_tx`/`kill_streams_rx` and `kill_server_tx`/`kill_server_rx` for controlling streams and server shutdowns.
    - Create a `Cnc` struct instance to manage the broadcast channels.
    - Spawn a new thread to run the gRPC server using `tokio` runtime, passing the `ServiceHandle` and the server address.
    - In the main thread, initialize a `DefaultEditor` for command-line input and handle potential errors.
    - Enter a loop to read and process command-line input using `handle_line` function, adding valid commands to the history.
    - Handle `ReadlineError` cases for interruption or EOF by exiting the process.
    - If an unexpected error occurs during line reading, panic with the error message.
- **Output**: No return value; the function runs indefinitely until the process exits.


---
### run\_server
Runs a gRPC server with shutdown and restart capabilities, handling block engine validation and authentication services.
- **Inputs**:
    - `service`: A `ServiceHandle` instance that provides the gRPC services to be added to the server.
    - `listen_addr`: A `SocketAddr` specifying the address and port on which the server will listen.
    - `kill_signal`: A `broadcast::Receiver` used to receive shutdown signals for the server.
- **Logic and Control Flow**:
    - Enter an infinite loop to continuously run the server.
    - Within the loop, create a gRPC server using `Server::builder()` and add the `BlockEngineValidatorServer` and `AuthServiceServer` services using the provided `service` handle.
    - Use `serve_with_shutdown` to start the server on the specified `listen_addr` and listen for shutdown signals from `kill_signal`.
    - Await the server's completion and handle any errors with `unwrap()`.
    - Log a message indicating the server is restarting after shutdown.
- **Output**: No return value; the function runs the server indefinitely until a shutdown signal is received.



---
Made with ❤️ by [Driver](https://www.driver.ai/)