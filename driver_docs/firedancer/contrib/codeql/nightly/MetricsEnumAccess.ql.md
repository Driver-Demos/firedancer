<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Detects issues with FD_METRICS_ENUM_%_CNT and FD_METRICS_ENUM_%_IDX macros in array accesses.

# Purpose
The code is a static analysis tool designed to identify issues related to the use of specific macros for array accesses in C++ code. It focuses on macros of the form `FD_METRICS_ENUM_%_CNT` and `FD_METRICS_ENUM_%_IDX`, which are used to define and access metrics arrays. The tool checks for potential problems such as mismatched count values, out-of-bounds array accesses, and inconsistencies between index macros and their associated count macros.

Key components of the code include classes and predicates that match and analyze different types of macros and array expressions. The `FdMetricsTypeMacro`, `FdMetricsCountMacro`, `FdMetricsEnumCountMacro`, and `FdMetricsEnumIndexMacro` classes are used to identify and extract information from specific macro patterns. The `MetricsArray` and `MetricsEnumAccess` classes are used to match array variable declarations and array expressions that use these macros. The code also defines predicates like `isMismatchedCount`, `isArrayAccessOob`, and `isMismatchedEnumName` to determine if there are any discrepancies or errors in the use of these macros.

The tool uses these components to generate warnings when it detects issues, such as when the index value is greater than the array size, when the count value does not match the array size, or when the enum name in the index macro does not match the one associated with the count macro. The output of the analysis provides detailed descriptions of these issues, helping developers to identify and correct potential errors in their code.
# Imports and Dependencies

---
- `cpp`
- `semmle.code.cpp.dataflow.new.DataFlow`


# Data Structures

---
### FdMetricsTypeMacro
- **Type**: ``class``
- **Members**:
    - ``FdMetricsTypeMacro``: Matches macros of the form `FD_METRICS_TYPE_<TYPE>` where `<TYPE>` is a string representing the metric type.
- **Description**: Represents a macro class that identifies and processes macros of the form `FD_METRICS_TYPE_<TYPE>`, where `<TYPE>` is a string that specifies the type of metric, such as `GAUGE` or `COUNTER`. The class provides a method to extract the type from the macro name using regular expression matching.


---
### FdMetricsCountMacro
- **Type**: ``abstract class``
- **Members**:
    - ``getAnEnumName``: Returns the enum name if the macro is associated with an enum.
- **Description**: Represents an abstract class that matches macros of the form `FD_METRICS_<???>_CNT`, which are used in array accesses. It provides an abstract method `getAnEnumName` to retrieve the enum name associated with the macro, if applicable. This class serves as a base for more specific macro classes that handle different types of metrics count macros.


---
### FdMetricsTypeCountMacro
- **Type**: ``class``
- **Members**:
    - ``type``: A string representing the metric type extracted from the macro name.
    - ``groupMeasurement``: A string representing the group measurement extracted from the macro name.
- **Description**: Represents macros of the form `FD_METRICS_<TYPE>_<???>_CNT`, where `<TYPE>` is derived from `FdMetricsTypeMacro` and does not include enums. It extracts the metric type and group measurement from the macro name and provides a method to get the associated enum name if the macro is linked to an enum.


---
### FdMetricsEnumCountMacro
- **Type**: ``class``
- **Members**:
    - ``FdMetricsEnumCountMacro``: Matches macros of the form `FD_METRICS_ENUM_<ENUM_NAME>_CNT`.
- **Description**: The `FdMetricsEnumCountMacro` class extends the `FdMetricsCountMacro` class and is used to match macros that follow the pattern `FD_METRICS_ENUM_<ENUM_NAME>_CNT`. It overrides the `getAnEnumName` method to extract and return the enum name from the macro's name using a regular expression.


---
### FdMetricsEnumIndexMacro
- **Type**: `class`
- **Members**:
    - `FdMetricsEnumIndexMacro`: Matches macros of the form `FD_METRICS_ENUM_<ENUM_NAME>_IDX`.
    - `getEnumName`: Extracts the enum name from the macro name using a regular expression.
    - `asCnt`: Returns an `FdMetricsEnumCountMacro` object that has the same enum name as this macro.
- **Description**: Represents a class that matches and processes macros of the form `FD_METRICS_ENUM_<ENUM_NAME>_IDX`, which are used to index arrays in a metrics context. The class provides methods to extract the enum name from the macro and to relate the index macro to its corresponding count macro, ensuring that the index and count macros are consistent with each other.


---
### FdDeclareMetricEnumMacro
- **Type**: ``class``
- **Members**:
    - `FdDeclareMetricEnumMacro`: Represents a macro that matches the `DECLARE_METRIC_ENUM` macro.
- **Description**: Represents a macro class that identifies and matches the `DECLARE_METRIC_ENUM` macro in the code. This class is used to facilitate the handling and processing of metric enumeration declarations within the codebase, allowing for the identification and manipulation of these specific macro invocations.


---
### FdDeclareMetricEnumInvocation
- **Type**: ``class``
- **Members**:
    - ``FdDeclareMetricEnumInvocation``: Matches invocations of the `DECLARE_METRIC_ENUM` macro.
    - ``getGroupMeasurement``: Returns the unexpanded argument at index 0 of the macro invocation.
    - ``getType``: Returns the unexpanded argument at index 1 of the macro invocation.
    - ``getEnumName``: Returns the unexpanded argument at index 2 of the macro invocation.
- **Description**: Represents a class that matches invocations of the `DECLARE_METRIC_ENUM` macro, providing methods to retrieve the group measurement, type, and enum name from the macro's arguments.


---
### ArrayVariable
- **Type**: ``class``
- **Members**:
    - ``ArrayVariable``: Matches variable declarations of array type.
- **Description**: `ArrayVariable` is a class that extends the `Variable` class and is used to identify variable declarations that are of an array type. It serves as a base class for other classes that need to work with array variables, particularly in the context of metrics and macro usage.


---
### MetricsArray
- **Type**: ``class``
- **Members**:
    - ``macro``: A member of type `FdMetricsCountMacro` that represents the macro used in the array size expression.
- **Description**: Represents a variable declaration of array type that is used in metrics, specifically focusing on the association with `FdMetricsCountMacro` macros. The `MetricsArray` class identifies the macro used in the array size expression by examining the literals following the field declaration and checking if they are arguments to the correct macro invocation. It provides methods to retrieve the usage of the array and the macro associated with a specific dimension.


---
### MetricsEnumAccess
- **Type**: ``class``
- **Members**:
    - ``macro``: Holds a reference to an `FdMetricsCountMacro` object.
- **Description**: Represents an array expression that uses `FD_METRICS_ENUM_<METRIC>_IDX` macros as their index or where the index is bounded by a `FD_METRICS_<???>_CNT` macro. It checks for the existence of an `FdMetricsEnumIndexMacro` or a less-than expression (`LTExpr`) to determine the macro used for indexing. The `getMacro` method returns the associated `FdMetricsCountMacro` object.


# Functions

---
### getValue
Extracts an integer value from a string using a regular expression.
- **Inputs**:
    - ``s``: A string from which the function extracts an integer value.
- **Logic and Control Flow**:
    - Uses the `regexpCapture` method on the input string `s` to find a sequence of digits.
    - Captures the first group of digits found in the string.
    - Converts the captured string of digits to an integer using `toInt()`.
- **Output**: An integer extracted from the input string `s`.


---
### getDimension
Calculates the 0-based dimension of an array access expression.
- **Inputs**:
    - `e`: An `ArrayExpr` object representing the array access expression.
- **Logic and Control Flow**:
    - Check if the base of the array expression `e` is an instance of `ArrayExpr`.
    - If true, recursively call `getDimension` on the base of the array expression and add 1 to the result.
    - If false, set the result to 0.
- **Output**: An integer representing the 0-based dimension of the array access expression.


---
### getNumArrayDimensions
Calculates the 1-based number of dimensions of an array type.
- **Inputs**:
    - ``at``: An `ArrayType` object representing the type of the array whose dimensions are to be calculated.
- **Logic and Control Flow**:
    - Check if the base type of `at` is an instance of `ArrayType`.
    - If true, recursively call `getNumArrayDimensions` on the base type and add 1 to the result.
    - If false, return 1.
- **Output**: An integer representing the 1-based number of dimensions of the array type.


---
### nextLiteral
Finds the next `Literal` element that appears after a given `Element` in the source code.
- **Inputs**:
    - `l`: An `Element` object representing a location in the source code.
- **Logic and Control Flow**:
    - Uses a `min` function to find the `Literal` element `li` that appears after the location of `Element` `l`.
    - The `afterElement` predicate checks if `li` is textually after `l` by comparing their file, start line, and start column.
    - Orders the `Literal` elements by their start line and start column to find the next one after `l`.
    - Assigns the result to the `Literal` element that is found.
- **Output**: A `Literal` object that is the next literal element after the given `Element` `l`.


---
### nthLiteralAfterVariable
Finds the nth literal after a given array variable declaration.
- **Inputs**:
    - ``v``: An `ArrayVariable` object representing the array variable after which the function will find the nth literal.
    - ``n``: An integer representing the position of the literal to find after the array variable.
- **Logic and Control Flow**:
    - If `n` is 0, the function assigns the result to the next literal after the variable `v` using the `nextLiteral` function.
    - If `n` is greater than 0, the function recursively calls itself with `n` decremented by 1 to find the next literal after the result of the previous call.
    - The function ensures that `n` is less than the number of dimensions of the array type of `v` using the `getNumArrayDimensions` function.
- **Output**: A `Literal` object that is the nth literal after the specified array variable.


---
### afterElement
Determines if an element `e` starts strictly after a location `f` in the same file.
- **Inputs**:
    - ``f``: A `Location` object representing the starting point to compare against.
    - ``e``: An `Element` object whose starting position is compared to `f`.
- **Logic and Control Flow**:
    - Check if the file of `e` is the same as the file of `f` using `e.getLocation().getFile() = f.getFile()`.
    - Verify that the starting line of `e` is greater than or equal to the starting line of `f` using `e.getLocation().getStartLine() >= f.getStartLine()`.
    - Ensure that the starting column of `e` is greater than the starting column of `f` using `e.getLocation().getStartColumn() > f.getStartColumn()`.
- **Output**: A boolean value indicating whether `e` starts strictly after `f` textually.


---
### getType
Extracts the metric type from a macro name of the form `FD_METRICS_TYPE_<TYPE>`.
- **Inputs**:
    - `this`: The current instance of the `FdMetricsTypeMacro` class.
- **Logic and Control Flow**:
    - Use the `regexpCapture` method on the macro name to extract the metric type.
    - The regular expression `FD_METRICS_TYPE_(.*)` captures the metric type part of the macro name.
    - Return the captured metric type as a string.
- **Output**: A string representing the metric type extracted from the macro name.


---
### getAnEnumName
Retrieves the enum name associated with a macro if the macro is linked to an enum.
- **Inputs**:
    - `None`: This function does not take any input arguments.
- **Logic and Control Flow**:
    - The function is defined as an abstract method in the `FdMetricsCountMacro` class.
    - The `FdMetricsTypeCountMacro` class provides an implementation of this function.
    - In `FdMetricsTypeCountMacro`, the function checks for the existence of an `FdDeclareMetricEnumInvocation` instance where the enum name, type, and group measurement match the current macro's properties.
    - If such an instance exists, the function returns the enum name from the `FdDeclareMetricEnumInvocation`.
    - The `FdMetricsEnumCountMacro` class also provides an implementation of this function.
    - In `FdMetricsEnumCountMacro`, the function uses a regular expression to extract the enum name from the macro's name.
- **Output**: The function returns a string representing the enum name if the macro is associated with an enum; otherwise, it returns nothing.


---
### getGroupMeasurement
Processes array expressions to identify issues with index and count macros in metrics.
- **Inputs**:
    - `access`: An `ArrayExpr` object representing the array access expression.
    - `des`: A string variable used to store the description of the issue found with the array access.
- **Logic and Control Flow**:
    - Checks if the array access is out of bounds using the `isArrayAccessOob` predicate.
    - If out of bounds, sets `des` to a message indicating the index value is greater than the array size.
    - Checks if there is a mismatched count using the `isMismatchedCount` predicate.
    - If mismatched count, sets `des` to a message indicating the count value does not match the array size.
    - Checks if there is a mismatched enum name using the `isMismatchedEnumName` predicate.
    - If mismatched enum name, sets `des` to a message indicating the enum name in the index macro does not match the one in the count macro.
    - Selects the `access` and `des` for output if any of the conditions are met.
- **Output**: A selection of `access` and `des` where `des` contains a description of the issue found with the array access.


---
### getEnumName
Extracts the enum name from a macro of the form `FD_METRICS_ENUM_<ENUM_NAME>_IDX`.
- **Inputs**:
    - `None`: This function does not take any explicit input parameters.
- **Logic and Control Flow**:
    - Uses the `regexpCapture` method to match and extract the enum name from the macro name.
    - The regular expression `FD_METRICS_ENUM_(.*?)_V_.*$` is used to capture the enum name part of the macro.
- **Output**: Returns a string representing the extracted enum name.


---
### getAUsage
Retrieves an array expression usage based on a specified dimension.
- **Inputs**:
    - `dimension`: An integer representing the dimension of the array access to retrieve.
- **Logic and Control Flow**:
    - The function checks if the array access expression matches the specified dimension by comparing it with the result of `getDimension`.
    - It uses `getAnAccess` to find the array base expression and ensures the dimension matches the input `dimension`.
- **Output**: An `ArrayExpr` object that represents the array usage at the specified dimension.


---
### getMacro
Retrieves the macro associated with a specific dimension of a metrics array.
- **Inputs**:
    - `dimension`: An integer representing the dimension of the array for which the macro is to be retrieved.
- **Logic and Control Flow**:
    - Calls the `nthLiteralAfterVariable` function with the current object and the given `dimension` to find the literal associated with the macro invocation expression.
    - Assigns the result of the macro invocation expression to the `result` variable.
- **Output**: Returns an `FdMetricsCountMacro` object that represents the macro associated with the specified dimension of the array.


---
### isMismatchedCount
Checks if the CNT value associated with a MetricsEnumAccess does not match the array size of the accessed array.
- **Inputs**:
    - `a`: A `MetricsEnumAccess` object representing an array access expression.
- **Logic and Control Flow**:
    - Get the CNT value from the macro body of the `MetricsEnumAccess` using `getValue(a.getMacro().getBody())`.
    - Get the array size from the type of the array base of `a` using `a.getArrayBase().getType().(ArrayType).getArraySize()`.
    - Compare the CNT value with the array size to determine if they are not equal.
- **Output**: A boolean value indicating whether the CNT value does not match the array size.


---
### isArrayAccessOob
Checks if the index used in an array expression is out of bounds for the array being accessed.
- **Inputs**:
    - ``access``: An `ArrayExpr` object representing the array access expression to check for out-of-bounds access.
- **Logic and Control Flow**:
    - The function checks if there exists a `MetricsArray` `e`, a dimension `dimension`, an enum array size `enumArraySize`, and an array index `arrayIndex` such that:
    - `dimension` is the dimension of the `access` array expression.
    - The value of the array offset in `access` is equal to `arrayIndex`.
    - The value of the macro body for the `dimension` of `e` is equal to `enumArraySize`.
    - The usage of `e` at `dimension` is equal to `access`.
    - The `enumArraySize` is less than or equal to `arrayIndex`.
- **Output**: A boolean value indicating whether the index used in the array expression is out of bounds.


---
### isMismatchedEnumName
Checks if the index used in a `MetricsEnumAccess` does not match any metric array definition's associated enum name.
- **Inputs**:
    - `a`: A `MetricsEnumAccess` object representing an array expression that uses `FD_METRICS_ENUM_<METRIC>_IDX` macros as their index or where the index is bounded by a `FD_METRICS_<???>_CNT` macro.
- **Logic and Control Flow**:
    - Get the dimension of the array expression `a` using `getDimension(a)`.
    - Check if there exists a `MetricsArray` `e` such that `e.getAUsage(dimension) = a` and `e.getMacro(dimension).getAnEnumName() = a.getMacro().getAnEnumName()`.
    - If no such `MetricsArray` exists, the predicate holds true, indicating a mismatch.
- **Output**: A boolean value indicating whether the index used in `a` does not match any metric array definition's associated enum name.



---
Made with ❤️ by [Driver](https://www.driver.ai/)