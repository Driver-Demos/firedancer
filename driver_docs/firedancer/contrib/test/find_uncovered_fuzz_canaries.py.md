<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Script to identify uncovered fuzz canaries in source code using lcov coverage data.

# Purpose
This script is a utility for analyzing code coverage, specifically focusing on identifying "canaries" in source code files. A "canary" in this context is a marker or line of code that must be covered by fuzz testing. The script reads coverage data from LCOV files and checks which canaries have not been covered by tests. It uses the `grep` command to search for canaries marked with `FD_FUZZ_MUST_BE_COVERED` in the source directory, excluding certain files. The script then processes each LCOV file to determine which canaries remain uncovered, reporting these as warnings.

The script defines a `Canary` class to represent canaries with their file and line number. The [`find_canaries`](<#find_canaries>) function searches for canaries in the source code, while the [`eliminate_canaries_with_lcov`](<#eliminate_canaries_with_lcov>) function processes LCOV files to filter out covered canaries. The script checks for a specific "canary canary" to ensure the tool's correctness. If this canary is not found as uncovered, the script exits with an error. The script is intended to be run from the command line, taking LCOV file paths as arguments, and outputs warnings for any canaries not yet covered by fuzzing.
# Imports and Dependencies

---
- `collections.defaultdict`
- `functools`
- `os`
- `subprocess`
- `sys`


# Global Variables

---
### canary\_canary\_path
- **Type**: ``str``
- **Description**: A string that specifies the file path to a specific C source file used in the canary detection process. This path is used to verify the presence of a 'canary canary' in the source code.
- **Use**: Used to check if the 'canary canary' is found as uncovered in the source code, indicating the tool's functionality.


# Classes

---
### Canary<!-- {{#class:firedancer/contrib/test/find_uncovered_fuzz_canaries.Canary}} -->
[View Source →](<../../../../contrib/test/find_uncovered_fuzz_canaries.py#L52>)

- **Members**:
    - `file`: Stores the file name associated with the canary.
    - `linum`: Stores the line number in the file where the canary is located.
- **Description**: Represents a canary with a file name and line number, used to track specific lines in source files that must be covered by fuzz testing.
- **Methods**:
    - [`firedancer/contrib/test/find_uncovered_fuzz_canaries.Canary.__init__`](<#canary__init__>)

**Methods**

---
#### Canary\.\_\_init\_\_<!-- {{#callable:firedancer/contrib/test/find_uncovered_fuzz_canaries.Canary.__init__}} -->
[View Source →](<../../../../contrib/test/find_uncovered_fuzz_canaries.py#L53>)

Initializes a `Canary` object with a file name and line number.
- **Inputs**:
    - `file`: The name of the file associated with the canary.
    - `linum`: The line number in the file where the canary is located.
- **Logic and Control Flow**:
    - Assigns the input `file` to the instance variable `self.file`.
    - Assigns the input `linum` to the instance variable `self.linum`.
- **Output**: No output is returned; the method initializes the instance variables of the `Canary` object.
- **See also**: [`firedancer/contrib/test/find_uncovered_fuzz_canaries.Canary`](<#canary>)  (Base Class)



# Functions

---
### main<!-- {{#callable:firedancer/contrib/test/find_uncovered_fuzz_canaries.main}} -->
[View Source →](<../../../../contrib/test/find_uncovered_fuzz_canaries.py#L14>)

Processes a list of lcov files to identify and report uncovered canaries in source code.
- **Inputs**:
    - `lcov_files`: A list of file paths to lcov files that contain coverage data.
- **Logic and Control Flow**:
    - Calls [`find_canaries`](<#find_canaries>) to retrieve a list of canaries from the source code.
    - Uses `functools.reduce` to transform the list of canaries into a dictionary mapping file names to sets of line numbers where canaries are found.
    - Prints the number of canaries found and their locations.
    - Iterates over each lcov file path in `lcov_files` and calls [`eliminate_canaries_with_lcov`](<#eliminate_canaries_with_lcov>) to update the dictionary by removing covered canaries.
    - Checks if the special canary at `canary_canary_path` is uncovered; if not, prints an error message and exits with status 1.
    - Removes the special canary from the dictionary of live canaries.
    - Filters out files with no uncovered canaries from the dictionary.
    - Prints a message if no uncovered canaries remain, otherwise prints warnings for each uncovered canary.
- **Output**: Prints information about uncovered canaries and exits with status 1 if the special canary is not found.
- **Functions Called**:
    - [`firedancer/contrib/test/find_uncovered_fuzz_canaries.find_canaries`](<#find_canaries>)
    - [`firedancer/contrib/test/find_uncovered_fuzz_canaries.eliminate_canaries_with_lcov`](<#eliminate_canaries_with_lcov>)


---
### find\_canaries<!-- {{#callable:firedancer/contrib/test/find_uncovered_fuzz_canaries.find_canaries}} -->
[View Source →](<../../../../contrib/test/find_uncovered_fuzz_canaries.py#L57>)

Searches for occurrences of the string 'FD_FUZZ_MUST_BE_COVERED' in source files and returns their file names and line numbers as Canary objects.
- **Inputs**: None
- **Logic and Control Flow**:
    - Define a command to search for the string 'FD_FUZZ_MUST_BE_COVERED' in the 'src/' directory, excluding 'fd_fuzz.h'.
    - Execute the command using `subprocess.run` with output captured in `stdout`.
    - Split the command output into lines and iterate over each line.
    - For each line, split it into components using ':' as a delimiter to extract the file name and line number.
    - Create a [`Canary`](<#canary>) object for each line and append it to the `output_tokens` list.
    - Return the list of [`Canary`](<#canary>) objects.
    - If a `subprocess.CalledProcessError` occurs, return an error message with the exception details.
- **Output**: A list of [`Canary`](<#canary>) objects, each containing the file name and line number where the string 'FD_FUZZ_MUST_BE_COVERED' is found, or an error message if the command fails.
- **Functions Called**:
    - [`firedancer/contrib/test/find_uncovered_fuzz_canaries.Canary`](<#canary>)


---
### eliminate\_canaries\_with\_lcov<!-- {{#callable:firedancer/contrib/test/find_uncovered_fuzz_canaries.eliminate_canaries_with_lcov}} -->
[View Source →](<../../../../contrib/test/find_uncovered_fuzz_canaries.py#L80>)

Reads an lcov file and returns canaries that were not covered.
- **Inputs**:
    - `path_to_lcov`: The file path to the lcov file to process.
    - `canaries`: A dictionary mapping file names to sets of line numbers representing canaries.
- **Logic and Control Flow**:
    - Prints the path of the lcov file being processed.
    - Gets the current working directory and opens the lcov file for reading.
    - Initializes `node_of_interest` and `source_path` to track the current state while reading the file.
    - Reads each line of the lcov file in a loop until the end of the file is reached.
    - If a line starts with `SF:`, extracts the source file path and updates `node_of_interest` with the corresponding canaries.
    - If a line starts with `end_of_context`, resets `source_path` and `node_of_interest` to `None`.
    - If a line starts with `DA:`, checks if the line is covered by examining the hit count.
    - If the hit count is not zero, removes the line number from `node_of_interest`.
    - Returns the updated `canaries` dictionary.
- **Output**: The updated `canaries` dictionary with uncovered canaries removed.



---
Made with ❤️ by [Driver](https://www.driver.ai/)