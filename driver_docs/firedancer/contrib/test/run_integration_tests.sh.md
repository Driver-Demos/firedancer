<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

A Bash script to sequentially run integration tests with logging and error handling.

# Purpose
The `run_integration_tests.sh` script is a Bash executable designed to run integration tests sequentially. It reads command-line arguments to specify test files and verbosity, and it ensures that only one integration test runs at a time. The script manages test execution by dispatching tests as jobs, tracking their process IDs, and logging their outputs. It uses a Makefile to determine the correct build directory if no specific tests are provided. The script also handles cleanup of processes and logs the results of each test, indicating success or failure.
# Global Variables

---
### TESTS
- **Type**: `string`
- **Description**: The `TESTS` variable is a global string variable that stores the path to a file containing a list of integration tests to run. It is initially set to an empty string and can be modified by the `--tests` command-line argument.
- **Use**: Stores the path to a file with integration tests to execute.


---
### VERBOSE
- **Type**: `integer`
- **Description**: The `VERBOSE` variable is an integer that controls the verbosity level of the script's output. It is set to 0 by default, indicating that verbose output is disabled.
- **Use**: Used to enable verbose output when the '-v' flag is provided in the command-line arguments.


---
### AVAILABLE\_JOBS
- **Type**: `integer`
- **Description**: Defines the maximum number of jobs that can run concurrently. It is set to 1, which means only one job can run at a time.
- **Use**: Used to control the concurrency of job scheduling, ensuring that only one job is executed at any given time.


---
### PIDS
- **Type**: ``declare -A``
- **Description**: Stores the process IDs (PIDs) of child processes that are spawned during the execution of integration tests. This associative array maps each PID to itself, effectively keeping track of all active child processes.
- **Use**: Used to manage and track the lifecycle of child processes during test execution.


---
### PID2UNIT
- **Type**: ``declare -A``
- **Description**: Maps process IDs (PIDs) to their corresponding unit names. This associative array is used to track which unit (or program) is associated with each running process.
- **Use**: Used to remember the unit name of each PID for tracking and logging purposes during test execution.


---
### PID2LOG
- **Type**: ``declare -A``
- **Description**: `PID2LOG` is an associative array that maps process IDs (PIDs) to their corresponding log file names. It is used to track the log file associated with each child process that is spawned during the execution of integration tests.
- **Use**: Stores the log file name for each process ID to facilitate logging and debugging of integration tests.


---
### TEST\_LIST
- **Type**: ``array``
- **Description**: Contains a list of integration tests to be scheduled and executed sequentially. The list is populated by reading from a file specified by the `TESTS` variable, excluding lines that are comments.
- **Use**: Used to store and manage the sequence of integration tests to be executed by the script.


---
### FAIL\_CNT
- **Type**: `integer`
- **Description**: `FAIL_CNT` is a global integer variable that tracks the number of failed integration tests during the execution of the script.
- **Use**: Used to count and report the number of test failures, incrementing each time a test fails.


# Functions

---
### rc\_path
Generates a file path for a process-specific return code file in the `/tmp` directory.
- **Inputs**:
    - ``$1``: The process identifier (PID) for which to generate the return code file path.
- **Logic and Control Flow**:
    - The function takes a single argument, which is the process identifier (PID).
    - It constructs a file path string in the format `/tmp/.pid-<PID>.rc`.
    - The function outputs this constructed file path.
- **Output**: A string representing the file path for the return code file associated with the given PID.


---
### runner
Executes a given program with logging and coverage setup, capturing its exit status and execution time.
- **Inputs**:
    - ``prog``: The path to the program to execute.
    - ``log``: The path to the log file where the program's stderr output will be saved.
    - ``...``: Additional arguments to pass to the program.
- **Logic and Control Flow**:
    - Assigns the current process ID to `pid` and extracts the program name from `prog`.
    - Creates a directory for coverage data and sets up a coverage file path using `LLVM_PROFILE_FILE`.
    - Executes the program with `sudo`, redirecting its stderr to `log` and stdout to `/dev/null`, while capturing the execution time using the `time` command.
    - Stores the program's exit status in `ret` and the elapsed time in `elapsed`.
    - Writes the exit status and elapsed time to a file at the path returned by `rc_path` using the process ID.
- **Output**: The function does not return a value, but it writes the program's exit status and elapsed time to a file.


---
### dispatch
Dispatches a program to run as a background process and tracks its execution details.
- **Inputs**:
    - `prog`: The path to the program to execute.
    - `...`: Additional command-line arguments to pass to the program.
- **Logic and Control Flow**:
    - Extracts the program name from the provided path.
    - Creates a log directory based on the program's path and name.
    - Generates a log file with a timestamp in the log directory.
    - If verbose mode is enabled, prints a message indicating the program being dispatched.
    - Calls the `runner` function to execute the program in the background, passing the program path, log file, and additional arguments.
    - Stores the process ID (PID) of the background process in the `PIDS` associative array.
    - Maps the PID to the program name and log file in the `PID2UNIT` and `PID2LOG` associative arrays, respectively.
- **Output**: There is no direct output from the function itself, but it starts a background process and updates global associative arrays with the process details.


---
### sow
Schedules tasks until the maximum concurrency is reached.
- **Inputs**: None
- **Logic and Control Flow**:
    - Checks if `TEST_LIST` is empty or if `AVAILABLE_JOBS` is zero; if either condition is true, the function returns immediately.
    - Retrieves the first test from `TEST_LIST` and removes it from the list.
    - Decrements `AVAILABLE_JOBS` by one to indicate a job is being scheduled.
    - Calls the `dispatch` function with the test to schedule it for execution.
- **Output**: No direct output; modifies global state by scheduling a test for execution.


---
### reap
Waits for a job to finish and processes its completion status.
- **Inputs**: None
- **Logic and Control Flow**:
    - Waits for any job in the `PIDS` array to finish using `wait -n`.
    - Iterates over each process ID in the `PIDS` array to check if the process has finished by verifying the absence of its directory in `/proc`.
    - For each finished job, reads the return code and elapsed time from the corresponding `.rc` file.
    - Retrieves the unit name and log file path associated with the finished process ID.
    - Removes the finished process ID from the `PIDS`, `PID2UNIT`, and `PID2LOG` arrays.
    - Increments the `AVAILABLE_JOBS` counter to indicate a free job slot.
    - If the return code is non-zero, increments the `FAIL_CNT` counter, prints a failure message with the elapsed time, unit name, return code, and log file path, and displays the log content excluding lines containing 'Log at'.
    - If the return code is zero, prints a success message with the elapsed time and unit name.
- **Output**: No direct output; modifies global state by updating job tracking arrays and counters, and prints job completion status to standard error.



---
Made with ❤️ by [Driver](https://www.driver.ai/)