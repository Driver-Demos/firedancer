<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Generates a PDF report analyzing repair mechanisms in a testnet run, using CSV data and logs.

# Purpose
The script is designed to generate a PDF report analyzing repair mechanisms during a testnet run. It processes log files and CSV data generated from a testnet execution to produce a detailed analysis of repair efficiency, peer statistics, and slot completion times. The script requires specific CSV files (`request_data.csv`, `shred_data.csv`, `fec_complete.csv`) and a log file as inputs. It uses these files to extract and analyze data related to slot repair times, peer performance, and turbine shred timelines.

The script includes several functions that perform specific analyses, such as [`execution_stats`](<#execution_stats>) for extracting key execution events from logs, [`long_slots`](<#long_slots>) for identifying problematic slots, and [`completion_times`](<#completion_times>) for analyzing FEC completion times. It also generates visualizations like heatmaps and scatter plots to illustrate repair efficiency and shred timelines. The script is intended to be run as a standalone tool, and it outputs a comprehensive PDF report (`report.pdf`) that includes all the analyses and visualizations. The script can automatically detect the most recent log and CSV files if no arguments are provided, simplifying its use.
# Imports and Dependencies

---
- `pandas`
- `numpy`
- `seaborn`
- `matplotlib.pyplot`
- `matplotlib.backends.backend_pdf.PdfPages`
- `sys`
- `warnings`
- `os`
- `datetime.datetime`
- `re`
- `matplotlib.ticker.MultipleLocator`
- `matplotlib.ticker.AutoMinorLocator`
- `glob`


# Functions

---
### create\_title\_page<!-- {{#callable:firedancer/contrib/repair-analysis/report.create_title_page}} -->
[View Source →](<../../../../contrib/repair-analysis/report.py#L34>)

Generates a title page for a PDF report with a title, subtitle, section descriptions, credits, and a timestamp.
- **Inputs**:
    - `pdf`: A `PdfPages` object where the title page will be saved.
- **Logic and Control Flow**:
    - Creates a figure with a white background using `matplotlib`.
    - Adds a main title and a subtitle to the figure using `plt.text`.
    - Defines a list of sections with titles and descriptions.
    - Iterates over the sections to add each section title and description to the figure.
    - Adds additional text for data source and developer credits.
    - Retrieves the current date and time, formats it, and adds it to the figure.
    - Disables the axis display using `plt.axis('off')`.
    - Saves the figure to the provided `pdf` object using `pdf.savefig`.
    - Closes the figure using `plt.close(fig)` to free up resources.
- **Output**: A title page is added to the provided `PdfPages` object.


---
### execution\_stats<!-- {{#callable:firedancer/contrib/repair-analysis/report.execution_stats}} -->
[View Source →](<../../../../contrib/repair-analysis/report.py#L106>)

Parses a log file to extract and display execution statistics related to turbine slots and snapshots, and calculates timing differences if applicable.
- **Inputs**:
    - `log_path`: Path to the log file to read and parse.
    - `pdf`: PDF object where the report will be saved.
- **Logic and Control Flow**:
    - Prints a header for execution statistics.
    - Initializes variables to store key execution timeline markers.
    - Reads the log file into memory and parses it line by line to extract information about the first turbine slot, snapshot slot, and their timestamps.
    - If the first turbine slot is found, it breaks the loop after capturing its execution timestamp.
    - Parses the log file in reverse to find the last executed slot efficiently.
    - If automatic parsing fails to find necessary information, prompts the user to input missing data manually.
    - Displays the extracted execution timeline information.
    - If the first turbine execution timestamp is available, calculates the time difference between snapshot loading and first turbine execution.
    - Returns the first turbine slot, snapshot slot, and last executed slot.
- **Output**: Returns a tuple containing the first turbine slot, snapshot slot, and last executed slot.


---
### long\_slots<!-- {{#callable:firedancer/contrib/repair-analysis/report.long_slots}} -->
[View Source →](<../../../../contrib/repair-analysis/report.py#L170>)

Analyzes and reports on slots that take between 410-500ms to complete, focusing on shred arrival patterns and potential delays.
- **Inputs**:
    - `slot_completion`: A DataFrame containing slot completion times and related data.
    - `shreds_data`: A DataFrame containing data about shreds, including their timestamps and whether they are turbine shreds.
    - `first_turbine`: An integer representing the first turbine slot number.
- **Logic and Control Flow**:
    - Prints a header indicating the start of long slot analysis.
    - Resets the index of `slot_completion` and filters it to find slots with completion times between 410-500ms, focusing on slots after `first_turbine`.
    - Iterates over each identified long slot to print statistics about turbine and repair shreds received for that slot.
    - Maps each long slot to metrics such as the number of repair requests, turbine shreds, and unique shreds in the slot.
    - Calculates a correlation matrix for the metrics and generates a heatmap to visualize relationships.
    - Generates histograms for shred arrival times for up to 10 long slots, identifying the latest arriving shred for each.
    - Identifies sources that send shreds after the 400ms mark, which may contribute to delays, and analyzes their patterns.
    - Calculates the number of repair shreds arriving after 400ms for each long slot and prints the results.
- **Output**: No explicit return value; outputs are printed and visualized in a PDF report.


---
### completion\_times<!-- {{#callable:firedancer/contrib/repair-analysis/report.completion_times}} -->
[View Source →](<../../../../contrib/repair-analysis/report.py#L292>)

Calculates and visualizes FEC and slot completion times, generating histograms and summary statistics.
- **Inputs**:
    - `fec_stats`: A DataFrame containing FEC statistics, including timestamps and slot information.
    - `shred_data`: A DataFrame containing shred data, including timestamps and slot information.
    - `first_turbine`: An integer representing the slot number of the first turbine.
    - `pdf`: A PdfPages object used to save plots to a PDF file.
- **Logic and Control Flow**:
    - Prints a header for FEC/Slot completion times.
    - Displays a progress indicator while matching FEC data to shred data to calculate first shred timestamps.
    - Calculates FEC completion times by subtracting first shred timestamps from FEC timestamps and converts them to milliseconds.
    - Splits FEC statistics into live and catchup periods based on the `first_turbine` slot number.
    - Generates histograms of FEC completion times for both live and catchup periods and saves them to the PDF.
    - Calculates slot-level completion times by combining first and last FEC completions within each slot.
    - Splits slot completion data into live and catchup periods based on the `first_turbine` slot number.
    - Prints summary statistics for FEC and slot-level completion times for both live and catchup periods.
    - Calculates and prints the time between slot completions for live and catchup periods.
    - Generates and saves a histogram of the time between completing live slots to the PDF.
- **Output**: No return value; outputs are printed to the console and plots are saved to the provided PDF file.


---
### show\_turbine\_arrivals<!-- {{#callable:firedancer/contrib/repair-analysis/report.show_turbine_arrivals}} -->
[View Source →](<../../../../contrib/repair-analysis/report.py#L390>)

Plots turbine arrival data from a live dataset and saves the plot to a PDF file.
- **Inputs**:
    - `live`: A DataFrame containing live data with turbine information, including columns 'is_turbine', 'slot', and 'timestamp'.
    - `pdf`: A PdfPages object used to save the generated plot as a PDF file.
- **Logic and Control Flow**:
    - Create a new figure with a specified size for plotting.
    - Filter the 'live' DataFrame to include only rows where 'is_turbine' is True and 'slot' is greater than or equal to 348905600.
    - Convert the 'timestamp' column to represent time in 10 ms buckets by dividing by 10,000,000 and converting to an integer.
    - Group the filtered data by 'timestamp' and count the occurrences, resetting the index to have a 'count' column.
    - Use seaborn to create a bar plot of the grouped data with 'timestamp' on the x-axis and 'count' on the y-axis.
    - Set the plot title and axis labels for clarity.
    - Hide x-axis labels except for every 5th tick to reduce clutter.
    - Adjust the layout to fit the plot within the figure area.
    - Save the figure to the provided PDF file and close the figure to free resources.
- **Output**: A bar plot of turbine arrivals is saved to the specified PDF file.


---
### turbine\_stats<!-- {{#callable:firedancer/contrib/repair-analysis/report.turbine_stats}} -->
[View Source →](<../../../../contrib/repair-analysis/report.py#L410>)

Analyzes turbine shreds during catchup and live periods, and identifies duplicate shreds.
- **Inputs**:
    - `catchup`: A DataFrame containing data for the catchup period, with a column 'is_turbine' indicating turbine shreds.
    - `live`: A DataFrame containing data for the live period, with a column 'is_turbine' indicating turbine shreds.
- **Logic and Control Flow**:
    - Prints a header 'Turbine Statistics'.
    - Calculates the number of turbine shreds during the catchup period and prints the result.
    - If turbine shreds are found during the catchup period, prints the slots where they were received and a warning about stake weight propagation.
    - Calculates the percentage of turbine shreds during the live period and prints the result.
    - Identifies duplicate shreds received both through turbine and repair during the live period.
    - Classifies each repair shred as a true repair or a duplicate of a turbine shred.
    - Prints the number of duplicate repair shreds during the live period.
- **Output**: No return value; outputs are printed to the console.


---
### turbine\_shred\_timeline<!-- {{#callable:firedancer/contrib/repair-analysis/report.turbine_shred_timeline}} -->
[View Source →](<../../../../contrib/repair-analysis/report.py#L447>)

Tracks turbine and repair shreds over time using a scatter plot.
- **Inputs**:
    - `shreds_data`: A DataFrame containing shred data with columns such as 'slot', 'timestamp', and 'is_turbine'.
    - `first_turbine`: An integer representing the first turbine slot number.
    - `pdf`: A PdfPages object to save the generated scatter plot.
- **Logic and Control Flow**:
    - Prints a header for the turbine shred timeline analysis.
    - Filters the `shreds_data` to include only slots greater than or equal to `first_turbine`.
    - Checks if the filtered data is empty and prints a message if so, then returns.
    - Separates the filtered data into turbine shreds and repair shreds based on the 'is_turbine' column.
    - Prints the number of turbine and repair shreds and the slot range.
    - Normalizes the timestamps within each slot to start from 0 milliseconds.
    - Creates a scatter plot with turbine shreds in blue and repair shreds in green.
    - Formats the plot with labels, title, legend, and grid.
    - Adjusts the x-axis and y-axis limits based on the slot range and maximum slot time.
    - Saves the plot to the provided PDF file.
    - Prints slot timing statistics if the normalized data is not empty.
    - Prints turbine and repair shred statistics if both are not empty.
- **Output**: None, but it generates and saves a scatter plot to the provided PDF file.


---
### show\_slot\_repairs<!-- {{#callable:firedancer/contrib/repair-analysis/report.show_slot_repairs}} -->
[View Source →](<../../../../contrib/repair-analysis/report.py#L537>)

Generates and displays a visual analysis of repair requests and shreds received for a specific slot within a given time window.
- **Inputs**:
    - `repair`: A DataFrame containing repair request data, filtered by the specified slot.
    - `response`: A DataFrame containing response data, filtered by the specified slot.
    - `slot`: An integer representing the slot number to analyze.
    - `pdf`: A PdfPages object used to save the generated plots.
    - `max_idx`: An optional integer parameter that limits the maximum index value for filtering data, defaulting to 32768.
    - `time_window`: An optional integer parameter specifying the time window in milliseconds for filtering data, defaulting to 400.
- **Logic and Control Flow**:
    - Filter the `repair` DataFrame to include only entries with the specified `slot` and convert the 'timestamp' column to datetime format.
    - Filter the `response` DataFrame similarly and convert the 'timestamp' column to datetime format.
    - Further filter the `repair` DataFrame to include only entries with 'idx' less than `max_idx`.
    - Determine the start and end times for the time window based on the earliest timestamp in the filtered `repair` DataFrame and the `time_window` parameter.
    - Filter both `repair` and `response` DataFrames to include only entries within the determined time window.
    - Print the number of repair requests and shreds received within the time window for the specified slot.
    - Create a figure with three subplots to visualize the data using scatter plots.
    - Plot repair requests and shreds received on the first subplot, using different colors for each.
    - Plot the minimum response and request timestamps for each index on the second subplot.
    - Plot the minimum response and request timestamps with source and destination IPs on the third subplot.
    - Save the figure to the provided PDF and close the plot.
- **Output**: A visual representation of repair requests and shreds received for a specific slot, saved to a PDF file.


---
### print\_slots<!-- {{#callable:firedancer/contrib/repair-analysis/report.print_slots}} -->
[View Source →](<../../../../contrib/repair-analysis/report.py#L577>)

Prints repair analysis for specific slots and calls [`show_slot_repairs`](<#show_slot_repairs>) for detailed slot repair data.
- **Inputs**:
    - `repair_requests`: A DataFrame containing repair request data for slots.
    - `shreds_data`: A DataFrame containing shred data for slots.
    - `snapshot_slot`: An integer representing the snapshot slot number.
    - `first_turbine`: An integer representing the first turbine slot number.
    - `pdf`: A PdfPages object for saving plots to a PDF file.
- **Logic and Control Flow**:
    - Prints a header for the specific slot repair analysis.
    - Prints the first slot after the snapshot and calls [`show_slot_repairs`](<#show_slot_repairs>) with a large time window and index limit.
    - Prints the first slot after the snapshot again and calls [`show_slot_repairs`](<#show_slot_repairs>) with a smaller time window and index limit.
    - Prints the last slot before the first turbine and calls [`show_slot_repairs`](<#show_slot_repairs>) with a large time window and index limit.
    - Prints the first turbine slot and calls [`show_slot_repairs`](<#show_slot_repairs>) with a large time window and index limit.
    - Prints the first turbine slot plus 50 and calls [`show_slot_repairs`](<#show_slot_repairs>) with a smaller time window and index limit.
- **Output**: No return value; outputs are printed to the console and plots are saved to the PDF.
- **Functions Called**:
    - [`firedancer/contrib/repair-analysis/report.show_slot_repairs`](<#show_slot_repairs>)


---
### slot\_request\_rate\_analysis<!-- {{#callable:firedancer/contrib/repair-analysis/report.slot_request_rate_analysis}} -->
[View Source →](<../../../../contrib/repair-analysis/report.py#L595>)

Analyzes slot request rates and processing times, showing first non-orphan response markers.
- **Inputs**:
    - `shreds_data`: A DataFrame containing shred data with columns like 'slot', 'timestamp', 'idx', and 'is_turbine'.
    - `first_turbine`: An integer representing the first turbine slot number.
    - `pdf`: A PdfPages object to save the generated plots.
    - `include_after_turbine`: A boolean flag indicating whether to include slots after the turbine slot in the analysis.
- **Logic and Control Flow**:
    - Prints a header for the analysis.
    - Finds the start time of the first turbine slot in the shred data.
    - Filters the shred data to include only relevant slots and timestamps.
    - Groups the filtered data by slot and calculates timestamps for first shred, slot completion, and first non-orphan response.
    - Filters slots based on the 'include_after_turbine' flag to include or exclude slots after the turbine slot.
    - Calculates time differences between first shred and slot completion for each slot.
    - Sorts and prepares valid slots for plotting.
    - Calculates average processing time and time to repair between slots.
    - Normalizes timestamps for plotting and creates a plot of slot processing time intervals.
    - Saves the plot to the provided PdfPages object.
- **Output**: No explicit return value; outputs are printed to the console and plots are saved to the provided PdfPages object.


---
### int\_to\_ip<!-- {{#callable:firedancer/contrib/repair-analysis/report.int_to_ip}} -->
[View Source →](<../../../../contrib/repair-analysis/report.py#L785>)

Converts an integer representation of an IP address to its dotted decimal notation.
- **Inputs**:
    - `ip_int`: An integer or string representing an IP address. If a string, it can be either a dotted decimal IP address or a numeric string.
- **Logic and Control Flow**:
    - Checks if `ip_int` is a string and contains a dot, indicating it is already in dotted decimal format, and returns it as is.
    - If `ip_int` is a string without a dot, attempts to convert it to an integer.
    - Calculates each octet of the IP address by bit-shifting and masking operations on the integer value.
    - Returns the formatted IP address as a string in dotted decimal notation.
    - If a `ValueError` or `TypeError` occurs during conversion, returns the original `ip_int` as a string.
- **Output**: A string representing the IP address in dotted decimal notation, or the original input as a string if conversion fails.


---
### peer\_stats\_analysis<!-- {{#callable:firedancer/contrib/repair-analysis/report.peer_stats_analysis}} -->
[View Source →](<../../../../contrib/repair-analysis/report.py#L798>)

Analyzes peer statistics from repair requests and shred data, generating a detailed PDF report with visualizations.
- **Inputs**:
    - `repair_requests`: A DataFrame containing repair request data, including columns like 'nonce', 'timestamp', 'dst_ip', and 'slot'.
    - `shreds_data`: A DataFrame containing shred data, including columns like 'nonce', 'timestamp', and 'slot'.
    - `pdf`: A PdfPages object used to save the generated figures and plots into a PDF file.
- **Logic and Control Flow**:
    - Prints a header for peer statistics analysis.
    - Checks if 'repair_requests' or 'shreds_data' is None or empty, and returns early if so.
    - Filters out invalid slots (slot == 0) from both datasets using vectorized operations.
    - Normalizes timestamps from nanoseconds to milliseconds if necessary.
    - Merges 'repair_requests' and 'shreds_data' on 'nonce' to calculate round-trip times (RTT).
    - Filters out negative RTT values to ensure valid data.
    - Calculates peer performance metrics (average RTT, median RTT, count of RTTs, total responses) using groupby and aggregation.
    - Calculates hit rates as the ratio of successful responses to total requests per peer.
    - Prepares data series for visualization, including RTT distributions and peer metrics.
    - Generates a multi-page PDF report with various plots, including RTT distributions, peer performance box plots, and request distributions.
    - Saves the generated figures to the provided PDF file.
- **Output**: No return value; outputs are printed to the console and saved to the provided PDF file.
- **Functions Called**:
    - [`firedancer/contrib/repair-analysis/report.int_to_ip`](<#int_to_ip>)


---
### repair\_efficiency\_heatmap<!-- {{#callable:firedancer/contrib/repair-analysis/report.repair_efficiency_heatmap}} -->
[View Source →](<../../../../contrib/repair-analysis/report.py#L1128>)

Generates a heatmap to analyze repair efficiency by comparing actual repair requests to minimal required requests over a specified slot range.
- **Inputs**:
    - `repair_requests`: A DataFrame containing repair request data, including slot and index information.
    - `shreds_data`: A DataFrame containing shred data, including slot, index, and turbine status.
    - `snapshot_slot`: An integer representing the starting slot for the analysis period.
    - `first_turbine`: An integer representing the slot number of the first turbine, marking the end of the analysis period.
    - `pdf`: A PdfPages object used to save the generated heatmap figure.
- **Logic and Control Flow**:
    - Prints the start of the repair efficiency heatmap analysis and the slot range being analyzed.
    - Checks if `repair_requests` or `shreds_data` are empty and returns if so.
    - Filters `repair_requests` and `shreds_data` to the specified slot range and checks if the filtered data is empty, returning if so.
    - Calculates the maximum shred index and determines a UINTMAX threshold to filter out invalid indices.
    - Replaces UINTMAX values in `repair_requests` with the maximum legitimate indices per slot.
    - Aggregates requests and responses by slot and index to calculate efficiency metrics, including the efficiency ratio.
    - Filters the data to include only slots with either requests or responses.
    - Identifies fully buffered slots with continuous shred coverage for accurate analysis.
    - Prepares a heatmap matrix and plots it using matplotlib, setting color scales based on efficiency ratios.
    - Saves the heatmap to the provided PDF and prints summary statistics and outlier information.
- **Output**: A heatmap figure saved to the provided PDF, showing repair efficiency across slots and shreds.


---
### generate\_report<!-- {{#callable:firedancer/contrib/repair-analysis/report.generate_report}} -->
[View Source →](<../../../../contrib/repair-analysis/report.py#L1375>)

Generates a report based on peer response data from various CSV files and a log file.
- **Inputs**:
    - `log_path`: Path to the testnet log file.
    - `request_data_path`: Path to the request data CSV file.
    - `shred_data_path`: Path to the shred data CSV file.
    - `peers_data_path`: Path to the peers data CSV file.
    - `fec_complete_path`: Optional path to the FEC complete CSV file.
    - `pdf`: Optional PDF object for saving the report.
    - `include_after_turbine`: Boolean flag to include slots after the turbine in the analysis.
- **Logic and Control Flow**:
    - Calls [`execution_stats`](<#execution_stats>) to extract execution timeline markers from the log file.
    - Reads CSV files for shreds, repair requests, peers, and optionally FEC stats, handling errors and skipping bad lines.
    - Calculates and filters data based on the first turbine slot and other execution markers.
    - Generates various analyses and visualizations, including turbine arrivals, slot request rates, peer statistics, repair efficiency, and turbine shred timelines.
    - Saves the generated plots and analyses to a PDF file.
- **Output**: None
- **Functions Called**:
    - [`firedancer/contrib/repair-analysis/report.execution_stats`](<#execution_stats>)
    - [`firedancer/contrib/repair-analysis/report.show_turbine_arrivals`](<#show_turbine_arrivals>)
    - [`firedancer/contrib/repair-analysis/report.create_title_page`](<#create_title_page>)
    - [`firedancer/contrib/repair-analysis/report.slot_request_rate_analysis`](<#slot_request_rate_analysis>)
    - [`firedancer/contrib/repair-analysis/report.peer_stats_analysis`](<#peer_stats_analysis>)
    - [`firedancer/contrib/repair-analysis/report.repair_efficiency_heatmap`](<#repair_efficiency_heatmap>)
    - [`firedancer/contrib/repair-analysis/report.turbine_stats`](<#turbine_stats>)
    - [`firedancer/contrib/repair-analysis/report.turbine_shred_timeline`](<#turbine_shred_timeline>)
    - [`firedancer/contrib/repair-analysis/report.completion_times`](<#completion_times>)
    - [`firedancer/contrib/repair-analysis/report.print_slots`](<#print_slots>)


---
### find\_most\_recent\_log<!-- {{#callable:firedancer/contrib/repair-analysis/report.find_most_recent_log}} -->
[View Source →](<../../../../contrib/repair-analysis/report.py#L1468>)

Finds the most recently created log file in the current directory and common locations.
- **Inputs**: None
- **Logic and Control Flow**:
    - Imports the `glob` module to perform file pattern matching.
    - Defines a list of search paths to look for log files in the current and parent directories.
    - Initializes an empty list `log_files` to store found log files.
    - Iterates over each pattern in `search_paths` and extends `log_files` with files matching the pattern using `glob.glob`.
    - Checks if `log_files` is empty; if so, returns `None`.
    - Sorts `log_files` by creation time in descending order using `os.path.getctime`.
    - Returns the first element of the sorted `log_files`, which is the most recent log file.
- **Output**: The function returns the path of the most recently created log file as a string, or `None` if no log files are found.


---
### find\_most\_recent\_csv\_folder<!-- {{#callable:firedancer/contrib/repair-analysis/report.find_most_recent_csv_folder}} -->
[View Source →](<../../../../contrib/repair-analysis/report.py#L1490>)

Finds the most recently created folder containing a CSV file named 'shred_data.csv'.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize an empty list `potential_folders` to store directories containing 'shred_data.csv'.
    - Use `os.walk` to traverse the current directory and its subdirectories, checking if 'shred_data.csv' is present in any directory.
    - If 'shred_data.csv' is found in a directory, append the directory path to `potential_folders`.
    - Repeat the directory traversal for the parent directory using `os.walk('..')`.
    - If `potential_folders` is empty after both traversals, return `None`.
    - Sort `potential_folders` by creation time in descending order using `os.path.getctime`.
    - Return the first element of the sorted `potential_folders`, which is the most recently created folder.
- **Output**: The path to the most recently created folder containing 'shred_data.csv', or `None` if no such folder exists.



---
Made with ❤️ by [Driver](https://www.driver.ai/)