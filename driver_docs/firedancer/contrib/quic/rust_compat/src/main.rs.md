<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Main entry point for a QUIC test application, handling command-line arguments and socket operations.

# Purpose
This Rust code is a command-line application that facilitates testing of QUIC (Quick UDP Internet Connections) implementations. It provides a main function that initializes logging and processes command-line arguments to execute specific test scenarios. The application supports different commands, each corresponding to a different QUIC client-server interaction, such as `quiche-fd`, `quinn-awslc-fd`, `quinn-pq-fd`, and `quinn-ring-fd`. These commands test the interoperability between various QUIC clients (using libraries like quiche and quinn) and the `fd_quic` server, with different cryptographic backends.

The code includes several components: it defines unsafe functions for creating anonymous workspace and UDP sockets, a `StdoutWriter` struct for thread-safe writing to standard output, and a `bindings` module that includes external bindings generated at build time. The `new_udp_socket` function creates and binds a UDP socket to a local address, returning the socket file descriptor and port number. The `StdoutWriter` struct uses a mutex to ensure thread-safe operations when writing to standard output. The application uses external modules `quiche` and `quinn` to handle specific QUIC client interactions, and it relies on the `bindings` module for low-level operations.
# Imports and Dependencies

---
- `libc`
- `std::ffi::c_char`
- `std::io::Write`
- `std::net::Ipv4Addr`
- `std::sync::Mutex`
- `env_logger`
- `std::env`
- `std::process`
- `std::ptr`
- `rustls`
- `rustls_post_quantum`


# Global Variables

---
### USAGE
- **Type**: `&str`
- **Description**: A static string that provides usage instructions for the `firedancer-quiche-quic-test` program. It lists the available commands and their descriptions for interacting with different client-server configurations.
- **Use**: Used to display usage instructions when the program is executed without the required command-line arguments.


# Data Structures

---
### StdoutWriter
- **Type**: `struct`
- **Members**:
    - ``lock``: A `Mutex` that ensures exclusive access to the standard output during write operations.
- **Description**: Provides a thread-safe mechanism to write to the standard output by using a `Mutex` to synchronize access. The `StdoutWriter` struct implements the `Write` trait, allowing it to perform write and flush operations. The `write` method locks the mutex, writes the provided buffer to the standard output, and then releases the lock. The `flush` method is a no-op, as flushing is not necessary for standard output.

**Methods**

---
#### StdoutWriter::flush
Ensures that any buffered data is written to the underlying output stream.
- **Inputs**:
    - `&mut self`: A mutable reference to the `StdoutWriter` instance, allowing modification of its state.
- **Logic and Control Flow**:
    - The method does not perform any operations as the `StdoutWriter` does not buffer data.
    - Returns an `Ok(())` result to indicate successful completion.
- **Output**: A `Result<(), std::io::Error>` indicating success or failure of the flush operation.


---
#### StdoutWriter::new
Creates a new instance of `StdoutWriter` with a mutex lock for thread-safe writing to standard output.
- **Inputs**:
    - `self`: Represents the instance of the `StdoutWriter` struct being created.
- **Logic and Control Flow**:
    - Initialize a new `StdoutWriter` struct.
    - Create a `Mutex` to ensure thread-safe access to the standard output.
    - Assign the `Mutex` to the `lock` field of the `StdoutWriter` struct.
    - Return the newly created `StdoutWriter` instance.
- **Output**: A new `StdoutWriter` instance with a mutex lock for synchronized access.


---
#### StdoutWriter::write
Writes the contents of a buffer to the standard output.
- **Inputs**:
    - `&mut self`: A mutable reference to the `StdoutWriter` instance.
    - `buf`: A byte slice containing the data to write to the standard output.
- **Logic and Control Flow**:
    - Acquire a lock on the `StdoutWriter` instance to ensure exclusive access to the standard output.
    - Convert the byte slice `buf` to a string using `std::str::from_utf8_unchecked`, which assumes the data is valid UTF-8.
    - Print the string to the standard output using the `print!` macro.
    - Release the lock on the `StdoutWriter` instance.
    - Return the length of the buffer as the number of bytes written.
- **Output**: Returns a `Result` containing the number of bytes written on success, or an `std::io::Error` on failure.



# Functions

---
### fd\_wksp\_new\_anonymous
Creates a new anonymous workspace with specified parameters.
- **Inputs**:
    - `page_sz`: The size of each page in the workspace.
    - `page_cnt`: The number of pages in the workspace.
    - `cpu_idx`: The index of the CPU to associate with the workspace.
    - `name`: A pointer to a C-style string representing the name of the workspace.
    - `opt_part_max`: The maximum number of partitions allowed in the workspace.
- **Logic and Control Flow**:
    - Creates arrays `sub_page_cnt` and `sub_cpu_idx` to hold `page_cnt` and `cpu_idx` respectively.
    - Calls the function `fd_wksp_new_anon` with the provided parameters and the created arrays to create a new anonymous workspace.
- **Output**: A pointer to the newly created `fd_wksp_t` workspace.


---
### main
Initializes the environment, processes command-line arguments, and executes the corresponding QUIC test command.
- **Inputs**:
    - `None`: The function does not take any direct input parameters.
- **Logic and Control Flow**:
    - Initializes the logger using `env_logger::init()`.
    - Retrieves the first command-line argument; if none is provided, prints usage instructions and exits with an error code.
    - Sets environment variables `FD_LOG_PATH`, `FD_LOG_LEVEL_LOGFILE`, and `FD_LOG_LEVEL_STDERR` to configure logging behavior.
    - Initializes the `fd_boot` function with dummy arguments to prepare the environment.
    - Matches the command-line argument against predefined commands (`quiche-fd`, `quinn-awslc-fd`, `quinn-pq-fd`, `quinn-ring-fd`) and calls the corresponding function from the `quiche` or `quinn` modules.
    - If the argument does not match any predefined command, the function panics with an "Unknown arg" message.
- **Output**: The function does not return a value; it either executes a command or exits the process.


---
### new\_udp\_socket
Creates a new UDP socket bound to the loopback address and returns its file descriptor and port number.
- **Inputs**: None
- **Logic and Control Flow**:
    - Call the `socket` function to create a new UDP socket with `AF_INET`, `SOCK_DGRAM`, and `IPPROTO_UDP` parameters.
    - Check that the socket file descriptor is greater than 0 to ensure the socket was created successfully.
    - Initialize a `sockaddr_in` structure with zeroed memory to represent the address to bind the socket to.
    - Set the `sin_family` field of `sockaddr_in` to `AF_INET`.
    - Set the `sin_addr` field of `sockaddr_in` to the loopback address `127.0.0.1`.
    - Set the `sin_port` field of `sockaddr_in` to 0, allowing the system to choose an available port.
    - Call the `bind` function to bind the socket to the specified address and port, and assert that it returns 0, indicating success.
    - Determine the port number assigned by the system by calling `getsockname` and assert that it returns 0, indicating success.
    - Check that the size of the address structure returned by `getsockname` matches the expected size.
    - Convert the port number from network byte order to host byte order.
    - Return the socket file descriptor and the port number.
- **Output**: A tuple containing the socket file descriptor (`i32`) and the port number (`u16`).



---
Made with ❤️ by [Driver](https://www.driver.ai/)