<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Main entry point for a QUIC test application with commands for blasting, pinging, and benchmarking.

# Purpose
The code is a Rust program that integrates with the Firedancer and Agave frameworks to perform network operations using the QUIC protocol. It includes several functions that set up and manage UDP sockets and QUIC connections, demonstrating interoperability between different network components. The program uses unsafe Rust code to interact with low-level network operations and external C libraries, which are included through bindings. The main function provides a command-line interface with commands such as `blast`, `ping-server`, `ping-client`, and `spam-server`, each executing different network tasks like flooding a target with QUIC streams or benchmarking client-server interactions.

The program defines several key functions: `agave_to_fdquic`, `agave_to_fdquic_bench`, and `fdquic_to_agave`, which set up and manage network connections between Agave and Firedancer components. These functions create UDP sockets, initialize QUIC connections, and handle data transmission. The code uses various external libraries, such as `libc` for system calls and `solana_client` for connection caching. The program also includes a module `blaster` for additional functionality related to the `blast` command. The use of unsafe code and direct memory manipulation indicates a focus on performance and low-level control over network operations.
# Imports and Dependencies

---
- `libc`
- `rand`
- `solana_client`
- `solana_connection_cache`
- `solana_keypair`
- `solana_streamer`
- `std`
- `crossbeam_channel`
- `env_logger`


# Global Variables

---
### USAGE
- **Type**: `&str`
- **Description**: A static string that provides usage instructions for the `firedancer-agave-quic-test` program. It lists the available commands and their descriptions.
- **Use**: Displayed to the user when the program is run without arguments or with incorrect arguments.


# Functions

---
### agave\_to\_fdquic
Sets up and manages a QUIC server using Firedancer and Agave components, facilitating data transmission between them.
- **Inputs**: None
- **Logic and Control Flow**:
    - Creates a new UDP socket and retrieves its file descriptor and listening port.
    - Initializes a Firedancer workspace using `fd_wksp_new_anonymous`.
    - Allocates memory for a UDP socket and joins it to the Firedancer UDP socket using `fd_udpsock_join`.
    - Sets the UDP socket layer to IP using `fd_udpsock_set_layer`.
    - Creates a new QUIC server instance with `fd_quic_new_anonymous_small` and configures it to retry connections.
    - Links the QUIC server's network transmission and reception to the UDP socket using `fd_quic_set_aio_net_tx` and `fd_udpsock_set_rx`.
    - Initializes the QUIC server with `fd_quic_init`.
    - Spawns a thread to service the UDP socket and QUIC server, checking various metrics to ensure correct operation.
    - Sets up an Agave connection cache and sends data to the QUIC server.
    - Signals the QUIC server thread to stop and waits for it to join.
    - Calls `fd_halt` to clean up resources.
- **Output**: No return value; the function operates through side effects, setting up and managing network components.


---
### agave\_to\_fdquic\_bench
Sets up and benchmarks a QUIC server using Firedancer and Agave components.
- **Inputs**: None
- **Logic and Control Flow**:
    - Creates a new UDP socket and retrieves its file descriptor and listening port.
    - Initializes a new anonymous workspace using `fd_wksp_new_anonymous`.
    - Sets up a random number generator `rng` with a specific sequence.
    - Defines QUIC limits and creates a new anonymous QUIC server using `fd_quic_new_anonymous`.
    - Spawns a thread to handle QUIC and UDP socket services, including setting up packet capture if the `PCAP` environment variable is set.
    - Within the thread, sets up a loop to continuously service the QUIC and UDP socket, and logs network metrics every second.
    - Sets up Agave components, including a connection cache and a connection to the QUIC server.
    - Continuously sends batches of random-sized data to the server using the connection.
- **Output**: No explicit return value; the function performs setup and benchmarking operations.


---
### fd\_wksp\_new\_anonymous
Creates a new anonymous workspace with specified parameters.
- **Inputs**:
    - ``page_sz``: The size of each page in the workspace.
    - ``page_cnt``: The number of pages in the workspace.
    - ``cpu_idx``: The CPU index to associate with the workspace.
    - ``name``: A pointer to a C-style string representing the name of the workspace.
    - ``opt_part_max``: An optional parameter specifying the maximum number of partitions.
- **Logic and Control Flow**:
    - Creates arrays `sub_page_cnt` and `sub_cpu_idx` to hold the `page_cnt` and `cpu_idx` values respectively.
    - Calls the `fd_wksp_new_anon` function with the provided parameters and the arrays `sub_page_cnt` and `sub_cpu_idx`.
- **Output**: A pointer to the newly created `fd_wksp_t` workspace.


---
### fdquic\_to\_agave
Establishes a QUIC connection from a Firedancer client to an Agave server and manages the connection lifecycle.
- **Inputs**: None
- **Logic and Control Flow**:
    - Bind a UDP socket to a local address and retrieve the listening port.
    - Create a new keypair for the connection.
    - Set up a crossbeam channel for communication and an atomic boolean for exit signaling.
    - Spawn an Agave server using the `solana_streamer::quic::spawn_server` function with the created UDP socket and keypair.
    - Pause the execution for 500 milliseconds to allow the server to start.
    - Create a new UDP socket for the client and retrieve the client port.
    - Create a new anonymous workspace using `fd_wksp_new_anonymous`.
    - Initialize a random number generator `fd_rng_t`.
    - Allocate memory for a UDP socket and join it using `fd_udpsock_join`.
    - Set the UDP socket layer to IP using `fd_udpsock_set_layer`.
    - Create a new anonymous small QUIC client using `fd_quic_new_anonymous_small`.
    - Set the asynchronous I/O network transmission and reception for the QUIC client using `fd_quic_set_aio_net_tx` and `fd_udpsock_set_rx`.
    - Initialize the QUIC client using `fd_quic_init`.
    - Log the connection attempt from the client to the server.
    - Establish a QUIC connection using `fd_quic_connect` and check the connection state in a loop until it becomes active or dead.
    - Halt the Firedancer components using `fd_halt`.
    - Signal the Agave server to exit and join the server thread.
- **Output**: No output is returned; the function manages the connection lifecycle and logs connection attempts.


---
### main
Executes different network operations based on the command-line argument provided.
- **Inputs**:
    - `arg`: A string representing the command-line argument that specifies the operation to perform.
- **Logic and Control Flow**:
    - Initialize the environment logger.
    - Retrieve the first command-line argument to determine the operation.
    - Set environment variables for logging configuration.
    - Initialize Firedancer components using `fd_boot`.
    - Match the command-line argument `arg` to execute the corresponding operation:
    - If `arg` is 'blast', retrieve the second command-line argument and call `blaster::blast` with it.
    - If `arg` is 'ping-server', call the `agave_to_fdquic` function.
    - If `arg` is 'ping-client', call the `fdquic_to_agave` function.
    - If `arg` is 'spam-server', call the `agave_to_fdquic_bench` function.
    - If `arg` does not match any known command, panic with 'Unknown arg'.
- **Output**: Executes a network operation based on the command-line argument and does not return a value.


---
### new\_udp\_socket
Creates a new UDP socket, binds it to the local loopback address, and returns the socket file descriptor and the assigned port number.
- **Inputs**: None
- **Logic and Control Flow**:
    - Call the `socket` function to create a new UDP socket with the `AF_INET` address family, `SOCK_DGRAM` type, and `IPPROTO_UDP` protocol.
    - Check that the socket file descriptor is greater than 0 to ensure the socket was created successfully.
    - Initialize a `sockaddr_in` structure to zero and set its `sin_family` to `AF_INET`, `sin_addr` to the loopback address `127.0.0.1`, and `sin_port` to 0 (indicating any available port).
    - Bind the socket to the address specified in the `sockaddr_in` structure using the `bind` function and check that it returns 0 to ensure successful binding.
    - Retrieve the assigned port number using the `getsockname` function and check that it returns 0 to ensure successful retrieval.
    - Verify that the size of the address structure returned by `getsockname` matches the expected size.
    - Convert the port number from network byte order to host byte order using `u16::from_be`.
    - Return the socket file descriptor and the assigned port number.
- **Output**: A tuple containing the socket file descriptor (`i32`) and the assigned port number (`u16`).


---
### tls\_keylog\_cb
Logs TLS key information to a pcapng file for debugging purposes.
- **Inputs**:
    - `_ctx`: A pointer to a context object, which is not used in this function.
    - `line`: A pointer to a C-style string containing the TLS key log line.
- **Logic and Control Flow**:
    - Calls `fd_pcapng_fwrite_tls_key_log` to write the TLS key log line to the global pcapng file.
    - Uses `strlen` to determine the length of the TLS key log line.
- **Output**: No return value (void function).



---
Made with ❤️ by [Driver](https://www.driver.ai/)