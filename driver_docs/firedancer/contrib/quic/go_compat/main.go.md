<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

A Go program that tests QUIC protocol interoperability between `fd_quic` and `quic-go` implementations.

# Purpose
The code is a Go program that tests the interoperability between a QUIC implementation in C (`fd_quic`) and a Go-based QUIC library (`quic-go`). It is structured to perform both client and server tests, where `fd_quic` acts as a client in one test and as a server in another. The program uses cgo to interface with C libraries and functions, allowing it to call C functions and use C data structures within the Go environment.

The program includes two main test functions: `clientTest` and `serverTest`. The `clientTest` function configures `fd_quic` as a client and establishes a connection to a `quic-go` server. It sends a test message over a QUIC stream and verifies the connection and data transmission. Conversely, the `serverTest` function configures `fd_quic` as a server and listens for connections from a `quic-go` client. It handles incoming streams and verifies the receipt of data. Both tests use UDP connections to simulate network communication, wrapping and unwrapping datagrams to include necessary headers.

The program also includes setup and teardown logic in the `main` function. It initializes the `fd_quic` environment, configures logging, and sets up necessary resources such as random number generators and memory allocations. The program can optionally generate qlog traces and write packet capture files for further analysis. The use of channels and goroutines facilitates concurrent processing of network packets and QUIC operations, ensuring efficient handling of asynchronous events.
# Imports and Dependencies

---
- `C`
- `context`
- `crypto/tls`
- `encoding/binary`
- `errors`
- `flag`
- `io`
- `log`
- `net`
- `runtime`
- `strings`
- `sync`
- `sync/atomic`
- `time`
- `unsafe`
- `github.com/quic-go/quic-go`
- `github.com/quic-go/quic-go/logging`
- `github.com/quic-go/quic-go/qlog`
- `golang.org/x/net/ipv4`


# Global Variables

---
### enableQlog
- **Type**: ``bool``
- **Description**: A boolean variable that indicates whether qlog tracing is enabled. When set to `true`, it enables the use of qlog for tracing QUIC connections.
- **Use**: Used to determine if qlog tracing should be activated in QUIC configurations.


---
### globFdToGo
- **Type**: ``chan []byte``
- **Description**: A global channel of type `chan []byte` that is used to transfer byte slices between different parts of the program. It is initialized in the `clientTest` and `serverTest` functions to facilitate communication between the QUIC client and server components.
- **Use**: Used to send and receive byte slices representing network packets between the QUIC client and server.


# Data Structures

---
### qlogWriter
- **Type**: ``struct``
- **Members**:
    - ``Write``: Implements the `Write` method to log non-empty strings from a byte slice.
    - ``Close``: Implements the `Close` method which returns `nil`.
- **Description**: `qlogWriter` is a struct that implements the `io.Writer` interface, specifically for logging QUIC protocol events. It provides a `Write` method that logs non-empty strings from a byte slice, and a `Close` method that does nothing and returns `nil`. This struct is used in conjunction with the `qlog` package to trace QUIC connections.


# Functions

---
### \(qlogWriter\) Write
Processes a byte slice by trimming whitespace and logging the result if it is not empty.
- **Inputs**:
    - `p`: A byte slice that the function will process.
- **Logic and Control Flow**:
    - Convert the byte slice `p` to a string and trim whitespace characters including null, carriage return, newline, tab, and space.
    - Check if the resulting string is not empty.
    - If the string is not empty, log the string prefixed with 'qlog: '.
    - Return the length of the byte slice `p` and a nil error.
- **Output**: Returns the length of the input byte slice `p` and a nil error.


---
### \(qlogWriter\) Close
Implements a no-operation close method for the `qlogWriter` type.
- **Inputs**: None
- **Logic and Control Flow**:
    - The function is defined as a method on the `qlogWriter` type.
    - The function signature indicates it returns an `error` type.
    - The function body contains a single statement: `return nil`.
- **Output**: The function returns `nil`, indicating no error occurs during the close operation.


---
### wrapDatagram
Wraps a UDP payload in fake Ethernet, IPv4, and UDP headers.
- **Inputs**:
    - `payload`: A byte slice representing the UDP payload to wrap.
    - `src`: A pointer to a `net.UDPAddr` representing the source address.
    - `dst`: A pointer to a `net.UDPAddr` representing the destination address.
    - `seq`: A pointer to an integer representing the sequence number for the IPv4 header.
- **Logic and Control Flow**:
    - Create a byte slice `buf` with a capacity to hold the headers and the payload.
    - Extend `buf` to include space for the IPv4 header and assign the last 20 bytes to `l3`.
    - Create an `ipv4.Header` with specified fields including version, length, total length, ID, TTL, protocol, source, and destination IPs.
    - Increment the sequence number pointed to by `seq`.
    - Marshal the IPv4 header and copy it into `l3`.
    - Extend `buf` to include space for the UDP header and assign the last 8 bytes to `l4`.
    - Set the source and destination ports, length, and checksum in the UDP header using big-endian encoding.
    - Append the `payload` to `buf`.
- **Output**: A byte slice containing the wrapped datagram with Ethernet, IPv4, and UDP headers.


---
### unwrapDatagram
Removes the Ethernet, IPv4, and UDP headers from a datagram buffer.
- **Inputs**:
    - ``buf``: A byte slice containing the datagram with Ethernet, IPv4, and UDP headers.
- **Logic and Control Flow**:
    - The function receives a byte slice `buf` as input.
    - It returns a slice of `buf` starting from the 29th byte, effectively removing the first 28 bytes which are assumed to be the Ethernet, IPv4, and UDP headers.
- **Output**: A byte slice containing the payload of the datagram, excluding the Ethernet, IPv4, and UDP headers.


---
### fdSendCallback
Processes a batch of packets, optionally writing them to a pcap file, and sends them to a global channel.
- **Inputs**:
    - `_ctx`: A pointer to an unspecified context, not used in the function.
    - `batchPtr`: A pointer to the first element of an array of `fd_aio_pkt_info_t` structures, representing a batch of packets.
    - `batchCnt`: The number of packets in the batch.
    - `_optBatchIdx`: A pointer to an optional batch index, not used in the function.
    - `_flush`: An integer indicating whether to flush, not used in the function.
- **Logic and Control Flow**:
    - Convert the `batchPtr` to a Go slice of `fd_aio_pkt_info_t` structures using `unsafe.Slice` with `batchCnt` as the length.
    - Iterate over each packet in the batch.
    - For each packet, convert the packet buffer to a Go byte slice using `unsafe.Slice`.
    - If `fd_quic_test_pcap` is not `nil`, write the packet to the pcap file using `fd_pcapng_fwrite_pkt`.
    - Attempt to send the unwrapped datagram to the `globFdToGo` channel using a non-blocking send operation.
    - Return `FD_AIO_SUCCESS` to indicate successful processing.
- **Output**: Returns `FD_AIO_SUCCESS` to indicate successful processing of the packet batch.


---
### clientTest
Tests the `fd_quic` client by establishing a connection to a `quic-go` server and sending a data stream.
- **Inputs**:
    - `fdQuic`: A pointer to an `fd_quic_t` structure representing the QUIC client configuration and state.
- **Logic and Control Flow**:
    - Logs the start of the client test.
    - Creates a context with a timeout of 3 seconds and a cancel function.
    - Configures the `fd_quic` client role and initializes it.
    - Sets up two channels `netFdToGo` and `netGoToFd` for communication between the client and server.
    - Creates UDP addresses for the client and server and establishes a loopback packet connection.
    - Starts two goroutines: one for the `quic-go` server and one for the `fd_quic` client.
    - In the server goroutine, sets up a QUIC listener with TLS configuration and accepts connections and streams.
    - In the client goroutine, defines a service function to process packets and manage connection state.
    - Connects the `fd_quic` client to the server and sends a data stream.
    - Closes the connection after the stream is received and waits for the connection state to become invalid.
- **Output**: No return value; the function performs operations and logs results.


---
### serverTest
Tests the interaction between a `quic-go` client and an `fd_quic` server.
- **Inputs**:
    - ``fdQuic``: A pointer to an `fd_quic_t` structure, representing the QUIC server instance.
- **Logic and Control Flow**:
    - Logs the start of the test for a `quic-go` client connecting to an `fd_quic` server.
    - Creates a context with a timeout of 3 seconds for the test duration.
    - Configures the `fdQuic` instance as a server and initializes it.
    - Sets up two channels, `netFdToGo` and `netGoToFd`, for communication between the `fd_quic` server and the `quic-go` client.
    - Defines UDP addresses for the server (`addrFd`) and client (`addrGo`).
    - Creates a loopback packet connection pair for communication between the server and client.
    - Starts a goroutine to handle incoming packets from the `quic-go` client, wrapping them in Ethernet, IPv4, and UDP headers, and processing them with `fd_quic`.
    - Starts another goroutine to handle the `quic-go` client, establishing a QUIC connection to the `fd_quic` server, sending a message, and closing the connection.
- **Output**: No return value; the function performs a test and logs the results.


---
### main
Initializes and runs tests for QUIC client-server communication using the `fd_quic` library and `quic-go`.
- **Inputs**:
    - `None`: The function does not take any input arguments.
- **Logic and Control Flow**:
    - Parses command-line flags to enable qlog and specify a pcap file path.
    - Calls `fd_boot` to initialize the Firedancer environment.
    - Sets log levels for logfile and stderr to 0.
    - Initializes a random number generator (`fd_rng_t`) and QUIC limits (`fd_quic_limits_t`).
    - Allocates memory for QUIC and joins the QUIC context.
    - Sets up a TLS test signer context and configures it for QUIC.
    - Sets up asynchronous I/O for network transmission using `fdSendCallback`.
    - Opens a pcap file if specified and starts pcapng logging.
    - Calls `clientTest` to test QUIC client functionality.
    - Calls `serverTest` to test QUIC server functionality.
    - Sleeps for 100 milliseconds to allow for any pending operations to complete.
    - Frees allocated memory for QUIC and TLS contexts.
    - Closes the pcap file if it was opened.
- **Output**: The function does not return any value.



---
Made with ❤️ by [Driver](https://www.driver.ai/)