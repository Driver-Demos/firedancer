<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Generates C include files with NIST CAVP test vectors for cryptographic hash function verification.

# Purpose
This Python script generates C include files containing test vectors for cryptographic hash functions, specifically for the NIST Cryptographic Algorithm Validation Program (CAVP). The script reads a CAVP response file, which contains message tests, and converts these into C data structures that can be used to verify implementations of SHA-2 hash functions. The script supports SHA-256, SHA-384, and SHA-512 algorithms.

The script defines several key components, including functions like [`bin2cstr`](<#bin2cstr>) and [`bin2carr`](<#bin2carr>) to format binary data as C strings and arrays, respectively. It also includes a `Msg` data class to represent messages and their corresponding digests. The `HashMsgGenerator` class is responsible for generating the C test vectors, and the [`_main`](<#_main>) function handles command-line arguments and orchestrates the overall process. The script outputs the generated C code to either a specified file or standard output, making it suitable for integration into larger projects that require automated generation of test vectors for cryptographic validation.
# Imports and Dependencies

---
- `argparse`
- `dataclasses.dataclass`
- `pathlib.Path`
- `re`
- `sys`
- `textwrap`
- `typing.Iterator`


# Classes

---
### Msg<!-- {{#class:firedancer/contrib/codegen/cavp_generate.Msg}} -->
[View Source →](<../../../../contrib/codegen/cavp_generate.py#L56>)

- **Decorators**: `@dataclass`
- **Members**:
    - `msg`: Contains the message data as bytes.
    - `digest`: Contains the digest of the message as bytes.
- **Description**: Represents a message and its corresponding digest, both stored as byte sequences, used for cryptographic hash function testing.


---
### HashMsgGenerator<!-- {{#class:firedancer/contrib/codegen/cavp_generate.HashMsgGenerator}} -->
[View Source →](<../../../../contrib/codegen/cavp_generate.py#L91>)

- **Members**:
    - `name`: Stores the name of the test.
    - `test_vector_type`: Indicates the type of the test vector.
    - `hashes`: Contains a list of hash digests as bytes.
- **Description**: Generates C include files with NIST CAVP test vectors for cryptographic hash function verification. It manages test vector names and stores hash digests for output.
- **Methods**:
    - [`firedancer/contrib/codegen/cavp_generate.HashMsgGenerator.__init__`](<#hashmsggenerator__init__>)
    - [`firedancer/contrib/codegen/cavp_generate.HashMsgGenerator._test_vector_name`](<#hashmsggenerator_test_vector_name>)
    - [`firedancer/contrib/codegen/cavp_generate.HashMsgGenerator.write_test`](<#hashmsggeneratorwrite_test>)
    - [`firedancer/contrib/codegen/cavp_generate.HashMsgGenerator.finish`](<#hashmsggeneratorfinish>)

**Methods**

---
#### HashMsgGenerator\.\_\_init\_\_<!-- {{#callable:firedancer/contrib/codegen/cavp_generate.HashMsgGenerator.__init__}} -->
[View Source →](<../../../../contrib/codegen/cavp_generate.py#L96>)

Initializes a `HashMsgGenerator` object with a name and test vector type, and prepares an empty list for hashes.
- **Inputs**:
    - `name`: A string representing the name of the hash message generator.
    - `test_vector_type`: A string representing the type of test vector.
- **Logic and Control Flow**:
    - Assigns the input `name` to the instance variable `self.name`.
    - Assigns the input `test_vector_type` to the instance variable `self.test_vector_type`.
    - Initializes `self.hashes` as an empty list to store hash values.
- **Output**: None (constructor method).
- **See also**: [`firedancer/contrib/codegen/cavp_generate.HashMsgGenerator`](<#hashmsggenerator>)  (Base Class)


---
#### HashMsgGenerator\.\_test\_vector\_name<!-- {{#callable:firedancer/contrib/codegen/cavp_generate.HashMsgGenerator._test_vector_name}} -->
[View Source →](<../../../../contrib/codegen/cavp_generate.py#L101>)

Generates a test vector name by appending an index to the class's name attribute.
- **Inputs**:
    - `i`: An integer index used to differentiate test vector names.
- **Logic and Control Flow**:
    - Uses the `name` attribute of the `HashMsgGenerator` class instance.
    - Appends the string '_test_' followed by the integer `i` to the `name` attribute.
    - Returns the concatenated string as the test vector name.
- **Output**: A string representing the test vector name, formatted as '<name>_test_<i>'.
- **See also**: [`firedancer/contrib/codegen/cavp_generate.HashMsgGenerator`](<#hashmsggenerator>)  (Base Class)


---
#### HashMsgGenerator\.write\_test<!-- {{#callable:firedancer/contrib/codegen/cavp_generate.HashMsgGenerator.write_test}} -->
[View Source →](<../../../../contrib/codegen/cavp_generate.py#L104>)

Appends a message digest to the list of hashes and prints a C array initializer for the message if the message is not empty.
- **Inputs**:
    - `msg`: An instance of the `Msg` class containing a message and its digest.
- **Logic and Control Flow**:
    - Check if the message in `msg` is empty; if it is, return immediately.
    - Determine the current index `i` by getting the length of the `hashes` list.
    - Append the `digest` from `msg` to the `hashes` list.
    - Print a C array declaration using the [`_test_vector_name`](<#hashmsggenerator_test_vector_name>) method to generate the name, with the index `i`.
    - Convert the message to a C array initializer using [`bin2carr`](<#bin2carr>) and print it with indentation.
    - Print the closing brace for the C array declaration.
- **Output**: No explicit return value; outputs are printed to the standard output.
- **Functions Called**:
    - [`firedancer/contrib/codegen/cavp_generate.HashMsgGenerator._test_vector_name`](<#hashmsggenerator_test_vector_name>)
    - [`firedancer/contrib/codegen/cavp_generate.bin2carr`](<#bin2carr>)
- **See also**: [`firedancer/contrib/codegen/cavp_generate.HashMsgGenerator`](<#hashmsggenerator>)  (Base Class)


---
#### HashMsgGenerator\.finish<!-- {{#callable:firedancer/contrib/codegen/cavp_generate.HashMsgGenerator.finish}} -->
[View Source →](<../../../../contrib/codegen/cavp_generate.py#L113>)

Generates and prints a C array of test vectors from stored hash digests.
- **Inputs**: None
- **Logic and Control Flow**:
    - Prints the start of a C array declaration using `self.test_vector_type` and `self.name`.
    - Iterates over `self.hashes` to process each hash digest.
    - For each hash digest, calls [`_test_vector_name`](<#hashmsggenerator_test_vector_name>) to get the declaration name.
    - Prints the declaration name and its size in the C array format.
    - Converts each hash digest to a C string using [`bin2cstr`](<#bin2cstr>) and prints it.
    - Prints a terminating entry `{ NULL, 0UL, { 0 } }` to the C array.
    - Prints the closing of the C array declaration.
- **Output**: No return value; outputs C array declarations to standard output.
- **Functions Called**:
    - [`firedancer/contrib/codegen/cavp_generate.HashMsgGenerator._test_vector_name`](<#hashmsggenerator_test_vector_name>)
    - [`firedancer/contrib/codegen/cavp_generate.bin2cstr`](<#bin2cstr>)
- **See also**: [`firedancer/contrib/codegen/cavp_generate.HashMsgGenerator`](<#hashmsggenerator>)  (Base Class)



# Functions

---
### bin2cstr<!-- {{#callable:firedancer/contrib/codegen/cavp_generate.bin2cstr}} -->
[View Source →](<../../../../contrib/codegen/cavp_generate.py#L19>)

Converts a byte sequence into a C-style string with hex-escaped characters.
- **Inputs**:
    - `data`: A byte sequence to convert into a C-style string.
- **Logic and Control Flow**:
    - Check if the input `data` is empty; if so, return the string 'NULL'.
    - Initialize the output string `out` with a double quote character.
    - Iterate over each byte `b` in the input `data` with its index `i`.
    - For the first byte, do nothing special.
    - For every 32nd byte, append a newline and a double quote to `out`.
    - For every 8th byte, append a space and a double quote to `out`.
    - Append the hex-escaped representation of the byte `b` to `out`.
    - For every 8th byte, append a closing double quote to `out`.
    - After the loop, if the length of `data` is not a multiple of 8, append a closing double quote to `out`.
    - Return the constructed C-style string `out`.
- **Output**: A C-style string with hex-escaped characters representing the input byte sequence.


---
### bin2carr<!-- {{#callable:firedancer/contrib/codegen/cavp_generate.bin2carr}} -->
[View Source →](<../../../../contrib/codegen/cavp_generate.py#L39>)

Converts binary data into a C array initializer string.
- **Inputs**:
    - `data`: A bytes object containing the binary data to convert.
- **Logic and Control Flow**:
    - Asserts that the length of `data` is greater than 0.
    - Initializes an empty string `out` to accumulate the C array initializer.
    - Iterates over each byte `b` in `data` with its index `i`.
    - For the first byte, does nothing special.
    - For every 16th byte, appends a newline and a comma to `out`.
    - For every 8th byte, appends a space and a comma to `out`.
    - For all other bytes, appends a comma to `out`.
    - Formats each byte `b` as a two-digit hexadecimal string prefixed by `_(` and appends it to `out`.
- **Output**: A string representing the C array initializer with the given binary data.


---
### \_find\_line\_match<!-- {{#callable:firedancer/contrib/codegen/cavp_generate._find_line_match}} -->
[View Source →](<../../../../contrib/codegen/cavp_generate.py#L62>)

Finds and returns the first line in an iterator that matches a given regular expression pattern.
- **Inputs**:
    - `lines`: An iterator over strings, representing lines to search through.
    - `pat`: A compiled regular expression pattern to match against each line.
- **Logic and Control Flow**:
    - Iterate over each line in the provided `lines` iterator.
    - For each line, attempt to match it against the provided regular expression pattern `pat`.
    - If a match is found, return the match object immediately.
    - If no match is found after all lines are checked, raise an `AssertionError` with the message 'failed to parse file'.
- **Output**: A `re.Match` object representing the first successful match of the pattern in the lines.


---
### parse\_msg\_rsp<!-- {{#callable:firedancer/contrib/codegen/cavp_generate.parse_msg_rsp}} -->
[View Source →](<../../../../contrib/codegen/cavp_generate.py#L70>)

Parses a CAVP response file to extract message tests and their corresponding digests.
- **Inputs**:
    - `file`: An iterable file object containing lines of a CAVP response file.
- **Logic and Control Flow**:
    - Initialize an iterator over the input file lines.
    - Compile regular expressions to match message count, message size, message content, and message digest.
    - Initialize an empty list `msgs` to store parsed messages.
    - Extract the message count from the file using the `_match_msg_count` pattern.
    - Iterate while `msg_count` is greater than zero:
    -   - Extract the message size using the `_match_msg_sz` pattern.
    -   - Extract the message content using the `_match_msg` pattern and convert it from hexadecimal to bytes, truncating to `msg_sz`.
    -   - Extract the message digest using the `_match_md` pattern and convert it from hexadecimal to bytes.
    -   - Create a [`Msg`](<#msg>) object with the message and digest, and append it to `msgs`.
    -   - Decrement `msg_count` by one.
    - Return the list `msgs` containing all parsed [`Msg`](<#msg>) objects.
- **Output**: A list of [`Msg`](<#msg>) objects, each containing a message and its corresponding digest.
- **Functions Called**:
    - [`firedancer/contrib/codegen/cavp_generate._find_line_match`](<#_find_line_match>)
    - [`firedancer/contrib/codegen/cavp_generate.Msg`](<#msg>)


---
### \_main<!-- {{#callable:firedancer/contrib/codegen/cavp_generate._main}} -->
[View Source →](<../../../../contrib/codegen/cavp_generate.py#L124>)

Parses command-line arguments to generate C include files with SHA-2 test vectors from a CAVS response file.
- **Inputs**: None
- **Logic and Control Flow**:
    - Creates an argument parser with a description of the program's functionality.
    - Adds arguments to the parser for the response file path, algorithm choice, test name, and optional output file.
    - Parses the command-line arguments and stores them in the `args` variable.
    - If an output file is specified, redirects `sys.stdout` to write to that file.
    - Prints a header comment indicating the file is auto-generated and defines a macro for formatting bytes.
    - Opens the specified response file and parses it to extract message test vectors using [`parse_msg_rsp`](<#parse_msg_rsp>).
    - Initializes a [`HashMsgGenerator`](<#hashmsggenerator>) with the test name and test vector type based on the algorithm.
    - Iterates over the parsed messages and writes each test vector using the [`HashMsgGenerator`](<#hashmsggenerator>).
    - Calls the [`finish`](<#hashmsggeneratorfinish>) method of [`HashMsgGenerator`](<#hashmsggenerator>) to complete the test vector definition.
    - Undefines the macro used for formatting bytes.
- **Output**: Generates C include files with SHA-2 test vectors and writes them to stdout or a specified file.
- **Functions Called**:
    - [`firedancer/contrib/codegen/cavp_generate.parse_msg_rsp`](<#parse_msg_rsp>)
    - [`firedancer/contrib/codegen/cavp_generate.HashMsgGenerator`](<#hashmsggenerator>)
    - [`firedancer/contrib/codegen/cavp_generate.HashMsgGenerator.write_test`](<#hashmsggeneratorwrite_test>)
    - [`firedancer/contrib/codegen/cavp_generate.HashMsgGenerator.finish`](<#hashmsggeneratorfinish>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)