<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

A tool for generating and sending Solana transactions, including account creation and transaction monitoring.

# Purpose
This code is a script designed to interact with the Solana blockchain network. It facilitates the creation and management of Solana accounts and the sending of transactions to specified Transaction Processing Unit (TPU) endpoints. The script uses command-line arguments to configure its operation, including specifying TPU endpoints, RPC server details, the number of accounts to create, and the type of transactions to send. It supports different transaction types, such as empty transactions, system transfers, and token transfers.

The script's main components include functions for parsing command-line arguments, creating accounts, generating transactions, and sending transactions. It uses multiprocessing and threading to handle concurrent operations, such as monitoring transaction throughput and fetching recent blockhashes. The script also includes utility functions to interact with the Solana RPC API, such as retrieving account balances and recent blockhashes. The [`main`](<#main>) function orchestrates the overall workflow, setting up the necessary resources and starting worker processes to perform the transaction operations.
# Imports and Dependencies

---
- `argparse`
- `logging`
- `json`
- `time`
- `random`
- `socket`
- `math`
- `multiprocessing`
- `threading`
- `requests`
- `functools.partial`
- `typing.List`
- `multiprocessing.sharedctypes.SynchronizedBase`
- `multiprocessing.Event`
- `multiprocessing.Value`
- `multiprocessing.Array`
- `tqdm`
- `pqdm.processes.pqdm`
- `solana.transaction.Transaction`
- `solana.rpc.api.Client`
- `solders.hash.Hash`
- `solana.rpc.commitment.Commitment`
- `solana.rpc.types.TxOpts`
- `solders.keypair.Keypair`
- `solders.system_program.TransferParams`
- `solders.system_program.transfer`
- `solders.compute_budget.set_compute_unit_limit`
- `solders.compute_budget.set_compute_unit_price`
- `solders.pubkey.Pubkey`
- `solders.signature.Signature`
- `solders.message.Message`
- `solders.instruction.AccountMeta`
- `solders.instruction.Instruction`


# Global Variables

---
### TXN\_TYPE\_EMPTY
- **Type**: ``int``
- **Description**: Represents a constant integer value used to identify an empty transaction type in the system. It is assigned the value `0`.
- **Use**: Used to specify the type of transaction as empty when processing or sending transactions.


---
### TXN\_TYPE\_SYSTEM\_TRANSFER
- **Type**: ``int``
- **Description**: Represents a constant integer value used to identify a specific type of transaction, specifically a system transfer transaction, in the codebase. It is assigned the value `1`.
- **Use**: Used to specify the transaction type when creating or processing transactions that involve system transfers.


---
### TXN\_TYPE\_TOKEN\_TRANSFER
- **Type**: ``int``
- **Description**: Represents the transaction type identifier for token transfer operations. It is assigned the integer value `2`.
- **Use**: Used to specify the type of transaction as a token transfer in the program logic.


# Functions

---
### get\_recent\_blockhash<!-- {{#callable:firedancer/contrib/tool/load_gen2.get_recent_blockhash}} -->
[View Source →](<../../../../contrib/tool/load_gen2.py#L37>)

Fetches the most recent blockhash from a Solana RPC endpoint.
- **Inputs**:
    - `rpc`: A string representing the URL of the Solana RPC endpoint to query.
- **Logic and Control Flow**:
    - Creates a JSON-RPC request payload to call the 'getLatestBlockhash' method.
    - Sends a POST request to the specified RPC endpoint with the JSON-RPC payload.
    - Parses the JSON response to extract the blockhash value.
    - Converts the blockhash string to a `Hash` object using `Hash.from_string`.
- **Output**: A `Hash` object representing the most recent blockhash.


---
### get\_balance<!-- {{#callable:firedancer/contrib/tool/load_gen2.get_balance}} -->
[View Source →](<../../../../contrib/tool/load_gen2.py#L42>)

Retrieves the balance of a given account from a specified RPC endpoint.
- **Inputs**:
    - `rpc`: A string representing the RPC endpoint URL to send the request to.
    - `acc`: A `Pubkey` object representing the public key of the account whose balance is to be retrieved.
- **Logic and Control Flow**:
    - Iterates up to 10 times to attempt retrieving the account balance.
    - Converts the `acc` parameter to a string to include in the JSON-RPC request payload.
    - Sends a POST request to the specified `rpc` endpoint with the JSON-RPC payload to get the account balance.
    - Checks if the HTTP response status code is not 200, and if so, returns 0 as the balance.
    - If the response is successful, extracts and returns the balance value from the JSON response.
    - If an exception occurs during the request, waits for 0.1 seconds before retrying.
- **Output**: An integer representing the balance of the account, or 0 if the request fails.


---
### parse\_args<!-- {{#callable:firedancer/contrib/tool/load_gen2.parse_args}} -->
[View Source →](<../../../../contrib/tool/load_gen2.py#L57>)

Parses command-line arguments for a script that interacts with Solana transactions.
- **Inputs**: None
- **Logic and Control Flow**:
    - Creates an `ArgumentParser` object to handle command-line arguments.
    - Adds several required arguments to the parser, each with a specific type and help description.
    - Parses the command-line arguments using `parser.parse_args()`.
    - Returns the parsed arguments as an `argparse.Namespace` object.
- **Output**: An `argparse.Namespace` object containing the parsed command-line arguments.


---
### send\_round\_of\_txs<!-- {{#callable:firedancer/contrib/tool/load_gen2.send_round_of_txs}} -->
[View Source →](<../../../../contrib/tool/load_gen2.py#L106>)

Sends a batch of transactions to specified TPU endpoints using a UDP socket.
- **Inputs**:
    - `txs`: A list of transactions to send.
    - `sock`: A UDP socket used to send the transactions.
    - `tpus`: A list of TPU (Transaction Processing Unit) endpoints to which the transactions are sent.
    - `rpc`: The RPC endpoint used to initialize the client.
    - `funder`: The funder account, though not used directly in this function.
- **Logic and Control Flow**:
    - Initializes a `Client` object with the given `rpc` endpoint.
    - Iterates over each transaction in `txs` using a progress bar provided by `tqdm`.
    - Converts each transaction to a byte message using the `to_solders` method.
    - Sends the byte message to each TPU endpoint in `tpus` using the `sock.sendto` method.
    - Pauses for 0.001 seconds after sending the message to all TPU endpoints.
- **Output**: No return value; the function sends transactions over the network.


---
### create\_accounts\_tx<!-- {{#callable:firedancer/contrib/tool/load_gen2.create_accounts_tx}} -->
[View Source →](<../../../../contrib/tool/load_gen2.py#L115>)

Creates a transaction to transfer lamports from a funder to multiple accounts.
- **Inputs**:
    - `funder`: A `Keypair` object representing the account that will fund the transactions.
    - `lamports`: An integer specifying the amount of lamports to transfer to each account.
    - `recent_blockhash`: A `Hash` object representing the recent blockhash for the transaction.
    - `accs`: A list of account objects to which lamports will be transferred.
- **Logic and Control Flow**:
    - Initialize a `Transaction` object with the given `recent_blockhash`, no fee payer, the funder's public key, and an empty list of instructions.
    - Add a compute unit price setting instruction to the transaction with a price of 1.
    - Iterate over each account in `accs` and add a transfer instruction to the transaction for each account, transferring the specified `lamports` from the funder to the account.
    - Sign the transaction with the funder's keypair.
    - Return the signed transaction.
- **Output**: A `Transaction` object that is signed and ready to be sent to the network.


---
### get\_balance\_sufficient<!-- {{#callable:firedancer/contrib/tool/load_gen2.get_balance_sufficient}} -->
[View Source →](<../../../../contrib/tool/load_gen2.py#L124>)

Checks if an account's balance is sufficient compared to a specified amount of lamports.
- **Inputs**:
    - `lamports`: The minimum balance required, specified in lamports.
    - `rpc`: The RPC endpoint URL as a string to query the account balance.
    - `acc`: The account object to check for sufficient balance.
- **Logic and Control Flow**:
    - Immediately returns the account object `acc` without performing any balance check.
    - The subsequent code, which is not executed due to the immediate return, would retrieve the account's balance using the [`get_balance`](<#get_balance>) function.
    - If the balance is greater than or equal to the specified `lamports`, it would return the account object `acc`.
    - If the balance is less than the specified `lamports`, it would return `None`.
- **Output**: Returns the account object `acc` immediately without checking the balance.
- **Functions Called**:
    - [`firedancer/contrib/tool/load_gen2.get_balance`](<#get_balance>)


---
### create\_accounts<!-- {{#callable:firedancer/contrib/tool/load_gen2.create_accounts}} -->
[View Source →](<../../../../contrib/tool/load_gen2.py#L132>)

Creates and funds a specified number of accounts with a given amount of lamports using a seed and a funder account.
- **Inputs**:
    - `funder`: The account that provides the lamports to fund the new accounts.
    - `rpc`: The RPC endpoint URL for the Solana network.
    - `num_accs`: The number of accounts to create.
    - `lamports`: The amount of lamports to fund each account with.
    - `seed`: The seed used to derive the keypairs for the new accounts.
    - `sock`: The socket used to send transactions.
    - `tpus`: A list of TPU UDP endpoints to send transactions to.
    - `txn_type`: The type of transaction to create for the accounts.
- **Logic and Control Flow**:
    - Initialize an empty list `accs` to store the created accounts.
    - Iterate over the range of `num_accs` to create keypairs using the provided `seed` and append them to `accs`.
    - Convert `accs` to a set `remaining_accs` to track accounts that need funding.
    - While there are accounts in `remaining_accs`, check if each account has sufficient balance using `pqdm` and `get_balance_sufficient`.
    - Remove accounts with sufficient balance from `remaining_accs`.
    - If `remaining_accs` is empty, exit the loop.
    - Divide `remaining_accs` into chunks of size 8 and get the recent blockhash using [`get_recent_blockhash`](<#get_recent_blockhash>).
    - Create transactions for each chunk using `pqdm` and `create_accounts_tx`, then send them using [`send_round_of_txs`](<#send_round_of_txs>).
    - Return the list of created accounts `accs`.
- **Output**: A list of created `Keypair` objects representing the new accounts.
- **Functions Called**:
    - [`firedancer/contrib/tool/load_gen2.get_recent_blockhash`](<#get_recent_blockhash>)
    - [`firedancer/contrib/tool/load_gen2.send_round_of_txs`](<#send_round_of_txs>)


---
### gen\_tx\_empty<!-- {{#callable:firedancer/contrib/tool/load_gen2.gen_tx_empty}} -->
[View Source →](<../../../../contrib/tool/load_gen2.py#L156>)

Generates and signs a transaction with a specified compute unit price and limit, using a given recent blockhash, key, and account.
- **Inputs**:
    - `recent_blockhash`: The recent blockhash to use for the transaction.
    - `key`: The key used to sign the transaction.
    - `acc`: The account associated with the transaction.
    - `cu_price`: The compute unit price to set for the transaction, as an integer.
- **Logic and Control Flow**:
    - Creates a `Transaction` object with the given `recent_blockhash`, `acc`, and a list of instructions.
    - Sets the compute unit limit to 152 and adds an `Instruction` with a specific public key and the compute unit price converted to bytes.
    - Signs the transaction using the provided `key`.
    - Returns the signed transaction.
- **Output**: A signed `Transaction` object.


---
### gen\_tx\_system\_transfer<!-- {{#callable:firedancer/contrib/tool/load_gen2.gen_tx_system_transfer}} -->
[View Source →](<../../../../contrib/tool/load_gen2.py#L166>)

Generates a system transfer transaction with specified compute unit price and limit.
- **Inputs**:
    - `recent_blockhash`: The recent blockhash to use for the transaction.
    - `key`: The key to sign the transaction.
    - `acc`: The account to use for the transaction.
    - `cu_price`: The compute unit price to set for the transaction.
- **Logic and Control Flow**:
    - Creates a `Message` object with a compute unit price, compute unit limit, and a transfer instruction using the provided `recent_blockhash` and `acc`.
    - Populates a `Transaction` object with the created `Message` and a random signature.
    - Returns the populated `Transaction` object.
- **Output**: A `Transaction` object populated with the specified message and signature.


---
### send\_txs<!-- {{#callable:firedancer/contrib/tool/load_gen2.send_txs}} -->
[View Source →](<../../../../contrib/tool/load_gen2.py#L174>)

Sends transactions to specified TPU endpoints using provided keypairs and transaction type until a stop event is triggered.
- **Inputs**:
    - `rpc`: A string representing the RPC endpoint URL.
    - `tpus`: A list of strings representing the TPU UDP endpoints to send transactions to.
    - `keys`: A list of `Keypair` objects used to sign transactions.
    - `tx_idx`: A shared multiprocessing value to track the index of transactions.
    - `mult`: An integer multiplier, though not used in the function.
    - `idx`: An integer index used for identifying the worker process.
    - `stop_event`: A multiprocessing event used to signal when to stop sending transactions.
    - `rbh`: A shared array representing the recent blockhash.
    - `txn_type`: An integer representing the type of transaction to generate and send.
- **Logic and Control Flow**:
    - Creates a UDP socket for sending transactions.
    - Generates a list of public keys from the provided keypairs.
    - Converts the recent blockhash from bytes to a `Hash` object.
    - Initializes the compute unit price to 1.
    - Enters a loop that continues until the `stop_event` is set.
    - In each loop iteration, updates the recent blockhash and adjusts the compute unit price based on changes in the blockhash.
    - For each keypair, generates a transaction based on the specified transaction type.
    - Converts the transaction to bytes and sends it to each TPU endpoint using the UDP socket.
    - Increments the transaction index by the number of keys after sending all transactions.
    - Prints a stopping message with the worker index when the loop exits.
- **Output**: No return value; the function operates by sending transactions over the network and updating shared state.
- **Functions Called**:
    - [`firedancer/contrib/tool/load_gen2.gen_tx_empty`](<#gen_tx_empty>)
    - [`firedancer/contrib/tool/load_gen2.gen_tx_system_transfer`](<#gen_tx_system_transfer>)


---
### monitor\_send\_tps<!-- {{#callable:firedancer/contrib/tool/load_gen2.monitor_send_tps}} -->
[View Source →](<../../../../contrib/tool/load_gen2.py#L204>)

Monitors and prints the transactions per second (TPS) at regular intervals, adjusting the interval if TPS is zero.
- **Inputs**:
    - `tx_idx`: A `SynchronizedBase` object that holds the current transaction index, used to calculate TPS.
    - `stop_event`: An `Event` object that signals when to stop monitoring.
    - `interval`: An integer specifying the time interval in seconds between TPS calculations, defaulting to 1.
- **Logic and Control Flow**:
    - Initialize `prev_count` to 0 and `prev_time` to the current time.
    - Enter a loop that continues while `interval` is less than 10 and `stop_event` is not set.
    - Sleep for the duration of `interval`.
    - Acquire a lock on `tx_idx` and read its value into `current_count`.
    - Calculate the current time and store it in `curr_time`.
    - Compute TPS as the difference between `current_count` and `prev_count` divided by `interval`.
    - Update `prev_count` to `current_count`.
    - Calculate the elapsed time as the difference between `curr_time` and `prev_time`.
    - Print the TPS and elapsed time.
    - If TPS is zero, increment `interval` by 1.
    - Update `prev_time` to `curr_time`.
- **Output**: No return value; the function prints TPS and elapsed time to the console.


---
### fetch\_recent\_blockhash<!-- {{#callable:firedancer/contrib/tool/load_gen2.fetch_recent_blockhash}} -->
[View Source →](<../../../../contrib/tool/load_gen2.py#L220>)

Continuously fetches the most recent blockhash from a Solana RPC endpoint and updates a shared memory array with it.
- **Inputs**:
    - `rbh`: A shared memory array to store the most recent blockhash as bytes.
    - `rpc`: A string representing the RPC endpoint URL to fetch the blockhash from.
    - `stop_event`: A threading event used to signal when to stop fetching the blockhash.
- **Logic and Control Flow**:
    - Initialize `prev_recent_blockhash` with the current blockhash fetched from the RPC endpoint using [`get_recent_blockhash`](<#get_recent_blockhash>) function.
    - Enter a loop that continues until `stop_event` is set.
    - In each iteration, pause execution for 0.1 seconds using `time.sleep`.
    - Attempt to fetch the current blockhash from the RPC endpoint.
    - If the fetched blockhash is the same as `prev_recent_blockhash`, continue to the next iteration without making changes.
    - If the fetched blockhash is different, update the `rbh` array with the new blockhash and set `prev_recent_blockhash` to this new value.
    - Print the new blockhash to the console.
    - If an exception occurs during the blockhash fetch, print 'bad RBH' to the console.
- **Output**: No return value; updates the `rbh` array in place with the latest blockhash.
- **Functions Called**:
    - [`firedancer/contrib/tool/load_gen2.get_recent_blockhash`](<#get_recent_blockhash>)


---
### main<!-- {{#callable:firedancer/contrib/tool/load_gen2.main}} -->
[View Source →](<../../../../contrib/tool/load_gen2.py#L235>)

Initializes and manages the process of creating accounts, sending transactions, and monitoring transaction throughput using multiprocessing and threading.
- **Inputs**: None
- **Logic and Control Flow**:
    - Parse command-line arguments using `parse_args()` to get necessary parameters.
    - Create a `Client` object with the RPC endpoint specified in the arguments.
    - Open and read the seed and funder files to obtain the seed and funder key data.
    - Create a UDP socket for communication with TPU endpoints.
    - Parse and convert TPU endpoints from strings to tuples of host and port.
    - Determine the transaction type based on the `txn_type` argument and set the corresponding constant.
    - Call `create_accounts()` to generate accounts with the specified parameters.
    - Divide the created accounts into chunks based on the number of workers specified.
    - Initialize shared memory and synchronization primitives for inter-process communication.
    - Start a monitoring thread to track transaction throughput using `monitor_send_tps()`.
    - Start a fetching thread to continuously update the recent blockhash using `fetch_recent_blockhash()`.
    - Create and start worker processes to send transactions using the `send_txs()` function.
    - Enter an infinite loop to keep the main process running, allowing worker processes to continue execution.
    - On termination, set the stop event to signal all threads and processes to stop.
    - Join all worker processes to ensure they complete before the program exits.
- **Output**: No return value; the function orchestrates the execution of multiple processes and threads to perform its tasks.
- **Functions Called**:
    - [`firedancer/contrib/tool/load_gen2.parse_args`](<#parse_args>)
    - [`firedancer/contrib/tool/load_gen2.create_accounts`](<#create_accounts>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)