<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

API for tracking block confirmation levels based on stake thresholds in a Solana cluster.

# Purpose
The `fd_notar.h` file defines an API for managing and tracking the confirmation levels of blocks in a blockchain network, specifically for the Solana blockchain. The API is designed to monitor when blocks reach certain stake thresholds, which are referred to as "confirmation levels." These levels include "propagation confirmed," "duplicate confirmed," and "optimistically confirmed," each representing different stages of block validation based on the percentage of stake votes received. The file includes structures and functions to manage validators' votes and block information, such as `fd_notar_vtr_t` for validator tracking and `fd_notar_blk_t` for block tracking.

The file provides several functions for interacting with the notarization system, such as [`fd_notar_new`](<#fd_notar_new>), [`fd_notar_join`](<#fd_notar_join>), [`fd_notar_leave`](<#fd_notar_leave>), and [`fd_notar_delete`](<#fd_notar_delete>), which manage the lifecycle of a notar object. Additionally, the [`fd_notar_vote`](<#fd_notar_vote>) function updates the notar with a vote, and [`fd_notar_publish`](<#fd_notar_publish>) updates the root slot, pruning outdated blocks. The file uses macros and includes other utility files to handle dynamic mapping and set operations, ensuring efficient management of validators and blocks. The API is intended for use in environments where tracking and confirming block propagation and validation are critical for maintaining consensus and network integrity.
# Imports and Dependencies

---
- `../fd_choreo_base.h`
- `../tower/fd_tower.h`
- `../../util/tmpl/fd_map_dynamic.c`
- `../../util/tmpl/fd_set.c`


# Global Variables

---
### pubkey\_null
- **Type**: ``fd_pubkey_t``
- **Description**: A constant variable of type `fd_pubkey_t` initialized with all zero values. It represents a null or invalid public key.
- **Use**: Used as a sentinel value to represent an invalid or uninitialized public key in the system.


# Data Structures

---
### fd\_notar\_vtr
- **Type**: ``struct``
- **Members**:
    - ``pubkey``: A public key used as the map key.
    - ``memo``: Reserved for use with `fd_map_dynamic`.
    - ``bit``: Bit position in `fd_notar_blk_vtrs` (a set of validators).
    - ``vote``: The most recent slot number the validator voted for.
    - ``hash``: The most recent hash the validator voted for.
- **Description**: Represents a validator's voting record, including the public key, the most recent slot and hash they voted for, and additional metadata for dynamic mapping and bit position tracking.


---
### fd\_notar\_vtr\_t
- **Type**: ``struct``
- **Members**:
    - ``pubkey``: A public key that serves as the map key.
    - ``memo``: A reserved field for `fd_map_dynamic`.
    - ``bit``: The bit position in `fd_notar_blk_vtrs` (a set).
    - ``vote``: The most recent slot the validator voted for.
    - ``hash``: The most recent hash the validator voted for.
- **Description**: Tracks validator voting information, including the public key, the most recent slot and hash voted for, and additional metadata for dynamic mapping.


---
### fd\_notar\_blk
- **Type**: ``struct``
- **Members**:
    - `slot`: The slot number of the block.
    - `parent_slot`: The slot number of the parent block.
    - `bank_hash`: The hash of the bank state for the block.
    - `stake`: The stake associated with the block.
    - `pro_conf`: The propagation confirmation status of the block.
    - `dup_conf`: The duplicate confirmation status of the block (unimplemented).
    - `opt_conf`: The optimistic confirmation status of the block (unimplemented).
    - `vtrs`: An array of validator identities that have voted for this block.
- **Description**: Represents a block in the notarization process, tracking its slot, parent slot, bank hash, associated stake, and confirmation statuses. It also includes an array of validators that have voted for the block, which is crucial for determining the block's confirmation level based on the stake thresholds.


---
### fd\_notar\_blk\_t
- **Type**: ``struct``
- **Members**:
    - ``slot``: The slot number of the block.
    - ``parent_slot``: The slot number of the parent block.
    - ``bank_hash``: The hash of the bank state for the block.
    - ``stake``: The total stake associated with the block.
    - ``pro_conf``: The propagation confirmation status of the block.
    - ``dup_conf``: The duplicate confirmation status of the block (unimplemented).
    - ``opt_conf``: The optimistic confirmation status of the block (unimplemented).
    - ``vtrs``: An array of validator identities that have voted for this block.
- **Description**: Tracks information about a block in a blockchain, including its slot number, parent slot, bank hash, total stake, and confirmation statuses. It also maintains a list of validators that have voted for the block.


---
### fd\_notar
- **Type**: ``struct fd_notar``
- **Members**:
    - ``blks``: Pointer to an array of `fd_notar_blk_t` structures representing blocks.
    - ``vtrs``: Pointer to an array of `fd_notar_vtr_t` structures representing validators.
    - ``root``: Current root slot in the notarization process.
    - ``stake``: Total stake in the current epoch.
- **Description**: Tracks the state of block notarization by maintaining information about blocks, validators, the current root slot, and the total stake in the current epoch. It is aligned to 128 bytes for performance reasons.


---
### fd\_notar\_t
- **Type**: ``struct fd_notar``
- **Members**:
    - ``blks``: Pointer to an array of `fd_notar_blk_t` structures representing blocks.
    - ``vtrs``: Pointer to an array of `fd_notar_vtr_t` structures representing validators.
    - ``root``: Current root slot number.
    - ``stake``: Total stake in the current epoch.
- **Description**: Tracks the state of block confirmations in a blockchain network by maintaining information about blocks and validators. It includes pointers to arrays of blocks and validators, and keeps track of the current root slot and total stake in the epoch.


# Functions

---
### fd\_notar\_align<!-- {{#callable:fd_notar_align}} -->
[View Source →](<../../../../../src/choreo/notar/fd_notar.h#L99>)

Returns the alignment requirement for the `fd_notar_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls the `alignof` operator on `fd_notar_t` to determine its alignment requirement.
    - Returns the result of the `alignof` operator.
- **Output**: The function returns an `ulong` value representing the alignment requirement of the `fd_notar_t` structure.


---
### fd\_notar\_footprint<!-- {{#callable:fd_notar_footprint}} -->
[View Source →](<../../../../../src/choreo/notar/fd_notar.h#L104>)

Calculates the memory footprint required for a notarization structure based on the maximum number of blocks.
- **Inputs**:
    - `blk_max`: The maximum number of blocks for which the footprint is calculated.
- **Logic and Control Flow**:
    - Calculate `lg_blk_max` as the most significant bit of the smallest power of two greater than or equal to `blk_max`.
    - Calculate `lg_vtr_max` as the most significant bit of the smallest power of two greater than or equal to `FD_VOTER_MAX`.
    - Initialize the layout with `FD_LAYOUT_INIT`.
    - Append the alignment and size of `fd_notar_t` to the layout.
    - Append the alignment and footprint of block data using `fd_notar_blk_align()` and `fd_notar_blk_footprint(lg_blk_max)` to the layout.
    - Append the alignment and footprint of voter data using `fd_notar_vtr_align()` and `fd_notar_vtr_footprint(lg_vtr_max)` to the layout.
    - Finalize the layout with `fd_notar_align()` and return the total footprint.
- **Output**: The function returns an `ulong` representing the total memory footprint required for the notarization structure.
- **Functions Called**:
    - [`fd_notar_align`](<#fd_notar_align>)


# Function Declarations (Public API)

---
### fd\_notar\_new<!-- {{#callable_declaration:fd_notar_new}} -->
[View Source →](<../../../../../src/choreo/notar/fd_notar.h#L123>)

Formats a memory region for use as a notar.
- **Description**: Use this function to prepare a memory region for notarization operations. The memory region must be non-null, properly aligned, and have sufficient size to accommodate the notar structure. This function initializes the memory region and returns a pointer to it. Ensure that the memory region is part of a workspace before calling this function. If the memory is null, misaligned, or the block maximum is invalid, the function logs a warning and returns null.
- **Inputs**:
    - `shmem`: A pointer to the memory region to format. Must not be null and must be aligned according to `fd_notar_align()`. The memory must be part of a workspace.
    - `blk_max`: The maximum number of blocks to support. Must be a valid value that results in a non-zero footprint.
- **Output**: Returns a pointer to the formatted memory region on success, or null on failure.
- **See Also**: [`fd_notar_new`](<fd_notar.c.md#fd_notar_new>)  (Implementation)


---
### fd\_notar\_join<!-- {{#callable_declaration:fd_notar_join}} -->
[View Source →](<../../../../../src/choreo/notar/fd_notar.h#L132>)

Joins the caller to a notarization memory region.
- **Description**: Use this function to access a notarization memory region from the caller's local address space. This function checks if the provided pointer is non-null, properly aligned, and part of a workspace. It is important to ensure that the memory region is correctly formatted and aligned before calling this function. If any of these conditions are not met, the function logs a warning and returns NULL.
- **Inputs**:
    - `shnotar`: A pointer to the memory region representing the notarization. Must not be null, must be aligned according to `fd_notar_align()`, and must be part of a workspace. If these conditions are not met, the function returns NULL.
- **Output**: Returns a pointer to the notarization memory region in the local address space on success, or NULL if the input is invalid.
- **See Also**: [`fd_notar_join`](<fd_notar.c.md#fd_notar_join>)  (Implementation)


---
### fd\_notar\_leave<!-- {{#callable_declaration:fd_notar_leave}} -->
[View Source →](<../../../../../src/choreo/notar/fd_notar.h#L139>)

Leaves a current local join to a notar.
- **Description**: Use this function to leave a current local join to a notar. It returns a pointer to the underlying shared memory region if successful. If the input is null, it logs a warning and returns null. This function is useful when you need to safely disconnect from a notar without losing access to the shared memory.
- **Inputs**:
    - `notar`: A pointer to a `fd_notar_t` structure representing the notar to leave. Must not be null. If null, the function logs a warning and returns null.
- **Output**: Returns a pointer to the underlying shared memory region on success, or null if the input is null.
- **See Also**: [`fd_notar_leave`](<fd_notar.c.md#fd_notar_leave>)  (Implementation)


---
### fd\_notar\_delete<!-- {{#callable_declaration:fd_notar_delete}} -->
[View Source →](<../../../../../src/choreo/notar/fd_notar.h#L148>)

Unformats a memory region used as a notar.
- **Description**: Use this function to unformat a memory region that was previously formatted for use as a notar. It assumes that only the local process is joined to the region. This function is useful when you want to reclaim the memory used by a notar. It returns a pointer to the underlying shared memory region, transferring ownership of the memory back to the caller. If the input is null or misaligned, it logs a warning and returns null.
- **Inputs**:
    - `notar`: A pointer to the memory region used as a notar. It must not be null and must be aligned according to `fd_notar_align()`. If the pointer is null or misaligned, the function logs a warning and returns null.
- **Output**: Returns a pointer to the underlying shared memory region if successful, or null if the input is invalid.
- **See Also**: [`fd_notar_delete`](<fd_notar.c.md#fd_notar_delete>)  (Implementation)


---
### fd\_notar\_vote<!-- {{#callable_declaration:fd_notar_vote}} -->
[View Source →](<../../../../../src/choreo/notar/fd_notar.h#L158>)

Updates the notarization state with a vote.
- **Description**: Use this function to record a vote in the notarization system. It updates the state with a voter's identity, stake, vote tower, and bank hash. This function should be called when a valid vote needs to be registered. Ensure that the `pubkey` is part of the known voters for the current epoch, and the `vote_tower` is not empty. The function will not count votes for slots that have not been replayed. It also checks if the bank hash matches before counting additional votes in the tower.
- **Inputs**:
    - `notar`: A pointer to an `fd_notar_t` structure representing the notarization state. Must not be null.
    - `pubkey`: A pointer to an `fd_pubkey_t` structure representing the voter's validator identity. Must not be null and must be part of the known voters for the current epoch.
    - `stake`: An unsigned long integer representing the voter's stake in the current epoch. Must be a valid stake value.
    - `vote_tower`: A pointer to an `fd_tower_t` structure representing the parsed tower from the vote transaction or replay vote state. Must not be null and must not be empty.
    - `vote_hash`: A pointer to an `fd_hash_t` structure representing the voter's bank hash for the last slot in the tower. Must not be null.
- **Output**: None
- **See Also**: [`fd_notar_vote`](<fd_notar.c.md#fd_notar_vote>)  (Implementation)


---
### fd\_notar\_publish<!-- {{#callable_declaration:fd_notar_publish}} -->
[View Source →](<../../../../../src/choreo/notar/fd_notar.h#L170>)

Publishes a new root slot and removes outdated blocks.
- **Description**: Use this function to update the root slot of a notarization structure and remove blocks with slot numbers less than the previous root. This function is typically called when a new root slot is determined, ensuring that only relevant blocks are retained. It is important to ensure that the `notar` parameter is a valid pointer to an initialized `fd_notar_t` structure. The function updates the `root` field of the `notar` structure to the new root value.
- **Inputs**:
    - `notar`: A pointer to an `fd_notar_t` structure. Must not be null and should be properly initialized before calling this function. The caller retains ownership.
    - `root`: An unsigned long integer representing the new root slot. It should be greater than or equal to the current root slot in the `notar` structure.
- **Output**: None
- **See Also**: [`fd_notar_publish`](<fd_notar.c.md#fd_notar_publish>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)