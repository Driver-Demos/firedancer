<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for managing and processing votes in a blockchain notarization system.

# Purpose
The code defines a set of functions for managing and interacting with a data structure related to voting and confirmation processes, likely in a distributed system or blockchain context. The primary data structure is `fd_notar_t`, which appears to manage blocks (`blks`) and voters (`vtrs`). The functions provided include [`fd_notar_new`](<#fd_notar_new>), which initializes a new `fd_notar_t` structure in shared memory, ensuring proper alignment and memory footprint. The [`fd_notar_join`](<#fd_notar_join>), [`fd_notar_leave`](<#fd_notar_leave>), and [`fd_notar_delete`](<#fd_notar_delete>) functions manage the lifecycle of the `fd_notar_t` structure, allowing it to be joined, left, or deleted from a workspace.

The [`fd_notar_vote`](<#fd_notar_vote>) function processes votes from a set of known voters, updating the confirmation status of blocks based on the votes received. It checks the validity of votes and ensures that only votes for slots that have been replayed are counted. The function also handles the propagation of confirmation status through a hierarchy of slots, ensuring that once a slot reaches a certain confirmation threshold, its ancestors are also confirmed. The [`fd_notar_publish`](<#fd_notar_publish>) function updates the root of the `fd_notar_t` structure, removing blocks that are no longer needed. The code is designed to be part of a larger system, likely involving shared memory and workspace management, and it includes several checks and logging for error conditions.
# Imports and Dependencies

---
- `fd_notar.h`


# Functions

---
### fd\_notar\_new<!-- {{#callable:fd_notar_new}} -->
[View Source →](<../../../../../src/choreo/notar/fd_notar.c#L7>)

Initializes a new `fd_notar_t` structure in shared memory with specified block capacity.
- **Inputs**:
    - `shmem`: A pointer to the shared memory where the `fd_notar_t` structure will be initialized.
    - `blk_max`: The maximum number of blocks that the `fd_notar_t` structure can handle.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL and log a warning if true, then return NULL.
    - Check if `shmem` is aligned according to `fd_notar_align()` and log a warning if not, then return NULL.
    - Calculate the memory footprint required for the `fd_notar_t` structure using `fd_notar_footprint(blk_max)` and log a warning if the footprint is zero, then return NULL.
    - Verify that `shmem` is part of a workspace using `fd_wksp_containing(shmem)` and log a warning if not, then return NULL.
    - Clear the memory at `shmem` with the calculated footprint using `fd_memset`.
    - Calculate the logarithm base 2 of the smallest power of 2 greater than or equal to `blk_max` using `fd_ulong_find_msb(fd_ulong_pow2_up(blk_max))`.
    - Initialize scratch memory allocation with `FD_SCRATCH_ALLOC_INIT`.
    - Allocate memory for `fd_notar_t`, blocks, and voters using `FD_SCRATCH_ALLOC_APPEND`.
    - Ensure the scratch allocation is correctly finalized with `FD_SCRATCH_ALLOC_FINI`.
    - Initialize the `blks` and `vtrs` fields of `notar` using `fd_notar_blk_new`.
- **Output**: Returns a pointer to the initialized shared memory (`shmem`) if successful, or NULL if any error occurs during initialization.
- **Functions Called**:
    - [`fd_notar_align`](<fd_notar.h.md#fd_notar_align>)
    - [`fd_notar_footprint`](<fd_notar.h.md#fd_notar_footprint>)


---
### fd\_notar\_join<!-- {{#callable:fd_notar_join}} -->
[View Source →](<../../../../../src/choreo/notar/fd_notar.c#L47>)

Validates and returns a pointer to a `fd_notar_t` structure if it is non-null, aligned, and part of a workspace.
- **Inputs**:
    - `shnotar`: A pointer to a shared memory object that is expected to be a `fd_notar_t` structure.
- **Logic and Control Flow**:
    - Cast `shnotar` to a `fd_notar_t` pointer and assign it to `notar`.
    - Check if `notar` is NULL; if true, log a warning and return NULL.
    - Check if `notar` is aligned according to [`fd_notar_align`](<fd_notar.h.md#fd_notar_align>); if not, log a warning and return NULL.
    - Determine if `notar` is part of a workspace using `fd_wksp_containing`; if not, log a warning and return NULL.
    - Return the `notar` pointer.
- **Output**: A pointer to a `fd_notar_t` structure if all checks pass, otherwise NULL.
- **Functions Called**:
    - [`fd_notar_align`](<fd_notar.h.md#fd_notar_align>)


---
### fd\_notar\_leave<!-- {{#callable:fd_notar_leave}} -->
[View Source →](<../../../../../src/choreo/notar/fd_notar.c#L70>)

Returns the input `notar` pointer as a `void` pointer after checking for null.
- **Inputs**:
    - `notar`: A constant pointer to an `fd_notar_t` structure that the function will check and return.
- **Logic and Control Flow**:
    - Check if `notar` is null using `FD_UNLIKELY`; if true, log a warning and return null.
    - If `notar` is not null, cast it to a `void` pointer and return it.
- **Output**: A `void` pointer to the `notar` structure, or null if `notar` is null.


---
### fd\_notar\_delete<!-- {{#callable:fd_notar_delete}} -->
[View Source →](<../../../../../src/choreo/notar/fd_notar.c#L81>)

Validates and returns a pointer to a notar object if it is non-null and properly aligned.
- **Inputs**:
    - `notar`: A pointer to a notar object that needs validation and potential deletion.
- **Logic and Control Flow**:
    - Check if `notar` is NULL; if true, log a warning and return NULL.
    - Check if `notar` is not aligned according to [`fd_notar_align`](<fd_notar.h.md#fd_notar_align>); if true, log a warning and return NULL.
    - Return the `notar` pointer if it passes the above checks.
- **Output**: Returns the `notar` pointer if it is valid and aligned, otherwise returns NULL.
- **Functions Called**:
    - [`fd_notar_align`](<fd_notar.h.md#fd_notar_align>)


---
### fd\_notar\_vote<!-- {{#callable:fd_notar_vote}} -->
[View Source →](<../../../../../src/choreo/notar/fd_notar.c#L97>)

Processes a vote by verifying its validity and updating the confirmation status of slots in the vote tower.
- **Inputs**:
    - `notar`: A pointer to an `fd_notar_t` structure that contains the current state of the notary.
    - `pubkey`: A constant pointer to an `fd_pubkey_t` structure representing the public key of the voter.
    - `stake`: An unsigned long integer representing the stake associated with the vote.
    - `vote_tower`: A constant pointer to an `fd_tower_t` structure representing the tower of votes.
    - `vote_hash`: A constant pointer to an `fd_hash_t` structure representing the hash of the vote.
- **Logic and Control Flow**:
    - Query the voter's record using `fd_notar_vtr_query` and return if the voter is unknown.
    - Check if the vote tower is empty using `fd_tower_votes_peek_tail_const` and return if it is.
    - Query the block for the last vote slot using `fd_notar_blk_query` and return if the slot has not been replayed.
    - Check if the last vote slot has already been counted and return if it has.
    - Insert the voter's bit into the block's voter record and add the stake to the block's stake.
    - Compare the block's bank hash with the vote hash and return if they do not match.
    - Iterate over the vote tower in reverse, skipping the last vote as it has already been counted.
    - For each vote, check if the vote slot is valid and if the voter's stake has already been counted.
    - Insert the voter's bit into the block's voter record and add the stake to the block's stake.
    - Check if the slot reaches propagation confirmation and update the confirmation status of ancestor slots if it does.
- **Output**: No output is returned; the function updates the state of the `notar` structure in place.


---
### fd\_notar\_publish<!-- {{#callable:fd_notar_publish}} -->
[View Source →](<../../../../../src/choreo/notar/fd_notar.c#L191>)

Updates the root of the `fd_notar_t` structure and removes blocks from the `blks` array up to the new root.
- **Inputs**:
    - `notar`: A pointer to an `fd_notar_t` structure that contains the blocks and other related data.
    - `root`: An unsigned long integer representing the new root value to update in the `fd_notar_t` structure.
- **Logic and Control Flow**:
    - Iterates over the slots from the current `notar->root` to the specified `root`.
    - For each slot, queries the block using `fd_notar_blk_query` to check if it exists.
    - If the block exists, removes it using `fd_notar_blk_remove`.
    - Updates `notar->root` to the new `root` value.
- **Output**: No return value; the function modifies the `notar` structure in place.



---
Made with ❤️ by [Driver](https://www.driver.ai/)