<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for managing and verifying FEC and proof data structures in memory.

# Purpose
The code provides functionality for managing and verifying Forward Error Correction (FEC) and proof data structures in a memory-efficient manner. It includes functions to create, join, leave, and delete `fd_eqvoc_t` objects, which are used to handle FEC and proof operations. The [`fd_eqvoc_new`](<#fd_eqvoc_new>) function initializes a new `fd_eqvoc_t` object in shared memory, setting up pools and maps for FEC and proof data. The [`fd_eqvoc_join`](<#fd_eqvoc_join>) function allows a process to join an existing `fd_eqvoc_t` object, while [`fd_eqvoc_leave`](<#fd_eqvoc_leave>) and [`fd_eqvoc_delete`](<#fd_eqvoc_delete>) handle leaving and deleting these objects, respectively.

The code also includes functions for inserting and searching FEC and proof entries. The [`fd_eqvoc_fec_insert`](<#fd_eqvoc_fec_insert>) function adds a new FEC entry, while [`fd_eqvoc_fec_search`](<#fd_eqvoc_fec_search>) checks for conflicts in FEC entries. Similarly, [`fd_eqvoc_proof_insert`](<#fd_eqvoc_proof_insert>) and [`fd_eqvoc_proof_chunk_insert`](<#fd_eqvoc_proof_chunk_insert>) manage proof entries and their associated data chunks. The [`fd_eqvoc_proof_verify`](<#fd_eqvoc_proof_verify>) function verifies the integrity of proof data by checking signatures and other metadata. The code is structured to handle memory alignment and allocation efficiently, using macros and functions to ensure proper setup and teardown of data structures.
# Imports and Dependencies

---
- `fd_eqvoc.h`
- `../../ballet/shred/fd_shred.h`


# Functions

---
### fd\_eqvoc\_new<!-- {{#callable:fd_eqvoc_new}} -->
[View Source →](<../../../../../src/choreo/eqvoc/fd_eqvoc.c#L4>)

Allocates and initializes memory for an `fd_eqvoc_t` structure and its associated resources using shared memory.
- **Inputs**:
    - ``shmem``: Pointer to the shared memory where the `fd_eqvoc_t` structure and its resources will be allocated.
    - ``fec_max``: Maximum number of Forward Error Correction (FEC) entries to allocate.
    - ``proof_max``: Maximum number of proof entries to allocate.
    - ``seed``: Seed value used for initializing FEC and proof maps.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL; if so, log a warning and return NULL.
    - Check if `shmem` is properly aligned; if not, log a warning and return NULL.
    - Initialize scratch memory allocation with `FD_SCRATCH_ALLOC_INIT`.
    - Allocate memory for `fd_eqvoc_t`, FEC pool, FEC map, proof pool, proof map, SHA-512, and Merkle tree memory using `FD_SCRATCH_ALLOC_APPEND`.
    - Finalize scratch memory allocation with `FD_SCRATCH_ALLOC_FINI`.
    - Set `fec_max`, `proof_max`, and `shred_version` fields in the `fd_eqvoc_t` structure.
    - Initialize FEC pool, FEC map, proof pool, proof map, and SHA-512 using their respective initialization functions.
    - Return the `shmem` pointer.
- **Output**: Returns the `shmem` pointer if successful, or NULL if there is an error.
- **Functions Called**:
    - [`fd_eqvoc_align`](<fd_eqvoc.h.md#fd_eqvoc_align>)


---
### fd\_eqvoc\_join<!-- {{#callable:fd_eqvoc_join}} -->
[View Source →](<../../../../../src/choreo/eqvoc/fd_eqvoc.c#L40>)

Initializes and joins an `fd_eqvoc_t` structure from a shared memory object.
- **Inputs**:
    - `sheqvoc`: A pointer to the shared memory object that contains the `fd_eqvoc_t` structure to join.
- **Logic and Control Flow**:
    - Check if `sheqvoc` is NULL; if so, log a warning and return NULL.
    - Check if `sheqvoc` is aligned according to [`fd_eqvoc_align`](<fd_eqvoc.h.md#fd_eqvoc_align>); if not, log a warning and return NULL.
    - Initialize scratch allocation with `FD_SCRATCH_ALLOC_INIT` using `sheqvoc`.
    - Allocate memory for `fd_eqvoc_t`, FEC pool, FEC map, proof pool, proof map, SHA-512, and bmtree memory using `FD_SCRATCH_ALLOC_APPEND`.
    - Finalize scratch allocation with `FD_SCRATCH_ALLOC_FINI`.
    - Join the allocated FEC pool, FEC map, proof pool, proof map, and SHA-512 using their respective join functions.
    - Assign the bmtree memory directly to `eqvoc->bmtree_mem` without joining.
    - Return the `fd_eqvoc_t` pointer cast from `sheqvoc`.
- **Output**: Returns a pointer to the joined `fd_eqvoc_t` structure, or NULL if an error occurs.
- **Functions Called**:
    - [`fd_eqvoc_align`](<fd_eqvoc.h.md#fd_eqvoc_align>)


---
### fd\_eqvoc\_leave<!-- {{#callable:fd_eqvoc_leave}} -->
[View Source →](<../../../../../src/choreo/eqvoc/fd_eqvoc.c#L73>)

Returns the input `eqvoc` pointer if it is not NULL, otherwise logs a warning and returns NULL.
- **Inputs**:
    - ``eqvoc``: A constant pointer to an `fd_eqvoc_t` structure, which represents the object to leave.
- **Logic and Control Flow**:
    - Check if `eqvoc` is NULL using `FD_UNLIKELY`.
    - If `eqvoc` is NULL, log a warning message 'NULL eqvoc' and return NULL.
    - If `eqvoc` is not NULL, cast it to a `void *` and return it.
- **Output**: A `void *` pointer to the `eqvoc` if it is not NULL, otherwise NULL.


---
### fd\_eqvoc\_delete<!-- {{#callable:fd_eqvoc_delete}} -->
[View Source →](<../../../../../src/choreo/eqvoc/fd_eqvoc.c#L84>)

Validates and returns the `eqvoc` pointer if it is non-null and properly aligned, otherwise logs a warning and returns NULL.
- **Inputs**:
    - ``eqvoc``: A pointer to the `eqvoc` object to be deleted.
- **Logic and Control Flow**:
    - Check if `eqvoc` is NULL using `FD_UNLIKELY`; if true, log a warning and return NULL.
    - Check if `eqvoc` is not aligned using `fd_ulong_is_aligned` and [`fd_eqvoc_align`](<fd_eqvoc.h.md#fd_eqvoc_align>); if true, log a warning and return NULL.
    - Return the `eqvoc` pointer.
- **Output**: Returns the `eqvoc` pointer if it is valid and aligned, otherwise returns NULL.
- **Functions Called**:
    - [`fd_eqvoc_align`](<fd_eqvoc.h.md#fd_eqvoc_align>)


---
### fd\_eqvoc\_init<!-- {{#callable:fd_eqvoc_init}} -->
[View Source →](<../../../../../src/choreo/eqvoc/fd_eqvoc.c#L100>)

Initializes the `shred_version` field of an `fd_eqvoc_t` structure.
- **Inputs**:
    - `eqvoc`: A pointer to an `fd_eqvoc_t` structure that will be initialized.
    - `shred_version`: An unsigned long integer representing the version of the shred to set in the `fd_eqvoc_t` structure.
- **Logic and Control Flow**:
    - Assigns the value of `shred_version` to the `shred_version` field of the `eqvoc` structure.
- **Output**: No return value, as the function is of type `void`.


---
### fd\_eqvoc\_fec\_insert<!-- {{#callable:fd_eqvoc_fec_insert}} -->
[View Source →](<../../../../../src/choreo/eqvoc/fd_eqvoc.c#L105>)

Inserts a new FEC entry into the FEC map and pool of the given `fd_eqvoc_t` structure.
- **Inputs**:
    - ``eqvoc``: A pointer to an `fd_eqvoc_t` structure, which contains the FEC map and pool where the new entry will be inserted.
    - ``slot``: An unsigned long integer representing the slot number for the FEC entry.
    - ``fec_set_idx``: An unsigned integer representing the FEC set index for the FEC entry.
- **Logic and Control Flow**:
    - Creates a `fd_slot_fec_t` key using the `slot` and `fec_set_idx` values.
    - If `FD_EQVOC_USE_HANDHOLDING` is defined, checks if the key already exists in the FEC map and logs an error if it does.
    - Checks if there is space available in the FEC pool; logs an error if the pool is full.
    - Acquires a new FEC entry from the FEC pool.
    - Initializes the new FEC entry with the provided `slot` and `fec_set_idx`, and sets `code_cnt`, `data_cnt`, and `last_idx` to zero or null values.
    - Inserts the new FEC entry into the FEC map.
- **Output**: Returns a pointer to the newly inserted `fd_eqvoc_fec_t` entry.


---
### fd\_eqvoc\_fec\_search<!-- {{#callable:fd_eqvoc_fec_search}} -->
[View Source →](<../../../../../src/choreo/eqvoc/fd_eqvoc.c#L127>)

Searches for a Forward Error Correction (FEC) entry in an equivocation vector based on a given shred and checks for conflicts.
- **Inputs**:
    - ``eqvoc``: A pointer to a constant `fd_eqvoc_t` structure representing the equivocation vector.
    - ``shred``: A pointer to a constant `fd_shred_t` structure representing the shred to search for in the FEC set.
- **Logic and Control Flow**:
    - Query the FEC entry using [`fd_eqvoc_fec_query`](<fd_eqvoc.h.md#fd_eqvoc_fec_query>) with the shred's slot and FEC set index.
    - If an entry is found, check if the signature of the entry matches the shred's signature; if not, return the entry.
    - Check if the shred's index is greater than the entry's last index, indicating equivocation; if so, return the entry.
    - Iterate backward up to `FD_EQVOC_FEC_MAX` indices to find overlapping FEC sets; if a conflict is found, return it.
    - Iterate forward up to the entry's data count to find overlapping FEC sets; if a conflict is found, return it.
    - Return `NULL` if no conflicts are found.
- **Output**: A pointer to a constant `fd_eqvoc_fec_t` structure if a conflict is found, or `NULL` if no conflicts are detected.
- **Functions Called**:
    - [`fd_eqvoc_fec_query`](<fd_eqvoc.h.md#fd_eqvoc_fec_query>)


---
### fd\_eqvoc\_proof\_insert<!-- {{#callable:fd_eqvoc_proof_insert}} -->
[View Source →](<../../../../../src/choreo/eqvoc/fd_eqvoc.c#L171>)

Inserts a new proof entry into the proof map of an `fd_eqvoc_t` structure.
- **Inputs**:
    - ``eqvoc``: A pointer to an `fd_eqvoc_t` structure where the proof will be inserted.
    - ``slot``: An unsigned long integer representing the slot number for the proof.
    - ``from``: A constant pointer to an `fd_pubkey_t` structure representing the public key associated with the proof.
- **Logic and Control Flow**:
    - Creates a `fd_slot_pubkey_t` key using the provided `slot` and `from` values.
    - If `FD_EQVOC_USE_HANDHOLDING` is defined, checks if the key already exists in the proof map and logs an error if it does.
    - Acquires a new proof element from the proof pool using `fd_eqvoc_proof_pool_ele_acquire`.
    - Initializes the acquired proof element to zero using `memset`.
    - Sets the `slot` and `hash` fields of the proof's key to the provided `slot` and `from` values, respectively.
    - Inserts the initialized proof element into the proof map using `fd_eqvoc_proof_map_ele_insert`.
- **Output**: Returns a pointer to the newly inserted `fd_eqvoc_proof_t` structure.


---
### fd\_eqvoc\_proof\_chunk\_insert<!-- {{#callable:fd_eqvoc_proof_chunk_insert}} -->
[View Source →](<../../../../../src/choreo/eqvoc/fd_eqvoc.c#L189>)

Inserts a chunk into a proof structure, updating or ignoring based on conditions.
- **Inputs**:
    - ``proof``: A pointer to an `fd_eqvoc_proof_t` structure where the chunk will be inserted.
    - ``chunk``: A constant pointer to an `fd_gossip_duplicate_shred_t` structure representing the chunk to be inserted.
- **Logic and Control Flow**:
    - If `chunk->wallclock` is greater than `proof->wallclock`, log a warning, update `proof->wallclock` and `proof->chunk_cnt`, and reset `proof->set`.
    - If `chunk->wallclock` is less than `proof->wallclock`, log a warning and return without inserting the chunk.
    - If `proof->chunk_cnt` does not match `chunk->num_chunks`, log a warning and return without inserting the chunk.
    - If the chunk index is already present in `proof->set`, log a warning and return without inserting the chunk.
    - Copy the chunk data into the appropriate position in `proof->shreds` and mark the chunk index in `proof->set`.
- **Output**: No return value; the function modifies the `proof` structure in place.


---
### fd\_eqvoc\_proof\_init<!-- {{#callable:fd_eqvoc_proof_init}} -->
[View Source →](<../../../../../src/choreo/eqvoc/fd_eqvoc.c#L221>)

Initializes a `fd_eqvoc_proof_t` structure with specified parameters and clears its `set` and `shreds` arrays.
- **Inputs**:
    - `proof`: A pointer to a `fd_eqvoc_proof_t` structure to initialize.
    - `producer`: A constant pointer to a `fd_pubkey_t` structure representing the producer's public key.
    - `wallclock`: A long integer representing the wallclock time.
    - `chunk_cnt`: An unsigned long integer representing the number of chunks.
    - `chunk_sz`: An unsigned long integer representing the size of each chunk.
    - `bmtree_mem`: A pointer to memory used for binary tree operations.
- **Logic and Control Flow**:
    - Assigns the `producer` public key to the `proof->producer` field.
    - Assigns the `bmtree_mem` pointer to the `proof->bmtree_mem` field.
    - Sets the `wallclock` value to the `proof->wallclock` field.
    - Sets the `chunk_cnt` value to the `proof->chunk_cnt` field.
    - Sets the `chunk_sz` value to the `proof->chunk_sz` field.
    - Clears the `proof->set` array by setting all its elements to zero.
    - Clears the `proof->shreds` array by setting all its elements to zero.
- **Output**: No return value; the function modifies the `fd_eqvoc_proof_t` structure pointed to by `proof`.


---
### fd\_eqvoc\_proof\_remove<!-- {{#callable:fd_eqvoc_proof_remove}} -->
[View Source →](<../../../../../src/choreo/eqvoc/fd_eqvoc.c#L233>)

Removes a proof entry from the proof map and releases its resources in the proof pool.
- **Inputs**:
    - ``eqvoc``: A pointer to an `fd_eqvoc_t` structure that contains the proof map and proof pool.
    - ``key``: A constant pointer to an `fd_slot_pubkey_t` structure that identifies the proof entry to remove.
- **Logic and Control Flow**:
    - Call `fd_eqvoc_proof_map_ele_remove` to remove the proof entry from the proof map using the provided `key`.
    - Check if the returned `proof` is `NULL`, indicating the key was not found in the map.
    - If the key is not found, log a warning message and return immediately.
    - If the proof entry is found, call `fd_eqvoc_proof_pool_ele_release` to release the proof entry back to the proof pool.
- **Output**: No return value; the function performs its operations directly on the provided data structures.


---
### fd\_eqvoc\_proof\_verify<!-- {{#callable:fd_eqvoc_proof_verify}} -->
[View Source →](<../../../../../src/choreo/eqvoc/fd_eqvoc.c#L243>)

Verifies the integrity and consistency of two shreds in a proof against a producer's public key and a Merkle tree memory.
- **Inputs**:
    - ``proof``: A constant pointer to an `fd_eqvoc_proof_t` structure containing the shreds and metadata for verification.
- **Logic and Control Flow**:
    - Calls [`fd_eqvoc_proof_shred1_const`](<fd_eqvoc.h.md#fd_eqvoc_proof_shred1_const>) and [`fd_eqvoc_proof_shred2_const`](<fd_eqvoc.h.md#fd_eqvoc_proof_shred2_const>) to extract the first and second shreds from the `proof`.
    - Passes the extracted shreds, the producer's public key, and the Merkle tree memory to [`fd_eqvoc_shreds_verify`](<#fd_eqvoc_shreds_verify>).
    - Returns the result of [`fd_eqvoc_shreds_verify`](<#fd_eqvoc_shreds_verify>), which indicates the verification status.
- **Output**: An integer representing the verification result, where specific values indicate success or different types of verification errors.
- **Functions Called**:
    - [`fd_eqvoc_shreds_verify`](<#fd_eqvoc_shreds_verify>)
    - [`fd_eqvoc_proof_shred1_const`](<fd_eqvoc.h.md#fd_eqvoc_proof_shred1_const>)
    - [`fd_eqvoc_proof_shred2_const`](<fd_eqvoc.h.md#fd_eqvoc_proof_shred2_const>)


---
### fd\_eqvoc\_shreds\_verify<!-- {{#callable:fd_eqvoc_shreds_verify}} -->
[View Source →](<../../../../../src/choreo/eqvoc/fd_eqvoc.c#L248>)

Verifies the equivalence of two shreds by checking their slot, version, type, signatures, and FEC set indices.
- **Inputs**:
    - `shred1`: A pointer to the first `fd_shred_t` structure to verify.
    - `shred2`: A pointer to the second `fd_shred_t` structure to verify.
    - `producer`: A pointer to the `fd_pubkey_t` structure representing the producer's public key.
    - `bmtree_mem`: A pointer to memory used for Merkle tree operations.
- **Logic and Control Flow**:
    - Check if `shred1` and `shred2` have the same slot; return `FD_EQVOC_PROOF_VERIFY_ERR_SLOT` if not.
    - Check if `shred1` and `shred2` have the same version; return `FD_EQVOC_PROOF_VERIFY_ERR_VERSION` if not.
    - Check if both shreds are either chained or resigned; return `FD_EQVOC_PROOF_VERIFY_ERR_TYPE` if not.
    - Calculate the Merkle root for both shreds and verify their signatures using the producer's public key; return `FD_EQVOC_PROOF_VERIFY_ERR_MERKLE` or `FD_EQVOC_PROOF_VERIFY_ERR_SIGNATURE` if verification fails.
    - If `shred1` and `shred2` are in the same FEC set, check for different signatures, coding metadata, or last shred index; return appropriate success codes if any condition is met.
    - If `shred1` and `shred2` are in different FEC sets, check for overlap or conflicting chained Merkle roots; return appropriate success codes if any condition is met.
    - Return `FD_EQVOC_PROOF_VERIFY_FAILURE` if none of the equivocation tests pass.
- **Output**: An integer indicating the result of the verification, with specific error or success codes.


---
### fd\_eqvoc\_proof\_from\_chunks<!-- {{#callable:fd_eqvoc_proof_from_chunks}} -->
[View Source →](<../../../../../src/choreo/eqvoc/fd_eqvoc.c#L368>)

Processes a series of chunks to populate an equivocation proof structure.
- **Inputs**:
    - ``chunks``: A pointer to an array of `fd_gossip_duplicate_shred_t` structures, each representing a chunk of data.
    - ``proof_out``: A pointer to an `fd_eqvoc_proof_t` structure where the function will store the processed proof data.
- **Logic and Control Flow**:
    - Retrieve the number of chunks from the first element of the `chunks` array.
    - Iterate over each chunk in the `chunks` array.
    - For each chunk, call [`fd_eqvoc_proof_chunk_insert`](<#fd_eqvoc_proof_chunk_insert>) to insert the chunk into the `proof_out` structure.
- **Output**: No return value; the function modifies the `proof_out` structure in place.
- **Functions Called**:
    - [`fd_eqvoc_proof_chunk_insert`](<#fd_eqvoc_proof_chunk_insert>)


---
### fd\_eqvoc\_proof\_to\_chunks<!-- {{#callable:fd_eqvoc_proof_to_chunks}} -->
[View Source →](<../../../../../src/choreo/eqvoc/fd_eqvoc.c#L377>)

Converts a proof into multiple chunks for gossiping.
- **Inputs**:
    - ``proof``: A pointer to an `fd_eqvoc_proof_t` structure containing the proof data to be converted into chunks.
    - ``chunks_out``: A pointer to an array of `fd_gossip_duplicate_shred_t` structures where the function will store the resulting chunks.
- **Logic and Control Flow**:
    - Iterates over a fixed number of chunks defined by `FD_EQVOC_PROOF_CHUNK_CNT`.
    - For each chunk, sets the `index`, `wallclock`, `slot`, `num_chunks`, and `chunk_len` fields of the `fd_gossip_duplicate_shred_t` structure.
    - Calculates the offset and size for the current chunk based on `FD_EQVOC_PROOF_CHUNK_SZ` and the total proof size `FD_EQVOC_PROOF_SZ`.
    - Copies a portion of the proof's shreds into the current chunk's `chunk` field using `fd_memcpy`.
- **Output**: The function does not return a value; it populates the `chunks_out` array with the converted chunks.



---
Made with ❤️ by [Driver](https://www.driver.ai/)