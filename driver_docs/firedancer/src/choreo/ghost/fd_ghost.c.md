<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for managing and manipulating a ghost data structure, including creation, insertion, and validation operations.

# Purpose
The code defines a set of functions for managing a data structure called `fd_ghost_t`, which appears to be a specialized tree or graph structure used for managing elements (`fd_ghost_ele_t`) in a shared memory workspace. The primary operations include creating, joining, leaving, and deleting instances of `fd_ghost_t`, as well as inserting, removing, and verifying elements within the structure. The code also includes functions for handling duplicate elements, marking elements as valid or invalid, and managing votes related to the elements, which suggests a use case in consensus or voting systems.

The functions [`fd_ghost_new`](<#fd_ghost_new>), [`fd_ghost_join`](<#fd_ghost_join>), [`fd_ghost_leave`](<#fd_ghost_leave>), and [`fd_ghost_delete`](<#fd_ghost_delete>) manage the lifecycle of the `fd_ghost_t` structure. The [`maps_insert`](<#maps_insert>) and [`maps_remove`](<#maps_remove>) functions handle the insertion and removal of elements in hash-keyed and slot-keyed maps, which are part of the internal data structure. The code also includes functions for verifying the integrity of the structure ([`fd_ghost_verify`](<#fd_ghost_verify>)), marking elements as valid or invalid, and processing duplicate confirmations. Additionally, the code provides functionality for printing the structure, which is useful for debugging or visualization purposes. The use of shared memory and alignment checks indicates that this code is designed for high-performance applications where memory management and concurrency are critical.
# Imports and Dependencies

---
- `fd_ghost.h`
- `stdio.h`


# Functions

---
### fd\_ghost\_new<!-- {{#callable:fd_ghost_new}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.c#L5>)

Initializes a new `fd_ghost_t` structure in shared memory with specified parameters.
- **Inputs**:
    - `shmem`: A pointer to the shared memory where the `fd_ghost_t` structure will be initialized.
    - `ele_max`: The maximum number of elements that the ghost structure can handle.
    - `seed`: A seed value used for initializing hash maps within the ghost structure.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL; if so, log a warning and return NULL.
    - Check if `shmem` is aligned according to [`fd_ghost_align`](<fd_ghost.h.md#fd_ghost_align>); if not, log a warning and return NULL.
    - Calculate the memory footprint required for `ele_max` elements; if zero, log a warning and return NULL.
    - Verify that `shmem` is part of a workspace; if not, log a warning and return NULL.
    - Clear the memory at `shmem` with the calculated footprint size.
    - Calculate `elg_max` as the most significant bit of the smallest power of two greater than or equal to `ele_max`.
    - Initialize scratch memory allocation with `shmem`.
    - Allocate memory for `fd_ghost_t`, pool, hash map, slot map, and duplicate map using scratch memory allocation.
    - Verify that the total allocated memory matches the calculated footprint.
    - Initialize the `fd_ghost_t` structure with global addresses for pool, hash map, slot map, and duplicate map.
    - Set the `ghost_gaddr`, `seed`, and `root` fields of the `fd_ghost_t` structure.
    - Use memory fences to ensure memory operations are completed before setting the `magic` field.
    - Set the `magic` field of the `fd_ghost_t` structure to `FD_GHOST_MAGIC`.
- **Output**: Returns the pointer to the shared memory (`shmem`) if successful, or NULL if any checks fail.
- **Functions Called**:
    - [`fd_ghost_align`](<fd_ghost.h.md#fd_ghost_align>)
    - [`fd_ghost_footprint`](<fd_ghost.h.md#fd_ghost_footprint>)


---
### fd\_ghost\_join<!-- {{#callable:fd_ghost_join}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.c#L58>)

Validates and returns a pointer to a `fd_ghost_t` structure if it meets certain conditions.
- **Inputs**:
    - `shghost`: A pointer to a shared memory object that is expected to be a `fd_ghost_t` structure.
- **Logic and Control Flow**:
    - Cast `shghost` to a `fd_ghost_t` pointer and assign it to `ghost`.
    - Check if `ghost` is NULL; if so, log a warning and return NULL.
    - Check if `ghost` is aligned according to [`fd_ghost_align`](<fd_ghost.h.md#fd_ghost_align>); if not, log a warning and return NULL.
    - Retrieve the workspace containing `ghost` using `fd_wksp_containing`; if it is NULL, log a warning and return NULL.
    - Check if `ghost->magic` equals `FD_GHOST_MAGIC`; if not, log a warning and return NULL.
    - Return the `ghost` pointer.
- **Output**: A pointer to a `fd_ghost_t` structure if all checks pass, otherwise NULL.
- **Functions Called**:
    - [`fd_ghost_align`](<fd_ghost.h.md#fd_ghost_align>)


---
### fd\_ghost\_leave<!-- {{#callable:fd_ghost_leave}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.c#L86>)

Returns the input `ghost` pointer if it is not NULL, otherwise logs a warning and returns NULL.
- **Inputs**:
    - ``ghost``: A constant pointer to an `fd_ghost_t` structure, which represents a ghost object.
- **Logic and Control Flow**:
    - Checks if the `ghost` pointer is NULL using `FD_UNLIKELY`.
    - If `ghost` is NULL, logs a warning message 'NULL ghost' and returns NULL.
    - If `ghost` is not NULL, casts the `ghost` pointer to a `void *` and returns it.
- **Output**: A `void *` pointer to the `ghost` if it is not NULL, otherwise NULL.


---
### fd\_ghost\_delete<!-- {{#callable:fd_ghost_delete}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.c#L97>)

Validates and returns a pointer to a 'ghost' object if it is non-null and properly aligned.
- **Inputs**:
    - `ghost`: A pointer to the 'ghost' object to be validated and returned.
- **Logic and Control Flow**:
    - Check if 'ghost' is NULL; if true, log a warning and return NULL.
    - Check if 'ghost' is not aligned according to 'fd_ghost_align'; if true, log a warning and return NULL.
    - Return the 'ghost' pointer if it passes the above checks.
- **Output**: Returns the 'ghost' pointer if it is valid and aligned, otherwise returns NULL.
- **Functions Called**:
    - [`fd_ghost_align`](<fd_ghost.h.md#fd_ghost_align>)


---
### maps\_insert<!-- {{#callable:maps_insert}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.c#L115>)

Inserts an element into a hash-keyed map and handles potential duplicates in a slot-keyed map.
- **Inputs**:
    - ``ghost``: A pointer to an `fd_ghost_t` structure, representing the ghost context.
    - ``ele``: A pointer to an `fd_ghost_ele_t` structure, representing the element to insert.
- **Logic and Control Flow**:
    - Retrieve the hash map, slot map, and pool from the `ghost` structure.
    - Insert the element `ele` into the hash map using `fd_ghost_hash_map_ele_insert`.
    - Query the slot map for an existing element with the same slot as `ele` using `fd_ghost_slot_map_ele_query`.
    - If no existing element is found, insert `ele` into the slot map using `fd_ghost_slot_map_ele_insert`.
    - If an existing element is found, traverse the linked list of duplicates until the end is reached.
    - Set the `eqvoc` field of the last duplicate to point to the new element `ele`.
- **Output**: No return value; the function modifies the maps and elements in place.


---
### maps\_remove<!-- {{#callable:maps_remove}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.c#L136>)

Removes an element from the hash map and, if it matches, also from the slot map.
- **Inputs**:
    - ``ghost``: A pointer to the `fd_ghost_t` structure, which contains the hash map and slot map.
    - ``hash``: A pointer to the `fd_hash_t` structure, which represents the hash key of the element to remove.
- **Logic and Control Flow**:
    - Retrieve the hash map, slot map, and pool from the `ghost` structure.
    - Attempt to remove the element associated with `hash` from the hash map using `fd_ghost_hash_map_ele_remove`.
    - If the element is found, query the slot map for the element using `fd_ghost_slot_map_ele_query`.
    - If the queried element exists and its key matches `hash`, remove it from the slot map using `fd_ghost_slot_map_ele_remove`.
    - Return the removed element.
- **Output**: A pointer to the removed `fd_ghost_ele_t` element, or `NULL` if no element was removed.


---
### fd\_ghost\_init<!-- {{#callable:fd_ghost_init}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.c#L152>)

Initializes a `fd_ghost_t` structure with a root element using a specified slot and hash.
- **Inputs**:
    - ``ghost``: A pointer to a `fd_ghost_t` structure to initialize.
    - ``root_slot``: An unsigned long representing the slot for the root element.
    - ``hash``: A pointer to a `fd_hash_t` structure representing the hash for the root element.
- **Logic and Control Flow**:
    - Check if `ghost` is NULL and log a warning if true, then return.
    - Check if `root_slot` is `FD_SLOT_NULL` and log a warning if true, then return.
    - Retrieve the pool of elements from `ghost` and get the null index for the pool.
    - Check if `ghost->root` is not null, log a warning if the ghost is already initialized, then return.
    - Acquire a new element from the pool and initialize its fields with the provided `hash` and `root_slot`, setting other fields to null or zero.
    - Insert the initialized root element into the maps using [`maps_insert`](<#maps_insert>) and update `ghost->root` with the pool index of the root element.
    - Perform sanity checks to ensure the root element is correctly initialized and inserted.
- **Output**: No output is returned; the function modifies the `ghost` structure in place.
- **Functions Called**:
    - [`maps_insert`](<#maps_insert>)


---
### fd\_ghost\_verify<!-- {{#callable:fd_ghost_verify}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.c#L204>)

Verifies the integrity and consistency of a `fd_ghost_t` structure.
- **Inputs**:
    - ``ghost``: A pointer to a constant `fd_ghost_t` structure to verify.
- **Logic and Control Flow**:
    - Check if `ghost` is NULL and log a warning if true, then return -1.
    - Check if `ghost` is aligned according to `fd_ghost_align()` and log a warning if misaligned, then return -1.
    - Retrieve the workspace containing `ghost` using `fd_wksp_containing()` and log a warning if not found, then return -1.
    - Verify that `ghost->magic` equals `FD_GHOST_MAGIC` and log a warning if not, then return -1.
    - Retrieve the pool and hash map associated with `ghost`.
    - Verify that every element in the pool exists in the hash map using `fd_ghost_hash_map_verify()`, returning -1 if verification fails.
    - Iterate over each parent element starting from the root, checking that each parent's weight is greater than or equal to the sum of its children's weights.
    - Return 0 if all checks pass.
- **Output**: Returns 0 if the `fd_ghost_t` structure is valid, otherwise returns -1.
- **Functions Called**:
    - [`fd_ghost_align`](<fd_ghost.h.md#fd_ghost_align>)
    - [`fd_ghost_pool_const`](<fd_ghost.h.md#fd_ghost_pool_const>)
    - [`fd_ghost_hash_map_const`](<fd_ghost.h.md#fd_ghost_hash_map_const>)
    - [`fd_ghost_root_const`](<fd_ghost.h.md#fd_ghost_root_const>)
    - [`fd_ghost_child_const`](<fd_ghost.h.md#fd_ghost_child_const>)
    - [`fd_ghost_sibling_const`](<fd_ghost.h.md#fd_ghost_sibling_const>)


---
### fd\_ghost\_mark\_valid<!-- {{#callable:fd_ghost_mark_valid}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.c#L254>)

Marks an element in the ghost structure as valid if it exists.
- **Inputs**:
    - ``ghost``: A pointer to the `fd_ghost_t` structure, which represents the ghost data structure.
    - ``bid``: A constant pointer to the `fd_hash_t` structure, which represents the hash key used to query the ghost structure.
- **Logic and Control Flow**:
    - Call `fd_ghost_query` with `ghost` and `bid` to find the element associated with the given hash key.
    - Check if the element exists using `FD_LIKELY`.
    - If the element exists, set its `valid` field to 1.
- **Output**: No output is returned as the function is of type `void`.


---
### fd\_ghost\_mark\_invalid<!-- {{#callable:fd_ghost_mark_invalid}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.c#L260>)

Marks elements in a ghost data structure as invalid if they are not confirmed duplicates.
- **Inputs**:
    - ``ghost``: A pointer to the `fd_ghost_t` structure representing the ghost data structure.
    - ``slot``: An unsigned long integer representing the slot number to be marked as invalid.
    - ``total_stake``: An unsigned long integer representing the total stake used to check for duplicate confirmation.
- **Logic and Control Flow**:
    - Retrieve the pool of elements from the ghost structure using `fd_ghost_pool` and get the null index using `fd_ghost_pool_idx_null`.
    - Get the hash for the given slot using [`fd_ghost_hash`](<fd_ghost.h.md#fd_ghost_hash>) and ensure it is not null with `FD_TEST`.
    - Query the ghost structure for an element with the given hash using `fd_ghost_query`.
    - If the element exists and is not a confirmed duplicate (checked using [`is_duplicate_confirmed`](<fd_ghost.h.md#fd_fn_unusedis_duplicate_confirmed>)), mark it as invalid by setting `ele->valid` to 0.
    - Iterate through equivalent elements (`eqvoc`) in the pool, marking each as invalid if they are not confirmed duplicates, until reaching a null equivalent.
- **Output**: No return value; the function modifies the validity of elements in the ghost data structure.
- **Functions Called**:
    - [`fd_ghost_hash`](<fd_ghost.h.md#fd_ghost_hash>)
    - [`FD_FN_UNUSED::is_duplicate_confirmed`](<fd_ghost.h.md#fd_fn_unusedis_duplicate_confirmed>)


---
### fd\_ghost\_insert<!-- {{#callable:fd_ghost_insert}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.c#L276>)

Inserts a new element into the ghost data structure, linking it to its parent and updating the structure's maps.
- **Inputs**:
    - ``ghost``: A pointer to the `fd_ghost_t` structure where the element will be inserted.
    - ``parent_hash``: A constant pointer to the `fd_hash_t` representing the hash of the parent element.
    - ``slot``: An unsigned long integer representing the slot number for the new element.
    - ``hash``: A constant pointer to the `fd_hash_t` representing the hash of the new element.
    - ``total_stake``: An unsigned long integer representing the total stake associated with the slot.
- **Logic and Control Flow**:
    - Logs the insertion details if logging is enabled.
    - Checks the validity of the `ghost` structure and the availability of the parent element.
    - Acquires a new element from the pool and initializes its fields.
    - Links the new element as a child or sibling of the parent element.
    - Inserts the new element into the hash-keyed and slot-keyed maps.
    - Checks for duplicate messages and marks the element as invalid if necessary.
    - Returns a pointer to the newly inserted element.
- **Output**: Returns a pointer to the newly inserted `fd_ghost_ele_t` element, or `NULL` if the insertion fails.
- **Functions Called**:
    - [`maps_insert`](<#maps_insert>)
    - [`fd_ghost_mark_invalid`](<#fd_ghost_mark_invalid>)


---
### fd\_ghost\_head<!-- {{#callable:fd_ghost_head}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.c#L331>)

Finds the heaviest valid descendant in a tree structure starting from a given root element.
- **Inputs**:
    - ``ghost``: A pointer to a constant `fd_ghost_t` structure, representing the ghost data structure.
    - ``root``: A pointer to a constant `fd_ghost_ele_t` structure, representing the root element of the tree to search.
- **Logic and Control Flow**:
    - If `FD_GHOST_USE_HANDHOLDING` is defined, check that `ghost->magic` equals `FD_GHOST_MAGIC` and `root` is not NULL.
    - Return NULL if `root` is not valid.
    - Initialize `pool` with the constant pool of elements from `ghost` and set `head` to `root`.
    - Retrieve the null index from the pool using `fd_ghost_pool_idx_null`.
    - While `head` has a child that is not null, iterate over its children to find the heaviest valid child.
    - For each child, if it is valid, update `head` to the child if it is the first valid child or if it is heavier than the current `head`.
    - Use `fd_ptr_if` and `fd_int_if` to compare weights and slots to determine the heaviest child.
    - If no valid children are found, break the loop.
    - Return the `head` which is the heaviest valid descendant.
- **Output**: A pointer to the heaviest valid `fd_ghost_ele_t` descendant, or NULL if no valid descendants exist.
- **Functions Called**:
    - [`fd_ghost_pool_const`](<fd_ghost.h.md#fd_ghost_pool_const>)
    - [`fd_ghost_child_const`](<fd_ghost.h.md#fd_ghost_child_const>)
    - [`fd_ghost_sibling_const`](<fd_ghost.h.md#fd_ghost_sibling_const>)


---
### fd\_ghost\_replay\_vote<!-- {{#callable:fd_ghost_replay_vote}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.c#L368>)

Processes a voter's replay vote by updating the ghost structure with the voter's stake and vote information.
- **Inputs**:
    - ``ghost``: A pointer to the `fd_ghost_t` structure representing the ghost data structure.
    - ``voter``: A pointer to the `fd_voter_t` structure representing the voter whose vote is being processed.
    - ``hash``: A constant pointer to the `fd_hash_t` structure representing the hash of the vote being replayed.
- **Logic and Control Flow**:
    - Retrieve the ghost pool, the voter's replay vote, the root of the ghost, and the vote element corresponding to the given hash.
    - Log the voter's key, hash, slot, and last vote slot if logging is enabled.
    - Return immediately if the vote slot is older than the root slot.
    - Return immediately if the vote is unchanged, indicating a potential slashable offense.
    - Return immediately if the vote slot is less than the last processed vote slot for this voter.
    - Retrieve the previous vote element and subtract the voter's stake from the previous vote slot and its ancestors if applicable.
    - Retrieve the current vote element and add the voter's stake to the current vote slot and propagate it up the ancestry.
    - Update the voter's cached replay vote slot and hash.
- **Output**: No return value; the function updates the ghost structure and the voter's replay vote information in place.
- **Functions Called**:
    - [`fd_ghost_query_const`](<fd_ghost.h.md#fd_ghost_query_const>)


---
### fd\_ghost\_gossip\_vote<!-- {{#callable:fd_ghost_gossip_vote}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.c#L449>)

Logs an error indicating that the function is not implemented.
- **Inputs**:
    - ``ghost``: A pointer to an `fd_ghost_t` structure, which is unused in this function.
    - ``voter``: A pointer to an `fd_voter_t` structure, which is unused in this function.
    - ``slot``: An unsigned long integer representing a slot, which is unused in this function.
- **Logic and Control Flow**:
    - Logs an error message indicating that the function is not implemented.
- **Output**: No output is produced as the function only logs an error.


---
### fd\_ghost\_rooted\_vote<!-- {{#callable:fd_ghost_rooted_vote}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.c#L456>)

Updates the rooted stake of a voter's root in the ghost data structure.
- **Inputs**:
    - ``ghost``: A pointer to the `fd_ghost_t` structure representing the ghost data structure.
    - ``voter``: A pointer to the `fd_voter_t` structure representing the voter whose stake is being updated.
    - ``root``: An unsigned long integer representing the root slot of the voter.
- **Logic and Control Flow**:
    - Logs the root, voter's public key, and stake if logging is enabled.
    - Queries the ghost data structure to find the element corresponding to the voter's root using `fd_ghost_query`.
    - If handholding is enabled, checks if the element is found and logs a critical error if not.
    - Increases the `rooted_stake` of the found element by the voter's stake.
- **Output**: No return value; the function updates the `rooted_stake` of the relevant element in the ghost data structure.
- **Functions Called**:
    - [`fd_ghost_hash`](<fd_ghost.h.md#fd_ghost_hash>)


---
### fd\_ghost\_publish<!-- {{#callable:fd_ghost_publish}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.c#L477>)

Updates the root of a ghost tree to a new element identified by a hash, pruning the old root and its ancestors.
- **Inputs**:
    - ``ghost``: A pointer to the `fd_ghost_t` structure representing the ghost tree.
    - ``hash``: A constant pointer to the `fd_hash_t` structure representing the hash of the new root element.
- **Logic and Control Flow**:
    - Retrieve the pool of elements and the null index from the ghost structure.
    - Get the current root element and the new root element using the provided hash.
    - If handholding is enabled, check if the new root is valid, has a slot greater than the current root, and is an ancestor of the current root; log warnings and return NULL if any check fails.
    - Remove the current root from the map and add it to the prune list.
    - Perform a breadth-first search (BFS) to prune all ancestors of the current root and their descendants, except for the new root.
    - Unlink the old root by setting the new root's parent to null.
    - Update the ghost's root to the new root's index in the pool.
    - Return the new root element.
- **Output**: Returns a constant pointer to the `fd_ghost_ele_t` structure representing the new root element, or NULL if the operation fails.
- **Functions Called**:
    - [`fd_ghost_is_ancestor`](<#fd_ghost_is_ancestor>)
    - [`maps_remove`](<#maps_remove>)


---
### fd\_ghost\_gca<!-- {{#callable:fd_ghost_gca}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.c#L520>)

Finds the greatest common ancestor of two elements in a ghost data structure based on their hashes.
- **Inputs**:
    - ``ghost``: A pointer to a constant `fd_ghost_t` structure representing the ghost data structure.
    - ``hash1``: A pointer to a constant `fd_hash_t` representing the first hash to query.
    - ``hash2``: A pointer to a constant `fd_hash_t` representing the second hash to query.
- **Logic and Control Flow**:
    - Retrieve the constant pool of elements from the ghost structure using [`fd_ghost_pool_const`](<fd_ghost.h.md#fd_ghost_pool_const>).
    - Query the ghost structure for the elements corresponding to `hash1` and `hash2` using [`fd_ghost_query_const`](<fd_ghost.h.md#fd_ghost_query_const>).
    - If `FD_GHOST_USE_HANDHOLDING` is defined, check if either `ele1` or `ele2` is NULL and log a warning if so, then return NULL.
    - Enter a loop that continues as long as both `ele1` and `ele2` are not NULL.
    - Inside the loop, compare the keys of `ele1` and `ele2` using `memcmp`. If they are equal, return `ele1` as the greatest common ancestor.
    - If `ele1` has a greater slot than `ele2`, update `ele1` to its parent using `fd_ghost_pool_ele_const`. Otherwise, update `ele2` to its parent.
    - If the loop exits without finding a common ancestor, log a critical error indicating an invariant violation.
- **Output**: A pointer to a constant `fd_ghost_ele_t` representing the greatest common ancestor, or NULL if not found.
- **Functions Called**:
    - [`fd_ghost_pool_const`](<fd_ghost.h.md#fd_ghost_pool_const>)
    - [`fd_ghost_query_const`](<fd_ghost.h.md#fd_ghost_query_const>)


---
### fd\_ghost\_is\_ancestor<!-- {{#callable:fd_ghost_is_ancestor}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.c#L541>)

Checks if a given `ancestor` hash is an ancestor of another `hash` in the ghost data structure.
- **Inputs**:
    - ``ghost``: A pointer to the `fd_ghost_t` structure representing the ghost data structure.
    - ``ancestor``: A pointer to the `fd_hash_t` structure representing the hash of the potential ancestor.
    - ``hash``: A pointer to the `fd_hash_t` structure representing the hash to check against the ancestor.
- **Logic and Control Flow**:
    - Retrieve the root element of the ghost using [`fd_ghost_root_const`](<fd_ghost.h.md#fd_ghost_root_const>) and store it in `root`.
    - Query the ghost for the element corresponding to `hash` using [`fd_ghost_query_const`](<fd_ghost.h.md#fd_ghost_query_const>) and store it in `curr`.
    - Query the ghost for the element corresponding to `ancestor` using [`fd_ghost_query_const`](<fd_ghost.h.md#fd_ghost_query_const>) and store it in `anc`.
    - If `anc` is not found, log a notice if logging is enabled and return 0.
    - If handholding is enabled, check if `anc` is older than `root` or if `curr` is not found, log warnings and return 0.
    - Iterate through the ancestry of `curr` while `curr` is not null and its slot is greater than or equal to `anc`'s slot.
    - In each iteration, compare the keys of `curr` and `anc` using `memcmp`; if they match, return 1.
    - Move `curr` to its parent element using `fd_ghost_pool_ele_const`.
    - If the loop completes without finding a match, return 0.
- **Output**: Returns 1 if `ancestor` is an ancestor of `hash`, otherwise returns 0.
- **Functions Called**:
    - [`fd_ghost_root_const`](<fd_ghost.h.md#fd_ghost_root_const>)
    - [`fd_ghost_query_const`](<fd_ghost.h.md#fd_ghost_query_const>)
    - [`fd_ghost_pool_const`](<fd_ghost.h.md#fd_ghost_pool_const>)


---
### fd\_ghost\_invalid<!-- {{#callable:fd_ghost_invalid}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.c#L572>)

Checks if an element or any of its ancestors in a ghost structure is invalid.
- **Inputs**:
    - ``ghost``: A pointer to a constant `fd_ghost_t` structure representing the ghost.
    - ``ele``: A pointer to a constant `fd_ghost_ele_t` structure representing the element to check.
- **Logic and Control Flow**:
    - Initialize `anc` to point to `ele`.
    - Enter a loop that continues while `anc` is not NULL.
    - Check if `anc->valid` is false; if so, return 1 indicating an invalid element.
    - Update `anc` to point to its parent using [`fd_ghost_parent_const`](<fd_ghost.h.md#fd_ghost_parent_const>).
    - If the loop completes without finding an invalid element, return 0.
- **Output**: Returns 1 if the element or any ancestor is invalid, otherwise returns 0.
- **Functions Called**:
    - [`fd_ghost_parent_const`](<fd_ghost.h.md#fd_ghost_parent_const>)


---
### process\_duplicate\_confirmed<!-- {{#callable:process_duplicate_confirmed}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.c#L583>)

Marks all ancestors of a confirmed duplicate slot as valid in the ghost data structure.
- **Inputs**:
    - ``ghost``: A pointer to the `fd_ghost_t` structure representing the ghost data structure.
    - ``hash``: A constant pointer to the `fd_hash_t` structure representing the hash of the confirmed duplicate.
    - ``slot``: An unsigned long integer representing the slot number of the confirmed duplicate.
- **Logic and Control Flow**:
    - Queries the ghost data structure for the element corresponding to the given `hash` and assigns it to `confirmed`.
    - Queries the ghost data structure for the element corresponding to the hash of the given `slot` and assigns it to `current`.
    - If `confirmed` is NULL, logs a warning indicating the need to repair and replay, then returns.
    - If `current` is NULL, logs an error indicating the slot does not exist in the ghost, then returns.
    - While `current` is not NULL, marks the current element as valid and moves to its parent element.
- **Output**: No return value; the function operates by side effects on the `ghost` data structure.
- **Functions Called**:
    - [`fd_ghost_hash`](<fd_ghost.h.md#fd_ghost_hash>)
    - [`fd_ghost_mark_valid`](<#fd_ghost_mark_valid>)
    - [`fd_ghost_parent_const`](<fd_ghost.h.md#fd_ghost_parent_const>)


---
### process\_duplicate<!-- {{#callable:process_duplicate}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.c#L599>)

Handles duplicate messages for a given slot by marking them as invalid if they have already been replayed.
- **Inputs**:
    - ``ghost``: A pointer to an `fd_ghost_t` structure representing the current state of the ghost protocol.
    - ``slot``: An unsigned long integer representing the slot number to process for duplicates.
    - ``total_stake``: An unsigned long integer representing the total stake associated with the slot.
- **Logic and Control Flow**:
    - Retrieve the duplicate map from the `ghost` structure using `fd_ghost_dup_map` function.
    - Insert the `slot` into the duplicate map using `fd_dup_seen_map_insert`.
    - Check if the `slot` has already been replayed by calling [`fd_ghost_hash`](<fd_ghost.h.md#fd_ghost_hash>).
    - If the `slot` has been replayed, log a warning message indicating a duplicate message for the slot and mark the slot as invalid using [`fd_ghost_mark_invalid`](<#fd_ghost_mark_invalid>).
    - Return from the function if the slot is marked invalid.
- **Output**: No return value; the function operates by modifying the state of the `ghost` structure and logging warnings.
- **Functions Called**:
    - [`fd_ghost_hash`](<fd_ghost.h.md#fd_ghost_hash>)
    - [`fd_ghost_mark_invalid`](<#fd_ghost_mark_invalid>)


---
### print<!-- {{#callable:print}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.c#L614>)

Prints a hierarchical representation of elements in a ghost structure, showing their slot, weight, and percentage of total weight.
- **Inputs**:
    - ``ghost``: A pointer to a constant `fd_ghost_t` structure, representing the ghost data structure.
    - ``ele``: A pointer to a constant `fd_ghost_ele_t` structure, representing the current element to print.
    - ``space``: An integer representing the indentation level for the current element.
    - ``prefix``: A string used as a prefix for the current element's line in the output.
    - ``total``: An unsigned long integer representing the total weight for calculating percentages.
- **Logic and Control Flow**:
    - Retrieve the constant pool from the `ghost` structure.
    - Return immediately if `ele` is `NULL`.
    - Print a newline if `space` is greater than 0.
    - Print spaces according to the `space` value for indentation.
    - Check if `ele->weight` is greater than 100, but do nothing (possibly a placeholder for future logic).
    - If `total` is 0, print the `prefix`, `ele->slot`, and `ele->weight`.
    - If `total` is not 0, calculate the percentage of `ele->weight` relative to `total` and print the `prefix`, `ele->slot`, percentage, and optionally `ele->weight` if the percentage is less than 0.99%.
    - Iterate over the children of `ele` using a while loop.
    - For each child, determine if it has siblings and set `new_prefix` to indicate branching or end.
    - Recursively call `print` for each child with updated `space` and `new_prefix`.
- **Output**: No return value; the function outputs directly to the standard output using `printf`.
- **Functions Called**:
    - [`fd_ghost_pool_const`](<fd_ghost.h.md#fd_ghost_pool_const>)


---
### fd\_ghost\_print<!-- {{#callable:fd_ghost_print}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.c#L650>)

Logs a notice and prints the structure of a ghost element tree with respect to the total stake.
- **Inputs**:
    - ``ghost``: A pointer to a constant `fd_ghost_t` structure representing the ghost context.
    - ``total_stake``: An unsigned long integer representing the total stake used for percentage calculations.
    - ``ele``: A pointer to a constant `fd_ghost_ele_t` structure representing the root element of the tree to print.
- **Logic and Control Flow**:
    - Logs a notice with the message "[Ghost]".
    - Calls the [`print`](<#print>) function with the provided `ghost`, `ele`, an initial indentation of 0, an empty prefix, and the `total_stake`.
    - Prints two newlines after the [`print`](<#print>) function call.
- **Output**: No return value (void function).
- **Functions Called**:
    - [`print`](<#print>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)