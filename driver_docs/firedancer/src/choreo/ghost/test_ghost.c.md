<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for the `fd_ghost` module, including scenarios with duplicate nodes, voting, and tree operations.

# Purpose
The code is a C test suite for a system that manages a data structure called `fd_ghost`, which appears to be related to a blockchain or distributed ledger system. The code includes various test functions that validate the behavior of the `fd_ghost` structure under different scenarios, such as handling duplicate nodes, publishing nodes, and managing votes. The tests are designed to ensure the correctness of operations like node insertion, vote replay, and duplicate detection within the `fd_ghost` structure.

The test suite includes functions like [`test_ghost_simple`](<#test_ghost_simple>), [`test_ghost_publish_left`](<#test_ghost_publish_left>), and [`test_ghost_publish_right`](<#test_ghost_publish_right>), which test the basic functionality of the `fd_ghost` structure, including node insertion and vote replay. Other functions, such as [`test_duplicate_simple`](<#test_duplicate_simple>) and [`test_many_duplicates`](<#test_many_duplicates>), focus on handling duplicate nodes and ensuring that the structure maintains consistency in the presence of duplicates. The [`main`](<#main>) function initializes a workspace and runs all the test functions, verifying the behavior of the `fd_ghost` structure and its interaction with other components like `fd_epoch` and `fd_voter`. The code uses macros and helper functions to manage memory and validate test conditions, ensuring that the `fd_ghost` structure operates as expected.
# Imports and Dependencies

---
- `fd_ghost.h`
- `../epoch/fd_epoch.h`
- `stdarg.h`


# Functions

---
### query\_mut<!-- {{#callable:query_mut}} -->
[View Source →](<../../../../../src/choreo/ghost/test_ghost.c#L11>)

Queries a mutable element from a ghost structure based on a given slot.
- **Inputs**:
    - `ghost`: A pointer to an `fd_ghost_t` structure, representing the ghost data structure to query.
    - `slot`: An unsigned long integer representing the slot number to query within the ghost structure.
- **Logic and Control Flow**:
    - Retrieve the workspace containing the `ghost` using `fd_wksp_containing` function.
    - Get the slot map address from the workspace using `fd_wksp_laddr_fast` with `ghost->slot_map_gaddr`.
    - Get the pool address from the workspace using `fd_wksp_laddr_fast` with `ghost->pool_gaddr`.
    - Call `fd_ghost_slot_map_ele_query` with the map, slot, and pool to retrieve the element.
- **Output**: Returns a pointer to an `fd_ghost_ele_t` structure, representing the queried element from the ghost structure.


---
### mock\_epoch<!-- {{#callable:mock_epoch}} -->
[View Source →](<../../../../../src/choreo/ghost/test_ghost.c#L19>)

Creates and initializes an `fd_epoch_t` structure with a specified number of voters and their stakes.
- **Inputs**:
    - ``wksp``: A pointer to an `fd_wksp_t` workspace where the epoch memory will be allocated.
    - ``total_stake``: The total stake value to be assigned to the epoch.
    - ``voter_cnt``: The number of voters to be included in the epoch.
    - ``...``: A variable argument list containing pairs of `fd_pubkey_t` keys and `ulong` stake values for each voter.
- **Logic and Control Flow**:
    - Allocate memory for the epoch using `fd_wksp_alloc_laddr` with alignment and footprint based on the number of voters.
    - Check if the memory allocation was successful using `FD_TEST`.
    - Create a new epoch with `fd_epoch_new` and join it using `fd_epoch_join`, then verify the operation with `FD_TEST`.
    - Initialize a variable argument list with `va_start` and iterate over each voter count.
    - For each voter, retrieve the public key and stake from the variable argument list, insert the voter into the epoch using `fd_epoch_voters_insert`, and set the voter's replay vote slot to `FD_SLOT_NULL`.
    - End the variable argument list with `va_end`.
    - Set the `total_stake` of the epoch to the provided `total_stake` value.
    - Return the initialized `fd_epoch_t` structure.
- **Output**: A pointer to the initialized `fd_epoch_t` structure.


---
### test\_ghost\_simple<!-- {{#callable:test_ghost_simple}} -->
[View Source →](<../../../../../src/choreo/ghost/test_ghost.c#L53>)

Tests the basic functionality of the GHOST protocol implementation by initializing a GHOST structure, inserting nodes, verifying the structure, and replaying votes.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for memory allocation and management.
- **Logic and Control Flow**:
    - Allocate memory for the GHOST structure using `fd_wksp_alloc_laddr` with alignment and footprint based on `node_max`.
    - Initialize the GHOST structure with [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>) using `hash_0`.
    - Insert nodes into the GHOST structure using the `INSERT` macro, which calls `fd_ghost_insert` with parent and child hashes.
    - Verify the GHOST structure with [`fd_ghost_verify`](<fd_ghost.c.md#fd_ghost_verify>) to ensure it is correctly formed.
    - Create a mock epoch with [`mock_epoch`](<#mock_epoch>) and query a voter using `fd_epoch_voters_query`.
    - Replay votes on the GHOST structure using [`fd_ghost_replay_vote`](<fd_ghost.c.md#fd_ghost_replay_vote>) with the voter and specific hashes.
    - Optionally print the GHOST structure using [`fd_ghost_print`](<fd_ghost.c.md#fd_ghost_print>) if `PRINT` is defined.
    - Free allocated memory for the epoch and GHOST structure using `fd_wksp_free_laddr`.
- **Output**: No return value; the function performs tests and assertions on the GHOST structure.
- **Functions Called**:
    - [`fd_ghost_align`](<fd_ghost.h.md#fd_ghost_align>)
    - [`fd_ghost_footprint`](<fd_ghost.h.md#fd_ghost_footprint>)
    - [`fd_ghost_join`](<fd_ghost.c.md#fd_ghost_join>)
    - [`fd_ghost_new`](<fd_ghost.c.md#fd_ghost_new>)
    - [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>)
    - [`fd_ghost_verify`](<fd_ghost.c.md#fd_ghost_verify>)
    - [`mock_epoch`](<#mock_epoch>)
    - [`fd_ghost_print`](<fd_ghost.c.md#fd_ghost_print>)
    - [`fd_ghost_replay_vote`](<fd_ghost.c.md#fd_ghost_replay_vote>)
    - [`fd_ghost_delete`](<fd_ghost.c.md#fd_ghost_delete>)
    - [`fd_ghost_leave`](<fd_ghost.c.md#fd_ghost_leave>)


---
### test\_ghost\_publish\_left<!-- {{#callable:test_ghost_publish_left}} -->
[View Source →](<../../../../../src/choreo/ghost/test_ghost.c#L119>)

Tests the functionality of the GHOST protocol by initializing a tree structure, inserting nodes, replaying votes, and verifying the state of the tree.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for memory allocation and management.
- **Logic and Control Flow**:
    - Allocate memory for the GHOST structure using `fd_wksp_alloc_laddr` and verify allocation with `FD_TEST`.
    - Initialize the GHOST structure with [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>) and a root hash.
    - Insert nodes into the GHOST structure using the `INSERT` macro, which calls `fd_ghost_insert`.
    - Verify the integrity of the GHOST structure with [`fd_ghost_verify`](<fd_ghost.c.md#fd_ghost_verify>).
    - Create a mock epoch with [`mock_epoch`](<#mock_epoch>) and query a voter with `fd_epoch_voters_query`.
    - Replay votes on the GHOST structure using [`fd_ghost_replay_vote`](<fd_ghost.c.md#fd_ghost_replay_vote>).
    - Query nodes in the GHOST structure with `fd_ghost_query` and verify their existence.
    - Publish a node in the GHOST structure with [`fd_ghost_publish`](<fd_ghost.c.md#fd_ghost_publish>) and verify the root node's slot.
    - Check the state of the GHOST structure with [`fd_ghost_verify`](<fd_ghost.c.md#fd_ghost_verify>) and `FD_TEST`.
    - Free the allocated memory with `fd_wksp_free_laddr`.
- **Output**: No return value; the function performs tests and assertions on the GHOST protocol implementation.
- **Functions Called**:
    - [`fd_ghost_align`](<fd_ghost.h.md#fd_ghost_align>)
    - [`fd_ghost_footprint`](<fd_ghost.h.md#fd_ghost_footprint>)
    - [`fd_ghost_join`](<fd_ghost.c.md#fd_ghost_join>)
    - [`fd_ghost_new`](<fd_ghost.c.md#fd_ghost_new>)
    - [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>)
    - [`fd_ghost_verify`](<fd_ghost.c.md#fd_ghost_verify>)
    - [`mock_epoch`](<#mock_epoch>)
    - [`fd_ghost_replay_vote`](<fd_ghost.c.md#fd_ghost_replay_vote>)
    - [`fd_ghost_print`](<fd_ghost.c.md#fd_ghost_print>)
    - [`fd_ghost_publish`](<fd_ghost.c.md#fd_ghost_publish>)


---
### test\_ghost\_publish\_right<!-- {{#callable:test_ghost_publish_right}} -->
[View Source →](<../../../../../src/choreo/ghost/test_ghost.c#L202>)

Tests the functionality of publishing a node to the right in a GHOST (Greedy Heaviest-Observed Sub-Tree) protocol implementation.
- **Inputs**:
    - `wksp`: A pointer to a `fd_wksp_t` workspace structure used for memory allocation and management.
- **Logic and Control Flow**:
    - Allocate memory for the GHOST structure using `fd_wksp_alloc_laddr` with alignment and footprint based on `node_max`.
    - Initialize the GHOST structure with [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>) and insert nodes using the `INSERT` macro to create a tree structure.
    - Verify the GHOST structure with [`fd_ghost_verify`](<fd_ghost.c.md#fd_ghost_verify>) to ensure it is correctly initialized.
    - Create a mock epoch with a voter using [`mock_epoch`](<#mock_epoch>) and query the voter with `fd_epoch_voters_query`.
    - Replay votes on the GHOST structure using [`fd_ghost_replay_vote`](<fd_ghost.c.md#fd_ghost_replay_vote>) and verify the structure after each vote.
    - Query a specific node in the GHOST structure using `fd_ghost_query` and verify its existence.
    - Publish a node in the GHOST structure using [`fd_ghost_publish`](<fd_ghost.c.md#fd_ghost_publish>) and verify the structure again.
    - Check the root node and its children in the GHOST structure to ensure they have the correct slots.
    - Free the allocated memory using `fd_wksp_free_laddr`.
- **Output**: No return value; the function performs tests and assertions to verify the correctness of the GHOST protocol implementation.
- **Functions Called**:
    - [`fd_ghost_align`](<fd_ghost.h.md#fd_ghost_align>)
    - [`fd_ghost_footprint`](<fd_ghost.h.md#fd_ghost_footprint>)
    - [`fd_ghost_join`](<fd_ghost.c.md#fd_ghost_join>)
    - [`fd_ghost_new`](<fd_ghost.c.md#fd_ghost_new>)
    - [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>)
    - [`fd_ghost_verify`](<fd_ghost.c.md#fd_ghost_verify>)
    - [`mock_epoch`](<#mock_epoch>)
    - [`fd_ghost_replay_vote`](<fd_ghost.c.md#fd_ghost_replay_vote>)
    - [`fd_ghost_print`](<fd_ghost.c.md#fd_ghost_print>)
    - [`fd_ghost_publish`](<fd_ghost.c.md#fd_ghost_publish>)


---
### test\_ghost\_gca<!-- {{#callable:test_ghost_gca}} -->
[View Source →](<../../../../../src/choreo/ghost/test_ghost.c#L261>)

Tests the functionality of the [`fd_ghost_gca`](<fd_ghost.c.md#fd_ghost_gca>) function by setting up a ghost tree and verifying the greatest common ancestor (GCA) of various nodes.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for memory allocation.
- **Logic and Control Flow**:
    - Allocate memory for the ghost structure using `fd_wksp_alloc_laddr` with alignment and footprint based on `node_max`.
    - Verify the memory allocation with `FD_TEST`.
    - Initialize a ghost structure with [`fd_ghost_new`](<fd_ghost.c.md#fd_ghost_new>) and join it with [`fd_ghost_join`](<fd_ghost.c.md#fd_ghost_join>).
    - Define several hash values (`hash_0` to `hash_6`) to represent nodes in the ghost tree.
    - Initialize the ghost tree with [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>) using `hash_0` as the root.
    - Insert nodes into the ghost tree using the `INSERT` macro, which calls `fd_ghost_insert`.
    - Verify the integrity of the ghost tree with `FD_TEST` and [`fd_ghost_verify`](<fd_ghost.c.md#fd_ghost_verify>).
    - Optionally print the ghost tree structure if `PRINT` is defined.
    - Perform a series of tests using `FD_TEST` to verify the slot of the GCA for various pairs of nodes using [`fd_ghost_gca`](<fd_ghost.c.md#fd_ghost_gca>).
- **Output**: No return value; the function performs tests and assertions to verify the behavior of the [`fd_ghost_gca`](<fd_ghost.c.md#fd_ghost_gca>) function.
- **Functions Called**:
    - [`fd_ghost_align`](<fd_ghost.h.md#fd_ghost_align>)
    - [`fd_ghost_footprint`](<fd_ghost.h.md#fd_ghost_footprint>)
    - [`fd_ghost_join`](<fd_ghost.c.md#fd_ghost_join>)
    - [`fd_ghost_new`](<fd_ghost.c.md#fd_ghost_new>)
    - [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>)
    - [`fd_ghost_verify`](<fd_ghost.c.md#fd_ghost_verify>)
    - [`fd_ghost_print`](<fd_ghost.c.md#fd_ghost_print>)
    - [`fd_ghost_gca`](<fd_ghost.c.md#fd_ghost_gca>)


---
### test\_ghost\_head<!-- {{#callable:test_ghost_head}} -->
[View Source →](<../../../../../src/choreo/ghost/test_ghost.c#L390>)

Tests the behavior of the GHOST protocol implementation by setting up a tree structure, replaying votes, and verifying the head of the tree.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for memory allocation and management.
- **Logic and Control Flow**:
    - Allocate memory for a GHOST protocol structure with a maximum of 16 nodes.
    - Initialize the GHOST protocol with a root node having a hash key of 10.
    - Insert nodes with hash keys 11, 12, and 13 into the tree structure, establishing parent-child relationships.
    - Create a mock epoch with two voters having public keys `pk1` and `pk2`, and stakes of 50 and 100, respectively.
    - Replay votes for nodes with hash keys 11 and 12 using the voters `v1` and `v2`, and verify the tree structure after each vote.
    - Retrieve the head of the tree and verify that it is the node with slot 12.
    - Replay a vote for the node with hash key 13 using voter `v1`, verify the tree structure, and confirm the head remains the node with slot 12.
    - Optionally print the tree structure if the `PRINT` macro is defined.
    - Free the allocated memory for the GHOST protocol structure.
- **Output**: No return value; the function performs tests and assertions to verify the correctness of the GHOST protocol implementation.
- **Functions Called**:
    - [`fd_ghost_align`](<fd_ghost.h.md#fd_ghost_align>)
    - [`fd_ghost_footprint`](<fd_ghost.h.md#fd_ghost_footprint>)
    - [`fd_ghost_join`](<fd_ghost.c.md#fd_ghost_join>)
    - [`fd_ghost_new`](<fd_ghost.c.md#fd_ghost_new>)
    - [`mock_epoch`](<#mock_epoch>)
    - [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>)
    - [`fd_ghost_replay_vote`](<fd_ghost.c.md#fd_ghost_replay_vote>)
    - [`fd_ghost_verify`](<fd_ghost.c.md#fd_ghost_verify>)
    - [`fd_ghost_head`](<fd_ghost.c.md#fd_ghost_head>)
    - [`fd_ghost_print`](<fd_ghost.c.md#fd_ghost_print>)


---
### test\_ghost\_vote\_leaves<!-- {{#callable:test_ghost_vote_leaves}} -->
[View Source →](<../../../../../src/choreo/ghost/test_ghost.c#L438>)

Tests the behavior of the GHOST protocol when a validator changes votes along the leaves of a binary tree structure.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for memory allocation.
- **Logic and Control Flow**:
    - Initialize variables `node_max`, `total_stake`, and `d` to 8, 40, and 3, respectively.
    - Allocate memory for the GHOST protocol using `fd_wksp_alloc_laddr` and initialize a GHOST instance with [`fd_ghost_new`](<fd_ghost.c.md#fd_ghost_new>) and [`fd_ghost_join`](<fd_ghost.c.md#fd_ghost_join>).
    - Create an array `hash_arr` of `fd_hash_t` to store hash values for each node, initializing the first element with `ULONG_MAX` and others with unique keys.
    - Initialize the GHOST protocol with the root node using [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>).
    - Construct a full binary tree by inserting nodes using [`fd_ghost_insert`](<fd_ghost.c.md#fd_ghost_insert>) and verify the tree structure with [`fd_ghost_verify`](<fd_ghost.c.md#fd_ghost_verify>).
    - Print the current state of the GHOST tree using [`fd_ghost_print`](<fd_ghost.c.md#fd_ghost_print>).
    - Simulate a validator changing votes along the leaves by iterating over the leaves and calling [`fd_ghost_replay_vote`](<fd_ghost.c.md#fd_ghost_replay_vote>).
    - Verify the tree structure after each vote change using [`fd_ghost_verify`](<fd_ghost.c.md#fd_ghost_verify>).
    - Calculate the path from the last leaf to the root and verify the weights and stakes of nodes along this path.
    - Simulate other validators voting for the remaining leaves and verify the tree structure after each vote.
    - Print the final state of the GHOST tree if `PRINT` is defined.
- **Output**: No return value; the function performs tests and assertions to verify the GHOST protocol's behavior.
- **Functions Called**:
    - [`fd_ghost_align`](<fd_ghost.h.md#fd_ghost_align>)
    - [`fd_ghost_footprint`](<fd_ghost.h.md#fd_ghost_footprint>)
    - [`fd_ghost_join`](<fd_ghost.c.md#fd_ghost_join>)
    - [`fd_ghost_new`](<fd_ghost.c.md#fd_ghost_new>)
    - [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>)
    - [`fd_ghost_insert`](<fd_ghost.c.md#fd_ghost_insert>)
    - [`fd_ghost_verify`](<fd_ghost.c.md#fd_ghost_verify>)
    - [`fd_ghost_print`](<fd_ghost.c.md#fd_ghost_print>)
    - [`fd_ghost_replay_vote`](<fd_ghost.c.md#fd_ghost_replay_vote>)


---
### test\_ghost\_old\_vote\_pruned<!-- {{#callable:test_ghost_old_vote_pruned}} -->
[View Source →](<../../../../../src/choreo/ghost/test_ghost.c#L532>)

Tests the pruning of old votes in a GHOST protocol implementation by simulating vote changes and verifying tree structure and weights.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for memory allocation and management.
- **Logic and Control Flow**:
    - Allocate memory for the GHOST protocol structure using `fd_wksp_alloc_laddr` with alignment and footprint based on `node_max`.
    - Initialize a GHOST protocol instance with [`fd_ghost_new`](<fd_ghost.c.md#fd_ghost_new>) and join it with [`fd_ghost_join`](<fd_ghost.c.md#fd_ghost_join>).
    - Create an array of hash values `hash_arr` for nodes, initializing the first element with `ULONG_MAX` and others with unique keys.
    - Initialize the GHOST protocol with the root node using [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>).
    - Insert nodes into the GHOST tree using [`fd_ghost_insert`](<fd_ghost.c.md#fd_ghost_insert>), simulating a binary tree structure with parent-child relationships.
    - Simulate voting by creating `fd_voter_t` structures and replaying votes with [`fd_ghost_replay_vote`](<fd_ghost.c.md#fd_ghost_replay_vote>).
    - Publish the GHOST tree state with [`fd_ghost_publish`](<fd_ghost.c.md#fd_ghost_publish>) to a specific node, pruning the tree to that node and its descendants.
    - Switch votes by replaying votes for different nodes and verify the tree structure and node weights using `fd_ghost_query`.
    - Perform assertions with `FD_TEST` to ensure the tree structure and weights are as expected after vote changes.
    - Verify the integrity of the GHOST protocol state with [`fd_ghost_verify`](<fd_ghost.c.md#fd_ghost_verify>).
- **Output**: No return value; the function performs tests and assertions to verify the behavior of the GHOST protocol implementation.
- **Functions Called**:
    - [`fd_ghost_align`](<fd_ghost.h.md#fd_ghost_align>)
    - [`fd_ghost_footprint`](<fd_ghost.h.md#fd_ghost_footprint>)
    - [`fd_ghost_join`](<fd_ghost.c.md#fd_ghost_join>)
    - [`fd_ghost_new`](<fd_ghost.c.md#fd_ghost_new>)
    - [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>)
    - [`fd_ghost_insert`](<fd_ghost.c.md#fd_ghost_insert>)
    - [`fd_ghost_replay_vote`](<fd_ghost.c.md#fd_ghost_replay_vote>)
    - [`fd_ghost_publish`](<fd_ghost.c.md#fd_ghost_publish>)
    - [`fd_ghost_print`](<fd_ghost.c.md#fd_ghost_print>)
    - [`fd_ghost_verify`](<fd_ghost.c.md#fd_ghost_verify>)


---
### test\_ghost\_head\_full\_tree<!-- {{#callable:test_ghost_head_full_tree}} -->
[View Source →](<../../../../../src/choreo/ghost/test_ghost.c#L592>)

Tests the behavior of a complete binary tree structure using the GHOST protocol, including node insertion, vote replay, and head node verification.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for memory allocation and management.
- **Logic and Control Flow**:
    - Allocate memory for the GHOST structure using `fd_wksp_alloc_laddr` with alignment and footprint based on `node_max`.
    - Initialize the GHOST structure with [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>) using the first hash in `hash_arr`.
    - Iterate from 1 to `node_max - 1` to insert nodes into the GHOST structure using [`fd_ghost_insert`](<fd_ghost.c.md#fd_ghost_insert>), setting parent-child relationships based on binary tree logic.
    - Replay votes for each node using [`fd_ghost_replay_vote`](<fd_ghost.c.md#fd_ghost_replay_vote>), assigning stakes incrementally.
    - Verify that each node's replay stake matches its index using `fd_ghost_query` and `FD_TEST`.
    - Check the validity of the GHOST structure with [`fd_ghost_verify`](<fd_ghost.c.md#fd_ghost_verify>).
    - Retrieve the head node of the tree using [`fd_ghost_head`](<fd_ghost.c.md#fd_ghost_head>) and verify its slot value.
    - Insert an additional node and replay a vote for it, then verify the head node again.
    - Ensure that adding another node would exceed the tree's capacity, which is not allowed.
- **Output**: No return value; the function performs tests and assertions to verify the correctness of the GHOST protocol implementation.
- **Functions Called**:
    - [`fd_ghost_align`](<fd_ghost.h.md#fd_ghost_align>)
    - [`fd_ghost_footprint`](<fd_ghost.h.md#fd_ghost_footprint>)
    - [`fd_ghost_join`](<fd_ghost.c.md#fd_ghost_join>)
    - [`fd_ghost_new`](<fd_ghost.c.md#fd_ghost_new>)
    - [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>)
    - [`fd_ghost_insert`](<fd_ghost.c.md#fd_ghost_insert>)
    - [`fd_ghost_replay_vote`](<fd_ghost.c.md#fd_ghost_replay_vote>)
    - [`fd_ghost_verify`](<fd_ghost.c.md#fd_ghost_verify>)
    - [`fd_ghost_print`](<fd_ghost.c.md#fd_ghost_print>)
    - [`fd_ghost_head`](<fd_ghost.c.md#fd_ghost_head>)


---
### test\_rooted\_vote<!-- {{#callable:test_rooted_vote}} -->
[View Source →](<../../../../../src/choreo/ghost/test_ghost.c#L646>)

Tests the behavior of the `fd_ghost` data structure when handling rooted votes and verifies the correctness of replay and rooted stakes.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace used for memory allocation and management.
- **Logic and Control Flow**:
    - Allocate memory for the `fd_ghost` data structure using `fd_wksp_alloc_laddr` and initialize it with [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>).
    - Create two public keys `pk1` and `pk2` and initialize an epoch with these keys and their respective stakes using [`mock_epoch`](<#mock_epoch>).
    - Query the voters `v1` and `v2` from the epoch using `fd_epoch_voters_query`.
    - Initialize a hash `hash_0` and insert a node with `hash_1` into the `fd_ghost` structure using [`fd_ghost_insert`](<fd_ghost.c.md#fd_ghost_insert>).
    - Replay a vote for `v1` on `hash_1` using [`fd_ghost_replay_vote`](<fd_ghost.c.md#fd_ghost_replay_vote>).
    - Perform a rooted vote for `v2` on the node with slot `1` using [`fd_ghost_rooted_vote`](<fd_ghost.c.md#fd_ghost_rooted_vote>).
    - Query the node with `hash_1` and verify its `replay_stake`, `weight`, and `rooted_stake` using `FD_TEST`.
    - Verify the integrity of the `fd_ghost` structure using [`fd_ghost_verify`](<fd_ghost.c.md#fd_ghost_verify>).
- **Output**: No output is returned, but the function performs assertions to verify the correctness of the `fd_ghost` structure's state.
- **Functions Called**:
    - [`fd_ghost_align`](<fd_ghost.h.md#fd_ghost_align>)
    - [`fd_ghost_footprint`](<fd_ghost.h.md#fd_ghost_footprint>)
    - [`fd_ghost_join`](<fd_ghost.c.md#fd_ghost_join>)
    - [`fd_ghost_new`](<fd_ghost.c.md#fd_ghost_new>)
    - [`mock_epoch`](<#mock_epoch>)
    - [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>)
    - [`fd_ghost_insert`](<fd_ghost.c.md#fd_ghost_insert>)
    - [`fd_ghost_replay_vote`](<fd_ghost.c.md#fd_ghost_replay_vote>)
    - [`fd_ghost_rooted_vote`](<fd_ghost.c.md#fd_ghost_rooted_vote>)
    - [`fd_ghost_verify`](<fd_ghost.c.md#fd_ghost_verify>)


---
### test\_ghost\_head\_valid<!-- {{#callable:test_ghost_head_valid}} -->
[View Source →](<../../../../../src/choreo/ghost/test_ghost.c#L689>)

Tests the validity of the head node in a GHOST protocol implementation by simulating various voting scenarios and node validity changes.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for memory allocation and management.
- **Logic and Control Flow**:
    - Allocate memory for the GHOST protocol structure using `fd_wksp_alloc_laddr` and initialize it with [`fd_ghost_new`](<fd_ghost.c.md#fd_ghost_new>) and [`fd_ghost_join`](<fd_ghost.c.md#fd_ghost_join>).
    - Create two public keys `pk1` and `pk2` and initialize an epoch with these keys and their respective stakes using [`mock_epoch`](<#mock_epoch>).
    - Query the voters `v1` and `v2` for the public keys using `fd_epoch_voters_query`.
    - Initialize the GHOST protocol with a root node using [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>) and insert nodes with `INSERT` macro.
    - Replay votes for nodes using [`fd_ghost_replay_vote`](<fd_ghost.c.md#fd_ghost_replay_vote>) and verify the GHOST structure with [`fd_ghost_verify`](<fd_ghost.c.md#fd_ghost_verify>).
    - Mark nodes as invalid or valid using [`query_mut`](<#query_mut>) to simulate changes in node validity.
    - Retrieve the head node using [`fd_ghost_head`](<fd_ghost.c.md#fd_ghost_head>) and verify its slot value with `FD_TEST`.
    - Optionally print the GHOST structure if `PRINT` is defined.
    - Free the allocated memory using `fd_wksp_free_laddr`.
- **Output**: No return value; the function performs tests and assertions to verify the correctness of the GHOST protocol implementation.
- **Functions Called**:
    - [`fd_ghost_align`](<fd_ghost.h.md#fd_ghost_align>)
    - [`fd_ghost_footprint`](<fd_ghost.h.md#fd_ghost_footprint>)
    - [`fd_ghost_join`](<fd_ghost.c.md#fd_ghost_join>)
    - [`fd_ghost_new`](<fd_ghost.c.md#fd_ghost_new>)
    - [`mock_epoch`](<#mock_epoch>)
    - [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>)
    - [`fd_ghost_replay_vote`](<fd_ghost.c.md#fd_ghost_replay_vote>)
    - [`fd_ghost_verify`](<fd_ghost.c.md#fd_ghost_verify>)
    - [`query_mut`](<#query_mut>)
    - [`fd_ghost_head`](<fd_ghost.c.md#fd_ghost_head>)
    - [`fd_ghost_print`](<fd_ghost.c.md#fd_ghost_print>)


---
### test\_duplicate\_simple<!-- {{#callable:test_duplicate_simple}} -->
[View Source →](<../../../../../src/choreo/ghost/test_ghost.c#L750>)

Tests the handling of duplicate nodes in a tree structure using the `fd_ghost` library.
- **Inputs**:
    - ``wksp``: A pointer to a workspace (`fd_wksp_t`) used for memory allocation and management.
- **Logic and Control Flow**:
    - Allocate memory for the ghost structure using `fd_wksp_alloc_laddr` with alignment and footprint based on `node_max`.
    - Initialize the ghost structure with [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>) using `hash_1`.
    - Insert nodes into the ghost structure to form a tree with branches, using [`fd_ghost_insert`](<fd_ghost.c.md#fd_ghost_insert>).
    - Verify that only the nodes 1, 2, and 3 are visible in the slot map using `FD_TEST` and `memcmp`.
    - Query the ghost structure for a duplicate child node and its parent using `fd_ghost_query` and `fd_ghost_pool_ele`.
    - Print the ghost structure using [`fd_ghost_print`](<fd_ghost.c.md#fd_ghost_print>).
    - Verify the integrity of the ghost structure using `FD_TEST` and [`fd_ghost_verify`](<fd_ghost.c.md#fd_ghost_verify>).
- **Output**: No return value; the function performs tests and assertions on the ghost structure.
- **Functions Called**:
    - [`fd_ghost_align`](<fd_ghost.h.md#fd_ghost_align>)
    - [`fd_ghost_footprint`](<fd_ghost.h.md#fd_ghost_footprint>)
    - [`fd_ghost_join`](<fd_ghost.c.md#fd_ghost_join>)
    - [`fd_ghost_new`](<fd_ghost.c.md#fd_ghost_new>)
    - [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>)
    - [`fd_ghost_insert`](<fd_ghost.c.md#fd_ghost_insert>)
    - [`fd_ghost_hash`](<fd_ghost.h.md#fd_ghost_hash>)
    - [`fd_ghost_print`](<fd_ghost.c.md#fd_ghost_print>)
    - [`fd_ghost_verify`](<fd_ghost.c.md#fd_ghost_verify>)


---
### test\_many\_duplicates<!-- {{#callable:test_many_duplicates}} -->
[View Source →](<../../../../../src/choreo/ghost/test_ghost.c#L801>)

Tests the handling of duplicate nodes in a ghost tree structure by inserting nodes with duplicate hashes and verifying the correct visibility and structure of the tree.
- **Inputs**:
    - ``wksp``: A pointer to a workspace (`fd_wksp_t`) used for memory allocation and management.
- **Logic and Control Flow**:
    - Allocate memory for the ghost tree using `fd_wksp_alloc_laddr` and verify allocation with `FD_TEST`.
    - Initialize the ghost tree with [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>) using a root hash `hash_1`.
    - Insert nodes into the ghost tree with [`fd_ghost_insert`](<fd_ghost.c.md#fd_ghost_insert>), creating a structure with potential duplicate nodes.
    - Define a set of visible slots and hashes to verify the expected visible nodes in the ghost tree.
    - Iterate over the ghost tree's slot map using `fd_ghost_slot_map_iter_init`, `fd_ghost_slot_map_iter_done`, and `fd_ghost_slot_map_iter_next`.
    - For each element in the slot map, verify that the slot and hash match the expected visible slots and hashes using `FD_TEST` and `memcmp`.
    - Ensure the count of visible nodes matches the expected count.
    - Print the ghost tree structure using [`fd_ghost_print`](<fd_ghost.c.md#fd_ghost_print>).
    - Simulate a voting action on the ghost tree using [`fd_ghost_replay_vote`](<fd_ghost.c.md#fd_ghost_replay_vote>).
- **Output**: No return value; the function performs tests and assertions to verify the correct handling of duplicate nodes in the ghost tree.
- **Functions Called**:
    - [`fd_ghost_align`](<fd_ghost.h.md#fd_ghost_align>)
    - [`fd_ghost_footprint`](<fd_ghost.h.md#fd_ghost_footprint>)
    - [`fd_ghost_join`](<fd_ghost.c.md#fd_ghost_join>)
    - [`fd_ghost_new`](<fd_ghost.c.md#fd_ghost_new>)
    - [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>)
    - [`fd_ghost_insert`](<fd_ghost.c.md#fd_ghost_insert>)
    - [`fd_ghost_print`](<fd_ghost.c.md#fd_ghost_print>)
    - [`fd_ghost_replay_vote`](<fd_ghost.c.md#fd_ghost_replay_vote>)


---
### run\_test\_state\_duplicate\_then\_bank\_frozen<!-- {{#callable:run_test_state_duplicate_then_bank_frozen}} -->
[View Source →](<../../../../../src/choreo/ghost/test_ghost.c#L875>)

Tests the behavior of the `fd_ghost` structure when handling duplicate messages and bank freezing scenarios.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for memory allocation.
- **Logic and Control Flow**:
    - Allocate memory for the `fd_ghost` structure using `fd_wksp_alloc_laddr` with alignment and footprint based on `node_max`.
    - Initialize the `fd_ghost` structure with [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>) using `hash_0`.
    - Insert a node into the `fd_ghost` structure with [`fd_ghost_insert`](<fd_ghost.c.md#fd_ghost_insert>) using `hash_0` and `hash_1`.
    - Call [`process_duplicate`](<fd_ghost.c.md#process_duplicate>) to simulate receiving a duplicate message for slot 2, which does not affect the structure because slot 2 has not been replayed.
    - Verify that the hash for slot 2 is `NULL` and the head of the ghost structure is at slot 1 using [`fd_ghost_hash`](<fd_ghost.h.md#fd_ghost_hash>) and [`fd_ghost_head`](<fd_ghost.c.md#fd_ghost_head>).
    - Insert another node into the `fd_ghost` structure with [`fd_ghost_insert`](<fd_ghost.c.md#fd_ghost_insert>) using `hash_1` and `hash_2` to simulate finishing the replay of slot 2.
    - Check that the node for `hash_2` is not valid and the head remains at slot 1 using `fd_ghost_query` and [`fd_ghost_head`](<fd_ghost.c.md#fd_ghost_head>).
- **Output**: No return value; the function performs tests and assertions on the `fd_ghost` structure.
- **Functions Called**:
    - [`fd_ghost_align`](<fd_ghost.h.md#fd_ghost_align>)
    - [`fd_ghost_footprint`](<fd_ghost.h.md#fd_ghost_footprint>)
    - [`fd_ghost_join`](<fd_ghost.c.md#fd_ghost_join>)
    - [`fd_ghost_new`](<fd_ghost.c.md#fd_ghost_new>)
    - [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>)
    - [`fd_ghost_insert`](<fd_ghost.c.md#fd_ghost_insert>)
    - [`process_duplicate`](<fd_ghost.c.md#process_duplicate>)
    - [`fd_ghost_hash`](<fd_ghost.h.md#fd_ghost_hash>)
    - [`fd_ghost_head`](<fd_ghost.c.md#fd_ghost_head>)


---
### test\_state\_ancestor\_confirmed\_descendant\_duplicate<!-- {{#callable:test_state_ancestor_confirmed_descendant_duplicate}} -->
[View Source →](<../../../../../src/choreo/ghost/test_ghost.c#L908>)

Tests the behavior of a ghost node structure when an ancestor is confirmed and a descendant is marked as duplicate.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for memory allocation.
- **Logic and Control Flow**:
    - Allocate memory for the ghost node structure using `fd_wksp_alloc_laddr` with alignment and footprint for `node_max`.
    - Initialize a ghost node structure with [`fd_ghost_new`](<fd_ghost.c.md#fd_ghost_new>) and join it with [`fd_ghost_join`](<fd_ghost.c.md#fd_ghost_join>).
    - Create a duplicate map using `fd_ghost_dup_map`.
    - Define hash values for nodes 0, 1, 2, and 3 using `fd_hash_t`.
    - Initialize the ghost node structure with [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>) and insert nodes 1, 2, and 3 using [`fd_ghost_insert`](<fd_ghost.c.md#fd_ghost_insert>).
    - Verify that the head of the ghost node structure is at slot 3 using [`fd_ghost_head`](<fd_ghost.c.md#fd_ghost_head>).
    - Process a confirmed duplicate for node 2 using [`process_duplicate_confirmed`](<fd_ghost.c.md#process_duplicate_confirmed>) and verify the head remains at slot 3.
    - Mark node 3 as duplicate using [`process_duplicate`](<fd_ghost.c.md#process_duplicate>) and verify it is recorded in the duplicate map with `fd_dup_seen_map_query`.
    - Verify that the head of the ghost node structure is now at slot 2.
- **Output**: No return value; the function performs tests and assertions on the ghost node structure.
- **Functions Called**:
    - [`fd_ghost_align`](<fd_ghost.h.md#fd_ghost_align>)
    - [`fd_ghost_footprint`](<fd_ghost.h.md#fd_ghost_footprint>)
    - [`fd_ghost_join`](<fd_ghost.c.md#fd_ghost_join>)
    - [`fd_ghost_new`](<fd_ghost.c.md#fd_ghost_new>)
    - [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>)
    - [`fd_ghost_insert`](<fd_ghost.c.md#fd_ghost_insert>)
    - [`fd_ghost_head`](<fd_ghost.c.md#fd_ghost_head>)
    - [`process_duplicate_confirmed`](<fd_ghost.c.md#process_duplicate_confirmed>)
    - [`process_duplicate`](<fd_ghost.c.md#process_duplicate>)


---
### test\_state\_ancestor\_duplicate\_descendant\_confirmed<!-- {{#callable:test_state_ancestor_duplicate_descendant_confirmed}} -->
[View Source →](<../../../../../src/choreo/ghost/test_ghost.c#L943>)

Tests the behavior of a ghost data structure when an ancestor node is marked as a duplicate and a descendant node is confirmed.
- **Inputs**:
    - ``wksp``: A pointer to a workspace (`fd_wksp_t`) used for memory allocation.
- **Logic and Control Flow**:
    - Allocate memory for the ghost data structure using `fd_wksp_alloc_laddr` and check allocation success with `FD_TEST`.
    - Initialize the ghost data structure with [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>) and insert nodes with [`fd_ghost_insert`](<fd_ghost.c.md#fd_ghost_insert>).
    - Check the head of the ghost structure to ensure it is the expected node using [`fd_ghost_head`](<fd_ghost.c.md#fd_ghost_head>).
    - Mark a node as duplicate using [`process_duplicate`](<fd_ghost.c.md#process_duplicate>) and verify it with `fd_dup_seen_map_query`.
    - Replay a vote for a node using [`fd_ghost_replay_vote`](<fd_ghost.c.md#fd_ghost_replay_vote>) and check if the node becomes duplicate confirmed with [`is_duplicate_confirmed`](<fd_ghost.h.md#fd_fn_unusedis_duplicate_confirmed>).
    - If the node is duplicate confirmed, process it with [`process_duplicate_confirmed`](<fd_ghost.c.md#process_duplicate_confirmed>) and verify the node's validity and head position.
- **Output**: No return value; the function performs tests and assertions to verify the behavior of the ghost data structure.
- **Functions Called**:
    - [`fd_ghost_align`](<fd_ghost.h.md#fd_ghost_align>)
    - [`fd_ghost_footprint`](<fd_ghost.h.md#fd_ghost_footprint>)
    - [`fd_ghost_join`](<fd_ghost.c.md#fd_ghost_join>)
    - [`fd_ghost_new`](<fd_ghost.c.md#fd_ghost_new>)
    - [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>)
    - [`fd_ghost_insert`](<fd_ghost.c.md#fd_ghost_insert>)
    - [`fd_ghost_head`](<fd_ghost.c.md#fd_ghost_head>)
    - [`process_duplicate`](<fd_ghost.c.md#process_duplicate>)
    - [`fd_ghost_replay_vote`](<fd_ghost.c.md#fd_ghost_replay_vote>)
    - [`FD_FN_UNUSED::is_duplicate_confirmed`](<fd_ghost.h.md#fd_fn_unusedis_duplicate_confirmed>)
    - [`process_duplicate_confirmed`](<fd_ghost.c.md#process_duplicate_confirmed>)


---
### test\_state\_descendant\_confirmed\_ancestor\_duplicate<!-- {{#callable:test_state_descendant_confirmed_ancestor_duplicate}} -->
[View Source →](<../../../../../src/choreo/ghost/test_ghost.c#L985>)

Tests the behavior of a ghost node system when a descendant node is confirmed and an ancestor node is marked as a duplicate.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for memory allocation.
- **Logic and Control Flow**:
    - Allocate memory for ghost node operations using `fd_wksp_alloc_laddr` and check allocation success with `FD_TEST`.
    - Initialize a ghost node structure with [`fd_ghost_new`](<fd_ghost.c.md#fd_ghost_new>) and [`fd_ghost_join`](<fd_ghost.c.md#fd_ghost_join>).
    - Create a duplicate map using `fd_ghost_dup_map`.
    - Define hash values for nodes 0 to 3 using `fd_hash_t`.
    - Initialize the ghost node with [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>) and insert nodes 1 to 3 using [`fd_ghost_insert`](<fd_ghost.c.md#fd_ghost_insert>).
    - Check if the head of the ghost node is at slot 3 using [`fd_ghost_head`](<fd_ghost.c.md#fd_ghost_head>).
    - Create a voter structure `v1` and replay a vote for node 3 using [`fd_ghost_replay_vote`](<fd_ghost.c.md#fd_ghost_replay_vote>).
    - Verify if node 3 is duplicate confirmed using [`is_duplicate_confirmed`](<fd_ghost.h.md#fd_fn_unusedis_duplicate_confirmed>).
    - If node 3 is confirmed as a duplicate, process it with [`process_duplicate_confirmed`](<fd_ghost.c.md#process_duplicate_confirmed>).
    - Print the ghost node structure using [`fd_ghost_print`](<fd_ghost.c.md#fd_ghost_print>).
    - Iterate over slots 0 to 3, query each node with `fd_ghost_query`, and check validity and duplicate confirmation.
    - Process node 1 as a duplicate using [`process_duplicate`](<fd_ghost.c.md#process_duplicate>) and verify it with `fd_dup_seen_map_query`.
    - Check if the head of the ghost node remains at slot 3.
- **Output**: No return value; the function performs tests and assertions on the ghost node system.
- **Functions Called**:
    - [`fd_ghost_align`](<fd_ghost.h.md#fd_ghost_align>)
    - [`fd_ghost_footprint`](<fd_ghost.h.md#fd_ghost_footprint>)
    - [`fd_ghost_join`](<fd_ghost.c.md#fd_ghost_join>)
    - [`fd_ghost_new`](<fd_ghost.c.md#fd_ghost_new>)
    - [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>)
    - [`fd_ghost_insert`](<fd_ghost.c.md#fd_ghost_insert>)
    - [`fd_ghost_head`](<fd_ghost.c.md#fd_ghost_head>)
    - [`fd_ghost_replay_vote`](<fd_ghost.c.md#fd_ghost_replay_vote>)
    - [`FD_FN_UNUSED::is_duplicate_confirmed`](<fd_ghost.h.md#fd_fn_unusedis_duplicate_confirmed>)
    - [`process_duplicate_confirmed`](<fd_ghost.c.md#process_duplicate_confirmed>)
    - [`fd_ghost_print`](<fd_ghost.c.md#fd_ghost_print>)
    - [`fd_ghost_hash`](<fd_ghost.h.md#fd_ghost_hash>)
    - [`process_duplicate`](<fd_ghost.c.md#process_duplicate>)


---
### test\_duplicate\_after\_frozen<!-- {{#callable:test_duplicate_after_frozen}} -->
[View Source →](<../../../../../src/choreo/ghost/test_ghost.c#L1034>)

Tests the behavior of the `fd_ghost` structure when a duplicate is processed after the structure is frozen.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for memory allocation.
- **Logic and Control Flow**:
    - Allocate memory for the `fd_ghost` structure using `fd_wksp_alloc_laddr` with alignment and footprint based on `node_max`.
    - Check if memory allocation was successful using `FD_TEST`.
    - Initialize a `fd_ghost` structure with [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>) using `hash_0`.
    - Insert a node into the `fd_ghost` structure with [`fd_ghost_insert`](<fd_ghost.c.md#fd_ghost_insert>) using `hash_1`.
    - Process a duplicate for the node with [`process_duplicate`](<fd_ghost.c.md#process_duplicate>).
    - Verify that the head of the `fd_ghost` structure is at slot 0 using `FD_TEST`.
- **Output**: No return value; the function performs tests and uses assertions to verify behavior.
- **Functions Called**:
    - [`fd_ghost_align`](<fd_ghost.h.md#fd_ghost_align>)
    - [`fd_ghost_footprint`](<fd_ghost.h.md#fd_ghost_footprint>)
    - [`fd_ghost_join`](<fd_ghost.c.md#fd_ghost_join>)
    - [`fd_ghost_new`](<fd_ghost.c.md#fd_ghost_new>)
    - [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>)
    - [`fd_ghost_insert`](<fd_ghost.c.md#fd_ghost_insert>)
    - [`process_duplicate`](<fd_ghost.c.md#process_duplicate>)
    - [`fd_ghost_head`](<fd_ghost.c.md#fd_ghost_head>)


---
### test\_duplicate\_node\_inserted<!-- {{#callable:test_duplicate_node_inserted}} -->
[View Source →](<../../../../../src/choreo/ghost/test_ghost.c#L1055>)

Tests the behavior of inserting a duplicate node in a ghost data structure and verifies that the original node remains in the slot map while the new hash is tracked separately.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for memory allocation.
- **Logic and Control Flow**:
    - Allocate memory for the ghost data structure using `fd_wksp_alloc_laddr` with alignment and footprint for `node_max`.
    - Initialize a new ghost data structure with [`fd_ghost_new`](<fd_ghost.c.md#fd_ghost_new>) and join it with [`fd_ghost_join`](<fd_ghost.c.md#fd_ghost_join>).
    - Initialize the ghost with a root node using [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>).
    - Check that the slot for the duplicate node is initially empty using [`fd_ghost_hash`](<fd_ghost.h.md#fd_ghost_hash>).
    - Insert a node into the ghost data structure using [`fd_ghost_insert`](<fd_ghost.c.md#fd_ghost_insert>) and verify the insertion with [`fd_ghost_hash`](<fd_ghost.h.md#fd_ghost_hash>) and `memcmp`.
    - Insert a duplicate node with a different hash into the same slot and verify that the slot map still points to the original hash while the new hash is tracked separately.
    - Query the new hash directly using `fd_ghost_query` and verify its presence.
    - Clean up by leaving and deleting the ghost data structure and freeing the allocated memory.
- **Output**: No return value; the function performs tests and assertions to verify the correct behavior of the ghost data structure when handling duplicate nodes.
- **Functions Called**:
    - [`fd_ghost_align`](<fd_ghost.h.md#fd_ghost_align>)
    - [`fd_ghost_footprint`](<fd_ghost.h.md#fd_ghost_footprint>)
    - [`fd_ghost_join`](<fd_ghost.c.md#fd_ghost_join>)
    - [`fd_ghost_new`](<fd_ghost.c.md#fd_ghost_new>)
    - [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>)
    - [`fd_ghost_hash`](<fd_ghost.h.md#fd_ghost_hash>)
    - [`fd_ghost_insert`](<fd_ghost.c.md#fd_ghost_insert>)
    - [`fd_ghost_delete`](<fd_ghost.c.md#fd_ghost_delete>)
    - [`fd_ghost_leave`](<fd_ghost.c.md#fd_ghost_leave>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/choreo/ghost/test_ghost.c#L1105>)

Initializes the environment, sets up a workspace, and runs a series of tests on ghost and duplicate handling functions.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Sets `page_cnt` to 1 and `_page_sz` to "gigantic" for workspace configuration.
    - Retrieves the NUMA index using `fd_shmem_numa_idx` with argument 0.
    - Creates a new anonymous workspace `wksp` using `fd_wksp_new_anonymous` with the specified page size, page count, and CPU index.
    - Checks if the workspace `wksp` is successfully created using `FD_TEST`.
    - Executes a series of test functions ([`test_duplicate_simple`](<#test_duplicate_simple>), [`test_many_duplicates`](<#test_many_duplicates>), etc.) with the workspace `wksp` as an argument.
    - Calls `fd_halt` to clean up and terminate the program.
    - Returns 0 to indicate successful execution.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`test_duplicate_simple`](<#test_duplicate_simple>)
    - [`test_many_duplicates`](<#test_many_duplicates>)
    - [`test_ghost_simple`](<#test_ghost_simple>)
    - [`test_ghost_publish_left`](<#test_ghost_publish_left>)
    - [`test_ghost_publish_right`](<#test_ghost_publish_right>)
    - [`test_ghost_gca`](<#test_ghost_gca>)
    - [`test_ghost_vote_leaves`](<#test_ghost_vote_leaves>)
    - [`test_ghost_head_full_tree`](<#test_ghost_head_full_tree>)
    - [`test_ghost_head`](<#test_ghost_head>)
    - [`test_rooted_vote`](<#test_rooted_vote>)
    - [`test_ghost_old_vote_pruned`](<#test_ghost_old_vote_pruned>)
    - [`test_ghost_head_valid`](<#test_ghost_head_valid>)
    - [`test_duplicate_after_frozen`](<#test_duplicate_after_frozen>)
    - [`test_duplicate_node_inserted`](<#test_duplicate_node_inserted>)
    - [`test_state_ancestor_confirmed_descendant_duplicate`](<#test_state_ancestor_confirmed_descendant_duplicate>)
    - [`run_test_state_duplicate_then_bank_frozen`](<#run_test_state_duplicate_then_bank_frozen>)
    - [`test_state_ancestor_duplicate_descendant_confirmed`](<#test_state_ancestor_duplicate_descendant_confirmed>)
    - [`test_state_descendant_confirmed_ancestor_duplicate`](<#test_state_descendant_confirmed_ancestor_duplicate>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)