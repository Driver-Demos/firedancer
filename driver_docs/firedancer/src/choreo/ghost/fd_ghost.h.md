<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements Solana's LMD-GHOST fork choice rule with data structures and functions for managing and querying fork trees.

# Purpose
The code defines a C header file for implementing Solana's LMD-GHOST ("latest message-driven greedy heaviest-observed subtree") fork choice rule. This rule is used in blockchain protocols to determine the best fork based on validator votes. The code provides a detailed explanation of the LMD-GHOST protocol, which involves counting only the latest vote from each validator and selecting the heaviest subtree based on stake weight. The code includes data structures and functions to manage and manipulate the in-memory representation of the fork choice tree, which consists of two maps: one keyed by slot number and another by hash ID. These maps help track the stake and weight of each slot and its subtree, allowing the protocol to make informed decisions about the best fork.

The file defines several key components, including the `fd_ghost_ele_t` structure, which represents elements in the fork choice tree, and the `fd_ghost_t` structure, which holds the root of the tree and associated metadata. The code also includes functions for creating, joining, and managing the ghost structure, as well as operations for inserting elements, voting, and publishing new roots. Additionally, the file provides utility functions for querying and verifying the integrity of the ghost structure. The header file is intended to be included in other C files, providing a public API for interacting with the LMD-GHOST implementation.
# Imports and Dependencies

---
- `../fd_choreo_base.h`
- `../epoch/fd_epoch.h`
- `../../tango/fseq/fd_fseq.h`
- `../../util/tmpl/fd_pool.c`
- `../../util/tmpl/fd_map_chain.c`
- `../../util/tmpl/fd_map_dynamic.c`


# Data Structures

---
### fd\_ghost\_ele
- **Type**: ``struct``
- **Members**:
    - `key`: Hash identifier, specifically the Merkle root of the last FEC set in the slot.
    - `slot`: Slot number that this element is tracking.
    - `next`: Reserved for internal use by `fd_pool`, `hash_map fd_map_chain`, and `fd_ghost_publish`.
    - `nexts`: Reserved for internal use by `slot_map fd_map_chain`.
    - `eqvoc`: Pool index of a duplicate of this slot.
    - `parent`: Pool index of the parent element.
    - `child`: Pool index of the left-child element.
    - `sibling`: Pool index of the right-sibling element.
    - `weight`: Total stake from replay votes for this slot or any of its descendants.
    - `replay_stake`: Total stake from replay votes for this slot.
    - `gossip_stake`: Total stake from gossip votes for this slot.
    - `rooted_stake`: Replay stake that has rooted this slot.
    - `valid`: Indicates whether this element is valid for fork choice.
- **Description**: Defines an element in a left-child, right-sibling n-ary tree structure used in the LMD-GHOST fork choice rule, tracking various attributes such as slot number, parent-child relationships, and stake information for fork choice decisions.


---
### fd\_ghost\_ele\_t
- **Type**: ``struct``
- **Members**:
    - ``key``: Hash identifier, typically the Merkle root of the last FEC set in the slot.
    - ``slot``: Slot number that this element is tracking.
    - ``next``: Reserved for internal use by `fd_pool`, `hash_map fd_map_chain`, and `fd_ghost_publish`.
    - ``nexts``: Reserved for internal use by `slot_map fd_map_chain`.
    - ``eqvoc``: Pool index of a duplicate of this slot.
    - ``parent``: Pool index of the parent element.
    - ``child``: Pool index of the left-most child element.
    - ``sibling``: Pool index of the immediate right sibling element.
    - ``weight``: Total stake from replay votes for this slot or any of its descendants.
    - ``replay_stake``: Total stake from replay votes for this slot.
    - ``gossip_stake``: Total stake from gossip votes for this slot.
    - ``rooted_stake``: Replay stake that has rooted this slot.
    - ``valid``: Indicates whether this element is valid for fork choice.
- **Description**: `fd_ghost_ele_t` is a data structure that implements a left-child, right-sibling n-ary tree used in the LMD-GHOST fork choice rule. It tracks various attributes of a slot in a blockchain, such as its hash identifier, slot number, and stake information. The structure is designed to support operations from processes with separate local ghost joins, and it maintains indices for parent, child, and sibling relationships within the tree. It also includes fields for managing duplicate slots and internal use by associated maps and pools.


---
### fd\_dup\_seen
- **Type**: ``struct``
- **Members**:
    - ``slot``: Stores the slot number associated with the duplicate seen.
- **Description**: The `fd_dup_seen` structure is a simple data structure that contains a single member, `slot`, which is used to store the slot number of a duplicate that has been observed. This structure is part of a map (`fd_dup_seen_map`) that facilitates tracking of duplicate slots in the context of the LMD-GHOST fork choice rule implementation.


---
### fd\_dup\_seen\_t
- **Type**: ``struct``
- **Members**:
    - `slot`: Tracks the slot number associated with this instance.
- **Description**: `fd_dup_seen_t` is a simple data structure that contains a single member, `slot`, which is used to track the slot number associated with a particular instance. This structure is likely used in the context of managing or tracking duplicate slots within a larger system, such as a blockchain or distributed ledger, where slot numbers are significant for maintaining order or state.


---
### fd\_ghost
- **Type**: ``struct``
- **Members**:
    - `magic`: A constant value used to verify the integrity of the `fd_ghost` structure.
    - `ghost_gaddr`: The global address of this `fd_ghost` instance in the backing workspace, must be non-zero.
    - `seed`: An arbitrary seed used for various hashing functions within the structure.
    - `root`: The pool index of the root element in the tree structure.
    - `pool_gaddr`: The global address of the pool backing this `fd_ghost`, must be non-zero.
    - `hash_map_gaddr`: The global address of the hash map for fast O(1) querying by hash, must be non-zero.
    - `slot_map_gaddr`: The global address of the slot map for fast O(1) querying by slot, must be non-zero.
    - `dup_map_gaddr`: The global address of the duplicate map for fast O(1) querying, must be non-zero.
- **Description**: Implements Solana's LMD-GHOST fork choice rule, managing metadata and memory addresses for tree elements and maps used in the protocol. The structure aligns with 128 bytes and includes fields for metadata verification, hashing, and memory management, ensuring efficient querying and manipulation of the tree structure.


---
### fd\_ghost\_t
- **Type**: ``struct``
- **Members**:
    - `magic`: A constant value used to verify the integrity of the `fd_ghost_t` structure.
    - `ghost_gaddr`: The global address of the `fd_ghost_t` in the workspace, ensuring it is non-zero.
    - `seed`: A seed value used for hashing functions within the structure.
    - `root`: The index of the root element in the pool.
    - `pool_gaddr`: The global address of the pool backing the `fd_ghost_t`, ensuring it is non-zero.
    - `hash_map_gaddr`: The global address of the hash map for fast querying by hash, ensuring it is non-zero.
    - `slot_map_gaddr`: The global address of the slot map for fast querying by slot, ensuring it is non-zero.
    - `dup_map_gaddr`: The global address of the duplicate map for fast querying, ensuring it is non-zero.
- **Description**: `fd_ghost_t` is a top-level structure that manages the root of a tree and associated memory pools and map structures for tracking elements and votes in a Solana LMD-GHOST fork choice rule implementation. It is aligned to 128 bytes and includes metadata for integrity verification, memory addressing, and hashing. The structure is designed to be bump-allocated and laid out contiguously in memory, ensuring efficient access and manipulation of the tree elements and their associated data.


# Functions

---
### fd\_ghost\_align<!-- {{#callable:fd_ghost_align}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L217>)

Returns the required memory alignment for a `fd_ghost_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Uses the `alignof` operator to determine the alignment requirement of the `fd_ghost_t` type.
    - Returns the alignment value as an unsigned long integer.
- **Output**: An unsigned long integer representing the alignment requirement of the `fd_ghost_t` structure.


---
### fd\_ghost\_footprint<!-- {{#callable:fd_ghost_footprint}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L230>)

Calculates the memory footprint required for a ghost structure with a specified maximum number of elements.
- **Inputs**:
    - `ele_max`: The maximum number of elements that the ghost structure will support.
- **Logic and Control Flow**:
    - Calculate `lg_ele_max` as the most significant bit of the smallest power of two greater than or equal to `ele_max` using `fd_ulong_find_msb` and `fd_ulong_pow2_up`.
    - Initialize the layout with `FD_LAYOUT_INIT`.
    - Append the alignment and size of `fd_ghost_t` to the layout.
    - Append the alignment and footprint of the ghost pool for `ele_max` elements to the layout.
    - Append the alignment and footprint of the ghost hash map for `ele_max` elements to the layout.
    - Append the alignment and footprint of the ghost slot map for `ele_max` elements to the layout.
    - Append the alignment and footprint of the duplicate seen map for `lg_ele_max` elements to the layout.
    - Finalize the layout with the alignment of `fd_ghost_t`.
- **Output**: Returns the total memory footprint required for the ghost structure.
- **Functions Called**:
    - [`fd_ghost_align`](<#fd_ghost_align>)


---
### fd\_ghost\_wksp<!-- {{#callable:fd_ghost_wksp}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L299>)

Returns a pointer to the workspace backing the given ghost structure.
- **Inputs**:
    - `ghost`: A pointer to a constant `fd_ghost_t` structure representing the ghost.
- **Logic and Control Flow**:
    - Casts the `ghost` pointer to an unsigned long integer.
    - Subtracts the `ghost_gaddr` field from this integer value.
    - Casts the result back to a `fd_wksp_t` pointer.
- **Output**: A pointer to the `fd_wksp_t` structure that backs the given ghost.


---
### fd\_ghost\_pool\_const<!-- {{#callable:fd_ghost_pool_const}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L309>)

Returns a constant pointer to the pool of tree elements in the ghost structure.
- **Inputs**:
    - `ghost`: A constant pointer to an `fd_ghost_t` structure representing the ghost.
- **Logic and Control Flow**:
    - Calls [`fd_ghost_wksp`](<#fd_ghost_wksp>) with `ghost` to get the workspace backing the ghost.
    - Uses `fd_wksp_laddr_fast` to compute the local address of the pool using the workspace and `ghost->pool_gaddr`.
    - Returns the computed local address as a constant pointer to `fd_ghost_ele_t`.
- **Output**: A constant pointer to `fd_ghost_ele_t`, representing the pool of tree elements in the ghost structure.
- **Functions Called**:
    - [`fd_ghost_wksp`](<#fd_ghost_wksp>)


---
### fd\_ghost\_hash\_map\_const<!-- {{#callable:fd_ghost_hash_map_const}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L311>)

Returns a constant pointer to the hash map associated with a given `fd_ghost_t` structure.
- **Inputs**:
    - `ghost`: A constant pointer to an `fd_ghost_t` structure, representing the ghost object whose hash map is to be accessed.
- **Logic and Control Flow**:
    - Calls [`fd_ghost_wksp`](<#fd_ghost_wksp>) with `ghost` to get the workspace associated with the ghost.
    - Uses `fd_wksp_laddr_fast` to compute the local address of the hash map using the workspace and the `hash_map_gaddr` from the `ghost`.
    - Returns the computed local address as a constant pointer to `fd_ghost_hash_map_t`.
- **Output**: A constant pointer to `fd_ghost_hash_map_t`, representing the hash map associated with the given ghost.
- **Functions Called**:
    - [`fd_ghost_wksp`](<#fd_ghost_wksp>)


---
### fd\_ghost\_slot\_map\_const<!-- {{#callable:fd_ghost_slot_map_const}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L313>)

Returns a constant pointer to the slot map of a given ghost structure.
- **Inputs**:
    - `ghost`: A constant pointer to an `fd_ghost_t` structure, representing the ghost from which to retrieve the slot map.
- **Logic and Control Flow**:
    - Calls [`fd_ghost_wksp`](<#fd_ghost_wksp>) with `ghost` to get the workspace associated with the ghost.
    - Uses `fd_wksp_laddr_fast` to compute the local address of the slot map using the workspace and the `slot_map_gaddr` from `ghost`.
    - Returns the computed local address as a constant pointer to `fd_ghost_slot_map_t`.
- **Output**: A constant pointer to `fd_ghost_slot_map_t`, representing the slot map of the ghost.
- **Functions Called**:
    - [`fd_ghost_wksp`](<#fd_ghost_wksp>)


---
### fd\_ghost\_dup\_map\_const<!-- {{#callable:fd_ghost_dup_map_const}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L315>)

Returns a constant pointer to the duplicate map associated with a given ghost structure.
- **Inputs**:
    - `ghost`: A constant pointer to an `fd_ghost_t` structure, representing the ghost from which to retrieve the duplicate map.
- **Logic and Control Flow**:
    - Calls [`fd_ghost_wksp`](<#fd_ghost_wksp>) with the `ghost` pointer to get the workspace associated with the ghost.
    - Uses `fd_wksp_laddr_fast` to compute the local address of the duplicate map using the workspace and the `dup_map_gaddr` field from the `ghost` structure.
    - Returns the computed local address as a constant pointer to `fd_dup_seen_t`.
- **Output**: A constant pointer to `fd_dup_seen_t`, representing the duplicate map associated with the given ghost.
- **Functions Called**:
    - [`fd_ghost_wksp`](<#fd_ghost_wksp>)


---
### fd\_ghost\_root\_const<!-- {{#callable:fd_ghost_root_const}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L324>)

Returns a constant pointer to the root element of a ghost tree.
- **Inputs**:
    - `ghost`: A constant pointer to an `fd_ghost_t` structure representing the ghost tree.
- **Logic and Control Flow**:
    - Calls [`fd_ghost_pool_const`](<#fd_ghost_pool_const>) with `ghost` to get a constant pointer to the pool of elements.
    - Accesses the `root` index from the `ghost` structure.
    - Calls `fd_ghost_pool_ele_const` with the pool and the root index to get a constant pointer to the root element.
    - Returns the constant pointer to the root element.
- **Output**: A constant pointer to the root element of the ghost tree (`fd_ghost_ele_t const *`).
- **Functions Called**:
    - [`fd_ghost_pool_const`](<#fd_ghost_pool_const>)


---
### fd\_ghost\_parent\_const<!-- {{#callable:fd_ghost_parent_const}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L326>)

Retrieves the parent element of a given element in a ghost tree structure.
- **Inputs**:
    - `ghost`: A pointer to a constant `fd_ghost_t` structure representing the ghost tree.
    - `ele`: A pointer to a constant `fd_ghost_ele_t` structure representing the element whose parent is to be retrieved.
- **Logic and Control Flow**:
    - Calls [`fd_ghost_pool_const`](<#fd_ghost_pool_const>) with `ghost` to get a constant pointer to the pool of elements.
    - Accesses the `parent` index from the `ele` structure.
    - Calls `fd_ghost_pool_ele_const` with the pool pointer and the `parent` index to retrieve the parent element.
- **Output**: A constant pointer to the parent `fd_ghost_ele_t` structure of the given element.
- **Functions Called**:
    - [`fd_ghost_pool_const`](<#fd_ghost_pool_const>)


---
### fd\_ghost\_child\_const<!-- {{#callable:fd_ghost_child_const}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L328>)

Retrieves a constant pointer to the left-most child of a given element in a GHOST tree structure.
- **Inputs**:
    - ``ghost``: A constant pointer to an `fd_ghost_t` structure representing the GHOST tree.
    - ``ele``: A constant pointer to an `fd_ghost_ele_t` structure representing the element whose child is to be retrieved.
- **Logic and Control Flow**:
    - Calls [`fd_ghost_pool_const`](<#fd_ghost_pool_const>) with `ghost` to get a constant pointer to the pool of elements.
    - Accesses the `child` index of the `ele` to find the left-most child.
    - Calls `fd_ghost_pool_ele_const` with the pool and the `child` index to get a constant pointer to the child element.
    - Returns the constant pointer to the child element.
- **Output**: A constant pointer to the left-most child element of the specified element in the GHOST tree.
- **Functions Called**:
    - [`fd_ghost_pool_const`](<#fd_ghost_pool_const>)


---
### fd\_ghost\_sibling\_const<!-- {{#callable:fd_ghost_sibling_const}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L330>)

Retrieves the constant pointer to the right sibling of a given element in a GHOST tree structure.
- **Inputs**:
    - ``ghost``: A constant pointer to the `fd_ghost_t` structure representing the GHOST tree.
    - ``ele``: A constant pointer to the `fd_ghost_ele_t` structure representing the current element whose sibling is to be retrieved.
- **Logic and Control Flow**:
    - Calls [`fd_ghost_pool_const`](<#fd_ghost_pool_const>) with `ghost` to get a constant pointer to the pool of elements.
    - Accesses the `sibling` index from the `ele` structure to identify the right sibling.
    - Calls `fd_ghost_pool_ele_const` with the pool and the sibling index to retrieve the constant pointer to the sibling element.
- **Output**: A constant pointer to the `fd_ghost_ele_t` structure representing the right sibling of the given element.
- **Functions Called**:
    - [`fd_ghost_pool_const`](<#fd_ghost_pool_const>)


---
### fd\_ghost\_query\_const<!-- {{#callable:fd_ghost_query_const}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L343>)

Queries a constant element in the ghost hash map using a given hash.
- **Inputs**:
    - `ghost`: A pointer to a constant `fd_ghost_t` structure representing the ghost data structure.
    - `hash`: A pointer to a constant `fd_hash_t` structure representing the hash key to query in the ghost hash map.
- **Logic and Control Flow**:
    - Check if `hash` is NULL; if so, return NULL.
    - Retrieve a constant pointer to the ghost hash map using [`fd_ghost_hash_map_const`](<#fd_ghost_hash_map_const>).
    - Retrieve a constant pointer to the ghost pool using [`fd_ghost_pool_const`](<#fd_ghost_pool_const>).
    - Call `fd_ghost_hash_map_ele_query_const` with the map, hash, NULL, and pool to query the element.
- **Output**: Returns a constant pointer to the `fd_ghost_ele_t` element if found, or NULL if not found or if `hash` is NULL.
- **Functions Called**:
    - [`fd_ghost_hash_map_const`](<#fd_ghost_hash_map_const>)
    - [`fd_ghost_pool_const`](<#fd_ghost_pool_const>)


---
### fd\_ghost\_hash<!-- {{#callable:fd_ghost_hash}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L354>)

Retrieves the hash ID of a tree element in the GHOST protocol structure, identified by a given slot number.
- **Inputs**:
    - `ghost`: A pointer to a constant `fd_ghost_t` structure, representing the GHOST protocol data structure.
    - `slot`: An unsigned long integer representing the slot number for which the hash ID is requested.
- **Logic and Control Flow**:
    - Retrieve the constant slot map from the `ghost` structure using [`fd_ghost_slot_map_const`](<#fd_ghost_slot_map_const>) function.
    - Retrieve the constant pool of elements from the `ghost` structure using [`fd_ghost_pool_const`](<#fd_ghost_pool_const>) function.
    - Query the slot map for the element corresponding to the given `slot` using `fd_ghost_slot_map_ele_query_const`.
    - If the element is found, return a pointer to its `key` (hash ID); otherwise, return `NULL`.
- **Output**: A pointer to a constant `fd_hash_t` representing the hash ID of the element associated with the given slot, or `NULL` if the slot is not found.
- **Functions Called**:
    - [`fd_ghost_slot_map_const`](<#fd_ghost_slot_map_const>)
    - [`fd_ghost_pool_const`](<#fd_ghost_pool_const>)


---
### is\_duplicate\_confirmed<!-- {{#callable:FD_FN_UNUSED::is_duplicate_confirmed}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L489>)

Checks if a slot in the ghost structure is confirmed as a duplicate based on its weight and gossip stake.
- **Inputs**:
    - ``ghost``: A pointer to the `fd_ghost_t` structure, which represents the ghost data structure.
    - ``hash``: A constant pointer to the `fd_hash_t` structure, representing the hash identifier of the slot to check.
    - ``total_stake``: An unsigned long integer representing the total stake in the system.
- **Logic and Control Flow**:
    - Query the ghost structure using the `hash` to find the corresponding element `ele`.
    - If `ele` is not found, log a warning message and return 0, indicating the slot is not confirmed as a duplicate.
    - Calculate the percentage `pct` as the sum of `ele->weight` and `ele->gossip_stake` divided by `total_stake`.
    - Return 1 if `pct` is greater than `FD_EQVOCSAFE_PCT`, otherwise return 0.
- **Output**: Returns an integer: 1 if the slot is confirmed as a duplicate, 0 otherwise.


# Function Declarations (Public API)

---
### fd\_ghost\_new<!-- {{#callable_declaration:fd_ghost_new}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L252>)

Formats a memory region for use as a ghost.
- **Description**: Use this function to prepare a memory region for use with the ghost protocol. The memory region must be aligned and have sufficient size to accommodate the specified number of elements. The function initializes the memory with zeroes and sets up internal structures for managing ghost elements. It must be called before any other operations on the ghost structure. If the memory is null, misaligned, or if the element count is invalid, the function returns null and logs a warning.
- **Inputs**:
    - `shmem`: A pointer to the memory region to format. Must not be null and must be aligned according to `fd_ghost_align()`. The caller retains ownership.
    - `ele_max`: The maximum number of elements the ghost can manage. Must be a positive number. If zero, the function returns null.
    - `seed`: An arbitrary seed value for internal hashing functions. No specific range or constraints.
- **Output**: Returns a pointer to the formatted memory region on success, or null on failure.
- **See Also**: [`fd_ghost_new`](<fd_ghost.c.md#fd_ghost_new>)  (Implementation)


---
### fd\_ghost\_join<!-- {{#callable_declaration:fd_ghost_join}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L261>)

Joins a caller to a ghost structure.
- **Description**: Use this function to join a caller to a ghost structure, which is a shared memory region. This function checks if the provided pointer is valid, aligned, and part of a workspace. It also verifies that the ghost structure has the correct magic number. If any of these checks fail, the function returns NULL and logs a warning. Ensure that the memory region is properly formatted and initialized before calling this function.
- **Inputs**:
    - `shghost`: A pointer to the shared memory region representing the ghost. Must not be NULL, must be aligned according to `fd_ghost_align()`, and must be part of a workspace. The caller retains ownership.
- **Output**: Returns a pointer to the ghost structure in the local address space on success, or NULL if the input is invalid or checks fail.
- **See Also**: [`fd_ghost_join`](<fd_ghost.c.md#fd_ghost_join>)  (Implementation)


---
### fd\_ghost\_leave<!-- {{#callable_declaration:fd_ghost_leave}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L268>)

Leaves a current local join of a ghost.
- **Description**: Use this function to leave a current local join of a ghost. It returns a pointer to the underlying shared memory region if successful. If the input is null, it logs a warning and returns null. This function is typically used when a process no longer needs to interact with a ghost and wants to release its local join.
- **Inputs**:
    - `ghost`: A pointer to a constant `fd_ghost_t` structure representing the ghost to leave. Must not be null. If null, the function logs a warning and returns null.
- **Output**: Returns a pointer to the underlying shared memory region on success, or null if the input is invalid.
- **See Also**: [`fd_ghost_leave`](<fd_ghost.c.md#fd_ghost_leave>)  (Implementation)


---
### fd\_ghost\_delete<!-- {{#callable_declaration:fd_ghost_delete}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L278>)

Unformats a memory region used as a ghost.
- **Description**: Use this function to unformat a memory region that was previously formatted for use as a ghost. This function assumes that no process is currently joined to the ghost. It returns a pointer to the underlying shared memory region, transferring ownership of the memory back to the caller. If the input is invalid, such as when the pointer is null or misaligned, the function logs a warning and returns null.
- **Inputs**:
    - `ghost`: A pointer to the memory region used as a ghost. It must not be null and must be properly aligned. If the pointer is null or misaligned, the function logs a warning and returns null.
- **Output**: Returns a pointer to the underlying shared memory region if successful, or null if the input is invalid.
- **See Also**: [`fd_ghost_delete`](<fd_ghost.c.md#fd_ghost_delete>)  (Implementation)


---
### fd\_ghost\_init<!-- {{#callable_declaration:fd_ghost_init}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L289>)

Initializes a ghost structure with a root element.
- **Description**: Use this function to initialize a ghost structure with a specified root element. This function must be called after the ghost memory has been formatted and before any other operations on the ghost. The function requires a valid local join to the ghost and assumes no other joins exist. It sets up the initial root element using the provided slot and hash, and logs warnings if the ghost is null, the root slot is null, or the ghost is already initialized.
- **Inputs**:
    - `ghost`: A pointer to a `fd_ghost_t` structure. Must not be null. The caller retains ownership.
    - `root`: An unsigned long representing the initial root slot. Must not be `FD_SLOT_NULL`.
    - `hash`: A pointer to a `fd_hash_t` structure representing the hash ID of the initial root. The caller retains ownership.
- **Output**: None
- **See Also**: [`fd_ghost_init`](<fd_ghost.c.md#fd_ghost_init>)  (Implementation)


---
### fd\_ghost\_head<!-- {{#callable_declaration:fd_ghost_head}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L369>)

Traverses the tree to find the heaviest valid path from the root.
- **Description**: Use this function to find the heaviest valid path in a tree structure, starting from a specified root element. This function is useful when you need to determine the most significant branch based on weight, which is a common requirement in fork choice rules like LMD-GHOST. Ensure that the `ghost` structure is properly initialized and that the `root` element is valid before calling this function. The function will return `NULL` if the root element is not valid, indicating that there are no valid paths to traverse.
- **Inputs**:
    - `ghost`: A pointer to a constant `fd_ghost_t` structure representing the tree. It must be a valid, initialized local join of the ghost structure.
    - `root`: A pointer to a constant `fd_ghost_ele_t` structure representing the root element from which to start the traversal. It must not be null and should be a valid element in the tree.
- **Output**: Returns a pointer to the `fd_ghost_ele_t` structure representing the heaviest valid path from the root, or `NULL` if no valid path exists.
- **See Also**: [`fd_ghost_head`](<fd_ghost.c.md#fd_ghost_head>)  (Implementation)


---
### fd\_ghost\_gca<!-- {{#callable_declaration:fd_ghost_gca}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L377>)

Finds the greatest common ancestor of two blocks in a ghost tree.
- **Description**: Use this function to find the greatest common ancestor of two blocks identified by their hash IDs within a ghost tree. This function assumes that at least one of the blocks is present in the ghost tree. If both blocks are present, the function guarantees a non-null return value. If handholding is enabled and either block is missing, the function logs a warning and returns null. This function is useful for determining the common lineage of two blocks in the context of fork choice rules.
- **Inputs**:
    - `ghost`: A pointer to a constant `fd_ghost_t` structure representing the ghost tree. Must not be null.
    - `bid1`: A pointer to a constant `fd_hash_t` representing the hash ID of the first block. Must not be null.
    - `bid2`: A pointer to a constant `fd_hash_t` representing the hash ID of the second block. Must not be null.
- **Output**: A pointer to a constant `fd_ghost_ele_t` representing the greatest common ancestor of the two blocks, or null if one or both blocks are missing and handholding is enabled.
- **See Also**: [`fd_ghost_gca`](<fd_ghost.c.md#fd_ghost_gca>)  (Implementation)


---
### fd\_ghost\_is\_ancestor<!-- {{#callable_declaration:fd_ghost_is_ancestor}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L384>)

Checks if one hash is an ancestor of another in the ghost structure.
- **Description**: Use this function to determine if a given hash is an ancestor of another hash within the ghost structure. This function is useful for validating the ancestry of blocks in a blockchain-like structure. It returns 1 if the specified ancestor is indeed an ancestor of the given hash, and 0 otherwise. It also returns 0 if either the ancestor or the hash is not present in the ghost structure. Ensure that the ghost structure is properly initialized and contains the relevant hashes before calling this function.
- **Inputs**:
    - `ghost`: A pointer to a constant `fd_ghost_t` structure. This must be a valid and initialized ghost structure. The caller retains ownership and must ensure it is not null.
    - `ancestor`: A pointer to a constant `fd_hash_t` representing the potential ancestor hash. This must not be null, and it should be present in the ghost structure for a meaningful result.
    - `slot`: A pointer to a constant `fd_hash_t` representing the hash to check against. This must not be null, and it should be present in the ghost structure for a meaningful result.
- **Output**: Returns 1 if `ancestor` is an ancestor of `slot`, otherwise returns 0. Also returns 0 if either `ancestor` or `slot` is not found in the ghost structure.
- **See Also**: [`fd_ghost_is_ancestor`](<fd_ghost.c.md#fd_ghost_is_ancestor>)  (Implementation)


---
### fd\_ghost\_invalid<!-- {{#callable_declaration:fd_ghost_invalid}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L389>)

Checks if an element or its ancestors are invalid for fork choice.
- **Description**: Use this function to determine if a given element or any of its ancestors in the tree are marked as invalid for fork choice. This function traverses from the specified element up to the root, checking the validity of each ancestor. It is useful for validating the integrity of a path in the tree. Ensure that the `ghost` and `ele` pointers are valid and that the element is part of the tree structure before calling this function.
- **Inputs**:
    - `ghost`: A pointer to a `fd_ghost_t` structure representing the tree. Must not be null and should be a valid local join.
    - `ele`: A pointer to a `fd_ghost_ele_t` structure representing the element to check. Must not be null and should be part of the tree represented by `ghost`.
- **Output**: Returns 1 if the element or any of its ancestors are invalid, otherwise returns 0.
- **See Also**: [`fd_ghost_invalid`](<fd_ghost.c.md#fd_ghost_invalid>)  (Implementation)


---
### fd\_ghost\_insert<!-- {{#callable_declaration:fd_ghost_insert}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L405>)

Inserts a new element into the ghost structure.
- **Description**: Use this function to add a new element to the ghost structure, associating it with a specific slot and parent hash. This function assumes that the slot is greater than the current root slot, the parent hash is already present in the ghost, and there is a free element in the pool. If these conditions are not met, the function will return NULL. This function is typically used when extending the ghost structure with new data, ensuring that the new element is correctly linked to its parent and integrated into the existing structure.
- **Inputs**:
    - `ghost`: A pointer to an `fd_ghost_t` structure. Must not be NULL and must be a valid local join of the ghost structure.
    - `parent_hash`: A pointer to a `fd_hash_t` representing the parent hash. Must not be NULL and must already exist in the ghost structure.
    - `slot`: An unsigned long representing the slot number. Must be greater than the current root slot in the ghost structure.
    - `hash_id`: A pointer to a `fd_hash_t` representing the hash ID of the new element. Must not be NULL and must not already exist in the ghost structure.
    - `total_stake`: An unsigned long representing the total stake. Used for internal calculations and validations.
- **Output**: Returns a pointer to the newly inserted `fd_ghost_ele_t` element if successful, or NULL if the insertion fails due to invalid input or constraints not being met.
- **See Also**: [`fd_ghost_insert`](<fd_ghost.c.md#fd_ghost_insert>)  (Implementation)


---
### fd\_ghost\_replay\_vote<!-- {{#callable_declaration:fd_ghost_replay_vote}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L421>)

Processes a voter's replay vote in the GHOST protocol.
- **Description**: Use this function to process a voter's replay vote within the GHOST protocol, which implements Solana's fork choice rule. This function updates the stake and weight of the relevant slots and their ancestors based on the voter's latest vote. It must be called with a valid `fd_ghost_t` structure that has been properly initialized and joined. The function assumes that the slot corresponding to the vote is present in the GHOST structure. It handles cases where the vote is unchanged, older than the root, or if the vote slot is less than the last processed vote slot for the voter.
- **Inputs**:
    - `ghost`: A pointer to an `fd_ghost_t` structure representing the GHOST protocol state. Must be a valid, initialized, and joined instance. Caller retains ownership.
    - `voter`: A pointer to an `fd_voter_t` structure representing the voter. Must not be null. Caller retains ownership.
    - `hash`: A pointer to a constant `fd_hash_t` representing the hash of the slot being voted on. Must not be null. Caller retains ownership.
- **Output**: None
- **See Also**: [`fd_ghost_replay_vote`](<fd_ghost.c.md#fd_ghost_replay_vote>)  (Implementation)


---
### fd\_ghost\_gossip\_vote<!-- {{#callable_declaration:fd_ghost_gossip_vote}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L435>)

Logs an error indicating the function is not implemented.
- **Description**: This function is a placeholder and does not perform any operations. It logs an error message indicating that it is not implemented. This function should not be used in its current state as it will not perform any meaningful action and will only result in an error log. It is likely intended for future development or as a stub for testing purposes.
- **Inputs**:
    - `ghost`: A pointer to an `fd_ghost_t` structure. This parameter is marked as unused and is not currently utilized by the function.
    - `voter`: A pointer to an `fd_voter_t` structure. This parameter is marked as unused and is not currently utilized by the function.
    - `slot`: An unsigned long integer representing a slot. This parameter is marked as unused and is not currently utilized by the function.
- **Output**: None
- **See Also**: [`fd_ghost_gossip_vote`](<fd_ghost.c.md#fd_ghost_gossip_vote>)  (Implementation)


---
### fd\_ghost\_rooted\_vote<!-- {{#callable_declaration:fd_ghost_rooted_vote}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L447>)

Adds stake to the rooted stake of a specified slot.
- **Description**: Use this function to add a voter's stake to the rooted stake of a specified slot in the ghost structure. This function assumes that the specified slot is present in the ghost structure. If the slot is not present, and handholding is enabled, the function will log a critical error. This function is typically used in scenarios where a slot has been confirmed as rooted, and the stake needs to be updated accordingly.
- **Inputs**:
    - `ghost`: A pointer to an `fd_ghost_t` structure. This must be a valid, non-null pointer to a ghost structure that has been properly initialized and joined.
    - `voter`: A pointer to an `fd_voter_t` structure representing the voter whose stake is to be added. This must be a valid, non-null pointer.
    - `root`: An unsigned long integer representing the slot to which the rooted stake is to be added. This slot must be present in the ghost structure.
- **Output**: None
- **See Also**: [`fd_ghost_rooted_vote`](<fd_ghost.c.md#fd_ghost_rooted_vote>)  (Implementation)


---
### fd\_ghost\_publish<!-- {{#callable_declaration:fd_ghost_publish}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L455>)

Publishes a specified slot as the new root of the ghost tree.
- **Description**: Use this function to set a specified slot and its descendants as the new root of the ghost tree, effectively pruning all elements not in the slot's ancestry. This function assumes that the slot corresponding to the given hash is present in the ghost structure. It is important to ensure that the ghost structure is properly initialized and that the hash provided is valid and corresponds to a slot that can be published as the new root.
- **Inputs**:
    - `ghost`: A pointer to an `fd_ghost_t` structure representing the ghost tree. Must not be null and should be a valid local join.
    - `hash_id`: A pointer to an `fd_hash_t` representing the hash of the slot to be published as the new root. Must not be null and should correspond to a valid slot in the ghost structure.
- **Output**: Returns a pointer to the `fd_ghost_ele_t` representing the new root of the ghost tree, or NULL if the operation fails due to invalid input or constraints.
- **See Also**: [`fd_ghost_publish`](<fd_ghost.c.md#fd_ghost_publish>)  (Implementation)


---
### fd\_ghost\_verify<!-- {{#callable_declaration:fd_ghost_verify}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L465>)

Verifies the integrity of a ghost structure.
- **Description**: Use this function to check if a ghost structure is valid and maintains its invariants. It verifies that the structure is not corrupt and that the weight of each element is greater than or equal to the sum of the weights of its children. This function should be called when you need to ensure the integrity of the ghost structure, especially after modifications. It returns an error code if the structure is invalid.
- **Inputs**:
    - `ghost`: A pointer to a constant `fd_ghost_t` structure. Must not be null and must be aligned according to `fd_ghost_align()`. The ghost must be part of a workspace and initialized with a valid magic number.
- **Output**: Returns 0 if the ghost structure is valid, or -1 if it is invalid.
- **See Also**: [`fd_ghost_verify`](<fd_ghost.c.md#fd_ghost_verify>)  (Implementation)


---
### fd\_ghost\_print<!-- {{#callable_declaration:fd_ghost_print}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L486>)

Prints a formatted representation of a ghost tree.
- **Description**: Use this function to print a formatted view of a ghost tree starting from a specified element. This is useful for debugging or visualizing the structure of the ghost tree. Ensure that the `ghost` and `ele` parameters are valid and that `ghost` is a current local join. The function outputs the tree structure to the standard output, beginning from the specified element, which appears as the root in the print output.
- **Inputs**:
    - `ghost`: A pointer to a `fd_ghost_t` structure representing the ghost tree. Must not be null and must be a valid local join.
    - `total_stake`: An unsigned long integer representing the total stake in the ghost tree. This value is used for informational purposes in the printout.
    - `ele`: A pointer to a `fd_ghost_ele_t` structure representing the starting element for the printout. Must not be null and should be a valid element within the ghost tree.
- **Output**: None
- **See Also**: [`fd_ghost_print`](<fd_ghost.c.md#fd_ghost_print>)  (Implementation)


---
### process\_duplicate\_confirmed<!-- {{#callable_declaration:process_duplicate_confirmed}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L502>)

Marks a duplicate confirmed slot as valid in the ghost structure.
- **Description**: Use this function to mark a slot as valid when it has been confirmed as a duplicate in the ghost structure. This function should be called when a duplicate confirmation signal is received for a slot. It checks if the slot and its duplicate are present in the ghost structure. If the slot is not found, it logs a warning and returns. If the duplicate is not found, it logs an error. The function then marks the slot and its ancestors as valid for fork choice. Ensure that the ghost structure is properly initialized and contains the relevant slots before calling this function.
- **Inputs**:
    - `ghost`: A pointer to an `fd_ghost_t` structure representing the ghost. Must not be null. The caller retains ownership.
    - `hash`: A constant pointer to an `fd_hash_t` representing the hash of the slot to confirm. Must not be null. The caller retains ownership.
    - `slot`: An unsigned long integer representing the slot number to confirm. Must be a valid slot in the ghost structure.
- **Output**: None
- **See Also**: [`process_duplicate_confirmed`](<fd_ghost.c.md#process_duplicate_confirmed>)  (Implementation)


---
### process\_duplicate<!-- {{#callable_declaration:process_duplicate}} -->
[View Source →](<../../../../../src/choreo/ghost/fd_ghost.h#L505>)

Processes a duplicate slot in the GHOST protocol.
- **Description**: Use this function to handle a slot that has been identified as a duplicate in the GHOST protocol. It checks if the slot has already been replayed and, if so, marks it as invalid. This function should be called when a duplicate slot is detected to ensure the integrity of the fork choice rule. It assumes that the `ghost` structure is properly initialized and that the `slot` is a valid slot number within the protocol's context.
- **Inputs**:
    - `ghost`: A pointer to an `fd_ghost_t` structure representing the GHOST protocol state. Must not be null and should be properly initialized before calling this function.
    - `slot`: An unsigned long integer representing the slot number to process. It should be a valid slot number within the protocol's context.
    - `total_stake`: An unsigned long integer representing the total stake in the system. It is used to determine the validity of the slot in the context of the protocol.
- **Output**: None
- **See Also**: [`process_duplicate`](<fd_ghost.c.md#process_duplicate>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)