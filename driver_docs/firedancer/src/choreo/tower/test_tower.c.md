<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for the `fd_tower` module, including vote management, serialization, and deserialization.

# Purpose
The code is a C test suite designed to validate the functionality of a voting system implemented using a data structure referred to as a "tower." The file includes several test functions that perform operations on the `fd_tower_t` structure, such as adding votes, simulating vote expiration, and verifying the integrity of vote data. The [`test_vote`](<#test_vote>) function tests the addition of votes to the tower and checks for correct vote expiration and repositioning. The [`test_tower_from_vote_acc_data_v1_14_11`](<#test_tower_from_vote_acc_data_v1_14_11>) and [`test_tower_from_vote_acc_data_current`](<#test_tower_from_vote_acc_data_current>) functions validate the tower's ability to correctly initialize from predefined vote data sets. The [`test_serde`](<#test_serde>) function tests the serialization and deserialization of the tower's state, ensuring data integrity through comparisons of serialized data.

The code includes a [`main`](<#main>) function that initializes the test environment and calls the [`test_serde`](<#test_serde>) function. Other test functions are commented out, indicating they are not executed in the current configuration. The file imports two header files, `fd_tower.h` and `test_tower.h`, which likely define the `fd_tower_t` structure and related functions. The test suite uses a static array `scratch` for memory alignment and storage, and it employs the `FD_TEST` macro to assert conditions during testing. The code is structured to be part of a larger testing framework, focusing on ensuring the correctness of the voting tower's operations.
# Imports and Dependencies

---
- `fd_tower.h`
- `test_tower.h`


# Global Variables

---
### scratch
- **Type**: ``uchar[]``
- **Description**: An array of unsigned characters with a size defined by the macro `FD_TOWER_FOOTPRINT`. The array is aligned according to the macro `FD_TOWER_ALIGN`.
- **Use**: Used as a memory buffer for operations involving the `fd_tower_t` data structure.


# Functions

---
### test\_vote<!-- {{#callable:test_vote}} -->
[View Source →](<../../../../../src/choreo/tower/test_tower.c#L4>)

Tests the voting mechanism of a tower data structure by simulating vote additions, expirations, and root changes.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize a `fd_tower_t` object using [`fd_tower_new`](<fd_tower.c.md#fd_tower_new>) and [`fd_tower_join`](<fd_tower.c.md#fd_tower_join>) with a static scratch buffer.
    - Add 31 votes to the tower, each with a slot number and a decreasing confirmation number, and verify the count of votes after each addition.
    - Verify that each vote in the tower matches the expected slot and confirmation values.
    - Simulate a new vote with an expiration of 33, which should cause the vote for slot 30 to expire, reducing the vote count to 30.
    - Add the new vote with expiration 33 and verify that slots 1 through 30 remain unchanged, and the new vote is correctly added at the end.
    - Simulate a new vote with a root of 34, which should reposition existing votes one index lower and increase their confirmation by one.
    - Verify that the new vote with root 34 is correctly added to the tower.
    - Clean up by deleting the tower using [`fd_tower_delete`](<fd_tower.c.md#fd_tower_delete>) and [`fd_tower_leave`](<fd_tower.c.md#fd_tower_leave>).
- **Output**: No output is returned; the function performs internal tests and assertions.
- **Functions Called**:
    - [`fd_tower_join`](<fd_tower.c.md#fd_tower_join>)
    - [`fd_tower_new`](<fd_tower.c.md#fd_tower_new>)
    - [`fd_tower_vote`](<fd_tower.h.md#fd_tower_vote>)
    - [`fd_tower_simulate_vote`](<fd_tower.c.md#fd_tower_simulate_vote>)
    - [`fd_tower_delete`](<fd_tower.c.md#fd_tower_delete>)
    - [`fd_tower_leave`](<fd_tower.c.md#fd_tower_leave>)


---
### test\_tower\_from\_vote\_acc\_data\_v1\_14\_11<!-- {{#callable:test_tower_from_vote_acc_data_v1_14_11}} -->
[View Source →](<../../../../../src/choreo/tower/test_tower.c#L86>)

Validates the conversion of vote account data to a tower structure and checks the integrity of the votes.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize a `fd_tower_t` structure by joining a new tower created with `scratch`.
    - Verify the successful creation of the tower using `FD_TEST`.
    - Call [`fd_tower_from_vote_acc_data`](<fd_tower.c.md#fd_tower_from_vote_acc_data>) with `v1_14_11` and the tower to populate it with votes.
    - Define an array `expected_votes` with 31 predefined vote entries, each having a `slot` and `conf` value.
    - Check that the number of votes in the tower is 31 using `fd_tower_votes_cnt`.
    - Iterate over the votes in the tower using `fd_tower_votes_iter_t` and compare each vote's `slot` and `conf` with the corresponding values in `expected_votes` using `FD_TEST`.
- **Output**: No output is returned as the function is a void type and primarily performs validation through assertions.
- **Functions Called**:
    - [`fd_tower_join`](<fd_tower.c.md#fd_tower_join>)
    - [`fd_tower_new`](<fd_tower.c.md#fd_tower_new>)
    - [`fd_tower_from_vote_acc_data`](<fd_tower.c.md#fd_tower_from_vote_acc_data>)


---
### test\_tower\_from\_vote\_acc\_data\_current<!-- {{#callable:test_tower_from_vote_acc_data_current}} -->
[View Source →](<../../../../../src/choreo/tower/test_tower.c#L139>)

Validates the conversion of current vote account data into a tower structure and checks the integrity of the votes.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize a `fd_tower_t` structure by joining a new tower created with `scratch`.
    - Verify the successful creation of the tower using `FD_TEST`.
    - Populate the tower with vote account data using [`fd_tower_from_vote_acc_data`](<fd_tower.c.md#fd_tower_from_vote_acc_data>) with `current` as the source.
    - Define an array `expected_votes` with 31 predefined vote entries, each having a `slot` and `conf` value.
    - Check that the number of votes in the tower is 31 using `fd_tower_votes_cnt`.
    - Iterate over the votes in the tower using `fd_tower_votes_iter_t` and compare each vote with the corresponding entry in `expected_votes`.
    - For each vote, verify that both `slot` and `conf` match the expected values using `FD_TEST`.
- **Output**: No output is returned; the function performs validation checks using assertions.
- **Functions Called**:
    - [`fd_tower_join`](<fd_tower.c.md#fd_tower_join>)
    - [`fd_tower_new`](<fd_tower.c.md#fd_tower_new>)
    - [`fd_tower_from_vote_acc_data`](<fd_tower.c.md#fd_tower_from_vote_acc_data>)


---
### test\_tower\_checkpt<!-- {{#callable:test_tower_checkpt}} -->
[View Source →](<../../../../../src/choreo/tower/test_tower.c#L192>)

Initializes a tower object and performs a test to ensure it is correctly joined.
- **Inputs**: None
- **Logic and Control Flow**:
    - Call [`fd_tower_new`](<fd_tower.c.md#fd_tower_new>) with `scratch` to create a new tower object.
    - Join the newly created tower using [`fd_tower_join`](<fd_tower.c.md#fd_tower_join>).
    - Verify the tower is successfully joined using `FD_TEST`.
- **Output**: No output is returned as the function is of type `void`.
- **Functions Called**:
    - [`fd_tower_join`](<fd_tower.c.md#fd_tower_join>)
    - [`fd_tower_new`](<fd_tower.c.md#fd_tower_new>)


---
### test\_serde<!-- {{#callable:test_serde}} -->
[View Source →](<../../../../../src/choreo/tower/test_tower.c#L202>)

Tests the serialization and deserialization of a tower structure and verifies the integrity of the serialized data.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize a `fd_tower_t` object by joining a new tower created with `scratch`.
    - Check if the tower is successfully created using `FD_TEST`.
    - Declare a `fd_tower_file_serde_t` structure and initialize it to zero.
    - Deserialize data from `restore` into the `serde` structure using [`fd_tower_deserialize`](<fd_tower.c.md#fd_tower_deserialize>).
    - Serialize the `serde` structure into `checkpt` and store the size in `checkpt_sz` using [`fd_tower_serialize`](<fd_tower.c.md#fd_tower_serialize>).
    - Verify that the size of `restore` matches `checkpt_sz` using `FD_TEST`.
    - Compare the first 4 bytes of `restore` and `checkpt` using `fd_uint_load_4` and `FD_TEST`.
    - Calculate an offset using the size of `uint`, `FD_ED25519_SIG_SZ`, and `ulong`.
    - Verify that the first 4 bytes of `restore` and `checkpt` match using `fd_uint_load_4_fast` and `FD_TEST`.
    - Compare the remaining bytes of `restore` and `checkpt` from the calculated offset using `memcmp` and `FD_TEST`.
- **Output**: No output is returned; the function performs tests and assertions.
- **Functions Called**:
    - [`fd_tower_join`](<fd_tower.c.md#fd_tower_join>)
    - [`fd_tower_new`](<fd_tower.c.md#fd_tower_new>)
    - [`fd_tower_deserialize`](<fd_tower.c.md#fd_tower_deserialize>)
    - [`fd_tower_serialize`](<fd_tower.c.md#fd_tower_serialize>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/choreo/tower/test_tower.c#L225>)

Initializes the environment, runs a serialization/deserialization test, and then halts the program.
- **Inputs**:
    - `argc`: The count of command-line arguments.
    - `argv`: An array of strings representing the command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Executes the [`test_serde`](<#test_serde>) function to perform serialization/deserialization tests.
    - Calls `fd_halt` to terminate the program.
    - Returns 0 to indicate successful execution.
- **Output**: Returns an integer value 0, indicating successful execution.
- **Functions Called**:
    - [`test_serde`](<#test_serde>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)