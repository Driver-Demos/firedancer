<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for managing and verifying voting towers, including serialization, deserialization, and vote simulation.

# Purpose
The code is a C module that manages a voting mechanism, likely for a blockchain or distributed ledger system. It provides functions to create, join, leave, and delete a voting structure referred to as a "tower." The module includes functions to simulate votes, check lockout and switch conditions, and verify voting thresholds. It also handles serialization and deserialization of voting data, allowing for persistence and restoration of voting states. The code defines several constants and uses them to determine voting behavior, such as `THRESHOLD_DEPTH` and `THRESHOLD_RATIO`, which are used to check if a vote meets the required conditions to be considered valid.

The module interfaces with other components through function calls and data structures, such as `fd_tower_vote_t`, `fd_ghost_t`, and `fd_epoch_t`. It includes functions for serializing and deserializing voting data to and from a buffer, which is useful for saving the state to a file or sending it over a network. The module also provides functions to verify the integrity of the voting data and print the current state of the voting tower. The code is structured to handle different versions of voting data, ensuring compatibility with various system states.
# Imports and Dependencies

---
- `unistd.h`
- `fcntl.h`
- `sys/stat.h`
- `fd_tower.h`
- `../../ballet/ed25519/fd_ed25519.h`
- `../../flamenco/txn/fd_txn_generate.h`
- `../../flamenco/runtime/fd_system_ids.h`
- `stdio.h`


# Global Variables

---
### option\_some
- **Type**: ``uchar``
- **Description**: A static constant unsigned character variable with a value of 1.
- **Use**: Used to extend the lifetime of a `uchar` outside the `fd_tower_sync_serde` context.


# Functions

---
### fd\_tower\_new<!-- {{#callable:fd_tower_new}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.c#L18>)

Initializes a new tower structure in shared memory if the memory is valid and aligned.
- **Inputs**:
    - `shmem`: A pointer to the shared memory where the tower structure will be initialized.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL; if so, log a warning and return NULL.
    - Check if `shmem` is aligned according to [`fd_tower_align`](<fd_tower.h.md#fd_tower_align>); if not, log a warning and return NULL.
    - Call `fd_tower_votes_new` with `shmem` and return its result.
- **Output**: A pointer to the newly initialized tower structure, or NULL if the input memory is invalid or misaligned.
- **Functions Called**:
    - [`fd_tower_align`](<fd_tower.h.md#fd_tower_align>)


---
### fd\_tower\_join<!-- {{#callable:fd_tower_join}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.c#L33>)

Validates and joins a shared memory tower object if it is non-null and properly aligned.
- **Inputs**:
    - `shtower`: A pointer to the shared memory tower object to join.
- **Logic and Control Flow**:
    - Check if `shtower` is NULL; if so, log a warning and return NULL.
    - Check if `shtower` is aligned according to `fd_tower_align()`; if not, log a warning and return NULL.
    - Call `fd_tower_votes_join(shtower)` to join the tower and return the result.
- **Output**: Returns a pointer to the joined `fd_tower_t` object, or NULL if the input is invalid.
- **Functions Called**:
    - [`fd_tower_align`](<fd_tower.h.md#fd_tower_align>)


---
### fd\_tower\_leave<!-- {{#callable:fd_tower_leave}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.c#L49>)

Checks if the `tower` pointer is not NULL and then calls `fd_tower_votes_leave` to leave the tower.
- **Inputs**:
    - `tower`: A pointer to an `fd_tower_t` structure that represents the tower to leave.
- **Logic and Control Flow**:
    - Check if `tower` is NULL using `FD_UNLIKELY`; if true, log a warning and return NULL.
    - If `tower` is not NULL, call `fd_tower_votes_leave` with `tower` as the argument and return its result.
- **Output**: Returns the result of `fd_tower_votes_leave` if `tower` is not NULL; otherwise, returns NULL.


---
### fd\_tower\_delete<!-- {{#callable:fd_tower_delete}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.c#L60>)

Deletes a tower object after checking for nullity and alignment.
- **Inputs**:
    - `tower`: A pointer to the tower object to delete.
- **Logic and Control Flow**:
    - Check if `tower` is NULL; if true, log a warning and return NULL.
    - Check if `tower` is not aligned according to `fd_tower_align()`; if true, log a warning and return NULL.
    - Call `fd_tower_votes_delete` with `tower` and return its result.
- **Output**: Returns a pointer to the result of `fd_tower_votes_delete` or NULL if the input is invalid.
- **Functions Called**:
    - [`fd_tower_align`](<fd_tower.h.md#fd_tower_align>)


---
### expiration<!-- {{#callable:expiration}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.c#L76>)

Calculates the expiration time of a vote by adding a lockout period to the vote's slot.
- **Inputs**:
    - `vote`: A pointer to a constant `fd_tower_vote_t` structure representing the vote for which the expiration is calculated.
- **Logic and Control Flow**:
    - Calculate `lockout` by left-shifting 1 by the value of `vote->conf`.
    - Return the sum of `vote->slot` and `lockout`.
- **Output**: Returns an unsigned long integer representing the expiration time of the vote.


---
### simulate\_vote<!-- {{#callable:simulate_vote}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.c#L82>)

Simulates the removal of expired votes from a tower by decrementing the vote count until the top vote is not expired relative to a given slot.
- **Inputs**:
    - `tower`: A pointer to a constant `fd_tower_t` structure representing the tower of votes.
    - `slot`: An unsigned long integer representing the current slot against which votes are checked for expiration.
- **Logic and Control Flow**:
    - Initialize `cnt` with the number of votes in the tower using `fd_tower_votes_cnt` function.
    - Enter a loop that continues as long as `cnt` is greater than zero.
    - In each iteration, check if the expiration of the top vote (obtained using `fd_tower_votes_peek_index_const`) is greater than or equal to the given `slot`.
    - If the expiration condition is met, break out of the loop.
    - If not, decrement `cnt` to simulate removing the expired vote.
    - Return the final value of `cnt`, representing the number of non-expired votes.
- **Output**: Returns an unsigned long integer representing the count of non-expired votes remaining in the tower.
- **Functions Called**:
    - [`expiration`](<#expiration>)


---
### fd\_tower\_lockout\_check<!-- {{#callable:fd_tower_lockout_check}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.c#L98>)

Checks if a new vote can be placed on the same fork as the last vote in the tower, considering lockout and ancestry constraints.
- **Inputs**:
    - `tower`: A pointer to a `fd_tower_t` structure representing the current state of votes.
    - `ghost`: A pointer to a `fd_ghost_t` structure used to check ancestry information.
    - `slot`: An unsigned long integer representing the slot number for the new vote.
    - `block_id`: A pointer to a `fd_hash_t` structure representing the block ID for the new vote.
- **Logic and Control Flow**:
    - If `FD_TOWER_PARANOID` is defined, check that the tower is not empty using `FD_TEST` and `fd_tower_votes_empty` function.
    - Call [`simulate_vote`](<#simulate_vote>) to remove expired votes from the tower and get the count of remaining votes.
    - Retrieve the last vote in the tower using `fd_tower_votes_peek_index_const` with the index `cnt - 1`.
    - Get the root of the ghost using `fd_ghost_root_const`.
    - Determine if the new vote can be placed by checking if the slot is greater than the last vote's slot and if the last vote's slot is either older than the ghost root or is an ancestor of the new vote's slot using `fd_ghost_is_ancestor`.
    - Log the result if `LOGGING` is defined using `FD_LOG_NOTICE`.
    - Return the result of the lockout check as an integer.
- **Output**: Returns an integer indicating whether the lockout check passed (1) or failed (0).
- **Functions Called**:
    - [`simulate_vote`](<#simulate_vote>)


---
### fd\_tower\_switch\_check<!-- {{#callable:fd_tower_switch_check}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.c#L132>)

Determines if a switch in voting forks is permissible based on the current vote, ghost root, and stake percentage.
- **Inputs**:
    - `tower`: A pointer to a `fd_tower_t` structure representing the current voting tower.
    - `epoch`: A pointer to a `fd_epoch_t` structure containing epoch-related data, including total stake.
    - `ghost`: A pointer to a `fd_ghost_t` structure representing the ghost state, which includes ancestry information.
    - `slot`: An unsigned long integer representing the slot number for which the switch check is being performed.
    - `block_id`: A pointer to a `fd_hash_t` structure representing the block identifier for the slot.
- **Logic and Control Flow**:
    - If `FD_TOWER_PARANOID` is defined, check that the tower is not empty using `FD_TEST`.
    - Retrieve the latest vote from the tower and the root from the ghost.
    - If the latest vote's slot is less than the ghost root's slot, return 1, indicating a permissible switch.
    - Ensure that the latest vote and the fork slot are on different forks, verified by `fd_ghost_is_ancestor`.
    - Retrieve the block ID for the latest vote's slot and the ghost's hash map, pool, and GCA (greatest common ancestor).
    - Find the child of the GCA that is an ancestor of the latest vote's slot and exclude it from the stake calculation.
    - Calculate the total stake of the children of the GCA, excluding the identified child, to determine the switch stake.
    - Calculate the switch percentage by dividing the switch stake by the total stake from the epoch.
    - Log the switch percentage and return whether it exceeds the defined `SWITCH_PCT`.
- **Output**: Returns an integer indicating whether the switch is permissible (1 if permissible, 0 otherwise).


---
### fd\_tower\_threshold\_check<!-- {{#callable:fd_tower_threshold_check}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.c#L211>)

Checks if a voting tower meets a threshold depth and stake percentage for a given slot.
- **Inputs**:
    - ``tower``: A pointer to the `fd_tower_t` structure representing the current voting tower.
    - ``epoch``: A pointer to the `fd_epoch_t` structure representing the current epoch data.
    - ``vote_keys``: An array of `fd_pubkey_t` structures representing the public keys of the voters.
    - ``vote_towers``: An array of pointers to `fd_tower_t` structures representing the voting towers of other voters.
    - ``vote_cnt``: The number of voting towers in the `vote_towers` array.
    - ``slot``: The current slot number for which the threshold check is performed.
- **Logic and Control Flow**:
    - Simulate a vote on the current tower to determine how many votes would remain after expiring votes for the current slot.
    - Check if the remaining votes are fewer than `THRESHOLD_DEPTH`; if so, return 1 to indicate failure.
    - Determine the `threshold_slot` by looking `THRESHOLD_DEPTH` back in the vote history of the current tower.
    - Initialize `threshold_stake` to zero to track the total stake of votes that meet the threshold condition.
    - Iterate over each voting tower in `vote_towers` to simulate a vote and check if the latest vote slot is greater than or equal to `threshold_slot`.
    - If a voter's latest vote meets the threshold condition, query the voter's stake from the epoch data and add it to `threshold_stake`.
    - Calculate `threshold_pct` as the ratio of `threshold_stake` to the total stake in the epoch.
    - Return whether `threshold_pct` exceeds `THRESHOLD_RATIO`.
- **Output**: Returns an integer indicating whether the voting tower meets the threshold conditions (0 for success, 1 for failure).
- **Functions Called**:
    - [`simulate_vote`](<#simulate_vote>)


---
### fd\_tower\_reset\_slot<!-- {{#callable:fd_tower_reset_slot}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.c#L295>)

Determines the appropriate slot to reset to based on the current voting state and ghost structure.
- **Inputs**:
    - `tower`: A pointer to a constant `fd_tower_t` structure representing the current voting tower.
    - `epoch`: A pointer to a constant `fd_epoch_t` structure representing the current epoch information.
    - `ghost`: A pointer to a constant `fd_ghost_t` structure representing the ghost structure used for ancestry and fork information.
- **Logic and Control Flow**:
    - Retrieve the last vote from the tower and query its corresponding ghost element.
    - Retrieve the root and head elements from the ghost structure.
    - Check for missing vote, root, or head elements and log critical errors if any are missing (only in paranoid mode).
    - If no vote exists, the last vote slot is less than the ghost root slot, or the ghost root is not an ancestor of the last vote, return the head slot.
    - If the last vote slot is an ancestor of the heaviest leaf, return the head slot.
    - If the last vote is on a different fork but a valid switch proof exists, return the head slot.
    - If the last vote is on an invalid fork, return the head slot.
    - Otherwise, return the slot of the heaviest leaf starting from the subtree rooted at the last vote slot.
- **Output**: Returns an `ulong` representing the slot to reset to.
- **Functions Called**:
    - [`fd_tower_switch_check`](<#fd_tower_switch_check>)


---
### fd\_tower\_vote\_slot<!-- {{#callable:fd_tower_vote_slot}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.c#L356>)

Determines the appropriate slot to vote for based on the current state of the tower and ghost structures, considering various conditions and thresholds.
- **Inputs**:
    - ``tower``: A pointer to a constant `fd_tower_t` structure representing the current voting tower.
    - ``epoch``: A pointer to an `fd_epoch_t` structure representing the current epoch data.
    - ``vote_keys``: A pointer to an array of `fd_pubkey_t` structures representing the public keys of the voters.
    - ``vote_towers``: A pointer to an array of pointers to `fd_tower_t` structures representing the voting towers of other voters.
    - ``vote_cnt``: An unsigned long integer representing the count of votes or voters.
    - ``ghost``: A pointer to a constant `fd_ghost_t` structure representing the ghost structure used for determining ancestry and fork information.
- **Logic and Control Flow**:
    - Retrieve the last vote from the tower and the root and head elements from the ghost structure.
    - Check if a vote should be made for the ghost head based on conditions such as not having voted, the last vote being less than the ghost root, or the ghost root not being an ancestor of the last vote.
    - If the ghost head is on the same fork as the last vote slot, check if the threshold conditions are met to vote for it.
    - If the ghost head is on a different fork, check if lockout and switch thresholds are met to switch and vote for it.
    - Log debug information about the success or failure of voting based on threshold and lockout switch checks.
    - Return the slot of the ghost head if voting conditions are met, otherwise return `FD_SLOT_NULL`.
- **Output**: Returns an unsigned long integer representing the slot to vote for, or `FD_SLOT_NULL` if no valid vote can be made.
- **Functions Called**:
    - [`fd_tower_threshold_check`](<#fd_tower_threshold_check>)
    - [`fd_tower_lockout_check`](<#fd_tower_lockout_check>)
    - [`fd_tower_switch_check`](<#fd_tower_switch_check>)


---
### fd\_tower\_vote<!-- {{#callable:fd_tower_vote}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.c#L412>)

Processes a vote for a given slot in the tower, managing expired votes and updating confirmations.
- **Inputs**:
    - `tower`: A pointer to the `fd_tower_t` structure representing the voting tower.
    - `slot`: An unsigned long integer representing the slot number for which the vote is being cast.
- **Logic and Control Flow**:
    - Log the voting action for the given slot.
    - If `FD_TOWER_PARANOID` is defined, check if the slot is less than the last vote's slot and log an error if true.
    - Use [`simulate_vote`](<#simulate_vote>) to determine how many expired votes to remove from the tower.
    - Remove expired votes from the tower until the count matches the result from [`simulate_vote`](<#simulate_vote>).
    - If the tower is full after removing expired votes, pop the head vote and set its slot as the new root.
    - Iterate through the votes in reverse order to increment confirmations for consecutive confirmations in prior votes.
    - Add the new vote with the given slot and a confirmation count of 1 to the tower.
    - Return the new root slot, or `FD_SLOT_NULL` if there is no new root.
- **Output**: Returns the new root slot as an unsigned long integer, or `FD_SLOT_NULL` if there is no new root.
- **Functions Called**:
    - [`simulate_vote`](<#simulate_vote>)


---
### fd\_tower\_simulate\_vote<!-- {{#callable:fd_tower_simulate_vote}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.c#L462>)

Simulates a vote by determining how many votes in the tower are still valid for a given slot.
- **Inputs**:
    - `tower`: A pointer to a constant `fd_tower_t` structure representing the tower of votes.
    - `slot`: An unsigned long integer representing the slot for which the vote simulation is performed.
- **Logic and Control Flow**:
    - If `FD_TOWER_PARANOID` is defined, checks if the tower is not empty using `fd_tower_votes_empty` and triggers a test failure if it is.
    - Calls the [`simulate_vote`](<#simulate_vote>) function with the `tower` and `slot` as arguments.
    - Returns the result of the [`simulate_vote`](<#simulate_vote>) function.
- **Output**: Returns an unsigned long integer representing the count of valid votes in the tower for the given slot.
- **Functions Called**:
    - [`simulate_vote`](<#simulate_vote>)


---
### fd\_tower\_to\_tower\_sync<!-- {{#callable:fd_tower_to_tower_sync}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.c#L473>)

Serializes the state of a voting tower into a `fd_tower_sync_serde_t` structure for synchronization.
- **Inputs**:
    - ``tower``: A pointer to a constant `fd_tower_t` structure representing the voting tower to serialize.
    - ``root``: An unsigned long integer representing the root slot of the tower.
    - ``bank_hash``: A pointer to an `fd_hash_t` structure representing the bank hash.
    - ``block_id``: A pointer to an `fd_hash_t` structure representing the block ID.
    - ``ts``: A long integer representing the timestamp.
    - ``ser``: A pointer to an `fd_tower_sync_serde_t` structure where the serialized data will be stored.
- **Logic and Control Flow**:
    - Assigns the address of `root` to `ser->root` and sets `ser->lockouts_cnt` to the count of votes in the tower cast to a `ushort`.
    - Initializes a loop to iterate over each vote in the tower using `fd_tower_votes_iter_t`.
    - For each vote, calculates the offset from the previous slot and assigns it to `ser->lockouts[i].offset`.
    - Assigns the confirmation count of each vote to `ser->lockouts[i].confirmation_count` after type punning it to a `uchar const *`.
    - Updates `ser->hash` with `bank_hash`, `ser->timestamp_option` with a constant indicating a valid timestamp, `ser->timestamp` with the address of `ts`, and `ser->block_id` with `block_id`.
    - Returns the pointer `ser` containing the serialized data.
- **Output**: A pointer to the `fd_tower_sync_serde_t` structure containing the serialized tower data.


---
### fd\_tower\_checkpt<!-- {{#callable:fd_tower_checkpt}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.c#L494>)

Serializes and signs the current state of a voting tower and writes it to a file descriptor.
- **Inputs**:
    - ``tower``: A pointer to the `fd_tower_t` structure representing the voting tower to serialize.
    - ``root``: An unsigned long integer representing the root slot of the tower.
    - ``last_vote``: A pointer to the `fd_tower_sync_serde_t` structure containing the last vote information.
    - ``pubkey``: A constant array of 32 unsigned characters representing the public key used for signing.
    - ``sign_fn``: A pointer to the `fd_tower_sign_fn` function used to sign the serialized data.
    - ``fd``: An integer representing the file descriptor where the serialized data will be written.
    - ``buf``: A pointer to an unsigned character buffer where the serialized data will be stored temporarily.
    - ``buf_max``: An unsigned long integer representing the maximum size of the buffer.
- **Logic and Control Flow**:
    - Initialize a `fd_tower_file_serde_t` structure `ser` and set its fields with constants and pointers to local variables.
    - Initialize a `fd_voter_v2_serde_t` structure `voter_v2_ser` and set its fields with default values and data from the `tower`.
    - Iterate over the votes in the `tower` and populate the `votes` array in `voter_v2_ser`.
    - Set the `root_slot_option` and `root_slot` fields in `voter_v2_ser` based on the `root` value.
    - Set additional fields in `voter_v2_ser` with default values.
    - Copy the `last_vote` data into the `ser` structure and set the `last_vote_kind`.
    - Calculate the `last_timestamp_slot` and `last_timestamp_timestamp` and set them in `ser`.
    - Call [`fd_tower_serialize`](<#fd_tower_serialize>) to serialize the `ser` structure into the `buf` and check for errors.
    - Calculate offsets for the signature and message within the buffer.
    - Call the `sign_fn` to sign the message using the `pubkey` and store the signature in the buffer.
    - Set the `signature` and `data_sz` fields in `ser` with pointers to the buffer data.
    - Call `fd_io_write` to write the serialized and signed data to the file descriptor and check for errors.
    - Call `fsync` to ensure the data is written to the file system.
    - Return 0 to indicate success.
- **Output**: Returns 0 on success, or -1 if an error occurs during serialization, signing, or writing.
- **Functions Called**:
    - [`fd_tower_serialize`](<#fd_tower_serialize>)


---
### fd\_tower\_restore<!-- {{#callable:fd_tower_restore}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.c#L601>)

Restores a tower's state from a serialized file, verifying its integrity and updating the tower's votes, root, and timestamp.
- **Inputs**:
    - ``tower``: A pointer to the `fd_tower_t` structure where the restored votes will be stored.
    - ``root``: A pointer to an `ulong` where the root slot will be updated.
    - ``ts``: A pointer to a `long` where the timestamp will be updated.
    - ``pubkey``: A constant array of 32 `uchar` representing the public key used for signature verification.
    - ``fd``: An integer file descriptor from which the serialized data will be read.
    - ``buf``: A pointer to a buffer where the serialized data will be temporarily stored.
    - ``buf_max``: An `ulong` representing the maximum size of the buffer.
    - ``buf_sz``: A pointer to an `ulong` where the size of the data read will be stored.
- **Logic and Control Flow**:
    - Call `fd_io_sz` to get the size of the data in the file and store it in `buf_sz`.
    - Check if `buf_max` is less than `*buf_sz` and return an error if true.
    - Read the data from the file into `buf` using `fd_io_read` and verify the read size matches `*buf_sz`.
    - Deserialize the data in `buf` into a `fd_tower_file_serde_t` structure using [`fd_tower_deserialize`](<#fd_tower_deserialize>).
    - Verify the signature of the deserialized data using `fd_ed25519_verify` with the provided `pubkey`.
    - Check various conditions on the deserialized data, such as matching `node_pubkey`, `kind`, `threshold_depth`, `threshold_size`, and valid counts for votes and authorized voters.
    - Push each vote from the deserialized data into the `tower` using `fd_tower_votes_push_tail`.
    - Update `root` and `ts` with the deserialized root slot and timestamp.
- **Output**: Returns 0 on success, or -1 if any error occurs during the process.
- **Functions Called**:
    - [`fd_tower_deserialize`](<#fd_tower_deserialize>)


---
### ser\_short\_vec\_cnt<!-- {{#callable:ser_short_vec_cnt}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.c#L645>)

Encodes a `ushort` value into a variable-length format and writes it to a destination buffer, returning the number of bytes written.
- **Inputs**:
    - `dst`: A pointer to the destination buffer where the encoded data will be written.
    - `src`: The `ushort` value to encode and write to the destination buffer.
- **Logic and Control Flow**:
    - Check if `src` is less than `0x80UL`; if true, write `src` as a single byte to `dst` and return 1.
    - If `src` is less than `0x4000UL`, write the lower 7 bits of `src` with a continuation bit to `dst`, increment `dst`, write the remaining bits of `src` to `dst`, and return 2.
    - Otherwise, write the lower 7 bits of `src` with a continuation bit to `dst`, increment `dst`, write the next 7 bits of `src` with a continuation bit to `dst`, increment `dst`, write the remaining bits of `src` to `dst`, and return 3.
- **Output**: Returns the number of bytes written to the destination buffer.


---
### ser\_varint<!-- {{#callable:ser_varint}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.c#L652>)

Serializes an unsigned long integer into a variable-length integer format and stores it in a destination buffer.
- **Inputs**:
    - ``dst``: A pointer to an unsigned character buffer where the serialized variable-length integer will be stored.
    - ``src``: An unsigned long integer that will be serialized into a variable-length integer format.
- **Logic and Control Flow**:
    - Initialize `off` to 0 to track the offset in the destination buffer.
    - Enter a loop that continues indefinitely.
    - Check if `src` is less than 0x80UL; if true, store `src` as a single byte in `dst`, increment `off` by 1, and return `off`.
    - If `src` is not less than 0x80UL, store the lower 7 bits of `src` ORed with 0x80UL in `dst+off`, increment `off` by 1, and right-shift `src` by 7 bits.
    - Repeat the loop until `src` is less than 0x80UL.
- **Output**: Returns the number of bytes written to the destination buffer as an unsigned long integer.


---
### fd\_tower\_serialize<!-- {{#callable:fd_tower_serialize}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.c#L667>)

Serializes a `fd_tower_file_serde_t` structure into a buffer, ensuring data integrity and size constraints.
- **Inputs**:
    - `ser`: A pointer to a `fd_tower_file_serde_t` structure containing the data to serialize.
    - `buf`: A pointer to a buffer where the serialized data will be stored.
    - `buf_max`: The maximum size of the buffer.
    - `buf_sz`: A pointer to a variable where the size of the serialized data will be stored.
- **Logic and Control Flow**:
    - Check if `ser->threshold_depth` matches `THRESHOLD_DEPTH` and `ser->threshold_size` matches `THRESHOLD_RATIO`; log a warning and return -1 if not.
    - Check if `ser->vote_state.votes_cnt` and `ser->vote_state.authorized_voters_cnt` are within valid limits; log a warning and return -1 if not.
    - Check if `ser->last_vote.lockouts_cnt` is within valid limits; log a warning and return -1 if not.
    - Initialize `off` to 0 to track the current offset in the buffer.
    - Use the `SER` macro to serialize various fields from `ser` into `buf`, updating `off` accordingly.
    - Use the `OFF` macro to set pointers in `ser` to the corresponding locations in `buf`.
    - For each field, check if adding its size to `off` would exceed `buf_max`; log a warning and return -1 if so.
    - Update `*buf_sz` with the final value of `off`.
    - Return 0 to indicate successful serialization.
- **Output**: Returns 0 on success, or -1 if an error occurs during serialization.
- **Functions Called**:
    - [`ser_short_vec_cnt`](<#ser_short_vec_cnt>)
    - [`ser_varint`](<#ser_varint>)


---
### de\_short\_vec\_cnt<!-- {{#callable:de_short_vec_cnt}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.c#L775>)

Decodes a short vector count from a source byte array into a destination unsigned short integer.
- **Inputs**:
    - `dst`: A pointer to an unsigned short where the decoded value will be stored.
    - `src`: A pointer to an unsigned char array containing the encoded short vector count.
- **Logic and Control Flow**:
    - Check if the most significant bit of `src[0]` is not set; if true, assign `src[0]` to `*dst` and return 1.
    - If the most significant bit of `src[0]` is set, check if the most significant bit of `src[1]` is not set; if true, decode the value using `src[0]` and `src[1]`, assign it to `*dst`, and return 2.
    - If the most significant bits of both `src[0]` and `src[1]` are set, decode the value using `src[0]`, `src[1]`, and `src[2]`, assign it to `*dst`, and return 3.
- **Output**: Returns the number of bytes read from `src` to decode the short vector count.


---
### de\_varint<!-- {{#callable:de_varint}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.c#L782>)

Decodes a variable-length integer from a byte array and stores it in a destination variable.
- **Inputs**:
    - ``dst``: A pointer to an `ulong` where the decoded integer will be stored.
    - ``src``: A pointer to a `uchar` array containing the encoded variable-length integer.
- **Logic and Control Flow**:
    - Initialize `*dst` to 0, `off` to 0, and `bit` to 0.
    - Enter a loop that continues while `bit` is less than 64.
    - Read a byte from `src` at the current offset `off` and increment `off` by 1.
    - Update `*dst` by OR-ing it with the lower 7 bits of the byte shifted left by `bit`.
    - Check if the most significant bit of the byte is 0; if so, perform two critical checks:
    - Ensure that the shifted `*dst` value matches the byte; if not, log a critical error.
    - Ensure that if the byte is 0, then `bit` is 0 and `*dst` is 0; if not, log a critical error.
    - If the most significant bit of the byte is 0, return `off`.
    - Increment `bit` by 7 and continue the loop.
    - If the loop exits without returning, log a critical error.
- **Output**: Returns the number of bytes read from `src` to decode the integer.


---
### fd\_tower\_deserialize<!-- {{#callable:fd_tower_deserialize}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.c#L801>)

Deserializes a buffer into a `fd_tower_file_serde_t` structure, extracting various fields and handling potential buffer overflows.
- **Inputs**:
    - ``buf``: A pointer to the buffer containing serialized data.
    - ``buf_sz``: The size of the buffer in bytes.
    - ``de``: A pointer to a `fd_tower_file_serde_t` structure where the deserialized data will be stored.
- **Logic and Control Flow**:
    - Initialize an offset variable `off` to 0.
    - Define a macro `DE` to handle deserialization of each field, checking for buffer overflow and updating the offset.
    - Deserialize fields related to `SavedTower::Current`, `VoteState1_14_11`, `VoteTransaction::TowerSync`, and `BlockTimestamp` using the `DE` macro.
    - For fields with variable lengths, such as `vote_state.votes` and `last_vote.lockouts`, use loops to deserialize each element, ensuring not to exceed predefined limits.
    - Return 0 upon successful deserialization.
- **Output**: Returns 0 on success, or -1 if a buffer overflow is detected during deserialization.
- **Functions Called**:
    - [`de_short_vec_cnt`](<#de_short_vec_cnt>)
    - [`de_varint`](<#de_varint>)


---
### fd\_tower\_to\_vote\_txn<!-- {{#callable:fd_tower_to_vote_txn}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.c#L887>)

Converts a tower's vote state into a transaction for voting on a blockchain.
- **Inputs**:
    - `tower`: A pointer to the `fd_tower_t` structure representing the current vote state.
    - `root`: An unsigned long integer representing the root slot of the tower.
    - `lockouts_scratch`: A pointer to an array of `fd_lockout_offset_t` structures used as scratch space for lockout calculations.
    - `bank_hash`: A pointer to the `fd_hash_t` structure representing the bank hash.
    - `recent_blockhash`: A pointer to the `fd_hash_t` structure representing the recent block hash.
    - `validator_identity`: A pointer to the `fd_pubkey_t` structure representing the validator's public key.
    - `vote_authority`: A pointer to the `fd_pubkey_t` structure representing the vote authority's public key.
    - `vote_acc`: A pointer to the `fd_pubkey_t` structure representing the vote account's public key.
    - `vote_txn`: A pointer to the `fd_txn_p_t` structure where the generated vote transaction will be stored.
- **Logic and Control Flow**:
    - Initialize `tower_sync` with the root, lockouts length, and current timestamp.
    - Iterate over the votes in the tower to populate `tower_sync.lockouts` with offsets and confirmation counts.
    - Copy the `bank_hash` into `tower_sync.hash`.
    - Determine if `validator_identity` and `vote_authority` are the same and set up transaction accounts accordingly.
    - Generate the base transaction using `fd_txn_base_generate` with the appropriate accounts and `recent_blockhash`.
    - Create a vote instruction with `tower_sync` and encode it into `vote_ix_buf`.
    - Add the vote instruction to the transaction using `fd_txn_add_instr`.
- **Output**: The function outputs a populated `fd_txn_p_t` structure representing the vote transaction.


---
### fd\_tower\_verify<!-- {{#callable:fd_tower_verify}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.c#L980>)

Verifies the integrity of a sequence of votes in a tower by checking that each vote's slot and confirmation count are in non-decreasing order.
- **Inputs**:
    - `tower`: A pointer to a constant `fd_tower_t` structure representing the tower of votes to verify.
- **Logic and Control Flow**:
    - Initialize a pointer `prev` to `NULL` to keep track of the previous vote.
    - Iterate over each vote in the tower using an iterator initialized with `fd_tower_votes_iter_init`.
    - For each vote, retrieve the current vote using `fd_tower_votes_iter_ele_const`.
    - Check if `prev` is not `NULL` and if the current vote's slot and confirmation count are not both less than those of `prev`.
    - If the check fails, log a warning message indicating an invariant violation and return -1.
    - Update `prev` to point to the current vote.
    - Continue the iteration until all votes are checked.
    - Return 0 if all votes satisfy the invariant.
- **Output**: Returns 0 if all votes in the tower satisfy the invariant; otherwise, returns -1 if an invariant violation is detected.


---
### fd\_tower\_print<!-- {{#callable:fd_tower_print}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.c#L998>)

Prints a formatted table of vote slots and confirmation counts from a tower structure.
- **Inputs**:
    - `tower`: A pointer to a constant `fd_tower_t` structure representing the tower of votes.
    - `root`: An unsigned long integer representing the root slot value to be printed at the end of the table.
- **Logic and Control Flow**:
    - Log a notice indicating the start of the tower print.
    - Initialize `max_slot` to zero to track the maximum slot value.
    - Iterate over the votes in reverse order to find the maximum slot value.
    - Calculate the number of digits in the maximum slot value for formatting purposes.
    - Print the table header with the slot and confirmation count columns.
    - Print a divider line under the header with appropriate spacing.
    - Iterate over the votes in reverse order again to print each vote's slot and confirmation count, formatted to align with the header.
    - Print the root slot value at the end of the table.
    - Print a newline to separate the table from subsequent output.
- **Output**: No return value; the function outputs the formatted table to the standard output.


---
### fd\_tower\_from\_vote\_acc\_data<!-- {{#callable:fd_tower_from_vote_acc_data}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.c#L1050>)

Converts vote account data into a tower of votes by iterating through the votes and pushing them onto the tower.
- **Inputs**:
    - ``data``: A pointer to the vote account data, which contains the votes to be processed.
    - ``tower_out``: A pointer to the `fd_tower_t` structure where the votes will be stored.
- **Logic and Control Flow**:
    - If `FD_TOWER_PARANOID` is defined, check that `tower_out` is empty using `fd_tower_votes_empty` function.
    - Cast `data` to a `fd_voter_state_t` pointer named `state`.
    - Iterate over the votes in `state` using a loop from 0 to `fd_voter_state_cnt(state)`.
    - For each vote, initialize a `fd_tower_vote_t` structure named `vote`.
    - Check the `kind` field of `state` to determine the version of the vote state.
    - Depending on the version, set the `slot` and `conf` fields of `vote` from the corresponding fields in `state`.
    - If the `kind` is unknown, log a critical error with `FD_LOG_CRIT`.
    - Push the `vote` onto `tower_out` using `fd_tower_votes_push_tail`.
- **Output**: The function does not return a value; it modifies the `tower_out` structure by adding votes to it.



---
Made with ❤️ by [Driver](https://www.driver.ai/)