<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

API and data structures for Solana's TowerBFT algorithm, including vote management and serialization.

# Purpose
The code defines an API for Solana's TowerBFT algorithm, which is a consensus mechanism used to achieve agreement among validators in a blockchain network. The primary focus of the code is to manage a validator's "vote tower," a data structure that tracks the votes a validator has cast for different blockchain slots. The vote tower helps ensure that validators converge on a single fork of the blockchain by enforcing rules about when and how votes can be cast or changed. The code includes functions for managing the vote tower, such as adding new votes, checking lockout and switch conditions, and serializing/deserializing the tower state for persistence and recovery.

The file is a C header file that provides a detailed implementation of the TowerBFT algorithm's components, including data structures and functions for managing vote towers. It defines public APIs for interacting with the vote tower, such as [`fd_tower_vote`](<#fd_tower_vote>), [`fd_tower_lockout_check`](<#fd_tower_lockout_check>), and [`fd_tower_switch_check`](<#fd_tower_switch_check>), which are used to manage voting operations and ensure consensus rules are followed. The file also includes serialization and deserialization functions to facilitate the storage and retrieval of the vote tower state, ensuring that validators can maintain their voting history across restarts. The code is structured to support zero-copy access to serialized data, optimizing performance for operations that require frequent state updates.
# Imports and Dependencies

---
- `../fd_choreo_base.h`
- `../epoch/fd_epoch.h`
- `../ghost/fd_ghost.h`
- `../../disco/pack/fd_microblock.h`
- `../../util/tmpl/fd_deque.c`


# Data Structures

---
### fd\_tower\_vote
- **Type**: ``struct``
- **Members**:
    - `slot`: Indicates the slot number for which the vote is cast.
    - `conf`: Represents the confirmation count for the vote.
- **Description**: The `fd_tower_vote` structure is used to represent a vote in the TowerBFT algorithm, which is part of the Solana blockchain's consensus mechanism. Each vote is associated with a specific slot and has a confirmation count that indicates how many consecutive votes have been cast on the same fork. This structure is a fundamental component of the vote tower, which helps validators decide on the heaviest fork to follow, ensuring consensus and stability in the network.


---
### fd\_tower\_vote\_t
- **Type**: ``struct``
- **Members**:
    - `slot`: Represents the vote slot.
    - `conf`: Indicates the confirmation count for the vote.
- **Description**: `fd_tower_vote_t` is a structure that represents a vote in the TowerBFT algorithm used in Solana's consensus mechanism. It contains two members: `slot`, which specifies the slot number for which the vote is cast, and `conf`, which denotes the number of confirmations for that vote. This structure is part of a larger system that manages the voting process and ensures consensus among validators by tracking votes and their confirmations.


---
### fd\_tower\_sync\_serde
- **Type**: ``struct``
- **Members**:
    - ``root``: Pointer to an unsigned long integer representing the root of the tower.
    - ``lockouts_cnt``: Unsigned short integer indicating the count of lockouts, which is variable-length.
    - ``lockouts``: Array of 31 `Lockout` structures, each containing an offset and a pointer to a confirmation count.
    - ``hash``: Pointer to a `fd_hash_t` structure representing the hash of the tower.
    - ``timestamp_option``: Pointer to an unsigned char indicating the presence of a timestamp.
    - ``timestamp``: Pointer to a long integer representing the timestamp.
    - ``block_id``: Pointer to a `fd_hash_t` structure representing the block ID.
- **Description**: Describes a serialization/deserialization schema for a bincode-encoded TowerSync transaction, structured for zero-copy access to individual fields. It includes pointers to various components such as the root, lockouts, hash, timestamp, and block ID, facilitating efficient data handling in the context of Solana's TowerBFT algorithm.


---
### fd\_tower\_sync\_serde\_t
- **Type**: ``struct``
- **Members**:
    - ``root``: Pointer to the root of the tower.
    - ``lockouts_cnt``: Count of lockouts, stored as a `ushort`.
    - ``lockouts``: Array of lockout structures, each containing an `offset` and `confirmation_count`.
    - ``hash``: Pointer to a hash value.
    - ``timestamp_option``: Pointer to an optional timestamp value.
    - ``timestamp``: Pointer to a timestamp value.
    - ``block_id``: Pointer to a block identifier.
- **Description**: Describes a serialization and deserialization schema for a bincode-encoded TowerSync transaction, structured for zero-copy access to individual fields. It includes pointers to the root, lockouts, hash, timestamp, and block ID, allowing efficient access and manipulation of these components in the context of Solana's TowerBFT algorithm.


---
### fd\_tower\_file\_serde
- **Type**: ``struct``
- **Members**:
    - ``kind``: Pointer to a constant unsigned integer representing the type of the serialized data.
    - ``signature``: Pointer to a constant `fd_ed25519_sig_t` representing the signature of the serialized data.
    - ``data_sz``: Pointer to a constant unsigned long representing the serialized size of the data field.
    - ``node_pubkey``: Pointer to a constant `fd_pubkey_t` representing the public key of the node.
    - ``threshold_depth``: Pointer to a constant unsigned long representing the threshold depth for voting.
    - ``threshold_size``: Pointer to a constant double representing the threshold size for voting.
    - ``vote_state``: `fd_voter_v2_serde_t` representing the state of the vote.
    - ``last_vote_kind``: Pointer to a constant unsigned integer representing the kind of the last vote.
    - ``last_vote``: `fd_tower_sync_serde_t` representing the last vote.
    - ``slot``: Pointer to a constant unsigned long representing the slot of the last timestamp.
    - ``timestamp``: Pointer to a constant long representing the timestamp of the last block.
- **Description**: Defines a structure for serializing and deserializing a tower file, which is used to checkpoint and restore the state of a voting tower in the context of Solana's TowerBFT algorithm. The structure includes fields for metadata such as the kind and signature of the serialized data, the size of the serialized data, and nested structures for node public key, voting thresholds, vote state, last vote details, and block timestamp information. This structure facilitates zero-copy access to individual fields for efficient processing.


---
### fd\_tower\_file\_serde\_t
- **Type**: ``struct``
- **Members**:
    - ``kind``: Pointer to a constant unsigned integer representing the kind of the tower file.
    - ``signature``: Pointer to a constant `fd_ed25519_sig_t` representing the signature of the tower file.
    - ``data_sz``: Pointer to a constant unsigned long representing the serialized size of the data field.
    - ``node_pubkey``: Pointer to a constant `fd_pubkey_t` representing the public key of the node.
    - ``threshold_depth``: Pointer to a constant unsigned long representing the threshold depth.
    - ``threshold_size``: Pointer to a constant double representing the threshold size.
    - ``vote_state``: `fd_voter_v2_serde_t` representing the state of the vote.
    - ``last_vote_kind``: Pointer to a constant unsigned integer representing the kind of the last vote.
    - ``last_vote``: `fd_tower_sync_serde_t` representing the last vote.
    - ``last_timestamp.slot``: Pointer to a constant unsigned long representing the slot of the last timestamp.
    - ``last_timestamp.timestamp``: Pointer to a constant long representing the timestamp of the last block.
- **Description**: Defines a serialization/deserialization schema for checkpointing and restoring a tower from a file, corresponding to the binary layout used by Agave during boot, set-identity, and voting. The structure is designed for zero-copy access, allowing direct access to individual fields without additional copying.


# Functions

---
### fd\_tower\_align<!-- {{#callable:fd_tower_align}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.h#L533>)

Returns the constant `FD_TOWER_ALIGN`, which specifies the alignment requirement for a memory region used as a tower.
- **Inputs**: None
- **Logic and Control Flow**:
    - The function is defined as `FD_FN_CONST` and `static inline`, indicating it is a constant function that can be inlined by the compiler.
    - The function body consists of a single return statement that returns the value of `FD_TOWER_ALIGN`.
- **Output**: The output is an `ulong` representing the alignment requirement for a tower, specifically `FD_TOWER_ALIGN`.


---
### fd\_tower\_footprint<!-- {{#callable:fd_tower_footprint}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.h#L538>)

Returns the constant `FD_TOWER_FOOTPRINT`.
- **Inputs**: None
- **Logic and Control Flow**:
    - The function directly returns the value of the constant `FD_TOWER_FOOTPRINT`.
- **Output**: The output is an unsigned long integer representing the footprint size of the tower, specifically `FD_TOWER_FOOTPRINT`.


# Function Declarations (Public API)

---
### fd\_tower\_new<!-- {{#callable_declaration:fd_tower_new}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.h#L547>)

Formats a memory region for use as a tower.
- **Description**: Use this function to prepare a memory region for use as a tower in the TowerBFT algorithm. The memory region must be non-null, properly aligned, and have the required footprint. If the memory region is null or misaligned, the function logs a warning and returns null. This function is typically called during initialization to set up the tower structure.
- **Inputs**:
    - `mem`: A non-null pointer to a memory region with the required alignment and footprint. The caller retains ownership of the memory. If the pointer is null or the memory is misaligned, the function logs a warning and returns null.
- **Output**: Returns a pointer to the initialized tower structure on success, or null if the input is invalid.
- **See Also**: [`fd_tower_new`](<fd_tower.c.md#fd_tower_new>)  (Implementation)


---
### fd\_tower\_join<!-- {{#callable_declaration:fd_tower_join}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.h#L556>)

Joins the caller to a shared tower memory region.
- **Description**: Use this function to access a shared memory region representing a tower in the local address space. Ensure that the `tower` parameter is a valid pointer to the start of the memory region with the required alignment. This function returns a pointer to the tower on success, or NULL if the input is invalid, such as when the pointer is NULL or misaligned. It is important to check the return value to confirm successful joining.
- **Inputs**:
    - `tower`: A pointer to the start of the memory region for the tower. Must not be NULL and must be aligned according to `fd_tower_align()`. If invalid, the function logs a warning and returns NULL.
- **Output**: Returns a pointer to the tower in the local address space on success, or NULL on failure.
- **See Also**: [`fd_tower_join`](<fd_tower.c.md#fd_tower_join>)  (Implementation)


---
### fd\_tower\_leave<!-- {{#callable_declaration:fd_tower_leave}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.h#L563>)

Leaves a current local join of a tower.
- **Description**: Use this function to leave a current local join of a tower. It is important to ensure that the `tower` parameter is not null before calling this function. If the `tower` is null, the function will log a warning and return null. This function is typically used when a process no longer needs to interact with a tower and wants to release any resources associated with the join.
- **Inputs**:
    - `tower`: A pointer to the `fd_tower_t` structure representing the tower to leave. Must not be null. If null, the function logs a warning and returns null.
- **Output**: Returns a pointer to the underlying shared memory region on success, or null if the `tower` is null.
- **See Also**: [`fd_tower_leave`](<fd_tower.c.md#fd_tower_leave>)  (Implementation)


---
### fd\_tower\_delete<!-- {{#callable_declaration:fd_tower_delete}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.h#L572>)

Unformats a memory region used as a tower.
- **Description**: Use this function to release a memory region previously formatted as a tower, assuming no other processes are joined to it. This function checks if the provided pointer is valid and aligned according to the tower's requirements. If the pointer is null or misaligned, it logs a warning and returns null. Otherwise, it returns a pointer to the underlying shared memory region, transferring ownership back to the caller.
- **Inputs**:
    - `tower`: A pointer to the memory region formatted as a tower. Must not be null and must be aligned according to `fd_tower_align()`. If invalid, the function logs a warning and returns null.
- **Output**: Returns a pointer to the underlying shared memory region if successful, or null if the input is invalid.
- **See Also**: [`fd_tower_delete`](<fd_tower.c.md#fd_tower_delete>)  (Implementation)


---
### fd\_tower\_lockout\_check<!-- {{#callable_declaration:fd_tower_lockout_check}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.h#L638>)

Checks if voting for a slot violates lockout rules.
- **Description**: Use this function to determine if voting for a specific slot is permissible under the lockout rules of the TowerBFT algorithm. It checks whether the slot is on the same fork as the previous votes or if the lockout period has expired, allowing a switch to a different fork. This function assumes that the tower is not empty and that the caller has already ensured this precondition.
- **Inputs**:
    - `tower`: A pointer to a non-empty `fd_tower_t` structure representing the current vote tower. The caller must ensure this is not null.
    - `ghost`: A pointer to a `fd_ghost_t` structure used to determine fork ancestry. The caller must ensure this is not null.
    - `slot`: An unsigned long integer representing the slot to check for lockout violations. Must be a valid slot number.
    - `block_id`: A pointer to a `fd_hash_t` structure representing the block ID of the slot. The caller must ensure this is not null.
- **Output**: Returns 1 if voting for the slot does not violate lockout rules, otherwise returns 0.
- **See Also**: [`fd_tower_lockout_check`](<fd_tower.c.md#fd_tower_lockout_check>)  (Implementation)


---
### fd\_tower\_switch\_check<!-- {{#callable_declaration:fd_tower_switch_check}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.h#L672>)

Checks if switching to a new fork is allowed.
- **Description**: Use this function to determine if it is permissible to switch to a different fork based on the current voting state and stake distribution. It assumes that the tower is non-empty and evaluates whether a sufficient percentage of stake has voted for a different descendant of the greatest common ancestor of the current and target forks. This check is crucial for maintaining consensus and preventing arbitrary fork switching.
- **Inputs**:
    - `tower`: A pointer to a non-empty `fd_tower_t` structure representing the current vote tower. The caller retains ownership and must ensure it is valid.
    - `epoch`: A pointer to a `fd_epoch_t` structure containing the current epoch's stake information. The caller retains ownership and must ensure it is valid.
    - `ghost`: A pointer to a `fd_ghost_t` structure used to determine fork ancestry. The caller retains ownership and must ensure it is valid.
    - `slot`: An unsigned long integer representing the slot of the fork to which switching is considered. Must be a valid slot number.
    - `block_id`: A pointer to a `fd_hash_t` structure representing the block identifier of the target fork. The caller retains ownership and must ensure it is valid.
- **Output**: Returns 1 if switching to the new fork is allowed, otherwise returns 0.
- **See Also**: [`fd_tower_switch_check`](<fd_tower.c.md#fd_tower_switch_check>)  (Implementation)


---
### fd\_tower\_threshold\_check<!-- {{#callable_declaration:fd_tower_threshold_check}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.h#L705>)

Checks if the threshold condition for voting is met.
- **Description**: Use this function to determine if the voting threshold condition is satisfied for a given slot. It simulates a vote for the specified slot and checks if the tower is deep enough to meet the threshold condition. This function is relevant after confirming the same fork and requires the tower to be at least `FD_TOWER_THRESHOLD_DEPTH` deep. It returns a boolean indicating whether the threshold condition is met, which is necessary to ensure that a sufficient amount of stake has voted for the same fork.
- **Inputs**:
    - `tower`: A pointer to a constant `fd_tower_t` structure representing the current vote tower. Must not be null.
    - `epoch`: A pointer to an `fd_epoch_t` structure representing the current epoch. Must not be null.
    - `vote_keys`: A pointer to an array of `fd_pubkey_t` representing the public keys of the vote accounts. Must not be null.
    - `vote_towers`: A pointer to an array of constant pointers to `fd_tower_t` structures representing the vote towers of other validators. Must not be null.
    - `vote_cnt`: An unsigned long representing the number of vote accounts. Must be non-negative.
    - `slot`: An unsigned long representing the slot for which the threshold check is performed.
- **Output**: Returns 1 if the threshold condition is met, otherwise returns 0.
- **See Also**: [`fd_tower_threshold_check`](<fd_tower.c.md#fd_tower_threshold_check>)  (Implementation)


---
### fd\_tower\_reset\_slot<!-- {{#callable_declaration:fd_tower_reset_slot}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.h#L722>)

Determines the slot to reset PoH to for building the next leader block.
- **Description**: Use this function to find the appropriate slot to reset the Proof of History (PoH) when preparing to build the next leader block. It assumes that both the `tower` and `ghost` are valid and synchronized, meaning every vote slot in the tower corresponds to a node in the ghost. The function guarantees a valid reset slot, ensuring it never returns `ULONG_MAX`. Typically, the reset slot is the leaf of the last vote fork, which is often the ghost head.
- **Inputs**:
    - `tower`: A pointer to a constant `fd_tower_t` structure representing the validator's vote tower. It must be a valid local join and synchronized with the ghost.
    - `epoch`: A pointer to a constant `fd_epoch_t` structure representing the current epoch. It must be valid and synchronized with the tower and ghost.
    - `ghost`: A pointer to a constant `fd_ghost_t` structure representing the ghost tree. It must be a valid local join and synchronized with the tower.
- **Output**: Returns an `ulong` representing the slot to reset PoH to, ensuring it is always a valid slot.
- **See Also**: [`fd_tower_reset_slot`](<fd_tower.c.md#fd_tower_reset_slot>)  (Implementation)


---
### fd\_tower\_vote\_slot<!-- {{#callable_declaration:fd_tower_vote_slot}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.h#L740>)

Determines the appropriate slot to vote for based on the current ghost tree.
- **Description**: Use this function to decide which slot to vote for in the context of Solana's TowerBFT algorithm. It evaluates the current state of the vote tower and the ghost tree to determine if a vote can be cast for the ghost head slot. The function checks if the ghost head is on the same fork as the last vote slot and if the threshold check is passed. Alternatively, it checks if the ghost head is on a different fork and if both the lockout and switch checks are satisfied. If none of these conditions are met, it returns `FD_SLOT_NULL`, indicating that a vote cannot be cast at this time.
- **Inputs**:
    - `tower`: A pointer to a constant `fd_tower_t` structure representing the current vote tower. Must not be null.
    - `epoch`: A pointer to an `fd_epoch_t` structure representing the current epoch. Must not be null.
    - `vote_keys`: A pointer to an array of `fd_pubkey_t` structures representing the public keys of the votes. Must not be null.
    - `vote_towers`: A pointer to an array of constant pointers to `fd_tower_t` structures representing the vote towers. Must not be null.
    - `vote_cnt`: An unsigned long integer representing the number of votes. Must be a valid count of the `vote_keys` and `vote_towers` arrays.
    - `ghost`: A pointer to a constant `fd_ghost_t` structure representing the ghost tree. Must not be null.
- **Output**: Returns the slot number to vote for, or `FD_SLOT_NULL` if voting is not possible.
- **See Also**: [`fd_tower_vote_slot`](<fd_tower.c.md#fd_tower_vote_slot>)  (Implementation)


---
### fd\_tower\_simulate\_vote<!-- {{#callable_declaration:fd_tower_simulate_vote}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.h#L752>)

Simulates a vote on the vote tower for a given slot.
- **Description**: Use this function to simulate the effect of voting for a specific slot on a non-empty vote tower. This function helps to understand the potential changes in the vote tower without actually committing a vote. It is useful for testing and validation purposes to see how the tower would adjust if a vote were cast for the specified slot.
- **Inputs**:
    - `tower`: A pointer to a non-empty `fd_tower_t` structure representing the current state of the vote tower. The caller must ensure that this pointer is valid and not null.
    - `slot`: An unsigned long integer representing the slot for which the vote is being simulated. The value should be a valid slot number within the context of the voting system.
- **Output**: Returns an unsigned long integer representing the new height (count) of votes that would be popped from the tower if the vote were actually cast.
- **See Also**: [`fd_tower_simulate_vote`](<fd_tower.c.md#fd_tower_simulate_vote>)  (Implementation)


---
### fd\_tower\_to\_tower\_sync<!-- {{#callable_declaration:fd_tower_to_tower_sync}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.h#L778>)

Populates a serialization structure for a TowerSync transaction.
- **Description**: Use this function to prepare a `fd_tower_sync_serde_t` structure with data from a given vote tower and additional parameters. This function is useful when you need to serialize the current state of a vote tower for synchronization purposes. Ensure that the `ser` parameter points to a valid `fd_tower_sync_serde_t` structure before calling this function. The function does not perform any memory allocation, so the caller must manage the memory for the `ser` structure.
- **Inputs**:
    - `tower`: A pointer to a constant `fd_tower_t` structure representing the vote tower. Must not be null.
    - `root`: An unsigned long integer representing the root slot of the tower. Must be a valid slot number.
    - `bank_hash`: A pointer to an `fd_hash_t` structure representing the bank hash. Must not be null.
    - `block_id`: A pointer to an `fd_hash_t` structure representing the block ID. Must not be null.
    - `ts`: A long integer representing the timestamp. Must be a valid timestamp value.
    - `ser`: A pointer to an `fd_tower_sync_serde_t` structure where the serialized data will be stored. Must not be null and must be properly initialized by the caller.
- **Output**: Returns a pointer to the populated `fd_tower_sync_serde_t` structure provided in the `ser` parameter.
- **See Also**: [`fd_tower_to_tower_sync`](<fd_tower.c.md#fd_tower_to_tower_sync>)  (Implementation)


---
### fd\_tower\_to\_vote\_txn<!-- {{#callable_declaration:fd_tower_to_vote_txn}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.h#L797>)

Serializes a vote tower into a Solana transaction.
- **Description**: Use this function to convert a vote tower into a Solana transaction, which can then be submitted to the network. This function requires a valid vote tower and several parameters related to the transaction, such as the root, bank hash, and public keys for the validator and vote authority. Ensure that the `tower` is a valid local join before calling this function. The function prepares the transaction by setting up the necessary accounts and instructions based on whether the validator identity matches the vote authority.
- **Inputs**:
    - `tower`: A pointer to a `fd_tower_t` structure representing the vote tower. Must be a valid local join and not null.
    - `root`: An unsigned long integer representing the root of the tower. If set to `ULONG_MAX`, it defaults to 0.
    - `lockouts_scratch`: A pointer to a `fd_lockout_offset_t` array used as scratch space for lockout calculations. Must not be null.
    - `bank_hash`: A pointer to a `fd_hash_t` structure representing the bank hash. Must not be null.
    - `recent_blockhash`: A pointer to a `fd_hash_t` structure representing the recent block hash. Must not be null.
    - `validator_identity`: A pointer to a `fd_pubkey_t` structure representing the validator's public key. Must not be null.
    - `vote_authority`: A pointer to a `fd_pubkey_t` structure representing the vote authority's public key. Must not be null.
    - `vote_acc`: A pointer to a `fd_pubkey_t` structure representing the vote account's public key. Must not be null.
    - `vote_txn`: A pointer to a `fd_txn_p_t` structure where the serialized transaction will be stored. Must not be null.
- **Output**: None
- **See Also**: [`fd_tower_to_vote_txn`](<fd_tower.c.md#fd_tower_to_vote_txn>)  (Implementation)


---
### fd\_tower\_checkpt<!-- {{#callable_declaration:fd_tower_checkpt}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.h#L825>)

Serializes a tower and writes it to a file descriptor.
- **Description**: Use this function to serialize a tower's state and write it to a specified file descriptor. This is useful for checkpointing the tower's state for later restoration. Ensure the tower is non-empty and a valid local join. The function requires a valid open file descriptor for writing, and a buffer with sufficient size to hold the serialized data. Avoid concurrent writes to the memory or file during execution to prevent data corruption.
- **Inputs**:
    - `tower`: A pointer to a non-empty `fd_tower_t` structure representing the current tower state. Must be a valid local join.
    - `root`: An unsigned long integer representing the current root of the tower.
    - `last_vote`: A pointer to a `fd_tower_sync_serde_t` structure containing the serialization of the last vote sent. Must be valid.
    - `pubkey`: A constant array of 32 unsigned characters representing the public key of the validator. Must not be null.
    - `sign_fn`: A pointer to a `fd_tower_sign_fn` function used to sign the serialized data. Must be valid.
    - `fd`: An integer representing a valid open file descriptor for writing the serialized data.
    - `buf`: A pointer to a buffer where the serialized data will be stored before writing. Must have sufficient space as indicated by `buf_max`.
    - `buf_max`: An unsigned long integer specifying the maximum size of the buffer `buf`. Must be large enough to hold the serialized data.
- **Output**: Returns 0 on successful serialization and writing, or -1 if an error occurs during the process.
- **See Also**: [`fd_tower_checkpt`](<fd_tower.c.md#fd_tower_checkpt>)  (Implementation)


---
### fd\_tower\_restore<!-- {{#callable_declaration:fd_tower_restore}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.h#L853>)

Restores a tower from a serialized file.
- **Description**: Use this function to restore the state of a tower from a serialized file. It reads the serialized data from a file descriptor and verifies the integrity of the data using the provided public key. The function assumes that the tower is a valid local join of an empty tower and that the file descriptor is valid and open for reading. It updates the tower, root, and timestamp to reflect the state at the time of checkpointing. Ensure no other process writes to the memory or file during this operation.
- **Inputs**:
    - `tower`: A pointer to an empty `fd_tower_t` structure. Must be a valid local join.
    - `root`: A pointer to an `ulong` where the root slot will be stored. Must not be null.
    - `ts`: A pointer to a `long` where the timestamp will be stored. Must not be null.
    - `pubkey`: A constant array of 32 `uchar` representing the validator's public key. Used for signature verification.
    - `fd`: An integer representing a valid open file descriptor for reading the serialized data.
    - `buf`: A pointer to a buffer of `uchar` where the serialized data will be read into. Must be large enough to hold the data.
    - `buf_max`: An `ulong` indicating the maximum size of the buffer. Must be greater than or equal to the size of the serialized data.
    - `buf_sz`: A pointer to an `ulong` where the size of the serialized data will be stored. Must not be null.
- **Output**: Returns 0 on success, or -1 on error with a logged message.
- **See Also**: [`fd_tower_restore`](<fd_tower.c.md#fd_tower_restore>)  (Implementation)


---
### fd\_tower\_serialize<!-- {{#callable_declaration:fd_tower_serialize}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.h#L873>)

Serializes a tower structure into a buffer.
- **Description**: Use this function to serialize a `fd_tower_file_serde_t` structure into a buffer for storage or transmission. Ensure that the `ser` parameter is correctly populated with valid pointers to the data to serialize. The buffer `buf` must be large enough to hold the serialized data, as specified by `buf_max`. The function will populate `buf_sz` with the number of bytes written to `buf`. If any precondition is not met, or if an error occurs during serialization, the function returns -1.
- **Inputs**:
    - `ser`: A pointer to a `fd_tower_file_serde_t` structure containing the data to serialize. Must be populated with valid pointers to the data fields to serialize.
    - `buf`: A pointer to a buffer where the serialized data will be written. Must not be null and should have enough space as specified by `buf_max`.
    - `buf_max`: The maximum number of bytes that can be written to `buf`. Must be greater than or equal to the size of the serialized data.
    - `buf_sz`: A pointer to an `ulong` where the function will store the size of the serialized data written to `buf`. Must not be null.
- **Output**: Returns 0 on successful serialization, or -1 if an error occurs.
- **See Also**: [`fd_tower_serialize`](<fd_tower.c.md#fd_tower_serialize>)  (Implementation)


---
### fd\_tower\_deserialize<!-- {{#callable_declaration:fd_tower_deserialize}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.h#L887>)

Deserializes a buffer into a tower file structure.
- **Description**: Use this function to convert a serialized buffer into a `fd_tower_file_serde_t` structure. Ensure that the buffer is large enough to contain the serialized data, as specified by `buf_sz`. The function will populate the `de` structure with the deserialized data. If the buffer is too small or an error occurs during deserialization, the function returns -1. This function is useful for restoring tower state from a serialized format.
- **Inputs**:
    - `buf`: A pointer to the buffer containing the serialized data. The buffer must not be null and should be large enough to hold the serialized data.
    - `buf_sz`: The size of the buffer in bytes. It must be at least as large as the serialized data to avoid overflow errors.
    - `de`: A pointer to an `fd_tower_file_serde_t` structure that will be populated with the deserialized data. The caller retains ownership and must ensure it is a valid pointer.
- **Output**: Returns 0 on successful deserialization, or -1 if an error occurs, such as buffer overflow.
- **See Also**: [`fd_tower_deserialize`](<fd_tower.c.md#fd_tower_deserialize>)  (Implementation)


---
### fd\_tower\_verify<!-- {{#callable_declaration:fd_tower_verify}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.h#L897>)

Checks if the tower is in a valid state.
- **Description**: Use this function to verify the integrity of a vote tower by ensuring that the vote slots and confirmation counts are monotonically increasing and that the number of votes does not exceed the maximum allowed. This function is useful for maintaining the correctness of the tower's state before performing operations that depend on its validity.
- **Inputs**:
    - `tower`: A pointer to a constant `fd_tower_t` structure representing the vote tower to verify. The pointer must not be null, and the tower should be properly initialized and populated with votes.
- **Output**: Returns 0 if the tower is valid, or -1 if the tower is invalid due to non-monotonic vote slots or confirmation counts, or if the vote count exceeds the maximum allowed.
- **See Also**: [`fd_tower_verify`](<fd_tower.c.md#fd_tower_verify>)  (Implementation)


---
### fd\_tower\_print<!-- {{#callable_declaration:fd_tower_print}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.h#L921>)

Pretty-prints the vote tower as a formatted table.
- **Description**: Use this function to display the contents of a vote tower in a human-readable table format. It prints each vote's slot and confirmation count, followed by the root slot labeled as 'root'. This function is useful for debugging or logging purposes to understand the current state of the vote tower. Ensure that the `tower` parameter is a valid pointer to a `fd_tower_t` structure before calling this function.
- **Inputs**:
    - `tower`: A pointer to a `fd_tower_t` structure representing the vote tower. Must not be null and should point to a valid, initialized vote tower.
    - `root`: An unsigned long integer representing the root slot to be printed at the end of the table. It is displayed as 'root' in the output.
- **Output**: None
- **See Also**: [`fd_tower_print`](<fd_tower.c.md#fd_tower_print>)  (Implementation)


---
### fd\_tower\_from\_vote\_acc\_data<!-- {{#callable_declaration:fd_tower_from_vote_acc_data}} -->
[View Source →](<../../../../../src/choreo/tower/fd_tower.h#L929>)

Reads vote account data into a tower.
- **Description**: Use this function to populate a tower with votes from Solana vote account data. Ensure the tower is a valid local join and currently empty before calling this function. The function deserializes the vote account data and populates the tower with the votes.
- **Inputs**:
    - `data`: A pointer to the vote account data to be deserialized. Must not be null.
    - `tower_out`: A pointer to the tower to be populated. Must be a valid local join and currently empty.
- **Output**: None
- **See Also**: [`fd_tower_from_vote_acc_data`](<fd_tower.c.md#fd_tower_from_vote_acc_data>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)