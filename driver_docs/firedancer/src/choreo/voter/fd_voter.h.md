<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

API for accessing and interpreting bincode-serialized on-chain voter accounts without deserialization.

# Purpose
The code is a C header file that defines an API for accessing and interpreting on-chain voter accounts, referred to as "vote states." These accounts are stored in a bincode-serialized format, and the API provides mechanisms to interpret the bytes without deserializing them. The file includes definitions for various data structures and functions that facilitate zero-copy access to the serialized data, allowing efficient manipulation and querying of voter information. The header file is part of a larger system, as indicated by its inclusion of other headers such as `fd_choreo_base.h` and `fd_funk_rec.h`.

Key components of the code include structures like `fd_voter_v2_serde` and `fd_voter_v3_serde`, which define the serialization and deserialization schema for different versions of vote accounts. These structures allow for direct access to fields such as node public keys, authorized withdrawers, and vote records. The code also defines a `fd_voter` structure that describes a voter in various contexts, such as slot-level or epoch-level, and includes fields for stake and cached vote records. Additionally, the file provides functions like [`fd_voter_state_cnt`](<#fd_voter_state_cnt>), [`fd_voter_root_laddr`](<#fd_voter_root_laddr>), and [`fd_voter_state_vote`](<#fd_voter_state_vote>) to query and manipulate the voter's state. The header file is designed to be used in conjunction with other components of the system, such as epoch tracking and fork updates, and it defines public interfaces for interacting with voter data.
# Imports and Dependencies

---
- `../fd_choreo_base.h`
- `../../funk/fd_funk_rec.h`


# Data Structures

---
### fd\_voter\_v2\_serde
- **Type**: ``struct``
- **Members**:
    - ``node_pubkey``: Pointer to the public key of the node.
    - ``authorized_withdrawer``: Pointer to the public key of the authorized withdrawer.
    - ``commission``: Pointer to the commission rate.
    - ``votes_cnt``: Pointer to the count of votes in the `VecDeque<Lockout>` structure.
    - ``votes``: Array of structures containing `slot` and `confirmation_count` for each vote.
    - ``root_slot_option``: Pointer to the option flag for the root slot.
    - ``root_slot``: Pointer to the root slot value.
    - ``authorized_voters_cnt``: Pointer to the count of authorized voters.
    - ``authorized_voters``: Array of structures containing `epoch` and `pubkey` for each authorized voter.
    - ``prior_voters``: Structure containing a circular buffer of prior voters with their epochs and public keys.
    - ``epoch_credits_cnt``: Pointer to the count of epoch credits.
    - ``epoch_credits``: Array of structures containing `epoch`, `credits`, and `prev_credits` for each epoch credit.
    - ``last_timestamp``: Structure containing the last `slot` and `timestamp`.
- **Description**: Defines a serialization/deserialization schema for a bincode-encoded vote account version 2, corresponding to the binary layout of an Agave VoteState1_14_11. It is structured for zero-copy access, allowing direct access to individual fields without deserialization. The structure includes fields for node public key, authorized withdrawer, commission, votes, root slot, authorized voters, prior voters, epoch credits, and the last timestamp, each with specific pointers or arrays to manage the data efficiently.


---
### fd\_voter\_v2\_serde\_t
- **Type**: ``struct``
- **Members**:
    - ``node_pubkey``: Pointer to the public key of the node.
    - ``authorized_withdrawer``: Pointer to the public key of the authorized withdrawer.
    - ``commission``: Pointer to the commission rate.
    - ``votes_cnt``: Pointer to the count of votes in the `VecDeque<Lockout>` structure.
    - ``votes``: Array of structures containing pointers to `slot` and `confirmation_count` for each vote.
    - ``root_slot_option``: Pointer to the option flag for the root slot.
    - ``root_slot``: Pointer to the root slot value.
    - ``authorized_voters_cnt``: Pointer to the count of authorized voters.
    - ``authorized_voters``: Array of structures containing pointers to `epoch` and `pubkey` for each authorized voter.
    - ``prior_voters``: Structure containing a buffer of prior voters with their `pubkey`, `start_epoch`, and `end_epoch`, along with pointers to `idx` and `is_empty`.
    - ``epoch_credits_cnt``: Pointer to the count of epoch credits.
    - ``epoch_credits``: Array of structures containing pointers to `epoch`, `credits`, and `prev_credits` for each epoch credit.
    - ``last_timestamp``: Structure containing pointers to `slot` and `timestamp` for the last block timestamp.
- **Description**: Defines a serialization/deserialization schema for a bincode-encoded vote account version 2, corresponding to the binary layout of an Agave `VoteState1_14_11`. It is structured for zero-copy access, allowing direct interpretation of individual fields without deserialization. The structure includes fields for node public key, authorized withdrawer, commission, votes, root slot, authorized voters, prior voters, epoch credits, and the last block timestamp, each represented by pointers to their respective data types.


---
### fd\_voter\_v3\_serde
- **Type**: ``struct``
- **Members**:
    - ``node_pubkey``: Pointer to the public key of the node.
    - ``authorized_withdrawer``: Pointer to the public key of the authorized withdrawer.
    - ``commission``: Pointer to the commission rate.
    - ``votes_cnt``: Pointer to the count of votes in the `VecDeque<LandedVote>` structure.
    - ``votes``: Array of structures containing `latency`, `slot`, and `confirmation_count` for each vote.
    - ``root_slot_option``: Pointer to the option flag for the root slot.
    - ``root_slot``: Pointer to the root slot value.
    - ``authorized_voters_cnt``: Pointer to the count of authorized voters.
    - ``authorized_voters``: Array of structures containing `epoch` and `pubkey` for each authorized voter.
    - ``prior_voters``: Structure containing a circular buffer of prior voters with `pubkey`, `start_epoch`, and `end_epoch`.
    - ``epoch_credits_cnt``: Pointer to the count of epoch credits.
    - ``epoch_credits``: Array of structures containing `epoch`, `credits`, and `prev_credits` for each epoch credit.
    - ``last_timestamp``: Structure containing the `slot` and `timestamp` of the last block.
- **Description**: Defines a serialization/deserialization schema for a bincode-encoded vote account version 3, corresponding to the binary layout of an Agave VoteState. It is structured for zero-copy access, allowing direct interpretation of serialized data fields without deserialization. The structure includes fields for node public key, authorized withdrawer, commission, votes, root slot, authorized voters, prior voters, epoch credits, and the last block timestamp, each represented by pointers to their respective data types.


---
### fd\_voter\_v3\_serde\_t
- **Type**: ``struct``
- **Members**:
    - `node_pubkey`: Pointer to the public key of the node.
    - `authorized_withdrawer`: Pointer to the public key of the authorized withdrawer.
    - `commission`: Pointer to the commission rate.
    - `votes_cnt`: Pointer to the count of votes in the `VecDeque<LandedVote>` structure.
    - `votes`: Array of structures containing latency, slot, and confirmation count for each vote.
    - `root_slot_option`: Pointer to the option indicating the presence of a root slot.
    - `root_slot`: Pointer to the root slot value.
    - `authorized_voters_cnt`: Pointer to the count of authorized voters.
    - `authorized_voters`: Array of structures containing epoch and public key for each authorized voter.
    - `prior_voters`: Structure containing a circular buffer of prior voters with public key, start epoch, and end epoch.
    - `epoch_credits_cnt`: Pointer to the count of epoch credits.
    - `epoch_credits`: Array of structures containing epoch, credits, and previous credits for each epoch.
    - `last_timestamp`: Structure containing the slot and timestamp of the last block.
- **Description**: Defines a serialization/deserialization schema for a bincode-encoded vote account version 3, corresponding to the binary layout of an Agave VoteStateVersioned::Current. It is structured for zero-copy access, allowing direct interpretation of individual fields without deserialization. The structure includes fields for node public key, authorized withdrawer, commission, votes, root slot, authorized voters, prior voters, epoch credits, and the last block timestamp.


---
### fd\_vote\_record
- **Type**: ``struct``
- **Members**:
    - `slot`: Stores the slot number associated with the vote record.
    - `hash`: Holds the hash value related to the vote record.
- **Description**: The `fd_vote_record` structure is used to keep track of a vote record by storing both the slot number and a hash value. This is useful for handling cases of equivocation by maintaining both the block ID and slot in the vote record.


---
### fd\_vote\_record\_t
- **Type**: ``struct``
- **Members**:
    - `slot`: Stores the slot number associated with the vote record.
    - `hash`: Stores the hash of the vote record.
- **Description**: `fd_vote_record_t` is a data structure that keeps track of a vote record by storing the slot number and the hash of the vote. This structure is useful for handling cases of vote equivocation by maintaining both the block ID and slot information.


---
### fd\_voter
- **Type**: ``struct``
- **Members**:
    - `key`: Vote account address.
    - `hash`: Reserved for `fd_map_dynamic.c`.
    - `stake`: Voter's stake.
    - `replay_vote`: Cached read of last tower vote via replay.
    - `gossip_vote`: Cached read of last tower vote via gossip.
    - `rooted_vote`: Cached read of last tower root via replay.
- **Description**: Represents a voter with a unique vote account address and associated data such as stake and cached vote records. The structure is used in various contexts, including epoch tracking and fork updates, and its fields are primarily modified by `fd_epoch` and `fd_ghost`.


---
### fd\_voter\_t
- **Type**: ``struct``
- **Members**:
    - ``key``: Vote account address.
    - ``hash``: Reserved for `fd_map_dynamic.c`.
    - ``stake``: Voter's stake.
    - ``replay_vote``: Cached read of last tower vote via replay.
    - ``gossip_vote``: Cached read of last tower vote via gossip.
    - ``rooted_vote``: Cached read of last tower root via replay.
- **Description**: Describes a voter in a generic context, where the stake value may vary depending on the context, such as slot-level or epoch-level. Used by various choreo APIs, including `fd_epoch`, `fd_forks`, `ghost`, and `tower`, for tracking voters and performing updates. The structure includes fields for the voter's key, hash, stake, and cached votes for replay, gossip, and rooted contexts.


---
### fd\_voter\_vote\_old
- **Type**: ``struct``
- **Members**:
    - `slot`: Stores the slot number as an unsigned long integer.
    - `conf`: Stores the confirmation count as an unsigned integer.
- **Description**: `fd_voter_vote_old` is a packed structure that represents a vote in a voter's state for version 0.23.5. It contains two fields: `slot`, which indicates the slot number associated with the vote, and `conf`, which indicates the confirmation count for that vote. This structure is used to support zero-copy reads of the vote account in a serialized format.


---
### fd\_voter\_vote\_old\_t
- **Type**: ``struct``
- **Members**:
    - `slot`: Stores the slot number associated with the vote.
    - `conf`: Stores the confirmation count for the vote.
- **Description**: Represents a vote in the old format, containing a slot number and a confirmation count, used in the context of a voter's state in a bincode-serialized layout.


---
### fd\_voter\_vote
- **Type**: ``struct``
- **Members**:
    - `latency`: An `uchar` representing the latency of the vote.
    - `slot`: An `ulong` representing the slot number associated with the vote.
    - `conf`: An `uint` representing the confirmation count of the vote.
- **Description**: The `fd_voter_vote` structure is a packed data structure that represents a vote with three fields: `latency`, `slot`, and `conf`. It is used to store information about a vote's latency, the slot number it is associated with, and the number of confirmations it has received. This structure is part of a system that manages voter states and is used in contexts where precise control over memory layout is necessary, as indicated by the `__attribute__((packed))` directive.


---
### fd\_voter\_vote\_t
- **Type**: ``struct``
- **Members**:
    - `latency`: Represents the latency of the vote.
    - `slot`: Indicates the slot number associated with the vote.
    - `conf`: Specifies the confirmation count for the vote.
- **Description**: Defines a structure for a vote with fields for latency, slot, and confirmation count, used in the context of a voter's state in a voting system.


---
### fd\_voter\_meta\_old
- **Type**: ``struct``
- **Members**:
    - ``node_pubkey``: Holds the public key of the node.
    - ``authorized_voter``: Stores the public key of the authorized voter.
    - ``authorized_voter_epoch``: Indicates the epoch when the voter was authorized.
    - ``prior_voters``: Contains serialized data of prior voters.
    - ``authorized_withdrawer``: Holds the public key of the authorized withdrawer.
    - ``commission``: Represents the commission rate.
- **Description**: Defines metadata for a voter in a packed format, including public keys for the node, authorized voter, and withdrawer, as well as the epoch of authorization, prior voter data, and commission rate.


---
### fd\_voter\_meta\_old\_t
- **Type**: ``struct``
- **Members**:
    - ``node_pubkey``: The public key of the node.
    - ``authorized_voter``: The public key of the authorized voter.
    - ``authorized_voter_epoch``: The epoch in which the voter is authorized.
    - ``prior_voters``: Serialized bincode size of prior voters.
    - ``authorized_withdrawer``: The public key of the authorized withdrawer.
    - ``commission``: The commission rate for the voter.
- **Description**: Represents metadata for an older version of a voter, including public keys for the node, authorized voter, and withdrawer, as well as the epoch of authorization and commission rate. It also includes serialized data for prior voters.


---
### fd\_voter\_meta
- **Type**: ``struct``
- **Members**:
    - ``node_pubkey``: Stores the public key of the node.
    - ``authorized_withdrawer``: Stores the public key of the authorized withdrawer.
    - ``commission``: Stores the commission rate as an unsigned character.
- **Description**: Represents metadata for a voter, including the node's public key, the authorized withdrawer's public key, and the commission rate. The structure is packed to ensure no padding is added between its members, which is important for binary compatibility and efficient storage.


---
### fd\_voter\_meta\_t
- **Type**: ``struct``
- **Members**:
    - ``node_pubkey``: Holds the public key of the node.
    - ``authorized_withdrawer``: Holds the public key of the authorized withdrawer.
    - ``commission``: Stores the commission rate as an unsigned character.
- **Description**: Defines metadata for a voter, including the node's public key, the authorized withdrawer's public key, and the commission rate. This structure is part of the serialized layout of a voter's state in a vote account, used for zero-copy reads.


---
### fd\_voter\_state
- **Type**: ``struct``
- **Members**:
    - ``kind``: Specifies the version of the voter state.
    - ``v0_23_5``: Contains metadata, vote count, and votes for version 0.23.5.
    - ``v1_14_11``: Contains metadata, vote count, and votes for version 1.14.11.
    - ``meta``: Holds metadata for the current version.
    - ``cnt``: Indicates the number of votes in the current version.
    - ``votes``: Stores an array of votes for the current version.
- **Description**: Represents a voter's state in a packed structure with different versions, each containing metadata, a count of votes, and an array of votes. The structure uses a union to accommodate different versions of the voter state, allowing for zero-copy access to serialized vote account data. The voter's root follows the votes and is not directly encoded in the structure due to variable-length serialization.


---
### fd\_voter\_state\_t
- **Type**: ``struct``
- **Members**:
    - ``kind``: Indicates the version of the voter's state.
    - ``v0_23_5``: Contains metadata and votes for version 0.23.5.
    - ``v1_14_11``: Contains metadata and votes for version 1.14.11.
    - ``meta``: Holds metadata for the current version.
    - ``cnt``: Stores the number of votes in the current version.
    - ``votes``: Array of votes for the current version.
- **Description**: Represents a voter's state in a vote account, supporting multiple versions with different metadata and vote structures. The structure uses a union to handle different versions, each with its own metadata and vote format. The `kind` field determines which version is active, and the structure allows for zero-copy access to serialized vote data.


---
### fd\_voter\_tower
- **Type**: ``struct``
- **Members**:
    - ``cnt``: Stores the number of votes currently in the tower.
    - ``votes``: An array of `fd_voter_vote_old_t` structures, each representing a vote, with a maximum of 31 votes.
- **Description**: Represents a voter's tower, which is a collection of votes. The structure is packed to ensure no padding between its members, optimizing memory usage. The `cnt` field indicates how many votes are currently stored in the `votes` array, which can hold up to 31 votes of type `fd_voter_vote_old_t`. This structure is used to manage and access the votes associated with a voter in a serialized format.


---
### fd\_voter\_tower\_t
- **Type**: ``struct``
- **Members**:
    - `cnt`: Stores the number of votes in the voter's tower.
    - `votes`: An array of `fd_voter_vote_old_t` structures representing the votes, with a maximum of 31 entries.
- **Description**: Represents a voter's tower, which is a collection of votes cast by the voter. The structure is packed to ensure a compact memory layout, and it includes a count of the votes and an array to store the votes themselves. The `votes` array can hold up to 31 votes, and each vote is represented by the `fd_voter_vote_old_t` structure, which includes information about the slot and confirmation count of each vote.


---
### fd\_voter\_footer
- **Type**: ``struct``
- **Members**:
    - ``some``: Indicates the presence of a root value, where 0 means None and 1 means Some.
    - ``root``: Stores the root value as an unsigned long integer.
- **Description**: Defines a packed structure with two fields: `some`, which is a flag indicating whether a root value is present, and `root`, which holds the actual root value if present. This structure is used to represent the footer of a voter, likely in a serialized form, where the presence of a root is optional.


# Functions

---
### fd\_voter\_state\_cnt<!-- {{#callable:fd_voter_state_cnt}} -->
[View Source →](<../../../../../src/choreo/voter/fd_voter.h#L288>)

Returns the number of votes in the voter's tower based on the version of the voter's state.
- **Inputs**:
    - `state`: A pointer to a `fd_voter_state_t` structure representing the voter's state.
- **Logic and Control Flow**:
    - Check if `state->kind` is `FD_VOTER_STATE_V0_23_5`; if true, return `state->v0_23_5.cnt`.
    - Check if `state->kind` is `FD_VOTER_STATE_V1_14_11`; if true, return `state->v1_14_11.cnt`.
    - If neither condition is met, return `state->cnt`.
- **Output**: The function returns an `ulong` representing the number of votes in the voter's tower.


---
### fd\_voter\_root\_laddr<!-- {{#callable:fd_voter_root_laddr}} -->
[View Source →](<../../../../../src/choreo/voter/fd_voter.h#L298>)

Returns a pointer to the voter's root in the bincode-serialized vote state.
- **Inputs**:
    - `state`: A pointer to a constant `fd_voter_state_t` structure representing the voter's state.
- **Logic and Control Flow**:
    - Call [`fd_voter_state_cnt`](<#fd_voter_state_cnt>) to get the number of votes in the voter's tower and store it in `cnt`.
    - If `cnt` is zero, return `NULL`.
    - Initialize `root` to `NULL`.
    - Check the `kind` of the `state` and set `root` to point to the appropriate vote array element based on `cnt`.
    - Use `FD_TEST` to verify the `root` pointer is valid.
    - Return the `root` pointer.
- **Output**: A pointer to the voter's root in the serialized vote state, or `NULL` if there are no votes.
- **Functions Called**:
    - [`fd_voter_state_cnt`](<#fd_voter_state_cnt>)


---
### fd\_voter\_state\_vote<!-- {{#callable:fd_voter_state_vote}} -->
[View Source →](<../../../../../src/choreo/voter/fd_voter.h#L327>)

Returns the most recent vote slot from a voter's state.
- **Inputs**:
    - `state`: A pointer to a `fd_voter_state_t` structure representing the voter's state.
- **Logic and Control Flow**:
    - Call [`fd_voter_state_cnt`](<#fd_voter_state_cnt>) to get the number of votes in the voter's state and store it in `cnt`.
    - Check if `cnt` is zero using `FD_UNLIKELY`; if true, return `FD_SLOT_NULL`.
    - Check if `state->kind` is `FD_VOTER_STATE_V0_23_5` using `FD_UNLIKELY`; if true, return the slot of the last vote in `state->v0_23_5.votes`.
    - Check if `state->kind` is `FD_VOTER_STATE_V1_14_11` using `FD_UNLIKELY`; if true, return the slot of the last vote in `state->v1_14_11.votes`.
    - If none of the above conditions are met, return the slot of the last vote in `state->votes`.
- **Output**: The slot of the most recent vote as an `ulong`, or `FD_SLOT_NULL` if there are no votes.
- **Functions Called**:
    - [`fd_voter_state_cnt`](<#fd_voter_state_cnt>)


---
### fd\_voter\_root\_slot<!-- {{#callable:fd_voter_root_slot}} -->
[View Source →](<../../../../../src/choreo/voter/fd_voter.h#L340>)

Retrieves the root slot from a voter's state, returning a null slot if the root is not set.
- **Inputs**:
    - `state`: A pointer to a constant `fd_voter_state_t` structure representing the voter's state.
- **Logic and Control Flow**:
    - Call [`fd_voter_root_laddr`](<#fd_voter_root_laddr>) with `state` to get the address of the root slot.
    - Check if the root slot is set by dereferencing the first byte at the root address.
    - If the first byte is non-zero, return the ulong value located after the first byte, indicating the root slot is set.
    - If the first byte is zero, return `FD_SLOT_NULL`, indicating the root slot is not set.
- **Output**: Returns an `ulong` representing the root slot if set, or `FD_SLOT_NULL` if not set.
- **Functions Called**:
    - [`fd_voter_root_laddr`](<#fd_voter_root_laddr>)


# Function Declarations (Public API)

---
### fd\_voter\_state<!-- {{#callable_declaration:fd_voter_state}} -->
[View Source →](<../../../../../src/choreo/voter/fd_voter.h#L320>)

Return a pointer to the start of the voter's state.
- **Description**: Use this function to obtain a pointer to the voter's state from a given transaction and record. It assumes that the `key` parameter is a valid vote account address and that the record is a voter's state. The function will update the provided Funk query with the version at the time of querying. After using this function, call `fd_funk_rec_query_test` to verify that the record has not been modified. If `key` does not point to a valid vote account, the behavior is undefined.
- **Inputs**:
    - `funk`: A pointer to a constant `fd_funk_t` structure. It represents the Funk context for the query. The caller must ensure this pointer is valid.
    - `rec`: A pointer to a constant `fd_funk_rec_t` structure. It represents the record to query. The caller must ensure this pointer is valid.
- **Output**: A pointer to a constant `fd_voter_state_t` structure representing the start of the voter's state.
- **See Also**: [`fd_voter_state`](<#fd_voter_state>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)