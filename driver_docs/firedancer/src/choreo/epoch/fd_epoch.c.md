<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for managing epoch data structures, including creation, joining, leaving, deletion, initialization, and finalization.

# Purpose
The code provides functionality for managing an epoch in a distributed system, specifically handling memory allocation and initialization for epoch-related data structures. It includes functions to create, join, leave, delete, initialize, and finalize an epoch. The [`fd_epoch_new`](<#fd_epoch_new>) function allocates and initializes memory for a new epoch, ensuring that the provided shared memory is correctly aligned and part of a workspace. It sets up the epoch's data structures, including voters, and assigns initial values to various fields. The [`fd_epoch_join`](<#fd_epoch_join>) function allows a process to join an existing epoch, verifying the integrity of the epoch through checks such as alignment and a magic number.

The code also includes functions for managing the lifecycle of an epoch. The [`fd_epoch_leave`](<#fd_epoch_leave>) and [`fd_epoch_delete`](<#fd_epoch_delete>) functions handle the disassociation of a process from an epoch and the deletion of an epoch, respectively, with checks for null pointers and alignment. The [`fd_epoch_init`](<#fd_epoch_init>) function initializes an epoch with a range of slots and a set of vote accounts, setting up voter data structures and calculating the total stake. The [`fd_epoch_fini`](<#fd_epoch_fini>) function clears the epoch's voter data and resets the total stake. The code is designed to be part of a larger system, likely involving distributed consensus or voting mechanisms, and relies on external functions and data structures such as `fd_wksp_t`, `fd_vote_states_t`, and `fd_voter_t`.
# Imports and Dependencies

---
- `fd_epoch.h`


# Functions

---
### fd\_epoch\_new<!-- {{#callable:fd_epoch_new}} -->
[View Source →](<../../../../../src/choreo/epoch/fd_epoch.c#L3>)

Initializes a new epoch structure in shared memory with specified voter capacity.
- **Inputs**:
    - `shmem`: A pointer to the shared memory where the epoch structure will be initialized.
    - `voter_max`: The maximum number of voters that the epoch can accommodate.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL; if so, log a warning and return NULL.
    - Check if `shmem` is aligned according to [`fd_epoch_align`](<fd_epoch.h.md#fd_epoch_align>); if not, log a warning and return NULL.
    - Calculate the memory footprint required for the epoch using [`fd_epoch_footprint`](<fd_epoch.h.md#fd_epoch_footprint>); if zero, log a warning and return NULL.
    - Verify that `shmem` is part of a workspace using `fd_wksp_containing`; if not, log a warning and return NULL.
    - Clear the memory at `shmem` with the calculated footprint using `fd_memset`.
    - Determine the number of slots needed for voters using `fd_ulong_find_msb` and `fd_ulong_pow2_up`.
    - Initialize scratch allocation with `FD_SCRATCH_ALLOC_INIT`.
    - Allocate memory for the epoch structure and voters using `FD_SCRATCH_ALLOC_APPEND`.
    - Finalize the scratch allocation and verify the allocation size with `FD_SCRATCH_ALLOC_FINI`.
    - Set the `voters_gaddr` and `epoch_gaddr` fields of the epoch structure using `fd_wksp_gaddr_fast`.
    - Initialize the `total_stake`, `first_slot`, and `last_slot` fields of the epoch structure.
    - Use memory fences `FD_COMPILER_MFENCE` to ensure memory operations are complete before setting `epoch->magic`.
    - Set the `magic` field of the epoch structure to `FD_EPOCH_MAGIC`.
- **Output**: Returns the pointer to the shared memory (`shmem`) if successful, or NULL if any checks fail.
- **Functions Called**:
    - [`fd_epoch_align`](<fd_epoch.h.md#fd_epoch_align>)
    - [`fd_epoch_footprint`](<fd_epoch.h.md#fd_epoch_footprint>)


---
### fd\_epoch\_join<!-- {{#callable:fd_epoch_join}} -->
[View Source →](<../../../../../src/choreo/epoch/fd_epoch.c#L49>)

Validates and returns a pointer to an `fd_epoch_t` structure if it meets certain conditions.
- **Inputs**:
    - `shepoch`: A pointer to a memory location that is expected to be an `fd_epoch_t` structure.
- **Logic and Control Flow**:
    - Cast `shepoch` to an `fd_epoch_t` pointer and assign it to `epoch`.
    - Check if `epoch` is NULL; if true, log a warning and return NULL.
    - Check if `epoch` is aligned according to `fd_epoch_align()`; if not, log a warning and return NULL.
    - Retrieve the workspace containing `epoch` using `fd_wksp_containing`; if NULL, log a warning and return NULL.
    - Check if `epoch->magic` equals `FD_EPOCH_MAGIC`; if not, log a warning and return NULL.
    - Return the `epoch` pointer.
- **Output**: A pointer to the `fd_epoch_t` structure if all checks pass, otherwise NULL.
- **Functions Called**:
    - [`fd_epoch_align`](<fd_epoch.h.md#fd_epoch_align>)


---
### fd\_epoch\_leave<!-- {{#callable:fd_epoch_leave}} -->
[View Source →](<../../../../../src/choreo/epoch/fd_epoch.c#L77>)

Returns the input `epoch` pointer if it is not NULL, otherwise logs a warning and returns NULL.
- **Inputs**:
    - `epoch`: A constant pointer to an `fd_epoch_t` structure, representing the epoch to leave.
- **Logic and Control Flow**:
    - Check if the `epoch` pointer is NULL using `FD_UNLIKELY`.
    - If `epoch` is NULL, log a warning message 'NULL epoch' and return NULL.
    - If `epoch` is not NULL, cast it to a `void *` and return it.
- **Output**: A `void *` pointer to the `epoch` if it is not NULL, otherwise NULL.


---
### fd\_epoch\_delete<!-- {{#callable:fd_epoch_delete}} -->
[View Source →](<../../../../../src/choreo/epoch/fd_epoch.c#L88>)

Validates the input `epoch` pointer for nullity and alignment, then returns it.
- **Inputs**:
    - `epoch`: A pointer to the epoch object to be deleted.
- **Logic and Control Flow**:
    - Check if `epoch` is NULL; if true, log a warning and return NULL.
    - Check if `epoch` is not aligned according to `fd_epoch_align()`; if true, log a warning and return NULL.
    - Return the `epoch` pointer.
- **Output**: Returns the `epoch` pointer if it is valid, otherwise returns NULL.
- **Functions Called**:
    - [`fd_epoch_align`](<fd_epoch.h.md#fd_epoch_align>)


---
### fd\_epoch\_init<!-- {{#callable:fd_epoch_init}} -->
[View Source →](<../../../../../src/choreo/epoch/fd_epoch.c#L104>)

Initializes an epoch with specified start and stop slots and populates it with voter information from vote accounts.
- **Inputs**:
    - `epoch`: A pointer to an `fd_epoch_t` structure that will be initialized.
    - `eah_start_slot`: An unsigned long integer representing the starting slot of the epoch.
    - `eah_stop_slot`: An unsigned long integer representing the stopping slot of the epoch.
    - `vote_accounts`: A constant pointer to an `fd_vote_states_t` structure containing vote account information.
- **Logic and Control Flow**:
    - Set `epoch->first_slot` to `eah_start_slot` and `epoch->last_slot` to `eah_stop_slot`.
    - Retrieve the epoch voters using `fd_epoch_voters(epoch)`.
    - Initialize a vote states iterator with `fd_vote_states_iter_init`.
    - Iterate over the vote accounts using the iterator until `fd_vote_states_iter_done` returns true.
    - For each vote state, check if the stake is greater than 0.
    - If the stake is greater than 0, insert the vote account into the epoch voters using `fd_epoch_voters_insert`.
    - Set the voter's stake and initialize its vote slots to `FD_SLOT_NULL`.
    - Accumulate the total stake in `epoch->total_stake`.
- **Output**: No return value; the function modifies the `epoch` structure in place.
- **Functions Called**:
    - [`fd_epoch_voters`](<fd_epoch.h.md#fd_epoch_voters>)


---
### fd\_epoch\_fini<!-- {{#callable:fd_epoch_fini}} -->
[View Source →](<../../../../../src/choreo/epoch/fd_epoch.c#L142>)

Finalizes an epoch by clearing its voters and resetting the total stake to zero.
- **Inputs**:
    - `epoch`: A pointer to an `fd_epoch_t` structure representing the epoch to finalize.
- **Logic and Control Flow**:
    - Calls [`fd_epoch_voters`](<fd_epoch.h.md#fd_epoch_voters>) to get the voters associated with the `epoch`.
    - Calls `fd_epoch_voters_clear` to clear the voters of the `epoch`.
    - Sets the `total_stake` of the `epoch` to 0UL.
- **Output**: This function does not return a value.
- **Functions Called**:
    - [`fd_epoch_voters`](<fd_epoch.h.md#fd_epoch_voters>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)