<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines structures and functions for managing epochs, including memory management and voter handling.

# Purpose
The code defines a C header file for managing epochs in a distributed system, specifically within the context of a choreographed process. It provides structures and functions to handle the lifecycle of an epoch, which includes initialization, joining, leaving, and deletion of epochs. The `fd_epoch` structure is central to this file, encapsulating metadata such as the epoch's magic number, global address, total stake, and slot range. The file also includes a dynamic map for managing voters within an epoch, keyed by public keys.

The header file defines several functions for epoch management. These include [`fd_epoch_new`](<#fd_epoch_new>) for formatting memory for a new epoch, [`fd_epoch_join`](<#fd_epoch_join>) and [`fd_epoch_leave`](<#fd_epoch_leave>) for managing participation in an epoch, and [`fd_epoch_delete`](<#fd_epoch_delete>) for unformatting an epoch's memory. Additionally, [`fd_epoch_init`](<#fd_epoch_init>) and [`fd_epoch_fini`](<#fd_epoch_fini>) are used to initialize and finalize an epoch, respectively. The file also provides utility functions to calculate memory alignment and footprint requirements for epochs. The use of macros and inline functions ensures efficient memory management and access to epoch-related data.
# Imports and Dependencies

---
- `../fd_choreo_base.h`
- `../voter/fd_voter.h`
- `../../flamenco/stakes/fd_vote_states.h`
- `../../util/tmpl/fd_map_dynamic.c`


# Data Structures

---
### fd\_epoch
- **Type**: ``struct fd_epoch``
- **Members**:
    - `magic`: A unique identifier for the epoch, expected to be equal to `FD_EPOCH_MAGIC`.
    - `epoch_gaddr`: The global address of the epoch in the backing workspace, which must be non-zero.
    - `total_stake`: The total amount of stake in the epoch.
    - `first_slot`: The first slot number in the epoch.
    - `last_slot`: The last slot number in the epoch.
    - `voters_gaddr`: The global address of a `fd_map_dynamic` containing all voters in the current epoch, keyed by public key.
- **Description**: Defines an epoch in a distributed system, containing metadata such as a unique identifier, global address, total stake, and slot range. It also includes a reference to a dynamic map of voters, which is essential for managing voting processes within the epoch.


---
### fd\_epoch\_t
- **Type**: ``struct fd_epoch``
- **Members**:
    - `magic`: A unique identifier for the epoch, set to `FD_EPOCH_MAGIC`.
    - `epoch_gaddr`: The global address of the epoch in the backing workspace.
    - `total_stake`: The total amount of stake in the epoch.
    - `first_slot`: The first slot in the epoch.
    - `last_slot`: The last slot in the epoch.
    - `voters_gaddr`: The global address of a dynamic map containing all voters in the epoch, keyed by public key.
- **Description**: Defines an epoch in a distributed system, containing metadata such as the total stake, slot range, and a reference to voter data. The structure is aligned to 128 bytes and includes a magic number for validation, as well as global addresses for memory management.


# Functions

---
### fd\_epoch\_align<!-- {{#callable:fd_epoch_align}} -->
[View Source →](<../../../../../src/choreo/epoch/fd_epoch.h#L46>)

Returns the alignment requirement for the `fd_epoch_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `alignof` to determine the alignment requirement of the `fd_epoch_t` structure.
    - Returns the result of the `alignof` operation.
- **Output**: The function returns an `ulong` representing the alignment requirement of the `fd_epoch_t` structure.


---
### fd\_epoch\_footprint<!-- {{#callable:fd_epoch_footprint}} -->
[View Source →](<../../../../../src/choreo/epoch/fd_epoch.h#L51>)

Calculates the memory footprint required for an epoch based on the maximum number of voters.
- **Inputs**:
    - `voter_max`: The maximum number of voters expected in the epoch.
- **Logic and Control Flow**:
    - Calculate `lg_slot_cnt` as the most significant bit of the smallest power of two greater than or equal to `voter_max`, plus 2.
    - Use `FD_LAYOUT_INIT` to start the memory layout process.
    - Append the alignment and size of `fd_epoch_t` to the layout using `FD_LAYOUT_APPEND`.
    - Append the alignment and footprint of the voter map using `fd_epoch_voters_align` and `fd_epoch_voters_footprint(lg_slot_cnt)`.
    - Finalize the layout with `FD_LAYOUT_FINI` using the alignment of `fd_epoch_t`.
- **Output**: Returns the total memory footprint required for the epoch, including the voter map.
- **Functions Called**:
    - [`fd_epoch_align`](<#fd_epoch_align>)


---
### fd\_epoch\_wksp<!-- {{#callable:fd_epoch_wksp}} -->
[View Source →](<../../../../../src/choreo/epoch/fd_epoch.h#L118>)

Calculates the local workspace pointer for a given epoch.
- **Inputs**:
    - `epoch`: A pointer to a constant `fd_epoch_t` structure representing the epoch.
- **Logic and Control Flow**:
    - Subtracts the `epoch_gaddr` from the memory address of the `epoch` to calculate the local workspace address.
    - Casts the result to a `fd_wksp_t` pointer.
- **Output**: A pointer to `fd_wksp_t`, representing the local workspace backing the epoch.


---
### fd\_epoch\_voters<!-- {{#callable:fd_epoch_voters}} -->
[View Source →](<../../../../../src/choreo/epoch/fd_epoch.h#L123>)

Retrieves the local address of the voters map for a given epoch.
- **Inputs**:
    - `epoch`: A pointer to an `fd_epoch_t` structure representing the epoch for which to retrieve the voters map.
- **Logic and Control Flow**:
    - Call [`fd_epoch_wksp`](<#fd_epoch_wksp>) with `epoch` to get the workspace backing the epoch.
    - Call `fd_wksp_laddr_fast` with the workspace and `epoch->voters_gaddr` to get the local address of the voters map.
- **Output**: A pointer to `fd_voter_t`, representing the local address of the voters map for the specified epoch.
- **Functions Called**:
    - [`fd_epoch_wksp`](<#fd_epoch_wksp>)


---
### fd\_epoch\_voters\_const<!-- {{#callable:fd_epoch_voters_const}} -->
[View Source →](<../../../../../src/choreo/epoch/fd_epoch.h#L128>)

Returns a constant pointer to the voters in the specified epoch.
- **Inputs**:
    - `epoch`: A constant pointer to an `fd_epoch_t` structure representing the epoch.
- **Logic and Control Flow**:
    - Call [`fd_epoch_wksp`](<#fd_epoch_wksp>) with `epoch` to get the workspace backing the epoch.
    - Call `fd_wksp_laddr_fast` with the workspace and `epoch->voters_gaddr` to get the local address of the voters.
    - Return the local address as a constant pointer to `fd_voter_t`.
- **Output**: A constant pointer to `fd_voter_t`, representing the voters in the specified epoch.
- **Functions Called**:
    - [`fd_epoch_wksp`](<#fd_epoch_wksp>)


# Function Declarations (Public API)

---
### fd\_epoch\_new<!-- {{#callable_declaration:fd_epoch_new}} -->
[View Source →](<../../../../../src/choreo/epoch/fd_epoch.h#L67>)

Formats a memory region for use as an epoch.
- **Description**: Use this function to prepare a memory region for use as an epoch. The memory region must be non-null, properly aligned, and have sufficient size to accommodate the epoch structure and its voters. This function initializes the memory region and sets up the necessary structures for managing voters within the epoch. It is important to ensure that the memory region is part of a workspace before calling this function. If any preconditions are not met, the function will return null and log a warning.
- **Inputs**:
    - `shmem`: A pointer to the memory region to format as an epoch. Must not be null and must be aligned according to `fd_epoch_align()`. The memory must be part of a workspace.
    - `voter_max`: The maximum number of voters the epoch can accommodate. Must be a positive number.
- **Output**: Returns a pointer to the formatted memory region on success, or null if the input is invalid or preconditions are not met.
- **See Also**: [`fd_epoch_new`](<fd_epoch.c.md#fd_epoch_new>)  (Implementation)


---
### fd\_epoch\_join<!-- {{#callable_declaration:fd_epoch_join}} -->
[View Source →](<../../../../../src/choreo/epoch/fd_epoch.h#L76>)

Joins the caller to an epoch.
- **Description**: Use this function to join the caller to an epoch, which is a memory region formatted for use as an epoch. This function checks if the provided pointer is valid, aligned, part of a workspace, and has the correct magic number. If any of these checks fail, the function logs a warning and returns NULL. Ensure that the memory region is correctly formatted and aligned before calling this function.
- **Inputs**:
    - `shepoch`: A pointer to the memory region representing the epoch. Must not be NULL, must be aligned according to `fd_epoch_align()`, and must be part of a workspace. The memory region must have the correct magic number (`FD_EPOCH_MAGIC`).
- **Output**: Returns a pointer to the epoch in the local address space on success, or NULL if the input is invalid or checks fail.
- **See Also**: [`fd_epoch_join`](<fd_epoch.c.md#fd_epoch_join>)  (Implementation)


---
### fd\_epoch\_leave<!-- {{#callable_declaration:fd_epoch_leave}} -->
[View Source →](<../../../../../src/choreo/epoch/fd_epoch.h#L83>)

Leaves a current local join to an epoch.
- **Description**: Use this function to leave a current local join to an epoch. It returns a pointer to the underlying shared memory region if successful. If the input is null, it logs a warning and returns null. This function is useful when you need to safely disconnect from an epoch and access the shared memory region.
- **Inputs**:
    - `epoch`: A pointer to a constant `fd_epoch_t` structure representing the epoch to leave. Must not be null. If null, the function logs a warning and returns null.
- **Output**: Returns a pointer to the underlying shared memory region on success, or null if the input is null.
- **See Also**: [`fd_epoch_leave`](<fd_epoch.c.md#fd_epoch_leave>)  (Implementation)


---
### fd\_epoch\_delete<!-- {{#callable_declaration:fd_epoch_delete}} -->
[View Source →](<../../../../../src/choreo/epoch/fd_epoch.h#L92>)

Unformats a memory region used as an epoch.
- **Description**: Use this function to unformat a memory region that was previously used as an epoch. It assumes that only the local process is joined to the region. This function transfers ownership of the memory region back to the caller. It returns a pointer to the underlying shared memory region or NULL if the input is invalid, such as when the input is not aligned or is NULL. This function logs details of any errors encountered.
- **Inputs**:
    - `epoch`: A pointer to the memory region used as an epoch. It must be aligned according to `fd_epoch_align()` and must not be NULL. If the pointer is NULL or misaligned, the function returns NULL and logs a warning.
- **Output**: Returns a pointer to the underlying shared memory region if successful, or NULL if the input is invalid.
- **See Also**: [`fd_epoch_delete`](<fd_epoch.c.md#fd_epoch_delete>)  (Implementation)


---
### fd\_epoch\_init<!-- {{#callable_declaration:fd_epoch_init}} -->
[View Source →](<../../../../../src/choreo/epoch/fd_epoch.h#L100>)

Initializes an epoch with vote states and slot range.
- **Description**: Use this function to set up an epoch with a specified range of slots and initialize it with vote states from the runtime bank. This function must be called once at the beginning of an epoch and assumes that the `epoch` is a valid local join that has not been previously initialized. It sets the first and last slots of the epoch and populates the epoch's voter list with accounts that have a positive stake. The total stake is accumulated from the provided vote accounts.
- **Inputs**:
    - `epoch`: A pointer to an `fd_epoch_t` structure that represents the epoch to initialize. Must not be null and must be a valid local join.
    - `eah_start_slot`: An unsigned long integer representing the first slot in the epoch. Must be a valid slot number.
    - `eah_stop_slot`: An unsigned long integer representing the last slot in the epoch. Must be a valid slot number and greater than or equal to `eah_start_slot`.
    - `vote_accounts`: A pointer to a `fd_vote_states_t` structure containing vote states. Must not be null and should contain valid vote account information with stakes.
- **Output**: None
- **See Also**: [`fd_epoch_init`](<fd_epoch.c.md#fd_epoch_init>)  (Implementation)


---
### fd\_epoch\_fini<!-- {{#callable_declaration:fd_epoch_fini}} -->
[View Source →](<../../../../../src/choreo/epoch/fd_epoch.h#L110>)

Finishes an epoch by clearing voters and resetting total stake.
- **Description**: Use this function to conclude an epoch that has been previously initialized. It clears all voters associated with the epoch and resets the total stake to zero. This function must be called only once at the end of an epoch and assumes that the epoch is a valid local join and has already been initialized.
- **Inputs**:
    - `epoch`: A pointer to a `fd_epoch_t` structure representing the epoch to finish. Must not be null and must point to a valid, initialized epoch.
- **Output**: None
- **See Also**: [`fd_epoch_fini`](<fd_epoch.c.md#fd_epoch_fini>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)