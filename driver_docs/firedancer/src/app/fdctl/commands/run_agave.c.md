<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements the "run-agave" command to start the Agave component of a Firedancer validator.

# Purpose
The code is a C source file that defines functionality for starting and managing the "Agave" component of a Firedancer validator. It includes several functions and macros to configure and execute the Agave process, which is part of a larger system for blockchain validation. The file imports various headers for network and tile utilities, and it defines a main function [`agave_main`](<#agave_main>) that initializes the Agave environment, sets up memory spaces, and configures process affinity. The [`agave_boot`](<#agave_boot>) function constructs command-line arguments for the Agave validator based on a configuration structure, handling network, consensus, ledger, gossip, RPC, and snapshot settings.

The file also defines a command function `run_agave_cmd_fn` that uses the `clone` system call to create a new process for running the Agave component in a separate PID namespace, ensuring isolation from other processes. The `fd_action_run_agave` structure provides metadata for this command, including its name, function pointer, and description. The code is intended to be part of a larger system, likely a blockchain validator, and it provides specific functionality for configuring and running a component within that system.
# Imports and Dependencies

---
- `../../shared/commands/run/run.h`
- `../../../util/net/fd_ip4.h`
- `../../../util/tile/fd_tile_private.h`
- `sched.h`
- `stdlib.h`
- `errno.h`
- `unistd.h`
- `pthread.h`
- `sys/wait.h`


# Global Variables

---
### fd\_log\_private\_shared\_lock
- **Type**: `int *`
- **Description**: `fd_log_private_shared_lock` is a pointer to an integer that is declared as an external variable. It is used to manage shared locking mechanisms in the logging system.
- **Use**: Used to control access to shared resources in the logging system, particularly in debugging scenarios.


---
### \_fd\_ext\_larger\_max\_cost\_per\_block
- **Type**: `int`
- **Description**: Stores the maximum cost per block for larger blocks in a development or benchmarking context.
- **Use**: Used to configure the maximum cost per block in development or benchmarking scenarios.


---
### \_fd\_ext\_larger\_shred\_limits\_per\_block
- **Type**: `int`
- **Description**: Stores the larger shred limits per block for the Firedancer validator in a consensus-breaking development-only context.
- **Use**: Used to configure the maximum number of shreds allowed per block in a development environment.


---
### \_fd\_ext\_disable\_status\_cache
- **Type**: `int`
- **Description**: Stores the status of whether the status cache is disabled in a consensus-breaking bench-only mode.
- **Use**: Used to determine if the status cache should be disabled during benchmarking.


---
### run\_agave\_cmd\_fn
- **Type**: `function`
- **Description**: Executes the Agave command function by setting up the logging thread and creating a new process using the `clone` system call. It uses the `agave_main` function as the entry point for the new process and applies specific namespace flags based on the configuration.
- **Use**: Used to initiate the Agave process within a new PID namespace if sandboxing is enabled.


---
### fd\_action\_run\_agave
- **Type**: ``action_t``
- **Description**: Defines an action structure for running the Agave component of a Firedancer validator. It includes the name of the action, a function pointer to execute the action, and a description of the action.
- **Use**: Used to initiate the Agave side of a Firedancer validator by executing the `run_agave_cmd_fn` function.


# Functions

---
### clone\_labs\_memory\_space\_tiles<!-- {{#callable:clone_labs_memory_space_tiles}} -->
[View Source →](<../../../../../../src/app/fdctl/commands/run_agave.c#L23>)

Preloads shared memory for Agave tiles and runs a single process with specific user and group IDs.
- **Inputs**:
    - ``config``: A pointer to a `config_t` structure that contains configuration data, including topology and workspace information.
- **Logic and Control Flow**:
    - Iterates over each workspace in the `config->topo.workspaces` array.
    - Checks the name of each workspace to determine the appropriate shared memory join mode.
    - Joins workspaces named 'pack_bank' or 'shred_store' in read-only mode using `fd_topo_join_workspace`.
    - Joins other specified workspaces in read-write mode using `fd_topo_join_workspace`.
    - Calls `fd_topo_run_single_process` to run a single process with the specified user ID (`config->uid`) and group ID (`config->gid`).
- **Output**: No return value; the function performs operations on shared memory and runs a process.


---
### fd\_ext\_larger\_max\_cost\_per\_block<!-- {{#callable:fd_ext_larger_max_cost_per_block}} -->
[View Source →](<../../../../../../src/app/fdctl/commands/run_agave.c#L50>)

Returns the value of the static variable `_fd_ext_larger_max_cost_per_block`.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the value of the static variable `_fd_ext_larger_max_cost_per_block`.
- **Output**: The function returns an integer value representing the current value of `_fd_ext_larger_max_cost_per_block`.


---
### fd\_ext\_larger\_shred\_limits\_per\_block<!-- {{#callable:fd_ext_larger_shred_limits_per_block}} -->
[View Source →](<../../../../../../src/app/fdctl/commands/run_agave.c#L51>)

Returns the value of the internal variable `_fd_ext_larger_shred_limits_per_block`.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the value of the internal variable `_fd_ext_larger_shred_limits_per_block`.
- **Output**: An integer representing the value of `_fd_ext_larger_shred_limits_per_block`.


---
### fd\_ext\_disable\_status\_cache<!-- {{#callable:fd_ext_disable_status_cache}} -->
[View Source →](<../../../../../../src/app/fdctl/commands/run_agave.c#L52>)

Returns the value of the `_fd_ext_disable_status_cache` variable.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the value of the static variable `_fd_ext_disable_status_cache`.
- **Output**: An integer representing the current value of `_fd_ext_disable_status_cache`.


---
### agave\_boot<!-- {{#callable:agave_boot}} -->
[View Source →](<../../../../../../src/app/fdctl/commands/run_agave.c#L54>)

Initializes and configures the Agave validator with command-line arguments based on the provided configuration, then executes the validator.
- **Inputs**:
    - `config`: A pointer to a `config_t` structure containing configuration settings for the Agave validator.
- **Logic and Control Flow**:
    - Initialize index `idx` and buffer index `bufidx` for argument storage.
    - Define macros `ADD1`, `ADD`, `ADDU`, and `ADDH` to simplify adding arguments to the `argv` array.
    - Add initial arguments `fdctl` and `--log` to `argv`.
    - Configure network settings by adding arguments based on `config->frankendancer.dynamic_port_range`, `config->net.bind_address`, and other network-related fields.
    - Configure consensus settings by adding arguments based on `config->paths.identity_key`, `config->frankendancer.consensus` fields, and other consensus-related fields.
    - Configure ledger settings by adding arguments based on `config->paths.ledger`, `config->frankendancer.ledger` fields, and other ledger-related fields.
    - Configure gossip settings by adding arguments based on `config->gossip.entrypoints`, `config->gossip.port`, and other gossip-related fields.
    - Configure RPC settings by adding arguments based on `config->rpc.port`, `config->frankendancer.rpc` fields, and other RPC-related fields.
    - Configure snapshot settings by adding arguments based on `config->frankendancer.snapshots` fields.
    - Determine the number of handler threads based on `config->frankendancer.layout.agave_unified_scheduler_handler_threads` and `config->topo.agave_affinity_cnt`, and add the corresponding argument.
    - Set the `SOLANA_METRICS_CONFIG` environment variable if specified in the configuration.
    - Log the constructed command-line arguments for the Agave validator.
    - Set CPU affinity for the process based on `config->topo.agave_affinity_cpu_idx`.
    - Set global variables `_fd_ext_larger_max_cost_per_block`, `_fd_ext_larger_shred_limits_per_block`, and `_fd_ext_disable_status_cache` based on `config->development.bench` fields.
    - Call `fd_ext_validator_main` with the constructed `argv` to execute the Agave validator.
- **Output**: No return value; the function executes the Agave validator process.


---
### agave\_main<!-- {{#callable:agave_main}} -->
[View Source →](<../../../../../../src/app/fdctl/commands/run_agave.c#L227>)

Initializes and boots the Agave process with specific configurations and handles debugging and memory space setup.
- **Inputs**:
    - `args`: A pointer to a `config_t` structure containing configuration settings for the Agave process.
- **Logic and Control Flow**:
    - Checks if debugging is enabled by examining `config->development.debug_tile` and handles debugger attachment or spin-waiting based on its value.
    - Calls [`clone_labs_memory_space_tiles`](<#clone_labs_memory_space_tiles>) to preload shared memory for Agave tiles.
    - Retrieves the current process ID using `fd_sandbox_getpid` and sets it for logging purposes.
    - Discovers the stack size and sets up the stack for the Agave process using `fd_log_private_stack_discover`.
    - Logs a notice indicating the booting of the Agave process with the current process ID.
    - Switches the user and group ID of the process to those specified in the configuration using `fd_sandbox_switch_uid_gid`.
    - Calls [`agave_boot`](<#agave_boot>) to start the Agave process with the given configuration.
- **Output**: Returns 0 upon successful execution.
- **Functions Called**:
    - [`clone_labs_memory_space_tiles`](<#clone_labs_memory_space_tiles>)
    - [`agave_boot`](<#agave_boot>)


# Function Declarations (Public API)

---
### fdctl\_tile\_run<!-- {{#callable_declaration:fdctl_tile_run}} -->
[View Source →](<../../../../../../src/app/fdctl/commands/run_agave.c#L16>)

Retrieves a tile configuration by name.
- **Description**: Use this function to find and retrieve a tile configuration from a predefined list of tiles by matching the tile's name. This function is useful when you need to access specific tile configurations based on their names. It is important to ensure that the tile name provided exists in the list; otherwise, an error is logged, and a default-initialized tile configuration is returned.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure that contains the name of the tile to search for. The pointer must not be null, and the `name` field within the structure must be a valid string. If the name does not match any tile in the list, an error is logged.
- **Output**: Returns a `fd_topo_run_tile_t` structure corresponding to the tile with the matching name. If no match is found, a default-initialized `fd_topo_run_tile_t` is returned.
- **See Also**: [`fdctl_tile_run`](<../../shared/boot/fd_boot.c.md#fdctl_tile_run>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)