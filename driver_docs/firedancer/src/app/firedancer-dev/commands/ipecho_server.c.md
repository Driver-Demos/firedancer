<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements an IP echo server with configuration, permission checks, and metrics monitoring.

# Purpose
The code defines a server application named `ipecho-server`, which is part of a larger system involving network topology and metrics management. The primary function of this code is to configure and run a network topology for the `ipecho` service, which appears to handle network connections and monitor metrics related to these connections. The code includes functions to set up the topology ([`ipecho_topo`](<#ipecho_topo>)), configure permissions (`ipecho_server_cmd_perm`), and execute the server command ([`ipecho_server_cmd_fn`](<#ipecho_server_cmd_fn>)). The [`ipecho_topo`](<#ipecho_topo>) function initializes the topology with specific parameters, such as the bind address and port, and sets up the necessary links and tiles for the service.

The code also defines an action structure `fd_action_ipecho_server`, which includes function pointers for permission checking, execution, and topology configuration. The [`ipecho_server_cmd_fn`](<#ipecho_server_cmd_fn>) function is responsible for initializing the server, joining shared memory workspaces, and running the server in a single process mode. It continuously monitors connection metrics, logging changes in connection counts and closed connections. The code relies on external libraries and headers for configuration and execution, indicating that it is part of a modular system designed to manage network services and their associated metrics.
# Imports and Dependencies

---
- `../../shared/commands/configure/configure.h`
- `../../shared/commands/run/run.h`
- `../../../disco/metrics/fd_metrics.h`
- `../../../disco/topo/fd_topob.h`
- `time.h`
- `stdio.h`
- `unistd.h`


# Global Variables

---
### CALLBACKS
- **Type**: `fd_topo_obj_callbacks_t *`
- **Description**: An array of pointers to `fd_topo_obj_callbacks_t` structures. These structures likely contain callback functions or methods related to topology objects.
- **Use**: Used to pass callback functions to the `fd_topob_finish` function for topology finalization.


---
### fd\_log\_private\_shared\_lock
- **Type**: `int *`
- **Description**: A pointer to an integer that is declared as an external variable. It is used to manage shared locking mechanisms in the logging system.
- **Use**: Used to control access to shared resources in the logging system by acting as a lock.


---
### ipecho\_server\_cmd\_perm
- **Type**: `function`
- **Description**: Defines the permissions for the ipecho server command by configuring and running permission checks.
- **Use**: Used to set up and verify permissions for the ipecho server command execution.


---
### fd\_action\_ipecho\_server
- **Type**: ``action_t``
- **Description**: Defines an action for the IP echo server with specific properties and functions. It includes the name of the action, permission function, execution function, and topology function.
- **Use**: Used to configure and execute the IP echo server action within the system.


# Functions

---
### ipecho\_topo<!-- {{#callable:ipecho_topo}} -->
[View Source →](<../../../../../../src/app/firedancer-dev/commands/ipecho_server.c#L18>)

Initializes and configures a network topology for an IP echo server.
- **Inputs**:
    - ``topo``: A pointer to an `fd_topo_t` structure that represents the network topology to configure.
    - ``name``: A constant character pointer representing the name of the topology.
- **Logic and Control Flow**:
    - Calls `fd_topob_new` to initialize a new topology with the given name.
    - Sets the `max_page_size` of the topology to 2^21 bytes.
    - Creates a workspace for the topology using `fd_topob_wksp`.
    - Establishes a link named `ipecho_out` with specific parameters using `fd_topob_link`.
    - Sets the `permit_no_consumers` flag of the link to 1, allowing no consumers.
    - Creates a tile named `ipecho` with specific parameters using `fd_topob_tile`.
    - Configures the tile's `ipecho` settings, including `expected_shred_version`, `entrypoints_cnt`, `bind_address`, and `bind_port`.
    - Defines the tile's output link using `fd_topob_tile_out`.
    - Automatically arranges the layout of the topology with `fd_topob_auto_layout`.
    - Finalizes the topology setup with `fd_topob_finish`, using `CALLBACKS`.
- **Output**: No return value; the function modifies the `topo` structure in place.


---
### ipecho\_server\_cmd\_topo<!-- {{#callable:ipecho_server_cmd_topo}} -->
[View Source →](<../../../../../../src/app/firedancer-dev/commands/ipecho_server.c#L40>)

Initializes the topology for the ipecho server using the provided configuration.
- **Inputs**:
    - `config`: A pointer to a `config_t` structure that contains the configuration data, including the topology and name.
- **Logic and Control Flow**:
    - Calls the [`ipecho_topo`](<#ipecho_topo>) function with the `topo` and `name` fields from the `config` structure.
- **Output**: No return value; the function modifies the topology within the `config` structure.
- **Functions Called**:
    - [`ipecho_topo`](<#ipecho_topo>)


---
### configure\_args<!-- {{#callable:configure_args}} -->
[View Source →](<../../../../../../src/app/firedancer-dev/commands/ipecho_server.c#L45>)

Initializes and returns an `args_t` structure with a specific command and configuration stages.
- **Inputs**: None
- **Logic and Control Flow**:
    - Declare and initialize an `args_t` variable named `args` with the `configure.command` field set to `CONFIGURE_CMD_INIT`.
    - Initialize a `ulong` variable `stage_idx` to 0.
    - Assign the address of `fd_cfg_stage_hugetlbfs` to the first element of `args.configure.stages` and increment `stage_idx`.
    - Assign `NULL` to the next element of `args.configure.stages` to mark the end of the stages.
    - Return the `args` structure.
- **Output**: Returns an `args_t` structure with initialized command and stages.


---
### ipecho\_server\_cmd\_fn<!-- {{#callable:ipecho_server_cmd_fn}} -->
[View Source →](<../../../../../../src/app/firedancer-dev/commands/ipecho_server.c#L67>)

Initializes and runs the ipecho server command, monitoring connection metrics and logging changes.
- **Inputs**:
    - `args`: Pointer to `args_t` structure, but it is not used in this function.
    - `config`: Pointer to `config_t` structure containing configuration data for the server.
- **Logic and Control Flow**:
    - Initialize command arguments using [`configure_args`](<#configure_args>) and call `configure_cmd_fn` with these arguments and the provided `config`.
    - Call `run_firedancer_init` to initialize the Firedancer environment with the given `config`.
    - Set the second element of `fd_log_private_shared_lock` to 0.
    - Join workspaces in the topology with read-write mode using `fd_topo_join_workspaces`.
    - Fill the topology with `fd_topo_fill`.
    - Find the tile index for 'ipecho' in the topology and retrieve its metrics using `fd_metrics_tile`.
    - Run a single process in the topology using `fd_topo_run_single_process`.
    - Find the tile index for 'ipecho' again and verify it is valid with `FD_TEST`.
    - Sleep for 1 second to allow the system to stabilize.
    - Enter an infinite loop to monitor connection metrics: `ipecho_conns`, `ipecho_closed_ok`, and `ipecho_closed_error`.
    - Log changes in connection metrics if they differ from the last recorded values.
    - Sleep for 1 millisecond between each iteration of the loop.
- **Output**: No return value; the function runs indefinitely, logging connection metrics.
- **Functions Called**:
    - [`configure_args`](<#configure_args>)


# Function Declarations (Public API)

---
### fdctl\_tile\_run<!-- {{#callable_declaration:fdctl_tile_run}} -->
[View Source →](<../../../../../../src/app/firedancer-dev/commands/ipecho_server.c#L15>)

Finds and returns a tile configuration by name.
- **Description**: Use this function to retrieve a tile configuration from a predefined list of tiles by matching the tile's name. This function is useful when you need to access specific tile configurations based on their names. It is important to ensure that the tile name provided exists in the list; otherwise, the function logs an error and returns a default-initialized tile configuration. This function does not modify the input tile or any global state.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure that contains the name of the tile to find. The pointer must not be null, and the `name` field within the structure must be a valid string. The caller retains ownership of the tile.
- **Output**: Returns a `fd_topo_run_tile_t` structure corresponding to the tile with the matching name. If no match is found, logs an error and returns a default-initialized `fd_topo_run_tile_t`.
- **See Also**: [`fdctl_tile_run`](<../../shared/boot/fd_boot.c.md#fdctl_tile_run>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)