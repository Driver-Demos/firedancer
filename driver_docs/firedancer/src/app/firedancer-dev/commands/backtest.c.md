<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a backtest command to simulate and reproduce the behavior of a replay tile using a smaller topology.

# Purpose
The code defines a backtest command for a system that simulates the behavior of a replay tile using a smaller topology. This topology is designed to replay shreds from a data source such as RocksDB and reproduce the behavior of a replay tile. The main components of this topology include the `backt` (backtest) tile, `replay` tile, and `exec` (executor) tiles. The code sets up various links and shared objects between these tiles to facilitate communication and data processing. The backtest command is part of a larger system that uses a modular approach to configure and run different components, as indicated by the inclusion of various headers and the use of configuration structures.

The code is structured to define a command within a larger application, as seen in the `fd_action_backtest` structure, which specifies the command's name, arguments, function, permissions, and topology setup. The [`backtest_topo`](<#backtest_topo>) function is responsible for configuring the topology, including setting up tiles and links, and managing shared memory objects. The code also includes functions for configuring command arguments, permissions, and execution, indicating that it is part of a command-line interface for managing and executing different system components. The use of external functions and structures suggests that this code is intended to be part of a larger application or library.
# Imports and Dependencies

---
- `../../firedancer/topology.h`
- `../../shared/commands/configure/configure.h`
- `../../shared/commands/run/run.h`
- `../../shared/commands/watch/watch.h`
- `../../shared/fd_config.h`
- `../../../disco/tiles.h`
- `../../../disco/topo/fd_topob.h`
- `../../../util/pod/fd_pod_format.h`
- `../../../discof/replay/fd_replay_tile.h`
- `../../../discof/restore/utils/fd_ssctrl.h`
- `../../../discof/restore/utils/fd_ssmsg.h`
- `../../../discof/tower/fd_tower_tile.h`
- `../../../discof/replay/fd_exec.h`
- `../../../ballet/lthash/fd_lthash.h`
- `../../../flamenco/runtime/context/fd_capture_ctx.h`
- `../../../disco/pack/fd_pack_cost.h`
- `../../../flamenco/progcache/fd_progcache_admin.h`
- `../main.h`
- `errno.h`
- `unistd.h`
- `fcntl.h`


# Global Variables

---
### CALLBACKS
- **Type**: ``fd_topo_obj_callbacks_t *``
- **Description**: An array of pointers to `fd_topo_obj_callbacks_t` structures. These structures likely contain callback functions or methods related to topology objects in the Firedancer system.
- **Use**: Used to store and manage callback functions for topology objects in the Firedancer system.


---
### fd\_log\_private\_shared\_lock
- **Type**: `int *`
- **Description**: `fd_log_private_shared_lock` is a pointer to an integer that is declared as an external variable. It is intended to be used for synchronization or locking purposes in a shared memory context.
- **Use**: Used to manage shared access to resources, likely in a multi-threaded or multi-process environment.


---
### backtest\_cmd\_perm
- **Type**: `function`
- **Description**: Executes permission checks and configuration for the backtest command.
- **Use**: Used to configure and run permission checks for the backtest command.


---
### backtest\_cmd\_fn
- **Type**: `function`
- **Description**: Implements the function to execute the backtest command, which sets up and runs the backtest topology using the provided configuration.
- **Use**: Used to configure and execute the backtest command within the software.


---
### fd\_action\_backtest
- **Type**: ``action_t``
- **Description**: Defines an action for the backtest command, which includes its name, arguments, function, permissions, and topology setup. This structure is used to configure and execute the backtest command within the system.
- **Use**: Used to encapsulate the configuration and execution details of the backtest command.


# Functions

---
### backtest\_topo<!-- {{#callable:backtest_topo}} -->
[View Source →](<../../../../../../src/app/firedancer-dev/commands/backtest.c#L43>)

Configures and sets up a topology for backtesting by initializing various tiles and links based on the provided configuration.
- **Inputs**:
    - `config`: A pointer to a `config_t` structure containing configuration settings for the topology.
- **Logic and Control Flow**:
    - Set `sandbox` to 0 and `no_clone` to 1 in `config->development`.
    - Retrieve `exec_tile_cnt` from `config->firedancer.layout.exec_tile_count`.
    - Determine `disable_snap_loader` based on `config->gossip.entrypoints_cnt` and `solcap_enabled` based on the length of `config->capture.solcap_capture`.
    - Create a new topology object `topo` using `fd_topob_new` and configure its `max_page_size` and `gigantic_page_threshold`.
    - Initialize a workspace for `metric_in`.
    - Add a backtest tile and a replay tile to the topology, incrementing `cpu_idx` for each.
    - Set up `funk_obj` and `progcache_obj` and associate them with the replay tile.
    - Add executor tiles to the topology based on `exec_tile_cnt`.
    - Conditionally add snapshot tiles or a genesis tile based on `disable_snap_loader`.
    - Set up links between backtest and replay tiles, including `shred_out`, `tower_out`, and `replay_out`.
    - Configure additional links and shared objects for replay and exec tiles, including `store_obj`, `banks_obj`, `bank_hash_cmp_obj`, and `txncache_obj`.
    - Configure each tile in the topology using `fd_topo_configure_tile`.
    - Finalize the topology setup with `fd_topob_finish`.
- **Output**: No return value; the function modifies the topology configuration in place.


---
### backtest\_cmd\_topo<!-- {{#callable:backtest_cmd_topo}} -->
[View Source →](<../../../../../../src/app/firedancer-dev/commands/backtest.c#L326>)

Calls the [`backtest_topo`](<#backtest_topo>) function with the provided configuration.
- **Inputs**:
    - ``config``: A pointer to a `config_t` structure that contains configuration settings for the backtest topology.
- **Logic and Control Flow**:
    - The function `backtest_cmd_topo` is defined as static, meaning it is limited to the file scope.
    - It takes a single argument, `config`, which is a pointer to a `config_t` structure.
    - The function calls [`backtest_topo`](<#backtest_topo>) with the `config` argument.
- **Output**: No output is returned as the function has a void return type.
- **Functions Called**:
    - [`backtest_topo`](<#backtest_topo>)


---
### configure\_args<!-- {{#callable:configure_args}} -->
[View Source →](<../../../../../../src/app/firedancer-dev/commands/backtest.c#L331>)

Initializes and returns an `args_t` structure with specific configuration stages for the `configure` command.
- **Inputs**: None
- **Logic and Control Flow**:
    - Declare and initialize an `args_t` variable named `args` with the `configure.command` field set to `CONFIGURE_CMD_INIT`.
    - Initialize a `ulong` variable `stage_idx` to 0.
    - Assign the address of `fd_cfg_stage_hugetlbfs` to `args.configure.stages[stage_idx++]`.
    - Assign the address of `fd_cfg_stage_snapshots` to `args.configure.stages[stage_idx++]`.
    - Assign `NULL` to `args.configure.stages[stage_idx++]` to mark the end of the stages array.
    - Return the `args` structure.
- **Output**: Returns an `args_t` structure with initialized configuration stages.


---
### backtest\_cmd\_args<!-- {{#callable:backtest_cmd_args}} -->
[View Source →](<../../../../../../src/app/firedancer-dev/commands/backtest.c#L345>)

Sets the `no_watch` field in the `backtest` structure of `args` based on the presence of the `--no-watch` command-line argument.
- **Inputs**:
    - `pargc`: A pointer to an integer representing the count of command-line arguments.
    - `pargv`: A pointer to an array of strings representing the command-line arguments.
    - `args`: A pointer to an `args_t` structure where the `no_watch` field in the `backtest` structure will be set.
- **Logic and Control Flow**:
    - Calls `fd_env_strip_cmdline_contains` with `pargc`, `pargv`, and the string `--no-watch` to check if the `--no-watch` argument is present in the command-line arguments.
    - Assigns the result of `fd_env_strip_cmdline_contains` to `args->backtest.no_watch`.
- **Output**: No direct output; modifies the `args` structure by setting the `no_watch` field.


# Function Declarations (Public API)

---
### fdctl\_tile\_run<!-- {{#callable_declaration:fdctl_tile_run}} -->
[View Source →](<../../../../../../src/app/firedancer-dev/commands/backtest.c#L41>)

Finds and returns a tile from a predefined list by name.
- **Description**: Use this function to search for a tile in a predefined list of tiles by its name. It is important to ensure that the `tile` parameter is not null and that the tile's name is correctly set. If the tile is found, the function returns a copy of the tile. If the tile is not found, an error is logged, and a default-initialized tile is returned. This function is useful when you need to retrieve a specific tile's configuration or state based on its name.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure representing the tile to find. The `name` field of this structure must be set to the name of the tile to search for. The pointer must not be null.
- **Output**: Returns a `fd_topo_run_tile_t` structure. If the tile is found, it returns a copy of the tile. If not found, it returns a default-initialized `fd_topo_run_tile_t`.
- **See Also**: [`fdctl_tile_run`](<../../shared/boot/fd_boot.c.md#fdctl_tile_run>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)