<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

A standalone application for profiling and executing repair operations in various network environments, with command-line argument parsing and topology management.

# Purpose
The code is a standalone C application designed to profile and manage a "repair" process within a network topology. It is capable of running in different environments such as mainnet, testnet, or a private cluster. The primary functionality of the code is to spawn a smaller topology for profiling the repair tile, which is a component of a larger network system. The code includes various components and functions to configure, run, and monitor the repair process, including setting up network links, managing CPU affinities, and handling command-line arguments for different operational modes.

The code defines several key components and functions. It includes a [`repair_topo`](<#repair_topo>) function that configures the network topology for the repair process, setting up various network links and tiles. The [`repair_cmd_args`](<#repair_cmd_args>) function processes command-line arguments to determine the mode of operation, such as metrics mode, tree mode, or profiler mode. The code also includes functions to print metrics and peer location latency, read IP tables, and manage terminal settings. The [`repair_cmd_fn`](<#repair_cmd_fn>) function serves as the main entry point, directing the flow based on the selected mode. The code is structured to be part of a larger system, with dependencies on external libraries and modules, and it defines public APIs for interaction with other components.
# Imports and Dependencies

---
- `../../../disco/net/fd_net_tile.h`
- `../../../disco/tiles.h`
- `../../../disco/topo/fd_topob.h`
- `../../../disco/topo/fd_cpu_topo.h`
- `../../../util/pod/fd_pod_format.h`
- `../../../util/tile/fd_tile_private.h`
- `../../firedancer/topology.h`
- `../../firedancer/topology.c`
- `../../shared/commands/configure/configure.h`
- `../../shared/commands/run/run.h`
- `../../shared/fd_config.h`
- `../../shared_dev/commands/dev.h`
- `../../../waltz/resolv/fd_io_readline.h`
- `../../shared/commands/monitor/helper.h`
- `../../../discof/repair/fd_repair_tile.c`
- `gossip.h`
- `core_subtopo.h`
- `unistd.h`
- `fcntl.h`
- `stdio.h`
- `termios.h`
- `errno.h`
- `../../../util/tmpl/fd_map.c`


# Global Variables

---
### location\_table\_mem
- **Type**: `uchar`
- **Description**: `location_table_mem` is a global array of unsigned characters (`uchar`) that is aligned to the alignment requirements of the `fd_location_info_t` structure. It is sized to hold `fd_location_info_t` structures for up to 65536 entries.
- **Use**: Stores memory for a table of `fd_location_info_t` structures, which map IP addresses to location information.


---
### termios\_backup
- **Type**: ``struct termios``
- **Description**: Stores a backup of the terminal settings for standard input. This structure is used to save the current terminal attributes so they can be restored later.
- **Use**: Used in the `restore_terminal` function to reset the terminal settings to their original state.


---
### fd\_log\_private\_shared\_lock
- **Type**: `int *`
- **Description**: A pointer to an integer that is declared as an external variable, indicating it is defined elsewhere in the program or in another module.
- **Use**: Used to access or modify a shared lock for logging purposes across different parts of the program.


---
### location\_table
- **Type**: ``fd_location_info_t *``
- **Description**: Points to a table of `fd_location_info_t` structures, which store IP address and location information.
- **Use**: Used to map IP addresses to their corresponding location information.


---
### peers\_copy
- **Type**: ``fd_pubkey_t[]``
- **Description**: An array of `fd_pubkey_t` elements, where `fd_pubkey_t` is a type representing a public key. The array size is defined by the constant `FD_ACTIVE_KEY_MAX`, which specifies the maximum number of active keys that can be stored.
- **Use**: Stores a copy of peer public keys for sorting and processing based on latency.


---
### fd\_action\_repair
- **Type**: ``action_t``
- **Description**: Defines an action named 'repair' with associated command arguments, function, and permissions. The `fd_action_repair` variable is an instance of the `action_t` structure, which includes fields for the action's name, arguments, function, and permissions.
- **Use**: Used to configure and execute the 'repair' command within the application.


# Data Structures

---
### fd\_location\_info
- **Type**: ``struct``
- **Members**:
    - ``ip4_addr``: Stores an IPv4 address as an unsigned long for map key convenience.
    - ``location``: Stores a location description as a character array with a maximum length of 128 characters.
- **Description**: The `fd_location_info` structure holds information about a network location, including an IPv4 address and a textual description of the location. This structure is used to map IP addresses to their corresponding locations, facilitating network operations that require location-based decisions or logging.


---
### fd\_location\_info\_t
- **Type**: ``struct``
- **Members**:
    - ``ip4_addr``: Stores the IPv4 address for map key convenience.
    - ``location``: Holds a string representing the location, with a maximum length of 128 characters.
- **Description**: `fd_location_info_t` is a structure that contains information about a network location, including an IPv4 address and a corresponding location string. It is used to map IP addresses to their respective locations, facilitating network operations that require geographical context.


# Functions

---
### restore\_terminal<!-- {{#callable:restore_terminal}} -->
[View Source →](<../../../../../../src/app/firedancer-dev/commands/repair.c#L51>)

Restores the terminal settings to their previous state using the `termios_backup` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `tcsetattr` with `STDIN_FILENO`, `TCSANOW`, and `&termios_backup` to restore terminal attributes.
- **Output**: No output is returned as the function is of type `void`.


---
### repair\_topo<!-- {{#callable:repair_topo}} -->
[View Source →](<../../../../../../src/app/firedancer-dev/commands/repair.c#L66>)

Configures and initializes a topology for profiling the repair tile in a Firedancer application.
- **Inputs**:
    - `config`: A pointer to a `config_t` structure containing configuration settings for the topology.
- **Logic and Control Flow**:
    - Calls `resolve_gossip_entrypoints` to resolve gossip entry points in the configuration.
    - Initializes various tile counts from the configuration, such as `net_tile_cnt`, `shred_tile_cnt`, `quic_tile_cnt`, `sign_tile_cnt`, and `gossvf_tile_cnt`.
    - Creates a new topology object using `fd_topob_new` and sets its `max_page_size` and `gigantic_page_threshold` based on the configuration.
    - Initializes arrays `tile_to_cpu` and `parsed_tile_to_cpu` to map tiles to CPU indices, with unassigned tiles set to float unless auto topology is enabled.
    - Checks if the CPU affinity settings in the configuration are consistent between `layout.affinity` and `development.bench.affinity`.
    - Initializes CPU topology using `fd_topo_cpus_init` and parses CPU affinity if not set to auto.
    - Configures core and gossip subtopologies using [`fd_core_subtopo`](<core_subtopo.h.md#fd_core_subtopo>) and `fd_gossip_subtopo`.
    - Sets up workspaces for various components like `net_shred`, `net_repair`, `net_quic`, etc., using `fd_topob_wksp`.
    - Defines links between components using `fd_topob_link` and `fd_topos_net_rx_link`, specifying parameters like depth, MTU, and burst size.
    - Configures tiles using `fd_topob_tile` and `fd_topob_tile_uses`, setting up shared workspace objects for FEC sets and other components.
    - Checks and logs errors or warnings if the CPU affinity does not match the number of tiles in the topology.
    - Finalizes the topology setup with `fd_topob_finish` and updates the configuration's topology with the new settings.
- **Output**: The function does not return a value; it modifies the `config` structure to set up the topology.
- **Functions Called**:
    - [`fd_core_subtopo`](<core_subtopo.h.md#fd_core_subtopo>)
    - [`fd_link_permit_no_producers`](<core_subtopo.h.md#fd_link_permit_no_producers>)
    - [`fd_link_permit_no_consumers`](<core_subtopo.h.md#fd_link_permit_no_consumers>)


---
### repair\_cmd\_args<!-- {{#callable:repair_cmd_args}} -->
[View Source →](<../../../../../../src/app/firedancer-dev/commands/repair.c#L307>)

Parses command-line arguments for the 'repair' command and configures the `args_t` structure based on the specified mode and paths.
- **Inputs**:
    - ``pargc``: A pointer to an integer representing the number of command-line arguments.
    - ``pargv``: A pointer to an array of strings representing the command-line arguments.
    - ``args``: A pointer to an `args_t` structure where the parsed arguments will be stored.
- **Logic and Control Flow**:
    - Checks if `*pargc` is zero and logs an error with usage instructions if true.
    - Extracts the `--manifest-path` argument from the command line using `fd_env_strip_cmdline_cstr` and stores it in `manifest_path`.
    - Checks if the `--metrics` argument is present; if so, sets `args->repair.metrics_only` to 1 and logs an error if `manifest_path` is also provided.
    - Checks if the `--tree` argument is present; if so, sets `args->repair.forest_only` to 1 and logs an error if `manifest_path` is also provided.
    - If neither `--metrics` nor `--tree` is present, appends `manifest_path` to `args->repair.manifest_path`.
    - Extracts the `--iptable-path` argument from the command line using `fd_env_strip_cmdline_cstr` and appends it to `args->repair.iptable_path` if present.
- **Output**: No return value; modifies the `args` structure in place.


---
### fmt\_count<!-- {{#callable:fmt_count}} -->
[View Source →](<../../../../../../src/app/firedancer-dev/commands/repair.c#L339>)

Formats a given count into a human-readable string representation with appropriate units (e.g., K for thousands, M for millions).
- **Inputs**:
    - `buf`: A character buffer with a minimum size of 64 to store the formatted string.
    - `count`: An unsigned long integer representing the count to format.
- **Logic and Control Flow**:
    - Declare a temporary character array `tmp` with a size of 64.
    - Check if `count` is less than 1000; if true, format `count` as a simple unsigned long integer into `tmp`.
    - If `count` is between 1000 and 999,999, format `count` as a floating-point number with one decimal place followed by 'K' into `tmp`.
    - If `count` is between 1,000,000 and 999,999,999, format `count` as a floating-point number with one decimal place followed by 'M' into `tmp`.
    - Format the content of `tmp` into `buf` as a right-aligned string with a width of 12 characters.
    - Return the `buf` containing the formatted string.
- **Output**: Returns a pointer to the `buf` containing the formatted string.


---
### print\_histogram\_buckets<!-- {{#callable:print_histogram_buckets}} -->
[View Source →](<../../../../../../src/app/firedancer-dev/commands/repair.c#L350>)

Prints a formatted histogram of bucket counts from a metrics array, including bucket edges, counts, and a visual bar representation.
- **Inputs**:
    - `metrics`: A volatile array of unsigned long integers representing the metrics data.
    - `offset`: An unsigned long integer indicating the starting index in the metrics array for the histogram data.
    - `converter`: An integer specifying the type of conversion to apply to the histogram data, such as time conversion.
    - `histmin`: A double representing the minimum value for the histogram range.
    - `histmax`: A double representing the maximum value for the histogram range.
    - `title`: A string representing the title of the histogram to be printed.
- **Logic and Control Flow**:
    - Initialize a histogram structure to determine bucket edges based on the converter type.
    - Check if the converter is for seconds or none, and initialize the histogram with appropriate min and max values.
    - Print the header of the histogram table with the given title.
    - Calculate the total count of all buckets by iterating over the metrics array from the given offset.
    - Iterate over each bucket to calculate and print the bucket edge, count, and a visual bar scaled to a maximum of 20 characters.
    - For the last bucket, use '+Inf' as the edge label.
    - Print the sum, total count, and average of the metrics data at the end of the table.
- **Output**: The function outputs the formatted histogram to the standard output (console).
- **Functions Called**:
    - [`fmt_count`](<#fmt_count>)


---
### print\_catchup\_slots<!-- {{#callable:print_catchup_slots}} -->
[View Source →](<../../../../../../src/app/firedancer-dev/commands/repair.c#L433>)

Prints the catchup slot metrics from a repair context using a specified verbosity level.
- **Inputs**:
    - ``repair_tile_wksp``: A pointer to the workspace (`fd_wksp_t`) where the repair tile operates.
    - ``repair_ctx``: A pointer to the context (`ctx_t`) containing the repair slot metrics.
    - ``verbose``: An integer indicating the verbosity level for printing the metrics.
- **Logic and Control Flow**:
    - Retrieve the `slot_metrics` from the `repair_ctx` and store it in `catchup`.
    - Calculate the global address of `catchup` in the workspace using `fd_wksp_gaddr_fast`.
    - Convert the global address to a local address in the `repair_tile_wksp` and store it in `catchup_table`.
    - Call `fd_repair_metrics_print` with `catchup_table` and `verbose` to print the metrics.
- **Output**: No return value; the function outputs the catchup slot metrics to the standard output.


---
### sort\_peers\_by\_latency<!-- {{#callable:sort_peers_by_latency}} -->
[View Source →](<../../../../../../src/app/firedancer-dev/commands/repair.c#L444>)

Sorts peers by their latency using a bubble sort algorithm.
- **Inputs**:
    - ``active_table``: A pointer to an array of `fd_policy_peer_t` structures representing active peers.
    - ``peers_dlist``: A pointer to a doubly linked list of fast peers.
    - ``peers_wlist``: A pointer to a doubly linked list of slow peers.
    - ``peers_arr``: A pointer to an array of `fd_peer_t` structures representing all peers.
- **Logic and Control Flow**:
    - Initialize an iterator for the fast peers list and iterate through it, copying each peer's identity to the `peers_copy` array until the list is exhausted or the maximum number of active keys (`FD_ACTIVE_KEY_MAX`) is reached.
    - Log the count of fast peers and repeat the iteration process for the slow peers list, appending their identities to the `peers_copy` array.
    - Calculate the total number of peers processed (`peer_cnt`).
    - Perform a bubble sort on the `peers_copy` array based on the average latency of each peer, swapping elements if a peer has higher latency than the next peer.
    - Return the total number of peers sorted.
- **Output**: Returns the total number of peers sorted as an `ulong`.


---
### print\_peer\_location\_latency<!-- {{#callable:print_peer_location_latency}} -->
[View Source →](<../../../../../../src/app/firedancer-dev/commands/repair.c#L491>)

Prints peer location and latency information by sorting peers based on latency and displaying their details.
- **Inputs**:
    - ``repair_tile_wksp``: A pointer to the workspace for the repair tile, used to access shared memory.
    - ``tile_ctx``: A pointer to the context of the tile, containing workspace and policy information.
- **Logic and Control Flow**:
    - Retrieve the global address of the policy using `fd_wksp_gaddr_fast` and convert it to a local address using `fd_wksp_laddr`.
    - Retrieve the global addresses for the peer map, peer array, peer list, and peer wait list from the policy and convert them to local addresses.
    - Call [`sort_peers_by_latency`](<#sort_peers_by_latency>) to sort peers based on their latency and get the count of peers.
    - Print the header for peer location and latency information.
    - Iterate over each peer, query the peer map for active peers, and check if the peer has a response count greater than zero.
    - For each active peer, query the location table for geolocation information and calculate the request and response bytes per second.
    - Print the peer's public key, request count, request bytes per second, response bytes per second, response rate, average latency, and location information.
    - Flush the standard output to ensure all data is printed.
- **Output**: No return value; outputs peer information to the standard output.
- **Functions Called**:
    - [`sort_peers_by_latency`](<#sort_peers_by_latency>)


---
### read\_iptable<!-- {{#callable:read_iptable}} -->
[View Source →](<../../../../../../src/app/firedancer-dev/commands/repair.c#L520>)

Reads an IP table file and populates a location table with IP address and location information.
- **Inputs**:
    - ``iptable_path``: A string representing the file path to the IP table file to read.
    - ``location_table``: A pointer to a `fd_location_info_t` structure where the function will store the IP address and location information.
- **Logic and Control Flow**:
    - Opens the IP table file specified by `iptable_path` in read-only mode.
    - Checks if the file descriptor `iptable_fd` is valid; if not, logs a notice and returns.
    - Initializes a buffered input stream `istream` for reading the file line by line.
    - Enters a loop to read each line from the file using `fd_io_fgets`.
    - Parses each line to extract an IP address and location using `sscanf`.
    - Inserts the parsed location information into the `location_table` using `fd_location_table_insert`.
    - Copies the location string into the `info->location` field if the insertion is successful.
    - Breaks the loop if the insertion fails (i.e., `info` is `NULL`).
- **Output**: No return value; the function modifies the `location_table` in place.


---
### repair\_cmd\_fn\_metrics\_mode<!-- {{#callable:repair_cmd_fn_metrics_mode}} -->
[View Source →](<../../../../../../src/app/firedancer-dev/commands/repair.c#L547>)

Joins a running Firedancer instance in metrics mode, processes repair tile data, and optionally sets up terminal for interactive metrics display.
- **Inputs**:
    - ``args``: Pointer to an `args_t` structure containing command-line arguments, specifically for repair mode.
    - ``config``: Pointer to a `config_t` structure containing configuration data for the Firedancer instance.
- **Logic and Control Flow**:
    - Logs an attempt to join a running Firedancer instance.
    - Finds the workspace ID for the 'repair' workspace using `fd_topo_find_wksp` and logs an error if not found.
    - Finds the tile ID for the 'repair' tile using `fd_topo_find_tile` and logs an error if not found.
    - Joins the 'repair' workspace in read-only mode using `fd_topo_join_workspace`.
    - Accesses the scratch memory for the repair tile and logs an error if access fails.
    - Initializes and appends a `ctx_t` structure to the scratch memory.
    - Joins the location table using `fd_location_table_join` and reads the IP table from the path specified in `args`.
    - If `args->repair.metrics_only` is false, prints peer location latency and catchup slots, then exits.
    - Sets up terminal settings to disable character echo and line buffering if `args->repair.metrics_only` is true.
    - Enters an infinite loop to read user input and toggle verbosity or exit on Ctrl-D.
    - Periodically prints catchup slots and prompts user interaction.
- **Output**: No return value; performs logging, terminal setup, and data processing as side effects.
- **Functions Called**:
    - [`read_iptable`](<#read_iptable>)
    - [`print_peer_location_latency`](<#print_peer_location_latency>)
    - [`print_catchup_slots`](<#print_catchup_slots>)


---
### repair\_cmd\_fn\_tree\_mode<!-- {{#callable:repair_cmd_fn_tree_mode}} -->
[View Source →](<../../../../../../src/app/firedancer-dev/commands/repair.c#L617>)

Joins a running Firedancer instance in tree mode and continuously prints the repair process tree.
- **Inputs**:
    - ``args``: A pointer to an `args_t` structure, which is not used in this function.
    - ``config``: A pointer to a `config_t` structure containing the configuration for the Firedancer instance.
- **Logic and Control Flow**:
    - Logs a notice about attempting to join a running Firedancer instance.
    - Finds the workspace ID for the 'repair' workspace using `fd_topo_find_wksp` and logs an error if not found.
    - Retrieves the repair workspace from the topology's workspaces array using the found workspace ID.
    - Finds the tile ID for the 'repair' tile using `fd_topo_find_tile` and logs an error if not found.
    - Joins the repair workspace in read-only mode using `fd_topo_join_workspace`.
    - Accesses the scratch memory of the repair tile using `fd_topo_obj_laddr` and logs an error if access fails.
    - Initializes scratch memory allocation using `FD_SCRATCH_ALLOC_INIT`.
    - Allocates memory for a `ctx_t` structure in the scratch memory using `FD_SCRATCH_ALLOC_APPEND`.
    - Retrieves the global address of the forest from the repair context and converts it to a local address to get a pointer to the `fd_forest_t` structure.
    - Enters an infinite loop where it prints the forest using `fd_forest_print` and sleeps for 1 second.
- **Output**: No return value; the function runs indefinitely, printing the repair process tree every second.


---
### repair\_cmd\_fn\_profiler\_mode<!-- {{#callable:repair_cmd_fn_profiler_mode}} -->
[View Source →](<../../../../../../src/app/firedancer-dev/commands/repair.c#L651>)

Initializes and runs a repair profiler mode for a network topology, configuring tiles and monitoring metrics.
- **Inputs**:
    - ``args``: A pointer to an `args_t` structure containing command-line arguments and configuration details for the repair command.
    - ``config``: A pointer to a `config_t` structure that holds the configuration settings for the network topology and other parameters.
- **Logic and Control Flow**:
    - Logs the start of the repair profiler mode.
    - Initializes the topology by setting it to zero and calling [`repair_topo`](<#repair_topo>) to configure it.
    - Iterates over the tiles in the topology, checking for tiles named 'scap' and setting specific properties for them.
    - Logs the initialization of the repair profiler and prints the topology configuration.
    - Prepares `configure_args` with the command `CONFIGURE_CMD_INIT` and stages from `STAGES`, then calls `configure_cmd_fn`.
    - Checks if the network provider is 'xdp' and installs XDP if true.
    - Calls `run_firedancer_init` to initialize the Firedancer environment.
    - Unlocks a shared log lock and joins workspaces in read-write mode.
    - Fills the topology with data using `fd_topo_fill`.
    - Finds and verifies the indices of 'repair' and 'shred' tiles, obtaining their metrics.
    - Logs the start of the repair profiler run.
    - Finds and verifies the 'shred_out' link and its metadata cache.
    - Runs a loop to monitor and print metrics, checking for the first fragment to set `turbine_slot0`.
    - Periodically prints metrics such as requests received, request types, and response latency.
    - Checks if the catchup process is finished and calls [`repair_cmd_fn_metrics_mode`](<#repair_cmd_fn_metrics_mode>) if true, logging an error message.
- **Output**: No return value; the function operates by side effects, configuring and running the repair profiler mode.
- **Functions Called**:
    - [`repair_topo`](<#repair_topo>)
    - [`fmt_count`](<#fmt_count>)
    - [`print_histogram_buckets`](<#print_histogram_buckets>)
    - [`repair_cmd_fn_metrics_mode`](<#repair_cmd_fn_metrics_mode>)


---
### repair\_cmd\_fn<!-- {{#callable:repair_cmd_fn}} -->
[View Source →](<../../../../../../src/app/firedancer-dev/commands/repair.c#L777>)

Selects and executes a specific repair command mode based on the input arguments.
- **Inputs**:
    - ``args``: A pointer to an `args_t` structure containing command-line arguments and flags that determine the mode of operation for the repair command.
    - ``config``: A pointer to a `config_t` structure containing configuration settings for the repair command.
- **Logic and Control Flow**:
    - Check if `args->repair.metrics_only` is true; if so, call [`repair_cmd_fn_metrics_mode`](<#repair_cmd_fn_metrics_mode>) with `args` and `config` as arguments.
    - Check if `args->repair.forest_only` is true; if so, call [`repair_cmd_fn_tree_mode`](<#repair_cmd_fn_tree_mode>) with `args` and `config` as arguments.
    - If neither `metrics_only` nor `forest_only` is true, call [`repair_cmd_fn_profiler_mode`](<#repair_cmd_fn_profiler_mode>) with `args` and `config` as arguments.
- **Output**: No return value; the function executes one of the repair command modes based on the input arguments.
- **Functions Called**:
    - [`repair_cmd_fn_metrics_mode`](<#repair_cmd_fn_metrics_mode>)
    - [`repair_cmd_fn_tree_mode`](<#repair_cmd_fn_tree_mode>)
    - [`repair_cmd_fn_profiler_mode`](<#repair_cmd_fn_profiler_mode>)


# Function Declarations (Public API)

---
### fdctl\_tile\_run<!-- {{#callable_declaration:fdctl_tile_run}} -->
[View Source →](<../../../../../../src/app/firedancer-dev/commands/repair.c#L56>)

Finds and returns a tile from a predefined list by name.
- **Description**: Use this function to search for a tile in a predefined list of tiles by its name. It returns the tile if found, or logs an error and returns a default tile if not found. Ensure that the tile name provided is valid and exists in the list to avoid errors.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure representing the tile to find. Must not be null and must point to a valid tile structure with a name field.
- **Output**: Returns a `fd_topo_run_tile_t` structure representing the found tile. If the tile is not found, logs an error and returns a default-initialized `fd_topo_run_tile_t`.
- **See Also**: [`fdctl_tile_run`](<../../shared/boot/fd_boot.c.md#fdctl_tile_run>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)