<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

A command-line tool for testing the send tile in the Firedancer application, using specified gossip and stake files.

# Purpose
The code is a C source file that defines a command-line tool named `send_test`. This tool is part of the Firedancer development environment and is used to test the "send" tile, which is a component of a larger system that involves network communication and data processing. The tool interacts with several other components, such as network, metrics, and signing tiles, to simulate a production-like environment. It requires two command-line arguments: `--gossip-file` and `--stake-file`, which specify the paths to files containing gossip and stake information, respectively. The tool can also operate in a "live" mode, where it uses real-time gossip data from a live cluster.

The main functionality of the code includes setting up a topology for the test environment, configuring network and processing tiles, and managing the flow of data through various links. The code defines several functions to initialize the test environment, parse command-line arguments, and execute the main testing loop. The [`send_test_main_loop`](<#send_test_main_loop>) function continuously checks for events and triggers mock actions based on predefined delays. The code also includes permission checks and configuration stages to ensure the environment is correctly set up before running the tests. The `fd_action_send_test` structure defines the command's name, argument parsing function, main execution function, and permission function, integrating the tool into the larger Firedancer framework.
# Imports and Dependencies

---
- `../../../shared/commands/configure/configure.h`
- `../../../shared/commands/run/run.h`
- `../../../shared/fd_config.h`
- `../../../../disco/topo/fd_topob.h`
- `../../../../disco/topo/fd_cpu_topo.h`
- `../../../../util/tile/fd_tile_private.h`
- `../../../../disco/net/fd_net_tile.h`
- `../../../../discof/tower/fd_tower_tile.h`
- `../../../../flamenco/leaders/fd_leaders_base.h`
- `../../../../app/firedancer/topology.h`
- `../../../../disco/keyguard/fd_keyload.h`
- `../core_subtopo.h`
- `../gossip.h`
- `send_test_helpers.c`


# Global Variables

---
### CALLBACKS
- **Type**: `fd_topo_obj_callbacks_t *`
- **Description**: An array of pointers to `fd_topo_obj_callbacks_t` structures. These structures likely contain callback functions or methods related to topology objects in the system.
- **Use**: Used to pass callback functions to the `fd_topob_finish` function for finalizing topology setup.


---
### send\_test\_args
- **Type**: `struct`
- **Description**: Contains two character arrays, `gossip_file` and `stake_file`, each with a size of 256 characters. These arrays store file paths for the gossip and stake files used in the `send_test` command.
- **Use**: Stores the file paths for the gossip and stake files, which are required arguments for the `send_test` command.


---
### send\_test\_cmd\_perm
- **Type**: `function`
- **Description**: Executes permission-related configuration stages for the `send_test` command. It calls `configure_stage_perm` for various configuration stages such as `fd_cfg_stage_sysctl`, `fd_cfg_stage_hugetlbfs`, and others.
- **Use**: Used to ensure that necessary permissions are set up before executing the `send_test` command.


---
### fd\_action\_send\_test
- **Type**: `action_t`
- **Description**: Defines an action structure for the `send_test` command in the Firedancer development environment. This structure includes the name of the action, the function to handle command-line arguments, the main function to execute the command, and the function to check permissions.
- **Use**: Used to encapsulate the `send_test` command's behavior, argument handling, execution, and permission checking in the Firedancer system.


# Functions

---
### send\_test\_topo<!-- {{#callable:send_test_topo}} -->
[View Source →](<../../../../../../../src/app/firedancer-dev/commands/send_test/send_test.c#L46>)

Configures and sets up the network topology for testing the send tile, including CPU affinity, live or mock gossip, and network links.
- **Inputs**:
    - ``config``: A pointer to a `config_t` structure containing configuration details for setting up the topology, including network tile count, ingress buffer size, and CPU affinity.
- **Logic and Control Flow**:
    - Retrieve network tile count and ingress buffer size from the configuration.
    - Initialize a new topology object and set its maximum page size.
    - Parse CPU affinity from the configuration and map tiles to CPUs, logging an error if any CPU index is invalid.
    - Determine whether to use live gossip or mock gossip based on the `gossip_file` setting.
    - Configure core and gossip subtopologies based on the gossip mode.
    - Add and configure send tiles and workspaces for network links.
    - Set up real and mock network links based on the gossip mode, including permissions for producers and consumers.
    - Attach input and output links for the send tile, ensuring unpolled links are last.
    - Finish network tile setup and configure each tile with the provided configuration.
    - Complete the topology setup, using automatic layout if specified in the configuration.
- **Output**: No return value; the function modifies the topology configuration in place.


---
### send\_test\_cmd\_args<!-- {{#callable:send_test_cmd_args}} -->
[View Source →](<../../../../../../../src/app/firedancer-dev/commands/send_test/send_test.c#L152>)

Parses command-line arguments to extract and validate file paths for gossip and stake files, and modifies the argument list accordingly.
- **Inputs**:
    - ``pargc``: A pointer to an integer representing the number of command-line arguments.
    - ``pargv``: A pointer to an array of strings representing the command-line arguments.
    - ``args``: A pointer to an `args_t` structure, which is not used in this function.
- **Logic and Control Flow**:
    - Initialize local variables `_pargv` and `_pargc` to point to the command-line arguments and their count.
    - Initialize flags `found_gossip` and `found_stake` to track if required arguments are found.
    - Iterate over the arguments to find `--gossip-file` and `--stake-file`, copying their values to `send_test_args` and setting the respective flags.
    - Iterate over the arguments again to remove `--gossip-file` and `--stake-file` along with their values from the argument list.
    - Update `*pargc` to reflect the new number of arguments after removal.
    - Log an error and terminate if `--gossip-file` or `--stake-file` is not found.
- **Output**: Modifies the input argument list to remove specific arguments and updates the global `send_test_args` structure with file paths.


---
### init<!-- {{#callable:init}} -->
[View Source →](<../../../../../../../src/app/firedancer-dev/commands/send_test/send_test.c#L189>)

Initializes the `send_test_ctx_t` context with configuration and prepares it for testing by setting up file paths, keys, links, functions, and delays.
- **Inputs**:
    - `ctx`: A pointer to `send_test_ctx_t` structure that will be initialized.
    - `config`: A pointer to `config_t` structure containing configuration data.
- **Logic and Control Flow**:
    - Assigns the topology from `config` to `ctx->topo` and the configuration to `ctx->config`.
    - Copies file paths from `send_test_args` to `ctx->gossip_file` and `ctx->stake_file`.
    - Checks if the gossip file is set to 'live' and stores the result in `live_gossip`.
    - Loads the identity key and vote account address using `fd_keyload_load` and assigns them to `ctx->identity_key[0]` and `ctx->vote_acct_addr[0]`.
    - Sets up output links for `MOCK_CI_IDX`, `MOCK_STAKE_IDX`, and `MOCK_TRIGGER_IDX` using [`setup_test_out_link`](<send_test_helpers.c.md#setup_test_out_link>).
    - Assigns output functions `send_test_ci`, [`send_test_stake`](<send_test_helpers.c.md#send_test_stake>), and `send_test_trigger` to `ctx->out_fns` for each index.
    - Initializes `ctx->last_evt` for each index to 0.
    - Calculates delays for each index using `fd_tempo_tick_per_ns` and assigns them to `ctx->delay`.
    - If `live_gossip` is true, sets `ctx->delay[MOCK_CI_IDX]` to `LONG_MAX`.
    - Encodes a vote using [`encode_vote`](<send_test_helpers.c.md#encode_vote>) and stores it in `ctx->twr_buf`.
    - Sends the first epoch of stake information using [`send_test_stake`](<send_test_helpers.c.md#send_test_stake>).
- **Output**: No return value; modifies the `ctx` structure in place.
- **Functions Called**:
    - [`setup_test_out_link`](<send_test_helpers.c.md#setup_test_out_link>)
    - [`encode_vote`](<send_test_helpers.c.md#encode_vote>)
    - [`send_test_stake`](<send_test_helpers.c.md#send_test_stake>)


---
### send\_test\_main\_loop<!-- {{#callable:send_test_main_loop}} -->
[View Source →](<../../../../../../../src/app/firedancer-dev/commands/send_test/send_test.c#L229>)

Executes a continuous loop to trigger output functions based on elapsed time for each mock index.
- **Inputs**:
    - `ctx`: A pointer to a `send_test_ctx_t` structure containing context information, including last event times, delays, output links, and output functions.
- **Logic and Control Flow**:
    - Enter an infinite loop to continuously check and execute output functions.
    - Get the current time using `fd_tickcount()`.
    - Iterate over each mock index from 0 to `MOCK_CNT - 1`.
    - For each index, check if the sum of `ctx->last_evt[i]` and `ctx->delay[i]` is less than or equal to the current time (`now`).
    - If the condition is true, get the output link for the current index and call the corresponding output function with the context and output link.
    - Update `ctx->last_evt[i]` to the current time.
- **Output**: No return value; the function operates in an infinite loop, continuously executing output functions based on timing conditions.


---
### send\_test\_cmd\_fn<!-- {{#callable:send_test_cmd_fn}} -->
[View Source →](<../../../../../../../src/app/firedancer-dev/commands/send_test/send_test.c#L243>)

Initializes and configures the network topology and environment for testing the send tile, then runs the main test loop.
- **Inputs**:
    - ``args``: A pointer to an `args_t` structure containing command-line arguments and options.
    - ``config``: A pointer to a `config_t` structure containing configuration settings for the test environment.
- **Logic and Control Flow**:
    - Calls [`send_test_topo`](<#send_test_topo>) to set up the network topology based on the provided configuration.
    - Configures various system stages using `configure_stage` with `CONFIGURE_CMD_INIT` and the provided configuration.
    - Logs the topology configuration using `fd_topo_print_log`.
    - Initializes the Firedancer environment with `run_firedancer_init`, considering the `no_init_workspaces` flag from `args`.
    - Sets up network namespaces with `fdctl_setup_netns`.
    - Checks if the network provider is 'xdp' and installs XDP using `fd_topo_install_xdp` if true.
    - Joins workspaces in read-write mode using `fd_topo_join_workspaces`.
    - Runs a single process in the topology with `fd_topo_run_single_process`, using the provided user and group IDs and the `fdctl_tile_run` function.
    - Initializes a `send_test_ctx_t` context structure with [`init`](<#init>), passing the context and configuration.
    - Enters the main test loop by calling [`send_test_main_loop`](<#send_test_main_loop>) with the initialized context.
- **Output**: No return value; the function operates through side effects on the provided configuration and context structures.
- **Functions Called**:
    - [`send_test_topo`](<#send_test_topo>)
    - [`init`](<#init>)
    - [`send_test_main_loop`](<#send_test_main_loop>)


---
### configure\_stage\_perm<!-- {{#callable:configure_stage_perm}} -->
[View Source →](<../../../../../../../src/app/firedancer-dev/commands/send_test/send_test.c#L269>)

Configures permissions for a stage if it is enabled and its check does not return CONFIGURE_OK.
- **Inputs**:
    - `stage`: A pointer to a `configure_stage_t` structure that contains stage configuration and function pointers for enabling, checking, and initializing permissions.
    - `chk`: A pointer to an `fd_cap_chk_t` structure used for permission initialization.
    - `config`: A pointer to a `config_t` structure that contains configuration data for the stage.
- **Logic and Control Flow**:
    - Determine if the stage is enabled by checking if `stage->enabled` is NULL or returns true when called with `config`.
    - If the stage is enabled, check the stage using `stage->check(config)`.
    - If the check result is not `CONFIGURE_OK`, call `stage->init_perm(chk, config)` if `stage->init_perm` is not NULL.
- **Output**: No return value; the function performs actions based on the input parameters.


# Function Declarations (Public API)

---
### fdctl\_tile\_run<!-- {{#callable_declaration:fdctl_tile_run}} -->
[View Source →](<../../../../../../../src/app/firedancer-dev/commands/send_test/send_test.c#L38>)

Finds and returns a tile configuration by name.
- **Description**: Use this function to retrieve a tile configuration from a predefined list of tiles by matching the tile's name. This function is useful when you need to access specific tile configurations based on their names. It is important to ensure that the tile name provided exists in the list; otherwise, an error is logged, and a default tile configuration is returned. This function should be called when the tile configurations are initialized and available for lookup.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure representing the tile to find. The `name` field of this structure is used to search for a matching tile in the list. The pointer must not be null, and the `name` field must be a valid string.
- **Output**: Returns a `fd_topo_run_tile_t` structure corresponding to the tile with the matching name. If no match is found, logs an error and returns a default-initialized `fd_topo_run_tile_t`.
- **See Also**: [`fdctl_tile_run`](<../../../shared/boot/fd_boot.c.md#fdctl_tile_run>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)