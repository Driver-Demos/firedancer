<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Helper functions and data structures for handling gossip messages, stake weights, and test triggers in the Firedancer application.

# Purpose
The code is a C source file that provides helper functions for testing a system related to gossip and stake weight processing. It includes several components that handle the parsing and processing of gossip messages and stake weights from input files. The file defines a structure `send_test_ctx_t` to maintain context for the test, including configuration and state information such as epoch and slot numbers, as well as file paths for gossip and stake data.

The code includes functions like [`parse_gossip_line`](<#parse_gossip_line>) and [`parse_stake_weight`](<#parse_stake_weight>) to interpret lines from input files and convert them into structured data. Functions such as [`send_test_ci`](<#send_test_ci>), [`send_test_stake`](<#send_test_stake>), and [`send_test_trigger`](<#send_test_trigger>) are responsible for reading data from files, processing it, and publishing it to a memory cache. The file also defines a function [`encode_vote`](<#encode_vote>) to create a mock vote transaction. The code is intended to be part of a larger system, as indicated by the inclusion of various headers and the use of specific data structures and functions from those headers. The file does not define a public API but provides internal functionality for testing purposes.
# Imports and Dependencies

---
- `../../../../disco/fd_disco.h`
- `../../../../choreo/tower/fd_tower.h`
- `../../../../flamenco/leaders/fd_leaders_base.h`
- `../../../../disco/pack/fd_microblock.h`
- `../../../../discof/tower/fd_tower_tile.h`
- `../../../../flamenco/gossip/fd_gossip_types.h`
- `../../../../util/net/fd_ip4.h`
- `stdio.h`
- `string.h`
- `stdlib.h`


# Data Structures

---
### send\_test\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``topo``: Pointer to a `fd_topo_t` structure.
    - ``config``: Pointer to a `fd_config_t` structure.
    - ``out_links``: Array of `send_test_out_t` structures for output links.
    - ``out_fns``: Array of function pointers for output functions.
    - ``identity_key``: Array containing a single `fd_pubkey_t` for the identity key.
    - ``vote_acct_addr``: Array containing a single `fd_pubkey_t` for the vote account address.
    - ``twr_buf``: Array containing a single `fd_tower_slot_done_t` for tower buffer.
    - ``last_evt``: Array of long integers for the last event timestamps.
    - ``delay``: Array of long integers for delays.
    - ``epoch``: Unsigned long integer for the current epoch.
    - ``slot``: Unsigned long integer for the current slot.
    - ``gossip_file``: Character array for the gossip file path.
    - ``stake_file``: Character array for the stake file path.
- **Description**: `send_test_ctx_t` is a structure that holds context information for sending test data, including topology and configuration pointers, output links and functions, identity and vote account keys, tower buffer, event timestamps, delays, epoch and slot information, and file paths for gossip and stake data.


---
### send\_test\_out\_t
- **Type**: ``struct``
- **Members**:
    - ``mcache``: Pointer to a `fd_frag_meta_t` structure for metadata caching.
    - ``sync``: Pointer to an unsigned long integer for synchronization.
    - ``depth``: Unsigned long integer representing the depth of the cache.
    - ``seq``: Unsigned long integer representing the sequence number.
    - ``mem``: Pointer to a `fd_wksp_t` structure for memory workspace.
    - ``chunk0``: Unsigned long integer representing the initial chunk index.
    - ``wmark``: Unsigned long integer representing the watermark for chunk management.
    - ``chunk``: Unsigned long integer representing the current chunk index.
- **Description**: `send_test_out_t` is a structure used to manage output data in a test environment. It includes pointers to metadata and memory workspaces, as well as several unsigned long integers to track synchronization, depth, sequence, and chunk management. This structure is essential for handling data output operations in the context of the test functions provided in the file.


---
### send\_test\_ctx
- **Type**: ``struct``
- **Members**:
    - ``topo``: Pointer to a `fd_topo_t` structure, representing the topology configuration.
    - ``config``: Pointer to a `fd_config_t` structure, representing the configuration settings.
    - ``out_links``: Array of `send_test_out_t` structures, representing output links.
    - ``out_fns``: Array of function pointers of type `out_fn_t`, representing output functions.
    - ``identity_key``: Array of `fd_pubkey_t`, representing the identity key.
    - ``vote_acct_addr``: Array of `fd_pubkey_t`, representing the vote account address.
    - ``twr_buf``: Array of `fd_tower_slot_done_t`, representing the tower buffer.
    - ``last_evt``: Array of `long`, representing the last event timestamps.
    - ``delay``: Array of `long`, representing the delay values.
    - ``epoch``: Unsigned long integer, representing the current epoch.
    - ``slot``: Unsigned long integer, representing the current slot.
    - ``gossip_file``: Character array of size 256, representing the path to the gossip file.
    - ``stake_file``: Character array of size 256, representing the path to the stake file.
- **Description**: The `send_test_ctx` structure is used to manage the context for sending test data in a network simulation environment. It includes pointers to topology and configuration structures, arrays for managing output links and functions, and fields for identity and vote account keys. The structure also contains buffers for tower slots, arrays for event timestamps and delays, and fields for epoch and slot tracking. Additionally, it holds file paths for gossip and stake data, which are used in the simulation process.


# Functions

---
### parse\_gossip\_line<!-- {{#callable:parse_gossip_line}} -->
[View Source →](<../../../../../../../src/app/firedancer-dev/commands/send_test/send_test_helpers.c#L66>)

Parses a line of gossip data to extract and populate a `fd_gossip_update_message_t` structure with IP address, public key, and port information.
- **Inputs**:
    - `line`: A string containing a line of gossip data, expected to be formatted with tokens separated by spaces or tabs.
- **Logic and Control Flow**:
    - Initialize a `fd_gossip_update_message_t` structure `msg` to zero.
    - Log the line being parsed for debugging purposes.
    - Use `strtok` to tokenize the input `line` by spaces or tabs, extracting the IP address, public key, and two port numbers, while skipping the gossip port.
    - Verify that each token is successfully extracted using `FD_TEST`.
    - Decode the public key from Base58 format and store it in `msg.origin_pubkey`.
    - Convert the IP address string to a numeric format and assign it to the `addr` fields of `udp_tpu` and `quic_tpu`.
    - Convert the port strings to network byte order and assign them to the `port` fields of `udp_tpu` and `quic_tpu`, using `fd_ushort_bswap` to ensure correct byte order.
    - Clear the `udp_vote` and `quic_vote` structures using `fd_memset`.
    - Return the populated `msg` structure.
- **Output**: A `fd_gossip_update_message_t` structure containing the parsed IP address, public key, and port information.


---
### send\_test\_ci<!-- {{#callable:send_test_ci}} -->
[View Source →](<../../../../../../../src/app/firedancer-dev/commands/send_test/send_test_helpers.c#L103>)

Reads a gossip file line by line, parses each line into a gossip update message, and publishes it to a memory cache.
- **Inputs**:
    - `ctx`: A pointer to a `send_test_ctx_t` structure containing context information, including the path to the gossip file.
    - `out`: A pointer to a `send_test_out_t` structure containing output parameters, including memory cache and sequence information.
- **Logic and Control Flow**:
    - Open the gossip file specified in `ctx->gossip_file` for reading.
    - If the file cannot be opened, log an error and terminate the function.
    - Read each line from the file into a buffer `line`.
    - For each line, convert the memory chunk at `out->chunk` to a local address and parse the line into a `fd_gossip_update_message_t` structure.
    - Publish the parsed message to the memory cache using `fd_mcache_publish` with the current sequence and chunk information.
    - Increment the sequence number using `fd_seq_inc`.
    - Update the chunk pointer using `fd_dcache_compact_next` to point to the next available memory location.
    - Close the file after processing all lines.
- **Output**: No direct output; modifies the `out` structure by updating the sequence and chunk, and publishes messages to the memory cache.
- **Functions Called**:
    - [`parse_gossip_line`](<#parse_gossip_line>)


---
### parse\_stake\_weight<!-- {{#callable:parse_stake_weight}} -->
[View Source →](<../../../../../../../src/app/firedancer-dev/commands/send_test/send_test_helpers.c#L121>)

Parses a line of text to extract and convert stake weight information into a `fd_vote_stake_weight_t` structure.
- **Inputs**:
    - `line`: A pointer to a character array (string) that contains the stake weight information to parse.
- **Logic and Control Flow**:
    - Logs the input line for debugging purposes.
    - Uses `strtok` to tokenize the line, starting from the fourth character, to extract the `id_token` and `vote_token`.
    - Validates the presence of `id_token` and `vote_token` using `FD_TEST`.
    - Decodes the `id_token` and `vote_token` from Base58 to populate `weight.id_key.key` and `weight.vote_key.key` respectively, validating each operation with `FD_TEST`.
    - Searches for the substring " SOL " in the remaining part of the line to locate the staked amount, validating the presence of " SOL " with `FD_TEST`.
    - Backtracks from the " SOL " position to find the start of the numeric staked amount, ensuring it includes digits and possibly a decimal point.
    - Converts the identified numeric string to a double using `atof`, validates that the amount is greater than zero, and calculates the stake in lamports by multiplying by 1,000,000,000.
    - Assigns the calculated stake to `weight.stake` and returns the `weight` structure.
- **Output**: Returns a `fd_vote_stake_weight_t` structure containing the decoded public keys and the calculated stake amount in lamports.


---
### send\_test\_stake<!-- {{#callable:send_test_stake}} -->
[View Source →](<../../../../../../../src/app/firedancer-dev/commands/send_test/send_test_helpers.c#L147>)

Processes stake weight data from a file and updates the message context for a test stake operation.
- **Inputs**:
    - ``ctx``: A pointer to a `send_test_ctx_t` structure containing the context for the test stake operation, including the current epoch and the file path for stake data.
    - ``out``: A pointer to a `send_test_out_t` structure used to store the output of the test stake operation, including memory cache and sequence information.
- **Logic and Control Flow**:
    - Convert the memory chunk in `out` to a `fd_stake_weight_msg_t` message structure.
    - Set the `epoch`, `start_slot`, `slot_cnt`, `excluded_stake`, and `vote_keyed_lsched` fields of the message using values from `ctx` and constants.
    - Initialize `stake_weights` to point to the `weights` array in the message and set `stake_count` to 0.
    - Open the stake file specified in `ctx->stake_file` for reading; log an error if the file cannot be opened.
    - Read each line from the file, parse it into a `fd_vote_stake_weight_t` structure using [`parse_stake_weight`](<#parse_stake_weight>), and store it in `stake_weights`, incrementing `stake_count`.
    - Close the file after reading all lines.
    - Log an error if no valid stake entries were found in the file.
    - Set the `staked_cnt` field of the message to `stake_count`.
    - Calculate the size of the message and its weights, ensuring it does not exceed `USHORT_MAX`.
    - Publish the message to the memory cache using `fd_mcache_publish`.
    - Increment the sequence number in `out` using `fd_seq_inc`.
    - Update the chunk in `out` using `fd_dcache_compact_next`.
    - Increment the `epoch` in `ctx`.
- **Output**: No return value; updates the `out` structure with the processed stake message and increments the epoch in `ctx`.
- **Functions Called**:
    - [`parse_stake_weight`](<#parse_stake_weight>)


---
### send\_test\_trigger<!-- {{#callable:send_test_trigger}} -->
[View Source →](<../../../../../../../src/app/firedancer-dev/commands/send_test/send_test_helpers.c#L183>)

Copies a tower slot done structure to a memory location and updates metadata for a test trigger.
- **Inputs**:
    - `ctx`: A pointer to a `send_test_ctx_t` structure containing context information, including the tower buffer to copy.
    - `out`: A pointer to a `send_test_out_t` structure containing output parameters, including memory location and metadata to update.
- **Logic and Control Flow**:
    - Convert the `out->chunk` to a local address using `fd_chunk_to_laddr` and store it in `slot_done`.
    - Copy the tower buffer from `ctx->twr_buf` to `slot_done` using `fd_memcpy`.
    - Publish the metadata using `fd_mcache_publish` with the size of `fd_tower_slot_done_t`.
    - Increment the sequence number `out->seq` using `fd_seq_inc`.
    - Update the chunk using `fd_dcache_compact_next` with the size of `fd_tower_slot_done_t`.
- **Output**: No return value; updates the `out` structure with new sequence and chunk values.


---
### setup\_test\_out\_link<!-- {{#callable:setup_test_out_link}} -->
[View Source →](<../../../../../../../src/app/firedancer-dev/commands/send_test/send_test_helpers.c#L193>)

Initializes a `send_test_out_t` structure by finding and configuring a link from a topology based on a given name.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure representing the topology.
    - ``name``: A string representing the name of the link to find in the topology.
- **Logic and Control Flow**:
    - Finds the index of the link in the topology using `fd_topo_find_link` with the given `name` and checks if the index is valid.
    - Retrieves the link from the topology using the found index.
    - Initializes a `send_test_out_t` structure with default values.
    - Sets the `mcache` field of the output structure to the `mcache` of the link.
    - Calculates and sets the `sync`, `depth`, and `seq` fields using `fd_mcache_seq_laddr`, `fd_mcache_depth`, and `fd_mcache_seq_query` respectively.
    - Sets the `mem` field to the workspace memory associated with the link's `dcache_obj_id`.
    - Calculates and sets the `chunk0` and `wmark` fields using `fd_dcache_compact_chunk0` and `fd_dcache_compact_wmark` respectively.
    - Sets the `chunk` field to the value of `chunk0`.
- **Output**: Returns a `send_test_out_t` structure initialized with the link's configuration.


---
### encode\_vote<!-- {{#callable:encode_vote}} -->
[View Source →](<../../../../../../../src/app/firedancer-dev/commands/send_test/send_test_helpers.c#L210>)

Encodes a vote transaction using a mock tower and stores it in the provided slot_done structure.
- **Inputs**:
    - `ctx`: A pointer to a `send_test_ctx_t` structure containing context information such as identity keys and vote account addresses.
    - `slot_done`: A pointer to a `fd_tower_slot_done_t` structure where the encoded vote transaction will be stored.
- **Logic and Control Flow**:
    - Initialize constants `root` and `vote_slot` for the vote slot calculation.
    - Create a minimal mock tower with one vote using `fd_tower_new` and `fd_tower_join`.
    - Push a vote with the calculated `vote_slot` and a confidence level of 1 to the tower using `fd_tower_votes_push_tail`.
    - Declare mock values for lockouts, hash, and transaction pointers.
    - Generate a vote transaction using `fd_tower_to_vote_txn` with the mock tower and context information.
    - Verify the transaction payload size is valid and within the maximum transmission unit (MTU) using `FD_TEST`.
    - Copy the transaction payload to `slot_done->vote_txn` and set the transaction size in `slot_done->vote_txn_sz`.
    - Parse the transaction to ensure it is valid using `fd_txn_parse`.
- **Output**: The function does not return a value but modifies the `slot_done` structure to contain the encoded vote transaction and its size.



---
Made with ❤️ by [Driver](https://www.driver.ai/)