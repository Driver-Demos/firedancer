<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements the `snapshot-load` command for configuring and running a snapshot loading topology in Firedancer.

# Purpose
The code is a C source file that defines a command for loading a snapshot in a distributed system. It is part of a larger software framework, as indicated by the inclusion of multiple header files from different directories. The primary function of this code is to set up and execute a series of operations related to loading a snapshot, which involves configuring and running various "tiles" or components in a topology. These tiles perform tasks such as reading, decompressing, and parsing snapshot data.

The code defines several functions, including [`snapshot_load_topo`](<#snapshot_load_topo>), which configures the topology for the snapshot load operation, and [`snapshot_load_cmd_fn`](<#snapshot_load_cmd_fn>), which executes the command. The [`snapshot_load_topo`](<#snapshot_load_topo>) function sets up the necessary workspace and tiles, linking them together to form a processing pipeline. The [`snapshot_load_cmd_fn`](<#snapshot_load_cmd_fn>) function manages the execution of the snapshot load process, including initializing configurations, running the process, and monitoring performance metrics. The code also defines an action structure, `fd_action_snapshot_load`, which specifies the command's name, argument handling function, permissions, and execution function. This structure is likely used to register the command within the larger system.
# Imports and Dependencies

---
- `../../firedancer/topology.h`
- `../../platform/fd_sys_util.h`
- `../../shared/commands/configure/configure.h`
- `../../shared/commands/run/run.h`
- `../../shared_dev/commands/dev.h`
- `../../../disco/metrics/fd_metrics.h`
- `../../../disco/topo/fd_topob.h`
- `../../../disco/pack/fd_pack.h`
- `../../../disco/pack/fd_pack_cost.h`
- `../../../util/tile/fd_tile_private.h`
- `../../../util/pod/fd_pod_format.h`
- `../../../discof/restore/utils/fd_ssctrl.h`
- `../../../discof/restore/utils/fd_ssmsg.h`
- `sys/resource.h`
- `linux/capability.h`
- `unistd.h`
- `stdio.h`


# Global Variables

---
### CALLBACKS
- **Type**: ``fd_topo_obj_callbacks_t *` array`
- **Description**: An array of pointers to `fd_topo_obj_callbacks_t` structures. These structures likely contain callback functions or methods related to topology objects in the Firedancer system.
- **Use**: Used to store and manage callback functions for topology objects in the Firedancer system.


---
### fd\_log\_private\_shared\_lock
- **Type**: `int *`
- **Description**: `fd_log_private_shared_lock` is a pointer to an integer that is declared as an external variable. It is intended to be shared across different parts of the program, possibly for synchronization or logging purposes.
- **Use**: Used to control or manage access to shared resources, likely in a multi-threaded or multi-process environment.


---
### fd\_action\_snapshot\_load
- **Type**: ``action_t``
- **Description**: Defines an action structure for loading a snapshot. It includes the name of the action, the function to parse command arguments, the permissions required, and the function to execute the command.
- **Use**: Used to encapsulate the details and execution logic for the snapshot load action.


# Functions

---
### snapshot\_load\_topo<!-- {{#callable:snapshot_load_topo}} -->
[View Source →](<../../../../../../src/app/firedancer-dev/commands/snapshot_load.c#L27>)

Initializes and configures the topology for snapshot loading, setting up various tiles and workspaces, and linking them for data processing.
- **Inputs**:
    - ``config``: A pointer to a `config_t` structure containing configuration settings for the topology.
    - ``args``: A pointer to a constant `args_t` structure containing arguments for snapshot loading, including CPU tile assignments.
- **Logic and Control Flow**:
    - Initialize the topology using `fd_topob_new` and set the maximum page size using `fd_cstr_to_shmem_page_sz`.
    - Set up the 'txncache' and 'funk' workspaces and objects using `setup_topo_txncache` and `setup_topo_funk`.
    - Parse CPU tile assignments from `args` and ensure at least 4 CPUs are specified, logging an error if not.
    - Create and configure various tiles ('metric', 'snapct', 'snapld', 'snapdc', 'snapin') with specific CPU assignments and allow shutdown for certain tiles.
    - Establish workspaces and links between tiles for data flow, using `fd_topob_wksp` and `fd_topob_link`.
    - Configure tile inputs and outputs using `fd_topob_tile_in` and `fd_topob_tile_out`, setting up reliable and polled connections.
    - Assign 'funk' and 'txncache' objects to the 'snapin' tile for read-write access, and set the maximum live slots.
    - Configure each tile in the topology using `fd_topo_configure_tile`.
    - If no CPU tile assignments are provided, perform automatic layout using `fd_topob_auto_layout`.
    - Finalize the topology setup with `fd_topob_finish`.
- **Output**: No direct output is returned; the function modifies the `config` structure to set up the topology for snapshot loading.


---
### snapshot\_load\_cmd\_args<!-- {{#callable:snapshot_load_cmd_args}} -->
[View Source →](<../../../../../../src/app/firedancer-dev/commands/snapshot_load.c#L122>)

Parses command-line arguments to extract the '--tile-cpus' option and stores it in the 'args' structure.
- **Inputs**:
    - `pargc`: A pointer to an integer representing the number of command-line arguments.
    - `pargv`: A pointer to an array of strings representing the command-line arguments.
    - `args`: A pointer to an 'args_t' structure where the parsed '--tile-cpus' option will be stored.
- **Logic and Control Flow**:
    - Calls 'fd_env_strip_cmdline_cstr' to extract the '--tile-cpus' option from the command-line arguments or environment variables.
    - Checks if 'tile_cpus' is not NULL, indicating that the option was found.
    - Calculates the length of the 'tile_cpus' string using 'strlen'.
    - Compares the length of 'tile_cpus' with the size of 'args->snapshot_load.tile_cpus'.
    - Logs an error and exits if 'tile_cpus' is too long to fit in 'args->snapshot_load.tile_cpus'.
    - Initializes 'args->snapshot_load.tile_cpus' and appends 'tile_cpus' to it using 'fd_cstr_append_text'.
    - Finalizes the string operation with 'fd_cstr_fini'.
- **Output**: No return value; modifies the 'args' structure in place.


---
### snapshot\_load\_cmd\_fn<!-- {{#callable:snapshot_load_cmd_fn}} -->
[View Source →](<../../../../../../src/app/firedancer-dev/commands/snapshot_load.c#L137>)

Executes the snapshot load command by initializing the topology, configuring stages, and running the Firedancer process while monitoring metrics and progress.
- **Inputs**:
    - ``args``: Pointer to an `args_t` structure containing command arguments.
    - ``config``: Pointer to a `config_t` structure containing configuration settings.
- **Logic and Control Flow**:
    - Checks if gossip snapshot sources are enabled and logs an error if they are.
    - Calls [`snapshot_load_topo`](<#snapshot_load_topo>) to initialize the topology with the given configuration and arguments.
    - Initializes `configure_args` with the command `CONFIGURE_CMD_INIT` and populates its stages from `STAGES`.
    - Calls `configure_cmd_fn` to configure the command with the initialized `configure_args`.
    - Runs `run_firedancer_init` to initialize the Firedancer process.
    - Sets the shared lock for logging to 0 and joins workspaces in read-write mode using `fd_topo_join_workspaces`.
    - Fills the topology using `fd_topo_fill`.
    - Calculates `tick_per_ns` and `ns_per_tick` for time measurement.
    - Starts the Firedancer process in a single process mode using `fd_topo_run_single_process`.
    - Finds and initializes tiles `snapct`, `snapld`, `snapdc`, and `snapin` from the topology.
    - Retrieves metrics for each tile using `fd_metrics_tile`.
    - Initializes old metric values to zero and sleeps for 1 second.
    - Prints column headers for metrics display.
    - Enters an infinite loop to monitor tile statuses and metrics.
    - Checks if all tile statuses are 2, indicating completion, and breaks the loop if true.
    - Gets the current wall clock time and calculates sleep duration if needed.
    - Sleeps for the calculated duration if the current time is less than the next scheduled time.
    - Calculates current metrics for each tile and computes progress and performance metrics.
    - Prints the progress and performance metrics to the console.
    - Updates old metric values with current values for the next iteration.
    - Increments the next scheduled time by 1 second.
- **Output**: No return value; performs operations and logs output to the console.
- **Functions Called**:
    - [`snapshot_load_topo`](<#snapshot_load_topo>)


# Function Declarations (Public API)

---
### fdctl\_tile\_run<!-- {{#callable_declaration:fdctl_tile_run}} -->
[View Source →](<../../../../../../src/app/firedancer-dev/commands/snapshot_load.c#L24>)

Finds and returns a tile configuration by name.
- **Description**: Use this function to retrieve a tile configuration from a predefined list of tiles by matching the tile's name. This function is useful when you need to access specific tile configurations based on their names. It is important to ensure that the tile name provided exists in the list; otherwise, the function will log an error and return a default-initialized tile configuration.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure representing the tile to find. The `name` field of this structure is used to search for a matching tile. The pointer must not be null, and the `name` field must be a valid string.
- **Output**: Returns a `fd_topo_run_tile_t` structure corresponding to the tile with the matching name. If no match is found, logs an error and returns a default-initialized `fd_topo_run_tile_t`.
- **See Also**: [`fdctl_tile_run`](<../../shared/boot/fd_boot.c.md#fdctl_tile_run>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)