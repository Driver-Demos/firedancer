<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

A wrapper for running programs with all capabilities to support debugging in VS Code.

# Purpose
The code is a C program designed to facilitate debugging with Visual Studio Code (VS Code) by enabling the execution of a program with elevated capabilities, which are necessary for certain operations that require root privileges. The program acts as a wrapper to allow the execution of the GNU Debugger (GDB) with all capabilities, circumventing the limitations imposed by running as a non-root user. This is achieved by setting the binary's capabilities to allow it to execute with elevated privileges, even when initiated by a non-root process.

The program follows a specific sequence to achieve this: it first checks if the current process has all necessary capabilities. If not, it forks a child process to execute a `sudo` command that sets the capabilities of the binary. The parent process waits for this operation to complete and then re-executes itself with the newly set capabilities. Once running with the required capabilities, the program raises ambient capabilities to ensure they persist through the execution of GDB. Finally, it executes GDB with the arguments provided by the IDE, allowing the debugging session to proceed with the necessary permissions. This approach addresses the challenge of debugging programs that require root access without modifying the VS Code agent or the GDB binary itself.
# Imports and Dependencies

---
- `../../util/fd_util.h`
- `stdlib.h`
- `unistd.h`
- `string.h`
- `stdio.h`
- `sys/types.h`
- `sys/prctl.h`
- `sys/syscall.h`
- `sys/xattr.h`
- `sys/wait.h`
- `linux/limits.h`
- `linux/capability.h`


# Data Structures

---
### vfs\_cap\_data
- **Type**: ``struct``
- **Members**:
    - ``magic_etc``: A 32-bit little-endian integer that stores magic and other data.
    - ``data``: An array of two elements, each containing `permitted` and `inheritable` fields.
    - ``permitted``: A 32-bit little-endian integer that specifies the permitted capabilities.
    - ``inheritable``: A 32-bit little-endian integer that specifies the inheritable capabilities.
- **Description**: Stores capability data for a file system, including magic numbers and capability sets for permitted and inheritable capabilities.


# Functions

---
### has\_all\_capabilities<!-- {{#callable:has_all_capabilities}} -->
[View Source →](<../../../../../src/app/fddbg/main.c#L56>)

Checks if the current process has all required capabilities.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize `capheader` with version `_LINUX_CAPABILITY_VERSION_3` and `pid` set to 0.
    - Call `syscall` with `SYS_capget` to retrieve the capability data into `capdata`.
    - Check if `capdata[0].permitted` equals `0xFFFFFFFF` and `capdata[1].permitted` bitwise AND with `0x000001FF` equals `0x000001FF`.
    - Return the result of the logical AND operation as the function's output.
- **Output**: Returns an integer indicating whether the process has all capabilities (1 if true, 0 if false).


---
### raise\_all\_capabilities<!-- {{#callable:raise_all_capabilities}} -->
[View Source →](<../../../../../src/app/fddbg/main.c#L69>)

Raises all capabilities for the current process to their maximum values.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize `capheader` and `capdata` structures to interact with Linux capabilities.
    - Set `capheader.version` to `_LINUX_CAPABILITY_VERSION_3` and `capheader.pid` to 0 to target the current process.
    - Use `syscall` with `SYS_capget` to retrieve the current capabilities into `capdata`.
    - Set all `effective` and `inheritable` fields in `capdata` to `0xFFFFFFFF` to enable all capabilities.
    - Use `syscall` with `SYS_capset` to apply the modified capabilities to the current process.
    - Iterate over all capabilities from 0 to `CAP_LAST_CAP` and use `prctl` with `PR_CAP_AMBIENT_RAISE` to raise each capability to ambient.
- **Output**: No direct output; modifies the capabilities of the current process.


---
### self\_exe<!-- {{#callable:self_exe}} -->
[View Source →](<../../../../../src/app/fddbg/main.c#L88>)

Retrieves the absolute path of the currently running executable and stores it in the provided buffer.
- **Inputs**:
    - `path`: A character array where the function will store the absolute path of the current executable.
- **Logic and Control Flow**:
    - Calls `readlink` to read the symbolic link `/proc/self/exe` which points to the executable of the current process.
    - Stores the number of bytes read by `readlink` in the variable `count`.
    - Checks if `count` is non-negative and less than `PATH_MAX` using `FD_TEST`.
    - Appends a null terminator to the `path` at the position indicated by `count`.
- **Output**: Does not return a value; modifies the `path` argument to contain the absolute path of the current executable.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/app/fddbg/main.c#L95>)

Manages process capabilities to ensure the program runs with necessary permissions, particularly for debugging with GDB.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with `argc` and `argv`.
    - Checks if the first argument is `--setcap`; if true, sets all capabilities for the current executable using `setxattr`.
    - If not `--setcap`, checks if the process has all capabilities using [`has_all_capabilities`](<#has_all_capabilities>).
    - If capabilities are missing and the first argument is `--withcap`, logs an error and exits.
    - If capabilities are missing, forks a child process to run `sudo` to set capabilities, waits for it to complete, and then re-executes itself with `--withcap`.
    - If the process has all capabilities, raises all capabilities using [`raise_all_capabilities`](<#raise_all_capabilities>) and prepares to execute GDB with the provided arguments.
    - Executes GDB with the modified argument list.
- **Output**: No explicit return value; the function primarily executes other processes and manages capabilities.
- **Functions Called**:
    - [`self_exe`](<#self_exe>)
    - [`has_all_capabilities`](<#has_all_capabilities>)
    - [`raise_all_capabilities`](<#raise_all_capabilities>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)