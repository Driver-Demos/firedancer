<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for the RPC client, including server setup, request handling, and response validation.

# Purpose
The code is a C program that implements a simple RPC (Remote Procedure Call) client-server interaction using HTTP over a local network. It includes a server function, [`fd_rpc_serve_one`](<#fd_rpc_serve_one>), which listens for incoming HTTP POST requests on a specified port and processes JSON-RPC requests. The server parses the HTTP request headers and JSON content to determine the requested method, such as `getLatestBlockhash` or `getTransactionCount`, and responds with a JSON-RPC formatted response. The server uses the `picohttpparser` library for HTTP parsing and `cJSON` for JSON handling.

The [`main`](<#main>) function tests the RPC client functionality by creating an RPC client instance, sending requests to the server, and verifying the responses. It uses a separate thread to run the server function concurrently with the client tests. The client sends requests to retrieve the latest block hash and transaction count, and the responses are validated against expected values. The program uses several utility functions and macros, such as `FD_TEST` for assertions and `FD_LOG_NOTICE` for logging, to ensure the correctness of operations. The code also includes setup and teardown functions for the RPC client, such as `fd_rpc_client_new`, `fd_rpc_client_join`, `fd_rpc_client_leave`, and `fd_rpc_client_delete`.
# Imports and Dependencies

---
- `fd_rpc_client.h`
- `fd_rpc_client_private.h`
- `../../../util/fd_util.h`
- `../../../util/net/fd_ip4.h`
- `../../../waltz/http/picohttpparser.h`
- `../../../ballet/json/cJSON.h`
- `../../../ballet/base58/fd_base58.h`
- `math.h`
- `stdio.h`
- `stdlib.h`
- `unistd.h`
- `pthread.h`
- `sys/socket.h`
- `netinet/ip.h`


# Global Variables

---
### listening
- **Type**: ``volatile int``
- **Description**: A global variable that indicates the listening state of a server socket. It is marked as `volatile` to ensure that changes to its value are immediately visible to all threads.
- **Use**: Used to signal when the server socket is ready to accept connections.


# Functions

---
### fd\_rpc\_serve\_one<!-- {{#callable:fd_rpc_serve_one}} -->
[View Source →](<../../../../../../src/app/shared_dev/rpc_client/test_rpc_client.c#L24>)

Handles a single RPC request over a TCP connection, processes JSON-RPC requests, and sends back a JSON response.
- **Inputs**:
    - `args`: Unused argument, typically for thread function signature compatibility.
- **Logic and Control Flow**:
    - Create a TCP socket and set it to allow address reuse.
    - Bind the socket to the local address `127.0.0.1` and port `12001`.
    - Listen for incoming connections with a backlog of 1.
    - Accept a connection from a client.
    - Receive data from the client in a loop until a complete HTTP request is received.
    - Parse the HTTP request to extract the method, path, headers, and content length.
    - Verify that the request method is `POST` and the `Content-Type` is `application/json`.
    - Parse the JSON content of the request.
    - Determine the requested method (`getLatestBlockhash` or `getTransactionCount`) and prepare the appropriate JSON response.
    - Send the HTTP response back to the client.
    - Close the client and server sockets.
- **Output**: Returns `NULL` after processing the request and sending the response.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../../src/app/shared_dev/rpc_client/test_rpc_client.c#L150>)

Initializes and tests an RPC client by performing various operations such as alignment, footprint verification, transaction count requests, and block hash retrieval.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Logs a notice about testing alignment and footprint, then verifies them using `FD_TEST`.
    - Logs a notice about testing the creation of a new RPC client and creates it using [`fd_rpc_client_new`](<fd_rpc_client.c.md#fd_rpc_client_new>).
    - Logs a notice about testing the join operation and joins the RPC client using [`fd_rpc_client_join`](<fd_rpc_client.h.md#fd_rpc_client_join>).
    - Logs a notice about testing transaction count requests, starts a server thread with `pthread_create`, and waits for it to listen.
    - Requests the transaction count using [`fd_rpc_client_request_transaction_count`](<fd_rpc_client.c.md#fd_rpc_client_request_transaction_count>), checks the response status, and verifies the transaction count.
    - Closes the RPC client request and joins the server thread.
    - Logs a notice about testing the latest block hash request, starts a server thread, and waits for it to listen.
    - Requests the latest block hash using [`fd_rpc_client_request_latest_block_hash`](<fd_rpc_client.c.md#fd_rpc_client_request_latest_block_hash>), checks the response status, and verifies the block hash.
    - Closes the RPC client request and joins the server thread.
    - Logs a notice about testing the leave operation and verifies it using [`fd_rpc_client_leave`](<fd_rpc_client.h.md#fd_rpc_client_leave>).
    - Logs a notice about testing the delete operation and verifies it using [`fd_rpc_client_delete`](<fd_rpc_client.h.md#fd_rpc_client_delete>).
    - Logs a notice indicating the tests passed and calls `fd_halt` to terminate the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`fd_rpc_client_align`](<fd_rpc_client.h.md#fd_rpc_client_align>)
    - [`fd_rpc_client_footprint`](<fd_rpc_client.h.md#fd_rpc_client_footprint>)
    - [`fd_rpc_client_new`](<fd_rpc_client.c.md#fd_rpc_client_new>)
    - [`fd_rpc_client_join`](<fd_rpc_client.h.md#fd_rpc_client_join>)
    - [`fd_rpc_client_request_transaction_count`](<fd_rpc_client.c.md#fd_rpc_client_request_transaction_count>)
    - [`fd_rpc_client_status`](<fd_rpc_client.c.md#fd_rpc_client_status>)
    - [`fd_rpc_client_close`](<fd_rpc_client.c.md#fd_rpc_client_close>)
    - [`fd_rpc_client_request_latest_block_hash`](<fd_rpc_client.c.md#fd_rpc_client_request_latest_block_hash>)
    - [`fd_rpc_client_leave`](<fd_rpc_client.h.md#fd_rpc_client_leave>)
    - [`fd_rpc_client_delete`](<fd_rpc_client.h.md#fd_rpc_client_delete>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)