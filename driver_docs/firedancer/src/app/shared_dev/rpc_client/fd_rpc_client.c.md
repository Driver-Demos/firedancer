<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements an RPC client for handling JSON-RPC requests and responses over HTTP in a non-blocking manner.

# Purpose
The code is a C implementation of an RPC (Remote Procedure Call) client. It is designed to communicate with a remote server using HTTP requests. The primary functionality includes creating and managing RPC requests, sending these requests to a server, and handling the responses. The code defines several functions to initialize the client, send requests for specific methods such as `getLatestBlockhash` and `getTransactionCount`, and process the server's responses. It uses non-blocking sockets and the `poll` system call to manage multiple requests concurrently.

The code includes functions like [`fd_rpc_client_new`](<#fd_rpc_client_new>) to initialize a new RPC client, [`fd_rpc_client_request`](<#fd_rpc_client_request>) to send a request, and [`fd_rpc_client_service`](<#fd_rpc_client_service>) to handle the communication with the server. It also defines helper functions to find available slots for requests and parse HTTP responses. The code uses external libraries such as `picohttpparser` for parsing HTTP responses and `cJSON` for handling JSON data. The client is designed to handle errors and manage the state of each request, ensuring that resources are properly allocated and released.
# Imports and Dependencies

---
- `fd_rpc_client.h`
- `fd_rpc_client_private.h`
- `../../../waltz/http/picohttpparser.h`
- `../../../ballet/json/cJSON.h`
- `../../../ballet/base58/fd_base58.h`
- `errno.h`
- `stdio.h`
- `stdlib.h`
- `unistd.h`
- `strings.h`
- `sys/socket.h`
- `sys/types.h`
- `netinet/ip.h`


# Functions

---
### fd\_rpc\_client\_new<!-- {{#callable:fd_rpc_client_new}} -->
[View Source →](<../../../../../../src/app/shared_dev/rpc_client/fd_rpc_client.c#L19>)

Initializes an `fd_rpc_client_t` structure with specified memory, address, and port, and sets up its request slots and file descriptors.
- **Inputs**:
    - ``mem``: A pointer to the memory location where the `fd_rpc_client_t` structure will be initialized.
    - ``rpc_addr``: An unsigned integer representing the RPC server address.
    - ``rpc_port``: An unsigned short representing the RPC server port.
- **Logic and Control Flow**:
    - Cast `mem` to an `fd_rpc_client_t` pointer and assign it to `rpc`.
    - Set `rpc->request_id` to 0.
    - Assign `rpc_addr` to `rpc->rpc_addr` and `rpc_port` to `rpc->rpc_port`.
    - Iterate over each request slot up to `FD_RPC_CLIENT_REQUEST_CNT`.
    - For each slot, set `state` to `FD_RPC_CLIENT_STATE_NONE`, `fd` to -1, and `events` to `POLLIN | POLLOUT`.
    - Return the initialized `rpc` pointer cast to `void *`.
- **Output**: A pointer to the initialized `fd_rpc_client_t` structure.


---
### fd\_rpc\_client\_wait\_ready<!-- {{#callable:fd_rpc_client_wait_ready}} -->
[View Source →](<../../../../../../src/app/shared_dev/rpc_client/fd_rpc_client.c#L35>)

Waits for an RPC client to be ready by attempting to connect to a specified address and port within a given timeout.
- **Inputs**:
    - `rpc`: A pointer to an `fd_rpc_client_t` structure that contains the RPC client configuration, including the address and port to connect to.
    - `timeout_ns`: A long integer representing the timeout duration in nanoseconds for the connection attempt.
- **Logic and Control Flow**:
    - Initialize a `sockaddr_in` structure with the RPC client's address and port, converting the port to network byte order.
    - Initialize a `pollfd` structure to monitor the socket for the `POLLOUT` event.
    - Record the start time using `fd_log_wallclock()`.
    - Enter an infinite loop to attempt connection to the RPC server.
    - Create a non-blocking socket and check for errors; return `FD_RPC_CLIENT_ERR_NETWORK` if socket creation fails.
    - Attempt to connect the socket to the server; if the connection fails and the error is not `EINPROGRESS`, close the socket and return `FD_RPC_CLIENT_ERR_NETWORK`.
    - Enter another loop to poll the socket for readiness or timeout.
    - Check if the current time exceeds the timeout; if so, close the socket and return `FD_RPC_CLIENT_ERR_NETWORK`.
    - Use `poll()` to check the socket's status; if interrupted or no events are ready, continue polling.
    - If `poll()` returns an error, close the socket and return `FD_RPC_CLIENT_ERR_NETWORK`.
    - If the socket is ready for output (`POLLOUT`), close the socket and return `FD_RPC_CLIENT_SUCCESS`.
    - If there is an error or hang-up (`POLLERR` or `POLLHUP`), close the socket and break out of the loop to retry.
- **Output**: Returns `FD_RPC_CLIENT_SUCCESS` if the connection is ready within the timeout, or `FD_RPC_CLIENT_ERR_NETWORK` if there is a network error or the timeout is reached.


---
### fd\_rpc\_available\_slot<!-- {{#callable:fd_rpc_available_slot}} -->
[View Source →](<../../../../../../src/app/shared_dev/rpc_client/fd_rpc_client.c#L86>)

Finds the first available slot in the RPC client's request array that is not in use.
- **Inputs**:
    - `rpc`: A pointer to an `fd_rpc_client_t` structure, which contains the client's request array and other related data.
- **Logic and Control Flow**:
    - Iterate over the `requests` array in the `rpc` structure from index 0 to `FD_RPC_CLIENT_REQUEST_CNT - 1`.
    - Check if the `state` of the current request is `FD_RPC_CLIENT_STATE_NONE`, indicating that the slot is available.
    - If an available slot is found, return its index.
    - If no available slot is found after checking all slots, return `ULONG_MAX`.
- **Output**: The index of the first available slot in the `requests` array, or `ULONG_MAX` if no slot is available.


---
### fd\_rpc\_find\_request<!-- {{#callable:fd_rpc_find_request}} -->
[View Source →](<../../../../../../src/app/shared_dev/rpc_client/fd_rpc_client.c#L94>)

Searches for a request with a specific `request_id` in the `rpc` client's request list and returns its index.
- **Inputs**:
    - ``rpc``: A pointer to an `fd_rpc_client_t` structure representing the RPC client.
    - ``request_id``: A long integer representing the unique identifier of the request to find.
- **Logic and Control Flow**:
    - Iterate over the request list in the `rpc` client, which has a maximum size defined by `FD_RPC_CLIENT_REQUEST_CNT`.
    - For each request, check if its state is not `FD_RPC_CLIENT_STATE_NONE`. If it is, skip to the next request.
    - Check if the `request_id` of the current request's response matches the given `request_id`. If it does, return the index of this request.
    - If no matching request is found, return `ULONG_MAX` to indicate that the request was not found.
- **Output**: Returns the index of the request with the specified `request_id` if found; otherwise, returns `ULONG_MAX`.


---
### fd\_rpc\_client\_request<!-- {{#callable:fd_rpc_client_request}} -->
[View Source →](<../../../../../../src/app/shared_dev/rpc_client/fd_rpc_client.c#L105>)

Sends an HTTP POST request to a specified RPC server and manages the connection state.
- **Inputs**:
    - `rpc`: A pointer to an `fd_rpc_client_t` structure representing the RPC client.
    - `method`: An unsigned long integer representing the method to be used in the request.
    - `request_id`: A long integer representing the unique identifier for the request.
    - `contents`: A pointer to a character array containing the request payload in JSON format.
    - `contents_len`: An integer representing the length of the `contents` array.
- **Logic and Control Flow**:
    - Finds an available slot in the `rpc` client for the new request using [`fd_rpc_available_slot`](<#fd_rpc_available_slot>) function.
    - Checks if the `contents_len` is valid and within the maximum allowed length.
    - Formats the HTTP POST request into `request->connected.request_bytes` using `snprintf`.
    - Creates a non-blocking socket with `socket` and attempts to connect to the server using `connect`.
    - If the connection is successful or in progress, updates the `rpc` and `request` structures with the connection details and sets the request state to `FD_RPC_CLIENT_STATE_CONNECTED`.
    - Returns the `request_id` if successful, or an error code if any step fails.
- **Output**: Returns the `request_id` if the request is successfully initiated, or an error code if an error occurs during the process.
- **Functions Called**:
    - [`fd_rpc_available_slot`](<#fd_rpc_available_slot>)


---
### fd\_rpc\_client\_request\_latest\_block\_hash<!-- {{#callable:fd_rpc_client_request_latest_block_hash}} -->
[View Source →](<../../../../../../src/app/shared_dev/rpc_client/fd_rpc_client.c#L153>)

Sends a request to obtain the latest block hash from an RPC server.
- **Inputs**:
    - `rpc`: A pointer to an `fd_rpc_client_t` structure representing the RPC client.
- **Logic and Control Flow**:
    - Initialize a character array `contents` with a maximum length of `MAX_REQUEST_LEN`.
    - Calculate the next `request_id` by checking if the current `rpc->request_id` is `LONG_MAX`; if so, reset to 0, otherwise increment by 1.
    - Format a JSON-RPC request string into `contents` using `snprintf`, specifying the method `getLatestBlockhash` and the parameter `commitment` set to `processed`.
    - Call `fd_rpc_client_request` with the prepared `contents` and its length to send the request to the server.
- **Output**: Returns the `request_id` of the sent request, or an error code if the request fails.


---
### fd\_rpc\_client\_request\_transaction\_count<!-- {{#callable:fd_rpc_client_request_transaction_count}} -->
[View Source →](<../../../../../../src/app/shared_dev/rpc_client/fd_rpc_client.c#L165>)

Sends a JSON-RPC request to get the transaction count from a remote server using the provided RPC client.
- **Inputs**:
    - `rpc`: A pointer to an `fd_rpc_client_t` structure representing the RPC client used to send the request.
- **Logic and Control Flow**:
    - Initialize a character array `contents` with a maximum length of `MAX_REQUEST_LEN`.
    - Calculate the `request_id` by checking if `rpc->request_id` is equal to `LONG_MAX`; if true, set it to 0, otherwise increment it by 1.
    - Format a JSON-RPC request string into the `contents` array using `snprintf`, specifying the method `getTransactionCount` and a parameter with commitment `processed`.
    - Call `fd_rpc_client_request` with the RPC client, method identifier `FD_RPC_CLIENT_METHOD_TRANSACTION_COUNT`, `request_id`, `contents`, and the length of the contents to send the request.
    - Return the result of `fd_rpc_client_request`, which is the `request_id` if successful or an error code if not.
- **Output**: Returns the `request_id` of the sent request or an error code if the request fails.


---
### fd\_rpc\_mark\_error<!-- {{#callable:fd_rpc_mark_error}} -->
[View Source →](<../../../../../../src/app/shared_dev/rpc_client/fd_rpc_client.c#L177>)

Marks an RPC request as finished with an error status and closes the associated file descriptor if it is open.
- **Inputs**:
    - ``rpc``: A pointer to an `fd_rpc_client_t` structure representing the RPC client.
    - ``idx``: An unsigned long integer representing the index of the request in the `rpc` structure.
    - ``error``: A long integer representing the error code to set for the request.
- **Logic and Control Flow**:
    - Checks if the file descriptor at index `idx` in `rpc->fds` is open (i.e., greater than or equal to 0).
    - If the file descriptor is open, attempts to close it using `close()`.
    - Logs a warning if `close()` fails.
    - Sets the file descriptor at index `idx` to -1 to mark it as closed.
    - Sets the state of the request at index `idx` in `rpc->requests` to `FD_RPC_CLIENT_STATE_FINISHED`.
    - Sets the response status of the request at index `idx` to the provided `error` code.
- **Output**: No return value (void function).


---
### fd\_rpc\_phr\_content\_length<!-- {{#callable:fd_rpc_phr_content_length}} -->
[View Source →](<../../../../../../src/app/shared_dev/rpc_client/fd_rpc_client.c#L189>)

Extracts the 'Content-Length' value from HTTP headers.
- **Inputs**:
    - ``headers``: A pointer to an array of `phr_header` structures representing HTTP headers.
    - ``num_headers``: The number of headers in the `headers` array.
- **Logic and Control Flow**:
    - Iterates over each header in the `headers` array.
    - Checks if the header name length is 14 and matches 'Content-Length' (case-insensitive).
    - If a match is found, attempts to convert the header's value to an unsigned long integer using `strtoul`.
    - If conversion fails (i.e., no digits were found), returns `ULONG_MAX`.
    - If conversion succeeds, returns the parsed content length.
    - If no 'Content-Length' header is found, returns `ULONG_MAX`.
- **Output**: Returns the content length as an unsigned long integer, or `ULONG_MAX` if the 'Content-Length' header is not found or invalid.


---
### parse\_response<!-- {{#callable:parse_response}} -->
[View Source →](<../../../../../../src/app/shared_dev/rpc_client/fd_rpc_client.c#L203>)

Parses an HTTP response to extract JSON data and updates the result based on the method specified.
- **Inputs**:
    - ``response``: A pointer to the HTTP response data to parse.
    - ``response_len``: The length of the response data.
    - ``last_response_len``: The length of the last response data processed.
    - ``result``: A pointer to a `fd_rpc_client_response_t` structure where the parsed result will be stored.
- **Logic and Control Flow**:
    - Call `phr_parse_response` to parse the HTTP response and extract the HTTP version, status, message, and headers.
    - Check if the parsing is incomplete (`-2`) or malformed (`-1`) and return appropriate error codes.
    - Verify if the HTTP status is 200; otherwise, return a malformed error.
    - Determine the content length from the headers using [`fd_rpc_phr_content_length`](<#fd_rpc_phr_content_length>) and check for errors or size limits.
    - Parse the JSON content from the response using `cJSON_ParseWithLengthOpts` and handle parsing errors.
    - Based on the `result->method`, extract specific JSON fields and update the `result` structure.
    - For `FD_RPC_CLIENT_METHOD_TRANSACTION_COUNT`, extract the transaction count and update `result->result.transaction_count.transaction_count`.
    - For `FD_RPC_CLIENT_METHOD_LATEST_BLOCK_HASH`, extract the block hash, decode it using `fd_base58_decode_32`, and update `result->result.latest_block_hash.block_hash`.
    - Return success or error codes based on the parsing and extraction results.
- **Output**: Returns a status code indicating success, pending, or various error conditions.
- **Functions Called**:
    - [`fd_rpc_phr_content_length`](<#fd_rpc_phr_content_length>)


---
### fd\_rpc\_client\_service<!-- {{#callable:fd_rpc_client_service}} -->
[View Source →](<../../../../../../src/app/shared_dev/rpc_client/fd_rpc_client.c#L281>)

Processes RPC client requests by polling file descriptors and handling send/receive operations.
- **Inputs**:
    - `rpc`: A pointer to an `fd_rpc_client_t` structure that contains the RPC client state and request information.
    - `wait`: An integer that determines the polling behavior; if non-zero, the function waits indefinitely for events, otherwise it returns immediately if no events are available.
- **Logic and Control Flow**:
    - Set `timeout` to -1 if `wait` is non-zero, otherwise set it to 0.
    - Call `poll` on the file descriptors in `rpc->fds` with the specified `timeout`.
    - If `poll` returns 0 or is interrupted (`errno==EINTR`), return 0.
    - If `poll` fails with an error, log the error and terminate the program.
    - Iterate over each request in `rpc->requests`.
    - For requests in `FD_RPC_CLIENT_STATE_CONNECTED` state with `POLLOUT` event, attempt to send data using `send`.
    - If `send` fails with `EAGAIN`, continue to the next request; if it fails with another error, mark the request as having a network error.
    - Update the number of bytes sent and change the request state to `FD_RPC_CLIENT_STATE_SENT` if all bytes are sent.
    - For requests in `FD_RPC_CLIENT_STATE_SENT` state with `POLLIN` event, attempt to receive data using `recv`.
    - If `recv` fails with `EAGAIN`, continue to the next request; if it fails with another error, mark the request as having a network error.
    - Update the number of bytes read and check if the response buffer is full, marking an error if it is.
    - Parse the response using [`parse_response`](<#parse_response>) and handle the result based on the status returned.
    - If the response is successfully parsed, close the file descriptor, update the response status, and set the request state to `FD_RPC_CLIENT_STATE_FINISHED`.
    - Return 1 to indicate that at least one request was processed.
- **Output**: Returns 1 if at least one request was processed, otherwise returns 0 if no events were available or the poll was interrupted.
- **Functions Called**:
    - [`fd_rpc_mark_error`](<#fd_rpc_mark_error>)
    - [`parse_response`](<#parse_response>)


---
### fd\_rpc\_client\_status<!-- {{#callable:fd_rpc_client_status}} -->
[View Source →](<../../../../../../src/app/shared_dev/rpc_client/fd_rpc_client.c#L346>)

Retrieves the status of a specific RPC client request, optionally waiting for its completion.
- **Inputs**:
    - `rpc`: A pointer to an `fd_rpc_client_t` structure representing the RPC client.
    - `request_id`: A long integer representing the unique identifier of the request to check.
    - `wait`: An integer flag indicating whether to wait for the request to complete (non-zero) or not (zero).
- **Logic and Control Flow**:
    - Finds the index of the request with the given `request_id` using [`fd_rpc_find_request`](<#fd_rpc_find_request>) function.
    - If the request is not found (`idx` is `ULONG_MAX`), returns `NULL`.
    - If `wait` is zero, returns the response of the request at the found index immediately.
    - If `wait` is non-zero, enters a loop where it checks if the request state is `FD_RPC_CLIENT_STATE_FINISHED`.
    - If the request is finished, returns the response of the request.
    - If the request is not finished, calls [`fd_rpc_client_service`](<#fd_rpc_client_service>) to process the request and continues the loop.
- **Output**: A pointer to an `fd_rpc_client_response_t` structure containing the response of the request, or `NULL` if the request is not found.
- **Functions Called**:
    - [`fd_rpc_find_request`](<#fd_rpc_find_request>)
    - [`fd_rpc_client_service`](<#fd_rpc_client_service>)


---
### fd\_rpc\_client\_close<!-- {{#callable:fd_rpc_client_close}} -->
[View Source →](<../../../../../../src/app/shared_dev/rpc_client/fd_rpc_client.c#L361>)

Closes the RPC client connection for a specific request and resets its state.
- **Inputs**:
    - `rpc`: A pointer to the `fd_rpc_client_t` structure representing the RPC client.
    - `request_id`: The identifier of the request to close.
- **Logic and Control Flow**:
    - Finds the index of the request with the given `request_id` using [`fd_rpc_find_request`](<#fd_rpc_find_request>) function.
    - If the index is `ULONG_MAX`, indicating the request was not found, the function returns immediately.
    - Checks if the file descriptor at the found index is valid (greater than or equal to 0).
    - If the file descriptor is valid, attempts to close it using the `close` function.
    - Logs a warning if the `close` function fails.
    - Sets the file descriptor at the found index to -1 to mark it as closed.
    - Resets the state of the request at the found index to `FD_RPC_CLIENT_STATE_NONE`.
- **Output**: No output is returned.
- **Functions Called**:
    - [`fd_rpc_find_request`](<#fd_rpc_find_request>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)