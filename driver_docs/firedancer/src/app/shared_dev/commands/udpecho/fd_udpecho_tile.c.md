<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Mirrors incoming UDP packets back to the source for connectivity testing, with potential risks in production.

# Purpose
The code is a C module that implements a UDP echo service. It is designed to receive UDP packets and send them back to the original sender. This functionality is useful for testing network connectivity. The module defines a context structure `fd_udpecho_tile_ctx_t` to manage the state of the echo service, including pointers to input and output data buffers, packet size, and IP address information.

The module includes several static functions to handle the initialization and processing of packets. The [`unprivileged_init`](<#unprivileged_init>) function sets up the input and output data buffers and initializes the context structure. The [`during_frag`](<#during_frag>) function processes incoming packets, checks their validity, and prepares them for echoing back. The [`after_frag`](<#after_frag>) function finalizes the packet processing and publishes the echoed packet. The module uses macros to define callback functions and includes another source file, `fd_stem.c`, to handle the main execution loop. The `fd_tile_udpecho` structure defines the entry points for running the echo service, including alignment and footprint requirements, initialization, and execution functions.
# Imports and Dependencies

---
- `../../../../disco/topo/fd_topo.h`
- `../../../../disco/stem/fd_stem.c`


# Global Variables

---
### fd\_tile\_udpecho
- **Type**: ``fd_topo_run_tile_t``
- **Description**: Defines a tile configuration for running a UDP echo service. The structure includes function pointers and parameters necessary for initializing and running the tile.
- **Use**: Used to configure and execute a UDP echo tile in a network topology.


# Data Structures

---
### fd\_udpecho\_tile\_ctx
- **Type**: ``struct``
- **Members**:
    - ``in_base``: Pointer to the base address of the input data.
    - ``out_base``: Pointer to the base address of the output data.
    - ``chunk0``: Initial chunk index for data processing.
    - ``wmark``: Watermark for data processing limits.
    - ``chunk``: Current chunk index for data processing.
    - ``pkt_sz``: Size of the packet being processed.
    - ``ip4_dst``: Destination IPv4 address for the packet.
- **Description**: The `fd_udpecho_tile_ctx` structure is used to manage the context for echoing UDP packets back to their source. It contains pointers to input and output data bases, chunk indices for data processing, a watermark to limit processing, the size of the packet being processed, and the destination IPv4 address for the packet. This structure is part of a system that mirrors incoming UDP packets, which is useful for testing connectivity.


---
### fd\_udpecho\_tile\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``in_base``: Pointer to the base address of the input data.
    - ``out_base``: Pointer to the base address of the output data.
    - ``chunk0``: Initial chunk index for data processing.
    - ``wmark``: Watermark for data processing limits.
    - ``chunk``: Current chunk index for data processing.
    - ``pkt_sz``: Size of the packet being processed.
    - ``ip4_dst``: Destination IPv4 address for the packet.
- **Description**: The `fd_udpecho_tile_ctx_t` structure is used to manage the context for echoing UDP packets back to their source. It contains pointers to input and output data bases, chunk indices for data processing, a watermark for processing limits, the size of the packet being processed, and the destination IPv4 address for the packet. This structure is part of a system that mirrors incoming UDP packets, which is useful for testing connectivity.


# Functions

---
### scratch\_align<!-- {{#callable:scratch_align}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/udpecho/fd_udpecho_tile.c#L19>)

Returns the alignment requirement of the `fd_udpecho_tile_ctx_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls the `alignof` operator on the `fd_udpecho_tile_ctx_t` type to determine its alignment requirement.
    - Returns the result of the `alignof` operation.
- **Output**: The alignment requirement of the `fd_udpecho_tile_ctx_t` structure as an `ulong`.


---
### scratch\_footprint<!-- {{#callable:scratch_footprint}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/udpecho/fd_udpecho_tile.c#L24>)

Calculates the memory footprint required for a `fd_udpecho_tile_ctx_t` structure.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure, which is not used in this function.
- **Logic and Control Flow**:
    - The function takes a single argument `tile`, which is marked as unused with `FD_PARAM_UNUSED`.
    - It returns the size of the `fd_udpecho_tile_ctx_t` structure using the `sizeof` operator.
- **Output**: The function returns an `ulong` representing the size of the `fd_udpecho_tile_ctx_t` structure.


---
### unprivileged\_init<!-- {{#callable:unprivileged_init}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/udpecho/fd_udpecho_tile.c#L29>)

Initializes the context for a tile in the topology by setting up input and output data cache bases and related parameters.
- **Inputs**:
    - ``topo``: A pointer to an `fd_topo_t` structure representing the topology configuration.
    - ``tile``: A pointer to an `fd_topo_tile_t` structure representing the specific tile to initialize.
- **Logic and Control Flow**:
    - Retrieve the local address of the tile context using `fd_topo_obj_laddr` with `topo` and `tile->tile_obj_id`.
    - Verify that the tile has exactly one output link using `FD_TEST`.
    - Determine the output base and data cache using the topology's workspace and link information, and store them in the context.
    - Calculate and store the initial chunk and watermark for the output data cache using `fd_dcache_compact_chunk0` and `fd_dcache_compact_wmark`.
    - Set the current chunk in the context to the initial chunk value.
    - Verify that the tile has exactly one input link using `FD_TEST`.
    - Determine the input base using the topology's workspace and link information, and store it in the context.
- **Output**: No return value; the function modifies the `fd_udpecho_tile_ctx_t` context associated with the tile.


---
### during\_frag<!-- {{#callable:during_frag}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/udpecho/fd_udpecho_tile.c#L47>)

Processes incoming UDP packets, swaps source and destination addresses, and prepares them for echoing back to the sender.
- **Inputs**:
    - `ctx`: A pointer to the `fd_udpecho_tile_ctx_t` structure, which holds context information for the UDP echo operation.
    - `in_idx`: An unused parameter, marked with `FD_PARAM_UNUSED`.
    - `seq`: The sequence number used to set the IP header's identification field.
    - `sig`: An unused parameter, marked with `FD_PARAM_UNUSED`.
    - `chunk`: The index of the input data chunk to process.
    - `sz`: The size of the incoming packet.
    - `ctl`: The control offset used to locate the start of the packet data within the chunk.
- **Logic and Control Flow**:
    - Check if the packet size `sz` is less than or equal to `FD_NET_MTU`; if not, set `ctx->pkt_sz` to 0 and return.
    - Calculate the minimum size `minsz` required for Ethernet, IP, and UDP headers; if `sz` is less than `minsz`, return.
    - Convert the input chunk to a local address `frame_in` and adjust by `ctl`; convert the output chunk to a local address `frame_out`.
    - Extract the Ethernet header from `frame_in` and check if the network type is IP; if not, return.
    - Extract the IP header and check if the version is IPv4; if not, return.
    - Calculate the IP header length and total length; adjust `sz` to the minimum of `sz` and the IP total length plus Ethernet header size.
    - Check if `sz` is less than the combined size of Ethernet, IP, and UDP headers; if so, return.
    - Check if the IP protocol is UDP; if not, return.
    - Extract the UDP header and check if the length is valid; if not, return.
    - Calculate the size of the UDP datagram and check if it fits within the packet size; if not, return.
    - Prepare the Ethernet header for the outgoing packet and store it in `frame_out`.
    - Prepare the IP header for the outgoing packet, swapping source and destination addresses, and store it in `frame_out`.
    - Prepare the UDP header for the outgoing packet, swapping source and destination ports, and store it in `frame_out`.
    - Copy the UDP datagram from `frame_in` to `frame_out`.
    - Set `ctx->pkt_sz` to the total size of the outgoing packet.
- **Output**: No direct output; modifies the `ctx` structure to store the size of the processed packet and prepares the packet for transmission.


---
### after\_frag<!-- {{#callable:after_frag}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/udpecho/fd_udpecho_tile.c#L113>)

Publishes a packet using the `fd_stem_publish` function and updates the chunk index for the next packet.
- **Inputs**:
    - ``ctx``: A pointer to `fd_udpecho_tile_ctx_t` structure containing context information for the UDP echo tile.
    - ``in_idx``: An unused parameter representing the index of the incoming packet.
    - ``in_seq``: An unused parameter representing the sequence number of the incoming packet.
    - ``in_sig``: An unused parameter representing the signal of the incoming packet.
    - ``in_sz``: An unused parameter representing the size of the incoming packet.
    - ``in_tsorig``: A timestamp representing the original time of the incoming packet.
    - ``in_tspub``: An unused parameter representing the publish time of the incoming packet.
    - ``stem``: A pointer to `fd_stem_context_t` structure used for publishing the packet.
- **Logic and Control Flow**:
    - Calculate `out_sig` using `fd_disco_netmux_sig` with parameters including `ctx->ip4_dst` and a constant value `42`.
    - Assign `ctx->chunk` to `out_chunk` and `ctx->pkt_sz` to `out_sz`.
    - Call `fd_stem_publish` with `stem`, `out_sig`, `out_chunk`, `out_sz`, and `in_tsorig` to publish the packet.
    - Update `ctx->chunk` using `fd_dcache_compact_next` with `out_chunk`, `out_sz`, `ctx->chunk0`, and `ctx->wmark`.
- **Output**: No return value; the function operates by side effects on the `ctx` and `stem` structures.



---
Made with ❤️ by [Driver](https://www.driver.ai/)