<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for tracing and parsing QUIC frames in a network context.

# Purpose
The code is a C source file that implements functionality for tracing and parsing QUIC (Quick UDP Internet Connections) frames. It includes several functions that handle different types of QUIC frames, such as padding, acknowledgment, crypto, and stream frames. The file uses macros to define stub functions for frame types that do not require detailed processing. These stub functions return a constant value, indicating that no specific action is needed for those frame types.

The file includes functions that decode and process various frame types, checking for parsing errors and handling specific frame attributes like length and type. The [`fd_quic_trace_frame`](<#fd_quic_trace_frame>) function is central to the file, as it determines the frame type and calls the appropriate handler function. The [`fd_quic_trace_frames`](<#fd_quic_trace_frames>) function iterates over a buffer of data, calling [`fd_quic_trace_frame`](<#fd_quic_trace_frame>) for each frame until all frames are processed or a parsing error occurs. The file also includes several header files and other source files, indicating that it is part of a larger QUIC protocol implementation.
# Imports and Dependencies

---
- `fd_quic_trace.h`
- `../../../shared/fd_config.h`
- `../../../../waltz/quic/fd_quic_proto.c`
- `../../../../waltz/quic/templ/fd_quic_frame.h`
- `../../../../waltz/quic/templ/fd_quic_dft.h`
- `../../../../waltz/quic/templ/fd_quic_frames_templ.h`
- `../../../../waltz/quic/templ/fd_quic_undefs.h`


# Functions

---
### fd\_quic\_trace\_padding\_frame<!-- {{#callable:fd_quic_trace_padding_frame}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/quic_trace/fd_quic_trace_frame.c#L18>)

Calculates the size of padding in a given byte array by counting consecutive zero bytes from the start.
- **Inputs**:
    - `context`: Unused parameter, typically for context information.
    - `frame`: Unused parameter, typically for frame information.
    - `p`: Pointer to the byte array to analyze.
    - `p_sz`: Size of the byte array.
- **Logic and Control Flow**:
    - Initialize `pad_sz` to 0.
    - Iterate over the byte array `p` while `pad_sz` is less than `p_sz` and the current byte is zero.
    - Increment `pad_sz` and move to the next byte in the array.
    - Return the value of `pad_sz`, which represents the number of consecutive zero bytes from the start.
- **Output**: Returns the number of consecutive zero bytes from the start of the byte array `p`.


---
### fd\_quic\_trace\_ack\_frame<!-- {{#callable:fd_quic_trace_ack_frame}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/quic_trace/fd_quic_trace_frame.c#L31>)

Parses and processes a QUIC ACK frame, decoding its ACK ranges and optional ECN counts.
- **Inputs**:
    - `context`: Unused parameter in the function.
    - `frame`: Pointer to a `fd_quic_ack_frame_t` structure containing the ACK frame data.
    - `p`: Pointer to the start of the data buffer to parse.
    - `p_sz`: Size of the data buffer to parse.
- **Logic and Control Flow**:
    - Initialize `p_begin` to `p` and `p_end` to `p + p_sz` to mark the start and end of the buffer.
    - Iterate over each ACK range in `frame->ack_range_count`.
    - For each range, check if `p` has reached or exceeded `p_end`; if so, return `FD_QUIC_PARSE_FAIL`.
    - Decode the ACK range fragment using `fd_quic_decode_ack_range_frag` and update `p` by the number of bytes processed.
    - If decoding fails, return `FD_QUIC_PARSE_FAIL`.
    - If `frame->type` indicates ECN counts are present, decode them using `fd_quic_decode_ecn_counts_frag` and update `p`.
    - If decoding ECN counts fails, return `FD_QUIC_PARSE_FAIL`.
    - Return the number of bytes processed, calculated as `p - p_begin`.
- **Output**: Returns the number of bytes processed from the buffer, or `FD_QUIC_PARSE_FAIL` if parsing fails.


---
### fd\_quic\_trace\_crypto\_frame<!-- {{#callable:fd_quic_trace_crypto_frame}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/quic_trace/fd_quic_trace_frame.c#L62>)

Validates the length of a QUIC crypto frame against the provided size and returns the frame's length if valid.
- **Inputs**:
    - `context`: Unused parameter, typically for passing additional data or state.
    - `frame`: Pointer to a `fd_quic_crypto_frame_t` structure representing the crypto frame to be processed.
    - `p`: Unused parameter, typically a pointer to the data buffer.
    - `p_sz`: Size of the data buffer `p`.
- **Logic and Control Flow**:
    - Check if the `frame->length` is greater than `p_sz` using `FD_UNLIKELY` macro for unlikely conditions.
    - If `frame->length` is greater than `p_sz`, return `FD_QUIC_PARSE_FAIL`.
    - If `frame->length` is not greater than `p_sz`, return `frame->length`.
- **Output**: Returns the length of the crypto frame if it is valid; otherwise, returns `FD_QUIC_PARSE_FAIL` if the frame's length exceeds the provided size.


---
### fd\_quic\_trace\_stream\_8\_frame<!-- {{#callable:fd_quic_trace_stream_8_frame}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/quic_trace/fd_quic_trace_frame.c#L74>)

Logs details of a QUIC stream frame and returns the size of the frame.
- **Inputs**:
    - `context`: A pointer to `fd_quic_trace_frame_ctx_t` structure containing context information for the QUIC trace.
    - `data`: A pointer to `fd_quic_stream_8_frame_t` structure containing the stream frame data.
    - `p`: An unused pointer to a constant unsigned character array.
    - `p_sz`: An unsigned long integer representing the size of the frame.
- **Logic and Control Flow**:
    - Calls `printf` to log the timestamp, connection ID, source IP, source port, packet number, stream ID, frame size, and the 'fin' flag of the stream frame.
    - Returns the size of the frame `p_sz`.
- **Output**: Returns the size of the frame as an unsigned long integer.


---
### fd\_quic\_trace\_stream\_a\_frame<!-- {{#callable:fd_quic_trace_stream_a_frame}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/quic_trace/fd_quic_trace_frame.c#L92>)

Validates and logs information about a QUIC stream frame, returning the frame's length if successful.
- **Inputs**:
    - `context`: A pointer to `fd_quic_trace_frame_ctx_t` structure containing context information for the QUIC trace.
    - `data`: A pointer to `fd_quic_stream_a_frame_t` structure containing the stream frame data to be processed.
    - `p`: An unused pointer to a constant unsigned character array.
    - `p_sz`: The size of the data pointed to by `p`.
- **Logic and Control Flow**:
    - Check if `data->length` is greater than `p_sz`; if true, return `FD_QUIC_PARSE_FAIL`.
    - Log the timestamp, connection ID, source IP, source port, packet number, stream ID, length, and the final bit of the stream frame using `printf`.
    - Return `data->length` as the result.
- **Output**: Returns the length of the stream frame (`data->length`) if the frame is valid, otherwise returns `FD_QUIC_PARSE_FAIL`.


---
### fd\_quic\_trace\_stream\_c\_frame<!-- {{#callable:fd_quic_trace_stream_c_frame}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/quic_trace/fd_quic_trace_frame.c#L111>)

Logs details of a QUIC stream frame and returns the size of the frame.
- **Inputs**:
    - `context`: A pointer to `fd_quic_trace_frame_ctx_t` structure containing connection context information.
    - `data`: A pointer to `fd_quic_stream_c_frame_t` structure containing stream frame data.
    - `p`: An unused pointer to a constant unsigned character array.
    - `p_sz`: The size of the data pointed to by `p`.
- **Logic and Control Flow**:
    - Calls `printf` to log the timestamp, connection ID, source IP, source port, packet number, stream ID, offset, length, and the 'fin' flag of the stream frame.
    - Uses `fd_log_wallclock` to get the current timestamp.
    - Uses `fd_uint_bswap` to convert the source IP from network byte order to host byte order.
    - Returns the value of `p_sz`.
- **Output**: Returns the size of the frame, `p_sz`, as an unsigned long integer.


---
### fd\_quic\_trace\_stream\_e\_frame<!-- {{#callable:fd_quic_trace_stream_e_frame}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/quic_trace/fd_quic_trace_frame.c#L130>)

Processes a QUIC stream frame by validating its length and printing its details.
- **Inputs**:
    - `context`: A pointer to `fd_quic_trace_frame_ctx_t` structure containing context information for the QUIC trace.
    - `data`: A pointer to `fd_quic_stream_e_frame_t` structure containing the stream frame data to process.
    - `p`: An unused pointer to a constant unsigned character array.
    - `p_sz`: An unsigned long integer representing the size of the data pointed to by `p`.
- **Logic and Control Flow**:
    - Check if `data->length` is greater than `p_sz`; if true, return `FD_QUIC_PARSE_FAIL`.
    - Print the timestamp, connection ID, source IP, source port, packet number, stream ID, offset, length, and the 'fin' flag of the stream frame.
    - Return `data->length`.
- **Output**: Returns the length of the stream frame if successful, or `FD_QUIC_PARSE_FAIL` if the length is invalid.


---
### fd\_quic\_trace\_conn\_close\_0\_frame<!-- {{#callable:fd_quic_trace_conn_close_0_frame}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/quic_trace/fd_quic_trace_frame.c#L161>)

Checks if the `reason_phrase_length` in a `fd_quic_conn_close_0_frame_t` structure exceeds the provided size and returns the length if valid.
- **Inputs**:
    - `context`: Unused parameter, typically used for passing additional data or state.
    - `frame`: Pointer to a `fd_quic_conn_close_0_frame_t` structure containing the connection close frame data.
    - `p`: Unused parameter, typically used for passing additional data or state.
    - `p_sz`: Size of the buffer or data available for processing.
- **Logic and Control Flow**:
    - Check if `frame->reason_phrase_length` is greater than `p_sz` using `FD_UNLIKELY` macro for unlikely conditions.
    - If the condition is true, return `FD_QUIC_PARSE_FAIL`.
    - If the condition is false, return `frame->reason_phrase_length`.
- **Output**: Returns `FD_QUIC_PARSE_FAIL` if the `reason_phrase_length` exceeds `p_sz`, otherwise returns the `reason_phrase_length`.


---
### fd\_quic\_trace\_conn\_close\_1\_frame<!-- {{#callable:fd_quic_trace_conn_close_1_frame}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/quic_trace/fd_quic_trace_frame.c#L171>)

Checks if the `reason_phrase_length` of a `fd_quic_conn_close_1_frame_t` frame exceeds the given size and returns the length if valid.
- **Inputs**:
    - `context`: Unused parameter, typically used for passing additional data or state.
    - `frame`: Pointer to a `fd_quic_conn_close_1_frame_t` structure containing the frame data.
    - `p`: Unused parameter, typically a pointer to additional data.
    - `p_sz`: Size of the data pointed to by `p`, used to validate the `reason_phrase_length`.
- **Logic and Control Flow**:
    - Check if `frame->reason_phrase_length` is greater than `p_sz` using `FD_UNLIKELY` macro.
    - If the condition is true, return `FD_QUIC_PARSE_FAIL`.
    - If the condition is false, return `frame->reason_phrase_length`.
- **Output**: Returns `FD_QUIC_PARSE_FAIL` if the `reason_phrase_length` exceeds `p_sz`, otherwise returns the `reason_phrase_length`.


---
### fd\_quic\_trace\_frame<!-- {{#callable:fd_quic_trace_frame}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/quic_trace/fd_quic_trace_frame.c#L208>)

Processes a QUIC frame by checking its validity and dispatching it to the appropriate handler based on its ID.
- **Inputs**:
    - `context`: A pointer to `fd_quic_trace_frame_ctx_t` which contains the context for tracing the QUIC frame.
    - `data`: A pointer to an array of `uchar` representing the frame data to be processed.
    - `data_sz`: An `ulong` representing the size of the data array.
- **Logic and Control Flow**:
    - Check if `data_sz` is less than 1; if true, return `FD_QUIC_PARSE_FAIL`.
    - Extract the frame ID from the first byte of `data`.
    - Check if the frame type is allowed using `fd_quic_frame_type_allowed`; if not allowed, log a notice and return `FD_QUIC_PARSE_FAIL`.
    - Use a switch statement on the frame ID to call the appropriate frame handler function using `fd_quic_trace1_##NAME##_frame`.
    - If the frame ID does not match any case, log a notice and return `FD_QUIC_PARSE_FAIL`.
- **Output**: Returns an `ulong` indicating the number of bytes processed or `FD_QUIC_PARSE_FAIL` if parsing fails.


---
### fd\_quic\_trace\_frames<!-- {{#callable:fd_quic_trace_frames}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/quic_trace/fd_quic_trace_frame.c#L233>)

Processes a sequence of QUIC frames from the given data buffer and updates the context accordingly.
- **Inputs**:
    - `context`: A pointer to `fd_quic_trace_frame_ctx_t` which holds the context for tracing QUIC frames.
    - `data`: A pointer to an array of unsigned characters representing the data buffer containing QUIC frames.
    - `data_sz`: An unsigned long integer representing the size of the data buffer.
- **Logic and Control Flow**:
    - While `data_sz` is not zero, continue processing frames.
    - Call [`fd_quic_trace_frame`](<#fd_quic_trace_frame>) with the current context, data, and data size.
    - If [`fd_quic_trace_frame`](<#fd_quic_trace_frame>) returns `FD_QUIC_PARSE_FAIL`, exit the function.
    - If the return value from [`fd_quic_trace_frame`](<#fd_quic_trace_frame>) is greater than `data_sz`, exit the function.
    - Increment the `data` pointer by the return value from [`fd_quic_trace_frame`](<#fd_quic_trace_frame>).
    - Decrement `data_sz` by the return value from [`fd_quic_trace_frame`](<#fd_quic_trace_frame>).
- **Output**: No return value; the function modifies the context and processes the data buffer in place.
- **Functions Called**:
    - [`fd_quic_trace_frame`](<#fd_quic_trace_frame>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)