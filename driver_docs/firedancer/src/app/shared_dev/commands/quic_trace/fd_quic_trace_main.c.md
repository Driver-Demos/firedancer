<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Glue code for the 'fddev quic-trace' subcommand to tap QUIC traffic by joining remote target tile objects.

# Purpose
The `fd_quic_trace_main.c` file is part of a system designed to monitor QUIC (Quick UDP Internet Connections) traffic on a live system. It provides the necessary code to integrate with remote target tile objects, allowing the system to tap into shared memory segments of a target tile running on the same host. This is done in a read-only manner to minimize the impact on the production system. The file includes functions to handle command-line arguments, configure QUIC tracing, and manage connections. It also defines global variables and structures necessary for tracing operations.

The code defines a command function [`quic_trace_cmd_fn`](<#quic_trace_cmd_fn>) that sets up the environment for tracing QUIC traffic. It joins shared memory objects, initializes peer connection ID maps, and iterates over connections to log or insert them into the map. The file also includes functions to dump QUIC configuration and connection details, providing diagnostic information about the QUIC connections. The `fd_action_quic_trace` structure at the end of the file defines the action for the `quic-trace` command, specifying its name, argument handling function, execution function, description, and diagnostic status.
# Imports and Dependencies

---
- `fd_quic_trace.h`
- `../../../../disco/metrics/fd_metrics.h`
- `../../../../disco/quic/fd_quic_tile.h`
- `../../../../discof/send/fd_send_tile.h`
- `../../../../waltz/quic/log/fd_quic_log_user.h`
- `../../../../ballet/hex/fd_hex.h`
- `stdlib.h`


# Global Variables

---
### fd\_quic\_trace\_tile\_ctx\_remote
- **Type**: `void const *`
- **Description**: Points to the remote context of a QUIC tile in shared memory. This variable is used to access the original objects in shared memory for QUIC tracing purposes.
- **Use**: Used to reference the remote QUIC tile context in shared memory for read-only operations.


---
### fd\_quic\_trace\_tile\_ctx\_raddr
- **Type**: `ulong`
- **Description**: `fd_quic_trace_tile_ctx_raddr` is a global variable of type `ulong` that stores the remote address of the original QUIC context object in the tile's address space.
- **Use**: Used to calculate and store the remote address of the QUIC context object for tracing purposes.


---
### fd\_quic\_trace\_target\_fseq
- **Type**: `ulong **`
- **Description**: A pointer to an array of pointers to unsigned long integers. This variable is used to store the sequence numbers of the target tile's input links in the QUIC tracing process.
- **Use**: Monitors the sequence numbers of the target tile's input links to ensure the trace RX tile does not skip ahead of the target tile.


---
### fd\_quic\_trace\_link\_metrics
- **Type**: `ulong volatile *`
- **Description**: `fd_quic_trace_link_metrics` is a pointer to a volatile unsigned long integer, which is used to track metrics related to the QUIC link in a tracing context. This variable is part of the global state used by the QUIC tracing functionality to monitor and log QUIC traffic metrics.
- **Use**: Used to store and update metrics related to the QUIC link during tracing operations.


---
### fd\_quic\_trace\_log\_base
- **Type**: ``void const *``
- **Description**: Points to the base address of the log buffer used for QUIC tracing. This variable is used to access the log data for QUIC events.
- **Use**: Used to access the base of the log buffer for reading QUIC trace logs.


---
### \_fd\_quic\_trace\_peer\_map
- **Type**: `peer_conn_id_map_t`
- **Description**: An array of `peer_conn_id_map_t` structures, sized by shifting 1 left by `PEER_MAP_LG_SLOT_CNT`. This array is used to store peer connection ID mappings for QUIC connections.
- **Use**: Used to initialize and manage peer connection ID mappings for QUIC traffic tracing.


---
### fd\_quic\_trace\_peer\_map
- **Type**: ``peer_conn_id_map_t *``
- **Description**: A pointer to a `peer_conn_id_map_t` data structure, which is used to manage peer connection IDs in the QUIC tracing process. This variable is initialized by joining a shared memory map created by `peer_conn_id_map_new` and is used to store and retrieve connection information based on peer connection IDs.
- **Use**: Used to access and manage peer connection IDs for QUIC connections during the tracing process.


---
### fd\_action\_quic\_trace
- **Type**: ``action_t``
- **Description**: Defines an action for tracing QUIC traffic on a live system. It includes the name of the action, command-line argument processing function, execution function, a description, and a diagnostic flag.
- **Use**: Used to configure and execute the 'quic-trace' subcommand for tracing QUIC traffic.


# Functions

---
### quic\_trace\_cmd\_args<!-- {{#callable:quic_trace_cmd_args}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/quic_trace/fd_quic_trace_main.c#L38>)

Parses command-line arguments to configure QUIC trace settings.
- **Inputs**:
    - ``pargc``: A pointer to an integer representing the count of command-line arguments.
    - ``pargv``: A pointer to an array of strings representing the command-line arguments.
    - ``args``: A pointer to an `args_t` structure where the parsed QUIC trace settings will be stored.
- **Logic and Control Flow**:
    - Call `fd_env_strip_cmdline_cstr` to extract the `--event` argument from the command line, defaulting to "stream" if not provided.
    - Compare the extracted `event` string to "stream" and "error" to set `args->quic_trace.event` to `EVENT_STREAM` or `EVENT_ERROR`, respectively.
    - Log an error and terminate if the `event` string is not "stream" or "error".
    - Call `fd_env_strip_cmdline_contains` to check for the presence of `--dump`, `--dump-config`, `--dump-conns`, and `--send-tile` arguments, setting the corresponding fields in `args->quic_trace`.
- **Output**: No return value; modifies the `args` structure to reflect the parsed command-line arguments.


---
### dump\_val\_enum\_role<!-- {{#callable:dump_val_enum_role}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/quic_trace/fd_quic_trace_main.c#L57>)

Maps an integer role identifier to its corresponding string representation for QUIC roles.
- **Inputs**:
    - `role`: An integer representing the QUIC role, expected to be either `FD_QUIC_ROLE_CLIENT` or `FD_QUIC_ROLE_SERVER`.
- **Logic and Control Flow**:
    - Use a `switch` statement to evaluate the `role` input.
    - If `role` is `FD_QUIC_ROLE_CLIENT`, return the string "ROLE_CLIENT".
    - If `role` is `FD_QUIC_ROLE_SERVER`, return the string "ROLE_SERVER".
    - For any other value of `role`, return the string "ROLE_UNKNOWN".
- **Output**: A constant character pointer to a string representing the role, which can be "ROLE_CLIENT", "ROLE_SERVER", or "ROLE_UNKNOWN".


---
### dump\_val\_bool<!-- {{#callable:dump_val_bool}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/quic_trace/fd_quic_trace_main.c#L69>)

Converts an integer value to a string representation of a boolean or an "invalid" state.
- **Inputs**:
    - `value`: An integer representing a boolean value, where 0 is false, 1 is true, and any other value is invalid.
- **Logic and Control Flow**:
    - Use a switch statement to evaluate the input `value`.
    - If `value` is 0, return the string "false".
    - If `value` is 1, return the string "true".
    - For any other `value`, return the string "invalid".
- **Output**: A constant character pointer to a string representing "false", "true", or "invalid".


---
### dump\_quic\_config<!-- {{#callable:dump_quic_config}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/quic_trace/fd_quic_trace_main.c#L78>)

Logs the configuration details of a QUIC configuration object.
- **Inputs**:
    - `config`: A pointer to an `fd_quic_config_t` structure containing the QUIC configuration to be logged.
- **Logic and Control Flow**:
    - Checks the `role` field of the `config` structure and logs whether it is a client, server, or unknown.
    - Defines several macros to format and log different types of configuration values, such as enums, booleans, units, values, pointers, and 32-byte hexadecimal arrays.
    - Uses the `FD_QUIC_CONFIG_LIST` macro to iterate over configuration fields and log their values using the appropriate formatting macro.
- **Output**: No return value; the function outputs log messages to the logging system.


---
### peer\_cid\_str<!-- {{#callable:peer_cid_str}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/quic_trace/fd_quic_trace_main.c#L123>)

Converts the first peer connection ID of a QUIC connection to a hexadecimal string.
- **Inputs**:
    - `conn`: A pointer to a constant `fd_quic_conn_t` structure representing a QUIC connection.
- **Logic and Control Flow**:
    - Declare a static buffer `buf` to store the hexadecimal string representation of the connection ID.
    - Retrieve the size `sz` of the first peer connection ID from `conn->peer_cids[0].sz`.
    - Retrieve the connection ID `cid` from `conn->peer_cids[0].conn_id`.
    - Limit `sz` to `FD_QUIC_MAX_CONN_ID_SZ` using `fd_ulong_min`.
    - Encode the connection ID `cid` into hexadecimal format and store it in `buf` using `fd_hex_encode`.
    - Return the buffer `buf` containing the hexadecimal string.
- **Output**: A pointer to a static character buffer containing the hexadecimal string representation of the first peer connection ID.


---
### dump\_connection<!-- {{#callable:dump_connection}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/quic_trace/fd_quic_trace_main.c#L135>)

Logs the state and attributes of a QUIC connection using predefined formatting macros.
- **Inputs**:
    - `conn`: A pointer to a constant `fd_quic_conn_t` structure representing the QUIC connection to log.
- **Logic and Control Flow**:
    - Defines a macro `CONN_MEMB_LIST` to list connection attributes with their format specifiers and values.
    - Uses `FD_LOG_NOTICE` to log the connection attributes by expanding the `CONN_MEMB_LIST` macro twice: once for formatting and once for arguments.
    - The `CONN_MEMB_FMT` macro formats each attribute as a string with its name and value.
    - The `CONN_MEMB_ARGS` macro unpacks the arguments for logging.
- **Output**: No return value; outputs connection details to the log.


---
### quic\_trace\_cmd\_fn<!-- {{#callable:quic_trace_cmd_fn}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/quic_trace/fd_quic_trace_main.c#L184>)

Taps QUIC traffic on a live system by accessing shared memory segments of a target tile in read-only mode.
- **Inputs**:
    - `args`: A pointer to an `args_t` structure containing command-line arguments and options for QUIC tracing.
    - `config`: A pointer to a `config_t` structure containing the configuration, including the topology of the system.
- **Logic and Control Flow**:
    - Accesses the topology from the `config` and joins workspaces in read-only mode.
    - Determines the target tile based on the `trace_send` flag from `args` and the tile names array.
    - Checks if the target tile is found in the topology; logs an error if not found.
    - Calculates the remote and local addresses for the QUIC context and logs the information.
    - Tracks the target network link and the net target link, logging errors if links are not found.
    - Joins the shared memory objects and verifies object magic numbers.
    - Builds a `fd_quic_trace_ctx_t` context structure with tracing options and network bounds.
    - Dumps the QUIC configuration if the `dump_config` flag is set.
    - Initializes a peer connection ID map and sets it as a global variable.
    - Iterates over connections, dumping and inserting them into the peer connection ID map as needed.
    - Logs the total number of connections and their states.
    - Allocates memory for target fseq objects and copies the sequence numbers from the target tile.
    - Locates the log buffer and joins the log receiver, logging errors if joining fails.
    - Redirects metadata writes to dummy buffers to prevent writes to the read-only topology.
    - Registers metrics and links them to the global metrics base.
    - Joins the net-to-target link consumer and sets up the trace context for QUIC tracing.
    - Starts the QUIC trace based on the event type specified in `args`, either streaming or logging errors.
    - Leaves the log receiver after tracing is complete.
- **Output**: No return value; performs operations and logging for QUIC tracing.
- **Functions Called**:
    - [`dump_quic_config`](<#dump_quic_config>)
    - [`fd_quic_trace_conn_at_idx`](<fd_quic_trace.h.md#fd_quic_trace_conn_at_idx>)
    - [`dump_connection`](<#dump_connection>)
    - [`fd_quic_trace_rx_tile`](<fd_quic_trace_rx_tile.c.md#fd_quic_trace_rx_tile>)
    - [`fd_quic_trace_log_tile`](<fd_quic_trace_log_tile.c.md#fd_quic_trace_log_tile>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)