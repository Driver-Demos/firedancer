<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for creating and managing a genesis configuration, including feature enabling and PoH rate estimation.

# Purpose
The code is a C source file that is part of a system for managing and configuring a blockchain network, specifically focusing on the creation and management of a "genesis" block. The genesis block is the initial block in a blockchain, and this code is responsible for generating the contents of a `genesis.bin` file, which contains the initial state and configuration of the blockchain. The file includes functions to initialize the genesis block, estimate the hash rate for Proof of History (PoH), and manage the features enabled by default in the blockchain network. It also includes functions to check the configuration and ensure the genesis block is correctly set up.

Key components of the code include the [`create_genesis`](<#create_genesis>) function, which generates the genesis block data, and the [`init`](<#init>), [`fini`](<#fini>), and [`check`](<#check>) functions, which handle the initialization, finalization, and verification of the genesis block configuration. The code uses several external libraries and modules, such as `fd_keyload` for key management and `fd_genesis_create` for creating the genesis block. The [`default_enable_features`](<#default_enable_features>) function configures various blockchain features, setting their initial states. The code is structured to be part of a larger system, with dependencies on other modules and libraries, and it defines a public API through the `fd_cfg_stage_genesis` structure, which provides an interface for initializing, finalizing, and checking the genesis block configuration.
# Imports and Dependencies

---
- `../../../shared/commands/configure/configure.h`
- `../../../platform/fd_file_util.h`
- `../../../../ballet/poh/fd_poh.h`
- `../../../../disco/keyguard/fd_keyload.h`
- `../../../../discof/genesis/genesis_hash.h`
- `../../../../flamenco/features/fd_features.h`
- `../../../../flamenco/genesis/fd_genesis_create.h`
- `../../../../flamenco/types/fd_types_custom.h`
- `../../../../flamenco/runtime/sysvar/fd_sysvar_clock.h`
- `stdio.h`
- `unistd.h`
- `dirent.h`
- `sys/stat.h`
- `sys/wait.h`


# Global Variables

---
### fd\_cfg\_stage\_genesis
- **Type**: ``configure_stage_t``
- **Description**: Defines a configuration stage for the genesis process with specific initialization, finalization, and checking functions.
- **Use**: Used to manage the lifecycle of the genesis configuration stage, including initialization, finalization, and validation.


# Functions

---
### default\_enable\_features<!-- {{#callable:default_enable_features}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/configure/genesis.c#L24>)

Initializes all feature flags in the `fd_features_t` structure to zero, except for `reject_callx_r10`, which is set to one.
- **Inputs**:
    - `features`: A pointer to an `fd_features_t` structure where feature flags will be set.
- **Logic and Control Flow**:
    - Set `features->index_erasure_conflict_duplicate_proofs` to 0UL.
    - Set `features->curve25519_restrict_msm_length` to 0UL.
    - Set `features->commission_updates_only_allowed_in_first_half_of_epoch` to 0UL.
    - Set `features->validate_fee_collector_account` to 0UL.
    - Set `features->incremental_snapshot_only_incremental_hash_calculation` to 0UL.
    - Set `features->timely_vote_credits` to 0UL.
    - Set `features->apply_cost_tracker_during_replay` to 0UL.
    - Set `features->reject_callx_r10` to 1UL.
    - Set `features->update_hashes_per_tick` to 0UL.
    - Set `features->pico_inflation` to 0UL.
    - Set `features->remaining_compute_units_syscall_enabled` to 0UL.
    - Set `features->simplify_writable_program_account_check` to 0UL.
    - Set `features->enable_bpf_loader_set_authority_checked_ix` to 0UL.
    - Set `features->consume_blockstore_duplicate_proofs` to 0UL.
    - Set `features->disable_deploy_of_alloc_free_syscall` to 0UL.
    - Set `features->disable_bpf_loader_instructions` to 0UL.
    - Set `features->full_inflation_enable` to 0UL.
    - Set `features->vote_state_add_vote_latency` to 0UL.
    - Set `features->curve25519_syscall_enabled` to 0UL.
    - Set `features->error_on_syscall_bpf_function_hash_collisions` to 0UL.
    - Set `features->update_hashes_per_tick3` to 0UL.
    - Set `features->update_hashes_per_tick4` to 0UL.
    - Set `features->enable_bpf_loader_extend_program_ix` to 0UL.
    - Set `features->enable_loader_v4` to 0UL.
    - Set `features->increase_tx_account_lock_limit` to 0UL.
    - Set `features->stake_raise_minimum_delegation_to_1_sol` to 0UL.
    - Set `features->enable_alt_bn128_syscall` to 0UL.
    - Set `features->revise_turbine_epoch_stakes` to 0UL.
    - Set `features->clean_up_delegation_errors` to 0UL.
    - Set `features->update_hashes_per_tick5` to 0UL.
    - Set `features->full_inflation_vote` to 0UL.
    - Set `features->skip_rent_rewrites` to 0UL.
    - Set `features->switch_to_new_elf_parser` to 0UL.
    - Set `features->require_rent_exempt_split_destination` to 0UL.
    - Set `features->enable_turbine_fanout_experiments` to 0UL.
    - Set `features->devnet_and_testnet` to 0UL.
    - Set `features->enable_big_mod_exp_syscall` to 0UL.
    - Set `features->enable_alt_bn128_compression_syscall` to 0UL.
    - Set `features->update_hashes_per_tick2` to 0UL.
    - Set `features->account_data_direct_mapping` to 0UL.
    - Set `features->stricter_abi_and_runtime_constraints` to 0UL.
    - Set `features->bpf_account_data_direct_mapping` to 0UL.
    - Set `features->relax_authority_signer_check_for_lookup_table_creation` to 0UL.
    - Set `features->update_hashes_per_tick6` to 0UL.
    - Set `features->enable_poseidon_syscall` to 0UL.
    - Set `features->better_error_codes_for_tx_lamport_check` to 0UL.
    - Set `features->stake_minimum_delegation_for_rewards` to 0UL.
    - Set `features->loosen_cpi_size_restriction` to 0UL.
    - Set `features->drop_legacy_shreds` to 0UL.
    - Set `features->deprecate_rewards_sysvar` to 0UL.
    - Set `features->warp_timestamp_again` to 0UL.
    - Set `features->reduce_stake_warmup_cooldown` to 0UL.
    - Set `features->disable_turbine_fanout_experiments` to 0UL.
    - Set `features->blake3_syscall_enabled` to 0UL.
    - Set `features->last_restart_slot_sysvar` to 0UL.
    - Set `features->disable_fees_sysvar` to 0UL.
- **Output**: The function does not return a value.


---
### estimate\_hashes\_per\_tick<!-- {{#callable:estimate_hashes_per_tick}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/configure/genesis.c#L90>)

Approximates the number of hashes per tick based on the PoH hashrate over a specified duration.
- **Inputs**:
    - `tick_mhz`: The target tick rate in ticks per microsecond (MHz).
    - `estimate_dur_ns`: The duration in nanoseconds for which the PoH hashing is performed to estimate the hash rate.
- **Logic and Control Flow**:
    - Initialize `batch` to 1 million and calculate `deadline` as the current time plus `estimate_dur_ns`.
    - Initialize `poh_hash` as a zeroed 32-byte array and `hash_cnt` to zero.
    - In a loop, append `batch` hashes to `poh_hash` and increment `hash_cnt` by `batch` until the current time is less than `deadline`.
    - Convert `hash_cnt` and `estimate_dur_ns` to double precision for calculation.
    - Calculate `tick_cnt_dbl` as the ratio of `estimate_dur_ns` to the product of `tick_mhz` and 1000.
    - If `tick_cnt_dbl` is less than 1, return 0.
    - Calculate `hashes_per_tick` as half of the ratio of `hash_cnt_dbl` to `tick_cnt_dbl`.
    - Return `hashes_per_tick` as an unsigned long integer.
- **Output**: Returns the estimated number of hashes per tick as an unsigned long integer.


---
### create\_genesis<!-- {{#callable:create_genesis}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/configure/genesis.c#L117>)

Creates a genesis blob from configuration data and returns its size.
- **Inputs**:
    - `config`: A pointer to a `config_t` structure containing paths and genesis configuration data.
    - `blob`: A pointer to a buffer where the genesis blob will be stored.
    - `blob_max`: The maximum size of the `blob` buffer.
- **Logic and Control Flow**:
    - Initialize `fd_genesis_options_t` structure to store genesis options.
    - Load identity, faucet, stake, and vote public keys from specified paths in the configuration and store them in `options`.
    - Set `options` fields such as `creation_time`, `faucet_balance`, and `vote_account_stake` using configuration data.
    - Determine `hashes_per_tick` based on configuration or estimate it if not specified.
    - Set other genesis options like `ticks_per_slot`, `target_tick_duration_micros`, and `fund_initial_accounts` from configuration.
    - Disable all features and enable default features using `fd_features_t` and `fd_cluster_version_t`.
    - Attach scratch memory for temporary storage during genesis creation.
    - Call `fd_genesis_create` to serialize the genesis options into the `blob` buffer.
    - Check if the blob size is zero and log an error if genesis creation fails.
    - Detach scratch memory and return the size of the created genesis blob.
- **Output**: Returns the size of the created genesis blob as an `ulong`.
- **Functions Called**:
    - [`estimate_hashes_per_tick`](<#estimate_hashes_per_tick>)
    - [`default_enable_features`](<#default_enable_features>)


---
### init<!-- {{#callable:init}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/configure/genesis.c#L223>)

Initializes the genesis file creation process if the configuration indicates a bootstrap is needed.
- **Inputs**:
    - `config`: A pointer to a `config_t` structure containing configuration details such as paths, user IDs, and other settings.
- **Logic and Control Flow**:
    - Check if the `config->gossip.entrypoints_cnt` is zero to determine if bootstrap is needed; if not, return immediately.
    - Determine the path for the genesis file based on whether `config->is_firedancer` is true or false.
    - Create the directory for the genesis file using `fd_file_util_mkdir_all` and log an error if it fails.
    - Create the genesis data blob using [`create_genesis`](<#create_genesis>) and store its size.
    - Switch the effective user and group IDs to those specified in the configuration to ensure correct file permissions.
    - Set the file creation mask to restrict permissions for group and others.
    - Open the genesis file for writing, write the blob data to it, and close the file, logging errors if any step fails.
    - Restore the previous file creation mask.
    - Revert the effective user and group IDs to their original values, logging errors if any step fails.
    - Compute the shred version and genesis hash using `compute_shred_version`, logging an error if it fails.
    - Log the creation of the genesis file with its hash and size, and log the shred version.
- **Output**: No return value; the function performs initialization and logging operations.
- **Functions Called**:
    - [`create_genesis`](<#create_genesis>)


---
### fini<!-- {{#callable:fini}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/configure/genesis.c#L280>)

Removes the `genesis.bin` file from the specified path if it exists and logs an error if the removal fails for reasons other than the file not existing.
- **Inputs**:
    - ``config``: A pointer to a `config_t` structure that contains configuration details, including paths and flags.
    - ``pre_init``: An integer that is not used in the function body.
- **Logic and Control Flow**:
    - Ignore the `pre_init` parameter as it is not used.
    - Declare a character array `_genesis_path` to store the path to the `genesis.bin` file.
    - Determine the path to the `genesis.bin` file based on the `is_firedancer` flag in the `config` structure.
    - If `is_firedancer` is true, use the `genesis` path from `config->paths`; otherwise, construct the path using `config->paths.ledger`.
    - Attempt to remove the `genesis.bin` file using `unlink`.
    - If `unlink` fails and the error is not `ENOENT` (file not found), log an error message with details about the failure.
- **Output**: Returns 0 after attempting to remove the `genesis.bin` file.


---
### check<!-- {{#callable:check}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/configure/genesis.c#L298>)

Validates the configuration and integrity of the `genesis.bin` file against expected parameters and structure.
- **Inputs**:
    - `config`: A pointer to a `config_t` structure containing configuration details such as paths, user IDs, and genesis parameters.
- **Logic and Control Flow**:
    - Check if `config->gossip.entrypoints_cnt` is non-zero; if so, return `CONFIGURE_OK()` immediately.
    - Determine the path to the `genesis.bin` file based on whether `config->is_firedancer` is true or false.
    - Use `stat` to check the existence and status of the `genesis.bin` file; log an error if the file cannot be accessed or does not exist.
    - Verify the directory and file permissions for the ledger and `genesis.bin` file using `check_dir` and `check_file`.
    - Read the `genesis.bin` file into a buffer and ensure its size does not exceed the buffer capacity.
    - Decode the `genesis.bin` file to obtain its footprint and validate its structure using `fd_genesis_solana_decode_footprint`.
    - Create a new genesis file in memory using [`create_genesis`](<#create_genesis>) and compare its structure to the existing `genesis.bin` file.
    - Compare various attributes of the decoded genesis structures, such as accounts, native instruction processors, rewards pools, and configuration parameters, logging errors if discrepancies are found.
    - Return `CONFIGURE_OK()` if all checks pass without errors.
- **Output**: Returns a `configure_result_t` indicating the success or failure of the configuration check.
- **Functions Called**:
    - [`create_genesis`](<#create_genesis>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)