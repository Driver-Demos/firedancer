<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a process termination utility that kills specific processes based on command-line criteria.

# Purpose
The code is a C module designed to manage and terminate specific processes running on a Linux system. It defines a configuration stage named `fd_cfg_stage_kill` that is part of a larger configuration management system. The module includes functions to initialize permissions, check command-line arguments of processes, and terminate processes based on specific criteria. It targets processes with command-line arguments ending in "fddev", "fdctl", "firedancer", or "firedancer-dev". Additionally, it checks for processes that have certain file descriptors or memory mappings, such as those related to huge pages, and terminates them if found.

The module interacts with the `/proc` filesystem to gather information about running processes and uses system calls like `kill` to terminate them. It includes error handling to log issues encountered during file operations or process termination. The [`init`](<#init>) function scans the `/proc` directory to identify processes, while [`maybe_kill`](<#maybe_kill>) determines if a process should be terminated based on its command-line arguments or memory mappings. The [`wait_dead`](<#wait_dead>) function ensures that resources are reclaimed after a process is killed, preventing race conditions. The module is part of a broader system that likely involves process management and configuration tasks.
# Imports and Dependencies

---
- `../../../shared/commands/configure/configure.h`
- `errno.h`
- `stdlib.h`
- `unistd.h`
- `stdio.h`
- `dirent.h`
- `signal.h`
- `sys/stat.h`
- `sys/types.h`


# Global Variables

---
### fd\_cfg\_stage\_kill
- **Type**: ``configure_stage_t``
- **Description**: Defines a configuration stage named 'kill' for managing process termination. It includes function pointers for initialization (`init`), permission initialization (`init_perm`), and checking (`check`) processes.
- **Use**: Used to configure and execute a stage that terminates specific processes based on criteria.


# Functions

---
### init\_perm<!-- {{#callable:init_perm}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/configure/kill.c#L15>)

Initializes permission checks for file descriptors in `/proc/` using a root capability check.
- **Inputs**:
    - ``chk``: A pointer to an `fd_cap_chk_t` structure that will be used for capability checking.
    - ``config``: A constant pointer to a `config_t` structure, which is not used in this function.
- **Logic and Control Flow**:
    - Calls the function `fd_cap_chk_root` with the parameters `chk`, `NAME`, and a description string to perform a root capability check on all open file descriptors in `/proc/`.
- **Output**: No output is returned as the function's return type is `void`.


---
### cmdline<!-- {{#callable:cmdline}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/configure/kill.c#L21>)

Reads the command line of a process with a given PID from the `/proc` filesystem and stores it in a buffer.
- **Inputs**:
    - ``buf``: A character buffer where the function will store the command line of the process.
    - ``len``: The size of the buffer `buf`, indicating the maximum number of characters to read.
    - ``pid``: The process ID of the process whose command line is to be read.
- **Logic and Control Flow**:
    - Constructs the file path `/proc/<pid>/cmdline` using the given `pid`.
    - Attempts to open the file at the constructed path for reading.
    - If the file does not exist (`errno == ENOENT`), sets the first character of `buf` to the null terminator and returns.
    - If the file cannot be opened for other reasons, logs an error and terminates the program.
    - Reads up to `len - 1` characters from the file into `buf`.
    - If a read error occurs, logs an error and terminates the program.
    - Closes the file and logs an error if the close operation fails.
    - Appends a null terminator to the end of the data read into `buf`.
- **Output**: The function does not return a value but modifies the `buf` to contain the command line of the specified process, or an empty string if the process does not exist.


---
### maybe\_kill<!-- {{#callable:maybe_kill}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/configure/kill.c#L42>)

Attempts to terminate a process based on its command line or memory mappings.
- **Inputs**:
    - `config`: A pointer to a `config_t` structure containing configuration data, specifically paths for hugepage mounts.
    - `pid`: An unsigned long integer representing the process ID of the target process.
- **Logic and Control Flow**:
    - Initialize `killed` to 0 to track if a process is terminated.
    - Retrieve the command line of the process with the given `pid` into `proc_cmdline`.
    - Check if the command line ends with specific strings ('fddev', 'fdctl', 'firedancer', 'firedancer-dev') and attempt to kill the process if a match is found, setting `killed` to 1.
    - If the process is not killed by command line checks, open and read `/proc/<pid>/maps` to check for specific mount paths from the configuration and attempt to kill the process if found.
    - If still not killed, open and read `/proc/<pid>/numa_maps` to check for 'huge' and 'anon' mappings and attempt to kill the process if found.
    - Log errors if file operations fail and return `killed` status.
- **Output**: Returns an integer indicating whether the process was killed (1) or not (0).
- **Functions Called**:
    - [`cmdline`](<#cmdline>)


---
### wait\_dead<!-- {{#callable:wait_dead}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/configure/kill.c#L126>)

Waits for a process to terminate and ensures resources are reclaimed by the kernel.
- **Inputs**:
    - `started`: The timestamp when the waiting started, used to track how long the function has been waiting.
    - `pid`: The process ID of the process to wait for termination.
- **Logic and Control Flow**:
    - Enters an infinite loop to continuously check the status of the process with the given `pid`.
    - Calls `kill` with signal 0 to check if the process exists without sending a signal.
    - If `kill` returns -1 and `errno` is `ESRCH`, the process does not exist, and the function returns.
    - If `kill` returns -1 for any other reason, logs an error and exits.
    - Checks if the elapsed time since `started` exceeds 1 second (1e9 nanoseconds).
    - If the elapsed time exceeds 1 second, logs an error indicating the wait was too long and exits.
- **Output**: No output is returned; the function either returns when the process is confirmed dead or logs an error and exits if a problem occurs.


---
### init<!-- {{#callable:init}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/configure/kill.c#L142>)

Iterates through processes in `/proc`, attempts to kill specific processes based on criteria, and waits for their termination.
- **Inputs**:
    - `config`: A pointer to a `config_t` structure containing configuration data used to determine which processes to kill.
- **Logic and Control Flow**:
    - Open the `/proc` directory to read process entries.
    - Initialize a counter `wait_killed_cnt` and an array `wait_killed` to track processes that need to be waited on after being killed.
    - Iterate over each directory entry in `/proc` using `readdir`.
    - Skip entries that start with a dot or are not numeric process IDs.
    - Convert the directory name to a process ID (`pid`) and skip the current process ID.
    - Call [`maybe_kill`](<#maybe_kill>) to attempt to kill the process based on the configuration and process characteristics.
    - If [`maybe_kill`](<#maybe_kill>) returns true, add the `pid` to the `wait_killed` array and increment `wait_killed_cnt`.
    - Check for errors in reading the directory and close the directory with `closedir`.
    - Record the current time using `fd_log_wallclock`.
    - Iterate over the `wait_killed` array and call [`wait_dead`](<#wait_dead>) for each `pid` to ensure the process has terminated.
- **Output**: No return value; the function performs process management and logging.
- **Functions Called**:
    - [`maybe_kill`](<#maybe_kill>)
    - [`wait_dead`](<#wait_dead>)


---
### check<!-- {{#callable:check}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/configure/kill.c#L172>)

Indicates that the configuration stage is partially configured to kill existing instances.
- **Inputs**:
    - `config`: A pointer to a `config_t` structure, which is not used in this function.
- **Logic and Control Flow**:
    - Calls the macro `PARTIALLY_CONFIGURED` with the argument "kill existing instances".
- **Output**: Returns a `configure_result_t` value, which is the result of the `PARTIALLY_CONFIGURED` macro.



---
Made with ❤️ by [Driver](https://www.driver.ai/)