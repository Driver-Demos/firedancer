<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements key generation and directory setup for identity, vote account, faucet, and stake configurations.

# Purpose
The code is part of a configuration module that manages the setup and verification of key files and directories for a system. It includes functions to generate key pairs and ensure the existence of necessary directories and files. The [`init`](<#init>) function is responsible for creating directories and generating key files if they do not exist, using paths specified in a `config_t` structure. It checks for the existence of identity and vote account directories and files, and creates them if necessary. The [`check`](<#check>) function verifies the existence and permissions of these files, ensuring they meet specified criteria.

The module defines a `configure_stage_t` structure named `fd_cfg_stage_keys`, which encapsulates the initialization and checking logic for the key configuration stage. This structure includes function pointers to the [`init`](<#init>) and [`check`](<#check>) functions, which are used to manage the lifecycle of the configuration stage. The code relies on external utilities for file operations and error handling, as indicated by the inclusion of headers such as `fd_file_util.h` and the use of macros like `FD_LOG_ERR`. The module is designed to be part of a larger configuration system, as suggested by its integration with shared and platform-specific components.
# Imports and Dependencies

---
- `../../../shared/commands/configure/configure.h`
- `../../../platform/fd_file_util.h`
- `errno.h`
- `unistd.h`
- `sys/stat.h`


# Global Variables

---
### fd\_cfg\_stage\_keys
- **Type**: ``configure_stage_t``
- **Description**: Defines a configuration stage for handling key-related operations. It includes function pointers for initialization (`init`) and checking (`check`) the configuration state.
- **Use**: Used to manage the setup and verification of key-related configurations in the system.


# Functions

---
### path\_parent<!-- {{#callable:path_parent}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/configure/keys.c#L17>)

Extracts the parent directory path from a given file path.
- **Inputs**:
    - `path`: A constant character pointer to the file path from which to extract the parent directory.
    - `parent`: A character pointer where the function will store the extracted parent directory path.
    - `parent_sz`: An unsigned long integer representing the size of the buffer pointed to by `parent`.
- **Logic and Control Flow**:
    - Finds the last occurrence of the '/' character in the `path` using `strrchr` to identify the end of the parent directory path.
    - If no '/' is found, returns -1 indicating failure.
    - Calculates the length of the parent directory path by subtracting the position of the last '/' from the start of the `path`.
    - If the calculated length is greater than or equal to `parent_sz`, returns -1 indicating the buffer is too small.
    - Copies the parent directory path into the `parent` buffer using `fd_memcpy`.
    - Appends a null terminator to the `parent` buffer to ensure it is a valid C string.
    - Returns 0 to indicate success.
- **Output**: Returns 0 on success, or -1 if the parent directory cannot be extracted or if the buffer is too small.


---
### init<!-- {{#callable:init}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/configure/keys.c#L33>)

Initializes directories and generates key pairs for identity, vote account, faucet, and stake account based on the provided configuration.
- **Inputs**:
    - `config`: A pointer to a `config_t` structure containing paths and user/group IDs for directory and file operations.
- **Logic and Control Flow**:
    - Declare a character array `identity_key_parent` to store the parent directory path of the identity key.
    - Check if the identity key path contains a '/' character to determine if it has a parent directory.
    - If a parent directory exists, call [`path_parent`](<#path_parent>) to get the parent directory path and store it in `identity_key_parent`.
    - If [`path_parent`](<#path_parent>) fails, log an error and exit.
    - Attempt to create the identity key parent directory using `fd_file_util_mkdir_all`. If it fails, log an error and exit.
    - Declare a `struct stat` variable `st` to hold file status information.
    - Check if the identity key file does not exist using `stat`. If it does not exist, call `generate_keypair` to create it.
    - Repeat similar steps for the vote account path: check for a parent directory, create it if necessary, and generate the key pair if the file does not exist.
    - Create the base directory specified in `config->paths.base` using `fd_file_util_mkdir_all`. If it fails, log an error and exit.
    - Construct the path for the faucet JSON file using `fd_cstr_printf_check` and store it in `faucet`.
    - Check if the faucet file does not exist using `stat`. If it does not exist, call `generate_keypair` to create it.
    - Construct the path for the stake account JSON file using `fd_cstr_printf_check` and store it in `stake`.
    - Check if the stake account file does not exist using `stat`. If it does not exist, call `generate_keypair` to create it.
- **Output**: No return value; performs initialization tasks and logs errors if operations fail.
- **Functions Called**:
    - [`path_parent`](<#path_parent>)


---
### check<!-- {{#callable:check}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/configure/keys.c#L76>)

Verifies the existence and permissions of specific configuration files.
- **Inputs**:
    - `config`: A pointer to a `config_t` structure containing paths and user/group IDs for configuration files.
- **Logic and Control Flow**:
    - Initialize `faucet` and `stake` file paths using `fd_cstr_printf_check` with the base path from `config`.
    - Create an array `paths` containing paths to `identity_key`, `vote_account`, `faucet`, and `stake`.
    - Initialize `all_exist` to 1, indicating all files are assumed to exist initially.
    - Iterate over each path in `paths` array.
    - Skip empty paths using `strcmp`.
    - Use `stat` to check if each file exists; if not, set `all_exist` to 0 and continue.
    - Call `check_file` to verify file permissions and ownership for existing files.
    - If `all_exist` is 0, call `NOT_CONFIGURED` with an error message; otherwise, call `CONFIGURE_OK`.
- **Output**: Returns a `configure_result_t` indicating whether the configuration files are correctly set up.


# Function Declarations (Public API)

---
### generate\_keypair<!-- {{#callable_declaration:FD_FN_SENSITIVE::generate_keypair}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/configure/keys.c#L11>)

Generates a cryptographic key pair and writes it to a file.
- **Description**: Use this function to create a cryptographic key pair and save it to a specified file. The function requires the caller to specify the file path where the key pair will be stored, as well as the user and group IDs to set the file's ownership. It can use either the system's random number generator or a less secure source based on the `use_grnd_random` flag. Ensure the specified file does not already exist, as the function will not overwrite existing files. The function temporarily changes the effective user and group IDs to the specified values for file creation, and reverts them after the operation. It also creates any necessary parent directories for the file path.
- **Inputs**:
    - `keyfile`: A string representing the path to the file where the key pair will be saved. Must not be null and should not point to an existing file.
    - `uid`: An unsigned integer representing the user ID to set as the owner of the created file. Must be a valid user ID.
    - `gid`: An unsigned integer representing the group ID to set as the owner of the created file. Must be a valid group ID.
    - `use_grnd_random`: An integer flag indicating whether to use the system's random number generator (`1` for true, `0` for false). If true, the function uses a more secure random source.
- **Output**: None
- **See Also**: [`FD_FN_SENSITIVE::generate_keypair`](<../../../shared/commands/keys.c.md#fd_fn_sensitivegenerate_keypair>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)