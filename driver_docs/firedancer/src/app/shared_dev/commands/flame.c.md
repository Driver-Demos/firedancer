<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a command to capture and report performance flamegraphs using `/usr/bin/perf`.

# Purpose
The code is a C source file that defines a command for capturing performance flamegraphs using the `/usr/bin/perf` tool. It is part of a larger system, as indicated by the inclusion of several shared and platform-specific headers. The main functionality is encapsulated in the [`flame_cmd_fn`](<#flame_cmd_fn>) function, which sets up signal handling, configures the system topology, and executes the `perf` tool to record and report performance data. The command can target specific system components, referred to as "tiles," or the entire process, depending on the arguments provided.

The file defines an `action_t` structure named `fd_action_flame`, which includes function pointers for handling command arguments, executing the command, and checking permissions. The [`flame_cmd_args`](<#flame_cmd_args>) function processes command-line arguments to determine the scope of the performance recording. The `flame_cmd_perm` function checks the necessary permissions to execute the command. The code uses system calls such as `fork`, `execve`, and `waitpid` to manage the execution of the `perf` tool and handle its output. The file is intended to be part of a larger application, providing a specific diagnostic action related to performance monitoring.
# Imports and Dependencies

---
- `../../shared/fd_config.h`
- `../../shared/fd_action.h`
- `../../platform/fd_sys_util.h`
- `../../../disco/metrics/fd_metrics.h`
- `../../../util/pod/fd_pod.h`
- `errno.h`
- `stdio.h`
- `stdlib.h`
- `unistd.h`
- `sys/wait.h`
- `sys/random.h`


# Global Variables

---
### record\_pid
- **Type**: ``int``
- **Description**: Stores the process ID of a child process created by the `fork()` system call. This variable is used to manage and control the child process that performs performance data collection using the `/usr/bin/perf` tool.
- **Use**: Used to send signals to the child process and check its status during execution.


---
### flame\_cmd\_perm
- **Type**: `function`
- **Description**: Defines permissions for the 'flame' command by checking if the user has root access to read system performance counters using the `/usr/bin/perf` tool.
- **Use**: Used to verify user permissions for executing the 'flame' command.


---
### fd\_action\_flame
- **Type**: ``action_t``
- **Description**: Defines an action for capturing a performance flamegraph using the `perf` tool. It includes the name of the action, the arguments it accepts, the function to execute, the permissions required, a description, and a flag indicating it is a diagnostic action.
- **Use**: Used to configure and execute the flamegraph capture action within the system.


# Functions

---
### parent\_signal<!-- {{#callable:parent_signal}} -->
[View Source →](<../../../../../../src/app/shared_dev/commands/flame.c#L17>)

Handles a signal by logging it and forwarding a SIGINT to a recorded process if applicable.
- **Inputs**:
    - `sig`: The signal number received by the process.
- **Logic and Control Flow**:
    - Logs the received signal using `FD_LOG_NOTICE` with the signal name obtained from `fd_io_strsignal`.
    - Checks if `record_pid` is set (non-zero) using `FD_LIKELY`.
    - If `record_pid` is set, attempts to send a SIGINT to the process with PID `record_pid` using `kill`.
    - If the `kill` call fails, logs an error using `FD_LOG_ERR` with the error number and message obtained from `fd_io_strerror`.
- **Output**: No return value; the function performs logging and process signaling as side effects.


---
### install\_parent\_signals<!-- {{#callable:install_parent_signals}} -->
[View Source →](<../../../../../../src/app/shared_dev/commands/flame.c#L25>)

Sets up signal handlers for `SIGTERM` and `SIGINT` to use the `parent_signal` function.
- **Inputs**: None
- **Logic and Control Flow**:
    - Declare and initialize a `sigaction` structure `sa` with `sa_handler` set to `parent_signal` and `sa_flags` set to 0.
    - Call `sigaction` to associate the `SIGTERM` signal with the `sa` structure; if it fails, log an error using `FD_LOG_ERR`.
    - Call `sigaction` to associate the `SIGINT` signal with the `sa` structure; if it fails, log an error using `FD_LOG_ERR`.
- **Output**: No return value; the function sets up signal handlers.


---
### flame\_cmd\_args<!-- {{#callable:flame_cmd_args}} -->
[View Source →](<../../../../../../src/app/shared_dev/commands/flame.c#L44>)

Parses command-line arguments for the 'flame' command and updates the argument count and vector.
- **Inputs**:
    - `pargc`: A pointer to an integer representing the number of command-line arguments.
    - `pargv`: A pointer to an array of strings representing the command-line arguments.
    - `args`: A pointer to an `args_t` structure where the parsed argument will be stored.
- **Logic and Control Flow**:
    - Checks if the argument count pointed to by `pargc` is zero; if so, logs an error message and exits.
    - Copies the first argument from `pargv` into the `name` field of the `flame` member of the `args` structure, ensuring it does not exceed the buffer size.
    - Decrements the argument count pointed to by `pargc`.
    - Advances the argument vector pointer `pargv` to the next argument.
- **Output**: No return value; modifies the input arguments `pargc`, `pargv`, and `args` in place.


---
### flame\_cmd\_fn<!-- {{#callable:flame_cmd_fn}} -->
[View Source →](<../../../../../../src/app/shared_dev/commands/flame.c#L56>)

Executes a performance profiling command using `/usr/bin/perf` to capture a flamegraph for specified tiles or processes.
- **Inputs**:
    - `args`: A pointer to an `args_t` structure containing command arguments, specifically the name of the tile or process to profile.
    - `config`: A pointer to a `config_t` structure containing configuration data, including topology information.
- **Logic and Control Flow**:
    - Install signal handlers for parent process signals using `install_parent_signals()`.
    - Join the topology workspaces in read-only mode and fill the topology using `fd_topo_join_workspaces()` and `fd_topo_fill()`.
    - Check if the system is running in a sandboxed environment and log a warning if true.
    - Initialize `tile_cnt` and `tile_idxs` to store tile indices for profiling.
    - Determine the tiles to profile based on `args->flame.name` and populate `tile_idxs` and `tile_cnt`.
    - For each tile, retrieve the thread ID (TID) and process ID (PID) using `fd_metrics_tile()` and check if the tile is running using `kill()`.
    - Format the TID or PID into a comma-separated string `threads` for the `perf` command.
    - Log the `perf` command to be executed for recording the flamegraph.
    - Fork the process to execute the `perf record` command with `execve()`.
    - Wait for the `perf record` process to complete, handling signals and errors appropriately.
    - Fork the process again to execute the `perf script report` command with `execve()`.
    - Wait for the `perf report` process to complete, handling signals and errors appropriately.
    - Exit the process group using `fd_sys_util_exit_group()`.
- **Output**: No return value; the function performs its operations and exits the process group.
- **Functions Called**:
    - [`install_parent_signals`](<#install_parent_signals>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)