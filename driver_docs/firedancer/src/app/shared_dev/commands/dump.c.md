<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functionality to dump network link data to a packet capture file, with options for configuration and metrics logging.

# Purpose
The code is a C module designed to capture and log network traffic data from specified links into a packet capture (PCAP) file. It includes functionality to handle command-line arguments, manage network link configurations, and process network fragments. The module uses several external libraries and headers for configuration, action handling, metrics, clock management, and packet capture operations. The primary structure, `dump_ctx_t`, maintains the context for the dump operation, including output stream management, link information, and metrics tracking.

The module defines several functions to handle different aspects of the dump process. The [`dump_cmd_args`](<#dump_cmd_args>) function processes command-line arguments to configure the output file and link names. The [`dump_link_once`](<#dump_link_once>) function captures data from a single link, while [`during_frag`](<#during_frag>) and [`after_frag`](<#after_frag>) manage the processing of network fragments. The [`log_metrics`](<#log_metrics>) function logs the metrics of the dump operation, and [`during_housekeeping`](<#during_housekeeping>) handles periodic maintenance tasks. The [`dump_cmd_fn`](<#dump_cmd_fn>) function orchestrates the overall dump operation, setting up the necessary context, initializing resources, and executing the dump process either once or continuously until a termination signal is received. The module also defines an `action_t` structure, `fd_action_dump`, which describes the dump action, including its name, argument processing function, execution function, and description.
# Imports and Dependencies

---
- `../../shared/fd_config.h`
- `../../shared/fd_action.h`
- `../../../disco/metrics/fd_metrics.h`
- `../../../util/clock/fd_clock.h`
- `../../../util/net/fd_pcap.h`
- `errno.h`
- `fcntl.h`
- `signal.h`
- `stdio.h`
- `unistd.h`
- `../../../disco/stem/fd_stem.c`


# Global Variables

---
### running
- **Type**: `int`
- **Description**: The `running` variable is a static integer initialized to 1.
- **Use**: It is used to control the execution flow of the program, indicating whether the program should continue running or shut down.


---
### should\_shutdown
- **Type**: `function`
- **Description**: Returns the negation of the `running` variable, indicating whether the system should shut down.
- **Use**: Used to determine if the system should stop running based on the `running` state.


---
### fd\_action\_dump
- **Type**: ``action_t``
- **Description**: Defines an action named 'dump' that is used to dump tango links to a packet capture file. It includes function pointers for argument processing and execution, and a description of the action.
- **Use**: Used to configure and execute the 'dump' action for capturing network link data.


# Data Structures

---
### dump\_ctx
- **Type**: ``struct``
- **Members**:
    - ``ostream``: A buffered output stream for writing data.
    - ``pending_sz``: The size of the pending data to be written.
    - ``links``: An array of link structures, each containing topology and cache information.
    - ``link_cnt``: The count of active links in the `links` array.
    - ``metrics_base``: A pointer to the base of the metrics data.
    - ``next_stat_log``: The timestamp for the next statistics log.
    - ``frags``: The number of fragments processed.
    - ``bytes``: The number of bytes processed.
    - ``last_overrun_frags``: The count of fragments overrun since the last check.
    - ``warmup_until``: The timestamp until which the warmup period lasts.
    - ``clock``: An array containing clock data.
    - ``clock_mem``: An array containing shared memory for clock data.
    - ``clock_epoch``: An array containing epoch data for the clock.
    - ``clock_recal_next``: The timestamp for the next clock recalibration.
- **Description**: The `dump_ctx` structure is used to manage the context for dumping data from network links to a packet capture file. It includes a buffered output stream (`ostream`) for writing data, an array of link structures (`links`) that hold information about network topology and cache, and various counters and timestamps for managing metrics and logging. The structure also contains clock-related data for time management and synchronization. The `pending_sz` field tracks the size of data pending to be written, while `frags` and `bytes` keep count of processed fragments and bytes, respectively. The `warmup_until` field indicates the end of the warmup period, and `clock_recal_next` schedules the next clock recalibration.


---
### link
- **Type**: ``struct``
- **Members**:
    - ``topo``: Pointer to a constant `fd_topo_link_t` structure.
    - ``dcache_base``: Pointer to a constant void, representing the base of the data cache.
    - ``link_hash``: Unsigned integer representing the hash of the link.
- **Description**: Defines a `struct link` which is used to represent a network link with associated metadata, including a pointer to the topology link, a base address for data caching, and a hash value for the link. This structure is part of an array `links` with a maximum size defined by `FD_TOPO_MAX_LINKS`, and the total count of links is stored in `link_cnt`.


---
### dump\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``ostream``: Buffered output stream for writing data.
    - ``pending_sz``: Size of the pending data to be written.
    - ``links``: Array of link structures containing topology and cache information.
    - ``link_cnt``: Number of active links in the `links` array.
    - ``metrics_base``: Base address for metrics data.
    - ``next_stat_log``: Timestamp for the next statistics log.
    - ``frags``: Count of fragments processed.
    - ``bytes``: Count of bytes processed.
    - ``last_overrun_frags``: Count of fragments overrun since the last check.
    - ``warmup_until``: Timestamp until the warmup period ends.
    - ``clock``: Clock structure for time management.
    - ``clock_mem``: Shared memory for clock operations.
    - ``clock_epoch``: Epoch time for the clock.
    - ``clock_recal_next``: Timestamp for the next clock recalibration.
- **Description**: The `dump_ctx_t` structure manages the context for dumping data from network links to a packet capture file. It includes a buffered output stream, an array of link structures with topology and cache information, and various counters and timestamps for managing data processing and logging. The structure also handles clock operations for time management and metrics collection.


# Functions

---
### dump\_cmd\_args<!-- {{#callable:dump_cmd_args}} -->
[View Source →](<../../../../../../src/app/shared_dev/commands/dump.c#L39>)

Parses command-line arguments to configure dump settings for a packet capture operation.
- **Inputs**:
    - `argc`: A pointer to the count of command-line arguments.
    - `argv`: A pointer to the array of command-line argument strings.
    - `args`: A pointer to an `args_t` structure where parsed argument values are stored.
- **Logic and Control Flow**:
    - Call `fd_env_strip_cmdline_cstr` to extract the `--out-file` argument or use the default value `dump.pcap` if not provided.
    - Call `fd_env_strip_cmdline_cstr` to extract the `--link` argument or use an empty string if not provided.
    - Call `fd_env_strip_cmdline_int` to extract the `--once` argument or use the default value `1` if not provided.
    - Initialize `args->dump.pcap_path` with the extracted `out_file` value using `fd_cstr_init` and `fd_cstr_append_cstr_safe`.
    - Initialize `args->dump.link_name` with the extracted `link` value using `fd_cstr_init` and `fd_cstr_append_cstr_safe`.
- **Output**: No return value; modifies the `args` structure to store parsed command-line argument values.


---
### dump\_link\_once<!-- {{#callable:dump_link_once}} -->
[View Source →](<../../../../../../src/app/shared_dev/commands/dump.c#L50>)

Processes and dumps packet fragments from a link to a packet capture stream, handling both reliable and unreliable links.
- **Inputs**:
    - `ctx`: A pointer to a `dump_ctx_t` structure that contains the context for the dump operation, including the output stream.
    - `link`: A pointer to a `struct link` that represents the link from which packet fragments are to be dumped.
- **Logic and Control Flow**:
    - Initialize `mcache`, `seq0`, `seq_init`, and `depth` from the link's topology metadata cache.
    - Initialize counters `frags` and `bytes` to zero.
    - Set `min_seq_seen` to `seq_init` to track the minimum sequence number seen.
    - Iterate backwards from `seq_init` to `seq0`, checking if the sequence number matches the expected sequence and updating `min_seq_seen`.
    - If `link->dcache_base` is not NULL, retrieve the packet data and write it to the output stream; otherwise, write metadata only.
    - Increment `frags` and `bytes` counters for each packet processed.
    - Iterate forward from `seq_init` up to `depth`, processing packets not already processed and skipping those with error control bits set.
    - Log the total number of fragments and bytes dumped.
- **Output**: No return value; outputs packet data to the `ctx->ostream` and logs the operation.


---
### exit\_signal<!-- {{#callable:exit_signal}} -->
[View Source →](<../../../../../../src/app/shared_dev/commands/dump.c#L121>)

Sets the `running` flag to 0 to signal termination.
- **Inputs**:
    - `sig`: An integer representing the signal received, but it is unused in this function.
- **Logic and Control Flow**:
    - Sets the global variable `running` to 0, indicating that the program should terminate.
- **Output**: No output is returned from this function.


---
### during\_frag<!-- {{#callable:during_frag}} -->
[View Source →](<../../../../../../src/app/shared_dev/commands/dump.c#L131>)

Copies a candidate fragment into local memory for later processing, ensuring it is not overrun during the operation.
- **Inputs**:
    - `ctx`: A pointer to a `dump_ctx_t` structure that holds the context for the dump operation.
    - `in_idx`: An unsigned long integer representing the index of the input link in the context's links array.
    - `seq`: An unsigned long integer representing the sequence number of the fragment.
    - `sig`: An unsigned long integer representing the signal, which is unused in this function.
    - `chunk`: An unsigned long integer representing the chunk identifier of the fragment.
    - `sz`: An unsigned long integer representing the size of the fragment.
    - `ctl`: An unsigned long integer representing the control flags, which is unused in this function.
- **Logic and Control Flow**:
    - Initialize `ctx->pending_sz` to 0 to indicate no pending size initially.
    - Calculate the packet size `pcap_sz` using `fd_pcap_pkt_sz` with the fragment size `sz`.
    - If `pcap_sz` is negative, return immediately as it indicates an error.
    - Check if `pcap_sz` exceeds the available peek size in the buffered ostream; if so, flush the ostream and check again.
    - Log an error if `pcap_sz` still exceeds the available peek size after flushing.
    - Verify that if `sz` is non-zero, the `dcache_base` for the link at `in_idx` is not NULL.
    - Retrieve the link and fragment metadata line using the sequence number `seq`.
    - Convert the chunk to a local address using `fd_chunk_to_laddr_const`.
    - Copy the fragment data into the buffered ostream peek space using `fd_pcap_pkt`.
    - Set `ctx->pending_sz` to the calculated `pcap_sz` to indicate the size of the pending packet.
- **Output**: No direct output is returned, but the function updates `ctx->pending_sz` to reflect the size of the pending packet.


---
### after\_frag<!-- {{#callable:after_frag}} -->
[View Source →](<../../../../../../src/app/shared_dev/commands/dump.c#L176>)

Processes a fragment after it is confirmed not to be overrun, updating timestamps and statistics.
- **Inputs**:
    - ``ctx``: A pointer to a `dump_ctx_t` structure that holds the context for the dump operation.
    - ``in_idx``: An unused `ulong` parameter.
    - ``seq``: An unused `ulong` parameter.
    - ``sig``: An unused `ulong` parameter.
    - ``sz``: The size of the fragment in bytes.
    - ``tsorig``: An unused `ulong` parameter.
    - ``tspub``: The publication timestamp of the fragment.
    - ``stem``: An unused pointer to a `fd_stem_context_t` structure.
- **Logic and Control Flow**:
    - Check if `ctx->pending_sz` is zero; if so, return immediately.
    - Calculate the packet size using `fd_pcap_pkt_sz` and verify it matches `ctx->pending_sz`.
    - Get the current tick count and convert it to an epoch time using `fd_clock_epoch_y`.
    - If the current time is past the warmup period (`ctx->warmup_until`), proceed with further processing.
    - If `tspub` is not zero, decompose it and convert it to a wall clock time, then update the timestamp in the output stream buffer.
    - Seek the output stream by `ctx->pending_sz` bytes to commit the fragment data.
    - Increment the fragment and byte counters in the context (`ctx->frags` and `ctx->bytes`).
    - Reset `ctx->pending_sz` to zero.
- **Output**: No return value; the function updates the context and output stream with processed fragment data.


---
### log\_metrics<!-- {{#callable:log_metrics}} -->
[View Source →](<../../../../../../src/app/shared_dev/commands/dump.c#L206>)

Logs the number of fragments and bytes processed, resets counters, and checks for overrun fragments.
- **Inputs**:
    - `ctx`: A pointer to a `dump_ctx_t` structure containing context information for logging metrics.
- **Logic and Control Flow**:
    - Logs the number of fragments and bytes processed using `FD_LOG_NOTICE` and resets `ctx->frags` and `ctx->bytes` to zero.
    - Initializes `overrun_frags` to zero and iterates over each link in `ctx->link_cnt`.
    - For each link, retrieves link metrics using `fd_metrics_link_in` and accumulates overrun fragment counts from `FD_METRICS_COUNTER_LINK_OVERRUN_POLLING_FRAG_COUNT_OFF` and `FD_METRICS_COUNTER_LINK_OVERRUN_READING_FRAG_COUNT_OFF`.
    - Checks if the accumulated `overrun_frags` is different from `ctx->last_overrun_frags`.
    - If there is a difference and `ctx->last_overrun_frags` is not zero, calculates the difference using `fd_seq_diff` and logs a warning with `FD_LOG_WARNING`.
    - Updates `ctx->last_overrun_frags` with the current `overrun_frags`.
- **Output**: No return value; the function performs logging and updates the context structure.


---
### during\_housekeeping<!-- {{#callable:during_housekeeping}} -->
[View Source →](<../../../../../../src/app/shared_dev/commands/dump.c#L230>)

Performs periodic housekeeping tasks such as recalibrating the clock and logging metrics based on the current time.
- **Inputs**:
    - `ctx`: A pointer to a `dump_ctx_t` structure that contains context information for the dump operation, including clock and logging details.
- **Logic and Control Flow**:
    - Get the current time using `fd_clock_epoch_y` and `fd_tickcount` functions.
    - Check if the current time exceeds `ctx->clock_recal_next`; if true, recalibrate the clock using `fd_clock_default_recal` and refresh the clock epoch with `fd_clock_epoch_refresh`.
    - Check if the current time exceeds `ctx->next_stat_log`; if true, update `ctx->next_stat_log` to one second later and call [`log_metrics`](<#log_metrics>) to log the current metrics.
- **Output**: No return value; the function updates the `ctx` structure with new clock and logging information.
- **Functions Called**:
    - [`log_metrics`](<#log_metrics>)


---
### dump\_cmd\_fn<!-- {{#callable:dump_cmd_fn}} -->
[View Source →](<../../../../../../src/app/shared_dev/commands/dump.c#L252>)

Writes packet data from specified links to a pcap file, either once or continuously until interrupted.
- **Inputs**:
    - ``args``: A pointer to an `args_t` structure containing command-line arguments, including the link name and pcap file path.
    - ``config``: A pointer to an `fd_config_t` structure containing the configuration, including topology information.
- **Logic and Control Flow**:
    - Tokenizes the link names from `args->dump.link_name` using commas as delimiters.
    - Initializes a `dump_ctx_t` structure to manage the dump context.
    - Opens the specified pcap file for writing, creating or truncating it as necessary.
    - Initializes a buffered output stream for writing to the pcap file.
    - Writes the pcap file header using `fd_pcap_ostream_hdr`.
    - Joins the topology workspaces in read-only mode and fills the topology structure.
    - Iterates over the links in the topology, checking if they match the specified tokens or if no tokens are specified, and adds them to the context if found.
    - If `args->dump.once` is true, calls [`dump_link_once`](<#dump_link_once>) for each link to dump data once.
    - If `args->dump.once` is false, sets up signal handlers for `SIGTERM` and `SIGINT` to allow graceful shutdown.
    - Initializes necessary structures for continuous dumping, including mcaches, fseqs, RNG, scratch space, and metrics.
    - Runs the `stem_run1` function to continuously process and dump fragments from the links.
    - Logs the number of fragments and bytes dumped for each link.
    - Cleans up resources, including clocks, metrics, RNG, and fseqs.
    - Leaves the topology workspaces and finalizes the output stream.
- **Output**: No return value; writes packet data to a specified pcap file.
- **Functions Called**:
    - [`dump_link_once`](<#dump_link_once>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)