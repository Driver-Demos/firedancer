<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Development and debugging utilities for running Firedancer in a single process with signal handling and configuration updates.

# Purpose
The code is a C source file that provides functionality for running and managing a software component called "Firedancer" in a development and debugging environment. It includes functions to handle command-line arguments, configure permissions, and manage process signals. The file imports several headers that suggest it is part of a larger system, including utilities for system operations, configuration, and command execution. The primary functions include [`dev_cmd_args`](<#dev_cmd_args>), which processes command-line arguments to set various development flags, and [`dev_cmd_perm`](<#dev_cmd_perm>), which configures permissions based on these flags.

The code also defines signal handling for process management, particularly for terminating child processes like `firedancer` and `watch` when certain signals are received. The [`run_firedancer_threaded`](<#run_firedancer_threaded>) function is responsible for initializing and running the Firedancer component in a single process, which is useful for development and debugging. It sets up necessary signal handlers, initializes workspaces, and manages network namespaces. The [`dev_cmd_fn`](<#dev_cmd_fn>) function orchestrates the overall execution flow, deciding whether to run Firedancer in a single process or forked processes based on the provided arguments and configuration. This file is part of a larger system and is intended to be compiled and executed as part of a development toolchain for managing the Firedancer component.
# Imports and Dependencies

---
- `../../platform/fd_sys_util.h`
- `../../shared/commands/configure/configure.h`
- `../../shared/commands/run/run.h`
- `../../shared/commands/watch/watch.h`
- `../../../discof/genesis/genesis_hash.h`
- `stdio.h`
- `stdlib.h`
- `unistd.h`
- `sched.h`
- `fcntl.h`
- `pthread.h`
- `sys/wait.h`


# Global Variables

---
### firedancer\_pid
- **Type**: ``pid_t``
- **Description**: Stores the process ID of the Firedancer process. This variable is used to manage and control the Firedancer process, such as sending signals to terminate it.
- **Use**: Used to store and manage the process ID of the Firedancer process for signal handling and process control.


---
### watch\_pid
- **Type**: ``pid_t``
- **Description**: Stores the process ID of the 'watch' process. This variable is used to manage and control the lifecycle of the 'watch' process in the application.
- **Use**: Used to send signals to the 'watch' process, such as terminating it with `SIGKILL`.


---
### fd\_log\_private\_path
- **Type**: ``char[1024]``
- **Description**: A global character array that can store up to 1024 characters. It is initialized as an empty string at the start of the program.
- **Use**: Stores the path to a private log file used by the application.


---
### fd\_sighandler\_actual\_stderr
- **Type**: `int`
- **Description**: Stores the original file descriptor for the standard error stream (`STDERR_FILENO`).
- **Use**: Used to restore the standard error stream to its original state after it has been redirected.


---
### fd\_log\_private\_shared\_lock
- **Type**: `int *`
- **Description**: A pointer to an integer that is used as a lock for shared resources in the logging system.
- **Use**: Used to synchronize access to shared resources in the logging system, ensuring that only one process can modify the resources at a time.


# Functions

---
### dev\_cmd\_args<!-- {{#callable:dev_cmd_args}} -->
[View Source →](<../../../../../../src/app/shared_dev/commands/dev.c#L20>)

Parses command-line arguments to set development-related flags in the `args_t` structure.
- **Inputs**:
    - ``pargc``: A pointer to an integer representing the count of command-line arguments.
    - ``pargv``: A pointer to an array of strings representing the command-line arguments.
    - ``args``: A pointer to an `args_t` structure where the parsed argument values will be stored.
- **Logic and Control Flow**:
    - Set `args->dev.parent_pipefd` to -1.
    - Check if the command-line contains `--no-watch` and set `args->dev.no_watch` accordingly.
    - Check if the command-line contains `--no-configure` and set `args->dev.no_configure` accordingly.
    - Check if the command-line contains `--no-init-workspaces` and set `args->dev.no_init_workspaces` accordingly.
    - Check if the command-line contains `--no-agave` or `--no-solana` and set `args->dev.no_agave` accordingly.
    - Retrieve the value for `--debug-tile` from the command-line, if present, and copy it to `args->dev.debug_tile`.
- **Output**: The function does not return a value; it modifies the `args_t` structure pointed to by `args`.


---
### dev\_cmd\_perm<!-- {{#callable:dev_cmd_perm}} -->
[View Source →](<../../../../../../src/app/shared_dev/commands/dev.c#L35>)

Executes configuration and runtime commands based on the provided arguments and configuration.
- **Inputs**:
    - `args`: A pointer to an `args_t` structure containing command-line arguments and flags.
    - `chk`: A pointer to an `fd_cap_chk_t` structure used for capability checking.
    - `config`: A constant pointer to a `config_t` structure containing configuration settings.
- **Logic and Control Flow**:
    - Checks if the `no_configure` flag in `args->dev` is not set.
    - If configuration is allowed, initializes a `configure_args` structure with the command `CONFIGURE_CMD_INIT`.
    - Copies stages from the `STAGES` array into `configure_args.configure.stages`.
    - Calls `configure_cmd_perm` with `configure_args`, `chk`, and `config` to perform configuration.
    - Calls `run_cmd_perm` with `NULL`, `chk`, and `config` to execute runtime commands.
- **Output**: No return value; the function performs operations based on the input arguments and configuration.


---
### parent\_signal<!-- {{#callable:parent_signal}} -->
[View Source →](<../../../../../../src/app/shared_dev/commands/dev.c#L59>)

Handles a signal by terminating child processes, restoring standard error, logging the signal, and exiting the process.
- **Inputs**:
    - `sig`: The signal number received by the process.
- **Logic and Control Flow**:
    - If `firedancer_pid` is set, send `SIGINT` to the process with that PID.
    - If `watch_pid` is set, send `SIGKILL` to the process with that PID.
    - Set `fd_log_private_shared_lock` to a local variable `lock`.
    - If `fd_sighandler_actual_stderr` is not -1, attempt to duplicate it to `STDERR_FILENO`; log an error if `dup2` fails.
    - Log the received signal and the log file path if available.
    - If the signal is `SIGINT`, exit the process with status `128 + SIGINT`; otherwise, exit with status `0`.
- **Output**: No return value; the function exits the process.


---
### install\_parent\_signals<!-- {{#callable:install_parent_signals}} -->
[View Source →](<../../../../../../src/app/shared_dev/commands/dev.c#L79>)

Sets up signal handlers for `SIGTERM` and `SIGINT` to use the `parent_signal` function.
- **Inputs**: None
- **Logic and Control Flow**:
    - Defines a `sigaction` structure `sa` with `sa_handler` set to `parent_signal` and `sa_flags` set to 0.
    - Calls `sigaction` to associate `SIGTERM` with the `sa` action; logs an error if it fails.
    - Calls `sigaction` to associate `SIGINT` with the `sa` action; logs an error if it fails.
- **Output**: No return value; sets up signal handlers.


---
### update\_config\_for\_dev<!-- {{#callable:update_config_for_dev}} -->
[View Source →](<../../../../../../src/app/shared_dev/commands/dev.c#L91>)

Updates the configuration for development by computing and setting the shred version from the genesis file if it is not already set.
- **Inputs**:
    - `config`: A pointer to an `fd_config_t` structure that contains the configuration to update.
- **Logic and Control Flow**:
    - Constructs the path to the genesis file using the `ledger` path from the `config` structure.
    - Initializes `shred_version` to 0 and attempts to compute the shred version from the genesis file using `compute_shred_version`.
    - If the computation fails and the error is not due to the file not existing (`ENOENT`), logs an error and exits.
    - Iterates over each shred tile in the configuration's topology layout.
    - For each shred tile, finds its ID and checks if its `expected_shred_version` is 0; if so, sets it to the computed `shred_version`.
    - Finds the store tile ID and checks if its `expected_shred_version` is 0; if so, sets it to the computed `shred_version`.
- **Output**: The function does not return a value; it updates the `config` structure in place.


---
### run\_firedancer\_threaded<!-- {{#callable:run_firedancer_threaded}} -->
[View Source →](<../../../../../../src/app/shared_dev/commands/dev.c#L123>)

Executes the Firedancer application in a single process for development and debugging, handling signal installation, workspace initialization, and optional execution of a secondary function.
- **Inputs**:
    - ``config``: A pointer to a `config_t` structure containing configuration data for the Firedancer application.
    - ``init_workspaces``: An integer indicating whether to initialize workspaces (non-zero to initialize).
    - ``agave_main``: A pointer to a function that takes a constant `config_t` pointer as an argument, which is optionally executed if certain conditions are met.
- **Logic and Control Flow**:
    - Install parent signal handlers using `install_parent_signals()` to manage process signals.
    - Log the topology configuration using `fd_topo_print_log()`.
    - Initialize the Firedancer application with `run_firedancer_init()` and set up network namespaces with `fdctl_setup_netns()`.
    - If debugging is enabled (`config->development.debug_tile` is true), set a shared lock for logging.
    - Check if the network provider is 'xdp'; if so, install XDP with `fd_topo_install_xdp()` and ignore the returned file descriptors.
    - Join all workspaces in read-write mode using `fd_topo_join_workspaces()` to ensure proper memory access across threads.
    - Run the Firedancer application in a single process with `fd_topo_run_single_process()`, using the provided user and group IDs and the `fdctl_tile_run` function.
    - If `agave_main` is provided and `config->development.no_agave` is false, execute the `agave_main` function.
- **Output**: No return value; the function performs its operations directly on the provided configuration and system state.
- **Functions Called**:
    - [`install_parent_signals`](<#install_parent_signals>)


---
### dev\_cmd\_fn<!-- {{#callable:dev_cmd_fn}} -->
[View Source →](<../../../../../../src/app/shared_dev/commands/dev.c#L156>)

Executes development commands based on configuration and arguments, managing processes and debugging options.
- **Inputs**:
    - `args`: Pointer to `args_t` structure containing command-line arguments and development options.
    - `config`: Pointer to `config_t` structure containing configuration settings for the development environment.
    - `agave_main`: Function pointer to a function that takes a constant `config_t` pointer, used for additional processing if required.
- **Logic and Control Flow**:
    - Checks if configuration is needed using `args->dev.no_configure` and calls `configure_cmd_fn` if not.
    - Updates the configuration for development using [`update_config_for_dev`](<#update_config_for_dev>).
    - Checks if Agave should be disabled using `args->dev.no_agave` and updates the configuration accordingly.
    - Handles debugging options by checking `args->dev.debug_tile` and updates the configuration to disable sandboxing if necessary.
    - Determines whether to run in watch mode or not using `args->dev.no_watch`.
    - If not in watch mode and cloning is allowed, calls `run_firedancer` or [`run_firedancer_threaded`](<#run_firedancer_threaded>) based on `args->dev.no_init_workspaces`.
    - If in watch mode and cloning is allowed, sets up signal handling, creates a pipe, forks processes for `firedancer` and `watch`, and manages their execution and termination.
    - If in watch mode and cloning is not allowed, creates a pipe, duplicates file descriptors, and runs [`run_firedancer_threaded`](<#run_firedancer_threaded>) and `watch_cmd_fn`.
- **Output**: No direct output; manages processes and updates configuration based on input arguments.
- **Functions Called**:
    - [`update_config_for_dev`](<#update_config_for_dev>)
    - [`run_firedancer_threaded`](<#run_firedancer_threaded>)
    - [`install_parent_signals`](<#install_parent_signals>)


# Function Declarations (Public API)

---
### fdctl\_tile\_run<!-- {{#callable_declaration:fdctl_tile_run}} -->
[View Source →](<../../../../../../src/app/shared_dev/commands/dev.c#L17>)

Finds and returns a tile from the topology by name.
- **Description**: Use this function to retrieve a tile from the topology based on its name. It searches through a predefined list of tiles and returns the tile that matches the given name. If no matching tile is found, it logs an error and returns a default-initialized tile structure. This function is useful when you need to access specific tile configurations or properties by name. Ensure that the tile name provided is valid and exists in the topology to avoid errors.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure that contains the name of the tile to find. Must not be null. The function expects the `name` field of this structure to be a valid string representing the tile's name.
- **Output**: Returns a `fd_topo_run_tile_t` structure representing the found tile. If no tile is found, returns a default-initialized `fd_topo_run_tile_t` and logs an error.
- **See Also**: [`fdctl_tile_run`](<../../shared/boot/fd_boot.c.md#fdctl_tile_run>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)