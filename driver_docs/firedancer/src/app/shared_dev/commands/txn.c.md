<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions to send QUIC transactions with command-line argument parsing and permission checks.

# Purpose
The code is a C source file that implements functionality for sending transactions over a QUIC (Quick UDP Internet Connections) protocol. It is part of a larger system that interacts with network namespaces and uses QUIC to transmit data. The file includes several headers from shared and platform-specific directories, indicating that it relies on external utilities and configurations for its operations. The primary function, [`txn_cmd_fn`](<#txn_cmd_fn>), orchestrates the setup and execution of sending transactions to a specified destination IP and port using the QUIC protocol.

The code defines several callback functions, such as [`cb_conn_hs_complete`](<#cb_conn_hs_complete>), [`cb_conn_final`](<#cb_conn_final>), and [`cb_stream_notify`](<#cb_stream_notify>), which handle events related to the QUIC connection and stream notifications. The [`send_quic_transactions`](<#send_quic_transactions>) function is responsible for managing the connection lifecycle, including establishing a connection, sending transactions, and closing the connection. The file also includes command-line argument parsing functions to configure transaction parameters, such as payload and destination details. The `fd_action_txn` structure defines the action for sending transactions, including its name, argument parsing function, execution function, permission checks, and a description. This code is intended to be part of a larger application that sends transactions to a specified endpoint using the QUIC protocol.
# Imports and Dependencies

---
- `../../shared/fd_config.h`
- `../../shared/fd_action.h`
- `../../platform/fd_sys_util.h`
- `../../platform/fd_net_util.h`
- `../../shared/commands/ready.h`
- `../../../ballet/base64/fd_base64.h`
- `../../../waltz/quic/fd_quic.h`
- `../../../waltz/quic/tests/fd_quic_test_helpers.h`
- `../../../waltz/tls/test_tls_helper.h`
- `../../../util/net/fd_ip4.h`
- `errno.h`
- `sys/random.h`
- `linux/capability.h`


# Global Variables

---
### g\_conn\_hs\_complete
- **Type**: `int`
- **Description**: Indicates whether the QUIC connection handshake is complete. It is initialized to 0 and set to 1 when the handshake is complete.
- **Use**: Used to track the completion status of a QUIC connection handshake.


---
### g\_conn\_final
- **Type**: `int`
- **Description**: `g_conn_final` is a static integer variable initialized to 0. It is used to indicate the final state of a QUIC connection.
- **Use**: Used to track when a QUIC connection has reached its final state, allowing the program to perform cleanup or termination actions.


---
### g\_stream\_notify
- **Type**: `ulong`
- **Description**: `g_stream_notify` is a static global variable of type `ulong` initialized to 0UL. It is used to count the number of stream notifications received.
- **Use**: Tracks the number of times the `cb_stream_notify` callback function is called.


---
### txn\_cmd\_perm
- **Type**: `function`
- **Description**: Checks if the network namespace feature is enabled in the configuration and verifies the necessary capabilities to enter a network namespace.
- **Use**: Used to ensure the correct permissions are set for network namespace operations.


---
### fd\_action\_txn
- **Type**: ``action_t``
- **Description**: Defines an action named 'txn' that is used to send a transaction to an fddev instance. It includes function pointers for handling command arguments, executing the command, and checking permissions.
- **Use**: Used to encapsulate the logic and parameters for sending transactions in the application.


# Functions

---
### txn\_cmd\_args<!-- {{#callable:txn_cmd_args}} -->
[View Source →](<../../../../../../src/app/shared_dev/commands/txn.c#L33>)

Parses command-line arguments to configure transaction parameters such as payload, count, destination IP, and port.
- **Inputs**:
    - ``pargc``: A pointer to an integer representing the number of command-line arguments.
    - ``pargv``: A pointer to an array of strings representing the command-line arguments.
    - ``args``: A pointer to an `args_t` structure where parsed transaction parameters will be stored.
- **Logic and Control Flow**:
    - Extracts the `--payload-base64-encoded` argument from the command line and assigns it to `args->txn.payload_base64`.
    - Extracts the `--count` argument from the command line, assigns it to `args->txn.count`, and checks if it is within the valid range (1 to `MAX_TXN_COUNT`).
    - Logs an error and exits if `args->txn.count` is not within the valid range.
    - Extracts the `--dst-ip` argument from the command line and assigns it to `args->txn.dst_ip`.
    - Extracts the `--dst-port` argument from the command line and assigns it to `args->txn.dst_port`.
- **Output**: No return value; modifies the `args` structure with parsed command-line arguments.


---
### cb\_conn\_hs\_complete<!-- {{#callable:cb_conn_hs_complete}} -->
[View Source →](<../../../../../../src/app/shared_dev/commands/txn.c#L46>)

Sets the global variable `g_conn_hs_complete` to 1, indicating that a QUIC connection handshake is complete.
- **Inputs**:
    - ``conn``: A pointer to an `fd_quic_conn_t` structure, representing the QUIC connection. It is not used in the function.
    - ``quic_ctx``: A pointer to a context for the QUIC operation. It is not used in the function.
- **Logic and Control Flow**:
    - Ignore the `conn` and `quic_ctx` parameters by casting them to void.
    - Set the global variable `g_conn_hs_complete` to 1.
- **Output**: No return value; the function modifies the global state by setting `g_conn_hs_complete`.


---
### cb\_conn\_final<!-- {{#callable:cb_conn_final}} -->
[View Source →](<../../../../../../src/app/shared_dev/commands/txn.c#L54>)

Sets the global variable `g_conn_final` to 1, indicating the finalization of a QUIC connection.
- **Inputs**:
    - ``conn``: A pointer to an `fd_quic_conn_t` structure, representing the QUIC connection. It is not used in the function.
    - ``quic_ctx``: A pointer to a context for the QUIC connection. It is not used in the function.
- **Logic and Control Flow**:
    - Ignore the input parameters `conn` and `quic_ctx` by casting them to void.
    - Set the global variable `g_conn_final` to 1.
- **Output**: No return value; the function modifies the global state by setting `g_conn_final`.


---
### cb\_stream\_notify<!-- {{#callable:cb_stream_notify}} -->
[View Source →](<../../../../../../src/app/shared_dev/commands/txn.c#L62>)

Increments the global variable `g_stream_notify` by 1.
- **Inputs**:
    - `stream`: A pointer to an `fd_quic_stream_t` structure, which is not used in the function.
    - `stream_ctx`: A pointer to a context for the stream, which is not used in the function.
    - `notify_type`: An integer representing the type of notification, which is not used in the function.
- **Logic and Control Flow**:
    - Ignore the input parameters `stream`, `stream_ctx`, and `notify_type` by casting them to void.
    - Increment the global variable `g_stream_notify` by 1.
- **Output**: No output is returned from this function.


---
### send\_quic\_transactions<!-- {{#callable:send_quic_transactions}} -->
[View Source →](<../../../../../../src/app/shared_dev/commands/txn.c#L72>)

Sends a specified number of QUIC transactions to a given destination IP and port using a QUIC connection.
- **Inputs**:
    - ``quic``: A pointer to an `fd_quic_t` structure representing the QUIC context.
    - ``udpsock``: A pointer to an `fd_quic_udpsock_t` structure representing the UDP socket used for the QUIC connection.
    - ``count``: An unsigned long integer specifying the number of transactions to send.
    - ``dst_ip``: An unsigned integer representing the destination IP address.
    - ``dst_port``: An unsigned short integer representing the destination port number.
    - ``pkt``: A pointer to an array of `fd_aio_pkt_info_t` structures containing the packet information to be sent.
- **Logic and Control Flow**:
    - Set the asynchronous I/O network transmission for the QUIC context using the UDP socket's AIO.
    - Initialize the QUIC context and set callback functions for connection finalization, handshake completion, and stream notification.
    - Establish a QUIC connection to the specified destination IP and port.
    - Wait for the connection handshake to complete or for the connection to finalize.
    - Check if the connection is active; if not, log an error and exit.
    - Send packets in a loop until the specified count is reached or the connection finalizes.
    - For each packet, create a new stream and send the packet data; if stream creation fails, continue to the next iteration.
    - After sending all packets, wait for all stream notifications to complete or for the connection to finalize.
    - If the connection is not finalized, close the connection and wait for it to finalize.
    - Finalize the QUIC context.
- **Output**: No return value; the function performs network operations and logs errors if they occur.


---
### txn\_cmd\_fn<!-- {{#callable:txn_cmd_fn}} -->
[View Source →](<../../../../../../src/app/shared_dev/commands/txn.c#L131>)

Sends transactions to a specified destination using QUIC protocol after preparing the necessary configurations and resources.
- **Inputs**:
    - `args`: A pointer to an `args_t` structure containing transaction details such as payload, count, destination IP, and port.
    - `config`: A pointer to a `config_t` structure containing configuration settings, including network namespace and network parameters.
- **Logic and Control Flow**:
    - Checks if network namespace is enabled and attempts to enter it if so.
    - Calls `ready_cmd_fn` to ensure the validator is ready to receive transactions.
    - Sets up QUIC limits and calculates the required memory footprint.
    - Creates a new anonymous workspace and allocates memory for QUIC operations.
    - Initializes a random number generator and a signing context for QUIC identity.
    - Configures the QUIC client with role, timeout, and stream data settings.
    - Prepares transaction packets, either using a hardcoded sample or decoding a base64 payload.
    - Determines the destination IP and port, using defaults from `config` if not specified in `args`.
    - Logs the transaction sending operation and calls [`send_quic_transactions`](<#send_quic_transactions>) to perform the actual sending.
    - Exits the process group after sending transactions.
- **Output**: No return value; the function performs its operations and exits the process group.
- **Functions Called**:
    - [`send_quic_transactions`](<#send_quic_transactions>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)