<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines a load testing command for an external validator, including argument parsing and execution logic.

# Purpose
The code defines a module that is part of a larger system for configuring and running load tests on an external validator. It includes functions to handle command-line arguments, set permissions, and execute the load test. The module uses several external libraries and headers, such as `bench.h`, `configure.h`, and `run.h`, indicating its integration with a broader framework for benchmarking and configuration management.

The primary components of the code are the functions `load_cmd_perm`, [`load_cmd_args`](<#load_cmd_args>), and [`load_cmd_fn`](<#load_cmd_fn>). These functions are responsible for setting up the environment and parameters for the load test, including network configurations like IP addresses and ports, as well as benchmarking parameters such as the number of benchmarks and accounts. The code also defines an `action_t` structure named `fd_action_load`, which encapsulates the load test action, including its name, argument handling function, permission function, execution function, and a description. This structure suggests that the module is part of a command-driven system where different actions can be executed based on user input.
# Imports and Dependencies

---
- `bench/bench.h`
- `../../shared/commands/configure/configure.h`
- `../../shared/commands/run/run.h`
- `../../../disco/topo/fd_topob.h`
- `../../../util/net/fd_ip4.h`
- `unistd.h`


# Global Variables

---
### load\_cmd\_perm
- **Type**: `function`
- **Description**: Processes command permissions for loading operations. It configures the command permissions by setting up the necessary stages and then calls `configure_cmd_perm` to apply these configurations.
- **Use**: Used to set up and apply command permissions for loading operations in the system.


---
### fd\_action\_load
- **Type**: ``action_t``
- **Description**: Defines an action structure for load testing an external validator. It includes the name of the action, the function pointers for handling arguments, permissions, and execution, as well as a description of the action.
- **Use**: Used to encapsulate the details and functions necessary to perform a load test on an external validator.


# Functions

---
### load\_cmd\_args<!-- {{#callable:load_cmd_args}} -->
[View Source →](<../../../../../../src/app/shared_dev/commands/load.c#L29>)

Parses command-line arguments and populates the `args` structure with the extracted values.
- **Inputs**:
    - `pargc`: A pointer to an integer representing the count of command-line arguments.
    - `pargv`: A pointer to an array of strings representing the command-line arguments.
    - `args`: A pointer to an `args_t` structure where the parsed command-line arguments will be stored.
- **Logic and Control Flow**:
    - Extracts the `--tpu-ip`, `--rpc-ip`, and `--affinity` command-line arguments as strings using `fd_env_strip_cmdline_cstr` and stores them in local variables.
    - Extracts and assigns various command-line arguments to the `args->load` structure fields using `fd_env_strip_cmdline_ushort`, `fd_env_strip_cmdline_ulong`, `fd_env_strip_cmdline_int`, and `fd_env_strip_cmdline_float`.
    - Appends the `affinity` string to `args->load.affinity` using `fd_cstr_append_cstr_safe`.
    - Initializes `args->load.tpu_ip` and `args->load.rpc_ip` to 0.
    - Converts `tpu_ip` and `rpc_ip` strings to IP addresses using `fd_cstr_to_ip4_addr` and assigns them to `args->load.tpu_ip` and `args->load.rpc_ip`, logging an error if conversion fails.
    - Checks for the presence of the `--no-quic` argument and assigns the result to `args->load.no_quic`.
- **Output**: Populates the `args` structure with parsed command-line argument values.


---
### load\_cmd\_fn<!-- {{#callable:load_cmd_fn}} -->
[View Source →](<../../../../../../src/app/shared_dev/commands/load.c#L64>)

Initializes and configures network and benchmark settings for a load test, then runs the test in a single process.
- **Inputs**:
    - `args`: A pointer to an `args_t` structure containing command-line arguments and settings for the load test.
    - `config`: A pointer to a `config_t` structure containing configuration settings and defaults.
- **Logic and Control Flow**:
    - Check if `args->load.tpu_ip` is not set, and if so, set it to `config->net.ip_addr`.
    - Check if `args->load.rpc_ip` is not set, and if so, set it to `config->net.ip_addr`.
    - Check if `args->load.tpu_port` is not set, and if so, set it using `fd_ushort_if` based on `args->load.no_quic`.
    - Check if `args->load.rpc_port` is not set, and if so, set it to `config->rpc.port`; log an error if still not set.
    - Check if `args->load.affinity` is empty, and if so, append `config->development.bench.affinity` to it.
    - Set other `args->load` fields to corresponding values from `config` if they are not set.
    - Create a new topology object `topo` and set its `max_page_size`.
    - Call `add_bench_topo` with the configured parameters to add benchmark topology.
    - Update `config->topo` with the new topology.
    - Initialize `configure_args` and set the first stage to `hugetlbfs` if present in `STAGES`.
    - Call `configure_cmd_fn` with `configure_args` and `config`.
    - Initialize workspaces and stacks using `initialize_workspaces` and `initialize_stacks`.
    - Log the current configuration settings using `FD_LOG_NOTICE`.
    - Run the topology in a single process using `fd_topo_run_single_process`.
    - Enter an infinite loop with `pause()` to keep the parent thread running indefinitely.
- **Output**: No return value; the function performs configuration and starts a process.


# Function Declarations (Public API)

---
### fdctl\_tile\_run<!-- {{#callable_declaration:fdctl_tile_run}} -->
[View Source →](<../../../../../../src/app/shared_dev/commands/load.c#L10>)

Finds and returns a tile configuration by name.
- **Description**: Use this function to retrieve a tile configuration from a predefined list of tiles by matching the tile's name. This function is useful when you need to access specific tile configurations based on their names. It is important to ensure that the `tile` parameter is not null and that the tile name exists in the list; otherwise, an error is logged, and a default-initialized tile configuration is returned.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure representing the tile to find. The `name` field of this structure is used to search for a matching tile in the list. Must not be null. If the tile name is not found, an error is logged.
- **Output**: Returns a `fd_topo_run_tile_t` structure corresponding to the tile with the matching name. If no match is found, returns a default-initialized `fd_topo_run_tile_t`.
- **See Also**: [`fdctl_tile_run`](<../../shared/boot/fd_boot.c.md#fdctl_tile_run>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)