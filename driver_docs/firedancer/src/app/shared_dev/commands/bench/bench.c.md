<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines and manages the benchmarking topology and execution for the Firedancer application.

# Purpose
The code is a C source file that appears to be part of a larger system for configuring and running a networked application, possibly related to benchmarking or performance testing. It includes several functions that manage the setup and execution of a topology of computational tiles, which are likely used to simulate or test network transactions. The file includes headers from various directories, indicating that it relies on shared components and utilities for topology management, shared memory, and tile operations.

Key functions in the code include [`add_bench_topo`](<#add_bench_topo>), which configures a benchmark topology by setting up links between tiles and assigning CPU affinities, and [`bench_cmd_fn`](<#bench_cmd_fn>), which orchestrates the execution of a benchmark command by configuring network settings, initializing components, and running the application in a specific environment. The code also handles CPU affinity settings and ensures that configurations are consistent across different components. The use of external functions and data structures, such as `fd_topo_obj_callbacks_t` and `fd_topo_run_tile_t`, suggests that this file is part of a modular system where different components interact through defined interfaces.
# Imports and Dependencies

---
- `../dev.h`
- `../../../shared/commands/configure/configure.h`
- `../../../shared/commands/run/run.h`
- `../../../../disco/topo/fd_topob.h`
- `../../../../disco/topo/fd_cpu_topo.h`
- `../../../../util/shmem/fd_shmem_private.h`
- `../../../../util/tile/fd_tile_private.h`
- `unistd.h`
- `stdio.h`
- `sched.h`
- `fcntl.h`
- `pthread.h`
- `linux/capability.h`
- `linux/futex.h`
- `sys/syscall.h`
- `sys/wait.h`
- `sys/socket.h`
- `arpa/inet.h`


# Global Variables

---
### CALLBACKS
- **Type**: `fd_topo_obj_callbacks_t *`
- **Description**: An array of pointers to `fd_topo_obj_callbacks_t` structures. These structures likely contain function pointers or callback functions related to topology objects.
- **Use**: Used to store and manage callback functions for topology objects in the system.


---
### fd\_log\_private\_shared\_lock
- **Type**: `int *`
- **Description**: A pointer to an integer that is declared as an external variable, indicating it is defined elsewhere in the program or in another file. It is used to manage shared locking mechanisms in the logging system.
- **Use**: Used to control access to shared resources in the logging system by acting as a lock.


# Functions

---
### bench\_cmd\_args<!-- {{#callable:bench_cmd_args}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/bench/bench.c#L31>)

Sets the `no_quic` flag in the `args` structure based on the presence of the `--no-quic` command-line argument.
- **Inputs**:
    - `pargc`: A pointer to an integer representing the count of command-line arguments.
    - `pargv`: A pointer to an array of strings representing the command-line arguments.
    - `args`: A pointer to an `args_t` structure where the `no_quic` flag will be set.
- **Logic and Control Flow**:
    - Calls `fd_env_strip_cmdline_contains` with `pargc`, `pargv`, and the string `--no-quic` to check if the `--no-quic` argument is present in the command-line arguments.
    - Assigns the result of `fd_env_strip_cmdline_contains` to `args->load.no_quic`.
- **Output**: No direct output; modifies the `args` structure by setting the `no_quic` flag.


---
### add\_bench\_topo<!-- {{#callable:add_bench_topo}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/bench/bench.c#L38>)

Configures and initializes a benchmark topology with specified parameters and CPU affinities.
- **Inputs**:
    - `topo`: A pointer to the `fd_topo_t` structure representing the topology to configure.
    - `affinity`: A string specifying the CPU affinity for the benchmark tiles.
    - `benchg_tile_cnt`: The number of generator tiles in the benchmark.
    - `benchs_tile_cnt`: The number of sink tiles in the benchmark.
    - `accounts_cnt`: The number of accounts for the generator tiles.
    - `transaction_mode`: The mode of transactions for the generator tiles.
    - `contending_fraction`: The fraction of contending transactions for the generator tiles.
    - `cu_price_spread`: The price spread for compute units in the generator tiles.
    - `conn_cnt`: The number of connections for the sink tiles.
    - `send_to_port`: The port number to which the sink tiles send data.
    - `send_to_ip_addr`: The IP address to which the sink tiles send data.
    - `rpc_port`: The RPC port for the output tile.
    - `rpc_ip_addr`: The RPC IP address for the output tile.
    - `no_quic`: A flag indicating whether QUIC is disabled for the sink tiles.
    - `reserve_agave_cores`: A flag indicating whether to reserve cores for Agave.
- **Logic and Control Flow**:
    - Initialize the workspace for the benchmark topology using `fd_topob_wksp` and create links for output and generator tiles.
    - Determine if the affinity is set to 'auto' and parse the CPU affinity string if not.
    - Initialize CPU topology and parse the CPU affinity string into `parsed_tile_to_cpu`.
    - Check for errors in CPU affinity string against available CPUs and log errors or warnings as needed.
    - Create and configure the output tile (`bencho`) with RPC settings.
    - Create and configure generator tiles (`benchg`) with account, mode, and transaction settings.
    - Create and configure sink tiles (`benchs`) with connection and network settings.
    - Establish input and output links between tiles using `fd_topob_tile_in` and `fd_topob_tile_out`.
    - If auto affinity is enabled, recompute the topology layout using `fd_topob_auto_layout`.
    - Finalize the topology configuration with `fd_topob_finish`.
- **Output**: No direct output is returned; the function modifies the `topo` structure to reflect the configured benchmark topology.


---
### bench\_cmd\_fn<!-- {{#callable:bench_cmd_fn}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/bench/bench.c#L125>)

Configures and initializes the benchmarking environment based on the provided arguments and configuration settings.
- **Inputs**:
    - `args`: A pointer to an `args_t` structure containing command-line arguments, including a flag to disable QUIC.
    - `config`: A pointer to a `config_t` structure containing configuration settings for the benchmarking environment.
- **Logic and Control Flow**:
    - Determine the destination port based on whether QUIC is disabled using `fd_ushort_if` function.
    - Set the RPC port in the configuration, defaulting to 8899 if not already set.
    - Enable full API for `frankendancer` if `is_firedancer` is false.
    - Check if CPU affinity settings are consistent across different configuration sections and log an error if they are not.
    - Call [`add_bench_topo`](<#add_bench_topo>) to set up the benchmark topology with the specified parameters.
    - Initialize `configure_args` with `CONFIGURE_CMD_INIT` and populate its stages from `STAGES` array.
    - Call `configure_cmd_fn` to apply the configuration settings.
    - Update the configuration for development using [`update_config_for_dev`](<../dev.c.md#update_config_for_dev>).
    - Initialize the Firedancer environment with `run_firedancer_init`.
    - Set up network namespaces with `fdctl_setup_netns`.
    - If the network provider is 'xdp', install XDP using `fd_topo_install_xdp`.
    - Unlock the shared log lock for index 1.
    - Join workspaces in read-write mode using `fd_topo_join_workspaces`.
    - Run the topology in a single process mode using `fd_topo_run_single_process`.
- **Output**: No return value; the function modifies the configuration and sets up the benchmarking environment.
- **Functions Called**:
    - [`add_bench_topo`](<#add_bench_topo>)
    - [`update_config_for_dev`](<../dev.c.md#update_config_for_dev>)


# Function Declarations (Public API)

---
### fdctl\_tile\_run<!-- {{#callable_declaration:fdctl_tile_run}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/bench/bench.c#L25>)

Finds and returns a tile configuration by name.
- **Description**: Use this function to retrieve the configuration of a specific tile by its name. The function searches through a predefined list of tiles and returns the configuration of the tile that matches the given name. If the tile is not found, an error is logged, and a default configuration is returned. This function assumes that the tile list is properly initialized and that the tile names are unique.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure that contains the name of the tile to find. Must not be null. The function does not modify the input structure.
- **Output**: Returns a `fd_topo_run_tile_t` structure containing the configuration of the found tile. If the tile is not found, returns a default-initialized `fd_topo_run_tile_t`.
- **See Also**: [`fdctl_tile_run`](<../../../shared/boot/fd_boot.c.md#fdctl_tile_run>)  (Implementation)


---
### update\_config\_for\_dev<!-- {{#callable_declaration:update_config_for_dev}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/bench/bench.c#L28>)

Updates the configuration with the computed shred version.
- **Description**: Use this function to update the configuration structure with the shred version derived from the genesis file, if available. This function should be called when the configuration needs to reflect the correct shred version for development purposes. It assumes that the `config` parameter is a valid pointer to a `fd_config_t` structure and that the `paths.ledger` field within this structure is correctly set to the directory containing the `genesis.bin` file. The function will attempt to compute the shred version from this file and update the `expected_shred_version` fields in the configuration's topology tiles accordingly. If the genesis file does not exist, the shred version will remain zero, and it will be obtained from gossip. Ensure that the configuration structure is properly initialized before calling this function.
- **Inputs**:
    - `config`: A pointer to an `fd_config_t` structure that contains the configuration data to be updated. The `paths.ledger` field must point to the directory containing the `genesis.bin` file. The caller retains ownership of this structure, and it must not be null. If the shred version cannot be computed and the error is not due to the file being absent, an error is logged.
- **Output**: None
- **See Also**: [`update_config_for_dev`](<../dev.c.md#update_config_for_dev>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)