<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a packet generator for network testing, including topology setup, command handling, and status rendering.

# Purpose
The code is a C source file that implements a packet generator (`pktgen`) for network testing. It is designed to configure and run a network topology using a set of predefined commands and configurations. The file includes several external headers and libraries to manage network topology, metrics, and configurations. The primary function, `pktgen_cmd_fn`, sets up the network environment, configures the necessary parameters, and runs the packet generator in a single process. It also includes a simple command-line interface to start, stop, or quit the packet generation process.

The code defines several functions and structures to manage the network topology and metrics. The [`pktgen_topo`](<#pktgen_topo>) function configures the network topology based on the provided configuration, including setting CPU affinities and initializing network tiles. The [`render_status`](<#render_status>) function periodically prints network statistics to the console, such as packet rates and buffer statuses. The code also includes a simple REPL (Read-Eval-Print Loop) to interact with the packet generator, allowing users to issue commands to control its operation. The `fd_action_pktgen` structure defines the packet generator action, including its name, arguments, function, permissions, and description.
# Imports and Dependencies

---
- `../dev.h`
- `../../../shared/commands/configure/configure.h`
- `../../../shared/commands/run/run.h`
- `../../../../disco/net/fd_net_tile.h`
- `../../../../disco/metrics/fd_metrics.h`
- `../../../../disco/topo/fd_topob.h`
- `../../../../disco/topo/fd_cpu_topo.h`
- `../../../../util/net/fd_ip4.h`
- `../../../../util/tile/fd_tile_private.h`
- `stdio.h`
- `unistd.h`
- `sys/ioctl.h`
- `poll.h`


# Global Variables

---
### CALLBACKS
- **Type**: `fd_topo_obj_callbacks_t *`
- **Description**: An array of pointers to `fd_topo_obj_callbacks_t` structures. These structures likely contain callback functions or methods related to topology objects.
- **Use**: Used to pass callback functions to the `fd_topob_finish` function for finalizing topology operations.


---
### fd\_pktgen\_active
- **Type**: ``uint``
- **Description**: A global variable that indicates whether the packet generator is active or not. It is used to control the mode of operation for the packet generator, switching between sending and receiving packets or just receiving.
- **Use**: Used to determine the operational mode of the packet generator in the `render_status` function and in the command loop to start or stop the packet generator.


---
### pktgen\_cmd\_fn
- **Type**: `function`
- **Description**: Executes the packet generator command function, which sets up and runs the packet generator topology using the provided configuration.
- **Use**: Used to initialize and execute the packet generator topology based on the given configuration.


---
### fd\_action\_pktgen
- **Type**: ``action_t``
- **Description**: Defines an action structure for packet generation, which includes the name, arguments, function, permissions, and a description of the action.
- **Use**: Used to configure and execute the packet generation command that floods an interface with invalid Ethernet frames.


# Functions

---
### pktgen\_topo<!-- {{#callable:pktgen_topo}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/pktgen/pktgen.c#L21>)

Configures and initializes the packet generator topology based on the provided configuration.
- **Inputs**:
    - `config`: A pointer to a `config_t` structure containing the configuration settings for the packet generator.
- **Logic and Control Flow**:
    - Retrieve the CPU affinity setting from the configuration and determine if it is set to 'auto'.
    - Initialize an array `parsed_tile_to_cpu` to map tiles to CPUs, setting all entries to `USHORT_MAX`.
    - Initialize the CPU topology using `fd_topo_cpus_init`.
    - If the affinity is not 'auto', parse the CPU affinity string to populate `parsed_tile_to_cpu`.
    - Map parsed tile indices to CPU indices, checking for invalid CPU indices and logging errors if necessary.
    - Verify that the number of CPUs specified in the affinity string is exactly three, logging an error if not.
    - Reset the topology using `fd_topob_new` and set the maximum page size for shared memory.
    - Configure workspaces and tiles for metrics and packet generation using `fd_topob_wksp` and `fd_topob_tile`.
    - Validate and set the fake destination IP address for the packet generator tile, logging an error if invalid.
    - Create links and configure input/output for the packet generator and network tiles.
    - Create a dummy RX link for the network tile.
    - Finalize the network tile configuration and apply automatic layout if the affinity is 'auto'.
    - Set the `agave_affinity_cnt` to zero and finish the topology setup with `fd_topob_finish`.
    - Print the topology configuration to the log.
- **Output**: No return value; the function modifies the `config` structure and logs errors if configuration issues are detected.


---
### pktgen\_cmd\_args<!-- {{#callable:pktgen_cmd_args}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/pktgen/pktgen.c#L79>)

Does not perform any operations and is a placeholder for future configuration options.
- **Inputs**:
    - ``pargc``: Pointer to an integer representing the argument count.
    - ``pargv``: Pointer to an array of strings representing the argument vector.
    - ``args``: Pointer to an `args_t` structure for additional arguments.
- **Logic and Control Flow**:
    - The function currently does nothing with its input parameters.
    - The parameters `pargc`, `pargv`, and `args` are cast to void to suppress unused variable warnings.
- **Output**: No output is produced as the function does not perform any operations.


---
### render\_status<!-- {{#callable:render_status}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/pktgen/pktgen.c#L94>)

Prints network statistics to the terminal, including packet rates and buffer statuses, while managing cursor position for a clean display.
- **Inputs**:
    - ``net_metrics``: A pointer to an array of volatile unsigned long integers representing network metrics.
- **Logic and Control Flow**:
    - Saves the current cursor position and moves it to the top of the terminal.
    - Prints the current mode of the packet generator based on the `fd_pktgen_active` flag.
    - Initializes static variables for tracking time and network metrics if they have not been set.
    - Calculates the time difference since the last update and checks if it exceeds 10 milliseconds.
    - If the time difference is sufficient, updates cumulative and delta metrics for idle time, ticks, received and transmitted packets, and bytes.
    - Calculates busy ratio, packet per second rates, and bits per second rates for received and transmitted packets.
    - Updates the last known values of metrics for the next calculation cycle.
    - Retrieves current idle and busy buffer counts for RX and TX.
    - Prints the calculated network statistics, including busy percentage, packet rates, and buffer statuses.
    - Restores the cursor position and flushes the output to ensure it is displayed immediately.
- **Output**: No return value; outputs statistics directly to the terminal.


# Function Declarations (Public API)

---
### fdctl\_tile\_run<!-- {{#callable_declaration:fdctl_tile_run}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/pktgen/pktgen.c#L18>)

Finds and returns a tile from a predefined list by name.
- **Description**: Use this function to search for a tile in a predefined list of tiles by its name. It returns the tile if found, or logs an error and returns a default-initialized tile if not found. Ensure that the tile name is unique within the list to avoid unexpected results. This function is useful when you need to retrieve a specific tile's configuration or state based on its name.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure representing the tile to find. The `name` field of this structure is used for comparison. Must not be null.
- **Output**: Returns a `fd_topo_run_tile_t` structure representing the found tile. If the tile is not found, logs an error and returns a default-initialized `fd_topo_run_tile_t`.
- **See Also**: [`fdctl_tile_run`](<../../../shared/boot/fd_boot.c.md#fdctl_tile_run>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)