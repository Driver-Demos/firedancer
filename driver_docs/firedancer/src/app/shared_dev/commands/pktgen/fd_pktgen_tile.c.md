<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Generates and sends small Ethernet frames with unique payloads to test network tiles.

# Purpose
The code is a C module designed to generate and send small Ethernet packets from a network tile, primarily for testing or experimental purposes. It defines a structure `fd_pktgen_tile_ctx_t` to maintain the context for packet generation, including pointers to output buffers and metadata such as sequence numbers and fake destination IP addresses. The module uses a sequence number in each packet to ensure that the payloads are unique, which helps prevent network interface cards (NICs) from stopping transmission due to repeated identical payloads.

The module includes functions for initializing the packet generation context ([`unprivileged_init`](<#unprivileged_init>)) and for handling the packet sending process ([`before_credit`](<#before_credit>)). The [`before_credit`](<#before_credit>) function constructs Ethernet frames with a fake destination IP and sends them using a function from an included library. The code is part of a larger system, as indicated by the inclusion of external headers and the use of macros to integrate with a framework for running network tiles (`fd_topo_run_tile_t`). The module is not intended to be a standalone executable but rather a component within a network simulation or testing environment.
# Imports and Dependencies

---
- `../../../../disco/topo/fd_topo.h`
- `../../../../util/net/fd_eth.h`
- `../../../../disco/stem/fd_stem.c`


# Global Variables

---
### fd\_pktgen\_active
- **Type**: ``uint``
- **Description**: A global variable that indicates whether the packet generator is active. It is initialized to 0U, which typically means inactive.
- **Use**: Used to check if the packet generator should perform operations in the `before_credit` function.


---
### fd\_tile\_pktgen
- **Type**: ``fd_topo_run_tile_t``
- **Description**: Represents a configuration for a network tile that generates packets. It includes function pointers for alignment, footprint calculation, initialization, and execution of the packet generation process.
- **Use**: Used to configure and manage the execution of a packet generation tile in a network topology.


# Data Structures

---
### fd\_pktgen\_tile\_ctx
- **Type**: ``struct``
- **Members**:
    - `out_base`: Pointer to the base address of the output buffer.
    - `chunk0`: Initial chunk index for packet generation.
    - `wmark`: Watermark indicating the maximum chunk index.
    - `chunk`: Current chunk index for packet generation.
    - `tag`: Tag used for packet identification.
    - `fake_dst_ip`: Fake destination IP address for packet generation.
- **Description**: Manages the context for generating packets in a network tile, including buffer pointers, chunk indices, and packet metadata.


---
### fd\_pktgen\_tile\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``out_base``: Pointer to the base address of the output workspace.
    - ``chunk0``: Initial chunk index for packet generation.
    - ``wmark``: Watermark for the maximum chunk index.
    - ``chunk``: Current chunk index for packet generation.
    - ``tag``: Tag used to differentiate packets.
    - ``fake_dst_ip``: Fake destination IP address for packet generation.
- **Description**: `fd_pktgen_tile_ctx_t` is a structure used in the packet generation process for a network tile. It holds context information such as the base address of the output workspace, chunk indices for packet generation, a tag for packet differentiation, and a fake destination IP address. This context is used to manage the generation and sending of Ethernet frames with unique payloads to avoid network interface card (NIC) issues.


# Functions

---
### scratch\_align<!-- {{#callable:scratch_align}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/pktgen/fd_pktgen_tile.c#L28>)

Returns the alignment requirement of the `fd_pktgen_tile_ctx_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls the `alignof` operator on the `fd_pktgen_tile_ctx_t` type to determine its alignment requirement.
    - Returns the result of the `alignof` operation.
- **Output**: The alignment requirement of the `fd_pktgen_tile_ctx_t` structure as an `ulong`.


---
### scratch\_footprint<!-- {{#callable:scratch_footprint}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/pktgen/fd_pktgen_tile.c#L33>)

Calculates the memory footprint required for a `fd_pktgen_tile_ctx_t` structure.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure, which is not used in this function.
- **Logic and Control Flow**:
    - Returns the size of the `fd_pktgen_tile_ctx_t` structure using the `sizeof` operator.
- **Output**: The function returns an `ulong` representing the size of the `fd_pktgen_tile_ctx_t` structure.


---
### unprivileged\_init<!-- {{#callable:unprivileged_init}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/pktgen/fd_pktgen_tile.c#L38>)

Initializes the packet generation context for a network tile with specific parameters.
- **Inputs**:
    - `topo`: A pointer to an `fd_topo_t` structure representing the network topology.
    - `tile`: A pointer to an `fd_topo_tile_t` structure representing the network tile to initialize.
- **Logic and Control Flow**:
    - Retrieve the packet generation context using `fd_topo_obj_laddr` with `topo` and `tile->tile_obj_id`.
    - Verify that `tile->out_cnt` is equal to 1 using `FD_TEST`.
    - Determine `out_base` by accessing the workspace of the object linked to the tile's output link.
    - Determine `out_dcache` by accessing the dcache of the link associated with the tile's output link.
    - Set `ctx->out_base` to `out_base`.
    - Calculate `ctx->chunk0` using `fd_dcache_compact_chunk0` with `out_base` and `out_dcache`.
    - Calculate `ctx->wmark` using `fd_dcache_compact_wmark` with `out_base`, `out_dcache`, and `FD_NET_MTU`.
    - Initialize `ctx->chunk` to `ctx->chunk0`.
    - Set `ctx->tag` to 0.
    - Set `ctx->fake_dst_ip` to `tile->pktgen.fake_dst_ip`.
- **Output**: No return value; the function initializes the context in place.


---
### before\_credit<!-- {{#callable:before_credit}} -->
[View Source →](<../../../../../../../src/app/shared_dev/commands/pktgen/fd_pktgen_tile.c#L55>)

Prepares and sends a minimum size Ethernet frame with a fake destination IP address.
- **Inputs**:
    - `ctx`: A pointer to `fd_pktgen_tile_ctx_t` structure containing context information for packet generation.
    - `stem`: A pointer to `fd_stem_context_t` structure used for publishing the Ethernet frame.
    - `charge_busy`: A pointer to an integer that will be set to 1 to indicate the function has performed its task.
- **Logic and Control Flow**:
    - Check if `fd_pktgen_active` is not equal to 1; if so, return immediately without doing anything.
    - Set `*charge_busy` to 1 to indicate the function is active.
    - Calculate a signature `sig` using `fd_disco_netmux_sig` with a fake destination IP from `ctx`.
    - Retrieve the current `chunk` from `ctx` and convert it to a local address `frame` using `fd_chunk_to_laddr`.
    - Retrieve the current `tag` from `ctx` and calculate the size `sz` of the Ethernet frame.
    - Store the `tag` in the `frame` at the position after the Ethernet header using `FD_STORE`.
    - Publish the Ethernet frame using `fd_stem_publish` with the calculated `sig`, `chunk`, and `sz`.
    - Increment `chunk` and check if it exceeds `ctx->wmark`; if so, reset `chunk` to `ctx->chunk0`.
    - Increment `ctx->tag` and update `ctx->chunk` with the new `chunk` value.
- **Output**: No direct output is returned, but the function modifies `charge_busy` and updates the `ctx` structure with new `chunk` and `tag` values.



---
Made with ❤️ by [Driver](https://www.driver.ai/)