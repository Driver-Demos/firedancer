<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for setting up and configuring network topology and tiles in the Firedancer application.

# Purpose
The code is a C source file that defines functions and structures for setting up and managing a network topology in a distributed system. It includes a variety of components related to network communication, data storage, and processing. The file imports several headers from different directories, indicating that it relies on external libraries and modules for its functionality. These headers include components for hashing, reassembly, execution, gossip, network communication, and more.

The primary functionality of the code revolves around configuring and initializing a topology (`fd_topo_t`) for a distributed system. It defines several functions to set up different components of the topology, such as [`setup_topo_bank_hash_cmp`](<#setup_topo_bank_hash_cmp>), [`setup_topo_banks`](<#setup_topo_banks>), [`setup_topo_fec_sets`](<#setup_topo_fec_sets>), [`setup_topo_funk`](<#setup_topo_funk>), [`setup_topo_progcache`](<#setup_topo_progcache>), [`setup_topo_store`](<#setup_topo_store>), and [`setup_topo_txncache`](<#setup_topo_txncache>). These functions create and configure objects within the topology, setting properties and linking them to workspaces. The code also includes functions for parsing and resolving network addresses, which are used to configure network communication between different components. The [`fd_topo_initialize`](<#fd_topo_initialize>) function is responsible for initializing the entire topology based on a given configuration, setting up workspaces, links, and tiles, and configuring each tile with specific properties. The code is structured to support a modular and configurable setup of a distributed system's network topology, allowing for flexible deployment and management of its components.
# Imports and Dependencies

---
- `topology.h`
- `../../ballet/lthash/fd_lthash.h`
- `../../discof/reasm/fd_reasm.h`
- `../../discof/poh/fd_poh.h`
- `../../discof/replay/fd_exec.h`
- `../../discof/gossip/fd_gossip_tile.h`
- `../../discof/tower/fd_tower_tile.h`
- `../../discof/resolv/fd_resolv_tile.h`
- `../../discof/repair/fd_repair.h`
- `../../discof/replay/fd_replay_tile.h`
- `../../disco/net/fd_net_tile.h`
- `../../discof/restore/fd_snapct_tile.h`
- `../../disco/quic/fd_tpu.h`
- `../../disco/pack/fd_pack_cost.h`
- `../../disco/tiles.h`
- `../../disco/topo/fd_topob.h`
- `../../disco/topo/fd_cpu_topo.h`
- `../../util/pod/fd_pod_format.h`
- `../../util/tile/fd_tile_private.h`
- `../../discof/restore/utils/fd_ssctrl.h`
- `../../discof/restore/utils/fd_ssmsg.h`
- `../../flamenco/gossip/fd_gossip.h`
- `../../flamenco/runtime/context/fd_capture_ctx.h`
- `../../flamenco/progcache/fd_progcache_admin.h`
- `sys/random.h`
- `sys/types.h`
- `sys/socket.h`
- `netdb.h`


# Global Variables

---
### CALLBACKS
- **Type**: ``fd_topo_obj_callbacks_t *` array`
- **Description**: An array of pointers to `fd_topo_obj_callbacks_t` structures, which are likely used to define callback functions for topology objects.
- **Use**: Used to store and manage callback functions for various topology objects in the system.


# Functions

---
### parse\_ip\_port<!-- {{#callable:parse_ip_port}} -->
[View Source →](<../../../../../src/app/firedancer/topology.c#L34>)

Parses an IP address and port from a string in the format 'ip:port' and stores the result in a `fd_topo_ip_port_t` structure.
- **Inputs**:
    - `name`: A string representing the name of the entity being parsed, used for error logging.
    - `ip_port`: A string containing the IP address and port in the format 'ip:port'.
    - `parsed_ip_port`: A pointer to a `fd_topo_ip_port_t` structure where the parsed IP address and port will be stored.
- **Logic and Control Flow**:
    - Copies the `ip_port` string into a buffer `buf` with a fixed size.
    - Finds the position of the colon ':' in `buf` to separate the IP address from the port.
    - If the colon is not found, logs an error indicating the expected format and exits.
    - Replaces the colon with a null terminator to isolate the IP address in `buf`.
    - Converts the IP address in `buf` to a numerical format and stores it in `parsed_ip_port->ip`.
    - If the IP address conversion fails, logs an error and exits.
    - Converts the port string (after the colon) to an unsigned short and stores it in `parsed_ip_port->port`.
    - If the port conversion fails, logs an error and exits.
- **Output**: The function does not return a value but populates the `parsed_ip_port` structure with the parsed IP address and port.


---
### setup\_topo\_bank\_hash\_cmp<!-- {{#callable:setup_topo_bank_hash_cmp}} -->
[View Source →](<../../../../../src/app/firedancer/topology.c#L52>)

Creates a topology object for a bank hash comparison workspace.
- **Inputs**:
    - ``topo``: A pointer to an `fd_topo_t` structure representing the topology configuration.
    - ``wksp_name``: A constant character pointer representing the name of the workspace.
- **Logic and Control Flow**:
    - Calls `fd_topob_obj` with `topo`, the string "bh_cmp", and `wksp_name` to create a topology object.
    - Stores the result in the `obj` variable.
    - Returns the `obj` variable.
- **Output**: Returns a pointer to an `fd_topo_obj_t` object.


---
### setup\_topo\_banks<!-- {{#callable:setup_topo_banks}} -->
[View Source →](<../../../../../src/app/firedancer/topology.c#L58>)

Initializes a topology object for 'banks' and inserts configuration properties for maximum live slots and fork width.
- **Inputs**:
    - ``topo``: A pointer to an `fd_topo_t` structure representing the topology configuration.
    - ``wksp_name``: A constant character pointer representing the name of the workspace.
    - ``max_live_slots``: An unsigned long integer specifying the maximum number of live slots.
    - ``max_fork_width``: An unsigned long integer specifying the maximum fork width.
- **Logic and Control Flow**:
    - Calls `fd_topob_obj` to create or retrieve a topology object named 'banks' associated with the given workspace name.
    - Inserts the `max_live_slots` value into the topology's properties using `fd_pod_insertf_ulong`, formatted with the object's ID.
    - Inserts the `max_fork_width` value into the topology's properties using `fd_pod_insertf_ulong`, formatted with the object's ID.
    - Returns the created or retrieved topology object.
- **Output**: Returns a pointer to an `fd_topo_obj_t` object representing the 'banks' topology.


---
### setup\_topo\_fec\_sets<!-- {{#callable:setup_topo_fec_sets}} -->
[View Source →](<../../../../../src/app/firedancer/topology.c#L69>)

Creates a topology object for FEC sets and inserts its size into the topology properties.
- **Inputs**:
    - ``topo``: A pointer to an `fd_topo_t` structure representing the topology.
    - ``wksp_name``: A constant character pointer representing the workspace name.
    - ``sz``: An unsigned long integer representing the size to be inserted into the topology properties.
- **Logic and Control Flow**:
    - Calls `fd_topob_obj` to create a topology object with the name 'fec_sets' and the given workspace name.
    - Inserts the size `sz` into the topology properties using `fd_pod_insertf_ulong`, with the key formatted as 'obj.%lu.sz' where `%lu` is replaced by the object's ID.
    - Returns the created topology object.
- **Output**: Returns a pointer to the created `fd_topo_obj_t` object.


---
### setup\_topo\_funk<!-- {{#callable:setup_topo_funk}} -->
[View Source →](<../../../../../src/app/firedancer/topology.c#L76>)

Initializes a topology object for a 'funk' workspace and configures its properties and workspace partition count.
- **Inputs**:
    - ``topo``: A pointer to an `fd_topo_t` structure representing the topology configuration.
    - ``wksp_name``: A constant character pointer representing the name of the workspace.
    - ``max_account_records``: An unsigned long integer specifying the maximum number of account records.
    - ``max_database_transactions``: An unsigned long integer specifying the maximum number of database transactions.
    - ``heap_size_gib``: An unsigned long integer specifying the heap size in GiB.
- **Logic and Control Flow**:
    - Create a topology object `obj` for the 'funk' workspace using `fd_topob_obj` with the given `topo` and `wksp_name`.
    - Insert the `obj` ID into the `topo->props` under the key 'funk'.
    - Insert the `max_account_records`, `max_database_transactions`, and `heap_size_gib` (converted to bytes) into `topo->props` with formatted keys using `obj->id`.
    - Calculate the `funk_footprint` using `fd_funk_footprint` with `max_database_transactions` and `max_account_records`.
    - Log an error and exit if `funk_footprint` is zero, indicating invalid parameters.
    - Find the workspace index `wksp_idx` using `fd_topo_find_wksp` with `topo` and `wksp_name`.
    - Log an error and exit if `wksp_idx` is `ULONG_MAX`, indicating the workspace was not found.
    - Calculate the maximum partition count `part_max` using `fd_wksp_part_max_est` with `funk_footprint` and `heap_size_gib` in bytes.
    - Log an error and exit if `part_max` is zero, indicating a failure in partition estimation.
    - Increase the `part_max` of the workspace at `wksp_idx` by the calculated `part_max`.
- **Output**: Returns a pointer to the initialized `fd_topo_obj_t` object for the 'funk' workspace.


---
### setup\_topo\_progcache<!-- {{#callable:setup_topo_progcache}} -->
[View Source →](<../../../../../src/app/firedancer/topology.c#L101>)

Initializes a topology object for a program cache with specified parameters and updates the workspace partition count.
- **Inputs**:
    - `topo`: A pointer to the `fd_topo_t` structure representing the topology.
    - `wksp_name`: A constant character pointer representing the name of the workspace.
    - `max_cache_entries`: An unsigned long integer specifying the maximum number of cache entries.
    - `max_database_transactions`: An unsigned long integer specifying the maximum number of database transactions.
    - `heap_size`: An unsigned long integer specifying the size of the heap.
- **Logic and Control Flow**:
    - Create a topology object `obj` using `fd_topob_obj` with the name 'funk' and the given workspace name.
    - Insert the `obj` ID into the topology properties under the key 'progcache'.
    - Insert the `max_cache_entries`, `max_database_transactions`, and `heap_size` into the topology properties, formatted with the `obj` ID.
    - Calculate the `funk_footprint` using `fd_funk_footprint` with `max_database_transactions` and `max_cache_entries`.
    - Log an error if `funk_footprint` is zero or if `heap_size` is less than twice the `funk_footprint`.
    - Find the workspace index `wksp_idx` using `fd_topo_find_wksp` with the given workspace name.
    - Log an error if `wksp_idx` is `ULONG_MAX`.
    - Estimate the maximum number of partitions `part_max` using `fd_wksp_part_max_est` with `heap_size` and a fixed size of 16KiB.
    - Log an error if `part_max` is zero.
    - Increase the `part_max` of the workspace at `wksp_idx` by the calculated `part_max`.
- **Output**: Returns a pointer to the initialized `fd_topo_obj_t` object.


---
### setup\_topo\_store<!-- {{#callable:setup_topo_store}} -->
[View Source →](<../../../../../src/app/firedancer/topology.c#L130>)

Initializes a topology object for a store with specified properties and returns it.
- **Inputs**:
    - ``topo``: A pointer to an `fd_topo_t` structure representing the topology.
    - ``wksp_name``: A constant character pointer representing the workspace name.
    - ``fec_max``: An unsigned long integer representing the maximum FEC (Forward Error Correction) value.
    - ``part_cnt``: An unsigned integer representing the partition count.
- **Logic and Control Flow**:
    - Calls `fd_topob_obj` to create a topology object with the name 'store' and the given workspace name.
    - Inserts the `fec_max` value into the topology's properties using `fd_pod_insertf_ulong`, formatted with the object's ID.
    - Inserts the `part_cnt` value into the topology's properties using `fd_pod_insertf_ulong`, formatted with the object's ID.
    - Returns the created topology object.
- **Output**: Returns a pointer to an `fd_topo_obj_t` object representing the initialized store topology.


---
### setup\_topo\_txncache<!-- {{#callable:setup_topo_txncache}} -->
[View Source →](<../../../../../src/app/firedancer/topology.c#L141>)

Initializes a transaction cache object in a topology with specified parameters.
- **Inputs**:
    - ``topo``: A pointer to an `fd_topo_t` structure representing the topology in which the transaction cache is set up.
    - ``wksp_name``: A constant character pointer representing the name of the workspace associated with the transaction cache.
    - ``max_live_slots``: An unsigned long integer specifying the maximum number of live slots for the transaction cache.
    - ``max_txn_per_slot``: An unsigned long integer specifying the maximum number of transactions per slot in the transaction cache.
- **Logic and Control Flow**:
    - Calls `fd_topob_obj` to create or retrieve a topology object named 'txncache' associated with the given workspace name.
    - Inserts the `max_live_slots` value into the topology's properties using `fd_pod_insertf_ulong`, formatted with the object's ID.
    - Inserts the `max_txn_per_slot` value into the topology's properties using `fd_pod_insertf_ulong`, formatted with the object's ID.
    - Returns the created or retrieved topology object.
- **Output**: A pointer to an `fd_topo_obj_t` structure representing the transaction cache object.


---
### resolve\_address<!-- {{#callable:resolve_address}} -->
[View Source →](<../../../../../src/app/firedancer/topology.c#L154>)

Resolves a given address to an IPv4 address and stores it in the provided variable.
- **Inputs**:
    - `address`: A constant character pointer representing the address to resolve.
    - `ip_addr`: A pointer to an unsigned integer where the resolved IPv4 address will be stored.
- **Logic and Control Flow**:
    - Initialize a `struct addrinfo` with `ai_family` set to `AF_INET` to specify IPv4 resolution.
    - Call `getaddrinfo` with the provided `address` and the initialized `hints` to get address information.
    - If `getaddrinfo` returns an error, log a warning and return 0.
    - Iterate through the linked list of `addrinfo` structures returned by `getaddrinfo`.
    - Check if the address family of the current `addrinfo` is `AF_INET`; if not, continue to the next.
    - If a valid IPv4 address is found, store it in `ip_addr`, set `resolved` to 1, and break the loop.
    - Free the `addrinfo` structure using `freeaddrinfo`.
    - Return the value of `resolved`, indicating whether the address was successfully resolved.
- **Output**: Returns an integer indicating whether the address was successfully resolved (1 for success, 0 for failure).


---
### resolve\_peer<!-- {{#callable:resolve_peer}} -->
[View Source →](<../../../../../src/app/firedancer/topology.c#L178>)

Parses a peer address string to extract and resolve the hostname and port, storing the results in an `fd_ip4_port_t` structure.
- **Inputs**:
    - `peer`: A string representing the peer address in the format 'host:port', optionally prefixed with 'http://' or 'https://'.
    - `ip4_port`: A pointer to an `fd_ip4_port_t` structure where the resolved IP address and port will be stored.
- **Logic and Control Flow**:
    - Checks if the `peer` string starts with 'http://' or 'https://', and adjusts the pointer to skip the prefix if present.
    - Finds the last colon in the `peer` string to separate the hostname from the port.
    - Validates the presence of a colon and the length of the hostname, logging an error if invalid.
    - Copies the hostname into a buffer and null-terminates it.
    - Parses the port number from the string following the colon, validating its range and format, and stores it in the `ip4_port` structure after byte-swapping.
    - Calls [`resolve_address`](<#resolve_address>) to resolve the hostname to an IP address and stores the result in the `ip4_port` structure.
    - Returns the result of the [`resolve_address`](<#resolve_address>) function, indicating success or failure.
- **Output**: Returns an integer indicating whether the hostname was successfully resolved (non-zero) or not (zero).
- **Functions Called**:
    - [`resolve_address`](<#resolve_address>)


---
### resolve\_gossip\_entrypoints<!-- {{#callable:resolve_gossip_entrypoints}} -->
[View Source →](<../../../../../src/app/firedancer/topology.c#L218>)

Resolves the IP addresses and ports for each gossip entrypoint in the configuration.
- **Inputs**:
    - ``config``: A pointer to a `config_t` structure containing the gossip entrypoints and resolved entrypoints arrays.
- **Logic and Control Flow**:
    - Retrieve the count of gossip entrypoints from `config->gossip.entrypoints_cnt`.
    - Iterate over each entrypoint using a loop from 0 to `entrypoint_cnt`.
    - For each entrypoint, call [`resolve_peer`](<#resolve_peer>) to resolve the IP address and port, storing the result in `config->gossip.resolved_entrypoints[i]`.
    - If [`resolve_peer`](<#resolve_peer>) returns 0 (indicating failure), log an error message and terminate the program.
- **Output**: No return value; modifies the `resolved_entrypoints` array in the `config` structure.
- **Functions Called**:
    - [`resolve_peer`](<#resolve_peer>)


---
### fd\_topo\_initialize<!-- {{#callable:fd_topo_initialize}} -->
[View Source →](<../../../../../src/app/firedancer/topology.c#L228>)

Initializes the topology configuration for a system by setting up various tiles, workspaces, and links based on the provided configuration.
- **Inputs**:
    - `config`: A pointer to a `config_t` structure containing the configuration settings for the topology.
- **Logic and Control Flow**:
    - Resolve gossip entry points using [`resolve_gossip_entrypoints`](<#resolve_gossip_entrypoints>) function.
    - Retrieve various tile counts from the configuration, such as `net_tile_cnt`, `shred_tile_cnt`, etc.
    - Determine if snapshots are enabled based on the `gossip.entrypoints_cnt`.
    - Create a new topology object using `fd_topob_new` and initialize its properties like `max_page_size` and `gigantic_page_threshold`.
    - Set up workspaces for different components using `fd_topob_wksp`.
    - Establish links between components using `fd_topob_link`, considering conditions like snapshot enablement.
    - Parse CPU affinity settings and configure CPU assignments for tiles.
    - Configure network tiles and their receive links using `fd_topos_net_tiles` and `fd_topos_net_rx_link`.
    - Set up tiles for various components using `fd_topob_tile`, considering conditions like snapshot enablement and GUI settings.
    - Configure input and output links for tiles using `fd_topob_tile_in` and `fd_topob_tile_out`.
    - Handle special cases for components like archiver, shredcap, and RPC server based on configuration flags.
    - Finalize the topology setup by configuring tiles and finishing network tile setup with [`fd_topo_configure_tile`](<#fd_topo_configure_tile>) and `fd_topos_net_tile_finish`.
- **Output**: The function does not return a value; it modifies the `config` structure to include the initialized topology.
- **Functions Called**:
    - [`resolve_gossip_entrypoints`](<#resolve_gossip_entrypoints>)
    - [`setup_topo_funk`](<#setup_topo_funk>)
    - [`setup_topo_banks`](<#setup_topo_banks>)
    - [`setup_topo_progcache`](<#setup_topo_progcache>)
    - [`setup_topo_bank_hash_cmp`](<#setup_topo_bank_hash_cmp>)
    - [`setup_topo_fec_sets`](<#setup_topo_fec_sets>)
    - [`setup_topo_store`](<#setup_topo_store>)
    - [`setup_topo_txncache`](<#setup_topo_txncache>)
    - [`fd_topo_configure_tile`](<#fd_topo_configure_tile>)


---
### fd\_topo\_configure\_tile<!-- {{#callable:fd_topo_configure_tile}} -->
[View Source →](<../../../../../src/app/firedancer/topology.c#L837>)

Configures a tile based on its name and the provided configuration settings.
- **Inputs**:
    - `tile`: A pointer to an `fd_topo_tile_t` structure representing the tile to configure.
    - `config`: A pointer to an `fd_config_t` structure containing the configuration settings.
- **Logic and Control Flow**:
    - Check the tile's name to determine the type of configuration to apply.
    - For a tile named 'metric', parse and set the Prometheus listen address and port.
    - For tiles named 'net' or 'sock', set various network-related ports from the configuration.
    - For a tile named 'ipecho', set the expected shred version, bind address, port, and entrypoints.
    - For a tile named 'genesi', set the funk object ID, download permissions, genesis path, expected shred version, entrypoints, and genesis hash.
    - For a tile named 'gossvf', set identity key path, tcache depth, shred version, and entrypoints.
    - For a tile named 'gossip', resolve the host address if specified, and set various ports and entrypoints.
    - For a tile named 'snapct', set snapshot-related paths and parameters, and resolve HTTP peers.
    - For a tile named 'snapld', set the snapshots path.
    - For a tile named 'snapin', set max live slots and object IDs for funk and txncache.
    - For a tile named 'repair', set various repair-related ports and parameters, including identity key path.
    - For a tile named 'replay', set various replay-related parameters, including object IDs and paths.
    - For a tile named 'exec', set various execution-related parameters, including object IDs and paths.
    - For a tile named 'tower', set paths for identity key, vote account, and ledger.
    - For a tile named 'send', set the send source port, IP address, and identity key path.
    - For a tile named 'quic', set various QUIC-related parameters, including ports and connection limits.
    - For a tile named 'verify', set the tcache depth for signature verification.
    - For a tile named 'dedup', set the tcache depth for deduplication.
    - For a tile named 'resolv', set the funk object ID.
    - For a tile named 'pack', set various packing-related parameters, including bundle settings if enabled.
    - For a tile named 'bank', set object IDs for txncache, funk, and progcache, and max live slots.
    - For a tile named 'poh', set identity key path, bank count, and bundle settings if enabled.
    - For a tile named 'shred', set identity key path, depth, expected shred version, and additional destinations.
    - For a tile named 'sign', set the identity key path.
    - For a tile named 'gui', parse and set the GUI listen address and various GUI-related parameters.
    - For a tile named 'arch_f' or 'arch_w', set the rocksdb path.
    - For a tile named 'backt', set the end slot, ingest mode, and validate paths based on the ingest mode.
    - For a tile named 'scap', set various shredcap-related parameters.
    - Log an error if the tile name is unknown.
- **Output**: The function does not return a value; it configures the tile in place.
- **Functions Called**:
    - [`resolve_address`](<#resolve_address>)
    - [`resolve_peer`](<#resolve_peer>)
    - [`parse_ip_port`](<#parse_ip_port>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)