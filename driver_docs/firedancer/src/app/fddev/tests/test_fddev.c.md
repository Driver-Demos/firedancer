<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for the `fddev` application, including configuration, workspace, and device readiness.

# Purpose
The code is a C source file that implements a test suite for a system involving configuration, workspace management, and device readiness. It includes several static functions that perform specific tasks such as configuring the system ([`fddev_configure`](<#fddev_configure>)), managing workspaces ([`fddev_wksp`](<#fddev_wksp>)), and preparing the system for readiness ([`fddev_ready`](<#fddev_ready>)). These functions are executed as child processes using the [`fork_child`](<#fork_child>) function, which creates a new process and sets up inter-process communication through pipes. The [`wait_children`](<#wait_children>) function is used to monitor these child processes and ensure they complete within specified timeouts.

The [`fddev_test_run`](<#fddev_test_run>) function serves as the entry point for running the test suite. It initializes the system configuration, sets up logging, and manages the execution of the test functions. The [`main`](<#main>) function calls [`fddev_test_run`](<#fddev_test_run>), passing command-line arguments and the [`test_fddev`](<#test_fddev>) function, which orchestrates the execution of the various test components. The code includes error handling and logging to track the execution flow and report issues. The file is intended to be compiled and executed as a standalone program, as indicated by the presence of the [`main`](<#main>) function.
# Imports and Dependencies

---
- `../main.h`
- `../../fdctl/config.h`
- `../../fdctl/topology.h`
- `../../platform/fd_sys_util.h`
- `../../shared/fd_config_file.h`
- `../../shared/commands/ready.h`
- `../../shared_dev/boot/fd_dev_boot.h`
- `../../shared_dev/commands/wksp.h`
- `../../shared_dev/commands/dev.h`
- `errno.h`
- `unistd.h`
- `poll.h`
- `fcntl.h`
- `sched.h`
- `sys/wait.h`
- `sys/mman.h`


# Data Structures

---
### child\_info
- **Type**: ``struct``
- **Members**:
    - `name`: Pointer to a constant character string representing the name of the child process.
    - `pipefd`: File descriptor for the pipe used for inter-process communication.
    - `pid`: Process ID of the child process.
- **Description**: Holds information about a child process, including its name, the file descriptor for communication, and its process ID, facilitating process management and communication in a multi-process environment.


# Functions

---
### fddev\_configure<!-- {{#callable:fddev_configure}} -->
[View Source →](<../../../../../../src/app/fddev/tests/test_fddev.c#L27>)

Configures the system by initializing command arguments, filtering out the 'kill' stage, checking permissions, and executing configuration commands.
- **Inputs**:
    - ``config``: A pointer to a `config_t` structure that holds configuration data.
    - ``pipefd``: An integer representing a file descriptor for a pipe, which is not used in this function.
- **Logic and Control Flow**:
    - Set the log thread name to 'configure'.
    - Initialize an `args_t` structure with the command set to `CONFIGURE_CMD_INIT` and stages set to zero.
    - Iterate over the `STAGES` array, skipping any stage named 'kill', and populate `args.configure.stages` with the remaining stages.
    - Create a new capability check object using `fd_cap_chk_new` and join it with `fd_cap_chk_join`.
    - Call `configure_cmd_perm` to check permissions using the `args` and `chk` objects.
    - Verify that there are no errors in the capability check using `FD_TEST`.
    - Execute the configuration command with `configure_cmd_fn` using the `args` and `config` objects.
    - Return 0 to indicate successful execution.
- **Output**: Returns 0 to indicate successful configuration.


---
### fddev\_wksp<!-- {{#callable:fddev_wksp}} -->
[View Source →](<../../../../../../src/app/fddev/tests/test_fddev.c#L53>)

Initializes and verifies permissions for workspace creation, then executes the workspace command.
- **Inputs**:
    - `config`: A pointer to a `config_t` structure that contains configuration data for the workspace operation.
    - `pipefd`: An integer representing a file descriptor for a pipe, which is not used in this function.
- **Logic and Control Flow**:
    - Sets the log thread name to 'wksp'.
    - Initializes an `args_t` structure to zero.
    - Allocates and joins a new capability check structure `fd_cap_chk_t` using `fd_cap_chk_new` and `fd_cap_chk_join`.
    - Calls `wksp_cmd_perm` to check permissions for workspace operations using the `args` and `chk` structures and the provided `config`.
    - Retrieves the error count from the capability check structure using `fd_cap_chk_err_cnt`.
    - If there are errors, logs each error using `FD_LOG_WARNING` and logs a fatal error using `FD_LOG_ERR` indicating insufficient permissions.
    - Calls `wksp_cmd_fn` to execute the workspace command with the `args` and `config`.
    - Returns 0 to indicate successful execution.
- **Output**: Returns 0 to indicate successful execution.


---
### fddev\_ready<!-- {{#callable:fddev_ready}} -->
[View Source →](<../../../../../../src/app/fddev/tests/test_fddev.c#L71>)

Sets the log thread to 'ready' and executes the `ready_cmd_fn` function with initialized arguments.
- **Inputs**:
    - ``config``: A pointer to a `config_t` structure that contains configuration data.
    - ``pipefd``: An integer representing a file descriptor for a pipe, which is not used in this function.
- **Logic and Control Flow**:
    - Sets the log thread name to 'ready' using `fd_log_thread_set`.
    - Initializes an `args_t` structure named `args` with zero values.
    - Calls the `ready_cmd_fn` function, passing the address of `args` and the `config` pointer as arguments.
    - Returns 0 to indicate successful execution.
- **Output**: Returns an integer value of 0, indicating successful execution.


---
### fddev\_dev<!-- {{#callable:fddev_dev}} -->
[View Source →](<../../../../../../src/app/fddev/tests/test_fddev.c#L85>)

Initializes and executes the development command sequence with specific configurations and permissions.
- **Inputs**:
    - `config`: A pointer to a `config_t` structure that holds configuration data.
    - `pipefd`: An integer representing the file descriptor for the pipe used for inter-process communication.
- **Logic and Control Flow**:
    - Sets the log thread name to 'dev'.
    - Initializes an `args_t` structure with specific development command parameters, including disabling configuration, initialization of workspaces, and watching, while enabling Agave.
    - Sets the `debug_tile` field of `args` to an empty string.
    - Allocates and joins a capability check structure `chk` using `fd_cap_chk_join` and `fd_cap_chk_new`.
    - Calls `dev_cmd_perm` to check permissions for the development command using `args`, `chk`, and `config`.
    - Asserts that there are no errors in the capability check using `FD_TEST`.
    - Logs a warning message with the process ID obtained from `fd_sandbox_getpid`.
    - Calls `dev_cmd_fn` to execute the development command function with `args`, `config`, and `spawn_agave`.
    - Returns 0 to indicate successful execution.
- **Output**: Returns 0 to indicate successful execution.


---
### fork\_child<!-- {{#callable:fork_child}} -->
[View Source →](<../../../../../../src/app/fddev/tests/test_fddev.c#L106>)

Creates a child process using `fork`, sets up a pipe for communication, and executes a specified child function in the child process.
- **Inputs**:
    - `name`: A constant character pointer representing the name of the child process.
    - `config`: A pointer to a `config_t` structure that holds configuration data for the child process.
    - `child`: A function pointer to the child function that takes a `config_t` pointer and an integer pipe file descriptor as arguments.
- **Logic and Control Flow**:
    - Initialize a pipe with two file descriptors in `pipefd` array.
    - Check if the pipe creation fails and log an error if it does.
    - Call `fork` to create a child process and check for errors in the fork operation.
    - In the child process (when `pid` is 0), close the read end of the pipe (`pipefd[0]`).
    - Execute the `child` function with `config` and the write end of the pipe (`pipefd[1]`) as arguments.
    - Exit the child process with the result of the `child` function using `fd_sys_util_exit_group`.
    - In the parent process, close the write end of the pipe (`pipefd[1]`).
    - Return a `child_info` structure containing the name, read end of the pipe, and process ID of the child.
- **Output**: A `struct child_info` containing the name of the child process, the read end of the pipe file descriptor, and the process ID of the child.


---
### wait\_children<!-- {{#callable:wait_children}} -->
[View Source →](<../../../../../../src/app/fddev/tests/test_fddev.c#L123>)

Waits for child processes to exit and returns the index of the first exited child.
- **Inputs**:
    - ``children``: An array of `struct child_info` representing the child processes to monitor.
    - ``children_cnt``: The number of child processes in the `children` array.
    - ``timeout_seconds``: The maximum time in seconds to wait for a child process to exit.
- **Logic and Control Flow**:
    - Initialize an array of `struct pollfd` to monitor the file descriptors of the child processes.
    - Use `poll` to wait for any of the child processes to exit or for the timeout to occur.
    - If `poll` returns an error, log the error and terminate the program.
    - If `poll` times out, log a timeout error and terminate the program.
    - Iterate through the `pollfd` array to find the first child process that has exited, indicated by the `POLLHUP` event.
    - Use `waitpid` to get the exit status of the exited child process.
    - If `waitpid` returns an error, log the error and terminate the program.
    - Check the exit status of the child process and log an error if it did not exit normally or if it exited with a non-zero status.
    - Close the file descriptor of the exited child process.
    - Return the index of the exited child process.
- **Output**: The index of the first child process that exited.


---
### init\_log\_memfd<!-- {{#callable:init_log_memfd}} -->
[View Source →](<../../../../../../src/app/fddev/tests/test_fddev.c#L157>)

Creates a memory file descriptor and sets its size to 4096 bytes.
- **Inputs**: None
- **Logic and Control Flow**:
    - Call `memfd_create` to create a memory file descriptor named 'fd_log_lock_page'.
    - Check if `memfd_create` returns -1, indicating an error, and log the error if it occurs.
    - Call `ftruncate` to set the size of the memory file descriptor to 4096 bytes.
    - Check if `ftruncate` returns -1, indicating an error, and log the error if it occurs.
    - Return the memory file descriptor.
- **Output**: An integer representing the memory file descriptor, or logs an error if creation or truncation fails.


---
### fddev\_test\_run<!-- {{#callable:fddev_test_run}} -->
[View Source →](<../../../../../../src/app/fddev/tests/test_fddev.c#L165>)

Executes a test run with a specified configuration and handles process management based on command-line arguments.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
    - `run`: A function pointer to execute with the loaded configuration.
- **Logic and Control Flow**:
    - Checks if the run is a base run by evaluating the number of arguments and specific argument values.
    - If it is a base run, attempts to unshare the PID namespace using `unshare(CLONE_NEWPID)` and logs an error if it fails.
    - Forks a new process and logs an error if the fork fails.
    - In the child process, initializes the system with `fd_boot`, sets the log thread name, loads the configuration, initializes the topology, and calls the `run` function with the configuration.
    - In the parent process, waits for the child process to exit using `waitpid` and logs errors if `waitpid` fails or if the child process does not exit properly.
    - If the run is not a base run, sets up a default configuration and calls `fd_dev_main` with the provided arguments and configuration.
- **Output**: Returns the exit status of the `run` function or `fd_dev_main`, or an error code if process management fails.
- **Functions Called**:
    - [`init_log_memfd`](<#init_log_memfd>)


---
### test\_fddev<!-- {{#callable:test_fddev}} -->
[View Source →](<../../../../../../src/app/fddev/tests/test_fddev.c#L219>)

Executes a series of child processes to configure, initialize workspaces, and prepare the development environment, ensuring each step completes successfully.
- **Inputs**:
    - ``config``: A pointer to a `config_t` structure that contains configuration data for the child processes.
- **Logic and Control Flow**:
    - Forks a child process named 'fddev configure' using [`fork_child`](<#fork_child>) and waits for it to complete with a timeout of 15 seconds using [`wait_children`](<#wait_children>).
    - Forks a child process named 'fddev wksp' and waits for it to complete with a timeout of 60 seconds.
    - Forks two child processes named 'fddev dev' and 'fddev ready'.
    - Waits for both 'fddev dev' and 'fddev ready' processes to complete with a timeout of 30 seconds.
    - Checks if any of the 'fddev dev' or 'fddev ready' processes exited unexpectedly and logs an error if so.
- **Output**: Returns 0 upon successful execution of all child processes.
- **Functions Called**:
    - [`fork_child`](<#fork_child>)
    - [`wait_children`](<#wait_children>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../../src/app/fddev/tests/test_fddev.c#L235>)

Executes the [`fddev_test_run`](<#fddev_test_run>) function with command-line arguments and a test function.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of strings representing the command-line arguments.
- **Logic and Control Flow**:
    - Calls the [`fddev_test_run`](<#fddev_test_run>) function with `argc`, `argv`, and `test_fddev` as arguments.
    - Returns the result of the [`fddev_test_run`](<#fddev_test_run>) function.
- **Output**: The return value of the [`fddev_test_run`](<#fddev_test_run>) function, which is an integer.
- **Functions Called**:
    - [`fddev_test_run`](<#fddev_test_run>)


# Function Declarations (Public API)

---
### spawn\_agave<!-- {{#callable_declaration:spawn_agave}} -->
[View Source →](<../../../../../../src/app/fddev/tests/test_fddev.c#L82>)

Creates a new thread to run the Agave main function.
- **Description**: Use this function to start a new thread that executes the Agave main function. This function requires a valid configuration object and will log an error if thread creation or naming fails. Ensure that the configuration object is properly initialized before calling this function. The function does not return any value and does not modify the input configuration.
- **Inputs**:
    - `config`: A pointer to a constant `config_t` structure. This must be a valid and initialized configuration object. The caller retains ownership and must ensure it remains valid for the duration of the thread's execution.
- **Output**: None
- **See Also**: [`spawn_agave`](<../commands/dev.c.md#spawn_agave>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)