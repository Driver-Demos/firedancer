<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements blockstore configuration, including initialization, finalization, and validation functions.

# Purpose
The code is a C module that manages the initialization, finalization, and verification of a blockstore for a ledger system. It is part of a larger system that involves creating and managing a "block 0" in a blockstore, which is necessary for the Agave validator to boot. The module includes functions to initialize the blockstore by creating a directory structure and generating the necessary data shreds using a process that involves computing a shred version and appending hashes. The [`init`](<#init>) function handles the creation of the blockstore, while the [`fini`](<#fini>) function cleans up the ledger directory by removing non-essential files and directories. The [`check`](<#check>) function verifies the existence and configuration of the blockstore directory.

The module defines a `configure_stage_t` structure named `fd_cfg_stage_blockstore`, which includes function pointers to the [`init`](<#init>), [`fini`](<#fini>), and [`check`](<#check>) functions. This structure is used to manage the lifecycle of the blockstore configuration stage. The code also includes external dependencies and utility functions for file and system operations, such as `fd_sys_util_exit_group` and `fd_file_util_rmtree`. The module is designed to be part of a larger system, as indicated by the inclusion of headers from various directories and the use of external functions like [`fd_ext_blockstore_create_block0`](<#fd_ext_blockstore_create_block0>).
# Imports and Dependencies

---
- `../../../shared/commands/configure/configure.h`
- `../../../platform/fd_sys_util.h`
- `../../../platform/fd_file_util.h`
- `../../../../ballet/shred/fd_shred.h`
- `../../../../ballet/poh/fd_poh.h`
- `../../../../disco/shred/fd_shredder.h`
- `../../../../disco/tiles.h`
- `../../../../discof/genesis/genesis_hash.h`
- `unistd.h`
- `dirent.h`
- `sys/stat.h`
- `sys/wait.h`


# Global Variables

---
### fd\_cfg\_stage\_blockstore
- **Type**: ``configure_stage_t``
- **Description**: Defines a configuration stage for managing the blockstore component in the system. It includes the stage name, a flag to always recreate the stage, and function pointers for initialization, finalization, and checking the configuration state.
- **Use**: Used to manage the lifecycle and configuration of the blockstore component, ensuring it is correctly initialized, finalized, and checked.


# Functions

---
### zero\_signer<!-- {{#callable:zero_signer}} -->
[View Source →](<../../../../../../../src/app/fddev/commands/configure/blockstore.c#L27>)

Sets the first 64 bytes of the `sig` array to zero.
- **Inputs**:
    - `_1`: A void pointer that is not used in the function.
    - `sig`: A pointer to an unsigned character array where the first 64 bytes will be set to zero.
    - `_2`: A constant unsigned character pointer that is not used in the function.
- **Logic and Control Flow**:
    - Ignore the `_1` and `_2` parameters by casting them to void.
    - Use the `memset` function to set the first 64 bytes of the `sig` array to zero.
- **Output**: No return value; the function modifies the `sig` array in place.


---
### init<!-- {{#callable:init}} -->
[View Source →](<../../../../../../../src/app/fddev/commands/configure/blockstore.c#L29>)

Initializes the blockstore by creating a genesis block and setting up the necessary environment for the Agave validator to boot.
- **Inputs**:
    - `config`: A pointer to a `config_t` structure containing configuration details such as paths and genesis parameters.
- **Logic and Control Flow**:
    - Retrieve `ticks_per_slot` and `hashes_per_tick` from the `config` structure.
    - Construct the path to the `genesis.bin` file and compute the shred version using `compute_shred_version`.
    - Check if `ticks_per_slot` is less than `GENESIS_MAX_TICKS_PER_SLOT` and initialize a batch structure with tick data.
    - Iterate over each tick, appending hashes and setting up the batch structure with hash and transaction count data.
    - Calculate the batch size and verify the number of data and parity shreds using `fd_shredder_count_data_shreds` and `fd_shredder_count_parity_shreds`.
    - Initialize `fd_shredder_t` and set the shred version, then prepare the batch and FEC set for shredding.
    - Fork a new process to handle the creation of the blockstore, switching user permissions as necessary.
    - In the child process, create the blockstore using `fd_ext_blockstore_create_block0` and exit the process.
    - In the parent process, wait for the child process to complete and check for errors or abnormal termination.
- **Output**: No return value; the function performs initialization tasks and may log errors or terminate the process if failures occur.


---
### fini<!-- {{#callable:fini}} -->
[View Source →](<../../../../../../../src/app/fddev/commands/configure/blockstore.c#L135>)

Cleans up the ledger directory by removing all files and directories except for 'genesis.bin'.
- **Inputs**:
    - ``config``: A pointer to a `config_t` structure that contains configuration data, including the path to the ledger directory.
    - ``pre_init``: An integer parameter that is not used in this function.
- **Logic and Control Flow**:
    - Open the directory specified by `config->paths.ledger` using `opendir`.
    - If the directory cannot be opened and the error is `ENOENT`, return 0.
    - Log an error and exit if `opendir` fails for reasons other than `ENOENT`.
    - Iterate over each entry in the directory using `readdir`.
    - Skip entries named '.' and '..'.
    - Skip the entry named 'genesis.bin'.
    - For each remaining entry, construct the full path using `fd_cstr_printf_check`.
    - Use `lstat` to get the status of the entry; continue if the entry does not exist (`ENOENT`).
    - Log an error and exit if `lstat` fails for reasons other than `ENOENT`.
    - If the entry is a directory, remove it using `fd_file_util_rmtree`; log an error and exit if this fails.
    - If the entry is a file, remove it using `unlink`; log an error and exit if this fails and the error is not `ENOENT`.
    - Log an error and exit if `readdir` fails for reasons other than `ENOENT`.
    - Close the directory using `closedir`; log an error and exit if this fails.
    - Return 1 to indicate successful completion.
- **Output**: Returns 1 if the cleanup is successful, or 0 if the directory does not exist.


---
### check<!-- {{#callable:check}} -->
[View Source →](<../../../../../../../src/app/fddev/commands/configure/blockstore.c#L175>)

Checks the existence and configuration of the ledger directory and its contents, specifically looking for the 'rocksdb' directory.
- **Inputs**:
    - `config`: A pointer to a `config_t` structure containing configuration details, including the path to the ledger directory.
- **Logic and Control Flow**:
    - Initialize `has_non_genesis` to 0 to track if non-genesis files are found.
    - Attempt to open the directory specified by `config->paths.ledger`.
    - If the directory cannot be opened and does not exist, log an error indicating the ledger directory is not configured.
    - Iterate over the directory entries using `readdir`.
    - Skip entries named '.' and '..'.
    - If an entry named 'genesis.bin' is found, skip it as it is managed by the genesis stage.
    - If an entry named 'rocksdb' is found, construct its path and check its directory configuration using `check_dir`.
    - If `check_dir` does not return `CONFIGURE_OK`, close the directory and return the result.
    - Set `has_non_genesis` to 1 if any non-genesis entries are found and break the loop.
    - After the loop, check for errors from `readdir` and log if any occurred.
    - Close the directory and log if closing fails.
    - If `has_non_genesis` is true, log that the 'rocksdb' directory exists and is partially configured; otherwise, log that it does not exist and is not configured.
- **Output**: Returns a `configure_result_t` indicating the configuration status of the ledger directory.



---
Made with ❤️ by [Driver](https://www.driver.ai/)