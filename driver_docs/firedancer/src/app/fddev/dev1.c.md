<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines and implements the `dev1` command for configuring and running a single tile in Firedancer.

# Purpose
The code defines a command-line utility for managing and executing tasks related to a specific component called a "tile" within a larger system. It includes functions to parse command-line arguments, configure the environment, and execute tasks associated with a tile. The utility is designed to handle signals such as `SIGTERM` and `SIGINT` to ensure proper termination and logging. The [`dev1_cmd_args`](<#dev1_cmd_args>) function processes command-line arguments, while [`dev1_cmd_fn`](<#dev1_cmd_fn>) executes the main functionality, including configuration updates and task execution. The [`install_parent_signals`](<#install_parent_signals>) function sets up signal handlers to manage termination signals.

The code also defines an `action_t` structure named `fd_action_dev1`, which encapsulates the command's name, argument processing function, execution function, permission function, and a description. This structure is likely used to register the command within a larger framework. The utility interacts with external components through function calls and shared data structures, such as `fd_topo_run_tile_t` and `fd_config_t`, to manage the execution of tasks on specific tiles. The code is part of a broader system, as indicated by the inclusion of headers from different directories, suggesting modularity and separation of concerns.
# Imports and Dependencies

---
- `../platform/fd_sys_util.h`
- `../shared/commands/configure/configure.h`
- `../shared/commands/run/run.h`
- `../shared_dev/commands/dev.h`
- `errno.h`
- `stdio.h`
- `unistd.h`
- `sched.h`
- `sys/wait.h`


# Global Variables

---
### TILES
- **Type**: `fd_topo_run_tile_t *`
- **Description**: `TILES` is an array of pointers to `fd_topo_run_tile_t` structures. Each element in the array represents a tile runner in the system topology.
- **Use**: Used to iterate over and find specific tile runners by name in the system topology.


---
### fd\_log\_private\_path
- **Type**: `char`
- **Description**: `fd_log_private_path` is a global character array with a size of 1024, initialized as an empty string at the start.
- **Use**: Stores the file path for logging purposes, which is used in error logging functions.


---
### fd\_log\_private\_shared\_lock
- **Type**: `int *`
- **Description**: A pointer to an integer that is used as a shared lock for logging operations.
- **Use**: Used to synchronize access to logging resources, particularly in signal handling.


---
### fd\_action\_dev1
- **Type**: ``action_t``
- **Description**: Defines an action structure for the 'dev1' command, which includes the command name, argument processing function, execution function, permission function, and a description of the action.
- **Use**: Used to configure and execute the 'dev1' command, which starts up a single tile in the system.


# Functions

---
### parent\_signal<!-- {{#callable:parent_signal}} -->
[View Source →](<../../../../../src/app/fddev/dev1.c#L27>)

Handles a signal by logging the event and exiting the process with a specific status code.
- **Inputs**:
    - `sig`: The signal number received by the process.
- **Logic and Control Flow**:
    - Initialize a local variable `lock` to 0 and assign its address to `fd_log_private_shared_lock`.
    - Check if the log file descriptor is valid using `fd_log_private_logfile_fd()`.
    - If valid, log the received signal and the log file path using `FD_LOG_ERR_NOEXIT`.
    - If not valid, log only the received signal using `FD_LOG_ERR_NOEXIT`.
    - If the signal is `SIGINT`, call `fd_sys_util_exit_group` with the exit code `128 + SIGINT`.
    - For other signals, call `fd_sys_util_exit_group` with the exit code `0`.
- **Output**: No return value; the function logs the signal and exits the process.


---
### install\_parent\_signals<!-- {{#callable:install_parent_signals}} -->
[View Source →](<../../../../../src/app/fddev/dev1.c#L40>)

Sets up signal handlers for `SIGTERM` and `SIGINT` to use the `parent_signal` function.
- **Inputs**: None
- **Logic and Control Flow**:
    - Declare and initialize a `sigaction` structure `sa` with `sa_handler` set to `parent_signal` and `sa_flags` set to 0.
    - Call `sigaction` to associate the `SIGTERM` signal with the `sa` structure; if it fails, log an error using `FD_LOG_ERR`.
    - Call `sigaction` to associate the `SIGINT` signal with the `sa` structure; if it fails, log an error using `FD_LOG_ERR`.
- **Output**: No return value; the function sets up signal handlers.


---
### dev1\_cmd\_args<!-- {{#callable:dev1_cmd_args}} -->
[View Source →](<../../../../../src/app/fddev/dev1.c#L52>)

Parses command-line arguments for the 'dev1' command and updates the 'args' structure accordingly.
- **Inputs**:
    - `pargc`: A pointer to an integer representing the count of command-line arguments.
    - `pargv`: A pointer to an array of strings representing the command-line arguments.
    - `args`: A pointer to an 'args_t' structure where parsed arguments will be stored.
- **Logic and Control Flow**:
    - Check if the number of arguments pointed by 'pargc' is less than 1; if true, log an error with usage information and terminate.
    - Copy the first argument from 'pargv' into 'args->dev1.tile_name', ensuring it does not exceed the buffer size.
    - Decrement the argument count pointed by 'pargc' and advance the argument pointer 'pargv' to the next argument.
    - Check if the '--no-configure' option is present in the command-line arguments using 'fd_env_strip_cmdline_contains' and store the result in 'args->dev1.no_configure'.
- **Output**: No direct output; modifies the 'args' structure and updates 'pargc' and 'pargv'.


---
### dev1\_cmd\_perm<!-- {{#callable:dev1_cmd_perm}} -->
[View Source →](<../../../../../src/app/fddev/dev1.c#L67>)

Calls the `dev_cmd_perm` function with the provided arguments.
- **Inputs**:
    - `args`: A pointer to an `args_t` structure containing command arguments.
    - `chk`: A pointer to an `fd_cap_chk_t` structure for capability checking.
    - `config`: A pointer to a constant `config_t` structure containing configuration data.
- **Logic and Control Flow**:
    - Calls the `dev_cmd_perm` function with `args`, `chk`, and `config` as arguments.
- **Output**: No output is returned as the function has a `void` return type.


---
### dev1\_cmd\_fn<!-- {{#callable:dev1_cmd_fn}} -->
[View Source →](<../../../../../src/app/fddev/dev1.c#L74>)

Executes the command for a specific tile, handling configuration, signal installation, and process execution.
- **Inputs**:
    - `args`: A pointer to an `args_t` structure containing command arguments, including the tile name and configuration flags.
    - `config`: A pointer to a `config_t` structure containing configuration details for the operation.
- **Logic and Control Flow**:
    - Check if configuration is needed by evaluating `args->dev1.no_configure`; if not, initialize and execute configuration commands.
    - Call [`update_config_for_dev`](<../shared_dev/commands/dev.c.md#update_config_for_dev>) to update the configuration for the device.
    - Run `run_firedancer_init` to initialize the Firedancer environment with the given configuration.
    - Install signal handlers for `SIGTERM` and `SIGINT` using [`install_parent_signals`](<#install_parent_signals>).
    - Close file descriptors 0, 1, and the log lock file descriptor, logging errors if any close operation fails.
    - Determine the tile to execute by comparing `args->dev1.tile_name` with "agave"; if it matches, call [`agave_main`](<../fdctl/commands/run_agave.c.md#agave_main>).
    - If the tile name is not "agave", find the tile ID using `fd_topo_find_tile`; log an error if the tile is not found.
    - Retrieve the tile and runner information from the configuration and `TILES` array.
    - Execute the tile using `fd_topo_run_tile` with the retrieved runner and configuration settings.
    - Exit the process group with the result of the tile execution using `fd_sys_util_exit_group`.
- **Output**: No direct output is returned; the function performs operations and exits the process group with a status code.
- **Functions Called**:
    - [`update_config_for_dev`](<../shared_dev/commands/dev.c.md#update_config_for_dev>)
    - [`install_parent_signals`](<#install_parent_signals>)
    - [`agave_main`](<../fdctl/commands/run_agave.c.md#agave_main>)


# Function Declarations (Public API)

---
### update\_config\_for\_dev<!-- {{#callable_declaration:update_config_for_dev}} -->
[View Source →](<../../../../../src/app/fddev/dev1.c#L15>)

Updates the configuration for development.
- **Description**: Use this function to update the configuration structure for development purposes. It computes the shred version from a genesis file if available and updates the expected shred version for shred and store tiles in the topology. This function should be called when the configuration needs to be prepared for a development environment, ensuring that all relevant tiles have the correct shred version set. It assumes that the configuration structure is properly initialized and that the paths and topology are correctly set up.
- **Inputs**:
    - `config`: A pointer to an `fd_config_t` structure that contains the configuration to update. The structure must be initialized and must not be null. The function will modify the `expected_shred_version` fields within the topology's shred and store tiles.
- **Output**: None
- **See Also**: [`update_config_for_dev`](<../shared_dev/commands/dev.c.md#update_config_for_dev>)  (Implementation)


---
### agave\_main<!-- {{#callable_declaration:agave_main}} -->
[View Source →](<../../../../../src/app/fddev/dev1.c#L18>)

Executes the main function for the agave tile.
- **Description**: Use this function to start the main execution process for the agave tile. It must be called with a valid configuration object that contains necessary settings for the tile's operation. This function handles debugging conditions, initializes memory spaces, and switches user and group IDs as specified in the configuration. It is important to ensure that the configuration object is correctly set up before calling this function to avoid unexpected behavior.
- **Inputs**:
    - `args`: A pointer to a `config_t` structure that contains configuration settings for the agave tile. The pointer must not be null, and the structure must be properly initialized with valid data before calling this function.
- **Output**: Returns 0 upon successful execution. The function does not modify the input configuration object.
- **See Also**: [`agave_main`](<../fdctl/commands/run_agave.c.md#agave_main>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)