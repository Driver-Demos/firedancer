<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a command to print current validator Prometheus metrics to STDOUT using HTTP server.

# Purpose
The code defines a module that is part of a larger system for handling metrics related to a validator, specifically using Prometheus metrics. It includes functionality to parse command-line arguments, reconstruct a topology based on a given name, and set up an HTTP server to render and output these metrics. The module imports several headers, indicating dependencies on configuration management, action handling, Prometheus metrics, and HTTP server functionalities.

The key components of the code include the [`metrics_cmd_args`](<#metrics_cmd_args>) function, which processes command-line arguments to extract a topology name, and the [`reconstruct_topo`](<#reconstruct_topo>) function, which identifies and reconstructs the specified topology. The [`metrics_cmd_fn`](<#metrics_cmd_fn>) function sets up an HTTP server with specific parameters and uses it to render Prometheus metrics, which are then written to the standard output. The `fd_action_metrics` structure defines an action named "metrics," specifying its arguments, function, and description, indicating that it is a diagnostic action intended to print Prometheus metrics. This module is likely intended to be part of a larger application where it can be invoked to provide metrics data for monitoring and diagnostic purposes.
# Imports and Dependencies

---
- `../fd_config.h`
- `../fd_action.h`
- `../../../disco/metrics/fd_prometheus.h`
- `../../../waltz/http/fd_http_server_private.h`
- `unistd.h`
- `errno.h`
- `stdlib.h`


# Global Variables

---
### ACTIONS
- **Type**: ``action_t *` array`
- **Description**: An array of pointers to `action_t` structures, where each element represents a specific action that can be performed. Each `action_t` structure contains information such as the action's name, function pointers for argument processing and execution, permissions, and other metadata.
- **Use**: Used to iterate over available actions and select the appropriate one based on a given name.


---
### fd\_action\_metrics
- **Type**: ``action_t``
- **Description**: Defines an action for printing Prometheus metrics to standard output. It includes the action's name, argument processing function, execution function, and a description of its purpose.
- **Use**: Used to configure and execute the action that outputs Prometheus metrics.


# Functions

---
### metrics\_cmd\_args<!-- {{#callable:metrics_cmd_args}} -->
[View Source →](<../../../../../../src/app/shared/commands/metrics.c#L13>)

Parses command-line arguments to extract and validate the '--topo' option, storing it in the 'args' structure.
- **Inputs**:
    - `pargc`: A pointer to the argument count, which can be modified by the function.
    - `pargv`: A pointer to the argument vector, which can be modified by the function.
    - `args`: A pointer to an 'args_t' structure where the parsed '--topo' option will be stored.
- **Logic and Control Flow**:
    - Call `fd_env_strip_cmdline_cstr` to extract the '--topo' command-line argument from `pargc` and `pargv`, defaulting to an empty string if not found.
    - Calculate the length of the extracted 'topo_name'.
    - Check if the length of 'topo_name' exceeds the size limit of 'args->metrics.topo'.
    - If the length exceeds the limit, log an error and terminate the program using `FD_LOG_ERR`.
    - Initialize 'args->metrics.topo' with `fd_cstr_init`, append 'topo_name' to it using `fd_cstr_append_text`, and finalize the string with `fd_cstr_fini`.
- **Output**: No return value; modifies the 'args' structure and may terminate the program on error.


---
### reconstruct\_topo<!-- {{#callable:reconstruct_topo}} -->
[View Source →](<../../../../../../src/app/shared/commands/metrics.c#L24>)

Selects and executes a topology action based on the given topology name.
- **Inputs**:
    - `config`: A pointer to a `config_t` structure that holds configuration data.
    - `topo_name`: A constant character pointer representing the name of the topology to be reconstructed.
- **Logic and Control Flow**:
    - Check if `topo_name` is an empty string; if so, return immediately to keep the default action topology.
    - Initialize `selected` as `NULL` to store the selected action.
    - Iterate over the `ACTIONS` array to find an action with a name matching `topo_name`.
    - If a matching action is found, assign it to `selected` and break the loop.
    - If no matching action is found, log an error indicating an unknown topology name.
    - If the selected action does not have a topology function, log an error indicating the inability to recover the topology.
    - Call the topology function of the selected action with `config` as the argument.
- **Output**: No direct output; the function executes a topology function associated with the selected action.


---
### metrics\_cmd\_fn<!-- {{#callable:metrics_cmd_fn}} -->
[View Source →](<../../../../../../src/app/shared/commands/metrics.c#L44>)

Initializes and configures an HTTP server to render and output Prometheus metrics to standard output.
- **Inputs**:
    - `args`: A pointer to an `args_t` structure containing command-line arguments, specifically the topology name for metrics.
    - `config`: A pointer to a `config_t` structure that holds configuration data, including topology information.
- **Logic and Control Flow**:
    - Call [`reconstruct_topo`](<#reconstruct_topo>) to set up the topology based on the provided `args->metrics.topo`.
    - Initialize `fd_http_server_params_t` with default values, including a 256MiB outgoing buffer size.
    - Join the topology workspaces in read-only mode using `fd_topo_join_workspaces`.
    - Fill the topology data using `fd_topo_fill`.
    - Allocate memory for the HTTP server using `aligned_alloc` and check for successful allocation with `FD_TEST`.
    - Create a new HTTP server instance with `fd_http_server_new` using the allocated memory and initialized parameters.
    - Render all Prometheus metrics using `fd_prometheus_render_all` with the configured topology and HTTP server.
    - Write the rendered metrics to standard output using `fd_io_write` and handle any errors with `FD_LOG_ERR`.
- **Output**: No return value; outputs Prometheus metrics to standard output.
- **Functions Called**:
    - [`reconstruct_topo`](<#reconstruct_topo>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)