<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Utility functions for formatted printing and input handling in a monitoring application.

# Purpose
The code provides a set of utility functions for formatting and printing various types of data, such as time durations, error counts, sequence numbers, rates, and percentages. It uses a macro `PRINT` to handle formatted output to a buffer, ensuring that the output is not truncated and logging errors if formatting fails. The functions [`printf_age`](<#printf_age>), [`printf_stale`](<#printf_stale>), [`printf_heart`](<#printf_heart>), [`printf_sig`](<#printf_sig>), [`printf_err_bool`](<#printf_err_bool>), [`printf_err_cnt`](<#printf_err_cnt>), [`printf_seq`](<#printf_seq>), [`printf_rate`](<#printf_rate>), and [`printf_pct`](<#printf_pct>) are designed to format specific types of data with color-coded output based on the data's state or value. These functions are likely used for monitoring or logging purposes, providing a visual representation of data states.

Additionally, the code includes a function [`fd_getchar`](<#fd_getchar>) that reads a character from standard input without blocking. It uses the `select` system call to check if input is available and handles any errors that occur during reading. The function is designed to be non-blocking and exits the process if no input is available. The code includes several header files, indicating dependencies on external utilities and platform-specific functionalities. The use of color-coded text and error handling suggests that the code is part of a larger system for monitoring or debugging, where visual feedback and error logging are important.
# Imports and Dependencies

---
- `helper.h`
- `../../../platform/fd_sys_util.h`
- `../../../../tango/cnc/fd_cnc.h`
- `sys/time.h`
- `sys/select.h`
- `stdio.h`
- `errno.h`
- `unistd.h`


# Functions

---
### printf\_age<!-- {{#callable:printf_age}} -->
[View Source →](<../../../../../../../src/app/shared/commands/monitor/helper.c#L17>)

Formats a time duration given in nanoseconds into a human-readable string and writes it to a buffer.
- **Inputs**:
    - ``buf``: A pointer to a character buffer where the formatted string will be written.
    - ``buf_sz``: A pointer to an unsigned long representing the size of the buffer.
    - ``_dt``: A long integer representing the time duration in nanoseconds to be formatted.
- **Logic and Control Flow**:
    - Check if `_dt` is negative; if so, write 'invalid' to the buffer and return.
    - Check if `_dt` is zero; if so, write '0s' to the buffer and return.
    - Convert `_dt` to an unsigned long `rem` and calculate the remainder in nanoseconds, microseconds, milliseconds, seconds, minutes, hours, days, and weeks, updating `rem` at each step.
    - For each time unit, if `rem` becomes zero, format the time string for that unit and write it to the buffer, then return.
    - If the time duration is more than 99 weeks, format the string to show weeks and days.
- **Output**: Writes a formatted string representing the time duration to the buffer pointed to by `buf`.


---
### printf\_stale<!-- {{#callable:printf_stale}} -->
[View Source →](<../../../../../../../src/app/shared/commands/monitor/helper.c#L35>)

Formats and prints the age of an item in a buffer, highlighting it in yellow if it is stale, otherwise printing a green dash.
- **Inputs**:
    - ``buf``: A pointer to a character buffer where the formatted output will be written.
    - ``buf_sz``: A pointer to an unsigned long representing the size of the buffer.
    - ``age``: A long integer representing the age of the item.
    - ``expire``: A long integer representing the expiration threshold for the item.
- **Logic and Control Flow**:
    - Check if `age` is greater than `expire` using `FD_UNLIKELY` macro.
    - If `age` is greater than `expire`, print the text in yellow, call [`printf_age`](<#printf_age>) to format and print the age, and then reset the text color to normal.
    - If `age` is not greater than `expire`, print a green dash followed by a normal text color.
- **Output**: No return value; the function writes formatted output to the buffer pointed to by `buf`.
- **Functions Called**:
    - [`printf_age`](<#printf_age>)


---
### printf\_heart<!-- {{#callable:printf_heart}} -->
[View Source →](<../../../../../../../src/app/shared/commands/monitor/helper.c#L49>)

Formats a heartbeat status message based on the time difference between two heartbeat timestamps.
- **Inputs**:
    - ``buf``: A pointer to a character buffer where the formatted message will be written.
    - ``buf_sz``: A pointer to an unsigned long representing the size of the buffer.
    - ``hb_now``: A long integer representing the current heartbeat timestamp.
    - ``hb_then``: A long integer representing the previous heartbeat timestamp.
- **Logic and Control Flow**:
    - Calculate the time difference `dt` as `hb_now - hb_then`.
    - Use a conditional operator to determine the message to print based on the value of `dt`.
    - If `dt` is greater than 0, print a green dash ('-').
    - If `dt` is equal to 0, print 'NONE' in red.
    - If `dt` is less than 0, print 'RESET' in blue.
    - Use the `PRINT` macro to format and write the message to the buffer, updating the buffer pointer and size.
- **Output**: Writes a formatted string to the buffer indicating the heartbeat status as '    -', ' NONE', or 'RESET'.


---
### sig\_color<!-- {{#callable:sig_color}} -->
[View Source →](<../../../../../../../src/app/shared/commands/monitor/helper.c#L60>)

Maps a signal code to a corresponding text color for display purposes.
- **Inputs**:
    - `sig`: An unsigned long integer representing the signal code to be mapped to a color.
- **Logic and Control Flow**:
    - Use a switch statement to evaluate the input `sig`.
    - If `sig` is `FD_CNC_SIGNAL_BOOT`, return `TEXT_BLUE`.
    - If `sig` is `FD_CNC_SIGNAL_HALT`, return `TEXT_YELLOW`.
    - If `sig` is `FD_CNC_SIGNAL_RUN`, return `TEXT_GREEN`.
    - If `sig` is `FD_CNC_SIGNAL_FAIL`, return `TEXT_RED`.
    - If `sig` does not match any known signal, return `TEXT_NORMAL`.
- **Output**: A constant character pointer to a string representing the color associated with the signal.


---
### printf\_sig<!-- {{#callable:printf_sig}} -->
[View Source →](<../../../../../../../src/app/shared/commands/monitor/helper.c#L72>)

Formats and prints the current and previous signal states with color coding.
- **Inputs**:
    - ``buf``: A pointer to a character buffer where the formatted string will be stored.
    - ``buf_sz``: A pointer to an unsigned long representing the size of the buffer.
    - ``sig_now``: An unsigned long representing the current signal state.
    - ``sig_then``: An unsigned long representing the previous signal state.
- **Logic and Control Flow**:
    - Declare two character arrays `buf0` and `buf1` with size `FD_CNC_SIGNAL_CSTR_BUF_MAX` to hold string representations of the signals.
    - Call [`sig_color`](<#sig_color>) with `sig_now` to get the color code for the current signal.
    - Call `fd_cnc_signal_cstr` with `sig_now` and `buf0` to get the string representation of the current signal.
    - Call [`sig_color`](<#sig_color>) with `sig_then` to get the color code for the previous signal.
    - Call `fd_cnc_signal_cstr` with `sig_then` and `buf1` to get the string representation of the previous signal.
    - Use the `PRINT` macro to format and print the colored signal states into the buffer, updating the buffer pointer and size.
- **Output**: The function does not return a value but modifies the buffer pointed to by `buf` to include the formatted signal states.
- **Functions Called**:
    - [`sig_color`](<#sig_color>)


---
### printf\_err\_bool<!-- {{#callable:printf_err_bool}} -->
[View Source →](<../../../../../../../src/app/shared/commands/monitor/helper.c#L84>)

Formats and prints error status indicators for current and previous error states into a buffer.
- **Inputs**:
    - ``buf``: A pointer to a character buffer where the formatted output will be written.
    - ``buf_sz``: A pointer to an unsigned long representing the size of the buffer.
    - ``err_now``: An unsigned long indicating the current error state.
    - ``err_then``: An unsigned long indicating the previous error state.
- **Logic and Control Flow**:
    - Uses the `PRINT` macro to format the error status of `err_now` and `err_then` into the buffer.
    - Checks if `err_now` is true; if so, formats the string with red text indicating an error, otherwise uses green text indicating no error.
    - Checks if `err_then` is true; if so, formats the string with red text indicating an error, otherwise uses green text indicating no error.
    - Writes the formatted string into the buffer and updates the buffer pointer and size.
- **Output**: No direct output is returned; the function writes formatted strings into the provided buffer.


---
### printf\_err\_cnt<!-- {{#callable:printf_err_cnt}} -->
[View Source →](<../../../../../../../src/app/shared/commands/monitor/helper.c#L93>)

Formats and prints the difference between two error counts with color coding based on the change.
- **Inputs**:
    - ``buf``: A pointer to a character buffer where the formatted output will be written.
    - ``buf_sz``: A pointer to an unsigned long representing the size of the buffer.
    - ``cnt_now``: The current error count as an unsigned long.
    - ``cnt_then``: The previous error count as an unsigned long.
- **Logic and Control Flow**:
    - Calculate the difference `delta` between `cnt_now` and `cnt_then`.
    - Determine the color for the output based on the value of `delta`: green for no change, red for an increase, yellow for a decrease, and blue for a reset.
    - If `delta` is greater than 99999, print the current count with a '>+99999' indicator.
    - If `delta` is less than -99999, print the current count with a '<-99999' indicator.
    - Otherwise, print the current count and the exact `delta` value.
- **Output**: The function does not return a value; it writes formatted output to the buffer pointed to by `buf`.


---
### printf\_seq<!-- {{#callable:printf_seq}} -->
[View Source →](<../../../../../../../src/app/shared/commands/monitor/helper.c#L108>)

Formats and prints the difference between two sequence numbers with color coding based on the difference.
- **Inputs**:
    - ``buf``: A pointer to a character buffer where the formatted output will be written.
    - ``buf_sz``: A pointer to an unsigned long representing the size of the buffer.
    - ``seq_now``: The current sequence number as an unsigned long.
    - ``seq_then``: The previous sequence number as an unsigned long.
- **Logic and Control Flow**:
    - Calculate the difference `delta` between `seq_now` and `seq_then`.
    - Determine the color based on the value of `delta`: yellow for no change, green for an increase, red for a decrease, and blue for a reset.
    - If `delta` is greater than 99999, print the current sequence number with a '>+99999' suffix and the determined color.
    - If `delta` is less than -99999, print the current sequence number with a '<-99999' suffix and the determined color.
    - Otherwise, print the current sequence number with the `delta` value and the determined color.
- **Output**: Writes a formatted string to the buffer, indicating the sequence number and its change, with color coding.


---
### printf\_rate<!-- {{#callable:printf_rate}} -->
[View Source →](<../../../../../../../src/app/shared/commands/monitor/helper.c#L123>)

Calculates and prints the rate of change between two counts over a time interval, with unit scaling.
- **Inputs**:
    - ``buf``: A pointer to a buffer where the formatted output will be written.
    - ``buf_sz``: A pointer to the size of the buffer, which will be updated as data is written.
    - ``cvt``: A conversion factor to apply to the rate calculation.
    - ``overhead``: An additional overhead value to include in the rate calculation.
    - ``cnt_now``: The current count value.
    - ``cnt_then``: The previous count value.
    - ``dt``: The time interval over which the rate is calculated.
- **Logic and Control Flow**:
    - Checks if the input parameters are valid, including ensuring `cvt` and `overhead` are within valid ranges, `cnt_now` is not less than `cnt_then`, and `dt` is positive.
    - If inputs are invalid, prints 'invalid' in red text and returns.
    - Calculates the rate using the formula `cvt * (overhead + (cnt_now - cnt_then)) / dt`.
    - Checks if the calculated rate is within a valid range; if not, prints 'overflow' in red text and returns.
    - Formats and prints the rate with appropriate unit scaling (e.g., K for thousands, M for millions) until the rate exceeds 9999.9, at which point it prints '>9999.9Y'.
- **Output**: Formatted rate output is written to the buffer pointed to by `buf`, with the buffer size updated accordingly.


---
### printf\_pct<!-- {{#callable:printf_pct}} -->
[View Source →](<../../../../../../../src/app/shared/commands/monitor/helper.c#L155>)

Calculates and prints the percentage change between two sets of numbers, considering L'Hôpital's rule adjustments.
- **Inputs**:
    - ``buf``: A pointer to a character buffer where the output will be written.
    - ``buf_sz``: A pointer to the size of the buffer, which will be updated as characters are written.
    - ``num_now``: The current numerator value.
    - ``num_then``: The previous numerator value.
    - ``lhopital_num``: A double value used for L'Hôpital's rule adjustment in the numerator.
    - ``den_now``: The current denominator value.
    - ``den_then``: The previous denominator value.
    - ``lhopital_den``: A double value used for L'Hôpital's rule adjustment in the denominator.
- **Logic and Control Flow**:
    - Checks if the current numerator is less than the previous numerator, or if the current denominator is less than the previous denominator, or if the L'Hôpital's rule adjustments are out of valid range; if any condition is true, prints 'invalid' and returns.
    - Calculates the percentage change using the formula: `100 * (((double)(num_now - num_then) + lhopital_num) / ((double)(den_now - den_then) + lhopital_den))`.
    - Checks if the calculated percentage is out of valid range; if so, prints 'overflow' and returns.
    - If the percentage is less than or equal to 999.999, prints the percentage with three decimal places.
    - If the percentage is greater than 999.999, prints '>999.999'.
- **Output**: Writes the formatted percentage or error message to the buffer and updates the buffer size accordingly.


---
### fd\_getchar<!-- {{#callable:fd_getchar}} -->
[View Source →](<../../../../../../../src/app/shared/commands/monitor/helper.c#L183>)

Reads a single character from standard input if available, without blocking.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize `fd_set` structures `read_fds` and `except_fds` to monitor standard input for reading and exceptions.
    - Set a zero timeout using `struct timeval` to ensure non-blocking behavior.
    - Use `select` to check if standard input is ready for reading or has an exception, logging an error if `select` fails.
    - If standard input is ready or has an exception, attempt to read one character using `read`.
    - Log an error if `read` fails, or exit the process if `read` returns zero, indicating end-of-file.
    - Return the read character as an integer.
- **Output**: An integer representing the character read from standard input, or zero if no character is available.



---
Made with ❤️ by [Driver](https://www.driver.ai/)