<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a state machine for switching the identity of a validator, ensuring data consistency during the process.

# Purpose
The code is a C module that manages the process of switching the identity key of a validator in a distributed system. It defines a state machine to ensure the key switch occurs in a controlled manner, preventing data inconsistencies such as partially signed blocks. The module includes several states, each representing a step in the key-switching process, from unlocking the validator to pausing the leader pipeline, flushing in-flight shreds, and finally switching all components to the new key. The states are defined as macros, such as `FD_SET_IDENTITY_STATE_UNLOCKED` and `FD_SET_IDENTITY_STATE_LOCKED`, which help track the progress of the key switch.

The module provides functions to handle command-line arguments, set permissions, and execute the key-switching process. The [`set_identity_cmd_args`](<#set_identity_cmd_args>) function parses command-line arguments to configure the key switch, while [`set_identity_cmd_fn`](<#set_identity_cmd_fn>) initiates the process. The [`poll_keyswitch`](<#fd_fn_sensitivepoll_keyswitch>) function is central to the state machine, transitioning between states based on the current state and conditions. The module also includes utility functions like [`find_keyswitch`](<#find_keyswitch>) to locate key switch objects within the system topology. The `fd_action_set_identity` structure defines the action for changing the validator's identity, including its name, argument handler, function, and description.
# Imports and Dependencies

---
- `run/run.h`
- `../../platform/fd_cap_chk.h`
- `../../../disco/keyguard/fd_keyswitch.h`
- `../../../disco/keyguard/fd_keyload.h`
- `../../../tango/fd_tango.h`
- `../../../util/fd_util.h`
- `strings.h`
- `unistd.h`
- `sys/resource.h`


# Global Variables

---
### set\_identity\_cmd\_perm
- **Type**: `function`
- **Description**: The `set_identity_cmd_perm` function is responsible for setting permissions related to identity command execution. It adjusts the memory lock limit to ensure that the necessary memory can be locked for key storage.
- **Use**: Used to configure memory lock limits for identity command operations.


---
### fd\_action\_set\_identity
- **Type**: ``action_t``
- **Description**: Defines an action to change the identity of a running validator. It includes the name of the action, arguments, function to execute, configuration requirement, permissions, and a description.
- **Use**: Used to encapsulate the details and execution logic for changing the identity of a validator in the system.


# Functions

---
### find\_keyswitch<!-- {{#callable:find_keyswitch}} -->
[View Source →](<../../../../../../src/app/shared/commands/set_identity.c#L133>)

Locates and returns a pointer to the keyswitch object associated with a specified tile name in the topology.
- **Inputs**:
    - `topo`: A pointer to a constant `fd_topo_t` structure representing the topology of tiles.
    - `tile_name`: A constant character pointer representing the name of the tile to find the keyswitch for.
- **Logic and Control Flow**:
    - Call `fd_topo_find_tile` to find the index of the tile with the given `tile_name` in the `topo` structure.
    - Verify that the tile index is valid by checking it is not equal to `ULONG_MAX`.
    - Check that the `keyswitch_obj_id` of the tile at the found index is not `ULONG_MAX`.
    - Retrieve the keyswitch object address using `fd_topo_obj_laddr` with the topology and the `keyswitch_obj_id`.
    - Ensure the keyswitch object is valid by checking it is not `NULL`.
    - Return the pointer to the keyswitch object.
- **Output**: A pointer to the `fd_keyswitch_t` object associated with the specified tile name.


---
### poll\_keyswitch<!-- {{#callable:FD_FN_SENSITIVE::poll_keyswitch}} -->
[View Source →](<../../../../../../src/app/shared/commands/set_identity.c#L145>)

Manages the state transitions for switching the identity key of a validator in a controlled sequence of operations.
- **Inputs**:
    - ``topo``: A pointer to an `fd_topo_t` structure representing the topology of the system.
    - ``state``: A pointer to an `ulong` representing the current state of the identity switch process.
    - ``halted_seq``: A pointer to an `ulong` that stores the sequence number when the leader pipeline is halted.
    - ``keypair``: A pointer to an `uchar` array containing the keypair used for the identity switch.
    - ``has_error``: A pointer to an `int` that indicates if an error occurred during the process.
    - ``require_tower``: An `int` flag indicating if the tower is required for the operation.
    - ``force_lock``: An `int` flag indicating if the lock should be forced during the operation.
- **Logic and Control Flow**:
    - Checks the current `state` and performs actions based on the state value.
    - In `FD_SET_IDENTITY_STATE_UNLOCKED`, attempts to lock the validator identity for key switching.
    - In `FD_SET_IDENTITY_STATE_LOCKED`, copies the keypair to the PoH tile and requests a halt of the leader pipeline.
    - In `FD_SET_IDENTITY_STATE_POH_HALT_REQUESTED`, waits for the PoH tile to confirm the halt and updates the state accordingly.
    - In `FD_SET_IDENTITY_STATE_POH_HALTED`, flushes in-flight shreds and updates the state to request shred flushing.
    - In `FD_SET_IDENTITY_STATE_SHRED_FLUSH_REQUESTED`, waits for all shreds to be flushed and updates the state to indicate shreds are flushed.
    - In `FD_SET_IDENTITY_STATE_SHRED_FLUSHED`, requests all tiles to switch identity keys and updates the state.
    - In `FD_SET_IDENTITY_STATE_ALL_SWITCH_REQUESTED`, checks if all tiles have switched keys and updates the state to indicate all switched.
    - In `FD_SET_IDENTITY_STATE_ALL_SWITCHED`, requests to unpause the leader pipeline and updates the state.
    - In `FD_SET_IDENTITY_STATE_POH_UNHALT_REQUESTED`, waits for the PoH tile to confirm the unhalt and updates the state to unlocked.
- **Output**: No direct output; modifies the state of the identity switch process and logs information.
- **Functions Called**:
    - [`find_keyswitch`](<#find_keyswitch>)


---
### set\_identity\_cmd\_args<!-- {{#callable:set_identity_cmd_args}} -->
[View Source →](<../../../../../../src/app/shared/commands/set_identity.c#L323>)

Parses command-line arguments to configure identity settings for a validator, including loading a keypair from a file or standard input.
- **Inputs**:
    - ``pargc``: A pointer to an integer representing the count of command-line arguments.
    - ``pargv``: A pointer to an array of strings representing the command-line arguments.
    - ``args``: A pointer to an `args_t` structure where parsed arguments will be stored.
- **Logic and Control Flow**:
    - Check if the command-line contains the `--require-tower` and `--force` options, and set the corresponding fields in `args->set_identity`.
    - If the number of arguments (`*pargc`) is less than 1, log an error message and exit the function.
    - Retrieve the first argument as `path`, decrement `*pargc`, and increment `*pargv`.
    - If `path` is `"-"`, allocate protected pages for the keypair and read it from standard input.
    - Otherwise, load the keypair from the file specified by `path`.
- **Output**: No return value; modifies the `args` structure to store parsed command-line options and the loaded keypair.


---
### set\_identity<!-- {{#callable:FD_FN_SENSITIVE::set_identity}} -->
[View Source →](<../../../../../../src/app/shared/commands/set_identity.c#L350>)

Switches the identity key of a validator by verifying the key pair, joining necessary workspaces, and managing the state machine for key switching.
- **Inputs**:
    - ``args``: A pointer to an `args_t` structure containing the key pair and options for the identity switch.
    - ``config``: A pointer to a `config_t` structure containing the topology configuration for the validator.
- **Logic and Control Flow**:
    - Initialize a SHA-512 context and derive the public key from the private key in `args->set_identity.keypair`.
    - Compare the derived public key with the public key in the key pair to ensure they match; log an error and exit if they do not match.
    - Iterate over the objects in `config->topo` and join workspaces for objects named 'keyswitch'.
    - Initialize `has_error`, `state`, and `halted_seq` variables.
    - Enter a loop to call [`poll_keyswitch`](<#fd_fn_sensitivepoll_keyswitch>) with the current state and key pair until the state is `FD_SET_IDENTITY_STATE_UNLOCKED`.
    - Encode the public key part of the key pair to Base58 format and log the result.
    - Log an error if `has_error` is set, otherwise log a notice of successful identity switch.
- **Output**: No return value; logs messages indicating success or failure of the identity switch.
- **Functions Called**:
    - [`FD_FN_SENSITIVE::poll_keyswitch`](<#fd_fn_sensitivepoll_keyswitch>)


---
### set\_identity\_cmd\_fn<!-- {{#callable:set_identity_cmd_fn}} -->
[View Source →](<../../../../../../src/app/shared/commands/set_identity.c#L384>)

Calls the [`set_identity`](<#fd_fn_sensitiveset_identity>) function with the provided arguments and configuration.
- **Inputs**:
    - ``args``: A pointer to an `args_t` structure containing the arguments for the identity setting operation.
    - ``config``: A pointer to a `config_t` structure containing the configuration for the identity setting operation.
- **Logic and Control Flow**:
    - Calls the [`set_identity`](<#fd_fn_sensitiveset_identity>) function with the provided `args` and `config` parameters.
- **Output**: No return value (void function).
- **Functions Called**:
    - [`FD_FN_SENSITIVE::set_identity`](<#fd_fn_sensitiveset_identity>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)