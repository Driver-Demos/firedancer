<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Handles key management commands, including generating new keypairs and printing public keys.

# Purpose
The code is a C module that provides functionality for managing cryptographic keys. It defines commands for generating new key pairs and retrieving public keys from existing key files. The module includes functions to parse command-line arguments ([`keys_cmd_args`](<#keys_cmd_args>)), generate a key pair ([`generate_keypair`](<#fd_fn_sensitivegenerate_keypair>)), and print a public key ([`keys_pubkey`](<#keys_pubkey>)). The [`keys_cmd_fn`](<#keys_cmd_fn>) function acts as a dispatcher, executing the appropriate action based on the parsed command. The module uses system calls and cryptographic utilities to perform its operations, such as `getrandom` for generating random bytes and `fd_sha512` for hashing operations.

The module is structured to be part of a larger application, as indicated by its inclusion of configuration and action headers. It defines an `action_t` structure, `fd_action_keys`, which encapsulates the command's name, argument parsing function, execution function, and a description. This structure suggests that the module is designed to be integrated into a command-line interface or a similar framework where actions are registered and executed based on user input. The module ensures security by handling user and group IDs during file operations and explicitly clearing sensitive data from memory.
# Imports and Dependencies

---
- `../fd_config.h`
- `../fd_action.h`
- `../../platform/fd_file_util.h`
- `../../../disco/keyguard/fd_keyload.h`
- `errno.h`
- `fcntl.h`
- `unistd.h`
- `sys/stat.h`
- `sys/random.h`


# Global Variables

---
### fd\_action\_keys
- **Type**: ``action_t``
- **Description**: Defines an action structure for handling key-related commands. It includes the name of the action, the function to parse command arguments, the function to execute the command, and a description of the action.
- **Use**: Used to manage key generation and public key printing operations.


# Data Structures

---
### cmd\_type\_t
- **Type**: ``enum``
- **Members**:
    - ``CMD_NEW_KEY``: Represents a command to create a new key.
    - ``CMD_PUBKEY``: Represents a command to retrieve a public key.
- **Description**: `cmd_type_t` is an enumeration that defines command types for key operations, specifically for creating new keys and retrieving public keys. It is used to specify the action to be performed in key management functions.


# Functions

---
### keys\_cmd\_args<!-- {{#callable:keys_cmd_args}} -->
[View Source →](<../../../../../../src/app/shared/commands/keys.c#L18>)

Parses command-line arguments to determine the subcommand and file path for key operations.
- **Inputs**:
    - ``pargc``: A pointer to an integer representing the count of command-line arguments.
    - ``pargv``: A pointer to an array of strings representing the command-line arguments.
    - ``args``: A pointer to an `args_t` structure where the parsed command and file path will be stored.
- **Logic and Control Flow**:
    - Check if the number of arguments (`*pargc`) is less than 2; if true, log an error and exit.
    - Check if the first argument (`*pargv[0]`) is 'new'; if true, decrement `*pargc`, increment `*pargv`, check if `*pargc` is less than 1, log an error if true, set `args->keys.cmd` to `CMD_NEW_KEY`, and copy the next argument to `args->keys.file_path`.
    - Check if the first argument (`*pargv[0]`) is 'pubkey'; if true, perform similar operations as for 'new', but set `args->keys.cmd` to `CMD_PUBKEY`.
    - If neither 'new' nor 'pubkey' is matched, log an error and exit.
    - Decrement `*pargc` and increment `*pargv` to move past the processed arguments.
- **Output**: No return value; modifies the `args` structure and updates `*pargc` and `*pargv` to reflect processed arguments.


---
### generate\_keypair<!-- {{#callable:FD_FN_SENSITIVE::generate_keypair}} -->
[View Source →](<../../../../../../src/app/shared/commands/keys.c#L52>)

Generates a 64-byte keypair, writes it to a specified file, and manages file permissions.
- **Inputs**:
    - `keyfile`: A constant character pointer to the path where the keypair will be saved.
    - `target_uid`: An unsigned integer representing the user ID to set for file creation.
    - `target_gid`: An unsigned integer representing the group ID to set for file creation.
    - `use_grnd_random`: An integer flag indicating whether to use `GRND_RANDOM` for random number generation.
- **Logic and Control Flow**:
    - Initialize `flags` based on `use_grnd_random` to determine random number generation method.
    - Generate 32 random bytes using `getrandom` and store them in `keypair`.
    - Create a SHA-512 context and derive a public key from the private key stored in `keypair`.
    - Switch to the specified non-root user and group IDs for file operations.
    - Copy `keyfile` to `keyfile_copy` and create necessary directories if they do not exist.
    - Open the `keyfile` for writing, ensuring it does not already exist.
    - Write the keypair as a JSON array to the file, handling each byte individually.
    - Close the file and log a success message.
    - Revert to the original user and group IDs.
    - Clear the `keypair` from memory for security.
- **Output**: No return value; writes the keypair to the specified file and logs success or error messages.


---
### keys\_pubkey<!-- {{#callable:keys_pubkey}} -->
[View Source →](<../../../../../../src/app/shared/commands/keys.c#L120>)

Loads a public key from a file, encodes it in Base58, and prints it to standard output.
- **Inputs**:
    - `file_path`: A string representing the path to the file containing the public key.
- **Logic and Control Flow**:
    - Call `fd_keyload_load` with `file_path` and `1` to load the public key from the specified file.
    - Declare a character array `pubkey_str` with size `FD_BASE58_ENCODED_32_SZ` to store the Base58 encoded public key.
    - Call `fd_base58_encode_32` to encode the loaded public key into Base58 format and store it in `pubkey_str`.
    - Print the encoded public key to standard output using `FD_LOG_STDOUT`.
- **Output**: No return value; outputs the Base58 encoded public key to standard output.


---
### keys\_cmd\_fn<!-- {{#callable:keys_cmd_fn}} -->
[View Source →](<../../../../../../src/app/shared/commands/keys.c#L128>)

Executes a command to either generate a new keypair or print a public key based on the provided arguments.
- **Inputs**:
    - ``args``: A pointer to an `args_t` structure containing command type and file path for key operations.
    - ``config``: A pointer to a `config_t` structure containing user ID (`uid`) and group ID (`gid`) for file operations.
- **Logic and Control Flow**:
    - Check if `args->keys.cmd` is `CMD_NEW_KEY` using `FD_LIKELY` macro.
    - If true, call [`generate_keypair`](<#fd_fn_sensitivegenerate_keypair>) with the file path from `args`, and `uid` and `gid` from `config`.
    - If `args->keys.cmd` is `CMD_PUBKEY`, call [`keys_pubkey`](<#keys_pubkey>) with the file path from `args`.
    - If neither condition is met, log an error indicating an unknown key type.
- **Output**: No return value; performs actions based on the command type in `args`.
- **Functions Called**:
    - [`FD_FN_SENSITIVE::generate_keypair`](<#fd_fn_sensitivegenerate_keypair>)
    - [`keys_pubkey`](<#keys_pubkey>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)