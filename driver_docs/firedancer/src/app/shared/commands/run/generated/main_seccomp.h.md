<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines a seccomp filter policy for syscall handling with architecture-specific checks and actions.

# Purpose
The code is a C header file that defines a seccomp (secure computing mode) filter policy for a specific application. It is generated automatically by a script and should not be edited manually. The file includes necessary headers for seccomp and BPF (Berkeley Packet Filter) operations, and it defines architecture-specific constants to ensure compatibility with the runtime environment. The primary function, [`populate_sock_filter_policy_main`](<#populate_sock_filter_policy_main>), initializes a BPF filter array that enforces security policies by allowing or denying specific system calls based on predefined rules.

The filter policy is designed to restrict the execution of certain system calls, allowing only those that are explicitly permitted, such as `SYS_write`, `SYS_fsync`, `SYS_wait4`, `SYS_kill`, and `SYS_exit_group`. The policy checks the architecture of the executing environment and compares it with the expected architecture, terminating the process if they do not match. The function uses BPF statements and jumps to implement these checks, and it copies the filter array to the output buffer provided by the caller. The filter ensures that only system calls with specific arguments are allowed, enhancing the security of the application by preventing unauthorized operations.
# Imports and Dependencies

---
- `../../../../../../src/util/fd_util_base.h`
- `linux/audit.h`
- `linux/capability.h`
- `linux/filter.h`
- `linux/seccomp.h`
- `linux/bpf.h`
- `sys/syscall.h`
- `signal.h`
- `stddef.h`


# Global Variables

---
### sock\_filter\_policy\_main\_instr\_cnt
- **Type**: ``unsigned int``
- **Description**: A constant variable that holds the number of instructions in the main socket filter policy. It is defined as a static constant with a value of 25.
- **Use**: Used to ensure the correct number of instructions are processed in the `populate_sock_filter_policy_main` function.


# Functions

---
### populate\_sock\_filter\_policy\_main<!-- {{#callable:populate_sock_filter_policy_main}} -->
[View Source →](<../../../../../../../../src/app/shared/commands/run/generated/main_seccomp.h#L26>)

Populates a `sock_filter` array with a predefined seccomp filter policy to control system call permissions.
- **Inputs**:
    - `out_cnt`: The number of elements in the `out` array, which must be at least 25.
    - `out`: A pointer to a `sock_filter` array where the filter policy will be copied.
    - `logfile_fd`: The file descriptor for the log file, used in syscall checks.
    - `pid_namespace`: The process ID namespace, used in syscall checks.
- **Logic and Control Flow**:
    - Check if `out_cnt` is at least 25 using `FD_TEST` macro.
    - Define a `sock_filter` array `filter` with 25 elements to specify the seccomp filter policy.
    - Load the architecture from `seccomp_data` and compare it with `ARCH_NR`; jump to `RET_KILL_PROCESS` if they do not match.
    - Load the syscall number and check against allowed syscalls (`SYS_write`, `SYS_fsync`, `SYS_wait4`, `SYS_kill`, `SYS_exit_group`).
    - For `SYS_write`, check if the first argument is 2 or `logfile_fd`; allow if true, otherwise kill the process.
    - For `SYS_fsync`, check if the first argument is `logfile_fd`; allow if true, otherwise kill the process.
    - For `SYS_wait4`, check if the first argument is `pid_namespace`, the second argument is `__WALL`, and the third argument is 0; allow if all are true, otherwise kill the process.
    - For `SYS_kill`, check if the second argument is `SIGKILL`; allow if true, otherwise kill the process.
    - If none of the conditions match, jump to `RET_KILL_PROCESS`.
    - Copy the `filter` array to the `out` array using `fd_memcpy`.
- **Output**: The `out` array is populated with the seccomp filter policy.



---
Made with ❤️ by [Driver](https://www.driver.ai/)