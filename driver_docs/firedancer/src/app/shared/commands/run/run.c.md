<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements the main execution logic for the Firedancer application, including process management, permissions, and configuration checks.

# Purpose
The code is a C source file that is part of a larger system designed to manage and execute processes within a controlled environment, likely for a high-performance computing application. The file includes functionality for setting up and managing process namespaces, configuring system resources, and handling process execution and termination. It defines several functions that are responsible for initializing and managing workspaces, setting up network namespaces, and executing processes with specific configurations and permissions.

Key components of the code include the [`run_cmd_perm`](<#run_cmd_perm>) function, which checks and raises resource limits and capabilities required for the execution of certain operations, and the [`main_pid_namespace`](<#main_pid_namespace>) function, which manages the lifecycle of processes within a PID namespace. The code also includes functions for creating and managing memory-mapped stacks, executing child processes with specific configurations, and handling signals to ensure proper cleanup and termination of processes. The file is structured to support the execution of a main process that acts as a supervisor, managing child processes and ensuring that if any process in the hierarchy fails, all related processes are terminated to maintain system integrity.
# Imports and Dependencies

---
- `run.h`
- `sys/wait.h`
- `generated/main_seccomp.h`
- `generated/pidns_arm64_seccomp.h`
- `generated/pidns_seccomp.h`
- `../../../platform/fd_sys_util.h`
- `../../../platform/fd_file_util.h`
- `../../../platform/fd_net_util.h`
- `../configure/configure.h`
- `dirent.h`
- `sched.h`
- `stdio.h`
- `stdlib.h`
- `poll.h`
- `unistd.h`
- `errno.h`
- `fcntl.h`
- `sys/prctl.h`
- `sys/resource.h`
- `sys/mman.h`
- `sys/stat.h`
- `linux/capability.h`
- `linux/unistd.h`
- `../../../../util/tile/fd_tile_private.h`


# Global Variables

---
### CALLBACKS
- **Type**: `fd_topo_obj_callbacks_t *`
- **Description**: An array of pointers to `fd_topo_obj_callbacks_t` structures. These structures likely contain function pointers or callback functions related to topology objects.
- **Use**: Used to store and manage callback functions for topology objects in the system.


---
### fd\_log\_private\_path
- **Type**: ``char` array`
- **Description**: A global character array with a size of 1024, initialized as an empty string at the start.
- **Use**: Stores the path to the log file used by the application.


---
### pid\_namespace
- **Type**: ``pid_t``
- **Description**: A static variable of type `pid_t` that stores the process ID of the namespace process.
- **Use**: Used to track the process ID of the namespace process for signal handling and process management.


---
### fd\_log\_private\_shared\_lock
- **Type**: `int *`
- **Description**: A pointer to an integer that acts as a lock for shared logging operations.
- **Use**: Used to control access to shared logging resources, ensuring that log messages are printed without interference from other processes.


---
### run\_cmd\_fn
- **Type**: `function`
- **Description**: Executes the main command for running the Firedancer validator. It checks configuration settings and initializes the Firedancer environment.
- **Use**: Used to start the Firedancer validator with the specified configuration.


---
### fd\_action\_run1
- **Type**: ``action_t``
- **Description**: Defines an action structure for the `run1` command, which includes the name, arguments, function, permissions, and description of the action.
- **Use**: Used to start up a single Firedancer tile with the specified command and parameters.


---
### fd\_action\_run
- **Type**: ``action_t``
- **Description**: Defines an action structure for running a Firedancer validator. It includes fields for the action's name, arguments, function pointer, configuration requirement, permissions, description, and error message for insufficient permissions.
- **Use**: Used to encapsulate the details and execution logic for starting a Firedancer validator.


# Data Structures

---
### pidns\_clone\_args
- **Type**: ``struct``
- **Members**:
    - ``config``: Pointer to a constant `config_t` structure.
    - ``pipefd``: Pointer to an integer representing a file descriptor for a pipe.
    - ``closefd``: Integer representing a file descriptor to close.
- **Description**: Holds arguments for cloning a process in a PID namespace, including configuration data, a pipe file descriptor, and a file descriptor to close.


# Functions

---
### run\_cmd\_perm<!-- {{#callable:run_cmd_perm}} -->
[View Source →](<../../../../../../../src/app/shared/commands/run/run.c#L39>)

Configures system resource limits and capabilities required for running a Firedancer validator.
- **Inputs**:
    - ``args``: Unused parameter, typically for command-line arguments.
    - ``chk``: Pointer to a `fd_cap_chk_t` structure used for checking and setting capabilities and resource limits.
    - ``config``: Pointer to a constant `config_t` structure containing configuration settings for the Firedancer validator.
- **Logic and Control Flow**:
    - Ignore the `args` parameter as it is not used in the function.
    - Calculate the maximum memory lock limit using `fd_topo_mlock_max_tile` with the topology from `config`.
    - Raise the `RLIMIT_MEMLOCK` limit to allow all memory to be locked using `mlock(2)`.
    - Raise the `RLIMIT_NICE` limit to increase thread priorities.
    - Raise the `RLIMIT_NOFILE` limit to allow more open files for Agave.
    - Check and set the `CAP_NET_RAW` capability to bind to a raw socket for XDP.
    - Check and set the `CAP_SYS_ADMIN` capability to initialize XDP with `bpf(2)`.
    - If sandboxing requires `CAP_SYS_ADMIN`, set it to allow user namespace sandboxing with `unshare(2)`.
    - If the current user ID does not match the configured user ID, set the `CAP_SETUID` capability to switch to the sandbox user.
    - If the current group ID does not match the configured group ID, set the `CAP_SETGID` capability to switch to the sandbox user.
    - If network namespace is enabled in development configuration, set `CAP_SYS_ADMIN` to enter the network namespace.
    - If the Prometheus listen port is less than 1024, set `CAP_NET_BIND_SERVICE` to bind to a privileged port for metrics.
    - If the GUI listen port is less than 1024, set `CAP_NET_BIND_SERVICE` to bind to a privileged port for the GUI.
- **Output**: No return value; the function performs system configuration tasks.


---
### parent\_signal<!-- {{#callable:parent_signal}} -->
[View Source →](<../../../../../../../src/app/shared/commands/run/run.c#L81>)

Handles signals for the parent process, logs the signal received, and terminates the process group accordingly.
- **Inputs**:
    - `sig`: The signal number received by the process.
- **Logic and Control Flow**:
    - If `pid_namespace` is valid, send `SIGKILL` to it using `kill()`.
    - Set `fd_log_private_shared_lock` to a local lock variable to avoid deadlocks in logging.
    - Log the received signal using `FD_LOG_ERR_NOEXIT`, including the log file path if available.
    - If the signal is `SIGINT`, call `fd_sys_util_exit_group` with an exit code of `128 + SIGINT`.
    - For other signals, call `fd_sys_util_exit_group` with an exit code of `0`.
- **Output**: No return value; the function logs the signal and exits the process group.


---
### install\_parent\_signals<!-- {{#callable:install_parent_signals}} -->
[View Source →](<../../../../../../../src/app/shared/commands/run/run.c#L100>)

Sets up signal handlers for the parent process to handle termination and ignore user signals.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initializes a `sigaction` structure `sa` with `parent_signal` as the handler and no flags.
    - Attempts to set the `SIGTERM` and `SIGINT` signals to use the `parent_signal` handler, logging an error if `sigaction` fails.
    - Changes the `sa_handler` to `SIG_IGN` to ignore signals.
    - Attempts to set the `SIGUSR1` and `SIGUSR2` signals to be ignored, logging an error if `sigaction` fails.
- **Output**: No output is returned.


---
### create\_clone\_stack<!-- {{#callable:create_clone_stack}} -->
[View Source →](<../../../../../../../src/app/shared/commands/run/run.c#L118>)

Allocates a memory region for a stack with guard pages using `mmap` and `munmap`.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calculate the total size of the memory to allocate, which includes the stack size and two guard pages.
    - Use `mmap` to allocate a memory region with read and write permissions.
    - Check if `mmap` failed and log an error if it did.
    - Use `munmap` to unmap the lower guard page and adjust the stack pointer.
    - Use `munmap` to unmap the upper guard page after the stack.
    - Map the lower guard page with no permissions using `mmap` and check for errors.
    - Map the upper guard page with no permissions using `mmap` and check for errors.
    - Return the pointer to the stack.
- **Output**: Returns a pointer to the allocated stack memory region.


---
### execve\_agave<!-- {{#callable:execve_agave}} -->
[View Source →](<../../../../../../../src/app/shared/commands/run/run.c#L147>)

Executes a new process with specific arguments and environment variables, handling errors and process management.
- **Inputs**:
    - `config_memfd`: A file descriptor for the configuration memory.
    - `pipefd`: A file descriptor for a pipe used for inter-process communication.
- **Logic and Control Flow**:
    - Checks if `fcntl` can clear the close-on-exec flag on `pipefd`; logs an error if it fails.
    - Forks the current process; logs an error if the fork fails.
    - In the child process, retrieves the current executable path and prepares arguments for `execve`.
    - Checks for the `GOOGLE_APPLICATION_CREDENTIALS` environment variable and includes it in the environment if present.
    - Attempts to execute the current executable with `execve` using the prepared arguments and environment; logs an error if it fails.
    - In the parent process, sets the close-on-exec flag on `pipefd` and returns the child's process ID.
- **Output**: Returns the process ID of the child process if successful, or logs an error and exits on failure.


---
### execve\_tile<!-- {{#callable:execve_tile}} -->
[View Source →](<../../../../../../../src/app/shared/commands/run/run.c#L177>)

Executes a new process with specific CPU affinity and priority settings, using the provided configuration and pipe file descriptors.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure that contains information about the tile, including its CPU index and kind ID.
    - `floating_cpu_set`: A pointer to a `fd_cpuset_t` structure representing the set of CPUs to use if the tile's CPU index is not specified.
    - `floating_priority`: An integer representing the priority to set if the tile's CPU index is not specified.
    - `config_memfd`: An integer file descriptor for the configuration memory file.
    - `pipefd`: An integer file descriptor for the pipe used for inter-process communication.
- **Logic and Control Flow**:
    - Declare a CPU set using `FD_CPUSET_DECL` macro.
    - Check if the tile's CPU index is not `ULONG_MAX`.
    - If the tile's CPU index is valid, insert it into the CPU set and set the process priority to -19.
    - If the tile's CPU index is not valid, copy the floating CPU set and set the process priority to the floating priority.
    - Set the thread affinity to the specified CPU set using `fd_cpuset_setaffinity`.
    - Clear the `FD_CLOEXEC` flag on the pipe file descriptor using `fcntl`.
    - Fork the current process using `fork`.
    - In the child process, construct the argument list and execute the current executable with `execve`.
    - In the parent process, set the `FD_CLOEXEC` flag back on the pipe file descriptor and return the child's PID.
- **Output**: Returns the process ID (`pid_t`) of the child process if successful, or logs an error and exits on failure.


---
### main\_pid\_namespace<!-- {{#callable:main_pid_namespace}} -->
[View Source →](<../../../../../../../src/app/shared/commands/run/run.c#L228>)

Manages a PID namespace, creating and monitoring child processes, and handling their termination.
- **Inputs**:
    - `_args`: A pointer to a `pidns_clone_args` structure containing configuration data and file descriptors for inter-process communication.
- **Logic and Control Flow**:
    - Closes the read end of the pipe and optionally another file descriptor specified in `args`.
    - Sets up logging for the PID namespace and retrieves the new process ID.
    - Configures the process as a child subreaper if sandboxing is not enabled.
    - Saves the current CPU affinity to restore it later.
    - Initializes arrays to track child process IDs, names, and indices.
    - Converts the configuration to a memory file descriptor and checks for errors.
    - If debugging is enabled, sets a shared lock for logging.
    - Creates a child process for Agave if applicable, using a pipe for communication.
    - Enters a network namespace if enabled in the configuration.
    - Saves the current process priority and checks for errors.
    - Installs XDP if required by the network configuration.
    - Iterates over tiles in the configuration, creating child processes for each non-Agave tile, using pipes for communication.
    - Reads actual child process IDs from pipes to ensure correct tracking.
    - Restores the original process priority and CPU affinity.
    - Closes various file descriptors, including those related to XDP if used.
    - Sets up a seccomp filter for sandboxing if enabled in the configuration.
    - Enters the sandbox environment or switches user and group IDs if sandboxing is not enabled.
    - Reaps child processes to prevent them from appearing in process listings.
    - Sets up polling on pipes to detect when the parent or any child process dies.
    - Enters an infinite loop to monitor child processes, exiting if the parent process dies or a child process exits unexpectedly.
- **Output**: Returns 0 upon successful execution, indicating normal termination of the PID namespace management process.
- **Functions Called**:
    - [`execve_agave`](<#execve_agave>)
    - [`execve_tile`](<#execve_tile>)
    - [`populate_sock_filter_policy_pidns_arm64`](<generated/pidns_arm64_seccomp.h.md#populate_sock_filter_policy_pidns_arm64>)
    - [`populate_sock_filter_policy_pidns`](<generated/pidns_seccomp.h.md#populate_sock_filter_policy_pidns>)


---
### clone\_firedancer<!-- {{#callable:clone_firedancer}} -->
[View Source →](<../../../../../../../src/app/shared/commands/run/run.c#L466>)

Creates a new process in a PID namespace and sets up a communication pipe between the parent and child processes.
- **Inputs**:
    - ``config``: A pointer to a `config_t` structure containing configuration settings, including whether to use a sandbox.
    - ``close_fd``: An integer representing a file descriptor that should be closed in the child process.
    - ``out_pipe``: A pointer to an integer where the function will store the read end of the pipe for communication with the child process.
- **Logic and Control Flow**:
    - Creates a pipe with `pipe2` for communication between the parent and child processes.
    - Checks if the `sandbox` option is enabled in the `config` and sets the `CLONE_NEWPID` flag accordingly.
    - Initializes a `pidns_clone_args` structure with the provided `config`, `close_fd`, and the created pipe file descriptors.
    - Allocates a stack for the child process using [`create_clone_stack`](<#create_clone_stack>).
    - Calls `clone` to create a new process in a PID namespace, passing `main_pid_namespace` as the function to execute in the child process.
    - If `clone` fails, logs an error and exits.
    - Closes the write end of the pipe in the parent process.
    - Stores the read end of the pipe in `out_pipe`.
- **Output**: Returns the process ID of the newly created child process in the PID namespace.
- **Functions Called**:
    - [`create_clone_stack`](<#create_clone_stack>)


---
### workspace\_path<!-- {{#callable:workspace_path}} -->
[View Source →](<../../../../../../../src/app/shared/commands/run/run.c#L490>)

Constructs a workspace path based on the page size and configuration details.
- **Inputs**:
    - ``config``: A pointer to a `config_t` structure containing configuration details, including mount paths for different page sizes.
    - ``wksp``: A pointer to a `fd_topo_wksp_t` structure representing the workspace, including its page size and name.
    - ``out``: A character array with a size of `PATH_MAX` to store the resulting workspace path.
- **Logic and Control Flow**:
    - Determine the `mount_path` based on the `wksp->page_sz` using a switch statement.
    - If `wksp->page_sz` is `FD_SHMEM_HUGE_PAGE_SZ`, set `mount_path` to `config->hugetlbfs.huge_page_mount_path`.
    - If `wksp->page_sz` is `FD_SHMEM_GIGANTIC_PAGE_SZ`, set `mount_path` to `config->hugetlbfs.gigantic_page_mount_path`.
    - If `wksp->page_sz` is `FD_SHMEM_NORMAL_PAGE_SZ`, set `mount_path` to `config->hugetlbfs.normal_page_mount_path`.
    - If `wksp->page_sz` does not match any known page size, log an error and exit.
    - Use `fd_cstr_printf_check` to format the path into `out` using the `mount_path`, `config->name`, and `wksp->name`.
- **Output**: The function outputs the constructed workspace path in the `out` parameter.


---
### warn\_unknown\_files<!-- {{#callable:warn_unknown_files}} -->
[View Source →](<../../../../../../../src/app/shared/commands/run/run.c#L512>)

Checks for unknown files in a specified mount path and logs warnings if any are found.
- **Inputs**:
    - ``config``: A pointer to a `config_t` structure containing configuration details, including mount paths and workspace information.
    - ``mount_type``: An unsigned long integer indicating the type of mount path to check (0 for huge page mount path, 1 for gigantic page mount path).
- **Logic and Control Flow**:
    - Determine the `mount_path` based on `mount_type` using a switch statement.
    - Open the directory at `mount_path` using `opendir` and handle errors if the directory cannot be opened.
    - Iterate over each entry in the directory using `readdir`.
    - Skip entries named "." and "..".
    - For each entry, construct the full path `entry_path`.
    - Check if `entry_path` matches any known workspace paths by iterating over `config->topo.workspaces` and using [`workspace_path`](<#workspace_path>) to generate expected paths.
    - If `mount_type` is 0, also check if `entry_path` matches any expected stack paths for tiles in `config->topo.tiles`.
    - Log a warning if `entry_path` does not match any known paths.
    - Handle errors that occur during directory reading and closing.
- **Output**: No return value; logs warnings for unknown files and errors encountered.
- **Functions Called**:
    - [`workspace_path`](<#workspace_path>)


---
### initialize\_workspaces<!-- {{#callable:initialize_workspaces}} -->
[View Source →](<../../../../../../../src/app/shared/commands/run/run.c#L575>)

Initializes workspaces by setting user and group IDs, checking and creating workspace paths, and handling memory allocation errors.
- **Inputs**:
    - `config`: A pointer to a `config_t` structure containing configuration data, including user and group IDs, workspace count, and workspace details.
- **Logic and Control Flow**:
    - Retrieve the current group ID (`gid`) and user ID (`uid`).
    - If the current `gid` is different from `config->gid`, attempt to set the effective group ID to `config->gid`.
    - If the current `uid` is different from `config->uid`, attempt to set the effective user ID to `config->uid`.
    - Iterate over each workspace in `config->topo.workspaces`.
    - For each workspace, generate its path using [`workspace_path`](<#workspace_path>).
    - Check if the workspace path exists using `stat`.
    - If the path exists and `config->is_live_cluster` is true, attempt to unlink the path and set `update_existing` to 0.
    - If the path exists and `config->is_live_cluster` is false, set `update_existing` to 1.
    - If the path does not exist, set `update_existing` to 0.
    - If `stat` fails for reasons other than the path not existing, log an error.
    - Attempt to create the workspace using `fd_topo_create_workspace`.
    - If memory allocation fails (`ENOMEM`), call [`warn_unknown_files`](<#warn_unknown_files>) and log an error with details about the memory issue.
    - Join the workspace with read-write mode using `fd_topo_join_workspace`.
    - Initialize the workspace with `fd_topo_wksp_new` using `CALLBACKS`.
    - Leave the workspace using `fd_topo_leave_workspace`.
    - Restore the original user ID using `seteuid`.
    - Restore the original group ID using `setegid`.
- **Output**: No return value; the function performs operations to initialize workspaces and logs errors if operations fail.
- **Functions Called**:
    - [`workspace_path`](<#workspace_path>)
    - [`warn_unknown_files`](<#warn_unknown_files>)


---
### initialize\_stacks<!-- {{#callable:initialize_stacks}} -->
[View Source →](<../../../../../../../src/app/shared/commands/run/run.c#L642>)

Initializes stack workspaces for each tile in the configuration, handling permissions and memory allocation.
- **Inputs**:
    - ``config``: A pointer to a `config_t` structure containing configuration details for stack initialization, including user and group IDs, tile information, and file paths.
- **Logic and Control Flow**:
    - If `FD_HAS_MSAN` is defined, the function returns immediately to avoid conflicts with MSan's external symbolizer.
    - Switches to non-root user and group IDs specified in `config` for workspace creation.
    - Iterates over each tile in `config->topo.tile_cnt`.
    - For each tile, constructs a file path for the stack workspace using `fd_cstr_printf_check`.
    - Checks if the stack workspace file exists using `stat`.
    - If the file exists and `config->is_live_cluster` is true, attempts to delete the file with `unlink`.
    - Determines whether to update an existing stack or create a new one based on the result of `stat` and `unlink`.
    - Sets the CPU index for the stack, defaulting to 0 if the tile's CPU index is invalid.
    - Creates or updates the stack workspace using `fd_shmem_create_multi` or `fd_shmem_update_multi`, logging errors if memory allocation fails.
    - Restores the original user and group IDs after processing all tiles.
- **Output**: No return value; the function performs operations to initialize stack workspaces and logs errors if they occur.
- **Functions Called**:
    - [`warn_unknown_files`](<#warn_unknown_files>)


---
### fdctl\_check\_configure<!-- {{#callable:fdctl_check_configure}} -->
[View Source →](<../../../../../../../src/app/shared/commands/run/run.c#L714>)

Checks the configuration of huge pages, network settings, kernel parameters, and hyperthreading, and logs errors if any configuration is incorrect.
- **Inputs**:
    - ``config``: A pointer to a `config_t` structure containing configuration settings to be checked.
- **Logic and Control Flow**:
    - Call `fd_cfg_stage_hugetlbfs.check` to verify huge pages configuration.
    - If huge pages are not configured correctly, log an error and suggest running `fdctl configure init hugetlbfs`.
    - Check if network namespace is not enabled and network provider is 'xdp'.
    - If conditions are met, check network settings using `fd_cfg_stage_ethtool_channels.check`, `fd_cfg_stage_ethtool_offloads.check`, and `fd_cfg_stage_ethtool_loopback.check`.
    - Log errors for each network setting if not configured correctly, suggesting appropriate `fdctl configure init` commands.
    - Check kernel parameters using `fd_cfg_stage_sysctl.check` and log an error if not configured correctly, suggesting `fdctl configure init sysctl`.
    - Check hyperthreading configuration using `fd_cfg_stage_hyperthreads.check` and log an error if not configured correctly, suggesting `fdctl configure init hyperthreads`.
- **Output**: No return value; logs errors if configurations are incorrect.


---
### run\_firedancer\_init<!-- {{#callable:run_firedancer_init}} -->
[View Source →](<../../../../../../../src/app/shared/commands/run/run.c#L750>)

Initializes the Firedancer environment by checking identity keys, verifying configuration, and initializing workspaces and stacks.
- **Inputs**:
    - ``config``: A pointer to a `config_t` structure containing configuration details for the Firedancer environment.
    - ``init_workspaces``: An integer flag indicating whether to initialize workspaces (non-zero to initialize).
    - ``check_configure``: An integer flag indicating whether to check the configuration (non-zero to check).
- **Logic and Control Flow**:
    - Check if the identity key file exists at the path specified in `config->paths.identity_key`; log an error if it does not exist or if there is a stat error.
    - If `config->is_firedancer` is false, iterate over `config->frankendancer.paths.authorized_voter_paths` to check if each authorized voter path exists; log an error if any path does not exist or if there is a stat error.
    - If `check_configure` is non-zero, call [`fdctl_check_configure`](<#fdctl_check_configure>) to verify the configuration.
    - If `init_workspaces` is non-zero, call [`initialize_workspaces`](<#initialize_workspaces>) to set up the workspaces.
    - Call [`initialize_stacks`](<#initialize_stacks>) to set up the stacks.
- **Output**: No return value; the function performs initialization tasks and logs errors if any issues are encountered.
- **Functions Called**:
    - [`fdctl_check_configure`](<#fdctl_check_configure>)
    - [`initialize_workspaces`](<#initialize_workspaces>)
    - [`initialize_stacks`](<#initialize_stacks>)


---
### fdctl\_setup\_netns<!-- {{#callable:fdctl_setup_netns}} -->
[View Source →](<../../../../../../../src/app/shared/commands/run/run.c#L775>)

Configures and manages the network namespace for the application based on the provided configuration.
- **Inputs**:
    - ``config``: A pointer to a `config_t` structure that contains configuration settings, including network namespace and provider details.
    - ``stay``: An integer flag indicating whether to stay in the new network namespace (`stay` is non-zero) or to restore the original namespace (`stay` is zero).
- **Logic and Control Flow**:
    - Check if network namespace is enabled in the configuration; if not, return immediately.
    - Determine whether to save the original network namespace based on the `stay` flag.
    - Attempt to enter the specified network namespace using `fd_net_util_netns_enter`; log an error and exit if it fails.
    - If the network provider is 'xdp', initialize ethtool settings using `fd_cfg_stage_ethtool_channels`, `fd_cfg_stage_ethtool_offloads`, and `fd_cfg_stage_ethtool_loopback`.
    - If the original network namespace was saved and `stay` is zero, attempt to restore it using `fd_net_util_netns_restore`; log an error and exit if it fails.
- **Output**: No return value; the function performs network namespace setup and logs errors if operations fail.


---
### run\_firedancer<!-- {{#callable:run_firedancer}} -->
[View Source →](<../../../../../../../src/app/shared/commands/run/run.c#L830>)

Initializes and runs the Firedancer process with security and sandboxing configurations.
- **Inputs**:
    - `config`: A pointer to a `config_t` structure containing configuration settings for Firedancer.
    - `parent_pipefd`: An integer representing the file descriptor for the parent pipe, used for inter-process communication.
    - `init_workspaces`: An integer flag indicating whether to initialize workspaces (1 for true, 0 for false).
- **Logic and Control Flow**:
    - Logs the topology configuration using `fd_topo_print_log`.
    - Initializes Firedancer with [`run_firedancer_init`](<#run_firedancer_init>), which checks configurations and initializes workspaces and stacks.
    - Attempts to create a Landlock ruleset using `syscall` for additional security; logs a warning if not supported.
    - Closes standard input and output file descriptors (0 and 1) to prevent unintended input/output.
    - Clones a new process namespace using [`clone_firedancer`](<#clone_firedancer>), which sets up a new PID namespace and returns a pipe file descriptor.
    - Installs signal handlers with [`install_parent_signals`](<#install_parent_signals>) to manage termination signals and log file location.
    - Closes the log lock file descriptor from the configuration to prevent shared access.
    - Populates a seccomp filter policy using [`populate_sock_filter_policy_main`](<generated/main_seccomp.h.md#populate_sock_filter_policy_main>) for syscall filtering.
    - Prepares a list of allowed file descriptors for the sandbox environment.
    - Enters a sandbox environment using `fd_sandbox_enter` if sandboxing is enabled, otherwise switches user and group IDs with `fd_sandbox_switch_uid_gid`.
    - Sets a private log lock to ensure the supervisor process does not share it with child processes.
    - Waits for the cloned PID namespace process to exit using `wait4`, and exits the group with the appropriate status code.
- **Output**: No return value; the function manages process execution and exits the program based on the child process's status.
- **Functions Called**:
    - [`run_firedancer_init`](<#run_firedancer_init>)
    - [`clone_firedancer`](<#clone_firedancer>)
    - [`install_parent_signals`](<#install_parent_signals>)
    - [`populate_sock_filter_policy_main`](<generated/main_seccomp.h.md#populate_sock_filter_policy_main>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)