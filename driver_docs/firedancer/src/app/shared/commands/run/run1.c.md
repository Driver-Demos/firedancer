<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines and implements functions to parse command-line arguments and execute a tile in a sandboxed environment.

# Purpose
The code is a C source file that defines functionality for running a specific type of process, referred to as a "tile," within a larger system. It includes functions to parse command-line arguments, set up the environment, and execute the tile process. The [`run1_cmd_args`](<#run1_cmd_args>) function processes command-line arguments to extract necessary parameters such as the tile name and kind ID, which are used to identify and configure the tile to be run. The [`run1_cmd_fn`](<#run1_cmd_fn>) function orchestrates the execution of the tile by setting up the process environment, including CPU affinity and logging, and then using the `clone` system call to create a new process in a potentially isolated namespace.

The file includes several external dependencies, such as `fd_tile_private.h` and `run.h`, indicating that it is part of a larger codebase. The [`tile_main`](<#tile_main>) function is the entry point for the tile process, which runs the tile using the [`fdctl_tile_run`](<#fdctl_tile_run>) function and manages its lifecycle. The code is designed to handle errors robustly, with checks and logging for various failure conditions. It is intended to be part of a system that manages multiple tiles, each potentially running in its own process space, and provides a mechanism for controlled execution and shutdown of these tiles.
# Imports and Dependencies

---
- `run.h`
- `../../../../util/tile/fd_tile_private.h`
- `sched.h`
- `stdlib.h`
- `errno.h`
- `unistd.h`
- `sys/wait.h`


# Global Variables

---
### fd\_log\_private\_shared\_lock
- **Type**: `int *`
- **Description**: A pointer to an integer that is declared as an external variable. It is used to manage shared locking mechanisms in the logging system.
- **Use**: Used to synchronize access to shared resources in the logging system, particularly in debugging and waiting conditions.


# Data Structures

---
### tile\_main\_args\_t
- **Type**: ``struct``
- **Members**:
    - ``config``: A pointer to a `config_t` structure that holds configuration data.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure that represents a tile in the topology.
    - ``pipefd``: An integer file descriptor for inter-process communication.
- **Description**: Holds the arguments needed for the main function of a tile, including configuration data, a tile reference, and a file descriptor for communication.


# Functions

---
### run1\_cmd\_args<!-- {{#callable:run1_cmd_args}} -->
[View Source →](<../../../../../../../src/app/shared/commands/run/run1.c#L17>)

Parses command-line arguments to initialize the `args_t` structure with a pipe file descriptor, tile name, and kind ID.
- **Inputs**:
    - `pargc`: A pointer to an integer representing the count of command-line arguments.
    - `pargv`: A pointer to an array of strings representing the command-line arguments.
    - `args`: A pointer to an `args_t` structure where parsed values will be stored.
- **Logic and Control Flow**:
    - Check if the number of arguments (`*pargc`) is less than 2; if true, log an error with usage information and terminate.
    - Extract the pipe file descriptor from the command-line arguments using `fd_env_strip_cmdline_int` and store it in `args->run1.pipe_fd`.
    - Copy the first command-line argument to `args->run1.tile_name` and decrement `*pargc` and increment `*pargv` to move to the next argument.
    - Convert the next command-line argument to an unsigned long integer (`kind_id`) using `strtoul`; if conversion fails or the result is `ULONG_MAX`, log an error and terminate.
    - Store the converted `kind_id` in `args->run1.kind_id` and decrement `*pargc` and increment `*pargv` to finalize argument processing.
- **Output**: The function does not return a value but modifies the `args_t` structure pointed to by `args` with parsed command-line argument values.


---
### tile\_main<!-- {{#callable:tile_main}} -->
[View Source →](<../../../../../../../src/app/shared/commands/run/run1.c#L47>)

Executes a tile in a specified configuration and handles its shutdown process.
- **Inputs**:
    - `_args`: A pointer to `tile_main_args_t` structure containing configuration, tile, and pipe file descriptor information.
- **Logic and Control Flow**:
    - Cast `_args` to `tile_main_args_t` pointer to access configuration and tile information.
    - Initialize `wait` and `debug` pointers to `NULL`.
    - Check if debugging is enabled for the tile using `args->config->development.debug_tile`.
    - If debugging is enabled and the tile ID matches the debug tile ID, set `debug` to `fd_log_private_shared_lock[1]`; otherwise, set `wait` to `fd_log_private_shared_lock[1]`.
    - Call [`fdctl_tile_run`](<../../boot/fd_boot.c.md#fdctl_tile_run>) to initialize `run_tile` with the tile's run configuration.
    - Execute `fd_topo_run_tile` with the provided configuration, tile, and run parameters, including `wait` and `debug` pointers.
    - Verify that the tile allows shutdown using `FD_TEST`.
    - Return `0` to indicate successful execution.
- **Output**: Returns `0` to indicate successful execution and clean shutdown of the tile.
- **Functions Called**:
    - [`fdctl_tile_run`](<../../boot/fd_boot.c.md#fdctl_tile_run>)


---
### run1\_cmd\_fn<!-- {{#callable:run1_cmd_fn}} -->
[View Source →](<../../../../../../../src/app/shared/commands/run/run1.c#L67>)

Executes a command to run a tile in a new process with specific configurations and logging setup.
- **Inputs**:
    - `args`: A pointer to an `args_t` structure containing command-line arguments, including the tile name, kind ID, and pipe file descriptor.
    - `config`: A pointer to a `config_t` structure containing configuration details, including topology and development settings.
- **Logic and Control Flow**:
    - Retrieve the current process ID using `fd_sandbox_getpid` and set it for logging with `fd_log_private_tid_set`.
    - Find the tile ID using `fd_topo_find_tile` with the provided tile name and kind ID from `args`.
    - If the tile ID is not found, log an error and terminate the process.
    - Set the thread name for logging using `fd_log_thread_set`.
    - Close the log lock file descriptor and log an error if it fails.
    - Get the CPU affinity using `fd_cpuset_getaffinity` and determine the first available CPU index.
    - If no CPU is available, log a warning and default to CPU 0.
    - Join the tile stack using `fd_topo_tile_stack_join` with the configuration and tile details.
    - Prepare `clone_args` with configuration, tile, and pipe file descriptor for the new process.
    - Clone a new process using `clone` with the `tile_main` function and the prepared stack and arguments.
    - If cloning fails, log an error and terminate the process.
    - If a valid pipe file descriptor is provided, write the new process ID to it and log an error if it fails.
- **Output**: No return value; the function performs operations and may terminate the process on errors.


# Function Declarations (Public API)

---
### fdctl\_tile\_run<!-- {{#callable_declaration:fdctl_tile_run}} -->
[View Source →](<../../../../../../../src/app/shared/commands/run/run1.c#L14>)

Finds and returns a tile configuration by name.
- **Description**: Use this function to retrieve a tile configuration from a predefined list of tiles by matching the tile's name. This function is useful when you need to access the configuration of a specific tile identified by its name. It is important to ensure that the tile name provided exists in the list; otherwise, the function will log an error and return a default-initialized tile configuration. This function does not modify the input tile or any global state.
- **Inputs**:
    - `tile`: A pointer to a constant `fd_topo_tile_t` structure representing the tile to find. The `name` field of this structure is used to search for a matching tile in the list. The pointer must not be null, and the `name` field must be a valid string.
- **Output**: Returns an `fd_topo_run_tile_t` structure corresponding to the tile with the matching name. If no match is found, logs an error and returns a default-initialized `fd_topo_run_tile_t`.
- **See Also**: [`fdctl_tile_run`](<../../boot/fd_boot.c.md#fdctl_tile_run>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)