<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a command to monitor a Firedancer instance using a terminal GUI, handling permissions, metrics, and sandboxing.

# Purpose
The code is a C source file that implements a monitoring tool for a Firedancer instance. It provides functionality to observe and report various metrics and states of the system in a terminal-based graphical user interface (GUI). The primary function, [`watch_cmd_fn`](<#watch_cmd_fn>), sets up the environment and permissions required to monitor the Firedancer instance, including configuring file descriptors and security policies. It then enters a sandboxed environment if necessary and begins the monitoring process.

The code includes several static functions that handle different aspects of the monitoring process, such as [`snap_tiles`](<#snap_tiles>) and [`snap_links`](<#snap_links>), which capture the current state of system metrics, and [`write_summary`](<#write_summary>), which outputs a summary of the current system state to the terminal. The [`run`](<#run>) function orchestrates the periodic capturing and reporting of metrics, updating the terminal display with the latest information. The file also defines an `action_t` structure, `fd_action_watch`, which describes the "watch" action, including its name, function pointer, and description, indicating that it is part of a larger system where actions can be registered and executed.
# Imports and Dependencies

---
- `watch.h`
- `generated/watch_seccomp.h`
- `../../../../discof/restore/fd_snapct_tile.h`
- `../../../../disco/metrics/fd_metrics.h`
- `errno.h`
- `unistd.h`
- `sys/resource.h`
- `linux/capability.h`


# Global Variables

---
### watch\_cmd\_perm
- **Type**: ``void``
- **Description**: The `watch_cmd_perm` function is a permission-checking function that takes three parameters: `args`, `chk`, and `config`. It is responsible for setting resource limits and checking necessary capabilities for the 'watch' command to execute properly.
- **Use**: Used to ensure the 'watch' command has the necessary permissions and resource limits to run.


---
### lines\_printed
- **Type**: `ulong`
- **Description**: `lines_printed` is a static global variable of type `ulong` that tracks the number of lines printed to the terminal.
- **Use**: Used to manage terminal output by keeping track of how many lines have been printed, allowing for proper screen updates and erasures.


---
### ended\_on\_newline
- **Type**: ``int``
- **Description**: Indicates whether the last output operation ended with a newline character. It is initialized to 1, meaning the last output ended on a newline.
- **Use**: Used to determine if additional terminal control sequences are needed to manage cursor position and screen clearing.


---
### sps\_samples\_idx
- **Type**: ``ulong``
- **Description**: Represents the current index in the `sps_samples` array, which is used to store samples of slots per second (SPS) metrics.
- **Use**: Tracks the position for the next SPS sample to be stored in the `sps_samples` array.


---
### sps\_samples
- **Type**: ``ulong[]``
- **Description**: An array of unsigned long integers with a fixed size of 200 elements. It is used to store samples of slots per second (SPS) metrics.
- **Use**: Stores SPS metrics for performance monitoring and analysis.


---
### tps\_samples\_idx
- **Type**: ``ulong``
- **Description**: `tps_samples_idx` is a static global variable of type `ulong` initialized to 0. It is used to track the current index in the `tps_samples` array.
- **Use**: Tracks the position for storing the next transaction per second (TPS) sample in the `tps_samples` array.


---
### tps\_samples
- **Type**: ``ulong[]``
- **Description**: An array of unsigned long integers with a fixed size of 200 elements. It is used to store samples related to transactions per second (TPS).
- **Use**: Used to store TPS samples for performance monitoring or analysis.


---
### snapshot\_rx\_idx
- **Type**: ``ulong``
- **Description**: Represents the current index for storing received snapshot data in the `snapshot_rx_samples` array. It is initialized to zero and is used to track the position in the array where the next snapshot data will be stored.
- **Use**: Tracks the index for storing received snapshot data in the `snapshot_rx_samples` array.


---
### snapshot\_rx\_samples
- **Type**: ``ulong[]``
- **Description**: An array of unsigned long integers with a fixed size of 100 elements. It is used to store samples of received data in a snapshot process.
- **Use**: Stores samples of received data for analysis or monitoring purposes in a snapshot process.


---
### snapshot\_acc\_idx
- **Type**: ``ulong``
- **Description**: Holds the current index for the `snapshot_acc_samples` array, which stores samples of account-related metrics.
- **Use**: Tracks the position for storing the next sample in the `snapshot_acc_samples` array.


---
### snapshot\_acc\_samples
- **Type**: ``ulong[]``
- **Description**: An array of unsigned long integers with a fixed size of 100 elements. It is declared as a static variable, meaning it is limited to the file scope and retains its value between function calls.
- **Use**: Stores accumulated sample data for snapshots, likely used for performance metrics or monitoring purposes.


---
### tiles
- **Type**: ``ulong[]``
- **Description**: An array of unsigned long integers with a size of `2UL*128UL*FD_METRICS_TOTAL_SZ`. This array is used to store metrics data for tiles in a topology.
- **Use**: Stores metrics data for tiles in a topology, with each tile's metrics occupying a segment of the array.


---
### links
- **Type**: ``ulong[]``
- **Description**: An array of unsigned long integers with a size determined by the expression `2UL*4096UL*8UL*FD_METRICS_ALL_LINK_IN_TOTAL`. This array is used to store metrics related to links in a topology.
- **Use**: Stores metrics for all links in the topology, with each link having a set of metrics defined by `FD_METRICS_ALL_LINK_IN_TOTAL`.


---
### fd\_action\_watch
- **Type**: ``action_t``
- **Description**: Defines an action for watching a locally running Firedancer instance using a terminal GUI. It includes the action's name, function pointer, permission function, and a description of its purpose.
- **Use**: Used to configure and execute the 'watch' command for monitoring Firedancer instances.


# Functions

---
### drain<!-- {{#callable:drain}} -->
[View Source →](<../../../../../../../src/app/shared/commands/watch/watch.c#L32>)

Reads data from a file descriptor and writes it to standard output, handling terminal screen updates and error conditions.
- **Inputs**:
    - `fd`: The file descriptor from which to read data.
- **Logic and Control Flow**:
    - Initialize `needs_reprint` to 0.
    - Enter an infinite loop to continuously read from the file descriptor `fd`.
    - Allocate a buffer `buf` of size 16384 bytes to store read data.
    - Read data from `fd` into `buf` and store the result in `result`.
    - If `result` is -1 and `errno` is `EAGAIN`, break the loop.
    - If `result` is -1, log an error and exit.
    - If `needs_reprint` is false, prepare terminal erase sequences to clear previous output lines.
    - Write the erase sequences to standard output to clear the terminal screen.
    - Set `needs_reprint` to 1 after clearing the screen.
    - Write the contents of `buf` to standard output until all read data is written.
    - Update `ended_on_newline` based on whether the last character in `buf` is a newline.
- **Output**: Returns an integer indicating whether the terminal screen needs to be reprinted (1 if it does, 0 otherwise).


---
### fmt\_bytes<!-- {{#callable:fmt_bytes}} -->
[View Source →](<../../../../../../../src/app/shared/commands/watch/watch.c#L76>)

Formats a given number of bytes into a human-readable string representation of bits, Kbits, Mbits, or Gbits, and stores it in a buffer.
- **Inputs**:
    - ``buf``: A character buffer where the formatted string will be stored.
    - ``buf_sz``: The size of the buffer `buf`.
    - ``bytes``: The number of bytes to format into a human-readable string.
- **Logic and Control Flow**:
    - Allocate temporary buffer `tmp` using `fd_alloca_check` with size `buf_sz`.
    - Check if `8 * bytes` is less than 1000; if true, format as bits and store in `tmp`.
    - If `8 * bytes` is less than 1,000,000, format as Kbits and store in `tmp`.
    - If `8 * bytes` is less than 1,000,000,000, format as Mbits and store in `tmp`.
    - Otherwise, format as Gbits and store in `tmp`.
    - Copy the formatted string from `tmp` to `buf`, ensuring it is right-aligned within a 10-character field.
    - Return the buffer `buf`.
- **Output**: Returns the pointer to the buffer `buf` containing the formatted string.


---
### fmt\_count<!-- {{#callable:fmt_count}} -->
[View Source →](<../../../../../../../src/app/shared/commands/watch/watch.c#L90>)

Formats a count value into a human-readable string with appropriate units (e.g., K for thousands, M for millions) and right-aligns it in a buffer.
- **Inputs**:
    - ``buf``: A pointer to a character buffer where the formatted string will be stored.
    - ``buf_sz``: The size of the buffer `buf`.
    - ``count``: The count value to format.
- **Logic and Control Flow**:
    - Allocate a temporary buffer `tmp` using `fd_alloca_check` with the size `buf_sz`.
    - Check if `count` is less than 1000; if true, format `count` as an unsigned long integer into `tmp`.
    - If `count` is less than 1,000,000, format `count` as a floating-point number with one decimal place followed by 'K' into `tmp`.
    - If `count` is less than 1,000,000,000, format `count` as a floating-point number with one decimal place followed by 'M' into `tmp`.
    - Format the content of `tmp` into `buf`, right-aligned within a 10-character wide field.
    - Return the pointer to `buf`.
- **Output**: Returns a pointer to the buffer `buf` containing the formatted string.


---
### fmt\_countf<!-- {{#callable:fmt_countf}} -->
[View Source →](<../../../../../../../src/app/shared/commands/watch/watch.c#L103>)

Formats a numerical count into a human-readable string with appropriate units (K, M) based on its magnitude.
- **Inputs**:
    - ``buf``: A pointer to a character buffer where the formatted string will be stored.
    - ``buf_sz``: The size of the buffer `buf`.
    - ``count``: A double representing the numerical count to format.
- **Logic and Control Flow**:
    - Allocate temporary buffer `tmp` using `fd_alloca_check` with size `buf_sz`.
    - Check if `count` is less than 1000; if true, format `count` as a floating-point number with one decimal place into `tmp`.
    - If `count` is less than 1,000,000, format `count` divided by 1000 as a floating-point number with one decimal place followed by 'K' into `tmp`.
    - If `count` is less than 1,000,000,000, format `count` divided by 1,000,000 as a floating-point number with one decimal place followed by 'M' into `tmp`.
    - If `count` is greater than or equal to 1,000,000,000, copy '-' into `tmp`.
    - Format the content of `tmp` into `buf` as a right-aligned string with a width of 10 characters.
    - Return the pointer `buf`.
- **Output**: Returns the pointer to the buffer `buf` containing the formatted string.


---
### diff\_link<!-- {{#callable:diff_link}} -->
[View Source →](<../../../../../../../src/app/shared/commands/watch/watch.c#L117>)

Calculates the difference in metrics for a specified link between two snapshots of a network topology.
- **Inputs**:
    - ``config``: A pointer to a `config_t` structure that contains the network topology configuration.
    - ``link_name``: A string representing the name of the link to compare.
    - ``prev_link``: A pointer to an array of unsigned long integers representing the previous snapshot of link metrics.
    - ``cur_link``: A pointer to an array of unsigned long integers representing the current snapshot of link metrics.
    - ``idx``: An unsigned long integer representing the index of the specific metric to compare.
- **Logic and Control Flow**:
    - Initialize `result` to 0 and `overall_polled_idx` to 0.
    - Iterate over each tile in the topology using a loop indexed by `i`.
    - For each tile, iterate over its input links using a loop indexed by `j`.
    - Retrieve the link associated with the current input link ID.
    - If the link is not polled, continue to the next iteration.
    - If the link name matches `link_name`, calculate the difference between the current and previous link metrics at the specified index and add it to `result`.
    - Increment `overall_polled_idx` after processing each input link.
- **Output**: Returns a long integer representing the calculated difference in metrics for the specified link.


---
### diff\_tile<!-- {{#callable:diff_tile}} -->
[View Source →](<../../../../../../../src/app/shared/commands/watch/watch.c#L142>)

Calculates the difference in metrics between two tile states for a specified tile name and index.
- **Inputs**:
    - ``config``: A pointer to a `config_t` structure containing the configuration, including topology information.
    - ``tile_name``: A constant character pointer to the name of the tile to compare.
    - ``prev_tile``: A constant pointer to an array of unsigned long integers representing the previous state of the tiles.
    - ``cur_tile``: A constant pointer to an array of unsigned long integers representing the current state of the tiles.
    - ``idx``: An unsigned long integer representing the index of the metric to compare.
- **Logic and Control Flow**:
    - Initialize `result` to 0.
    - Iterate over each tile in the configuration's topology using a loop.
    - For each tile, check if the tile's name matches `tile_name`. If not, continue to the next iteration.
    - If the tile name matches, calculate the difference between the current and previous tile metrics at the specified index and add this difference to `result`.
    - Return the accumulated `result`.
- **Output**: Returns a long integer representing the accumulated difference in metrics for the specified tile and index.


---
### total\_crds<!-- {{#callable:total_crds}} -->
[View Source →](<../../../../../../../src/app/shared/commands/watch/watch.c#L158>)

Calculates the total number of CRDS (Contact Information) entries from a metrics array.
- **Inputs**:
    - `metrics`: A pointer to an array of unsigned long integers representing metrics data.
- **Logic and Control Flow**:
    - Initialize a variable `sum` to 0.
    - Iterate over a range from 0 to `FD_METRICS_ENUM_CRDS_VALUE_CNT`.
    - In each iteration, add the value at the index `MIDX(GAUGE, GOSSIP, CRDS_COUNT_CONTACT_INFO_V1) + i` from the `metrics` array to `sum`.
    - Return the value of `sum`.
- **Output**: Returns the total sum of CRDS entries as an unsigned long integer.


---
### total\_regime<!-- {{#callable:total_regime}} -->
[View Source →](<../../../../../../../src/app/shared/commands/watch/watch.c#L167>)

Calculates the total duration of a regime in nanoseconds from a metrics array.
- **Inputs**:
    - `metrics`: A pointer to an array of unsigned long integers representing metrics data.
- **Logic and Control Flow**:
    - Initialize a variable `sum` to 0.
    - Iterate over a range from 0 to `FD_METRICS_ENUM_TILE_REGIME_CNT`.
    - In each iteration, add the value at the index `MIDX(COUNTER, TILE, REGIME_DURATION_NANOS) + i` from the `metrics` array to `sum`.
    - Return the accumulated `sum`.
- **Output**: Returns the total sum of regime durations in nanoseconds as an unsigned long integer.


---
### write\_backtest<!-- {{#callable:write_backtest}} -->
[View Source →](<../../../../../../../src/app/shared/commands/watch/watch.c#L216>)

Calculates and displays the progress of a backtest operation based on the current and final slots.
- **Inputs**:
    - ``config``: A pointer to a `config_t` structure containing configuration data, including topology information.
    - ``cur_tile``: A pointer to an array of unsigned long integers representing the current state of metrics for various tiles.
- **Logic and Control Flow**:
    - Finds the index of the 'backt' tile using `fd_topo_find_tile` and retrieves the start and final slots from `cur_tile` using this index.
    - Finds the index of the 'replay' tile and retrieves the current slot from `cur_tile`. If the current slot is zero, it defaults to the start slot.
    - Calculates the total number of slots as the difference between the final and start slots.
    - Calculates the number of completed slots as the difference between the current and start slots.
    - Calculates the progress percentage as the ratio of completed slots to total slots, multiplied by 100. If the total slots are zero, sets progress to 100%.
    - Prints the progress percentage and the number of completed and total slots using the `PRINT` macro.
- **Output**: No return value; outputs progress information to the standard output.


---
### write\_snapshots<!-- {{#callable:write_snapshots}} -->
[View Source →](<../../../../../../../src/app/shared/commands/watch/watch.c#L237>)

Calculates and prints the progress, speed, and backpressure metrics of snapshot operations.
- **Inputs**:
    - ``config``: A pointer to a `config_t` structure containing the configuration and topology information.
    - ``cur_tile``: A pointer to an array of unsigned long integers representing the current state of the tiles.
    - ``prev_tile``: A pointer to an array of unsigned long integers representing the previous state of the tiles.
- **Logic and Control Flow**:
    - Finds the index of the 'snapct' tile using `fd_topo_find_tile` and retrieves various metrics from `cur_tile` using this index.
    - Calculates the progress of the snapshot operation based on the bytes read and total bytes, or based on gossip counts if bytes are not available.
    - Calculates the average megabytes per second and million accounts per second using samples from `snapshot_rx_samples` and `snapshot_acc_samples`.
    - Calculates the total ticks for 'snapct', 'snapld', 'snapdc', and 'snapin' tiles and ensures they are at least 1 to avoid division by zero.
    - Calculates the backpressure and idle percentages for each of the tiles using the [`diff_tile`](<#diff_tile>) function and the total ticks.
    - Prints the calculated state, progress, speed, backpressure, and busy percentages using the `PRINT` macro.
- **Output**: No return value; outputs formatted metrics to the standard output.
- **Functions Called**:
    - [`total_regime`](<#total_regime>)
    - [`diff_tile`](<#diff_tile>)


---
### write\_gossip<!-- {{#callable:write_gossip}} -->
[View Source →](<../../../../../../../src/app/shared/commands/watch/watch.c#L301>)

Calculates and prints gossip metrics such as received and transmitted bytes, contact information, and busy and backpressure percentages.
- **Inputs**:
    - ``config``: A pointer to a `config_t` structure containing the topology configuration.
    - ``cur_tile``: A pointer to an array of unsigned long integers representing the current tile metrics.
    - ``prev_tile``: A pointer to an array of unsigned long integers representing the previous tile metrics.
    - ``cur_link``: A pointer to an array of unsigned long integers representing the current link metrics.
    - ``prev_link``: A pointer to an array of unsigned long integers representing the previous link metrics.
- **Logic and Control Flow**:
    - Finds the index of the 'gossip' tile using `fd_topo_find_tile` and checks if it is valid.
    - Calculates the total ticks for the gossip tile by subtracting the previous regime total from the current regime total and ensures it is at least 1.
    - Calculates the backpressure and idle percentages using [`diff_tile`](<#diff_tile>) and the total ticks, then calculates the busy percentage as the remainder.
    - Formats and prints the gossip metrics including received and transmitted bytes, contact information, and the calculated percentages using the `PRINT` macro.
    - Returns 1 if the gossip tile index is valid, otherwise returns 0.
- **Output**: Returns an unsigned integer, 1 if the gossip tile index is valid and metrics are printed, otherwise 0.
- **Functions Called**:
    - [`total_regime`](<#total_regime>)
    - [`diff_tile`](<#diff_tile>)
    - [`total_crds`](<#total_crds>)


---
### write\_repair<!-- {{#callable:write_repair}} -->
[View Source →](<../../../../../../../src/app/shared/commands/watch/watch.c#L327>)

Determines if a repair tile exists and prints repair metrics if it does.
- **Inputs**:
    - ``config``: A pointer to a `config_t` structure containing the topology configuration.
    - ``cur_tile``: A pointer to an array of unsigned long integers representing the current tile metrics.
    - ``cur_link``: A pointer to an array of unsigned long integers representing the current link metrics.
    - ``prev_link``: A pointer to an array of unsigned long integers representing the previous link metrics.
- **Logic and Control Flow**:
    - Finds the index of the repair tile using `fd_topo_find_tile` with the name 'repair'.
    - Checks if the repair tile index is `ULONG_MAX`, indicating the tile does not exist, and returns 0 if true.
    - Retrieves the `repair_slot` and `turbine_slot` metrics from the `cur_tile` array using the repair tile index and predefined metric indices.
    - Prints the repair metrics, including the difference between `repair_slot` and `turbine_slot`, using the `PRINT` macro.
    - Returns 1 to indicate successful execution if the repair tile exists.
- **Output**: Returns an unsigned integer, 0 if the repair tile does not exist, and 1 if it does.


---
### write\_replay<!-- {{#callable:write_replay}} -->
[View Source →](<../../../../../../../src/app/shared/commands/watch/watch.c#L345>)

Processes and displays replay metrics for a specified tile configuration.
- **Inputs**:
    - ``config``: A pointer to a `config_t` structure containing the topology configuration.
    - ``cur_tile``: A pointer to an array of unsigned long integers representing the current tile metrics.
- **Logic and Control Flow**:
    - Finds the tile indices for 'repair' and 'replay' using `fd_topo_find_tile`.
    - Checks if the 'replay' tile index is valid; if not, returns 0.
    - Retrieves various slot metrics from the `cur_tile` array using predefined indices.
    - Allocates memory for a string to store the next leader slot time.
    - Determines the `turbine_slot` based on the presence of a valid 'repair' tile index.
    - Calculates the time until the next leader slot in seconds and formats it as a string.
    - Retrieves additional metrics such as `root_distance` and `live_banks`.
    - Calculates the average slots per second (SPS) and transactions per second (TPS) from sample arrays.
    - Formats and prints the replay metrics using the `PRINT` macro.
    - Returns 1 to indicate successful processing.
- **Output**: Returns an unsigned integer (1U) indicating successful processing of replay metrics.


---
### write\_summary<!-- {{#callable:write_summary}} -->
[View Source →](<../../../../../../../src/app/shared/commands/watch/watch.c#L393>)

Generates a summary of system metrics and status by printing various operational details to the console.
- **Inputs**:
    - ``config``: A pointer to a `config_t` structure containing configuration and topology information.
    - ``cur_tile``: A pointer to an array of unsigned long integers representing the current state of tile metrics.
    - ``prev_tile``: A pointer to an array of unsigned long integers representing the previous state of tile metrics.
    - ``cur_link``: A pointer to an array of unsigned long integers representing the current state of link metrics.
    - ``prev_link``: A pointer to an array of unsigned long integers representing the previous state of link metrics.
- **Logic and Control Flow**:
    - Checks if the last output ended on a newline and prints a newline if not.
    - Prints a separator line to the console.
    - Finds the index of the 'snapct' tile and checks if it is in a shutdown state.
    - Updates the `snap_shutdown_time` based on the shutdown state of the 'snapct' tile.
    - Initializes `lines_printed` to 1.
    - Finds the index of the 'backt' tile and calls [`write_backtest`](<#write_backtest>) if it exists, incrementing `lines_printed`.
    - Gets the current wall clock time and checks if the 'snapct' tile was recently shutdown or is still active, calling [`write_snapshots`](<#write_snapshots>) if so, and incrementing `lines_printed`.
    - Calls [`write_gossip`](<#write_gossip>), [`write_repair`](<#write_repair>), and [`write_replay`](<#write_replay>) functions, adding their return values to `lines_printed`.
- **Output**: No return value; the function outputs text to the console.
- **Functions Called**:
    - [`write_backtest`](<#write_backtest>)
    - [`write_snapshots`](<#write_snapshots>)
    - [`write_gossip`](<#write_gossip>)
    - [`write_repair`](<#write_repair>)
    - [`write_replay`](<#write_replay>)


---
### snap\_tiles<!-- {{#callable:snap_tiles}} -->
[View Source →](<../../../../../../../src/app/shared/commands/watch/watch.c#L434>)

Copies metrics from each tile in the topology to a specified array.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure that contains the topology information, including the number of tiles and their metrics.
    - ``tiles``: A pointer to an array of `ulong` where the function will store the metrics of each tile.
- **Logic and Control Flow**:
    - Iterates over each tile in the topology using a loop that runs from 0 to `topo->tile_cnt`.
    - For each tile, retrieves the metrics using the `fd_metrics_tile` function and checks if the metrics are valid using `FD_TEST`.
    - Copies the metrics from the current tile into the `tiles` array, adjusting the index to account for the size of each tile's metrics.
- **Output**: The function does not return a value; it modifies the `tiles` array in place to store the metrics of each tile.


---
### snap\_links<!-- {{#callable:snap_links}} -->
[View Source →](<../../../../../../../src/app/shared/commands/watch/watch.c#L445>)

Copies metrics from input links of each tile in the topology to the provided `links` array.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure that contains the topology information, including the number of tiles and their respective input links.
    - ``links``: A pointer to an array of `ulong` where the function will store the metrics of the input links.
- **Logic and Control Flow**:
    - Initialize `overall_polled_idx` to 0.
    - Iterate over each tile in the topology using a loop with index `i`.
    - For each tile, initialize `polled_in_idx` to 0.
    - Iterate over each input link of the current tile using a loop with index `j`.
    - Check if the input link is polled using `tile->in_link_poll[j]`; if not, continue to the next link.
    - Retrieve the metrics for the polled input link using `fd_metrics_link_in` and store them in `metrics`.
    - Copy the metrics into the `links` array at the position calculated using `overall_polled_idx`.
    - Increment `polled_in_idx` and `overall_polled_idx` after processing each polled input link.
- **Output**: The function does not return a value; it modifies the `links` array in place.


---
### run<!-- {{#callable:run}} -->
[View Source →](<../../../../../../../src/app/shared/commands/watch/watch.c#L469>)

Monitors and processes metrics from a topology configuration, updating and displaying summaries at regular intervals.
- **Inputs**:
    - ``config``: A pointer to a `config_t` structure containing the topology configuration.
    - ``drain_output_fd``: An integer file descriptor for draining output, if applicable.
- **Logic and Control Flow**:
    - Initialize `tile_cnt` with the number of tiles from `config->topo.tile_cnt`.
    - Calculate `cons_cnt` by iterating over each tile and counting the number of input links that are polled.
    - Verify that `tile_cnt` is less than or equal to 128 and `cons_cnt` is less than or equal to 4096 using `FD_TEST`.
    - Capture the initial state of tiles and links using [`snap_tiles`](<#snap_tiles>) and [`snap_links`](<#snap_links>), and store them in `tiles` and `links` arrays.
    - Copy the initial state of tiles and links to a secondary location in the arrays for comparison.
    - Set `last_snap` to 1 to track the last snapshot index.
    - Call [`write_summary`](<#write_summary>) to output the initial summary of the metrics.
    - Enter an infinite loop to continuously monitor and update metrics.
    - Check if `drain_output_fd` is valid and call [`drain`](<#drain>) to process output if necessary.
    - Get the current time using `fd_log_wallclock` and compare it to `next` to determine if it's time to update metrics.
    - If it's time to update, toggle `last_snap`, capture new snapshots of tiles and links, and calculate differences in metrics using [`diff_tile`](<#diff_tile>).
    - Update sample arrays for slots per second (SPS), transactions per second (TPS), and snapshot metrics.
    - Prepare terminal output by erasing previous lines and writing new summaries using [`write_summary`](<#write_summary>).
    - Increment `next` by 10 million nanoseconds to schedule the next update.
- **Output**: No return value; the function operates in an infinite loop, updating metrics and outputting summaries.
- **Functions Called**:
    - [`snap_tiles`](<#snap_tiles>)
    - [`snap_links`](<#snap_links>)
    - [`write_summary`](<#write_summary>)
    - [`drain`](<#drain>)
    - [`diff_tile`](<#diff_tile>)


---
### watch\_cmd\_fn<!-- {{#callable:watch_cmd_fn}} -->
[View Source →](<../../../../../../../src/app/shared/commands/watch/watch.c#L541>)

Sets up and executes a monitoring environment for a Firedancer instance, managing file descriptors, security policies, and sandboxing.
- **Inputs**:
    - `args`: A pointer to an `args_t` structure containing command-line arguments, including `watch.drain_output_fd` for output redirection.
    - `config`: A pointer to a `config_t` structure containing configuration settings, including topology and sandboxing parameters.
- **Logic and Control Flow**:
    - Initialize an array `allow_fds` to store allowed file descriptors and populate it with standard input, output, and error descriptors.
    - Check if a log file descriptor is available and add it to `allow_fds` if so.
    - Check if `args->watch.drain_output_fd` is set and add it to `allow_fds` if applicable.
    - Join the topology workspaces in read-only mode using `fd_topo_join_workspaces`.
    - Create a `seccomp_filter` array and populate it with security policies using [`populate_sock_filter_policy_watch`](<generated/watch_seccomp.h.md#populate_sock_filter_policy_watch>).
    - If sandboxing is enabled in the configuration, close the log lock file descriptor and enter the sandbox environment using `fd_sandbox_enter`.
    - If sandboxing is not enabled, switch user and group IDs using `fd_sandbox_switch_uid_gid`.
    - Fill the topology configuration using `fd_topo_fill`.
    - Call the [`run`](<#run>) function with the configuration and `drain_output_fd` to start the monitoring process.
- **Output**: No return value; the function performs setup and execution of a monitoring environment.
- **Functions Called**:
    - [`populate_sock_filter_policy_watch`](<generated/watch_seccomp.h.md#populate_sock_filter_policy_watch>)
    - [`run`](<#run>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)