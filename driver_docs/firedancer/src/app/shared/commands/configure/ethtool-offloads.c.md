<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Disables incompatible ethtool features on network interfaces for AF_XDP compatibility.

# Purpose
The code is a C module designed to configure network interfaces by disabling certain `ethtool` features that are incompatible with AF_XDP (Address Family eXpress Data Path). The primary focus is on disabling "Generic Receive Offload" (GRO) and "GRE Segmentation Offload" features on both main and loopback interfaces. These features, if enabled, can cause packet corruption when AF_XDP is in use. The module includes functions to check if a network device is bonded, read slave devices of a bonded interface, and initialize or check the configuration of network devices to ensure the specified features are disabled.

The module defines a `configure_stage_t` structure named `fd_cfg_stage_ethtool_offloads`, which includes function pointers for enabling, initializing, and checking the configuration of network devices. The [`enabled`](<#enabled>) function determines if the configuration should be applied based on the network stack provider. The [`init`](<#init>) function disables the specified `ethtool` features, while the [`check`](<#check>) function verifies that these features are indeed disabled. The module uses `fd_ethtool_ioctl` functions to interact with network devices and manage their configurations.
# Imports and Dependencies

---
- `configure.h`
- `errno.h`
- `stdio.h`
- `sys/stat.h`
- `fd_ethtool_ioctl.h`


# Global Variables

---
### fd\_cfg\_stage\_ethtool\_offloads
- **Type**: ``configure_stage_t``
- **Description**: Defines a configuration stage for managing ethtool offloads, specifically targeting features that are incompatible with AF_XDP, such as Generic Receive Offload and GRE Segmentation Offload. This structure includes function pointers for enabling, initializing, and checking the configuration of network devices.
- **Use**: Used to configure and manage the disabling of specific ethtool features on network interfaces to ensure compatibility with AF_XDP.


# Functions

---
### enabled<!-- {{#callable:enabled}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/ethtool-offloads.c#L21>)

Determines if the network configuration should enable certain features based on the network namespace and provider type.
- **Inputs**:
    - ``config``: A pointer to a constant `fd_config_t` structure that contains network configuration settings.
- **Logic and Control Flow**:
    - Check if the network namespace (`netns`) is enabled in the `config` structure; if true, return 0.
    - Compare the `provider` field in the `config` structure to the string "xdp"; if they are not equal, return 0.
    - If neither of the above conditions are met, return 1.
- **Output**: Returns an integer: 0 if the network namespace is enabled or the provider is not "xdp", otherwise 1.


---
### init\_perm<!-- {{#callable:init_perm}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/ethtool-offloads.c#L34>)

Initializes permission checks for disabling network device features using `ethtool`.
- **Inputs**:
    - `chk`: A pointer to an `fd_cap_chk_t` structure used for capability checking.
    - `config`: A pointer to a constant `fd_config_t` structure, marked as unused in this function.
- **Logic and Control Flow**:
    - Calls the function `fd_cap_chk_root` with `chk`, `NAME`, and a string describing the action to disable network device features using `ethtool`.
- **Output**: No output is returned as the function is of type `void`.


---
### device\_is\_bonded<!-- {{#callable:device_is_bonded}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/ethtool-offloads.c#L40>)

Checks if a network device is bonded by verifying the existence of a bonding directory in the device's sysfs path.
- **Inputs**:
    - `device`: A constant character pointer representing the name of the network device to check.
- **Logic and Control Flow**:
    - Constructs a file path string for the bonding directory of the specified device using `fd_cstr_printf_check`.
    - Calls `stat` on the constructed path to check if the bonding directory exists.
    - If `stat` returns an error other than `ENOENT`, logs an error message and exits.
    - Returns true if the bonding directory exists, indicating the device is bonded; otherwise, returns false.
- **Output**: Returns an integer value: 1 if the device is bonded (bonding directory exists), 0 otherwise.


---
### device\_read\_slaves<!-- {{#callable:device_read_slaves}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/ethtool-offloads.c#L52>)

Reads the list of slave network interfaces for a bonded network device and stores it in the provided output buffer.
- **Inputs**:
    - `device`: A constant character pointer representing the name of the network device to read the slave interfaces from.
    - `output`: A character array with a size of 4096 to store the list of slave interfaces.
- **Logic and Control Flow**:
    - Constructs the file path to the bonding slaves file for the specified network device using `fd_cstr_printf_check`.
    - Opens the file at the constructed path for reading using `fopen`.
    - If the file cannot be opened, logs an error and exits.
    - Reads a line from the file into the `output` buffer using `fgets`.
    - If reading fails, logs an error and exits.
    - Checks for end-of-file and file errors, logging errors and exiting if any are encountered.
    - Verifies that the line read is not too long or empty, logging errors and exiting if these conditions are met.
    - Closes the file using `fclose`, logging an error and exiting if the operation fails.
    - Removes the newline character from the end of the `output` string.
- **Output**: The `output` buffer contains the list of slave interfaces as a null-terminated string, with the newline character removed.


---
### init\_device<!-- {{#callable:init_device}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/ethtool-offloads.c#L72>)

Disables specific ethtool features on a network device to ensure compatibility with AF_XDP and QUIC.
- **Inputs**:
    - `device`: A constant character pointer representing the name of the network device to configure.
- **Logic and Control Flow**:
    - Initialize an `fd_ethtool_ioctl_t` structure `ioc` for the specified `device` using `fd_ethtool_ioctl_init` and check for initialization errors.
    - Disable the 'Generic Receive Offload' feature using [`fd_ethtool_ioctl_feature_gro_set`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_feature_gro_set>) to prevent UDP packet corruption.
    - Disable 'tx-gre-segmentation' and 'tx-gre-csum-segmentation' features using [`fd_ethtool_ioctl_feature_set`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_feature_set>) to avoid packet corruption when XDP is in use.
    - Finalize the `ioc` structure using [`fd_ethtool_ioctl_fini`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_fini>).
- **Output**: No return value; the function performs configuration changes on the specified network device.
- **Functions Called**:
    - [`fd_ethtool_ioctl_feature_gro_set`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_feature_gro_set>)
    - [`fd_ethtool_ioctl_feature_set`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_feature_set>)
    - [`fd_ethtool_ioctl_fini`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_fini>)


---
### init<!-- {{#callable:init}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/ethtool-offloads.c#L94>)

Initializes network devices by disabling certain ethtool features on bonded and non-bonded interfaces, including the loopback interface.
- **Inputs**:
    - `config`: A pointer to a constant `fd_config_t` structure that contains network configuration details, including the network interface to initialize.
- **Logic and Control Flow**:
    - Check if the network device specified in `config->net.interface` is bonded using [`device_is_bonded`](<#device_is_bonded>).
    - If the device is bonded, read the slave devices of the bonded interface using [`device_read_slaves`](<#device_read_slaves>).
    - Iterate over each slave device and call [`init_device`](<#init_device>) to initialize them.
    - If the device is not bonded, directly call [`init_device`](<#init_device>) on `config->net.interface`.
    - Call [`init_device`](<#init_device>) on the loopback interface `lo` to ensure it is also initialized.
- **Output**: No return value; the function performs initialization actions on network devices.
- **Functions Called**:
    - [`device_is_bonded`](<#device_is_bonded>)
    - [`device_read_slaves`](<#device_read_slaves>)
    - [`init_device`](<#init_device>)


---
### check\_device<!-- {{#callable:check_device}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/ethtool-offloads.c#L114>)

Checks if specific ethtool features are disabled on a network device.
- **Inputs**:
    - `device`: A constant character pointer representing the name of the network device to check.
- **Logic and Control Flow**:
    - Initialize an `fd_ethtool_ioctl_t` structure for the specified device using `fd_ethtool_ioctl_init`.
    - Check if the initialization of the `fd_ethtool_ioctl_t` structure failed and log an error if it did.
    - Test if the 'Generic Receive Offload' (GRO) feature is active using [`fd_ethtool_ioctl_feature_gro_test`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_feature_gro_test>).
    - Test if the 'tx-gre-segmentation' and 'tx-gre-csum-segmentation' features are active using [`fd_ethtool_ioctl_feature_test`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_feature_test>).
    - Finalize the `fd_ethtool_ioctl_t` structure using [`fd_ethtool_ioctl_fini`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_fini>).
    - If any of the features are active, log a 'not configured' error message indicating the feature should be disabled.
    - If all checks pass, return a successful configuration result using `CONFIGURE_OK`.
- **Output**: Returns a `configure_result_t` indicating whether the device is correctly configured with the required ethtool features disabled.
- **Functions Called**:
    - [`fd_ethtool_ioctl_feature_gro_test`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_feature_gro_test>)
    - [`fd_ethtool_ioctl_feature_test`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_feature_test>)
    - [`fd_ethtool_ioctl_fini`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_fini>)


---
### check<!-- {{#callable:check}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/ethtool-offloads.c#L141>)

Verifies the configuration of network devices to ensure certain ethtool features are disabled.
- **Inputs**:
    - ``config``: A pointer to a `fd_config_t` structure containing network configuration details.
- **Logic and Control Flow**:
    - Check if the network interface specified in `config` is bonded using [`device_is_bonded`](<#device_is_bonded>).
    - If bonded, read the slave devices of the bonded interface using [`device_read_slaves`](<#device_read_slaves>).
    - Iterate over each slave device and call [`check_device`](<#check_device>) to verify its configuration.
    - If not bonded, directly call [`check_device`](<#check_device>) on the specified network interface.
    - Always call [`check_device`](<#check_device>) on the loopback interface `lo`.
    - Return `CONFIGURE_OK()` to indicate successful configuration verification.
- **Output**: Returns a `configure_result_t` indicating the result of the configuration check.
- **Functions Called**:
    - [`device_is_bonded`](<#device_is_bonded>)
    - [`device_read_slaves`](<#device_read_slaves>)
    - [`check_device`](<#check_device>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)