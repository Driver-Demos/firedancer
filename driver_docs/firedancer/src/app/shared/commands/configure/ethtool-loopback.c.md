<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Disables "tx-udp-segmentation" offload on loopback interface for compatibility with AF_XDP.

# Purpose
The code is a configuration module designed to manage the "tx-udp-segmentation" offload feature on the loopback network interface using `ethtool`. It specifically disables this feature to ensure compatibility with AF_XDP, as enabling TX segmentation can cause AF_XDP to drop loopback UDP packets. The module is part of a larger configuration system, as indicated by its integration with `fd_config_t` and `fd_cap_chk_t` structures, which are likely defined in the included headers.

The module defines a `configure_stage_t` structure named `fd_cfg_stage_ethtool_loopback`, which includes several function pointers for managing the configuration stage. The [`enabled`](<#enabled>) function checks if the configuration should be applied based on the network namespace and provider settings. The [`init_perm`](<#init_perm>) function sets up necessary permissions, while the [`init`](<#init>) function performs the actual disabling of the "tx-udp-segmentation" feature using `ethtool` commands. The [`check`](<#check>) function verifies that the feature is disabled, ensuring the configuration is correct. This module is intended to be part of a broader system that configures network settings, particularly for environments using the XDP network stack.
# Imports and Dependencies

---
- `configure.h`
- `fd_ethtool_ioctl.h`


# Global Variables

---
### fd\_cfg\_stage\_ethtool\_loopback
- **Type**: ``configure_stage_t``
- **Description**: Defines a configuration stage for managing the ethtool settings on the loopback interface, specifically to disable the 'tx-udp-segmentation' offload feature. This configuration is necessary to ensure compatibility with AF_XDP, which does not support this feature when enabled.
- **Use**: Used to configure and manage the ethtool settings for the loopback interface, ensuring the 'tx-udp-segmentation' feature is disabled.


# Functions

---
### enabled<!-- {{#callable:enabled}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/ethtool-loopback.c#L14>)

Determines if the configuration should enable a feature based on network namespace and network stack provider.
- **Inputs**:
    - ``config``: A pointer to a constant `fd_config_t` structure that contains configuration settings.
- **Logic and Control Flow**:
    - Check if the `netns.enabled` field in the `development` section of `config` is true; if so, return 0.
    - Compare the `provider` field in the `net` section of `config` with the string "xdp"; if they are not equal, return 0.
    - If neither of the above conditions are met, return 1.
- **Output**: Returns an integer: 0 if the feature should not be enabled, or 1 if it should be enabled.


---
### init\_perm<!-- {{#callable:init_perm}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/ethtool-loopback.c#L27>)

Initializes permission checks for disabling the 'tx-udp-segmentation' offload on the loopback interface.
- **Inputs**:
    - `chk`: A pointer to an `fd_cap_chk_t` structure used for capability checks.
    - `config`: A pointer to a constant `fd_config_t` structure, marked as unused in this function.
- **Logic and Control Flow**:
    - Calls `fd_cap_chk_root` with `chk`, `NAME`, and a message to disable loopback `FD_ETHTOOL_FEATURE_TXUDPSEG`.
- **Output**: No return value; performs an action to initialize permission checks.


---
### init<!-- {{#callable:init}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/ethtool-loopback.c#L33>)

Disables the 'tx-udp-segmentation' offload on the loopback interface using ethtool.
- **Inputs**:
    - `config`: A pointer to a constant `fd_config_t` structure, which is not used in this function.
- **Logic and Control Flow**:
    - Declare a variable `ioc` of type `fd_ethtool_ioctl_t`.
    - Initialize `ioc` for the loopback interface 'lo' using `fd_ethtool_ioctl_init`.
    - If initialization fails, log an error and terminate the program.
    - Disable the 'tx-udp-segmentation' feature on the loopback interface using [`fd_ethtool_ioctl_feature_set`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_feature_set>).
    - Finalize the `ioc` using [`fd_ethtool_ioctl_fini`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_fini>).
- **Output**: No output is returned as the function is of type `void`.
- **Functions Called**:
    - [`fd_ethtool_ioctl_feature_set`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_feature_set>)
    - [`fd_ethtool_ioctl_fini`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_fini>)


---
### check<!-- {{#callable:check}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/ethtool-loopback.c#L44>)

Verifies if the 'tx-udp-segmentation' feature is disabled on the loopback interface.
- **Inputs**:
    - `config`: A pointer to a constant `fd_config_t` structure, which is not used in this function.
- **Logic and Control Flow**:
    - Initialize an `fd_ethtool_ioctl_t` structure `ioc` for the loopback interface 'lo'.
    - Check if the initialization of `ioc` fails, and log an error if it does.
    - Test if the 'tx-udp-segmentation' feature is active on the loopback interface using [`fd_ethtool_ioctl_feature_test`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_feature_test>).
    - Finalize the `ioc` structure using [`fd_ethtool_ioctl_fini`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_fini>).
    - If 'tx-udp-segmentation' is active, call `NOT_CONFIGURED` with an error message.
    - If 'tx-udp-segmentation' is not active, call `CONFIGURE_OK`.
- **Output**: Returns a `configure_result_t` indicating the configuration status of the loopback interface.
- **Functions Called**:
    - [`fd_ethtool_ioctl_feature_test`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_feature_test>)
    - [`fd_ethtool_ioctl_fini`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_fini>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)