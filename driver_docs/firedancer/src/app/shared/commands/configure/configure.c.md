<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements command-line argument parsing and execution for configuring Firedancer stages.

# Purpose
The code is a C module that provides functionality for configuring a system to run a software called Firedancer. It defines several functions to handle command-line arguments, execute configuration commands, and check system paths for correct permissions and ownership. The module supports three main commands: `init`, `check`, and `fini`, which correspond to initializing, checking, and finalizing the configuration stages, respectively. The [`configure_cmd_args`](<#configure_cmd_args>) function processes command-line arguments to determine the command and stages to execute. The [`configure_cmd_perm`](<#configure_cmd_perm>) function manages permissions for each stage based on the command. The [`configure_stage`](<#configure_stage>) function executes the appropriate actions for each stage, such as initializing or finalizing, and checks the configuration status.

The module also includes utility functions [`check_dir`](<#check_dir>) and [`check_file`](<#check_file>) to verify directory and file properties, such as ownership and permissions, using the [`check_path`](<#check_path>) function. The `fd_action_configure` structure defines the configuration action, including its name, argument processing function, execution function, permission function, and a description. This structure is likely used to integrate the configuration functionality into a larger system. The module is designed to ensure that the system is correctly configured to run Firedancer by checking and setting necessary permissions and configurations.
# Imports and Dependencies

---
- `configure.h`
- `errno.h`
- `sys/stat.h`


# Global Variables

---
### fd\_action\_configure
- **Type**: ``action_t``
- **Description**: Defines an action for configuring the local host to run Firedancer correctly. It includes the name of the action, the function pointers for handling arguments, execution, and permission checks, as well as descriptions for the action and permission errors.
- **Use**: Used to encapsulate the configuration action for Firedancer, including its execution logic and permission requirements.


# Functions

---
### configure\_cmd\_args<!-- {{#callable:configure_cmd_args}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/configure.c#L6>)

Parses command-line arguments to set the configuration command and stages for execution.
- **Inputs**:
    - `pargc`: A pointer to an integer representing the number of command-line arguments.
    - `pargv`: A pointer to an array of strings representing the command-line arguments.
    - `args`: A pointer to an `args_t` structure where the parsed command and stages will be stored.
- **Logic and Control Flow**:
    - Check if the number of arguments is less than 2; if so, log an error with usage information.
    - Compare the first argument to 'check', 'init', and 'fini' to set the corresponding command in `args->configure.command`; log an error if the command is unrecognized.
    - Decrement `pargc` and increment `pargv` to skip the command argument.
    - Iterate over the remaining arguments to check for the 'all' stage; if found, set all stages in `args->configure.stages` and return.
    - Initialize `nstage` to 0 and iterate over the remaining arguments to match them with known stages in `STAGES`; add matched stages to `args->configure.stages`.
    - Log an error if a stage is not recognized.
    - Decrement `pargc` and increment `pargv` for each processed stage argument.
- **Output**: No return value; modifies the `args` structure to store the parsed command and stages.


---
### configure\_cmd\_perm<!-- {{#callable:configure_cmd_perm}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/configure.c#L49>)

Executes permission-related operations for each configuration stage based on the specified command.
- **Inputs**:
    - ``args``: A pointer to an `args_t` structure that contains configuration command and stages.
    - ``chk``: A pointer to an `fd_cap_chk_t` structure used for permission checks.
    - ``config``: A constant pointer to a `config_t` structure that holds configuration data.
- **Logic and Control Flow**:
    - Iterates over each configuration stage in `args->configure.stages`.
    - Switches on `args->configure.command` to determine the operation to perform.
    - For `CONFIGURE_CMD_INIT`, checks if the stage is enabled and if the configuration check does not return `CONFIGURE_OK`. If so, calls `init_perm` if it exists.
    - For `CONFIGURE_CMD_CHECK`, no operation is performed.
    - For `CONFIGURE_CMD_FINI`, checks if the stage is enabled and if the configuration check does not return `CONFIGURE_NOT_CONFIGURED`. If so, calls `fini_perm` if it exists.
- **Output**: No return value; the function performs operations based on the configuration stages and command.


---
### configure\_stage<!-- {{#callable:configure_stage}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/configure.c#L73>)

Executes configuration commands on a given stage based on the specified command and configuration.
- **Inputs**:
    - `stage`: A pointer to a `configure_stage_t` structure representing the stage to configure.
    - `command`: A `configure_cmd_t` value indicating the command to execute (e.g., `CONFIGURE_CMD_INIT`, `CONFIGURE_CMD_CHECK`, `CONFIGURE_CMD_FINI`).
    - `config`: A pointer to a constant `config_t` structure containing the configuration data.
- **Logic and Control Flow**:
    - Checks if the stage is enabled using the `enabled` function pointer; if not enabled, logs a message and returns 0.
    - Switches on the `command` to determine the action to perform:
    - For `CONFIGURE_CMD_INIT`, checks the stage configuration, attempts to undo partial configurations if necessary, initializes the stage, and verifies the configuration.
    - For `CONFIGURE_CMD_CHECK`, checks the stage configuration and logs warnings if not configured or partially configured.
    - For `CONFIGURE_CMD_FINI`, checks the stage configuration, attempts to finalize the stage, and verifies the configuration.
- **Output**: Returns 0 on successful execution or 1 if the stage is not configured correctly during a check.


---
### configure\_cmd\_fn<!-- {{#callable:configure_cmd_fn}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/configure.c#L158>)

Executes configuration commands on specified stages based on the command type.
- **Inputs**:
    - `args`: A pointer to an `args_t` structure containing configuration command and stages.
    - `config`: A pointer to a `config_t` structure used for configuration.
- **Logic and Control Flow**:
    - Initialize an `error` variable to 0.
    - Check if the command is not `CONFIGURE_CMD_FINI`.
    - If true, iterate over each stage in `args->configure.stages` and call [`configure_stage`](<#configure_stage>) with the current stage, command, and config.
    - If [`configure_stage`](<#configure_stage>) returns a non-zero value, set `error` to 1.
    - If the command is `CONFIGURE_CMD_FINI`, count the number of stages in `args->configure.stages`.
    - If there is at least one stage, iterate over the stages in reverse order and call [`configure_stage`](<#configure_stage>) with each stage, command, and config.
    - If [`configure_stage`](<#configure_stage>) returns a non-zero value, set `error` to 1.
    - If `error` is non-zero, log an error message indicating failure to configure some stages.
- **Output**: No return value; logs an error if configuration of any stage fails.
- **Functions Called**:
    - [`configure_stage`](<#configure_stage>)


---
### check\_path<!-- {{#callable:check_path}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/configure.c#L181>)

Verifies if a given path matches expected user ID, group ID, mode, and type (file or directory).
- **Inputs**:
    - ``path``: A constant character pointer to the path that needs verification.
    - ``expected_uid``: An unsigned integer representing the expected user ID of the path.
    - ``expected_gid``: An unsigned integer representing the expected group ID of the path.
    - ``expected_mode``: An unsigned integer representing the expected mode (permissions) of the path.
    - ``expected_dir``: An integer indicating whether the path is expected to be a directory (non-zero) or a file (zero).
- **Logic and Control Flow**:
    - Use `stat` to retrieve the status of the path and store it in `st`.
    - If `stat` fails, check if the error is `ENOENT` (path does not exist) and call `PARTIALLY_CONFIGURED` with an appropriate message.
    - If the path is expected to be a directory but is not, call `PARTIALLY_CONFIGURED` with a message indicating the path is a file.
    - If the path is expected to be a file but is a directory, call `PARTIALLY_CONFIGURED` with a message indicating the path is a directory.
    - Check if the user ID of the path matches `expected_uid`; if not, call `PARTIALLY_CONFIGURED` with a message indicating the mismatch.
    - Check if the group ID of the path matches `expected_gid`; if not, call `PARTIALLY_CONFIGURED` with a message indicating the mismatch.
    - Check if the mode of the path matches `expected_mode`; if not, call `PARTIALLY_CONFIGURED` with a message indicating the mismatch.
    - If all checks pass, call `CONFIGURE_OK`.
- **Output**: Returns a `configure_result_t` indicating the result of the path verification.


---
### check\_dir<!-- {{#callable:check_dir}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/configure.c#L207>)

Checks if a directory at a given path has the specified user ID, group ID, and mode.
- **Inputs**:
    - `path`: A constant character pointer to the path of the directory to check.
    - `uid`: An unsigned integer representing the expected user ID of the directory.
    - `gid`: An unsigned integer representing the expected group ID of the directory.
    - `mode`: An unsigned integer representing the expected mode (permissions) of the directory.
- **Logic and Control Flow**:
    - Calls the [`check_path`](<#check_path>) function with the provided `path`, `uid`, `gid`, `mode`, and a fixed value of `1` for `expected_dir` to indicate that the path should be a directory.
- **Output**: Returns a `configure_result_t` indicating the result of the directory check.
- **Functions Called**:
    - [`check_path`](<#check_path>)


---
### check\_file<!-- {{#callable:check_file}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/configure.c#L215>)

Calls [`check_path`](<#check_path>) to verify the properties of a file at a given path.
- **Inputs**:
    - `path`: A constant character pointer to the file path to check.
    - `uid`: An unsigned integer representing the expected user ID of the file.
    - `gid`: An unsigned integer representing the expected group ID of the file.
    - `mode`: An unsigned integer representing the expected mode (permissions) of the file.
- **Logic and Control Flow**:
    - Calls the [`check_path`](<#check_path>) function with the provided `path`, `uid`, `gid`, and `mode` arguments.
    - Passes `0` as the `expected_dir` argument to [`check_path`](<#check_path>) to indicate that the path should be a file, not a directory.
- **Output**: Returns the result of the [`check_path`](<#check_path>) function, which is of type `configure_result_t`.
- **Functions Called**:
    - [`check_path`](<#check_path>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)