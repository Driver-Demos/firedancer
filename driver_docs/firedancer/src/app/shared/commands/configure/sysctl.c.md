<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Configures and checks kernel parameters in `/proc/sys` for network and file system settings.

# Purpose
The code is a C module designed to configure and verify system control parameters (`sysctl`) on a Linux system. It defines a set of kernel parameters that need to be set or checked to ensure the system operates within expected performance and functionality limits. The module includes structures and functions to initialize and check these parameters, ensuring they meet specified minimum or exact values. The parameters are organized into different categories, such as general system parameters, XDP (eXpress Data Path) specific parameters, and socket-related parameters.

The module defines a `configure_stage_t` structure named `fd_cfg_stage_sysctl`, which includes function pointers for initializing permissions, initializing parameters, and checking parameter values. The [`init_perm`](<#init_perm>) function checks for the necessary system capabilities to modify kernel parameters. The [`init`](<#init>) function sets the parameters based on the network provider type, while the [`check`](<#check>) function verifies that the parameters are correctly configured. The module uses utility functions from `fd_file_util.h` to read and write parameter values in the `/proc/sys` directory, and it logs errors or warnings if parameters are not set as expected.
# Imports and Dependencies

---
- `configure.h`
- `../../../platform/fd_file_util.h`
- `errno.h`
- `stdio.h`
- `linux/capability.h`


# Global Variables

---
### params
- **Type**: ``sysctl_param_t[]``
- **Description**: An array of `sysctl_param_t` structures that define kernel parameters to configure in the `/proc/sys` directory. Each element in the array specifies a path to a sysctl file, a value to set, a mode for enforcement, and whether the parameter can be missing.
- **Use**: Used to initialize and check kernel parameters during system configuration.


---
### xdp\_params
- **Type**: ``sysctl_param_t[]``
- **Description**: An array of `sysctl_param_t` structures that define kernel parameters related to XDP (eXpress Data Path) configuration. Each element in the array specifies a path to a sysctl file, a value to set, a mode for enforcement, and whether missing files are allowed.
- **Use**: Used to configure specific kernel parameters when the network provider is set to XDP.


---
### sock\_params
- **Type**: ``sysctl_param_t[]``
- **Description**: An array of `sysctl_param_t` structures that define kernel parameters related to socket buffer sizes. Each element in the array specifies a path to a sysctl file, a value, a mode for enforcement, and whether the parameter can be missing.
- **Use**: Used to configure and enforce minimum values for socket buffer sizes in the `/proc/sys/net/core` directory.


---
### fd\_cfg\_stage\_sysctl
- **Type**: ``configure_stage_t``
- **Description**: Defines a configuration stage for managing system control parameters (`sysctl`) in the Linux kernel. It includes function pointers for initialization, permission setting, and checking of system parameters.
- **Use**: Used to configure and verify system control parameters during the setup of a software environment.


# Data Structures

---
### sysctl\_param\_t
- **Type**: ``struct``
- **Members**:
    - `path`: Pointer to a constant character string that specifies the path to the sysctl parameter.
    - `value`: Unsigned long integer that holds the desired value for the sysctl parameter.
    - `mode`: Integer that indicates the mode of enforcement for the sysctl parameter value.
    - `allow_missing`: Integer flag that specifies if the absence of the sysctl parameter is permissible.
- **Description**: Defines a structure to represent a sysctl parameter, including its path, desired value, enforcement mode, and whether its absence is allowed. This structure is used to configure kernel parameters in the `/proc/sys` directory, ensuring that system settings meet specified requirements.


# Functions

---
### init\_perm<!-- {{#callable:init_perm}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/sysctl.c#L11>)

Initializes permissions by checking if the process has the capability to set kernel parameters in `/proc/sys`.
- **Inputs**:
    - `chk`: A pointer to an `fd_cap_chk_t` structure that represents the capability check context.
    - `config`: A pointer to a `config_t` structure, which is not used in this function.
- **Logic and Control Flow**:
    - Calls the `fd_cap_chk_cap` function with `chk`, `NAME`, `CAP_SYS_ADMIN`, and a description string to check if the process has the `CAP_SYS_ADMIN` capability.
- **Output**: No return value; the function performs a capability check.


---
### init\_param\_list<!-- {{#callable:init_param_list}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/sysctl.c#L104>)

Initializes system control parameters by reading and potentially modifying kernel parameters based on a given list.
- **Inputs**:
    - `list`: A pointer to an array of `sysctl_param_t` structures, each containing a path to a sysctl file, a value, a mode, and a flag indicating if missing files are allowed.
- **Logic and Control Flow**:
    - Iterates over each `sysctl_param_t` in the provided list until a null path is encountered.
    - For each parameter, attempts to read the current value from the sysctl file specified by `p->path`.
    - If reading fails and the file is missing, checks if `allow_missing` is true and continues to the next parameter if so.
    - Logs an error and exits if reading fails for other reasons.
    - Checks the `mode` of the parameter; if `ENFORCE_MINIMUM`, compares the current value with `p->value`.
    - If the current value is less than `p->value`, logs a notice to set the parameter and attempts to write the new value to the sysctl file.
    - Logs an error and exits if writing the new value fails.
- **Output**: No return value; modifies system state by setting kernel parameters as specified.


---
### init<!-- {{#callable:init}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/sysctl.c#L129>)

Initializes system parameters based on the network provider specified in the configuration.
- **Inputs**:
    - ``config``: A pointer to a `config_t` structure that contains network configuration details, including the network provider and socket buffer sizes.
- **Logic and Control Flow**:
    - Calls [`init_param_list`](<#init_param_list>) with the `params` array to initialize default system parameters.
    - Checks if the network provider in `config` is "xdp"; if true, calls [`init_param_list`](<#init_param_list>) with the `xdp_params` array.
    - If the network provider is "socket", sets the `sock_params` array values to the receive and send buffer sizes from `config`, then calls [`init_param_list`](<#init_param_list>) with the `sock_params` array.
- **Output**: No return value; the function operates by side effects on system parameters.
- **Functions Called**:
    - [`init_param_list`](<#init_param_list>)


---
### check\_param\_list<!-- {{#callable:check_param_list}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/sysctl.c#L141>)

Validates a list of system control parameters against expected values and logs warnings or errors if discrepancies are found.
- **Inputs**:
    - `list`: A pointer to an array of `sysctl_param_t` structures, each containing a path, expected value, mode, and a flag indicating if missing parameters are allowed.
- **Logic and Control Flow**:
    - Initialize a static variable `has_warned` to track if warnings have been issued.
    - Iterate over each `sysctl_param_t` in the `list` until a null `path` is encountered.
    - For each parameter, attempt to read its current value using `fd_file_util_read_ulong`.
    - If reading fails and the parameter is allowed to be missing (`allow_missing` is true) and the error is `ENOENT`, continue to the next parameter.
    - If reading fails for other reasons, log an error and exit.
    - Based on the `mode`, compare the current value to the expected value (`value`):
    - - If `ENFORCE_MINIMUM`, log an error and exit if the current value is less than expected.
    - - If `WARN_MINIMUM`, log a warning if the current value is less than expected and no warnings have been issued yet.
    - - If `WARN_EXACT`, log a warning if the current value does not match the expected value and no warnings have been issued yet.
    - Set `has_warned` to 1 after processing all parameters.
    - Return `CONFIGURE_OK()` to indicate successful completion.
- **Output**: Returns a `configure_result_t` indicating the result of the parameter checks, with `CONFIGURE_OK()` signaling success.


---
### check<!-- {{#callable:check}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/sysctl.c#L172>)

Validates system configuration parameters based on the network provider specified in the `config` structure.
- **Inputs**:
    - `config`: A pointer to a `config_t` structure containing network configuration details, including the network provider and socket buffer sizes.
- **Logic and Control Flow**:
    - Call [`check_param_list`](<#check_param_list>) with `params` to validate general system parameters.
    - If the result is not `CONFIGURE_OK`, return the result.
    - Check if the network provider is 'xdp'.
    - If 'xdp', call [`check_param_list`](<#check_param_list>) with `xdp_params`.
    - If the network provider is 'socket', set `sock_params` values from `config` and call [`check_param_list`](<#check_param_list>) with `sock_params`.
    - If the network provider is unknown, log an error message.
    - If the result from [`check_param_list`](<#check_param_list>) is not `CONFIGURE_OK`, return the result.
    - Return `CONFIGURE_OK` if all checks pass.
- **Output**: A `configure_result_t` structure indicating the success or failure of the configuration checks.
- **Functions Called**:
    - [`check_param_list`](<#check_param_list>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)