<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Configures network devices using ethtool, focusing on channel settings and XDP compatibility.

# Purpose
The code is a C module that configures network devices using the `ethtool` utility. It is designed to manage network device settings, specifically focusing on channel configurations and related features. The module includes functions to initialize, check, and finalize the configuration of network devices, particularly in environments where network namespaces and XDP (eXpress Data Path) are used. The code interacts with the system's network device files and uses `ioctl` calls to modify device settings.

Key components of the module include functions to determine if a device is bonded, read slave devices for bonded interfaces, and configure devices in either simple or dedicated mode. The module also checks if the device configuration is modified from its default state and ensures that the configuration is applied correctly. The `fd_cfg_stage_ethtool_channels` structure defines the configuration stage, including its name, enabling conditions, and the functions to initialize, finalize, and check the configuration. This module is intended to be part of a larger system that manages network configurations programmatically.
# Imports and Dependencies

---
- `configure.h`
- `errno.h`
- `stdio.h`
- `unistd.h`
- `sys/stat.h`
- `fd_ethtool_ioctl.h`


# Global Variables

---
### fd\_cfg\_stage\_ethtool\_channels
- **Type**: ``configure_stage_t``
- **Description**: Defines a configuration stage for managing network device settings using ethtool channels. It includes function pointers for enabling, initializing, finalizing, and checking the configuration state of network devices.
- **Use**: Used to manage the configuration of network devices through ethtool channels in a structured manner.


# Functions

---
### enabled<!-- {{#callable:enabled}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/ethtool-channels.c#L12>)

Determines if the network configuration should be enabled based on the network namespace and provider type.
- **Inputs**:
    - ``config``: A pointer to a constant `fd_config_t` structure containing configuration settings.
- **Logic and Control Flow**:
    - Check if the network namespace (`netns`) is enabled in the `config` structure; if true, return 0.
    - Compare the `provider` field in the `config` structure's `net` section to the string "xdp"; if they do not match, return 0.
    - If neither condition is met, return 1.
- **Output**: Returns an integer: 0 if the network configuration should not be enabled, or 1 if it should be enabled.


---
### init\_perm<!-- {{#callable:init_perm}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/ethtool-channels.c#L25>)

Initializes permissions for modifying network device configuration using ethtool.
- **Inputs**:
    - `chk`: A pointer to an `fd_cap_chk_t` structure that will be initialized.
    - `config`: A pointer to a constant `fd_config_t` structure, which is not used in this function.
- **Logic and Control Flow**:
    - Calls the function `fd_cap_chk_root` with `chk`, `NAME`, and a description string to initialize permissions.
- **Output**: No return value; the function operates on the `chk` parameter to set permissions.


---
### fini\_perm<!-- {{#callable:fini_perm}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/ethtool-channels.c#L31>)

Calls `fd_cap_chk_root` to modify network device configuration permissions with ethtool.
- **Inputs**:
    - `chk`: A pointer to an `fd_cap_chk_t` structure, which is used to check and manage capabilities.
    - `config`: A pointer to a constant `fd_config_t` structure, which is not used in this function.
- **Logic and Control Flow**:
    - Calls the function `fd_cap_chk_root` with `chk`, `NAME`, and a description string to modify network device configuration permissions.
    - The `config` parameter is marked as unused with `FD_PARAM_UNUSED`, indicating it is not used in the function body.
- **Output**: No return value, as the function is of type `void`.


---
### device\_is\_bonded<!-- {{#callable:device_is_bonded}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/ethtool-channels.c#L37>)

Checks if a network device is bonded by verifying the existence of a bonding directory in the device's sysfs path.
- **Inputs**:
    - `device`: A constant character pointer representing the name of the network device to check.
- **Logic and Control Flow**:
    - Constructs a file path string for the bonding directory of the specified device using `fd_cstr_printf_check`.
    - Calls `stat` on the constructed path to check if the directory exists.
    - If `stat` returns an error other than `ENOENT`, logs an error message and exits.
    - Returns true if the bonding directory exists, otherwise false.
- **Output**: Returns an integer indicating whether the device is bonded (1 if bonded, 0 if not).


---
### device\_read\_slaves<!-- {{#callable:device_read_slaves}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/ethtool-channels.c#L49>)

Reads the list of slave devices for a given network device and stores them in an array.
- **Inputs**:
    - `device`: A string representing the name of the network device to read the slave devices from.
    - `output`: A character array of size 4096 to store the output from reading the slave devices.
    - `devices`: An array of 16 string pointers to store the names of the slave devices.
- **Logic and Control Flow**:
    - Constructs the file path to the bonding slaves file for the given device.
    - Opens the file at the constructed path for reading.
    - If the file cannot be opened, logs an error and exits.
    - Reads a line from the file into the `output` buffer.
    - If reading fails, logs an error and exits.
    - Checks for end-of-file or read errors and logs an error if any are encountered.
    - Ensures the read line is not too long or empty, logging an error if it is.
    - Closes the file and logs an error if closing fails.
    - Removes the newline character from the end of the `output` string.
    - Tokenizes the `output` string using space and tab as delimiters, storing each token in the `devices` array.
    - Ensures that at least one device is found, logging an error if none are found.
- **Output**: The `devices` array is populated with the names of the slave devices, and the `output` buffer contains the raw line read from the file without the trailing newline.


---
### init\_device<!-- {{#callable:init_device}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/ethtool-channels.c#L81>)

Configures a network device using ethtool in either simple or dedicated mode, with optional strict error handling.
- **Inputs**:
    - `device`: A string representing the name of the network device to configure.
    - `config`: A pointer to a `fd_config_t` structure containing configuration details for the network device.
    - `dedicated_mode`: An integer flag indicating whether to configure the device in dedicated mode (non-zero) or simple mode (zero).
    - `strict`: An integer flag indicating whether to enforce strict error handling (non-zero) or not (zero).
- **Logic and Control Flow**:
    - Checks if either `dedicated_mode` or `strict` is true using `FD_TEST` macro.
    - Initializes an `fd_ethtool_ioctl_t` structure for the device and logs an error if initialization fails.
    - Sets the default receive flow hash (rxfh) configuration using [`fd_ethtool_ioctl_rxfh_set_default`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_rxfh_set_default>).
    - Determines the number of channels to set based on `dedicated_mode` and attempts to set it using [`fd_ethtool_ioctl_channels_set_num`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_channels_set_num>).
    - Handles errors in setting the number of channels, logging detailed error messages if `strict` is true.
    - Clears existing ntuple rules using [`fd_ethtool_ioctl_ntuple_clear`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_ntuple_clear>).
    - If `dedicated_mode` is true, isolates queue 0 and enables the ntuple feature, logging errors if `strict` is true.
    - Configures UDP destination port ntuple rules based on the configuration, with additional rules if `config->is_firedancer` is true.
    - Returns 0 on success or 1 on failure, depending on the `strict` flag.
- **Output**: Returns 0 on successful configuration or 1 on failure, depending on the `strict` flag.
- **Functions Called**:
    - [`fd_ethtool_ioctl_rxfh_set_default`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_rxfh_set_default>)
    - [`fd_ethtool_ioctl_channels_set_num`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_channels_set_num>)
    - [`fd_ethtool_ioctl_ntuple_clear`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_ntuple_clear>)
    - [`fd_ethtool_ioctl_rxfh_set_suffix`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_rxfh_set_suffix>)
    - [`fd_ethtool_ioctl_feature_set`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_feature_set>)
    - [`fd_ethtool_ioctl_ntuple_set_udp_dport`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_ntuple_set_udp_dport>)


---
### init<!-- {{#callable:init}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/ethtool-channels.c#L148>)

Initializes network device configuration based on the specified RSS queue mode and device bonding status.
- **Inputs**:
    - `config`: A pointer to a `fd_config_t` structure containing network configuration settings.
- **Logic and Control Flow**:
    - Determine if the RSS queue mode is 'dedicated' or 'auto' and set `only_dedicated` and `try_dedicated` flags accordingly.
    - Check if the device is bonded using [`device_is_bonded`](<#device_is_bonded>) and read slave devices if bonded.
    - If `try_dedicated` is true, attempt to initialize devices in dedicated mode using [`init_device`](<#init_device>). If initialization fails and the mode is 'auto', log a warning and fall back to simple mode.
    - If the device is bonded, iterate over each bonded device and initialize them in simple mode using [`init_device`](<#init_device>). Otherwise, initialize the main device in simple mode.
- **Output**: No return value; the function configures network devices as specified.
- **Functions Called**:
    - [`device_is_bonded`](<#device_is_bonded>)
    - [`device_read_slaves`](<#device_read_slaves>)
    - [`init_device`](<#init_device>)


---
### check\_device\_is\_modified<!-- {{#callable:check_device_is_modified}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/ethtool-channels.c#L193>)

Checks if a network device's configuration has been modified from its default state using ethtool.
- **Inputs**:
    - `device`: A constant character pointer representing the name of the network device to check.
- **Logic and Control Flow**:
    - Initialize an `fd_ethtool_ioctl_t` structure with the given device name using `fd_ethtool_ioctl_init` and ensure it is successful.
    - Retrieve the current and maximum number of channels using [`fd_ethtool_ioctl_channels_get_num`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_channels_get_num>) and compare them; return 1 if they differ.
    - Get the RX flow hash (RXFH) queue count using [`fd_ethtool_ioctl_rxfh_get_queue_cnt`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_rxfh_get_queue_cnt>).
    - Retrieve the RXFH table and its element count using [`fd_ethtool_ioctl_rxfh_get_table`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_rxfh_get_table>).
    - Iterate over the RXFH table and check if each element matches an incrementing queue index; return 1 if any element does not match.
    - Validate if the ntuple rules for UDP destination ports are empty using [`fd_ethtool_ioctl_ntuple_validate_udp_dport`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_ntuple_validate_udp_dport>); return 1 if they are not empty.
    - Return 0 if none of the above conditions indicate a modification.
- **Output**: Returns an integer: 1 if the device configuration is modified, 0 if it is not.
- **Functions Called**:
    - [`fd_ethtool_ioctl_channels_get_num`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_channels_get_num>)
    - [`fd_ethtool_ioctl_rxfh_get_queue_cnt`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_rxfh_get_queue_cnt>)
    - [`fd_ethtool_ioctl_rxfh_get_table`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_rxfh_get_table>)
    - [`fd_ethtool_ioctl_ntuple_validate_udp_dport`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_ntuple_validate_udp_dport>)


---
### check\_device\_is\_configured<!-- {{#callable:check_device_is_configured}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/ethtool-channels.c#L221>)

Checks if a network device is configured correctly based on the given configuration and mode.
- **Inputs**:
    - `device`: A constant character pointer representing the name of the network device to check.
    - `config`: A constant pointer to an `fd_config_t` structure containing the configuration details for the device.
    - `dedicated_mode`: An integer indicating whether the device should be checked in dedicated mode (non-zero) or not (zero).
- **Logic and Control Flow**:
    - Initialize an `fd_ethtool_ioctl_t` structure for the device and check for initialization errors.
    - Retrieve the current number of channels using [`fd_ethtool_ioctl_channels_get_num`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_channels_get_num>) and compare it with the expected number based on `dedicated_mode` or `config->layout.net_tile_count`.
    - Get the RX flow hash (RXFH) queue count and table, and verify the table entries against the expected values based on `dedicated_mode`.
    - If `dedicated_mode` is true, check if the n-tuple feature is active using [`fd_ethtool_ioctl_feature_test`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_feature_test>).
    - If `dedicated_mode` is false, validate that the n-tuple rules are empty using [`fd_ethtool_ioctl_ntuple_validate_udp_dport`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_ntuple_validate_udp_dport>).
    - If `dedicated_mode` is true, validate specific UDP destination ports using [`fd_ethtool_ioctl_ntuple_validate_udp_dport`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_ntuple_validate_udp_dport>) with a list of ports from the configuration.
- **Output**: Returns 1 if the device is configured correctly, otherwise returns 0.
- **Functions Called**:
    - [`fd_ethtool_ioctl_channels_get_num`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_channels_get_num>)
    - [`fd_ethtool_ioctl_rxfh_get_queue_cnt`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_rxfh_get_queue_cnt>)
    - [`fd_ethtool_ioctl_rxfh_get_table`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_rxfh_get_table>)
    - [`fd_ethtool_ioctl_feature_test`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_feature_test>)
    - [`fd_ethtool_ioctl_ntuple_validate_udp_dport`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_ntuple_validate_udp_dport>)


---
### check<!-- {{#callable:check}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/ethtool-channels.c#L279>)

Checks the network device configuration for dedicated or simple mode and reports the configuration status.
- **Inputs**:
    - ``config``: A pointer to a constant `fd_config_t` structure containing network configuration details.
- **Logic and Control Flow**:
    - Determine if the RSS queue mode is 'dedicated' or 'auto' with a single network tile, setting `check_dedicated` accordingly.
    - Check if the network device is bonded using [`device_is_bonded`](<#device_is_bonded>).
    - If the device is bonded, read the slave devices using [`device_read_slaves`](<#device_read_slaves>).
    - If `check_dedicated` is true, verify if the device(s) are configured in dedicated mode using [`check_device_is_configured`](<#check_device_is_configured>). If configured, call `CONFIGURE_OK()`.
    - If not only in dedicated mode, verify if the device(s) are configured in simple mode using [`check_device_is_configured`](<#check_device_is_configured>). If configured, call `CONFIGURE_OK()`.
    - Check if the device(s) have been modified from the default state using [`check_device_is_modified`](<#check_device_is_modified>). If modified, call `PARTIALLY_CONFIGURED()` with a message.
    - If none of the above conditions are met, call `NOT_CONFIGURED()` with a message.
- **Output**: Returns a `configure_result_t` indicating the configuration status of the network device.
- **Functions Called**:
    - [`device_is_bonded`](<#device_is_bonded>)
    - [`device_read_slaves`](<#device_read_slaves>)
    - [`check_device_is_configured`](<#check_device_is_configured>)
    - [`check_device_is_modified`](<#check_device_is_modified>)


---
### fini\_device<!-- {{#callable:fini_device}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/ethtool-channels.c#L329>)

Resets a network device to its default state and checks if any configuration changes occurred.
- **Inputs**:
    - `device`: A constant character pointer representing the name of the network device to be reset.
- **Logic and Control Flow**:
    - Initialize an `fd_ethtool_ioctl_t` structure for the specified device using `fd_ethtool_ioctl_init`.
    - Check the initial state of the device by retrieving the number of channels, RXFH table, and ntuple rules using [`fd_ethtool_ioctl_channels_get_num`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_channels_get_num>), [`fd_ethtool_ioctl_rxfh_get_table`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_rxfh_get_table>), and [`fd_ethtool_ioctl_ntuple_validate_udp_dport`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_ntuple_validate_udp_dport>) respectively.
    - Log an error and exit if any of the initial state retrievals fail.
    - Set the RXFH table to its default state using [`fd_ethtool_ioctl_rxfh_set_default`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_rxfh_set_default>).
    - Set the number of channels to the maximum allowed using [`fd_ethtool_ioctl_channels_set_num`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_channels_set_num>).
    - Reset the RXFH table to its default state again to ensure even distribution.
    - Clear ntuple rules using [`fd_ethtool_ioctl_ntuple_clear`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_ntuple_clear>), leaving the ntuple feature flag unchanged.
    - Log an error and exit if any of the reset operations fail.
    - Retrieve the final state of the device using the same methods as for the initial state.
    - Finalize the `fd_ethtool_ioctl_t` structure using [`fd_ethtool_ioctl_fini`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_fini>).
    - Compare the initial and final states to determine if any configuration changes occurred.
- **Output**: Returns an integer indicating whether the device configuration was modified (1 if modified, 0 if not).
- **Functions Called**:
    - [`fd_ethtool_ioctl_channels_get_num`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_channels_get_num>)
    - [`fd_ethtool_ioctl_rxfh_get_table`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_rxfh_get_table>)
    - [`fd_ethtool_ioctl_ntuple_validate_udp_dport`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_ntuple_validate_udp_dport>)
    - [`fd_ethtool_ioctl_rxfh_set_default`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_rxfh_set_default>)
    - [`fd_ethtool_ioctl_channels_set_num`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_channels_set_num>)
    - [`fd_ethtool_ioctl_ntuple_clear`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_ntuple_clear>)
    - [`fd_ethtool_ioctl_fini`](<fd_ethtool_ioctl.c.md#fd_ethtool_ioctl_fini>)


---
### fini<!-- {{#callable:fini}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/ethtool-channels.c#L387>)

Finalizes the network device configuration by resetting bonded or standalone devices to their default state.
- **Inputs**:
    - ``config``: A pointer to a constant `fd_config_t` structure containing network configuration details.
    - ``pre_init``: An integer flag that is unused in this function.
- **Logic and Control Flow**:
    - Initialize `done` to 0 to track if any device configuration was modified.
    - Check if the network device specified in `config->net.interface` is bonded using [`device_is_bonded`](<#device_is_bonded>).
    - If the device is bonded, read the slave devices into `bond_devices` using [`device_read_slaves`](<#device_read_slaves>).
    - Iterate over each bonded device in `bond_devices` and call [`fini_device`](<#fini_device>) on each, updating `done` with the result using bitwise OR.
    - If the device is not bonded, call [`fini_device`](<#fini_device>) on the standalone device specified in `config->net.interface` and assign the result to `done`.
    - Return the value of `done`, indicating if any device configuration was modified.
- **Output**: Returns an integer indicating if any device configuration was modified (non-zero if modified, zero if not).
- **Functions Called**:
    - [`device_is_bonded`](<#device_is_bonded>)
    - [`device_read_slaves`](<#device_read_slaves>)
    - [`fini_device`](<#fini_device>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)