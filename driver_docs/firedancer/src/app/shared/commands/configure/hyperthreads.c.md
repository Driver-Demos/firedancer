<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Configures and checks hyperthreading settings for CPU tiles, issuing warnings if performance may be reduced.

# Purpose
The code is a C source file that defines a configuration stage for managing hyperthreading in a system topology. It includes the header file `configure.h` and a specific topology header `fd_cpu_topo.h`, indicating its reliance on external configuration and topology structures. The primary functionality of this code is to check the status of hyperthread pairs associated with specific CPU tiles, such as "pack" and "poh", within a given system configuration. It uses functions like [`determine_ht_pair`](<#determine_ht_pair>) and [`determine_cpu_used`](<#determine_cpu_used>) to identify and verify the usage and online status of these hyperthread pairs.

The [`check`](<#check>) function is the core component of this module, performing the validation of hyperthread pairs and issuing warnings if certain conditions are met, such as when a hyperthread pair is used by another tile or should be offline. The results of these checks are encapsulated in the `fd_cfg_stage_hyperthreads` structure, which defines a configuration stage with a name, and a [`check`](<#check>) function pointer. This structure is likely intended to be part of a larger configuration management system, where it can be used to ensure optimal performance by managing hyperthreading configurations.
# Imports and Dependencies

---
- `configure.h`
- `../../../../disco/topo/fd_cpu_topo.h`


# Global Variables

---
### fd\_cfg\_stage\_hyperthreads
- **Type**: ``configure_stage_t``
- **Description**: Defines a configuration stage for managing hyperthreading settings. It includes a name, a flag for recreation, and a function pointer for checking the configuration.
- **Use**: Used to configure and verify hyperthreading settings in a system.


# Functions

---
### determine\_ht\_pair<!-- {{#callable:determine_ht_pair}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/hyperthreads.c#L7>)

Finds the hyperthread pair for a given tile kind and ID in the CPU topology.
- **Inputs**:
    - `config`: A pointer to a `config_t` structure that contains the CPU topology information.
    - `cpus`: A pointer to a `fd_topo_cpus_t` structure that contains CPU information, including hyperthread pairs.
    - `kind`: A string representing the type of tile to find in the topology.
    - `kind_id`: An unsigned long integer representing the ID of the tile kind to find.
- **Logic and Control Flow**:
    - Call `fd_topo_find_tile` with `config->topo`, `kind`, and `kind_id` to find the index of the tile in the topology.
    - Check if `tile_idx` is not `ULONG_MAX` to ensure a valid tile index was found.
    - If valid, retrieve the tile from `config->topo.tiles` using `tile_idx`.
    - Check if `tile->cpu_idx` is not `ULONG_MAX` to ensure a valid CPU index is present.
    - If valid, return the sibling CPU index from `cpus->cpu[tile->cpu_idx].sibling`.
    - If any check fails, return `ULONG_MAX` to indicate an invalid or non-existent hyperthread pair.
- **Output**: Returns the sibling CPU index of the tile's CPU if found, otherwise returns `ULONG_MAX`.


---
### determine\_cpu\_used<!-- {{#callable:determine_cpu_used}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/hyperthreads.c#L20>)

Checks if a given CPU index is used by any tile in the configuration.
- **Inputs**:
    - `config`: A pointer to a `config_t` structure that contains the topology information of the system.
    - `cpu_idx`: An unsigned long integer representing the CPU index to check.
- **Logic and Control Flow**:
    - Check if `cpu_idx` is equal to `ULONG_MAX`; if true, return 0.
    - Retrieve the number of tiles from `config->topo.tile_cnt`.
    - Iterate over each tile in `config->topo.tiles`.
    - For each tile, check if `tile->cpu_idx` is equal to `cpu_idx`; if true, return 1.
    - If no tile matches `cpu_idx`, return 0.
- **Output**: Returns 1 if the CPU index is used by any tile, otherwise returns 0.


---
### check<!-- {{#callable:check}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/hyperthreads.c#L33>)

Checks the configuration for hyperthread pairs and logs warnings if they are used or online when they should not be.
- **Inputs**:
    - `config`: A pointer to a `config_t` structure containing the topology configuration.
- **Logic and Control Flow**:
    - Initialize a static integer `has_warned` to track if a warning has been logged.
    - Initialize an array `cpus` of type `fd_topo_cpus_t` and call `fd_topo_cpus_init` to populate it.
    - Find the tile indices for 'pack' and 'poh' using `fd_topo_find_tile`.
    - Determine the hyperthread pairs for 'pack' and 'poh' using [`determine_ht_pair`](<#determine_ht_pair>).
    - Check if the hyperthread pairs are used by other tiles using [`determine_cpu_used`](<#determine_cpu_used>).
    - Iterate over the CPUs to check if the hyperthread pairs are online when they should not be.
    - Log warnings if the hyperthread pairs are used or online, but only if `has_warned` is false.
    - Set `has_warned` to true to prevent further warnings.
    - Return `CONFIGURE_OK()` to indicate successful configuration check.
- **Output**: Returns a `configure_result_t` indicating the result of the configuration check, specifically `CONFIGURE_OK()`.
- **Functions Called**:
    - [`determine_ht_pair`](<#determine_ht_pair>)
    - [`determine_cpu_used`](<#determine_cpu_used>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)