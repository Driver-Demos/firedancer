<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Manages the configuration and mounting of hugetlbfs filesystems, including permission checks and error handling.

# Purpose
The code is a C module that manages the configuration and setup of `hugetlbfs` filesystems, which are used for handling huge pages in Linux. It includes functions to initialize and finalize permissions ([`init_perm`](<#init_perm>) and [`fini_perm`](<#fini_perm>)), set up the huge pages ([`init`](<#init>)), and check the current configuration ([`check`](<#check>)). The module interacts with system files and directories to ensure that the required huge pages are available and properly mounted. It also handles potential errors and logs necessary actions to be taken by the user.

The module defines paths and sizes for different types of huge pages and uses these to configure the system's memory management. It checks the number of available pages and attempts to increase them if necessary, while also handling memory compaction and cache dropping to mitigate fragmentation issues. The code includes error handling and logging to guide users in resolving configuration issues. The `fd_cfg_stage_hugetlbfs` structure at the end of the file defines the stage name and associates the relevant functions for managing the `hugetlbfs` configuration.
# Imports and Dependencies

---
- `configure.h`
- `../../../platform/fd_file_util.h`
- `../../../platform/fd_sys_util.h`
- `unistd.h`
- `errno.h`
- `stdio.h`
- `stdlib.h`
- `dirent.h`
- `sys/stat.h`
- `sys/mount.h`
- `linux/capability.h`


# Global Variables

---
### TOTAL\_HUGE\_PAGE\_PATH
- **Type**: ``char const *[2]``
- **Description**: Contains two file paths as strings, each representing a path to a system file that tracks the number of huge pages on a NUMA node. The paths are formatted to include a placeholder for the NUMA node number.
- **Use**: Used to access and modify the total number of huge pages available on specific NUMA nodes.


---
### FREE\_HUGE\_PAGE\_PATH
- **Type**: ``static char const *``
- **Description**: An array of two constant character pointers that store file paths to the free huge pages information for different page sizes on a NUMA node. The paths are formatted strings that include a placeholder for the NUMA node number.
- **Use**: Used to construct file paths for reading the number of free huge pages on a specific NUMA node.


---
### PAGE\_SIZE
- **Type**: ``ulong[2]``
- **Description**: Defines an array with two elements representing the sizes of huge pages in bytes. The first element is 2 MiB (2097152 bytes), and the second element is 1 GiB (1073741824 bytes).
- **Use**: Used to specify the page sizes for huge and gigantic pages in memory management operations.


---
### PAGE\_NAMES
- **Type**: ``static char const *``
- **Description**: An array of constant character pointers that contains the names of two types of pages: "huge" and "gigantic". These names correspond to different page sizes used in the system.
- **Use**: Used to reference the type of page (huge or gigantic) in logging and error messages.


---
### fd\_cfg\_stage\_hugetlbfs
- **Type**: ``configure_stage_t``
- **Description**: Defines a configuration stage for managing `hugetlbfs` in the system. It includes function pointers for initialization, finalization, and permission management specific to `hugetlbfs`.
- **Use**: Used to configure and manage the lifecycle of `hugetlbfs` mounts, including setting permissions and checking configurations.


# Functions

---
### init\_perm<!-- {{#callable:init_perm}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/hugetlbfs.c#L15>)

Initializes permissions for `hugetlbfs` by checking root and capability permissions.
- **Inputs**:
    - `chk`: A pointer to `fd_cap_chk_t` structure used for capability checking.
    - `config`: A constant pointer to `config_t` structure, marked as unused in this function.
- **Logic and Control Flow**:
    - Calls `fd_cap_chk_root` to check if the root permissions are sufficient for increasing hugepages.
    - Calls `fd_cap_chk_cap` to check if the `CAP_SYS_ADMIN` capability is available for mounting `hugetlbfs` filesystems.
- **Output**: No return value; the function operates through side effects on the `chk` parameter.


---
### fini\_perm<!-- {{#callable:fini_perm}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/hugetlbfs.c#L22>)

Checks and removes permissions related to `hugetlbfs` by removing directories and unmounting filesystems.
- **Inputs**:
    - `chk`: A pointer to an `fd_cap_chk_t` structure used for capability checking.
    - `config`: A constant pointer to a `config_t` structure, marked as unused in this function.
- **Logic and Control Flow**:
    - Calls `fd_cap_chk_root` to check root permissions for removing directories from `/mnt` related to `hugetlbfs`.
    - Calls `fd_cap_chk_cap` to check for `CAP_SYS_ADMIN` capability to unmount `hugetlbfs` filesystems.
- **Output**: No return value as the function is of type `void`.


---
### init<!-- {{#callable:init}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/hugetlbfs.c#L49>)

Configures and mounts hugetlbfs for huge and gigantic pages on NUMA nodes based on the provided configuration.
- **Inputs**:
    - ``config``: A pointer to a `config_t` structure containing configuration details for hugetlbfs, including mount paths and page settings.
- **Logic and Control Flow**:
    - Initialize `mount_path` array with huge and gigantic page mount paths from `config`.
    - Get the number of NUMA nodes using `fd_shmem_numa_cnt()`.
    - For each NUMA node, calculate the required number of huge and gigantic pages using `fd_topo_huge_page_cnt()` and `fd_topo_gigantic_page_cnt()`.
    - For each page type (huge and gigantic), check the number of free pages using `fd_file_util_read_uint()` and compare it with the required pages.
    - If free pages are less than required and increasing hugepage reservations is allowed, calculate additional pages needed and attempt to increase the total pages using `fd_file_util_write_uint()`.
    - If memory is fragmented, attempt to compact memory and drop caches using `/proc/sys/vm/compact_memory` and `/proc/sys/vm/drop_caches`.
    - Calculate the minimum size required for each page type across all NUMA nodes.
    - Create directories for hugetlbfs mounts using `fd_file_util_mkdir_all()` and set permissions using `chown()` and `chmod()`.
    - Mount hugetlbfs with the calculated options using `mount()`.
- **Output**: No return value; the function performs configuration and setup operations for hugetlbfs.


---
### cmdline<!-- {{#callable:cmdline}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/hugetlbfs.c#L183>)

Reads the command line arguments of the current process from `/proc/self/cmdline` into a buffer.
- **Inputs**:
    - ``buf``: A character buffer where the function will store the command line arguments.
    - ``buf_sz``: The size of the buffer `buf`, which determines the maximum number of characters to read.
- **Logic and Control Flow**:
    - Open the file `/proc/self/cmdline` in read mode.
    - If the file cannot be opened, log an error and terminate the program.
    - Read up to `buf_sz - 1` bytes from the file into the buffer `buf`.
    - If an error occurs during reading, log an error and terminate the program.
    - Close the file and log an error if closing fails.
    - Terminate the string in `buf` with a null character at the position of the last read byte.
- **Output**: The function does not return a value; it modifies the buffer `buf` to contain the command line arguments as a null-terminated string.


---
### warn\_mount\_users<!-- {{#callable:warn_mount_users}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/hugetlbfs.c#L196>)

Checks for processes with open file descriptors in a specified mount path and logs warnings if found.
- **Inputs**:
    - `mount_path`: A constant character pointer to the mount path to check for open file descriptors.
- **Logic and Control Flow**:
    - Opens the `/proc` directory to read process entries.
    - Iterates over each entry in the `/proc` directory, skipping `.` and `..` entries.
    - Converts each directory name to a process ID (`pid`) and skips non-numeric entries.
    - Constructs the path to the process's memory maps file (`/proc/<pid>/maps`).
    - Opens the memory maps file and reads it line by line.
    - Checks each line for the presence of the specified `mount_path`.
    - Logs a warning if a line contains the `mount_path`, indicating an open file descriptor.
    - Handles errors in opening, reading, and closing files with error logging.
    - Closes the directory stream after processing all entries.
- **Output**: No return value; logs warnings for processes with open file descriptors in the specified mount path.
- **Functions Called**:
    - [`cmdline`](<#cmdline>)


---
### fini<!-- {{#callable:fini}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/hugetlbfs.c#L234>)

Unmounts and removes hugetlbfs mount directories specified in the configuration.
- **Inputs**:
    - ``config``: A pointer to a `config_t` structure containing the paths for hugetlbfs mount directories.
    - ``pre_init``: An integer that is not used in the function.
- **Logic and Control Flow**:
    - Initialize `normal_page_mount_path` using the `mount_path` from `config`.
    - Create an array `mount_path` containing paths for huge, gigantic, and normal page mounts.
    - Iterate over each path in `mount_path`.
    - For each path, open `/proc/self/mounts` to read the current mounts.
    - Check each line in `/proc/self/mounts` to see if it contains the current `mount_path`.
    - If found, attempt to unmount the path using `umount`.
    - If `umount` fails due to `EBUSY`, call [`warn_mount_users`](<#warn_mount_users>) and log an error.
    - If `umount` fails for other reasons, log an error with the specific error code.
    - After processing `/proc/self/mounts`, close the file and check for errors.
    - Attempt to remove the directory at the current `mount_path` using `rmdir`.
    - Log an error if `rmdir` fails for reasons other than `ENOENT`.
    - After processing all paths in `mount_path`, attempt to remove the main `mount_path` from `config`.
    - Log an error if removing the main `mount_path` fails for reasons other than `ENOENT`.
- **Output**: Returns 1 after attempting to unmount and remove the specified directories.
- **Functions Called**:
    - [`warn_mount_users`](<#warn_mount_users>)


---
### check<!-- {{#callable:check}} -->
[View Source →](<../../../../../../../src/app/shared/commands/configure/hugetlbfs.c#L292>)

Validates the configuration and existence of hugetlbfs mount points and their properties.
- **Inputs**:
    - `config`: A pointer to a `config_t` structure containing configuration details for hugetlbfs, including mount paths, user ID, and group ID.
- **Logic and Control Flow**:
    - Initialize `mount_path` and `MOUNT_PAGE_SIZE` arrays with paths and page sizes for huge and gigantic pages.
    - Calculate the required minimum size for each page type across all NUMA nodes using `fd_shmem_numa_cnt`, `fd_topo_huge_page_cnt`, and `fd_topo_gigantic_page_cnt`.
    - Use `stat` to check the existence of the mount paths and handle errors or non-existence with `PARTIALLY_CONFIGURED` or `NOT_CONFIGURED` macros.
    - Verify directory permissions for the mount paths using [`check_dir`](<configure.c.md#check_dir>).
    - Open `/proc/self/mounts` to read and verify mount details for each path, checking device, path, type, options, and minimum size.
    - Use `strtok_r` to parse mount options and validate them against expected values, logging errors with `FD_LOG_ERR` and using `PARTIALLY_CONFIGURED` for mismatches.
    - Close the file pointer and handle errors during file operations.
    - Call `CONFIGURE_OK` if all checks pass.
- **Output**: Returns a `configure_result_t` indicating the configuration status of the hugetlbfs mount points.
- **Functions Called**:
    - [`check_dir`](<configure.c.md#check_dir>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)