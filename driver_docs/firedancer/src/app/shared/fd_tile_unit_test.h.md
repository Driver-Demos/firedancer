<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Framework for unit testing Firedancer tiles, including initialization, link management, and test execution.

# Purpose
This C header file provides a framework for unit testing Firedancer tiles in a single-threaded environment. It defines structures and functions to facilitate the testing of tile state transitions across various callbacks, such as `before/after_credit` and `before/during/after_frag`. The file includes a function [`fd_tile_unit_test_init`](<#fd_tile_unit_test_init>) to initialize the testing environment by loading configuration paths and setting up the topology relevant to the tile under test. It also defines structures like `fd_tile_test_link_t` and `fd_tile_test_ctx_t` to model communication channels and maintain test context, respectively. The framework allows for the definition of custom test callbacks and provides functions to initialize input and output links, update callbacks, reset the test environment, and execute the main test loop. This setup enables the testing of tile-specific logic and communication within a simulated production-like topology.
# Imports and Dependencies

---
- `../../app/shared/fd_config.h`


# Data Structures

---
### fd\_tile\_test\_link\_t
- **Type**: ``struct``
- **Members**:
    - ``mcache``: Pointer to the metadata cache of the link.
    - ``dcache``: Pointer to the data cache of the link.
    - ``depth``: Depth of the link.
    - ``base``: Base address of the data cache.
    - ``chunk0``: Initial chunk of the data cache.
    - ``wmark``: Watermark for the data cache chunks.
    - ``chunk``: Current chunk, initialized to `chunk0`.
    - ``in_idx``: Index of the link in the context if it is an input link, otherwise `ULONG_MAX`.
    - ``prod_seq``: Sequence number of the newly produced fragment.
    - ``cons_seq``: Sequence number of the currently processing fragment.
    - ``is_input_link``: Indicates if the link is an input/producer/upstream link.
    - ``publish``: Callback to publish a fragment.
    - ``make_sig``: Callback to make a signature for the published fragment.
    - ``before_frag_check``: Callback to check before fragment processing.
    - ``during_frag_check``: Callback to check during fragment processing.
    - ``after_frag_check``: Callback to check after fragment processing.
    - ``output_verifier``: Callback to verify an output for output/consumer/downstream link.
- **Description**: Models the Firedancer communication channels between tiles, representing an input/output link for the tile under test. The structure is used in unit testing to simulate and verify the behavior of tile communication links, with fields for managing metadata and data caches, tracking fragment sequences, and providing callbacks for fragment processing and verification.


---
### fd\_tile\_test\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``loop_i``: Test loop counter.
    - ``select_in_link``: Function pointer for selecting upstream producer link.
    - ``select_out_links``: Function pointer for selecting downstream consumer links.
    - ``in_link``: Pointer to the input link for the current loop, set by `select_in_link`.
    - ``is_overrun``: Flag indicating whether the current fragment is overrun.
    - ``filter``: Filter returned by `before_frag` callback.
    - ``filter_exp``: Expected filter for `before_frag`, initialized to 0.
    - ``locals``: Array containing tile-specific test fields.
- **Description**: Contains both common testing infrastructure and tile-specific state for testing Firedancer tiles. It is updated and checked during each test loop, with functions to select input and output links for each loop iteration. The structure also includes fields for managing test state, such as loop counters, overrun detection, and expected filter values.


---
### fd\_tile\_test\_link
- **Type**: ``struct``
- **Members**:
    - `mcache`: Pointer to the metadata cache of the link.
    - `dcache`: Pointer to the data cache of the link.
    - `depth`: Depth of the link.
    - `base`: Base address of the data cache.
    - `chunk0`: Initial chunk of the data cache.
    - `wmark`: Watermark for the data cache chunk.
    - `chunk`: Current chunk, initialized to `chunk0`.
    - `in_idx`: Index of the link if it is an input link, `ULONG_MAX` otherwise.
    - `prod_seq`: Sequence number of the newly produced fragment.
    - `cons_seq`: Sequence number of the currently processing fragment.
    - `is_input_link`: Indicates if the link is an input link (1) or an output link (0).
    - `publish`: Callback function to publish a fragment.
    - `make_sig`: Callback function to make a signature for the published fragment.
    - `before_frag_check`: Callback function to check before processing a fragment.
    - `during_frag_check`: Callback function to check during processing a fragment.
    - `after_frag_check`: Callback function to check after processing a fragment.
    - `output_verifier`: Callback function to verify an output.
- **Description**: Models a communication link in a tile testing framework, representing either an input/producer or output/consumer link. It includes metadata and data cache pointers, sequence numbers for fragment production and consumption, and several callback functions for handling fragment processing and verification. The structure is used to simulate and test the behavior of communication channels between tiles in a controlled environment.


---
### fd\_tile\_test\_locals\_t
- **Type**: ``struct``
- **Members**:
    - `after_credit_expected_sz`: Size expected after credit.
    - `after_credit_expected_output`: Expected output after credit.
    - `after_frag_expected_sz`: Size expected after fragment.
- **Description**: `fd_tile_test_locals_t` is a structure used in the context of unit testing Firedancer tiles. It holds fields that track expected sizes and outputs during the testing of tile states across various callback transitions, such as before and after credit, and before, during, and after fragment processing. This structure is part of a templated framework that allows different tiles to share common testing infrastructure.


---
### fd\_tile\_test\_context
- **Type**: ``struct``
- **Members**:
    - ``loop_i``: Test loop counter.
    - ``select_in_link``: Function pointer for selecting upstream producer.
    - ``select_out_links``: Function pointer for selecting downstream consumers.
    - ``in_link``: Input link for the current loop, set by `select_in_link`.
    - ``is_overrun``: Indicates whether the current fragment is overrun.
    - ``filter``: Filter returned by `before_frag(...)`.
    - ``filter_exp``: Expected `before_frag` filter, initialized to 0 and usually set by the publish callback.
    - ``locals``: Array of tile-specific test fields.
- **Description**: The `fd_tile_test_context` structure is used in unit testing Firedancer tiles, providing a framework to test transitions between tile callbacks. It includes fields for managing test loops, selecting input and output links, and tracking the state of fragments during testing. The structure also contains tile-specific fields and supports overrun detection and filter management for fragments.


# Function Declarations (Public API)

---
### fd\_tile\_unit\_test\_init<!-- {{#callable_declaration:fd_tile_unit_test_init}} -->
[View Source →](<../../../../../src/app/shared/fd_tile_unit_test.h#L38>)

Initializes a tile for unit testing with a specified topology configuration.
- **Description**: Use this function to set up a tile for unit testing within a specified topology. It requires a default topology configuration path and optionally accepts override and user configuration paths. The function initializes the topology using the provided configuration paths and parameters, and it populates the `out_config` structure. It is important to ensure that the `default_topo_config_path` is not null, as the function will return null and log a warning if it cannot read the configuration file. The function also requires a pointer to an initialization function and a tile structure to run. On success, it returns a pointer to the initialized tile, which is necessary for further initialization steps.
- **Inputs**:
    - `default_topo_config_path`: Path to the default topology configuration file. Must not be null. If null, the function logs a warning and returns null.
    - `override_topo_config_path`: Path to an optional override topology configuration file. Can be null. If provided and the file cannot be read, the function logs a warning and returns null.
    - `user_topo_config_path`: Path to an optional user topology configuration file. Can be null. If provided and the file cannot be read, the function logs a warning and returns null.
    - `netns`: Integer representing the network namespace. Valid values depend on the system configuration.
    - `is_firedancer`: Integer flag indicating if the Firedancer topology is used. Non-zero for true, zero for false.
    - `is_local_cluster`: Integer flag indicating if the local cluster is used. Non-zero for true, zero for false.
    - `fd_topo_initialize_`: Pointer to a function that initializes the topology. Must not be null.
    - `topo_run_tile`: Pointer to a `fd_topo_run_tile_t` structure representing the tile to run. Must not be null.
    - `out_config`: Pointer to a `config_t` structure that will be populated with the configuration data. Must not be null.
- **Output**: Returns a pointer to an `fd_topo_tile_t` structure representing the initialized tile, or null on error.
- **See Also**: [`fd_tile_unit_test_init`](<fd_tile_unit_test.c.md#fd_tile_unit_test_init>)  (Implementation)


---
### fd\_tile\_test\_init\_link\_out<!-- {{#callable_declaration:fd_tile_test_init_link_out}} -->
[View Source →](<../../../../../src/app/shared/fd_tile_unit_test.h#L368>)

Initialize an output test link for a tile.
- **Description**: Use this function to set up an output link in the tile's topology for testing purposes. It finds the specified link in the topology and initializes the test link structure with the necessary callbacks for output verification. This function is typically used when preparing a tile for unit testing, ensuring that the output link is correctly configured to verify the tile's output during tests. The function must be called with a valid topology and link name, and it logs an error if the link cannot be found.
- **Inputs**:
    - `topo`: Pointer to the topology structure. Must not be null and should contain the link specified by `link_name`.
    - `test_link`: Pointer to the test link structure to initialize. Must not be null. The function populates this structure with the link's details and the output verifier callback.
    - `link_name`: String representing the name of the link to find in the topology. Must not be null. The function logs an error if the link is not found.
    - `output_verifier`: Pointer to a function that verifies the output. Can be null if no verification is needed. If provided, the function checks its validity.
- **Output**: None
- **See Also**: [`fd_tile_test_init_link_out`](<fd_tile_unit_test_tmpl.c.md#fd_tile_test_init_link_out>)  (Implementation)


---
### fd\_tile\_test\_init\_link\_in<!-- {{#callable_declaration:fd_tile_test_init_link_in}} -->
[View Source →](<../../../../../src/app/shared/fd_tile_unit_test.h#L382>)

Initialize an input link for tile testing.
- **Description**: Use this function to set up an input link for testing a tile within a specified topology. It requires a valid topology and link name to locate the link. The function initializes the test link with callbacks for fragment generation and verification. Ensure that the `find_in_idx` callback is provided, as it is mandatory for determining the link's index in the tile's context. Call this function before running tests to prepare the link for input operations.
- **Inputs**:
    - `topo`: Pointer to the topology structure. Must not be null and should contain the link specified by `link_name`.
    - `test_link`: Pointer to the test link structure to initialize. Must not be null.
    - `link_name`: String representing the name of the link to find in the topology. Must not be null.
    - `ctx`: Pointer to the tile's context structure. Must not be null.
    - `find_in_idx`: Callback function to find the index of the link in the tile's context. Must not be null.
    - `publish`: Optional callback function for publishing a fragment. Can be null if not used.
    - `make_sig`: Optional callback function for making a signature for the published fragment. Can be null if not used.
    - `before_frag_check`: Optional callback function to check conditions before processing a fragment. Can be null if not used.
    - `during_frag_check`: Optional callback function to check conditions during fragment processing. Can be null if not used.
    - `after_frag_check`: Optional callback function to check conditions after processing a fragment. Can be null if not used.
- **Output**: None
- **See Also**: [`fd_tile_test_init_link_in`](<fd_tile_unit_test_tmpl.c.md#fd_tile_test_init_link_in>)  (Implementation)


---
### fd\_tile\_test\_update\_callback\_link\_in<!-- {{#callable_declaration:fd_tile_test_update_callback_link_in}} -->
[View Source →](<../../../../../src/app/shared/fd_tile_unit_test.h#L398>)

Updates a callback function for an input test link.
- **Description**: Use this function to modify the callback function associated with an input test link in a tile testing framework. This function is applicable when you need to change the behavior of a specific callback during testing. Ensure that the `test_link` is an input link, as the function will log an error if it is not. The `callback_fn_num` must correspond to a valid callback identifier, otherwise an error is logged. Only one of `pub_or_sig` or `check` will be used based on the `callback_fn_num` provided.
- **Inputs**:
    - `test_link`: A pointer to an `fd_tile_test_link_t` structure representing the input test link. Must be an input/producer/upstream link.
    - `callback_fn_num`: An integer representing the callback function number to update. Must be a valid identifier such as `FD_TILE_TEST_CALLBACK_BEFORE_CREDIT`, `FD_TILE_TEST_CALLBACK_DURING_FRAG`, etc.
    - `pub_or_sig`: A function pointer to a callback function that takes `fd_tile_test_ctx_t *` and `fd_tile_test_link_t *` as parameters and returns an `ulong`. Used for callbacks like `FD_TILE_TEST_CALLBACK_PUBLISH` or `FD_TILE_TEST_CALLBACK_MAKE_SIG`.
    - `check`: A function pointer to a callback function that takes `fd_tile_test_ctx_t *` and `TEST_TILE_CTX_TYPE *` as parameters and returns an `int`. Used for callbacks like `FD_TILE_TEST_CALLBACK_BEFORE_FRAG`, `FD_TILE_TEST_CALLBACK_DURING_FRAG`, etc.
- **Output**: None
- **See Also**: [`fd_tile_test_update_callback_link_in`](<fd_tile_unit_test_tmpl.c.md#fd_tile_test_update_callback_link_in>)  (Implementation)


---
### fd\_tile\_test\_update\_callback\_link\_out<!-- {{#callable_declaration:fd_tile_test_update_callback_link_out}} -->
[View Source →](<../../../../../src/app/shared/fd_tile_unit_test.h#L406>)

Updates the output verifier callback for an output test link.
- **Description**: Use this function to set or update the output verifier callback for a test link that acts as an output or consumer in a tile testing environment. This function is applicable only to links that are designated as output links, and it requires a valid callback function number. Ensure that the `test_link` is not an input link before calling this function, as it will log an error if the link is not an output link. The function does not perform any operation if the `callback_fn_num` is not `FD_TILE_TEST_CALLBACK_OUT_VERIFY`.
- **Inputs**:
    - `test_link`: A pointer to a `fd_tile_test_link_t` structure representing the test link. This must not be null and must represent an output/consumer/downstream link. The function logs an error if the link is an input link.
    - `callback_fn_num`: An integer representing the callback function number. It must be `FD_TILE_TEST_CALLBACK_OUT_VERIFY`. If it is not, the function logs an error.
    - `output_verifier`: A pointer to a function that takes a `fd_tile_test_ctx_t *`, a `TEST_TILE_CTX_TYPE *`, and a `fd_tile_test_link_t *` as parameters and returns an integer. This function will be used to verify the output of the test link. It must not be null.
- **Output**: None
- **See Also**: [`fd_tile_test_update_callback_link_out`](<fd_tile_unit_test_tmpl.c.md#fd_tile_test_update_callback_link_out>)  (Implementation)


---
### fd\_tile\_test\_check\_output<!-- {{#callable_declaration:fd_tile_test_check_output}} -->
[View Source →](<../../../../../src/app/shared/fd_tile_unit_test.h#L419>)

Notifies the test framework to verify output after a tile callback.
- **Description**: Use this function to signal the test framework to verify the output of a tile after a specific callback has been executed. This function is typically called within a test run when the tile is expected to produce fragments after a callback. It is important to ensure that the `callback_fn_num` corresponds to a valid callback identifier, such as `FD_TILE_TEST_CALLBACK_BEFORE_CREDIT`, `FD_TILE_TEST_CALLBACK_AFTER_CREDIT`, or `FD_TILE_TEST_CALLBACK_AFTER_FRAG`. If an unsupported callback function number is provided, the function logs an error.
- **Inputs**:
    - `callback_fn_num`: An integer representing the callback function number. Must be one of the predefined constants like `FD_TILE_TEST_CALLBACK_BEFORE_CREDIT`, `FD_TILE_TEST_CALLBACK_AFTER_CREDIT`, or `FD_TILE_TEST_CALLBACK_AFTER_FRAG`. If an invalid number is provided, the function logs an error.
    - `test_link`: A pointer to a `fd_tile_test_link_t` structure representing the test link. This parameter must not be null and should be properly initialized before calling this function.
- **Output**: None
- **See Also**: [`fd_tile_test_check_output`](<fd_tile_unit_test_tmpl.c.md#fd_tile_test_check_output>)  (Implementation)


---
### fd\_tile\_test\_reset\_env<!-- {{#callable_declaration:fd_tile_test_reset_env}} -->
[View Source →](<../../../../../src/app/shared/fd_tile_unit_test.h#L426>)

Resets the test environment for a new test run.
- **Description**: Use this function to clear the state and reset input and output selection callbacks before starting a new test run. It is necessary to call this function to ensure that the test environment is in a known state, which includes resetting test links and initializing the test context with the provided callbacks. This function must be called before each test run to avoid unexpected behavior.
- **Inputs**:
    - `test_ctx`: A pointer to the test context structure. Must not be null. The function initializes this structure with the provided callbacks.
    - `stem`: A pointer to the stem context structure. Must not be null. The function resets sequences and credit availability in this structure.
    - `test_links`: An array of pointers to test link structures. Must not be null. The function resets the production and consumption sequences for each link.
    - `select_in_link`: A function pointer for selecting input links. Must not be null. The function assigns this callback to the test context.
    - `select_out_links`: A function pointer for selecting output links. Must not be null. The function assigns this callback to the test context.
    - `before_credit_check`: A function pointer for the before credit check callback. Can be null if not used. The function assigns this callback to the test context.
    - `after_credit_check`: A function pointer for the after credit check callback. Can be null if not used. The function assigns this callback to the test context.
- **Output**: None
- **See Also**: [`fd_tile_test_reset_env`](<fd_tile_unit_test_tmpl.c.md#fd_tile_test_reset_env>)  (Implementation)


---
### fd\_tile\_test\_run<!-- {{#callable_declaration:fd_tile_test_run}} -->
[View Source →](<../../../../../src/app/shared/fd_tile_unit_test.h#L476>)

Executes a series of test iterations for a tile.
- **Description**: Use this function to run a series of test iterations on a tile, simulating its operation in a controlled environment. It requires a context for the tile, a set of test links, and a test context to track the state across iterations. The function iterates up to a specified count, performing operations such as selecting input and output links, publishing data, and executing callbacks. It also handles housekeeping tasks at specified intervals. Ensure that the test environment is properly initialized and reset before calling this function.
- **Inputs**:
    - `ctx`: A pointer to the tile's context. This must be properly initialized before use.
    - `stem`: A pointer to a stem context, marked as unused in this function. Can be NULL.
    - `test_links`: An array of pointers to `fd_tile_test_link_t` structures representing the test links. Must not be NULL.
    - `test_ctx`: A pointer to a `fd_tile_test_ctx_t` structure that maintains the state of the test. Must be initialized before use.
    - `loop_cnt`: The number of iterations to run the test. Must be a positive integer.
    - `housekeeping_interval`: The interval at which housekeeping tasks are performed. Marked as unused in this function.
- **Output**: None
- **See Also**: [`fd_tile_test_run`](<fd_tile_unit_test_tmpl.c.md#fd_tile_test_run>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)