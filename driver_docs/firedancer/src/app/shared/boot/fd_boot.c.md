<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Bootstraps the Firedancer application, handling configuration, logging, and command execution.

# Purpose
The code is a C source file that provides functionality for initializing and managing configurations and logging for a software application. It includes functions to handle configuration files, manage memory-mapped files, and set up logging mechanisms. The file imports several headers, indicating dependencies on other modules for configuration, actions, file utilities, and topology management. The primary function, [`fd_main`](<#fd_main>), serves as the entry point for the application, processing command-line arguments to determine the appropriate action to execute. It supports different network configurations such as testnet, devnet, and mainnet, and allows for the specification of user configuration paths.

The code defines several static functions to manage memory and logging, such as [`copy_config_from_fd`](<#copy_config_from_fd>), [`map_log_memfd`](<#map_log_memfd>), and [`init_log_memfd`](<#init_log_memfd>). These functions are used to map configuration data into memory and initialize logging mechanisms. The [`fd_main_init`](<#fd_main_init>) function is responsible for setting up the initial environment, including loading configuration files, initializing logging, and setting up shared memory. The code also includes logic to handle command-line arguments, determine the appropriate configuration to use, and execute the specified action. The use of external variables like `ACTIONS` and `TILES` suggests that the code is part of a larger system where actions and tiles are defined elsewhere.
# Imports and Dependencies

---
- `fd_boot.h`
- `../fd_config.h`
- `../fd_action.h`
- `../../platform/fd_file_util.h`
- `../../../disco/topo/fd_topo.h`
- `errno.h`
- `unistd.h`
- `fcntl.h`
- `sys/mman.h`


# Global Variables

---
### ACTIONS
- **Type**: ``action_t *``
- **Description**: An array of pointers to `action_t` structures, where each element represents a specific action or command that can be executed by the program. Each `action_t` structure likely contains information about the action's name, function to execute, and any specific flags or requirements.
- **Use**: Used to store and access different actions or commands that the program can execute, allowing for dynamic command handling.


---
### TILES
- **Type**: ``fd_topo_run_tile_t *` array`
- **Description**: An array of pointers to `fd_topo_run_tile_t` structures. Each element in the array represents a tile in the topology.
- **Use**: Used to store and access the tiles in the topology for operations such as searching for a specific tile by name.


---
### fd\_log\_private\_shared\_lock
- **Type**: `int *`
- **Description**: A pointer to an integer that serves as a shared lock for logging operations.
- **Use**: Used to synchronize log message sequencing across different processes.


---
### config
- **Type**: ``config_t``
- **Description**: Represents a static instance of the `config_t` structure, which is used to store configuration settings for the application. This variable is defined at the top level of the file, making it a global variable accessible throughout the file.
- **Use**: Used to store and manage configuration data that is loaded and manipulated by various functions in the application.


# Functions

---
### fdctl\_tile\_run<!-- {{#callable:fdctl_tile_run}} -->
[View Source →](<../../../../../../src/app/shared/boot/fd_boot.c#L19>)

Searches for a tile with a matching name in the `TILES` array and returns it if found, otherwise logs an error and returns a default-initialized `fd_topo_run_tile_t`.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure containing the name of the tile to search for.
- **Logic and Control Flow**:
    - Iterates over the `TILES` array until a null pointer is encountered.
    - Compares the `name` field of the input `tile` with the `name` field of each tile in the `TILES` array using `strcmp`.
    - If a match is found, returns the corresponding `fd_topo_run_tile_t` structure from the `TILES` array.
    - If no match is found after the loop, logs an error message indicating the tile was not found.
    - Returns a default-initialized `fd_topo_run_tile_t` structure if no match is found.
- **Output**: Returns a `fd_topo_run_tile_t` structure corresponding to the found tile, or a default-initialized `fd_topo_run_tile_t` if no match is found.


---
### copy\_config\_from\_fd<!-- {{#callable:copy_config_from_fd}} -->
[View Source →](<../../../../../../src/app/shared/boot/fd_boot.c#L28>)

Copies configuration data from a file descriptor into a `config_t` structure using memory mapping.
- **Inputs**:
    - `config_fd`: A file descriptor from which to read the configuration data.
    - `config`: A pointer to a `config_t` structure where the configuration data will be copied.
- **Logic and Control Flow**:
    - Use `mmap` to map the configuration data from the file descriptor `config_fd` into memory.
    - Check if `mmap` failed by comparing the result to `MAP_FAILED`; if it failed, log an error and exit.
    - Copy the mapped data into the `config` structure using `fd_memcpy`.
    - Unmap the memory using `munmap` and check for errors; if `munmap` fails, log an error and exit.
    - Close the file descriptor `config_fd` and check for errors; if closing fails, log an error and exit.
- **Output**: No return value; the function modifies the `config` structure in place.


---
### map\_log\_memfd<!-- {{#callable:map_log_memfd}} -->
[View Source →](<../../../../../../src/app/shared/boot/fd_boot.c#L38>)

Maps a memory file descriptor to a shared memory region and locks it in memory.
- **Inputs**:
    - `log_memfd`: A file descriptor for the memory file to map.
- **Logic and Control Flow**:
    - Call `mmap` to map a 4096-byte shared memory region with read and write permissions using the `log_memfd` file descriptor.
    - Check if `mmap` returns `MAP_FAILED`, indicating an error, and log the error using `FD_LOG_ERR`.
    - If `mmap` is successful, call `mlock` to lock the mapped memory region in RAM to prevent it from being swapped out.
    - Check if `mlock` fails and log the error using `FD_LOG_ERR`.
- **Output**: Returns a pointer to the mapped shared memory region, or logs an error if mapping or locking fails.


---
### init\_log\_memfd<!-- {{#callable:init_log_memfd}} -->
[View Source →](<../../../../../../src/app/shared/boot/fd_boot.c#L56>)

Creates a memory file descriptor (memfd) and sets its size to 4096 bytes for logging purposes.
- **Inputs**: None
- **Logic and Control Flow**:
    - Call `memfd_create` with the name 'fd_log_lock_page' and flags set to 0 to create a new memory file descriptor.
    - Check if `memfd_create` returns -1, indicating an error, and log an error message if so.
    - Call `ftruncate` on the created memfd to set its size to 4096 bytes.
    - Check if `ftruncate` returns -1, indicating an error, and log an error message if so.
    - Return the created memfd.
- **Output**: An integer representing the created memory file descriptor.


---
### should\_colorize<!-- {{#callable:should_colorize}} -->
[View Source →](<../../../../../../src/app/shared/boot/fd_boot.c#L64>)

Determines if the terminal supports colorization based on environment variables.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `fd_env_strip_cmdline_cstr` to get the value of the `COLORTERM` environment variable.
    - Checks if `cstr` is not null and equals `truecolor`; if true, returns 1.
    - Calls `fd_env_strip_cmdline_cstr` to get the value of the `TERM` environment variable.
    - Checks if `cstr` is not null and contains `256color`; if true, returns 1.
    - If none of the conditions are met, returns 0.
- **Output**: Returns 1 if the terminal supports colorization, otherwise returns 0.


---
### determine\_override\_config<!-- {{#callable:determine_override_config}} -->
[View Source →](<../../../../../../src/app/shared/boot/fd_boot.c#L74>)

Selects an override configuration based on command-line arguments for network type.
- **Inputs**:
    - ``pargc``: Pointer to the argument count.
    - ``pargv``: Pointer to the argument vector.
    - ``configs``: Array of pointers to `fd_config_file_t` structures representing available configurations.
    - ``override_config``: Pointer to a string where the selected override configuration data will be stored.
    - ``override_config_path``: Pointer to a string where the path of the selected override configuration will be stored.
    - ``override_config_sz``: Pointer to an unsigned long where the size of the selected override configuration data will be stored.
- **Logic and Control Flow**:
    - Check if the `--testnet` argument is present in the command line arguments.
    - If `--testnet` is present, iterate through `configs` to find a configuration named 'testnet'.
    - If found, set `override_config`, `override_config_path`, and `override_config_sz` to the corresponding values from the 'testnet' configuration.
    - If no 'testnet' configuration is found, log an error and exit.
    - Check if the `--devnet` argument is present in the command line arguments.
    - If `--devnet` is present, ensure `--testnet` is not also specified, then iterate through `configs` to find a configuration named 'devnet'.
    - If found, set `override_config`, `override_config_path`, and `override_config_sz` to the corresponding values from the 'devnet' configuration.
    - If no 'devnet' configuration is found, log an error and exit.
    - Check if the `--mainnet` argument is present in the command line arguments.
    - If `--mainnet` is present, ensure neither `--testnet` nor `--devnet` are also specified, then iterate through `configs` to find a configuration named 'mainnet'.
    - If found, set `override_config`, `override_config_path`, and `override_config_sz` to the corresponding values from the 'mainnet' configuration.
    - If no 'mainnet' configuration is found, log an error and exit.
- **Output**: Sets the `override_config`, `override_config_path`, and `override_config_sz` to the selected configuration's data, path, and size, respectively.


---
### fd\_main\_init<!-- {{#callable:fd_main_init}} -->
[View Source →](<../../../../../../src/app/shared/boot/fd_boot.c#L126>)

Initializes the main configuration and logging setup for the application, handling user and default configurations, and setting up the environment for further execution.
- **Inputs**:
    - ``pargc``: Pointer to the argument count, which can be modified by the function.
    - ``pargv``: Pointer to the argument vector, which can be modified by the function.
    - ``config``: Pointer to a `config_t` structure where the configuration will be loaded.
    - ``opt_user_config_path``: Optional path to a user configuration file.
    - ``is_firedancer``: Flag indicating if the application is running in 'firedancer' mode.
    - ``is_local_cluster``: Flag indicating if the application is running in a local cluster environment.
    - ``log_path``: Path to the log file, if specified.
    - ``configs``: Array of pointers to `fd_config_file_t` structures containing configuration data.
    - ``topo_init``: Function pointer to initialize the topology with the loaded configuration.
- **Logic and Control Flow**:
    - Enables logging settings to handle unclean exits and sets initial log levels.
    - Checks for a configuration file descriptor from command line arguments and loads configuration from it if available.
    - If no configuration file descriptor is found, attempts to read a user configuration file if a path is provided.
    - Determines the default and override configurations from the provided `configs` array and loads them.
    - Initializes the topology using the `topo_init` function with the loaded configuration.
    - Sets up shared memory arguments and maps the log memory file descriptor for logging purposes.
    - Switches to the sandbox user and group IDs for log file creation.
    - Bootstraps the logging system with the initialized configuration and environment settings.
    - Restores the original user and group IDs after setting up logging.
    - Initializes shared memory and tile systems for further execution.
- **Output**: No return value; the function modifies the provided `config` structure and sets up the environment for the application.
- **Functions Called**:
    - [`should_colorize`](<#should_colorize>)
    - [`copy_config_from_fd`](<#copy_config_from_fd>)
    - [`determine_override_config`](<#determine_override_config>)
    - [`init_log_memfd`](<#init_log_memfd>)
    - [`map_log_memfd`](<#map_log_memfd>)


---
### fd\_main<!-- {{#callable:fd_main}} -->
[View Source →](<../../../../../../src/app/shared/boot/fd_boot.c#L249>)

Processes command-line arguments to execute specified actions, handling configuration and permissions.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `_argv`: An array of command-line argument strings.
    - `is_firedancer`: A flag indicating if the application is running in Firedancer mode.
    - `configs`: An array of pointers to configuration file structures.
    - `topo_init`: A function pointer for initializing the topology with the given configuration.
- **Logic and Control Flow**:
    - Decrements `argc` and advances `argv` to skip the program name.
    - Searches for a help action in the `ACTIONS` array and assigns it to `help_action`.
    - Checks if no subcommand is specified and executes the help action if true, logging a warning and returning 1.
    - Strips command-line flags to find the user configuration path using `fd_env_strip_cmdline_cstr`.
    - Searches for the specified action in the `ACTIONS` array and assigns it to `action`.
    - If the action is immediate, executes it and returns 0.
    - Initializes the main configuration using [`fd_main_init`](<#fd_main_init>) with the parsed arguments and configuration details.
    - If no action is found, executes the help action and logs an error for an unknown subcommand.
    - Checks if the action requires a configuration and logs an error if the `--config` argument is missing.
    - Decrements `argc` and advances `argv` to process additional arguments.
    - Initializes `args_t` structure and processes additional arguments if the action has an `args` function.
    - Logs an error if there are unknown arguments remaining.
    - Checks permissions using `fd_cap_chk_t` and logs warnings or errors if there are permission issues.
    - Executes the action's function with the parsed arguments and configuration.
- **Output**: Returns 0 on successful execution of the specified action, or 1 if no subcommand is specified.
- **Functions Called**:
    - [`fd_main_init`](<#fd_main_init>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)