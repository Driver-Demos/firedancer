<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Configuration management and validation for the Firedancer application, including TOML parsing and error handling.

# Purpose
The code is a C source file that manages configuration loading and validation for a software system, likely related to a network application. It includes functions to parse configuration data from TOML files, validate the configuration settings, and fill in default or computed values where necessary. The file defines several functions, such as [`fd_config_load_buf`](<#fd_config_load_buf>), [`fd_config_fill`](<#fd_config_fill>), and [`fd_config_validate`](<#fd_config_validate>), which handle the parsing, filling, and validation of configuration data, respectively. The configuration data is stored in a structure `fd_config_t`, which is populated with values from the configuration files and then validated to ensure all necessary settings are present and correctly formatted.

The code also includes utility functions like [`replace`](<#replace>) for string manipulation and [`parse_log_level`](<#parse_log_level>) for interpreting log level strings. It uses various macros and inline functions to handle error logging and validation checks. The file imports several headers, indicating dependencies on other modules for network utilities, system utilities, and TOML parsing. The code is structured to support different configurations for development and production environments, with specific checks and adjustments for network settings, file paths, and user permissions. Additionally, it provides functionality to convert the configuration data into a memory file descriptor for further use in the application.
# Imports and Dependencies

---
- `fd_config.h`
- `fd_config_private.h`
- `../platform/fd_net_util.h`
- `../platform/fd_sys_util.h`
- `../../ballet/toml/fd_toml.h`
- `../../disco/genesis/fd_genesis_cluster.h`
- `unistd.h`
- `errno.h`
- `stdlib.h`
- `sys/utsname.h`
- `sys/mman.h`


# Functions

---
### replace<!-- {{#callable:replace}} -->
[View Source →](<../../../../../src/app/shared/fd_config.c#L18>)

Replaces the first occurrence of a pattern in a string with a substitute string, ensuring the result does not exceed a maximum path length.
- **Inputs**:
    - ``in``: A mutable string where the function will search for the pattern and perform the replacement.
    - ``pat``: A constant string representing the pattern to search for in the input string.
    - ``sub``: A constant string representing the substitute string to replace the pattern with.
- **Logic and Control Flow**:
    - Searches for the first occurrence of the pattern `pat` in the input string `in` using `strstr`.
    - If the pattern is found, calculates the lengths of `pat`, `sub`, and `in`.
    - Checks if the pattern length is greater than the input string length; if so, returns without making changes.
    - Calculates the total length of the new string after replacement and checks if it exceeds `PATH_MAX`; if so, logs an error and returns.
    - Copies the part of the string after the pattern into a temporary buffer `after`.
    - Copies the substitute string `sub` into the position of the pattern in the input string.
    - Copies the contents of `after` back into the input string, starting after the substitute string.
    - Appends a null terminator to the end of the modified input string.
- **Output**: The function modifies the input string `in` in place, replacing the first occurrence of `pat` with `sub`, or logs an error if the resulting string would be too long.


---
### parse\_log\_level<!-- {{#callable:parse_log_level}} -->
[View Source →](<../../../../../src/app/shared/fd_config.c#L43>)

Maps a string representation of a log level to its corresponding integer value.
- **Inputs**:
    - `level`: A constant character pointer representing the log level as a string.
- **Logic and Control Flow**:
    - Check if `level` is equal to "DEBUG"; if true, return 0.
    - Check if `level` is equal to "INFO"; if true, return 1.
    - Check if `level` is equal to "NOTICE"; if true, return 2.
    - Check if `level` is equal to "WARNING"; if true, return 3.
    - Check if `level` is equal to "ERR"; if true, return 4.
    - Check if `level` is equal to "CRIT"; if true, return 5.
    - Check if `level` is equal to "ALERT"; if true, return 6.
    - Check if `level` is equal to "EMERG"; if true, return 7.
    - If none of the above conditions are met, return -1.
- **Output**: An integer representing the log level, or -1 if the input string does not match any known log level.


---
### fd\_config\_load\_buf<!-- {{#callable:fd_config_load_buf}} -->
[View Source →](<../../../../../src/app/shared/fd_config.c#L56>)

Parses a TOML configuration buffer and extracts its contents into a `fd_config_t` structure.
- **Inputs**:
    - `out`: A pointer to an `fd_config_t` structure where the parsed configuration will be stored.
    - `buf`: A constant character pointer to the buffer containing the TOML configuration data.
    - `sz`: An unsigned long representing the size of the buffer.
    - `path`: A constant character pointer to the path of the configuration file, used for error logging.
- **Logic and Control Flow**:
    - Allocate a static memory buffer `pod_mem` and initialize a POD structure using `fd_pod_new` and `fd_pod_join`.
    - Parse the TOML configuration from `buf` using `fd_toml_parse`, storing any errors in `toml_err`.
    - If parsing fails, log an error message based on the error code `toml_errc` and the line number from `toml_err`.
    - Extract the parsed configuration data from the POD structure into the `out` parameter using `fd_config_extract_pod`.
    - Clean up the POD structure by calling `fd_pod_leave` and `fd_pod_delete`.
- **Output**: The function does not return a value but populates the `out` parameter with the parsed configuration data.


---
### fd\_config\_fillf<!-- {{#callable:fd_config_fillf}} -->
[View Source →](<../../../../../src/app/shared/fd_config.c#L98>)

Does nothing with the given `fd_config_t` pointer.
- **Inputs**:
    - ``config``: A pointer to an `fd_config_t` structure, which is not used in the function.
- **Logic and Control Flow**:
    - The function takes a single argument, `config`, which is a pointer to an `fd_config_t` structure.
    - The function explicitly casts the `config` parameter to void to indicate that it is unused.
    - No operations are performed within the function body.
- **Output**: No output is produced as the function does nothing.


---
### fd\_config\_fillh<!-- {{#callable:fd_config_fillh}} -->
[View Source →](<../../../../../src/app/shared/fd_config.c#L103>)

Processes and validates configuration paths and ports, replacing placeholders and checking constraints.
- **Inputs**:
    - `config`: A pointer to an `fd_config_t` structure containing configuration data to be processed and validated.
- **Logic and Control Flow**:
    - Check if `accounts_path` is non-empty and replace placeholders `{user}` and `{name}` with `config->user` and `config->name` respectively.
    - Check if `snapshots.path` is non-empty; if so, replace placeholders, otherwise copy `config->paths.ledger` to `snapshots.path`.
    - Iterate over `authorized_voter_paths` and replace placeholders `{user}` and `{name}` in each path.
    - Validate that `quic_transaction_listen_port` is exactly 6 more than `regular_transaction_listen_port`; log an error if not.
    - Copy `dynamic_port_range` to a local buffer and split it into `agave_port_min` and `agave_port_max` using `strtoul`, logging errors for invalid formats or values.
    - Ensure `regular_transaction_listen_port`, `quic_transaction_listen_port`, and `shred_listen_port` are outside the dynamic port range, logging errors if they are not.
- **Output**: No return value; the function modifies the `config` structure in place and logs errors if validation fails.
- **Functions Called**:
    - [`replace`](<#replace>)


---
### fd\_config\_fill\_net<!-- {{#callable:fd_config_fill_net}} -->
[View Source →](<../../../../../src/app/shared/fd_config.c#L176>)

Configures network settings for a Firedancer configuration based on the provided configuration structure.
- **Inputs**:
    - ``config``: A pointer to an `fd_config_t` structure that holds the configuration settings to be filled.
- **Logic and Control Flow**:
    - Checks if the network interface is not specified and network namespace is not enabled, then attempts to find a network interface that routes to 8.8.8.8.
    - If a network interface is found, retrieves its name and assigns it to `config->net.interface`.
    - If network namespace is enabled, copies `interface0` and `interface1_addr` from `development.netns` to `net.interface` and `pktgen.fake_dst_ip` respectively.
    - Validates that `development.netns.interface0` matches `net.interface` and converts `interface0_addr` to an IP address.
    - If network namespace is not enabled, verifies the existence of the specified network interface and retrieves its IP address.
    - If `is_firedancer` is true, checks the validity of the `gossip.host` IP address and its public accessibility.
    - Assigns the IP address of the network interface to `config->net.ip_addr`.
- **Output**: No direct output; modifies the `config` structure in place.


---
### fd\_config\_fill<!-- {{#callable:fd_config_fill}} -->
[View Source →](<../../../../../src/app/shared/fd_config.c#L245>)

Configures the `fd_config_t` structure based on network namespace and cluster settings, while validating and adjusting various configuration parameters.
- **Inputs**:
    - `config`: A pointer to an `fd_config_t` structure that will be filled with configuration data.
    - `netns`: An integer indicating if network namespace is enabled (non-zero) or not (zero).
    - `is_local_cluster`: An integer indicating if the configuration is for a local cluster (non-zero) or not (zero).
- **Logic and Control Flow**:
    - If `netns` is non-zero, enable network namespace and set the network interface from `development.netns.interface0`.
    - Retrieve and set the system hostname using `uname`.
    - Identify the cluster using `fd_genesis_cluster_identify` if `is_firedancer` is false, and set `is_live_cluster` accordingly.
    - If `user` is empty, attempt to determine the login user and set it in the configuration.
    - Convert the user to UID and GID, ensuring they are not root, and match the current process UID and GID.
    - Set paths for huge pages using `fd_cstr_printf_check`.
    - Validate `hugetlbfs.max_page_size` to be either "huge" or "gigantic".
    - Replace placeholders in `log.path` with user and name.
    - Set `log.colorize1` based on `log.colorize` value, checking environment variables for color support if set to "auto".
    - Parse log levels for `log.level_logfile`, `log.level_stderr`, and `log.level_flush`, logging errors for unrecognized levels.
    - Replace placeholders in `paths.base`, `paths.ledger`, `paths.identity_key`, `paths.vote_account`, `paths.snapshots`, and `paths.genesis` with user and name, or set default paths if empty.
    - Calibrate `tick_per_ns_mu` using `fd_tempo_tick_per_ns`.
    - Validate `net.bind_address` as a valid IPv4 address if not empty.
    - Set `tiles.pack.schedule_strategy_enum` based on `tiles.pack.schedule_strategy`, logging errors for unrecognized strategies.
    - Call [`fd_config_fill_net`](<#fd_config_fill_net>) to fill network-related configuration.
    - Call [`fd_config_fillf`](<#fd_config_fillf>) or [`fd_config_fillh`](<#fd_config_fillh>) based on `is_firedancer`.
    - Set `development.gui.frontend_release_channel_enum` based on `development.gui.frontend_release_channel`, logging errors for unrecognized channels.
    - If `is_live_cluster` is true, ensure development-only features are disabled, logging errors if not.
    - If `is_local_cluster` is true, override certain options for development convenience, such as setting `cluster` to "development" and adjusting `frankendancer` settings.
    - Log an error if attempting to start `firedancer` against a non-testnet live cluster.
- **Output**: No return value; the function modifies the `fd_config_t` structure pointed to by `config`.
- **Functions Called**:
    - [`replace`](<#replace>)
    - [`parse_log_level`](<#parse_log_level>)
    - [`fd_config_fill_net`](<#fd_config_fill_net>)
    - [`fd_config_fillf`](<#fd_config_fillf>)
    - [`fd_config_fillh`](<#fd_config_fillh>)


---
### fd\_config\_validatef<!-- {{#callable:fd_config_validatef}} -->
[View Source →](<../../../../../src/app/shared/fd_config.c#L458>)

Validates the `layout.sign_tile_count` field in the `fd_configf_t` structure to ensure it is non-zero and at least 2.
- **Inputs**:
    - `config`: A pointer to a constant `fd_configf_t` structure containing configuration data to validate.
- **Logic and Control Flow**:
    - Checks if `layout.sign_tile_count` is non-zero using the `CFG_HAS_NON_ZERO` macro.
    - If `layout.sign_tile_count` is less than 2, logs an error using `FD_LOG_ERR`.
- **Output**: No return value; logs an error if validation fails.


---
### fd\_config\_validateh<!-- {{#callable:fd_config_validateh}} -->
[View Source →](<../../../../../src/app/shared/fd_config.c#L466>)

Validates specific configuration fields in a `fd_configh_t` structure to ensure they are non-empty or non-zero.
- **Inputs**:
    - `config`: A pointer to a constant `fd_configh_t` structure containing configuration data to validate.
- **Logic and Control Flow**:
    - Checks if `dynamic_port_range` is non-empty using `CFG_HAS_NON_EMPTY` macro.
    - Checks if `ledger.snapshot_archive_format` is non-empty using `CFG_HAS_NON_EMPTY` macro.
    - Checks if `snapshots.full_snapshot_interval_slots` is non-zero using `CFG_HAS_NON_ZERO` macro.
    - Checks if `snapshots.incremental_snapshot_interval_slots` is non-zero using `CFG_HAS_NON_ZERO` macro.
    - Checks if `snapshots.minimum_snapshot_download_speed` is non-zero using `CFG_HAS_NON_ZERO` macro.
    - Checks if `snapshots.maximum_snapshot_download_abort` is non-zero using `CFG_HAS_NON_ZERO` macro.
    - Checks if `layout.agave_affinity` is non-empty using `CFG_HAS_NON_EMPTY` macro.
- **Output**: No return value; logs an error and exits if any validation fails.


---
### fd\_config\_validate<!-- {{#callable:fd_config_validate}} -->
[View Source →](<../../../../../src/app/shared/fd_config.c#L480>)

Validates the configuration settings for a Firedancer or Frankendancer instance, ensuring all required fields are present and correctly formatted.
- **Inputs**:
    - `config`: A pointer to a constant `fd_config_t` structure containing the configuration settings to validate.
- **Logic and Control Flow**:
    - Check if the configuration is for a Firedancer or Frankendancer instance and call the respective validation function ([`fd_config_validatef`](<#fd_config_validatef>) or [`fd_config_validateh`](<#fd_config_validateh>)).
    - Verify that specific configuration fields are non-empty or non-zero using macros like `CFG_HAS_NON_EMPTY`, `CFG_HAS_NON_ZERO`, and `CFG_HAS_POW2`.
    - For network settings, check the `net.provider` field and validate related settings based on its value ('xdp' or 'socket').
    - Ensure that `tiles.bundle.keepalive_interval_millis` is within the specified range.
    - Log errors and terminate if any validation checks fail.
- **Output**: No return value; the function logs errors and terminates if validation fails.
- **Functions Called**:
    - [`fd_config_validatef`](<#fd_config_validatef>)
    - [`fd_config_validateh`](<#fd_config_validateh>)


---
### fd\_config\_load<!-- {{#callable:fd_config_load}} -->
[View Source →](<../../../../../src/app/shared/fd_config.c#L577>)

Loads and configures a `fd_config_t` structure using default, override, and user configuration data.
- **Inputs**:
    - `is_firedancer`: Indicates if the configuration is for Firedancer (1 for true, 0 for false).
    - `netns`: Indicates if network namespace is enabled (1 for true, 0 for false).
    - `is_local_cluster`: Indicates if the configuration is for a local cluster (1 for true, 0 for false).
    - `default_config`: Pointer to the default configuration data.
    - `default_config_sz`: Size of the default configuration data.
    - `override_config`: Pointer to the override configuration data, if any.
    - `override_config_path`: Path to the override configuration file.
    - `override_config_sz`: Size of the override configuration data.
    - `user_config`: Pointer to the user configuration data, if any.
    - `user_config_sz`: Size of the user configuration data.
    - `user_config_path`: Path to the user configuration file.
    - `config`: Pointer to the `fd_config_t` structure to be populated.
- **Logic and Control Flow**:
    - Initialize the `config` structure to zero using `memset`.
    - Set `config->is_firedancer` to `is_firedancer` and `config->boot_timestamp_nanos` to the current wall clock time.
    - Set the `frontend_release_channel` to 'dev' if `is_firedancer` is true, otherwise set it to 'stable'.
    - Load the default configuration using [`fd_config_load_buf`](<#fd_config_load_buf>) and validate it with [`fd_config_validate`](<#fd_config_validate>).
    - If `override_config` is provided, load and validate it similarly.
    - If `user_config` is provided, load and validate it similarly.
    - Call [`fd_config_fill`](<#fd_config_fill>) to finalize the configuration with network and cluster settings.
- **Output**: Populates the `fd_config_t` structure with the loaded and validated configuration data.
- **Functions Called**:
    - [`fd_config_load_buf`](<#fd_config_load_buf>)
    - [`fd_config_validate`](<#fd_config_validate>)
    - [`fd_config_fill`](<#fd_config_fill>)


---
### fd\_config\_to\_memfd<!-- {{#callable:fd_config_to_memfd}} -->
[View Source →](<../../../../../src/app/shared/fd_config.c#L614>)

Creates a memory file descriptor, writes the configuration data to it, and returns the file descriptor.
- **Inputs**:
    - ``config``: A pointer to a constant `fd_config_t` structure containing the configuration data to be written to the memory file descriptor.
- **Logic and Control Flow**:
    - Create a memory file descriptor using `memfd_create` with the name 'fd_config'.
    - Check if `memfd_create` failed by returning -1 if `config_memfd` is -1.
    - Resize the memory file descriptor to the size of `config_t` using `ftruncate`.
    - If `ftruncate` fails, close the file descriptor and return -1.
    - Map the memory file descriptor to a memory region using `mmap` with read and write permissions.
    - If `mmap` fails, close the file descriptor and return -1.
    - Copy the configuration data from `config` to the mapped memory region using `fd_memcpy`.
    - Unmap the memory region using `munmap`.
    - If `munmap` fails, log a warning and return -1.
    - Return the memory file descriptor `config_memfd`.
- **Output**: An integer representing the memory file descriptor on success, or -1 on failure.



---
Made with ❤️ by [Driver](https://www.driver.ai/)