<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements capability and resource limit checks with error handling for processes.

# Purpose
The code is a C module designed to check and manage process capabilities and resource limits in a Linux environment. It provides functions to verify if a process has the necessary capabilities and to raise resource limits if required. The module includes functions such as [`fd_cap_chk_new`](<#fd_cap_chk_new>), [`fd_cap_chk_join`](<#fd_cap_chk_join>), [`fd_cap_chk_root`](<#fd_cap_chk_root>), [`fd_cap_chk_cap`](<#fd_cap_chk_cap>), and [`fd_cap_chk_raise_rlimit`](<#fd_cap_chk_raise_rlimit>), which are used to initialize capability checks, verify root access, check specific capabilities, and adjust resource limits, respectively. The module also maintains an error log to record any capability or resource limit issues encountered during these checks.

The module defines a private structure `fd_cap_chk_private` to store error messages and count, and it uses Linux-specific system calls and structures, such as `syscall` for `capget` and `struct rlimit` for resource limits. It includes utility functions like [`has_capability`](<#has_capability>) to check for specific capabilities and [`cap_cstr`](<#cap_cstr>) and [`rlimit_cstr`](<#rlimit_cstr>) to convert capability and resource limit identifiers to strings. The module is intended to be used as part of a larger system where capability and resource management is critical, and it provides a clear interface for checking and handling these aspects in a controlled manner.
# Imports and Dependencies

---
- `fd_cap_chk.h`
- `fd_file_util.h`
- `../../util/fd_util.h`
- `unistd.h`
- `stdarg.h`
- `stdio.h`
- `errno.h`
- `sys/syscall.h`
- `sys/resource.h`
- `linux/capability.h`


# Data Structures

---
### fd\_cap\_chk\_private
- **Type**: ``struct``
- **Members**:
    - ``err_cnt``: Stores the count of errors recorded.
    - ``err``: Holds error messages with a maximum of `MAX_ERROR_ENTRIES` entries, each of length `MAX_ERROR_MSG_LEN`.
- **Description**: Manages error tracking for capability checks, storing a count of errors and an array of error messages.


# Functions

---
### fd\_cap\_chk\_add\_error<!-- {{#callable:fd_cap_chk_add_error}} -->
[View Source →](<../../../../../src/app/platform/fd_cap_chk.c#L23>)

Adds a formatted error message to the error log of a capability check structure.
- **Inputs**:
    - `chk`: A pointer to an `fd_cap_chk_t` structure where the error message will be stored.
    - `fmt`: A format string that specifies how to format the error message.
    - `...`: Additional arguments that are used to format the error message according to `fmt`.
- **Logic and Control Flow**:
    - Check if the error count in `chk` has reached `MAX_ERROR_ENTRIES`; if so, log an error and terminate the program.
    - Initialize a `va_list` to handle the variable arguments for the format string.
    - Use `vsnprintf` to format the error message and store it in the next available slot in the `err` array of `chk`.
    - Increment the error count in `chk`.
    - Check if `vsnprintf` returned a negative value, indicating an error, and log an error if so.
    - Check if the formatted message was truncated by comparing the result of `vsnprintf` to `MAX_ERROR_MSG_LEN`; log an error if truncation occurred.
    - End the use of `va_list` with `va_end`.
- **Output**: No return value; the function logs errors and modifies the `chk` structure.


---
### fd\_cap\_chk\_new<!-- {{#callable:fd_cap_chk_new}} -->
[View Source →](<../../../../../src/app/platform/fd_cap_chk.c#L38>)

Initializes a `fd_cap_chk_t` structure in shared memory and sets its error count to zero.
- **Inputs**:
    - `shmem`: A pointer to shared memory where the `fd_cap_chk_t` structure will be initialized.
- **Logic and Control Flow**:
    - Cast the `shmem` pointer to a `fd_cap_chk_t` pointer named `chk`.
    - Set the `err_cnt` field of `chk` to zero.
- **Output**: Returns a pointer to the initialized `fd_cap_chk_t` structure.


---
### fd\_cap\_chk\_join<!-- {{#callable:fd_cap_chk_join}} -->
[View Source →](<../../../../../src/app/platform/fd_cap_chk.c#L45>)

Casts a generic pointer to a `fd_cap_chk_t` pointer.
- **Inputs**:
    - `shchk`: A generic pointer to be cast to a `fd_cap_chk_t` pointer.
- **Logic and Control Flow**:
    - Casts the input pointer `shchk` to a `fd_cap_chk_t` pointer.
    - Returns the casted pointer.
- **Output**: A pointer of type `fd_cap_chk_t`.


---
### fd\_cap\_chk\_root<!-- {{#callable:fd_cap_chk_root}} -->
[View Source →](<../../../../../src/app/platform/fd_cap_chk.c#L50>)

Checks if the process is running as root and logs an error if it is not.
- **Inputs**:
    - ``chk``: A pointer to an `fd_cap_chk_t` structure where errors are logged.
    - ``name``: A string representing the name of the process or operation requiring root access.
    - ``reason``: A string explaining why root access is required for the process or operation.
- **Logic and Control Flow**:
    - Check if the current user ID is zero (indicating root access) using `getuid()`.
    - If the user ID is zero, return immediately without doing anything.
    - If the user ID is not zero, call [`fd_cap_chk_add_error`](<#fd_cap_chk_add_error>) to log an error message in the `chk` structure, indicating that root access is required for the specified `name` and `reason`.
- **Output**: No output is returned; the function logs an error in the `chk` structure if the process is not running as root.
- **Functions Called**:
    - [`fd_cap_chk_add_error`](<#fd_cap_chk_add_error>)


---
### has\_capability<!-- {{#callable:has_capability}} -->
[View Source →](<../../../../../src/app/platform/fd_cap_chk.c#L58>)

Checks if the current process has a specific capability.
- **Inputs**:
    - `capability`: An unsigned integer representing the capability to check.
- **Logic and Control Flow**:
    - Initializes `capdata` array to store capability data and `capheader` with the current process ID and capability version.
    - Calls the `syscall` function with `SYS_capget` to retrieve the capability data for the current process.
    - If the syscall fails, logs an error message and terminates the program.
    - Uses `fd_msan_unpoison` to mark the `capdata` as unpoisoned for memory sanitization purposes.
    - Checks if the effective capabilities in `capdata[0]` include the specified capability by performing a bitwise AND operation.
    - Returns a non-zero value if the capability is present, otherwise returns zero.
- **Output**: Returns a non-zero integer if the specified capability is present, otherwise returns zero.


---
### cap\_cstr<!-- {{#callable:cap_cstr}} -->
[View Source →](<../../../../../src/app/platform/fd_cap_chk.c#L71>)

Maps a capability constant to its corresponding string representation.
- **Inputs**:
    - `capability`: An unsigned integer representing a specific capability constant.
- **Logic and Control Flow**:
    - Uses a `switch` statement to match the `capability` argument against predefined capability constants.
    - Returns the corresponding string representation for each matched capability constant.
    - Includes conditional compilation for capabilities `CAP_PERFMON`, `CAP_BPF`, and `CAP_CHECKPOINT_RESTORE` to handle cases where these are defined.
    - Returns "UNKNOWN" if the `capability` does not match any predefined constants.
- **Output**: A constant character pointer to the string representation of the capability, or "UNKNOWN" if the capability is not recognized.


---
### fd\_cap\_chk\_cap<!-- {{#callable:fd_cap_chk_cap}} -->
[View Source →](<../../../../../src/app/platform/fd_cap_chk.c#L125>)

Checks if a process has a specific capability and logs an error if it does not.
- **Inputs**:
    - ``chk``: A pointer to an `fd_cap_chk_t` structure that stores error information.
    - ``name``: A string representing the name of the process or operation requiring the capability.
    - ``capability``: An unsigned integer representing the capability to check.
    - ``reason``: A string explaining why the capability is required.
- **Logic and Control Flow**:
    - Call [`has_capability`](<#has_capability>) with the `capability` argument to check if the process has the required capability.
    - If the process has the capability, return immediately without doing anything further.
    - If the process does not have the capability, call [`fd_cap_chk_add_error`](<#fd_cap_chk_add_error>) to log an error message, including the `name`, the string representation of the capability from [`cap_cstr`](<#cap_cstr>), and the `reason`.
- **Output**: No output is returned; the function logs an error if the capability check fails.
- **Functions Called**:
    - [`has_capability`](<#has_capability>)
    - [`fd_cap_chk_add_error`](<#fd_cap_chk_add_error>)
    - [`cap_cstr`](<#cap_cstr>)


---
### rlimit\_cstr<!-- {{#callable:rlimit_cstr}} -->
[View Source →](<../../../../../src/app/platform/fd_cap_chk.c#L134>)

Maps a resource limit constant to its corresponding string representation.
- **Inputs**:
    - `resource`: An integer representing a resource limit constant, such as `RLIMIT_CPU` or `RLIMIT_FSIZE`.
- **Logic and Control Flow**:
    - Use a `switch` statement to match the `resource` argument against predefined resource limit constants.
    - Return the corresponding string representation for each matched resource limit constant.
    - If the `resource` does not match any predefined constant, return "UNKNOWN".
- **Output**: A pointer to a string that represents the name of the resource limit constant, or "UNKNOWN" if the constant is not recognized.


---
### fd\_cap\_chk\_raise\_rlimit<!-- {{#callable:fd_cap_chk_raise_rlimit}} -->
[View Source →](<../../../../../src/app/platform/fd_cap_chk.c#L164>)

Attempts to raise the resource limit for a specified resource, checking for necessary capabilities and logging errors if the operation is not permitted.
- **Inputs**:
    - `chk`: A pointer to an `fd_cap_chk_t` structure used to log errors if capability checks fail.
    - `name`: A constant character string representing the name of the process or operation for logging purposes.
    - `_resource`: An integer representing the resource type whose limit is to be raised.
    - `limit`: An unsigned long integer specifying the new limit to set for the resource.
    - `reason`: A constant character string providing the reason for raising the resource limit, used in error messages.
- **Logic and Control Flow**:
    - Convert `_resource` to `fd_rlimit_res_t` type and store it in `resource`.
    - Retrieve the current resource limits using `getrlimit` and store them in `rlim`.
    - If `getrlimit` fails, log an error and exit.
    - If the current limit `rlim.rlim_cur` is greater than or equal to `limit`, return without making changes.
    - Check if the process lacks the `CAP_SYS_RESOURCE` capability.
    - If the resource is `RLIMIT_NICE` and the process has `CAP_SYS_NICE`, return without raising the limit.
    - If the resource is `RLIMIT_NICE` and the process lacks both `CAP_SYS_RESOURCE` and `CAP_SYS_NICE`, log an error indicating the missing capabilities.
    - For other resources, if the process lacks `CAP_SYS_RESOURCE`, log an error indicating the missing capability.
    - If the process has `CAP_SYS_RESOURCE` and the resource is `RLIMIT_NOFILE`, read `/proc/sys/fs/nr_open` to check if it is below `limit`.
    - If `/proc/sys/fs/nr_open` is below `limit`, log an error and exit.
    - Set `rlim.rlim_cur` and `rlim.rlim_max` to `limit`.
    - Attempt to set the new resource limits using `setrlimit`.
    - If `setrlimit` fails, log an error and exit.
- **Output**: No direct output is returned; errors are logged or added to the `chk` structure if capability checks fail.
- **Functions Called**:
    - [`has_capability`](<#has_capability>)
    - [`fd_cap_chk_add_error`](<#fd_cap_chk_add_error>)
    - [`cap_cstr`](<#cap_cstr>)
    - [`fd_file_util_read_uint`](<fd_file_util.c.md#fd_file_util_read_uint>)
    - [`rlimit_cstr`](<#rlimit_cstr>)


---
### fd\_cap\_chk\_err\_cnt<!-- {{#callable:fd_cap_chk_err_cnt}} -->
[View Source →](<../../../../../src/app/platform/fd_cap_chk.c#L219>)

Returns the error count from a capability check structure.
- **Inputs**:
    - `chk`: A pointer to a constant `fd_cap_chk_t` structure that contains the error count.
- **Logic and Control Flow**:
    - Accesses the `err_cnt` field of the `fd_cap_chk_t` structure pointed to by `chk`.
    - Returns the value of `err_cnt`.
- **Output**: The function returns an unsigned long integer representing the number of errors recorded in the capability check structure.


---
### fd\_cap\_chk\_err<!-- {{#callable:fd_cap_chk_err}} -->
[View Source →](<../../../../../src/app/platform/fd_cap_chk.c#L224>)

Retrieves an error message from a capability check structure at a specified index.
- **Inputs**:
    - `chk`: A pointer to a `fd_cap_chk_t` structure that contains error messages.
    - `idx`: An unsigned long integer representing the index of the error message to retrieve.
- **Logic and Control Flow**:
    - Accesses the `err` array within the `chk` structure using the provided `idx` index.
    - Returns the error message located at the specified index.
- **Output**: A constant character pointer to the error message at the specified index in the `chk` structure's `err` array.



---
Made with ❤️ by [Driver](https://www.driver.ai/)