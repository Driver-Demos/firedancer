<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

System utility functions for process management, user identification, and sleep operations.

# Purpose
The code provides utility functions for system-level operations in a C program. It includes functions for exiting a process group, sleeping for a specified duration, retrieving the login username, and converting a username to user and group IDs. The function [`fd_sys_util_exit_group`](<#fd_sys_util_exit_group>) uses a system call to terminate all threads in a process group. The [`fd_sys_util_nanosleep`](<#fd_sys_util_nanosleep>) function allows the program to pause execution for a specified number of seconds and nanoseconds, handling interruptions by signals. The [`fd_sys_util_login_user`](<#fd_sys_util_login_user>) function attempts to determine the current user's login name by checking various environment variables and system calls. The [`fd_sys_util_user_to_uid`](<#fd_sys_util_user_to_uid>) function maps a username to its corresponding user ID (UID) and group ID (GID) by forking a process to safely call `getpwnam_r`, which may interact with system services like NCSD or SSSD.

This code is part of a C source file intended to be used as a utility library for system operations. It includes necessary headers for system calls and error handling, and it defines functions that can be used by other parts of a program to perform specific system-related tasks. The functions handle errors and edge cases, such as interrupted system calls and missing user information, and they use logging to report issues. The code does not define a public API or external interfaces but provides internal utility functions that can be integrated into larger applications.
# Imports and Dependencies

---
- `fd_sys_util.h`
- `pwd.h`
- `errno.h`
- `stdlib.h`
- `time.h`
- `unistd.h`
- `sys/syscall.h`
- `sys/mman.h`
- `sys/wait.h`


# Functions

---
### fd\_sys\_util\_exit\_group<!-- {{#callable:fd_sys_util_exit_group}} -->
[View Source →](<../../../../../src/app/platform/fd_sys_util.c#L13>)

Terminates all threads in a process with the specified exit code.
- **Inputs**:
    - `code`: The exit code to terminate the process with.
- **Logic and Control Flow**:
    - Calls the `syscall` function with `SYS_exit_group` and the provided `code` to terminate all threads in the process.
    - Enters an infinite loop to ensure the function does not return, as indicated by the `noreturn` attribute.
- **Output**: Does not return a value as it terminates the process.


---
### fd\_sys\_util\_nanosleep<!-- {{#callable:fd_sys_util_nanosleep}} -->
[View Source →](<../../../../../src/app/platform/fd_sys_util.c#L19>)

Pauses the execution of the program for a specified number of seconds and nanoseconds, handling interruptions by signals.
- **Inputs**:
    - `secs`: The number of seconds to sleep.
    - `nanos`: The number of nanoseconds to sleep.
- **Logic and Control Flow**:
    - Initialize a `timespec` structure `ts` with `secs` and `nanos`.
    - Declare a `timespec` structure `rem` to store remaining time if interrupted.
    - Enter a loop that calls `nanosleep` with `ts` and `rem`.
    - If `nanosleep` returns -1 and `errno` is `EINTR`, update `ts` with `rem` to retry the sleep.
    - If `nanosleep` fails for other reasons, return -1.
    - If `nanosleep` succeeds, exit the loop and return 0.
- **Output**: Returns 0 on successful sleep completion, or -1 if an error occurs other than interruption by a signal.


---
### fd\_sys\_util\_login\_user<!-- {{#callable:fd_sys_util_login_user}} -->
[View Source →](<../../../../../src/app/platform/fd_sys_util.c#L31>)

Retrieves the login name of the current user from environment variables or system calls.
- **Inputs**: None
- **Logic and Control Flow**:
    - Check the environment variable `SUDO_USER` for a user name; if found, return it.
    - Check the environment variable `LOGNAME` for a user name; if found, return it.
    - Check the environment variable `USER` for a user name; if found, return it.
    - Check the environment variable `LNAME` for a user name; if found, return it.
    - Check the environment variable `USERNAME` for a user name; if found, return it.
    - Call `getlogin()` to get the user name if none of the environment variables are set.
    - If `getlogin()` fails and `errno` is `ENXIO` or `ENOTTY`, return `NULL`.
    - If `getlogin()` fails for other reasons, log an error and terminate the program.
    - Return the user name obtained from `getlogin()` if successful.
- **Output**: Returns a pointer to a string containing the login name of the user, or `NULL` if it cannot be determined.


---
### fd\_sys\_util\_user\_to\_uid<!-- {{#callable:fd_sys_util_user_to_uid}} -->
[View Source →](<../../../../../src/app/platform/fd_sys_util.c#L54>)

Converts a username to its corresponding user ID (UID) and group ID (GID) using a separate process to avoid file descriptor issues.
- **Inputs**:
    - `user`: A constant character pointer representing the username to convert.
    - `uid`: A pointer to an unsigned integer where the function will store the user ID.
    - `gid`: A pointer to an unsigned integer where the function will store the group ID.
- **Logic and Control Flow**:
    - Allocate a shared memory region using `mmap` to store results.
    - Check if `mmap` failed and return -1 if it did.
    - Initialize the results array with `UINT_MAX` values to indicate uninitialized state.
    - Fork a new process to safely call `getpwnam_r` without leaving file descriptors open.
    - In the child process, call `getpwnam_r` to retrieve the password entry for the given username.
    - If `getpwnam_r` fails, log a warning and exit the child process with an error code.
    - If successful, store the retrieved UID and GID in the shared memory and exit the child process.
    - In the parent process, wait for the child process to complete using `waitpid`.
    - Check if the child process terminated due to a signal or exited with a non-zero status, log warnings, and return -1 if so.
    - Verify that the results are not `UINT_MAX`, indicating successful retrieval, otherwise return -1.
    - Copy the UID and GID from the shared memory to the provided pointers.
    - Unmap the shared memory region and return 0 on success.
- **Output**: Returns 0 on success, and -1 on failure, with `uid` and `gid` set to the user's UID and GID respectively if successful.
- **Functions Called**:
    - [`fd_sys_util_exit_group`](<#fd_sys_util_exit_group>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)