<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Utility functions for file operations, including reading, writing, directory management, and file path retrieval.

# Purpose
The code provides a set of utility functions for file operations in C. It includes functions to read and write unsigned long and unsigned int values from and to files, create directories recursively, remove directories and their contents, retrieve the path of the current executable, and read the entire contents of a file into memory. These functions are designed to handle common file-related tasks, such as opening, reading, writing, and closing files, as well as managing directory structures.

The functions use standard C library functions and system calls, such as `open`, `read`, `write`, `close`, `mkdir`, `chown`, `chmod`, `opendir`, `readdir`, `unlink`, `rmdir`, `readlink`, and `mmap`. Error handling is implemented using return codes and the `errno` variable to indicate failure conditions. The code is intended to be part of a larger application or library, providing file utility functions that can be reused across different parts of a program. The functions are not designed to be standalone executables but rather to be included and called from other C source files.
# Imports and Dependencies

---
- `fd_file_util.h`
- `stdio.h`
- `errno.h`
- `limits.h`
- `dirent.h`
- `fcntl.h`
- `stdlib.h`
- `unistd.h`
- `sys/stat.h`
- `sys/mman.h`


# Functions

---
### fd\_file\_util\_read\_ulong<!-- {{#callable:fd_file_util_read_ulong}} -->
[View Source →](<../../../../../src/app/platform/fd_file_util.c#L13>)

Reads an unsigned long integer from a file and stores it in a provided variable.
- **Inputs**:
    - ``path``: A constant character pointer representing the file path to read from.
    - ``value``: A pointer to an unsigned long where the function will store the read value.
- **Logic and Control Flow**:
    - Open the file at the specified `path` in read-only mode.
    - If the file cannot be opened, return -1.
    - Read up to 31 bytes from the file into a buffer `buf`.
    - If the read operation fails or reads an invalid number of bytes, set `errno` to `EINVAL`, close the file, and return -1.
    - Null-terminate the buffer to ensure it is a valid string.
    - Close the file descriptor.
    - Convert the string in `buf` to an unsigned long using `strtoul`.
    - If the conversion results in a range error, return -1.
    - If the conversion does not consume the entire string (i.e., there are leftover characters that are not newline or null), set `errno` to `EINVAL` and return -1.
    - Store the converted value in the location pointed to by `value`.
    - Return 0 to indicate success.
- **Output**: Returns 0 on success, or -1 on failure, with `errno` set to indicate the error.


---
### fd\_file\_util\_read\_uint<!-- {{#callable:fd_file_util_read_uint}} -->
[View Source →](<../../../../../src/app/platform/fd_file_util.c#L49>)

Reads an unsigned integer from a file and stores it in the provided variable.
- **Inputs**:
    - ``path``: A constant character pointer to the file path from which to read the unsigned integer.
    - ``value``: A pointer to an unsigned integer where the function will store the read value.
- **Logic and Control Flow**:
    - Declare a variable `_value` of type `ulong` to temporarily store the read value.
    - Call [`fd_file_util_read_ulong`](<#fd_file_util_read_ulong>) with `path` and `_value` to read an unsigned long integer from the file.
    - If [`fd_file_util_read_ulong`](<#fd_file_util_read_ulong>) returns -1, return -1 to indicate an error.
    - Check if `_value` exceeds `UINT_MAX`; if true, set `errno` to `ERANGE` and return -1 to indicate an error.
    - Cast `_value` to `uint` and store it in the location pointed to by `value`.
    - Return 0 to indicate success.
- **Output**: Returns 0 on success, or -1 if an error occurs (e.g., if the file cannot be read or the value exceeds `UINT_MAX`).
- **Functions Called**:
    - [`fd_file_util_read_ulong`](<#fd_file_util_read_ulong>)


---
### fd\_file\_util\_write\_ulong<!-- {{#callable:fd_file_util_write_ulong}} -->
[View Source →](<../../../../../src/app/platform/fd_file_util.c#L63>)

Writes an unsigned long integer to a specified file path.
- **Inputs**:
    - ``path``: A constant character pointer that specifies the file path where the unsigned long integer will be written.
    - ``value``: An unsigned long integer that will be written to the file.
- **Logic and Control Flow**:
    - Open the file at the specified `path` with write-only, create, and truncate options, and set user read and write permissions.
    - If the file descriptor `fd` is -1, return -1 to indicate an error opening the file.
    - Format the `value` as a string with a newline character and store it in the buffer `buf`.
    - Check that the formatted string length `len` is valid and does not exceed the buffer size.
    - Write the formatted string from `buf` to the file using the file descriptor `fd`.
    - If the write operation returns -1, close the file and return -1 to indicate an error.
    - If the number of bytes written does not match `len`, set `errno` to `EINTR`, close the file, and return -1.
    - Close the file descriptor `fd` and return -1 if closing fails.
    - Return 0 to indicate success.
- **Output**: Returns 0 on success, or -1 if an error occurs during file operations.


---
### fd\_file\_util\_mkdir\_all<!-- {{#callable:fd_file_util_mkdir_all}} -->
[View Source →](<../../../../../src/app/platform/fd_file_util.c#L87>)

Creates all directories in a given path, setting ownership and permissions for newly created directories.
- **Inputs**:
    - `_path`: A constant character pointer to the path where directories should be created.
    - `uid`: An unsigned integer representing the user ID to set for newly created directories.
    - `gid`: An unsigned integer representing the group ID to set for newly created directories.
    - `is_dir`: An integer flag indicating whether the final component of the path is a directory that should be created.
- **Logic and Control Flow**:
    - Initialize a character array `path` with a maximum length of `PATH_MAX+1UL` and copy `_path` into it.
    - Set a pointer `p` to the start of `path` and increment it if the first character is a '/'.
    - Iterate over each character in `path` until the end of the string is reached.
    - If a '/' is encountered, replace it with a null terminator to create a sub-path, then attempt to create a directory with `mkdir`.
    - If `mkdir` fails and the error is not `EEXIST`, return -1.
    - If `mkdir` succeeds, change the ownership of the directory with `chown` and set its permissions with `chmod`.
    - Restore the '/' character and continue iterating.
    - After the loop, if `is_dir` is true, attempt to create the final directory in the path, set its ownership, and permissions similarly.
    - Return 0 if all operations succeed.
- **Output**: Returns 0 on success, or -1 if an error occurs during directory creation, ownership change, or permission setting.


---
### fd\_file\_util\_rmtree<!-- {{#callable:fd_file_util_rmtree}} -->
[View Source →](<../../../../../src/app/platform/fd_file_util.c#L127>)

Recursively deletes a directory and its contents, optionally removing the root directory.
- **Inputs**:
    - ``path``: A constant character pointer to the path of the directory to delete.
    - ``remove_root``: An integer flag indicating whether to remove the root directory itself (1 to remove, 0 to keep).
- **Logic and Control Flow**:
    - Open the directory specified by `path` using `opendir` and check if it fails.
    - If the directory does not exist (`errno==ENOENT`), return 0; otherwise, return -1.
    - Iterate over each entry in the directory using `readdir`.
    - Skip entries for the current directory (`.`) and parent directory (`..`).
    - Construct the full path for each entry using `fd_cstr_printf_check`.
    - Use `lstat` to get the status of the entry; if it fails and the entry does not exist (`errno==ENOENT`), continue to the next entry.
    - If the entry is a directory (`S_ISDIR`), recursively call [`fd_file_util_rmtree`](<#fd_file_util_rmtree>) on the entry with `remove_root` set to 1.
    - If the entry is a file, attempt to delete it using `unlink`; if it fails and the file does not exist (`errno!=ENOENT`), return -1.
    - After processing all entries, close the directory using `closedir`.
    - If `remove_root` is true, attempt to remove the root directory using `rmdir`.
    - Return 0 on successful completion.
- **Output**: Returns 0 on success, or -1 on failure.
- **Functions Called**:
    - [`fd_file_util_rmtree`](<#fd_file_util_rmtree>)


---
### fd\_file\_util\_self\_exe<!-- {{#callable:fd_file_util_self_exe}} -->
[View Source →](<../../../../../src/app/platform/fd_file_util.c#L172>)

Retrieves the path of the executable for the current process and stores it in the provided buffer.
- **Inputs**:
    - `path`: A character array with a minimum size of `PATH_MAX` to store the path of the executable.
- **Logic and Control Flow**:
    - Calls `readlink` to read the symbolic link `/proc/self/exe` into the `path` buffer with a maximum size of `PATH_MAX`.
    - Checks if `readlink` returns -1, indicating an error, and returns -1 if so.
    - Checks if the number of bytes read is greater than or equal to `PATH_MAX`, sets `errno` to `ERANGE`, and returns -1 if so.
    - Appends a null terminator to the `path` buffer at the position indicated by the number of bytes read.
    - Returns 0 to indicate success.
- **Output**: Returns 0 on success, or -1 on failure, with `errno` set appropriately.


---
### fd\_file\_util\_read\_all<!-- {{#callable:fd_file_util_read_all}} -->
[View Source →](<../../../../../src/app/platform/fd_file_util.c#L185>)

Reads the entire content of a file into memory and returns a pointer to it.
- **Inputs**:
    - ``path``: A constant character pointer to the file path to read.
    - ``out_sz``: A pointer to an unsigned long where the size of the file will be stored.
- **Logic and Control Flow**:
    - Open the file at the specified `path` in read-only mode.
    - If the file descriptor is invalid, return `MAP_FAILED`.
    - Use `fstat` to get the file status and check for errors; if any, close the file and return `MAP_FAILED`.
    - Retrieve the file size from the `stat` structure and store it in `toml_sz`.
    - If the file size is zero, close the file, set `errno` to `EINVAL`, and return `MAP_FAILED`.
    - Map the file into memory using `mmap` with read-only and private flags.
    - If `mmap` fails, close the file and return `MAP_FAILED`.
    - Close the file descriptor and log a warning if closing fails.
    - Store the file size in `out_sz` and return the memory pointer cast to a `char *`.
- **Output**: Returns a pointer to the memory-mapped file content, or `MAP_FAILED` if an error occurs.



---
Made with ❤️ by [Driver](https://www.driver.ai/)