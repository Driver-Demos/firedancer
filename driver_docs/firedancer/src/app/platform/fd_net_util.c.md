<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Network utility functions for managing network namespaces, interfaces, and addresses.

# Purpose
The code provides utility functions for network namespace management and network interface operations in a Linux environment. It includes functions to enter and restore network namespaces, retrieve the index of the default internet interface, and obtain the IP address of a specified network interface. The function [`fd_net_util_netns_enter`](<#fd_net_util_netns_enter>) allows a process to enter a specified network namespace, optionally saving the original namespace for later restoration using [`fd_net_util_netns_restore`](<#fd_net_util_netns_restore>). The function [`fd_net_util_internet_ifindex`](<#fd_net_util_internet_ifindex>) determines the index of the default internet interface by sending a netlink request to the kernel and parsing the response. The function [`fd_net_util_if_addr`](<#fd_net_util_if_addr>) retrieves the IP address associated with a given network interface name using an ioctl system call.

The code is intended to be part of a larger system, likely a library, that provides network-related utilities. It uses system calls and Linux-specific features such as netlink sockets and ioctl to interact with the network stack. The code does not define a public API or external interfaces but provides internal utility functions that can be used by other components of the system to manage network namespaces and interfaces. The inclusion of headers like `<linux/netlink.h>` and `<sys/ioctl.h>` indicates that the code is designed to operate at a low level, interacting directly with the operating system's networking facilities.
# Imports and Dependencies

---
- `fd_net_util.h`
- `fcntl.h`
- `errno.h`
- `sched.h`
- `unistd.h`
- `net/if.h`
- `sys/ioctl.h`
- `sys/socket.h`
- `linux/netlink.h`
- `linux/rtnetlink.h`
- `netinet/in.h`


# Functions

---
### fd\_net\_util\_netns\_enter<!-- {{#callable:fd_net_util_netns_enter}} -->
[View Source →](<../../../../../src/app/platform/fd_net_util.c#L15>)

Enters a specified network namespace and optionally saves the original namespace.
- **Inputs**:
    - `name`: A pointer to a constant character string that specifies the name of the network namespace to enter.
    - `original_netns`: A pointer to an integer where the function will store the file descriptor of the original network namespace, or `NULL` if not needed.
- **Logic and Control Flow**:
    - Constructs the path to the network namespace using the provided `name` and checks if it fits within `PATH_MAX` length.
    - If `original_netns` is not `NULL`, opens the current network namespace and stores its file descriptor in `_original_netns`.
    - Opens the target network namespace specified by `path` and checks for errors.
    - Uses `setns` to switch to the target network namespace and handles any errors.
    - If `original_netns` is not `NULL`, stores `_original_netns` in `original_netns`.
    - Closes the file descriptor for the target network namespace.
    - Creates a socket to bring the loopback interface (`lo`) up using `ioctl` calls.
    - Closes the socket used for the `ioctl` operations.
    - Returns 0 on success or -1 on failure, setting `errno` appropriately.
- **Output**: Returns 0 on success, or -1 on failure with `errno` set to indicate the error.


---
### fd\_net\_util\_netns\_restore<!-- {{#callable:fd_net_util_netns_restore}} -->
[View Source →](<../../../../../src/app/platform/fd_net_util.c#L61>)

Restores the network namespace using a file descriptor and closes the file descriptor.
- **Inputs**:
    - `original_fd`: A file descriptor representing the original network namespace to restore.
- **Logic and Control Flow**:
    - Check if `setns` fails to set the network namespace using `original_fd` and return -1 if it does.
    - Check if `close` fails to close `original_fd` and return -1 if it does.
    - Return 0 if both operations succeed.
- **Output**: Returns 0 on success, or -1 if an error occurs during `setns` or `close` operations.


---
### fd\_net\_util\_internet\_ifindex<!-- {{#callable:fd_net_util_internet_ifindex}} -->
[View Source →](<../../../../../src/app/platform/fd_net_util.c#L68>)

Retrieves the interface index for the default internet route.
- **Inputs**:
    - `ifindex`: A pointer to an unsigned integer where the function will store the interface index of the default internet route.
- **Logic and Control Flow**:
    - Create a socket using `AF_NETLINK`, `SOCK_DGRAM`, and `NETLINK_ROUTE`.
    - Return -1 if socket creation fails.
    - Initialize a `request` structure with netlink message headers and route message for IPv4.
    - Set up a route attribute for the destination IP address 8.8.8.8.
    - Send the netlink request through the socket and check if the send operation was successful.
    - Receive the response from the socket and check for errors or buffer overflow.
    - Parse the netlink response to find the `RTA_OIF` attribute, which contains the interface index.
    - Close the socket and return -1 if closing fails.
    - If a valid interface index is found, store it in `ifindex` and return 0; otherwise, set `errno` to `ENODEV` and return -1.
- **Output**: Returns 0 on success with the interface index stored in `ifindex`, or -1 on failure with `errno` set appropriately.


---
### fd\_net\_util\_if\_addr<!-- {{#callable:fd_net_util_if_addr}} -->
[View Source →](<../../../../../src/app/platform/fd_net_util.c#L138>)

Retrieves the IPv4 address of a specified network interface.
- **Inputs**:
    - `interface`: A string representing the name of the network interface to query.
    - `addr`: A pointer to an unsigned integer where the function will store the IPv4 address of the specified interface.
- **Logic and Control Flow**:
    - Create a socket with `AF_INET` and `SOCK_DGRAM` parameters.
    - Check if socket creation failed and return -1 if it did.
    - Initialize a `struct ifreq` and set its address family to `AF_INET`.
    - Copy the `interface` name into `ifr.ifr_name` and ensure it is null-terminated.
    - Use `ioctl` with `SIOCGIFADDR` to get the interface address and check for failure, returning -1 if it occurs.
    - Close the socket and check for failure, returning -1 if it occurs.
    - Extract the IPv4 address from `ifr.ifr_addr` and store it in the location pointed to by `addr`.
    - Return 0 to indicate success.
- **Output**: Returns 0 on success and -1 on failure, with the IPv4 address stored in the location pointed to by `addr`.



---
Made with ❤️ by [Driver](https://www.driver.ai/)