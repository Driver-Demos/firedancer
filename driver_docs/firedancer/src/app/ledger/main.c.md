<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Main function for a ledger application that processes RocksDB data, including setup and minification.

# Purpose
The code is a C program designed to manage and manipulate RocksDB databases, specifically for operations related to ledger data. It includes functionality to initialize, ingest, and minify RocksDB databases. The program defines a structure `fd_ledger_args_t` to hold various parameters required for these operations, such as paths to the RocksDB directories, slot ranges, and other configuration settings. The [`ingest_rocksdb`](<#ingest_rocksdb>) function reads and processes blocks from a specified RocksDB database within a given slot range, while the [`minify`](<#minify>) function creates a smaller version of a RocksDB database by copying over a specified range of data.

The program also includes a [`main`](<#main>) function that serves as the entry point, where it parses command-line arguments using the [`initial_setup`](<#initial_setup>) function to populate the `fd_ledger_args_t` structure. It supports commands like "minify" to perform specific operations on the RocksDB databases. The code uses various external functions and types, such as `fd_rocksdb_t` and `fd_wksp_t`, indicating dependencies on other modules or libraries for RocksDB and workspace management. The program is structured to handle errors and log messages using macros like `FD_LOG_ERR` and `FD_LOG_NOTICE`, ensuring that operations are monitored and issues are reported.
# Imports and Dependencies

---
- `../../flamenco/types/fd_types.h`
- `../../flamenco/runtime/fd_rocksdb.h`
- `../../flamenco/runtime/context/fd_capture_ctx.h`
- `unistd.h`
- `sys/stat.h`


# Data Structures

---
### fd\_ledger\_args
- **Type**: ``struct``
- **Members**:
    - `wksp`: Pointer to a workspace for blockstore.
    - `cmd`: User-passed command to `fd_ledger`.
    - `start_slot`: Start slot for offline replay.
    - `end_slot`: End slot for offline replay.
    - `hashseed`: Hash seed value.
    - `restore`: Workspace restore path.
    - `shred_max`: Maximum number of shreds.
    - `slot_history_max`: Number of slots stored by blockstore.
    - `mini_db_dir`: Path to the minified RocksDB to be created.
    - `copy_txn_status`: Flag to determine if transactions should be copied to the blockstore during minify/replay.
    - `trash_hash`: Trash hash used for negative cases.
    - `rocksdb_path`: Path to the RocksDB directory.
- **Description**: `fd_ledger_args` is a `struct` that holds configuration parameters for the `fd_ledger` operations, including workspace pointers, command strings, slot ranges for replay, hash seeds, and paths for database directories. It is used to manage and configure the behavior of ledger operations such as minifying and restoring databases.


---
### fd\_ledger\_args\_t
- **Type**: ``struct``
- **Members**:
    - `wksp`: Pointer to a workspace for blockstore.
    - `cmd`: User-passed command to `fd_ledger`.
    - `start_slot`: Start slot for offline replay.
    - `end_slot`: End slot for offline replay.
    - `hashseed`: Hash seed value.
    - `restore`: Workspace restore path.
    - `shred_max`: Maximum number of shreds.
    - `slot_history_max`: Number of slots stored by blockstore.
    - `mini_db_dir`: Path to the minified RocksDB to be created.
    - `copy_txn_status`: Flag to determine if transactions should be copied to the blockstore during minify/replay.
    - `trash_hash`: Trash hash used for negative cases.
    - `rocksdb_path`: Path to the RocksDB directory.
- **Description**: `fd_ledger_args_t` is a structure that holds various parameters and configurations for managing and processing ledger data in a blockstore environment. It includes pointers to workspace and command strings, slot range for replay, hash seed, paths for database directories, and flags for transaction status copying. This structure is used to configure the behavior of ledger operations such as minification and restoration.


# Functions

---
### ingest\_rocksdb<!-- {{#callable:ingest_rocksdb}} -->
[View Source →](<../../../../../src/app/ledger/main.c#L23>)

Processes a range of slots from a RocksDB database, reading and deshredding blocks within the specified slot range.
- **Inputs**:
    - ``file``: Path to the RocksDB database file.
    - ``start_slot``: The starting slot number for processing.
    - ``end_slot``: The ending slot number for processing.
    - ``trash_hash``: Unused parameter, marked as `FD_PARAM_UNUSED`.
- **Logic and Control Flow**:
    - Initialize a `fd_rocksdb_t` object with the given `file` and check for errors.
    - Retrieve the last slot from the RocksDB and check for errors.
    - If the last slot is less than `start_slot`, log an error and exit.
    - Log the start and end slots for ingestion.
    - Initialize a `fd_rocksdb_root_iter_t` iterator and seek to the `start_slot`.
    - If unable to seek to any slot, log an error and exit.
    - Initialize a buffer `trash_hash_buf` with a specific pattern (0xFE).
    - Iterate over slots, reading and deshredding blocks until `end_slot` is reached or no more slots are available.
    - Log a warning every 100 blocks processed.
    - If an error occurs during block retrieval, log an error and exit.
    - Free resources and destroy the RocksDB and iterator objects.
    - Log the total number of blocks ingested.
- **Output**: No return value; logs errors and notices during processing.


---
### wksp\_restore<!-- {{#callable:wksp_restore}} -->
[View Source →](<../../../../../src/app/ledger/main.c#L100>)

Restores a workspace using the provided restore path and hash seed if the restore path is not NULL.
- **Inputs**:
    - `args`: A pointer to an `fd_ledger_args_t` structure containing the workspace, restore path, and hash seed.
- **Logic and Control Flow**:
    - Check if `args->restore` is not NULL.
    - If not NULL, log a notice message indicating the restoration of the workspace with the specified restore path.
    - Call `fd_wksp_restore` with the workspace, restore path, and hash seed from `args`.
- **Output**: No return value; performs actions based on the input arguments.


---
### minify<!-- {{#callable:minify}} -->
[View Source →](<../../../../../src/app/ledger/main.c#L109>)

Reduces the size of a RocksDB database by copying a specified range of slots to a new database, optionally including transaction statuses.
- **Inputs**:
    - `args`: A pointer to `fd_ledger_args_t` structure containing parameters such as paths to the original and minified RocksDB directories, start and end slots, and a flag to copy transaction statuses.
- **Logic and Control Flow**:
    - Check if `rocksdb_path` and `mini_db_dir` in `args` are not NULL; log an error if they are.
    - Initialize a `fd_rocksdb_t` instance for the large RocksDB using `fd_rocksdb_init`; log an error if initialization fails.
    - Check if the directory for the minified RocksDB already exists using `stat`; log an error if it does.
    - Create a new `fd_rocksdb_t` instance for the minified RocksDB using `fd_rocksdb_new`.
    - Determine the first and last slots in the large RocksDB using `fd_rocksdb_first_slot` and `fd_rocksdb_last_slot`; adjust `start_slot` and `end_slot` in `args` to be within these bounds.
    - Log a notice about the range of slots being copied.
    - Iterate over slot-indexed column families and copy the specified range from the large to the minified RocksDB using `fd_rocksdb_copy_over_slot_indexed_range`.
    - Log a notice after copying all slot-indexed columns.
    - If `copy_txn_status` in `args` is true, prepare to copy transaction statuses (currently commented out); otherwise, log a notice about skipping this step.
    - Destroy both the large and minified RocksDB instances using `fd_rocksdb_destroy`.
- **Output**: No return value; the function performs operations on the file system and logs messages.


---
### initial\_setup<!-- {{#callable:initial_setup}} -->
[View Source →](<../../../../../src/app/ledger/main.c#L176>)

Parses command-line arguments, initializes a workspace, and sets up shared data structures for further processing.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of strings representing the command-line arguments.
    - `args`: A pointer to an `fd_ledger_args_t` structure where parsed arguments and setup data will be stored.
- **Logic and Control Flow**:
    - Check if `argc` is 1, return 1 if true, indicating insufficient arguments.
    - Call `fd_boot` to initialize the environment with `argc` and `argv`.
    - Parse command-line arguments using `fd_env_strip_cmdline_*` functions to extract various parameters such as `wksp_name`, `page_cnt`, `reset`, `cmd`, etc.
    - Retrieve the hostname and compute a hash seed using `fd_hash`, storing it in `args->hashseed`.
    - Determine the workspace setup: if `wksp_name` is NULL, create an anonymous workspace; otherwise, attach to the specified workspace.
    - If `reset` is true, reset the workspace using `fd_wksp_reset`.
    - Store the parsed arguments into the `args` structure for later use.
    - Log the `rocksdb_path` if it is not NULL.
    - Return 0 to indicate successful setup.
- **Output**: Returns 0 on successful setup, or 1 if insufficient arguments are provided.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/app/ledger/main.c#L244>)

Initializes program arguments, checks the command, and executes the corresponding function or logs an error.
- **Inputs**:
    - `argc`: The number of command-line arguments passed to the program.
    - `argv`: An array of strings representing the command-line arguments.
- **Logic and Control Flow**:
    - Allocate memory for `fd_ledger_args_t` structure with proper alignment using `fd_alloca` and initialize it to zero using `memset`.
    - Call [`initial_setup`](<#initial_setup>) to parse command-line arguments and populate the `args` structure.
    - Check if `args->cmd` is `NULL`; if so, log an error indicating no command was specified.
    - If `args->cmd` is "minify", call the [`minify`](<#minify>) function with `args`.
    - If `args->cmd` is not recognized, log an error indicating an unknown command.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`initial_setup`](<#initial_setup>)
    - [`minify`](<#minify>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)