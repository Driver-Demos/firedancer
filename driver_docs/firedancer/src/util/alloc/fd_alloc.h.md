<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

A high-performance, lock-free memory allocator optimized for concurrency and small allocation sizes.

# Purpose
The code defines a high-performance, lock-free memory allocator named `fd_alloc`. This allocator is designed for efficient memory management in concurrent and single-threaded environments. It is optimized for small, clustered, and multi-modal distributed allocation sizes, and it maintains good performance even in complex threading scenarios. The allocator stores its state in a workspace (`wksp`) and backs its allocations with the same workspace, avoiding the performance and reliability issues associated with traditional `malloc` implementations. The allocator ensures that memory allocations are real and ready for use without unexpected stalls or memory overcommitment issues.

The code provides several functions to manage memory allocation and deallocation. Key functions include [`fd_alloc_new`](<#fd_alloc_new>) for creating a new allocator, [`fd_alloc_join`](<#fd_alloc_join>) and [`fd_alloc_leave`](<#fd_alloc_leave>) for managing thread participation in the allocator, and [`fd_alloc_malloc`](<#fd_alloc_malloc>) and [`fd_alloc_free`](<#fd_alloc_free>) for allocating and freeing memory. The allocator supports shared memory usage across processes and provides mechanisms for optimizing memory reuse and minimizing fragmentation. Additionally, the code includes utility functions for managing concurrency hints and calculating optimal memory expansion sizes. The header file defines constants and types necessary for using the allocator, such as alignment and footprint requirements, and provides inline functions for efficient operations.
# Imports and Dependencies

---
- `../wksp/fd_wksp.h`


# Data Structures

---
### fd\_alloc\_t
- **Type**: ``typedef struct fd_alloc fd_alloc_t;``
- **Description**: Defines `fd_alloc_t` as a type alias for the `fd_alloc` structure, which is used as an opaque handle for a high-performance, lock-free allocator optimized for concurrency and small allocation sizes.


# Functions

---
### fd\_alloc\_join\_cgroup\_hint<!-- {{#callable:fd_alloc_join_cgroup_hint}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.h#L243>)

Calculates the concurrency group hint for a given join by applying a bitwise AND operation with a predefined maximum value.
- **Inputs**:
    - `join`: A pointer to an `fd_alloc_t` structure representing the current join.
- **Logic and Control Flow**:
    - Casts the `join` pointer to an `ulong` type.
    - Performs a bitwise AND operation between the casted `join` value and the constant `FD_ALLOC_JOIN_CGROUP_HINT_MAX`.
    - Returns the result of the bitwise AND operation.
- **Output**: An `ulong` value representing the concurrency group hint, which is within the range [0, `FD_ALLOC_JOIN_CGROUP_HINT_MAX`].


---
### fd\_alloc\_join\_cgroup\_hint\_set<!-- {{#callable:fd_alloc_join_cgroup_hint_set}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.h#L248>)

Updates the concurrency group hint of a `fd_alloc_t` join by combining the existing join address with a new hint value.
- **Inputs**:
    - ``join``: A pointer to a `fd_alloc_t` structure representing the current join.
    - ``cgroup_hint``: An unsigned long integer representing the new concurrency group hint to set.
- **Logic and Control Flow**:
    - Casts the `join` pointer to an unsigned long integer.
    - Applies a bitwise AND operation between the `join` value and the bitwise NOT of `FD_ALLOC_JOIN_CGROUP_HINT_MAX` to clear the current hint bits.
    - Applies a bitwise AND operation between `cgroup_hint` and `FD_ALLOC_JOIN_CGROUP_HINT_MAX` to ensure the hint is within the valid range.
    - Combines the results of the above operations using a bitwise OR to set the new hint.
    - Casts the result back to a `fd_alloc_t` pointer and returns it.
- **Output**: Returns a `fd_alloc_t` pointer with the updated concurrency group hint.


---
### fd\_alloc\_malloc<!-- {{#callable:fd_alloc_malloc}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.h#L322>)

Allocates memory with specified alignment and size using a lock-free allocator.
- **Inputs**:
    - ``join``: A pointer to an `fd_alloc_t` structure representing the allocator to use for the memory allocation.
    - ``align``: An unsigned long specifying the alignment requirement for the memory allocation, which should be a power of 2 or 0.
    - ``sz``: An unsigned long specifying the size of the memory allocation in bytes.
- **Logic and Control Flow**:
    - Initializes a local variable `max` as an array with one element.
    - Calls the function [`fd_alloc_malloc_at_least`](<fd_alloc.c.md#fd_alloc_malloc_at_least>) with `join`, `align`, `sz`, and `max` as arguments.
    - Returns the result of [`fd_alloc_malloc_at_least`](<fd_alloc.c.md#fd_alloc_malloc_at_least>).
- **Output**: Returns a pointer to the allocated memory if successful, or `NULL` if the allocation fails.
- **Functions Called**:
    - [`fd_alloc_malloc_at_least`](<fd_alloc.c.md#fd_alloc_malloc_at_least>)


---
### fd\_alloc\_max\_expand<!-- {{#callable:fd_alloc_max_expand}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.h#L609>)

Calculates a new maximum size for dynamic resizing, ensuring it is greater than or equal to the needed size and handles potential overflow.
- **Inputs**:
    - `max`: The current maximum size of the allocation.
    - `delta`: The minimum increment by which the maximum size should increase, assumed to be greater than 0.
    - `needed`: The required size that the new maximum must accommodate.
- **Logic and Control Flow**:
    - Calculate `t0` as `max + delta` and check for overflow; if overflow occurs, set `t0` to `ULONG_MAX`.
    - Calculate `t1` as `max + (max>>2) + (max>>4)` and check for overflow; if overflow occurs, set `t1` to `ULONG_MAX`.
    - Return the maximum value among `t0`, `t1`, and `needed` using `fd_ulong_max`.
- **Output**: Returns the new maximum size, which is at least the maximum of `needed` and the current `max`, and greater than `max` if `max` is less than `ULONG_MAX`.


# Function Declarations (Public API)

---
### fd\_alloc\_align<!-- {{#callable_declaration:fd_alloc_align}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.h#L152>)

Returns the alignment requirement for a `fd_alloc_t`.
- **Description**: Use this function to obtain the alignment requirement for a `fd_alloc_t` type. This is useful when you need to ensure that memory allocations for `fd_alloc_t` are correctly aligned. The function does not require any parameters and can be called at any time to retrieve the alignment value.
- **Inputs**: None
- **Output**: The function returns an unsigned long integer representing the alignment requirement for a `fd_alloc_t`.
- **See Also**: [`fd_alloc_align`](<fd_alloc.c.md#fd_alloc_align>)  (Implementation)


---
### fd\_alloc\_footprint<!-- {{#callable_declaration:fd_alloc_footprint}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.h#L159>)

Returns the memory footprint required for an allocator.
- **Description**: Use this function to determine the size of memory required to store an instance of the allocator. This is useful for allocating the correct amount of memory when setting up the allocator. The function does not require any parameters and can be called at any time to retrieve the constant size value.
- **Inputs**: None
- **Output**: The function returns an unsigned long integer representing the size in bytes required for the allocator.
- **See Also**: [`fd_alloc_footprint`](<fd_alloc.c.md#fd_alloc_footprint>)  (Implementation)


---
### fd\_alloc\_new<!-- {{#callable_declaration:fd_alloc_new}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.h#L175>)

Formats a workspace allocation for use as a lock-free allocator.
- **Description**: Use this function to initialize a workspace allocation as a lock-free allocator. The function requires a valid, aligned memory region backed by a workspace and a positive tag for allocation tracking. It returns the same memory region on success or NULL if the inputs are invalid, logging details of any failure. This function is useful for setting up multiple allocators within a single workspace, allowing them to share the workspace dynamically while acting as separate arenas.
- **Inputs**:
    - `shmem`: A pointer to the memory region to format as an allocator. Must not be NULL, must be aligned to `fd_alloc_t`, and must be backed by a workspace. Caller retains ownership.
    - `tag`: A positive integer used to tag allocations for diagnostics and garbage collection. Must be non-zero.
- **Output**: Returns the `shmem` pointer on success, or NULL on failure if `shmem` is NULL, misaligned, or not backed by a workspace, or if `tag` is zero.
- **See Also**: [`fd_alloc_new`](<fd_alloc.c.md#fd_alloc_new>)  (Implementation)


---
### fd\_alloc\_join<!-- {{#callable_declaration:fd_alloc_join}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.h#L205>)

Joins a caller to a memory allocator.
- **Description**: Use this function to join a caller to a memory allocator, which allows the caller to manage memory allocations within a shared workspace. This function requires a valid memory region pointer and a concurrency group hint to optimize parallel usage. It returns an opaque handle on success, which is essential for subsequent memory operations. Ensure that the memory region is correctly aligned and initialized before calling this function. If the input parameters are invalid, the function logs a warning and returns NULL.
- **Inputs**:
    - `shalloc`: A pointer to the first byte of the memory region backing the allocator. Must not be NULL and must be aligned to the requirements of `fd_alloc_t`. The caller retains ownership.
    - `cgroup_hint`: A concurrency hint used to optimize parallel and persistent use cases. Valid values are in the range [0, FD_ALLOC_JOIN_CGROUP_HINT_MAX]. If the value is outside this range, it will be wrapped to fit.
- **Output**: Returns an opaque handle of type `fd_alloc_t *` on success, or NULL on failure if the input parameters are invalid.
- **See Also**: [`fd_alloc_join`](<fd_alloc.c.md#fd_alloc_join>)  (Implementation)


---
### fd\_alloc\_leave<!-- {{#callable_declaration:fd_alloc_leave}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.h#L214>)

Leaves an existing join to a memory allocator.
- **Description**: Use this function to leave a previously established join to a memory allocator. This is necessary to properly manage resources and ensure that the allocator can be safely used by other threads or processes. It is important to call this function for every successful join to maintain system stability and prevent resource leaks. The function returns the underlying shared memory address on success, which is not a simple cast of the join handle. If the join is null, the function logs a warning and returns null.
- **Inputs**:
    - `join`: A pointer to an `fd_alloc_t` structure representing the current join to the allocator. Must not be null. If null, the function logs a warning and returns null.
- **Output**: Returns the underlying shared memory address on success, or null if the join is null.
- **See Also**: [`fd_alloc_leave`](<fd_alloc.c.md#fd_alloc_leave>)  (Implementation)


---
### fd\_alloc\_delete<!-- {{#callable_declaration:fd_alloc_delete}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.h#L230>)

Unformats a workspace allocation used as a fast allocator.
- **Description**: Use this function to unformat a workspace allocation that was previously formatted as a fast allocator. Ensure that no threads are joined to the allocator and that there are no outstanding allocations before calling this function. If there are outstanding allocations, the function will attempt to clean up as many as possible, but it is not guaranteed to find all of them. This function returns the original shared memory pointer on success or NULL on failure, logging details of any issues encountered.
- **Inputs**:
    - `shalloc`: A pointer to the shared memory region that was used as a fast allocator. Must not be NULL and must be properly aligned. If the pointer is NULL or misaligned, the function logs a warning and returns NULL.
- **Output**: Returns the original shared memory pointer on success, or NULL on failure if the input is invalid or if the allocator's magic number is incorrect.
- **See Also**: [`fd_alloc_delete`](<fd_alloc.c.md#fd_alloc_delete>)  (Implementation)


---
### fd\_alloc\_wksp<!-- {{#callable_declaration:fd_alloc_wksp}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.h#L263>)

Returns a pointer to the workspace backing the allocator.
- **Description**: Use this function to obtain a pointer to the workspace associated with a given allocator. This is useful when you need to interact with the workspace directly or query its properties. The function requires a valid allocator join as input and will return NULL if the join is NULL. Ensure that the allocator is properly joined before calling this function.
- **Inputs**:
    - `join`: A pointer to a valid `fd_alloc_t` join. Must not be NULL. If NULL, the function returns NULL.
- **Output**: A pointer to the `fd_wksp_t` workspace associated with the allocator, or NULL if the join is NULL.
- **See Also**: [`fd_alloc_wksp`](<fd_alloc.c.md#fd_alloc_wksp>)  (Implementation)


---
### fd\_alloc\_tag<!-- {{#callable_declaration:fd_alloc_tag}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.h#L264>)

Returns the tag used for allocations from a workspace.
- **Description**: Use this function to obtain the tag associated with allocations from a workspace when you have a valid join to a `fd_alloc`. This function is useful for diagnostics or when you need to verify or log the tag used for allocations. It is important to ensure that the `join` parameter is not null before calling this function, as a null `join` will result in a return value of 0.
- **Inputs**:
    - `join`: A pointer to a `fd_alloc_t` structure representing a current local join to the allocator. Must not be null. If null, the function returns 0.
- **Output**: Returns the tag as an unsigned long integer. If `join` is null, returns 0.
- **See Also**: [`fd_alloc_tag`](<fd_alloc.c.md#fd_alloc_tag>)  (Implementation)


---
### fd\_alloc\_malloc\_at\_least<!-- {{#callable_declaration:fd_alloc_malloc_at_least}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.h#L316>)

Allocates memory with specified alignment and size.
- **Description**: Use this function to allocate memory from a workspace with a specified alignment and size. The function requires a valid join to a `fd_alloc` and will allocate at least the requested size. If the allocation is successful, it returns a pointer to the allocated memory and updates the `max` parameter with the actual size of the allocated memory, which will be at least the requested size. If the allocation fails or if the requested size is zero, it returns `NULL` and sets `max` to zero. Ensure that the `align` parameter is a power of two or zero, where zero defaults to a predefined alignment suitable for C/C++ standards.
- **Inputs**:
    - `join`: A pointer to a `fd_alloc_t` structure representing a current local join to the allocator. Must not be `NULL`.
    - `align`: Specifies the alignment for the allocation. Must be a power of two or zero. Zero defaults to a predefined alignment.
    - `sz`: The minimum number of bytes to allocate. If zero, the function returns `NULL`.
    - `max`: A pointer to an `ulong` where the function will store the actual size of the allocated memory. Must not be `NULL`.
- **Output**: Returns a pointer to the allocated memory on success, or `NULL` on failure. Updates `*max` with the actual size of the allocated memory or zero on failure.
- **See Also**: [`fd_alloc_malloc_at_least`](<fd_alloc.c.md#fd_alloc_malloc_at_least>)  (Implementation)


---
### fd\_alloc\_free<!-- {{#callable_declaration:fd_alloc_free}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.h#L356>)

Frees a previously allocated memory block.
- **Description**: Use this function to release a memory block that was previously allocated using the same allocator. It is important to ensure that the memory block being freed was allocated by the same `fd_alloc` instance. This function is silent on invalid inputs, such as a null allocator or a null pointer, making it suitable for high-performance computing scenarios where error handling is minimized. The function optimizes memory reuse for the concurrency group associated with the provided allocator.
- **Inputs**:
    - `join`: A pointer to an `fd_alloc_t` instance representing the allocator. Must be a valid, non-null join to the allocator that originally allocated the memory block.
    - `laddr`: A pointer to the first byte of the memory block to be freed. Must not be null and must point to a block allocated by the same `fd_alloc` instance.
- **Output**: None
- **See Also**: [`fd_alloc_free`](<fd_alloc.c.md#fd_alloc_free>)  (Implementation)


---
### fd\_alloc\_compact<!-- {{#callable_declaration:fd_alloc_compact}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.h#L387>)

Frees unused workspace allocations in the allocator.
- **Description**: Use this function to release workspace allocations that are not needed for any active user allocations. It is useful for minimizing workspace utilization when there is no concurrent usage of the allocator. If there are no outstanding allocations, all workspace allocations, except for the allocator's state, will be returned to the workspace. This function is safe to use even with concurrent allocator usage, but it is best effort in such cases and does not guarantee minimization of workspace utilization. It is not O(1) and should be used sparingly, such as during program teardown for leak detection.
- **Inputs**:
    - `join`: A pointer to a current local join of the allocator. Must not be null. If the join is invalid, the function logs a warning and returns without making changes.
- **Output**: None
- **See Also**: [`fd_alloc_compact`](<fd_alloc.c.md#fd_alloc_compact>)  (Implementation)


---
### fd\_alloc\_is\_empty<!-- {{#callable_declaration:fd_alloc_is_empty}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.h#L410>)

Checks if the allocator has no outstanding allocations.
- **Description**: Use this function to determine if there are no outstanding allocations in the allocator. It should only be called when there is no concurrent usage of the allocator, as the result is not well-defined otherwise. The function is not optimized for speed and may temporarily lock the underlying workspace. It is suitable for use in scenarios like program teardown for leak detection.
- **Inputs**:
    - `join`: A pointer to a current local join of the allocator. Must not be null. If null, the function returns 0 without any side effects.
- **Output**: Returns 1 if there are no outstanding allocations, otherwise returns 0.
- **See Also**: [`fd_alloc_is_empty`](<fd_alloc.c.md#fd_alloc_is_empty>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)