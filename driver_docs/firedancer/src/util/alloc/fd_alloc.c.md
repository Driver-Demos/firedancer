<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Memory allocation utilities for managing superblocks and sizeclasses, including functions for allocation, deallocation, and diagnostics.

# Purpose
The code is a C implementation of a memory allocator, specifically designed to manage memory allocation and deallocation within a workspace. It provides a set of functions and data structures to handle memory blocks, superblocks, and size classes, allowing for efficient memory management in a multi-threaded environment. The allocator supports both small and large allocations, with small allocations being managed within superblocks and large allocations being handled directly by the workspace.

Key components of the code include functions for determining the preferred size class for a given memory footprint ([`fd_alloc_preferred_sizeclass`](<#fd_alloc_preferred_sizeclass>)), managing block sets within superblocks ([`fd_alloc_block_set_add`](<#fd_alloc_block_set_add>) and [`fd_alloc_block_set_sub`](<#fd_alloc_block_set_sub>)), and handling the allocation and deallocation of memory blocks. The code also includes mechanisms for atomic operations to ensure thread safety when modifying shared data structures. Additionally, the code provides functions for creating, joining, and deleting allocator instances, as well as functions for compacting and checking the emptiness of the allocator. The allocator is designed to work with a specific memory layout, indicated by a magic number, and includes diagnostic functions for printing the state of the allocator and its components.
# Imports and Dependencies

---
- `fd_alloc.h`
- `fd_alloc_cfg.h`
- `../sanitize/fd_asan.h`
- `../sanitize/fd_msan.h`
- `../tmpl/fd_smallset.c`
- `../tmpl/fd_voff.c`
- `../wksp/fd_wksp_private.h`
- `stdio.h`


# Data Structures

---
### fd\_alloc\_superblock
- **Type**: ``struct fd_alloc_superblock``
- **Members**:
    - ``free_blocks``: Indicates which blocks in the superblock are allocated.
    - ``next_gaddr``: Points to the next inactive superblock or is NULL if not on the inactive stack.
- **Description**: Aligns to `FD_ALLOC_SUPERBLOCK_ALIGN` and manages memory allocation within a superblock. It tracks allocated blocks using `free_blocks` and links to the next inactive superblock with `next_gaddr` when on the inactive stack. The structure is designed to facilitate efficient memory management and allocation within a larger memory workspace.


---
### fd\_alloc\_superblock\_t
- **Type**: ``struct``
- **Members**:
    - ``free_blocks``: Indicates which blocks in the superblock are allocated.
    - ``next_gaddr``: Points to the next inactive superblock or is NULL if not on the inactive stack.
- **Description**: Defines a superblock in a memory allocation system, where `free_blocks` tracks allocated blocks within the superblock, and `next_gaddr` is used for managing inactive superblocks in a stack-like structure. The structure is aligned to `FD_ALLOC_SUPERBLOCK_ALIGN` to ensure that `free_blocks` and `next_gaddr` are on the same cache line, optimizing access performance.


---
### fd\_alloc
- **Type**: ``struct``
- **Members**:
    - ``magic``: A unique identifier for the memory layout, expected to be `FD_ALLOC_MAGIC`.
    - ``wksp_off``: The offset of the first byte of this structure from the start of the workspace.
    - ``tag``: A positive tag used by this allocator.
    - ``active_slot``: An array storing the global address of the active superblock for sizeclass allocations by concurrency group members.
    - ``inactive_stack``: An array representing the top of the inactive stack for each sizeclass, with versioned offsets.
- **Description**: The `fd_alloc` structure is a memory allocator that manages memory allocation within a workspace. It uses a system of active and inactive superblocks to efficiently allocate memory for different size classes and concurrency groups. The `active_slot` array holds the global address of the active superblock for each sizeclass and concurrency group, while the `inactive_stack` array manages the inactive superblocks. The structure is aligned to `FD_ALLOC_ALIGN` and includes padding to ensure 128-byte alignment for its arrays, minimizing false sharing in concurrent operations.


# Functions

---
### fd\_alloc\_preferred\_sizeclass<!-- {{#callable:fd_alloc_preferred_sizeclass}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L21>)

Determines the smallest size class that can accommodate a given memory footprint.
- **Inputs**:
    - `footprint`: The memory footprint size for which the function needs to find a suitable size class.
- **Logic and Control Flow**:
    - Initialize `l` to 0 and `h` to `FD_ALLOC_SIZECLASS_CNT-1` to set the search range for size classes.
    - Iterate 7 times to perform a binary search within the size class range, assuming `FD_ALLOC_SIZECLASS_CNT` is between 64 and 128.
    - In each iteration, calculate the midpoint `m` as `(l+h)>>1`.
    - Check if the size class at index `m` can accommodate the `footprint` by comparing `fd_alloc_sizeclass_cfg[m].block_footprint` with `footprint`.
    - Use conditional move operations (`fd_ulong_if`) to adjust `l` and `h` based on whether the current size class is suitable.
    - After the loop, `h` will hold the index of the smallest suitable size class.
- **Output**: Returns the index of the smallest size class that can accommodate the given `footprint`.


---
### fd\_alloc\_preferred\_sizeclass\_cgroup<!-- {{#callable:fd_alloc_preferred_sizeclass_cgroup}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L52>)

Calculates the preferred sizeclass concurrency group for a given sizeclass and concurrency group index.
- **Inputs**:
    - `sizeclass`: The index of the sizeclass, which must be within the range [0, FD_ALLOC_SIZECLASS_CNT).
    - `cgroup_idx`: The index of the concurrency group for which the preferred sizeclass is being determined.
- **Logic and Control Flow**:
    - Retrieve the `cgroup_mask` for the given `sizeclass` from the `fd_alloc_sizeclass_cfg` array.
    - Perform a bitwise AND operation between `cgroup_idx` and the `cgroup_mask` to determine the preferred concurrency group.
- **Output**: Returns the preferred concurrency group index as an unsigned long integer.


---
### fd\_alloc\_block\_set\_add<!-- {{#callable:fd_alloc_block_set_add}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L100>)

Adds a specified number of blocks to a block set and returns the previous value of the block set.
- **Inputs**:
    - ``set``: A pointer to a `fd_alloc_block_set_t` representing the current block set.
    - ``blocks``: A `fd_alloc_block_set_t` representing the number of blocks to add to the block set.
- **Logic and Control Flow**:
    - Declare a variable `ret` of type `fd_alloc_block_set_t` to store the previous value of the block set.
    - Call `FD_COMPILER_MFENCE()` to ensure memory ordering before reading the current value of the block set.
    - Assign the current value of the block set pointed to by `set` to `ret` using `FD_VOLATILE_CONST`.
    - Add `blocks` to the current value of the block set and store the result back into the block set using `FD_VOLATILE`.
    - Call `FD_COMPILER_MFENCE()` again to ensure memory ordering after updating the block set.
    - Return the previous value of the block set stored in `ret`.
- **Output**: The function returns the previous value of the block set before the addition of `blocks`.


---
### fd\_alloc\_block\_set\_sub<!-- {{#callable:fd_alloc_block_set_sub}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L111>)

Subtracts a specified number of blocks from a block set and returns the original value of the block set.
- **Inputs**:
    - ``set``: A pointer to a `fd_alloc_block_set_t` representing the block set from which blocks will be subtracted.
    - ``blocks``: A `fd_alloc_block_set_t` value representing the number of blocks to subtract from the block set.
- **Logic and Control Flow**:
    - Declare a variable `ret` of type `fd_alloc_block_set_t` to store the original value of the block set.
    - Execute a memory fence using `FD_COMPILER_MFENCE()` to ensure memory operations are completed in order.
    - Assign the current value of the block set pointed to by `set` to `ret` using `FD_VOLATILE_CONST`.
    - Subtract `blocks` from the block set pointed to by `set` and store the result back in `set` using `FD_VOLATILE`.
    - Execute another memory fence using `FD_COMPILER_MFENCE()` to ensure memory operations are completed in order.
    - Return the original value of the block set stored in `ret`.
- **Output**: The function returns the original value of the block set before the subtraction operation.


---
### fd\_alloc\_private\_wksp<!-- {{#callable:fd_alloc_private_wksp}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L202>)

Calculates the address of the workspace backing a given allocator by subtracting the workspace offset from the allocator's address.
- **Inputs**:
    - ``alloc``: A pointer to an `fd_alloc_t` structure, representing the allocator whose backing workspace address is to be calculated.
- **Logic and Control Flow**:
    - Cast the `alloc` pointer to an unsigned long integer.
    - Subtract the `wksp_off` field of the `alloc` structure from the casted value.
    - Cast the result back to a pointer of type `fd_wksp_t`.
- **Output**: A pointer to the `fd_wksp_t` structure representing the workspace backing the given allocator.


---
### fd\_alloc\_private\_active\_slot\_replace<!-- {{#callable:fd_alloc_private_active_slot_replace}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L212>)

Replaces the value in the memory location pointed to by `active_slot` with `new_superblock_gaddr` and returns the previous value.
- **Inputs**:
    - ``active_slot``: A pointer to a memory location that holds the address of the current active superblock.
    - ``new_superblock_gaddr``: The new address of the superblock to be set as active.
- **Logic and Control Flow**:
    - Execute a memory fence to ensure memory operations are completed in order.
    - If atomic operations are supported (`FD_HAS_ATOMIC` is true), use `FD_ATOMIC_XCHG` to atomically exchange the value at `active_slot` with `new_superblock_gaddr` and store the old value in `old_superblock_gaddr`.
    - If atomic operations are not supported, read the current value at `active_slot` into `old_superblock_gaddr`, then set `active_slot` to `new_superblock_gaddr` using volatile operations.
    - Execute another memory fence to ensure the operation is completed before proceeding.
    - Return the old value stored in `old_superblock_gaddr`.
- **Output**: The function returns the previous value of the superblock address that was stored in `active_slot`.


---
### fd\_alloc\_private\_inactive\_stack\_push<!-- {{#callable:fd_alloc_private_inactive_stack_push}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L232>)

Pushes a superblock onto the inactive stack in a workspace, ensuring atomicity if supported.
- **Inputs**:
    - ``inactive_stack``: A pointer to the top of the inactive stack where the superblock will be pushed.
    - ``wksp``: A pointer to the workspace that contains the superblock.
    - ``superblock_gaddr``: The global address of the superblock to be pushed onto the inactive stack.
- **Logic and Control Flow**:
    - Convert the `superblock_gaddr` to a local address using `fd_wksp_laddr_fast` to access the superblock.
    - Enter an infinite loop to attempt pushing the superblock onto the inactive stack.
    - Read the current top of the inactive stack and store it in `old`.
    - Extract the version and global address from `old`.
    - Create a new versioned global address `new` with an incremented version and the `superblock_gaddr`.
    - Set the `next_gaddr` of the superblock to the current top global address of the stack.
    - If atomic operations are supported (`FD_HAS_ATOMIC`), use `FD_ATOMIC_CAS` to attempt to update the stack top; otherwise, use a volatile check and update.
    - If the update is successful, break out of the loop; otherwise, pause and retry.
- **Output**: No return value; the function modifies the `inactive_stack` to include the new superblock.


---
### fd\_alloc\_private\_inactive\_stack\_pop<!-- {{#callable:fd_alloc_private_inactive_stack_pop}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L278>)

Pops a superblock from the top of the inactive stack and returns its global address or 0 if the stack is empty.
- **Inputs**:
    - ``inactive_stack``: A pointer to the top of the inactive stack, which is a versioned global address.
    - ``wksp``: A pointer to the workspace (`fd_wksp_t`) where the superblocks are managed.
- **Logic and Control Flow**:
    - Initialize `top_gaddr` to store the global address of the top superblock.
    - Enter an infinite loop to attempt popping the top of the inactive stack.
    - Read the current top of the inactive stack into `old` and ensure memory consistency with `FD_COMPILER_MFENCE`.
    - Extract the global address (`top_gaddr`) and version (`top_ver`) from `old`.
    - Unpoison `top_gaddr` for memory sanitization purposes.
    - If `top_gaddr` is 0, break the loop as the stack is empty.
    - Retrieve the superblock at `top_gaddr` and read its `next_gaddr` to find the next superblock in the stack.
    - Create a new versioned address `new` with incremented version and `next_gaddr`.
    - Attempt to atomically compare and swap (`FD_ATOMIC_CAS`) the top of the stack from `old` to `new`.
    - If the compare and swap is successful, break the loop.
    - If the compare and swap fails, pause briefly (`FD_SPIN_PAUSE`) and retry.
    - Ensure memory consistency with `FD_COMPILER_MFENCE` before returning `top_gaddr`.
- **Output**: Returns the global address of the popped superblock if successful, or 0 if the stack is empty.


---
### fd\_alloc\_hdr\_load<!-- {{#callable:fd_alloc_hdr_t::fd_alloc_hdr_load}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L351>)

Loads an `fd_alloc_hdr_t` header from a memory location just before the given address.
- **Inputs**:
    - `laddr`: A pointer to the first byte of an allocation in the caller's address space.
- **Logic and Control Flow**:
    - Calculate the address of the header by subtracting the size of `fd_alloc_hdr_t` from the given `laddr`.
    - Use the `FD_LOAD` macro to load the `fd_alloc_hdr_t` from the calculated address.
- **Output**: Returns the `fd_alloc_hdr_t` header located just before the given `laddr`.


---
### fd\_alloc\_hdr\_sizeclass<!-- {{#callable:fd_alloc_hdr_sizeclass}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L364>)

Extracts the size class from an allocation header.
- **Inputs**:
    - `hdr`: An `fd_alloc_hdr_t` type representing the allocation header from which the size class is extracted.
- **Logic and Control Flow**:
    - Performs a bitwise AND operation between `hdr` and `127U` to isolate the size class bits.
    - Casts the result to `ulong` and returns it.
- **Output**: Returns the size class as a `ulong`, which is in the range [0, FD_ALLOC_SIZECLASS_CNT) or FD_ALLOC_SIZECLASS_LARGE.


---
### fd\_alloc\_hdr\_block\_idx<!-- {{#callable:fd_alloc_hdr_block_idx}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L387>)

Extracts the block index from a given allocation header.
- **Inputs**:
    - `hdr`: An `fd_alloc_hdr_t` type representing the allocation header from which the block index is extracted.
- **Logic and Control Flow**:
    - Shift the `hdr` value right by 7 bits.
    - Apply a bitwise AND operation with 63U to isolate the block index.
- **Output**: Returns the block index as an `ulong` type, which is a value between 0 and 63.


---
### fd\_alloc\_hdr\_is\_large<!-- {{#callable:fd_alloc_hdr_is_large}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L394>)

Checks if a given allocation header represents a large direct allocation.
- **Inputs**:
    - ``hdr``: An `fd_alloc_hdr_t` type representing the allocation header to check.
- **Logic and Control Flow**:
    - Calls `fd_uint_clear_bit` on `hdr` with bit position 7 to clear the 7th bit.
    - Compares the result with `FD_ALLOC_HDR_LARGE_DIRECT`.
    - Returns 1 if they are equal, indicating a large direct allocation, otherwise returns 0.
- **Output**: Returns an integer: 1 if the header is for a large direct allocation, 0 otherwise.


---
### fd\_alloc\_hdr\_large\_is\_superblock<!-- {{#callable:fd_alloc_hdr_large_is_superblock}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L403>)

Determines if a large allocation header represents a superblock by checking the 7th bit.
- **Inputs**:
    - ``hdr``: An `fd_alloc_hdr_t` type representing the header of a large allocation.
- **Logic and Control Flow**:
    - Calls `fd_uint_extract_bit` with `hdr` and bit position 7.
    - Returns the result of `fd_uint_extract_bit`, which is 1 if the 7th bit is set, indicating a superblock, or 0 otherwise.
- **Output**: An integer value, 1 if the header is for a superblock, 0 otherwise.


---
### fd\_alloc\_hdr\_store<!-- {{#callable:fd_alloc_hdr_store}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L417>)

Stores a header describing a small sizeclass allocation in the memory immediately preceding the given local address.
- **Inputs**:
    - ``laddr``: A pointer to the local address where the allocation starts in the caller's address space.
    - ``superblock``: A pointer to the superblock containing the allocation.
    - ``block_idx``: The index of the block within the superblock.
    - ``sizeclass``: The size class of the allocation.
- **Logic and Control Flow**:
    - Calculates the offset of the allocation from the start of the superblock and shifts it left by 13 bits.
    - Shifts the `block_idx` left by 7 bits and combines it with the offset.
    - Combines the sizeclass with the previous result to form the header.
    - Stores the header in the memory immediately preceding `laddr`.
    - Returns the original `laddr`.
- **Output**: Returns the original local address `laddr`.


---
### fd\_alloc\_hdr\_store\_large<!-- {{#callable:fd_alloc_hdr_store_large}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L429>)

Stores a header for a large allocation at a specified memory location, indicating whether it is a superblock.
- **Inputs**:
    - `laddr`: A pointer to the memory location where the header will be stored.
    - `is_superblock`: An integer flag (0 or 1) indicating whether the allocation is a superblock.
- **Logic and Control Flow**:
    - Calculates the address to store the header by subtracting the size of `fd_alloc_hdr_t` from `laddr`.
    - Combines the `FD_ALLOC_HDR_LARGE_DIRECT` constant with the `is_superblock` flag shifted left by 7 bits to form the header value.
    - Stores the calculated header value at the computed address.
    - Returns the original `laddr` pointer.
- **Output**: Returns the original `laddr` pointer after storing the header.


---
### fd\_alloc\_private\_join\_alloc<!-- {{#callable:fd_alloc_private_join_alloc}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L442>)

Returns the local address of the allocator for a given join by masking out the concurrency group hint.
- **Inputs**:
    - ``join``: A pointer to an `fd_alloc_t` structure representing the join handle.
- **Logic and Control Flow**:
    - Casts the `join` pointer to an unsigned long integer.
    - Applies a bitwise AND operation with the negation of `FD_ALLOC_JOIN_CGROUP_HINT_MAX` to clear the concurrency group hint bits.
    - Casts the result back to an `fd_alloc_t` pointer.
    - Returns the resulting pointer.
- **Output**: A pointer to an `fd_alloc_t` structure representing the local address of the allocator.


---
### fd\_alloc\_align<!-- {{#callable:fd_alloc_align}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L449>)

Returns the alignment requirement of the `fd_alloc_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls the `alignof` operator on `fd_alloc_t` to determine its alignment requirement.
    - Returns the result of the `alignof` operator.
- **Output**: An unsigned long integer representing the alignment requirement of `fd_alloc_t`.


---
### fd\_alloc\_footprint<!-- {{#callable:fd_alloc_footprint}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L454>)

Returns the size in bytes of the `fd_alloc_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calculate the size of the `fd_alloc_t` structure using the `sizeof` operator.
    - Return the calculated size.
- **Output**: An unsigned long integer representing the size of the `fd_alloc_t` structure in bytes.


---
### fd\_alloc\_superblock\_footprint<!-- {{#callable:fd_alloc_superblock_footprint}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L459>)

Returns the size of the `fd_alloc_superblock_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calculate the size of the `fd_alloc_superblock_t` structure using the `sizeof` operator.
    - Return the calculated size as an unsigned long integer.
- **Output**: The function returns an unsigned long integer representing the size of the `fd_alloc_superblock_t` structure.


---
### fd\_alloc\_new<!-- {{#callable:fd_alloc_new}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L464>)

Initializes a new `fd_alloc_t` structure in shared memory with a specified tag.
- **Inputs**:
    - `shmem`: A pointer to the shared memory location where the `fd_alloc_t` structure will be initialized.
    - `tag`: An unsigned long integer representing a positive tag to be associated with the allocator.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL; if so, log a warning and return NULL.
    - Check if `shmem` is aligned to the alignment of `fd_alloc_t`; if not, log a warning and return NULL.
    - Determine the workspace containing `shmem` using `fd_wksp_containing`; if not found, log a warning and return NULL.
    - Check if `tag` is zero; if so, log a warning and return NULL.
    - Cast `shmem` to `fd_alloc_t*` and zero out the memory for the size of `fd_alloc_t`.
    - Calculate and set the offset of the allocator from the start of the workspace in `wksp_off`.
    - Set the `tag` field of the allocator to the provided `tag`.
    - Use memory fences to ensure memory operations are completed before setting the `magic` field.
    - Set the `magic` field of the allocator to `FD_ALLOC_MAGIC` using a volatile store.
    - Return the `shmem` pointer.
- **Output**: Returns the pointer to the initialized shared memory (`shmem`) or NULL if any checks fail.


---
### fd\_alloc\_join<!-- {{#callable:fd_alloc_join}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L504>)

Validates and joins a shared memory allocator (`shalloc`) with a concurrency group hint (`cgroup_hint`).
- **Inputs**:
    - ``shalloc``: A pointer to the shared memory allocator to join.
    - ``cgroup_hint``: An unsigned long integer providing a hint for the concurrency group.
- **Logic and Control Flow**:
    - Cast `shalloc` to `fd_alloc_t *` and assign it to `alloc`.
    - Check if `alloc` is NULL; if true, log a warning and return NULL.
    - Check if `alloc` is misaligned; if true, log a warning and return NULL.
    - Check if `alloc->magic` is not equal to `FD_ALLOC_MAGIC`; if true, log a warning and return NULL.
    - Call [`fd_alloc_join_cgroup_hint_set`](<fd_alloc.h.md#fd_alloc_join_cgroup_hint_set>) with `alloc` and `cgroup_hint` and return its result.
- **Output**: Returns a pointer to the joined `fd_alloc_t` structure or NULL if any validation fails.
- **Functions Called**:
    - [`fd_alloc_join_cgroup_hint_set`](<fd_alloc.h.md#fd_alloc_join_cgroup_hint_set>)


---
### fd\_alloc\_leave<!-- {{#callable:fd_alloc_leave}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L526>)

Checks if the input pointer is valid and returns the local address of the allocator for a given join.
- **Inputs**:
    - ``join``: A pointer to an `fd_alloc_t` structure representing the join handle.
- **Logic and Control Flow**:
    - Checks if the `join` pointer is NULL using `FD_UNLIKELY`.
    - Logs a warning message 'NULL join' if `join` is NULL and returns NULL.
    - Calls [`fd_alloc_private_join_alloc`](<#fd_alloc_private_join_alloc>) with `join` to get the local address of the allocator and returns it.
- **Output**: Returns the local address of the allocator for the given join, or NULL if the input is invalid.
- **Functions Called**:
    - [`fd_alloc_private_join_alloc`](<#fd_alloc_private_join_alloc>)


---
### fd\_alloc\_delete<!-- {{#callable:fd_alloc_delete}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L536>)

Deallocates a memory allocation and cleans up associated resources.
- **Inputs**:
    - ``shalloc``: A pointer to the memory allocation to be deleted, which must be aligned and have a valid magic number.
- **Logic and Control Flow**:
    - Check if `shalloc` is NULL; if so, log a warning and return NULL.
    - Check if `shalloc` is aligned correctly; if not, log a warning and return NULL.
    - Cast `shalloc` to `fd_alloc_t *` and verify its magic number; if incorrect, log a warning and return NULL.
    - Set the magic number of the allocation to 0 to mark it as deleted.
    - Retrieve the workspace associated with the allocation.
    - Iterate over each size class to clean up active and inactive superblocks.
    - For each size class, iterate over concurrency groups to replace active superblocks with 0 and free them if necessary.
    - Pop and free all inactive superblocks for each size class.
    - Return the original `shalloc` pointer.
- **Output**: Returns the original `shalloc` pointer if successful, or NULL if an error occurs.
- **Functions Called**:
    - [`fd_alloc_private_wksp`](<#fd_alloc_private_wksp>)
    - [`fd_alloc_private_active_slot_replace`](<#fd_alloc_private_active_slot_replace>)
    - [`fd_alloc_free`](<#fd_alloc_free>)
    - [`fd_alloc_private_inactive_stack_pop`](<#fd_alloc_private_inactive_stack_pop>)


---
### fd\_alloc\_wksp<!-- {{#callable:fd_alloc_wksp}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L592>)

Allocates a workspace from a given allocator join handle.
- **Inputs**:
    - ``join``: A pointer to an `fd_alloc_t` structure representing the allocator join handle.
- **Logic and Control Flow**:
    - Checks if `join` is not NULL using `FD_LIKELY` macro.
    - If `join` is valid, calls [`fd_alloc_private_join_alloc`](<#fd_alloc_private_join_alloc>) to get the local address of the allocator.
    - Calls [`fd_alloc_private_wksp`](<#fd_alloc_private_wksp>) with the local address to get the workspace backing the allocator.
    - Returns the workspace if `join` is valid, otherwise returns NULL.
- **Output**: Returns a pointer to the `fd_wksp_t` structure representing the workspace, or NULL if `join` is NULL.
- **Functions Called**:
    - [`fd_alloc_private_wksp`](<#fd_alloc_private_wksp>)
    - [`fd_alloc_private_join_alloc`](<#fd_alloc_private_join_alloc>)


---
### fd\_alloc\_tag<!-- {{#callable:fd_alloc_tag}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L597>)

Retrieves the tag associated with a given `fd_alloc_t` join handle.
- **Inputs**:
    - `join`: A pointer to an `fd_alloc_t` structure representing the join handle from which to retrieve the tag.
- **Logic and Control Flow**:
    - Checks if `join` is likely to be non-null using `FD_LIKELY` macro.
    - If `join` is non-null, calls [`fd_alloc_private_join_alloc`](<#fd_alloc_private_join_alloc>) to get the actual `fd_alloc_t` structure from the join handle.
    - Returns the `tag` field from the `fd_alloc_t` structure if `join` is non-null.
    - Returns `0UL` if `join` is null.
- **Output**: Returns the tag of the allocator if `join` is valid, otherwise returns `0UL`.
- **Functions Called**:
    - [`fd_alloc_private_join_alloc`](<#fd_alloc_private_join_alloc>)


---
### fd\_alloc\_malloc\_at\_least\_impl<!-- {{#callable:fd_alloc_malloc_at_least_impl}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L602>)

Allocates memory with a specified alignment and size, ensuring the allocation is at least the requested size, and returns the maximum possible size of the allocation.
- **Inputs**:
    - ``join``: A pointer to an `fd_alloc_t` structure representing the allocator context.
    - ``align``: The desired alignment for the memory allocation, which must be a power of two.
    - ``sz``: The minimum size of the memory allocation requested.
    - ``max``: A pointer to a `ulong` where the function will store the maximum size of the allocated memory.
- **Logic and Control Flow**:
    - Check if `max` is NULL; if so, return NULL.
    - Retrieve the allocator from the `join` handle.
    - Set default alignment if `align` is zero, and ensure alignment is at least 8 if `FD_HAS_DEEPASAN` is defined.
    - Calculate the total footprint required for the allocation, including header and alignment padding.
    - If the footprint is larger than a threshold, allocate directly from the workspace and return the allocated address.
    - Determine the preferred sizeclass and concurrency group for the allocation.
    - Attempt to get exclusive access to an active superblock for the allocation.
    - If no active superblock is available, try to pop an inactive superblock or allocate a new one.
    - If a superblock is available, allocate a block from it, update the free block set, and return the allocated address.
- **Output**: Returns a pointer to the allocated memory if successful, or NULL if the allocation fails.
- **Functions Called**:
    - [`fd_alloc_private_join_alloc`](<#fd_alloc_private_join_alloc>)
    - [`fd_alloc_private_wksp`](<#fd_alloc_private_wksp>)
    - [`fd_alloc_hdr_store_large`](<#fd_alloc_hdr_store_large>)
    - [`fd_alloc_preferred_sizeclass`](<#fd_alloc_preferred_sizeclass>)
    - [`fd_alloc_preferred_sizeclass_cgroup`](<#fd_alloc_preferred_sizeclass_cgroup>)
    - [`fd_alloc_join_cgroup_hint`](<fd_alloc.h.md#fd_alloc_join_cgroup_hint>)
    - [`fd_alloc_private_active_slot_replace`](<#fd_alloc_private_active_slot_replace>)
    - [`fd_alloc_private_inactive_stack_pop`](<#fd_alloc_private_inactive_stack_pop>)
    - [`fd_alloc_malloc`](<fd_alloc.h.md#fd_alloc_malloc>)
    - [`fd_alloc_private_inactive_stack_push`](<#fd_alloc_private_inactive_stack_push>)
    - [`fd_alloc_hdr_store`](<#fd_alloc_hdr_store>)


---
### fd\_alloc\_malloc\_at\_least<!-- {{#callable:fd_alloc_malloc_at_least}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L890>)

Allocates memory with a specified alignment and size, ensuring the allocated memory is poisoned for memory safety analysis.
- **Inputs**:
    - ``join``: A pointer to an `fd_alloc_t` structure representing the memory allocator context.
    - ``align``: The alignment requirement for the allocated memory, specified as a power of two.
    - ``sz``: The minimum size of the memory block to allocate.
    - ``max``: A pointer to a `ulong` where the function will store the actual size of the allocated memory block.
- **Logic and Control Flow**:
    - Calls [`fd_alloc_malloc_at_least_impl`](<#fd_alloc_malloc_at_least_impl>) with the provided parameters to perform the actual memory allocation.
    - Poisons the allocated memory block using `fd_msan_poison` to ensure memory safety analysis tools can detect uninitialized memory usage.
    - Returns the pointer to the allocated memory block.
- **Output**: Returns a pointer to the allocated memory block, or `NULL` if the allocation fails.
- **Functions Called**:
    - [`fd_alloc_malloc_at_least_impl`](<#fd_alloc_malloc_at_least_impl>)


---
### fd\_alloc\_free<!-- {{#callable:fd_alloc_free}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L900>)

Frees a memory allocation by determining its size class and handling it accordingly, either as a large allocation or a small allocation within a superblock.
- **Inputs**:
    - ``join``: A pointer to the `fd_alloc_t` structure representing the allocator context.
    - ``laddr``: A pointer to the first byte of the memory allocation to be freed.
- **Logic and Control Flow**:
    - Check if `join` or `laddr` is NULL; if so, return immediately.
    - Retrieve the allocator context from `join` using [`fd_alloc_private_join_alloc`](<#fd_alloc_private_join_alloc>).
    - Load the allocation header from `laddr` to determine the size class using [`fd_alloc_hdr_load`](<#fd_alloc_hdr_tfd_alloc_hdr_load>) and [`fd_alloc_hdr_sizeclass`](<#fd_alloc_hdr_sizeclass>).
    - If the size class is `FD_ALLOC_SIZECLASS_LARGE`, free the allocation using `fd_wksp_free` and return.
    - For small allocations, determine the superblock and block index from the header using `fd_alloc_hdr_superblock` and [`fd_alloc_hdr_block_idx`](<#fd_alloc_hdr_block_idx>).
    - Add the block to the set of free blocks in the superblock using `fd_alloc_block_set_add`.
    - If the superblock had no free blocks before this operation, put it back into circulation by updating the active slot or pushing it onto the inactive stack.
    - If the superblock is now completely free, attempt to delete an inactive superblock if it is also completely free, otherwise return it to circulation.
- **Output**: No return value; the function performs the operation of freeing the specified memory allocation.
- **Functions Called**:
    - [`fd_alloc_private_join_alloc`](<#fd_alloc_private_join_alloc>)
    - [`fd_alloc_hdr_t::fd_alloc_hdr_load`](<#fd_alloc_hdr_tfd_alloc_hdr_load>)
    - [`fd_alloc_hdr_sizeclass`](<#fd_alloc_hdr_sizeclass>)
    - [`fd_alloc_private_wksp`](<#fd_alloc_private_wksp>)
    - [`fd_alloc_hdr_block_idx`](<#fd_alloc_hdr_block_idx>)
    - [`fd_alloc_preferred_sizeclass_cgroup`](<#fd_alloc_preferred_sizeclass_cgroup>)
    - [`fd_alloc_join_cgroup_hint`](<fd_alloc.h.md#fd_alloc_join_cgroup_hint>)
    - [`fd_alloc_private_active_slot_replace`](<#fd_alloc_private_active_slot_replace>)
    - [`fd_alloc_private_inactive_stack_push`](<#fd_alloc_private_inactive_stack_push>)
    - [`fd_alloc_private_inactive_stack_pop`](<#fd_alloc_private_inactive_stack_pop>)
    - [`fd_alloc_free`](<#fd_alloc_free>)


---
### fd\_alloc\_compact<!-- {{#callable:fd_alloc_compact}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L1105>)

Reclaims memory by freeing completely empty superblocks in each sizeclass and reorganizing remaining superblocks.
- **Inputs**:
    - ``join``: A pointer to an `fd_alloc_t` structure representing the allocator to compact.
- **Logic and Control Flow**:
    - Retrieve the allocator from the `join` pointer using [`fd_alloc_private_join_alloc`](<#fd_alloc_private_join_alloc>).
    - Check if the allocator is valid; if not, log a warning and return.
    - Get the workspace associated with the allocator using [`fd_alloc_private_wksp`](<#fd_alloc_private_wksp>).
    - Iterate over each sizeclass from 0 to `FD_ALLOC_SIZECLASS_CNT`.
    - For each sizeclass, determine the number of blocks and concurrency groups.
    - For each concurrency group, attempt to free the active superblock if it is completely empty.
    - If the superblock is not empty, return it to circulation or push displaced superblocks onto the inactive stack.
    - Drain the inactive stack, freeing empty superblocks and pushing non-empty ones onto a local stack.
    - Return non-empty superblocks from the local stack back to the inactive stack.
- **Output**: No return value; the function operates by modifying the state of the allocator and workspace.
- **Functions Called**:
    - [`fd_alloc_private_join_alloc`](<#fd_alloc_private_join_alloc>)
    - [`fd_alloc_private_wksp`](<#fd_alloc_private_wksp>)
    - [`fd_alloc_private_active_slot_replace`](<#fd_alloc_private_active_slot_replace>)
    - [`fd_alloc_free`](<#fd_alloc_free>)
    - [`fd_alloc_private_inactive_stack_push`](<#fd_alloc_private_inactive_stack_push>)
    - [`fd_alloc_private_inactive_stack_pop`](<#fd_alloc_private_inactive_stack_pop>)


---
### fd\_alloc\_is\_empty<!-- {{#callable:fd_alloc_is_empty}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L1198>)

Checks if a given memory allocator is empty by verifying that there are no large allocations remaining.
- **Inputs**:
    - ``join``: A pointer to a `fd_alloc_t` structure representing the memory allocator to check.
- **Logic and Control Flow**:
    - Retrieve the private allocator associated with the `join` handle using [`fd_alloc_private_join_alloc`](<#fd_alloc_private_join_alloc>).
    - If the allocator is `NULL`, return 0 indicating it is not empty.
    - Call [`fd_alloc_compact`](<#fd_alloc_compact>) to compact the allocator, ensuring no unnecessary allocations remain.
    - Retrieve the workspace associated with the allocator using [`fd_alloc_private_wksp`](<#fd_alloc_private_wksp>).
    - Calculate the global address range (`alloc_lo` to `alloc_hi`) and the tag of the allocator.
    - Iterate over all partitions in the workspace (`pinfo` array) to check for any large allocations with the same tag as the allocator.
    - If a partition with the same tag is found and its address range does not fully contain the allocator's range, break the loop.
    - Return 1 if no such partitions are found, indicating the allocator is empty; otherwise, return 0.
- **Output**: Returns 1 if the allocator is empty (no large allocations remain), otherwise returns 0.
- **Functions Called**:
    - [`fd_alloc_private_join_alloc`](<#fd_alloc_private_join_alloc>)
    - [`fd_alloc_compact`](<#fd_alloc_compact>)
    - [`fd_alloc_private_wksp`](<#fd_alloc_private_wksp>)


---
### fd\_alloc\_superblock\_fprintf<!-- {{#callable:fd_alloc_superblock_fprintf}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L1250>)

Prints detailed information about the state of a superblock in a workspace to a given stream.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` structure representing the workspace; must not be NULL.
    - ``superblock_gaddr``: An unsigned long representing the global address of the superblock within the workspace; must be valid.
    - ``sizeclass``: An unsigned long representing the size class of the superblock; must be valid.
    - ``block_cnt``: An unsigned long representing the number of blocks in the superblock; must match the size class configuration.
    - ``block_footprint``: An unsigned long representing the footprint of each block in the superblock; must match the size class configuration.
    - ``stream``: A pointer to a `FILE` structure where the output will be printed; must not be NULL.
    - ``ctr``: A pointer to an array of unsigned longs with at least two elements, used to accumulate diagnostic counts; must not be NULL.
- **Logic and Control Flow**:
    - Initialize a counter `cnt` to zero.
    - Retrieve the superblock from the workspace using `superblock_gaddr`.
    - Get the set of free blocks from the superblock.
    - Check if there are any unexpected bits set in the free blocks and update `ctr[0]` if so.
    - Print the free blocks information to the stream.
    - Iterate over each block in the superblock using `block_cnt`.
    - For each block, calculate the global address range (`gaddr_lo` to `gaddr_hi`).
    - Check if the block is free using `fd_alloc_block_set_test`.
    - If the block is used, search for a plausible allocation header (`fd_alloc_hdr_t`) within the block.
    - Estimate alignment and size of the allocation, and print the details to the stream.
    - If no plausible header is found, print a message indicating a bad block and update `ctr[0]`.
    - Return the total number of characters printed (`cnt`).
- **Output**: Returns an integer representing the number of characters printed to the stream, or a negative error code if an error occurs.
- **Functions Called**:
    - [`fd_alloc_hdr_sizeclass`](<#fd_alloc_hdr_sizeclass>)
    - [`fd_alloc_hdr_block_idx`](<#fd_alloc_hdr_block_idx>)


---
### fd\_alloc\_fprintf<!-- {{#callable:fd_alloc_fprintf}} -->
[View Source →](<../../../../../src/util/alloc/fd_alloc.c#L1331>)

Prints detailed information about the current state of a memory allocator to a specified output stream.
- **Inputs**:
    - ``join``: A pointer to the `fd_alloc_t` structure representing the memory allocator to be analyzed.
    - ``stream``: A pointer to a `FILE` stream where the function will print the allocator's details.
- **Logic and Control Flow**:
    - Check if `stream` is NULL; if so, return 0 as nothing can be printed.
    - Initialize a counter array `ctr` to track errors, small allocations found, workspace partitions used, workspace bytes used, large allocations count, and large allocation workspace used.
    - Retrieve the allocator from the `join` handle using [`fd_alloc_private_join_alloc`](<#fd_alloc_private_join_alloc>) and the concurrency group hint using [`fd_alloc_join_cgroup_hint`](<fd_alloc.h.md#fd_alloc_join_cgroup_hint>).
    - If the allocator is NULL, print an error message to `stream` and increment the error counter.
    - If the allocator is valid, print a summary header including the allocator's global address, concurrency group hint, and magic number status.
    - Iterate over each size class to print details about superblock footprints, block footprints, block counts, and concurrency group counts.
    - For each size class, print the inactive stack top and details of active and inactive superblocks.
    - Scan the workspace partition table for partitions matching the allocator's tag and print details about large allocations.
    - Print summary statistics including errors detected, small allocations found, workspace partitions and bytes used, and large allocation counts and workspace used.
- **Output**: Returns the total number of characters printed to the `stream` or a negative error code if an error occurs during printing.
- **Functions Called**:
    - [`fd_alloc_private_join_alloc`](<#fd_alloc_private_join_alloc>)
    - [`fd_alloc_join_cgroup_hint`](<fd_alloc.h.md#fd_alloc_join_cgroup_hint>)
    - [`fd_alloc_private_wksp`](<#fd_alloc_private_wksp>)
    - [`fd_alloc_superblock_fprintf`](<#fd_alloc_superblock_fprintf>)
    - [`fd_alloc_hdr_is_large`](<#fd_alloc_hdr_is_large>)
    - [`fd_alloc_hdr_large_is_superblock`](<#fd_alloc_hdr_large_is_superblock>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)