<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests memory allocation and deallocation functions, including torture tests for single and multi-threaded scenarios.

# Purpose
The code is a C program designed to perform a series of tests on a custom memory allocation system. It includes a main function that initializes the environment, sets up a workspace for memory allocation, and runs a series of tests to validate the functionality of the memory allocator. The program uses a combination of static assertions, random number generation, and bit manipulation to test various aspects of memory allocation, such as alignment, size, and the ability to handle multiple allocations and deallocations. The code also includes mechanisms to test memory integrity by filling allocated memory with unique bit patterns and verifying them before deallocation.

The program is structured to run in a multi-threaded environment, where different threads can perform allocations and deallocations concurrently. It includes two main test functions, [`test_main`](<#test_main>) and [`test2_main`](<#test2_main>), which are executed on different threads to simulate real-world usage scenarios. The code uses a series of macros and utility functions to manage memory and log information about the tests being performed. The program is designed to be run in a hosted environment, as indicated by the `FD_HAS_HOSTED` preprocessor directive, and includes a fallback main function that logs a warning if the required capabilities are not available.
# Imports and Dependencies

---
- `../fd_util.h`
- `stdio.h`
- `stdlib.h`


# Global Variables

---
### \_go
- **Type**: ``int``
- **Description**: The `_go` variable is a static integer that acts as a control flag for the execution of certain loops in the program. It is used to synchronize the start of operations across multiple threads or processes.
- **Use**: Used to signal when threads should start executing their main loop by checking its value in a spin-wait loop.


---
### \_shalloc
- **Type**: ``void *``
- **Description**: Points to a memory region used for shared allocation operations. It is initialized with a memory address returned by `fd_alloc_new` and is used in conjunction with other allocation functions.
- **Use**: Used to manage shared memory allocations across different threads or processes.


---
### \_alloc\_cnt
- **Type**: ``ulong``
- **Description**: Represents the number of allocations to perform during the test. It is a static global variable of type `ulong`.
- **Use**: Used to control the number of allocation operations in the `test_main` and `test2_main` functions.


---
### \_align\_max
- **Type**: ``ulong``
- **Description**: Stores the maximum alignment value used in memory allocation operations. It is a static global variable of type `ulong`.
- **Use**: Used to determine the maximum alignment constraint for memory allocations in the test functions.


---
### \_sz\_max
- **Type**: ``ulong``
- **Description**: Represents the maximum size for memory allocations in the test program. It is used to determine the upper limit for the size of memory blocks that can be allocated during the execution of the test.
- **Use**: Used to set the maximum size for memory allocations in the test functions `test_main` and `test2_main`.


---
### test2\_slot
- **Type**: `static struct`
- **Description**: An array of structures, each aligned to 128 bytes, where each structure contains fields for a lock, a memory pointer, size, pattern, and source.
- **Use**: Used to manage memory allocations and their associated metadata in a multi-threaded environment.


# Functions

---
### test\_main<!-- {{#callable:test_main}} -->
[View Source →](<../../../../../src/util/alloc/test_alloc.c#L30>)

Performs a memory allocation and deallocation test using a random allocation strategy on a single thread.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: The array of command-line arguments.
- **Logic and Control Flow**:
    - Initialize variables and constants for memory allocation testing.
    - Wait for a volatile flag `_go` to be set before starting the test loop.
    - Iterate over a loop twice the number of `alloc_cnt` to perform allocation and deallocation operations.
    - Randomly decide whether to allocate or free memory based on the number of outstanding allocations and a random coin toss.
    - For allocation, determine random size and alignment, allocate memory, and fill it with a unique pattern.
    - For deallocation, select a random outstanding allocation, verify its integrity, and free it.
    - Log information about memory allocations at intervals if `FD_HAS_DEEPASAN` is not defined.
    - After the loop, clean up by leaving the allocation and random number generator contexts.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`main::FD_VOLATILE`](<#mainfd_volatile>)
    - [`fd_alloc_fprintf`](<fd_alloc.c.md#fd_alloc_fprintf>)


---
### test2\_main<!-- {{#callable:test2_main}} -->
[View Source →](<../../../../../src/util/alloc/test_alloc.c#L187>)

Performs a memory allocation and deallocation test using random slot selection and test patterns to ensure data integrity.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: The array of command-line arguments.
- **Logic and Control Flow**:
    - Initialize `tile_idx` with the current tile index using `fd_tile_idx()`.
    - Retrieve volatile constants `_shalloc`, `_alloc_cnt`, `_align_max`, and `_sz_max`.
    - Initialize a random number generator `rng` with `fd_rng_new` and join it with `fd_rng_join`.
    - Join the allocator with `fd_alloc_join` using `shalloc` and `tile_idx`.
    - Calculate `lg_align_max` as the most significant bit of `align_max`.
    - Wait for the volatile `_go` flag to be set using a spin-wait loop.
    - Iterate `2 * alloc_cnt` times to perform allocation and deallocation tests.
    - In each iteration, select a random slot index `idx` and attempt to lock it using `FD_ATOMIC_CAS`.
    - If the slot is unlocked, check if it has an associated memory allocation.
    - If no memory is allocated, randomly determine size and alignment, allocate memory, and fill it with a test pattern.
    - If memory is allocated, verify the test pattern, free the memory, and clear the slot's memory reference.
    - Release the lock on the slot by setting `test2_slot[idx].lock` to 0.
    - After the loop, leave the allocator and delete the random number generator.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`main::FD_VOLATILE`](<#mainfd_volatile>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/util/alloc/test_alloc.c#L456>)

Initializes the environment and logs a warning if the `FD_HAS_HOSTED` capability is not available, then halts execution.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of strings representing the command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with `argc` and `argv`.
    - Logs a warning message indicating that the unit test requires `FD_HAS_HOSTED` capabilities.
    - Calls `fd_halt` to stop further execution.
    - Returns 0 to indicate successful termination.
- **Output**: Returns 0, indicating successful termination of the program.


---
### FD\_VOLATILE<!-- {{#callable:main::FD_VOLATILE}} -->
[View Source →](<../../../../../src/util/alloc/test_alloc.c#L408>)

Sets the volatile variables `_go` and `_shalloc` to specific values.
- **Inputs**:
    - `_go`: A volatile integer variable that is set to 0.
    - `_shalloc`: A volatile pointer variable that is set to the value of `shalloc`.
- **Logic and Control Flow**:
    - Set the volatile variable `_go` to 0.
    - Set the volatile variable `_shalloc` to the value of `shalloc`.
- **Output**: No output is produced.


# Function Declarations (Public API)

---
### fd\_alloc\_fprintf<!-- {{#callable_declaration:fd_alloc_fprintf}} -->
[View Source →](<../../../../../src/util/alloc/test_alloc.c#L26>)

Prints allocation details to a specified stream.
- **Description**: Use this function to print detailed information about memory allocations associated with a given `fd_alloc_t` object to a specified output stream. This function is useful for debugging and monitoring memory usage. It requires a valid `fd_alloc_t` pointer and a non-null `FILE` stream. If the `stream` is null, the function returns immediately with a value of 0, indicating no output was produced. The function returns the number of characters printed to the stream.
- **Inputs**:
    - `join`: A pointer to an `fd_alloc_t` object representing the memory allocation context. Must not be null.
    - `stream`: A pointer to a `FILE` object where the allocation details will be printed. Must not be null. If null, the function returns 0 immediately.
- **Output**: The function returns the number of characters printed to the stream. If the `stream` is null, it returns 0.
- **See Also**: [`fd_alloc_fprintf`](<fd_alloc.c.md#fd_alloc_fprintf>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)