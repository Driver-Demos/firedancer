<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Header file for a shared memory object to synchronize clocks across threads, with APIs for calibration and observation.

# Purpose
The code defines a C header file for a module named `fd_clock`, which provides functionality for synchronizing clocks across different hardware components using shared memory. The primary purpose of this module is to enable efficient and accurate conversion of fast-but-inaccurate local clock readings (such as CPU tick counters) into a consistent wall-clock time that can be used across an application. This is achieved by synchronizing these local clocks with a slow-but-accurate reference clock, such as the system clock, using a lock-free mechanism that supports multiple observer threads and a single calibrating thread.

The module includes several key components and functions. It defines data structures like `fd_clock_shmem_t`, `fd_clock_t`, and `fd_clock_epoch_t` to manage shared memory and clock synchronization states. The module provides APIs for creating, joining, leaving, and deleting clock instances, as well as functions for reading and recalibrating clocks. It also includes error handling mechanisms and utilities for managing clock epochs and synchronization parameters. The module is designed to handle common clock dysfunctions and supports both single-threaded and multi-threaded operations. Additionally, it offers advanced APIs for high-performance computing scenarios, allowing for efficient clock synchronization in distributed systems.
# Imports and Dependencies

---
- `../log/fd_log.h`


# Data Structures

---
### fd\_clock\_shmem\_t
- **Type**: ``struct``
- **Members**:
    - `magic`: Holds a magic number to identify the shared memory region layout.
    - `seq`: Stores the most recent epoch sequence number published by the calibrating thread.
    - `recal_next`: Indicates the recommended time on the y-clock for the next recalibration.
    - `err_cnt`: Counts the number of times recalibration potentially broke monotonicity of y-clock estimates.
    - `recal_alpha`: Derived parameter for recalibration, calculated as 1 / (1 + recal_hist).
    - `recal_beta`: Derived parameter for recalibration, calculated as recal_frac / (recal_avg + pow2_dn(recal_jit)).
    - `recal_min`: Derived parameter for recalibration, calculated as recal_avg - pow2_dn(recal_jit).
    - `recal_mask`: Derived parameter for recalibration, calculated as 2*pow2_dn(recal_jit)-1.
    - `recal_avg`: Recommended average interval between recalibrations, in y-ticks.
    - `recal_jit`: Recommended jitter between recalibrations, in y-ticks.
    - `recal_hist`: Roughly how many recent epochs to use for estimating the recent relative clock rate.
    - `recal_frac`: Fraction of clock drift to absorb over the next epoch.
    - `init_x0`: Initial x-clock observation used for epoch 0 when the clock was created.
    - `init_y0`: Initial y-clock observation used for epoch 0 when the clock was created.
    - `init_w`: Initial estimate for the x-ticks per y-ticks rate.
    - `epoch`: Cache of recently published epochs, each on its own cache line pair to minimize false sharing.
- **Description**: `fd_clock_shmem_t` is a structure that represents a shared memory region used to hold the state of a `fd_clock`. It includes various fields for managing clock synchronization, such as sequence numbers, recalibration parameters, and initial clock observations. The structure is designed to facilitate interprocess communication and synchronization of clocks, allowing for efficient conversion of fast-but-inaccurate tickcounter reads into accurate wallclock time estimates. The structure also includes a cache of recently published epochs to minimize cache traffic and false sharing between threads.


---
### fd\_clock\_t
- **Type**: ``struct``
- **Members**:
    - ``shclock``: Pointer to the shared memory location of the clock in the local join's address space.
    - ``clock_x``: Function pointer to read the x-clock for this local join.
    - ``args_x``: Pointer to additional arguments for reading the x-clock.
- **Description**: `fd_clock_t` is a quasi-opaque handle that describes a local join to a `fd_clock`. It contains a pointer to the shared memory location of the clock, a function pointer to read the x-clock, and a pointer to additional arguments for reading the x-clock. This structure is used to facilitate the synchronization of clocks in a shared memory context, allowing for efficient and accurate time conversion between different clock sources.


---
### fd\_clock\_epoch\_t
- **Type**: ``struct``
- **Members**:
    - ``seq0``: The epoch's sequence number.
    - ``x0``: The raw value observed on the x-clock at the epoch start, in x-ticks.
    - ``y0``: The raw value for the y-clock at the epoch start, in y-ticks.
    - ``w``: The estimate of the recent x-tick per y-tick rate at epoch start.
    - ``y0_eff``: The effective value for the y-clock at the epoch start, preserving monotonicity.
    - ``m``: The y-tick per x-tick rate used to estimate the y-clock value from the x-clock observation.
    - ``seq1``: Indicates the validity of the epoch parameters, matching `seq0` when valid.
- **Description**: Describes the relationship between the x-clock and y-clock in an epoch, used for clock synchronization in high-performance contexts. The structure includes sequence numbers to ensure the validity of synchronization parameters, raw and effective clock values at the epoch start, and conversion rates between x-ticks and y-ticks. It is aligned to avoid false sharing in multi-threaded environments.


---
### fd\_clock\_epoch\_private
- **Type**: ``struct``
- **Members**:
    - ``seq0``: The epoch's sequence number.
    - ``x0``: The raw value observed on the x-clock at the epoch start, in x-ticks.
    - ``y0``: The raw value for the y-clock at the epoch start, in y-ticks.
    - ``w``: The estimate of the recent x-tick per y-tick rate at epoch start.
    - ``y0_eff``: The effective value for the y-clock at the epoch start, preserving monotonicity.
    - ``m``: The y-tick per x-tick rate used to estimate the y-clock value from an x-clock observation.
    - ``seq1``: Indicates when the parameters are valid, matching `seq0` when valid.
- **Description**: Aligns to 128 bytes to avoid false sharing, and represents the synchronization parameters for a clock epoch, including sequence numbers, raw and effective clock values, and tick rate estimates. The structure supports non-blocking lock-free reads by ensuring that `seq0` and `seq1` match when parameters are valid, allowing observers to read the structure sequentially and validate the parameters.


---
### fd\_clock\_shmem\_private
- **Type**: ``struct``
- **Members**:
    - ``magic``: Stores a magic number to identify the structure.
    - ``seq``: Holds the most recent epoch sequence number published by the calibrating thread.
    - ``recal_next``: Indicates the recommended time on the y-clock for the next recalibration, in y-ticks.
    - ``err_cnt``: Counts the number of times recalibration potentially broke monotonicity of y-clock estimates.
    - ``recal_alpha``: Derived parameter equal to 1. / (1. + recal_hist).
    - ``recal_beta``: Derived parameter equal to recal_frac / (recal_avg + pow2_dn(recal_jit)).
    - ``recal_min``: Derived parameter equal to recal_avg - pow2_dn(recal_jit).
    - ``recal_mask``: Derived parameter equal to 2*pow2_dn(recal_jit)-1.
    - ``recal_avg``: Recommended average interval between recalibrations, in y-ticks.
    - ``recal_jit``: Recommended jitter between recalibrations, in y-ticks.
    - ``recal_hist``: Roughly how many recent epochs to use for estimating the recent relative clock rate.
    - ``recal_frac``: Fraction of clock drift to absorb over the next epoch.
    - ``init_x0``: Initial x-clock observation for epoch 0.
    - ``init_y0``: Initial y-clock observation for epoch 0.
    - ``init_w``: Initial estimate for the x-ticks per y-ticks rate.
    - ``epoch``: Cache of recently published epochs, each on its own cache line pair.
- **Description**: The `fd_clock_shmem_private` structure is used to manage the state of a clock synchronization system in shared memory. It includes fields for managing epoch sequence numbers, recalibration timing, error counting, and parameters derived from user configuration. The structure also caches recently published epochs to minimize false sharing between threads. It is aligned to 128 bytes to optimize cache usage and reduce contention in multi-threaded environments.


---
### fd\_clock\_private
- **Type**: ``struct``
- **Members**:
    - ``shclock``: Location of the clock shared memory in the local join's address space.
    - ``clock_x``: How to read the x-clock for this local join.
    - ``args_x``: Additional arguments for reading the x-clock.
- **Description**: Defines the internal structure for managing a local join to a shared memory clock, including the shared memory location, the function to read the x-clock, and any additional arguments needed for the x-clock reading.


# Functions

---
### fd\_clock\_recal\_avg<!-- {{#callable:fd_clock_recal_avg}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L428>)

Retrieves the average interval between recalibrations for a given clock.
- **Inputs**:
    - `clock`: A pointer to a `fd_clock_t` structure representing the clock from which to retrieve the recalibration average.
- **Logic and Control Flow**:
    - Accesses the `shclock` member of the `fd_clock_t` structure pointed to by `clock`.
    - Returns the `recal_avg` value from the `shclock` structure.
- **Output**: Returns a `long` representing the average interval between recalibrations, in y-ticks.


---
### fd\_clock\_recal\_jit<!-- {{#callable:fd_clock_recal_jit}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L429>)

Retrieves the target clock epoch jitter value from a given `fd_clock_t` instance.
- **Inputs**:
    - `clock`: A pointer to a constant `fd_clock_t` structure, representing the clock instance from which to retrieve the jitter value.
- **Logic and Control Flow**:
    - Accesses the `shclock` member of the `fd_clock_t` structure pointed to by `clock`.
    - Returns the `recal_jit` value from the `shclock` structure.
- **Output**: Returns a `long` integer representing the target clock epoch jitter in y-ticks.


---
### fd\_clock\_recal\_hist<!-- {{#callable:fd_clock_recal_hist}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L430>)

Retrieves the `recal_hist` parameter from a `fd_clock_t` structure.
- **Inputs**:
    - `clock`: A pointer to a `fd_clock_t` structure, which contains the shared memory location of the clock and its parameters.
- **Logic and Control Flow**:
    - Accesses the `shclock` member of the `fd_clock_t` structure pointed to by `clock`.
    - Returns the `recal_hist` value from the `shclock` structure.
- **Output**: Returns a `double` representing the `recal_hist` parameter, which indicates the number of recent clock epochs used for clock rate estimation.


---
### fd\_clock\_recal\_frac<!-- {{#callable:fd_clock_recal_frac}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L431>)

Retrieves the recalibration fraction from a given clock structure.
- **Inputs**:
    - `clock`: A pointer to a `fd_clock_t` structure, which contains the shared memory clock data.
- **Logic and Control Flow**:
    - Accesses the `shclock` member of the `fd_clock_t` structure pointed to by `clock`.
    - Returns the `recal_frac` value from the `shclock` structure.
- **Output**: A `double` representing the recalibration fraction (`recal_frac`) of the clock.


---
### fd\_clock\_init\_x0<!-- {{#callable:fd_clock_init_x0}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L432>)

Retrieves the initial x-clock value from a `fd_clock_t` structure.
- **Inputs**:
    - `clock`: A pointer to a `fd_clock_t` structure, which contains the shared memory location of the clock.
- **Logic and Control Flow**:
    - Accesses the `shclock` member of the `fd_clock_t` structure pointed to by `clock`.
    - Returns the `init_x0` value from the `shclock` structure, which represents the initial x-clock value.
- **Output**: Returns a `long` integer representing the initial x-clock value (`init_x0`).


---
### fd\_clock\_init\_y0<!-- {{#callable:fd_clock_init_y0}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L433>)

Retrieves the initial y-clock value from a given `fd_clock_t` structure.
- **Inputs**:
    - `clock`: A pointer to a constant `fd_clock_t` structure, which contains the shared memory clock data.
- **Logic and Control Flow**:
    - Accesses the `shclock` member of the `fd_clock_t` structure pointed to by `clock`.
    - Returns the `init_y0` value from the `shclock` structure, which represents the initial y-clock value.
- **Output**: Returns a `long` integer representing the initial y-clock value (`init_y0`).


---
### fd\_clock\_init\_w<!-- {{#callable:fd_clock_init_w}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L434>)

Retrieves the initial estimate of the x-ticks per y-ticks rate from a given clock.
- **Inputs**:
    - `clock`: A pointer to a `fd_clock_t` structure, which contains the shared memory location of the clock.
- **Logic and Control Flow**:
    - Accesses the `shclock` member of the `fd_clock_t` structure pointed to by `clock`.
    - Returns the `init_w` value from the `shclock` structure, which represents the initial x-ticks per y-ticks rate.
- **Output**: A `double` representing the initial x-ticks per y-ticks rate (`init_w`) from the clock's shared memory.


---
### fd\_clock\_shclock\_const<!-- {{#callable:fd_clock_shclock_const}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L436>)

Returns a constant pointer to the shared memory location of a clock.
- **Inputs**:
    - `clock`: A constant pointer to an `fd_clock_t` structure, representing a local join to a shared clock.
- **Logic and Control Flow**:
    - Accesses the `shclock` member of the `fd_clock_t` structure pointed to by `clock`.
    - Returns the `shclock` member, which is a pointer to the shared memory location of the clock.
- **Output**: A constant pointer to the shared memory location of the clock (`shclock`).


---
### fd\_clock\_clock\_x<!-- {{#callable:fd_clock_clock_x}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L437>)

Retrieves the function pointer for reading the x-clock from a given `fd_clock_t` instance.
- **Inputs**:
    - `clock`: A pointer to a constant `fd_clock_t` structure from which to retrieve the x-clock function pointer.
- **Logic and Control Flow**:
    - Accesses the `clock_x` member of the `fd_clock_t` structure pointed to by `clock`.
    - Returns the value of `clock->clock_x`, which is a function pointer for reading the x-clock.
- **Output**: Returns a `fd_clock_func_t`, which is a function pointer for reading the x-clock.


---
### fd\_clock\_args\_x<!-- {{#callable:fd_clock_args_x}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L438>)

Returns the `args_x` field from a given `fd_clock_t` structure.
- **Inputs**:
    - `clock`: A pointer to a constant `fd_clock_t` structure from which the `args_x` field is accessed.
- **Logic and Control Flow**:
    - Accesses the `args_x` field of the `fd_clock_t` structure pointed to by `clock`.
    - Returns the value of the `args_x` field.
- **Output**: A constant pointer to the `args_x` field of the `fd_clock_t` structure.


---
### fd\_clock\_shclock<!-- {{#callable:fd_clock_shclock}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L440>)

Returns the shared memory location of a clock from a local join.
- **Inputs**:
    - `clock`: A pointer to an `fd_clock_t` structure representing a local join to a shared clock.
- **Logic and Control Flow**:
    - Accesses the `shclock` member of the `fd_clock_t` structure pointed to by `clock`.
    - Returns the value of `shclock`, which is a pointer to the shared memory location of the clock.
- **Output**: A pointer to the shared memory location of the clock (`shclock`).


---
### fd\_clock\_recal\_next<!-- {{#callable:fd_clock_recal_next}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L474>)

Retrieves the recommended next recalibration time for a given clock from its shared memory structure.
- **Inputs**:
    - `clock`: A pointer to a `fd_clock_t` structure representing the clock whose next recalibration time is to be retrieved.
- **Logic and Control Flow**:
    - Accesses the `shclock` member of the `fd_clock_t` structure pointed to by `clock`.
    - Returns the value of the `recal_next` member from the `shclock` structure, which indicates the recommended next recalibration time.
- **Output**: Returns a `long` integer representing the recommended next recalibration time in y-ticks.


---
### fd\_clock\_err\_cnt<!-- {{#callable:fd_clock_err_cnt}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L475>)

Retrieves the error count from a `fd_clock_t` structure.
- **Inputs**:
    - `clock`: A pointer to a `fd_clock_t` structure, which contains a reference to the shared clock memory.
- **Logic and Control Flow**:
    - Accesses the `shclock` member of the `fd_clock_t` structure pointed to by `clock`.
    - Returns the `err_cnt` value from the `shclock` structure, which indicates the number of errors detected since the clock was created or the counter was last reset.
- **Output**: Returns an `ulong` representing the number of errors detected with the underlying clock sources.


---
### fd\_clock\_reset\_err\_cnt<!-- {{#callable:fd_clock_reset_err_cnt}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L479>)

Resets the error counter for a given clock to zero.
- **Inputs**:
    - `clock`: A pointer to an `fd_clock_t` structure representing the clock whose error counter is to be reset.
- **Logic and Control Flow**:
    - Accesses the `shclock` member of the `fd_clock_t` structure pointed to by `clock`.
    - Sets the `err_cnt` field of the `shclock` structure to `0L`.
- **Output**: No output is returned as the function is of type `void`.


---
### fd\_clock\_seq<!-- {{#callable:fd_clock_seq}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L543>)

Returns the most recent epoch sequence number from a shared memory clock structure, ensuring memory consistency with compiler memory fences.
- **Inputs**:
    - `shclock`: A pointer to a `fd_clock_shmem_t` structure representing the shared memory clock from which to retrieve the sequence number.
- **Logic and Control Flow**:
    - Execute a compiler memory fence to ensure memory operations are completed before proceeding.
    - Retrieve the sequence number from the `seq` field of the `shclock` structure.
    - Execute another compiler memory fence to ensure memory operations are completed before returning the sequence number.
    - Return the retrieved sequence number.
- **Output**: The function returns an `ulong` representing the most recent epoch sequence number from the shared memory clock.


---
### fd\_clock\_epoch\_read<!-- {{#callable:fd_clock_epoch_read}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L573>)

Reads synchronization parameters for a specific clock epoch from shared memory and stores them in a provided epoch structure.
- **Inputs**:
    - `shclock`: A pointer to a `fd_clock_shmem_t` structure representing the shared memory region containing clock epochs.
    - `seq`: An unsigned long integer representing the sequence number of the desired clock epoch.
    - `epoch`: A pointer to a `fd_clock_epoch_t` structure where the function will store the read epoch parameters.
- **Logic and Control Flow**:
    - Calculate the index of the desired epoch in the shared memory using `seq & (FD_CLOCK_EPOCH_CNT-1UL)` and store it in `e`.
    - Use memory fences (`FD_COMPILER_MFENCE`) to ensure proper ordering of memory operations.
    - Read the sequence number `seq0` from the epoch at index `e`.
    - Read the parameters `x0`, `y0`, `w`, `y0_eff`, and `m` from the epoch at index `e`.
    - Read the sequence number `seq1` from the epoch at index `e`.
    - Store the read parameters into the provided `epoch` structure.
    - Return the pointer to the `epoch` structure.
- **Output**: Returns a pointer to the `fd_clock_epoch_t` structure containing the read epoch parameters.


---
### fd\_clock\_epoch\_init<!-- {{#callable:fd_clock_epoch_init}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L607>)

Initializes a `fd_clock_epoch_t` structure with the current epoch parameters from a shared memory clock.
- **Inputs**:
    - `epoch`: A pointer to a `fd_clock_epoch_t` structure that will be initialized with the current epoch parameters.
    - `shclock`: A constant pointer to a `fd_clock_shmem_t` structure representing the shared memory clock from which to read the epoch parameters.
- **Logic and Control Flow**:
    - Enter an infinite loop to repeatedly attempt to initialize the `epoch` structure.
    - Call [`fd_clock_seq`](<#fd_clock_seq>) to get the current sequence number from `shclock`.
    - Call [`fd_clock_epoch_read`](<#fd_clock_epoch_read>) to read the epoch parameters for the current sequence number into `epoch`.
    - Check if `epoch->seq0` and `epoch->seq1` are equal to the current sequence number.
    - If they are equal, break the loop, indicating successful initialization.
    - If they are not equal, call `FD_SPIN_PAUSE` to yield the processor and retry.
- **Output**: Returns a pointer to the initialized `fd_clock_epoch_t` structure.
- **Functions Called**:
    - [`fd_clock_seq`](<#fd_clock_seq>)
    - [`fd_clock_epoch_read`](<#fd_clock_epoch_read>)


---
### fd\_clock\_epoch\_refresh<!-- {{#callable:fd_clock_epoch_refresh}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L624>)

Refreshes the epoch parameters if the sequence number has changed.
- **Inputs**:
    - ``epoch``: A pointer to a `fd_clock_epoch_t` structure that holds the current epoch parameters.
    - ``shclock``: A constant pointer to a `fd_clock_shmem_t` structure representing the shared memory clock state.
- **Logic and Control Flow**:
    - Check if the sequence number `seq0` in `epoch` is different from the current sequence number obtained from `fd_clock_seq(shclock)`.
    - If the sequence numbers differ, call `fd_clock_epoch_init(epoch, shclock)` to reinitialize the epoch parameters.
    - Return the `epoch` pointer.
- **Output**: Returns a pointer to the refreshed `fd_clock_epoch_t` structure.
- **Functions Called**:
    - [`fd_clock_seq`](<#fd_clock_seq>)
    - [`fd_clock_epoch_init`](<#fd_clock_epoch_init>)


---
### fd\_clock\_epoch\_x0<!-- {{#callable:fd_clock_epoch_x0}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L640>)

Returns the raw x-clock epoch start time from a given `fd_clock_epoch_t` structure.
- **Inputs**:
    - `epoch`: A pointer to a `fd_clock_epoch_t` structure from which the function retrieves the raw x-clock epoch start time.
- **Logic and Control Flow**:
    - Accesses the `x0` member of the `fd_clock_epoch_t` structure pointed to by `epoch`.
    - Returns the value of `x0`.
- **Output**: The function returns a `long` integer representing the raw x-clock epoch start time.


---
### fd\_clock\_epoch\_y0<!-- {{#callable:fd_clock_epoch_y0}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L641>)

Retrieves the raw value for the y-clock at the start of an epoch from a given `fd_clock_epoch_t` structure.
- **Inputs**:
    - `epoch`: A pointer to a `fd_clock_epoch_t` structure, which contains the synchronization parameters for a clock epoch.
- **Logic and Control Flow**:
    - Accesses the `y0` field of the `fd_clock_epoch_t` structure pointed to by `epoch`.
    - Returns the value of `y0`, which represents the raw y-clock start time in y-ticks.
- **Output**: Returns a `long` integer representing the raw y-clock start time in y-ticks.


---
### fd\_clock\_epoch\_w<!-- {{#callable:fd_clock_epoch_w}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L642>)

Retrieves the estimated recent average x-tick per y-tick rate at the start of an epoch.
- **Inputs**:
    - `epoch`: A pointer to a `fd_clock_epoch_t` structure representing the clock epoch.
- **Logic and Control Flow**:
    - Accesses the `w` field of the `fd_clock_epoch_t` structure pointed to by `epoch`.
    - Returns the value of the `w` field.
- **Output**: A `double` representing the estimated recent average x-tick per y-tick rate at the epoch start.


---
### fd\_clock\_epoch\_y0\_eff<!-- {{#callable:fd_clock_epoch_y0_eff}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L643>)

Retrieves the effective start time of the y-clock for a given epoch.
- **Inputs**:
    - `epoch`: A pointer to a `fd_clock_epoch_t` structure representing the clock epoch.
- **Logic and Control Flow**:
    - Accesses the `y0_eff` field of the `epoch` structure.
    - Returns the value of `y0_eff`.
- **Output**: The effective start time of the y-clock in y-ticks, as a `long` integer.


---
### fd\_clock\_epoch\_m<!-- {{#callable:fd_clock_epoch_m}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L644>)

Returns the `m` value from a given `fd_clock_epoch_t` structure.
- **Inputs**:
    - `epoch`: A pointer to a constant `fd_clock_epoch_t` structure from which the `m` value is retrieved.
- **Logic and Control Flow**:
    - Accesses the `m` member of the `fd_clock_epoch_t` structure pointed to by `epoch`.
    - Returns the value of `m`.
- **Output**: The function returns a `double` representing the `m` value, which is the y-tick per x-tick rate used for estimating the y-clock value from an x-clock observation.


---
### fd\_clock\_epoch\_y<!-- {{#callable:fd_clock_epoch_y}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L653>)

Calculates an estimated y-clock value based on an x-clock observation and epoch synchronization parameters.
- **Inputs**:
    - `epoch`: A pointer to a `fd_clock_epoch_t` structure containing synchronization parameters between the x-clock and y-clock.
    - `x`: A long integer representing the observed value on the x-clock.
- **Logic and Control Flow**:
    - Retrieve the effective y-clock start value `y0_eff` from the `epoch` structure.
    - Retrieve the conversion rate `m` from the `epoch` structure.
    - Retrieve the x-clock start value `x0` from the `epoch` structure.
    - Calculate the difference between the observed x-clock value `x` and the x-clock start value `x0`.
    - Multiply the difference by the conversion rate `m` and add 0.5 for rounding.
    - Add the result to the effective y-clock start value `y0_eff` to get the estimated y-clock value.
- **Output**: Returns a long integer representing the estimated value on the y-clock.


---
### fd\_clock\_default\_init<!-- {{#callable:fd_clock_default_init}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L677>)

Initializes and joins a `fd_clock_t` with default values for single-threaded use cases.
- **Inputs**:
    - `clock_lmem`: A pointer to a local memory array of size 1 for `fd_clock_t`.
    - `clock_mem`: A pointer to shared memory for `fd_clock_shmem_t`.
- **Logic and Control Flow**:
    - Set default recalibration parameters: `recal_avg` to 10e6L, `recal_jit` to 0L, `recal_hist` to 0.0, and `recal_frac` to 0.0.
    - Call [`fd_clock_joint_read`](<fd_clock.c.md#fd_clock_joint_read>) to read initial x and y clock values into `init_x0` and `init_y0`.
    - If [`fd_clock_joint_read`](<fd_clock.c.md#fd_clock_joint_read>) fails, log an error and exit.
    - Spin for 20e6 ticks using `FD_SPIN_PAUSE` to allow time to pass.
    - Call [`fd_clock_joint_read`](<fd_clock.c.md#fd_clock_joint_read>) again to read new x and y clock values into `init_x1` and `init_y1`.
    - If [`fd_clock_joint_read`](<fd_clock.c.md#fd_clock_joint_read>) fails, log an error and exit.
    - Calculate `init_dx` and `init_dy` as the differences between the new and initial clock values.
    - If `init_dx` or `init_dy` are not positive, log an error and exit.
    - Calculate `init_w` as the ratio of `init_dx` to `init_dy`.
    - Call [`fd_clock_new`](<fd_clock.c.md#fd_clock_new>) to create a new shared clock with the calculated parameters.
    - If [`fd_clock_new`](<fd_clock.c.md#fd_clock_new>) fails, log an error and exit.
    - Call [`fd_clock_join`](<fd_clock.c.md#fd_clock_join>) to join the local memory clock with the shared clock.
    - If [`fd_clock_join`](<fd_clock.c.md#fd_clock_join>) fails or does not return `clock_lmem`, log an error and exit.
- **Output**: No return value; initializes the clock in the provided memory locations.
- **Functions Called**:
    - [`fd_clock_joint_read`](<fd_clock.c.md#fd_clock_joint_read>)
    - [`fd_clock_strerror`](<fd_clock.c.md#fd_clock_strerror>)
    - [`fd_clock_new`](<fd_clock.c.md#fd_clock_new>)
    - [`fd_clock_join`](<fd_clock.c.md#fd_clock_join>)


---
### fd\_clock\_default\_recal<!-- {{#callable:fd_clock_default_recal}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L715>)

Recalibrates a clock by reading the current time from two clocks and updating the clock state.
- **Inputs**:
    - `clock`: A pointer to an `fd_clock_t` structure representing the clock to recalibrate.
- **Logic and Control Flow**:
    - Declare variables `x` and `y` to store clock readings.
    - Call [`fd_clock_joint_read`](<fd_clock.c.md#fd_clock_joint_read>) to read the current time from the x-clock and y-clock, storing the results in `x` and `y`.
    - Check if [`fd_clock_joint_read`](<fd_clock.c.md#fd_clock_joint_read>) returns an error; if so, log a warning message with the error details.
    - Call [`fd_clock_recal`](<fd_clock.c.md#fd_clock_recal>) with the `clock`, `x`, and `y` to perform the recalibration and return the result.
- **Output**: Returns a `long` value indicating the recommended time on the y-clock for the next recalibration.
- **Functions Called**:
    - [`fd_clock_joint_read`](<fd_clock.c.md#fd_clock_joint_read>)
    - [`fd_clock_strerror`](<fd_clock.c.md#fd_clock_strerror>)
    - [`fd_clock_recal`](<fd_clock.c.md#fd_clock_recal>)


# Function Declarations (Public API)

---
### fd\_clock\_align<!-- {{#callable_declaration:fd_clock_align}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L397>)

Returns the alignment requirement for `fd_clock_shmem_t`.
- **Description**: Use this function to obtain the alignment requirement for a `fd_clock_shmem_t` shared memory object. This is necessary when allocating memory for `fd_clock_shmem_t` to ensure proper alignment, which is crucial for performance and correctness in memory operations. Call this function before allocating memory for `fd_clock_shmem_t` to determine the correct alignment size.
- **Inputs**: None
- **Output**: The function returns an `unsigned long` representing the alignment requirement for `fd_clock_shmem_t`.
- **See Also**: [`fd_clock_align`](<fd_clock.c.md#fd_clock_align>)  (Implementation)


---
### fd\_clock\_footprint<!-- {{#callable_declaration:fd_clock_footprint}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L405>)

Returns the size of the shared memory object for clock synchronization.
- **Description**: Use this function to determine the memory footprint required for the shared memory object used in clock synchronization. This is useful when allocating memory for the `fd_clock_shmem_t` structure, ensuring that the correct amount of memory is reserved. This function does not require any initialization or prior setup and can be called at any time.
- **Inputs**: None
- **Output**: The function returns an `unsigned long` representing the size, in bytes, of the `fd_clock_shmem_t` structure.
- **See Also**: [`fd_clock_footprint`](<fd_clock.c.md#fd_clock_footprint>)  (Implementation)


---
### fd\_clock\_new<!-- {{#callable_declaration:fd_clock_new}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L407>)

Creates a new shared memory clock object for synchronization.
- **Description**: Use this function to initialize a shared memory region for clock synchronization between a fast local clock and a slow reference clock. Ensure that the shared memory is properly aligned and has sufficient footprint before calling. The function sets up initial calibration parameters and returns a pointer to the initialized shared memory clock object. If any input parameters are invalid or the shared memory is misaligned, the function logs a warning and returns NULL.
- **Inputs**:
    - `shmem`: Pointer to a shared memory region where the clock state will be stored. Must not be null and must be aligned according to `fd_clock_align()`.
    - `recal_avg`: Target average interval between recalibrations, in y-ticks. Must be positive and greater than or equal to `recal_jit`.
    - `recal_jit`: Target jitter between recalibrations, in y-ticks. If zero, a default value is used. Must be between 1 and `recal_avg`.
    - `recal_hist`: Number of recent clock epochs to use for clock rate estimation. If zero, a default value is used. Must be positive.
    - `recal_frac`: Target maximum clock drift fraction to correct in a clock epoch. If zero, a default value is used. Must be positive.
    - `init_x0`: Initial x-clock observation value. Must be positive.
    - `init_y0`: Initial y-clock observation value. Must be positive.
    - `init_w`: Initial estimate of the x-ticks per y-tick rate. Must be positive.
- **Output**: Returns a pointer to the initialized shared memory clock object on success, or NULL on failure.
- **See Also**: [`fd_clock_new`](<fd_clock.c.md#fd_clock_new>)  (Implementation)


---
### fd\_clock\_join<!-- {{#callable_declaration:fd_clock_join}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L417>)

Joins a local memory region to a shared clock.
- **Description**: Use this function to associate a local memory region with a shared clock for synchronization purposes. This function is typically called after creating or mapping a shared clock into the local address space. Ensure that the local memory and shared clock pointers are properly aligned and not null. The function will return null if any of these conditions are not met or if the shared clock's magic number is incorrect. This function is essential for setting up the synchronization between local and shared clocks, allowing for efficient time conversion and calibration.
- **Inputs**:
    - `_lmem`: Pointer to a local memory region where the clock state will be stored. Must not be null and must be aligned to the alignment requirements of `fd_clock_t`.
    - `_shclock`: Pointer to the shared memory region representing the clock. Must not be null and must be aligned to the alignment requirements of `fd_clock_shmem_t`. The shared memory must have a valid magic number.
    - `clock_x`: Function pointer to the method used to read the x-clock. Must not be null.
    - `args_x`: Pointer to additional arguments for the x-clock reading function. Can be null if no additional arguments are needed.
- **Output**: Returns a pointer to the initialized `fd_clock_t` structure on success, or null on failure.
- **See Also**: [`fd_clock_join`](<fd_clock.c.md#fd_clock_join>)  (Implementation)


---
### fd\_clock\_leave<!-- {{#callable_declaration:fd_clock_leave}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L423>)

Leaves a clock join and returns the local memory pointer.
- **Description**: Use this function to leave a current local join to a `fd_clock`. It should be called when the clock is no longer needed in the current context, allowing the local memory to be freed or reused. Ensure that the `clock` parameter is a valid pointer to a `fd_clock_t` structure representing a current local join. If the `clock` is `NULL`, the function logs a warning and returns `NULL`. Otherwise, it returns the local memory pointer associated with the clock.
- **Inputs**:
    - `clock`: A pointer to a `fd_clock_t` structure representing a current local join. Must not be `NULL`. If `NULL`, the function logs a warning and returns `NULL`.
- **Output**: Returns the local memory pointer associated with the clock on success, or `NULL` if the `clock` is `NULL`.
- **See Also**: [`fd_clock_leave`](<fd_clock.c.md#fd_clock_leave>)  (Implementation)


---
### fd\_clock\_delete<!-- {{#callable_declaration:fd_clock_delete}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L424>)

Deletes a shared memory clock object.
- **Description**: Use this function to delete a shared memory clock object when it is no longer needed. Ensure that the pointer to the shared memory clock object is valid, aligned according to the required alignment, and has the correct magic number before calling this function. This function resets the magic number to zero, indicating that the memory no longer holds a valid clock object. It logs a warning and returns NULL if the input is NULL, misaligned, or has an incorrect magic number.
- **Inputs**:
    - `_shclock`: A pointer to the shared memory clock object to delete. Must not be NULL, must be aligned according to `fd_clock_align()`, and must have a valid magic number (`FD_CLOCK_MAGIC`). The function logs a warning and returns NULL if these conditions are not met.
- **Output**: Returns the input pointer if the deletion is successful, or NULL if the input is invalid.
- **See Also**: [`fd_clock_delete`](<fd_clock.c.md#fd_clock_delete>)  (Implementation)


---
### fd\_clock\_now<!-- {{#callable_declaration:fd_clock_now}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L464>)

Returns an estimate of the y-clock time based on the x-clock observation.
- **Description**: Use this function to obtain an estimate of the y-clock time, which is typically a slow-but-accurate global reference clock, by observing the x-clock, which is usually a fast-but-inaccurate local tick counter. This function assumes that the clock has been recently calibrated. It is designed to be faster and more deterministic than directly reading the y-clock, while maintaining comparable accuracy. The function does not perform input argument checking, so ensure that the clock has been properly initialized and calibrated before calling this function.
- **Inputs**:
    - `_clock`: A pointer to a `fd_clock_t` structure representing the clock to observe. This must not be null and should point to a valid, initialized, and calibrated clock structure. The caller retains ownership of the memory.
- **Output**: Returns a `long` representing the estimated time on the y-clock, based on the x-clock observation.
- **See Also**: [`fd_clock_now`](<fd_clock.c.md#fd_clock_now>)  (Implementation)


---
### fd\_clock\_joint\_read<!-- {{#callable_declaration:fd_clock_joint_read}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L506>)

Reads two clocks simultaneously and returns their values.
- **Description**: Use this function to read the time from two different clocks, specified by `clock_x` and `clock_y`, at the same moment. This is useful for synchronizing clocks or comparing their readings. The function returns success if it can read both clocks without error. If `opt_x` or `opt_y` is provided, the function stores the observed time from the respective clock in these pointers. If `opt_dx` is provided, it stores the read accuracy in x-ticks. The function does not perform input validation, so ensure that the clocks are well-behaved and do not step backward.
- **Inputs**:
    - `clock_x`: A function pointer to read the x-clock. It must be a valid function that returns the current time in x-ticks.
    - `args_x`: A pointer to arguments for `clock_x`. It can be NULL if `clock_x` does not require arguments. The caller retains ownership.
    - `clock_y`: A function pointer to read the y-clock. It must be a valid function that returns the current time in y-ticks.
    - `args_y`: A pointer to arguments for `clock_y`. It can be NULL if `clock_y` does not require arguments. The caller retains ownership.
    - `opt_x`: A pointer to store the observed time from the x-clock. It can be NULL if the caller does not need this value.
    - `opt_y`: A pointer to store the observed time from the y-clock. It can be NULL if the caller does not need this value.
    - `opt_dx`: A pointer to store the read accuracy in x-ticks. It can be NULL if the caller does not need this value.
- **Output**: Returns 0 on success. Returns a negative error code if the x-clock or y-clock is not well-behaved (e.g., if they step backward).
- **See Also**: [`fd_clock_joint_read`](<fd_clock.c.md#fd_clock_joint_read>)  (Implementation)


---
### fd\_clock\_recal<!-- {{#callable_declaration:fd_clock_recal}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L534>)

Recalibrates the clock to synchronize x-clock and y-clock readings.
- **Description**: Use this function to recalibrate a clock by providing new readings from the x-clock and y-clock. This function should be called when the clock needs recalibration, typically after a joint read of the x-clock and y-clock. It ensures that the clock's synchronization parameters are updated to reflect the new readings, maintaining the monotonicity of y-clock estimates if the underlying clocks are well-behaved. If the clocks are not well-behaved, the function attempts to handle the situation and logs a potential monotonicity failure. This function returns the recommended time on the y-clock for the next recalibration.
- **Inputs**:
    - `clock`: A pointer to an `fd_clock_t` structure representing the clock to recalibrate. Must not be null. The caller retains ownership.
    - `x1`: A long integer representing the new reading from the x-clock. Must be greater than the previous x-clock reading.
    - `y1`: A long integer representing the new reading from the y-clock. Must be greater than the previous y-clock reading.
- **Output**: Returns a long integer representing the recommended time on the y-clock for the next recalibration.
- **See Also**: [`fd_clock_recal`](<fd_clock.c.md#fd_clock_recal>)  (Implementation)


---
### fd\_clock\_step<!-- {{#callable_declaration:fd_clock_step}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L535>)

Synchronizes a clock to a new epoch with specified parameters.
- **Description**: Use this function to update the synchronization of a clock to a new epoch, specifying the new x-clock and y-clock times and the x-tick per y-tick rate. This function is useful when the clock needs to be adjusted after a period of inactivity or when the calibrating thread knows that the clocks have been adjusted externally. It does not ensure monotonicity of y-clock estimates, so it should be used with caution in situations where clock adjustments are known to have occurred.
- **Inputs**:
    - `clock`: A pointer to an `fd_clock_t` structure representing the clock to be synchronized. Must not be null.
    - `x0`: A long integer representing the new time on the x-clock. No specific range is enforced, but it should be a valid time value.
    - `y0`: A long integer representing the new time on the y-clock. No specific range is enforced, but it should be a valid time value.
    - `w`: A double representing the x-tick per y-tick rate for the new epoch. Must be a positive value.
- **Output**: Returns a long integer representing the recommended time on the y-clock for the next recalibration.
- **See Also**: [`fd_clock_step`](<fd_clock.c.md#fd_clock_step>)  (Implementation)


---
### fd\_clock\_strerror<!-- {{#callable_declaration:fd_clock_strerror}} -->
[View Source →](<../../../../../src/util/clock/fd_clock.h#L665>)

Converts an error code to a human-readable string.
- **Description**: Use this function to obtain a descriptive string for a given error code related to clock operations. This is useful for logging or displaying error messages to users. The function returns a constant string that describes the error associated with the provided error code. It handles specific error codes related to clock behavior and returns "unknown" for any unrecognized error codes. The returned string is always non-null and has an infinite lifetime.
- **Inputs**:
    - `err`: An integer representing the error code. Valid values include `FD_CLOCK_SUCCESS`, `FD_CLOCK_ERR_X`, and `FD_CLOCK_ERR_Y`. If the value is not one of these, the function returns "unknown".
- **Output**: A constant character pointer to a string describing the error. The string is non-null and has an infinite lifetime.
- **See Also**: [`fd_clock_strerror`](<fd_clock.c.md#fd_clock_strerror>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)