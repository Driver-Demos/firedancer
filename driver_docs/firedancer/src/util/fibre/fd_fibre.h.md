<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Data structures and functions for managing fibres, including initialization, scheduling, and inter-fibre communication.

# Purpose
The code defines a C header file for a fibre (or lightweight thread) management system. It provides the necessary data structures and function prototypes to create, manage, and schedule fibres within a program. The primary data structures are `fd_fibre_t`, which represents an individual fibre, and `fd_fibre_pipe_t`, which facilitates communication between fibres through a pipe mechanism. The `fd_fibre_t` structure includes context information, stack details, and scheduling parameters, while `fd_fibre_pipe_t` manages a queue for inter-fibre communication.

The header file declares several functions for fibre lifecycle management, including [`fd_fibre_init`](<#fd_fibre_init>), [`fd_fibre_start`](<#fd_fibre_start>), [`fd_fibre_free`](<#fd_fibre_free>), and [`fd_fibre_swap`](<#fd_fibre_swap>), which handle initialization, starting, freeing, and context switching of fibres, respectively. It also includes functions for scheduling and controlling fibre execution, such as [`fd_fibre_yield`](<#fd_fibre_yield>), [`fd_fibre_wait`](<#fd_fibre_wait>), [`fd_fibre_wake`](<#fd_fibre_wake>), and [`fd_fibre_schedule`](<#fd_fibre_schedule>). Additionally, the file provides mechanisms for inter-fibre communication through pipes, with functions like [`fd_fibre_pipe_new`](<#fd_fibre_pipe_new>), [`fd_fibre_pipe_write`](<#fd_fibre_pipe_write>), and [`fd_fibre_pipe_read`](<#fd_fibre_pipe_read>). The header file is intended to be included in other C source files to provide fibre management capabilities, and it defines public APIs for external use.
# Imports and Dependencies

---
- `ucontext.h`
- `../fd_util.h`


# Global Variables

---
### fd\_fibre\_current
- **Type**: ``fd_fibre_t *``
- **Description**: A pointer to the currently executing fibre in the system. It is used to keep track of the fibre that is currently active and running.
- **Use**: Tracks the state of the currently running fibre and is updated during fibre context switches.


# Data Structures

---
### fd\_fibre
- **Type**: ``struct``
- **Members**:
    - `ctx`: Stores the execution context of the fibre.
    - `stack`: Points to the memory allocated for the fibre's stack.
    - `stack_sz`: Indicates the size of the stack in bytes.
    - `fn`: Holds the function to execute when the fibre starts.
    - `arg`: Stores the argument to pass to the function `fn`.
    - `done`: Indicates whether the fibre has completed execution.
    - `sched_time`: Specifies the scheduled time for the fibre to run.
    - `next`: Points to the next fibre in the scheduling queue.
    - `sentinel`: Acts as a marker or flag for internal use.
- **Description**: Defines a fibre, which is a lightweight thread of execution, with its own context, stack, and function to execute. It includes scheduling parameters to manage execution order and timing, and a sentinel for internal state management.


---
### fd\_fibre\_t
- **Type**: ``struct``
- **Members**:
    - `ctx`: Stores the execution context of the fibre.
    - `stack`: Points to the memory allocated for the fibre's stack.
    - `stack_sz`: Indicates the size of the stack in bytes.
    - `fn`: Holds the function to execute when the fibre starts.
    - `arg`: Stores the argument to pass to the function `fn`.
    - `done`: Indicates whether the fibre has completed execution.
    - `sched_time`: Specifies the scheduled time for the fibre to run.
    - `next`: Points to the next fibre in the scheduling queue.
    - `sentinel`: Acts as a marker for the end of a fibre list.
- **Description**: Manages the state and execution context of a fibre, which is a lightweight thread of execution. It includes fields for the execution context, stack management, function execution, scheduling, and state tracking. This structure is essential for creating, managing, and scheduling fibres within a concurrent execution environment.


---
### fd\_fibre\_pipe
- **Type**: ``struct``
- **Members**:
    - `cap`: The capacity of the pipe.
    - `head`: The index of the head of the pipe.
    - `tail`: The index of the tail of the pipe.
    - `writer`: A pointer to the fibre currently waiting to write, if any.
    - `reader`: A pointer to the fibre currently waiting to read, if any.
    - `entries`: A pointer to the array of entries in the pipe.
- **Description**: Facilitates communication between fibres by acting as a pipe that can send data from one fibre to another, with the ability to wake the receiving fibre upon a write operation.


---
### fd\_fibre\_pipe\_t
- **Type**: ``struct``
- **Members**:
    - `cap`: Capacity of the pipe.
    - `head`: Index of the head of the pipe.
    - `tail`: Index of the tail of the pipe.
    - `writer`: Pointer to the fibre currently waiting to write, if any.
    - `reader`: Pointer to the fibre currently waiting to read, if any.
    - `entries`: Pointer to the array of entries in the pipe.
- **Description**: Facilitates communication between fibres by providing a mechanism to send data from one fibre to another, with the ability to block and wake fibres based on read and write operations.


# Function Declarations (Public API)

---
### fd\_fibre\_init\_footprint<!-- {{#callable_declaration:fd_fibre_init_footprint}} -->
[View Source →](<../../../../../src/util/fibre/fd_fibre.h#L46>)

Calculates the memory footprint required for fiber initialization.
- **Description**: Use this function to determine the memory size needed to initialize a fiber. It calculates the size based on the fiber structure and ensures it is aligned to the required boundary. This function is useful before allocating memory for fiber initialization to ensure the memory block is correctly sized and aligned.
- **Inputs**: None
- **Output**: Returns the size in bytes, aligned to `FD_FIBRE_ALIGN`, required for fiber initialization.
- **See Also**: [`fd_fibre_init_footprint`](<fd_fibre.c.md#fd_fibre_init_footprint>)  (Implementation)


---
### fd\_fibre\_init\_align<!-- {{#callable_declaration:fd_fibre_init_align}} -->
[View Source →](<../../../../../src/util/fibre/fd_fibre.h#L51>)

Returns the alignment requirement for fiber initialization.
- **Description**: Use this function to obtain the alignment requirement for initializing a fiber. This value is necessary when allocating memory for fiber initialization to ensure proper alignment. Call this function before allocating memory for a fiber to avoid alignment issues.
- **Inputs**: None
- **Output**: Returns an unsigned long integer representing the alignment requirement for fiber initialization.
- **See Also**: [`fd_fibre_init_align`](<fd_fibre.c.md#fd_fibre_init_align>)  (Implementation)


---
### fd\_fibre\_init<!-- {{#callable_declaration:fd_fibre_init}} -->
[View Source →](<../../../../../src/util/fibre/fd_fibre.h#L66>)

Initializes a new fibre from the current thread.
- **Description**: Use this function to create a new fibre from the current thread. It must be called before any other fibre-related functions. The caller is responsible for managing the memory for the fibre, including allocation and deallocation. This function should not be called more than once on the same thread. It sets up the fibre's context and initializes its stack and size to zero. If the context cannot be obtained, the function will abort the program.
- **Inputs**:
    - `mem`: A pointer to the memory allocated for the fibre. The memory must meet the size and alignment requirements specified by `fd_fibre_init_footprint` and `fd_fibre_init_align`. The caller retains ownership of this memory.
- **Output**: Returns a pointer to the initialized `fd_fibre_t` structure representing the new fibre.
- **See Also**: [`fd_fibre_init`](<fd_fibre.c.md#fd_fibre_init>)  (Implementation)


---
### fd\_fibre\_start\_footprint<!-- {{#callable_declaration:fd_fibre_start_footprint}} -->
[View Source →](<../../../../../src/util/fibre/fd_fibre.h#L71>)

Calculates the memory footprint required for starting a fibre.
- **Description**: Use this function to determine the amount of memory needed to start a new fibre with a specified stack size. This calculation includes the memory required for the fibre's control structure and the aligned stack size. It is important to call this function before allocating memory for a fibre to ensure that the allocated memory is sufficient and properly aligned.
- **Inputs**:
    - `stack_size`: The size of the stack required for the fibre, in bytes. Must be a non-negative value. The function aligns this size to the required boundary.
- **Output**: Returns the total memory footprint in bytes, including alignment, needed to start a fibre with the specified stack size.
- **See Also**: [`fd_fibre_start_footprint`](<fd_fibre.c.md#fd_fibre_start_footprint>)  (Implementation)


---
### fd\_fibre\_start\_align<!-- {{#callable_declaration:fd_fibre_start_align}} -->
[View Source →](<../../../../../src/util/fibre/fd_fibre.h#L72>)

Returns the alignment requirement for starting a fibre.
- **Description**: Use this function to obtain the alignment requirement for memory when starting a new fibre. This is necessary to ensure that the memory used for fibre operations is correctly aligned, which is important for performance and correctness. Call this function before allocating memory for a fibre to determine the correct alignment.
- **Inputs**: None
- **Output**: Returns an unsigned long integer representing the alignment requirement for starting a fibre.
- **See Also**: [`fd_fibre_start_align`](<fd_fibre.c.md#fd_fibre_start_align>)  (Implementation)


---
### fd\_fibre\_start<!-- {{#callable_declaration:fd_fibre_start}} -->
[View Source →](<../../../../../src/util/fibre/fd_fibre.h#L93>)

Starts a new fibre with a specified function and argument.
- **Description**: Use this function to create and start a new fibre, which is a lightweight thread of execution. Before calling, ensure that `fd_fibre_init` has been called to initialize the fibre system. This function sets up the execution context for the new fibre, including its stack and function to execute. The current fibre continues to run, while the new fibre is inactive and ready to be switched to. This function can be used in the current or another thread.
- **Inputs**:
    - `mem`: Pointer to the memory allocated for the fibre. Use `fd_fibre_start_align` and `fd_fibre_start_footprint` to determine the required size and alignment. Caller retains ownership.
    - `stack_sz`: Size of the stack required for the new fibre. Must be a positive value.
    - `fn`: Function entry point to call in the new fibre. Must be a valid function pointer.
    - `arg`: Value to pass to the function `fn`. Can be NULL if the function does not require an argument.
- **Output**: Returns a pointer to the newly created `fd_fibre_t` structure representing the fibre.
- **See Also**: [`fd_fibre_start`](<fd_fibre.c.md#fd_fibre_start>)  (Implementation)


---
### fd\_fibre\_free<!-- {{#callable_declaration:fd_fibre_free}} -->
[View Source →](<../../../../../src/util/fibre/fd_fibre.h#L102>)

Frees resources associated with a fibre.
- **Description**: Use this function to release resources of a fibre that is no longer needed. Ensure that the fibre is not currently running when calling this function. The caller is responsible for managing the memory of the fibre, as this function does not deallocate memory.
- **Inputs**:
    - `fibre`: A pointer to the `fd_fibre_t` structure representing the fibre to free. The pointer must not be null, and the fibre must not be currently running. The caller retains ownership of the memory.
- **Output**: None
- **See Also**: [`fd_fibre_free`](<fd_fibre.c.md#fd_fibre_free>)  (Implementation)


---
### fd\_fibre\_swap<!-- {{#callable_declaration:fd_fibre_swap}} -->
[View Source →](<../../../../../src/util/fibre/fd_fibre.h#L111>)

Switches execution to a specified fibre.
- **Description**: Use this function to change the execution context to the fibre specified by the parameter. This function updates the global variable `fd_fibre_current` to reflect the currently running fibre before switching. It does nothing if the specified fibre is the same as the current fibre or if the specified fibre has completed execution. Ensure that the fibre to switch to is not marked as done before calling this function.
- **Inputs**:
    - `swap_to`: A pointer to the `fd_fibre_t` structure representing the fibre to switch to. Must not be null and must not point to a fibre that is marked as done. The caller retains ownership of the fibre.
- **Output**: None
- **See Also**: [`fd_fibre_swap`](<fd_fibre.c.md#fd_fibre_swap>)  (Implementation)


---
### fd\_fibre\_set\_clock<!-- {{#callable_declaration:fd_fibre_set_clock}} -->
[View Source →](<../../../../../src/util/fibre/fd_fibre.h#L122>)

Sets a custom clock function for the scheduler.
- **Description**: Use this function to specify a custom clock function that the scheduler will use to obtain the current time. This is useful when you need to integrate the fibre scheduler with a specific timing source or when testing with a mock clock. Ensure that the provided clock function returns a `long` value representing the current time. This function should be called before any scheduling operations that depend on time.
- **Inputs**:
    - `clock`: A pointer to a function that returns a `long` value representing the current time. The function must not be null, and it should be capable of providing a valid time value whenever called.
- **Output**: None
- **See Also**: [`fd_fibre_set_clock`](<fd_fibre.c.md#fd_fibre_set_clock>)  (Implementation)


---
### fd\_fibre\_yield<!-- {{#callable_declaration:fd_fibre_yield}} -->
[View Source →](<../../../../../src/util/fibre/fd_fibre.h#L128>)

Allows other fibres to execute by yielding the current fibre.
- **Description**: Use this function to yield the execution of the current fibre, allowing other fibres to run. This is useful in cooperative multitasking environments where fibres voluntarily give up control to enable other fibres to execute. Ensure that the fibre system is initialized before calling this function. This function does not take any parameters and does not return any value.
- **Inputs**: None
- **Output**: None
- **See Also**: [`fd_fibre_yield`](<fd_fibre.c.md#fd_fibre_yield>)  (Implementation)


---
### fd\_fibre\_wait<!-- {{#callable_declaration:fd_fibre_wait}} -->
[View Source →](<../../../../../src/util/fibre/fd_fibre.h#L133>)

Stops the current fibre from running for a specified time.
- **Description**: Use this function to pause the execution of the current fibre for a specified number of nanoseconds. This function should only be called when a fibre scheduler is active, as it relies on the scheduler to manage the pause and resume operations. If no scheduler is present, the function returns immediately without any effect. The function calculates the wake-up time based on the current time and the specified wait duration, ensuring that the fibre is scheduled to resume after the wait period. This function is useful for implementing delays or yielding execution to other fibres in a cooperative multitasking environment.
- **Inputs**:
    - `wait_ns`: The number of nanoseconds to wait before resuming the current fibre. If the value is less than 1, it is clamped to 1 nanosecond. The caller retains ownership of this value.
- **Output**: None
- **See Also**: [`fd_fibre_wait`](<fd_fibre.c.md#fd_fibre_wait>)  (Implementation)


---
### fd\_fibre\_wait\_until<!-- {{#callable_declaration:fd_fibre_wait_until}} -->
[View Source →](<../../../../../src/util/fibre/fd_fibre.h#L139>)

Stops execution of the current fibre until a specified time.
- **Description**: Use this function to pause the execution of the current fibre until the specified resume time in nanoseconds. This function should be called when you want to ensure that the current fibre does not run until a certain time has passed. If the specified time is in the past or present, the function will adjust the time to ensure that another fibre gets a chance to execute. This function requires a scheduler to be set; otherwise, it will return immediately without effect.
- **Inputs**:
    - `resume_time_ns`: The time in nanoseconds at which the current fibre should resume execution. If this time is less than or equal to the current time, it will be adjusted to ensure a minimal wait. The caller retains ownership of this value.
- **Output**: None
- **See Also**: [`fd_fibre_wait_until`](<fd_fibre.c.md#fd_fibre_wait_until>)  (Implementation)


---
### fd\_fibre\_wake<!-- {{#callable_declaration:fd_fibre_wake}} -->
[View Source →](<../../../../../src/util/fibre/fd_fibre.h#L144>)

Wakes a specified fibre for execution.
- **Description**: Use this function to wake a fibre that is not currently executing, allowing it to be scheduled for execution. This function should not be called on the currently executing fibre, as it will have no effect. Ensure that the fibre passed to this function is valid and has been properly initialized. This function updates the scheduling time of the fibre and adds it to the schedule for execution.
- **Inputs**:
    - `fibre`: A pointer to the `fd_fibre_t` structure representing the fibre to wake. Must not be null and must not point to the currently executing fibre. The caller retains ownership of the fibre.
- **Output**: None
- **See Also**: [`fd_fibre_wake`](<fd_fibre.c.md#fd_fibre_wake>)  (Implementation)


---
### fd\_fibre\_schedule<!-- {{#callable_declaration:fd_fibre_schedule}} -->
[View Source →](<../../../../../src/util/fibre/fd_fibre.h#L149>)

Adds a fibre to the scheduling queue.
- **Description**: Use this function to add a fibre to the scheduling queue, allowing it to be scheduled for execution based on its wake time. Ensure that the fibre is properly initialized and not currently in the scheduling queue before calling this function. This function must be called after setting up the fibre and the scheduling environment. It is important to note that the function will abort if the scheduling clock is not set.
- **Inputs**:
    - `fibre`: A pointer to an `fd_fibre_t` structure representing the fibre to be scheduled. The fibre must be initialized and not null. The function will remove the fibre from its current position in the schedule, if any, and reinsert it based on its `sched_time`.
- **Output**: None
- **See Also**: [`fd_fibre_schedule`](<fd_fibre.c.md#fd_fibre_schedule>)  (Implementation)


---
### fd\_fibre\_schedule\_run<!-- {{#callable_declaration:fd_fibre_schedule_run}} -->
[View Source →](<../../../../../src/util/fibre/fd_fibre.h#L158>)

Runs the current fibre schedule.
- **Description**: Use this function to execute the current fibre schedule. It processes fibres in the schedule queue, executing those that are ready based on their scheduled time. This function must be called after fibres have been scheduled using `fd_fibre_schedule`. It returns immediately if there are no fibres ready to run, or if the next fibre is not yet ready. The function will return the time of the next fibre that is ready to run, or -1 if there are no fibres left in the schedule.
- **Inputs**: None
- **Output**: Returns the time of the next ready fibre, or -1 if no fibres are in the schedule.
- **See Also**: [`fd_fibre_schedule_run`](<fd_fibre.c.md#fd_fibre_schedule_run>)  (Implementation)


---
### fd\_fibre\_pipe\_align<!-- {{#callable_declaration:fd_fibre_pipe_align}} -->
[View Source →](<../../../../../src/util/fibre/fd_fibre.h#L171>)

Returns the alignment requirement for a fibre pipe.
- **Description**: Use this function to obtain the alignment requirement for a `fd_fibre_pipe_t` structure. This is necessary when allocating memory for a fibre pipe to ensure proper alignment. Call this function before creating a new fibre pipe to determine the correct alignment boundary.
- **Inputs**: None
- **Output**: The function returns an `ulong` representing the alignment requirement for a `fd_fibre_pipe_t` structure.
- **See Also**: [`fd_fibre_pipe_align`](<fd_fibre.c.md#fd_fibre_pipe_align>)  (Implementation)


---
### fd\_fibre\_pipe\_footprint<!-- {{#callable_declaration:fd_fibre_pipe_footprint}} -->
[View Source →](<../../../../../src/util/fibre/fd_fibre.h#L174>)

Calculates the memory footprint required for a fibre pipe.
- **Description**: Use this function to determine the amount of memory needed to allocate a fibre pipe with a specified number of entries. This is useful when planning memory allocation for fibre communication. Ensure that the number of entries is a positive value to avoid incorrect memory calculations.
- **Inputs**:
    - `entries`: Specifies the number of entries the fibre pipe will hold. Must be a positive integer. If the value is zero or negative, the function will still return a calculated size, but it may not be meaningful for actual use.
- **Output**: Returns the total memory size in bytes required to store the specified number of entries in a fibre pipe.
- **See Also**: [`fd_fibre_pipe_footprint`](<fd_fibre.c.md#fd_fibre_pipe_footprint>)  (Implementation)


---
### fd\_fibre\_pipe\_new<!-- {{#callable_declaration:fd_fibre_pipe_new}} -->
[View Source →](<../../../../../src/util/fibre/fd_fibre.h#L180>)

Creates a new fibre pipe in the provided memory.
- **Description**: Use this function to initialize a new fibre pipe in a pre-allocated memory region. This function sets up the pipe's internal structure, including its capacity and entry array, and prepares it for use. Ensure that the memory provided is large enough to accommodate the pipe structure and its entries, as determined by the `fd_fibre_pipe_footprint` function. The function does not perform any memory allocation itself; it only initializes the structure within the given memory.
- **Inputs**:
    - `mem`: A pointer to the pre-allocated memory where the fibre pipe will be initialized. Must not be null and must be properly aligned and sized according to `fd_fibre_pipe_align` and `fd_fibre_pipe_footprint`.
    - `entries`: The number of entries the pipe can hold. Determines the capacity of the pipe.
- **Output**: Returns a pointer to the initialized `fd_fibre_pipe_t` structure within the provided memory.
- **See Also**: [`fd_fibre_pipe_new`](<fd_fibre.c.md#fd_fibre_pipe_new>)  (Implementation)


---
### fd\_fibre\_pipe\_write<!-- {{#callable_declaration:fd_fibre_pipe_write}} -->
[View Source →](<../../../../../src/util/fibre/fd_fibre.h#L196>)

Writes a value into a fibre pipe with a timeout.
- **Description**: Use this function to write a value into a fibre pipe. It can block if there is no free space in the pipe, but will terminate the blocking after the specified timeout period. This function is useful when you need to ensure that a value is written to a pipe within a certain time frame. It is important to ensure that the pipe is properly initialized and that the timeout is set according to the application's requirements.
- **Inputs**:
    - `pipe`: A pointer to the `fd_fibre_pipe_t` structure representing the pipe to write to. Must not be null and must point to a valid, initialized pipe.
    - `value`: The `ulong` value to write into the pipe. There are no specific constraints on the value itself.
    - `timeout`: The amount of time, in nanoseconds, to wait for space to become available in the pipe. If the timeout is reached before space is available, the function will return with a timeout indication.
- **Output**: Returns 0 if the write operation is successful. Returns 1 if the operation times out due to lack of space in the pipe.
- **See Also**: [`fd_fibre_pipe_write`](<fd_fibre.c.md#fd_fibre_pipe_write>)  (Implementation)


---
### fd\_fibre\_pipe\_read<!-- {{#callable_declaration:fd_fibre_pipe_read}} -->
[View Source →](<../../../../../src/util/fibre/fd_fibre.h#L213>)

Reads a value from a fibre pipe with a timeout.
- **Description**: Use this function to read a value from a fibre pipe. It can block if there is no data available in the pipe. The function will wait for data to become available until the specified timeout period elapses. If the timeout is reached without data being available, the function returns with a timeout indication. This function is useful in scenarios where you need to synchronize data transfer between fibres and want to avoid indefinite blocking.
- **Inputs**:
    - `pipe`: A pointer to the `fd_fibre_pipe_t` structure from which to read. Must not be null. The pipe should be properly initialized and must have been created using `fd_fibre_pipe_new`.
    - `value`: A pointer to an `ulong` where the read value will be stored. Must not be null. The caller is responsible for ensuring that this pointer is valid.
    - `timeout`: The number of nanoseconds to wait for a value to become available in the pipe. If the timeout is reached without data being available, the function returns with a timeout indication.
- **Output**: Returns 0 if a value was successfully read from the pipe. Returns 1 if the operation timed out without receiving data.
- **See Also**: [`fd_fibre_pipe_read`](<fd_fibre.c.md#fd_fibre_pipe_read>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)