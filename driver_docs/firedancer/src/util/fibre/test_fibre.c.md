<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for fibre scheduling, pipe communication, and timing functions in the Firedancer codebase.

# Purpose
The code is a C program that demonstrates the use of a fibre-based concurrency model, utilizing the `fd_fibre` library. It includes several test functions and scenarios to illustrate the scheduling and execution of fibres, which are lightweight threads. The program defines multiple functions ([`fn1`](<#fn1>), [`fn2`](<#fn2>), [`fn3`](<#fn3>), [`test1`](<#test1>), [`test2`](<#test2>), [`test_pipe_producer`](<#test_pipe_producer>), [`test_pipe_consumer`](<#test_pipe_consumer>), [`pipe_producer_main`](<#pipe_producer_main>), [`pipe_filter_main`](<#pipe_filter_main>), and [`pipe_consumer_main`](<#pipe_consumer_main>)) that are executed as fibres. These functions perform tasks such as printing messages, waiting for specific time periods, and simulating producer-consumer scenarios using pipes for inter-fibre communication.

The program includes two main test scenarios: [`run_pipe_test`](<#run_pipe_test>) and [`run_test_pipe_filter`](<#run_test_pipe_filter>). The [`run_pipe_test`](<#run_pipe_test>) function sets up a producer-consumer model where a producer fibre sends messages to a consumer fibre through a pipe. The [`run_test_pipe_filter`](<#run_test_pipe_filter>) function extends this model by introducing a filter fibre that distributes messages from one input pipe to two output pipes based on specific conditions. The [`main`](<#main>) function initializes the fibre environment, creates and schedules fibres for execution, and runs the test scenarios. The program uses a synthetic clock to simulate time progression and demonstrates the use of `fd_fibre_wait` and `fd_fibre_wait_until` for fibre synchronization.
# Imports and Dependencies

---
- `stdio.h`
- `stdlib.h`
- `fd_fibre.h`


# Global Variables

---
### now
- **Type**: ``long``
- **Description**: Represents a synthetic clock time used in the program. It is initialized to zero and is updated to simulate the passage of time during the execution of various functions.
- **Use**: Used to track and simulate time progression in the program, particularly for scheduling and timing operations.


---
### done
- **Type**: ``int``
- **Description**: A global integer variable that acts as a flag to indicate the completion status of certain operations in the program. It is initialized to 0, representing an incomplete state.
- **Use**: Used in the `test1` and `test2` functions to control the execution flow based on whether the operations are complete.


# Data Structures

---
### pipe\_producer\_args
- **Type**: ``struct``
- **Members**:
    - `output`: A pointer to a `fd_fibre_pipe_t` structure, representing the output pipe.
    - `expire`: A `long` integer indicating the expiration time for the producer.
    - `period`: A `long` integer specifying the period between message transmissions.
- **Description**: Defines the arguments for a pipe producer, including the output pipe, expiration time, and transmission period.


---
### pipe\_producer\_args\_t
- **Type**: ``struct``
- **Members**:
    - `output`: A pointer to an `fd_fibre_pipe_t` structure, representing the output pipe for the producer.
    - `expire`: A `long` integer that specifies the expiration time for the producer's operation.
    - `period`: A `long` integer that defines the period between message transmissions.
- **Description**: Facilitates the configuration of a pipe producer by storing the output pipe, expiration time, and transmission period.


---
### pipe\_filter\_args
- **Type**: ``struct``
- **Members**:
    - `input`: A pointer to an `fd_fibre_pipe_t` structure representing the input pipe.
    - `out1`: A pointer to an `fd_fibre_pipe_t` structure representing the first output pipe.
    - `out2`: A pointer to an `fd_fibre_pipe_t` structure representing the second output pipe.
    - `period`: A `long` integer representing the period for operations.
- **Description**: Facilitates the distribution of messages from an input pipe to two output pipes, with a specified period for operations.


---
### pipe\_filter\_args\_t
- **Type**: ``struct``
- **Members**:
    - `input`: Pointer to an input `fd_fibre_pipe_t` structure.
    - `out1`: Pointer to the first output `fd_fibre_pipe_t` structure.
    - `out2`: Pointer to the second output `fd_fibre_pipe_t` structure.
    - `period`: Time period for operations, represented as a `long` integer.
- **Description**: `pipe_filter_args_t` is a structure that holds arguments for a pipe filter operation, including pointers to input and output pipes and a time period for processing.


---
### pipe\_consumer\_args
- **Type**: ``struct``
- **Members**:
    - ``name``: A pointer to a constant character string representing the name of the consumer.
    - ``input``: A pointer to a `fd_fibre_pipe_t` structure representing the input pipe for the consumer.
    - ``expire``: A long integer representing the expiration time for the consumer operation.
- **Description**: Defines the arguments for a pipe consumer, including a name, an input pipe, and an expiration time for operations.


---
### pipe\_consumer\_args\_t
- **Type**: ``struct``
- **Members**:
    - ``name``: A pointer to a constant character string that represents the name of the consumer.
    - ``input``: A pointer to an `fd_fibre_pipe_t` structure that represents the input pipe for the consumer.
    - ``expire``: A long integer that specifies the expiration time for the consumer.
- **Description**: Defines the arguments for a pipe consumer, including the consumer's name, the input pipe from which it reads messages, and the expiration time for its operation.


# Functions

---
### fn1<!-- {{#callable:fn1}} -->
[View Source →](<../../../../../src/util/fibre/test_fibre.c#L7>)

Prints a message to the standard output and flushes the output buffer.
- **Inputs**:
    - `vp`: A void pointer that is not used in the function.
- **Logic and Control Flow**:
    - Casts the input parameter `vp` to void to avoid unused parameter warnings.
    - Prints the message 'running fn1\n' to the standard output using `printf`.
    - Flushes the standard output buffer using `fflush(stdout)` to ensure the message is immediately displayed.
- **Output**: No return value; the function returns `void`.


---
### fn2<!-- {{#callable:fn2}} -->
[View Source →](<../../../../../src/util/fibre/test_fibre.c#L14>)

Prints a message indicating that `fn2` is running and flushes the output buffer.
- **Inputs**:
    - `vp`: A void pointer that is not used in the function.
- **Logic and Control Flow**:
    - Cast the input `vp` to void to avoid unused parameter warnings.
    - Print the message 'running fn2\n' to the standard output.
    - Flush the standard output buffer to ensure the message is displayed immediately.
- **Output**: No return value.


---
### fn3<!-- {{#callable:fn3}} -->
[View Source →](<../../../../../src/util/fibre/test_fibre.c#L21>)

Prints a message indicating that `fn3` is running and flushes the output buffer.
- **Inputs**:
    - `vp`: A void pointer, which is not used in the function.
- **Logic and Control Flow**:
    - Casts the input `vp` to void to suppress unused parameter warnings.
    - Prints the message 'running fn3\n' to the standard output.
    - Flushes the standard output buffer to ensure the message is displayed immediately.
- **Output**: No return value.


---
### my\_clock<!-- {{#callable:my_clock}} -->
[View Source →](<../../../../../src/util/fibre/test_fibre.c#L33>)

Returns the current value of the synthetic clock variable `now`.
- **Inputs**: None
- **Logic and Control Flow**:
    - Return the value of the global variable `now`.
- **Output**: The function returns a `long` integer representing the current time in the synthetic clock.


---
### test1<!-- {{#callable:test1}} -->
[View Source →](<../../../../../src/util/fibre/test_fibre.c#L42>)

Periodically prints the current time and a given period until a global 'done' flag is set.
- **Inputs**:
    - `vp`: A pointer to a `long` array where the first element is the period for waiting.
- **Logic and Control Flow**:
    - Cast the input `vp` to a `long` pointer and store it in `arg`.
    - Retrieve the period from `arg[0]`.
    - Enter a loop that continues until the global variable `done` is non-zero.
    - Inside the loop, print the current period and the global variable `now`.
    - Flush the standard output buffer to ensure the message is printed immediately.
    - Call [`fd_fibre_wait`](<fd_fibre.c.md#fd_fibre_wait>) with the period to pause execution for the specified duration.
- **Output**: No return value; the function operates in a loop until the global `done` flag is set.
- **Functions Called**:
    - [`fd_fibre_wait`](<fd_fibre.c.md#fd_fibre_wait>)


---
### test2<!-- {{#callable:test2}} -->
[View Source →](<../../../../../src/util/fibre/test_fibre.c#L57>)

Waits until a specified time and then sets a completion flag.
- **Inputs**:
    - `vp`: A pointer to a `long` array where the first element is the 'done' time.
- **Logic and Control Flow**:
    - Cast the input `vp` to a `long` pointer and store it in `arg`.
    - Extract the 'done' time from `arg[0]` and store it in `done_time`.
    - Print 'test2: waiting' to the standard output and flush the output buffer.
    - Call [`fd_fibre_wait_until`](<fd_fibre.c.md#fd_fibre_wait_until>) with `done_time` to wait until the specified time.
    - Print 'test2: finished waiting' to the standard output and flush the output buffer.
    - Set the global variable `done` to 1 to indicate completion.
- **Output**: No return value; sets the global variable `done` to 1 after waiting.
- **Functions Called**:
    - [`fd_fibre_wait_until`](<fd_fibre.c.md#fd_fibre_wait_until>)


---
### test\_pipe\_producer<!-- {{#callable:test_pipe_producer}} -->
[View Source →](<../../../../../src/util/fibre/test_fibre.c#L75>)

Transmits messages through a pipe at a fixed rate for a specified duration.
- **Inputs**:
    - `vp`: A pointer to a `fd_fibre_pipe_t` structure, which represents the pipe used for message transmission.
- **Logic and Control Flow**:
    - Prints a start message and flushes the output buffer.
    - Initializes `run_period` to 1 millisecond and `run_duration` to 1 second.
    - Calculates `send_time` as the current time plus `run_period` and `run_end` as the current time plus `run_duration`.
    - Initializes a message counter `msg` to 0.
    - Enters a loop that continues until the current time is less than `run_end`.
    - Within the loop, waits until `send_time` using [`fd_fibre_wait_until`](<fd_fibre.c.md#fd_fibre_wait_until>).
    - Attempts to write the current message `msg` to the pipe using [`fd_fibre_pipe_write`](<fd_fibre.c.md#fd_fibre_pipe_write>).
    - If the write operation fails, prints an error message and exits the program.
    - Increments `send_time` by `run_period` for the next iteration.
    - Increments the message counter `msg`.
    - Prints a finish message after the loop ends.
- **Output**: No return value; the function performs its operations and exits if an error occurs.
- **Functions Called**:
    - [`fd_fibre_wait_until`](<fd_fibre.c.md#fd_fibre_wait_until>)
    - [`fd_fibre_pipe_write`](<fd_fibre.c.md#fd_fibre_pipe_write>)


---
### test\_pipe\_consumer<!-- {{#callable:test_pipe_consumer}} -->
[View Source →](<../../../../../src/util/fibre/test_fibre.c#L113>)

Receives messages from a pipe and logs them until a specified duration elapses.
- **Inputs**:
    - `vp`: A pointer to a `fd_fibre_pipe_t` object, which represents the pipe from which messages are received.
- **Logic and Control Flow**:
    - Cast the input `vp` to a `fd_fibre_pipe_t` pointer named `pipe`.
    - Print a message indicating the start of the consumer process and flush the output buffer.
    - Set `run_period` to 1,000,000 and `run_duration` to 1,000,000,000, then calculate `run_end` as the sum of `now` and `run_duration`.
    - Enter a loop that continues while `now` is less than `run_end`.
    - Inside the loop, initialize `msg` to 0 and call [`fd_fibre_pipe_read`](<fd_fibre.c.md#fd_fibre_pipe_read>) to read a message from `pipe` into `msg`, with a timeout of `run_period`.
    - If [`fd_fibre_pipe_read`](<fd_fibre.c.md#fd_fibre_pipe_read>) returns a non-zero value, print an error message and exit the program with status 1.
    - If a message is successfully read, print the message and the current time `now`.
    - After the loop, print a message indicating the consumer process has finished.
- **Output**: No return value; the function logs messages to the standard output.
- **Functions Called**:
    - [`fd_fibre_pipe_read`](<fd_fibre.c.md#fd_fibre_pipe_read>)


---
### run\_pipe\_test<!-- {{#callable:run_pipe_test}} -->
[View Source →](<../../../../../src/util/fibre/test_fibre.c#L142>)

Executes a test of a producer-consumer model using fibres and a communication pipe.
- **Inputs**: None
- **Logic and Control Flow**:
    - Prints 'pipe test starting' to indicate the start of the test.
    - Sets the global variable `now` to zero for output formatting.
    - Allocates memory for a communication pipe and initializes it with 16 entries.
    - Allocates memory for two fibres, one for the producer and one for the consumer, and starts them with the pipe as an argument.
    - Schedules the producer and consumer fibres for execution.
    - Enters a loop to run the scheduled fibres until no more fibres are scheduled, updating `now` to the next scheduled event time.
    - Frees the memory allocated for the fibres and the pipe after the test completes.
    - Prints 'pipe test complete' to indicate the end of the test.
- **Output**: No return value; the function performs its operations and outputs status messages to the console.
- **Functions Called**:
    - [`fd_fibre_start_align`](<fd_fibre.c.md#fd_fibre_start_align>)
    - [`fd_fibre_start_footprint`](<fd_fibre.c.md#fd_fibre_start_footprint>)
    - [`fd_fibre_pipe_new`](<fd_fibre.c.md#fd_fibre_pipe_new>)
    - [`fd_fibre_start`](<fd_fibre.c.md#fd_fibre_start>)
    - [`fd_fibre_schedule`](<fd_fibre.c.md#fd_fibre_schedule>)
    - [`fd_fibre_schedule_run`](<fd_fibre.c.md#fd_fibre_schedule_run>)
    - [`fd_fibre_free`](<fd_fibre.c.md#fd_fibre_free>)


---
### pipe\_producer\_main<!-- {{#callable:pipe_producer_main}} -->
[View Source →](<../../../../../src/util/fibre/test_fibre.c#L198>)

Periodically sends messages through a pipe until a specified time limit is reached.
- **Inputs**:
    - `vp_args`: A pointer to `pipe_producer_args_t` structure containing the output pipe, expiration time, and period for sending messages.
- **Logic and Control Flow**:
    - Cast `vp_args` to `pipe_producer_args_t` to obtain the arguments.
    - Initialize `output`, `expire`, and `period` from the arguments.
    - Calculate `send_time` as the current time plus the period.
    - Calculate `expire_time` as the current time plus the expiration time.
    - Initialize `msg` as a counter starting at 1.
    - Enter a loop that continues until the current time is less than `expire_time`.
    - In each iteration, wait until `send_time` using [`fd_fibre_wait_until`](<fd_fibre.c.md#fd_fibre_wait_until>).
    - Set `timeout` to the value of `period`.
    - Log the message to be written.
    - Attempt to write `msg` to the `output` pipe with the specified `timeout`.
    - If the write operation fails, print an error message and exit the program.
    - Increment `send_time` by `period` for the next iteration.
    - Increment `msg` by 1.
- **Output**: No return value; outputs messages to a pipe and logs activity to the console.
- **Functions Called**:
    - [`fd_fibre_wait_until`](<fd_fibre.c.md#fd_fibre_wait_until>)
    - [`fd_fibre_pipe_write`](<fd_fibre.c.md#fd_fibre_pipe_write>)


---
### pipe\_filter\_main<!-- {{#callable:pipe_filter_main}} -->
[View Source →](<../../../../../src/util/fibre/test_fibre.c#L259>)

Distributes messages from an input pipe to two output pipes based on divisibility conditions.
- **Inputs**:
    - `vp_args`: A pointer to `pipe_filter_args_t` structure containing input and output pipes and a period value.
- **Logic and Control Flow**:
    - Cast `vp_args` to `pipe_filter_args_t` and extract `input`, `out1`, `out2`, and `period`.
    - Set `timeout` to `period`.
    - Enter an infinite loop to read messages from `input` pipe.
    - Read a message from `input` pipe with a timeout; if read fails, exit the loop.
    - Check if the message is divisible by 2; if true, write it to `out1` pipe.
    - Check if the message is divisible by 3; if true, write it to `out2` pipe.
    - If any write operation fails, print an error message and exit the program.
    - Print a completion message after exiting the loop.
- **Output**: No return value; outputs messages to specified pipes or prints error messages.
- **Functions Called**:
    - [`fd_fibre_pipe_read`](<fd_fibre.c.md#fd_fibre_pipe_read>)
    - [`fd_fibre_pipe_write`](<fd_fibre.c.md#fd_fibre_pipe_write>)


---
### pipe\_consumer\_main<!-- {{#callable:pipe_consumer_main}} -->
[View Source →](<../../../../../src/util/fibre/test_fibre.c#L308>)

Reads messages from a pipe until a specified expiration time and prints them.
- **Inputs**:
    - `vp_args`: A pointer to `pipe_consumer_args_t` structure containing the input pipe, expiration time, and consumer name.
- **Logic and Control Flow**:
    - Cast `vp_args` to `pipe_consumer_args_t` to obtain `input` pipe and `expire` time.
    - Calculate `expire_time` by adding `expire` to the current time `now`.
    - Enter a loop that continues until `expire_time` is greater than `now`.
    - Inside the loop, attempt to read a message from `input` pipe with a timeout of `expire_time - now`.
    - If the read operation fails, break the loop.
    - If a message is read successfully, print the message along with the consumer's name.
    - After exiting the loop, print a finished message.
- **Output**: No return value; outputs messages to the standard output.
- **Functions Called**:
    - [`fd_fibre_pipe_read`](<fd_fibre.c.md#fd_fibre_pipe_read>)


---
### run\_test\_pipe\_filter<!-- {{#callable:run_test_pipe_filter}} -->
[View Source →](<../../../../../src/util/fibre/test_fibre.c#L333>)

Executes a test of a pipe filter system using fibres to simulate a producer, a filter, and two consumers, managing memory allocation and scheduling.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize `pipe_entries` to 16 and `stack_sz` to 1<<20 for pipe and fibre configurations.
    - Allocate memory for three pipes and create them using [`fd_fibre_pipe_new`](<fd_fibre.c.md#fd_fibre_pipe_new>).
    - Set `period` to 1 ms and `expire` to 20 ms for timing control.
    - Initialize arguments for producer, filter, and consumer fibres with respective pipes and timing parameters.
    - Allocate memory and start fibres for producer, filter, and two consumers using [`fd_fibre_start`](<fd_fibre.c.md#fd_fibre_start>).
    - Schedule all fibres using [`fd_fibre_schedule`](<fd_fibre.c.md#fd_fibre_schedule>).
    - Run the fibre schedule in a loop until no fibres are scheduled, updating `now` to the next event time.
    - Free all allocated fibres and their memory after execution.
    - Free all allocated pipe memory after execution.
- **Output**: No return value; the function performs operations and manages resources internally.
- **Functions Called**:
    - [`fd_fibre_start_align`](<fd_fibre.c.md#fd_fibre_start_align>)
    - [`fd_fibre_start_footprint`](<fd_fibre.c.md#fd_fibre_start_footprint>)
    - [`fd_fibre_pipe_new`](<fd_fibre.c.md#fd_fibre_pipe_new>)
    - [`fd_fibre_start`](<fd_fibre.c.md#fd_fibre_start>)
    - [`fd_fibre_schedule`](<fd_fibre.c.md#fd_fibre_schedule>)
    - [`fd_fibre_schedule_run`](<fd_fibre.c.md#fd_fibre_schedule_run>)
    - [`fd_fibre_free`](<fd_fibre.c.md#fd_fibre_free>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/util/fibre/test_fibre.c#L412>)

Initializes and manages the execution of multiple fibres, including scheduling and running tests for fibre wait functions and pipe communication.
- **Inputs**:
    - `argc`: The number of command-line arguments passed to the program.
    - `argv`: An array of strings representing the command-line arguments.
- **Logic and Control Flow**:
    - Initialize the main fibre using [`fd_fibre_init`](<fd_fibre.c.md#fd_fibre_init>) with memory allocated by `aligned_alloc`.
    - Create three fibres for functions `fn1`, `fn2`, and `fn3` with a stack size of 1 MB each, using [`fd_fibre_start`](<fd_fibre.c.md#fd_fibre_start>).
    - Start each fibre using [`fd_fibre_swap`](<fd_fibre.c.md#fd_fibre_swap>) and allow them to complete execution.
    - Free the memory and resources associated with the fibres using [`fd_fibre_free`](<fd_fibre.c.md#fd_fibre_free>) and `free`.
    - Set a synthetic clock using [`fd_fibre_set_clock`](<fd_fibre.c.md#fd_fibre_set_clock>) to `my_clock`.
    - Prepare and start additional fibres for `test1` and `test2` functions with different periods and done times.
    - Schedule these fibres using [`fd_fibre_schedule`](<fd_fibre.c.md#fd_fibre_schedule>) and run the schedule until no fibres are left using [`fd_fibre_schedule_run`](<fd_fibre.c.md#fd_fibre_schedule_run>).
    - Free the memory and resources associated with these test fibres.
    - Run additional tests [`run_pipe_test`](<#run_pipe_test>) and [`run_test_pipe_filter`](<#run_test_pipe_filter>) for pipe communication between fibres.
    - Free the main fibre and its allocated memory before exiting.
- **Output**: Returns an integer value `0` to indicate successful execution of the program.
- **Functions Called**:
    - [`fd_fibre_init_align`](<fd_fibre.c.md#fd_fibre_init_align>)
    - [`fd_fibre_init_footprint`](<fd_fibre.c.md#fd_fibre_init_footprint>)
    - [`fd_fibre_init`](<fd_fibre.c.md#fd_fibre_init>)
    - [`fd_fibre_start_align`](<fd_fibre.c.md#fd_fibre_start_align>)
    - [`fd_fibre_start_footprint`](<fd_fibre.c.md#fd_fibre_start_footprint>)
    - [`fd_fibre_start`](<fd_fibre.c.md#fd_fibre_start>)
    - [`fd_fibre_swap`](<fd_fibre.c.md#fd_fibre_swap>)
    - [`fd_fibre_free`](<fd_fibre.c.md#fd_fibre_free>)
    - [`fd_fibre_set_clock`](<fd_fibre.c.md#fd_fibre_set_clock>)
    - [`fd_fibre_schedule`](<fd_fibre.c.md#fd_fibre_schedule>)
    - [`fd_fibre_schedule_run`](<fd_fibre.c.md#fd_fibre_schedule_run>)
    - [`run_pipe_test`](<#run_pipe_test>)
    - [`run_test_pipe_filter`](<#run_test_pipe_filter>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)