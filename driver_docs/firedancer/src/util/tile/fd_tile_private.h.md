<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Internal utilities for managing CPU sets and thread affinity in the fd_tile module.

# Purpose
The code defines internal utilities for managing CPU sets within the `fd_tile` module. It provides an alternative to the standard `cpu_set_t` from the C library, named `fd_cpuset_t`, to address stability issues and strict aliasing violations encountered with the standard API. The code includes macros and functions for declaring and manipulating these CPU sets, such as `FD_CPUSET_DECL` for declaring an empty CPU set and `fd_cpuset_{get,set}affinity` for wrapping the `sched_{get,set}affinity` functions. These functions are intended for internal use within the `fd_tile` module and are not part of the public API.

The file also includes internal functions for managing thread stack allocation and parsing CPU configurations, specifically [`fd_tile_private_stack_new`](<#fd_tile_private_stack_new>) and [`fd_tile_private_cpus_parse`](<#fd_tile_private_cpus_parse>). These functions are designed to optimize CPU affinity and manage CPU resources within the constraints of the `fd_tile` module. The code is structured to ensure that it does not expose these internal mechanisms to external modules, maintaining encapsulation and focusing on internal stability and performance.
# Imports and Dependencies

---
- `fd_tile.h`
- `../tmpl/fd_set.c`


# Function Declarations (Public API)

---
### fd\_cpuset\_getaffinity<!-- {{#callable_declaration:fd_cpuset_getaffinity}} -->
[View Source →](<../../../../../src/util/tile/fd_tile_private.h#L34>)

Retrieves the CPU affinity mask for a specified thread.
- **Description**: Use this function to obtain the CPU affinity mask of a specific thread, identified by its thread ID. This function is intended for internal use within the `fd_tile` module and addresses type-punning issues associated with the `cpu_set_t` API. It is important to note that if the number of host CPUs exceeds `FD_TILE_MAX`, the function will silently truncate the CPU set. This function should not be used for setting tile affinity, as it may lead to sub-optimal performance and stability issues.
- **Inputs**:
    - `tid`: The thread ID for which to retrieve the CPU affinity mask. A value of 0 implies the current thread. Must be a valid thread ID.
    - `mask`: A pointer to an `fd_cpuset_t` structure where the CPU affinity mask will be stored. Must not be null. The caller retains ownership of the memory.
- **Output**: Returns 0 on success. On non-Linux systems, returns -1 and sets `errno` to `ENOTSUP` to indicate that the operation is not supported.
- **See Also**: [`fd_cpuset_getaffinity`](<fd_tile.c.md#fd_cpuset_getaffinity>)  (Implementation)


---
### fd\_cpuset\_setaffinity<!-- {{#callable_declaration:fd_cpuset_setaffinity}} -->
[View Source →](<../../../../../src/util/tile/fd_tile_private.h#L51>)

Sets the CPU affinity for a specified thread.
- **Description**: Use this function to set the CPU affinity for a specific thread, identified by its thread ID. This function is intended for internal use within the `fd_tile` module and addresses type-punning issues with the standard `sched_setaffinity` function. It is important to note that this function is not supported on non-Linux platforms, where it will return an error. Ensure that the `mask` parameter is correctly initialized using `FD_CPUSET_DECL` before calling this function.
- **Inputs**:
    - `tid`: The thread ID for which to set the CPU affinity. A value of 0 implies the current thread. Must be a valid thread ID.
    - `mask`: A pointer to a `fd_cpuset_t` structure that specifies the desired CPU affinity. Must not be null and should be initialized using `FD_CPUSET_DECL`.
- **Output**: Returns 0 on success. On non-Linux platforms, returns -1 and sets `errno` to `ENOTSUP`.
- **See Also**: [`fd_cpuset_setaffinity`](<fd_tile.c.md#fd_cpuset_setaffinity>)  (Implementation)


---
### fd\_tile\_private\_stack\_new<!-- {{#callable_declaration:fd_tile_private_stack_new}} -->
[View Source →](<../../../../../src/util/tile/fd_tile_private.h#L57>)

Allocates a new stack with optional NUMA and TLB optimization.
- **Description**: Use this function to allocate a new stack for a tile, with the option to optimize for NUMA and TLB if desired. This function is intended for internal use within the `fd_tile` module. If optimization is requested, the function attempts to allocate a stack optimized for the specified CPU index. If optimization fails or is not requested, it falls back to a standard stack allocation. The function handles memory allocation failures by logging warnings and attempting to continue with a fallback stack. It also sets up guard regions to protect the stack boundaries.
- **Inputs**:
    - `optimize`: An integer flag indicating whether to optimize the stack for NUMA and TLB. A non-zero value requests optimization, while zero skips it.
    - `cpu_idx`: An unsigned long representing the CPU index for which the stack should be optimized. This parameter is ignored if optimization is not requested.
- **Output**: Returns a pointer to the newly allocated stack. If allocation fails, it returns NULL.
- **See Also**: [`fd_tile_private_stack_new`](<fd_tile_threads.cxx.md#fd_tile_private_stack_new>)  (Implementation)


---
### fd\_tile\_private\_cpus\_parse<!-- {{#callable_declaration:fd_tile_private_cpus_parse}} -->
[View Source →](<../../../../../src/util/tile/fd_tile_private.h#L61>)

Parses a CPU configuration string into a tile-to-CPU mapping.
- **Description**: Use this function to convert a string representation of CPU assignments into a mapping of tiles to CPUs. The function processes the input string to identify CPU ranges and floating tile requests, storing the results in the provided array. It expects a non-null string input and an array with sufficient capacity to hold the results. The function returns the number of CPUs parsed. If the input string is malformed or if the number of CPUs exceeds the maximum allowed, the function will log an error and terminate.
- **Inputs**:
    - `cstr`: A non-null pointer to a null-terminated string that specifies the CPU configuration. The string can include whitespace, CPU ranges, and floating tile requests. If the string is malformed, the function logs an error.
    - `tile_to_cpu`: A pointer to an array of `ushort` where the function will store the parsed tile-to-CPU mapping. The array must have enough space to accommodate the results, up to a maximum defined by `FD_TILE_MAX`. The caller retains ownership of the array.
- **Output**: Returns the number of CPUs successfully parsed from the input string. If the input string is null, returns 0.
- **See Also**: [`fd_tile_private_cpus_parse`](<fd_tile_threads.cxx.md#fd_tile_private_cpus_parse>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)