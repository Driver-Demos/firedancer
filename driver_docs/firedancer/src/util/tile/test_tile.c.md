<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for tile stack operations and tile-to-tile dispatch functionality in the Firedancer codebase.

# Purpose
The code is a C program designed to test and validate the functionality of a multi-tile execution environment. It includes functions to check the stack properties of tiles, such as stack boundaries and estimated free and used stack space. The program uses a series of assertions (`FD_TEST`) to ensure that the stack grows from high to low and that the estimated free and used stack space are within expected limits. The [`test_stack`](<#test_stack>) function is conditionally compiled based on the presence of AddressSanitizer (`FD_HAS_ASAN`), which suggests that the stack testing is not performed when AddressSanitizer is enabled.

The main functionality of the program is implemented in the [`main`](<#main>) and [`tile_main`](<#tile_main>) functions. These functions initialize the environment, log tile information, and perform tests on tile execution. The program verifies the number of tiles, their identifiers, and their indices. It also tests the ability to dispatch tasks to different tiles using `fd_tile_exec_new`, ensuring that tasks cannot be dispatched to tile 0 or the current tile. The program checks the execution status and results of dispatched tasks, ensuring that they complete successfully. The code is structured to run in a hosted environment, with additional checks for CPU assignments to tiles when `FD_HAS_HOSTED` is defined. The program concludes by logging a "pass" message and halting the environment.
# Imports and Dependencies

---
- `../fd_util.h`


# Global Variables

---
### \_argv
- **Type**: ``char const * []``
- **Description**: An array of constant character pointers that contains the strings "Hey" and "You", followed by a NULL pointer to indicate the end of the array.
- **Use**: Used as a reference for command-line arguments in the `tile_main` and `main` functions.


# Functions

---
### test\_stack<!-- {{#callable:test_stack}} -->
[View Source →](<../../../../../src/util/tile/test_tile.c#L45>)

Tests the stack memory boundaries and estimates for a tile in a multi-tile system.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `fd_tile_stack0` to get the initial stack pointer `stack0`.
    - If `stack0` is zero, verifies that `fd_tile_stack1`, `fd_tile_stack_sz`, `fd_tile_stack_est_free`, and `fd_tile_stack_est_used` all return zero using `FD_TEST`.
    - If `stack0` is not zero, retrieves `stack1`, `stack_sz`, `stack_est_free`, and `stack_est_used` using respective functions and performs boundary and size checks with `FD_TEST`.
    - Checks that the estimated free stack space is greater than the estimated used stack space.
    - Verifies that the sum of estimated free and used stack space is approximately equal to the total stack size, allowing for a margin of 64 bytes.
    - Allocates a small memory block on the stack and checks its address is within the stack boundaries.
    - Logs a notice message indicating stack testing.
    - Iterates over the stack memory range from `stack0` to `stack1`, accessing each byte to ensure memory is valid.
- **Output**: No output is returned; the function performs internal tests and logs results.


---
### tile\_main<!-- {{#callable:tile_main}} -->
[View Source →](<../../../../../src/util/tile/test_tile.c#L49>)

Executes and tests tile-based execution logic, including dispatching tasks to different tiles and verifying execution conditions.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
- **Logic and Control Flow**:
    - Logs and verifies the number of tiles using `fd_tile_cnt()` and checks it is within valid range.
    - Logs and verifies tile IDs using `fd_tile_id0()`, `fd_tile_id1()`, and `fd_tile_id()`, ensuring they are consistent with the tile count and index.
    - Flushes the log buffer using `fd_log_flush()`.
    - Calls `test_stack()` to perform stack-related tests.
    - Verifies that the current tile ID matches the log thread ID using `fd_log_thread_id()`.
    - Checks that `argc` matches the tile index and `argv` matches the global `_argv`.
    - Attempts to dispatch a new task to tile 0 and the current tile, expecting failure.
    - If the current tile index is the second last, dispatches a task to the next tile and verifies execution properties using `fd_tile_exec_new()`, `fd_tile_exec()`, `fd_tile_exec_by_id()`, `fd_tile_exec_idx()`, `fd_tile_exec_task()`, `fd_tile_exec_argc()`, and `fd_tile_exec_argv()`.
    - Checks if the dispatched task is done using `fd_tile_exec_done()` and deletes the task using `fd_tile_exec_delete()`, verifying the return value and ensuring no failure.
- **Output**: Returns the input `argc` value.
- **Functions Called**:
    - [`test_stack`](<#test_stack>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/util/tile/test_tile.c#L95>)

Initializes the system, validates tile configurations, and executes tasks across multiple tiles.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the system with command-line arguments.
    - Retrieves the number of tiles using `fd_tile_cnt` and logs it.
    - Validates the tile count is within acceptable limits using `FD_TEST`.
    - Logs and validates tile IDs and indices using `fd_tile_id0`, `fd_tile_id1`, `fd_tile_id`, and `fd_tile_idx`.
    - Flushes the log buffer with `fd_log_flush`.
    - Calls [`test_stack`](<#test_stack>) to perform stack-related tests.
    - If `FD_HAS_HOSTED` is defined, retrieves the CPU count and iterates over each tile to log and validate CPU assignments.
    - Flushes the log buffer again with `fd_log_flush`.
    - Validates that the current tile ID matches the log thread ID.
    - Iterates over each tile (except the first and last) to execute `tile_main` on each tile using `fd_tile_exec_new`.
    - Validates the execution context and results for each tile using `FD_TEST`.
    - Logs a success message and calls `fd_halt` to terminate the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`test_stack`](<#test_stack>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)