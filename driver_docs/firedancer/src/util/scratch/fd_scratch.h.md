<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

APIs for high-performance scratch pad memory allocation, including alignment-aware allocators and safety checks.

# Purpose
The code is a C header file that provides APIs for high-performance scratch pad memory allocation. It defines two main allocators: `fd_alloca`, which is an alignment-aware equivalent of `alloca`, and [`fd_scratch_alloc`](<#fd_scratch_alloc>), which is designed for complex and large temporary memory usage. The file includes mechanisms for managing memory alignment and footprint, ensuring that memory allocations are efficient and conform to specific alignment requirements. The default alignment is set to 128 bytes to optimize for various hardware architectures, including x86 and GPU environments.

The header file defines both private and public APIs. The private APIs manage internal states and alignment checks, while the public APIs provide functions for attaching and detaching memory regions, managing scratch frames, and performing memory allocations. The file also includes macros for creating temporary scratch frames within a scope and provides safety checks to ensure that operations are performed correctly. The code is designed to be fast and efficient, with operations optimized to use minimal assembly instructions. Additionally, the file includes conditional compilation options to enable runtime checks and debugging features, such as AddressSanitizer (ASAN) and MemorySanitizer (MSAN) support, to detect memory errors.
# Imports and Dependencies

---
- `../tile/fd_tile.h`


# Global Variables

---
### fd\_scratch\_in\_prepare
- **Type**: `int`
- **Description**: A global integer variable that is used to track the state of a scratch memory preparation process.
- **Use**: Used to indicate whether a scratch memory allocation is currently being prepared when `FD_SCRATCH_USE_HANDHOLDING` is enabled.


---
### fd\_scratch\_private\_start
- **Type**: `ulong`
- **Description**: `fd_scratch_private_start` is a global variable of type `ulong` that represents the starting address of the scratch pad memory region used for temporary memory allocations.
- **Use**: Used to initialize and manage the starting point of the scratch pad memory in the `fd_scratch_attach` function.


---
### fd\_scratch\_private\_free
- **Type**: `ulong`
- **Description**: `fd_scratch_private_free` is a global variable of type `ulong` that represents the current free position in the scratch pad memory.
- **Use**: Tracks the next available memory location for allocation in the scratch pad.


---
### fd\_scratch\_private\_stop
- **Type**: `ulong`
- **Description**: `fd_scratch_private_stop` is a global variable of type `ulong` that represents the end address of the scratch pad memory region in the `fd_scratch` module.
- **Use**: Used to determine the boundary of the scratch pad memory region, ensuring allocations do not exceed this limit.


---
### fd\_scratch\_private\_frame
- **Type**: `ulong *`
- **Description**: Points to the start of the frame memory used for managing scratch frames in the scratch pad memory allocation system.
- **Use**: Used to track the memory location of the current frame in the scratch pad memory.


---
### fd\_scratch\_private\_frame\_cnt
- **Type**: ``ulong``
- **Description**: Represents the current number of scratch frames in use by the scratch pad memory allocator. It is used to track how many frames have been pushed onto the stack of scratch frames.
- **Use**: Tracks the number of active scratch frames in the memory allocation process.


---
### fd\_scratch\_private\_frame\_max
- **Type**: `ulong`
- **Description**: Represents the maximum number of scratch frames that can be used in the scratch pad memory allocation system.
- **Use**: Used to limit the number of frames that can be pushed onto the scratch pad memory stack.


---
### fd\_alloca\_check\_private\_sz
- **Type**: `ulong`
- **Description**: `fd_alloca_check_private_sz` is a global variable of type `ulong` used in the `fd_alloca_check` macro to store the size of the allocation request.
- **Use**: Used to check the size of the allocation request in the `fd_alloca_check` macro to prevent stack overflow.


# Functions

---
### fd\_scratch\_private\_align\_is\_valid<!-- {{#callable:fd_scratch_private_align_is_valid}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L74>)

Checks if a given alignment value is a power of two or zero.
- **Inputs**:
    - `align`: An unsigned long integer representing the alignment value to check.
- **Logic and Control Flow**:
    - Performs a bitwise AND operation between `align` and `align-1UL`.
    - Returns the negation of the result, which is true if `align` is a power of two or zero.
- **Output**: Returns an integer that is non-zero if `align` is a power of two or zero, and zero otherwise.


---
### fd\_scratch\_private\_true\_align<!-- {{#callable:fd_scratch_private_true_align}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L79>)

Determines the true alignment value by returning a default alignment if the input is zero, otherwise returning the input alignment.
- **Inputs**:
    - `align`: An unsigned long integer representing the desired alignment value.
- **Logic and Control Flow**:
    - Checks if `align` is zero.
    - If `align` is zero, returns `FD_SCRATCH_ALIGN_DEFAULT`.
    - If `align` is not zero, returns `align`.
- **Output**: An unsigned long integer representing the true alignment value.


---
### fd\_scratch\_smem\_align<!-- {{#callable:fd_scratch_smem_align}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L121>)

Returns the alignment requirement for a scratch pad memory region.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the constant `FD_SCRATCH_SMEM_ALIGN`.
- **Output**: The function outputs an `ulong` representing the alignment requirement for scratch pad memory, which is defined as `FD_SCRATCH_SMEM_ALIGN`.


---
### fd\_scratch\_smem\_footprint<!-- {{#callable:fd_scratch_smem_footprint}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L123>)

Calculates the aligned memory footprint for a scratch pad memory region that can hold up to `smax` bytes.
- **Inputs**:
    - `smax`: The maximum number of bytes the scratch pad memory region should be able to hold.
- **Logic and Control Flow**:
    - Calls `fd_ulong_align_up` with `smax` and `FD_SCRATCH_SMEM_ALIGN` to compute the aligned size.
    - Returns the result of the alignment calculation.
- **Output**: An unsigned long integer representing the aligned memory footprint size.


---
### fd\_scratch\_fmem\_align<!-- {{#callable:fd_scratch_fmem_align}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L146>)

Returns the alignment requirement for the scratch pad memory metadata region, which is the size of an `ulong`.
- **Inputs**: None
- **Logic and Control Flow**:
    - The function returns the size of an `ulong` as the alignment requirement for the scratch pad memory metadata region.
- **Output**: The function returns an `ulong` representing the alignment size, which is `sizeof(ulong)`.


---
### fd\_scratch\_fmem\_footprint<!-- {{#callable:fd_scratch_fmem_footprint}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L147>)

Calculates the memory footprint required for a scratch pad memory capable of holding a specified number of frames.
- **Inputs**:
    - `depth`: The number of scratch frames the memory region should be able to hold.
- **Logic and Control Flow**:
    - Multiplies the size of an `ulong` by the `depth` to determine the total memory footprint.
- **Output**: Returns the total memory footprint in bytes as an `ulong`.


---
### fd\_scratch\_attach<!-- {{#callable:fd_scratch_attach}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L160>)

Attaches a thread to specified memory regions for scratch pad memory allocation, initializing internal state and optionally performing memory poisoning for debugging.
- **Inputs**:
    - `smem`: Pointer to the memory region for scratch pad data storage.
    - `fmem`: Pointer to the memory region for scratch pad frame metadata.
    - `smax`: Maximum size in bytes of the scratch pad memory region.
    - `depth`: Maximum number of frames that can be used in the scratch pad.
- **Logic and Control Flow**:
    - If `FD_SCRATCH_USE_HANDHOLDING` is enabled, check if a scratch pad is already attached and validate inputs; log errors if any checks fail.
    - Set `fd_scratch_private_start`, `fd_scratch_private_free`, and `fd_scratch_private_stop` to manage the scratch pad memory region.
    - Initialize `fd_scratch_private_frame`, `fd_scratch_private_frame_cnt`, and `fd_scratch_private_frame_max` to manage frame metadata.
    - If `FD_HAS_DEEPASAN` is enabled, poison the memory region to detect invalid memory accesses, respecting alignment requirements.
    - If `FD_HAS_MSAN` is enabled, mark the memory region as uninitialized to detect use of uninitialized memory.
- **Output**: No return value; initializes internal state for scratch pad memory management.


---
### fd\_scratch\_detach<!-- {{#callable:fd_scratch_detach}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L211>)

Detaches the calling thread from its current scratch pad memory attachment, returning the start of the scratch memory and optionally storing the frame memory.
- **Inputs**:
    - `_opt_fmem`: An optional pointer to a memory location where the function will store the frame memory if provided.
- **Logic and Control Flow**:
    - If `FD_SCRATCH_USE_HANDHOLDING` is enabled, check if the scratch pad is attached; if not, log an error.
    - If `FD_HAS_DEEPASAN` is enabled, unpoison the scratch space to ensure it is safe for use.
    - Store the current start of the scratch memory (`fd_scratch_private_start`) in `smem` and the current frame memory (`fd_scratch_private_frame`) in `fmem`.
    - Reset all private scratch pad memory variables to indicate detachment.
    - If `_opt_fmem` is not NULL, store `fmem` in `_opt_fmem[0]`.
    - Return `smem`, which is the start of the scratch memory.
- **Output**: Returns a pointer to the start of the scratch memory (`smem`) that was used during the attachment.


---
### fd\_scratch\_used<!-- {{#callable:fd_scratch_used}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L253>)

Calculates the number of bytes currently used in the scratch pad memory.
- **Inputs**: None
- **Logic and Control Flow**:
    - Subtracts `fd_scratch_private_start` from `fd_scratch_private_free` to determine the used memory size.
- **Output**: Returns the number of bytes used in the scratch pad memory as an unsigned long integer.


---
### fd\_scratch\_free<!-- {{#callable:fd_scratch_free}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L254>)

Calculates the number of free bytes available in the scratch pad memory.
- **Inputs**: None
- **Logic and Control Flow**:
    - Subtracts the value of `fd_scratch_private_free` from `fd_scratch_private_stop`.
- **Output**: Returns the number of free bytes as an unsigned long integer (`ulong`).


---
### fd\_scratch\_frame\_used<!-- {{#callable:fd_scratch_frame_used}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L263>)

Returns the number of scratch frames currently in use.
- **Inputs**: None
- **Logic and Control Flow**:
    - Accesses the global variable `fd_scratch_private_frame_cnt`.
    - Returns the value of `fd_scratch_private_frame_cnt`, which represents the number of scratch frames currently in use.
- **Output**: The function returns an `ulong` representing the number of scratch frames in use.


---
### fd\_scratch\_frame\_free<!-- {{#callable:fd_scratch_frame_free}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L264>)

Calculates the number of free scratch frames available.
- **Inputs**: None
- **Logic and Control Flow**:
    - Subtracts `fd_scratch_private_frame_cnt` from `fd_scratch_private_frame_max`.
- **Output**: Returns the number of free scratch frames as an unsigned long integer.


---
### fd\_scratch\_reset<!-- {{#callable:fd_scratch_reset}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L274>)

Resets the scratch pad memory to its initial state after attachment, freeing all allocations and frames.
- **Inputs**: None
- **Logic and Control Flow**:
    - If `FD_SCRATCH_USE_HANDHOLDING` is enabled, check if the scratch pad is attached; if not, log an error and abort.
    - Set `fd_scratch_in_prepare` to 0 to indicate no preparation is in progress.
    - Reset `fd_scratch_private_free` to `fd_scratch_private_start`, effectively freeing all allocations.
    - Set `fd_scratch_private_frame_cnt` to 0, indicating no frames are in use.
    - If `FD_HAS_DEEPASAN` is enabled, poison the entire scratch space to detect invalid memory accesses.
    - If `FD_HAS_MSAN` is enabled, mark the entire scratch space as uninitialized to detect uninitialized memory reads.
- **Output**: No return value; the function modifies global state related to scratch pad memory.


---
### fd\_scratch\_push<!-- {{#callable:fd_scratch_push}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L303>)

Creates a new scratch frame and makes it the current frame, with optional runtime checks and memory poisoning for debugging.
- **Inputs**: None
- **Logic and Control Flow**:
    - If `FD_SCRATCH_USE_HANDHOLDING` is enabled, check if the scratch pad is attached and if there is space for a new frame; log errors if not.
    - Set `fd_scratch_in_prepare` to 0 to indicate no allocation is in preparation.
    - Store the current free memory pointer in the frame stack and increment the frame count.
    - If `FD_HAS_DEEPASAN` or `FD_HAS_MSAN` is enabled, align the start and stop pointers and poison the memory region to detect invalid memory accesses.
- **Output**: No output; modifies global state to manage scratch frames.


---
### fd\_scratch\_pop<!-- {{#callable:fd_scratch_pop}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L338>)

Releases all allocations in the current scratch frame, destroys the frame, and reverts to the previous frame if available.
- **Inputs**: None
- **Logic and Control Flow**:
    - If `FD_SCRATCH_USE_HANDHOLDING` is enabled, check if the scratch pad is attached and if there is a frame to pop; log an error if not.
    - Set `fd_scratch_in_prepare` to 0 to indicate no ongoing preparation.
    - Decrement `fd_scratch_private_frame_cnt` to move to the previous frame and update `fd_scratch_private_free` to the start of this frame.
    - If `FD_HAS_DEEPASAN` is enabled, poison the memory from `fd_scratch_private_free` to the end of the scratch space, aligning the start and stop addresses as required.
    - If `FD_HAS_MSAN` is enabled, perform a similar poisoning operation for memory sanitization.
- **Output**: No return value; modifies internal state to reflect the removal of the current scratch frame.


---
### fd\_scratch\_prepare<!-- {{#callable:fd_scratch_prepare}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L410>)

Prepares a memory region with a specified alignment for allocation in the current scratch frame.
- **Inputs**:
    - `align`: The desired alignment for the memory region, where 0 uses the default alignment.
- **Logic and Control Flow**:
    - If `FD_SCRATCH_USE_HANDHOLDING` is enabled, check if there is a current frame and if the alignment is valid; log an error if not.
    - If `FD_HAS_DEEPASAN` is enabled, adjust the alignment to ensure at least 8-byte alignment.
    - Calculate the true alignment using [`fd_scratch_private_true_align`](<#fd_scratch_private_true_align>) and align the current free memory pointer `fd_scratch_private_free` to this alignment.
    - If `FD_SCRATCH_USE_HANDHOLDING` is enabled, check for overflow or insufficient scratch space; log an error if detected and set `fd_scratch_in_prepare` to 1.
    - If `FD_HAS_DEEPASAN` is enabled, unpoison the memory region from the aligned start to the end of the scratch space.
    - Update `fd_scratch_private_free` to the aligned memory address.
- **Output**: Returns a pointer to the aligned memory region in the caller's address space.
- **Functions Called**:
    - [`fd_scratch_private_align_is_valid`](<#fd_scratch_private_align_is_valid>)
    - [`fd_scratch_private_true_align`](<#fd_scratch_private_true_align>)


---
### fd\_scratch\_publish<!-- {{#callable:fd_scratch_publish}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L443>)

Completes an in-progress memory allocation in a scratch pad by updating the free pointer and optionally poisoning unused memory regions for debugging.
- **Inputs**:
    - `_end`: A pointer to the end of the allocated memory region, indicating the first byte after the final allocation.
- **Logic and Control Flow**:
    - Convert `_end` to an unsigned long `end`.
    - If `FD_SCRATCH_USE_HANDHOLDING` is enabled, check if a prepare is in progress, if `end` is less than `fd_scratch_private_free`, or if `end` exceeds `fd_scratch_private_stop`, and log errors if any condition is true.
    - Set `fd_scratch_in_prepare` to 0 to indicate the end of the prepare phase.
    - If `FD_HAS_DEEPASAN` is enabled, align `fd_scratch_private_free`, `end`, and `fd_scratch_private_stop` to `FD_ASAN_ALIGN` and poison the memory region from `aligned_end` to `aligned_stop`, and unpoison the region from `aligned_free` to `aligned_end`.
    - If `FD_HAS_MSAN` is enabled, perform similar alignment and poisoning operations as in `FD_HAS_DEEPASAN`, but with `FD_MSAN_ALIGN`.
    - Update `fd_scratch_private_free` to `end`.
- **Output**: No return value; updates the global state of the scratch pad memory.


---
### fd\_scratch\_cancel<!-- {{#callable:fd_scratch_cancel}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L475>)

Cancels an in-progress memory allocation in a scratch pad memory system.
- **Inputs**: None
- **Logic and Control Flow**:
    - Checks if `FD_SCRATCH_USE_HANDHOLDING` is enabled.
    - If enabled, verifies that `fd_scratch_in_prepare` is set, indicating an allocation is in progress.
    - If the check fails, logs an error message 'unmatched prepare'.
    - Resets `fd_scratch_in_prepare` to 0, indicating no allocation is in progress.
- **Output**: No output is returned.


---
### fd\_scratch\_alloc<!-- {{#callable:fd_scratch_alloc}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L516>)

Allocates a block of memory with a specified alignment and size in the current scratch frame.
- **Inputs**:
    - `align`: The alignment requirement for the memory block, which must be 0 or a power of 2; 0 defaults to `FD_SCRATCH_ALIGN_DEFAULT`.
    - `sz`: The size of the memory block to allocate in bytes.
- **Logic and Control Flow**:
    - Call [`fd_scratch_prepare`](<#fd_scratch_prepare>) with `align` to get the starting memory address `smem` for the allocation.
    - Calculate `end` as the sum of `smem` and `sz`.
    - If `FD_SCRATCH_USE_HANDHOLDING` is enabled, check for overflow or out-of-bounds conditions with `end`.
    - Call [`fd_scratch_publish`](<#fd_scratch_publish>) with `end` to finalize the allocation.
    - Return the starting address `smem` as a pointer.
- **Output**: A pointer to the allocated memory block with the specified alignment and size.
- **Functions Called**:
    - [`fd_scratch_prepare`](<#fd_scratch_prepare>)
    - [`fd_scratch_publish`](<#fd_scratch_publish>)


---
### fd\_scratch\_trim<!-- {{#callable:fd_scratch_trim}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L562>)

Adjusts the size of the most recent scratch allocation in the current scratch frame to a specified end point.
- **Inputs**:
    - `_end`: A pointer to the new end of the most recent scratch allocation, indicating the first byte to free or the first byte after the allocation.
- **Logic and Control Flow**:
    - Convert `_end` to an `ulong` type and store it in `end`.
    - If `FD_SCRATCH_USE_HANDHOLDING` is enabled, check for unmatched push, trim underflow, and trim overflow conditions, logging errors if any are detected.
    - If `FD_HAS_DEEPASAN` is enabled, align `end` and the stop of the scratch region, then poison the memory region from the aligned end to the aligned stop.
    - If `FD_HAS_MSAN` is enabled, perform similar alignment and poisoning operations as in `FD_HAS_DEEPASAN`.
    - Set `fd_scratch_private_free` to `end` to update the free space in the scratch memory.
- **Output**: The function does not return a value; it modifies the state of the scratch memory by updating `fd_scratch_private_free`.


---
### fd\_scratch\_attach\_is\_safe<!-- {{#callable:fd_scratch_attach_is_safe}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L629>)

Checks if the calling thread is not currently attached to a scratch pad memory.
- **Inputs**: None
- **Logic and Control Flow**:
    - Evaluates the expression `!fd_scratch_private_frame_max` to determine if the calling thread is not attached to a scratch pad memory.
    - Returns 1 if `fd_scratch_private_frame_max` is 0, indicating it is safe to attach.
    - Returns 0 if `fd_scratch_private_frame_max` is non-zero, indicating it is not safe to attach.
- **Output**: Returns an integer: 1 if it is safe to attach, 0 otherwise.


---
### fd\_scratch\_detach\_is\_safe<!-- {{#callable:fd_scratch_detach_is_safe}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L630>)

Checks if the calling thread is currently attached to a scratch pad memory.
- **Inputs**: None
- **Logic and Control Flow**:
    - Evaluates the global variable `fd_scratch_private_frame_max`.
    - Returns 1 if `fd_scratch_private_frame_max` is non-zero, indicating the thread is attached.
    - Returns 0 if `fd_scratch_private_frame_max` is zero, indicating the thread is not attached.
- **Output**: An integer value, 1 if the thread is attached to a scratch pad memory, 0 otherwise.


---
### fd\_scratch\_reset\_is\_safe<!-- {{#callable:fd_scratch_reset_is_safe}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L631>)

Checks if the scratch reset operation is safe by verifying if the calling thread is attached to a scratch pad memory.
- **Inputs**: None
- **Logic and Control Flow**:
    - Checks if `fd_scratch_private_frame_max` is non-zero, indicating that the calling thread is attached to a scratch pad memory.
- **Output**: Returns 1 if the calling thread is attached to a scratch pad memory, otherwise returns 0.


---
### fd\_scratch\_push\_is\_safe<!-- {{#callable:fd_scratch_push_is_safe}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L632>)

Checks if a new scratch frame can be safely pushed by comparing the current frame count with the maximum allowed frames.
- **Inputs**: None
- **Logic and Control Flow**:
    - Compares `fd_scratch_private_frame_cnt` with `fd_scratch_private_frame_max`.
    - Returns 1 if `fd_scratch_private_frame_cnt` is less than `fd_scratch_private_frame_max`, indicating it is safe to push a new frame.
    - Returns 0 otherwise, indicating it is not safe to push a new frame.
- **Output**: Returns an integer (1 or 0) indicating whether it is safe to push a new scratch frame.


---
### fd\_scratch\_pop\_is\_safe<!-- {{#callable:fd_scratch_pop_is_safe}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L633>)

Checks if there is at least one scratch frame in use.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the logical negation of `fd_scratch_private_frame_cnt`, which indicates the number of frames in use.
    - If `fd_scratch_private_frame_cnt` is greater than zero, the function returns 1, indicating it is safe to pop a frame.
    - If `fd_scratch_private_frame_cnt` is zero, the function returns 0, indicating it is not safe to pop a frame.
- **Output**: An integer value: 1 if it is safe to pop a frame, 0 otherwise.


---
### fd\_scratch\_prepare\_is\_safe<!-- {{#callable:fd_scratch_prepare_is_safe}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L635>)

Checks if it is safe to prepare an allocation with a given alignment in the current scratch frame.
- **Inputs**:
    - `align`: The desired alignment for the allocation, which must be a power of two or zero.
- **Logic and Control Flow**:
    - Check if there is a current frame by verifying `fd_scratch_private_frame_cnt` is non-zero; return 0 if not.
    - Validate the alignment using [`fd_scratch_private_align_is_valid`](<#fd_scratch_private_align_is_valid>); return 0 if invalid.
    - Calculate the true alignment using [`fd_scratch_private_true_align`](<#fd_scratch_private_true_align>).
    - Align the current free memory pointer `fd_scratch_private_free` to the true alignment using `fd_ulong_align_up`.
    - Check for alignment overflow by comparing the aligned memory pointer with `fd_scratch_private_free`; return 0 if overflow occurs.
    - Ensure there is enough scratch memory by comparing the aligned memory pointer with `fd_scratch_private_stop`; return 0 if insufficient.
    - Return 1 if all checks pass, indicating it is safe to prepare the allocation.
- **Output**: Returns 1 if it is safe to prepare the allocation, otherwise returns 0.
- **Functions Called**:
    - [`fd_scratch_private_align_is_valid`](<#fd_scratch_private_align_is_valid>)
    - [`fd_scratch_private_true_align`](<#fd_scratch_private_true_align>)


---
### fd\_scratch\_publish\_is\_safe<!-- {{#callable:fd_scratch_publish_is_safe}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L646>)

Checks if the given end pointer is a valid location to complete an allocation in preparation.
- **Inputs**:
    - `_end`: A pointer to the end of the allocation being checked.
- **Logic and Control Flow**:
    - Convert the input pointer `_end` to an unsigned long `end`.
    - If `FD_SCRATCH_USE_HANDHOLDING` is enabled, check if `fd_scratch_in_prepare` is false and return 0 if so, indicating not in prepare state.
    - Check if `end` is less than `fd_scratch_private_free`; if true, return 0 indicating a backward allocation.
    - Check if `end` is greater than `fd_scratch_private_stop`; if true, return 0 indicating out of bounds.
    - If none of the above conditions are met, return 1 indicating the end pointer is safe for publishing.
- **Output**: Returns 1 if the end pointer is safe for publishing, otherwise returns 0.


---
### fd\_scratch\_cancel\_is\_safe<!-- {{#callable:fd_scratch_cancel_is_safe}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L657>)

Always returns 1, indicating that canceling a scratch allocation is always safe.
- **Inputs**: None
- **Logic and Control Flow**:
    - The function is defined as `FD_FN_CONST`, meaning it is a constant function that does not depend on any mutable state.
    - The function is implemented as a static inline function, which suggests it is intended for use within the same translation unit and optimized for performance.
    - The function body contains a single return statement that returns the integer value 1.
- **Output**: An integer value of 1, indicating that it is always safe to cancel a scratch allocation.


---
### fd\_scratch\_alloc\_is\_safe<!-- {{#callable:fd_scratch_alloc_is_safe}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L662>)

Checks if a scratch pad memory allocation with a given alignment and size is safe to perform.
- **Inputs**:
    - `align`: The desired alignment for the allocation, which must be a power of two or zero (zero defaults to a predefined alignment).
    - `sz`: The size of the memory allocation in bytes.
- **Logic and Control Flow**:
    - Checks if there is a current scratch frame by verifying `fd_scratch_private_frame_cnt` is non-zero.
    - Validates the alignment using [`fd_scratch_private_align_is_valid`](<#fd_scratch_private_align_is_valid>) to ensure it is a power of two or zero.
    - Calculates the true alignment using [`fd_scratch_private_true_align`](<#fd_scratch_private_true_align>).
    - Aligns the current free memory pointer `fd_scratch_private_free` to the true alignment using `fd_ulong_align_up`.
    - Checks for alignment overflow by ensuring the aligned memory pointer `smem` is not less than `fd_scratch_private_free`.
    - Calculates the new free memory pointer after allocation by adding `sz` to `smem`.
    - Checks for size overflow by ensuring the new free memory pointer `free` is not less than `smem`.
    - Ensures there is enough space for the allocation by checking if `free` is less than or equal to `fd_scratch_private_stop`.
    - Returns 1 if all checks pass, indicating the allocation is safe; otherwise, returns 0.
- **Output**: Returns 1 if the allocation is safe, otherwise returns 0.
- **Functions Called**:
    - [`fd_scratch_private_align_is_valid`](<#fd_scratch_private_align_is_valid>)
    - [`fd_scratch_private_true_align`](<#fd_scratch_private_true_align>)


---
### fd\_scratch\_trim\_is\_safe<!-- {{#callable:fd_scratch_trim_is_safe}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L676>)

Checks if trimming the current scratch frame to a specified end address is safe.
- **Inputs**:
    - `_end`: A pointer to the end address to which the current scratch frame should be trimmed.
- **Logic and Control Flow**:
    - Convert the input pointer `_end` to an unsigned long integer `end`.
    - Check if there is no current frame by evaluating `fd_scratch_private_frame_cnt`; return 0 if true.
    - Check if `end` is less than the start of the current frame (`fd_scratch_private_frame[fd_scratch_private_frame_cnt-1UL]`); return 0 if true.
    - Check if `end` is greater than the current free space (`fd_scratch_private_free`); return 0 if true.
    - Return 1 if none of the above conditions are met, indicating it is safe to trim.
- **Output**: Returns 1 if it is safe to trim the current scratch frame to the specified end address, otherwise returns 0.


---
### fd\_scratch\_scoped\_pop\_private<!-- {{#callable:fd_scratch_scoped_pop_private}} -->
[View Source →](<../../../../../src/util/scratch/fd_scratch.h#L700>)

Calls [`fd_scratch_pop`](<#fd_scratch_pop>) to free all allocations in the current scratch frame and destroy the current frame.
- **Inputs**:
    - `_unused`: A void pointer that is not used in the function body.
- **Logic and Control Flow**:
    - Casts the `_unused` parameter to void to avoid compiler warnings about unused parameters.
    - Calls the [`fd_scratch_pop`](<#fd_scratch_pop>) function to free all allocations in the current scratch frame and destroy the current frame.
- **Output**: No output is returned as the function is of type `void`.
- **Functions Called**:
    - [`fd_scratch_pop`](<#fd_scratch_pop>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)