<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for managing process environment, file descriptors, user and group IDs, namespaces, resource limits, capabilities, and security restrictions in a sandbox environment.

# Purpose
The code in this file is a C header file that defines a set of private functions for managing and securing a sandbox environment. The functions focus on enhancing security by controlling process environment variables, file descriptors, user and group IDs, and system capabilities. The file includes functions to clear environment variables, check file descriptors, switch user and group IDs, and write user namespace mappings. It also provides mechanisms to deny namespace creation, pivot the root filesystem, set resource limits, and read kernel capabilities. Additionally, the file includes functions to drop all capabilities, apply landlock restrictions, and install seccomp-bpf filters to restrict system calls.

These functions are designed to be used internally within a sandboxing framework, such as Firedancer, to ensure that processes run in a controlled and secure environment. The functions are not intended for public use, as indicated by the `fd_sandbox_private_` prefix in their names. The file does not define public APIs or external interfaces but rather provides internal mechanisms to enforce security policies and prevent unauthorized access or privilege escalation within the sandbox.
# Imports and Dependencies

---
- `fd_sandbox.h`


# Function Declarations (Public API)

---
### fd\_sandbox\_private\_check\_exact\_file\_descriptors<!-- {{#callable_declaration:fd_sandbox_private_check_exact_file_descriptors}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox_private.h#L47>)

Verifies that the current process's open file descriptors match a specified list.
- **Description**: Use this function to ensure that the open file descriptors in the current process exactly match a provided list of allowed file descriptors. This function is crucial for maintaining the security of a sandboxed environment by preventing unauthorized file descriptors from being open. It checks for discrepancies such as unexpected open file descriptors or missing ones from the allowed list, and it will terminate the program with an error if any are found. This function is typically used as a defense-in-depth measure to catch programming errors or unexpected system behavior that could compromise security. Ensure that the list of allowed file descriptors does not exceed 256 entries and contains no duplicates.
- **Inputs**:
    - `allowed_file_descriptor_cnt`: Specifies the number of file descriptors in the allowed list. Must be between 0 and 256 inclusive. If the value exceeds 256, the function will terminate the program with an error.
    - `allowed_file_descriptor`: A pointer to an array of integers representing the allowed file descriptors. The array must contain exactly 'allowed_file_descriptor_cnt' entries. The function assumes the array is valid and will terminate the program with an error if it contains invalid file descriptors (negative or INT_MAX) or duplicates.
- **Output**: None
- **See Also**: [`fd_sandbox_private_check_exact_file_descriptors`](<fd_sandbox.c.md#fd_sandbox_private_check_exact_file_descriptors>)  (Implementation)


---
### fd\_sandbox\_private\_switch\_uid\_gid<!-- {{#callable_declaration:fd_sandbox_private_switch_uid_gid}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox_private.h#L67>)

Sets the user and group IDs for the calling thread.
- **Description**: Use this function to set the real, effective, and saved set-user-ID and set-group-ID of the calling thread to the specified values. This function is useful in scenarios where you need to change the user and group IDs for a specific thread without affecting other threads in the process. Ensure that the calling process has the necessary capabilities (CAP_SETUID and CAP_SETGID) to perform these operations, or the function will log an error and terminate the process. The function also manages the dumpable bit, restoring it if it was altered during the ID switch.
- **Inputs**:
    - `desired_uid`: The target user ID to set for the calling thread. Must be a valid user ID that the process has permission to switch to.
    - `desired_gid`: The target group ID to set for the calling thread. Must be a valid group ID that the process has permission to switch to.
- **Output**: None
- **See Also**: [`fd_sandbox_private_switch_uid_gid`](<fd_sandbox.c.md#fd_sandbox_private_switch_uid_gid>)  (Implementation)


---
### fd\_sandbox\_private\_write\_userns\_uid\_gid\_maps<!-- {{#callable_declaration:fd_sandbox_private_write_userns_uid_gid_maps}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox_private.h#L96>)

Writes user and group ID mappings for a user namespace.
- **Description**: Use this function immediately after creating a user namespace to set up the mapping of user and group IDs from the namespace to the parent namespace. It maps the UID and GID of '1' inside the namespace to the specified UID and GID in the parent namespace. This function must be called before any other operations in the namespace. It also writes 'deny' to '/proc/self/setgroups' as a security measure required by the kernel. Ensure that the provided UID and GID match the effective UID and GID of the process that created the namespace.
- **Inputs**:
    - `uid_in_parent`: The UID in the parent namespace to which UID 1 in the user namespace will be mapped. Must be a valid user ID.
    - `gid_in_parent`: The GID in the parent namespace to which GID 1 in the user namespace will be mapped. Must be a valid group ID.
- **Output**: None
- **See Also**: [`fd_sandbox_private_write_userns_uid_gid_maps`](<fd_sandbox.c.md#fd_sandbox_private_write_userns_uid_gid_maps>)  (Implementation)


---
### fd\_sandbox\_private\_deny\_namespaces<!-- {{#callable_declaration:fd_sandbox_private_deny_namespaces}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox_private.h#L116>)

Restricts the creation of new namespaces within the sandbox.
- **Description**: Use this function to prevent the creation of new namespaces, which is a common vector for privilege escalation in Linux environments. It should be called within the first user namespace of a nested namespace setup. This function sets the maximum allowed namespaces to zero for all types except user namespaces, where one additional namespace is permitted. This ensures that the process cannot revert the denied namespaces to allowed, as the limits are controlled by the parent user namespace, where the process has no permissions. This function is part of a defense-in-depth strategy, complementing other security measures like seccomp-bpf.
- **Inputs**: None
- **Output**: None
- **See Also**: [`fd_sandbox_private_deny_namespaces`](<fd_sandbox.c.md#fd_sandbox_private_deny_namespaces>)  (Implementation)


---
### fd\_sandbox\_private\_pivot\_root<!-- {{#callable_declaration:fd_sandbox_private_pivot_root}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox_private.h#L129>)

Changes the root filesystem to a new, empty directory.
- **Description**: Use this function to change the root filesystem visible to the process to a new directory with no contents. It creates a new mount namespace and performs a pivot operation inside it, making the old filesystem inaccessible. This is more secure than using `chroot(2)` alone, as it ensures that all mounts are unmounted and not visible in the new directory. Call this function when you need to isolate the process from the existing filesystem for security purposes.
- **Inputs**: None
- **Output**: None
- **See Also**: [`fd_sandbox_private_pivot_root`](<fd_sandbox.c.md#fd_sandbox_private_pivot_root>)  (Implementation)


---
### fd\_sandbox\_private\_set\_rlimits<!-- {{#callable_declaration:fd_sandbox_private_set_rlimits}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox_private.h#L141>)

Restrict resource limits for the calling process.
- **Description**: Use this function to set resource limits for the calling process, primarily to zero, except for specific limits provided as arguments. This is useful for sandboxing applications to prevent excessive resource usage. The function must be called with valid resource limits, and it will not modify RLIMIT_CORE if the dumpable bit is set to 1. Ensure that the process has the necessary permissions to change these limits.
- **Inputs**:
    - `rlimit_file_cnt`: Specifies the maximum number of open file descriptors. Must be a non-negative unsigned long value. The function will set RLIMIT_NOFILE to this value.
    - `rlimit_address_space`: Specifies the maximum size of the process's address space. Must be a non-negative unsigned long value. The function will set RLIMIT_AS to this value.
    - `rlimit_data`: Specifies the maximum size of the process's data segment. Must be a non-negative unsigned long value. The function will set RLIMIT_DATA to this value.
    - `dumpable`: An integer flag indicating whether the process is dumpable. If set to 1, RLIMIT_CORE is not modified. Any non-zero value is treated as true.
- **Output**: None
- **See Also**: [`fd_sandbox_private_set_rlimits`](<fd_sandbox.c.md#fd_sandbox_private_set_rlimits>)  (Implementation)


---
### fd\_sandbox\_private\_read\_cap\_last\_cap<!-- {{#callable_declaration:fd_sandbox_private_read_cap_last_cap}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox_private.h#L151>)

Read the value of cap_last_cap from the system file and return it.
- **Description**: Use this function to obtain the current value of `cap_last_cap` from the system file `/proc/sys/kernel/cap_last_cap`. This function is useful when you need to know the highest capability number recognized by the Linux kernel. It is important to note that any error encountered during the reading or parsing of the file will result in the program logging an error and exiting. Therefore, ensure that the environment is correctly set up to access this file and handle the program's exit behavior appropriately.
- **Inputs**: None
- **Output**: Returns the value of `cap_last_cap` as an unsigned long integer.
- **See Also**: [`fd_sandbox_private_read_cap_last_cap`](<fd_sandbox.c.md#fd_sandbox_private_read_cap_last_cap>)  (Implementation)


---
### fd\_sandbox\_private\_drop\_caps<!-- {{#callable_declaration:fd_sandbox_private_drop_caps}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox_private.h#L162>)

Drop all capabilities and set securebits to be maximally restrictive.
- **Description**: Use this function to remove all capabilities from the current thread, ensuring a highly restrictive security posture by setting securebits flags. This function is essential for sandboxing processes to prevent privilege escalation. It should be called with the highest capability value known to the running Linux kernel, which can be obtained from `/proc/sys/kernel/cap_last_cap`. Ensure that this function is called in a context where dropping capabilities is safe and intended, as it will affect the current thread's ability to perform privileged operations.
- **Inputs**:
    - `cap_last_cap`: The highest capability value known to the running Linux kernel, typically read from `/proc/sys/kernel/cap_last_cap`. Must be a valid unsigned long value. The function will log an error and exit if it encounters issues with setting securebits or dropping capabilities.
- **Output**: None
- **See Also**: [`fd_sandbox_private_drop_caps`](<fd_sandbox.c.md#fd_sandbox_private_drop_caps>)  (Implementation)


---
### fd\_sandbox\_private\_landlock\_restrict\_self<!-- {{#callable_declaration:fd_sandbox_private_landlock_restrict_self}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox_private.h#L184>)

Apply a landlock restriction to the current process.
- **Description**: Use this function to apply a landlock restriction to the current process, which limits filesystem operations such as writes, reads, truncates, and execution. This function is a defense-in-depth measure, complementing seccomp-bpf filters. It allows for conditional permission of `connect(2)` and `renameat(2)` syscalls based on the provided parameters. If the kernel does not support landlock, the function returns without error or exiting the program. This function should be called when you need to enforce strict access controls on filesystem and network operations.
- **Inputs**:
    - `allow_connect`: An integer that, if nonzero, allows the `connect(2)` syscall. If zero, the `connect(2)` syscall is restricted.
    - `allow_renameat`: An integer that, if nonzero, allows the `renameat(2)` syscall. If zero, the `renameat(2)` syscall is restricted.
- **Output**: None
- **See Also**: [`fd_sandbox_private_landlock_restrict_self`](<fd_sandbox.c.md#fd_sandbox_private_landlock_restrict_self>)  (Implementation)


---
### fd\_sandbox\_private\_set\_seccomp\_filter<!-- {{#callable_declaration:fd_sandbox_private_set_seccomp_filter}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox_private.h#L198>)

Install a seccomp-bpf filter to the current process.
- **Description**: Use this function to apply a seccomp-bpf filter to the current process, which restricts system calls based on a specified whitelist. This is a security measure to prevent unauthorized system calls. The `seccomp_filter` parameter must be a BPF program generated by an appropriate script, and the `no_new_privs` bit must be set before calling this function. If a system call not on the whitelist is attempted, the process will terminate with a SIGSYS signal. This function is critical for maintaining process security by limiting system call access.
- **Inputs**:
    - `seccomp_filter_cnt`: The number of entries in the seccomp filter. It must accurately reflect the length of the `seccomp_filter` array.
    - `seccomp_filter`: A pointer to an array of `struct sock_filter` that defines the seccomp-bpf filter. The caller must ensure this is a valid, non-null pointer to a properly constructed BPF program.
- **Output**: None
- **See Also**: [`fd_sandbox_private_set_seccomp_filter`](<fd_sandbox.c.md#fd_sandbox_private_set_seccomp_filter>)  (Implementation)


---
### fd\_sandbox\_private\_enter\_no\_seccomp<!-- {{#callable_declaration:fd_sandbox_private_enter_no_seccomp}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox_private.h#L208>)

Enters a sandbox environment without seccomp-bpf filtering.
- **Description**: Use this function to enter a sandbox environment with specific user and group IDs, network settings, and resource limits, while bypassing seccomp-bpf filtering. This is useful for testing purposes where syscall access is needed after entering the sandbox. Ensure that the process has the necessary capabilities to change user and group IDs. The function sets various resource limits and file descriptor checks to enhance security. It must be called with valid parameters to avoid process termination due to security checks.
- **Inputs**:
    - `desired_uid`: The user ID to set for the sandboxed process. Must be a valid user ID that the process has permission to switch to.
    - `desired_gid`: The group ID to set for the sandboxed process. Must be a valid group ID that the process has permission to switch to.
    - `keep_host_networking`: If non-zero, retains the host's network namespace. Otherwise, a new network namespace is created.
    - `allow_connect`: If non-zero, allows the connect(2) syscall within the sandbox.
    - `allow_renameat`: If non-zero, allows the renameat(2) syscall within the sandbox.
    - `keep_controlling_terminal`: If non-zero, retains the controlling terminal. Otherwise, detaches from it.
    - `dumpable`: Sets the dumpable attribute of the process, affecting core dump generation.
    - `rlimit_file_cnt`: The maximum number of file descriptors the process can open. Must be a valid limit value.
    - `rlimit_address_space`: The maximum address space size for the process. Must be a valid limit value.
    - `rlimit_data`: The maximum data segment size for the process. Must be a valid limit value.
    - `allowed_file_descriptor_cnt`: The number of allowed file descriptors. Must be between 0 and 256.
    - `allowed_file_descriptor`: An array of allowed file descriptors. Must contain exactly 'allowed_file_descriptor_cnt' entries, with no duplicates.
- **Output**: None
- **See Also**: [`fd_sandbox_private_enter_no_seccomp`](<fd_sandbox.c.md#fd_sandbox_private_enter_no_seccomp>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)