<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for managing Linux sandbox environments, including user namespace handling, capability dropping, and seccomp filtering.

# Purpose
The code is a C module designed to manage and enforce sandboxing in a Linux environment. It provides functions to manipulate user and group IDs, manage file descriptors, and enforce security policies using Linux namespaces, capabilities, and seccomp filters. The module includes functions to switch user and group IDs, clear environment variables, check and manage file descriptors, and set resource limits. It also provides mechanisms to restrict the creation of new namespaces, pivot the root filesystem, and apply Landlock and seccomp security policies.

The module is intended to be used in environments where security and isolation are critical. It uses Linux-specific features such as `unshare`, `prctl`, and `syscall` to manipulate process capabilities and namespaces. The code checks for specific conditions and errors, logging them using the `FD_LOG_ERR` macro. The module is designed to be integrated into larger systems that require sandboxing capabilities, providing a set of functions that can be called to configure and enforce security policies on processes.
# Imports and Dependencies

---
- `fd_sandbox_private.h`
- `../cstr/fd_cstr.h`
- `../log/fd_log.h`
- `fcntl.h`
- `stdlib.h`
- `errno.h`
- `unistd.h`
- `sched.h`
- `dirent.h`
- `sys/stat.h`
- `sys/wait.h`
- `sys/prctl.h`
- `sys/mount.h`
- `sys/random.h`
- `sys/syscall.h`
- `sys/resource.h`
- `linux/keyctl.h`
- `linux/seccomp.h`
- `linux/securebits.h`
- `linux/capability.h`


# Global Variables

---
### environ
- **Type**: ``char **``
- **Description**: Points to an array of strings representing the environment variables for the current process. Each string in the array is in the format 'KEY=VALUE'. The array is terminated by a NULL pointer.
- **Use**: Used to access and manipulate the environment variables of the process.


# Data Structures

---
### rlimit\_setting
- **Type**: ``struct``
- **Members**:
    - ``resource``: Specifies the resource type for which the limit is set, using `__rlimit_resource_t` for glibc or `int` for non-glibc systems.
    - ``limit``: Defines the maximum allowable value for the specified resource.
- **Description**: Defines a structure to represent resource limits, with a conditional type for the `resource` field based on the presence of glibc, and a `limit` field to specify the maximum value for the resource.


---
### landlock\_ruleset\_attr
- **Type**: ``struct``
- **Members**:
    - ``handled_access_fs``: Specifies the file system access rights that the ruleset can handle.
    - ``handled_access_net``: Specifies the network access rights that the ruleset can handle.
- **Description**: Defines attributes for a Landlock ruleset, which is used to specify the access rights that can be managed by the Landlock security module. The `handled_access_fs` field indicates the file system operations that the ruleset can control, while the `handled_access_net` field indicates the network operations that can be controlled. This structure is part of the Landlock security framework, which provides a way to restrict the actions of a process based on a set of rules.


# Functions

---
### check\_unshare\_eacces\_main<!-- {{#callable:check_unshare_eacces_main}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox.c#L47>)

Attempts to unshare the user namespace and handle potential `EACCES` errors during the process.
- **Inputs**:
    - `_arg`: A pointer to an unsigned long integer that encodes the desired user ID (UID) and group ID (GID) for the operation.
- **Logic and Control Flow**:
    - Convert `_arg` to an unsigned long integer `arg` and extract `desired_uid` and `desired_gid` from it.
    - Call [`fd_sandbox_private_switch_uid_gid`](<#fd_sandbox_private_switch_uid_gid>) with `desired_uid` and `desired_gid` to switch the UID and GID.
    - Attempt to unshare the user namespace using `unshare(CLONE_NEWUSER)`.
    - If `unshare` fails with `EACCES`, return 255.
    - If `unshare` fails for other reasons, log an error and terminate.
    - Attempt to open `/proc/self/setgroups` with write permissions.
    - If opening `/proc/self/setgroups` fails with `EACCES`, return 255.
    - If opening `/proc/self/setgroups` fails for other reasons, log an error and terminate.
    - Return 0 if all operations succeed without encountering `EACCES`.
- **Output**: Returns 255 if `EACCES` is encountered during `unshare` or opening `/proc/self/setgroups`, otherwise returns 0.
- **Functions Called**:
    - [`fd_sandbox_private_switch_uid_gid`](<#fd_sandbox_private_switch_uid_gid>)


---
### fd\_sandbox\_requires\_cap\_sys\_admin<!-- {{#callable:fd_sandbox_requires_cap_sys_admin}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox.c#L63>)

Determines if creating a user namespace requires `CAP_SYS_ADMIN` capability based on system restrictions.
- **Inputs**:
    - `desired_uid`: The desired user ID for the namespace.
    - `desired_gid`: The desired group ID for the namespace.
- **Logic and Control Flow**:
    - Opens `/proc/sys/kernel/unprivileged_userns_clone` to check if unprivileged user namespaces are restricted.
    - If the file is not found, it assumes no restriction; otherwise, it reads the file to determine the restriction status.
    - If `unprivileged_userns_clone` is 0, it returns 1, indicating `CAP_SYS_ADMIN` is required.
    - If the file is found and indicates no restriction, it proceeds to attempt creating a user namespace using `clone` with a new stack.
    - The `clone` function calls `check_unshare_eacces_main` to attempt `unshare(CLONE_NEWUSER)` and checks for `EACCES` errors.
    - If `EACCES` is encountered, it returns 1, indicating `CAP_SYS_ADMIN` is required.
    - If no errors are encountered, it returns 0, indicating `CAP_SYS_ADMIN` is not required.
- **Output**: Returns 1 if `CAP_SYS_ADMIN` is required to create a user namespace, otherwise returns 0.


---
### fd\_sandbox\_private\_explicit\_clear\_environment\_variables<!-- {{#callable:FD_FN_SENSITIVE::fd_sandbox_private_explicit_clear_environment_variables}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox.c#L122>)

Clears all environment variables by overwriting them with zeros and then removing them from the environment.
- **Inputs**: None
- **Logic and Control Flow**:
    - Checks if the `environ` variable is not null; if it is null, the function returns immediately.
    - Iterates over each environment variable in `environ`.
    - For each environment variable, calculates its length using `strlen`.
    - Overwrites the environment variable with zeros using `explicit_bzero`.
    - Calls `clearenv` to remove all environment variables from the environment.
    - If `clearenv` fails, logs an error message using `FD_LOG_ERR`.
- **Output**: No output is returned from this function.


---
### fd\_sandbox\_private\_check\_exact\_file\_descriptors<!-- {{#callable:fd_sandbox_private_check_exact_file_descriptors}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox.c#L134>)

Validates that the current process has exactly the specified file descriptors open, without duplicates or invalid entries.
- **Inputs**:
    - `allowed_file_descriptor_cnt`: The number of allowed file descriptors.
    - `allowed_file_descriptor`: An array of allowed file descriptors.
- **Logic and Control Flow**:
    - Check if `allowed_file_descriptor_cnt` is greater than 256 and log an error if true.
    - Initialize an array `seen_fds` to track which file descriptors have been seen.
    - Iterate over `allowed_file_descriptor` to check for invalid file descriptors (negative or equal to `INT_MAX`) and log an error if found.
    - Check for duplicate file descriptors in `allowed_file_descriptor` and log an error if any are found.
    - Open the directory `/proc/self/fd` to read the current file descriptors of the process.
    - Use `getdents64` to read directory entries from `/proc/self/fd` into a buffer.
    - Iterate over the directory entries, skipping `.` and `..`, and convert entry names to file descriptor numbers.
    - Check if each file descriptor is in `allowed_file_descriptor`; if not, log an error with the path of the unexpected file descriptor.
    - Mark seen file descriptors in `seen_fds` and log an error if a file descriptor is seen twice.
    - After processing all entries, check if all `allowed_file_descriptor` entries were seen; log an error if any are missing.
    - Close the directory file descriptor `dirfd`.
- **Output**: No return value; logs errors if any discrepancies are found.


---
### fd\_sandbox\_private\_switch\_uid\_gid<!-- {{#callable:fd_sandbox_private_switch_uid_gid}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox.c#L224>)

Switches the user ID (UID) and group ID (GID) of the current process to the specified values, ensuring compatibility between development and production environments.
- **Inputs**:
    - `desired_uid`: The target user ID to switch to.
    - `desired_gid`: The target group ID to switch to.
- **Logic and Control Flow**:
    - Initialize a variable `changed` to track if any changes occur.
    - Retrieve the current real, effective, and saved group IDs using `getresgid`.
    - If the current group IDs do not match the `desired_gid`, use a direct syscall to `setresgid` to change them and set `changed` to 1.
    - Retrieve the current real, effective, and saved user IDs using `getresuid`.
    - If the current user IDs do not match the `desired_uid`, use a direct syscall to `setresuid` to change them and set `changed` to 1.
    - If any changes were made, use `prctl` to set the dumpable attribute to 1, allowing debugging and setting UID/GID maps in the user namespace.
- **Output**: No return value; the function modifies the process's UID and GID.


---
### fd\_sandbox\_private\_write\_userns\_uid\_gid\_maps<!-- {{#callable:fd_sandbox_private_write_userns_uid_gid_maps}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox.c#L277>)

Writes user and group ID mappings to the user namespace for the current process.
- **Inputs**:
    - `uid_in_parent`: The user ID in the parent namespace to map to the user namespace.
    - `gid_in_parent`: The group ID in the parent namespace to map to the user namespace.
- **Logic and Control Flow**:
    - Opens the `/proc/self/setgroups` file in write-only mode to deny group changes.
    - Writes 'deny' to the `setgroups` file to prevent group changes in the user namespace.
    - Closes the `setgroups` file descriptor.
    - Defines paths for `uid_map` and `gid_map` files in the `/proc/self` directory.
    - Iterates over the `uid_map` and `gid_map` paths to open each file in write-only mode.
    - Formats a mapping line for each ID and writes it to the corresponding map file.
    - Checks if the write operation was successful and writes the entire data.
    - Closes each map file descriptor after writing.
- **Output**: No return value; the function performs operations on the file system to set up user namespace mappings.


---
### fd\_sandbox\_private\_deny\_namespaces<!-- {{#callable:fd_sandbox_private_deny_namespaces}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox.c#L311>)

Restricts the creation of various Linux namespaces by setting specific limits in the system control files.
- **Inputs**: None
- **Logic and Control Flow**:
    - Defines two static arrays, `SYSCTLS` and `VALUES`, which contain paths to system control files and their corresponding values to be written, respectively.
    - Iterates over each entry in the `SYSCTLS` array.
    - Opens each system control file in write-only mode using `open`.
    - Checks if the file descriptor is valid; if not, logs an error using `FD_LOG_ERR`.
    - Writes the corresponding value from the `VALUES` array to the opened file using `write`.
    - Checks if the write operation was successful; if not, logs an error using `FD_LOG_ERR`.
    - Closes the file descriptor using `close` and checks for errors, logging any issues with `FD_LOG_ERR`.
- **Output**: No output is returned; the function performs system-level operations and logs errors if they occur.


---
### fd\_sandbox\_private\_pivot\_root<!-- {{#callable:fd_sandbox_private_pivot_root}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox.c#L344>)

Jails the process into a new isolated filesystem namespace by creating a temporary directory, setting it as the new root, and unmounting the old root.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `unshare(CLONE_NEWNS)` to create a new mount namespace.
    - Generates a random number using `getrandom()` to create a unique temporary directory path.
    - Creates the temporary directory with `mkdir()` and sets its permissions to 0700.
    - Remounts the root filesystem as a slave to prevent propagation of mount events using `mount(NULL, "/", NULL, MS_SLAVE | MS_REC, NULL)`.
    - Binds the temporary directory to itself with `mount(new_root_path, new_root_path, NULL, MS_BIND | MS_REC, NULL)` to prepare it for pivoting.
    - Changes the current working directory to the new root path using `chdir(new_root_path)`.
    - Calls `syscall(SYS_pivot_root, ".", ".")` to pivot the root filesystem to the new directory.
    - Unmounts the old root with `umount2(".", MNT_DETACH)` to detach it from the filesystem tree.
    - Changes the current working directory to the new root using `chdir("/")`.
- **Output**: No return value; the function modifies the process's filesystem namespace.


---
### fd\_sandbox\_private\_set\_rlimits<!-- {{#callable:fd_sandbox_private_set_rlimits}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox.c#L386>)

Sets resource limits for a process based on specified parameters and handles errors if setting limits fails.
- **Inputs**:
    - ``rlimit_file_cnt``: The maximum number of open file descriptors allowed.
    - ``rlimit_address_space``: The maximum size of the process's address space.
    - ``rlimit_data``: The maximum size of the process's data segment.
    - ``dumpable``: A flag indicating whether the process can produce core dumps.
- **Logic and Control Flow**:
    - Defines an array `rlimits` with resource limits to set, including `RLIMIT_NOFILE`, `RLIMIT_NICE`, `RLIMIT_AS`, `RLIMIT_CORE`, `RLIMIT_DATA`, and others, with specific limits for each.
    - Iterates over each resource limit in the `rlimits` array.
    - Checks if `dumpable` is true and the resource is `RLIMIT_CORE`; if so, skips setting this limit.
    - Creates a `struct rlimit` with current and maximum limits set to the specified limit for each resource.
    - Calls `setrlimit` for each resource to apply the limit.
    - Logs an error and exits if `setrlimit` fails for any resource.
- **Output**: No return value; the function sets resource limits and logs errors if any occur.


---
### fd\_sandbox\_private\_drop\_caps<!-- {{#callable:fd_sandbox_private_drop_caps}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox.c#L435>)

Drops all capabilities from the process and sets secure bits to prevent regaining them.
- **Inputs**:
    - `cap_last_cap`: The highest capability index to drop, inclusive.
- **Logic and Control Flow**:
    - Sets secure bits using `prctl` to lock capabilities and prevent setuid fixups.
    - Iterates over all capabilities from 0 to `cap_last_cap` and drops each using `prctl` with `PR_CAPBSET_DROP`.
    - Initializes capability header and data structures to clear all capabilities using `syscall` with `SYS_capset`.
    - Clears all ambient capabilities using `prctl` with `PR_CAP_AMBIENT_CLEAR_ALL`.
- **Output**: No return value; the function modifies the process's capabilities and secure bits.


---
### fd\_sandbox\_private\_landlock\_restrict\_self<!-- {{#callable:fd_sandbox_private_landlock_restrict_self}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox.c#L480>)

Restricts the current process using Landlock rules based on the provided permissions for network connections and file renaming.
- **Inputs**:
    - `allow_connect`: A flag to allow or disallow TCP network connections.
    - `allow_renameat`: A flag to allow or disallow file renaming operations.
- **Logic and Control Flow**:
    - Initialize a `landlock_ruleset_attr` structure with default filesystem and network access rights.
    - Check if `allow_connect` is false; if so, add `LANDLOCK_ACCESS_NET_CONNECT_TCP` to the network access rights.
    - Check if `allow_renameat` is false; if so, add `LANDLOCK_ACCESS_FS_REMOVE_FILE` and `LANDLOCK_ACCESS_FS_MAKE_REG` to the filesystem access rights.
    - Call `syscall` to create a Landlock ruleset and handle errors if the syscall is not supported or fails.
    - Adjust the access rights based on the ABI version returned by the syscall, removing unsupported rights for older ABI versions.
    - Create a new Landlock ruleset with the adjusted access rights and handle errors if the syscall fails.
    - Apply the Landlock ruleset to the current process using `syscall` and handle errors if the syscall fails.
    - Close the file descriptor for the Landlock ruleset and handle errors if the close operation fails.
- **Output**: No return value; the function applies restrictions to the current process.


---
### fd\_sandbox\_private\_set\_seccomp\_filter<!-- {{#callable:fd_sandbox_private_set_seccomp_filter}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox.c#L543>)

Sets a seccomp filter for the current process using the provided filter program.
- **Inputs**:
    - `seccomp_filter_cnt`: The number of filter instructions in the seccomp filter program.
    - `seccomp_filter`: A pointer to an array of `sock_filter` structures that define the seccomp filter program.
- **Logic and Control Flow**:
    - Initializes a `sock_fprog` structure with the provided `seccomp_filter_cnt` and `seccomp_filter`.
    - Calls the `syscall` function with `SYS_seccomp` to set the seccomp filter mode to `SECCOMP_SET_MODE_FILTER` using the initialized `sock_fprog` structure.
    - If the syscall fails, logs an error message with the error number and description.
- **Output**: No return value; the function sets the seccomp filter for the process or logs an error if it fails.


---
### fd\_sandbox\_private\_read\_cap\_last\_cap<!-- {{#callable:fd_sandbox_private_read_cap_last_cap}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox.c#L554>)

Reads the last valid capability index from the Linux kernel's capability system.
- **Inputs**: None
- **Logic and Control Flow**:
    - Opens the file `/proc/sys/kernel/cap_last_cap` in read-only mode.
    - Checks if the file descriptor is valid; if not, logs an error and exits.
    - Reads up to 16 bytes from the file into a buffer `buf`.
    - Checks if the read operation was successful and if the data is not truncated; logs an error and exits if any check fails.
    - Converts the string in `buf` to an unsigned long integer using `strtoul`.
    - Checks if the conversion was successful by verifying the end character is a newline; logs an error and exits if not.
    - Closes the file descriptor and checks for errors; logs an error and exits if closing fails.
    - Validates that the capability index is within a valid range (greater than 0 and less than 64); logs an error and exits if not.
- **Output**: Returns the last valid capability index as an unsigned long integer.


---
### fd\_sandbox\_private\_enter\_no\_seccomp<!-- {{#callable:fd_sandbox_private_enter_no_seccomp}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox.c#L573>)

Configures a sandbox environment by setting user and group IDs, managing namespaces, restricting file and network access, and setting resource limits without using seccomp.
- **Inputs**:
    - `desired_uid`: The user ID to switch to within the sandbox.
    - `desired_gid`: The group ID to switch to within the sandbox.
    - `keep_host_networking`: Flag to determine if host networking should be retained.
    - `allow_connect`: Flag to allow network connections.
    - `allow_renameat`: Flag to allow renaming of files.
    - `keep_controlling_terminal`: Flag to determine if the controlling terminal should be kept.
    - `dumpable`: Flag to set the process dumpable state.
    - `rlimit_file_cnt`: The maximum number of open file descriptors.
    - `rlimit_address_space`: The maximum size of the process's address space.
    - `rlimit_data`: The maximum size of the process's data segment.
    - `allowed_file_descriptor_cnt`: The number of allowed file descriptors.
    - `allowed_file_descriptor`: Array of allowed file descriptors.
- **Logic and Control Flow**:
    - Reads the highest capability index from `/proc` using [`fd_sandbox_private_read_cap_last_cap`](<#fd_sandbox_private_read_cap_last_cap>).
    - Clears environment variables using [`fd_sandbox_private_explicit_clear_environment_variables`](<#fd_fn_sensitivefd_sandbox_private_explicit_clear_environment_variables>).
    - Checks allowed file descriptors with [`fd_sandbox_private_check_exact_file_descriptors`](<#fd_sandbox_private_check_exact_file_descriptors>).
    - Replaces the session keyring with a new anonymous one using `syscall(SYS_keyctl)`.
    - Detaches from the controlling terminal if `keep_controlling_terminal` is false using `setsid()`.
    - Checks if CAP_SYS_ADMIN is required for user namespaces using [`fd_sandbox_requires_cap_sys_admin`](<#fd_sandbox_requires_cap_sys_admin>).
    - Switches user and group IDs using [`fd_sandbox_private_switch_uid_gid`](<#fd_sandbox_private_switch_uid_gid>).
    - Checks and logs if there are multiple supplementary groups using `getgroups()`.
    - Raises CAP_SYS_ADMIN if required using `syscall(SYS_capget)` and `syscall(SYS_capset)`.
    - Unshares the user namespace and writes UID/GID maps using [`fd_sandbox_private_write_userns_uid_gid_maps`](<#fd_sandbox_private_write_userns_uid_gid_maps>).
    - Unshares other namespaces based on flags and denies further namespace creation using [`fd_sandbox_private_deny_namespaces`](<#fd_sandbox_private_deny_namespaces>).
    - Clears PR_SET_KEEPCAPS and sets PR_SET_DUMPABLE using `prctl()`.
    - Remounts the filesystem root using [`fd_sandbox_private_pivot_root`](<#fd_sandbox_private_pivot_root>).
    - Applies landlock restrictions using [`fd_sandbox_private_landlock_restrict_self`](<#fd_sandbox_private_landlock_restrict_self>).
    - Sets resource limits using [`fd_sandbox_private_set_rlimits`](<#fd_sandbox_private_set_rlimits>).
    - Drops all capabilities in the new user namespace using [`fd_sandbox_private_drop_caps`](<#fd_sandbox_private_drop_caps>).
    - Sets PR_SET_NO_NEW_PRIVS using `prctl()`.
- **Output**: No return value; the function configures the process environment.
- **Functions Called**:
    - [`fd_sandbox_private_read_cap_last_cap`](<#fd_sandbox_private_read_cap_last_cap>)
    - [`FD_FN_SENSITIVE::fd_sandbox_private_explicit_clear_environment_variables`](<#fd_fn_sensitivefd_sandbox_private_explicit_clear_environment_variables>)
    - [`fd_sandbox_private_check_exact_file_descriptors`](<#fd_sandbox_private_check_exact_file_descriptors>)
    - [`fd_sandbox_requires_cap_sys_admin`](<#fd_sandbox_requires_cap_sys_admin>)
    - [`fd_sandbox_private_switch_uid_gid`](<#fd_sandbox_private_switch_uid_gid>)
    - [`fd_sandbox_private_write_userns_uid_gid_maps`](<#fd_sandbox_private_write_userns_uid_gid_maps>)
    - [`fd_sandbox_private_deny_namespaces`](<#fd_sandbox_private_deny_namespaces>)
    - [`fd_sandbox_private_pivot_root`](<#fd_sandbox_private_pivot_root>)
    - [`fd_sandbox_private_landlock_restrict_self`](<#fd_sandbox_private_landlock_restrict_self>)
    - [`fd_sandbox_private_set_rlimits`](<#fd_sandbox_private_set_rlimits>)
    - [`fd_sandbox_private_drop_caps`](<#fd_sandbox_private_drop_caps>)


---
### fd\_sandbox\_enter<!-- {{#callable:fd_sandbox_enter}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox.c#L685>)

Enters a sandbox environment with specified user and group IDs, network and file descriptor settings, and applies a seccomp filter for system call restrictions.
- **Inputs**:
    - `desired_uid`: The user ID to switch to within the sandbox.
    - `desired_gid`: The group ID to switch to within the sandbox.
    - `keep_host_networking`: Flag to determine if host networking should be retained.
    - `allow_connect`: Flag to allow or disallow network connections.
    - `allow_renameat`: Flag to allow or disallow the use of the `renameat` system call.
    - `keep_controlling_terminal`: Flag to determine if the controlling terminal should be retained.
    - `dumpable`: Flag to set the process dumpable state, affecting core dump generation.
    - `rlimit_file_cnt`: The maximum number of open file descriptors allowed.
    - `rlimit_address_space`: The maximum size of the process's address space.
    - `rlimit_data`: The maximum size of the process's data segment.
    - `allowed_file_descriptor_cnt`: The number of file descriptors that are allowed to remain open.
    - `allowed_file_descriptor`: Array of file descriptors that are allowed to remain open.
    - `seccomp_filter_cnt`: The number of entries in the seccomp filter.
    - `seccomp_filter`: The seccomp filter to apply for system call restrictions.
- **Logic and Control Flow**:
    - Checks if `seccomp_filter_cnt` exceeds `USHORT_MAX` and logs an error if true.
    - Calls [`fd_sandbox_private_enter_no_seccomp`](<#fd_sandbox_private_enter_no_seccomp>) to set up the sandbox environment without seccomp filtering.
    - Logs the enabling of the full sandbox before applying the seccomp filter.
    - Applies the seccomp filter using [`fd_sandbox_private_set_seccomp_filter`](<#fd_sandbox_private_set_seccomp_filter>).
- **Output**: No return value; the function sets up a sandbox environment with specified restrictions.
- **Functions Called**:
    - [`fd_sandbox_private_enter_no_seccomp`](<#fd_sandbox_private_enter_no_seccomp>)
    - [`fd_sandbox_private_set_seccomp_filter`](<#fd_sandbox_private_set_seccomp_filter>)


---
### fd\_sandbox\_switch\_uid\_gid<!-- {{#callable:fd_sandbox_switch_uid_gid}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox.c#L721>)

Switches the user ID and group ID of the current process to the specified values and logs that the sandbox is disabled.
- **Inputs**:
    - `desired_uid`: The user ID to switch to.
    - `desired_gid`: The group ID to switch to.
- **Logic and Control Flow**:
    - Calls [`fd_sandbox_private_switch_uid_gid`](<#fd_sandbox_private_switch_uid_gid>) with `desired_uid` and `desired_gid` to change the user and group IDs.
    - Logs the message 'sandbox: sandbox disabled' using `FD_LOG_INFO`.
- **Output**: No return value.
- **Functions Called**:
    - [`fd_sandbox_private_switch_uid_gid`](<#fd_sandbox_private_switch_uid_gid>)


---
### fd\_sandbox\_getpid<!-- {{#callable:fd_sandbox_getpid}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox.c#L728>)

Retrieves the process ID (PID) of the current process from the `/proc/self` symbolic link and validates it.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initializes a character array `pid` to store the PID as a string, with a size sufficient for `INT_MAX` and a null terminator.
    - Uses `readlink` to read the symbolic link `/proc/self` into the `pid` array, storing the number of bytes read in `count`.
    - Checks if `readlink` failed by comparing `count` to `-1L` and logs an error if it did.
    - Checks if the `count` is greater than or equal to the size of `pid`, indicating a truncated PID, and logs an error if true.
    - Converts the string in `pid` to an unsigned long using `strtoul`, storing the result in `result` and the end pointer in `endptr`.
    - Validates that the conversion consumed the entire string and that `result` does not exceed `INT_MAX`, logging an error if either condition is false.
    - Returns the validated PID as an unsigned long.
- **Output**: Returns the process ID (PID) of the current process as an unsigned long.


---
### fd\_sandbox\_gettid<!-- {{#callable:fd_sandbox_gettid}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox.c#L744>)

Retrieves the thread ID (TID) of the current thread from the `/proc/thread-self` symbolic link.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize a character array `tid` with a size of 27 to store the thread ID path.
    - Use `readlink` to read the symbolic link `/proc/thread-self` into `tid` and store the number of bytes read in `count`.
    - If `count` is less than 0, log an error indicating `readlink` failed.
    - If `count` is greater than or equal to the size of `tid`, log an error indicating the TID is truncated.
    - Find the first '/' character in `tid` and store the pointer in `taskstr`.
    - If `taskstr` is NULL, log an error indicating an invalid TID.
    - Increment `taskstr` to point to the character after the first '/'.
    - Find the next '/' character in `taskstr` and store the pointer in `task`.
    - If `task` is NULL, log an error indicating an invalid TID.
    - Convert the substring starting from `task + 1` to an unsigned long using `strtoul`, storing the result in `result`.
    - If the conversion is not successful or `result` is greater than `INT_MAX`, log an error indicating an invalid TID.
    - Return `result` as the thread ID.
- **Output**: Returns the thread ID as an unsigned long.


# Function Declarations (Public API)

---
### fd\_sandbox\_private\_switch\_uid\_gid<!-- {{#callable_declaration:fd_sandbox_private_switch_uid_gid}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox.c#L43>)

Switches the process's user and group IDs to the specified values.
- **Description**: Use this function to change the user ID (UID) and group ID (GID) of the current process to the specified values. This is useful in development environments where processes need to run with specific privileges. The function directly invokes system calls to change the UID and GID, bypassing the usual glibc behavior that affects all threads in a process. This function should be called with care, as it affects the process's ability to access resources and perform actions that require specific user or group permissions.
- **Inputs**:
    - `desired_uid`: The target user ID to switch to. Must be a valid user ID on the system. Invalid values will cause the function to log an error and terminate the process.
    - `desired_gid`: The target group ID to switch to. Must be a valid group ID on the system. Invalid values will cause the function to log an error and terminate the process.
- **Output**: None
- **See Also**: [`fd_sandbox_private_switch_uid_gid`](<#fd_sandbox_private_switch_uid_gid>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)