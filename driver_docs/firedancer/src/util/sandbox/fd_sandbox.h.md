<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for managing process sandboxing on Linux, including entering a sandbox and switching user IDs.

# Purpose
The code defines a C header file that provides functions for managing a sandboxed execution environment on Linux systems. The primary purpose of this file is to facilitate the creation and management of a secure, isolated environment where a process has limited access to system resources and capabilities. The file includes functions such as [`fd_sandbox_requires_cap_sys_admin`](<#fd_sandbox_requires_cap_sys_admin>), [`fd_sandbox_enter`](<#fd_sandbox_enter>), [`fd_sandbox_switch_uid_gid`](<#fd_sandbox_switch_uid_gid>), [`fd_sandbox_getpid`](<#fd_sandbox_getpid>), and [`fd_sandbox_gettid`](<#fd_sandbox_gettid>). These functions are designed to check for necessary capabilities, enter a sandboxed environment, switch user and group IDs, and retrieve the true process and thread IDs from the root PID namespace, respectively.

The [`fd_sandbox_enter`](<#fd_sandbox_enter>) function is particularly comprehensive, detailing a series of steps to establish a sandbox, including clearing environment variables, managing file descriptors, and setting up user namespaces. It also involves configuring resource limits and applying security measures such as seccomp-bpf filters and landlock restrictions. The file is intended to be included in other C source files, providing a public API for sandbox management. It is specifically designed for Linux environments, as indicated by the conditional compilation directive `#if defined(__linux__)`.
# Imports and Dependencies

---
- `../fd_util_base.h`
- `linux/filter.h`


# Function Declarations (Public API)

---
### fd\_sandbox\_requires\_cap\_sys\_admin<!-- {{#callable_declaration:fd_sandbox_requires_cap_sys_admin}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox.h#L10>)

Checks if CAP_SYS_ADMIN is required to establish a sandbox.
- **Description**: Use this function to determine if the current environment requires the CAP_SYS_ADMIN capability to fully establish a sandbox. This is necessary on certain Linux distributions that restrict unprivileged user namespaces, such as some versions of Ubuntu. The function checks system configurations and attempts to create a user namespace to identify if CAP_SYS_ADMIN is needed. It should be called before attempting to establish a sandbox to ensure the necessary capabilities are available.
- **Inputs**:
    - `desired_uid`: The user ID that the process will switch to when entering the sandbox. Must be a valid user ID.
    - `desired_gid`: The group ID that the process will switch to when entering the sandbox. Must be a valid group ID.
- **Output**: Returns 1 if CAP_SYS_ADMIN is required, otherwise returns 0.
- **See Also**: [`fd_sandbox_requires_cap_sys_admin`](<fd_sandbox.c.md#fd_sandbox_requires_cap_sys_admin>)  (Implementation)


---
### fd\_sandbox\_enter<!-- {{#callable_declaration:fd_sandbox_enter}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox.h#L144>)

Enters a fully sandboxed execution environment.
- **Description**: Use this function to restrict a process's access to the system by entering a sandboxed environment. This function must be called when the process is single-threaded, as it will terminate the program on any error encountered during sandboxing. It may require certain capabilities, such as CAP_SETGID, CAP_SETUID, and CAP_SYS_ADMIN, depending on the system configuration and the desired user and group IDs. The function performs various operations, including clearing environment variables, checking open file descriptors, and setting resource limits. It also installs a seccomp-bpf filter to restrict system calls. Ensure the process is in its own PID namespace before calling this function to prevent interactions with other processes.
- **Inputs**:
    - `desired_uid`: User ID to switch the process to inside the sandbox. Must be a valid user ID.
    - `desired_gid`: Group ID to switch the process to inside the sandbox. Must be a valid group ID.
    - `keep_host_networking`: Set to non-zero to retain the host networking namespace; otherwise, it will be unshared.
    - `allow_connect`: Set to non-zero to allow the connect(2) syscall via landlock.
    - `allow_renameat`: Set to non-zero to allow the renameat(2) syscall via landlock.
    - `keep_controlling_terminal`: Set to non-zero to retain the controlling terminal session; otherwise, the process will disconnect.
    - `dumpable`: Set to non-zero to keep the process dumpable; otherwise, it will be cleared.
    - `rlimit_file_cnt`: Maximum number of open files allowed, used to set RLIMIT_NOFILE.
    - `rlimit_address_space`: Maximum address space size allowed, used to set RLIMIT_AS.
    - `rlimit_data`: Maximum data segment size allowed, used to set RLIMIT_DATA.
    - `allowed_file_descriptor_cnt`: Number of entries in the `allowed_file_descriptor` array. Must match the actual number of file descriptors provided.
    - `allowed_file_descriptor`: Array of allowed file descriptors. Must not be null and must contain valid file descriptors.
    - `seccomp_filter_cnt`: Number of entries in the `seccomp_filter` array. Must not exceed USHORT_MAX.
    - `seccomp_filter`: Array of BPF instructions for the seccomp-bpf filter. Must not be null and should be generated from a policy file.
- **Output**: None
- **See Also**: [`fd_sandbox_enter`](<fd_sandbox.c.md#fd_sandbox_enter>)  (Implementation)


---
### fd\_sandbox\_switch\_uid\_gid<!-- {{#callable_declaration:fd_sandbox_switch_uid_gid}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox.h#L178>)

Switches the calling thread's user and group IDs.
- **Description**: Use this function to change the effective, real, and saved-set user ID and group ID of the calling thread to the specified values. This function is suitable for use in multi-threaded processes, unlike `fd_sandbox_enter`, as it only affects the calling thread. It may require `CAP_SETUID` and `CAP_SETGID` capabilities if the current IDs differ from the desired ones. The function restores the dumpable bit to true after switching IDs, which the Linux kernel clears as a security measure when IDs are changed.
- **Inputs**:
    - `desired_uid`: The user ID to switch the calling thread to. Must be a valid user ID. Requires `CAP_SETUID` if the current user ID is different.
    - `desired_gid`: The group ID to switch the calling thread to. Must be a valid group ID. Requires `CAP_SETGID` if the current group ID is different.
- **Output**: None
- **See Also**: [`fd_sandbox_switch_uid_gid`](<fd_sandbox.c.md#fd_sandbox_switch_uid_gid>)  (Implementation)


---
### fd\_sandbox\_getpid<!-- {{#callable_declaration:fd_sandbox_getpid}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox.h#L198>)

Returns the true PID of the current process in the root PID namespace.
- **Description**: Use this function to obtain the actual process ID as seen in the root PID namespace, which is necessary for operations like sending signals with the correct PID. It is important to call this function after entering a PID namespace but before entering a sandbox, as it cannot be called from within the sandbox due to likely restrictions from the seccomp filter. The function will terminate the process with an error if it cannot read the PID or if the PID is malformed.
- **Inputs**: None
- **Output**: The function returns the true PID of the current process as an unsigned long integer.
- **See Also**: [`fd_sandbox_getpid`](<fd_sandbox.c.md#fd_sandbox_getpid>)  (Implementation)


---
### fd\_sandbox\_gettid<!-- {{#callable_declaration:fd_sandbox_gettid}} -->
[View Source →](<../../../../../src/util/sandbox/fd_sandbox.h#L216>)

Returns the true TID of the current process in the root PID namespace.
- **Description**: Use this function to obtain the true thread ID (TID) of the current process as it appears in the root PID namespace, which is necessary when the process is inside a PID namespace and the TID returned by `gettid(2)` is renumbered. This function must be called after entering a PID namespace but before entering a sandbox, as it cannot be called from within the sandbox due to likely restrictions from the seccomp filter. The function will terminate the calling process with an error if it cannot read or if it encounters a malformed TID from `/proc/thread-self`.
- **Inputs**: None
- **Output**: Returns the true TID of the current process as an unsigned long integer.
- **See Also**: [`fd_sandbox_gettid`](<fd_sandbox.c.md#fd_sandbox_gettid>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)