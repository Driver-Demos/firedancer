<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for treap data structure operations, including insertion, deletion, iteration, and merging.

# Purpose
The code is a C program designed to test the functionality and integrity of data structures known as treaps and lreaps, which are types of binary search trees with additional properties. The program includes definitions for elements (`ele_t`) that are used within these data structures, and it utilizes macros to configure and include external C files (`fd_pool.c` and `fd_treap.c`) that provide the implementation of pools and treaps. The code defines several functions to test various operations on these data structures, such as insertion, removal, iteration, and merging, ensuring that they maintain their properties and perform correctly under different conditions.

The program is structured to run a series of tests, including forward and reverse iteration tests, merge tests, and duplicate handling tests. It uses a random number generator to simulate different scenarios and validate the behavior of the treaps and lreaps. The main function initializes the environment, sets up the test parameters, and executes the tests, logging the results. The code also includes conditional compilation for hosted environments and uses assertions to verify the correctness of operations. The program is intended to be executed as a standalone application, as indicated by the presence of a [`main`](<#main>) function, and it does not define public APIs or external interfaces for use by other programs.
# Imports and Dependencies

---
- `../fd_util.h`
- `sys/types.h`
- `sys/wait.h`
- `unistd.h`
- `fd_pool.c`
- `fd_treap.c`
- `stdio.h`


# Global Variables

---
### scratch
- **Type**: ``uchar[]``
- **Description**: An array of unsigned characters with a size defined by `SCRATCH_FOOTPRINT`, which is 2048 bytes. The array is aligned in memory according to `SCRATCH_ALIGN`, which is 128 bytes.
- **Use**: Used as a memory pool for operations involving data structures like `treap` and `lreap`.


---
### ele\_max
- **Type**: `ulong`
- **Description**: Represents the maximum number of elements that can be managed in certain data structures, such as pools and treaps, within the program.
- **Use**: Used to define the upper limit of elements for operations involving data structures like `treap` and `lreap`.


---
### pool
- **Type**: `ele_t *`
- **Description**: `pool` is a pointer to an array of `ele_t` structures, which are elements in a pool data structure. The `ele_t` structure contains several fields, including indices for parent, left, right, priority, previous, and next elements, as well as a value field.
- **Use**: `pool` is used to manage and access elements in a pool, allowing operations such as acquiring and releasing indices, and inserting or removing elements in data structures like treaps and lreaps.


---
### a
- **Type**: `lreap_t *`
- **Description**: A pointer to a `lreap_t` data structure, which is a type of treap (tree heap) that supports additional operations for linked list-like iteration. The `lreap_t` structure is used to manage elements in a priority queue with additional linked list properties.
- **Use**: Used to join and manage a new `lreap` instance with a specified maximum number of elements (`ele_max`).


---
### b
- **Type**: `lreap_t *`
- **Description**: A pointer to a `lreap_t` structure, which is a type of treap data structure optimized for iteration.
- **Use**: Used to join a new `lreap` instance with a specified maximum number of elements.


# Data Structures

---
### ele
- **Type**: ``struct``
- **Members**:
    - ``parent_cidx``: Stores the index of the parent element.
    - ``left_cidx``: Stores the index of the left child element.
    - ``right_cidx``: Stores the index of the right child element.
    - ``prio_cidx``: Stores the priority index of the element.
    - ``prev_cidx``: Stores the index of the previous element in a linked list.
    - ``next_cidx``: Stores the index of the next element in a linked list.
    - ``val``: Stores the value of the element.
- **Description**: Defines a node structure for a treap or linked list, with fields for parent, left, right, priority, previous, and next indices, as well as a value field. The indices are used to navigate and manage the relationships between nodes in data structures like treaps and linked lists.


---
### ele\_t
- **Type**: ``struct``
- **Members**:
    - `parent_cidx`: Stores the index of the parent element in the data structure.
    - `left_cidx`: Stores the index of the left child element in the data structure.
    - `right_cidx`: Stores the index of the right child element in the data structure.
    - `prio_cidx`: Stores the priority index of the element in the data structure.
    - `prev_cidx`: Stores the index of the previous element in a linked list context.
    - `next_cidx`: Stores the index of the next element in a linked list context.
    - `val`: Stores the value of the element as a signed character.
- **Description**: Defines a node structure for a treap or linked list, with fields for parent, left, right, priority, previous, and next indices, as well as a value field. This structure is used to manage elements in a pool and treap data structures, facilitating operations like insertion, removal, and iteration.


# Functions

---
### dump\_treap<!-- {{#callable:dump_treap}} -->
[View Source →](<../../../../../src/util/tmpl/test_treap.c#L65>)

Recursively prints the structure of a treap with indentation to represent tree levels.
- **Inputs**:
    - ``i``: The index of the current node in the `ele` array.
    - ``ele``: A pointer to an array of `ele_t` structures representing the nodes of the treap.
    - ``indent``: The current level of indentation for printing, used to visually represent the depth of the node in the treap.
- **Logic and Control Flow**:
    - Check if the index `i` is null using `treap_idx_is_null(i)`; if true, print the current indentation followed by a dash and return.
    - Recursively call `dump_treap` for the right child of the current node, increasing the indentation by 4 spaces.
    - Print the current node's value, priority, and index with the current indentation.
    - Recursively call `dump_treap` for the left child of the current node, increasing the indentation by 4 spaces.
- **Output**: No return value; the function outputs the treap structure to `stdout`.


---
### test\_iteration<!-- {{#callable:test_iteration}} -->
[View Source →](<../../../../../src/util/tmpl/test_treap.c#L88>)

Tests forward and reverse iteration over two data structures (`treap` and `lreap`) while conditionally deleting elements based on a provided function.
- **Inputs**:
    - ``del``: A function pointer of type `delfn_t` that determines which element to delete based on its value.
- **Logic and Control Flow**:
    - Initialize two data structures, `treap` and `lreap`, and two pools, `pool1` and `pool2`, each with 64 elements.
    - Insert elements into `treap` and `lreap` from `pool1` and `pool2`, respectively, setting their values and priorities.
    - Iterate over `treap` and `lreap` in forward direction, checking that elements are in order and not seen before, updating the largest seen value.
    - Use the `del` function to determine if an element should be deleted, and remove it from both `treap` and `lreap` if so.
    - Verify the integrity of `treap` and `lreap` after each iteration step.
    - Repeat the process for reverse iteration, checking elements in reverse order and updating the smallest seen value.
    - Ensure all elements are seen by the end of each iteration and verify the completion of iteration.
    - Clean up by deleting `treap`, `lreap`, and the pools.
- **Output**: No return value; the function performs tests and assertions internally.


---
### del\_fn\_self\_0<!-- {{#callable:del_fn_self_0}} -->
[View Source →](<../../../../../src/util/tmpl/test_treap.c#L197>)

Always returns -1, indicating no deletion should occur.
- **Inputs**:
    - `i`: An integer input, which is ignored in the function.
- **Logic and Control Flow**:
    - Casts the input `i` to void to indicate it is unused.
    - Returns -1 unconditionally.
- **Output**: An integer value of -1, indicating no deletion.


---
### del\_fn\_self\_1<!-- {{#callable:del_fn_self_1}} -->
[View Source →](<../../../../../src/util/tmpl/test_treap.c#L198>)

Evaluates if an integer is odd and returns the integer if true, otherwise returns -1.
- **Inputs**:
    - `i`: An integer to evaluate.
- **Logic and Control Flow**:
    - Checks if the integer `i` is odd by performing a bitwise AND operation with 1 (`i & 1`).
    - If the result of the bitwise operation is true (i.e., `i` is odd), returns the integer `i`.
    - If the result of the bitwise operation is false (i.e., `i` is even), returns -1.
- **Output**: Returns the integer `i` if it is odd, otherwise returns -1.


---
### del\_fn\_self\_2<!-- {{#callable:del_fn_self_2}} -->
[View Source →](<../../../../../src/util/tmpl/test_treap.c#L199>)

Evaluates whether an integer is even and returns the integer if true, otherwise returns -1.
- **Inputs**:
    - `i`: An integer to evaluate.
- **Logic and Control Flow**:
    - Performs a bitwise NOT operation on `i` and checks if the least significant bit is 0 (i.e., `i` is even).
    - If `i` is even, returns `i`.
    - If `i` is not even, returns -1.
- **Output**: Returns the input integer `i` if it is even, otherwise returns -1.


---
### del\_fn\_self\_3<!-- {{#callable:del_fn_self_3}} -->
[View Source →](<../../../../../src/util/tmpl/test_treap.c#L200>)

Evaluates whether an integer is odd and less than 32, returning the integer if true, or -1 otherwise.
- **Inputs**:
    - `i`: An integer to evaluate.
- **Logic and Control Flow**:
    - Performs a bitwise AND operation between `i` and 1 to check if `i` is odd.
    - Checks if `i` is less than 32.
    - Returns `i` if both conditions are true; otherwise, returns -1.
- **Output**: Returns the integer `i` if it is odd and less than 32; otherwise, returns -1.


---
### del\_fn\_self\_4<!-- {{#callable:del_fn_self_4}} -->
[View Source →](<../../../../../src/util/tmpl/test_treap.c#L201>)

Evaluates whether an integer `i` is even and less than 32, returning `i` if true, otherwise returning -1.
- **Inputs**:
    - `i`: An integer to evaluate.
- **Logic and Control Flow**:
    - Performs a bitwise NOT operation on `i` and checks if the least significant bit is 0 (i.e., `i` is even).
    - Checks if `i` is less than 32.
    - If both conditions are true, returns `i`.
    - If any condition is false, returns -1.
- **Output**: Returns the integer `i` if it is even and less than 32; otherwise, returns -1.


---
### del\_fn\_self\_5<!-- {{#callable:del_fn_self_5}} -->
[View Source →](<../../../../../src/util/tmpl/test_treap.c#L202>)

Evaluates whether an integer `i` is odd and greater than 31, returning `i` if true, otherwise returning -1.
- **Inputs**:
    - `i`: An integer to evaluate.
- **Logic and Control Flow**:
    - Performs a bitwise AND operation between `i` and 1 to check if `i` is odd.
    - Checks if `i` is greater than 31.
    - If both conditions are true, returns `i`.
    - If either condition is false, returns -1.
- **Output**: Returns the integer `i` if it is odd and greater than 31; otherwise, returns -1.


---
### del\_fn\_self\_6<!-- {{#callable:del_fn_self_6}} -->
[View Source →](<../../../../../src/util/tmpl/test_treap.c#L203>)

Evaluates whether an integer `i` is even and greater than 31, returning `i` if true, otherwise returning -1.
- **Inputs**:
    - `i`: An integer to evaluate.
- **Logic and Control Flow**:
    - Perform a bitwise NOT operation on `i` and bitwise AND with 1 to check if `i` is even.
    - Check if `i` is greater than 31.
    - If both conditions are true, return `i`.
    - If any condition is false, return -1.
- **Output**: Returns the integer `i` if it is even and greater than 31; otherwise, returns -1.


---
### del\_fn\_self\_7<!-- {{#callable:del_fn_self_7}} -->
[View Source →](<../../../../../src/util/tmpl/test_treap.c#L204>)

Returns the input integer `i` without modification.
- **Inputs**:
    - `i`: An integer input that the function will return.
- **Logic and Control Flow**:
    - The function takes an integer `i` as input.
    - The function returns the integer `i` without any modification.
- **Output**: The function returns the integer `i` that was passed as input.


---
### del\_fn\_next<!-- {{#callable:del_fn_next}} -->
[View Source →](<../../../../../src/util/tmpl/test_treap.c#L206>)

Calculates the next index to delete based on the current index, returning the next index if it is less than 63, otherwise returning -1.
- **Inputs**:
    - `i`: The current index as an integer.
- **Logic and Control Flow**:
    - Check if the input index `i` is less than 63.
    - If `i` is less than 63, return `i + 1`.
    - If `i` is 63 or greater, return -1.
- **Output**: Returns the next index to delete if `i` is less than 63, otherwise returns -1.


---
### del\_fn\_prev<!-- {{#callable:del_fn_prev}} -->
[View Source →](<../../../../../src/util/tmpl/test_treap.c#L207>)

Calculates the previous index for deletion based on the current index, returning the previous index if it is greater than zero, or -1 otherwise.
- **Inputs**:
    - `i`: The current index as an integer.
- **Logic and Control Flow**:
    - Check if the input `i` is greater than 0.
    - If `i` is greater than 0, return `i - 1`.
    - If `i` is not greater than 0, return -1.
- **Output**: An integer representing the previous index to delete, or -1 if no deletion should occur.


---
### del\_fn\_3<!-- {{#callable:del_fn_3}} -->
[View Source →](<../../../../../src/util/tmpl/test_treap.c#L208>)

Calculates the result of multiplying the input by 3 and then taking the modulus with 64.
- **Inputs**:
    - `i`: An integer input to the function.
- **Logic and Control Flow**:
    - Multiply the input `i` by 3.
    - Take the modulus of the result with 64.
    - Return the calculated value.
- **Output**: An integer which is the result of `(i*3)%64`.


---
### del\_fn\_5<!-- {{#callable:del_fn_5}} -->
[View Source →](<../../../../../src/util/tmpl/test_treap.c#L209>)

Calculates the result of multiplying the input by 5 and then taking the modulus with 64.
- **Inputs**:
    - `i`: An integer input to the function.
- **Logic and Control Flow**:
    - Multiply the input `i` by 5.
    - Calculate the modulus of the result with 64.
    - Return the calculated value.
- **Output**: An integer that is the result of `(i*5)%64`.


---
### test\_iteration\_all<!-- {{#callable:test_iteration_all}} -->
[View Source →](<../../../../../src/util/tmpl/test_treap.c#L211>)

Executes the [`test_iteration`](<#test_iteration>) function with a series of predefined deletion functions to test different iteration scenarios.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls [`test_iteration`](<#test_iteration>) with `del_fn_self_0` to `del_fn_self_7`, which are functions that determine whether to delete an element based on its index and specific conditions.
    - Calls [`test_iteration`](<#test_iteration>) with `del_fn_next`, `del_fn_prev`, `del_fn_3`, and `del_fn_5`, which are functions that determine the next index to delete based on arithmetic operations on the current index.
- **Output**: No output is returned as the function is `void`.
- **Functions Called**:
    - [`test_iteration`](<#test_iteration>)


---
### lreap\_to\_treap<!-- {{#callable:lreap_to_treap}} -->
[View Source →](<../../../../../src/util/tmpl/test_treap.c#L228>)

Converts an `lreap_t` structure to a `treap_t` structure by copying relevant fields.
- **Inputs**:
    - `in`: A pointer to the `lreap_t` structure to convert.
    - `out`: A pointer to the `treap_t` structure where the converted data will be stored.
- **Logic and Control Flow**:
    - Copy the `ele_max` field from `in` to `out`.
    - Copy the `ele_cnt` field from `in` to `out`.
    - Copy the `root` field from `in` to `out`.
    - Return the `out` pointer.
- **Output**: Returns a pointer to the `treap_t` structure (`out`) with the copied data.


---
### test\_merge<!-- {{#callable:test_merge}} -->
[View Source →](<../../../../../src/util/tmpl/test_treap.c#L239>)

Tests the merging of two leftist heaps (`lreap`) or treaps, depending on the `optimize_iteration` flag, and verifies the integrity of the merged structure.
- **Inputs**:
    - ``rng``: A pointer to a random number generator (`fd_rng_t`) used for random operations.
    - ``optimize_iteration``: An integer flag that determines whether to optimize the iteration using `lreap` or to convert to `treap` for merging.
- **Logic and Control Flow**:
    - Defines a macro `MERGE_VERIFY_AND_CLEAR` to verify and clear the merged structure.
    - Initializes two `lreap` structures `a` and `b` and a pool of elements.
    - Iterates over a range to distribute elements between `a` and `b`, then merges them using `MERGE_VERIFY_AND_CLEAR`.
    - Randomly distributes nodes between `a` and `b` and merges them, verifying the result each time.
    - Exercises a degenerate case by filling the internal stack and merging, verifying the result each time.
    - Cleans up by deleting the `lreap` structures and the pool.
- **Output**: No return value; the function performs tests and assertions to verify the correctness of the merge operations.


---
### test\_duplicate<!-- {{#callable:test_duplicate}} -->
[View Source →](<../../../../../src/util/tmpl/test_treap.c#L338>)

Tests the insertion, verification, and removal of elements in a treap data structure, including handling duplicates and merging operations.
- **Inputs**:
    - ``rng``: A pointer to a random number generator (`fd_rng_t`) used for generating random numbers during the test.
- **Logic and Control Flow**:
    - Initialize `ele_max` to 254 and create a pool and treap with this maximum size.
    - Set all elements in the pool to have a value of 0.
    - Perform 100 iterations where elements are inserted into the treap in a random order, verified, and then removed.
    - Verify that the order of elements in the treap matches the insertion order using forward iteration.
    - Create two treaps `a` and `b` and fill the pool with random values, allowing duplicates.
    - Perform 100 iterations where elements are randomly inserted into either treap `a` or `b`, then merge the treaps and verify the result.
    - Remove all elements from treap `a` after each merge.
    - Delete the treaps and clean up resources.
- **Output**: No return value; the function performs tests and assertions internally.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/util/tmpl/test_treap.c#L389>)

Initializes the environment, processes command-line arguments, and performs a series of tests on a treap data structure.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of strings representing the command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Extracts `ele_max` and `seed` from the command-line arguments using `fd_env_strip_cmdline_ulong`.
    - Checks if `ele_max` exceeds 64 and logs an error if true.
    - Logs the testing parameters `ele_max` and `seed`.
    - Initializes a random number generator `rng`.
    - Calculates alignment and footprint for the pool and checks against predefined limits, logging an error if exceeded.
    - Creates and joins a pool of elements using `pool_new` and `pool_join`.
    - Performs various tests on special values, address conversion, seed, alignment, and footprint.
    - Creates and joins a treap data structure, performing operations like insert, remove, and query in a loop.
    - Tests forward and reverse iteration over the treap.
    - Tests comparison operations (gt, ge, lt, le) on the treap.
    - Performs additional tests if hosted environment and handholding are enabled.
    - Tests leaving and deleting the treap and pool.
    - Calls [`test_merge`](<#test_merge>), [`test_duplicate`](<#test_duplicate>), and [`test_iteration_all`](<#test_iteration_all>) to perform further tests on treap operations.
    - Deletes the random number generator and logs a pass message.
    - Calls `fd_halt` to terminate the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`test_merge`](<#test_merge>)
    - [`test_duplicate`](<#test_duplicate>)
    - [`test_iteration_all`](<#test_iteration_all>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)