<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for singly linked list operations and memory pool management in the Firedancer codebase.

# Purpose
The code is a C program that implements and tests a simple pool and singly linked list (slist) data structure. It includes functions for managing a pool of elements and operations on a singly linked list, such as pushing and popping elements from the head or tail, inserting elements, and iterating over the list. The program uses a static array `ref_ele` to represent elements in the pool and list, with indices to track the previous and next elements. The `ref_pool` and `ref_slist` functions manage the pool and list operations, respectively.

The [`main`](<#main>) function initializes the environment, sets up a random number generator, and performs a series of tests on the pool and slist operations. It uses macros to define the pool and slist types and includes external files `fd_pool.c` and `fd_slist.c` for additional functionality. The program tests various operations, including checking if the list is empty, peeking at the head and tail, and verifying the list's integrity. It also includes diagnostic logging and error handling to ensure the operations are performed correctly. The program concludes by cleaning up resources and halting execution.
# Imports and Dependencies

---
- `../fd_util.h`
- `sys/types.h`
- `sys/wait.h`
- `unistd.h`
- `fd_pool.c`
- `fd_slist.c`


# Global Variables

---
### ref\_ele
- **Type**: `struct`
- **Description**: An array of structures, each containing three unsigned long integers: `prev`, `next`, and `val`. The array size is defined by the constant `ELE_MAX`. Each structure represents an element in a doubly linked list, with `prev` and `next` used to store indices of the previous and next elements, respectively, and `val` used to store a value associated with the element.
- **Use**: Used to manage a pool of elements and a singly linked list, allowing operations such as initialization, acquisition, release, and insertion of elements.


---
### ref\_pool
- **Type**: `ulong`
- **Description**: `ref_pool` is a global variable of type `ulong` that is initialized to `ELE_IDX_NULL`. It is used to manage a pool of elements in a linked list structure.
- **Use**: Tracks the index of the first available element in the pool for allocation and deallocation operations.


---
### ref\_slist\_head
- **Type**: `ulong`
- **Description**: Stores the index of the head element in a singly linked list. It is initialized to `ELE_IDX_NULL`, indicating that the list is initially empty.
- **Use**: Used to track the first element in the singly linked list for operations such as insertion, deletion, and traversal.


---
### ref\_slist\_tail
- **Type**: `ulong`
- **Description**: `ref_slist_tail` is a static global variable of type `ulong` that is initialized to `ELE_IDX_NULL`. It represents the index of the last element in a singly linked list (`slist`).
- **Use**: Tracks the index of the tail element in the singly linked list for operations like insertion and removal.


# Data Structures

---
### tst\_ele
- **Type**: ``struct``
- **Members**:
    - ``next_cidx``: Stores the index of the next element in the list.
    - ``val``: Holds an unsigned long integer value associated with the element.
- **Description**: Defines a structure with two members: `next_cidx`, which is of type `CIDX_T` and is used to store the index of the next element in a list, and `val`, which is an unsigned long integer that holds a value associated with the element. This structure is used in conjunction with pool and singly linked list operations to manage elements in a list.


---
### tst\_ele\_t
- **Type**: ``struct``
- **Members**:
    - ``next_cidx``: Stores the index of the next element in the list.
    - ``val``: Holds a value associated with the element.
- **Description**: Defines a structure with two members: `next_cidx`, which is used to link elements in a list, and `val`, which stores a value. This structure is used in conjunction with a pool and singly linked list implementation to manage elements efficiently.


# Functions

---
### ref\_pool\_init<!-- {{#callable:ref_pool_init}} -->
[View Source →](<../../../../../src/util/tmpl/test_slist.c#L21>)

Initializes the reference pool and sets up the linked list of elements based on the given element count.
- **Inputs**:
    - `ele_cnt`: The number of elements to initialize in the reference pool, must be in the range [0, ELE_MAX].
- **Logic and Control Flow**:
    - Check if `ele_cnt` is zero; if true, set `ref_pool` to `ELE_IDX_NULL` and return.
    - Set `ref_pool` to 0 to indicate the start of the pool.
    - Iterate over the range from 1 to `ele_cnt - 1`, setting the `prev` field of each element to `ELE_IDX_NULL`, the `next` field to the current index, and the `val` field to 0.
    - For the last element in the range, set its `prev` and `next` fields to `ELE_IDX_NULL` and its `val` field to 0.
- **Output**: No return value; the function modifies the global `ref_pool` and `ref_ele` array to initialize the pool.


---
### ref\_pool\_is\_empty<!-- {{#callable:ref_pool_is_empty}} -->
[View Source →](<../../../../../src/util/tmpl/test_slist.c#L41>)

Checks if the reference pool is empty by comparing `ref_pool` to `ELE_IDX_NULL`.
- **Inputs**: None
- **Logic and Control Flow**:
    - Compares the global variable `ref_pool` with the constant `ELE_IDX_NULL`.
    - Returns 1 if `ref_pool` is equal to `ELE_IDX_NULL`, indicating the pool is empty.
    - Returns 0 otherwise, indicating the pool has elements.
- **Output**: Returns an integer: 1 if the pool is empty, 0 otherwise.


---
### ref\_pool\_idx\_acquire<!-- {{#callable:ref_pool_idx_acquire}} -->
[View Source →](<../../../../../src/util/tmpl/test_slist.c#L46>)

Acquires an element index from the reference pool, assuming the pool is not empty.
- **Inputs**: None
- **Logic and Control Flow**:
    - Assigns the current `ref_pool` value to `ele_idx`.
    - Updates `ref_pool` to the `next` index of the element at `ele_idx` in `ref_ele`.
    - Returns the acquired `ele_idx`.
- **Output**: Returns the index of the acquired element from the pool.


---
### ref\_pool\_idx\_release<!-- {{#callable:ref_pool_idx_release}} -->
[View Source →](<../../../../../src/util/tmpl/test_slist.c#L53>)

Releases an element index back to the pool by updating the pool's head to the released index.
- **Inputs**:
    - `ele_idx`: The index of the element to release back to the pool.
- **Logic and Control Flow**:
    - Sets the `next` field of the element at `ele_idx` to the current `ref_pool` head.
    - Updates `ref_pool` to point to `ele_idx`, making it the new head of the pool.
- **Output**: The element index `ele_idx` is now part of the pool.


---
### ref\_slist\_is\_empty<!-- {{#callable:ref_slist_is_empty}} -->
[View Source →](<../../../../../src/util/tmpl/test_slist.c#L59>)

Checks if the singly linked list is empty by comparing the head index to `ELE_IDX_NULL`.
- **Inputs**: None
- **Logic and Control Flow**:
    - Compares `ref_slist_head` to `ELE_IDX_NULL` to determine if the list is empty.
    - Returns 1 if `ref_slist_head` is equal to `ELE_IDX_NULL`, indicating the list is empty.
    - Returns 0 if `ref_slist_head` is not equal to `ELE_IDX_NULL`, indicating the list is not empty.
- **Output**: Returns 1 if the singly linked list is empty, otherwise returns 0.


---
### ref\_slist\_idx\_peek\_head<!-- {{#callable:ref_slist_idx_peek_head}} -->
[View Source →](<../../../../../src/util/tmpl/test_slist.c#L64>)

Returns the index of the head element in a singly linked list.
- **Inputs**: None
- **Logic and Control Flow**:
    - Assumes the singly linked list is not empty.
    - Returns the value of the `ref_slist_head` variable, which holds the index of the head element in the list.
- **Output**: The index of the head element in the singly linked list as an unsigned long integer.


---
### ref\_slist\_idx\_peek\_tail<!-- {{#callable:ref_slist_idx_peek_tail}} -->
[View Source →](<../../../../../src/util/tmpl/test_slist.c#L69>)

Returns the index of the last element in a singly linked list.
- **Inputs**: None
- **Logic and Control Flow**:
    - Assumes the singly linked list is not empty.
    - Returns the value of the global variable `ref_slist_tail`, which holds the index of the last element in the list.
- **Output**: The index of the last element in the singly linked list as an unsigned long integer.


---
### ref\_slist\_idx\_push\_head<!-- {{#callable:ref_slist_idx_push_head}} -->
[View Source →](<../../../../../src/util/tmpl/test_slist.c#L74>)

Adds an element to the head of a singly linked list.
- **Inputs**:
    - `ele_idx`: The index of the element to add to the head of the singly linked list.
- **Logic and Control Flow**:
    - Retrieve the current head index of the singly linked list and store it in `next_idx`.
    - Set the `prev` field of the element at `ele_idx` to `ELE_IDX_NULL`.
    - Set the `next` field of the element at `ele_idx` to `next_idx`.
    - If `next_idx` is `ELE_IDX_NULL`, set `ref_slist_tail` to `ele_idx`, indicating the list was empty and now has one element.
    - Otherwise, set the `prev` field of the element at `next_idx` to `ele_idx`, linking the new head to the rest of the list.
    - Update `ref_slist_head` to `ele_idx`, making it the new head of the list.
- **Output**: No return value; the function modifies the global state of the singly linked list by adding a new head element.


---
### ref\_slist\_idx\_push\_tail<!-- {{#callable:ref_slist_idx_push_tail}} -->
[View Source →](<../../../../../src/util/tmpl/test_slist.c#L84>)

Adds an element to the end of a singly linked list.
- **Inputs**:
    - `ele_idx`: The index of the element to add to the tail of the singly linked list.
- **Logic and Control Flow**:
    - Retrieve the current tail index of the singly linked list and store it in `prev_idx`.
    - Set the `prev` field of the element at `ele_idx` to `prev_idx`.
    - Set the `next` field of the element at `ele_idx` to `ELE_IDX_NULL`, indicating it is the new tail.
    - If `prev_idx` is `ELE_IDX_NULL`, set `ref_slist_head` to `ele_idx`, indicating the list was empty and `ele_idx` is now the head.
    - Otherwise, set the `next` field of the element at `prev_idx` to `ele_idx`, linking the previous tail to the new tail.
    - Update `ref_slist_tail` to `ele_idx`, making it the new tail of the list.
- **Output**: No return value; the function modifies the global state of the singly linked list.


---
### ref\_slist\_idx\_pop\_head<!-- {{#callable:ref_slist_idx_pop_head}} -->
[View Source →](<../../../../../src/util/tmpl/test_slist.c#L94>)

Removes and returns the index of the head element from a singly linked list, updating the list's head and tail pointers accordingly.
- **Inputs**: None
- **Logic and Control Flow**:
    - Retrieve the index of the current head element from `ref_slist_head`.
    - Get the index of the next element in the list using `ref_ele[ele_idx].next`.
    - Update `ref_slist_head` to point to the next element's index.
    - If the next element's index is `ELE_IDX_NULL`, set `ref_slist_tail` to `ELE_IDX_NULL` to indicate the list is now empty.
    - Otherwise, set the `prev` pointer of the new head element to `ELE_IDX_NULL`.
    - Return the index of the removed head element.
- **Output**: Returns the index of the removed head element from the singly linked list.


---
### ref\_slist\_idx\_insert\_after<!-- {{#callable:ref_slist_idx_insert_after}} -->
[View Source →](<../../../../../src/util/tmpl/test_slist.c#L104>)

Inserts an element into a singly linked list immediately after a specified element.
- **Inputs**:
    - `ele_idx`: The index of the element to insert, which is assumed to be not in the list and not in the pool.
    - `slist_idx`: The index of the element in the list after which the new element will be inserted, which is assumed to be in the list.
- **Logic and Control Flow**:
    - Retrieve the index of the element following `slist_idx` in the list and store it in `next_idx`.
    - Set the `next` pointer of the element at `ele_idx` to `next_idx`.
    - Set the `prev` pointer of the element at `ele_idx` to `slist_idx`.
    - Update the `next` pointer of the element at `slist_idx` to point to `ele_idx`.
    - If `next_idx` is `ELE_IDX_NULL`, update `ref_slist_tail` to `ele_idx`, indicating that the new element is now the last element in the list.
    - Otherwise, update the `prev` pointer of the element at `next_idx` to `ele_idx`.
- **Output**: The function does not return a value; it modifies the linked list structure in place.


---
### ref\_slist\_remove\_all<!-- {{#callable:ref_slist_remove_all}} -->
[View Source →](<../../../../../src/util/tmpl/test_slist.c#L120>)

Removes all elements from the singly linked list by setting the head and tail indices to `ELE_IDX_NULL`.
- **Inputs**: None
- **Logic and Control Flow**:
    - Set `ref_slist_head` to `ELE_IDX_NULL` to indicate the list is empty.
    - Set `ref_slist_tail` to `ELE_IDX_NULL` to indicate the list is empty.
- **Output**: The singly linked list is empty, with no elements in the list or pool.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/util/tmpl/test_slist.c#L148>)

Initializes, tests, and validates a singly linked list implementation with various operations and boundary conditions.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
- **Logic and Control Flow**:
    - Initialize the environment and parse the command-line argument `--ele-max` to determine the maximum number of elements (`ele_max`).
    - Log the start of testing with the specified `ele_max`.
    - Initialize a random number generator (`rng`) and a scratch memory area with specific alignment and footprint.
    - Check if `ele_max` exceeds `ELE_MAX`, if the pool alignment is correct, and if the pool footprint is within limits, logging errors if any checks fail.
    - Initialize a reference pool and join a test pool with the specified `ele_max`.
    - Log the start of construction tests and perform various alignment and footprint checks on the singly linked list (`slist`).
    - Create and join a new singly linked list (`slist`) and perform tests to ensure it is correctly initialized.
    - Log the start of operation tests and perform a series of operations on the `slist`, including pushing, popping, and inserting elements, while verifying the list's state against a reference implementation.
    - Iterate a large number of times, randomly selecting operations to perform on the `slist`, and verify the results against the reference implementation.
    - If hosted and handholding is enabled, test boundary conditions of operations on an empty `slist` and ensure critical log messages are triggered.
    - Log the start of destruction tests and perform cleanup operations on the `slist`, ensuring proper deletion and memory management.
    - Log the completion of tests and halt the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`ref_pool_init`](<#ref_pool_init>)
    - [`ref_slist_is_empty`](<#ref_slist_is_empty>)
    - [`ref_slist_idx_peek_head`](<#ref_slist_idx_peek_head>)
    - [`ref_slist_idx_peek_tail`](<#ref_slist_idx_peek_tail>)
    - [`ref_pool_is_empty`](<#ref_pool_is_empty>)
    - [`ref_pool_idx_acquire`](<#ref_pool_idx_acquire>)
    - [`ref_slist_idx_push_head`](<#ref_slist_idx_push_head>)
    - [`ref_slist_idx_push_tail`](<#ref_slist_idx_push_tail>)
    - [`ref_slist_idx_pop_head`](<#ref_slist_idx_pop_head>)
    - [`ref_pool_idx_release`](<#ref_pool_idx_release>)
    - [`ref_slist_idx_insert_after`](<#ref_slist_idx_insert_after>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)