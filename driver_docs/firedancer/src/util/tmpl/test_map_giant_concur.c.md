<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests concurrent operations on a giant map data structure using multiple threads.

# Purpose
This code is a C program that tests the functionality of a map data structure, which is implemented in the included file `fd_map_giant.c`. The program uses a custom map type, `pair_t`, which consists of three `ulong` fields: `mykey`, `mynext`, and `val`. The map is used to store and retrieve key-value pairs, where the key is stored in the `mykey` field. The program initializes a map with a specified maximum number of entries and a seed for random number generation. It then performs a series of insertions and deletions on the map, using a queue to manage the keys being tested.

The program includes a separate thread, [`read_thread`](<#read_thread>), which continuously queries the map for keys stored in a volatile queue. This thread checks if the queried key is present in the map and counts the number of correct, incorrect, and blank results. The main thread performs map operations such as insertion, removal, and verification of map integrity. The program uses several functions from the `fd_util.h` library for logging, random number generation, and environment variable handling. The test concludes by stopping the read thread, cleaning up resources, and logging the test results.
# Imports and Dependencies

---
- `../fd_util.h`
- `pthread.h`
- `fd_map_giant.c`


# Global Variables

---
### mem
- **Type**: ``uchar[]``
- **Description**: An array of unsigned characters with a size of 32,768 bytes, aligned to a 128-byte boundary. The `mem` array is used as a memory buffer for the map data structure.
- **Use**: Provides memory storage for the map data structure used in the program.


---
### max
- **Type**: ``ulong``
- **Description**: `max` is a constant unsigned long integer with a value of 512. It defines the maximum number of elements that can be stored in the `queue` array and is used as a limit in various operations throughout the code.
- **Use**: Used to set the size of the `queue` array and as a loop boundary in the `read_thread` function.


---
### queue
- **Type**: ``volatile ulong[512]``
- **Description**: An array of 512 unsigned long integers that is declared as volatile to indicate that its value may change at any time without any action being taken by the code the compiler finds nearby. This is typically used in multi-threaded applications where the variable can be modified by different threads.
- **Use**: Used to store keys that are processed by the `read_thread` function and manipulated in the `main` function to manage entries in the `map`.


---
### map
- **Type**: ``pair_t *``
- **Description**: A pointer to a `pair_t` structure, which represents an entry in a map data structure. The `pair_t` structure contains fields `mykey`, `mynext`, and `val` to store key-value pairs and manage linked entries.
- **Use**: Used to store and manage key-value pairs in a map data structure, allowing for operations such as insertion, removal, and querying of entries.


---
### stop\_flag
- **Type**: ``int``
- **Description**: A static volatile integer variable that indicates when the `read_thread` function should stop executing its loop. The `volatile` keyword ensures that the compiler does not optimize out checks to this variable, as it may be modified by another thread.
- **Use**: Used as a flag to control the execution of the `read_thread` function, allowing it to terminate when set to a non-zero value.


# Data Structures

---
### pair
- **Type**: ``struct``
- **Members**:
    - `mykey`: Stores a key of type `ulong`.
    - `mynext`: Stores a reference to the next element in the map of type `ulong`.
    - `val`: Stores a value associated with the key of type `ulong`.
- **Description**: Defines a `struct` named `pair` that is used to represent an element in a map, with fields for a key, a reference to the next element, and a value, all of which are of type `ulong`.


---
### pair\_t
- **Type**: ``struct``
- **Members**:
    - `mykey`: Stores the key of the pair.
    - `mynext`: Stores the index or reference to the next pair in a sequence.
    - `val`: Stores the value associated with the key.
- **Description**: Defines a structure `pair_t` that represents a key-value pair with an additional field for linking to the next pair, typically used in a map or hash table implementation.


# Functions

---
### read\_thread<!-- {{#callable:read_thread}} -->
[View Source →](<../../../../../src/util/tmpl/test_map_giant_concur.c#L25>)

Continuously reads and verifies entries from a shared map until a stop condition is met, logging the number of correct, incorrect, and missing entries.
- **Inputs**:
    - `arg`: Unused argument, typically used for thread data.
- **Logic and Control Flow**:
    - Initialize counters `rights`, `wrongs`, and `blanks` to zero.
    - Enter a loop that continues until `stop_flag` is set to a non-zero value.
    - Iterate over each index `i` from 0 to `max` (exclusive).
    - Retrieve the key from `queue[i]` and query the map for a record using `map_query_safe`.
    - If the record is `NULL`, increment the `blanks` counter.
    - If the record is not `NULL`, calculate the index `idx` of the record in the map and verify its validity using `FD_TEST`.
    - If the record's key matches the queried key, increment the `rights` counter; otherwise, increment the `wrongs` counter.
    - After exiting the loop, log the counts of `rights`, `wrongs`, and `blanks`.
    - Ensure that at least one correct entry was found using `FD_TEST`.
- **Output**: Returns `NULL` after the loop completes and logging is done.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/util/tmpl/test_map_giant_concur.c#L50>)

Initializes and tests a map data structure with random keys and values, using a separate thread for concurrent read operations.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Extracts `--seed` and `--iter-max` values from command-line arguments, with default values of 1234 and 500000000, respectively.
    - Logs the testing parameters using `FD_LOG_NOTICE`.
    - Initializes a random number generator `rng` using `fd_rng_new` and `fd_rng_join`.
    - Fills the `queue` array with random numbers generated by `fd_rng_ulong`.
    - Checks memory alignment and footprint requirements using `map_align` and `map_footprint`. If requirements are not met, logs a warning and exits.
    - Creates and joins a map using `map_new` and `map_join`, and verifies its initial state with `FD_TEST`.
    - Creates a new thread `thr` to run the `read_thread` function, which performs concurrent read operations on the map.
    - Iterates `iter_max` times, performing map verification every 200 iterations and inserting/removing elements from the map.
    - If the map is full, removes an element from the map and updates the `queue_len`.
    - Inserts a new random key into the map, updates the queue, and increments `queue_len`.
    - Sets `stop_flag` to 1 and waits for the `read_thread` to finish using `pthread_join`.
    - Deletes the map and random number generator, logs a success message, and calls `fd_halt` before returning 0.
- **Output**: Returns 0 after completing the test and cleanup operations.



---
Made with ❤️ by [Driver](https://www.driver.ai/)