<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests dynamic deque operations and boundary conditions in the Firedancer codebase.

# Purpose
The code is a C program that tests the functionality of a deque (double-ended queue) implementation. It includes operations for adding and removing elements from both ends of the deque, as well as random access and iteration capabilities. The program defines a static buffer with a maximum size (`TEST_DEQUE_MAX`) and provides functions to manipulate this buffer, such as [`buf_push_head`](<#buf_push_head>), [`buf_push_tail`](<#buf_push_tail>), [`buf_pop_head`](<#buf_pop_head>), [`buf_pop_tail`](<#buf_pop_tail>), and [`buf_pop_idx`](<#buf_pop_idx>). These functions are used to simulate the behavior of a deque and are tested against the actual deque implementation included from `fd_deque_dynamic.c`.

The [`main`](<#main>) function initializes the environment and sets up a random number generator to perform a series of randomized operations on the deque. It tests various operations, including pushing and popping elements from both ends, zero-copy operations, and iterating over the deque. The program also includes checks for boundary conditions, such as handling full and empty deques, and tests the deque's behavior with a maximum size of zero. The code uses logging and assertions (`FD_TEST`) to verify the correctness of each operation and to ensure that the deque behaves as expected under different scenarios. The program is designed to run in a hosted environment, as indicated by the conditional inclusion of system headers and the use of process control functions like `fork` and `wait`.
# Imports and Dependencies

---
- `../fd_util.h`
- `sys/types.h`
- `sys/wait.h`
- `unistd.h`
- `fd_deque_dynamic.c`


# Global Variables

---
### buf
- **Type**: ``int[]``
- **Description**: An array of integers with a size defined by the macro `TEST_DEQUE_MAX`. It is used to store elements in a circular buffer or deque structure.
- **Use**: Stores integer elements for operations such as push and pop in a circular buffer.


---
### buf\_start
- **Type**: ``ulong``
- **Description**: `buf_start` is a static global variable of type `ulong` that represents the starting index of a buffer used in a circular deque implementation. It is initialized to 0 and is used to track the position where the next element will be pushed or popped from the head of the buffer.
- **Use**: Tracks the starting index for head operations in a circular buffer.


---
### buf\_end
- **Type**: ``ulong``
- **Description**: Stores the index of the next available position in the buffer for inserting a new element at the tail. It is initialized to 0 and is used to track the end of the buffer in a circular buffer implementation.
- **Use**: Tracks the position for the next tail insertion in the buffer.


---
### buf\_cnt
- **Type**: ``ulong``
- **Description**: `buf_cnt` is a static unsigned long integer that tracks the number of elements currently stored in the buffer `buf`. It is initialized to zero and is used to ensure that the buffer does not exceed its maximum capacity, defined by `TEST_DEQUE_MAX`. The variable is incremented or decremented as elements are added to or removed from the buffer.
- **Use**: Tracks the current count of elements in the buffer to manage buffer operations and ensure it does not exceed its capacity.


---
### scratch
- **Type**: ``uchar[]``
- **Description**: An array of unsigned characters with a size defined by `SCRATCH_FOOTPRINT`, which is 1024 bytes. The array is aligned in memory according to `SCRATCH_ALIGN`, which is 128 bytes.
- **Use**: Used as a memory buffer for operations that require aligned memory access, such as creating and managing a deque.


# Functions

---
### buf\_push\_head<!-- {{#callable:buf_push_head}} -->
[View Source →](<../../../../../src/util/tmpl/test_deque_dynamic.c#L15>)

Inserts an integer at the head of a circular buffer, adjusting the buffer's start index and count.
- **Inputs**:
    - `i`: The integer value to insert at the head of the buffer.
- **Logic and Control Flow**:
    - Check if the buffer count `buf_cnt` is less than `TEST_DEQUE_MAX` using `FD_TEST` macro.
    - Increment the buffer count `buf_cnt`.
    - Decrement the buffer start index `buf_start`.
    - If `buf_start` is greater than or equal to `TEST_DEQUE_MAX`, set `buf_start` to `TEST_DEQUE_MAX-1UL`.
    - Assign the integer `i` to the buffer at the index `buf_start`.
- **Output**: No return value; the function modifies the global buffer state.


---
### buf\_push\_tail<!-- {{#callable:buf_push_tail}} -->
[View Source →](<../../../../../src/util/tmpl/test_deque_dynamic.c#L22>)

Adds an integer to the end of a circular buffer if it is not full.
- **Inputs**:
    - `i`: The integer value to add to the end of the buffer.
- **Logic and Control Flow**:
    - Check if the buffer is not full using `FD_TEST(buf_cnt<TEST_DEQUE_MAX)`.
    - Assign the integer `i` to the current end position of the buffer `buf[buf_end]`.
    - Increment the buffer count `buf_cnt` and the end index `buf_end`.
    - If `buf_end` reaches `TEST_DEQUE_MAX`, reset `buf_end` to 0 to maintain the circular nature of the buffer.
- **Output**: No return value; the function modifies the global buffer state.


---
### buf\_pop\_head<!-- {{#callable:buf_pop_head}} -->
[View Source →](<../../../../../src/util/tmpl/test_deque_dynamic.c#L29>)

Removes and returns the integer at the head of a circular buffer, updating the buffer's start index and count.
- **Inputs**: None
- **Logic and Control Flow**:
    - Checks if the buffer is not empty using `FD_TEST(buf_cnt)`.
    - Retrieves the integer at the current `buf_start` index from the `buf` array and stores it in `i`.
    - Decrements `buf_cnt` to reflect the removal of an element.
    - Increments `buf_start` to point to the next element in the buffer.
    - Checks if `buf_start` has reached the maximum buffer size (`TEST_DEQUE_MAX`), and if so, wraps it around to 0.
- **Output**: Returns the integer value that was at the head of the buffer.


---
### buf\_pop\_tail<!-- {{#callable:buf_pop_tail}} -->
[View Source →](<../../../../../src/util/tmpl/test_deque_dynamic.c#L37>)

Removes and returns the last element from a circular buffer, adjusting the buffer's end index and count.
- **Inputs**: None
- **Logic and Control Flow**:
    - Check if the buffer is not empty using `FD_TEST(buf_cnt)`.
    - Decrement `buf_cnt` to reflect the removal of an element.
    - Decrement `buf_end` to point to the new end of the buffer.
    - If `buf_end` is greater than or equal to `TEST_DEQUE_MAX`, set `buf_end` to `TEST_DEQUE_MAX-1UL`.
    - Return the element at the new `buf_end` position in the buffer.
- **Output**: Returns the integer value of the element removed from the end of the buffer.


---
### buf\_pop\_idx<!-- {{#callable:buf_pop_idx}} -->
[View Source →](<../../../../../src/util/tmpl/test_deque_dynamic.c#L44>)

Removes and returns the element at a specified index from a circular buffer, shifting subsequent elements to fill the gap.
- **Inputs**:
    - `idx`: The index of the element to remove from the buffer.
- **Logic and Control Flow**:
    - Check if the buffer is not empty using `FD_TEST(buf_cnt)`.
    - Decrement `buf_cnt` and `buf_end` to reflect the removal of an element.
    - Adjust `buf_end` if it exceeds `TEST_DEQUE_MAX` by setting it to `TEST_DEQUE_MAX-1UL`.
    - Calculate the position of the element to remove using `(buf_start+idx) % TEST_DEQUE_MAX` and store its value in `val`.
    - Initialize `gap` with `idx` and enter a loop to shift elements from `gap+1` to `buf_cnt` to the left.
    - In each iteration, calculate the current and next positions using `(buf_start+gap) % TEST_DEQUE_MAX` and `(buf_start+gap+1) % TEST_DEQUE_MAX`, respectively.
    - Assign the element at the next position to the current position and increment `gap`.
    - Continue the loop until `gap` exceeds `buf_cnt`.
    - Return the value of the removed element `val`.
- **Output**: The function returns the integer value of the element removed from the buffer.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/util/tmpl/test_deque_dynamic.c#L65>)

Executes a series of tests on a deque data structure, including construction, accessor, and operation tests, while handling command-line arguments and logging results.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of strings representing the command-line arguments.
- **Logic and Control Flow**:
    - Initializes the environment and random number generator using `fd_boot` and `fd_rng_new`.
    - Parses the `--max` command-line argument to determine the maximum size of the deque, defaulting to `TEST_DEQUE_MAX`.
    - Checks if the `max` value exceeds `TEST_DEQUE_MAX` or if the alignment and footprint requirements are met; logs warnings and exits if not.
    - Logs the maximum size and begins testing the deque's construction, ensuring alignment and footprint are correct.
    - Creates and joins a new deque using `test_deque_new` and `test_deque_join`, then tests accessors to verify the maximum size and count.
    - Performs 100 million iterations of random operations on the deque, including push, pop, and zero-copy operations, while validating each operation with `FD_TEST`.
    - Handles special cases like resetting the deque and testing iterators in both forward and reverse directions.
    - Tests boundary conditions for full and empty deques, including invalid operations that should trigger critical logs.
    - Cleans up by leaving and deleting the deque, and deletes the random number generator before halting the program.
- **Output**: Returns 0 upon successful completion of all tests.
- **Functions Called**:
    - [`buf_push_head`](<#buf_push_head>)
    - [`buf_push_tail`](<#buf_push_tail>)
    - [`buf_pop_head`](<#buf_pop_head>)
    - [`buf_pop_tail`](<#buf_pop_tail>)
    - [`buf_pop_idx`](<#buf_pop_idx>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)