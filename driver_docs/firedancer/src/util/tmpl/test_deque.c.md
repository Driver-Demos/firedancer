<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for deque operations, including push, pop, and iteration, with boundary condition checks.

# Purpose
The code is a test suite for a double-ended queue (deque) implementation in C. It includes functions to manipulate a static buffer as a deque, with operations such as [`buf_push_head`](<#buf_push_head>), [`buf_push_tail`](<#buf_push_tail>), [`buf_pop_head`](<#buf_pop_head>), [`buf_pop_tail`](<#buf_pop_tail>), and [`buf_pop_idx`](<#buf_pop_idx>). These functions manage the buffer's start, end, and count to simulate deque operations. The code also includes a main function that tests the deque's functionality by performing a series of operations on a deque instance created using the `fd_deque.c` library. The test suite verifies the correctness of deque operations, including pushing and popping elements from both ends, iterating over elements, and handling boundary conditions.

The code uses macros to define the deque's characteristics, such as `DEQUE_NAME`, `DEQUE_T`, and `DEQUE_MAX`, and includes the `fd_deque.c` file to provide the deque implementation. The main function initializes a random number generator and performs a series of randomized operations on the deque, checking the results against the static buffer implementation to ensure consistency. It also includes tests for invalid operations and boundary conditions, using logging and assertions to verify expected behavior. The code is designed to run in a hosted environment, as indicated by the conditional inclusion of system headers and the use of process control functions for testing error conditions.
# Imports and Dependencies

---
- `../fd_util.h`
- `sys/types.h`
- `sys/wait.h`
- `unistd.h`
- `fd_deque.c`


# Global Variables

---
### buf
- **Type**: ``int[]``
- **Description**: An array of integers with a size defined by the macro `TEST_DEQUE_MAX`. It is used to store elements in a circular buffer or deque structure.
- **Use**: Stores integer elements for operations such as push and pop in a circular buffer.


---
### buf\_start
- **Type**: ``ulong``
- **Description**: Stores the index of the start of the buffer in a circular buffer implementation. It is initialized to 0 and is used to track the position where the next element will be pushed or popped from the head of the buffer.
- **Use**: Tracks the starting index of the buffer for operations like pushing and popping elements from the head.


---
### buf\_end
- **Type**: ``ulong``
- **Description**: Stores the index of the next position in the buffer where a new element will be added when using the `buf_push_tail` function. It is initialized to 0 and is incremented each time an element is added to the tail of the buffer.
- **Use**: Tracks the end position of the buffer for tail operations.


---
### buf\_cnt
- **Type**: ``ulong``
- **Description**: `buf_cnt` is a static unsigned long integer that tracks the number of elements currently stored in the buffer `buf`. It is initialized to zero and is used to ensure that the buffer does not exceed its maximum capacity, defined by `TEST_DEQUE_MAX`. The variable is incremented or decremented as elements are added to or removed from the buffer.
- **Use**: Tracks the current count of elements in the buffer to manage buffer operations and ensure it does not exceed its capacity.


---
### scratch
- **Type**: ``uchar[]``
- **Description**: An array of unsigned characters with a size defined by `SCRATCH_FOOTPRINT`, which is 1024 bytes. The array is aligned in memory according to `SCRATCH_ALIGN`, which is 128 bytes.
- **Use**: Used as a memory region for operations that require specific alignment and footprint constraints, such as the `test_deque` operations.


# Functions

---
### buf\_push\_head<!-- {{#callable:buf_push_head}} -->
[View Source →](<../../../../../src/util/tmpl/test_deque.c#L15>)

Inserts an integer at the head of a circular buffer, adjusting the buffer's start index and count.
- **Inputs**:
    - `i`: The integer value to insert at the head of the buffer.
- **Logic and Control Flow**:
    - Check if the buffer count `buf_cnt` is less than `TEST_DEQUE_MAX` using `FD_TEST` macro.
    - Increment the buffer count `buf_cnt`.
    - Decrement the buffer start index `buf_start`.
    - If `buf_start` is greater than or equal to `TEST_DEQUE_MAX`, set `buf_start` to `TEST_DEQUE_MAX-1UL`.
    - Assign the integer `i` to the buffer at the position `buf[buf_start]`.
- **Output**: No return value; the function modifies the global buffer state.


---
### buf\_push\_tail<!-- {{#callable:buf_push_tail}} -->
[View Source →](<../../../../../src/util/tmpl/test_deque.c#L22>)

Adds an integer to the end of a circular buffer if it is not full.
- **Inputs**:
    - `i`: The integer value to add to the buffer.
- **Logic and Control Flow**:
    - Check if the buffer is not full using `FD_TEST(buf_cnt<TEST_DEQUE_MAX)`; if full, the function does not proceed.
    - Assign the integer `i` to the current end position of the buffer `buf[buf_end]`.
    - Increment the buffer count `buf_cnt` and the end index `buf_end`.
    - If `buf_end` reaches `TEST_DEQUE_MAX`, reset `buf_end` to 0 to maintain the circular nature of the buffer.
- **Output**: No return value; the function modifies the global buffer state.


---
### buf\_pop\_head<!-- {{#callable:buf_pop_head}} -->
[View Source →](<../../../../../src/util/tmpl/test_deque.c#L29>)

Removes and returns the integer at the head of a circular buffer, updating the buffer's start index and count.
- **Inputs**: None
- **Logic and Control Flow**:
    - Checks if the buffer is not empty using `FD_TEST(buf_cnt)`.
    - Retrieves the integer at the current `buf_start` index from the `buf` array and stores it in `i`.
    - Decrements `buf_cnt` to reflect the removal of an element.
    - Increments `buf_start` to point to the next element in the buffer.
    - Checks if `buf_start` has reached or exceeded `TEST_DEQUE_MAX`, and if so, wraps it around to 0.
- **Output**: Returns the integer that was at the head of the buffer.


---
### buf\_pop\_tail<!-- {{#callable:buf_pop_tail}} -->
[View Source →](<../../../../../src/util/tmpl/test_deque.c#L37>)

Removes and returns the last element from a buffer, adjusting the buffer's end and count accordingly.
- **Inputs**: None
- **Logic and Control Flow**:
    - Check if the buffer count `buf_cnt` is non-zero using `FD_TEST` macro.
    - Decrement the buffer count `buf_cnt` and the buffer end `buf_end`.
    - If `buf_end` is greater than or equal to `TEST_DEQUE_MAX`, set `buf_end` to `TEST_DEQUE_MAX-1UL`.
    - Return the element at the new `buf_end` position in the buffer `buf`.
- **Output**: Returns the integer value of the element removed from the end of the buffer.


---
### buf\_pop\_idx<!-- {{#callable:buf_pop_idx}} -->
[View Source →](<../../../../../src/util/tmpl/test_deque.c#L44>)

Removes an element at a specified index from a circular buffer and shifts subsequent elements to fill the gap.
- **Inputs**:
    - `idx`: The index of the element to remove from the buffer.
- **Logic and Control Flow**:
    - Checks if the buffer is not empty using `FD_TEST(buf_cnt)`.
    - Decrements `buf_cnt` and `buf_end` to reflect the removal of an element.
    - Adjusts `buf_end` if it exceeds `TEST_DEQUE_MAX` to wrap around the buffer.
    - Retrieves the value at the specified index `idx` from the buffer using `(buf_start+idx) % TEST_DEQUE_MAX`.
    - Initializes `gap` with the value of `idx` and enters a loop to shift elements.
    - In the loop, calculates the current and next indices `i` and `j` using `(buf_start+gap) % TEST_DEQUE_MAX` and `(buf_start+gap+1) % TEST_DEQUE_MAX`, respectively.
    - Copies the element from index `j` to index `i` to shift elements left.
    - Increments `gap` and continues the loop until `gap` exceeds `buf_cnt`.
    - Returns the value of the removed element.
- **Output**: The function returns the integer value of the element removed from the buffer.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/util/tmpl/test_deque.c#L66>)

Tests the functionality of a deque data structure by performing various operations and validating their correctness.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Initializes the random number generator and checks alignment and footprint constraints for the deque.
    - Logs the start of testing for construction, accessors, and operations.
    - Creates and joins a new deque using the `scratch` memory region.
    - Performs a loop of 100,000,000 iterations where a random operation is selected and executed on the deque.
    - Handles operations such as push, pop, zero-copy push/pop, and iterating over the deque in both forward and reverse directions.
    - Checks the deque's state after each operation to ensure it matches expected conditions (e.g., full, empty, correct count).
    - Tests boundary conditions and invalid arguments if hosted environment is available.
    - Deletes the deque and cleans up resources before exiting.
- **Output**: Returns 0 after successfully testing the deque operations.
- **Functions Called**:
    - [`buf_push_head`](<#buf_push_head>)
    - [`buf_push_tail`](<#buf_push_tail>)
    - [`buf_pop_head`](<#buf_pop_head>)
    - [`buf_pop_tail`](<#buf_pop_tail>)
    - [`buf_pop_idx`](<#buf_pop_idx>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)