<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for priority queue implementations with different sorting criteria and operations.

# Purpose
The code is a C program that tests the functionality of priority queues implemented using a heap data structure. It defines a structure `event_t` to represent events with timeouts and values, and uses this structure to create three types of priority queues: `eventq`, `maxq`, and `implq`. Each queue type is defined by including the `fd_prq.c` file with different preprocessor directives to customize the behavior of the priority queue, such as sorting order and timeout handling.

The program includes functions to test the integrity and behavior of these priority queues, such as [`test_heap`](<#test_heap>), [`test_max_heap`](<#test_max_heap>), and [`test_implicit_heap`](<#test_implicit_heap>), which verify the heap properties for each queue type. The [`main`](<#main>) function orchestrates the testing process by creating, populating, and manipulating these queues, checking that operations like insertion, removal, and retrieval maintain the expected order and properties. The program also includes tests for edge cases and error handling, ensuring that the priority queues function correctly under various conditions.
# Imports and Dependencies

---
- `../fd_util.h`
- `sys/types.h`
- `sys/wait.h`
- `unistd.h`
- `fd_prq.c`


# Data Structures

---
### event
- **Type**: ``struct``
- **Members**:
    - `timeout`: Stores a long integer representing the primary timeout value for the event.
    - `timeout2`: Stores a long integer used for implementation queue tests, which must be strictly positive.
    - `val`: An array of three long integers used to store additional values related to the event.
- **Description**: Represents an event with two timeout values and an array of additional values, used in priority queue operations to manage event scheduling and retrieval.


---
### event\_t
- **Type**: ``struct``
- **Members**:
    - `timeout`: Stores the primary timeout value for the event.
    - `timeout2`: Stores a secondary timeout value used for specific tests, must be strictly positive.
    - `val`: An array of three long integers used to store additional values related to the event.
- **Description**: Defines an event with two timeout values and an array of three long integers, used in priority queue operations to manage event scheduling and retrieval based on timeout criteria.


# Functions

---
### test\_heap<!-- {{#callable:test_heap}} -->
[View Source →](<../../../../../src/util/tmpl/test_prq.c#L33>)

Validates that a binary heap of events maintains the heap property and matches expected counts and maximums.
- **Inputs**:
    - `heap`: A pointer to an array of `event_t` structures representing the heap.
    - `cnt`: The current number of elements in the heap.
    - `max`: The maximum number of elements the heap can contain.
- **Logic and Control Flow**:
    - Checks if the current count of elements in the heap matches `cnt` using `eventq_cnt` function.
    - Checks if the maximum capacity of the heap matches `max` using `eventq_max` function.
    - Verifies that the current count `cnt` does not exceed the maximum `max`.
    - Iterates over each child node in the heap starting from index 1 to `cnt-1`.
    - For each child node, calculates the parent node index using `(child-1UL) >> 1`.
    - Checks if the `timeout` of the parent node is less than or equal to the `timeout` of the child node, ensuring the heap property is maintained.
- **Output**: Returns 0 after successfully validating the heap properties.


---
### test\_max\_heap<!-- {{#callable:test_max_heap}} -->
[View Source →](<../../../../../src/util/tmpl/test_prq.c#L46>)

Validates that a max-heap property is maintained in a given heap of events.
- **Inputs**:
    - `heap`: A pointer to an array of `event_t` structures representing the heap.
    - `cnt`: The number of elements currently in the heap.
    - `max`: The maximum capacity of the heap.
- **Logic and Control Flow**:
    - Check if the current count of elements in the heap matches `cnt` using `FD_TEST` and `maxq_cnt` function.
    - Check if the maximum capacity of the heap matches `max` using `FD_TEST` and `maxq_max` function.
    - Ensure that `cnt` is less than or equal to `max` using `FD_TEST`.
    - Iterate over each child node in the heap starting from index 1 to `cnt-1`.
    - For each child node, calculate its parent node index using `(child-1UL) >> 1`.
    - Verify that the `timeout` of the parent node is greater than or equal to the `timeout` of the child node using `FD_TEST`.
- **Output**: Returns 0 after successfully validating the max-heap property.


---
### test\_implicit\_heap<!-- {{#callable:test_implicit_heap}} -->
[View Source →](<../../../../../src/util/tmpl/test_prq.c#L59>)

Validates the properties of an implicit heap by checking its size, maximum capacity, and the heap property based on a custom comparison of event timeouts.
- **Inputs**:
    - `heap`: A pointer to an array of `event_t` structures representing the heap.
    - `cnt`: The current number of elements in the heap.
    - `max`: The maximum capacity of the heap.
- **Logic and Control Flow**:
    - Check if the current count of elements in the heap matches `cnt` using `implq_cnt` function.
    - Verify if the maximum capacity of the heap matches `max` using `implq_max` function.
    - Ensure that the current count `cnt` does not exceed the maximum capacity `max`.
    - Iterate over each child node in the heap starting from index 1 to `cnt-1`.
    - For each child node, calculate its parent index using `(child-1UL) >> 1`.
    - Compute the ratio of `timeout` to `timeout2` for both the parent and child nodes.
    - Check if the parent's ratio is greater than or equal to the child's ratio to maintain the heap property.
- **Output**: Returns 0 after successfully validating the heap properties.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/util/tmpl/test_prq.c#L75>)

Tests various queue operations including construction, insertion, removal, and destruction on different types of priority queues.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Initializes the random number generator and sets a maximum value for the queue size.
    - Logs the start of testing for queue construction and checks alignment and footprint requirements.
    - Allocates memory for the queue and checks if the memory allocation is sufficient.
    - Creates and joins an event queue, then tests the queue's initial state.
    - Inserts events into the queue in a quasi-random order and tests the heap property after each insertion.
    - Removes events from the queue in order of minimum timeout and tests the heap property after each removal.
    - Inserts events again in a quasi-random order, removes half of them randomly, and tests the heap property.
    - Ensures the remaining events are retrieved in a valid order and tests the heap property after each removal.
    - Tests the removal of all events from the queue and checks the heap property.
    - Tests the destruction of the event queue and logs the completion of the test.
    - Repeats similar tests for max queue and implicit queue types.
    - Includes conditional compilation for additional tests if hosted environment and handholding are enabled.
    - Deletes the random number generator and logs the successful completion of all tests.
- **Output**: Returns 0 on successful completion of all tests, or 1 if any test fails.
- **Functions Called**:
    - [`test_heap`](<#test_heap>)
    - [`test_max_heap`](<#test_max_heap>)
    - [`test_implicit_heap`](<#test_implicit_heap>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)