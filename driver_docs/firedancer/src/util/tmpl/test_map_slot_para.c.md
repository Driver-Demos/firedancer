<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for concurrent operations and error handling on a custom map data structure using multiple tiles.

# Purpose
The code is a C program designed to test the functionality and performance of a concurrent hash map implementation. It includes a structure `myele` to represent elements in the map, with fields for a key, usage status, value, modification count, and a memoization value. The program uses a series of macros to define the map's behavior, such as key hashing, key equality checks, and element management. The map is implemented using a slot-based approach, as indicated by the inclusion of `fd_map_slot_para.c`.

The main function initializes the map with parameters such as element maximum, lock count, probe maximum, and seed, which can be configured via command-line arguments. It then performs a series of tests to verify the map's construction, accessors, and concurrent operations across multiple tiles (threads). The [`tile_main`](<#tile_main>) function simulates concurrent operations on the map, including insertions, removals, modifications, and queries, while ensuring the map's integrity through various assertions. The program also includes mechanisms for shared memory allocation and random number generation to support these operations. The code concludes with tests for map destruction and error handling, ensuring that the map behaves correctly under various conditions.
# Imports and Dependencies

---
- `../fd_util.h`
- `fd_map_slot_para.c`


# Global Variables

---
### shmem
- **Type**: ``uchar[]``
- **Description**: A static array of unsigned characters with a maximum size defined by `SHMEM_MAX`. It is used to store shared memory data.
- **Use**: Used to allocate and manage shared memory for concurrent operations.


---
### shmem\_cnt
- **Type**: ``ulong``
- **Description**: `shmem_cnt` is a static global variable of type `ulong` that tracks the current offset in the shared memory array `shmem`. It is initialized to 0UL, indicating that no memory has been allocated yet.
- **Use**: Tracks the current position in the shared memory array `shmem` for memory allocation purposes.


---
### tile\_map
- **Type**: ``mymap_t *``
- **Description**: A pointer to a `mymap_t` structure, which is a type defined for a map data structure. This variable is used to store the address of the map instance that is shared across different parts of the program.
- **Use**: Used to access and manipulate the map data structure throughout the program.


---
### tile\_iter\_cnt
- **Type**: ``ulong``
- **Description**: Stores the number of iterations to perform in the `tile_main` function.
- **Use**: Used to control the loop iterations in the `tile_main` function for concurrent operations on the map.


---
### tile\_go
- **Type**: ``ulong``
- **Description**: `tile_go` is a static global variable of type `ulong` that acts as a flag to control the execution flow of concurrent operations on multiple tiles. It is used to synchronize the start of operations across different tiles in a multi-threaded environment.
- **Use**: Used to signal when tiles should begin executing concurrent operations.


# Data Structures

---
### myele
- **Type**: ``struct``
- **Members**:
    - `mykey`: An unsigned integer that serves as the key for the element.
    - `used`: An integer flag indicating whether the element is in use.
    - `val`: An unsigned integer representing a value associated with the element.
    - `mod`: An unsigned integer used for modification tracking.
    - `mymemo`: An unsigned long integer used for memoization purposes.
- **Description**: Defines a structure `myele` that represents an element in a map, containing a key, a usage flag, a value, a modification tracker, and a memoization field.


---
### myele\_t
- **Type**: ``struct``
- **Members**:
    - ``mykey``: An unsigned integer that serves as the key for the element.
    - ``used``: An integer flag indicating whether the element is in use.
    - ``val``: An unsigned integer representing the value associated with the key.
    - ``mod``: An unsigned integer used for modification tracking.
    - ``mymemo``: An unsigned long integer used for memoization purposes.
- **Description**: Defines a structure for elements in a map, with fields for a key, usage status, value, modification tracking, and memoization.


# Functions

---
### shmem\_alloc<!-- {{#callable:shmem_alloc}} -->
[View Source →](<../../../../../src/util/tmpl/test_map_slot_para.c#L49>)

Allocates a block of memory from a shared memory pool with specified alignment and size.
- **Inputs**:
    - `a`: The alignment requirement for the memory block, specified as an unsigned long integer.
    - `s`: The size of the memory block to allocate, specified as an unsigned long integer.
- **Logic and Control Flow**:
    - Aligns the current position in the shared memory pool `shmem` to the specified alignment `a` using `fd_ulong_align_up` function.
    - Calculates the new position in the shared memory pool by adding the aligned position and the requested size `s`.
    - Updates the global `shmem_cnt` to reflect the new position in the shared memory pool.
    - Checks if the updated `shmem_cnt` exceeds the maximum allowed size `SHMEM_MAX` using `FD_TEST`.
    - Returns a pointer to the aligned memory block.
- **Output**: A pointer to the allocated memory block, cast to `void *`.


---
### tile\_main<!-- {{#callable:tile_main}} -->
[View Source →](<../../../../../src/util/tmpl/test_map_slot_para.c#L62>)

Executes concurrent operations on a shared map structure using multiple tiles, including insertions, removals, modifications, and queries, while ensuring synchronization and correctness.
- **Inputs**:
    - `argc`: The number of command-line arguments, used to determine the tile index.
    - `argv`: The command-line arguments, used to determine the number of tiles.
- **Logic and Control Flow**:
    - Initialize local variables and context for the tile, including map pointers, random number generator, and shared memory allocation.
    - Check constraints on the number of tiles and iterations to ensure they are within limits.
    - Wait for a signal to start operations by spinning until `tile_go` is set.
    - Perform a loop for `iter_cnt` iterations, executing random operations on the map based on a randomly generated operation code (`op`).
    - Operations include blocking reads, inserts, removes, modifies, queries, and parallel iterations, each with specific conditions and error handling.
    - Use hints and flags to optimize map operations and handle errors such as `FD_MAP_ERR_AGAIN` and `FD_MAP_ERR_FULL`.
    - Log progress and diagnostics at regular intervals, especially for the first tile.
    - After completing iterations, clean up by removing all keys from the map and restoring shared memory state.
    - Delete the random number generator and return 0 to indicate successful execution.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`shmem_alloc`](<#shmem_alloc>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/util/tmpl/test_map_slot_para.c#L487>)

Initializes and tests a concurrent map implementation with various parameters and operations.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Extracts command-line parameters for `ele_max`, `lock_cnt`, `probe_max`, `seed`, and `iter_cnt` using `fd_env_strip_cmdline_ulong`.
    - Logs the testing parameters using `FD_LOG_NOTICE`.
    - Initializes a random number generator `rng` with `fd_rng_new` and `fd_rng_join`.
    - Allocates shared memory for elements `shele` and initializes it to zero.
    - Performs miscellaneous tests on lock and probe counts using random values and checks with `FD_TEST`.
    - Logs the start of construction tests and checks alignment and footprint of the map with `FD_TEST`.
    - Allocates shared memory for the map `shmap` and initializes a map instance `map`.
    - Tests map creation and joining with various invalid and valid parameters using `FD_TEST`.
    - Initializes the map context and tests accessors for map properties using `FD_TEST`.
    - Performs tests on element locks and indices using loops and `FD_TEST`.
    - Sets up concurrent operations on multiple tiles using `fd_tile_exec_new` and [`tile_main`](<#tile_main>).
    - Tests map verification after concurrent operations using `FD_TEST`.
    - Logs the start of destruction tests and tests map leaving and deletion with `FD_TEST`.
    - Logs error codes and their string representations using `FD_LOG_NOTICE`.
    - Deletes the random number generator and halts the program with `fd_halt`.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`shmem_alloc`](<#shmem_alloc>)
    - [`main::FD_VOLATILE`](<#mainfd_volatile>)
    - [`tile_main`](<#tile_main>)


---
### FD\_VOLATILE<!-- {{#callable:main::FD_VOLATILE}} -->
[View Source →](<../../../../../src/util/tmpl/test_map_slot_para.c#L618>)

Sets the volatile variable `tile_go` to 0 and enforces a memory fence.
- **Inputs**:
    - `tile_go`: A volatile variable that is set to 0.
- **Logic and Control Flow**:
    - Set the volatile variable `tile_go` to 0.
    - Call `FD_COMPILER_MFENCE()` to enforce a memory fence, ensuring memory operations are completed before proceeding.
- **Output**: No output is returned.



---
Made with ❤️ by [Driver](https://www.driver.ai/)