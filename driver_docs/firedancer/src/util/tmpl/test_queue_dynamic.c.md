<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests dynamic queue operations with various push and pop methods, including zero-copy operations.

# Purpose
The code is a C program that tests the functionality of a dynamic queue implementation. It includes a static buffer with a maximum size defined by `BUF_MAX` and provides basic operations to push and pop integers from this buffer. The program uses a dynamic queue, defined in the included file `fd_queue_dynamic.c`, to perform similar operations. The main function initializes the environment, sets up a random number generator, and configures the maximum size of the queue. It then performs a series of tests to verify the queue's construction, accessors, and operations, including push, pop, zero-copy push, and zero-copy pop.

The program uses a scratch memory region for the queue's storage, ensuring alignment and footprint constraints are met. It performs a large number of iterations to test the queue's operations under various conditions, including random resets of the buffer. The tests include checks for queue properties such as maximum size, current count, availability, emptiness, and fullness. The program logs notices and warnings to provide feedback on the test progress and results. It concludes by cleaning up resources and halting the execution.
# Imports and Dependencies

---
- `../fd_util.h`
- `fd_queue_dynamic.c`


# Global Variables

---
### buf
- **Type**: ``int[]``
- **Description**: An array of integers with a size defined by the macro `BUF_MAX`. It is used to store integer values in a circular buffer fashion.
- **Use**: Stores integer values in a circular buffer for push and pop operations.


---
### buf\_start
- **Type**: ``ulong``
- **Description**: `buf_start` is a static global variable of type `ulong` that represents the starting index of a circular buffer `buf`. It is initialized to 0 and is used to track the position from which elements are removed from the buffer.
- **Use**: Tracks the starting index for element removal in the circular buffer `buf`.


---
### buf\_end
- **Type**: ``ulong``
- **Description**: Represents the index position in the `buf` array where the next element will be inserted. It is used to track the end of the buffer in a circular buffer implementation.
- **Use**: Tracks the position for the next insertion in the circular buffer.


---
### buf\_cnt
- **Type**: ``ulong``
- **Description**: Counts the number of elements currently in the buffer `buf`. It is initialized to zero and is incremented or decremented as elements are added or removed from the buffer.
- **Use**: Tracks the current number of elements in the buffer to ensure it does not exceed `BUF_MAX`.


---
### scratch
- **Type**: ``uchar[]``
- **Description**: An array of unsigned characters with a size defined by `SCRATCH_FOOTPRINT`, which is 1024 bytes. The array is aligned in memory according to `SCRATCH_ALIGN`, which is 128 bytes.
- **Use**: Serves as a memory region for operations related to the `test_queue`.


# Functions

---
### buf\_push<!-- {{#callable:buf_push}} -->
[View Source →](<../../../../../src/util/tmpl/test_queue_dynamic.c#L10>)

Adds an integer to the end of a circular buffer if there is space available.
- **Inputs**:
    - `i`: The integer to add to the buffer.
- **Logic and Control Flow**:
    - Check if the buffer is not full using `FD_TEST(buf_cnt<BUF_MAX)`; if full, the function does not proceed.
    - Assign the integer `i` to the position in the buffer indicated by `buf_end`.
    - Increment `buf_cnt` to reflect the addition of a new element.
    - Increment `buf_end` to point to the next position in the buffer.
    - If `buf_end` reaches `BUF_MAX`, reset `buf_end` to 0 to maintain the circular nature of the buffer.
- **Output**: No output is returned; the function modifies the global buffer state.


---
### buf\_pop<!-- {{#callable:buf_pop}} -->
[View Source →](<../../../../../src/util/tmpl/test_queue_dynamic.c#L17>)

Removes and returns the integer at the start of a circular buffer, updating the buffer's state accordingly.
- **Inputs**: None
- **Logic and Control Flow**:
    - Checks if the buffer is not empty using `FD_TEST(buf_cnt)`.
    - Retrieves the integer at the current `buf_start` index from the `buf` array and stores it in `i`.
    - Decrements `buf_cnt` to reflect the removal of an element.
    - Increments `buf_start` to point to the next element in the buffer.
    - Checks if `buf_start` has reached `BUF_MAX` and resets it to `0UL` if true, maintaining the circular nature of the buffer.
    - Returns the integer `i` that was removed from the buffer.
- **Output**: Returns the integer that was at the start of the buffer.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/util/tmpl/test_queue_dynamic.c#L31>)

Initializes and tests a dynamic queue with random operations, ensuring alignment and footprint constraints are met.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: The array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment.
    - Creates a random number generator `rng` using `fd_rng_new` and `fd_rng_join`.
    - Parses the `--max` command-line argument to determine the maximum queue size, defaulting to `BUF_MAX`.
    - Checks if `max` exceeds `BUF_MAX` or if the queue's alignment and footprint exceed `SCRATCH_ALIGN` and `SCRATCH_FOOTPRINT`, respectively, logging warnings and exiting if so.
    - Logs the maximum queue size being tested.
    - Tests queue construction by checking alignment and footprint, then creates and joins a new queue.
    - Logs and tests queue accessors to ensure the queue is initialized correctly.
    - Performs 100 million iterations of random queue operations (push, pop, zero-copy push, zero-copy pop) based on random values generated by `rng`.
    - Resets the buffer and queue if a randomly generated reset condition is met.
    - Verifies queue operations using `FD_TEST` to ensure correctness after each operation.
    - Leaves and deletes the queue, then deletes the random number generator.
    - Logs a success message and calls `fd_halt` to terminate the program.
- **Output**: Returns 0 after successful execution and testing of the queue operations.
- **Functions Called**:
    - [`buf_push`](<#buf_push>)
    - [`buf_pop`](<#buf_pop>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)