<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Generates prototypes, inlines, and implementations for concurrent persistent shared maps using chaining, supporting high concurrency and low conflict risk.

# Purpose
The code is a C module that provides a framework for creating concurrent persistent shared maps using chaining. These maps can store a large number of elements and are designed to support high concurrency with minimal risk of conflicts. The module allows for concurrent operations such as insert, remove, and modify, with a focus on maintaining low overhead and high performance. The maps are implemented with version numbers for each chain to manage concurrent access and ensure data integrity. This versioning allows for speculative processing and lock-free queries, which can be useful in high-throughput applications.

The module is designed to be highly flexible and can be integrated with other data structures like pools, treaps, heaps, and lists. It supports features such as inter-process usage, memory relocation, serialization, and index compression for efficiency. The code provides a comprehensive API for managing map operations, including functions for creating, joining, and deleting maps, as well as for performing transactional operations. The module is intended to be used in environments where concurrency and flexibility are important, and it requires atomic operations for safe concurrent use.
# Imports and Dependencies

---
- `fd_map.h`
- `../bits/fd_bits.h`
- `../log/fd_log.h`


# Functions

---
### MAP\_<!-- {{#callable:MAP_}} -->
[View Source →](<../../../../../src/util/tmpl/fd_map_chain_para.c#L2131>)

Attempts a speculative query on a map for a given key, returning success if the key is found and valid, or an error code if not.
- **Inputs**:
    - ``join``: A pointer to a `MAP_(t)` structure representing the map to query.
    - ``key``: A pointer to a `MAP_KEY_T` structure representing the key to search for in the map.
    - ``sentinel``: A pointer to a `MAP_ELE_T` structure used as a sentinel value if the key is not found.
    - ``query``: A pointer to a `MAP_(query_t)` structure where the query result will be stored.
    - ``flags``: An integer representing flags that modify the behavior of the query, such as using a hint for the key hash.
- **Logic and Control Flow**:
    - Retrieve the map and element store from the `join` structure.
    - Calculate the hash of the `key` using the map's seed, unless the `FD_MAP_FLAG_USE_HINT` flag is set, in which case use the memoized hash from `query`.
    - Get the chain associated with the calculated hash.
    - Read the versioned count of the chain to determine the number of elements and check if the chain is locked.
    - If the chain is locked or the versioned count changes during the operation, return `FD_MAP_ERR_AGAIN`.
    - If the number of elements exceeds the maximum allowed, return `FD_MAP_ERR_CORRUPT`.
    - Iterate over the elements in the chain, checking if each element matches the `key`.
    - If a matching element is found, update `query` with the element and return `FD_MAP_SUCCESS`.
    - If no matching element is found, perform an additional integrity check on the chain's tail pointer.
    - If the integrity check fails, return `FD_MAP_ERR_CORRUPT`; otherwise, return `FD_MAP_ERR_KEY`.
- **Output**: Returns `FD_MAP_SUCCESS` if the key is found and valid, `FD_MAP_ERR_AGAIN` if the chain is locked or modified during the query, `FD_MAP_ERR_CORRUPT` if corruption is detected, or `FD_MAP_ERR_KEY` if the key is not found.


---
### MAP\_CRIT<!-- {{#callable:MAP_CRIT}} -->
[View Source →](<../../../../../src/util/tmpl/fd_map_chain_para.c#L2060>)

Searches a map chain for a key and, if found, retains the lock on the chain for further operations.
- **Inputs**:
    - `chain`: A pointer to the map chain to be searched.
    - `flags`: An integer representing operation flags, including `FD_MAP_FLAG_BLOCKING` and `FD_MAP_FLAG_ADAPTIVE`.
- **Logic and Control Flow**:
    - Initialize `ver_cnt` with the versioned count of the chain.
    - Calculate `ele_cnt` as the count of elements in the chain using `MAP_(private_vcnt_cnt)`.
    - Check if `ele_cnt` exceeds `ele_max`; if so, handle corruption based on `MAP_PEDANTIC` setting.
    - Initialize `cur` to point to the head of the chain.
    - Iterate over the elements in the chain using a for-loop bounded by `ele_cnt`.
    - For each element, calculate `ele_idx` using `MAP_(private_idx)` and check if it is valid.
    - If the element is found (key matches), update the chain if `FD_MAP_FLAG_ADAPTIVE` is set, set `query->ele` to the found element, set `err` to `FD_MAP_SUCCESS`, and set `retain_lock` to 1.
    - If the element is not found, update `cur` to point to the next element in the chain.
    - After the loop, check if the chain ends correctly; if not, handle corruption based on `MAP_PEDANTIC` setting.
    - Set `err` to `FD_MAP_ERR_KEY` if the key is not found.
- **Output**: The function returns an integer error code, `FD_MAP_SUCCESS` if the key is found and the lock is retained, or an error code such as `FD_MAP_ERR_KEY` or `FD_MAP_ERR_CORRUPT` if the key is not found or corruption is detected.



---
Made with ❤️ by [Driver](https://www.driver.ai/)