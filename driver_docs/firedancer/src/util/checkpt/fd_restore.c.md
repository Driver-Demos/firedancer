<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for restoring data from a checkpoint, including LZ4 decompression support.

# Purpose
The code provides functionality for restoring data from a checkpoint using LZ4 compression. It includes functions to initialize, manage, and finalize a restoration process. The primary components are functions that handle the initialization of a restoration stream ([`fd_restore_init_stream`](<#fd_restore_init_stream>)) or memory-mapped I/O ([`fd_restore_init_mmio`](<#fd_restore_init_mmio>)), decompression of data using LZ4 ([`fd_restore_private_lz4`](<#fd_restore_private_lz4>)), and the management of restoration frames ([`fd_restore_open_advanced`](<#fd_restore_open_advanced>), [`fd_restore_close_advanced`](<#fd_restore_close_advanced>)). The code also includes error handling and logging to ensure that invalid inputs or states are reported.

The code is structured to support both streaming and memory-mapped input/output operations, with conditional compilation based on the availability of LZ4. It defines a public API for initializing and finalizing restoration processes, as well as for reading metadata and data from a checkpoint. The use of LZ4 allows for efficient decompression of data, and the code includes optimizations for handling small buffers. The functions are designed to be used in a larger system where data needs to be restored from compressed checkpoints, providing a mechanism to handle both raw and compressed data streams.
# Imports and Dependencies

---
- `fd_checkpt.h`
- `lz4.h`


# Functions

---
### fd\_restore\_private\_lz4<!-- {{#callable:fd_restore_private_lz4}} -->
[View Source →](<../../../../../src/util/checkpt/fd_restore.c#L20>)

Decompresses a compressed buffer using LZ4 and handles small buffer optimizations.
- **Inputs**:
    - `lz4`: A pointer to an `LZ4_streamDecode_t` structure used for LZ4 decompression.
    - `_ubuf`: A pointer to the destination buffer where decompressed data will be stored.
    - `ubuf_usz`: The size of the uncompressed buffer.
    - `_cbuf`: A pointer to the source buffer containing compressed data.
    - `cbuf_max`: The maximum size of the compressed buffer.
    - `_sbuf`: A pointer to a small buffer used for optimization.
    - `sbuf_sz`: The size of the small buffer.
    - `sbuf_thresh`: The threshold size to determine if the small buffer optimization should be used.
    - `_sbuf_cursor`: A pointer to a cursor indicating the current position in the small buffer.
- **Logic and Control Flow**:
    - Verify that `ubuf_usz` is within the valid range and `cbuf_max` is large enough to store a header and a non-trivial compressed body.
    - Extract and validate the header from `cbuf` to determine the compressed size `ubuf_csz` and total size `cbuf_sz`.
    - Check if `cbuf_sz` is within valid limits and does not exceed `cbuf_max`.
    - Determine if the small buffer optimization should be used based on `ubuf_usz` and `sbuf_thresh`.
    - If using the small buffer, adjust `ubuf` to point to the appropriate location in `_sbuf` and update `_sbuf_cursor`.
    - Decompress the data using `LZ4_decompress_safe_continue` and store the result in `ubuf`.
    - If decompression fails, log a warning and return 0.
    - If using the small buffer, copy the decompressed data back to `_ubuf`.
    - Return the total size of the compressed data used.
- **Output**: Returns the total size of the compressed data used for decompression, or 0 if an error occurs.


---
### fd\_restore\_init\_stream<!-- {{#callable:fd_restore_init_stream}} -->
[View Source →](<../../../../../src/util/checkpt/fd_restore.c#L90>)

Initializes a `fd_restore_t` structure for stream-based restoration with optional LZ4 decompression support.
- **Inputs**:
    - `mem`: A pointer to memory where the `fd_restore_t` structure will be initialized.
    - `fd`: A file descriptor for the stream to restore from.
    - `rbuf`: A pointer to a buffer used for reading data from the stream.
    - `rbuf_sz`: The size of the read buffer `rbuf`.
- **Logic and Control Flow**:
    - Check if `mem` is NULL; if so, log a warning and return NULL.
    - Check if `mem` is aligned to `FD_RESTORE_ALIGN`; if not, log a warning and return NULL.
    - Check if `fd` is negative; if so, log a warning and return NULL.
    - Check if `rbuf` is NULL; if so, log a warning and return NULL.
    - Check if `rbuf_sz` is less than `FD_RESTORE_RBUF_MIN`; if so, log a warning and return NULL.
    - Attempt to get the size and current position of the file descriptor `fd` using `fd_io_sz` and `fd_io_seek`.
    - If the file descriptor is not seekable, set `off` to 0 and `sz` to `ULONG_MAX`.
    - If the file descriptor is seekable, ensure the current position is valid; otherwise, log a warning and return NULL.
    - If LZ4 is available, create an LZ4 stream decoder; if creation fails, log a warning and return NULL.
    - Initialize the `fd_restore_t` structure with the provided and calculated values.
    - Return the initialized `fd_restore_t` structure.
- **Output**: A pointer to the initialized `fd_restore_t` structure, or NULL if initialization fails.


---
### fd\_restore\_init\_mmio<!-- {{#callable:fd_restore_init_mmio}} -->
[View Source →](<../../../../../src/util/checkpt/fd_restore.c#L171>)

Initializes a `fd_restore_t` structure for memory-mapped I/O operations with optional LZ4 decompression support.
- **Inputs**:
    - `mem`: A pointer to a memory region where the `fd_restore_t` structure will be initialized.
    - `mmio`: A pointer to the memory-mapped I/O region to be used for restoration.
    - `mmio_sz`: The size of the memory-mapped I/O region.
- **Logic and Control Flow**:
    - Check if `mem` is NULL; if so, log a warning and return NULL.
    - Check if `mem` is aligned according to `FD_RESTORE_ALIGN`; if not, log a warning and return NULL.
    - Check if `mmio` is NULL while `mmio_sz` is non-zero; if so, log a warning and return NULL.
    - Check if `mmio_sz` exceeds `LONG_MAX`; if so, log a warning and return NULL.
    - If LZ4 support is available, create an LZ4 stream decoder; if creation fails, log a warning and return NULL.
    - Initialize the `fd_restore_t` structure with the provided `mem`, set `fd` to -1 for mmio mode, and assign other fields including `lz4`, `sbuf_cursor`, `sz`, `off`, and `mmio.mem`.
    - Return the initialized `fd_restore_t` structure.
- **Output**: A pointer to the initialized `fd_restore_t` structure, or NULL if initialization fails.


---
### fd\_restore\_fini<!-- {{#callable:fd_restore_fini}} -->
[View Source →](<../../../../../src/util/checkpt/fd_restore.c#L225>)

Finalizes the restoration process by checking the validity of the `restore` object and freeing any associated LZ4 resources if applicable.
- **Inputs**:
    - `restore`: A pointer to an `fd_restore_t` structure that represents the restoration context to be finalized.
- **Logic and Control Flow**:
    - Check if `restore` is NULL; if so, log a warning and return NULL.
    - Check if `restore` is currently in a frame using [`fd_restore_in_frame`](<fd_checkpt.h.md#fd_restore_in_frame>); if so, log a warning, set `frame_style` to -1, and return NULL.
    - If LZ4 is enabled, attempt to free the LZ4 stream decoder associated with `restore->lz4`; log a warning if the operation fails.
    - Return the `restore` pointer.
- **Output**: Returns the `restore` pointer if successful, or NULL if an error occurs.
- **Functions Called**:
    - [`fd_restore_in_frame`](<fd_checkpt.h.md#fd_restore_in_frame>)


---
### fd\_restore\_open\_advanced<!-- {{#callable:fd_restore_open_advanced}} -->
[View Source →](<../../../../../src/util/checkpt/fd_restore.c#L253>)

Initializes a restore operation with a specified frame style and updates the offset if successful.
- **Inputs**:
    - ``restore``: A pointer to an `fd_restore_t` structure that represents the restore context.
    - ``frame_style``: An integer representing the desired frame style for the restore operation.
    - ``_off``: A pointer to an unsigned long where the function will store the current offset if the operation is successful.
- **Logic and Control Flow**:
    - Checks if `restore` is NULL and logs a warning if true, returning `FD_CHECKPT_ERR_INVAL`.
    - Checks if `restore` can open using [`fd_restore_can_open`](<fd_checkpt.h.md#fd_restore_can_open>) and logs a warning if it cannot, returning `FD_CHECKPT_ERR_INVAL`.
    - Checks if `_off` is NULL and logs a warning if true, returning `FD_CHECKPT_ERR_INVAL`.
    - Determines the `frame_style` using `fd_int_if` to set a default if `frame_style` is zero.
    - Uses a switch statement to handle different `frame_style` values:
    - For `FD_CHECKPT_FRAME_STYLE_RAW`, it does nothing and breaks.
    - For `FD_CHECKPT_FRAME_STYLE_LZ4`, it attempts to set up LZ4 stream decoding and logs a warning if it fails, returning `FD_CHECKPT_ERR_COMP`.
    - For unsupported `frame_style` values, it logs a warning and returns `FD_CHECKPT_ERR_UNSUP`.
    - Sets `restore->frame_style` to the determined `frame_style`.
    - Updates `*_off` with the current offset from `restore->off`.
    - Returns `FD_CHECKPT_SUCCESS` if all operations are successful.
- **Output**: Returns an integer status code: `FD_CHECKPT_SUCCESS` on success, or an error code such as `FD_CHECKPT_ERR_INVAL`, `FD_CHECKPT_ERR_COMP`, or `FD_CHECKPT_ERR_UNSUP` on failure.
- **Functions Called**:
    - [`fd_restore_can_open`](<fd_checkpt.h.md#fd_restore_can_open>)


---
### fd\_restore\_close\_advanced<!-- {{#callable:fd_restore_close_advanced}} -->
[View Source →](<../../../../../src/util/checkpt/fd_restore.c#L309>)

Closes a frame in the restore process and updates the offset if the restore is valid and in a frame.
- **Inputs**:
    - `restore`: A pointer to an `fd_restore_t` structure that represents the current restore context.
    - `_off`: A pointer to an `ulong` where the function will store the current offset if the operation is successful.
- **Logic and Control Flow**:
    - Check if `restore` is NULL; if so, log a warning and return `FD_CHECKPT_ERR_INVAL`.
    - Check if `restore` is not in a frame using [`fd_restore_in_frame`](<fd_checkpt.h.md#fd_restore_in_frame>); if not, log a warning, set `restore->frame_style` to -1, and return `FD_CHECKPT_ERR_INVAL`.
    - Check if `_off` is NULL; if so, log a warning, set `restore->frame_style` to -1, and return `FD_CHECKPT_ERR_INVAL`.
    - Set `restore->frame_style` to 0 to indicate the frame is closed.
    - Set the value pointed to by `_off` to `restore->off`.
    - Return `FD_CHECKPT_SUCCESS` to indicate the operation was successful.
- **Output**: Returns `FD_CHECKPT_SUCCESS` on success, or an error code such as `FD_CHECKPT_ERR_INVAL` if the input is invalid or the restore is not in a frame.
- **Functions Called**:
    - [`fd_restore_in_frame`](<fd_checkpt.h.md#fd_restore_in_frame>)


---
### fd\_restore\_seek<!-- {{#callable:fd_restore_seek}} -->
[View Source →](<../../../../../src/util/checkpt/fd_restore.c#L336>)

Adjusts the file descriptor position within a restore operation to a specified offset, handling both memory-mapped I/O and streaming modes.
- **Inputs**:
    - ``restore``: A pointer to an `fd_restore_t` structure representing the restore operation context.
    - ``off``: An unsigned long integer specifying the offset to which the file descriptor should be moved.
- **Logic and Control Flow**:
    - Check if `restore` is NULL; if so, log a warning and return `FD_CHECKPT_ERR_INVAL`.
    - Verify if the restore operation can be opened; if not, log a warning, set `frame_style` to -1, and return `FD_CHECKPT_ERR_INVAL`.
    - Retrieve the size `sz` from the `restore` structure and check if it exceeds `LONG_MAX`; if so, log a warning, set `frame_style` to -1, and return `FD_CHECKPT_ERR_INVAL`.
    - Check if `off` is greater than `sz`; if so, log a warning, set `frame_style` to -1, and return `FD_CHECKPT_ERR_INVAL`.
    - If the restore operation is in memory-mapped I/O mode, set `restore->off` to `off`.
    - Otherwise, attempt to seek the file descriptor to `off` using `fd_io_seek`; if it fails, log a warning, set `frame_style` to -1, and return `FD_CHECKPT_ERR_IO`.
    - Verify that the resulting index `idx` matches `off`; if not, log a warning, set `frame_style` to -1, and return `FD_CHECKPT_ERR_IO`.
    - Update `restore->off`, `restore->rbuf.lo`, and `restore->rbuf.ready` to reflect the new position.
- **Output**: Returns `FD_CHECKPT_SUCCESS` on successful seek, or an error code (`FD_CHECKPT_ERR_INVAL` or `FD_CHECKPT_ERR_IO`) if an error occurs.
- **Functions Called**:
    - [`fd_restore_can_open`](<fd_checkpt.h.md#fd_restore_can_open>)
    - [`fd_restore_is_mmio`](<fd_checkpt.h.md#fd_restore_is_mmio>)


---
### fd\_restore\_private\_buf<!-- {{#callable:fd_restore_private_buf}} -->
[View Source →](<../../../../../src/util/checkpt/fd_restore.c#L423>)

Restores data from a checkpoint into a buffer, handling different frame styles and error conditions.
- **Inputs**:
    - ``restore``: A pointer to an `fd_restore_t` structure that contains the state of the restore operation.
    - ``buf``: A pointer to the buffer where the restored data will be written.
    - ``sz``: The size of the data to restore.
    - ``max``: The maximum allowable size for the data to restore.
- **Logic and Control Flow**:
    - Check if `restore` is NULL and log a warning if true, returning `FD_CHECKPT_ERR_INVAL`.
    - Verify if the restore operation is within a frame using [`fd_restore_in_frame`](<fd_checkpt.h.md#fd_restore_in_frame>); if not, log a warning, set `frame_style` to -1, and return `FD_CHECKPT_ERR_INVAL`.
    - If `sz` is zero, return `FD_CHECKPT_SUCCESS` as there is nothing to restore.
    - Check if `sz` exceeds `max`; if true, log a warning, set `frame_style` to -1, and return `FD_CHECKPT_ERR_INVAL`.
    - Verify if `buf` is NULL when `sz` is non-zero; if true, log a warning, set `frame_style` to -1, and return `FD_CHECKPT_ERR_INVAL`.
    - Determine the current offset from `restore->off`.
    - Switch based on `restore->frame_style` to handle different frame styles:
    - For `FD_CHECKPT_FRAME_STYLE_RAW`, check if in mmio mode and perform a memory copy or buffered read based on the mode, updating the offset accordingly.
    - For `FD_CHECKPT_FRAME_STYLE_LZ4`, handle both mmio and streaming modes, decompressing data using LZ4 and updating the offset and buffer pointers accordingly.
    - If an unsupported frame style is encountered, log a warning, set `frame_style` to -1, and return `FD_CHECKPT_ERR_UNSUP`.
    - Update `restore->off` with the new offset after processing.
- **Output**: Returns an integer status code indicating success (`FD_CHECKPT_SUCCESS`) or an error code (`FD_CHECKPT_ERR_INVAL`, `FD_CHECKPT_ERR_IO`, `FD_CHECKPT_ERR_COMP`, or `FD_CHECKPT_ERR_UNSUP`) based on the outcome of the restore operation.
- **Functions Called**:
    - [`fd_restore_in_frame`](<fd_checkpt.h.md#fd_restore_in_frame>)
    - [`fd_restore_is_mmio`](<fd_checkpt.h.md#fd_restore_is_mmio>)
    - [`fd_restore_private_lz4`](<#fd_restore_private_lz4>)


---
### fd\_restore\_meta<!-- {{#callable:fd_restore_meta}} -->
[View Source →](<../../../../../src/util/checkpt/fd_restore.c#L641>)

Calls [`fd_restore_private_buf`](<#fd_restore_private_buf>) to restore metadata from a buffer with a size limit of `FD_CHECKPT_META_MAX`.
- **Inputs**:
    - `restore`: A pointer to an `fd_restore_t` structure that manages the restore operation.
    - `buf`: A pointer to the buffer where the metadata will be restored.
    - `sz`: The size of the buffer to restore.
- **Logic and Control Flow**:
    - Calls [`fd_restore_private_buf`](<#fd_restore_private_buf>) with `restore`, `buf`, `sz`, and `FD_CHECKPT_META_MAX` as arguments.
    - Returns the result of the [`fd_restore_private_buf`](<#fd_restore_private_buf>) function call.
- **Output**: Returns an integer status code from [`fd_restore_private_buf`](<#fd_restore_private_buf>), indicating success or failure of the restore operation.
- **Functions Called**:
    - [`fd_restore_private_buf`](<#fd_restore_private_buf>)


---
### fd\_restore\_data<!-- {{#callable:fd_restore_data}} -->
[View Source →](<../../../../../src/util/checkpt/fd_restore.c#L648>)

Calls [`fd_restore_private_buf`](<#fd_restore_private_buf>) to restore data from a checkpoint into a buffer.
- **Inputs**:
    - `restore`: A pointer to an `fd_restore_t` structure that contains the state of the restore operation.
    - `buf`: A pointer to the buffer where the restored data will be stored.
    - `sz`: The size of the data to restore, in bytes.
- **Logic and Control Flow**:
    - Calls [`fd_restore_private_buf`](<#fd_restore_private_buf>) with `restore`, `buf`, `sz`, and `ULONG_MAX` as arguments.
    - Returns the result of the [`fd_restore_private_buf`](<#fd_restore_private_buf>) function call.
- **Output**: Returns an integer status code indicating the success or failure of the restore operation.
- **Functions Called**:
    - [`fd_restore_private_buf`](<#fd_restore_private_buf>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)