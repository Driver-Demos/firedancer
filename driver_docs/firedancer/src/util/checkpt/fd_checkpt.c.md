<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for initializing, managing, and compressing checkpoint streams with optional LZ4 support.

# Purpose
The code provides functionality for managing checkpoint operations with optional compression using LZ4. It includes functions to initialize and finalize checkpoint streams, handle errors, and manage data buffers. The code supports two modes: memory-mapped I/O (MMIO) and streaming, with the ability to handle different frame styles, including raw and LZ4-compressed frames. The [`fd_checkpt_frame_style_is_supported`](<#fd_checkpt_frame_style_is_supported>) function checks if a given frame style is supported, while [`fd_checkpt_strerror`](<#fd_checkpt_strerror>) provides error messages for various error codes.

The code defines several functions for initializing and finalizing checkpoint streams ([`fd_checkpt_init_stream`](<#fd_checkpt_init_stream>), [`fd_checkpt_init_mmio`](<#fd_checkpt_init_mmio>), and [`fd_checkpt_fini`](<#fd_checkpt_fini>)), opening and closing frames ([`fd_checkpt_open_advanced`](<#fd_checkpt_open_advanced>) and [`fd_checkpt_close_advanced`](<#fd_checkpt_close_advanced>)), and handling data buffers ([`fd_checkpt_private_buf`](<#fd_checkpt_private_buf>), [`fd_checkpt_meta`](<#fd_checkpt_meta>), and [`fd_checkpt_data`](<#fd_checkpt_data>)). The [`fd_checkpt_private_lz4`](<#fd_checkpt_private_lz4>) function is responsible for compressing data using LZ4, optimizing for both small and large buffers. The code uses conditional compilation to include LZ4-related functionality only if the `FD_HAS_LZ4` macro is defined, ensuring compatibility with systems that do not support LZ4.
# Imports and Dependencies

---
- `fd_checkpt.h`
- `lz4.h`


# Functions

---
### fd\_checkpt\_frame\_style\_is\_supported<!-- {{#callable:fd_checkpt_frame_style_is_supported}} -->
[View Source →](<../../../../../src/util/checkpt/fd_checkpt.c#L3>)

Determines if a given frame style is supported based on compile-time options.
- **Inputs**:
    - `frame_style`: An integer representing the frame style to check for support.
- **Logic and Control Flow**:
    - Initialize the `supported` variable to check if `frame_style` is equal to `FD_CHECKPT_FRAME_STYLE_RAW`.
    - If `FD_HAS_LZ4` is defined, update `supported` to also check if `frame_style` is equal to `FD_CHECKPT_FRAME_STYLE_LZ4`.
    - Return the value of `supported`, which indicates if the frame style is supported.
- **Output**: Returns an integer that is non-zero if the frame style is supported, and zero if it is not.


---
### fd\_checkpt\_strerror<!-- {{#callable:fd_checkpt_strerror}} -->
[View Source →](<../../../../../src/util/checkpt/fd_checkpt.c#L13>)

Maps error codes to human-readable error messages for checkpoint operations.
- **Inputs**:
    - `err`: An integer representing the error code to be translated into a string message.
- **Logic and Control Flow**:
    - Use a switch statement to match the input error code `err` with predefined error codes.
    - Return the corresponding string message for each matched error code: 'success', 'bad input args', 'unsupported on this target', 'io error', or 'compression error'.
    - If the error code does not match any predefined cases, return 'unknown'.
- **Output**: A constant character pointer to a string that describes the error message corresponding to the input error code.


---
### fd\_checkpt\_private\_lz4<!-- {{#callable:fd_checkpt_private_lz4}} -->
[View Source →](<../../../../../src/util/checkpt/fd_checkpt.c#L42>)

Compresses a given buffer using LZ4, with optimizations for small buffer handling and header management.
- **Inputs**:
    - `lz4`: A pointer to an `LZ4_stream_t` structure used for LZ4 compression.
    - `_ubuf`: A pointer to the uncompressed input buffer.
    - `ubuf_usz`: The size of the uncompressed input buffer in bytes.
    - `_cbuf`: A pointer to the buffer where the compressed data will be stored.
    - `cbuf_max`: The maximum size of the compressed buffer in bytes.
    - `_gbuf`: A pointer to a gather buffer used for small buffer optimization.
    - `gbuf_sz`: The size of the gather buffer in bytes.
    - `gbuf_thresh`: The threshold size in bytes to determine if a buffer is considered small.
    - `_gbuf_cursor`: A pointer to the current position in the gather buffer.
- **Logic and Control Flow**:
    - Check if `ubuf_usz` is within the valid range and if `cbuf_max` is sufficient to store a header and compressed data.
    - Determine if the buffer is small by comparing `ubuf_usz` with `gbuf_thresh`.
    - If the buffer is small, copy it into the gather buffer and update the gather buffer cursor.
    - Calculate the maximum possible compressed size (`ubuf_csz_max`) and attempt to compress the buffer using `LZ4_compress_fast_continue`.
    - If compression fails or the compressed size exceeds the maximum, log a warning and return 0.
    - Store the compressed size in the first three bytes of the compressed buffer as a 24-bit little-endian integer.
    - Return the total size of the compressed data including the header.
- **Output**: Returns the total size of the compressed data including the header, or 0 if compression fails.


---
### fd\_checkpt\_init\_stream<!-- {{#callable:fd_checkpt_init_stream}} -->
[View Source →](<../../../../../src/util/checkpt/fd_checkpt.c#L180>)

Initializes a checkpoint stream with specified memory, file descriptor, write buffer, and buffer size.
- **Inputs**:
    - `mem`: Pointer to memory where the checkpoint structure will be initialized.
    - `fd`: File descriptor for the stream; must be non-negative.
    - `wbuf`: Pointer to the write buffer used for streaming.
    - `wbuf_sz`: Size of the write buffer; must be greater than or equal to `FD_CHECKPT_WBUF_MIN`.
- **Logic and Control Flow**:
    - Check if `mem` is NULL; if so, log a warning and return NULL.
    - Check if `mem` is aligned to `FD_CHECKPT_ALIGN`; if not, log a warning and return NULL.
    - Check if `fd` is negative; if so, log a warning and return NULL.
    - Check if `wbuf` is NULL; if so, log a warning and return NULL.
    - Check if `wbuf_sz` is less than `FD_CHECKPT_WBUF_MIN`; if so, log a warning and return NULL.
    - If `FD_HAS_LZ4` is defined, create an LZ4 stream; if creation fails, log a warning and return NULL.
    - Initialize the `fd_checkpt_t` structure with the provided parameters and the created LZ4 stream (if applicable).
    - Return the initialized `fd_checkpt_t` structure.
- **Output**: Returns a pointer to the initialized `fd_checkpt_t` structure, or NULL if initialization fails.


---
### fd\_checkpt\_init\_mmio<!-- {{#callable:fd_checkpt_init_mmio}} -->
[View Source →](<../../../../../src/util/checkpt/fd_checkpt.c#L241>)

Initializes a memory-mapped I/O checkpoint structure with optional LZ4 compression support.
- **Inputs**:
    - `mem`: A pointer to the memory where the checkpoint structure will be initialized.
    - `mmio`: A pointer to the memory-mapped I/O region, or NULL if not used.
    - `mmio_sz`: The size of the memory-mapped I/O region, or 0 if not used.
- **Logic and Control Flow**:
    - Check if `mem` is NULL; if so, log a warning and return NULL.
    - Check if `mem` is aligned to `FD_CHECKPT_ALIGN`; if not, log a warning and return NULL.
    - Check if `mmio` is NULL while `mmio_sz` is non-zero; if so, log a warning and return NULL.
    - If LZ4 is available, create an LZ4 stream; if creation fails, log a warning and return NULL.
    - Initialize the `fd_checkpt_t` structure at `mem` with default values and the provided `mmio` and `mmio_sz`.
    - Return the initialized `fd_checkpt_t` structure.
- **Output**: A pointer to the initialized `fd_checkpt_t` structure, or NULL if initialization fails.


---
### fd\_checkpt\_fini<!-- {{#callable:fd_checkpt_fini}} -->
[View Source →](<../../../../../src/util/checkpt/fd_checkpt.c#L290>)

Finalizes a checkpoint by checking its validity and freeing associated resources if applicable.
- **Inputs**:
    - `checkpt`: A pointer to an `fd_checkpt_t` structure representing the checkpoint to finalize.
- **Logic and Control Flow**:
    - Check if `checkpt` is NULL; if so, log a warning and return NULL.
    - Check if `checkpt` is in a frame using [`fd_checkpt_in_frame`](<fd_checkpt.h.md#fd_checkpt_in_frame>); if so, log a warning, set `frame_style` to -1, and return NULL.
    - If `FD_HAS_LZ4` is defined, attempt to free the LZ4 stream associated with `checkpt->lz4` using `LZ4_freeStream`; log a warning if it fails.
    - Return the `checkpt` pointer cast to `void *`.
- **Output**: Returns a `void *` pointer to the `checkpt` if successful, or NULL if an error occurs.
- **Functions Called**:
    - [`fd_checkpt_in_frame`](<fd_checkpt.h.md#fd_checkpt_in_frame>)


---
### fd\_checkpt\_open\_advanced<!-- {{#callable:fd_checkpt_open_advanced}} -->
[View Source →](<../../../../../src/util/checkpt/fd_checkpt.c#L318>)

Opens a checkpoint with a specified frame style and updates the offset.
- **Inputs**:
    - `checkpt`: A pointer to a `fd_checkpt_t` structure representing the checkpoint to open.
    - `frame_style`: An integer representing the desired frame style for the checkpoint.
    - `_off`: A pointer to an unsigned long where the function will store the current offset of the checkpoint.
- **Logic and Control Flow**:
    - Check if `checkpt` is NULL; if so, log a warning and return `FD_CHECKPT_ERR_INVAL`.
    - Check if the checkpoint can be opened using [`fd_checkpt_can_open`](<fd_checkpt.h.md#fd_checkpt_can_open>); if not, log a warning, set `frame_style` to -1, and return `FD_CHECKPT_ERR_INVAL`.
    - Check if `_off` is NULL; if so, log a warning, set `frame_style` to -1, and return `FD_CHECKPT_ERR_INVAL`.
    - Determine the `frame_style` using `fd_int_if`, defaulting to `FD_CHECKPT_FRAME_STYLE_DEFAULT` if `frame_style` is zero.
    - Use a switch statement to handle different `frame_style` cases:
    - For `FD_CHECKPT_FRAME_STYLE_RAW`, do nothing.
    - For `FD_CHECKPT_FRAME_STYLE_LZ4`, reset the LZ4 stream and set `gbuf_cursor` to 0.
    - For unsupported `frame_style`, log a warning, set `frame_style` to -1, and return `FD_CHECKPT_ERR_UNSUP`.
    - Set `checkpt->frame_style` to the determined `frame_style`.
    - Set `*_off` to `checkpt->off`.
    - Return `FD_CHECKPT_SUCCESS`.
- **Output**: Returns an integer status code: `FD_CHECKPT_SUCCESS` on success, `FD_CHECKPT_ERR_INVAL` for invalid inputs, or `FD_CHECKPT_ERR_UNSUP` for unsupported frame styles.
- **Functions Called**:
    - [`fd_checkpt_can_open`](<fd_checkpt.h.md#fd_checkpt_can_open>)


---
### fd\_checkpt\_close\_advanced<!-- {{#callable:fd_checkpt_close_advanced}} -->
[View Source →](<../../../../../src/util/checkpt/fd_checkpt.c#L370>)

Closes a checkpoint frame, flushing any pending data and updating the offset.
- **Inputs**:
    - `checkpt`: A pointer to a `fd_checkpt_t` structure representing the checkpoint to close.
    - `_off`: A pointer to an `ulong` where the function will store the updated offset after closing the checkpoint.
- **Logic and Control Flow**:
    - Check if `checkpt` is NULL; if so, log a warning and return `FD_CHECKPT_ERR_INVAL`.
    - Check if `checkpt` is not in a frame; if so, log a warning, set `frame_style` to -1, and return `FD_CHECKPT_ERR_INVAL`.
    - Check if `_off` is NULL; if so, log a warning, set `frame_style` to -1, and return `FD_CHECKPT_ERR_INVAL`.
    - Retrieve the current offset from `checkpt`.
    - If the checkpoint is in MMIO mode, do nothing further.
    - If the checkpoint is in streaming mode, check if there are pending bytes in the write buffer (`wbuf`).
    - If there are pending bytes, attempt to write them to the file descriptor using `fd_io_write`.
    - If the write fails, log a warning, set `frame_style` to -1, and return `FD_CHECKPT_ERR_IO`.
    - Update the offset with the number of bytes written and check for overflow; if overflow occurs, log a warning, set `frame_style` to -1, and return `FD_CHECKPT_ERR_IO`.
    - Reset the write buffer usage to 0.
    - Update the checkpoint's offset and set `frame_style` to 0, indicating it is not in a frame.
    - Store the updated offset in `_off` and return `FD_CHECKPT_SUCCESS`.
- **Output**: Returns an integer status code: `FD_CHECKPT_SUCCESS` on success, `FD_CHECKPT_ERR_INVAL` for invalid input, or `FD_CHECKPT_ERR_IO` for I/O errors.
- **Functions Called**:
    - [`fd_checkpt_in_frame`](<fd_checkpt.h.md#fd_checkpt_in_frame>)
    - [`fd_checkpt_is_mmio`](<fd_checkpt.h.md#fd_checkpt_is_mmio>)


---
### fd\_checkpt\_private\_buf<!-- {{#callable:fd_checkpt_private_buf}} -->
[View Source →](<../../../../../src/util/checkpt/fd_checkpt.c#L433>)

Validates and processes a buffer for checkpointing, handling different frame styles and modes.
- **Inputs**:
    - `checkpt`: A pointer to a `fd_checkpt_t` structure representing the checkpoint context.
    - `buf`: A pointer to the buffer to be processed.
    - `sz`: The size of the buffer to be processed.
    - `max`: The maximum allowable size for the buffer.
- **Logic and Control Flow**:
    - Check if `checkpt` is NULL; if so, log a warning and return `FD_CHECKPT_ERR_INVAL`.
    - Verify if the checkpoint is in a frame using [`fd_checkpt_in_frame`](<fd_checkpt.h.md#fd_checkpt_in_frame>); if not, log a warning, set `frame_style` to -1, and return `FD_CHECKPT_ERR_INVAL`.
    - If `sz` is zero, return `FD_CHECKPT_SUCCESS` as there is nothing to process.
    - Check if `sz` exceeds `max`; if so, log a warning, set `frame_style` to -1, and return `FD_CHECKPT_ERR_INVAL`.
    - Verify if `buf` is NULL when `sz` is non-zero; if so, log a warning, set `frame_style` to -1, and return `FD_CHECKPT_ERR_INVAL`.
    - Initialize `off` with the current offset from `checkpt`.
    - Switch based on `checkpt->frame_style` to handle different processing modes.
    - For `FD_CHECKPT_FRAME_STYLE_RAW`, check if in mmio mode or streaming mode and process accordingly, updating `off` and handling errors.
    - For `FD_CHECKPT_FRAME_STYLE_LZ4`, if available, handle mmio and streaming modes with LZ4 compression, updating `off` and handling errors.
    - If an unsupported frame style is encountered, log a warning, set `frame_style` to -1, and return `FD_CHECKPT_ERR_UNSUP`.
    - Update `checkpt->off` with the new offset and return `FD_CHECKPT_SUCCESS`.
- **Output**: Returns an integer status code indicating success or the type of error encountered.
- **Functions Called**:
    - [`fd_checkpt_in_frame`](<fd_checkpt.h.md#fd_checkpt_in_frame>)
    - [`fd_checkpt_is_mmio`](<fd_checkpt.h.md#fd_checkpt_is_mmio>)
    - [`fd_checkpt_private_lz4`](<#fd_checkpt_private_lz4>)


---
### fd\_checkpt\_meta<!-- {{#callable:fd_checkpt_meta}} -->
[View Source →](<../../../../../src/util/checkpt/fd_checkpt.c#L624>)

Processes metadata for a checkpoint by writing it to a buffer with a size limit.
- **Inputs**:
    - `checkpt`: A pointer to an `fd_checkpt_t` structure representing the checkpoint.
    - `buf`: A constant pointer to the buffer containing the metadata to be processed.
    - `sz`: An unsigned long integer representing the size of the metadata buffer.
- **Logic and Control Flow**:
    - Calls [`fd_checkpt_private_buf`](<#fd_checkpt_private_buf>) with `checkpt`, `buf`, `sz`, and `FD_CHECKPT_META_MAX` as arguments.
    - Returns the result of the [`fd_checkpt_private_buf`](<#fd_checkpt_private_buf>) function call.
- **Output**: Returns an integer status code indicating success or failure of the metadata processing.
- **Functions Called**:
    - [`fd_checkpt_private_buf`](<#fd_checkpt_private_buf>)


---
### fd\_checkpt\_data<!-- {{#callable:fd_checkpt_data}} -->
[View Source →](<../../../../../src/util/checkpt/fd_checkpt.c#L631>)

Calls [`fd_checkpt_private_buf`](<#fd_checkpt_private_buf>) to process a buffer of data for checkpointing with no size limit.
- **Inputs**:
    - `checkpt`: A pointer to an `fd_checkpt_t` structure representing the checkpoint context.
    - `buf`: A pointer to the buffer containing the data to be checkpointed.
    - `sz`: The size of the buffer in bytes.
- **Logic and Control Flow**:
    - Calls [`fd_checkpt_private_buf`](<#fd_checkpt_private_buf>) with `checkpt`, `buf`, `sz`, and `ULONG_MAX` as arguments.
    - The function does not perform any additional operations or checks beyond this call.
- **Output**: Returns the result of the [`fd_checkpt_private_buf`](<#fd_checkpt_private_buf>) function call, which is an integer status code.
- **Functions Called**:
    - [`fd_checkpt_private_buf`](<#fd_checkpt_private_buf>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)