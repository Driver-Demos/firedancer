<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for checkpoint and restore stream functionality, including various buffer sizes and frame styles.

# Purpose
The code is a C program designed to test the functionality of checkpointing and restoring data streams using file descriptors. It includes various tests for functions related to checkpointing (`fd_checkpt_*`) and restoring (`fd_restore_*`) data, which are likely part of a larger library for handling data persistence and recovery. The program initializes test data, creates temporary files for testing, and performs a series of operations to verify the correct behavior of the checkpoint and restore functions. These operations include opening and closing data frames, writing and reading data, and handling different buffer sizes and styles, such as raw and LZ4-compressed frames.

The program uses a main function to execute a series of tests, logging the progress and results of each test. It checks for various error conditions, such as invalid parameters and unsupported operations, and verifies that the data is correctly written and restored. The code also includes functionality to handle temporary files, ensuring they are cleaned up after the tests are complete. The use of random number generation and buffer manipulation allows for comprehensive testing of the checkpoint and restore processes, ensuring that the functions can handle a wide range of scenarios and data sizes.
# Imports and Dependencies

---
- `../fd_util.h`
- `stdlib.h`
- `errno.h`
- `unistd.h`
- `fcntl.h`
- `sys/stat.h`


# Global Variables

---
### in
- **Type**: ``uchar[]``
- **Description**: An array of unsigned characters with a size defined by the macro `BUF_MAX`. It is used to store input data for processing.
- **Use**: Stores input data for various operations in the program.


---
### out
- **Type**: ``uchar[]``
- **Description**: An array of unsigned characters with a size defined by the macro `BUF_MAX`, which is set to 1048576. This array is used to store data during the execution of the program.
- **Use**: Used as a buffer to hold data for various operations, such as reading and writing data during checkpoint and restore processes.


---
### mmio
- **Type**: ``uchar[]``
- **Description**: `mmio` is a static array of unsigned characters with a size defined by the macro `BUF_MAX`, which is set to 1048576. It is used to store data in memory-mapped I/O operations.
- **Use**: Used to hold data for memory-mapped I/O operations in the program.


---
### rbuf
- **Type**: ``uchar[]``
- **Description**: `rbuf` is a static array of unsigned characters with a size defined by the macro `BUF_MAX`, which is set to 1048576UL. It is used as a buffer for reading operations in the program.
- **Use**: Used as a buffer in the `fd_restore_init_stream` function to handle reading operations from a file descriptor.


---
### wbuf
- **Type**: ``uchar[]``
- **Description**: An array of unsigned characters with a size defined by the macro `BUF_MAX`, which is set to 1048576UL. This array is used as a buffer for writing operations in the program.
- **Use**: Used to store data temporarily during write operations, particularly in the `fd_checkpt_init_stream` function for checkpointing streams.


---
### \_checkpt
- **Type**: ``fd_checkpt_t``
- **Description**: The `_checkpt` variable is a static array of type `fd_checkpt_t` with a size of 1. It is used to manage checkpoint operations in the program.
- **Use**: Used to initialize and manage checkpoint streams for data processing.


---
### \_restore
- **Type**: ``fd_restore_t` array`
- **Description**: An array of type `fd_restore_t` with a single element. This array is used to store the state of a file descriptor restore operation.
- **Use**: Used to initialize and manage the state of file descriptor restore operations in the program.


# Functions

---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/util/checkpt/test_checkpt_stream.c#L22>)

Initializes, configures, and tests checkpoint and restore operations using command-line arguments and random data.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Checks for LZ4 support and logs a warning if not available.
    - Parses command-line arguments for path, mode, keep, data size, mmio size, write buffer size, and read buffer size.
    - Logs the configuration of data, write buffer, and read buffer sizes.
    - Validates that sizes do not exceed `BUF_MAX` and logs errors if they do.
    - Initializes a random number generator `rng`.
    - Creates test data by filling the `in` buffer with random values.
    - Determines the file path for testing, either from command-line or a temporary file, and opens it with specified mode.
    - Unlinks the file if `keep` is not set, ensuring cleanup on program termination.
    - Defines a macro `RESET` to reset the file descriptor position to the start.
    - Tests various checkpoint and restore operations, including initialization, opening, closing, and data handling, with different frame styles (raw and LZ4).
    - Performs end-to-end tests for checkpoint and restore operations with different buffer sizes and frame styles.
    - Tests non-trivial gather/scatter operations to stress test the LZ4 compressor and gather/scatter optimizations.
    - Cleans up by deleting the random number generator and halting the program.
- **Output**: Returns 0 upon successful execution.



---
Made with ❤️ by [Driver](https://www.driver.ai/)