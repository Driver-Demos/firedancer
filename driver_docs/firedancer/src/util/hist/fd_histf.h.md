<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines a fixed-size exponential histogram structure and functions for creating, sampling, and analyzing histograms.

# Purpose
The code defines a C header file for managing fixed-size exponential histograms. It provides functionality to create, manipulate, and query histograms that are bucketed exponentially up to a specified maximum value, with an overflow bucket for values exceeding this maximum. The histograms are designed to efficiently handle a range of values by using a logarithmic scale for bucket boundaries, which allows for a compact representation of data distributions. The code includes functions to initialize a histogram ([`fd_histf_new`](<#fd_histf_new>)), add samples ([`fd_histf_sample`](<#fd_histf_sample>)), and compute statistics such as the count of samples in each bucket, the sum of all samples, and percentile estimates ([`fd_histf_percentile`](<#fd_histf_percentile>)).

The header file defines a structure `fd_histf_t` that holds the histogram data, including an array of bucket counts and precomputed bucket boundaries. The code also provides functions to align and manage memory for the histogram, ensuring that the data structure is correctly formatted and aligned in memory. Additionally, the code includes conditional compilation for SIMD (Single Instruction, Multiple Data) optimizations using AVX instructions, which can improve performance on supported hardware. The histogram operations are designed to be efficient and are implemented with inline functions to minimize overhead.
# Imports and Dependencies

---
- `math.h`
- `../log/fd_log.h`
- `../simd/fd_avx.h`


# Data Structures

---
### fd\_histf\_private
- **Type**: ``struct``
- **Members**:
    - ``counts``: An array of unsigned long integers representing the count of samples in each histogram bucket.
    - ``left_edge``: An array of long integers representing the left edges of the histogram buckets, pre-subtracted by 2^63 for comparison purposes.
    - ``sum``: An unsigned long integer representing the sum of all samples, used for computing the mean.
- **Description**: The `fd_histf_private` structure is used to implement a fixed-size exponential histogram with buckets that are exponentially spaced. It contains an array `counts` to store the number of samples in each bucket, an array `left_edge` to define the boundaries of these buckets, and a `sum` to keep track of the total sum of all samples for mean calculation. The structure is aligned according to `FD_HISTF_ALIGN` to optimize memory access, and it is designed to handle unsigned comparisons by pre-subtracting 2^63 from the bucket edges.


---
### fd\_histf\_t
- **Type**: ``struct``
- **Members**:
    - ``counts``: An array of unsigned long integers representing the count of samples in each bucket.
    - ``left_edge``: An array of long integers representing the left edge of each bucket, pre-subtracted by 2^63 for comparison purposes.
    - ``sum``: An unsigned long integer representing the sum of all samples added to the histogram.
- **Description**: Defines a fixed-size exponential histogram with 16 buckets, where each bucket is exponentially spaced between a minimum and maximum value. The structure includes an overflow bucket for values exceeding the maximum. The `counts` array tracks the number of samples in each bucket, while the `left_edge` array defines the boundaries of these buckets. The `sum` field maintains the total of all sample values, aiding in the calculation of the mean.


# Functions

---
### fd\_histf\_align<!-- {{#callable:fd_histf_align}} -->
[View Source →](<../../../../../src/util/hist/fd_histf.h#L37>)

Returns the alignment requirement for the histogram data structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the constant `FD_HISTF_ALIGN`.
- **Output**: The alignment requirement as an unsigned long integer.


---
### fd\_histf\_footprint<!-- {{#callable:fd_histf_footprint}} -->
[View Source →](<../../../../../src/util/hist/fd_histf.h#L38>)

Returns the constant footprint size of a fixed-size exponential histogram.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the value of the macro `FD_HISTF_FOOTPRINT`.
- **Output**: The function returns an `ulong` representing the footprint size of the histogram.


---
### fd\_histf\_new<!-- {{#callable:fd_histf_new}} -->
[View Source →](<../../../../../src/util/hist/fd_histf.h#L88>)

Initializes a memory region as an exponential histogram with specified minimum and maximum values.
- **Inputs**:
    - `mem`: Pointer to a memory region that will be formatted as a histogram.
    - `min_value`: Minimum value for the histogram buckets, must be greater than 0.
    - `max_value`: Maximum value for the histogram buckets.
- **Logic and Control Flow**:
    - Check if `max_value` is less than or equal to `min_value`; if true, return `NULL`.
    - Set `min_value` to the maximum of `min_value` and 1.
    - Set `max_value` to the maximum of `max_value` and `min_value + FD_HISTF_BUCKET_CNT - 2UL`.
    - Cast `mem` to `fd_histf_t*` and initialize the `counts` array to zero and `sum` to zero.
    - Initialize the `left_edge` array with exponential spacing between `min_value` and `max_value`.
    - Adjust each bucket's left edge to ensure no bucket is empty.
    - Subtract `2^63` from each `left_edge` value and store in the histogram's `left_edge` array.
    - Set the last `left_edge` to `LONG_MAX`.
    - Return the pointer to the initialized histogram.
- **Output**: Pointer to the initialized histogram or `NULL` if `max_value` is less than or equal to `min_value`.


---
### fd\_histf\_join<!-- {{#callable:fd_histf_join}} -->
[View Source →](<../../../../../src/util/hist/fd_histf.h#L120>)

Casts a generic pointer to a `fd_histf_t` pointer.
- **Inputs**:
    - `_hist`: A pointer to a memory region that is expected to be a `fd_histf_t` object.
- **Logic and Control Flow**:
    - Casts the input pointer `_hist` to a `fd_histf_t` pointer type.
- **Output**: Returns the input pointer `_hist` cast to a `fd_histf_t` pointer.


---
### fd\_histf\_leave<!-- {{#callable:fd_histf_leave}} -->
[View Source →](<../../../../../src/util/hist/fd_histf.h#L121>)

Returns the input histogram pointer as a void pointer.
- **Inputs**:
    - `_hist`: A pointer to a `fd_histf_t` histogram structure.
- **Logic and Control Flow**:
    - Casts the `_hist` pointer to a `void` pointer.
    - Returns the casted `void` pointer.
- **Output**: A `void` pointer to the input histogram.


---
### fd\_histf\_delete<!-- {{#callable:fd_histf_delete}} -->
[View Source →](<../../../../../src/util/hist/fd_histf.h#L122>)

Returns the input pointer `_hist` without modification.
- **Inputs**:
    - `_hist`: A pointer to a memory region representing a histogram.
- **Logic and Control Flow**:
    - The function takes a single input pointer `_hist`.
    - It returns the same pointer `_hist` without any changes.
- **Output**: The same pointer `_hist` that was passed as input.


---
### fd\_histf\_bucket\_cnt<!-- {{#callable:fd_histf_bucket_cnt}} -->
[View Source →](<../../../../../src/util/hist/fd_histf.h#L126>)

Returns the number of buckets in the histogram, including the overflow bucket.
- **Inputs**:
    - ``hist``: A pointer to an `fd_histf_t` structure representing the histogram.
- **Logic and Control Flow**:
    - The function takes a pointer to an `fd_histf_t` structure as input, but does not use it in its logic.
    - It returns the constant `FD_HISTF_BUCKET_CNT`, which is defined as `16UL`.
- **Output**: The function returns an `ulong` representing the total number of buckets in the histogram, which is `16UL`.


---
### fd\_histf\_sample<!-- {{#callable:fd_histf_sample}} -->
[View Source →](<../../../../../src/util/hist/fd_histf.h#L130>)

Adds a sample to a fixed-size exponential histogram and updates the appropriate bucket count.
- **Inputs**:
    - ``hist``: A pointer to an `fd_histf_t` structure representing the histogram.
    - ``value``: An unsigned long integer representing the sample value to add to the histogram.
- **Logic and Control Flow**:
    - Add `value` to `hist->sum`.
    - Calculate `shifted_v` by subtracting `2^63` from `value`.
    - If `FD_HAS_AVX` is defined, use AVX instructions to broadcast `shifted_v` and compare it against `hist->left_edge` values to determine the appropriate bucket.
    - Use logical operations to select the correct bucket and update the count by subtracting the result from the current count.
    - If `FD_HAS_AVX` is not defined, iterate over each bucket and update the count if `shifted_v` falls within the bucket's range.
- **Output**: No return value; the function updates the histogram in place.


---
### fd\_histf\_cnt<!-- {{#callable:fd_histf_cnt}} -->
[View Source →](<../../../../../src/util/hist/fd_histf.h#L169>)

Retrieves the count of samples in a specified bucket of the histogram.
- **Inputs**:
    - `hist`: A pointer to a constant `fd_histf_t` structure representing the histogram.
    - `b`: An unsigned long integer representing the index of the bucket for which the sample count is requested.
- **Logic and Control Flow**:
    - Accesses the `counts` array of the `fd_histf_t` structure using the bucket index `b`.
    - Returns the value at the specified index `b` from the `counts` array.
- **Output**: The function returns an unsigned long integer representing the number of samples in the specified bucket.


---
### fd\_histf\_left<!-- {{#callable:fd_histf_left}} -->
[View Source →](<../../../../../src/util/hist/fd_histf.h#L170>)

Calculates the left edge of a specified histogram bucket, adjusted by a constant shift.
- **Inputs**:
    - `hist`: A pointer to a constant `fd_histf_t` structure representing the histogram.
    - `b`: An unsigned long integer representing the index of the bucket for which the left edge is calculated.
- **Logic and Control Flow**:
    - Accesses the `left_edge` array of the `fd_histf_t` structure at index `b`.
    - Adds a constant value `(1UL<<63)` to the accessed `left_edge` value to adjust it.
- **Output**: Returns the adjusted left edge of the specified bucket as an unsigned long integer.


---
### fd\_histf\_right<!-- {{#callable:fd_histf_right}} -->
[View Source →](<../../../../../src/util/hist/fd_histf.h#L171>)

Calculates the right edge of a specified histogram bucket, adjusted by adding 2^63.
- **Inputs**:
    - `hist`: A pointer to a constant `fd_histf_t` structure representing the histogram.
    - `b`: An unsigned long integer representing the index of the bucket for which the right edge is calculated.
- **Logic and Control Flow**:
    - Access the `left_edge` array of the `hist` structure at index `b+1` to get the pre-subtracted right edge of the bucket.
    - Convert the value from `long` to `ulong` and add 2^63 to adjust for the pre-subtraction done during histogram initialization.
- **Output**: Returns an unsigned long integer representing the right edge of the specified bucket, adjusted by adding 2^63.


---
### fd\_histf\_sum<!-- {{#callable:fd_histf_sum}} -->
[View Source →](<../../../../../src/util/hist/fd_histf.h#L172>)

Retrieves the sum of all samples added to the histogram.
- **Inputs**:
    - ``hist``: A pointer to a constant `fd_histf_t` structure representing the histogram.
- **Logic and Control Flow**:
    - Accesses the `sum` field of the `fd_histf_t` structure pointed to by `hist`.
    - Returns the value of the `sum` field.
- **Output**: The function returns an `ulong` representing the sum of all samples in the histogram.


---
### fd\_histf\_percentile<!-- {{#callable:fd_histf_percentile}} -->
[View Source →](<../../../../../src/util/hist/fd_histf.h#L181>)

Calculates the percentile estimate from a fixed-size exponential histogram, returning a sentinel value for overflow conditions.
- **Inputs**:
    - ``hist``: A pointer to a `fd_histf_t` structure representing the histogram from which to calculate the percentile.
    - ``percentile``: An unsigned char representing the desired percentile (0 to 100) to calculate.
    - ``sentinel``: A ulong value to return if the percentile calculation encounters an overflow condition.
- **Logic and Control Flow**:
    - Check if `percentile` is greater than 100 and log an error if true.
    - Initialize `total_sample_cnt` to zero and iterate over all histogram buckets to sum up the sample counts.
    - Return `sentinel` if `total_sample_cnt` is zero, indicating no samples in the histogram.
    - Calculate `rank` using the `MAP` macro to map the `percentile` to a rank within the total sample count.
    - Iterate over the histogram buckets, summing the counts until `sum` exceeds `rank`.
    - If the current bucket is the underflow bucket (index 0), use linear interpolation to estimate the percentile and return the result.
    - If the current bucket is the overflow bucket (last index), return the `sentinel` value.
    - For other buckets, calculate the `max_value` and use exponential interpolation to estimate the percentile, then return the result.
    - Log an error if the function reaches an unreachable state.
- **Output**: Returns a ulong value representing the estimated percentile value from the histogram, or the `sentinel` value if the percentile falls in the overflow bucket.
- **Functions Called**:
    - [`fd_histf_cnt`](<#fd_histf_cnt>)
    - [`fd_histf_left`](<#fd_histf_left>)
    - [`fd_histf_right`](<#fd_histf_right>)


---
### fd\_histf\_subtract<!-- {{#callable:fd_histf_subtract}} -->
[View Source →](<../../../../../src/util/hist/fd_histf.h#L235>)

Subtracts the sample counts and sum of `prefix_hist` from `hist` and stores the result in `out`.
- **Inputs**:
    - ``hist``: A pointer to a `fd_histf_t` structure representing the main histogram.
    - ``prefix_hist``: A pointer to a `fd_histf_t` structure representing the prefix histogram to subtract from `hist`.
    - ``out``: A pointer to a `fd_histf_t` structure where the result of the subtraction will be stored.
- **Logic and Control Flow**:
    - Subtracts the `sum` of `prefix_hist` from the `sum` of `hist` and assigns the result to `out->sum`.
    - Iterates over each bucket index `b` from 0 to `FD_HISTF_BUCKET_CNT - 1`, subtracting `prefix_hist->counts[b]` from `hist->counts[b]` and storing the result in `out->counts[b]`.
    - Copies the `left_edge` values from `hist` to `out` for each bucket index `b`.
- **Output**: The function does not return a value; it modifies the `out` histogram in place.



---
Made with ❤️ by [Driver](https://www.driver.ai/)