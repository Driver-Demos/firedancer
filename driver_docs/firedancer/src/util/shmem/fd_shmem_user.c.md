<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Shared memory management functions for joining, leaving, and querying shared memory regions.

# Purpose
The code is a C module that manages shared memory regions in a hosted environment. It provides functions to join, leave, and query shared memory regions, as well as to handle anonymous shared memory joins. The module uses a private map to track shared memory regions and their associated metadata, such as reference counts, page sizes, and memory addresses. The key functions include [`fd_shmem_join`](<#fd_shmem_join>), which maps a shared memory region into the process's address space, and [`fd_shmem_leave`](<#fd_shmem_leave>), which unmaps a region and updates the reference count. The module also includes utility functions for querying shared memory regions by name, join handle, or address range.

The code defines several static and inline functions to support its operations, such as [`fd_shmem_private_key`](<#fd_shmem_private_key>) for generating keys from region names and [`fd_shmem_private_map_query_by_join`](<#fd_shmem_private_map_query_by_join>) for looking up join information by join handle. It uses system calls like `mmap` and `munmap` to manage memory mappings and includes error handling to log warnings and errors. The module is designed to be used in a multi-threaded environment, with locks (`FD_SHMEM_LOCK` and `FD_SHMEM_UNLOCK`) to ensure thread safety when accessing shared data structures.
# Imports and Dependencies

---
- `fd_shmem_private.h`
- `errno.h`
- `unistd.h`
- `fcntl.h`
- `sys/mman.h`
- `sys/random.h`
- `../tmpl/fd_map.c`


# Global Variables

---
### fd\_shmem\_private\_key\_null
- **Type**: ``fd_shmem_private_key_t const``
- **Description**: A constant of type `fd_shmem_private_key_t` that is initialized to zero at the start of a thread group. It serves as a null or default value for shared memory private keys.
- **Use**: Used as a null key in shared memory operations to represent an uninitialized or default state.


---
### fd\_shmem\_private\_map
- **Type**: ``fd_shmem_join_info_t` array`
- **Description**: An array of `fd_shmem_join_info_t` structures, each representing information about a shared memory region that has been joined by the thread group. The array is initialized to be empty at the start of the thread group.
- **Use**: Used to store and manage information about shared memory regions that are joined by the thread group.


---
### fd\_shmem\_private\_map\_cnt
- **Type**: `ulong`
- **Description**: A static global variable that is initialized to 0 at the start of a thread group.
- **Use**: Tracks the number of currently active shared memory mappings in the `fd_shmem_private_map`.


# Functions

---
### fd\_shmem\_private\_key<!-- {{#callable:fd_shmem_private_key}} -->
[View Source →](<../../../../../src/util/shmem/fd_shmem_user.c#L22>)

Converts a shared memory region name into a valid key and stores it in the provided key structure.
- **Inputs**:
    - `key`: A pointer to an `fd_shmem_private_key_t` structure where the function will store the converted key.
    - `name`: A constant character pointer to the shared memory region name to be converted into a key.
- **Logic and Control Flow**:
    - Calculate the length of the shared memory region name using [`fd_shmem_name_len`](<fd_shmem_admin.c.md#fd_shmem_name_len>) function.
    - If the length is zero, return `NULL` indicating an invalid name.
    - Initialize the `cstr` field of the `key` structure to zero using `fd_memset`.
    - Copy the valid name into the `cstr` field of the `key` structure using `fd_memcpy`.
    - Return the pointer to the `key` structure.
- **Output**: Returns a pointer to the `fd_shmem_private_key_t` structure containing the valid key, or `NULL` if the name is invalid.
- **Functions Called**:
    - [`fd_shmem_name_len`](<fd_shmem_admin.c.md#fd_shmem_name_len>)


---
### fd\_shmem\_private\_map\_query\_by\_join<!-- {{#callable:fd_shmem_private_map_query_by_join}} -->
[View Source →](<../../../../../src/util/shmem/fd_shmem_user.c#L56>)

Searches for a shared memory join information entry in a map by its join handle and returns it if found, otherwise returns a default value.
- **Inputs**:
    - ``map``: A pointer to an array of `fd_shmem_join_info_t` structures representing the shared memory map.
    - ``join``: A constant pointer to the join handle to search for in the map.
    - ``def``: A pointer to a default `fd_shmem_join_info_t` structure to return if the join handle is not found in the map.
- **Logic and Control Flow**:
    - Iterates over each slot in the `map` array up to `FD_SHMEM_PRIVATE_MAP_SLOT_CNT`.
    - Checks if the key in the current slot is valid and if the join handle matches the `join` parameter.
    - If both conditions are true, returns a pointer to the current slot's `fd_shmem_join_info_t` structure.
    - If no matching join handle is found after checking all slots, returns the `def` parameter.
- **Output**: A pointer to the `fd_shmem_join_info_t` structure in the map that matches the join handle, or the `def` parameter if no match is found.


---
### fd\_shmem\_private\_map\_query\_by\_addr<!-- {{#callable:fd_shmem_private_map_query_by_addr}} -->
[View Source →](<../../../../../src/util/shmem/fd_shmem_user.c#L65>)

Searches a shared memory map for a region that overlaps with a specified address range and returns the corresponding join information.
- **Inputs**:
    - ``map``: A pointer to an array of `fd_shmem_join_info_t` structures representing the shared memory map.
    - ``a0``: The starting address of the range to query.
    - ``a1``: The ending address of the range to query, assumed to be greater than or equal to `a0`.
    - ``def``: A default pointer to return if no matching region is found.
- **Logic and Control Flow**:
    - Iterate over each slot in the shared memory map up to `FD_SHMEM_PRIVATE_MAP_SLOT_CNT`.
    - For each slot, calculate the start (`j0`) and end (`j1`) addresses of the memory region using the `shmem`, `page_sz`, and `page_cnt` fields of the current slot.
    - Check if the slot's key is valid and if the queried address range `[a0, a1]` overlaps with the region `[j0, j1]`.
    - If a valid overlapping region is found, return a pointer to the corresponding `fd_shmem_join_info_t` structure.
    - If no overlapping region is found after checking all slots, return the default pointer `def`.
- **Output**: A pointer to the `fd_shmem_join_info_t` structure of the matching region, or `def` if no match is found.


---
### fd\_shmem\_private\_grab\_region<!-- {{#callable:fd_shmem_private_grab_region}} -->
[View Source →](<../../../../../src/util/shmem/fd_shmem_user.c#L87>)

Attempts to map a memory region at a specified address and size with given protection flags, ensuring the region is unmapped before mapping.
- **Inputs**:
    - `addr`: The starting address of the memory region to map.
    - `size`: The size of the memory region to map.
    - `prot`: The protection flags for the memory mapping, such as read, write, or execute permissions.
- **Logic and Control Flow**:
    - Call `mmap` to attempt to map the memory region at the specified `addr` with `size` and `prot` using `MAP_ANON|MAP_PRIVATE` flags.
    - Check if `mmap` returns `MAP_FAILED`, indicating a failure to map the region, and return `MAP_FAILED` if so.
    - Verify if the returned address from `mmap` matches the requested `addr`.
    - If the addresses do not match, call `munmap` to unmap the temporary mapping and log an error if `munmap` fails.
    - Return `MAP_FAILED` if the addresses do not match after unmapping.
    - Return the mapped address if successful.
- **Output**: Returns a pointer to the mapped memory region on success, or `MAP_FAILED` on failure.


---
### fd\_shmem\_private\_map\_rand<!-- {{#callable:fd_shmem_private_map_rand}} -->
[View Source →](<../../../../../src/util/shmem/fd_shmem_user.c#L104>)

Attempts to map a random memory region of specified size and alignment with given protection settings.
- **Inputs**:
    - `size`: The size of the memory region to map.
    - `align`: The alignment requirement for the starting address of the memory region.
    - `prot`: The protection settings for the memory region (e.g., read, write permissions).
- **Logic and Control Flow**:
    - Initialize `ret_addr` to 0.
    - Iterate up to 1000 times to find a suitable random address.
    - In each iteration, use `getrandom` to generate a random address and store it in `ret_addr`.
    - Check if `getrandom` successfully generated the address; if not, log an error and exit.
    - Mask `ret_addr` to assume a 47-bit virtual address space.
    - Align `ret_addr` to the specified alignment using `fd_ulong_align_up`.
    - Attempt to map the memory region at `ret_addr` using [`fd_shmem_private_grab_region`](<#fd_shmem_private_grab_region>).
    - If mapping is successful, return the address as a pointer.
    - If no suitable address is found after 1000 attempts, log an error and exit.
- **Output**: Returns a pointer to the mapped memory region if successful, otherwise logs an error and exits.
- **Functions Called**:
    - [`fd_shmem_private_grab_region`](<#fd_shmem_private_grab_region>)


---
### fd\_shmem\_join<!-- {{#callable:fd_shmem_join}} -->
[View Source →](<../../../../../src/util/shmem/fd_shmem_user.c#L130>)

Joins a shared memory region by mapping it into the process's address space and managing its reference count.
- **Inputs**:
    - `name`: A constant character pointer representing the name of the shared memory region to join.
    - `mode`: An integer specifying the join mode, either `FD_SHMEM_JOIN_MODE_READ_ONLY` or `FD_SHMEM_JOIN_MODE_READ_WRITE`.
    - `join_func`: A function pointer to a join/leave function that can modify the join process, or NULL if not used.
    - `context`: A pointer to user-defined data passed to the `join_func`.
    - `opt_info`: A pointer to an `fd_shmem_join_info_t` structure to store optional join information, or NULL if not used.
- **Logic and Control Flow**:
    - Checks if the `name` is valid and converts it to a private key using `fd_shmem_private_key`.
    - Validates the `mode` to ensure it is either read-only or read-write.
    - Locks the shared memory system using `FD_SHMEM_LOCK`.
    - Queries the existing mapping for the given key using `fd_shmem_private_map_query`.
    - If a mapping exists, increments the reference count and returns the join address.
    - If no mapping exists, checks if there is room for a new mapping.
    - Queries the shared memory region information using [`fd_shmem_info`](<fd_shmem.h.md#fd_shmem_info>).
    - Opens the shared memory file and maps it into the process's address space using `mmap`.
    - Validates the memory mapping and aligns it to the page size.
    - Locks the mapped region in DRAM and advises the kernel not to dump it.
    - Inserts the new mapping into the private map and updates the reference count.
    - Calls the `join_func` if provided, otherwise uses the mapped address as the join address.
    - Unlocks the shared memory system using `FD_SHMEM_UNLOCK` and returns the join address.
- **Output**: Returns a pointer to the joined shared memory region, or NULL if the join operation fails.
- **Functions Called**:
    - [`fd_shmem_info`](<fd_shmem.h.md#fd_shmem_info>)
    - [`fd_shmem_private_path`](<fd_shmem_private.h.md#fd_shmem_private_path>)
    - [`fd_shmem_private_map_rand`](<#fd_shmem_private_map_rand>)


---
### fd\_shmem\_leave<!-- {{#callable:fd_shmem_leave}} -->
[View Source →](<../../../../../src/util/shmem/fd_shmem_user.c#L287>)

Manages the process of leaving a shared memory region by updating reference counts, invoking a leave function if provided, and unmapping the memory.
- **Inputs**:
    - `join`: A pointer to the shared memory region to leave.
    - `leave_func`: A function pointer to a leave function that is called if provided.
    - `context`: A pointer to user-defined data passed to the leave function.
- **Logic and Control Flow**:
    - Check if `join` is NULL and log a warning if true, then return 1.
    - Acquire a lock on shared memory operations with `FD_SHMEM_LOCK`.
    - Check if there are no current joins (`fd_shmem_private_map_cnt` is zero) and log a warning if true, then return 1.
    - Query the shared memory map for the `join` pointer to get `join_info`; if not found, log a warning and return 1.
    - Check the reference count (`ref_cnt`) of `join_info`; if greater than 1, decrement it, release the lock, and return 0.
    - If `ref_cnt` is -1, log a circular dependency warning, release the lock, and return 1.
    - Log a warning if `ref_cnt` is not 1, which should be impossible, and continue.
    - Store `name`, `shmem`, `page_sz`, and `page_cnt` from `join_info` to local variables.
    - If `leave_func` is provided, set `ref_cnt` to -1 to mark join/leave in progress, and call `leave_func`.
    - Calculate the size `sz` as `page_sz * page_cnt` and attempt to unmap the memory with `munmap`; log a warning and set `error` to 1 if it fails.
    - Remove `join_info` from the shared memory map and decrement `fd_shmem_private_map_cnt`.
    - Release the lock with `FD_SHMEM_UNLOCK` and return `error`.
- **Output**: Returns 0 on success or 1 if an error occurs during the leave process.
- **Functions Called**:
    - [`fd_shmem_private_map_query_by_join`](<#fd_shmem_private_map_query_by_join>)


---
### fd\_shmem\_join\_query\_by\_name<!-- {{#callable:fd_shmem_join_query_by_name}} -->
[View Source →](<../../../../../src/util/shmem/fd_shmem_user.c#L347>)

Queries shared memory join information by name and optionally returns it.
- **Inputs**:
    - `name`: A constant character pointer representing the name of the shared memory region to query.
    - `opt_info`: A pointer to `fd_shmem_join_info_t` where the function can store the join information if found; it can be NULL if the caller does not need the information.
- **Logic and Control Flow**:
    - Convert the `name` to a private key using `fd_shmem_private_key` function.
    - If the key conversion fails, return `EINVAL`.
    - Lock the shared memory using `FD_SHMEM_LOCK`.
    - Check if there are any mappings in `fd_shmem_private_map_cnt`; if not, unlock and return `ENOENT`.
    - Query the `fd_shmem_private_map` for the join information using the key.
    - If no join information is found, unlock and return `ENOENT`.
    - If `opt_info` is not NULL, copy the found join information to `opt_info`.
    - Unlock the shared memory using `FD_SHMEM_UNLOCK`.
    - Return 0 to indicate success.
- **Output**: Returns 0 on success, `EINVAL` if the key conversion fails, or `ENOENT` if no join information is found.


---
### fd\_shmem\_join\_query\_by\_join<!-- {{#callable:fd_shmem_join_query_by_join}} -->
[View Source →](<../../../../../src/util/shmem/fd_shmem_user.c#L364>)

Queries shared memory join information by a join handle and optionally returns it.
- **Inputs**:
    - `join`: A pointer to the join handle to query.
    - `opt_info`: An optional pointer to a `fd_shmem_join_info_t` structure to store the join information if found.
- **Logic and Control Flow**:
    - Check if `join` is NULL; if so, return `EINVAL`.
    - Lock the shared memory map using `FD_SHMEM_LOCK`.
    - Check if there are no entries in the shared memory map; if so, unlock and return `ENOENT`.
    - Query the shared memory map for the join handle using [`fd_shmem_private_map_query_by_join`](<#fd_shmem_private_map_query_by_join>).
    - If the join information is not found, unlock and return `ENOENT`.
    - If `opt_info` is provided, copy the found join information into it.
    - Unlock the shared memory map using `FD_SHMEM_UNLOCK`.
    - Return 0 to indicate success.
- **Output**: Returns 0 on success, `EINVAL` if `join` is NULL, or `ENOENT` if the join information is not found.
- **Functions Called**:
    - [`fd_shmem_private_map_query_by_join`](<#fd_shmem_private_map_query_by_join>)


---
### fd\_shmem\_join\_query\_by\_addr<!-- {{#callable:fd_shmem_join_query_by_addr}} -->
[View Source →](<../../../../../src/util/shmem/fd_shmem_user.c#L380>)

Queries shared memory join information based on a memory address range.
- **Inputs**:
    - `addr`: A pointer to the starting address of the memory range to query.
    - `sz`: The size of the memory range to query.
    - `opt_info`: An optional pointer to a `fd_shmem_join_info_t` structure to store the join information if found.
- **Logic and Control Flow**:
    - Check if `sz` is zero; if true, return `ENOENT` indicating an empty range.
    - Calculate the end address `a1` by adding `sz` to `addr` and subtracting one; check for cyclic wrap by verifying if `a1` is less than `a0`; if true, return `EINVAL`.
    - Lock the shared memory map using `FD_SHMEM_LOCK`.
    - Check if there are no entries in the shared memory map; if true, unlock and return `ENOENT`.
    - Query the shared memory map for join information using [`fd_shmem_private_map_query_by_addr`](<#fd_shmem_private_map_query_by_addr>) with the address range `a0` to `a1`.
    - If no join information is found, unlock and return `ENOENT`.
    - If `opt_info` is not null, copy the found join information into `opt_info`.
    - Unlock the shared memory map using `FD_SHMEM_UNLOCK`.
    - Return 0 to indicate success.
- **Output**: Returns 0 on success, `ENOENT` if the range is empty or no join information is found, and `EINVAL` if there is a cyclic wrap in the address range.
- **Functions Called**:
    - [`fd_shmem_private_map_query_by_addr`](<#fd_shmem_private_map_query_by_addr>)


---
### fd\_shmem\_join\_anonymous<!-- {{#callable:fd_shmem_join_anonymous}} -->
[View Source →](<../../../../../src/util/shmem/fd_shmem_user.c#L400>)

Joins an anonymous shared memory region with specified parameters, ensuring it is not already mapped and there is enough room for the join.
- **Inputs**:
    - `name`: A constant character pointer representing the name of the shared memory region.
    - `mode`: An integer specifying the join mode, either `FD_SHMEM_JOIN_MODE_READ_ONLY` or `FD_SHMEM_JOIN_MODE_READ_WRITE`.
    - `join`: A pointer to the join handle, which must not be NULL.
    - `mem`: A pointer to the memory to be joined, which must not be NULL and must be aligned to `page_sz`.
    - `page_sz`: An unsigned long representing the size of each page, which must be a supported page size.
    - `page_cnt`: An unsigned long representing the number of pages, which must be greater than zero and not exceed `ULONG_MAX/page_sz`.
- **Logic and Control Flow**:
    - Validate input arguments including `name`, `mode`, `join`, `mem`, `page_sz`, and `page_cnt` for correctness and alignment.
    - Calculate the total size `sz` of the memory region and check for address range validity.
    - Lock shared memory operations with `FD_SHMEM_LOCK`.
    - Query existing mappings to ensure the region is not already joined, the join handle is not in use, and the memory is not already mapped.
    - Check if there is enough room for a new join in the shared memory map.
    - Attempt to insert the new join into the shared memory map, incrementing the map count.
    - Unlock shared memory operations with `FD_SHMEM_UNLOCK`.
- **Output**: Returns 0 on success, or `EINVAL` if any validation or mapping checks fail.
- **Functions Called**:
    - [`fd_shmem_is_page_sz`](<fd_shmem.h.md#fd_shmem_is_page_sz>)
    - [`fd_shmem_private_map_query_by_join`](<#fd_shmem_private_map_query_by_join>)
    - [`fd_shmem_private_map_query_by_addr`](<#fd_shmem_private_map_query_by_addr>)
    - [`fd_shmem_info`](<fd_shmem.h.md#fd_shmem_info>)


---
### fd\_shmem\_leave\_anonymous<!-- {{#callable:fd_shmem_leave_anonymous}} -->
[View Source →](<../../../../../src/util/shmem/fd_shmem_user.c#L520>)

Removes an anonymous shared memory join from the private map if it is valid and has a reference count of 1.
- **Inputs**:
    - ``join``: A pointer to the join handle that identifies the shared memory region to leave.
    - ``opt_info``: An optional pointer to a `fd_shmem_join_info_t` structure to store information about the join being left.
- **Logic and Control Flow**:
    - Check if `join` is NULL; if so, log a warning and return `EINVAL`.
    - Acquire a lock using `FD_SHMEM_LOCK`.
    - Check if there are no current joins (`fd_shmem_private_map_cnt` is zero); if so, release the lock, log a warning, and return `EINVAL`.
    - Query the private map for the join information using [`fd_shmem_private_map_query_by_join`](<#fd_shmem_private_map_query_by_join>); if not found, release the lock, log a warning, and return `EINVAL`.
    - Check if the reference count (`ref_cnt`) of the join is not 1; if so, release the lock, log a warning, and return `EINVAL`.
    - If `opt_info` is provided, copy the join information to `opt_info` and set its `ref_cnt` to 0.
    - Remove the join information from the private map using `fd_shmem_private_map_remove`.
    - Decrement the join count (`fd_shmem_private_map_cnt`).
    - Release the lock using `FD_SHMEM_UNLOCK`.
    - Return 0 to indicate success.
- **Output**: Returns 0 on success or `EINVAL` if an error occurs.
- **Functions Called**:
    - [`fd_shmem_private_map_query_by_join`](<#fd_shmem_private_map_query_by_join>)


---
### fd\_shmem\_iter\_begin<!-- {{#callable:fd_shmem_iter_begin}} -->
[View Source →](<../../../../../src/util/shmem/fd_shmem_user.c#L561>)

Finds the first valid shared memory join information entry in the private map.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize a pointer `map` to the start of the `fd_shmem_private_map`.
    - Iterate over each slot index from 0 to `FD_SHMEM_PRIVATE_MAP_SLOT_CNT`.
    - For each slot, check if the key is valid using `fd_shmem_private_map_key_inval`.
    - If a valid key is found, return a pointer to the corresponding `fd_shmem_join_info_t` entry.
    - If no valid entry is found, return `NULL`.
- **Output**: A pointer to the first valid `fd_shmem_join_info_t` entry or `NULL` if none is found.


---
### fd\_shmem\_iter\_next<!-- {{#callable:fd_shmem_iter_next}} -->
[View Source →](<../../../../../src/util/shmem/fd_shmem_user.c#L570>)

Iterates over the shared memory map to find the next valid entry after the given iterator.
- **Inputs**:
    - `iter`: A pointer to the current `fd_shmem_join_info_t` entry in the shared memory map.
- **Logic and Control Flow**:
    - Calculate the starting index in the map by subtracting the base address of the map from the `iter` pointer and adding 1.
    - Iterate over the map starting from the calculated index up to `FD_SHMEM_PRIVATE_MAP_SLOT_CNT`.
    - Check if the key of the current map entry is valid using `fd_shmem_private_map_key_inval`.
    - If a valid key is found, return a pointer to the current map entry.
    - If no valid entry is found, return `NULL`.
- **Output**: A pointer to the next valid `fd_shmem_join_info_t` entry in the map, or `NULL` if no valid entry is found.



---
Made with ❤️ by [Driver](https://www.driver.ai/)