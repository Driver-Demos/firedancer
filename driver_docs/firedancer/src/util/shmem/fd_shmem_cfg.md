<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Bash script for managing shared memory IPC domains with commands for initialization, allocation, querying, and cleanup.

# Purpose
This Bash script manages shared memory using huge pages on a Linux system. It provides several commands to initialize, finalize, allocate, free, query, and reset shared memory regions. The script uses the `hugetlbfs` filesystem to manage large memory pages, which are beneficial for applications requiring large contiguous memory blocks. The script supports three types of pages: `normal`, `huge`, and `gigantic`, each with different sizes.

The script defines several functions to handle different operations. The `init` function sets up the necessary directories and mounts for shared memory, while the `fini` function cleans up these resources. The `alloc` function reserves a specified number of huge pages on a given NUMA node, and the `free` function releases them. The `query` function provides information about the current usage of shared memory, and the `reset` function removes all named shared memory regions. The script also includes a `try_defrag_memory` function to attempt memory defragmentation, which can help in allocating large contiguous memory blocks.

The script is designed to be run with superuser privileges due to the nature of the operations it performs, such as mounting filesystems and changing permissions. It uses environment variables, such as `FD_SHMEM_PATH`, to determine the mount path for shared memory, defaulting to `/mnt/.fd` if not specified. The script also provides a `help` command to guide users on how to use the available commands and their arguments.
# Global Variables

---
### SHMEM\_PATH
- **Type**: `string`
- **Description**: `SHMEM_PATH` is a global variable that stores the path for the hugetlbfs mount. It is set to the value of the environment variable `FD_SHMEM_PATH` if it is provided; otherwise, it defaults to "/mnt/.fd".
- **Use**: Used to determine the file system path for shared memory operations in the script.


---
### ALL\_TYPES
- **Type**: ``string``
- **Description**: Contains a space-separated list of page types: 'gigantic', 'huge', and 'normal'. These types represent different sizes of memory pages used in the script for shared memory operations.
- **Use**: Used to iterate over different page types for memory operations such as initialization, allocation, and querying.


---
### BIN
- **Type**: `string`
- **Description**: The `BIN` variable stores the directory path of the script being executed. It uses the `dirname` command to extract the directory name from the `$BASH_SOURCE` variable, which contains the path of the script.
- **Use**: Stores the directory path of the script for use in constructing command paths.


---
### NUMA\_CNT
- **Type**: ``string``
- **Description**: Stores the output of the command `$BIN/fd_shmem_ctl numa-cnt --log-path "" 2> /dev/null`, which is expected to be a count of NUMA nodes available on the system. The command is executed in the shell and its output is captured into the variable.
- **Use**: Used to determine the number of NUMA nodes for operations that require NUMA node-specific information, such as querying or allocating memory pages.


# Functions

---
### get\_page\_size
Determines the page size in bytes for a given page type.
- **Inputs**:
    - `$1`: The type of page, which can be 'normal', 'huge', or 'gigantic'.
- **Logic and Control Flow**:
    - Check if the input page type is 'normal'; if true, output 4096.
    - Check if the input page type is 'huge'; if true, output 2097152.
    - Check if the input page type is 'gigantic'; if true, output 1073741824.
    - If the input page type is not supported, output an error message and exit with status 1.
- **Output**: Outputs the size of the page in bytes or an error message if the page type is unsupported.


---
### get\_page\_path
Generates the file path for hugepages based on the page type and NUMA node.
- **Inputs**:
    - `$1`: The type of page, which can be either 'huge' or 'gigantic'.
    - `$2`: The NUMA node number to specify the node for which the path is generated.
- **Logic and Control Flow**:
    - Checks if the page type `$1` is 'huge'.
    - If true, it returns the path `/sys/devices/system/node/node$2/hugepages/hugepages-2048kB`.
    - If the page type `$1` is 'gigantic', it returns the path `/sys/devices/system/node/node$2/hugepages/hugepages-1048576kB`.
    - If the page type `$1` is neither 'huge' nor 'gigantic', it outputs an error message and exits with status 1.
- **Output**: Returns the file path for the specified hugepage type and NUMA node, or exits with an error if the page type is unsupported.


---
### get\_page\_total
Retrieves the total number of huge pages of a specified type and NUMA node.
- **Inputs**:
    - `$1`: The type of huge page, which can be 'huge' or 'gigantic'.
    - `$2`: The NUMA node number to query for huge pages.
- **Logic and Control Flow**:
    - Calls the `get_page_path` function with the provided page type and NUMA node to get the path to the huge pages information.
    - Uses the `cat` command to read the `nr_hugepages` file at the path returned by `get_page_path`, which contains the total number of huge pages.
    - Checks the exit status of the `cat` command to determine if the operation was successful.
    - If the `cat` command fails (exit status is not 0), prints an error message and exits with status 1.
- **Output**: The total number of huge pages for the specified type and NUMA node, printed to standard output.


---
### get\_page\_free
Retrieves the number of free huge pages of a specified type on a specified NUMA node.
- **Inputs**:
    - `$1`: The type of huge page, either 'huge' or 'gigantic'.
    - `$2`: The NUMA node number to query for free huge pages.
- **Logic and Control Flow**:
    - Calls the `get_page_path` function with the provided page type and NUMA node to get the path to the huge pages directory.
    - Uses the `cat` command to read the `free_hugepages` file in the directory obtained from `get_page_path`.
    - Checks the exit status of the `cat` command to determine if the operation was successful.
    - If the `cat` command fails, prints an error message and exits with status 1.
- **Output**: The function outputs the number of free huge pages of the specified type on the specified NUMA node to the standard output.


---
### try\_defrag\_memory
Attempts to defragment system memory by synchronizing cached writes, compacting memory, and dropping caches.
- **Inputs**: None
- **Logic and Control Flow**:
    - Synchronizes cached writes to disk using the `sync` command.
    - Attempts to compact memory by writing `1` to `/proc/sys/vm/compact_memory` and waits for 0.25 seconds if successful.
    - Attempts to drop caches by writing `3` to `/proc/sys/vm/drop_caches` and waits for 0.25 seconds if successful.
    - Repeats the memory compaction step by writing `1` to `/proc/sys/vm/compact_memory` again and waits for 0.25 seconds if successful.
- **Output**: No direct output; the function performs system-level operations to manage memory.


---
### init
Initializes shared memory structures for a specified IPC domain with given permissions, user, and group.
- **Inputs**:
    - `SHMEM_PERM`: The permission settings for the shared memory path, in the format used by `chmod`.
    - `SHMEM_USER`: The user who will own the shared memory path, in the format used by `chown`.
    - `SHMEM_GROUP`: The group that will own the shared memory path, in the format used by `chown`.
- **Logic and Control Flow**:
    - Check if the directory at `SHMEM_PATH` exists; if it does, print an error message and exit.
    - Create the directory at `SHMEM_PATH` and check for errors; if creation fails, print an error message and exit.
    - Iterate over each type in `ALL_TYPES` to create and mount directories for each memory page type.
    - For each type, check if the mount path exists; if it does, print an error message and exit.
    - Create the mount path directory and check for errors; if creation fails, print an error message and exit.
    - Check if the mount path is already mounted; if it is, print an error message and exit.
    - Call `try_defrag_memory` to attempt memory defragmentation.
    - For 'normal' pages, mount a `tmpfs` at the mount path; for other types, calculate the memory size and mount a `hugetlbfs`.
    - Check for errors after mounting; if mounting fails, print an error message and exit.
    - Call `try_defrag_memory` again after mounting.
    - Change the ownership of `SHMEM_PATH` to `SHMEM_USER` and `SHMEM_GROUP`, and check for errors; if it fails, print an error message and exit.
    - Change the permissions of `SHMEM_PATH` to `SHMEM_PERM`, and check for errors; if it fails, print an error message and exit.
    - Print a success message indicating the initialization was successful.
- **Output**: Prints a success message if initialization is successful, or an error message and exits if any step fails.


---
### fini
Removes shared memory structures and unmounts associated filesystems.
- **Inputs**: None
- **Logic and Control Flow**:
    - Checks if the directory at `SHMEM_PATH` exists.
    - If the directory exists, calls `try_defrag_memory` to attempt memory defragmentation.
    - Iterates over each type in `ALL_TYPES` and attempts to unmount the corresponding directory under `SHMEM_PATH`.
    - If unmounting fails, logs a failure message but continues the process.
    - Removes the directory at `SHMEM_PATH` and logs a failure message if it fails.
    - Calls `try_defrag_memory` again after removal.
    - Logs a success message if all operations complete without error.
    - If the directory does not exist, logs a failure message indicating the path is not accessible.
- **Output**: Logs a success message if the operation completes successfully, or logs failure messages if any step fails.


---
### query
Prints the current shared memory utilization and details of named shared memory regions for a shared memory IPC domain.
- **Inputs**: None
- **Logic and Control Flow**:
    - Prints an empty line for formatting.
    - Iterates over each page type in `ALL_TYPES`, excluding 'normal'.
    - For each page type, prints the type and iterates over each NUMA node.
    - For each NUMA node, prints the total and free pages using `get_page_total` and `get_page_free`.
    - Checks if the shared memory path `SHMEM_PATH` exists.
    - If the path exists, prints the `FD_SHMEM_PATH` and iterates over each page type in `ALL_TYPES`.
    - For each page type, lists the shared memory regions in the corresponding directory and prints their details.
    - If the path does not exist, prints an error message indicating the path is not accessible and exits with an error code.
- **Output**: Prints the shared memory utilization and details of shared memory regions, or an error message if the path is not accessible.


---
### alloc
Allocates a specified number of huge or gigantic pages on a specified NUMA node.
- **Inputs**:
    - ``CNT``: The number of pages to allocate.
    - ``TYPE``: The type of pages to allocate, either 'huge' or 'gigantic'.
    - ``NUMA``: The NUMA node on which to allocate the pages.
- **Logic and Control Flow**:
    - Check if `TYPE` is 'normal'; if so, print an error message and exit.
    - Retrieve the total and free pages for the specified `TYPE` and `NUMA` using `get_page_total` and `get_page_free`.
    - If the total pages do not equal the free pages, print an error message and exit.
    - Attempt to defragment memory using `try_defrag_memory`.
    - Write the number of pages to allocate (`CNT`) to the `nr_hugepages` file for the specified `TYPE` and `NUMA`.
    - Check if the operation was successful; if not, print an error message and exit.
    - Retrieve the total and free pages again to verify the allocation was successful.
    - If the total pages do not match `CNT` or if the total pages do not equal the free pages, print an error message and exit.
    - Print a success message if all checks pass.
- **Output**: Prints a success message if the allocation is successful, or an error message if it fails.


---
### reset
Removes all named shared memory regions for the current group and attempts to defragment memory.
- **Inputs**: None
- **Logic and Control Flow**:
    - Checks if the directory at `SHMEM_PATH` exists.
    - If the directory exists, calls `try_defrag_memory` to attempt memory defragmentation.
    - Iterates over each type in `ALL_TYPES` and removes all files in the corresponding subdirectory under `SHMEM_PATH`.
    - Checks the success of the `rm` command and exits with an error message if it fails.
    - Calls `try_defrag_memory` again after removing files.
    - Prints a success message if all operations complete without errors.
    - If the directory does not exist, prints an error message and exits.
- **Output**: Prints a success message if the reset operation is successful, or an error message if it fails.



---
Made with ❤️ by [Driver](https://www.driver.ai/)