<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Test utilities for simulating data races with callback injection in instrumented code.

# Purpose
The `fd_racesan.h` file is a C header file that provides utilities for simulating data races in a deterministic manner. It is designed to facilitate the injection of callbacks into instrumented production code, allowing developers to test and debug data race conditions. The file includes mechanisms to inject these callbacks using compiler-specific techniques to manipulate registers and local variables. The header file defines a maximum number of active race condition hooks (`FD_RACESAN_HOOKS_MAX`) and provides a structure (`fd_racesan_t`) to manage these hooks and their associated contexts.

The file defines several functions and macros to manage the lifecycle and behavior of race condition hooks. Functions such as `fd_racesan_new` and [`fd_racesan_delete`](<#fd_racesan_delete>) are used to create and delete `fd_racesan_t` objects, respectively. The [`fd_racesan_inject`](<#fd_racesan_inject>) and [`fd_racesan_inject_default`](<#fd_racesan_inject_default>) functions allow the injection of specific or default callbacks into trace points. Additionally, the file provides macros `FD_RACESAN_INJECT_BEGIN` and `FD_RACESAN_INJECT_END` to facilitate the injection process within a code block. These utilities are intended for use in testing environments where simulating and handling data races is necessary for ensuring the robustness of concurrent code.
# Imports and Dependencies

---
- `fd_racesan_base.h`


# Data Structures

---
### fd\_racesan\_hook\_map
- **Type**: ``struct``
- **Members**:
    - `name_hash`: A hash value that represents the name of the hook.
    - `hook`: A pointer to a function of type `fd_racesan_hook_fn_t`.
- **Description**: Maps a hash value to a function pointer, allowing the association of a specific hook function with a unique identifier in the context of race condition simulation.


---
### fd\_racesan\_hook\_map\_t
- **Type**: ``struct``
- **Members**:
    - ``name_hash``: Stores a hash value that represents the name of the hook.
    - ``hook``: Points to a function that is called when the hook is triggered.
- **Description**: Defines a mapping between a hash value and a function pointer, which allows for the association of specific hooks with their corresponding callback functions in a deterministic data race simulation environment.


---
### fd\_racesan
- **Type**: ``struct``
- **Members**:
    - `hook_ctx`: Pointer to a context used by hooks.
    - `default_hook`: Pointer to a default hook function.
    - `hook_map`: Array of hook mappings, each containing a name hash and a hook function pointer.
- **Description**: Facilitates deterministic simulation of data races by providing a mechanism to inject callbacks into instrumented production code. It includes a context pointer, a default hook function, and a map of hook functions indexed by a hash, allowing for flexible callback management.


---
### fd\_racesan\_t
- **Type**: ``struct``
- **Members**:
    - `hook_ctx`: Pointer to the context for hooks.
    - `default_hook`: Pointer to the default hook function.
    - `hook_map`: Array of `fd_racesan_hook_map_t` structures, each containing a name hash and a hook function pointer.
- **Description**: Manages hooks for simulating data races by providing a context, a default hook function, and a map of specific hooks identified by name hashes.


# Functions

---
### fd\_racesan\_private\_cleanup<!-- {{#callable:fd_racesan_private_cleanup}} -->
[View Source →](<../../../../../src/util/racesan/fd_racesan.h#L68>)

Calls the [`fd_racesan_exit`](<fd_racesan.c.md#fd_racesan_exit>) function to perform cleanup operations.
- **Inputs**:
    - `unused`: An integer pointer that is not used in the function.
- **Logic and Control Flow**:
    - Casts the `unused` parameter to void to explicitly indicate it is unused.
    - Calls the [`fd_racesan_exit`](<fd_racesan.c.md#fd_racesan_exit>) function to perform necessary cleanup operations.
- **Output**: No return value.
- **Functions Called**:
    - [`fd_racesan_exit`](<fd_racesan.c.md#fd_racesan_exit>)


# Function Declarations (Public API)

---
### fd\_racesan\_delete<!-- {{#callable_declaration:fd_racesan_delete}} -->
[View Source →](<../../../../../src/util/racesan/fd_racesan.h#L44>)

Deletes a race condition simulation object.
- **Description**: Use this function to delete a race condition simulation object when it is no longer needed. This function does not perform any operations on the object other than returning it. Ensure that the object is valid before calling this function. This function does not free any memory or resources associated with the object.
- **Inputs**:
    - `racesan`: A pointer to a `fd_racesan_t` object. The object must be valid and initialized. The function does not modify the object or its contents.
- **Output**: Returns the same pointer that was passed as input.
- **See Also**: [`fd_racesan_delete`](<fd_racesan.c.md#fd_racesan_delete>)  (Implementation)


---
### fd\_racesan\_inject<!-- {{#callable_declaration:fd_racesan_inject}} -->
[View Source →](<../../../../../src/util/racesan/fd_racesan.h#L50>)

Injects a callback into a race condition simulation trace point.
- **Description**: Use this function to add a specific callback to a trace point in a race condition simulation. This is useful for testing and fault injection in instrumented production code. Ensure that the `racesan` object is properly initialized before calling this function. If a callback with the same name already exists, the function will log an error and not overwrite the existing callback.
- **Inputs**:
    - `racesan`: A pointer to an `fd_racesan_t` object that manages the race condition simulation. Must not be null and must be initialized before use.
    - `name`: A constant character pointer representing the name of the trace point. Must not be null. The function uses this name to identify the trace point uniquely.
    - `fn`: A pointer to a function of type `fd_racesan_hook_fn_t` that will be called when the trace point is hit. Must not be null.
- **Output**: None
- **See Also**: [`fd_racesan_inject`](<fd_racesan.c.md#fd_racesan_inject>)  (Implementation)


---
### fd\_racesan\_inject\_default<!-- {{#callable_declaration:fd_racesan_inject_default}} -->
[View Source →](<../../../../../src/util/racesan/fd_racesan.h#L58>)

Sets a default callback for race condition trace points.
- **Description**: Use this function to specify a default callback that will be invoked by any race condition trace points in the system. This is useful when you want a uniform behavior for all trace points that do not have a specific callback assigned. Ensure that the `racesan` object is properly initialized before calling this function. The function does not validate the `callback` parameter, so it is the caller's responsibility to ensure it is a valid function pointer.
- **Inputs**:
    - `racesan`: A pointer to an `fd_racesan_t` object. Must not be null and should be initialized before use. The function modifies the `default_hook` member of this object.
    - `callback`: A pointer to a function of type `fd_racesan_hook_fn_t`. This function will be set as the default callback for trace points. The caller must ensure this is a valid function pointer.
- **Output**: None
- **See Also**: [`fd_racesan_inject_default`](<fd_racesan.c.md#fd_racesan_inject_default>)  (Implementation)


---
### fd\_racesan\_enter<!-- {{#callable_declaration:fd_racesan_enter}} -->
[View Source →](<../../../../../src/util/racesan/fd_racesan.h#L62>)

Activates a race condition simulation context.
- **Description**: Use this function to activate a race condition simulation context for deterministic testing. This function must be called before any race condition simulation operations are performed. It is important to ensure that no other race condition simulation context is active when calling this function, as it will log a critical error if a context is already activated. This function does not return a value and does not modify the input parameter.
- **Inputs**:
    - `racesan`: A pointer to an `fd_racesan_t` structure representing the race condition simulation context to activate. Must not be null. The caller retains ownership of the memory.
- **Output**: None
- **See Also**: [`fd_racesan_enter`](<fd_racesan.c.md#fd_racesan_enter>)  (Implementation)


---
### fd\_racesan\_exit<!-- {{#callable_declaration:fd_racesan_exit}} -->
[View Source →](<../../../../../src/util/racesan/fd_racesan.h#L65>)

Resets the race condition simulation state.
- **Description**: Use this function to reset the state of the race condition simulation utility. It is typically called to clean up or reset the environment after race condition testing is complete. This function does not require any parameters and does not return any values. It is important to ensure that any necessary cleanup or finalization logic is executed before calling this function, as it will reset the internal state used for race condition simulation.
- **Inputs**: None
- **Output**: None
- **See Also**: [`fd_racesan_exit`](<fd_racesan.c.md#fd_racesan_exit>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)