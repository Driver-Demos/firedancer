<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for race condition detection and handling using the RaceSan library in asynchronous and interleaved contexts.

# Purpose
The code is a C source file that implements a test suite for a race condition detection framework, specifically when the `FD_HAS_RACESAN` macro is defined. It includes several header files related to race condition analysis and utilities. The file defines multiple static functions to test different aspects of the race condition detection, such as [`cas_inc`](<#cas_inc>), [`inject_inc`](<#inject_inc>), [`async_cas_inc`](<#async_cas_inc>), and [`async_cas_dbl`](<#async_cas_dbl>). These functions are used to increment or double a value atomically, with hooks for race condition analysis.

The main function initializes the test environment and executes three test functions: [`test_racesan_async`](<#test_racesan_async>), [`test_racesan_weave`](<#test_racesan_weave>), and [`test_racesan_inject`](<#test_racesan_inject>). These functions test asynchronous operations and the weaving of multiple asynchronous tasks to detect race conditions. The tests use volatile variables and atomic operations to simulate and verify race conditions. If the `FD_HAS_RACESAN` macro is not defined, the main function logs a message indicating that the unit test is skipped. The code is structured to ensure that race conditions are detected and handled correctly, providing a framework for testing concurrent operations.
# Imports and Dependencies

---
- `fd_racesan.h`
- `fd_racesan_async.h`
- `fd_racesan_target.h`
- `fd_racesan_weave.h`
- `../../util/fd_util.h`


# Functions

---
### cas\_inc<!-- {{#callable:cas_inc}} -->
[View Source →](<../../../../../src/util/racesan/test_racesan.c#L9>)

Atomically increments the value pointed to by `p` using a compare-and-swap operation.
- **Inputs**:
    - `p`: A pointer to an unsigned integer that will be incremented atomically.
- **Logic and Control Flow**:
    - Enters an infinite loop to repeatedly attempt the increment operation.
    - Reads the current value pointed to by `p` using `FD_VOLATILE_CONST`.
    - Calls `fd_racesan_hook` with the string "cas_inc:post_load" to trigger a hook after loading the value.
    - Uses `__sync_bool_compare_and_swap` to attempt to atomically increment the value at `p` by 1.
    - Breaks out of the loop if the compare-and-swap operation is successful.
- **Output**: No direct output; the function modifies the value at the memory location pointed to by `p`.


---
### inject\_inc<!-- {{#callable:inject_inc}} -->
[View Source →](<../../../../../src/util/racesan/test_racesan.c#L18>)

Sets the value pointed to by `ctx` to 1 if it is currently 0.
- **Inputs**:
    - `ctx`: A pointer to a `uint` that the function will check and potentially modify.
    - `name_hash`: An `ulong` value that is not used in the function.
- **Logic and Control Flow**:
    - The function casts `ctx` to a `uint` pointer `p`.
    - It checks if the value pointed to by `p` is 0 using `FD_VOLATILE_CONST`.
    - If the value is 0, it sets the value pointed to by `p` to 1 using `FD_VOLATILE`.
- **Output**: No return value; the function modifies the value pointed to by `ctx` directly.


---
### test\_racesan\_inject<!-- {{#callable:test_racesan_inject}} -->
[View Source →](<../../../../../src/util/racesan/test_racesan.c#L26>)

Tests the race condition sanitizer by injecting a hook and verifying the increment operation.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize a `uint` variable `ctx` to 0.
    - Declare a `fd_racesan_t` array `racesan` with one element.
    - Call `fd_racesan_new` to initialize the race condition sanitizer with `racesan` and `ctx`.
    - Inject the `inject_inc` function into the race condition sanitizer with the hook name `cas_inc:post_load`.
    - Begin a race condition injection block with `FD_RACESAN_INJECT_BEGIN` and call [`cas_inc`](<#cas_inc>) with `ctx`.
    - End the race condition injection block with `FD_RACESAN_INJECT_END`.
    - Verify that `ctx` equals 2 using `FD_TEST`.
    - Delete the race condition sanitizer with [`fd_racesan_delete`](<fd_racesan.c.md#fd_racesan_delete>).
- **Output**: No output is returned as the function is `void`, but it performs internal tests and assertions.
- **Functions Called**:
    - [`fd_racesan_inject`](<fd_racesan.c.md#fd_racesan_inject>)
    - [`cas_inc`](<#cas_inc>)
    - [`fd_racesan_delete`](<fd_racesan.c.md#fd_racesan_delete>)


---
### FD\_RACESAN\_INJECT\_BEGIN<!-- {{#callable:test_racesan_inject::FD_RACESAN_INJECT_BEGIN}} -->
[View Source →](<../../../../../src/util/racesan/test_racesan.c#L33>)

Increments the value pointed to by `ctx` using a compare-and-swap operation within a race condition sanitizer context.
- **Inputs**:
    - `racesan`: A pointer to a `fd_racesan_t` structure that represents the race condition sanitizer context.
- **Logic and Control Flow**:
    - Calls the [`cas_inc`](<#cas_inc>) function with the address of `ctx` to increment its value.
    - Uses a compare-and-swap operation to safely increment the value pointed to by `ctx`.
- **Output**: No direct output; modifies the value pointed to by `ctx`.
- **Functions Called**:
    - [`cas_inc`](<#cas_inc>)


---
### async\_cas\_inc<!-- {{#callable:async_cas_inc}} -->
[View Source →](<../../../../../src/util/racesan/test_racesan.c#L42>)

Calls the [`cas_inc`](<#cas_inc>) function with a given context pointer.
- **Inputs**:
    - `ctx`: A pointer to a `uint` that represents the context or sequence number to increment.
- **Logic and Control Flow**:
    - Retrieve the `uint` pointer from the `ctx` argument.
    - Call the [`cas_inc`](<#cas_inc>) function with the retrieved pointer.
- **Output**: No return value; the function operates on the pointer provided in the input.
- **Functions Called**:
    - [`cas_inc`](<#cas_inc>)


---
### test\_racesan\_async<!-- {{#callable:test_racesan_async}} -->
[View Source →](<../../../../../src/util/racesan/test_racesan.c#L48>)

Tests the asynchronous race condition detection mechanism by incrementing a sequence number and verifying the expected behavior.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize a sequence number `seq` to 0.
    - Create an asynchronous race condition detector `async` using `fd_racesan_async_new` with `async_cas_inc` as the function and `seq` as the context.
    - Verify that the first step of the asynchronous operation returns 1 and the hook name matches "cas_inc:post_load".
    - Increment the sequence number `seq` using `FD_VOLATILE`.
    - Verify again that the next step returns 1 and the hook name matches "cas_inc:post_load".
    - Check that subsequent steps return 0, indicating no further operations are performed.
    - Verify that the final value of `seq` is 2, confirming the expected increment operations.
    - Delete the asynchronous race condition detector `async` using [`fd_racesan_async_delete`](<fd_racesan_async.c.md#fd_racesan_async_delete>).
- **Output**: No output is returned as the function is void, but it performs internal tests using `FD_TEST` to validate race condition handling.
- **Functions Called**:
    - [`fd_racesan_async_step`](<fd_racesan_async.c.md#fd_racesan_async_step>)
    - [`fd_racesan_async_hook_name_eq`](<fd_racesan_async.c.md#fd_racesan_async_hook_name_eq>)
    - [`fd_racesan_async_delete`](<fd_racesan_async.c.md#fd_racesan_async_delete>)


---
### async\_cas\_dbl<!-- {{#callable:async_cas_dbl}} -->
[View Source →](<../../../../../src/util/racesan/test_racesan.c#L70>)

Doubles the value pointed to by `ctx` using an atomic compare-and-swap operation in a loop until successful.
- **Inputs**:
    - `ctx`: A pointer to an unsigned integer (`uint`) that will be doubled.
- **Logic and Control Flow**:
    - Retrieve the current value pointed to by `ctx` using `FD_VOLATILE_CONST` and store it in `v`.
    - Call `fd_racesan_hook` with the string "cas_dbl:post_load" to signal a hook point after loading the value.
    - Use `__sync_bool_compare_and_swap` to attempt to atomically double the value pointed to by `ctx` by comparing it with `v` and setting it to `v<<1` if they are equal.
    - Repeat the loop until the compare-and-swap operation is successful.
- **Output**: None (the function modifies the value pointed to by `ctx` in place).


---
### test\_racesan\_weave<!-- {{#callable:test_racesan_weave}} -->
[View Source →](<../../../../../src/util/racesan/test_racesan.c#L80>)

Executes a series of random interleavings on asynchronous operations to test race conditions.
- **Inputs**:
    - `void`: No input parameters are required.
- **Logic and Control Flow**:
    - Initialize a sequence variable `seq` to 0.
    - Create a `fd_racesan_weave_t` object `weave` and initialize it using `fd_racesan_weave_new`.
    - Create an asynchronous operation `async_dbl` with `async_cas_dbl` and add it to `weave`.
    - Create another asynchronous operation `async_inc` with `async_cas_inc` and add it to `weave`.
    - Set the number of iterations `iter` to 1,000,000 and `step_max` to 1024.
    - For each iteration, set `seq` to 5, execute random interleavings using [`fd_racesan_weave_exec_rand`](<fd_racesan_weave.c.md#fd_racesan_weave_exec_rand>), and verify that the result `res` is either 11 or 12.
    - Delete the `weave`, `async_inc`, and `async_dbl` objects to clean up resources.
- **Output**: No output is returned, but the function performs tests to ensure the sequence variable `seq` reaches expected values after random interleavings.
- **Functions Called**:
    - [`fd_racesan_weave_add`](<fd_racesan_weave.c.md#fd_racesan_weave_add>)
    - [`fd_racesan_weave_exec_rand`](<fd_racesan_weave.c.md#fd_racesan_weave_exec_rand>)
    - [`fd_racesan_weave_delete`](<fd_racesan_weave.c.md#fd_racesan_weave_delete>)
    - [`fd_racesan_async_delete`](<fd_racesan_async.c.md#fd_racesan_async_delete>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/util/racesan/test_racesan.c#L126>)

Initializes the environment and logs a message indicating that the unit test is skipped if `FD_HAS_RACESAN` is not defined.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of strings representing the command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with the command-line arguments.
    - Logs a notice message indicating that the unit test is skipped because `FD_HAS_RACESAN` is not defined.
    - Calls `fd_halt` to terminate the program.
- **Output**: Returns 0, indicating successful execution.



---
Made with ❤️ by [Driver](https://www.driver.ai/)