<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements asynchronous context switching and race condition detection functions.

# Purpose
The code provides an implementation for asynchronous race condition analysis using context switching in C. It defines a set of functions and structures to manage asynchronous operations, specifically for a race condition sanitizer (`racesan`). The primary structure used is `fd_racesan_async_t`, which holds the context and state for asynchronous operations. The code includes functions to create, manage, and delete asynchronous tasks, such as [`fd_racesan_async_new`](<#fd_racesan_async_new>), [`fd_racesan_async_delete`](<#fd_racesan_async_delete>), and [`fd_racesan_async_step`](<#fd_racesan_async_step>). These functions utilize the `ucontext_t` structure to perform context switching, allowing the asynchronous function to yield control back to the caller and resume later.

The key components include [`fd_racesan_async_yield`](<#fd_racesan_async_yield>), which handles yielding control, and [`fd_racesan_async_hook`](<#fd_racesan_async_hook>), which is invoked when a race condition hook is reached. The [`fd_racesan_async_target`](<#fd_racesan_async_target>) function represents the asynchronous task with its own stack, and it integrates with the race condition sanitizer by injecting hooks and managing the task's lifecycle. The code also provides utility functions like [`fd_racesan_async_hook_name_eq`](<#fd_racesan_async_hook_name_eq>) to compare hook names and [`fd_racesan_async_reset`](<#fd_racesan_async_reset>) to reset the asynchronous context. This module is intended to be part of a larger system for detecting and analyzing race conditions in concurrent programs.
# Imports and Dependencies

---
- `fd_racesan_async.h`
- `../../util/fd_util.h`
- `errno.h`


# Functions

---
### fd\_racesan\_async\_yield<!-- {{#callable:fd_racesan_async_yield}} -->
[View Source →](<../../../../../src/util/racesan/fd_racesan_async.c#L8>)

Performs a context switch from the current asynchronous function to its caller.
- **Inputs**:
    - `async`: A pointer to an `fd_racesan_async_t` structure that contains the context information for the asynchronous operation.
- **Logic and Control Flow**:
    - Checks if the `swapcontext` function call returns a non-zero value, indicating a failure.
    - If `swapcontext` fails, logs an error message with the error number and description.
- **Output**: No return value; the function performs a context switch or logs an error if the switch fails.


---
### fd\_racesan\_async\_hook<!-- {{#callable:fd_racesan_async_hook}} -->
[View Source →](<../../../../../src/util/racesan/fd_racesan_async.c#L19>)

Handles a racesan hook by updating the context with a name hash, exiting the current racesan context, and yielding control back to the caller.
- **Inputs**:
    - `ctx`: A pointer to the `fd_racesan_async_t` structure that holds the asynchronous context.
    - `name_hash`: An unsigned long integer representing the hash of the name associated with the racesan hook.
- **Logic and Control Flow**:
    - Cast `ctx` to `fd_racesan_async_t *` and store it in `async`.
    - Assign `name_hash` to `async->name_hash`.
    - Call `fd_racesan_exit()` to exit the current racesan context.
    - Call `fd_racesan_async_yield(async)` to yield control back to the caller.
- **Output**: No return value; the function performs operations on the provided context and manages control flow.
- **Functions Called**:
    - [`fd_racesan_exit`](<fd_racesan.c.md#fd_racesan_exit>)
    - [`fd_racesan_async_yield`](<#fd_racesan_async_yield>)


---
### fd\_racesan\_async\_target<!-- {{#callable:fd_racesan_async_target}} -->
[View Source →](<../../../../../src/util/racesan/fd_racesan_async.c#L31>)

Executes an asynchronous function with race condition detection and context switching.
- **Inputs**:
    - `async`: A pointer to an `fd_racesan_async_t` structure that contains the asynchronous function and its context.
- **Logic and Control Flow**:
    - Declare a `fd_racesan_t` array named `racesan` with one element.
    - Initialize `racesan` with `fd_racesan_new`, passing `async` as a parameter.
    - Inject the default race condition hook using [`fd_racesan_inject_default`](<fd_racesan.c.md#fd_racesan_inject_default>).
    - Enter the race condition detection context with [`fd_racesan_enter`](<fd_racesan.c.md#fd_racesan_enter>).
    - Call the asynchronous function `async->fn` with its context `async->fn_ctx`.
    - Delete the race condition detection context with [`fd_racesan_delete`](<fd_racesan.c.md#fd_racesan_delete>).
    - Set `async->done` to 1 to indicate completion.
    - Yield control back to the caller using [`fd_racesan_async_yield`](<#fd_racesan_async_yield>).
- **Output**: No return value; modifies the `async` structure to indicate completion and performs context switching.
- **Functions Called**:
    - [`fd_racesan_inject_default`](<fd_racesan.c.md#fd_racesan_inject_default>)
    - [`fd_racesan_enter`](<fd_racesan.c.md#fd_racesan_enter>)
    - [`fd_racesan_delete`](<fd_racesan.c.md#fd_racesan_delete>)
    - [`fd_racesan_async_yield`](<#fd_racesan_async_yield>)


---
### fd\_racesan\_async\_new<!-- {{#callable:fd_racesan_async_new}} -->
[View Source →](<../../../../../src/util/racesan/fd_racesan_async.c#L44>)

Initializes an `fd_racesan_async_t` structure for asynchronous execution with a specified function and context.
- **Inputs**:
    - `async`: A pointer to an `fd_racesan_async_t` structure to initialize.
    - `async_fn`: A pointer to the function to execute asynchronously.
    - `ctx`: A pointer to the context to pass to the asynchronous function.
- **Logic and Control Flow**:
    - Set all bytes of the `async` structure to zero using `memset`.
    - Assign `ctx` to `async->fn_ctx` and `async_fn` to `async->fn`.
    - Call `getcontext` to initialize the context in `async->ctx`; log an error if it fails.
    - Set the stack pointer and size for `async->ctx` using `async->stack`.
    - Use `makecontext` to set up the context to start execution at `fd_racesan_async_target` with `async` as an argument.
- **Output**: Returns a pointer to the initialized `fd_racesan_async_t` structure.


---
### fd\_racesan\_async\_delete<!-- {{#callable:fd_racesan_async_delete}} -->
[View Source →](<../../../../../src/util/racesan/fd_racesan_async.c#L63>)

Returns a null pointer after receiving an `fd_racesan_async_t` pointer.
- **Inputs**:
    - `async`: A pointer to an `fd_racesan_async_t` structure, which is not used in the function.
- **Logic and Control Flow**:
    - Casts the `async` parameter to void to indicate it is unused.
    - Returns a null pointer.
- **Output**: A null pointer.


---
### fd\_racesan\_async\_step<!-- {{#callable:fd_racesan_async_step}} -->
[View Source →](<../../../../../src/util/racesan/fd_racesan_async.c#L69>)

Performs a single step in the asynchronous execution of a function, switching context to the asynchronous function's context if it is not done.
- **Inputs**:
    - `async`: A pointer to an `fd_racesan_async_t` structure that contains the context and state of the asynchronous function.
- **Logic and Control Flow**:
    - Check if the `done` flag in the `async` structure is set; if so, return 0 indicating no further steps are needed.
    - Create a `ucontext_t` structure named `caller` to store the current context before switching.
    - Assign the address of `caller` to `async->caller` to save the caller's context.
    - Use `swapcontext` to switch from the current context to the context stored in `async->ctx`.
    - If `swapcontext` fails, log an error message and terminate the program.
    - Return 1 to indicate that the step was successful and the asynchronous function is not yet complete.
- **Output**: Returns 0 if the asynchronous function is complete, otherwise returns 1.


---
### fd\_racesan\_async\_hook\_name\_eq<!-- {{#callable:fd_racesan_async_hook_name_eq}} -->
[View Source →](<../../../../../src/util/racesan/fd_racesan_async.c#L82>)

Compares the hash of a given hook name with the stored hash in the `fd_racesan_async_t` structure.
- **Inputs**:
    - `async`: A pointer to an `fd_racesan_async_t` structure that contains the stored hash to compare against.
    - `hook_name`: A constant character pointer to the hook name whose hash will be computed and compared.
- **Logic and Control Flow**:
    - Calculate the length of the `hook_name` using `strlen`.
    - Compute the hash of `hook_name` using [`fd_racesan_strhash`](<fd_racesan_base.h.md#fd_racesan_strhash>) with the calculated length.
    - Compare the computed hash with the `name_hash` stored in the `async` structure.
    - Return the result of the comparison as an integer.
- **Output**: Returns an integer that is non-zero if the hashes are equal, otherwise zero.
- **Functions Called**:
    - [`fd_racesan_strhash`](<fd_racesan_base.h.md#fd_racesan_strhash>)


---
### fd\_racesan\_async\_reset<!-- {{#callable:fd_racesan_async_reset}} -->
[View Source →](<../../../../../src/util/racesan/fd_racesan_async.c#L90>)

Resets the asynchronous context and marks it as not done.
- **Inputs**:
    - `async`: A pointer to an `fd_racesan_async_t` structure that holds the asynchronous context to reset.
- **Logic and Control Flow**:
    - Calls `makecontext` to set up the context `async->ctx` to start execution at `fd_racesan_async_target` with `async` as an argument.
    - Sets `async->done` to 0 to indicate that the asynchronous operation is not complete.
- **Output**: No return value.



---
Made with ❤️ by [Driver](https://www.driver.ai/)