<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

APIs for creating and managing thread pools to efficiently execute parallel tasks with low overhead.

# Purpose
The code is a C header file that defines a thread pool API for executing parallel tasks efficiently. It provides a set of functions and macros to manage and execute tasks across multiple threads, focusing on minimizing overhead and maximizing scalability. The header file includes detailed explanations and strategies for optimizing thread parallelism, addressing common inefficiencies in naive thread pool implementations. It introduces concepts such as partitioning tasks, reducing dispatch overhead, and parallelizing both task execution and thread dispatch to achieve better performance.

Key components of the code include the `fd_tpool_t` structure, which represents a thread pool, and various function signatures like `fd_tpool_task_t` and `fd_tpool_task_v2_t` for defining tasks. The file also defines macros such as `FD_TPOOL_PARTITION` for partitioning tasks among threads and provides functions for initializing and finalizing thread pools ([`fd_tpool_init`](<#fd_tpool_init>), [`fd_tpool_fini`](<#fd_tpool_fini>)), managing worker threads ([`fd_tpool_worker_push`](<#fd_tpool_worker_push>), [`fd_tpool_worker_pop`](<#fd_tpool_worker_pop>)), and executing tasks ([`fd_tpool_exec`](<#fd_tpool_exec>), `fd_tpool_exec_all_*`). The code is designed to be used in high-performance contexts, with a focus on reducing the overhead associated with thread management and task dispatch.
# Imports and Dependencies

---
- `../scratch/fd_scratch.h`
- `fd_map_reduce.h`


# Global Variables

---
### \_ftp\_block\_rem
- **Type**: `ulong`
- **Description**: Represents the number of leftover tasks after dividing the total number of tasks (`_ftp_task_cnt`) by the number of lanes (`_ftp_lane_cnt`).
- **Use**: Used to determine the number of tasks that do not fit into complete SIMD blocks when partitioning tasks among workers.


---
### \_ftp\_worker\_block\_min
- **Type**: `ulong`
- **Description**: The variable `_ftp_worker_block_min` is an unsigned long integer that represents the minimum number of complete SIMD (Single Instruction, Multiple Data) blocks that a worker thread is responsible for processing.
- **Use**: It is used to determine the workload distribution among worker threads in a parallel processing environment.


---
### \_ftp\_worker\_extra\_cnt
- **Type**: `ulong`
- **Description**: Stores the number of worker threads that need to handle an additional complete SIMD block when tasks are partitioned among workers.
- **Use**: Used to determine which workers are assigned extra tasks to ensure an even distribution of work.


---
### \_ftp\_worker\_task0
- **Type**: `ulong`
- **Description**: `_ftp_worker_task0` is a global variable that calculates the starting index of tasks assigned to a specific worker in a thread pool. It is computed based on the initial task index, the number of lanes, the minimum number of complete SIMD blocks per worker, the worker index, and the number of workers needing an extra complete SIMD block.
- **Use**: Used to determine the starting task index for a worker in a parallel task partitioning scheme.


---
### \_ftp\_worker\_task1
- **Type**: `ulong`
- **Description**: The variable `_ftp_worker_task1` calculates the end index of the task range assigned to a specific worker thread in a thread pool. It is computed based on the starting task index, the number of tasks per worker, and any remaining tasks that need to be distributed among the workers.
- **Use**: Used to determine the upper bound of the task range for a worker thread in a parallel task distribution.


---
### FD\_STATIC\_ASSERT
- **Type**: `FD_STATIC_ASSERT`
- **Description**: `FD_STATIC_ASSERT` is a macro used to perform a compile-time assertion. It checks if the condition `FD_TILE_MAX<2048UL` is true, and if not, it triggers a compilation error with the message `update_implementation`. This ensures that certain conditions are met during compilation, preventing potential runtime errors.
- **Use**: Used to enforce compile-time constraints by checking if `FD_TILE_MAX` is less than 2048.


# Data Structures

---
### fd\_tpool\_t
- **Type**: ``struct``
- **Members**:
    - ``opt``: Bitwise OR of options for the thread pool.
    - ``worker_max``: Maximum number of worker threads allowed.
    - ``worker_cnt``: Current number of worker threads in the pool.
- **Description**: `fd_tpool_t` is an opaque handle for a thread pool, designed to manage and execute tasks across multiple threads efficiently. It includes options for configuration, and tracks the maximum and current number of worker threads. The structure is aligned for optimal performance and is used internally to manage thread execution and task distribution.


---
### fd\_tpool\_private\_worker
- **Type**: ``struct``
- **Members**:
    - ``seq0``: Dispatch read/write (ideally write-only), worker read-only.
    - ``arg_cnt``: Indicates `UINT_MAX` for a v1 task, or argument count for a v2 task (in [0, `FD_TPOOL_TASK_ARG_MAX`]).
    - ``task``: 0 to halt worker, `fd_tpool_task_t` if `arg_cnt` is `UINT_MAX`, `fd_tpool_task_v2_t` otherwise.
    - ``arg``: Task arguments, indexed [0, `arg_cnt`).
    - ``seq1``: Dispatch read-only, worker write-only (different cache line pair than `seq0`, `arg_cnt`, `task` and the most commonly used leading parts of `arg`).
    - ``tile_idx``: Read-only (after initialization).
    - ``lock``: For use by sleep workers.
    - ``wake``: For use by sleep workers.
- **Description**: Represents a private worker in a thread pool, managing task execution and synchronization between dispatch and worker threads, with fields for task arguments, task type, and synchronization mechanisms.


---
### fd\_tpool\_private\_worker\_t
- **Type**: ``struct``
- **Members**:
    - ``seq0``: Dispatch read/write (ideally write-only), worker read-only.
    - ``arg_cnt``: Indicates the argument count for a task, with `UINT_MAX` for a v1 task.
    - ``task``: Holds the task identifier, which is 0 to halt the worker or a function pointer for tasks.
    - ``arg``: Array of task arguments, indexed from 0 to `arg_cnt`.
    - ``seq1``: Dispatch read-only, worker write-only, located in a different cache line pair than `seq0`.
    - ``tile_idx``: Read-only after initialization, indicates the tile index.
    - ``lock``: Used by sleep workers for synchronization.
    - ``wake``: Used by sleep workers to manage wake-up signals.
- **Description**: Defines a private worker structure for a thread pool, managing task execution and synchronization details for each worker thread. It includes fields for task dispatching, argument handling, and synchronization mechanisms, ensuring efficient task management and execution within a thread pool environment.


---
### fd\_tpool\_private
- **Type**: ``struct``
- **Members**:
    - ``opt``: Bitwise OR of `FD_TPOOL_OPTs` options.
    - ``worker_max``: Maximum number of workers, must be positive.
    - ``worker_cnt``: Current number of workers, in the range [1, `worker_max`].
- **Description**: Defines a private structure for managing a thread pool, including options and worker count constraints. It includes a pointer to an array of `fd_tpool_private_worker_t` structures, which manage individual worker threads. The structure is aligned to 128 bytes and is designed to be compatible with C++17, avoiding the use of flexible arrays.


# Functions

---
### fd\_tpool\_private\_split<!-- {{#callable:fd_tpool_private_split}} -->
[View Source →](<../../../../../src/util/tpool/fd_tpool.h#L605>)

Splits a given number `n` into two parts, with the left part being greater than or equal to the right part, using a NUMA-aware strategy.
- **Inputs**:
    - `n`: The number to split, assumed to be greater than 1.
- **Logic and Control Flow**:
    - Checks if the simple splitting method is enabled (currently disabled).
    - Finds the most significant bit of `n` using `fd_ulong_find_msb`.
    - Calculates `m` as the largest power of two smaller than `n`.
    - Uses `fd_ulong_if` to determine the split point: if `n` and `m` do not overlap, returns `n-m`; otherwise, returns `m<<1`.
- **Output**: Returns the number of elements on the left side of the split.


---
### fd\_tpool\_private\_wake<!-- {{#callable:fd_tpool_private_wake}} -->
[View Source →](<../../../../../src/util/tpool/fd_tpool.h#L636>)

Does nothing with the given `worker` argument.
- **Inputs**:
    - `worker`: A pointer to a `fd_tpool_private_worker_t` structure, representing a worker in the thread pool.
- **Logic and Control Flow**:
    - The function takes a `worker` argument of type `fd_tpool_private_worker_t *`.
    - The function casts the `worker` argument to `void` to explicitly indicate that it is unused.
    - No operations are performed within the function body.
- **Output**: No output is produced as the function does not perform any operations.


---
### fd\_tpool\_opt<!-- {{#callable:fd_tpool_opt}} -->
[View Source →](<../../../../../src/util/tpool/fd_tpool.h#L743>)

Retrieves the `opt` field from a `fd_tpool_t` structure.
- **Inputs**:
    - `tpool`: A pointer to a constant `fd_tpool_t` structure from which the `opt` field is retrieved.
- **Logic and Control Flow**:
    - Accesses the `opt` field of the `tpool` structure.
    - Returns the value of the `opt` field.
- **Output**: Returns an `ulong` representing the `opt` field of the `tpool` structure.


---
### fd\_tpool\_worker\_cnt<!-- {{#callable:fd_tpool_worker_cnt}} -->
[View Source →](<../../../../../src/util/tpool/fd_tpool.h#L744>)

Retrieves the current number of worker threads in a thread pool.
- **Inputs**:
    - `tpool`: A pointer to a `fd_tpool_t` structure representing the thread pool.
- **Logic and Control Flow**:
    - Casts the `worker_cnt` field of the `tpool` structure to an `ulong`.
    - Returns the casted value.
- **Output**: The function returns the current number of worker threads in the thread pool as an `ulong`.


---
### fd\_tpool\_worker\_max<!-- {{#callable:fd_tpool_worker_max}} -->
[View Source →](<../../../../../src/util/tpool/fd_tpool.h#L745>)

Returns the maximum number of worker threads that a thread pool can support.
- **Inputs**:
    - `tpool`: A pointer to a constant `fd_tpool_t` structure representing the thread pool.
- **Logic and Control Flow**:
    - Casts the `worker_max` field of the `tpool` structure to an `ulong`.
    - Returns the casted value.
- **Output**: An `ulong` representing the maximum number of worker threads in the thread pool.


---
### fd\_tpool\_worker\_tile\_idx<!-- {{#callable:fd_tpool_worker_tile_idx}} -->
[View Source →](<../../../../../src/util/tpool/fd_tpool.h#L747>)

Retrieves the tile index of a specified worker in a thread pool.
- **Inputs**:
    - `tpool`: A pointer to a `fd_tpool_t` structure representing the thread pool.
    - `worker_idx`: An unsigned long integer representing the index of the worker within the thread pool.
- **Logic and Control Flow**:
    - Calls [`fd_tpool_private_worker`](<#fd_tpool_private_worker>) with `tpool` to get the array of worker pointers.
    - Accesses the worker at the specified `worker_idx` in the array.
    - Returns the `tile_idx` of the worker as an unsigned long integer.
- **Output**: Returns the tile index of the specified worker as an unsigned long integer.
- **Functions Called**:
    - [`fd_tpool_private_worker`](<#fd_tpool_private_worker>)


---
### fd\_tpool\_worker\_idle<!-- {{#callable:fd_tpool_worker_idle}} -->
[View Source →](<../../../../../src/util/tpool/fd_tpool.h#L762>)

Checks if a specified worker in a thread pool is idle by comparing sequence numbers.
- **Inputs**:
    - `tpool`: A pointer to a constant `fd_tpool_t` structure representing the thread pool.
    - `worker_idx`: An unsigned long integer representing the index of the worker to check within the thread pool.
- **Logic and Control Flow**:
    - Retrieve the worker at the specified `worker_idx` from the thread pool.
    - Obtain pointers to the `seq0` and `seq1` sequence numbers of the worker.
    - Enter a loop to repeatedly check the sequence numbers.
    - Use memory fences to ensure memory operations are completed in order.
    - Read the `seq0` value and store it in `seq0`.
    - Read the `seq1` value and store it in `seq1`.
    - Read the `seq0` value again and store it in `seq2`.
    - If `seq2` equals `seq0`, exit the loop; otherwise, pause briefly and retry.
    - Return whether `seq0` equals `seq1`, indicating the worker's idle status.
- **Output**: Returns an integer, 1 if the worker is idle and 0 if not.
- **Functions Called**:
    - [`fd_tpool_private_worker`](<#fd_tpool_private_worker>)


---
### fd\_tpool\_exec<!-- {{#callable:fd_tpool_exec}} -->
[View Source →](<../../../../../src/util/tpool/fd_tpool.h#L814>)

Executes a task on a specified worker thread within a thread pool, handling task arguments and synchronization.
- **Inputs**:
    - `tpool`: A pointer to the thread pool (`fd_tpool_t`) where the task will be executed.
    - `worker_idx`: The index of the worker thread within the thread pool that will execute the task.
    - `task`: The task function (`fd_tpool_task_t`) to be executed by the worker thread.
    - `task_tpool`: A pointer to the task-specific thread pool context.
    - `task_t0`: The starting index for the task's range of execution.
    - `task_t1`: The ending index for the task's range of execution.
    - `task_args`: A pointer to the arguments for the task.
    - `task_reduce`: A pointer to the reduction context for the task.
    - `task_stride`: The stride value for the task's execution.
    - `task_l0`: The starting index for the task's l-dimension range.
    - `task_l1`: The ending index for the task's l-dimension range.
    - `task_m0`: The starting index for the task's m-dimension range.
    - `task_m1`: The ending index for the task's m-dimension range.
    - `task_n0`: The starting index for the task's n-dimension range.
    - `task_n1`: The ending index for the task's n-dimension range.
- **Logic and Control Flow**:
    - Retrieve the worker thread from the thread pool using `worker_idx`.
    - Increment the worker's sequence number `seq0` by 1 to signal task dispatch.
    - Set `arg_cnt` to `UINT_MAX` to indicate a task dispatch.
    - Store the task and its arguments in the worker's argument array.
    - Use `FD_COMPILER_MFENCE()` to ensure memory operations are completed before updating `seq0`.
    - Update `seq0` to the new sequence number to signal task readiness.
    - Use `FD_COMPILER_MFENCE()` again to ensure memory operations are completed after updating `seq0`.
    - If the thread pool option `FD_TPOOL_OPT_SLEEP` is set, call [`fd_tpool_private_wake`](<#fd_tpool_private_wake>) to wake the worker thread.
- **Output**: No direct output; the function schedules a task for execution on a worker thread.
- **Functions Called**:
    - [`fd_tpool_private_worker`](<#fd_tpool_private_worker>)
    - [`fd_tpool_private_wake`](<#fd_tpool_private_wake>)


---
### fd\_tpool\_wait<!-- {{#callable:fd_tpool_wait}} -->
[View Source →](<../../../../../src/util/tpool/fd_tpool.h#L852>)

Waits for a specific worker thread in a thread pool to complete its task and exit the EXEC state.
- **Inputs**:
    - `tpool`: A pointer to a constant `fd_tpool_t` structure representing the thread pool.
    - `worker_idx`: An unsigned long integer representing the index of the worker thread to wait for.
- **Logic and Control Flow**:
    - Retrieve the worker thread from the thread pool using the `worker_idx`.
    - Enter an infinite loop to repeatedly check the worker's execution state.
    - Use memory fences (`FD_COMPILER_MFENCE`) to ensure memory operations are completed in order.
    - Read the `seq1` value from the worker's `seq1` field.
    - Compare `seq0` and `seq1` values; if they are equal, break the loop, indicating the worker is not in the EXEC state.
    - If `seq0` and `seq1` are not equal, pause briefly using `FD_SPIN_PAUSE` and retry.
- **Output**: No explicit output; the function ensures the specified worker thread is not in the EXEC state before returning.
- **Functions Called**:
    - [`fd_tpool_private_worker`](<#fd_tpool_private_worker>)


---
### fd\_tpool\_exec\_all\_taskq<!-- {{#callable:fd_tpool_exec_all_taskq}} -->
[View Source →](<../../../../../src/util/tpool/fd_tpool.h#L971>)

Executes a task across a range of worker threads in a thread pool using a task queue strategy.
- **Inputs**:
    - `tpool`: A pointer to the thread pool (`fd_tpool_t`) where the tasks will be executed.
    - `t0`: The starting index of the worker threads in the thread pool to use for task execution.
    - `t1`: The ending index of the worker threads in the thread pool to use for task execution.
    - `task`: A function pointer (`fd_tpool_task_t`) representing the task to execute.
    - `task_tpool`: A pointer to the task-specific thread pool data.
    - `task_args`: A pointer to the arguments for the task.
    - `task_reduce`: A pointer to the reduction data for the task.
    - `task_stride`: The stride value for the task.
    - `task_l0`: The starting index of the task range.
    - `task_l1`: The ending index of the task range.
- **Logic and Control Flow**:
    - Initialize an array `l_next` with the starting task index `task_l0` and the task-specific thread pool data `task_tpool`.
    - Use a memory fence (`FD_COMPILER_MFENCE`) to ensure memory operations are completed before proceeding.
    - Call `fd_tpool_private_exec_all_taskq_node` to execute the task across the specified range of worker threads using the task queue strategy.
- **Output**: No direct output; the function executes tasks in the specified thread pool.


# Function Declarations (Public API)

---
### fd\_tpool\_align<!-- {{#callable_declaration:fd_tpool_align}} -->
[View Source →](<../../../../../src/util/tpool/fd_tpool.h#L661>)

Returns the alignment requirement for a thread pool.
- **Description**: Use this function to obtain the alignment requirement for a memory region intended to be used as a thread pool. This is necessary to ensure that the memory region is correctly aligned for optimal performance and compatibility with the thread pool operations. The function does not require any parameters and can be called at any time to retrieve the alignment value.
- **Inputs**: None
- **Output**: Returns an unsigned long integer representing the alignment requirement for a thread pool.
- **See Also**: [`fd_tpool_align`](<fd_tpool.cxx.md#fd_tpool_align>)  (Implementation)


---
### fd\_tpool\_footprint<!-- {{#callable_declaration:fd_tpool_footprint}} -->
[View Source →](<../../../../../src/util/tpool/fd_tpool.h#L668>)

Calculates the memory footprint for a thread pool.
- **Description**: Use this function to determine the memory size required to create a thread pool that can support a specified maximum number of worker threads. This is useful for allocating the correct amount of memory before initializing a thread pool. The function returns zero if the specified number of workers is outside the valid range, indicating an invalid input.
- **Inputs**:
    - `worker_max`: Specifies the maximum number of worker threads the thread pool should support. Must be in the range [1, FD_TILE_MAX]. If the value is outside this range, the function returns zero.
- **Output**: Returns the size in bytes of the memory footprint required for the thread pool if the input is valid, or zero if the input is invalid.
- **See Also**: [`fd_tpool_footprint`](<fd_tpool.cxx.md#fd_tpool_footprint>)  (Implementation)


---
### fd\_tpool\_init<!-- {{#callable_declaration:fd_tpool_init}} -->
[View Source →](<../../../../../src/util/tpool/fd_tpool.h#L685>)

Initializes a thread pool with specified parameters.
- **Description**: Use this function to set up a thread pool in a given memory region, allowing for efficient parallel task execution. Ensure that the memory region is properly aligned and has sufficient footprint for the specified number of worker threads. This function must be called before any operations on the thread pool and acts as a memory fence to ensure proper ordering of operations. On success, it returns a handle to the initialized thread pool, with worker 0 already set up for use.
- **Inputs**:
    - `mem`: Pointer to a memory region where the thread pool will be initialized. Must not be null and must be aligned according to `fd_tpool_align()`.
    - `worker_max`: Maximum number of worker threads the pool can support. Must be within the range [1, FD_TILE_MAX].
    - `opt`: Bitwise OR of options specifying additional behaviors for the thread pool. The caller retains ownership of this value.
- **Output**: Returns a pointer to the initialized thread pool on success, or NULL if initialization fails due to invalid input or alignment issues.
- **See Also**: [`fd_tpool_init`](<fd_tpool.cxx.md#fd_tpool_init>)  (Implementation)


---
### fd\_tpool\_fini<!-- {{#callable_declaration:fd_tpool_fini}} -->
[View Source →](<../../../../../src/util/tpool/fd_tpool.h#L699>)

Finalizes a thread pool and releases its resources.
- **Description**: Use this function to finalize a thread pool and release its resources. It should be called at most once by a thread that was not part of the thread pool (e.g., a 'worker 0' thread). Ensure that no other operations on the thread pool are in progress when calling this function, and do not perform any operations on the thread pool after this function is called. This function acts as a compiler memory fence.
- **Inputs**:
    - `tpool`: A pointer to the thread pool to finalize. Must not be null. If null, the function logs a warning and returns null.
- **Output**: Returns a pointer to the memory region used by the thread pool on success, or null on failure.
- **See Also**: [`fd_tpool_fini`](<fd_tpool.cxx.md#fd_tpool_fini>)  (Implementation)


---
### fd\_tpool\_worker\_push<!-- {{#callable_declaration:fd_tpool_worker_push}} -->
[View Source →](<../../../../../src/util/tpool/fd_tpool.h#L719>)

Adds a worker tile to the thread pool.
- **Description**: Use this function to add a worker tile to an existing thread pool. The tile index must be valid, non-zero, and not already part of the pool. The function ensures that the tile is idle and not the calling tile. It returns the updated thread pool on success or NULL on failure, logging the reason for failure. Ensure no other operations on the thread pool are in progress when calling this function.
- **Inputs**:
    - `tpool`: A pointer to the thread pool. Must not be null. The caller retains ownership.
    - `tile_idx`: The index of the tile to add. Must be non-zero, not the calling tile, and not already in the pool. Must be less than the total number of tiles.
- **Output**: Returns the updated thread pool on success or NULL on failure.
- **See Also**: [`fd_tpool_worker_push`](<fd_tpool.cxx.md#fd_tpool_worker_push>)  (Implementation)


---
### fd\_tpool\_worker\_pop<!-- {{#callable_declaration:fd_tpool_worker_pop}} -->
[View Source →](<../../../../../src/util/tpool/fd_tpool.h#L735>)

Removes the most recently added worker thread from the thread pool.
- **Description**: Use this function to remove the last worker thread that was added to the thread pool. This is useful when you need to dynamically adjust the number of worker threads in a pool. Ensure that the thread pool is not null and that there is more than one worker thread in the pool before calling this function. The function will fail if the worker to be removed is not idle, logging a warning in such cases. It acts as a compiler memory fence, ensuring memory operations are completed before and after its execution.
- **Inputs**:
    - `tpool`: A pointer to the thread pool from which to remove a worker. Must not be null. The thread pool must have more than one worker thread, and the last worker must be idle.
- **Output**: Returns a pointer to the thread pool on success, or null if the operation fails due to invalid input or if the worker is not idle.
- **See Also**: [`fd_tpool_worker_pop`](<fd_tpool.cxx.md#fd_tpool_worker_pop>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)