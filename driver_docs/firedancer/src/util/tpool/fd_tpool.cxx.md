<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implementation of a thread pool with worker management and task execution capabilities.

# Purpose
The code defines a thread pool implementation in C++ that manages worker threads for executing tasks concurrently. It includes functions for initializing and finalizing a thread pool ([`fd_tpool_init`](<#fd_tpool_init>) and [`fd_tpool_fini`](<#fd_tpool_fini>)), adding and removing worker threads ([`fd_tpool_worker_push`](<#fd_tpool_worker_push>) and [`fd_tpool_worker_pop`](<#fd_tpool_worker_pop>)), and executing tasks across multiple threads. The code uses conditional compilation to include thread-related functionality only if threading is supported (`FD_HAS_THREADS`). The [`fd_tpool_private_worker`](<#fd_tpool_private_worker>) function is a key component that represents the worker thread's main loop, handling task execution and state transitions between idle, executing, and halting states.

The code also defines several task execution strategies, such as round-robin, block, task queue, batch, and raw, which are implemented using macros (`FD_TPOOL_EXEC_ALL_IMPL_HDR` and `FD_TPOOL_EXEC_ALL_IMPL_FTR`). These strategies determine how tasks are distributed and executed across the worker threads. The code uses synchronization primitives like mutexes and condition variables to manage thread states and ensure safe concurrent execution. The thread pool is designed to be flexible, allowing for different task execution patterns and supporting both single-threaded and multi-threaded environments.
# Imports and Dependencies

---
- `fd_tpool.h`
- `pthread.h`


# Global Variables

---
### m\_stride
- **Type**: `ulong`
- **Description**: `m_stride` is a global variable of type `ulong` that represents the difference between two time points, `t1` and `t0`. It is used to calculate the stride for task execution in a thread pool.
- **Use**: Used to determine the stride for task execution in the `fd_tpool_private_exec_all_rrobin_node` function.


---
### m
- **Type**: `ulong`
- **Description**: `m` is a variable of type `ulong` that is initialized with a value calculated to be robust against overflow. It is computed as the sum of `l0` and the minimum of `node_t0-t0` and `ULONG_MAX-l0`. This ensures that the value of `m` does not exceed the maximum value for an unsigned long integer.
- **Use**: `m` is used in a loop to iterate over a range from `l0` to `l1`, incrementing by a stride that is also robust against overflow.


---
### FD\_TPOOL\_EXEC\_ALL\_IMPL\_HDR
- **Type**: `macro`
- **Description**: Defines a macro that generates a function to execute tasks across a thread pool in a specified style. The macro takes a parameter `style` and creates a function `fd_tpool_private_exec_all_##style##_node` that manages task execution and synchronization within a thread pool.
- **Use**: Used to create functions for executing tasks in a thread pool with different execution styles, such as 'rrobin', 'block', 'taskq', and 'batch'.


---
### m0
- **Type**: `ulong`
- **Description**: `m0` is a global variable of type `ulong` used in the `FD_TPOOL_PARTITION` macro to partition a range of tasks for execution.
- **Use**: Used to define the start of a task range in the `FD_TPOOL_PARTITION` macro.


---
### m1
- **Type**: `ulong`
- **Description**: `m1` is a global variable of type `ulong`.
- **Use**: Used in the `FD_TPOOL_PARTITION` macro to define a partition range for task execution.


---
### tpool
- **Type**: `void *`
- **Description**: A global variable that is a pointer to a memory location, initialized with the value of `l_next[1]`. It is used in the context of a task queue implementation within a thread pool.
- **Use**: Used to store a reference to a task pool in a multi-threaded environment.


# Data Structures

---
### fd\_tpool\_private\_worker\_cfg<!-- {{#data_structure:fd_tpool_private_worker_cfg}} -->
[View Source →](<../../../../../src/util/tpool/fd_tpool.cxx#L7>)

- **Type**: ``struct``
- **Members**:
    - ``tpool``: A pointer to a `fd_tpool_t` object, representing the thread pool associated with the worker.
    - ``tile_idx``: An unsigned long integer representing the index of the tile associated with the worker.
- **Description**: Defines the configuration for a private worker in a thread pool, containing a pointer to the thread pool and an index for the tile associated with the worker.


---
### fd\_tpool\_private\_worker\_cfg\_t<!-- {{#data_structure:fd_tpool_private_worker_cfg_t}} -->
[View Source →](<../../../../../src/util/tpool/fd_tpool.cxx#L12>)

- **Type**: ``struct``
- **Members**:
    - ``tpool``: A pointer to an `fd_tpool_t` object.
    - ``tile_idx``: An unsigned long integer representing the tile index.
- **Description**: Defines a configuration for a private worker in a thread pool, containing a pointer to the thread pool and an index for the tile.


# Functions

---
### fd\_tpool\_private\_worker<!-- {{#callable:fd_tpool_private_worker}} -->
[View Source →](<../../../../../src/util/tpool/fd_tpool.cxx#L14>)

Executes tasks in a thread pool worker, handling task execution, idle waiting, and cleanup.
- **Inputs**:
    - `argc`: The index of the worker, cast to an integer.
    - `argv`: A pointer to a configuration structure `fd_tpool_private_worker_cfg_t` containing the thread pool and tile index.
- **Logic and Control Flow**:
    - Initialize `worker_idx` and `cfg` from `argc` and `argv` respectively.
    - Retrieve `tpool` and `tile_idx` from `cfg`.
    - Initialize a `fd_tpool_private_worker_t` structure `worker` and set its `tile_idx`.
    - If threading is enabled, initialize mutex and condition variables if the thread pool option includes sleep.
    - Assign the `worker` to the thread pool's worker array at `worker_idx`.
    - Enter an infinite loop to check the worker's task status.
    - If the worker is idle, pause and continue the loop.
    - If the worker has no task, break the loop to halt.
    - Execute the task based on the task type (`fd_tpool_task_t` or `fd_tpool_task_v2_t`).
    - Catch any exceptions during task execution and log a warning.
    - Update the worker's sequence number to indicate task completion.
    - If threading is enabled, clean up mutex and condition variables before returning.
- **Output**: Returns 0 to indicate successful execution and termination of the worker.
- **Functions Called**:
    - [`fd_tpool_private_worker`](<fd_tpool.h.md#fd_tpool_private_worker>)


---
### fd\_tpool\_private\_wake<!-- {{#callable:fd_tpool_private_wake}} -->
[View Source →](<../../../../../src/util/tpool/fd_tpool.cxx#L127>)

Signals a condition variable to wake a worker thread in a thread pool.
- **Inputs**:
    - ``worker``: A pointer to an `fd_tpool_private_worker_t` structure representing the worker to wake.
- **Logic and Control Flow**:
    - Cast the `lock` and `wake` members of the `worker` structure to `pthread_mutex_t` and `pthread_cond_t` pointers, respectively.
    - Attempt to lock the mutex using `pthread_mutex_lock`; log a warning if it fails.
    - Signal the condition variable using `pthread_cond_signal`; log a warning if it fails.
    - Unlock the mutex using `pthread_mutex_unlock`; log a warning if it fails.
- **Output**: None (void function).


---
### fd\_tpool\_align<!-- {{#callable:fd_tpool_align}} -->
[View Source →](<../../../../../src/util/tpool/fd_tpool.cxx#L137>)

Returns the alignment requirement for a thread pool.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the value of the macro `FD_TPOOL_ALIGN`.
- **Output**: The alignment requirement for a thread pool as an unsigned long integer (`ulong`).


---
### fd\_tpool\_footprint<!-- {{#callable:fd_tpool_footprint}} -->
[View Source →](<../../../../../src/util/tpool/fd_tpool.cxx#L142>)

Calculates the memory footprint required for a thread pool with a specified maximum number of workers.
- **Inputs**:
    - ``worker_max``: The maximum number of workers in the thread pool, which must be between 1 and `FD_TILE_MAX` inclusive.
- **Logic and Control Flow**:
    - Checks if `worker_max` is within the valid range (1 to `FD_TILE_MAX`).
    - If `worker_max` is not valid, returns 0.
    - Calculates the total memory size needed for the thread pool, including the size of `fd_tpool_private_worker_t`, `fd_tpool_t`, and an array of worker pointers, aligned to `FD_TPOOL_ALIGN`.
    - Returns the aligned memory size.
- **Output**: The aligned memory size required for the thread pool, or 0 if `worker_max` is invalid.


---
### fd\_tpool\_init<!-- {{#callable:fd_tpool_init}} -->
[View Source →](<../../../../../src/util/tpool/fd_tpool.cxx#L149>)

Initializes a thread pool with a specified memory block, maximum number of workers, and options.
- **Inputs**:
    - ``mem``: A pointer to a memory block where the thread pool will be initialized.
    - ``worker_max``: The maximum number of workers that the thread pool can support.
    - ``opt``: Options for configuring the thread pool.
- **Logic and Control Flow**:
    - Performs a memory fence operation to ensure memory ordering.
    - Checks if `mem` is NULL and logs a warning if true, then returns NULL.
    - Checks if `mem` is properly aligned using `fd_tpool_align()` and logs a warning if not, then returns NULL.
    - Calculates the memory footprint required for the thread pool using `fd_tpool_footprint(worker_max)` and logs a warning if the footprint is zero, then returns NULL.
    - Initializes the memory block to zero using `fd_memset()`.
    - Sets up the first worker (`worker0`) in the memory block and initializes its sequence numbers.
    - Initializes the thread pool structure (`tpool`) immediately after `worker0` in memory.
    - Sets the options, maximum number of workers, and current worker count in the thread pool structure.
    - Performs another memory fence operation to ensure memory ordering.
    - Assigns `worker0` to the first position in the thread pool's worker array.
    - Performs a final memory fence operation to ensure memory ordering.
    - Returns a pointer to the initialized thread pool.
- **Output**: A pointer to the initialized `fd_tpool_t` structure, or NULL if initialization fails.
- **Functions Called**:
    - [`fd_tpool_align`](<#fd_tpool_align>)
    - [`fd_tpool_footprint`](<#fd_tpool_footprint>)
    - [`fd_tpool_private_worker`](<fd_tpool.h.md#fd_tpool_private_worker>)


---
### fd\_tpool\_fini<!-- {{#callable:fd_tpool_fini}} -->
[View Source →](<../../../../../src/util/tpool/fd_tpool.cxx#L192>)

Finalizes a thread pool by ensuring all workers except the primary one are removed and returns a pointer to the primary worker.
- **Inputs**:
    - ``tpool``: A pointer to the `fd_tpool_t` thread pool to finalize.
- **Logic and Control Flow**:
    - Executes a memory fence to ensure memory operations are completed before proceeding.
    - Checks if `tpool` is `NULL` and logs a warning if true, then returns `NULL`.
    - Enters a loop to remove workers from the pool until only one remains.
    - In each iteration, calls [`fd_tpool_worker_pop`](<#fd_tpool_worker_pop>) to remove a worker and logs a warning if it fails, then returns `NULL`.
    - After the loop, returns a pointer to the primary worker using `fd_tpool_private_worker0`.
- **Output**: A `void*` pointer to the primary worker of the thread pool, or `NULL` if an error occurs.
- **Functions Called**:
    - [`fd_tpool_worker_cnt`](<fd_tpool.h.md#fd_tpool_worker_cnt>)
    - [`fd_tpool_worker_pop`](<#fd_tpool_worker_pop>)


---
### fd\_tpool\_worker\_push<!-- {{#callable:fd_tpool_worker_push}} -->
[View Source →](<../../../../../src/util/tpool/fd_tpool.cxx#L212>)

Adds a new worker to the thread pool if the conditions are met.
- **Inputs**:
    - ``tpool``: A pointer to the thread pool (`fd_tpool_t`) to which the worker will be added.
    - ``tile_idx``: An unsigned long integer representing the index of the tile to be added as a worker.
- **Logic and Control Flow**:
    - Performs a memory fence operation with `FD_COMPILER_MFENCE()` to ensure memory ordering.
    - Checks if `tpool` is NULL and logs a warning if true, then returns NULL.
    - Checks if `tile_idx` is zero and logs a warning if true, then returns NULL.
    - Checks if `tile_idx` is equal to the current tile index (`fd_tile_idx()`) and logs a warning if true, then returns NULL.
    - Checks if `tile_idx` is greater than or equal to the total number of tiles (`fd_tile_cnt()`) and logs a warning if true, then returns NULL.
    - Retrieves the current worker count and checks if it exceeds the maximum allowed workers (`tpool->worker_max`), logging a warning and returning NULL if true.
    - Iterates over existing workers to check if `tile_idx` is already present, logging a warning and returning NULL if true.
    - Configures a new worker with the given `tpool` and `tile_idx`.
    - Sets up arguments for the new worker and performs a memory fence operation.
    - Attempts to create a new tile execution context with `fd_tile_exec_new()`, logging a warning and returning NULL if it fails.
    - Waits for the new worker to be initialized using a spin-wait loop.
    - Increments the worker count in the thread pool and returns the updated `tpool`.
- **Output**: A pointer to the updated thread pool (`fd_tpool_t`) if successful, or NULL if any checks fail.
- **Functions Called**:
    - [`fd_tpool_private_worker`](<fd_tpool.h.md#fd_tpool_private_worker>)


---
### fd\_tpool\_worker\_pop<!-- {{#callable:fd_tpool_worker_pop}} -->
[View Source →](<../../../../../src/util/tpool/fd_tpool.cxx#L275>)

Removes the last worker from the thread pool if it is idle and returns the updated thread pool.
- **Inputs**:
    - ``tpool``: A pointer to the thread pool (`fd_tpool_t *`) from which to pop a worker.
- **Logic and Control Flow**:
    - Ensure memory fence with `FD_COMPILER_MFENCE()` to prevent reordering of operations.
    - Check if `tpool` is `NULL` and log a warning if true, then return `NULL`.
    - Retrieve the current worker count from `tpool` and check if it is less than or equal to 1; if true, log a warning and return `NULL`.
    - Check if the last worker is idle using [`fd_tpool_worker_idle`](<fd_tpool.h.md#fd_tpool_worker_idle>); if not idle, log a warning and return `NULL`.
    - Retrieve the last worker and increment its `seq0` to signal a halt.
    - Set the worker's task to `0UL` and update `seq0` with memory fences to ensure order.
    - If the thread pool option `FD_TPOOL_OPT_SLEEP` is set, wake the worker using [`fd_tpool_private_wake`](<fd_tpool.h.md#fd_tpool_private_wake>).
    - Delete the worker's execution context using `fd_tile_exec_delete` and log any errors or unexpected return values.
    - Decrement the worker count in `tpool` and return the updated `tpool`.
- **Output**: A pointer to the updated thread pool (`fd_tpool_t *`) or `NULL` if an error occurs.
- **Functions Called**:
    - [`fd_tpool_worker_idle`](<fd_tpool.h.md#fd_tpool_worker_idle>)
    - [`fd_tpool_private_worker`](<fd_tpool.h.md#fd_tpool_private_worker>)
    - [`fd_tpool_private_wake`](<fd_tpool.h.md#fd_tpool_private_wake>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)