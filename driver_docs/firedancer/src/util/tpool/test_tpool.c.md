<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests and benchmarks for thread pool operations, including initialization, execution, and partitioning.

# Purpose
The code is a C program designed to test and benchmark a thread pool implementation. It includes various static functions and macros to perform unit tests and benchmarks on the thread pool's functionality, such as task partitioning, worker management, and execution strategies. The program uses assertions to verify the correctness of operations like worker pushing, popping, and task execution. It also includes several test cases to ensure the thread pool's alignment, footprint, and initialization are correct.

The main function initializes a random number generator and performs a series of tests on the thread pool, including partitioning tasks among workers, executing tasks in different modes (e.g., raw, batch, round-robin, block, and task queue), and measuring the performance of these operations. The program uses logging to report the results of the tests and benchmarks, providing insights into the overhead and efficiency of the thread pool operations. The code is structured to handle different configurations and options, making it a comprehensive test suite for evaluating the thread pool's capabilities.
# Imports and Dependencies

---
- `../fd_util.h`


# Global Variables

---
### worker\_tx
- **Type**: ``test_args_t` array`
- **Description**: An array of `test_args_t` structures, where each element corresponds to a worker tile. Each `test_args_t` structure contains various fields such as `tpool`, `t0`, `t1`, `args`, `reduce`, `stride`, `l0`, `l1`, `m0`, `m1`, `n0`, and `n1`, which are used to store task-related parameters for each worker.
- **Use**: Used to store and manage task parameters for each worker tile in a parallel processing environment.


---
### worker\_rx
- **Type**: ``test_args_t` array`
- **Description**: An array of `test_args_t` structures, where each element corresponds to a worker tile. Each structure holds various parameters related to task execution, such as pointers to the thread pool, arguments, and indices for task partitioning.
- **Use**: Stores task execution parameters for each worker tile, which are set and used in functions like `worker_bulk`, `worker_scalar`, and `worker_taskq`.


---
### test\_t0
- **Type**: ``ulong``
- **Description**: `test_t0` is a static global variable of type `ulong`.
- **Use**: It is used to store a value that is compared against other variables in various test functions to ensure correct behavior.


---
### test\_t1
- **Type**: ``ulong``
- **Description**: `test_t1` is a static global variable of type `ulong` (unsigned long). It is used in various test functions to define the upper boundary of a range for testing purposes.
- **Use**: Used to set the upper limit of a range in test functions, ensuring that operations stay within defined boundaries.


---
### test\_i0
- **Type**: ``long``
- **Description**: `test_i0` is a static global variable of type `long`. It is used in various test functions to define a range for block indices in the context of testing thread pool operations.
- **Use**: Used to set the lower bound of block indices in test functions.


---
### test\_i1
- **Type**: ``long``
- **Description**: A static global variable of type `long`.
- **Use**: Used in various test functions to verify conditions related to block indices and counts.


---
### test\_a
- **Type**: ``ulong[]``
- **Description**: An array of unsigned long integers with a size defined by the constant `FD_TPOOL_TASK_ARG_MAX`. The array is declared as a static variable, meaning it is limited to the file scope and retains its value between function calls.
- **Use**: Used to store task arguments for testing purposes in the context of thread pool operations.


---
### FD\_FOR\_ALL\_BEGIN
- **Type**: `macro`
- **Description**: Defines the beginning of a block for a parallel execution construct, specifically for the `bench_for_all` function with a threshold of `1L`. This macro is part of a set of macros used to manage parallel execution in a thread pool.
- **Use**: Used to initiate a parallel execution block for the `bench_for_all` function.


---
### FD\_MAP\_REDUCE\_BEGIN
- **Type**: ``FD_MAP_REDUCE_BEGIN``
- **Description**: Defines the beginning of a map-reduce operation with specific parameters for block threshold, reduce alignment, reduce size, and reduce count. It is used to set up the environment for a map-reduce operation, which involves mapping tasks to workers and reducing the results.
- **Use**: Used to initiate a map-reduce operation with specified parameters for task distribution and result reduction.


# Data Structures

---
### test\_args
- **Type**: ``struct``
- **Members**:
    - `tpool`: A pointer to a thread pool.
    - `t0`: An unsigned long representing the start of a range.
    - `t1`: An unsigned long representing the end of a range.
    - `args`: A pointer to additional arguments.
    - `reduce`: A pointer to a reduction function or data.
    - `stride`: An unsigned long representing the stride value.
    - `l0`: An unsigned long representing the start of a sub-range.
    - `l1`: An unsigned long representing the end of a sub-range.
    - `m0`: An unsigned long representing the start of another sub-range.
    - `m1`: An unsigned long representing the end of another sub-range.
    - `n0`: An unsigned long representing the start of yet another sub-range.
    - `n1`: An unsigned long representing the end of yet another sub-range.
- **Description**: Defines a structure to hold arguments for a test, including pointers to a thread pool, additional arguments, and reduction data, as well as multiple unsigned long values representing various ranges and strides.


---
### test\_args\_t
- **Type**: ``struct``
- **Members**:
    - `tpool`: A pointer to a thread pool.
    - `t0`: An unsigned long integer representing the start of a range.
    - `t1`: An unsigned long integer representing the end of a range.
    - `args`: A pointer to additional arguments.
    - `reduce`: A pointer to a reduction operation.
    - `stride`: An unsigned long integer representing the stride value.
    - `l0`: An unsigned long integer representing the start of a sub-range.
    - `l1`: An unsigned long integer representing the end of a sub-range.
    - `m0`: An unsigned long integer representing the start of another sub-range.
    - `m1`: An unsigned long integer representing the end of another sub-range.
    - `n0`: An unsigned long integer representing the start of yet another sub-range.
    - `n1`: An unsigned long integer representing the end of yet another sub-range.
- **Description**: Defines a structure to hold arguments for worker tasks, including pointers to a thread pool, additional arguments, and reduction operations, as well as multiple unsigned long integers to specify ranges and sub-ranges for task execution.


# Functions

---
### tile\_self\_push\_main<!-- {{#callable:tile_self_push_main}} -->
[View Source →](<../../../../../src/util/tpool/test_tpool.c#L10>)

Pushes the current tile index to the worker pool.
- **Inputs**:
    - `argc`: The number of command-line arguments, which is not used in this function.
    - `argv`: An array of command-line arguments, where the first argument is cast to a pointer to `fd_tpool_t`.
- **Logic and Control Flow**:
    - Cast `argv` to a pointer of type `fd_tpool_t` and assign it to `tpool`.
    - Call `fd_tpool_worker_push` with `tpool` and the current tile index obtained from `fd_tile_idx()`.
    - Use `FD_TEST` to check if the push operation was successful.
    - Return 0 to indicate successful execution.
- **Output**: Returns 0 to indicate successful execution.


---
### tile\_spin\_main<!-- {{#callable:tile_spin_main}} -->
[View Source →](<../../../../../src/util/tpool/test_tpool.c#L19>)

Waits in a loop until a specified condition is met, then returns 0.
- **Inputs**:
    - `argc`: The number of command-line arguments (unused in this function).
    - `argv`: An array of command-line arguments, where the first argument is expected to be a pointer to a `ulong` that indicates when to stop spinning.
- **Logic and Control Flow**:
    - Casts `argv` to a `ulong const *` and assigns it to `done`.
    - Enters a `while` loop that continues as long as the value pointed to by `done` is not volatile and constant.
    - Calls `FD_SPIN_PAUSE()` within the loop to pause execution, likely to reduce CPU usage while waiting.
    - Exits the loop when the condition `!FD_VOLATILE_CONST(*done)` is false.
    - Returns 0 after exiting the loop.
- **Output**: Returns 0 after the loop condition is met.


---
### worker\_spin<!-- {{#callable:worker_spin}} -->
[View Source →](<../../../../../src/util/tpool/test_tpool.c#L28>)

Waits in a loop until a specified condition is met, using a volatile check to pause execution.
- **Inputs**:
    - `tpool`: A pointer to a thread pool, expected to be a pointer to a `ulong`.
    - `t0`: An unsigned long integer, expected to be 1UL.
    - `t1`: An unsigned long integer, expected to be 2UL.
    - `args`: A pointer, expected to be (void *)3UL.
    - `reduce`: A pointer, expected to be (void *)4UL.
    - `stride`: An unsigned long integer, expected to be 5UL.
    - `l0`: An unsigned long integer, expected to be 6UL.
    - `l1`: An unsigned long integer, expected to be 7UL.
    - `m0`: An unsigned long integer, expected to be 8UL.
    - `m1`: An unsigned long integer, expected to be 9UL.
    - `n0`: An unsigned long integer, expected to be 10UL.
    - `n1`: An unsigned long integer, expected to be 11UL.
- **Logic and Control Flow**:
    - Checks that `t0`, `t1`, `args`, `reduce`, `stride`, `l0`, `l1`, `m0`, `m1`, `n0`, and `n1` have specific expected values using `FD_TEST` assertions.
    - Casts `tpool` to a `ulong` pointer and assigns it to `done`.
    - Enters a loop that continues while the value pointed to by `done` is not volatile, using `FD_VOLATILE_CONST` to check the condition.
    - Within the loop, calls `FD_SPIN_PAUSE()` to pause execution.
- **Output**: No return value; the function operates in a loop until a condition is met.


---
### worker\_bulk<!-- {{#callable:worker_bulk}} -->
[View Source →](<../../../../../src/util/tpool/test_tpool.c#L57>)

Assigns task parameters to a specific worker in the `worker_rx` array based on the given index `n0`.
- **Inputs**:
    - `tpool`: Pointer to the thread pool.
    - `t0`: Start time for the task.
    - `t1`: End time for the task.
    - `args`: Pointer to the arguments for the task.
    - `reduce`: Pointer to the reduction function or data.
    - `stride`: Stride value for the task.
    - `l0`: Lower bound of the first range.
    - `l1`: Upper bound of the first range.
    - `m0`: Lower bound of the second range.
    - `m1`: Upper bound of the second range.
    - `n0`: Index of the worker in the `worker_rx` array.
    - `n1`: Upper bound of the third range.
- **Logic and Control Flow**:
    - Check if `n0` is less than `FD_TILE_MAX` using `FD_TEST` macro.
    - Assign `tpool` to `worker_rx[n0].tpool`.
    - Assign `t0` and `t1` to `worker_rx[n0].t0` and `worker_rx[n0].t1`, respectively.
    - Assign `args` to `worker_rx[n0].args`.
    - Assign `reduce` and `stride` to `worker_rx[n0].reduce` and `worker_rx[n0].stride`, respectively.
    - Assign `l0` and `l1` to `worker_rx[n0].l0` and `worker_rx[n0].l1`, respectively.
    - Assign `m0` and `m1` to `worker_rx[n0].m0` and `worker_rx[n0].m1`, respectively.
    - Assign `n0` and `n1` to `worker_rx[n0].n0` and `worker_rx[n0].n1`, respectively.
- **Output**: No return value; the function modifies the `worker_rx` array in place.


---
### worker\_scalar<!-- {{#callable:worker_scalar}} -->
[View Source →](<../../../../../src/util/tpool/test_tpool.c#L75>)

Assigns task parameters to a specific worker in the `worker_rx` array based on the `m0` index.
- **Inputs**:
    - `tpool`: Pointer to the thread pool.
    - `t0`: Start time or index for the task.
    - `t1`: End time or index for the task.
    - `args`: Pointer to additional arguments for the task.
    - `reduce`: Pointer to the reduction function or data.
    - `stride`: Stride value for the task.
    - `l0`: Lower bound of the task's range.
    - `l1`: Upper bound of the task's range.
    - `m0`: Index in the `worker_rx` array to assign the task parameters.
    - `m1`: Additional parameter for the task, possibly an upper bound.
    - `n0`: Another parameter for the task, possibly a lower bound.
    - `n1`: Another parameter for the task, possibly an upper bound.
- **Logic and Control Flow**:
    - Check if `m0` is less than `FD_TILE_MAX` using `FD_TEST` macro.
    - Assign `tpool`, `t0`, `t1`, `args`, `reduce`, `stride`, `l0`, `l1`, `m0`, `m1`, `n0`, and `n1` to the corresponding fields in `worker_rx[m0]`.
- **Output**: No return value; the function modifies the `worker_rx` array in place.


---
### worker\_taskq<!-- {{#callable:worker_taskq}} -->
[View Source →](<../../../../../src/util/tpool/test_tpool.c#L94>)

Initializes a `worker_rx` entry with task queue parameters and performs validation checks.
- **Inputs**:
    - `tpool`: Pointer to the thread pool.
    - `t0`: Start index for the task.
    - `t1`: End index for the task.
    - `args`: Pointer to additional arguments for the task.
    - `reduce`: Pointer to the reduction function or data.
    - `stride`: Stride value for the task.
    - `l0`: Lower bound for the task's range.
    - `l1`: Upper bound for the task's range.
    - `m0`: Index for the `worker_rx` array to store task parameters.
    - `m1`: Upper bound for the `worker_rx` array index.
    - `n0`: Start index for the task queue.
    - `n1`: End index for the task queue.
- **Logic and Control Flow**:
    - Checks if `m0` is less than `FD_TILE_MAX` to ensure valid index range.
    - Validates that `t0` is less than or equal to `n0`, `n1` is equal to `n0 + 1`, and `n1` is less than or equal to `t1` to ensure task queue determinism.
    - Assigns the input parameters to the `worker_rx[m0]` structure, setting `n0` and `n1` to 0.
- **Output**: No return value; modifies the `worker_rx` array in place.


---
### worker\_bench<!-- {{#callable:worker_bench}} -->
[View Source →](<../../../../../src/util/tpool/test_tpool.c#L114>)

Does nothing with its input parameters and has no functional implementation.
- **Inputs**:
    - `tpool`: A pointer to a thread pool, but it is not used in the function.
    - `t0`: An unsigned long integer, not used in the function.
    - `t1`: An unsigned long integer, not used in the function.
    - `args`: A pointer to arguments, not used in the function.
    - `reduce`: A pointer to a reduction operation, not used in the function.
    - `stride`: An unsigned long integer, not used in the function.
    - `l0`: An unsigned long integer, not used in the function.
    - `l1`: An unsigned long integer, not used in the function.
    - `m0`: An unsigned long integer, not used in the function.
    - `m1`: An unsigned long integer, not used in the function.
    - `n0`: An unsigned long integer, not used in the function.
    - `n1`: An unsigned long integer, not used in the function.
- **Logic and Control Flow**:
    - The function takes multiple parameters but does not use any of them.
    - All parameters are cast to void to suppress unused variable warnings.
    - The function body is empty, indicating no operations are performed.
- **Output**: No output is produced as the function does not perform any operations.


---
### FD\_FOR\_ALL\_BEGIN<!-- {{#callable:FD_FOR_ALL_BEGIN}} -->
[View Source →](<../../../../../src/util/tpool/test_tpool.c#L181>)

Validates specific conditions and constraints for a parallel processing task with six arguments.
- **Inputs**:
    - `block_thresh`: The threshold value for block processing, expected to be 7L.
    - `reduce_align`: The alignment requirement for reduction, expected to be 1UL.
    - `reduce_sz`: The size of the reduction, expected to be 0UL.
    - `reduce_cnt`: The count of reductions, expected to be 0L.
    - `tpool_t0`: The start time of the thread pool, expected to be within the range of `test_t0` and `test_t1`.
    - `tpool_t1`: The end time of the thread pool, expected to be within the range of `test_t0` and `test_t1`.
    - `block_i0`: The start index of the block, expected to be within the range of `test_i0` and `test_i1`.
    - `block_i1`: The end index of the block, expected to be within the range of `test_i0` and `test_i1`.
    - `block_cnt`: The count of blocks, expected to be equal to the difference between `block_i1` and `block_i0`.
    - `arg_cnt`: The count of arguments, expected to be 6UL.
    - `arg`: The array of arguments, expected to match `test_a` for the first `arg_cnt` elements.
- **Logic and Control Flow**:
    - Check if `block_thresh` is equal to 7L.
    - Verify `reduce_align` is equal to 1UL, `reduce_sz` is equal to 0UL, and `reduce_cnt` is equal to 0L.
    - Ensure `tpool_t0` is greater than or equal to `test_t0` and less than `tpool_t1`, and `tpool_t1` is less than or equal to `test_t1`.
    - Confirm `block_i0` is greater than or equal to `test_i0`, `block_i1` is less than or equal to `test_i1`, and `block_cnt` is equal to `block_i1 - block_i0`.
    - Check if `arg_cnt` is equal to 6UL.
    - Verify that the memory content of `arg` matches `test_a` for the first `arg_cnt` elements using `memcmp`.
- **Output**: No output is returned; the function performs validation checks using assertions.


---
### FD\_MAP\_REDUCE\_BEGIN<!-- {{#callable:FD_MAP_REDUCE_BEGIN}} -->
[View Source →](<../../../../../src/util/tpool/test_tpool.c#L281>)

Validates the parameters and conditions for a map-reduce operation with specific thresholds, alignments, sizes, and counts.
- **Inputs**:
    - `block_thresh`: The threshold for the block, expected to be 7L.
    - `reduce_align`: The alignment for the reduction, expected to be 128UL.
    - `reduce_sz`: The size for the reduction, expected to be 256UL.
    - `reduce_cnt`: The count for the reduction, expected to be 6L.
    - `tpool_t0`: The start time of the thread pool, expected to be within the test time range.
    - `tpool_t1`: The end time of the thread pool, expected to be within the test time range.
    - `block_i0`: The start index of the block, expected to be within the test index range.
    - `block_i1`: The end index of the block, expected to be within the test index range.
    - `block_cnt`: The count of blocks, expected to be equal to the difference between block_i1 and block_i0.
    - `arg_cnt`: The count of arguments, expected to be 6UL.
    - `arg`: An array of arguments where the first element must be aligned to reduce_align and the rest must match the test array.
- **Logic and Control Flow**:
    - Check if `block_thresh` is equal to 7L.
    - Check if `reduce_align` is equal to 128UL.
    - Check if `reduce_sz` is equal to 256UL.
    - Check if `reduce_cnt` is equal to 6L.
    - Verify that `tpool_t0` and `tpool_t1` are within the range of `test_t0` and `test_t1`.
    - Verify that `block_i0` and `block_i1` are within the range of `test_i0` and `test_i1`, and that `block_cnt` equals `block_i1 - block_i0`.
    - Check if `arg_cnt` is equal to 6UL.
    - Ensure the first element of `arg` is aligned to `reduce_align`.
    - Compare the remaining elements of `arg` with `test_a` to ensure they match.
- **Output**: No output is returned; the function performs validation checks.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/util/tpool/test_tpool.c#L300>)

Executes a series of tests and benchmarks on a thread pool implementation, including partitioning, alignment, initialization, execution, and various execution strategies.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Initializes the environment and command-line options using `fd_boot` and `fd_env_strip_cmdline_ulong`.
    - Creates a random number generator using `fd_rng_new` and `fd_rng_join`.
    - Logs the start of testing for `FD_TPOOL_PARTITION` and performs a series of partitioning tests using random values.
    - Logs the start of alignment and footprint tests, verifying alignment and footprint calculations for various worker counts.
    - Initializes a memory pool for the thread pool and tests initialization and finalization with various parameters.
    - Tests worker push operations, ensuring correct behavior for valid and invalid operations.
    - If more than one tile is available, tests execution and waiting for worker tasks using `fd_tpool_exec` and `fd_tpool_wait`.
    - Tests various execution strategies (`fd_tpool_exec_all_raw`, `fd_tpool_exec_all_batch`, `fd_tpool_exec_all_rrobin`, `fd_tpool_exec_all_block`, and `fd_tpool_exec_all_taskq`) with random job parameters.
    - Tests `FD_FOR_ALL` and `FD_MAP_REDUCE` macros with random parameters and verifies correctness.
    - Benchmarks execution strategies and logs performance metrics.
    - Finalizes the thread pool and deletes the random number generator.
    - Logs a pass message and halts the program.
- **Output**: Returns 0 to indicate successful execution.



---
Made with ❤️ by [Driver](https://www.driver.ai/)