<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for reading and writing PCAP files, including packet iteration and header management.

# Purpose
The code is a C module that provides functionality for reading and writing packet capture (PCAP) files. It includes definitions for PCAP file headers and packet headers, as well as functions to iterate over packets in a PCAP file, read packet data, and write packet data to a file or output stream. The module supports both Ethernet and Linux cooked capture formats, as indicated by the constants `FD_PCAP_HDR_NETWORK_ETHERNET` and `FD_PCAP_HDR_NETWORK_LINUX_SLL`. The code uses structures such as `fd_pcap_hdr_t`, `fd_pcap_pkt_hdr_t`, and `fd_pcap_sll_hdr_t` to represent different parts of the PCAP file and packet headers.

The module defines several functions for handling PCAP data. The [`fd_pcap_iter_new`](<#fd_pcap_iter_new>) function initializes a new iterator for reading packets from a PCAP file, while [`fd_pcap_iter_next`](<#fd_pcap_iter_next>) and [`fd_pcap_iter_next_split`](<#fd_pcap_iter_next_split>) are used to retrieve the next packet from the file. The [`fd_pcap_fwrite_hdr`](<#fd_pcap_fwrite_hdr>) and [`fd_pcap_fwrite_pkt`](<#fd_pcap_fwrite_pkt>) functions write PCAP headers and packets to a file, respectively. Additionally, the module provides functions for writing to buffered output streams, such as [`fd_pcap_ostream_hdr`](<#fd_pcap_ostream_hdr>) and [`fd_pcap_ostream_pkt`](<#fd_pcap_ostream_pkt>). The code includes error handling and logging for various failure scenarios, such as file read errors and unsupported network types.
# Imports and Dependencies

---
- `fd_pcap.h`
- `fd_ip4.h`
- `fd_udp.h`
- `stdio.h`
- `errno.h`


# Data Structures

---
### fd\_pcap\_hdr
- **Type**: ``struct``
- **Members**:
    - `magic_number`: Stores a unique identifier for the PCAP file format.
    - `version_major`: Indicates the major version number of the PCAP format.
    - `version_minor`: Indicates the minor version number of the PCAP format.
    - `thiszone`: Represents the correction time in seconds between GMT and the local timezone.
    - `sigfigs`: Holds the accuracy of timestamps in the capture.
    - `snaplen`: Specifies the maximum length of captured packets.
    - `network`: Defines the data link type of the capture.
- **Description**: Defines the global header for a PCAP file, which includes metadata such as version information, timezone offset, timestamp accuracy, maximum packet length, and network type. This header is essential for interpreting the structure and content of the PCAP file.


---
### fd\_pcap\_hdr\_t
- **Type**: ``struct``
- **Members**:
    - `magic_number`: Stores a unique identifier for the PCAP file format.
    - `version_major`: Indicates the major version number of the PCAP format.
    - `version_minor`: Indicates the minor version number of the PCAP format.
    - `thiszone`: Represents the time zone offset from UTC in seconds.
    - `sigfigs`: Holds the accuracy of timestamps in the capture.
    - `snaplen`: Specifies the maximum length of captured packets.
    - `network`: Defines the data link type of the captured packets.
- **Description**: Defines the header structure for a PCAP file, which includes metadata such as version information, time zone, and network type, necessary for interpreting the packet capture data.


---
### fd\_pcap\_pkt\_hdr
- **Type**: ``struct``
- **Members**:
    - ``sec``: Stores the seconds part of the timestamp in host byte order.
    - ``usec``: Stores the microseconds part of the timestamp in host byte order, assuming nanosecond capture.
    - ``incl_len``: Indicates the number of bytes of packet data actually captured in host byte order.
    - ``orig_len``: Represents the original length of the packet before any truncation in host byte order.
- **Description**: Defines the header for a packet in a pcap file, containing timestamp and length information for captured network packets.


---
### fd\_pcap\_pkt\_hdr\_t
- **Type**: ``struct``
- **Members**:
    - ``sec``: Stores the seconds part of the timestamp in host order.
    - ``usec``: Stores the microseconds part of the timestamp in host order, assuming nanosecond capture.
    - ``incl_len``: Indicates the number of bytes of packet data actually captured in host order.
    - ``orig_len``: Represents the original length of the packet before any truncation in host order.
- **Description**: Defines a packet header structure used in PCAP (Packet Capture) files, which includes timestamp information and packet length details. The structure is used to store metadata about captured network packets, such as the time of capture and the size of the packet data included in the capture.


---
### fd\_pcap\_sll\_hdr\_t
- **Type**: ``struct``
- **Members**:
    - ``dir``: Indicates the direction of the packet.
    - ``ha_type``: Specifies the hardware address type.
    - ``ha_len``: Defines the length of the hardware address.
    - ``ha``: Stores the hardware address as an array of 8 unsigned characters.
    - ``net_type``: Represents the network type.
- **Description**: Defines a header structure for Linux cooked-mode capture in a pcap file, containing fields for direction, hardware address type and length, the hardware address itself, and the network type.


# Functions

---
### fd\_pcap\_iter\_new<!-- {{#callable:fd_pcap_iter_new}} -->
[View Source →](<../../../../../src/util/net/fd_pcap.c#L42>)

Initializes a new packet capture iterator from a file pointer, validating the file's alignment, magic number, and network type.
- **Inputs**:
    - `_file`: A pointer to a file object, expected to be aligned and contain a valid pcap header.
- **Logic and Control Flow**:
    - Cast `_file` to a `FILE` pointer named `file`.
    - Check if `file` is `NULL`; if so, log a warning and return `NULL`.
    - Check if `file` is not aligned to a 2-byte boundary; if so, log a warning and return `NULL`.
    - Read the pcap header from `file` into a `fd_pcap_hdr_t` structure named `pcap`.
    - Check if the `magic_number` in `pcap` is valid (either `0xa1b2c3d4U` or `0xa1b23c4dU`); if not, log a warning and return `NULL`.
    - Check if the `network` type in `pcap` is either Ethernet or Linux SLL; if not, log a warning and return `NULL`.
    - Determine if the file is a cooked capture by checking if the `network` type is Linux SLL, and store this as `cooked`.
    - Return a pointer to a new `fd_pcap_iter_t` by combining the `file` pointer and `cooked` flag.
- **Output**: A pointer to a `fd_pcap_iter_t` structure, or `NULL` if any validation checks fail.


---
### fd\_pcap\_iter\_next<!-- {{#callable:fd_pcap_iter_next}} -->
[View Source →](<../../../../../src/util/net/fd_pcap.c#L79>)

Reads the next packet from a pcap file, processes it, and returns its size.
- **Inputs**:
    - ``iter``: A pointer to an `fd_pcap_iter_t` structure that represents the current state of the pcap file iteration.
    - ``pkt``: A pointer to a buffer where the packet data will be stored.
    - ``pkt_max``: The maximum size of the packet that can be stored in the `pkt` buffer.
    - ``_pkt_ts``: A pointer to a `long` where the timestamp of the packet will be stored.
- **Logic and Control Flow**:
    - Retrieve the file pointer and cooked flag from the `iter` structure.
    - Read the packet header from the pcap file into a `fd_pcap_pkt_hdr_t` structure.
    - Check if the packet is truncated by comparing `incl_len` and `orig_len`. If truncated, log a warning and return 0.
    - Determine the size of the pcap header based on whether the packet is cooked or not.
    - Check if the packet size is less than the header size or greater than `pkt_max`. If so, log a warning and return 0.
    - If the packet is cooked, read the SLL header, construct an Ethernet-compatible header, and adjust the packet size.
    - If the packet is not cooked, read the Ethernet header directly.
    - Read the remaining packet data into the `pkt` buffer.
    - Store the packet timestamp in `_pkt_ts` and return the packet size.
- **Output**: Returns the size of the packet read, or 0 if an error occurs.
- **Functions Called**:
    - [`fd_pcap_iter_file`](<fd_pcap.h.md#fd_pcap_iter_file>)
    - [`fd_pcap_iter_type`](<fd_pcap.h.md#fd_pcap_iter_type>)


---
### fd\_pcap\_iter\_next\_split<!-- {{#callable:fd_pcap_iter_next_split}} -->
[View Source →](<../../../../../src/util/net/fd_pcap.c#L165>)

Processes a packet from a pcap file, splitting it into header and payload buffers, and returns the packet timestamp.
- **Inputs**:
    - ``iter``: A pointer to an `fd_pcap_iter_t` structure representing the current position in the pcap file.
    - ``hdr_buf``: A pointer to a buffer where the packet header will be stored.
    - ``hdr_sz``: A pointer to an `ulong` that initially contains the size of `hdr_buf` and will be updated with the actual size of the header read.
    - ``pld_buf``: A pointer to a buffer where the packet payload will be stored.
    - ``pld_sz``: A pointer to an `ulong` that initially contains the size of `pld_buf` and will be updated with the actual size of the payload read.
    - ``_pkt_ts``: A pointer to a `long` where the packet timestamp will be stored.
- **Logic and Control Flow**:
    - Retrieve the file and cooked status from the `iter` structure.
    - Read the packet header from the file into a `fd_pcap_pkt_hdr_t` structure.
    - Check if the packet is truncated by comparing `incl_len` and `orig_len`.
    - Determine the size of the pcap header based on whether the file is cooked or not.
    - Check if the packet size is valid and fits within the provided buffers.
    - If the file is cooked, read the SLL header and construct an Ethernet-compatible header.
    - If the file is not cooked, read the Ethernet header directly into `hdr_buf`.
    - Adjust the remaining header and payload sizes after reading the Ethernet header.
    - Process any VLAN tags by reading them into `hdr_buf` and updating the remaining sizes.
    - If the packet is an IP packet, read the IP header and any options into `hdr_buf`.
    - If the packet is a UDP packet, read the UDP header into `hdr_buf`.
    - Check if the payload buffer is large enough for the remaining packet data.
    - Read the payload into `pld_buf`.
    - Update `pld_sz`, `hdr_sz`, and `_pkt_ts` with the sizes and timestamp of the packet.
- **Output**: Returns 1 on success, or 0 if an error occurs or the packet is invalid.
- **Functions Called**:
    - [`fd_pcap_iter_file`](<fd_pcap.h.md#fd_pcap_iter_file>)
    - [`fd_pcap_iter_type`](<fd_pcap.h.md#fd_pcap_iter_type>)


---
### fd\_pcap\_write\_hdr<!-- {{#callable:fd_pcap_write_hdr}} -->
[View Source →](<../../../../../src/util/net/fd_pcap.c#L352>)

Initializes a `fd_pcap_hdr_t` structure with predefined values and a specified link layer type.
- **Inputs**:
    - ``hdr``: A pointer to a `fd_pcap_hdr_t` structure that will be initialized.
    - ``link_layer_type``: An unsigned integer representing the type of link layer to set in the header.
- **Logic and Control Flow**:
    - Set `hdr->magic_number` to `0xa1b23c4dU` to identify the file as a pcap file.
    - Set `hdr->version_major` to `2` and `hdr->version_minor` to `4` to specify the pcap version.
    - Set `hdr->thiszone` to `0`, indicating the timezone offset is unknown.
    - Set `hdr->sigfigs` to `0U`, indicating no significant figures for timestamps.
    - Set `hdr->snaplen` to `FD_PCAP_SNAPLEN`, defining the maximum length of captured packets.
    - Set `hdr->network` to `link_layer_type`, specifying the type of network link layer.
- **Output**: The function does not return a value; it modifies the `fd_pcap_hdr_t` structure pointed to by `hdr`.


---
### fd\_pcap\_fwrite\_hdr<!-- {{#callable:fd_pcap_fwrite_hdr}} -->
[View Source →](<../../../../../src/util/net/fd_pcap.c#L364>)

Writes a PCAP file header to a specified file stream.
- **Inputs**:
    - `file`: A pointer to a `FILE` stream where the PCAP header will be written.
    - `link_layer_type`: An unsigned integer representing the link layer type for the PCAP header.
- **Logic and Control Flow**:
    - Declare a `fd_pcap_hdr_t` structure named `hdr` to hold the PCAP header data.
    - Call [`fd_pcap_write_hdr`](<#fd_pcap_write_hdr>) to populate `hdr` with the appropriate PCAP header information based on `link_layer_type`.
    - Use `fwrite` to write the `hdr` structure to the file stream pointed to by `file`.
- **Output**: Returns the number of elements successfully written, which should be 1 if the header is written successfully.
- **Functions Called**:
    - [`fd_pcap_write_hdr`](<#fd_pcap_write_hdr>)


---
### fd\_pcap\_ostream\_hdr<!-- {{#callable:fd_pcap_ostream_hdr}} -->
[View Source →](<../../../../../src/util/net/fd_pcap.c#L372>)

Writes a PCAP file header to a buffered output stream.
- **Inputs**:
    - ``out``: A pointer to a `fd_io_buffered_ostream_t` structure representing the output stream where the header will be written.
    - ``link_layer_type``: An unsigned integer specifying the type of link layer for the PCAP header.
- **Logic and Control Flow**:
    - Declare a `fd_pcap_hdr_t` structure named `hdr` to hold the PCAP header data.
    - Call [`fd_pcap_write_hdr`](<#fd_pcap_write_hdr>) to populate `hdr` with the appropriate PCAP header information using the provided `link_layer_type`.
    - Write the populated `hdr` to the output stream `out` using `fd_io_buffered_ostream_write`.
    - Return the result of the `fd_io_buffered_ostream_write` function call, which indicates success or failure of the write operation.
- **Output**: Returns an integer indicating the success or failure of writing the header to the output stream.
- **Functions Called**:
    - [`fd_pcap_write_hdr`](<#fd_pcap_write_hdr>)


---
### fd\_pcap\_pkt\_sz<!-- {{#callable:fd_pcap_pkt_sz}} -->
[View Source →](<../../../../../src/util/net/fd_pcap.c#L380>)

Calculates the total packet size for a pcap file, including headers, and checks for overflow or size limits.
- **Inputs**:
    - `hdr_sz`: The size of the packet header in bytes.
    - `payload_sz`: The size of the packet payload in bytes.
- **Logic and Control Flow**:
    - Calculate the initial packet size by adding `hdr_sz` and `payload_sz`.
    - Check if the calculated packet size is less than `hdr_sz` to detect overflow or if it exceeds the maximum allowed size (`FD_PCAP_SNAPLEN` minus the sizes of `fd_pcap_pkt_hdr_t` and `uint`).
    - If either condition is true, log a warning and return -1.
    - Add the sizes of `fd_pcap_pkt_hdr_t` and `uint` to the packet size.
    - Return the total packet size as a `long`.
- **Output**: Returns the total packet size as a `long`, or -1 if the size is too large or an overflow occurs.


---
### fd\_pcap\_pkt<!-- {{#callable:fd_pcap_pkt}} -->
[View Source →](<../../../../../src/util/net/fd_pcap.c#L393>)

Constructs a PCAP packet from given header and payload data, and writes it to the output buffer.
- **Inputs**:
    - `out`: A pointer to the output buffer where the constructed PCAP packet will be stored.
    - `ts`: A timestamp in nanoseconds representing the time the packet was captured.
    - `_hdr`: A pointer to the packet header data.
    - `hdr_sz`: The size of the packet header data in bytes.
    - `_payload`: A pointer to the packet payload data.
    - `payload_sz`: The size of the packet payload data in bytes.
    - `_fcs`: The frame check sequence (FCS) value for the packet.
- **Logic and Control Flow**:
    - Calculate the total packet size using [`fd_pcap_pkt_sz`](<#fd_pcap_pkt_sz>) with `hdr_sz` and `payload_sz` as inputs.
    - If the calculated packet size is negative, return -1 indicating an error.
    - Initialize a pointer `p` to the start of the output buffer `out`.
    - Cast and assign the first part of the buffer to a `fd_pcap_pkt_hdr_t` structure and update `p` to point past this header.
    - Copy the header data from `_hdr` to the buffer location pointed by `p` and update `p` by `hdr_sz`.
    - Copy the payload data from `_payload` to the buffer location pointed by `p` and update `p` by `payload_sz`.
    - Store the `_fcs` value at the current location of `p` and update `p` by the size of `uint`.
    - Set the `sec` and `usec` fields of the `fd_pcap_pkt_hdr_t` structure using the provided timestamp `ts`.
    - Set the `incl_len` and `orig_len` fields of the `fd_pcap_pkt_hdr_t` structure to the size of the packet excluding the PCAP header size.
    - Return the total packet size.
- **Output**: Returns the total size of the constructed PCAP packet, or -1 if an error occurs during size calculation.
- **Functions Called**:
    - [`fd_pcap_pkt_sz`](<#fd_pcap_pkt_sz>)


---
### fd\_pcap\_fwrite\_pkt<!-- {{#callable:fd_pcap_fwrite_pkt}} -->
[View Source →](<../../../../../src/util/net/fd_pcap.c#L422>)

Writes a packet to a file in PCAP format after constructing it with a timestamp, header, payload, and frame check sequence.
- **Inputs**:
    - `ts`: The timestamp for the packet, in nanoseconds.
    - `_hdr`: A pointer to the packet header data.
    - `hdr_sz`: The size of the packet header in bytes.
    - `_payload`: A pointer to the packet payload data.
    - `payload_sz`: The size of the packet payload in bytes.
    - `_fcs`: The frame check sequence for the packet.
    - `file`: A pointer to the file where the packet will be written.
- **Logic and Control Flow**:
    - Create a buffer `pkt` with a size of `FD_PCAP_SNAPLEN` to hold the packet data.
    - Call [`fd_pcap_pkt`](<#fd_pcap_pkt>) to construct the packet in `pkt` using the provided timestamp, header, payload, and frame check sequence.
    - Check if [`fd_pcap_pkt`](<#fd_pcap_pkt>) returns a negative value, indicating an error, and return 0 if so.
    - Attempt to write the constructed packet to the specified file using `fwrite`.
    - If `fwrite` fails, log a warning and return 0.
    - Return 1 to indicate successful writing of the packet.
- **Output**: Returns 1 if the packet is successfully written to the file, otherwise returns 0.
- **Functions Called**:
    - [`fd_pcap_pkt`](<#fd_pcap_pkt>)


---
### fd\_pcap\_ostream\_pkt<!-- {{#callable:fd_pcap_ostream_pkt}} -->
[View Source →](<../../../../../src/util/net/fd_pcap.c#L437>)

Writes a packet to a buffered output stream in PCAP format.
- **Inputs**:
    - `out`: A pointer to a `fd_io_buffered_ostream_t` structure representing the output stream.
    - `ts`: A long integer representing the timestamp of the packet in nanoseconds.
    - `_hdr`: A pointer to the packet header data.
    - `hdr_sz`: An unsigned long integer representing the size of the packet header.
    - `_payload`: A pointer to the packet payload data.
    - `payload_sz`: An unsigned long integer representing the size of the packet payload.
    - `_fcs`: An unsigned integer representing the frame check sequence.
- **Logic and Control Flow**:
    - Calculate the total packet size using [`fd_pcap_pkt_sz`](<#fd_pcap_pkt_sz>) with `hdr_sz` and `payload_sz` as inputs.
    - If the calculated packet size is negative, return `EINVAL`.
    - Initialize a `fd_pcap_pkt_hdr_t` structure with the timestamp split into seconds and nanoseconds, and set the included and original lengths to the packet size minus the header size.
    - Write the PCAP packet header to the output stream using `fd_io_buffered_ostream_write`.
    - If writing the PCAP packet header fails, return the error code.
    - Write the packet header data to the output stream.
    - If writing the packet header fails, return the error code.
    - Write the packet payload data to the output stream.
    - If writing the packet payload fails, return the error code.
    - Write the frame check sequence to the output stream.
    - If writing the frame check sequence fails, return the error code.
    - Return 0 to indicate success.
- **Output**: Returns 0 on success or an error code if writing to the output stream fails.
- **Functions Called**:
    - [`fd_pcap_pkt_sz`](<#fd_pcap_pkt_sz>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)