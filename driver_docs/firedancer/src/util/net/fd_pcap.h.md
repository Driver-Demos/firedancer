<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Header file for handling pcap file operations, including iterating, reading, and writing packets.

# Purpose
The code is a C header file that defines an interface for handling PCAP (Packet Capture) files. It provides functionality to read and write packets in PCAP format, which is commonly used for capturing network traffic. The file defines several constants, types, and function prototypes that facilitate the creation, manipulation, and destruction of PCAP iterators. These iterators are used to traverse PCAP files, extract packets, and manage the underlying file streams.

Key components include the `fd_pcap_iter_t` type, which represents an opaque handle for a PCAP iterator, and functions such as `fd_pcap_iter_new`, [`fd_pcap_iter_next`](<#fd_pcap_iter_next>), and [`fd_pcap_iter_delete`](<#fd_pcap_iter_delete>), which manage the lifecycle and operation of these iterators. The file also provides functions for writing PCAP headers and packets to streams, such as [`fd_pcap_fwrite_hdr`](<#fd_pcap_fwrite_hdr>) and [`fd_pcap_fwrite_pkt`](<#fd_pcap_fwrite_pkt>). The interface supports different link layer types and handles both Ethernet and cooked capture formats. The functions are designed to work with both standard file streams and buffered output streams, providing flexibility in how PCAP data is processed and stored.
# Imports and Dependencies

---
- `../log/fd_log.h`
- `fd_eth.h`


# Data Structures

---
### fd\_pcap\_iter\_t
- **Type**: ``struct``
- **Description**: `fd_pcap_iter_t` is an opaque handle for a pcap iterator, which is used to read packets from a pcap file stream. The iterator manages the file stream and provides functions to extract packets, retrieve the file stream, and determine the type of pcap file being iterated over. It supports operations such as creating a new iterator, deleting it, and extracting packets either as a whole or split into headers and payloads. The iterator abstracts the details of the underlying pcap file format, allowing users to focus on packet processing.


# Functions

---
### fd\_pcap\_iter\_file<!-- {{#callable:fd_pcap_iter_file}} -->
[View Source →](<../../../../../src/util/net/fd_pcap.h#L36>)

Returns the file stream associated with a given pcap iterator by masking out the least significant bit of the iterator pointer.
- **Inputs**:
    - ``iter``: A pointer to an `fd_pcap_iter_t` structure, representing the pcap iterator.
- **Logic and Control Flow**:
    - Casts the `iter` pointer to an unsigned long integer.
    - Applies a bitwise AND operation with the complement of 1 (`~1UL`) to clear the least significant bit.
    - Casts the result back to a `void *` pointer and returns it.
- **Output**: A `void *` pointer to the file stream associated with the pcap iterator.


---
### fd\_pcap\_iter\_type<!-- {{#callable:fd_pcap_iter_type}} -->
[View Source →](<../../../../../src/util/net/fd_pcap.h#L37>)

Determines the type of pcap file being iterated over by checking the least significant bit of the iterator pointer.
- **Inputs**:
    - ``iter``: A pointer to an `fd_pcap_iter_t` structure, representing the pcap iterator.
- **Logic and Control Flow**:
    - Casts the `iter` pointer to an `ulong`.
    - Performs a bitwise AND operation with `1UL` to isolate the least significant bit.
    - Returns the result of the bitwise operation, which indicates the type of pcap file.
- **Output**: Returns an `ulong` representing the type of pcap file, where `0UL` indicates Ethernet and `1UL` indicates Cooked.


---
### fd\_pcap\_iter\_delete<!-- {{#callable:fd_pcap_iter_delete}} -->
[View Source →](<../../../../../src/util/net/fd_pcap.h#L42>)

Returns the file stream associated with a `fd_pcap_iter_t` iterator and transfers ownership of the stream to the caller.
- **Inputs**:
    - `iter`: A pointer to a `fd_pcap_iter_t` structure, representing the pcap iterator to be deleted.
- **Logic and Control Flow**:
    - Calls [`fd_pcap_iter_file`](<#fd_pcap_iter_file>) with the `iter` argument to retrieve the file stream associated with the iterator.
    - Returns the file stream to the caller, effectively transferring ownership of the stream.
- **Output**: The function returns a pointer to the file stream associated with the `fd_pcap_iter_t` iterator.
- **Functions Called**:
    - [`fd_pcap_iter_file`](<#fd_pcap_iter_file>)


# Function Declarations (Public API)

---
### fd\_pcap\_iter\_next<!-- {{#callable_declaration:fd_pcap_iter_next}} -->
[View Source →](<../../../../../src/util/net/fd_pcap.h#L68>)

Extracts the next packet from a pcap stream.
- **Description**: Use this function to read the next packet from a pcap file stream using an iterator. It returns the size of the packet in bytes on success or 0 on failure. Failures can occur due to end-of-file, read errors, file corruption, truncated packets, or if the packet size exceeds the provided maximum. On success, the packet data is stored in the provided buffer, and the packet timestamp is updated. The function logs warnings for all failures except normal end-of-file. The iterator advances to the next packet in the stream.
- **Inputs**:
    - `iter`: A pointer to an `fd_pcap_iter_t` iterator. Must be a valid iterator initialized for reading a pcap file. The iterator's underlying stream is advanced on success.
    - `pkt`: A pointer to a memory buffer where the packet data will be stored. The buffer must be large enough to hold the packet data, up to `pkt_max` bytes.
    - `pkt_max`: The maximum number of bytes that can be written to `pkt`. Must be a positive value. If the packet size exceeds this value, the function returns 0 and logs a warning.
    - `_pkt_ts`: A pointer to a `long` where the packet timestamp will be stored on success. The timestamp is assumed to be in nanoseconds.
- **Output**: Returns the size of the packet in bytes on success, or 0 on failure. On success, `pkt` contains the packet data and `_pkt_ts` contains the timestamp. On failure, `pkt` and `_pkt_ts` are not modified.
- **See Also**: [`fd_pcap_iter_next`](<fd_pcap.c.md#fd_pcap_iter_next>)  (Implementation)


---
### fd\_pcap\_iter\_next\_split<!-- {{#callable_declaration:fd_pcap_iter_next_split}} -->
[View Source →](<../../../../../src/util/net/fd_pcap.h#L109>)

Extracts the next packet from a pcap stream into separate header and payload buffers.
- **Description**: Use this function to read the next packet from a pcap file and split it into header and payload components. It is important to ensure that the buffers provided for headers and payloads are large enough to accommodate the data. The function returns 1 on success and 0 on failure, with failure reasons including end-of-file, read errors, file corruption, or insufficient buffer sizes. On success, the function updates the sizes of the data written to the buffers and provides the packet timestamp. If the function fails, the contents of the buffers may be partially written, and the timestamp remains unchanged.
- **Inputs**:
    - `iter`: A pointer to an `fd_pcap_iter_t` iterator. Must not be null and should be a valid iterator for a pcap file.
    - `hdr_buf`: A pointer to a writable memory region for storing packet headers. Must not be null and should have at least `*hdr_sz` bytes available.
    - `hdr_sz`: A pointer to an `ulong` that specifies the size of `hdr_buf`. On success, it is updated with the number of bytes written to `hdr_buf`.
    - `pld_buf`: A pointer to a writable memory region for storing packet payloads. Must not be null and should have at least `*pld_sz` bytes available.
    - `pld_sz`: A pointer to an `ulong` that specifies the size of `pld_buf`. On success, it is updated with the number of bytes written to `pld_buf`.
    - `_pkt_ts`: A pointer to a `long` where the packet timestamp will be stored on success. Must not be null.
- **Output**: Returns 1 on success and 0 on failure. On success, updates `hdr_sz`, `pld_sz`, and `_pkt_ts` with the number of bytes written and the packet timestamp, respectively.
- **See Also**: [`fd_pcap_iter_next_split`](<fd_pcap.c.md#fd_pcap_iter_next_split>)  (Implementation)


---
### fd\_pcap\_fwrite\_hdr<!-- {{#callable_declaration:fd_pcap_fwrite_hdr}} -->
[View Source →](<../../../../../src/util/net/fd_pcap.h#L123>)

Writes a PCAP header to a file stream.
- **Description**: Use this function to write a little-endian PCAP header to a file stream. This function is useful when you need to initialize a PCAP file with the correct header before writing packet data. The `file` parameter must be a valid file stream pointer, and `link_layer_type` should be one of the predefined `FD_PCAP_LINK_LAYER_*` values. The function returns the number of headers written, which should be 1 on success. If the function fails, it returns 0, indicating that no header was written.
- **Inputs**:
    - `file`: A pointer to a file stream where the PCAP header will be written. Must not be null. The caller retains ownership of the file stream.
    - `link_layer_type`: An unsigned integer representing the link layer type. Must be one of the `FD_PCAP_LINK_LAYER_*` values, such as `FD_PCAP_LINK_LAYER_ETHERNET` or `FD_PCAP_LINK_LAYER_USER0`.
- **Output**: Returns the number of headers written: 1 on success, 0 on failure.
- **See Also**: [`fd_pcap_fwrite_hdr`](<fd_pcap.c.md#fd_pcap_fwrite_hdr>)  (Implementation)


---
### fd\_pcap\_ostream\_hdr<!-- {{#callable_declaration:fd_pcap_ostream_hdr}} -->
[View Source →](<../../../../../src/util/net/fd_pcap.h#L131>)

Writes a pcap header to a buffered output stream.
- **Description**: Use this function to write a pcap file header to a `fd_io_buffered_ostream_t` stream. This is typically done at the beginning of a pcap file to specify the link layer type. The function requires a valid output stream and a link layer type, which must be one of the predefined `FD_PCAP_LINK_LAYER_*` values. It returns a nonzero value if the operation fails, indicating that the header was not written successfully.
- **Inputs**:
    - `out`: A pointer to a `fd_io_buffered_ostream_t` stream where the pcap header will be written. Must not be null. The caller retains ownership of the stream.
    - `link_layer_type`: An unsigned integer specifying the link layer type. Must be one of the `FD_PCAP_LINK_LAYER_*` values, such as `FD_PCAP_LINK_LAYER_ETHERNET` or `FD_PCAP_LINK_LAYER_USER0`. Invalid values may result in a failure to write the header.
- **Output**: Returns an integer, where a nonzero value indicates a failure to write the header to the stream.
- **See Also**: [`fd_pcap_ostream_hdr`](<fd_pcap.c.md#fd_pcap_ostream_hdr>)  (Implementation)


---
### fd\_pcap\_pkt\_sz<!-- {{#callable_declaration:fd_pcap_pkt_sz}} -->
[View Source →](<../../../../../src/util/net/fd_pcap.h#L139>)

Calculates the total size of a pcap packet entry.
- **Description**: Use this function to determine the total number of bytes required to store a pcap packet entry, including headers and payload. This function checks for overflow and ensures the packet size does not exceed the maximum allowed size for a pcap entry. If the calculated size is too large, the function returns a negative value to indicate failure. This function is useful when preparing to write packet data to a pcap file and ensuring that the packet size is within acceptable limits.
- **Inputs**:
    - `hdr_sz`: The size of the packet header in bytes. Must be a non-negative value. If the sum of `hdr_sz` and `payload_sz` causes an overflow or exceeds the maximum allowed size, the function returns a negative value.
    - `payload_sz`: The size of the packet payload in bytes. Must be a non-negative value. If the sum of `hdr_sz` and `payload_sz` causes an overflow or exceeds the maximum allowed size, the function returns a negative value.
- **Output**: Returns the total size of the pcap packet entry in bytes as a long integer. If the size is too large, returns a negative value to indicate failure.
- **See Also**: [`fd_pcap_pkt_sz`](<fd_pcap.c.md#fd_pcap_pkt_sz>)  (Implementation)


---
### fd\_pcap\_pkt<!-- {{#callable_declaration:fd_pcap_pkt}} -->
[View Source →](<../../../../../src/util/net/fd_pcap.h#L156>)

Writes a pcap Ethernet frame to a specified memory location.
- **Description**: Use this function to create a pcap entry for an Ethernet frame by combining the header, payload, and frame check sequence (FCS) at a specified timestamp. Ensure that the output buffer has enough space, as determined by `fd_pcap_pkt_sz`, to accommodate the pcap entry. This function is useful for applications that need to log or analyze network traffic in pcap format. It returns the size of the pcap entry on success or a negative value if the header or payload sizes are invalid.
- **Inputs**:
    - `out`: Pointer to a memory location where the pcap entry will be written. Must have sufficient space as determined by `fd_pcap_pkt_sz`. Caller retains ownership.
    - `ts`: Timestamp for the pcap entry, in nanoseconds. Represents the time the packet was captured.
    - `_hdr`: Pointer to the Ethernet header data. Must not be null. Caller retains ownership.
    - `hdr_sz`: Size of the Ethernet header in bytes. Must be a valid size for an Ethernet header.
    - `_payload`: Pointer to the Ethernet payload data. Must not be null. Caller retains ownership.
    - `payload_sz`: Size of the Ethernet payload in bytes. Must be a valid size for an Ethernet payload.
    - `_fcs`: Frame Check Sequence (FCS) for the Ethernet frame. Should be calculated as per Ethernet standards.
- **Output**: Returns the size of the pcap entry on success, or a negative value if the header or payload sizes are invalid.
- **See Also**: [`fd_pcap_pkt`](<fd_pcap.c.md#fd_pcap_pkt>)  (Implementation)


---
### fd\_pcap\_fwrite\_pkt<!-- {{#callable_declaration:fd_pcap_fwrite_pkt}} -->
[View Source →](<../../../../../src/util/net/fd_pcap.h#L171>)

Writes a packet to a file stream in pcap format.
- **Description**: Use this function to write a packet, composed of a header and payload, to a file stream in pcap format. This function is useful when you need to log network packets to a file for analysis. Ensure that the file stream is valid and writable. The function returns 1 on success and 0 on failure, logging a warning if the write operation fails. It is important to provide valid header and payload data, as well as a correct frame check sequence (FCS).
- **Inputs**:
    - `ts`: The timestamp for the packet, representing the time the packet was captured. It must be a valid long integer.
    - `_hdr`: A pointer to the packet header data. It must not be null and should point to a valid memory region of size 'hdr_sz'.
    - `hdr_sz`: The size of the header data in bytes. It must be a valid unsigned long integer.
    - `_payload`: A pointer to the packet payload data. It must not be null and should point to a valid memory region of size 'payload_sz'.
    - `payload_sz`: The size of the payload data in bytes. It must be a valid unsigned long integer.
    - `_fcs`: The frame check sequence for the packet. It must be a valid unsigned integer.
    - `file`: A pointer to the file stream where the packet will be written. It must be a valid and writable file stream.
- **Output**: Returns 1 on successful write and 0 on failure, with a warning logged if the write fails.
- **See Also**: [`fd_pcap_fwrite_pkt`](<fd_pcap.c.md#fd_pcap_fwrite_pkt>)  (Implementation)


---
### fd\_pcap\_ostream\_pkt<!-- {{#callable_declaration:fd_pcap_ostream_pkt}} -->
[View Source →](<../../../../../src/util/net/fd_pcap.h#L184>)

Writes a pcap packet to a buffered output stream.
- **Description**: Use this function to write a pcap-formatted packet to a specified buffered output stream. The function requires a timestamp, header, payload, and frame check sequence (FCS) to construct the packet. Ensure that the output stream is properly initialized and that the header and payload sizes are valid. The function returns a nonzero value on failure, which can occur if the packet size is invalid or if writing to the stream fails.
- **Inputs**:
    - `out`: A pointer to a `fd_io_buffered_ostream_t` stream where the pcap packet will be written. Must not be null.
    - `ts`: A long integer representing the timestamp of the packet in nanoseconds.
    - `_hdr`: A pointer to the packet header data. Must not be null and should point to a valid memory region of size `hdr_sz`.
    - `hdr_sz`: An unsigned long integer specifying the size of the header in bytes. Must be a valid size for the header data.
    - `_payload`: A pointer to the packet payload data. Must not be null and should point to a valid memory region of size `payload_sz`.
    - `payload_sz`: An unsigned long integer specifying the size of the payload in bytes. Must be a valid size for the payload data.
    - `_fcs`: An unsigned integer representing the frame check sequence for the packet.
- **Output**: Returns 0 on success and a nonzero value on failure, indicating an error in writing the packet to the stream.
- **See Also**: [`fd_pcap_ostream_pkt`](<fd_pcap.c.md#fd_pcap_ostream_pkt>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)