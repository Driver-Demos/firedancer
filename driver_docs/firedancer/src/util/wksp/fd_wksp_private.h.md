<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines internal structures and functions for managing workspace partitions, including idle stack and treap operations, in the Firedancer codebase.

# Purpose
The code is a C header file that defines private structures and functions for managing a workspace (`fd_wksp`) in a memory management system. It provides detailed internal mechanisms for handling partitions within a workspace, including the allocation and deallocation of memory regions. The file defines constants, data structures, and inline functions to manage partition information (`fd_wksp_private_pinfo_t`), which includes details about memory partitions such as their size, status (used or free), and their relationships with other partitions. The code uses treap data structures to efficiently manage and query used and free partitions, ensuring that operations like insertion, removal, and querying are performed in logarithmic time complexity.

The header file also includes functions for locking and unlocking the workspace, which are crucial for maintaining data integrity in concurrent environments. Additionally, it provides mechanisms for checkpointing and restoring the state of the workspace, which are essential for persistence and recovery. The file defines several macros and inline functions to facilitate these operations, ensuring that the workspace's internal state can be efficiently managed and manipulated. The code is intended for internal use within a larger system, as indicated by the use of private structures and functions, and it is not designed to define public APIs or external interfaces.
# Imports and Dependencies

---
- `fd_wksp.h`


# Data Structures

---
### fd\_wksp\_private\_pinfo
- **Type**: ``struct``
- **Members**:
    - ``gaddr_lo``: Specifies the lower bound of the global address range for the partition, or 0 if idle.
    - ``gaddr_hi``: Specifies the upper bound of the global address range for the partition, or 0 if idle.
    - ``tag``: Indicates if the partition is free (0) or allocated (non-zero).
    - ``heap_prio``: Stores a 30-bit priority and a 1-bit flag for infinite priority operations.
    - ``in_same``: Indicates if the partition is part of a list of partitions with the same size.
    - ``prev_cidx``: Compressed index of the previous partition or null index if none.
    - ``next_cidx``: Compressed index of the next partition or null index if none.
    - ``left_cidx``: Compressed index of the left child in the treap or null index if none.
    - ``right_cidx``: Compressed index of the right child in the treap or null index if none.
    - ``parent_cidx``: Compressed index of the parent partition in the treap or null index if none.
    - ``same_cidx``: Compressed index of the next partition of the same size or null index if none.
    - ``stack_cidx``: Used internally for stack operations.
    - ``cycle_tag``: Used internally for cycle detection.
- **Description**: Defines a structure that holds information about a partition in a workspace, including its address range, allocation status, and its position in various data structures like treaps and lists. It uses compressed indices to reference related partitions and includes fields for internal operations such as cycle detection and stack management.


---
### fd\_wksp\_private\_pinfo\_t
- **Type**: ``struct``
- **Members**:
    - ``gaddr_lo``: Specifies the lower bound of the partition's address range.
    - ``gaddr_hi``: Specifies the upper bound of the partition's address range.
    - ``tag``: Indicates if the partition is free (0) or allocated (non-zero).
    - ``heap_prio``: Stores a 30-bit priority value for heap operations.
    - ``in_same``: Indicates if the partition is part of a list of partitions with the same size.
    - ``prev_cidx``: Compressed index of the previous partition in the list.
    - ``next_cidx``: Compressed index of the next partition in the list.
    - ``left_cidx``: Compressed index of the left child in the treap.
    - ``right_cidx``: Compressed index of the right child in the treap.
    - ``parent_cidx``: Compressed index of the parent partition in the treap.
    - ``same_cidx``: Compressed index of the next partition of the same size.
    - ``stack_cidx``: Used internally for stack operations.
    - ``cycle_tag``: Used internally for cycle detection.
- **Description**: Specifies details about a partition in a workspace, including its address range, allocation status, and its position in various data structures like treaps and lists. It uses compressed indices to reference related partitions and includes fields for internal operations such as heap priority and cycle detection.


---
### fd\_wksp\_private
- **Type**: ``struct``
- **Members**:
    - `magic`: Holds a constant value `FD_WKSP_MAGIC` to verify the structure's integrity.
    - `part_max`: Specifies the maximum number of partitions in the workspace.
    - `data_max`: Indicates the size of the data region in bytes.
    - `gaddr_lo`: Marks the lower bound of the data region's offset.
    - `gaddr_hi`: Marks the upper bound of the data region's offset.
    - `name`: Stores the name of the backing shared memory region as a string.
    - `seed`: Contains a random number seed for heap priority operations.
    - `idle_top_cidx`: Index of the top of the stack for idle partition information.
    - `part_head_cidx`: Index of the leftmost partition information.
    - `part_tail_cidx`: Index of the rightmost partition information.
    - `part_used_cidx`: Index of the root of the treap for used partitions.
    - `part_free_cidx`: Index of the root of the treap for free partitions.
    - `cycle_tag`: Used for detecting cycles in the data structure.
    - `owner`: Holds the thread group ID of the owner or NULL if unowned.
- **Description**: Defines the internal layout of a workspace (`fd_wksp_t`) with static fields for configuration and dynamic fields for managing partition information. The structure includes fields for managing partition indices, data region boundaries, and auxiliary data structures for partition management. It ensures data integrity and provides mechanisms for efficient partition allocation and deallocation.


---
### fd\_wksp\_checkpt\_v2\_hdr
- **Type**: ``struct``
- **Members**:
    - `magic`: Must be first and equal to `FD_WKSP_MAGIC`.
    - `style`: Must be second and indicates the workspace checkpoint style.
    - `frame_style_compressed`: Specifies the frame style used for compressed frames.
    - `reserved`: Used for header padding.
    - `name`: C-string holding the original workspace name, with a maximum length defined by `FD_SHMEM_NAME_MAX`.
    - `seed`: Workspace seed when checkpointed, likely the same used to construct.
    - `part_max`: Maximum number of partitions used to construct the workspace.
    - `data_max`: Maximum data size used to construct the workspace.
- **Description**: Defines the byte layout of frame 0 of a workspace version 2 checkpoint, containing metadata such as the checkpoint style, compression algorithm, and workspace information.


---
### fd\_wksp\_checkpt\_v2\_hdr\_t
- **Type**: ``struct``
- **Members**:
    - `magic`: Holds a unique identifier for the memory layout, must be `FD_WKSP_MAGIC`.
    - `style`: Indicates the checkpoint style used.
    - `frame_style_compressed`: Specifies the compression style for frames.
    - `reserved`: Padding for alignment purposes.
    - `name`: Stores the original workspace name as a C-style string.
    - `seed`: Represents the seed used for the workspace when checkpointed.
    - `part_max`: Indicates the maximum number of partitions used to construct the workspace.
    - `data_max`: Indicates the maximum data size used to construct the workspace.
- **Description**: Defines the byte layout of frame 0 of a version 2 workspace checkpoint, containing metadata such as the checkpoint style, compression algorithm, and workspace preview information in an uncompressed format.


---
### fd\_wksp\_checkpt\_v2\_info
- **Type**: ``struct``
- **Members**:
    - `mode`: Specifies the mode of the checkpoint.
    - `wallclock`: Records the wall clock time.
    - `app_id`: Identifies the application.
    - `thread_id`: Identifies the thread.
    - `host_id`: Identifies the host.
    - `cpu_id`: Identifies the CPU.
    - `group_id`: Identifies the group.
    - `tid`: Identifies the thread ID.
    - `user_id`: Identifies the user.
    - `sz_app`: Specifies the size of the application name.
    - `sz_thread`: Specifies the size of the thread name.
    - `sz_host`: Specifies the size of the host name.
    - `sz_cpu`: Specifies the size of the CPU name.
    - `sz_group`: Specifies the size of the group name.
    - `sz_user`: Specifies the size of the user name.
    - `sz_path`: Specifies the size of the path.
    - `sz_binfo`: Specifies the size of the build info.
    - `sz_uinfo`: Specifies the size of the user info.
- **Description**: Defines the layout of frame 1 in a version 2 workspace checkpoint, containing metadata such as mode, wall clock time, and various identifiers (application, thread, host, CPU, group, thread ID, and user). It also includes size fields for application, thread, host, CPU, group, user, path, build info, and user info, which indicate the buffer layout for corresponding strings.


---
### fd\_wksp\_checkpt\_v2\_info\_t
- **Type**: ``struct``
- **Members**:
    - `mode`: Specifies the mode of the checkpoint.
    - `wallclock`: Records the wallclock time when the checkpoint was taken.
    - `app_id`: Identifies the application associated with the checkpoint.
    - `thread_id`: Identifies the thread associated with the checkpoint.
    - `host_id`: Identifies the host machine associated with the checkpoint.
    - `cpu_id`: Identifies the CPU associated with the checkpoint.
    - `group_id`: Identifies the group associated with the checkpoint.
    - `tid`: Identifies the thread ID associated with the checkpoint.
    - `user_id`: Identifies the user associated with the checkpoint.
    - `sz_app`: Specifies the size of the application name string.
    - `sz_thread`: Specifies the size of the thread name string.
    - `sz_host`: Specifies the size of the host name string.
    - `sz_cpu`: Specifies the size of the CPU name string.
    - `sz_group`: Specifies the size of the group name string.
    - `sz_user`: Specifies the size of the user name string.
    - `sz_path`: Specifies the size of the path string.
    - `sz_binfo`: Specifies the size of the build info string.
    - `sz_uinfo`: Specifies the size of the user info string.
- **Description**: Defines the layout of frame 1 in a version 2 workspace checkpoint, containing metadata about the checkpoint such as mode, timing, and various identifiers, along with sizes for associated strings.


---
### fd\_wksp\_checkpt\_v2\_cmd
- **Type**: ``union``
- **Members**:
    - ``meta``: Contains a `tag` greater than 0, and `gaddr_lo` and `gaddr_hi` for address range.
    - ``data``: Contains a `tag` equal to 0, `cgroup_cnt` equal to `ULONG_MAX`, and `frame_off` equal to `ULONG_MAX`.
    - ``appendix``: Contains a `tag` equal to 0, `cgroup_cnt` less than `ULONG_MAX`, and `frame_off` less than `ULONG_MAX`.
    - ``volumes``: Contains a `tag` equal to 0, `cgroup_cnt` equal to `ULONG_MAX`, and `frame_off` less than `ULONG_MAX`.
- **Description**: Defines a union for handling different command types in a workspace checkpoint version 2, with each struct variant representing a specific command type based on the `tag` and other fields.


---
### fd\_wksp\_checkpt\_v2\_cmd\_t
- **Type**: `union`
- **Members**:
    - `meta`: Contains a `tag` greater than 0 and two unsigned long integers `gaddr_lo` and `gaddr_hi`.
    - `data`: Contains a `tag` equal to 0, `cgroup_cnt` equal to `ULONG_MAX`, and `frame_off` equal to `ULONG_MAX`.
    - `appendix`: Contains a `tag` equal to 0, `cgroup_cnt` less than `ULONG_MAX`, and `frame_off` less than `ULONG_MAX`.
    - `volumes`: Contains a `tag` equal to 0, `cgroup_cnt` equal to `ULONG_MAX`, and `frame_off` less than `ULONG_MAX`.
- **Description**: Defines a command structure for handling different types of frames in a version 2 workspace checkpoint, supporting operations like metadata handling, data management, appendix management, and volume management.


---
### fd\_wksp\_checkpt\_v2\_ftr
- **Type**: ``struct``
- **Members**:
    - `alloc_cnt`: Total number of allocations in the checkpoint.
    - `cgroup_cnt`: Total number of cgroups in the checkpoint.
    - `volume_cnt`: Total number of volumes in the checkpoint.
    - `frame_off`: Byte offset of the volumes command relative to the header initial byte.
    - `checkpt_sz`: Checkpoint byte size from the header initial byte to the footer final byte inclusive.
    - `data_max`: Should match the header.
    - `part_max`: Should match the header.
    - `seed`: Should match the header.
    - `name`: Should match the header.
    - `reserved`: Reserved field.
    - `frame_style_compressed`: Should match the header.
    - `style`: Should match the header.
    - `unmagic`: Should equal the bitwise negation of `FD_WKSP_MAGIC`.
- **Description**: Defines the layout of the final frame of a workspace version 2 checkpoint, containing metadata necessary for navigating and unpacking the checkpoint data.


---
### fd\_wksp\_checkpt\_v2\_ftr\_t
- **Type**: ``struct``
- **Members**:
    - `alloc_cnt`: Total number of allocations in the checkpoint.
    - `cgroup_cnt`: Total number of cgroups in the checkpoint.
    - `volume_cnt`: Total number of volumes in the checkpoint.
    - `frame_off`: Byte offset of the volumes command relative to the header initial byte.
    - `checkpt_sz`: Checkpoint byte size from header initial byte to footer final byte inclusive.
    - `data_max`: Should match the header's data_max.
    - `part_max`: Should match the header's part_max.
    - `seed`: Should match the header's seed.
    - `name`: Should match the header's name.
    - `reserved`: Reserved field matching the header.
    - `frame_style_compressed`: Should match the header's frame style compressed.
    - `style`: Should match the header's style.
    - `unmagic`: Inverse of `FD_WKSP_MAGIC`.
- **Description**: Defines the byte layout of the final frame of a workspace version 2 checkpoint, containing footer information uncompressed. It includes metadata such as the total number of allocations, cgroups, and volumes, as well as offsets and sizes necessary for navigating and unpacking the checkpoint. The structure ensures consistency with the header by matching several fields, and it provides a mechanism to seek from the end of the checkpoint to the header.


# Functions

---
### fd\_wksp\_private\_pinfo\_sz<!-- {{#callable:fd_wksp_private_pinfo_sz}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_private.h#L194>)

Calculates the size of a partition in bytes by subtracting the lower address from the higher address in the partition information.
- **Inputs**:
    - `pinfo`: A pointer to a `fd_wksp_private_pinfo_t` structure, which contains information about a partition in a workspace.
- **Logic and Control Flow**:
    - Accesses the `gaddr_hi` and `gaddr_lo` fields of the `pinfo` structure.
    - Subtracts `gaddr_lo` from `gaddr_hi` to determine the size of the partition.
- **Output**: Returns an `ulong` representing the size of the partition in bytes, which is guaranteed to be positive.


---
### fd\_wksp\_private\_pinfo\_off<!-- {{#callable:fd_wksp_private_pinfo_off}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_private.h#L209>)

Returns the offset of the private partition information within a workspace structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns a constant value `128UL`, which represents the aligned offset of the private partition information within a workspace structure.
- **Output**: A constant unsigned long integer value `128UL`.


---
### fd\_wksp\_private\_data\_off<!-- {{#callable:fd_wksp_private_data_off}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_private.h#L214>)

Calculates the offset for the data region in a workspace based on the maximum number of partitions.
- **Inputs**:
    - `part_max`: The maximum number of partitions in the workspace.
- **Logic and Control Flow**:
    - Calls `fd_wksp_private_pinfo_off()` to get the offset of the partition info array.
    - Calculates the total size of the partition info array by multiplying `part_max` with the size of `fd_wksp_private_pinfo_t`.
    - Adds the result to the partition info offset to get the data region offset.
- **Output**: Returns the offset for the data region in the workspace as an unsigned long integer.
- **Functions Called**:
    - [`fd_wksp_private_pinfo_off`](<#fd_wksp_private_pinfo_off>)


---
### fd\_wksp\_private\_pinfo\_const<!-- {{#callable:fd_wksp_private_pinfo_const}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_private.h#L228>)

Returns a constant pointer to the private partition information array of a workspace.
- **Inputs**:
    - `wksp`: A constant pointer to a `fd_wksp_t` structure representing the workspace.
- **Logic and Control Flow**:
    - Calculate the offset of the private partition information array using `fd_wksp_private_pinfo_off()`.
    - Add the calculated offset to the base address of the workspace `wksp`.
    - Cast the result to a constant pointer of type `fd_wksp_private_pinfo_t`.
- **Output**: A constant pointer to the `fd_wksp_private_pinfo_t` array within the workspace.
- **Functions Called**:
    - [`fd_wksp_private_pinfo_off`](<#fd_wksp_private_pinfo_off>)


---
### fd\_wksp\_private\_pinfo\_cidx<!-- {{#callable:fd_wksp_private_pinfo_cidx}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_private.h#L235>)

Converts an `ulong` index to a `uint` compressed index.
- **Inputs**:
    - `idx`: An `ulong` index to convert to a `uint` compressed index.
- **Logic and Control Flow**:
    - Casts the `ulong` input `idx` to a `uint`.
- **Output**: Returns the `uint` compressed index equivalent of the input `ulong` index.


---
### fd\_wksp\_private\_pinfo\_idx<!-- {{#callable:fd_wksp_private_pinfo_idx}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_private.h#L236>)

Converts a compressed index (`cidx`) to an uncompressed index (`ulong`).
- **Inputs**:
    - `cidx`: A compressed index of type `uint` that needs conversion to an uncompressed index.
- **Logic and Control Flow**:
    - Casts the input `cidx` from `uint` to `ulong`.
- **Output**: Returns the uncompressed index as a `ulong`.


---
### fd\_wksp\_private\_pinfo\_idx\_is\_null<!-- {{#callable:fd_wksp_private_pinfo_idx_is_null}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_private.h#L241>)

Checks if a given index is equal to the null index constant `FD_WKSP_PRIVATE_PINFO_IDX_NULL`.
- **Inputs**:
    - `idx`: An unsigned long integer representing the index to check.
- **Logic and Control Flow**:
    - Compares the input `idx` with the constant `FD_WKSP_PRIVATE_PINFO_IDX_NULL`.
    - Returns 1 if `idx` is equal to `FD_WKSP_PRIVATE_PINFO_IDX_NULL`, otherwise returns 0.
- **Output**: Returns an integer: 1 if the index is null, 0 otherwise.


---
### fd\_wksp\_private\_idle\_stack\_is\_empty<!-- {{#callable:fd_wksp_private_idle_stack_is_empty}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_private.h#L249>)

Checks if the idle stack of a workspace is empty or corrupted.
- **Inputs**:
    - `wksp`: A pointer to a `fd_wksp_t` structure representing the workspace to check.
- **Logic and Control Flow**:
    - Calls [`fd_wksp_private_pinfo_idx`](<#fd_wksp_private_pinfo_idx>) with `wksp->idle_top_cidx` to get the index of the top idle partition.
    - Compares the result with `wksp->part_max` to determine if the idle stack is empty or corrupted.
- **Output**: Returns 1 if the idle stack is empty or corrupted, otherwise returns 0.
- **Functions Called**:
    - [`fd_wksp_private_pinfo_idx`](<#fd_wksp_private_pinfo_idx>)


---
### fd\_wksp\_private\_idle\_stack\_pop<!-- {{#callable:fd_wksp_private_idle_stack_pop}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_private.h#L261>)

Removes the top partition from the idle stack of a workspace and returns its index.
- **Inputs**:
    - `wksp`: A pointer to the `fd_wksp_t` structure representing the workspace, assumed to be currently joined locally.
    - `pinfo`: A pointer to the `fd_wksp_private_pinfo_t` array, which is the partition information array of the workspace.
- **Logic and Control Flow**:
    - Retrieve the index `i` of the top idle partition using [`fd_wksp_private_pinfo_idx`](<#fd_wksp_private_pinfo_idx>) on `wksp->idle_top_cidx`.
    - Update `wksp->idle_top_cidx` to the `parent_cidx` of the partition at index `i`.
    - Set the `parent_cidx` of the partition at index `i` to `FD_WKSP_PRIVATE_PINFO_IDX_NULL` using [`fd_wksp_private_pinfo_cidx`](<#fd_wksp_private_pinfo_cidx>).
    - Return the index `i`.
- **Output**: Returns the index of the partition that was at the top of the idle stack.
- **Functions Called**:
    - [`fd_wksp_private_pinfo_idx`](<#fd_wksp_private_pinfo_idx>)
    - [`fd_wksp_private_pinfo_cidx`](<#fd_wksp_private_pinfo_cidx>)


---
### fd\_wksp\_private\_idle\_stack\_push<!-- {{#callable:fd_wksp_private_idle_stack_push}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_private.h#L274>)

Pushes a partition onto the idle stack in a workspace by resetting its properties and updating the stack's top index.
- **Inputs**:
    - `i`: Index of the partition to push onto the idle stack, assumed to be in the range [0, part_max).
    - `wksp`: Pointer to the workspace structure, assumed to be currently joined locally.
    - `pinfo`: Pointer to the partition information array associated with the workspace.
- **Logic and Control Flow**:
    - Set the `gaddr_lo`, `gaddr_hi`, `tag`, and `in_same` fields of the partition at index `i` in `pinfo` to zero.
    - Set the `prev_cidx`, `next_cidx`, `left_cidx`, `right_cidx`, and `same_cidx` fields of the partition at index `i` in `pinfo` to `fd_wksp_private_pinfo_cidx(FD_WKSP_PRIVATE_PINFO_IDX_NULL)`.
    - Set the `parent_cidx` field of the partition at index `i` in `pinfo` to the current `idle_top_cidx` of `wksp`.
    - Update the `idle_top_cidx` of `wksp` to the compressed index of `i` using `fd_wksp_private_pinfo_cidx(i)`.
- **Output**: No return value; the function modifies the workspace and partition information in place.
- **Functions Called**:
    - [`fd_wksp_private_pinfo_cidx`](<#fd_wksp_private_pinfo_cidx>)


---
### fd\_wksp\_private\_free\_treap\_same\_is\_empty<!-- {{#callable:fd_wksp_private_free_treap_same_is_empty}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_private.h#L412>)

Checks if the 'same' list for a given partition in the free treap is empty or corrupted.
- **Inputs**:
    - `d`: The index of the partition in the free treap to check.
    - `wksp`: A pointer to the workspace structure, assumed to be a current local join.
    - `pinfo`: A pointer to the partition information array, equivalent to `fd_wksp_private_pinfo(wksp)`.
- **Logic and Control Flow**:
    - Retrieve the maximum number of partitions from `wksp->part_max`.
    - Convert the compressed index `pinfo[d].same_cidx` to an uncompressed index using [`fd_wksp_private_pinfo_idx`](<#fd_wksp_private_pinfo_idx>).
    - Compare the uncompressed index to `part_max` to determine if the 'same' list is empty or corrupted.
- **Output**: Returns 1 if the 'same' list is empty or if corruption is detected, otherwise returns 0.
- **Functions Called**:
    - [`fd_wksp_private_pinfo_idx`](<#fd_wksp_private_pinfo_idx>)


---
### fd\_wksp\_private\_free\_treap\_same\_remove<!-- {{#callable:fd_wksp_private_free_treap_same_remove}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_private.h#L425>)

Removes the first partition from a list of partitions with the same size in a workspace's free treap.
- **Inputs**:
    - `d`: The index of the partition in the free treap from which to remove the first partition in the same list.
    - `wksp`: A pointer to the workspace structure, assumed to be a current local join.
    - `pinfo`: A pointer to the partition information array associated with the workspace.
- **Logic and Control Flow**:
    - Retrieve the maximum number of partitions from the workspace structure.
    - Get the index `i` of the first partition in the same list of partition `d`.
    - Get the index `j` of the next partition in the same list after `i`.
    - Update the `same_cidx` of partition `d` to point to `j`.
    - If `j` is less than `part_max`, update the `parent_cidx` of partition `j` to point to `d`.
    - Set the `in_same` flag of partition `i` to 0, indicating it is no longer in a same list.
    - Set the `same_cidx` and `parent_cidx` of partition `i` to `FD_WKSP_PRIVATE_PINFO_IDX_NULL`.
- **Output**: Returns the index `i` of the removed partition.
- **Functions Called**:
    - [`fd_wksp_private_pinfo_idx`](<#fd_wksp_private_pinfo_idx>)
    - [`fd_wksp_private_pinfo_cidx`](<#fd_wksp_private_pinfo_cidx>)


---
### fd\_wksp\_private\_unlock<!-- {{#callable:fd_wksp_private_unlock}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_private.h#L479>)

Releases the lock on a workspace by setting its owner to `ULONG_MAX`.
- **Inputs**:
    - `wksp`: A pointer to a `fd_wksp_t` structure representing the workspace to unlock.
- **Logic and Control Flow**:
    - Executes a memory fence to ensure memory operations are completed before proceeding.
    - Sets the `owner` field of the `wksp` structure to `ULONG_MAX` to indicate the workspace is unlocked.
    - Executes another memory fence to ensure the update to the `owner` field is visible to other threads.
- **Output**: No return value; the function operates directly on the `wksp` structure to unlock it.


---
### fd\_wksp\_checkpt\_v2\_cmd\_is\_meta<!-- {{#callable:fd_wksp_checkpt_v2_cmd_is_meta}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_private.h#L588>)

Checks if a given command is a meta command by evaluating if its tag is greater than zero.
- **Inputs**:
    - `cmd`: A pointer to a `fd_wksp_checkpt_v2_cmd_t` structure representing the command to check.
- **Logic and Control Flow**:
    - Accesses the `meta.tag` field of the `cmd` structure.
    - Returns true (non-zero) if `meta.tag` is greater than zero, indicating a meta command.
    - Returns false (zero) otherwise.
- **Output**: An integer value, 1 if the command is a meta command, 0 otherwise.


---
### fd\_wksp\_checkpt\_v2\_cmd\_is\_data<!-- {{#callable:fd_wksp_checkpt_v2_cmd_is_data}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_private.h#L593>)

Checks if a command is a data command in a workspace checkpoint version 2.
- **Inputs**:
    - `cmd`: A pointer to a `fd_wksp_checkpt_v2_cmd_t` structure representing the command to check.
- **Logic and Control Flow**:
    - Evaluates if `cmd->data.tag` is equal to 0.
    - Checks if `cmd->data.cgroup_cnt` is equal to `ULONG_MAX`.
    - Verifies if `cmd->data.frame_off` is equal to `ULONG_MAX`.
    - Returns the result of the bitwise AND operation of the above three conditions.
- **Output**: Returns an integer that is non-zero if the command is a data command, and zero otherwise.


---
### fd\_wksp\_checkpt\_v2\_cmd\_is\_appendix<!-- {{#callable:fd_wksp_checkpt_v2_cmd_is_appendix}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_private.h#L598>)

Checks if a command is an appendix command in a workspace checkpoint version 2.
- **Inputs**:
    - `cmd`: A pointer to a `fd_wksp_checkpt_v2_cmd_t` structure representing the command to check.
- **Logic and Control Flow**:
    - Evaluates if `cmd->appendix.tag` is equal to 0.
    - Checks if `cmd->appendix.cgroup_cnt` is less than `ULONG_MAX`.
    - Verifies if `cmd->appendix.frame_off` is less than `ULONG_MAX`.
    - Returns the result of the bitwise AND operation of the above three conditions.
- **Output**: Returns an integer that is non-zero if the command is an appendix command, otherwise returns zero.


---
### fd\_wksp\_checkpt\_v2\_cmd\_is\_volumes<!-- {{#callable:fd_wksp_checkpt_v2_cmd_is_volumes}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_private.h#L603>)

Checks if a command is of the 'volumes' type in a workspace checkpoint version 2.
- **Inputs**:
    - `cmd`: A pointer to a constant `fd_wksp_checkpt_v2_cmd_t` structure representing the command to check.
- **Logic and Control Flow**:
    - Evaluates if the `tag` field of the `volumes` structure within `cmd` is equal to 0.
    - Checks if the `cgroup_cnt` field of the `volumes` structure is equal to `ULONG_MAX`.
    - Verifies if the `frame_off` field of the `volumes` structure is less than `ULONG_MAX`.
    - Returns the result of the logical AND operation on the above three conditions.
- **Output**: Returns an integer that is non-zero if the command is of the 'volumes' type, otherwise returns zero.


# Function Declarations (Public API)

---
### fd\_wksp\_private\_used\_treap\_query<!-- {{#callable_declaration:fd_wksp_private_used_treap_query}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_private.h#L301>)

Queries the used partition treap for a specific address.
- **Description**: Use this function to find the index of a used partition in a workspace that contains a given global address. It is important to ensure that the address is within the valid range of the workspace's data region before calling this function. The function will return a special null index if the address is not within any used partition or if there is an internal error such as a cycle or bad index in the treap structure. This function may modify the cycle tags of partitions as part of its operation.
- **Inputs**:
    - `gaddr`: The global address to query. It must be within the range [wksp->gaddr_lo, wksp->gaddr_hi). If it is not, the function returns a null index.
    - `wksp`: A pointer to the workspace structure. It must be a valid and properly initialized workspace.
    - `pinfo`: A pointer to an array of partition information structures. It must be associated with the workspace and properly initialized.
- **Output**: Returns the index of the partition containing the address if successful, or a null index if the address is not found or an error occurs.
- **See Also**: [`fd_wksp_private_used_treap_query`](<fd_wksp_used_treap.c.md#fd_wksp_private_used_treap_query>)  (Implementation)


---
### fd\_wksp\_private\_used\_treap\_insert<!-- {{#callable_declaration:fd_wksp_private_used_treap_insert}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_private.h#L332>)

Inserts a partition into the used treap of a workspace.
- **Description**: Use this function to add a partition to the used treap of a workspace. Ensure that the partition is not already in the idle stack, used treap, or free treap before calling. The partition must have its address range and heap priority initialized. The function will initialize various index fields and may consume a workspace cycle tag. It returns success or an error code if the insertion fails due to invalid parameters or memory corruption.
- **Inputs**:
    - `n`: The index of the partition to insert. Must be within the range [0, part_max). If not, the function will return an error.
    - `wksp`: A pointer to the workspace structure. Must be a valid, non-null pointer to a workspace that is currently joined locally.
    - `pinfo`: A pointer to the partition information array. Must be equal to the result of `fd_wksp_private_pinfo(wksp)`. The function will modify this array to reflect the insertion.
- **Output**: Returns `FD_WKSP_SUCCESS` on success or a negative error code on failure. The function does not modify the partition or treap on failure, except possibly clobbering `stack_cidx` and `cycle_tag` fields.
- **See Also**: [`fd_wksp_private_used_treap_insert`](<fd_wksp_used_treap.c.md#fd_wksp_private_used_treap_insert>)  (Implementation)


---
### fd\_wksp\_private\_used\_treap\_remove<!-- {{#callable_declaration:fd_wksp_private_used_treap_remove}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_private.h#L353>)

Removes a partition from the used treap in a workspace.
- **Description**: Use this function to remove a specified partition from the used treap of a workspace. It is important to ensure that the partition is currently in the used treap and not in the free treap or idle stack before calling this function. The function operates in O(log N) time complexity, where N is the number of used partitions. It may consume a workspace cycle tag and modify the partition's stack_cidx and cycle_tag fields. The function returns a success code on successful removal or an error code if the partition index is out of range or if there are connectivity issues within the treap.
- **Inputs**:
    - `d`: The index of the partition to remove. Must be within the range [0, part_max) and currently in the used treap.
    - `wksp`: A pointer to the workspace structure. Must be a valid, non-null pointer representing a current local join.
    - `pinfo`: A pointer to the partition information array. Must be a valid, non-null pointer to the workspace's partition information.
- **Output**: Returns FD_WKSP_SUCCESS (zero) on success or a negative error code on failure.
- **See Also**: [`fd_wksp_private_used_treap_remove`](<fd_wksp_used_treap.c.md#fd_wksp_private_used_treap_remove>)  (Implementation)


---
### fd\_wksp\_private\_free\_treap\_query<!-- {{#callable_declaration:fd_wksp_private_free_treap_query}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_private.h#L369>)

Finds the smallest free partition of at least a given size.
- **Description**: Use this function to locate the smallest available partition in a workspace's free treap that can accommodate a specified size. It is important to ensure that the workspace is in a valid state and that the function is called with a non-zero size. The function will return a special index value if no suitable partition is found or if the input size is zero. This function may modify cycle tags for internal use.
- **Inputs**:
    - `sz`: The size in bytes to search for in the free treap. Must be greater than zero. If zero, the function returns a null index.
    - `wksp`: A pointer to a `fd_wksp_t` structure representing the workspace. Must be a valid, non-null pointer and in a current local join state.
    - `pinfo`: A pointer to an array of `fd_wksp_private_pinfo_t` structures. Must be valid and correspond to the workspace's partition information.
- **Output**: Returns the index of a suitable partition in the free treap, or `FD_WKSP_PRIVATE_PINFO_IDX_NULL` if no suitable partition is found or if the input size is zero.
- **See Also**: [`fd_wksp_private_free_treap_query`](<fd_wksp_free_treap.c.md#fd_wksp_private_free_treap_query>)  (Implementation)


---
### fd\_wksp\_private\_free\_treap\_insert<!-- {{#callable_declaration:fd_wksp_private_free_treap_insert}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_private.h#L403>)

Inserts a partition into the free treap of a workspace.
- **Description**: Use this function to add a partition to the free treap of a workspace, ensuring it is not already part of any treap or idle stack. The partition should have its address range and heap priority initialized, and its tag should be zero to indicate it is free. The function will organize the partition within the treap based on its size, potentially adding it to a list of partitions with the same size. It returns success or an error code if the operation fails due to invalid input or memory corruption.
- **Inputs**:
    - `n`: The index of the partition to insert, which must be within the range [0, part_max). It should not be part of any treap or idle stack.
    - `wksp`: A pointer to the workspace structure, which must be a current local join. The caller retains ownership.
    - `pinfo`: A pointer to the partition information array associated with the workspace. It must not be null and should be correctly initialized.
- **Output**: Returns FD_WKSP_SUCCESS (zero) on success or a negative error code on failure, indicating issues such as invalid index, range errors, or memory corruption.
- **See Also**: [`fd_wksp_private_free_treap_insert`](<fd_wksp_free_treap.c.md#fd_wksp_private_free_treap_insert>)  (Implementation)


---
### fd\_wksp\_private\_free\_treap\_remove<!-- {{#callable_declaration:fd_wksp_private_free_treap_remove}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_private.h#L457>)

Removes a partition from the free treap in a workspace.
- **Description**: Use this function to remove a specified partition from the free treap of a workspace. It assumes that the partition is currently in the free treap and not in the used treap or idle stack. The function operates efficiently with a time complexity of O(log N), where N is the number of free partitions. It may consume a workspace cycle tag and modify the partition's stack_cidx and cycle_tag fields. The function returns a success code on successful removal or an error code if the partition index is out of range or if there are connectivity issues within the treap. This function is not expected to fail under normal operating conditions.
- **Inputs**:
    - `d`: The index of the partition to remove. Must be within the range [0, part_max) and currently in the free treap.
    - `wksp`: A pointer to the workspace structure. Must be a current local join.
    - `pinfo`: A pointer to the partition information array associated with the workspace. Must not be null and should correspond to the workspace's partition information.
- **Output**: Returns FD_WKSP_SUCCESS (zero) on success or a negative error code on failure.
- **See Also**: [`fd_wksp_private_free_treap_remove`](<fd_wksp_free_treap.c.md#fd_wksp_private_free_treap_remove>)  (Implementation)


---
### fd\_wksp\_private\_lock<!-- {{#callable_declaration:fd_wksp_private_lock}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_private.h#L473>)

Locks a workspace for exclusive access.
- **Description**: Use this to obtain exclusive access to a workspace. It must be called when the workspace is in a current local join. If the workspace is already locked, the function will wait until it can acquire the lock. If a process holding the lock dies, the function will attempt to reclaim the lock and clean up any incomplete operations. It returns success if the lock is acquired or an error if memory corruption is detected during recovery.
- **Inputs**:
    - `wksp`: A pointer to a `fd_wksp_t` structure representing the workspace to lock. It must not be null and must point to a valid workspace in a current local join.
- **Output**: Returns `FD_WKSP_SUCCESS` (0) if the lock is successfully acquired. Returns `FD_WKSP_ERR_CORRUPT` if memory corruption is detected while trying to recover from a dead process.
- **See Also**: [`fd_wksp_private_lock`](<fd_wksp_admin.c.md#fd_wksp_private_lock>)  (Implementation)


---
### fd\_wksp\_private\_checkpt\_v1<!-- {{#callable_declaration:fd_wksp_private_checkpt_v1}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_private.h#L647>)

Creates a checkpoint of a workspace to a specified file path.
- **Description**: Use this function to save the current state of a workspace to a file for later restoration. This function requires a valid workspace and a file path where the checkpoint will be saved. The function does not support thread parallelism, so the thread pool and thread range parameters are ignored. Ensure the workspace is not corrupted before calling this function, as it will return an error if corruption is detected. The function will attempt to create a new file at the specified path and will fail if the file already exists or if there are I/O errors during the process.
- **Inputs**:
    - `tpool`: Pointer to a thread pool, which is ignored in this version. Can be null.
    - `t0`: Starting index of the thread range, which is ignored in this version.
    - `t1`: Ending index of the thread range, which is ignored in this version.
    - `wksp`: Pointer to the workspace to be checkpointed. Must not be null and must point to a valid workspace.
    - `path`: String representing the file path where the checkpoint will be saved. Must not be null and should not point to an existing file.
    - `mode`: File mode for the new checkpoint file, specified in octal format. Determines the permissions of the created file.
    - `uinfo`: String containing user information to be included in the checkpoint. Must not be null.
- **Output**: Returns zero on success, or a negative error code if the operation fails due to I/O errors or workspace corruption.
- **See Also**: [`fd_wksp_private_checkpt_v1`](<fd_wksp_checkpt_v1.c.md#fd_wksp_private_checkpt_v1>)  (Implementation)


---
### fd\_wksp\_private\_restore\_v1<!-- {{#callable_declaration:fd_wksp_private_restore_v1}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_private.h#L656>)

Restores a version 1 checkpoint into a workspace.
- **Description**: Use this function to restore a version 1 checkpoint from a specified file path into a given workspace. This function requires a valid workspace and a file path to the checkpoint. It logs the restoration process and handles errors such as file access issues or format errors in the checkpoint. The function must be called with a valid workspace and assumes the caller has ensured the workspace is ready for restoration. It does not support thread parallelism for this version.
- **Inputs**:
    - `tpool`: A pointer to a thread pool, which is currently unused in this version and can be set to NULL.
    - `t0`: An unsigned long representing the starting thread index, currently unused in this version.
    - `t1`: An unsigned long representing the ending thread index, currently unused in this version.
    - `wksp`: A pointer to a `fd_wksp_t` structure representing the workspace where the checkpoint will be restored. Must not be null and must be a valid workspace.
    - `path`: A constant character pointer to the file path of the checkpoint to restore. Must not be null and should point to a valid file path.
    - `new_seed`: An unsigned integer representing the new seed for the workspace rebuild process after restoration.
- **Output**: Returns an integer indicating success or failure. Zero indicates success, while a negative value indicates an error occurred during the restoration process.
- **See Also**: [`fd_wksp_private_restore_v1`](<fd_wksp_restore_v1.c.md#fd_wksp_private_restore_v1>)  (Implementation)


---
### fd\_wksp\_private\_printf\_v1<!-- {{#callable_declaration:fd_wksp_private_printf_v1}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_private.h#L664>)

Prints workspace metadata and partition information to a file descriptor.
- **Description**: Use this function to print detailed metadata and partition information of a workspace checkpoint stored in a file. It reads the checkpoint from the specified file path and outputs the information to the given file descriptor. The verbosity level controls the amount of detail printed, with higher levels providing more detailed information. Ensure the file at the specified path is accessible and contains a valid workspace checkpoint. The function handles errors by printing error messages to the output file descriptor.
- **Inputs**:
    - `out`: A file descriptor where the output will be written. Must be a valid, open file descriptor for writing.
    - `path`: A string representing the file path to the workspace checkpoint. Must not be null and should point to a readable file.
    - `verbose`: An integer specifying the verbosity level of the output. Higher values result in more detailed output. Must be at least 1.
- **Output**: Returns an integer representing the total number of bytes written to the output file descriptor. Returns a negative value if an error occurs during processing.
- **See Also**: [`fd_wksp_private_printf_v1`](<fd_wksp_restore_v1.c.md#fd_wksp_private_printf_v1>)  (Implementation)


---
### fd\_wksp\_private\_checkpt\_v2<!-- {{#callable_declaration:fd_wksp_private_checkpt_v2}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_private.h#L673>)

Creates a checkpoint of a workspace to a specified file path.
- **Description**: Use this function to create a checkpoint of a workspace, saving its state to a specified file path. This function requires a valid workspace and a file path where the checkpoint will be stored. Ensure that the workspace name is valid and that the file path is accessible and writable. The function does not support thread parallelization, and it will return an error if the specified frame style is not supported. It is important to handle potential errors, such as file creation failures or invalid workspace names, to ensure the checkpoint process completes successfully.
- **Inputs**:
    - `tpool`: A pointer to a thread pool structure. Currently unused, so it can be NULL.
    - `t0`: The starting index for thread parallelization. Currently unused.
    - `t1`: The ending index for thread parallelization. Currently unused.
    - `wksp`: A pointer to the workspace structure to checkpoint. Must not be NULL and must have a valid name.
    - `path`: A constant character pointer to the file path where the checkpoint will be saved. Must not be NULL and should be a valid, writable path.
    - `mode`: The file mode for the checkpoint file. Must be a valid mode for file creation.
    - `uinfo`: A constant character pointer to user information to include in the checkpoint. Can be NULL.
    - `frame_style_compressed`: An integer indicating the frame style for compression. Must be a supported style; otherwise, the function returns an error.
- **Output**: Returns an integer indicating success or an error code. On success, returns 0. On failure, returns a negative error code indicating the type of error encountered.
- **See Also**: [`fd_wksp_private_checkpt_v2`](<fd_wksp_checkpt_v2.c.md#fd_wksp_private_checkpt_v2>)  (Implementation)


---
### fd\_wksp\_private\_restore\_v2<!-- {{#callable_declaration:fd_wksp_private_restore_v2}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_private.h#L683>)

Restores a workspace from a checkpoint file.
- **Description**: Use this function to restore a workspace from a specified checkpoint file. This function requires a valid thread pool, workspace, and file path to operate. It supports both memory-mapped I/O and streaming methods for restoration, depending on the file's capabilities. Ensure that the workspace is properly initialized before calling this function. The function logs various stages of the restoration process and handles errors by returning a negative value. It is important to close any open file descriptors and finalize any resources used during the restoration process.
- **Inputs**:
    - `tpool`: A pointer to a thread pool (`fd_tpool_t`). Must not be null. The caller retains ownership.
    - `t0`: The starting index of the thread pool. Must be less than or equal to `t1`.
    - `t1`: The ending index of the thread pool. Must be greater than or equal to `t0`.
    - `wksp`: A pointer to the workspace (`fd_wksp_t`) to restore into. Must not be null. The caller retains ownership.
    - `path`: A constant character pointer to the path of the checkpoint file. Must not be null. The caller retains ownership.
    - `new_seed`: An unsigned integer representing the new seed for the workspace. Any valid `uint` value is acceptable.
- **Output**: Returns zero on success or a negative error code on failure.
- **See Also**: [`fd_wksp_private_restore_v2`](<fd_wksp_restore_v2.c.md#fd_wksp_private_restore_v2>)  (Implementation)


---
### fd\_wksp\_private\_printf\_v2<!-- {{#callable_declaration:fd_wksp_private_printf_v2}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_private.h#L691>)

Prints workspace checkpoint metadata to a specified output.
- **Description**: Use this function to print metadata from a workspace checkpoint file to a specified output file descriptor. This function is useful for debugging or logging purposes when you need to inspect the contents of a checkpoint file. The function requires a valid file path to the checkpoint and an output file descriptor where the metadata will be printed. The verbosity level controls the amount of detail printed. Ensure that the file path is accessible and the output file descriptor is valid before calling this function.
- **Inputs**:
    - `out`: An integer representing the file descriptor where the output will be printed. Must be a valid, open file descriptor for writing.
    - `path`: A constant character pointer to the path of the checkpoint file. Must not be null and should point to a valid file path.
    - `verbose`: An integer that sets the verbosity level of the output. A value of 1 or higher will print detailed metadata, while higher values may print additional information if implemented.
- **Output**: Returns an integer representing the total number of bytes written to the output file descriptor. If an error occurs, a negative value is returned.
- **See Also**: [`fd_wksp_private_printf_v2`](<fd_wksp_restore_v2.c.md#fd_wksp_private_printf_v2>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)