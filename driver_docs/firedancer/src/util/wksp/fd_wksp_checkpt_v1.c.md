<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for writing, preparing, publishing, and canceling workspace checkpoints in a buffered output stream.

# Purpose
The code is a C source file that implements functions for managing and writing checkpoints of a workspace (`wksp`) to an output stream. The primary function, [`fd_wksp_private_checkpt_v1`](<#fd_wksp_private_checkpt_v1>), is responsible for creating a checkpoint of the workspace's state, including its metadata and allocated partitions, and writing this data to a specified file path. The function uses a buffered output stream to efficiently handle the I/O operations. It performs various checks to ensure the integrity of the workspace and handles errors related to I/O operations and workspace corruption.

The file includes several static inline helper functions, such as [`fd_wksp_private_checkpt_v1_write`](<#fd_wksp_private_checkpt_v1_write>), [`fd_wksp_private_checkpt_v1_prepare`](<#fd_wksp_private_checkpt_v1_prepare>), [`fd_wksp_private_checkpt_v1_publish`](<#fd_wksp_private_checkpt_v1_publish>), and [`fd_wksp_private_checkpt_v1_ulong`](<#fd_wksp_private_checkpt_v1_ulong>), which facilitate the preparation, writing, and encoding of data into the checkpoint. These functions ensure that data is correctly formatted and written to the output stream. The code also manages file permissions and error handling, ensuring that the checkpoint process is robust against potential failures. The file is intended to be part of a larger system, as indicated by its use of private workspace functions and structures, and it does not define public APIs or external interfaces.
# Imports and Dependencies

---
- `fd_wksp_private.h`
- `errno.h`
- `unistd.h`
- `fcntl.h`
- `sys/stat.h`


# Functions

---
### fd\_wksp\_private\_checkpt\_v1\_write<!-- {{#callable:fd_wksp_private_checkpt_v1_write}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_checkpt_v1.c#L13>)

Writes a buffer of specified size to a given output stream.
- **Inputs**:
    - `checkpt`: A pointer to a `fd_io_buffered_ostream_t` structure representing the output stream where the buffer will be written.
    - `buf`: A constant pointer to the buffer that contains the data to be written to the output stream.
    - `sz`: An unsigned long integer representing the size of the buffer to be written.
- **Logic and Control Flow**:
    - Calls the function `fd_io_buffered_ostream_write` with the provided `checkpt`, `buf`, and `sz` arguments.
    - Returns the result of the `fd_io_buffered_ostream_write` function call.
- **Output**: Returns an integer indicating success (0) or failure (non-zero, which will be an errno-compatible error code).


---
### fd\_wksp\_private\_checkpt\_v1\_prepare<!-- {{#callable:fd_wksp_private_checkpt_v1_prepare}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_checkpt_v1.c#L27>)

Prepares a buffered output stream for writing a specified maximum number of bytes, ensuring sufficient buffer space is available.
- **Inputs**:
    - `checkpt`: A pointer to a `fd_io_buffered_ostream_t` structure representing the buffered output stream.
    - `max`: An unsigned long integer specifying the maximum number of bytes to prepare for writing.
    - `_err`: A pointer to an integer where the function will store an error code if an error occurs.
- **Logic and Control Flow**:
    - Check if the current available buffer size in `checkpt` is less than `max` using `fd_io_buffered_ostream_peek_sz`.
    - If the buffer size is insufficient, flush the buffer using `fd_io_buffered_ostream_flush`.
    - If flushing fails, set the error code in `_err` and return `NULL`.
    - If flushing succeeds or if the buffer was already sufficient, set `_err` to 0.
    - Return the pointer to the prepared buffer location using `fd_io_buffered_ostream_peek`.
- **Output**: Returns a pointer to the location in the caller's address space for preparing the maximum bytes on success, or `NULL` on failure.


---
### fd\_wksp\_private\_checkpt\_v1\_publish<!-- {{#callable:fd_wksp_private_checkpt_v1_publish}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_checkpt_v1.c#L49>)

Adjusts the position of the output stream `checkpt` to publish prepared bytes up to `next`.
- **Inputs**:
    - `checkpt`: A pointer to a `fd_io_buffered_ostream_t` structure representing the output stream.
    - `next`: A pointer to the next position in the prepared data to be published.
- **Logic and Control Flow**:
    - Calculate the offset by subtracting the current position of the output stream, obtained using `fd_io_buffered_ostream_peek`, from the `next` pointer.
    - Call `fd_io_buffered_ostream_seek` with the calculated offset to adjust the position of the output stream `checkpt`.
- **Output**: No return value; the function modifies the position of the output stream `checkpt`.


---
### fd\_wksp\_private\_checkpt\_v1\_ulong<!-- {{#callable:fd_wksp_private_checkpt_v1_ulong}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_checkpt_v1.c#L67>)

Encodes a given unsigned long value into a prepared memory location and returns the next available memory location.
- **Inputs**:
    - `prep`: A pointer to the memory location where the value should be encoded.
    - `val`: The unsigned long value to encode.
- **Logic and Control Flow**:
    - Calls the function `fd_ulong_svw_enc` with `prep` cast to `uchar *` and `val` as arguments.
    - Returns the result of `fd_ulong_svw_enc`, which is the location of the first byte after the encoded value.
- **Output**: A pointer to the location of the first byte after the encoded value.


---
### fd\_wksp\_private\_checkpt\_v1\_buf<!-- {{#callable:fd_wksp_private_checkpt_v1_buf}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_checkpt_v1.c#L77>)

Encodes a variable length buffer into a checkpoint preparation region and returns the next available position.
- **Inputs**:
    - `prep`: A pointer to the location in a preparation region where the buffer should be encoded.
    - `buf`: A constant pointer to the buffer that needs to be checkpointed.
    - `sz`: The size of the buffer to be checkpointed.
- **Logic and Control Flow**:
    - Call [`fd_wksp_private_checkpt_v1_ulong`](<#fd_wksp_private_checkpt_v1_ulong>) to encode the size `sz` at the preparation location `prep`.
    - Check if `sz` is non-zero using `FD_LIKELY`.
    - If `sz` is non-zero, copy the buffer `buf` to the preparation location `prep` using `fd_memcpy`.
    - Return the pointer to the next available position after the encoded buffer, which is `prep + sz`.
- **Output**: Returns a pointer to the location immediately after the encoded buffer in the preparation region.
- **Functions Called**:
    - [`fd_wksp_private_checkpt_v1_ulong`](<#fd_wksp_private_checkpt_v1_ulong>)


---
### fd\_wksp\_private\_checkpt\_v1<!-- {{#callable:fd_wksp_private_checkpt_v1}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_checkpt_v1.c#L86>)

Creates a checkpoint of a workspace to a specified file path with metadata and partition data.
- **Inputs**:
    - ``tpool``: A pointer to a thread pool, currently unused in this function.
    - ``t0``: An unsigned long integer, currently unused in this function.
    - ``t1``: An unsigned long integer, currently unused in this function.
    - ``wksp``: A pointer to the workspace structure to be checkpointed.
    - ``path``: A constant character pointer to the file path where the checkpoint will be saved.
    - ``mode``: An unsigned long integer representing the file creation mode.
    - ``uinfo``: A constant character pointer to user information to be included in the checkpoint.
- **Logic and Control Flow**:
    - Set the file creation mask to zero and open the file at `path` with exclusive write access; restore the mask after opening.
    - Initialize a buffered output stream for writing the checkpoint data.
    - Lock the workspace to ensure data consistency during the checkpoint process.
    - Verify the workspace's address range is valid; if not, log corruption and exit.
    - Prepare and write metadata including workspace properties and logging information to the checkpoint file.
    - Iterate over each partition in the workspace, checking for validity and writing partition headers and data to the checkpoint file.
    - Write a footer to the checkpoint file to indicate the end of data.
    - Flush the buffered output stream to ensure all data is written to the file.
    - Unlock the workspace and finalize the output stream.
    - Handle errors by logging warnings and cleaning up resources, including removing the checkpoint file if necessary.
- **Output**: Returns 0 on success, or a non-zero error code on failure, indicating either an I/O error or workspace corruption.
- **Functions Called**:
    - [`fd_wksp_private_lock`](<fd_wksp_admin.c.md#fd_wksp_private_lock>)
    - [`fd_wksp_private_checkpt_v1_prepare`](<#fd_wksp_private_checkpt_v1_prepare>)
    - [`fd_wksp_private_checkpt_v1_ulong`](<#fd_wksp_private_checkpt_v1_ulong>)
    - [`fd_wksp_private_checkpt_v1_buf`](<#fd_wksp_private_checkpt_v1_buf>)
    - [`fd_wksp_private_checkpt_v1_publish`](<#fd_wksp_private_checkpt_v1_publish>)
    - [`fd_wksp_private_pinfo`](<fd_wksp_private.h.md#fd_wksp_private_pinfo>)
    - [`fd_wksp_private_pinfo_idx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx>)
    - [`fd_wksp_private_pinfo_idx_is_null`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx_is_null>)
    - [`fd_wksp_laddr_fast`](<fd_wksp.h.md#fd_wksp_laddr_fast>)
    - [`fd_wksp_private_checkpt_v1_write`](<#fd_wksp_private_checkpt_v1_write>)
    - [`fd_wksp_private_unlock`](<fd_wksp_private.h.md#fd_wksp_private_unlock>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)