<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions and macros for restoring workspace checkpoints in version 2, including handling headers, info, footers, and cgroups.

# Purpose
The code is a C source file that implements functions for restoring a workspace checkpoint from a version 2 (v2) format. It includes several macros and static functions that handle the restoration of different frames (header, info, footer) and components (cgroups, volumes) from a checkpoint. The file is part of a larger system that manages workspace checkpoints, which are used to save and restore the state of a workspace.

The main components of the code include macros for handling restoration operations (`RESTORE_SEEK`, `RESTORE_OPEN`, `RESTORE_CLOSE`, `RESTORE_META`, `RESTORE_DATA`, `RESTORE_TEST`), and functions such as [`fd_wksp_restore_v2_hdr`](<#fd_wksp_restore_v2_hdr>), [`fd_wksp_restore_v2_info`](<#fd_wksp_restore_v2_info>), and [`fd_wksp_restore_v2_ftr`](<#fd_wksp_restore_v2_ftr>) that restore specific frames from a checkpoint. The code also includes functions for handling multi-threaded restoration using a thread pool ([`fd_wksp_private_restore_v2_node`](<#fd_wksp_private_restore_v2_node>)) and for restoring checkpoints from memory-mapped I/O or streaming sources ([`fd_wksp_private_restore_v2_mmio`](<#fd_wksp_private_restore_v2_mmio>), [`fd_wksp_private_restore_v2_stream`](<#fd_wksp_private_restore_v2_stream>)). The file defines internal functions and macros, indicating that it is intended for use within a specific module or library rather than as a public API.
# Imports and Dependencies

---
- `fd_wksp_private.h`
- `stdio.h`
- `errno.h`
- `unistd.h`
- `fcntl.h`
- `sys/stat.h`


# Functions

---
### fd\_wksp\_restore\_v2\_hdr<!-- {{#callable:fd_wksp_restore_v2_hdr}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_restore_v2.c#L81>)

Restores a workspace checkpoint version 2 header from a restore object and validates its contents.
- **Inputs**:
    - ``restore``: A pointer to an `fd_restore_t` object, which represents the restore context.
    - ``hdr``: A pointer to an `fd_wksp_checkpt_v2_hdr_t` object, which will be populated with the restored header data.
- **Logic and Control Flow**:
    - Opens a restore frame with the style `FD_CHECKPT_FRAME_STYLE_RAW` using the `RESTORE_OPEN` macro.
    - Restores the header data into `hdr` using the `RESTORE_DATA` macro, specifying the size of `fd_wksp_checkpt_v2_hdr_t`.
    - Closes the restore frame using the `RESTORE_CLOSE` macro.
    - Calculates the length of the name in the header using `fd_shmem_name_len`.
    - Performs a series of validation checks on the restored header using the `RESTORE_TEST` macro, including checks on `magic`, `style`, `frame_style_compressed`, `reserved`, `name_len`, and the footprint calculated by [`fd_wksp_footprint`](<fd_wksp_admin.c.md#fd_wksp_footprint>).
    - Returns `FD_WKSP_SUCCESS` if all checks pass.
    - Jumps to the `fail` label and returns `FD_WKSP_ERR_FAIL` if any check fails.
- **Output**: Returns `FD_WKSP_SUCCESS` on successful restoration and validation, or `FD_WKSP_ERR_FAIL` on failure.
- **Functions Called**:
    - [`fd_wksp_footprint`](<fd_wksp_admin.c.md#fd_wksp_footprint>)


---
### fd\_wksp\_restore\_v2\_info<!-- {{#callable:fd_wksp_restore_v2_info}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_restore_v2.c#L117>)

Restores the info frame from a workspace checkpoint, populating the info structure and info_cstr array with data from the info_buf.
- **Inputs**:
    - `restore`: A pointer to an `fd_restore_t` structure, which manages the restore process.
    - `hdr`: A pointer to a constant `fd_wksp_checkpt_v2_hdr_t` structure containing header information for the checkpoint.
    - `info`: A pointer to an `fd_wksp_checkpt_v2_info_t` structure where the restored info will be stored.
    - `info_buf`: A buffer to store the restored info data.
    - `info_buf_max`: The maximum size of the `info_buf`.
    - `info_cstr`: An array of 9 constant character pointers to store string representations of the restored info fields.
- **Logic and Control Flow**:
    - Opens the restore frame using the frame style from `hdr`.
    - Restores metadata into the `info` structure using `RESTORE_META`.
    - Calculates the total size of the info buffer needed by summing the sizes of various fields in `info`.
    - Checks if the calculated buffer size is within the maximum allowed size using `RESTORE_TEST`.
    - Restores the data into `info_buf` using `RESTORE_DATA`.
    - Iterates over each field in `info`, using the `NEXT` macro to extract and validate strings from `info_buf`, storing them in `info_cstr`.
    - Returns `FD_WKSP_SUCCESS` on success, or `FD_WKSP_ERR_FAIL` if any restore operation fails.
- **Output**: Returns an integer status code: `FD_WKSP_SUCCESS` on success or `FD_WKSP_ERR_FAIL` on failure.


---
### fd\_wksp\_restore\_v2\_ftr<!-- {{#callable:fd_wksp_restore_v2_ftr}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_restore_v2.c#L183>)

Restores the footer frame from a workspace checkpoint and validates its compatibility with the header.
- **Inputs**:
    - ``restore``: A pointer to an `fd_restore_t` structure, which manages the restoration process.
    - ``hdr``: A constant pointer to an `fd_wksp_checkpt_v2_hdr_t` structure containing header information from the checkpoint.
    - ``ftr``: A pointer to an `fd_wksp_checkpt_v2_ftr_t` structure where the footer data will be restored.
    - ``checkpt_sz``: An unsigned long integer representing the size of the checkpoint.
- **Logic and Control Flow**:
    - Opens a raw frame style for restoration using `RESTORE_OPEN` macro.
    - Restores the footer data into `ftr` using `RESTORE_DATA` macro.
    - Closes the frame using `RESTORE_CLOSE` macro.
    - Validates that the frame offset matches `checkpt_sz` using `RESTORE_TEST`.
    - Checks that `ftr->checkpt_sz` equals `checkpt_sz`.
    - Compares various fields in `ftr` and `hdr` to ensure they match, including `data_max`, `part_max`, `seed`, `name`, `reserved`, `frame_style_compressed`, `style`, and `unmagic`.
    - Returns `FD_WKSP_SUCCESS` if all tests pass, otherwise jumps to `fail` label and returns `FD_WKSP_ERR_FAIL`.
- **Output**: Returns an integer indicating success (`FD_WKSP_SUCCESS`) or failure (`FD_WKSP_ERR_FAIL`).


---
### fd\_wksp\_private\_restore\_v2\_common<!-- {{#callable:fd_wksp_private_restore_v2_common}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_restore_v2.c#L221>)

Restores the header and info frames from a workspace checkpoint and logs the details.
- **Inputs**:
    - ``hdr``: A pointer to `fd_wksp_checkpt_v2_hdr_t`, which will be populated with header data from the checkpoint.
    - ``restore``: A pointer to `fd_restore_t`, which represents the restore context and must be valid and positioned at the start of the header frame.
- **Logic and Control Flow**:
    - Logs the start of the restoration process for header and info frames.
    - Calls [`fd_wksp_restore_v2_hdr`](<#fd_wksp_restore_v2_hdr>) to restore the header frame and checks for success using `RESTORE_TEST`.
    - Initializes local variables `info`, `info_buf`, and `info_cstr` to store info frame data.
    - Calls [`fd_wksp_restore_v2_info`](<#fd_wksp_restore_v2_info>) to restore the info frame and checks for success using `RESTORE_TEST`.
    - Formats the wallclock time from the info frame into a string using `fd_log_wallclock_cstr`.
    - Logs detailed information from the header and info frames, including style, name, seed, part_max, data_max, magic, wallclock, and other fields.
    - Logs additional info strings (`path`, `binfo`, `uinfo`) separately to avoid truncation by the logger.
    - Returns `FD_WKSP_SUCCESS` on successful restoration.
- **Output**: Returns `FD_WKSP_SUCCESS` on success, or `FD_WKSP_ERR_FAIL` if an error occurs during restoration.
- **Functions Called**:
    - [`fd_wksp_restore_v2_hdr`](<#fd_wksp_restore_v2_hdr>)
    - [`fd_wksp_restore_v2_info`](<#fd_wksp_restore_v2_info>)


---
### fd\_wksp\_private\_restore\_v2\_cgroup<!-- {{#callable:fd_wksp_private_restore_v2_cgroup}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_restore_v2.c#L292>)

Restores a cgroup's allocation into a workspace from a checkpoint, updating metadata and data regions.
- **Inputs**:
    - ``wksp``: Pointer to the workspace where the cgroup allocation will be restored.
    - ``restore``: Pointer to the restore object used to manage the restoration process.
    - ``hdr``: Pointer to the header containing metadata about the restore operation.
    - ``frame_off_lo``: Lower bound of the frame offset for the cgroup to restore.
    - ``frame_off_hi``: Upper bound of the frame offset for the cgroup to restore.
    - ``part_lo``: Lower bound of the partition indices to use for this frame's allocations.
    - ``part_hi``: Upper bound of the partition indices to use for this frame's allocations.
    - ``_dirty``: Pointer to an integer that will be set to 1 if the workspace was modified, otherwise 0.
- **Logic and Control Flow**:
    - Initialize `dirty` to 0 and retrieve workspace private information and data bounds.
    - Calculate header data bounds using `hdr->part_max` and `hdr->data_max`.
    - Seek to the start of the frame using `RESTORE_SEEK` and open the frame with `RESTORE_OPEN`.
    - Iterate over partitions from `part_lo` to `part_hi` to restore metadata using `RESTORE_META` and validate it with `RESTORE_TEST`.
    - Check if the restored metadata fits within the current workspace data region; log a warning and fail if not.
    - Set `dirty` to 1 and update the workspace private information with restored metadata.
    - Restore the data command and validate it using `RESTORE_META` and `RESTORE_TEST`.
    - Iterate over partitions again to restore allocation data into the workspace data region using `RESTORE_DATA`.
    - Close the frame with `RESTORE_CLOSE` and validate the frame offset with `RESTORE_TEST`.
    - Set the `_dirty` output to the value of `dirty` and return `FD_WKSP_SUCCESS` on success or `FD_WKSP_ERR_FAIL` on failure.
- **Output**: Returns `FD_WKSP_SUCCESS` on success and `FD_WKSP_ERR_FAIL` on failure, with `_dirty` set to 1 if the workspace was modified.
- **Functions Called**:
    - [`fd_wksp_private_pinfo`](<fd_wksp_private.h.md#fd_wksp_private_pinfo>)
    - [`fd_wksp_private_data_off`](<fd_wksp_private.h.md#fd_wksp_private_data_off>)
    - [`fd_wksp_checkpt_v2_cmd_is_meta`](<fd_wksp_private.h.md#fd_wksp_checkpt_v2_cmd_is_meta>)
    - [`fd_wksp_checkpt_v2_cmd_is_data`](<fd_wksp_private.h.md#fd_wksp_checkpt_v2_cmd_is_data>)
    - [`fd_wksp_laddr_fast`](<fd_wksp.h.md#fd_wksp_laddr_fast>)


---
### fd\_wksp\_private\_restore\_v2\_node<!-- {{#callable:fd_wksp_private_restore_v2_node}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_restore_v2.c#L386>)

Restores cgroup allocations in a workspace using a thread pool, handling errors and modifications.
- **Inputs**:
    - `tpool`: Pointer to the thread pool used for parallel execution.
    - `tpool_t0`: Starting index of the thread range in the thread pool.
    - `tpool_t1`: Ending index of the thread range in the thread pool, assumed to be greater than `tpool_t0`.
    - `_wksp`: Pointer to the workspace where the cgroup allocations will be restored.
    - `_restore`: Pointer to the restore object used for restoring data.
    - `_hdr`: Pointer to the header information for the restore process.
    - `_cgroup_frame_off`: Pointer to an array of offsets for cgroup frames.
    - `_cgroup_pinfo_lo`: Pointer to an array of partition indices for cgroup allocations.
    - `_cgroup_nxt`: Pointer to the next cgroup index to be processed.
    - `cgroup_cnt`: Total number of cgroups to be processed.
    - `_err`: Pointer to an integer where the first encountered error code will be stored.
    - `_dirty`: Pointer to an integer where the modification status of the workspace will be stored.
- **Logic and Control Flow**:
    - Calculate the number of threads (`tpool_cnt`) by subtracting `tpool_t0` from `tpool_t1`.
    - If `tpool_cnt` is greater than 1, split the thread range into two halves and recursively call `fd_wksp_private_restore_v2_node` for each half.
    - Execute the right half using `fd_tpool_exec` and handle the left half in the current thread.
    - Wait for the right half to complete using `fd_tpool_wait`.
    - Combine the results from both halves, storing the first error encountered in `_err` and accumulating the dirty flag in `_dirty`.
    - If `tpool_cnt` is 1, handle a single thread by unpacking input arguments and initializing a local restore object.
    - Use a loop to fetch and process each cgroup index until all cgroups are processed or an error occurs.
    - For each cgroup, call [`fd_wksp_private_restore_v2_cgroup`](<#fd_wksp_private_restore_v2_cgroup>) to restore the cgroup and update the dirty flag.
    - Finalize the local restore object and store the error and dirty status in `_err` and `_dirty`.
- **Output**: No direct output; modifies the workspace and updates `_err` and `_dirty` with the error status and modification status, respectively.
- **Functions Called**:
    - [`fd_wksp_private_restore_v2_cgroup`](<#fd_wksp_private_restore_v2_cgroup>)


---
### fd\_wksp\_private\_restore\_v2\_mmio<!-- {{#callable:fd_wksp_private_restore_v2_mmio}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_restore_v2.c#L506>)

Replaces all allocations in a workspace with those from a restore object using memory-mapped I/O, utilizing a thread pool for parallel processing.
- **Inputs**:
    - `tpool`: A pointer to a thread pool (`fd_tpool_t *`) used for parallel processing.
    - `t0`: The starting index of the thread pool range (`ulong`).
    - `t1`: The ending index of the thread pool range (`ulong`).
    - `wksp`: A pointer to the workspace (`fd_wksp_t *`) where allocations will be restored.
    - `restore`: A pointer to the restore object (`fd_restore_t *`) containing the data to restore.
    - `new_seed`: A new seed value (`uint`) for rebuilding the workspace.
- **Logic and Control Flow**:
    - Initialize variables `frame_off`, `locked`, and `dirty` to track the frame offset, lock status, and modification status of the workspace.
    - Calculate the size of the restore object using `fd_restore_sz` and determine offsets for the header, info, and footer frames.
    - Validate the frame offsets to ensure they are in the correct order and within bounds.
    - Restore and validate the header and info frames using [`fd_wksp_private_restore_v2_common`](<#fd_wksp_private_restore_v2_common>).
    - Log the restoration of the footer and restore it using [`fd_wksp_restore_v2_ftr`](<#fd_wksp_restore_v2_ftr>).
    - Check if the number of allocations in the footer exceeds the workspace's partition maximum and log a warning if so.
    - Log the restoration of volumes and seek to the volume frame offset.
    - Open the frame and read metadata using `RESTORE_META`, then close the frame.
    - Lock the workspace using [`fd_wksp_private_lock`](<fd_wksp_admin.c.md#fd_wksp_private_lock>) and set `locked` to 1 if successful.
    - Iterate over all volumes, verifying and restoring each volume's appendix and cgroup allocations.
    - Dispatch work to thread pool threads using [`fd_wksp_private_restore_v2_node`](<#fd_wksp_private_restore_v2_node>) for parallel restoration of cgroups.
    - Check for errors during cgroup restoration and log warnings if necessary.
    - Ensure all volumes and cgroups are processed and position the restore at the expected location.
    - Free any remaining old allocations and rebuild the workspace using [`fd_wksp_rebuild`](<fd_wksp_admin.c.md#fd_wksp_rebuild>).
    - Unlock the workspace using [`fd_wksp_private_unlock`](<fd_wksp_private.h.md#fd_wksp_private_unlock>) and return `FD_WKSP_SUCCESS` on success.
    - Handle failures by releasing resources, unlocking the workspace if locked, and returning appropriate error codes.
- **Output**: Returns `FD_WKSP_SUCCESS` on success, `FD_WKSP_ERR_FAIL` if an error occurred before the workspace was modified, and `FD_WKSP_ERR_CORRUPT` if an error occurred after modification.
- **Functions Called**:
    - [`fd_wksp_private_restore_v2_common`](<#fd_wksp_private_restore_v2_common>)
    - [`fd_wksp_restore_v2_ftr`](<#fd_wksp_restore_v2_ftr>)
    - [`fd_wksp_private_lock`](<fd_wksp_admin.c.md#fd_wksp_private_lock>)
    - [`fd_wksp_checkpt_v2_cmd_is_appendix`](<fd_wksp_private.h.md#fd_wksp_checkpt_v2_cmd_is_appendix>)
    - [`fd_wksp_private_restore_v2_node`](<#fd_wksp_private_restore_v2_node>)
    - [`fd_wksp_private_pinfo`](<fd_wksp_private.h.md#fd_wksp_private_pinfo>)
    - [`fd_wksp_rebuild`](<fd_wksp_admin.c.md#fd_wksp_rebuild>)
    - [`fd_wksp_private_unlock`](<fd_wksp_private.h.md#fd_wksp_private_unlock>)


---
### fd\_wksp\_private\_restore\_v2\_stream<!-- {{#callable:fd_wksp_private_restore_v2_stream}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_restore_v2.c#L727>)

Restores a workspace from a checkpoint stream, validating and rebuilding its structure.
- **Inputs**:
    - ``wksp``: A pointer to the workspace (`fd_wksp_t`) to restore.
    - ``restore``: A pointer to the restore object (`fd_restore_t`) that provides the checkpoint data.
    - ``new_seed``: An unsigned integer used as a new seed for rebuilding the workspace.
- **Logic and Control Flow**:
    - Initialize variables to track the lock state and modification state of the workspace.
    - Call [`fd_wksp_private_restore_v2_common`](<#fd_wksp_private_restore_v2_common>) to restore the header and info frames from the checkpoint.
    - Attempt to lock the workspace using [`fd_wksp_private_lock`](<fd_wksp_admin.c.md#fd_wksp_private_lock>); if unsuccessful, go to the fail state.
    - Iterate over volumes in the checkpoint, logging the restoration process for each volume.
    - Within each volume, iterate over cgroups, opening frames and reading commands to determine the type of frame (cgroup, appendix, or end of volumes).
    - For cgroup frames, restore allocation metadata and data into the workspace's `pinfo` array and data region, updating the `dirty` flag as necessary.
    - For appendix frames, validate the frame offsets and allocation counts against the cgroup data.
    - If an end of volumes frame is encountered, proceed to restore the footer.
    - Restore and validate the footer, ensuring that the allocation, cgroup, and volume counts match the restored data.
    - Rebuild the workspace using [`fd_wksp_rebuild`](<fd_wksp_admin.c.md#fd_wksp_rebuild>) with the new seed, freeing any remaining old allocations.
    - Unlock the workspace and return success if all operations complete without error.
    - If any operation fails, release resources, unlock the workspace if locked, and return an error code indicating whether the workspace was modified.
- **Output**: Returns `FD_WKSP_SUCCESS` on successful restoration, `FD_WKSP_ERR_CORRUPT` if an error occurred after modifications, or `FD_WKSP_ERR_FAIL` if an error occurred before modifications.
- **Functions Called**:
    - [`fd_wksp_private_restore_v2_common`](<#fd_wksp_private_restore_v2_common>)
    - [`fd_wksp_private_lock`](<fd_wksp_admin.c.md#fd_wksp_private_lock>)
    - [`fd_wksp_private_pinfo`](<fd_wksp_private.h.md#fd_wksp_private_pinfo>)
    - [`fd_wksp_private_data_off`](<fd_wksp_private.h.md#fd_wksp_private_data_off>)
    - [`fd_wksp_checkpt_v2_cmd_is_appendix`](<fd_wksp_private.h.md#fd_wksp_checkpt_v2_cmd_is_appendix>)
    - [`fd_wksp_checkpt_v2_cmd_is_volumes`](<fd_wksp_private.h.md#fd_wksp_checkpt_v2_cmd_is_volumes>)
    - [`fd_wksp_checkpt_v2_cmd_is_data`](<fd_wksp_private.h.md#fd_wksp_checkpt_v2_cmd_is_data>)
    - [`fd_wksp_checkpt_v2_cmd_is_meta`](<fd_wksp_private.h.md#fd_wksp_checkpt_v2_cmd_is_meta>)
    - [`fd_wksp_laddr_fast`](<fd_wksp.h.md#fd_wksp_laddr_fast>)
    - [`fd_wksp_restore_v2_ftr`](<#fd_wksp_restore_v2_ftr>)
    - [`fd_wksp_rebuild`](<fd_wksp_admin.c.md#fd_wksp_rebuild>)
    - [`fd_wksp_private_unlock`](<fd_wksp_private.h.md#fd_wksp_private_unlock>)


---
### fd\_wksp\_private\_restore\_v2<!-- {{#callable:fd_wksp_private_restore_v2}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_restore_v2.c#L932>)

Restores a checkpoint from a file into a workspace, using either memory-mapped I/O or streaming, and logs the process.
- **Inputs**:
    - `tpool`: A pointer to a thread pool used for parallel processing.
    - `t0`: The starting index of threads in the thread pool to use.
    - `t1`: The ending index of threads in the thread pool to use.
    - `wksp`: A pointer to the workspace where the checkpoint will be restored.
    - `path`: A constant character pointer to the file path of the checkpoint to restore.
    - `new_seed`: An unsigned integer representing the new seed for the workspace.
- **Logic and Control Flow**:
    - Logs the start of the restoration process with the checkpoint path and workspace name.
    - Attempts to open the checkpoint file in read-only mode; logs a warning and exits on failure.
    - Initializes memory-mapped I/O (mmio) for the file; if successful, proceeds with mmio restoration, otherwise uses streaming restoration.
    - For mmio restoration, initializes a restore object and calls [`fd_wksp_private_restore_v2_mmio`](<#fd_wksp_private_restore_v2_mmio>); logs details and exits on failure.
    - For streaming restoration, initializes a restore object and calls [`fd_wksp_private_restore_v2_stream`](<#fd_wksp_private_restore_v2_stream>); logs details and exits on failure.
    - Logs the closing of the checkpoint file and attempts to finalize the restore object and close the file, logging warnings on failure.
    - Returns the error code from the restoration process or a failure code if any step fails.
- **Output**: Returns an integer indicating success or failure of the restoration process.
- **Functions Called**:
    - [`fd_wksp_private_restore_v2_mmio`](<#fd_wksp_private_restore_v2_mmio>)
    - [`fd_wksp_private_restore_v2_stream`](<#fd_wksp_private_restore_v2_stream>)


---
### fd\_wksp\_private\_printf\_v2<!-- {{#callable:fd_wksp_private_printf_v2}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_restore_v2.c#L1017>)

Prints the header and metadata of a workspace checkpoint file to a specified output.
- **Inputs**:
    - `out`: The file descriptor where the function will print the output.
    - `path`: The file path to the workspace checkpoint file to be read.
    - `verbose`: The verbosity level for printing details; higher values print more information.
- **Logic and Control Flow**:
    - Initialize return value `ret` to 0 and define a macro `TRAP` for error handling.
    - If `verbose` is greater than or equal to 1, attempt to open the file at `path` for reading.
    - If the file cannot be opened, log a warning and jump to the `fail` label.
    - Initialize a restore stream with `fd_restore_init_stream` and check for success.
    - Restore the header using [`fd_wksp_restore_v2_hdr`](<#fd_wksp_restore_v2_hdr>) and check for success.
    - Restore the info using [`fd_wksp_restore_v2_info`](<#fd_wksp_restore_v2_info>) and check for success.
    - Format and print the header and info details to `out` using `dprintf`, handling errors with `TRAP`.
    - If `verbose` is greater than or equal to 2, print additional details such as mode, path, binfo, and uinfo.
    - Finalize the restore with `fd_restore_fini` and close the file, logging warnings if these operations fail.
    - If any errors occur during the process, release resources and log warnings as needed.
- **Output**: Returns an integer `ret` which is the sum of bytes written to `out` or an error code if an error occurred.
- **Functions Called**:
    - [`fd_wksp_restore_v2_hdr`](<#fd_wksp_restore_v2_hdr>)
    - [`fd_wksp_restore_v2_info`](<#fd_wksp_restore_v2_info>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)