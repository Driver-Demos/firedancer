<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for restoring and printing version 1 workspace checkpoints from a buffered input stream.

# Purpose
The code is a C source file that provides functionality for restoring data from a checkpoint file into a workspace. It includes functions to read and decode data from a buffered input stream, specifically designed to handle the restoration of unsigned long integers and variable-length buffers. The primary function, [`fd_wksp_private_restore_v1`](<#fd_wksp_private_restore_v1>), is responsible for restoring a workspace from a file specified by a path, using a buffered input stream to read the data. It validates the integrity of the data by checking magic numbers and other metadata, and it ensures that the restored data fits within the workspace's constraints. The function also handles potential errors during the restoration process, logging warnings and attempting to reset the workspace if necessary.

Additionally, the file includes a function [`fd_wksp_private_printf_v1`](<#fd_wksp_private_printf_v1>) that prints the contents of a checkpoint file to an output stream. This function reads and verifies the header and metadata of the checkpoint file, and it can provide detailed information about the partitions within the workspace, depending on the verbosity level specified. The code uses macros to simplify repetitive tasks such as restoring unsigned long integers and C-style strings, and it defines constants for buffer alignment and size. The file is intended to be part of a larger system that manages workspaces, and it does not define public APIs or external interfaces directly.
# Imports and Dependencies

---
- `fd_wksp_private.h`
- `stdio.h`
- `errno.h`
- `unistd.h`
- `fcntl.h`
- `sys/stat.h`


# Functions

---
### fd\_wksp\_private\_restore\_v1\_ulong<!-- {{#callable:fd_wksp_private_restore_v1_ulong}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_restore_v1.c#L15>)

Restores an encoded unsigned long integer from a buffered input stream.
- **Inputs**:
    - `in`: A pointer to a `fd_io_buffered_istream_t` structure representing the input stream from which to read the encoded value.
    - `_val`: A pointer to an `ulong` where the decoded value will be stored.
- **Logic and Control Flow**:
    - Initialize local variables `csz`, `buf`, and `_buf` for size, buffer pointer, and temporary buffer storage respectively.
    - Check the size of the prefetched data in the input stream using `fd_io_buffered_istream_peek_sz`.
    - If the prefetched size is at least 9 bytes, set `buf` to the prefetched data and determine the size of the encoded value using `fd_ulong_svw_dec_sz`.
    - Advance the input stream by the size of the encoded value using `fd_io_buffered_istream_seek`.
    - If the prefetched size is less than 9 bytes, read the first byte into `_buf` and determine the size of the encoded value.
    - Read the remaining bytes of the encoded value into `_buf` if necessary.
    - Decode the encoded value using `fd_ulong_svw_dec_fixed` and store it in `_val`.
    - Return 0 to indicate success.
- **Output**: Returns 0 on success, and on failure, returns a non-zero error code and sets `*_val` to 0.


---
### fd\_wksp\_private\_restore\_v1\_buf<!-- {{#callable:fd_wksp_private_restore_v1_buf}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_restore_v1.c#L53>)

Restores a buffer from a stream, ensuring it does not exceed a specified maximum size.
- **Inputs**:
    - ``in``: A pointer to a `fd_io_buffered_istream_t` stream from which the buffer is restored.
    - ``buf``: A pointer to the buffer where the data will be restored.
    - ``buf_max``: The maximum allowable size of the buffer.
    - ``_buf_sz``: A pointer to a `ulong` where the size of the restored buffer will be stored.
- **Logic and Control Flow**:
    - Call [`fd_wksp_private_restore_v1_ulong`](<#fd_wksp_private_restore_v1_ulong>) to restore the size of the buffer (`buf_sz`) from the stream `in`.
    - Check if there is an error in restoring `buf_sz` or if `buf_sz` exceeds `buf_max`. If so, set `*_buf_sz` to 0 and return the error code.
    - If no error, call `fd_io_buffered_istream_read` to read `buf_sz` bytes from the stream `in` into `buf`.
    - Set `*_buf_sz` to `buf_sz` if no error occurred during reading, otherwise set it to 0.
    - Return the error code from the read operation.
- **Output**: Returns 0 on success, with `buf` containing the restored data and `*_buf_sz` containing the size of the restored buffer. Returns a non-zero error code on failure, with `*_buf_sz` set to 0.
- **Functions Called**:
    - [`fd_wksp_private_restore_v1_ulong`](<#fd_wksp_private_restore_v1_ulong>)


---
### fd\_wksp\_private\_restore\_v1<!-- {{#callable:fd_wksp_private_restore_v1}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_restore_v1.c#L94>)

Restores a workspace from a checkpoint file into a given workspace structure.
- **Inputs**:
    - `tpool`: A pointer to a thread pool, currently unused in this function.
    - `t0`: An unsigned long integer, currently unused in this function.
    - `t1`: An unsigned long integer, currently unused in this function.
    - `wksp`: A pointer to the workspace structure where the checkpoint will be restored.
    - `path`: A constant character pointer to the file path of the checkpoint to restore.
    - `new_seed`: An unsigned integer representing the new seed for the workspace.
- **Logic and Control Flow**:
    - Logs the start of the restore process with the checkpoint path and workspace name.
    - Opens the checkpoint file in read-only mode and checks for errors.
    - Initializes a buffered input stream for reading the checkpoint file.
    - Locks the workspace to prevent concurrent modifications during the restore process.
    - Reads and validates the checkpoint header, including magic number, style, seed, and other metadata.
    - Logs detailed information about the checkpoint metadata.
    - Restores allocation headers and payloads from the checkpoint file into the workspace, checking for errors and constraints.
    - If the workspace becomes dirty during the restore, attempts to reset it to a clean state.
    - Rebuilds the workspace with the restored allocations and logs the success or failure of the rebuild.
    - Unlocks the workspace and finalizes the input stream.
    - Closes the checkpoint file and logs any errors encountered during the close operation.
    - Returns an error code indicating the success or failure of the restore operation.
- **Output**: Returns an integer error code, where 0 indicates success and non-zero indicates failure.
- **Functions Called**:
    - [`fd_wksp_private_lock`](<fd_wksp_admin.c.md#fd_wksp_private_lock>)
    - [`fd_wksp_private_pinfo`](<fd_wksp_private.h.md#fd_wksp_private_pinfo>)
    - [`fd_wksp_footprint`](<fd_wksp_admin.c.md#fd_wksp_footprint>)
    - [`fd_wksp_private_data_off`](<fd_wksp_private.h.md#fd_wksp_private_data_off>)
    - [`fd_wksp_laddr_fast`](<fd_wksp.h.md#fd_wksp_laddr_fast>)
    - [`fd_wksp_rebuild`](<fd_wksp_admin.c.md#fd_wksp_rebuild>)
    - [`fd_wksp_private_unlock`](<fd_wksp_private.h.md#fd_wksp_private_unlock>)


---
### fd\_wksp\_private\_printf\_v1<!-- {{#callable:fd_wksp_private_printf_v1}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_restore_v1.c#L326>)

Reads and prints metadata and partition information from a file, with verbosity-controlled output.
- **Inputs**:
    - `out`: The file descriptor where the function writes the output.
    - `path`: The path to the file that contains the data to read.
    - `verbose`: The verbosity level that controls the amount of information printed.
- **Logic and Control Flow**:
    - Open the file at the given `path` for reading.
    - Initialize a buffered input stream with the opened file.
    - Read and validate metadata from the file, including magic number, style, seed, and other identifiers.
    - If `verbose` is 1 or higher, print detailed metadata information.
    - If `verbose` is 2 or higher, print additional information such as `binfo` and `uinfo`.
    - If `verbose` is 3 or higher, calculate and print allocation statistics.
    - Iterate over partitions, reading and validating each partition's metadata.
    - If `verbose` is 4 or higher, print detailed partition information.
    - Handle errors by printing error messages and exiting the loop.
    - Close the file and finalize the input stream.
- **Output**: Returns the total number of bytes written to `out`, or an error code if an error occurs.
- **Functions Called**:
    - [`fd_wksp_footprint`](<fd_wksp_admin.c.md#fd_wksp_footprint>)
    - [`fd_wksp_private_data_off`](<fd_wksp_private.h.md#fd_wksp_private_data_off>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)