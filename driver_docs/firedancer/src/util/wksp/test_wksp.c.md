<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

A torture test for same-thread memory allocation and deallocation in a workspace environment.

# Purpose
The code is a C program designed to perform a "torture test" for memory allocation and deallocation within the same thread. It uses a workspace (`fd_wksp_t`) to manage memory allocations, testing the allocation and deallocation of memory blocks with varying sizes and alignments. The program defines a maximum number of outstanding allocations (`OUTSTANDING_MAX`) and uses a random number generator to decide whether to allocate or free memory in each iteration. The test ensures that memory usage statistics are consistent and that allocated memory is correctly aligned and tagged. The program also verifies that the data integrity of allocated memory is maintained by checking bit patterns before and after allocations.

The [`main`](<#main>) function initializes the environment, parses command-line arguments to configure the test parameters, and sets up the workspace. It then launches the test on multiple tiles (or threads) using `fd_tile_exec_new` to simulate concurrent execution. The test waits for a signal to start (`go` variable) and then performs the allocation and deallocation operations. After the test completes, the program cleans up by detaching or deleting the workspace and halting the execution. The code is structured to be executed as a standalone program, with the [`main`](<#main>) function serving as the entry point.
# Imports and Dependencies

---
- `../fd_util.h`


# Global Variables

---
### go
- **Type**: ``int``
- **Description**: A static integer variable initialized to 0.
- **Use**: Used as a flag to control the execution flow in the `test_main` function.


---
### \_wksp
- **Type**: ``fd_wksp_t *``
- **Description**: A pointer to a workspace object of type `fd_wksp_t`. This variable is used to manage memory allocations and deallocations within the program.
- **Use**: Used to reference the workspace for memory operations such as allocation and deallocation.


---
### \_alloc\_cnt
- **Type**: `ulong`
- **Description**: Represents the number of memory allocations to perform during the test.
- **Use**: Used to control the number of allocation iterations in the `test_main` function.


---
### \_align\_max
- **Type**: ``ulong``
- **Description**: Stores the maximum alignment value for memory allocations in the workspace. It is initialized from the command line argument `--align-max` and must be a power of 2.
- **Use**: Used to determine the alignment constraints for memory allocations in the workspace.


---
### \_sz\_max
- **Type**: ``ulong``
- **Description**: A static global variable that stores the maximum size for memory allocations in the test program.
- **Use**: Used to determine the maximum size of memory allocations during the torture test for same thread allocation.


# Functions

---
### test\_main<!-- {{#callable:test_main}} -->
[View Source →](<../../../../../src/util/wksp/test_wksp.c#L14>)

Performs a stress test on memory allocation and deallocation in a shared workspace, ensuring data integrity and alignment.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: The array of command-line arguments.
- **Logic and Control Flow**:
    - Initialize variables and constants, including workspace and random number generator.
    - Check initial workspace usage and validate its state.
    - Wait for a signal to start the test loop.
    - Iterate over twice the allocation count, deciding randomly whether to allocate or free memory.
    - For allocation, determine size and alignment, allocate memory, and fill it with a unique pattern.
    - For deallocation, select a random outstanding allocation, verify its integrity, and free it.
    - Repeat the allocation and deallocation process, ensuring workspace usage remains consistent.
    - Clean up by deleting the random number generator and returning 0.
- **Output**: Returns 0 to indicate successful execution.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/util/wksp/test_wksp.c#L182>)

Initializes the environment, processes command-line arguments, sets up a workspace, and executes a multi-threaded test for memory allocation and deallocation.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of strings representing the command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Extracts various configuration parameters from the command-line arguments using `fd_env_strip_cmdline_cstr`, `fd_env_strip_cmdline_ulong`, and `fd_env_strip_cmdline_uint`.
    - Validates the extracted parameters, logging errors if any constraints are violated.
    - Determines the number of tiles available using `fd_tile_cnt`.
    - Checks if a workspace name is provided; if so, attaches to it using `fd_wksp_attach`, otherwise creates an anonymous workspace with `fd_wksp_new_anon`.
    - Logs the configuration details for the test.
    - Verifies the alignment of the workspace with `fd_ulong_is_aligned` and logs an error if it is not aligned.
    - Initializes remote tiles for execution using `fd_tile_exec_new` and stores the execution contexts in an array.
    - Pauses for a short duration using `fd_log_sleep` before starting the tests.
    - Sets a volatile flag `go` to 1 to signal the start of the test and calls [`test_main`](<#test_main>) to execute the test on the main tile.
    - Waits for remote tiles to complete their execution using `fd_tile_exec_delete`.
    - Detaches or deletes the workspace based on whether it was attached or created anonymously.
    - Logs a success message and calls `fd_halt` to terminate the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`test_main`](<#test_main>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)