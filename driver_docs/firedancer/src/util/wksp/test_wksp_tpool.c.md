<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests the functionality of workspace allocation, initialization, checkpointing, and restoration using a thread pool.

# Purpose
The code is an executable C program designed to test and validate the functionality of a workspace memory allocation system using a thread pool. It initializes a thread pool and random number generators, then performs a series of memory allocation and deallocation operations within a workspace. The program uses a test pattern to fill allocated memory regions and verifies the integrity of these regions through a series of checks. It also includes functionality to checkpoint and restore the workspace state to and from a file, ensuring that the memory allocations are consistent across these operations.

The program defines several static functions using macros, such as [`FD_FOR_ALL_BEGIN`](<#fd_for_all_begin>) and `FD_FOR_ALL_END`, to manage the initialization, finalization, and testing of memory allocations in a parallelized manner. The [`main`](<#main>) function orchestrates the entire process, including setting up the environment, managing command-line arguments, and logging the progress of the tests. The code uses various utility functions and macros, such as `fd_rng_new`, `fd_wksp_alloc`, and `fd_wksp_checkpt_tpool`, to perform its operations, indicating that it relies on an external library for workspace and random number management. The program concludes by cleaning up resources and logging the test results.
# Imports and Dependencies

---
- `../fd_util.h`
- `errno.h`
- `unistd.h`
- `fcntl.h`
- `sys/stat.h`


# Global Variables

---
### fd\_rng\_t
- **Type**: ``fd_rng_t``
- **Description**: Represents a static array of `fd_rng_t` type with a single element, used for random number generation.
- **Use**: Used to initialize and manage random number generators in a thread pool.


---
### FD\_FOR\_ALL\_BEGIN
- **Type**: `macro`
- **Description**: `FD_FOR_ALL_BEGIN` is a macro used to define a block of code that will be executed in parallel across multiple threads in a thread pool. It is used to initialize, finalize, or test various components such as random number generators and memory allocations.
- **Use**: Used to define parallel execution blocks for thread pool operations.


# Functions

---
### FD\_FOR\_ALL\_BEGIN<!-- {{#callable:FD_FOR_ALL_BEGIN}} -->
[View Source →](<../../../../../src/util/wksp/test_wksp_tpool.c#L25>)

Fills specified memory regions in a workspace with a test pattern based on a unique tag for each allocation.
- **Inputs**:
    - `arg`: An array of pointers where `arg[0]` is a pointer to a `fd_wksp_t` workspace and `arg[1]` is a pointer to an array of `alloc_info_t` structures containing allocation information.
- **Logic and Control Flow**:
    - Iterates over a range of indices from `block_i0` to `block_i1`.
    - For each index, retrieves the starting global address `gaddr0` and size `sz` from the `info` array.
    - Calculates a unique tag for each allocation as `idx + 1L`.
    - Determines a fill character `c` based on the tag, ensuring it is within the range [1, 255].
    - Uses `memset` to fill the memory region starting at the local address corresponding to `gaddr0` with the character `c` for `sz` bytes.
- **Output**: No direct output; modifies the memory regions in the workspace specified by the input arguments.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/util/wksp/test_wksp_tpool.c#L76>)

Initializes and manages a thread pool to test workspace allocation, checkpointing, and restoration with random number generation and logging.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: The array of command-line arguments.
- **Logic and Control Flow**:
    - Initialize the environment with `fd_boot` and parse command-line arguments for configuration options such as `--path`, `--mode`, `--keep`, `--worker-cnt`, `--wksp`, `--page-sz`, `--page-cnt`, `--near-cpu`, and `--iter-max`.
    - Set default values for path and mode if not provided, and log the configuration.
    - Initialize a thread pool with `fd_tpool_init` and log the details.
    - Add worker threads to the thread pool using `fd_tpool_worker_push`.
    - Initialize random number generators for each worker in the thread pool using `FD_FOR_ALL` with `rng_init`.
    - Attach to an existing workspace or create a new anonymous workspace based on the `--wksp` argument.
    - Iterate `iter_max` times to test workspace operations:
    -   - Reset the workspace with a random seed and fill it with randomly aligned and sized allocations.
    -   - Use `FD_FOR_ALL` with `alloc_init` to fill allocations with a test pattern.
    -   - Remove any existing file at the specified path and checkpoint the workspace using `fd_wksp_checkpt_tpool`.
    -   - Zero out all allocations using `FD_FOR_ALL` with `alloc_zero`.
    -   - Restore the workspace from the checkpoint using `fd_wksp_restore_tpool`.
    -   - Test that all allocations are as expected using `FD_FOR_ALL` with `alloc_test`.
    - Log the cleanup process, unlink the path if `--keep` is not set, and detach or delete the workspace.
    - Finalize random number generators and the thread pool with `FD_FOR_ALL` using `rng_fini` and `fd_tpool_fini`.
    - Log the completion of the process and halt the program with `fd_halt`.
- **Output**: Returns 0 upon successful completion.



---
Made with ❤️ by [Driver](https://www.driver.ai/)