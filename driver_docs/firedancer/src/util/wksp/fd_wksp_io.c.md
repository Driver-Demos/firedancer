<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for reading, previewing, checkpointing, restoring, and printing workspace checkpoint data.

# Purpose
The code provides functionality for handling workspace checkpoint operations in a C program. It includes functions to read, preview, check, restore, and print information about workspace checkpoints. The primary components are functions such as [`fd_wksp_private_checkpt_read`](<#fd_wksp_private_checkpt_read>), [`fd_wksp_preview`](<#fd_wksp_preview>), [`fd_wksp_checkpt_tpool`](<#fd_wksp_checkpt_tpool>), [`fd_wksp_restore_tpool`](<#fd_wksp_restore_tpool>), and [`fd_wksp_printf`](<#fd_wksp_printf>). These functions interact with checkpoint files, which are used to save and restore the state of a workspace. The code supports different versions of checkpoint styles, specifically V1, V2, and V3, with V3 being a compressed version of V2.

The file is intended to be part of a larger system, as it includes private headers and uses specific data structures and constants like `fd_wksp_preview_t`, `FD_WKSP_MAGIC`, and `FD_WKSP_CHECKPT_STYLE_V2`. It defines internal functions for reading and interpreting checkpoint data, as well as public APIs for managing checkpoint operations. The functions handle various error conditions and log warnings when operations fail. The code is structured to ensure compatibility with different checkpoint styles and provides detailed logging and error handling to facilitate debugging and maintenance.
# Imports and Dependencies

---
- `fd_wksp_private.h`
- `stdio.h`
- `errno.h`
- `unistd.h`
- `fcntl.h`


# Functions

---
### fd\_wksp\_private\_checkpt\_read<!-- {{#callable:fd_wksp_private_checkpt_read}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_io.c#L14>)

Reads up to `buf_max` bytes from a file at `path` into `buf` and returns the number of bytes read.
- **Inputs**:
    - `path`: A valid string representing the file path to read from.
    - `buf`: A valid pointer to a buffer where the read data will be stored.
    - `buf_max`: An unsigned long indicating the maximum number of bytes to read, assumed to be at least 12.
    - `_buf_sz`: A non-NULL pointer to an unsigned long where the function will store the number of bytes actually read.
- **Logic and Control Flow**:
    - Opens the file at the specified `path` in read-only mode.
    - Checks if the file descriptor `fd` is valid; if not, returns the error number `errno`.
    - Calls `fd_io_read` to read up to 12 bytes from the file into `buf`, with a maximum of `buf_max` bytes, and stores the number of bytes read in `_buf_sz`.
    - Attempts to close the file descriptor `fd` and logs a warning if the close operation fails.
    - Returns the result of the `fd_io_read` operation.
- **Output**: Returns 0 on success, with `_buf_sz` containing the number of bytes read; on failure, returns an error code compatible with `fd_io_strerror`, and `_buf_sz` remains unchanged.


---
### fd\_wksp\_preview<!-- {{#callable:fd_wksp_preview}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_io.c#L31>)

Reads and validates a workspace checkpoint header from a file, providing preview information if valid.
- **Inputs**:
    - `path`: A constant character pointer to the file path of the workspace checkpoint.
    - `_opt_preview`: A pointer to an `fd_wksp_preview_t` structure where the preview information will be stored; if NULL, a local stack variable is used.
- **Logic and Control Flow**:
    - Check if `path` is NULL; if so, return `FD_WKSP_ERR_INVAL`.
    - If `_opt_preview` is NULL, use a local stack variable `stack_preview` to store the preview information.
    - Call [`fd_wksp_private_checkpt_read`](<#fd_wksp_private_checkpt_read>) to read the checkpoint header from the file into a buffer `buf` of size 165 bytes.
    - If reading fails, return `FD_WKSP_ERR_FAIL`.
    - Cast the buffer to a `fd_wksp_checkpt_v2_hdr_t` pointer `v2` and check if it contains a valid V2 header.
    - If valid, copy the header information into `_opt_preview` and return `FD_WKSP_SUCCESS`.
    - If not valid, decode the buffer as a V1 header using `fd_ulong_svw_dec` to extract fields.
    - Check if the decoded V1 header is valid; if so, copy the information into `_opt_preview` and return `FD_WKSP_SUCCESS`.
    - If neither V1 nor V2 headers are valid, return `FD_WKSP_ERR_CORRUPT`.
- **Output**: Returns `FD_WKSP_SUCCESS` if a valid V1 or V2 header is found and preview information is stored; otherwise, returns an error code such as `FD_WKSP_ERR_INVAL`, `FD_WKSP_ERR_FAIL`, or `FD_WKSP_ERR_CORRUPT`.
- **Functions Called**:
    - [`fd_wksp_private_checkpt_read`](<#fd_wksp_private_checkpt_read>)
    - [`fd_wksp_footprint`](<fd_wksp_admin.c.md#fd_wksp_footprint>)


---
### fd\_wksp\_checkpt\_tpool<!-- {{#callable:fd_wksp_checkpt_tpool}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_io.c#L129>)

Performs a checkpoint operation on a workspace using a specified style and parameters.
- **Inputs**:
    - `tpool`: A pointer to a thread pool (`fd_tpool_t`) used for the operation.
    - `t0`: An unsigned long integer representing the start time or identifier for the operation.
    - `t1`: An unsigned long integer representing the end time or identifier for the operation.
    - `wksp`: A pointer to the workspace (`fd_wksp_t`) to be checkpointed.
    - `path`: A constant character pointer to the file path where the checkpoint will be saved.
    - `mode`: An unsigned long integer representing the file mode for the checkpoint file.
    - `style`: An integer indicating the style of the checkpoint operation, which can be V1, V2, or V3.
    - `uinfo`: A constant character pointer to user information, which can be an empty string if not provided.
- **Logic and Control Flow**:
    - Check if `wksp` is NULL; if so, log a warning and return `FD_WKSP_ERR_INVAL`.
    - Check if `path` is NULL; if so, log a warning and return `FD_WKSP_ERR_INVAL`.
    - Check if `mode` is valid by comparing it to its casted version; if invalid, log a warning and return `FD_WKSP_ERR_INVAL`.
    - Determine the `style` using `fd_int_if` based on the presence of LZ4 compression support.
    - Set `uinfo` to an empty string if it is NULL.
    - Set `binfo` to `fd_log_build_info` or an empty string if it is NULL.
    - Use a switch statement to perform the checkpoint operation based on the `style` value:
    - - For `FD_WKSP_CHECKPT_STYLE_V1`, call [`fd_wksp_private_checkpt_v1`](<fd_wksp_checkpt_v1.c.md#fd_wksp_private_checkpt_v1>).
    - - For `FD_WKSP_CHECKPT_STYLE_V2`, call [`fd_wksp_private_checkpt_v2`](<fd_wksp_checkpt_v2.c.md#fd_wksp_private_checkpt_v2>) with `FD_CHECKPT_FRAME_STYLE_RAW`.
    - - For `FD_WKSP_CHECKPT_STYLE_V3`, call [`fd_wksp_private_checkpt_v2`](<fd_wksp_checkpt_v2.c.md#fd_wksp_private_checkpt_v2>) with `FD_CHECKPT_FRAME_STYLE_LZ4`.
    - If the `style` is unsupported, log a warning and return `FD_WKSP_ERR_INVAL`.
- **Output**: Returns an integer status code indicating success or failure of the checkpoint operation.
- **Functions Called**:
    - [`fd_wksp_private_checkpt_v1`](<fd_wksp_checkpt_v1.c.md#fd_wksp_private_checkpt_v1>)
    - [`fd_wksp_private_checkpt_v2`](<fd_wksp_checkpt_v2.c.md#fd_wksp_private_checkpt_v2>)


---
### fd\_wksp\_restore\_tpool<!-- {{#callable:fd_wksp_restore_tpool}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_io.c#L178>)

Restores a workspace from a checkpoint file using the specified thread pool and version style.
- **Inputs**:
    - `tpool`: A pointer to the thread pool (`fd_tpool_t`) used for the restoration process.
    - `t0`: An unsigned long integer representing the start time or initial timestamp for the restoration.
    - `t1`: An unsigned long integer representing the end time or final timestamp for the restoration.
    - `wksp`: A pointer to the workspace (`fd_wksp_t`) to be restored.
    - `path`: A constant character pointer to the file path of the checkpoint to restore from.
    - `new_seed`: An unsigned integer representing a new seed value, which is arbitrary in this context.
- **Logic and Control Flow**:
    - Check if `wksp` is NULL; if so, log a warning and return `FD_WKSP_ERR_INVAL`.
    - Check if `path` is NULL; if so, log a warning and return `FD_WKSP_ERR_INVAL`.
    - Call [`fd_wksp_preview`](<#fd_wksp_preview>) to determine the version style of the checkpoint file at `path`.
    - If [`fd_wksp_preview`](<#fd_wksp_preview>) returns an error, log a warning and return the error code.
    - Use a switch statement to handle restoration based on the `style` field of the `preview` structure.
    - If the style is `FD_WKSP_CHECKPT_STYLE_V1`, call [`fd_wksp_private_restore_v1`](<fd_wksp_restore_v1.c.md#fd_wksp_private_restore_v1>) with the provided arguments and return its result.
    - If the style is `FD_WKSP_CHECKPT_STYLE_V2`, call [`fd_wksp_private_restore_v2`](<fd_wksp_restore_v2.c.md#fd_wksp_private_restore_v2>) with the provided arguments and return its result.
    - If the style is unsupported, log a warning and return `FD_WKSP_ERR_CORRUPT`.
- **Output**: Returns an integer status code indicating success or the type of error encountered during the restoration process.
- **Functions Called**:
    - [`fd_wksp_preview`](<#fd_wksp_preview>)
    - [`fd_wksp_private_restore_v1`](<fd_wksp_restore_v1.c.md#fd_wksp_private_restore_v1>)
    - [`fd_wksp_private_restore_v2`](<fd_wksp_restore_v2.c.md#fd_wksp_private_restore_v2>)


---
### fd\_wksp\_printf<!-- {{#callable:fd_wksp_printf}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_io.c#L222>)

Prints workspace checkpoint information to a file descriptor based on verbosity and style.
- **Inputs**:
    - `fd`: The file descriptor where the function writes the output.
    - `path`: The path to the workspace checkpoint file.
    - `verbose`: The verbosity level of the output; negative values result in no output.
- **Logic and Control Flow**:
    - Initialize `ret` to 0 to accumulate the number of bytes written.
    - Define a macro `TRAP` to handle errors and accumulate the return value from expressions.
    - If `verbose` is less than 0, return `ret` immediately.
    - Use `dprintf` to print the checkpoint header with the path and verbosity level.
    - Call [`fd_wksp_preview`](<#fd_wksp_preview>) to get the preview information of the workspace checkpoint.
    - If [`fd_wksp_preview`](<#fd_wksp_preview>) returns an error, print an error message with the error code and description.
    - If no error, print the style, name, seed, part_max, and data_max from the preview.
    - If `verbose` is less than 1, return `ret`.
    - Use a switch statement to handle different styles of the workspace checkpoint.
    - For `FD_WKSP_CHECKPT_STYLE_V1`, call [`fd_wksp_private_printf_v1`](<fd_wksp_restore_v1.c.md#fd_wksp_private_printf_v1>).
    - For `FD_WKSP_CHECKPT_STYLE_V2`, call [`fd_wksp_private_printf_v2`](<fd_wksp_restore_v2.c.md#fd_wksp_private_printf_v2>).
    - For unsupported styles, print an unsupported style message.
    - Return the accumulated `ret` value.
- **Output**: Returns the total number of bytes written to the file descriptor, or an error code if an error occurs.
- **Functions Called**:
    - [`fd_wksp_preview`](<#fd_wksp_preview>)
    - [`fd_wksp_strerror`](<fd_wksp_admin.c.md#fd_wksp_strerror>)
    - [`fd_wksp_private_printf_v1`](<fd_wksp_restore_v1.c.md#fd_wksp_private_printf_v1>)
    - [`fd_wksp_private_printf_v2`](<fd_wksp_restore_v2.c.md#fd_wksp_private_printf_v2>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)