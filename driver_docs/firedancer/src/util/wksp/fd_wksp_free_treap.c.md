<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for querying, inserting, and removing nodes in a free treap data structure.

# Purpose
The code defines functions for managing a data structure known as a "treap," which is a combination of a binary search tree and a heap. The functions are part of a private workspace management system, as indicated by the inclusion of the header file `fd_wksp_private.h`. The primary operations provided by this code are querying, inserting, and removing nodes from the treap. The function [`fd_wksp_private_free_treap_query`](<#fd_wksp_private_free_treap_query>) searches for a suitable partition in the treap that can accommodate a given size. The function [`fd_wksp_private_free_treap_insert`](<#fd_wksp_private_free_treap_insert>) inserts a new partition into the treap, maintaining the properties of both the binary search tree and the heap. The function [`fd_wksp_private_free_treap_remove`](<#fd_wksp_private_free_treap_remove>) removes a partition from the treap, ensuring that the structure remains valid.

The code uses several macros, such as `TEST`, `TEST_AND_MARK`, and `TEST_PARENT`, to perform validation checks and ensure the integrity of the treap during operations. These macros help detect and handle errors, such as invalid indices or cycles within the data structure. The code is designed to handle edge cases, such as inserting into an empty treap or removing nodes with no children, and it uses a cycle tag mechanism to mark visited nodes during operations. The functions are intended for internal use within a larger system, as suggested by the use of private data structures and the naming convention.
# Imports and Dependencies

---
- `fd_wksp_private.h`


# Functions

---
### fd\_wksp\_private\_free\_treap\_query<!-- {{#callable:fd_wksp_private_free_treap_query}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_free_treap.c#L3>)

Searches for a partition in a workspace treap that can accommodate a given size and returns its index.
- **Inputs**:
    - `sz`: The size of the partition to find.
    - `wksp`: A pointer to the workspace structure containing the treap.
    - `pinfo`: A pointer to an array of partition information structures.
- **Logic and Control Flow**:
    - Check if `sz` is zero; if so, return `FD_WKSP_PRIVATE_PINFO_IDX_NULL`.
    - Initialize `f` to `FD_WKSP_PRIVATE_PINFO_IDX_NULL` and retrieve `part_max` and `cycle_tag` from `wksp`.
    - Start with the index `i` from `wksp->part_free_cidx` and iterate while `i` is not null.
    - In each iteration, check if `i` is out of bounds or if a cycle is detected; if so, return `FD_WKSP_PRIVATE_PINFO_IDX_NULL`.
    - Mark the current index `i` as visited by setting its `cycle_tag`.
    - Retrieve the size of the current partition and decide whether to go left or right in the treap based on the comparison with `sz`.
    - If an exact match is found, break the loop; otherwise, update `f` to `i` and continue searching.
- **Output**: Returns the index of a suitable partition or `FD_WKSP_PRIVATE_PINFO_IDX_NULL` if no suitable partition is found.
- **Functions Called**:
    - [`fd_wksp_private_pinfo_idx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx>)
    - [`fd_wksp_private_pinfo_idx_is_null`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx_is_null>)
    - [`fd_wksp_private_pinfo_sz`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_sz>)


---
### fd\_wksp\_private\_free\_treap\_insert<!-- {{#callable:fd_wksp_private_free_treap_insert}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_free_treap.c#L45>)

Inserts a node into a free treap data structure, maintaining the heap property.
- **Inputs**:
    - `n`: The index of the node to insert into the treap.
    - `wksp`: A pointer to the workspace structure containing the treap.
    - `pinfo`: An array of private partition information structures, where each element corresponds to a node in the treap.
- **Logic and Control Flow**:
    - Check if `n` is less than `part_max` and mark the node with the current `cycle_tag`.
    - Calculate the size of the node to insert and ensure it is within valid address range.
    - If the treap is empty, set `n` as the root and return success.
    - Traverse the treap to find the correct leaf node for insertion, comparing node sizes to decide direction.
    - If a node with the same size is found, insert `n` into the 'same' list of that node.
    - If no node with the same size is found, insert `n` as a child of the appropriate node, potentially breaking the heap property.
    - Bubble `n` up the treap to restore the heap property, swapping nodes based on priority.
- **Output**: Returns `FD_WKSP_SUCCESS` on successful insertion.
- **Functions Called**:
    - [`fd_wksp_private_pinfo_idx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx>)
    - [`fd_wksp_private_pinfo_idx_is_null`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx_is_null>)
    - [`fd_wksp_private_pinfo_cidx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_cidx>)
    - [`fd_wksp_private_pinfo_sz`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_sz>)


---
### fd\_wksp\_private\_free\_treap\_remove<!-- {{#callable:fd_wksp_private_free_treap_remove}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_free_treap.c#L215>)

Removes a partition from a treap data structure, maintaining the heap property and updating necessary links.
- **Inputs**:
    - `d`: The index of the partition to remove.
    - `wksp`: A pointer to the workspace structure containing the treap.
    - `pinfo`: An array of partition information structures.
- **Logic and Control Flow**:
    - Check if `d` is within the valid range and mark it with the current cycle tag.
    - If `d` is part of a 'same' list, remove it by updating the parent and sibling links, then exit.
    - If `d` is not part of a 'same' list, load and validate its left, right, and parent indices.
    - Determine the location of the link from the parent to `d` or the root of the tree if `d` is the root.
    - If `d` has a non-empty 'same' list, replace `d` with the first partition in the 'same' list and swap heap priorities.
    - If `d` is the only partition of its size, fill the hole by promoting the left or right subtree based on heap priorities.
    - Continue promoting subtrees until the hole is filled, maintaining the heap property.
    - Clear the links of `d` to indicate it is no longer part of the treap.
- **Output**: Returns `FD_WKSP_SUCCESS` to indicate successful removal.
- **Functions Called**:
    - [`fd_wksp_private_pinfo_idx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx>)
    - [`fd_wksp_private_pinfo_idx_is_null`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx_is_null>)
    - [`fd_wksp_private_pinfo_cidx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_cidx>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)