<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for managing and manipulating a workspace, including locking, unlocking, and memory protection.

# Purpose
The code is a C source file that provides functionality for managing a workspace (`fd_wksp_t`) in shared memory. It includes functions for locking and unlocking the workspace, estimating maximum partition and data sizes, creating and deleting workspaces, and managing workspace metadata. The file defines public APIs for interacting with the workspace, such as [`fd_wksp_new`](<#fd_wksp_new>), [`fd_wksp_join`](<#fd_wksp_join>), [`fd_wksp_leave`](<#fd_wksp_leave>), and [`fd_wksp_delete`](<#fd_wksp_delete>), which handle the lifecycle of a workspace. It also includes utility functions like [`fd_wksp_strerror`](<#fd_wksp_strerror>) for error handling and [`fd_wksp_mprotect`](<#fd_wksp_mprotect>) for memory protection.

The code is structured to handle concurrent access to the workspace, with mechanisms for lock reclamation if a process holding a lock dies. It uses atomic operations and memory fences to ensure consistency and correctness in a multi-threaded environment. The file also includes functions for verifying and rebuilding the workspace's internal data structures, ensuring integrity and recovering from potential corruption. The workspace is organized into partitions, and the code manages these partitions using data structures like treaps for efficient access and modification.
# Imports and Dependencies

---
- `fd_wksp_private.h`
- `sys/mman.h`
- `errno.h`


# Functions

---
### fd\_wksp\_private\_lock<!-- {{#callable:fd_wksp_private_lock}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_admin.c#L5>)

Attempts to acquire a lock on a workspace, handling potential lock recovery if the previous owner process is dead.
- **Inputs**:
    - ``wksp``: A pointer to the `fd_wksp_t` structure representing the workspace to lock.
- **Logic and Control Flow**:
    - Initialize `me` with the current process's log group ID and `_owner` with the address of the workspace's owner field.
    - Enter an infinite loop to attempt acquiring the lock.
    - Use a compare-and-swap (CAS) operation to set the owner to `me` if it is `ULONG_MAX`, indicating the lock is free.
    - If the lock is successfully acquired, return `FD_WKSP_SUCCESS`.
    - If `FD_WKSP_LOCK_RECLAIM` is enabled, check the status of the current owner process ID (`pid`).
    - If the owner process is dead, attempt to recover the lock by setting the owner to `me` and verify or rebuild the workspace if necessary.
    - If the lock recovery is successful, return `FD_WKSP_SUCCESS`; otherwise, return `FD_WKSP_ERR_CORRUPT` if rebuilding fails.
    - If the owner process status is unknown, log a warning and retry acquiring the lock.
    - If `FD_WKSP_LOCK_RECLAIM` is not enabled, assume contention is due to another core and use spin locking.
    - Yield or pause execution to reduce contention and retry acquiring the lock.
- **Output**: Returns `FD_WKSP_SUCCESS` if the lock is acquired successfully, or `FD_WKSP_ERR_CORRUPT` if the workspace is found to be corrupt during recovery.
- **Functions Called**:
    - [`fd_wksp_verify`](<#fd_wksp_verify>)
    - [`fd_wksp_rebuild`](<#fd_wksp_rebuild>)


---
### fd\_wksp\_part\_max\_est<!-- {{#callable:fd_wksp_part_max_est}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_admin.c#L101>)

Estimates the maximum number of partitions that can fit in a workspace given its footprint and a typical partition size.
- **Inputs**:
    - `footprint`: The total size of the workspace in bytes, which is aligned down to the nearest multiple of `FD_WKSP_ALIGN`.
    - `sz_typical`: The typical size of a partition in bytes.
- **Logic and Control Flow**:
    - Align `footprint` down to the nearest multiple of `FD_WKSP_ALIGN` using `fd_ulong_align_dn`.
    - Calculate `data_end` as `footprint - 1UL`.
    - Retrieve `pinfo_off` using `fd_wksp_private_pinfo_off()`.
    - Calculate `consumed` as the sum of `sizeof(fd_wksp_private_pinfo_t)` and `sz_typical`.
    - Compute `part_max` as `(data_end - pinfo_off) / (consumed + (ulong)!consumed)` to avoid division by zero.
    - Check if any of the following conditions are true: `footprint` is zero, `sz_typical` is zero, `sz_typical` is greater than `consumed`, or `pinfo_off` is greater than `data_end`. If any condition is true, return `0UL`.
    - Return the minimum of `part_max` and `FD_WKSP_PRIVATE_PINFO_IDX_NULL` using `fd_ulong_min`.
- **Output**: Returns the estimated maximum number of partitions that can fit in the workspace, or `0UL` if the input conditions are invalid.
- **Functions Called**:
    - [`fd_wksp_private_pinfo_off`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_off>)


---
### fd\_wksp\_data\_max\_est<!-- {{#callable:fd_wksp_data_max_est}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_admin.c#L113>)

Estimates the maximum data size that can be accommodated in a workspace given its footprint and partition maximum.
- **Inputs**:
    - `footprint`: The total size of the workspace, aligned to `FD_WKSP_ALIGN`.
    - `part_max`: The maximum number of partitions allowed in the workspace.
- **Logic and Control Flow**:
    - Align `footprint` down to the nearest multiple of `FD_WKSP_ALIGN` using `fd_ulong_align_dn`.
    - Calculate `data_end` as `footprint - 1UL`.
    - Calculate `data_off` using `fd_wksp_private_data_off(part_max)`.
    - Check if any of the following conditions are true: `part_max` is zero, `part_max` exceeds `FD_WKSP_PRIVATE_PINFO_IDX_NULL`, `part_max` exceeds the maximum allowable partitions based on `ULONG_MAX`, `footprint` is zero, or `data_off` is greater than or equal to `data_end`.
    - If any condition is true, return `0UL`.
    - Otherwise, return the difference between `data_end` and `data_off`.
- **Output**: Returns the estimated maximum data size as an unsigned long integer, or `0UL` if the input conditions are invalid.
- **Functions Called**:
    - [`fd_wksp_private_data_off`](<fd_wksp_private.h.md#fd_wksp_private_data_off>)
    - [`fd_wksp_private_pinfo_off`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_off>)


---
### fd\_wksp\_align<!-- {{#callable:fd_wksp_align}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_admin.c#L125>)

Returns the alignment value used in the workspace.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the constant `FD_WKSP_ALIGN`.
- **Output**: The function returns an `ulong` representing the alignment value `FD_WKSP_ALIGN`.


---
### fd\_wksp\_footprint<!-- {{#callable:fd_wksp_footprint}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_admin.c#L130>)

Calculates the aligned memory footprint required for a workspace given the maximum number of partitions and data size.
- **Inputs**:
    - `part_max`: The maximum number of partitions that the workspace can have.
    - `data_max`: The maximum size of the data that the workspace can hold.
- **Logic and Control Flow**:
    - Calculate `data_off` using `fd_wksp_private_data_off(part_max)` to determine the offset for data storage.
    - Check if any of the following conditions are true: `part_max` is zero, `part_max` exceeds `FD_WKSP_PRIVATE_PINFO_IDX_NULL`, `data_max` is zero, `part_max` exceeds the maximum allowable partitions based on system limits, or `data_max` exceeds the maximum allowable data size based on system limits and `data_off`.
    - If any condition is true, return 0, indicating an invalid configuration.
    - If all conditions are false, calculate the aligned memory footprint using `fd_ulong_align_up(data_off + data_max + 1UL, FD_WKSP_ALIGN)` and return it.
- **Output**: Returns the aligned memory footprint as an unsigned long integer, or 0 if the input parameters are invalid.
- **Functions Called**:
    - [`fd_wksp_private_data_off`](<fd_wksp_private.h.md#fd_wksp_private_data_off>)
    - [`fd_wksp_private_pinfo_off`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_off>)


---
### fd\_wksp\_new<!-- {{#callable:fd_wksp_new}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_admin.c#L140>)

Initializes a new workspace in shared memory with specified parameters and returns a pointer to it.
- **Inputs**:
    - `shmem`: A pointer to the shared memory region where the workspace will be initialized.
    - `name`: A constant character pointer representing the name of the workspace.
    - `seed`: An unsigned integer used for initializing the workspace's random seed.
    - `part_max`: An unsigned long representing the maximum number of partitions in the workspace.
    - `data_max`: An unsigned long representing the maximum data size in the workspace.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL; if so, log a warning and return NULL.
    - Check if `shmem` is properly aligned; if not, log a warning and return NULL.
    - Calculate the length of `name` and check if it is valid; if not, log a warning and return NULL.
    - Calculate the workspace footprint using `part_max` and `data_max`; if invalid, log a warning and return NULL.
    - Clear the memory for the workspace using `fd_memset`.
    - Initialize various fields of the workspace structure, including `part_max`, `data_max`, `gaddr_lo`, `gaddr_hi`, `name`, `seed`, and several index fields.
    - Set the `magic` field to `FD_WKSP_MAGIC` to indicate the workspace is initialized.
    - Call [`fd_wksp_rebuild`](<#fd_wksp_rebuild>) to finalize the workspace setup; if it fails, log a warning, reset `magic`, and return NULL.
    - If `FD_HAS_DEEPASAN` is defined, poison the workspace memory except for the header and pinfo array.
    - Unlock the workspace using [`fd_wksp_private_unlock`](<fd_wksp_private.h.md#fd_wksp_private_unlock>).
- **Output**: Returns a pointer to the initialized `fd_wksp_t` structure, or NULL if initialization fails.
- **Functions Called**:
    - [`fd_wksp_footprint`](<#fd_wksp_footprint>)
    - [`fd_wksp_private_data_off`](<fd_wksp_private.h.md#fd_wksp_private_data_off>)
    - [`fd_wksp_private_pinfo_cidx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_cidx>)
    - [`fd_wksp_rebuild`](<#fd_wksp_rebuild>)
    - [`fd_wksp_strerror`](<#fd_wksp_strerror>)
    - [`fd_wksp_private_pinfo_off`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_off>)
    - [`fd_wksp_private_pinfo`](<fd_wksp_private.h.md#fd_wksp_private_pinfo>)
    - [`fd_wksp_private_unlock`](<fd_wksp_private.h.md#fd_wksp_private_unlock>)


---
### fd\_wksp\_join<!-- {{#callable:fd_wksp_join}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_admin.c#L222>)

Validates and returns a pointer to a workspace if it is correctly aligned and has the correct magic number.
- **Inputs**:
    - `shwksp`: A pointer to a shared workspace, expected to be of type `void *`.
- **Logic and Control Flow**:
    - Cast `shwksp` to a `fd_wksp_t *` and assign it to `wksp`.
    - Check if `wksp` is `NULL`; if true, log a warning and return `NULL`.
    - Check if `wksp` is not aligned to `FD_WKSP_ALIGN`; if true, log a warning and return `NULL`.
    - Check if `wksp->magic` is not equal to `FD_WKSP_MAGIC`; if true, log a warning and return `NULL`.
    - Return `wksp` if all checks pass.
- **Output**: Returns a pointer to `fd_wksp_t` if the input is valid; otherwise, returns `NULL`.


---
### fd\_wksp\_leave<!-- {{#callable:fd_wksp_leave}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_admin.c#L244>)

Returns the workspace pointer if it is not NULL, otherwise logs a warning and returns NULL.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` structure representing the workspace to leave.
- **Logic and Control Flow**:
    - Check if the `wksp` pointer is NULL using `FD_UNLIKELY` macro.
    - If `wksp` is NULL, log a warning message 'NULL wksp' and return NULL.
    - If `wksp` is not NULL, cast it to a `void *` and return it.
- **Output**: A `void *` pointer to the workspace if `wksp` is not NULL, otherwise NULL.


---
### fd\_wksp\_delete<!-- {{#callable:fd_wksp_delete}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_admin.c#L254>)

Deletes a workspace by validating its alignment and magic number, then clearing its magic number and optionally unpoisoning its memory region.
- **Inputs**:
    - `shwksp`: A pointer to the shared workspace to delete.
- **Logic and Control Flow**:
    - Cast `shwksp` to a `fd_wksp_t` pointer named `wksp`.
    - Check if `wksp` is NULL; if so, log a warning and return NULL.
    - Check if `wksp` is aligned to `FD_WKSP_ALIGN`; if not, log a warning and return NULL.
    - Check if `wksp->magic` equals `FD_WKSP_MAGIC`; if not, log a warning and return NULL.
    - Use memory fences to ensure memory operations are completed before and after setting `wksp->magic` to 0.
    - If `FD_HAS_DEEPASAN` is defined, calculate the footprint of the workspace and unpoison the memory region from `wksp_data` to the end of the footprint.
    - Return the `wksp` pointer.
- **Output**: Returns a pointer to the deleted workspace, or NULL if any validation checks fail.
- **Functions Called**:
    - [`fd_wksp_footprint`](<#fd_wksp_footprint>)
    - [`fd_wksp_private_pinfo_off`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_off>)


---
### fd\_wksp\_name<!-- {{#callable:fd_wksp_name}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_admin.c#L289>)

Retrieves the name of the workspace from the given workspace structure.
- **Inputs**:
    - `wksp`: A pointer to a constant `fd_wksp_t` structure representing the workspace.
- **Logic and Control Flow**:
    - Accesses the `name` field of the `wksp` structure.
    - Returns the value of the `name` field.
- **Output**: A constant character pointer to the name of the workspace.


---
### fd\_wksp\_seed<!-- {{#callable:fd_wksp_seed}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_admin.c#L290>)

Returns the seed value from the given workspace structure.
- **Inputs**:
    - `wksp`: A pointer to a constant `fd_wksp_t` structure from which the seed value is retrieved.
- **Logic and Control Flow**:
    - Accesses the `seed` member of the `wksp` structure.
    - Returns the value of the `seed` member.
- **Output**: The function returns a `uint` representing the seed value of the workspace.


---
### fd\_wksp\_part\_max<!-- {{#callable:fd_wksp_part_max}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_admin.c#L291>)

Retrieves the maximum number of partitions allowed in a given workspace.
- **Inputs**:
    - `wksp`: A pointer to a constant `fd_wksp_t` structure representing the workspace.
- **Logic and Control Flow**:
    - Accesses the `part_max` member of the `wksp` structure.
    - Returns the value of `part_max`.
- **Output**: The function returns an unsigned long integer representing the maximum number of partitions allowed in the workspace.


---
### fd\_wksp\_data\_max<!-- {{#callable:fd_wksp_data_max}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_admin.c#L292>)

Retrieves the maximum data size from a workspace structure.
- **Inputs**:
    - `wksp`: A pointer to a constant `fd_wksp_t` structure representing the workspace.
- **Logic and Control Flow**:
    - Accesses the `data_max` field of the `wksp` structure.
    - Returns the value of the `data_max` field.
- **Output**: Returns an unsigned long integer representing the maximum data size of the workspace.


---
### fd\_wksp\_owner<!-- {{#callable:fd_wksp_owner}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_admin.c#L294>)

Retrieves the owner of a workspace in a thread-safe manner.
- **Inputs**:
    - `wksp`: A pointer to a constant `fd_wksp_t` structure representing the workspace.
- **Logic and Control Flow**:
    - Executes a memory fence to ensure memory operations are completed before accessing the owner.
    - Reads the `owner` field from the `wksp` structure using a volatile read to prevent compiler optimizations that could reorder operations.
    - Executes another memory fence to ensure the read operation is completed before any subsequent operations.
- **Output**: Returns the `owner` field of the workspace as an unsigned long integer.


---
### fd\_wksp\_strerror<!-- {{#callable:fd_wksp_strerror}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_admin.c#L302>)

Maps error codes to their corresponding error message strings.
- **Inputs**:
    - `err`: An integer representing the error code to be translated into a string message.
- **Logic and Control Flow**:
    - Use a switch statement to check the value of `err`.
    - If `err` is `FD_WKSP_SUCCESS`, return the string "success".
    - If `err` is `FD_WKSP_ERR_INVAL`, return the string "inval".
    - If `err` is `FD_WKSP_ERR_FAIL`, return the string "fail".
    - If `err` is `FD_WKSP_ERR_CORRUPT`, return the string "corrupt".
    - If `err` does not match any known error codes, return the string "unknown".
- **Output**: A constant character pointer to the error message string corresponding to the input error code.


---
### fd\_wksp\_verify<!-- {{#callable:fd_wksp_verify}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_admin.c#L314>)

Validates the integrity of a workspace by checking metadata, partitioning, and treap structures.
- **Inputs**:
    - `wksp`: A pointer to the `fd_wksp_t` structure representing the workspace to verify.
- **Logic and Control Flow**:
    - Define a macro `TEST` to log a warning and return `FD_WKSP_ERR_CORRUPT` if a condition is false.
    - Validate the workspace metadata, including `magic`, `part_max`, `data_max`, `gaddr_lo`, `gaddr_hi`, and `name`.
    - Ensure `cycle_tag` is at least 4.
    - Clear cycle tags for all partitions.
    - Verify the idle stack by traversing it and marking visited partitions.
    - Verify partitioning by traversing partitions, checking adjacency, and marking visited partitions.
    - Validate the used treap by traversing it, ensuring heap properties, and marking visited partitions.
    - Validate the free treap by traversing it, ensuring heap properties, and marking visited partitions.
    - Return `FD_WKSP_SUCCESS` if all checks pass.
- **Output**: Returns `FD_WKSP_SUCCESS` if the workspace is valid, otherwise returns `FD_WKSP_ERR_CORRUPT` if any validation fails.
- **Functions Called**:
    - [`fd_wksp_footprint`](<#fd_wksp_footprint>)
    - [`fd_wksp_private_data_off`](<fd_wksp_private.h.md#fd_wksp_private_data_off>)
    - [`fd_wksp_private_pinfo`](<fd_wksp_private.h.md#fd_wksp_private_pinfo>)
    - [`fd_wksp_private_pinfo_idx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx>)
    - [`fd_wksp_private_pinfo_idx_is_null`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx_is_null>)
    - [`fd_wksp_private_pinfo_cidx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_cidx>)
    - [`fd_wksp_private_pinfo_sz`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_sz>)


---
### fd\_wksp\_rebuild<!-- {{#callable:fd_wksp_rebuild}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_admin.c#L581>)

Rebuilds the workspace by validating metadata, organizing partitions into used and idle structures, and ensuring data integrity.
- **Inputs**:
    - ``wksp``: A pointer to the `fd_wksp_t` structure representing the workspace to rebuild.
    - ``seed``: A seed value used for randomizing heap priorities during the rebuild process.
- **Logic and Control Flow**:
    - Check if `wksp` is NULL; if so, log a warning and return `FD_WKSP_ERR_CORRUPT`.
    - Load metadata from `wksp` and calculate expected values for `gaddr_lo` and `gaddr_hi`.
    - Verify metadata integrity; if any checks fail, log a warning and return `FD_WKSP_ERR_CORRUPT`.
    - Initialize the workspace's seed and reset indices for idle, used, and free structures.
    - Iterate over partitions in reverse order, assigning heap priorities and organizing them into idle or used structures based on their tags.
    - If a partition is used, attempt to insert it into the used treap; if insertion fails, return `FD_WKSP_ERR_CORRUPT`.
    - Traverse the used treap in order to rebuild the partitioning and free treap, filling gaps with idle partitions as needed.
    - If any gaps cannot be filled due to insufficient idle partitions, log a warning and return `FD_WKSP_ERR_CORRUPT`.
    - Set the tail index of the partition list to the last added partition.
- **Output**: Returns `FD_WKSP_SUCCESS` if the rebuild is successful, or `FD_WKSP_ERR_CORRUPT` if any errors are encountered during the process.
- **Functions Called**:
    - [`fd_wksp_footprint`](<#fd_wksp_footprint>)
    - [`fd_wksp_private_data_off`](<fd_wksp_private.h.md#fd_wksp_private_data_off>)
    - [`fd_wksp_private_pinfo`](<fd_wksp_private.h.md#fd_wksp_private_pinfo>)
    - [`fd_wksp_private_pinfo_cidx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_cidx>)
    - [`fd_wksp_private_idle_stack_push`](<fd_wksp_private.h.md#fd_wksp_private_idle_stack_push>)
    - [`fd_wksp_private_used_treap_insert`](<fd_wksp_used_treap.c.md#fd_wksp_private_used_treap_insert>)
    - [`fd_wksp_private_pinfo_idx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx>)
    - [`fd_wksp_private_pinfo_idx_is_null`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx_is_null>)
    - [`fd_wksp_private_idle_stack_is_empty`](<fd_wksp_private.h.md#fd_wksp_private_idle_stack_is_empty>)
    - [`fd_wksp_private_idle_stack_pop`](<fd_wksp_private.h.md#fd_wksp_private_idle_stack_pop>)
    - [`fd_wksp_private_free_treap_insert`](<fd_wksp_free_treap.c.md#fd_wksp_private_free_treap_insert>)


---
### fd\_wksp\_mprotect<!-- {{#callable:fd_wksp_mprotect}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_admin.c#L789>)

Changes the memory protection of a workspace based on the provided flag.
- **Inputs**:
    - ``wksp``: A pointer to the `fd_wksp_t` workspace structure to modify.
    - ``flag``: An integer flag that determines the protection level; if non-zero, set to read-only, otherwise set to read-write.
- **Logic and Control Flow**:
    - Check if `wksp` is NULL and log a warning if true, then return.
    - Check if `wksp` is aligned according to `FD_WKSP_ALIGN` and log a warning if not, then return.
    - Check if `wksp->magic` matches `FD_WKSP_MAGIC` and log a warning if not, then return.
    - Calculate the workspace footprint using [`fd_wksp_footprint`](<#fd_wksp_footprint>).
    - Call `mprotect` to set the memory protection of the workspace to read-only if `flag` is non-zero, or to read-write if `flag` is zero.
    - Log a warning if `mprotect` fails, including the error number and description, then return.
- **Output**: No output is returned; the function modifies the memory protection of the workspace in place.
- **Functions Called**:
    - [`fd_wksp_footprint`](<#fd_wksp_footprint>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)