<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for managing workspace partitions, including splitting, merging, allocating, and freeing memory.

# Purpose
The code is a C source file that provides functionality for managing partitions within a workspace. It includes private functions for splitting and merging partitions, as well as public APIs for allocating, freeing, and querying memory within the workspace. The private functions, such as [`fd_wksp_private_split_before`](<#fd_wksp_private_split_before>), [`fd_wksp_private_split_after`](<#fd_wksp_private_split_after>), [`fd_wksp_private_merge_before`](<#fd_wksp_private_merge_before>), and [`fd_wksp_private_merge_after`](<#fd_wksp_private_merge_after>), handle the internal logic of partition management, ensuring that partitions are correctly split or merged without leaving the workspace in an inconsistent state. These functions operate on a data structure that represents the workspace and its partitions, using indices to manage the relationships between partitions.

The public APIs, such as [`fd_wksp_alloc_at_least`](<#fd_wksp_alloc_at_least>), [`fd_wksp_free`](<#fd_wksp_free>), [`fd_wksp_tag`](<#fd_wksp_tag>), and [`fd_wksp_usage`](<#fd_wksp_usage>), provide an interface for users to interact with the workspace. These functions allow users to allocate memory with specific alignment and size requirements, free allocated memory, query the tag associated with a memory address, and gather usage statistics about the workspace. The code ensures that operations are performed safely by using locks and checks for data corruption, logging warnings if inconsistencies are detected. The file is intended to be part of a larger system where memory management within a workspace is required, and it provides both low-level partition management and higher-level memory allocation interfaces.
# Imports and Dependencies

---
- `fd_wksp_private.h`


# Functions

---
### fd\_wksp\_private\_split\_before<!-- {{#callable:fd_wksp_private_split_before}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_user.c#L25>)

Splits a partition into two smaller partitions, placing the new partition before the original one.
- **Inputs**:
    - `i2`: Index of the original partition to split, in the range [0, part_max).
    - `s2`: Size of the new partition, must be in the range (0, size of i2).
    - `wksp`: Pointer to the current workspace structure.
    - `pinfo`: Pointer to the private partition information array associated with the workspace.
- **Logic and Control Flow**:
    - Calculate the new end address `g2` for the new partition by subtracting `s2` from the old end address `g3` of the original partition.
    - Determine the start address `g1` for the new partition from the original partition's start address.
    - Retrieve the index `i0` of the partition before the original partition and pop an index `i1` from the idle stack for the new partition.
    - Initialize the new partition at index `i1` with calculated addresses, zero tag, and null child and parent indices.
    - Update the original partition at index `i2` to start at the new end address `g2` and set its previous index to `i1`.
    - If `i0` is null, set the workspace's head index to `i1`; otherwise, update the next index of the partition at `i0` to `i1`.
    - Return the index `i1` of the newly created partition.
- **Output**: Returns the index of the newly created partition, which is placed before the original partition.
- **Functions Called**:
    - [`fd_wksp_private_pinfo_idx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx>)
    - [`fd_wksp_private_idle_stack_pop`](<fd_wksp_private.h.md#fd_wksp_private_idle_stack_pop>)
    - [`fd_wksp_private_pinfo_cidx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_cidx>)
    - [`fd_wksp_private_pinfo_idx_is_null`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx_is_null>)


---
### fd\_wksp\_private\_split\_after<!-- {{#callable:fd_wksp_private_split_after}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_user.c#L58>)

Splits a partition into two, creating a new partition immediately after the original one.
- **Inputs**:
    - `i1`: Index of the original partition to split, in the range [0, part_max).
    - `s1`: Size of the new partition to create, must be in the range (0, size of i2).
    - `wksp`: Pointer to the current local join workspace.
    - `pinfo`: Pointer to the private partition information array, equivalent to `fd_wksp_private_pinfo(wksp)`.
- **Logic and Control Flow**:
    - Calculate the starting and ending global addresses for the new partition (`g2` and `g3`).
    - Pop an index from the idle stack to use for the new partition (`i2`).
    - Retrieve the index of the partition following the original partition (`i3`).
    - Initialize the new partition's metadata, including global address range, tag, and tree indices.
    - Update the original partition's ending global address and next partition index to reflect the split.
    - If the original partition was the last in the list, update the workspace's tail index; otherwise, update the previous index of the partition following the original.
- **Output**: Returns the index of the newly created partition, `i2`, which is in the range [0, part_max).
- **Functions Called**:
    - [`fd_wksp_private_idle_stack_pop`](<fd_wksp_private.h.md#fd_wksp_private_idle_stack_pop>)
    - [`fd_wksp_private_pinfo_idx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx>)
    - [`fd_wksp_private_pinfo_cidx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_cidx>)
    - [`fd_wksp_private_pinfo_idx_is_null`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx_is_null>)


---
### fd\_wksp\_private\_merge\_before<!-- {{#callable:fd_wksp_private_merge_before}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_user.c#L102>)

Merges two adjacent partitions in a workspace by combining the partition at index `i1` with the partition at index `i2`, and updates the workspace's partition information accordingly.
- **Inputs**:
    - `i1`: Index of the partition immediately preceding `i2`, which will be merged into `i2`.
    - `i2`: Index of the partition that will absorb the partition at `i1`.
    - `wksp`: Pointer to the current workspace structure.
    - `pinfo`: Pointer to the partition information array associated with the workspace.
- **Logic and Control Flow**:
    - Retrieve the index `i0` of the partition preceding `i1` using [`fd_wksp_private_pinfo_idx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx>) and `pinfo[i1].prev_cidx`.
    - Set the starting address (`gaddr_lo`) of `i2` to the starting address of `i1`.
    - Update the previous partition index (`prev_cidx`) of `i2` to `i0` using [`fd_wksp_private_pinfo_cidx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_cidx>).
    - If `i0` is null, update the workspace's head partition index (`part_head_cidx`) to `i2`; otherwise, set the next partition index (`next_cidx`) of `i0` to `i2`.
    - Push `i1` onto the idle stack using [`fd_wksp_private_idle_stack_push`](<fd_wksp_private.h.md#fd_wksp_private_idle_stack_push>).
- **Output**: No return value; the function modifies the workspace and partition information in place.
- **Functions Called**:
    - [`fd_wksp_private_pinfo_idx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx>)
    - [`fd_wksp_private_pinfo_cidx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_cidx>)
    - [`fd_wksp_private_pinfo_idx_is_null`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx_is_null>)
    - [`fd_wksp_private_idle_stack_push`](<fd_wksp_private.h.md#fd_wksp_private_idle_stack_push>)


---
### fd\_wksp\_private\_merge\_after<!-- {{#callable:fd_wksp_private_merge_after}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_user.c#L119>)

Merges two adjacent partitions in a workspace, updating partition information and pushing the second partition index onto the idle stack.
- **Inputs**:
    - `i1`: Index of the first partition in the range [0, part_max).
    - `i2`: Index of the second partition, adjacent to i1, in the range [0, part_max).
    - `wksp`: Pointer to the current local join of the workspace.
    - `pinfo`: Pointer to the private partition information array for the workspace.
- **Logic and Control Flow**:
    - Retrieve the index of the partition following `i2` using [`fd_wksp_private_pinfo_idx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx>) on `pinfo[i2].next_cidx`.
    - Update `pinfo[i1].gaddr_hi` to `pinfo[i2].gaddr_hi` to extend the first partition to include the second.
    - Set `pinfo[i1].next_cidx` to the index of the partition after `i2` using [`fd_wksp_private_pinfo_cidx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_cidx>).
    - If there is no partition after `i2`, update `wksp->part_tail_cidx` to the index of `i1`. Otherwise, update `pinfo[i3].prev_cidx` to the index of `i1`.
    - Push the index `i2` onto the idle stack using [`fd_wksp_private_idle_stack_push`](<fd_wksp_private.h.md#fd_wksp_private_idle_stack_push>).
- **Output**: No return value; the function modifies the workspace and partition information in place.
- **Functions Called**:
    - [`fd_wksp_private_pinfo_idx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx>)
    - [`fd_wksp_private_pinfo_cidx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_cidx>)
    - [`fd_wksp_private_pinfo_idx_is_null`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx_is_null>)
    - [`fd_wksp_private_idle_stack_push`](<fd_wksp_private.h.md#fd_wksp_private_idle_stack_push>)


---
### fd\_wksp\_private\_free<!-- {{#callable:fd_wksp_private_free}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_user.c#L136>)

Frees a specified partition in a workspace and updates related data structures.
- **Inputs**:
    - `i`: Index of the partition to free, must be in the range [0, part_max).
    - `wksp`: Pointer to the current local join of the workspace.
    - `pinfo`: Pointer to the private partition information of the workspace, equivalent to `fd_wksp_private_pinfo(wksp)`.
- **Logic and Control Flow**:
    - Set the tag of the partition at index `i` to 0, indicating it is free.
    - Remove the partition from the used treap structure; log a warning if this fails due to corruption.
    - Check the previous partition; if it is free, remove it from the free treap and merge it with the current partition.
    - Check the next partition; if it is free, remove it from the free treap and merge it with the current partition.
    - Insert the current partition into the free treap; log a warning if this fails due to corruption.
    - If `FD_HAS_DEEPASAN` is defined, poison the data region of the freed allocation to detect invalid memory accesses.
- **Output**: No return value; the function modifies the workspace and partition information in place.
- **Functions Called**:
    - [`fd_wksp_private_used_treap_remove`](<fd_wksp_used_treap.c.md#fd_wksp_private_used_treap_remove>)
    - [`fd_wksp_private_pinfo_idx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx>)
    - [`fd_wksp_private_free_treap_remove`](<fd_wksp_free_treap.c.md#fd_wksp_private_free_treap_remove>)
    - [`fd_wksp_private_merge_before`](<#fd_wksp_private_merge_before>)
    - [`fd_wksp_private_merge_after`](<#fd_wksp_private_merge_after>)
    - [`fd_wksp_private_free_treap_insert`](<fd_wksp_free_treap.c.md#fd_wksp_private_free_treap_insert>)
    - [`fd_wksp_laddr_fast`](<fd_wksp.h.md#fd_wksp_laddr_fast>)


---
### fd\_wksp\_laddr<!-- {{#callable:fd_wksp_laddr}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_user.c#L189>)

Maps a global address to a local address within a workspace.
- **Inputs**:
    - `wksp`: A pointer to a constant `fd_wksp_t` structure representing the workspace.
    - `gaddr`: An unsigned long integer representing the global address to map.
- **Logic and Control Flow**:
    - Check if `wksp` is NULL; if so, log a warning and return NULL.
    - Check if `gaddr` is zero; if so, return NULL.
    - Verify that `gaddr` is within the range defined by `wksp->gaddr_lo` and `wksp->gaddr_hi`; if not, log a warning and return NULL.
    - Call [`fd_wksp_laddr_fast`](<fd_wksp.h.md#fd_wksp_laddr_fast>) with `wksp` and `gaddr` to perform the address mapping and return the result.
- **Output**: Returns a pointer to the local address corresponding to the given global address, or NULL if the input is invalid or out of range.
- **Functions Called**:
    - [`fd_wksp_laddr_fast`](<fd_wksp.h.md#fd_wksp_laddr_fast>)


---
### fd\_wksp\_gaddr<!-- {{#callable:fd_wksp_gaddr}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_user.c#L206>)

Converts a local address to a global address within a workspace, ensuring the address is valid.
- **Inputs**:
    - ``wksp``: A pointer to a constant `fd_wksp_t` structure representing the workspace.
    - ``laddr``: A constant pointer to the local address to be converted to a global address.
- **Logic and Control Flow**:
    - Check if `wksp` is NULL; if so, log a warning and return 0UL.
    - Check if `laddr` is NULL; if so, return 0UL, as NULL maps to "NULL".
    - Call [`fd_wksp_gaddr_fast`](<fd_wksp.h.md#fd_wksp_gaddr_fast>) to convert `laddr` to a global address `gaddr`.
    - Check if `gaddr` is within the valid range defined by `wksp->gaddr_lo` and `wksp->gaddr_hi`; if not, log a warning and return 0UL.
    - Return the valid `gaddr`.
- **Output**: Returns the global address as an unsigned long integer if valid, otherwise returns 0UL.
- **Functions Called**:
    - [`fd_wksp_gaddr_fast`](<fd_wksp.h.md#fd_wksp_gaddr_fast>)


---
### fd\_wksp\_alloc\_at\_least<!-- {{#callable:fd_wksp_alloc_at_least}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_user.c#L222>)

Allocates a memory partition in a workspace with specified alignment and size, returning the aligned start address.
- **Inputs**:
    - `wksp`: Pointer to the workspace where memory is allocated.
    - `align`: Desired alignment for the memory allocation; defaults to `FD_WKSP_ALIGN_DEFAULT` if zero.
    - `sz`: Size of the memory to allocate.
    - `tag`: Tag to assign to the allocated memory partition.
    - `_lo`: Pointer to store the lower bound of the allocated memory range.
    - `_hi`: Pointer to store the upper bound of the allocated memory range.
- **Logic and Control Flow**:
    - Set `align` to `FD_WKSP_ALIGN_DEFAULT` if it is zero.
    - Calculate `footprint` as `sz + align - 1UL`.
    - Check for invalid inputs: zero size, null workspace, non-power-of-two alignment, or zero tag, and log warnings if any are invalid.
    - Adjust alignment and size for ASan if `FD_HAS_DEEPASAN` is defined.
    - Check for size overflow in `footprint` and log a warning if it occurs.
    - Lock the workspace for allocation operations.
    - Query the free treap for a suitable partition to allocate.
    - If no suitable partition is found, log a warning and fail.
    - Remove the partition from the free treap and prepare it for allocation.
    - Align the start address and calculate the end address of the allocation.
    - Check if there are enough idle partitions to complete the allocation; if not, log a warning and fail.
    - Split the partition if necessary to fit the requested size and alignment.
    - Insert the partition into the used treap and update its tag to make the allocation official.
    - Unlock the workspace and store the allocated range in `_lo` and `_hi`.
    - Return the aligned start address of the allocated memory.
- **Output**: Returns the aligned start address of the allocated memory, or 0UL on failure.
- **Functions Called**:
    - [`fd_wksp_private_pinfo`](<fd_wksp_private.h.md#fd_wksp_private_pinfo>)
    - [`fd_wksp_private_lock`](<fd_wksp_admin.c.md#fd_wksp_private_lock>)
    - [`fd_wksp_private_free_treap_query`](<fd_wksp_free_treap.c.md#fd_wksp_private_free_treap_query>)
    - [`fd_wksp_private_pinfo_idx_is_null`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx_is_null>)
    - [`fd_wksp_private_unlock`](<fd_wksp_private.h.md#fd_wksp_private_unlock>)
    - [`fd_wksp_private_free_treap_same_is_empty`](<fd_wksp_private.h.md#fd_wksp_private_free_treap_same_is_empty>)
    - [`fd_wksp_private_free_treap_same_remove`](<fd_wksp_private.h.md#fd_wksp_private_free_treap_same_remove>)
    - [`fd_wksp_private_free_treap_remove`](<fd_wksp_free_treap.c.md#fd_wksp_private_free_treap_remove>)
    - [`fd_wksp_private_pinfo_idx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx>)
    - [`fd_wksp_private_free_treap_insert`](<fd_wksp_free_treap.c.md#fd_wksp_private_free_treap_insert>)
    - [`fd_wksp_private_split_before`](<#fd_wksp_private_split_before>)
    - [`fd_wksp_private_split_after`](<#fd_wksp_private_split_after>)
    - [`fd_wksp_private_used_treap_insert`](<fd_wksp_used_treap.c.md#fd_wksp_private_used_treap_insert>)
    - [`fd_wksp_laddr_fast`](<fd_wksp.h.md#fd_wksp_laddr_fast>)


---
### fd\_wksp\_free<!-- {{#callable:fd_wksp_free}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_user.c#L364>)

Releases a previously allocated partition in a workspace based on a global address.
- **Inputs**:
    - `wksp`: A pointer to the `fd_wksp_t` workspace structure.
    - `gaddr`: The global address of the partition to free.
- **Logic and Control Flow**:
    - Check if `gaddr` is zero; if so, return immediately.
    - Check if `wksp` is NULL; if so, log a warning and return.
    - Retrieve `part_max` and `pinfo` from the workspace structure.
    - Attempt to lock the workspace; if locking fails, return.
    - Query the used treap for the partition index `i` corresponding to `gaddr`.
    - If `i` is less than `part_max`, call [`fd_wksp_private_free`](<#fd_wksp_private_free>) to free the partition.
    - Unlock the workspace.
    - If `i` is greater than or equal to `part_max` and not equal to `FD_WKSP_PRIVATE_PINFO_IDX_NULL`, log a warning that `gaddr` does not appear to be a current workspace allocation.
- **Output**: No output is returned.
- **Functions Called**:
    - [`fd_wksp_private_pinfo`](<fd_wksp_private.h.md#fd_wksp_private_pinfo>)
    - [`fd_wksp_private_lock`](<fd_wksp_admin.c.md#fd_wksp_private_lock>)
    - [`fd_wksp_private_used_treap_query`](<fd_wksp_used_treap.c.md#fd_wksp_private_used_treap_query>)
    - [`fd_wksp_private_free`](<#fd_wksp_private_free>)
    - [`fd_wksp_private_unlock`](<fd_wksp_private.h.md#fd_wksp_private_unlock>)


---
### fd\_wksp\_tag<!-- {{#callable:fd_wksp_tag}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_user.c#L386>)

Retrieves the tag associated with a given global address in a workspace.
- **Inputs**:
    - `wksp`: A pointer to the `fd_wksp_t` workspace structure.
    - `gaddr`: The global address for which to retrieve the tag.
- **Logic and Control Flow**:
    - Check if `wksp` is NULL; if so, return 0UL.
    - Retrieve `part_max` from `wksp` and get the private partition info using [`fd_wksp_private_pinfo`](<fd_wksp_private.h.md#fd_wksp_private_pinfo>).
    - Attempt to lock the workspace using [`fd_wksp_private_lock`](<fd_wksp_admin.c.md#fd_wksp_private_lock>); if locking fails, return 0UL.
    - Query the used treap for the index `i` corresponding to `gaddr` using [`fd_wksp_private_used_treap_query`](<fd_wksp_used_treap.c.md#fd_wksp_private_used_treap_query>).
    - If `i` is less than `part_max`, retrieve the tag from `pinfo[i]`; otherwise, set `tag` to 0UL.
    - Unlock the workspace using [`fd_wksp_private_unlock`](<fd_wksp_private.h.md#fd_wksp_private_unlock>).
    - Return the retrieved `tag`.
- **Output**: Returns the tag associated with the given global address, or 0UL if the address is invalid or the workspace is NULL.
- **Functions Called**:
    - [`fd_wksp_private_pinfo`](<fd_wksp_private.h.md#fd_wksp_private_pinfo>)
    - [`fd_wksp_private_lock`](<fd_wksp_admin.c.md#fd_wksp_private_lock>)
    - [`fd_wksp_private_used_treap_query`](<fd_wksp_used_treap.c.md#fd_wksp_private_used_treap_query>)
    - [`fd_wksp_private_unlock`](<fd_wksp_private.h.md#fd_wksp_private_unlock>)


---
### fd\_wksp\_tag\_query<!-- {{#callable:fd_wksp_tag_query}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_user.c#L404>)

Queries a workspace for partitions with specific tags and returns information about them.
- **Inputs**:
    - `wksp`: A pointer to the `fd_wksp_t` workspace structure to query.
    - `tag`: A pointer to an array of `ulong` values representing the tags to query.
    - `tag_cnt`: The number of tags in the `tag` array.
    - `info`: A pointer to an array of `fd_wksp_tag_query_info_t` structures to store the query results.
    - `info_max`: The maximum number of entries that can be stored in the `info` array.
- **Logic and Control Flow**:
    - Check if `tag_cnt` is zero; if so, return 0 as there are no tags to query.
    - Validate the `wksp`, `tag`, and `info` pointers; log warnings and return 0 if any are invalid.
    - Retrieve the maximum number of partitions (`part_max`) and the private partition information (`pinfo`) from the workspace.
    - Initialize `info_cnt` to zero to count the number of matching tags found.
    - Lock the workspace to ensure thread safety; return 0 if locking fails.
    - Increment the workspace's `cycle_tag` to mark the current query cycle.
    - Iterate over the partitions in the workspace using the `part_head_cidx` index.
    - For each partition, check if the index is valid and if the partition has already been visited in the current cycle; if so, unlock the workspace, log a warning, and return 0.
    - Mark the current partition as visited by setting its `cycle_tag`.
    - For each tag in the `tag` array, check if it matches the current partition's tag.
    - If a match is found and `info_cnt` is less than `info_max`, store the partition's information in the `info` array and increment `info_cnt`.
    - Continue to the next partition using the `next_cidx` index.
    - Unlock the workspace after the iteration is complete.
    - Return the number of matching tags found (`info_cnt`).
- **Output**: Returns the number of partitions with matching tags found in the workspace.
- **Functions Called**:
    - [`fd_wksp_private_pinfo`](<fd_wksp_private.h.md#fd_wksp_private_pinfo>)
    - [`fd_wksp_private_lock`](<fd_wksp_admin.c.md#fd_wksp_private_lock>)
    - [`fd_wksp_private_pinfo_idx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx>)
    - [`fd_wksp_private_pinfo_idx_is_null`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx_is_null>)
    - [`fd_wksp_private_unlock`](<fd_wksp_private.h.md#fd_wksp_private_unlock>)


---
### fd\_wksp\_tag\_free<!-- {{#callable:fd_wksp_tag_free}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_user.c#L456>)

Frees workspace partitions that match specified tags.
- **Inputs**:
    - `wksp`: A pointer to the `fd_wksp_t` workspace structure.
    - `tag`: A pointer to an array of tags to match against workspace partitions.
    - `tag_cnt`: The number of tags in the `tag` array.
- **Logic and Control Flow**:
    - Return immediately if `tag_cnt` is zero, indicating no tags to free.
    - Check if `wksp` or `tag` is NULL and log a warning if so, then return.
    - Retrieve the maximum number of partitions (`part_max`) and the private partition information (`pinfo`) from the workspace.
    - Attempt to lock the workspace; if locking fails, return.
    - Initialize a stack (`top`) to track partitions to be freed and increment the workspace's `cycle_tag`.
    - Iterate over the partitions starting from the head, checking for corruption and marking visited partitions with the current `cycle_tag`.
    - For each partition, check if its tag matches any in the `tag` array; if so, push it onto the stack.
    - Once all partitions are checked, iterate over the stack to free each partition using [`fd_wksp_private_free`](<#fd_wksp_private_free>).
    - Unlock the workspace after freeing the partitions.
- **Output**: No output is returned.
- **Functions Called**:
    - [`fd_wksp_private_pinfo`](<fd_wksp_private.h.md#fd_wksp_private_pinfo>)
    - [`fd_wksp_private_lock`](<fd_wksp_admin.c.md#fd_wksp_private_lock>)
    - [`fd_wksp_private_pinfo_idx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx>)
    - [`fd_wksp_private_pinfo_idx_is_null`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx_is_null>)
    - [`fd_wksp_private_unlock`](<fd_wksp_private.h.md#fd_wksp_private_unlock>)
    - [`fd_wksp_private_pinfo_cidx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_cidx>)
    - [`fd_wksp_private_free`](<#fd_wksp_private_free>)


---
### fd\_wksp\_memset<!-- {{#callable:fd_wksp_memset}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_user.c#L507>)

Sets a memory region in a workspace to a specified value.
- **Inputs**:
    - `wksp`: A pointer to the `fd_wksp_t` workspace structure.
    - `gaddr`: The global address within the workspace where the memory set operation should begin.
    - `c`: The integer value to set in the specified memory region.
- **Logic and Control Flow**:
    - Check if `wksp` is NULL and log a warning if true, then return.
    - Retrieve `part_max` and `pinfo` from the workspace structure.
    - Attempt to lock the workspace; if locking fails, return.
    - Query the used treap with `gaddr` to find the partition index `i`.
    - If `i` is greater than or equal to `part_max`, set `err` to 1; otherwise, perform a memory set operation using `fd_memset` on the local address corresponding to `gaddr` and set `err` to 0.
    - Unlock the workspace.
    - If `err` is set, log a warning indicating that `gaddr` does not point to a current workspace allocation.
- **Output**: No return value; the function performs operations directly on the workspace memory.
- **Functions Called**:
    - [`fd_wksp_private_pinfo`](<fd_wksp_private.h.md#fd_wksp_private_pinfo>)
    - [`fd_wksp_private_lock`](<fd_wksp_admin.c.md#fd_wksp_private_lock>)
    - [`fd_wksp_private_used_treap_query`](<fd_wksp_used_treap.c.md#fd_wksp_private_used_treap_query>)
    - [`fd_wksp_laddr_fast`](<fd_wksp.h.md#fd_wksp_laddr_fast>)
    - [`fd_wksp_private_pinfo_sz`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_sz>)
    - [`fd_wksp_private_unlock`](<fd_wksp_private.h.md#fd_wksp_private_unlock>)


---
### fd\_wksp\_reset<!-- {{#callable:fd_wksp_reset}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_user.c#L532>)

Resets a workspace by clearing partition tags and rebuilding it with a given seed.
- **Inputs**:
    - `wksp`: A pointer to the `fd_wksp_t` workspace structure to reset.
    - `seed`: An unsigned integer used as a seed for rebuilding the workspace.
- **Logic and Control Flow**:
    - Check if `wksp` is NULL; if so, log a warning and return.
    - If `FD_HAS_DEEPASAN` is defined, poison the workspace data except for the header and `pinfo` array, then unpoison the `pinfo` array.
    - Retrieve `part_max` and `pinfo` from the workspace.
    - Attempt to lock the workspace; if locking fails, return.
    - Iterate over each partition in `pinfo` and set its `tag` to 0.
    - Call [`fd_wksp_rebuild`](<fd_wksp_admin.c.md#fd_wksp_rebuild>) with `wksp` and `seed` to rebuild the workspace.
    - Unlock the workspace.
    - If [`fd_wksp_rebuild`](<fd_wksp_admin.c.md#fd_wksp_rebuild>) returns an error, log a warning about a corrupt workspace.
- **Output**: No return value; the function operates directly on the workspace pointed to by `wksp`.
- **Functions Called**:
    - [`fd_wksp_footprint`](<fd_wksp_admin.c.md#fd_wksp_footprint>)
    - [`fd_wksp_private_pinfo_off`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_off>)
    - [`fd_wksp_private_pinfo`](<fd_wksp_private.h.md#fd_wksp_private_pinfo>)
    - [`fd_wksp_private_lock`](<fd_wksp_admin.c.md#fd_wksp_private_lock>)
    - [`fd_wksp_rebuild`](<fd_wksp_admin.c.md#fd_wksp_rebuild>)
    - [`fd_wksp_private_unlock`](<fd_wksp_private.h.md#fd_wksp_private_unlock>)


---
### fd\_wksp\_usage<!-- {{#callable:fd_wksp_usage}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_user.c#L559>)

Calculates and returns the usage statistics of a workspace based on specified tags.
- **Inputs**:
    - `wksp`: A pointer to the `fd_wksp_t` workspace structure to analyze.
    - `tag`: A pointer to an array of tags to match against the workspace partitions.
    - `tag_cnt`: The number of tags in the `tag` array.
    - `usage`: A pointer to an `fd_wksp_usage_t` structure where the usage statistics will be stored.
- **Logic and Control Flow**:
    - Check if `usage` is NULL and return it if true, logging a warning.
    - Initialize the `usage` structure to zero.
    - Check if `wksp` is NULL or if `tag` is NULL while `tag_cnt` is non-zero, returning `usage` and logging a warning if true.
    - Retrieve the maximum number of partitions (`part_max`) and the partition information (`pinfo`) from the workspace.
    - Attempt to lock the workspace; if locking fails, log a warning and return `usage`.
    - Set `usage->total_max` to `part_max`.
    - Increment the workspace's `cycle_tag` to mark the current cycle.
    - Iterate over the partitions starting from `part_head_cidx`, checking for corruption and marking visited partitions with the current `cycle_tag`.
    - For each partition, calculate its size and check if its tag matches any in the `tag` array.
    - Update the `usage` statistics for total, free, and used partitions based on the tag match results.
    - Unlock the workspace and return the `usage` structure.
- **Output**: A pointer to the `fd_wksp_usage_t` structure containing the updated usage statistics.
- **Functions Called**:
    - [`fd_wksp_private_pinfo`](<fd_wksp_private.h.md#fd_wksp_private_pinfo>)
    - [`fd_wksp_private_lock`](<fd_wksp_admin.c.md#fd_wksp_private_lock>)
    - [`fd_wksp_private_pinfo_idx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx>)
    - [`fd_wksp_private_pinfo_idx_is_null`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx_is_null>)
    - [`fd_wksp_private_unlock`](<fd_wksp_private.h.md#fd_wksp_private_unlock>)
    - [`fd_wksp_private_pinfo_sz`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_sz>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)