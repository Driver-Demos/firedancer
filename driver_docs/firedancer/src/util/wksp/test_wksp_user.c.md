<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for workspace memory management functions in the Firedancer codebase.

# Purpose
The code is a C program designed to test and validate the functionality of a workspace management system. It includes a [`main`](<#main>) function that initializes the environment, sets up a random number generator, and configures various parameters such as `scratch_sz`, `name`, `seed`, `part_max`, and `data_max` through command-line arguments. The program performs a series of tests on workspace operations, including address translation (`fd_wksp_laddr`, `fd_wksp_gaddr`), memory allocation (`fd_wksp_alloc`), memory setting (`fd_wksp_memset`), and memory freeing (`fd_wksp_free`). It also tests edge cases and verifies the integrity of the workspace using `fd_wksp_verify`.

The program uses a loop to simulate a large number of iterations, during which it performs random operations such as tagging, allocating, freeing, and setting memory within the workspace. It maintains an array of allocations to track memory usage and ensure that operations do not overlap improperly. The code includes logging statements to provide feedback on the progress and results of the tests. The program concludes by cleaning up resources and logging a success message if all tests pass. The code is structured to be executed as a standalone application, with the primary purpose of ensuring the correctness and reliability of the workspace management system.
# Imports and Dependencies

---
- `../fd_util.h`
- `fd_wksp_private.h`
- `stdio.h`


# Global Variables

---
### scratch
- **Type**: ``uchar[]``
- **Description**: An array of unsigned characters with a maximum size defined by `SCRATCH_MAX`, which is 16384 bytes. The array is aligned according to `FD_WKSP_ALIGN`, ensuring proper memory alignment for workspace operations.
- **Use**: Used as a scratch space for temporary data storage during workspace operations.


# Functions

---
### dump\_used\_tree<!-- {{#callable:dump_used_tree}} -->
[View Source →](<../../../../../src/util/wksp/test_wksp_user.c#L12>)

Prints a representation of a binary tree structure of used memory segments with indentation to indicate tree depth.
- **Inputs**:
    - `i`: The index of the current node in the tree, where `FD_WKSP_PRIVATE_PINFO_IDX_NULL` indicates a null node.
    - `pinfo`: A pointer to an array of `fd_wksp_private_pinfo_t` structures, which contain information about the memory segments.
    - `indent`: The current level of indentation, used to format the output to reflect the depth of the node in the tree.
- **Logic and Control Flow**:
    - Check if the current index `i` is `FD_WKSP_PRIVATE_PINFO_IDX_NULL`; if so, print a placeholder for a null node and return.
    - Recursively call `dump_used_tree` for the left child of the current node, increasing the indentation level by 4.
    - Print spaces according to the current indentation level, followed by the range of global addresses `[gaddr_lo, gaddr_hi)` for the current node.
    - Iterate through nodes with the same index (`same_cidx`) and print their indices until reaching a null index.
    - Recursively call `dump_used_tree` for the right child of the current node, increasing the indentation level by 4.
- **Output**: No return value; the function outputs formatted text to `stdout`.
- **Functions Called**:
    - [`fd_wksp_private_pinfo_idx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx>)


---
### dump\_free\_tree<!-- {{#callable:dump_free_tree}} -->
[View Source →](<../../../../../src/util/wksp/test_wksp_user.c#L36>)

Prints a representation of a binary tree of free memory blocks, showing their sizes and indices, with indentation to indicate tree depth.
- **Inputs**:
    - `i`: The index of the current node in the tree, where `FD_WKSP_PRIVATE_PINFO_IDX_NULL` indicates a null node.
    - `pinfo`: A pointer to an array of `fd_wksp_private_pinfo_t` structures, which contain information about the memory blocks.
    - `indent`: The current level of indentation for printing, used to visually represent the depth of the node in the tree.
- **Logic and Control Flow**:
    - Check if the current index `i` is `FD_WKSP_PRIVATE_PINFO_IDX_NULL`; if so, print a placeholder for a null node and return.
    - Recursively call `dump_free_tree` for the left child of the current node, increasing the indentation level by 4.
    - Print spaces according to the current indentation level, followed by the size of the memory block at the current node.
    - Iterate through the nodes with the same index (`same_cidx`), printing each index until reaching `FD_WKSP_PRIVATE_PINFO_IDX_NULL`.
    - Recursively call `dump_free_tree` for the right child of the current node, increasing the indentation level by 4.
- **Output**: No return value; the function outputs to `stdout`.
- **Functions Called**:
    - [`fd_wksp_private_pinfo_idx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/util/wksp/test_wksp_user.c#L61>)

Initializes and tests a workspace allocation system with various configurations and edge cases.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Creates a random number generator `rng` using `fd_rng_new` and `fd_rng_join`.
    - Parses command-line arguments to set `scratch_sz`, `name`, `seed`, `part_max`, and `data_max` with default values if not provided.
    - Checks if `scratch_sz` exceeds `SCRATCH_MAX` and logs an error if true.
    - Configures `part_max` and `data_max` if they are not set, estimating them based on `scratch_sz`.
    - Logs the configuration details for testing.
    - Calculates the workspace footprint and checks if it is valid and within `scratch_sz`.
    - Creates and joins a new workspace `wksp` using [`fd_wksp_new`](<fd_wksp_admin.c.md#fd_wksp_new>) and [`fd_wksp_join`](<fd_wksp_admin.c.md#fd_wksp_join>).
    - Tests various workspace functions ([`fd_wksp_laddr`](<fd_wksp_user.c.md#fd_wksp_laddr>), [`fd_wksp_gaddr`](<fd_wksp_user.c.md#fd_wksp_gaddr>), [`fd_wksp_laddr_fast`](<fd_wksp.h.md#fd_wksp_laddr_fast>), [`fd_wksp_gaddr_fast`](<fd_wksp.h.md#fd_wksp_gaddr_fast>)) for edge cases.
    - Allocates memory in the workspace and tests allocation functions for edge cases.
    - Performs a loop of 100 million iterations to test workspace operations like tagging, allocation, freeing, and memory setting with random operations.
    - Verifies the workspace integrity and logs usage statistics periodically.
    - Deletes the workspace and random number generator before halting the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`fd_wksp_part_max_est`](<fd_wksp_admin.c.md#fd_wksp_part_max_est>)
    - [`fd_wksp_data_max_est`](<fd_wksp_admin.c.md#fd_wksp_data_max_est>)
    - [`fd_wksp_footprint`](<fd_wksp_admin.c.md#fd_wksp_footprint>)
    - [`fd_wksp_join`](<fd_wksp_admin.c.md#fd_wksp_join>)
    - [`fd_wksp_new`](<fd_wksp_admin.c.md#fd_wksp_new>)
    - [`fd_wksp_laddr`](<fd_wksp_user.c.md#fd_wksp_laddr>)
    - [`fd_wksp_gaddr`](<fd_wksp_user.c.md#fd_wksp_gaddr>)
    - [`fd_wksp_laddr_fast`](<fd_wksp.h.md#fd_wksp_laddr_fast>)
    - [`fd_wksp_gaddr_fast`](<fd_wksp.h.md#fd_wksp_gaddr_fast>)
    - [`fd_wksp_alloc`](<fd_wksp.h.md#fd_wksp_alloc>)
    - [`fd_wksp_tag`](<fd_wksp_user.c.md#fd_wksp_tag>)
    - [`fd_wksp_memset`](<fd_wksp_user.c.md#fd_wksp_memset>)
    - [`fd_wksp_free`](<fd_wksp_user.c.md#fd_wksp_free>)
    - [`fd_wksp_tag_query`](<fd_wksp_user.c.md#fd_wksp_tag_query>)
    - [`fd_wksp_tag_free`](<fd_wksp_user.c.md#fd_wksp_tag_free>)
    - [`fd_wksp_reset`](<fd_wksp_user.c.md#fd_wksp_reset>)
    - [`fd_wksp_usage`](<fd_wksp.h.md#fd_wksp_usage>)
    - [`fd_wksp_verify`](<fd_wksp_admin.c.md#fd_wksp_verify>)
    - [`fd_wksp_rebuild`](<fd_wksp_admin.c.md#fd_wksp_rebuild>)
    - [`fd_wksp_alloc_at_least`](<fd_wksp_user.c.md#fd_wksp_alloc_at_least>)
    - [`fd_wksp_delete`](<fd_wksp_admin.c.md#fd_wksp_delete>)
    - [`fd_wksp_leave`](<fd_wksp_admin.c.md#fd_wksp_leave>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)