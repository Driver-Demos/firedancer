<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a function for creating a checkpoint of a workspace with load-balanced cgroups and error handling.

# Purpose
The code defines a function [`fd_wksp_private_checkpt_v2`](<#fd_wksp_private_checkpt_v2>), which is responsible for creating a checkpoint of a workspace (`wksp`) to a specified file path. This function is part of a private implementation and is not strictly part of the version 2 specification. The function takes several parameters, including a thread pool (`tpool`), time markers (`t0`, `t1`), the workspace to checkpoint (`wksp`), the file path (`path`), file mode (`mode`), user information (`uinfo`), and a flag indicating whether the frame style is compressed (`frame_style_compressed`).

The function performs several key operations: it locks the workspace to ensure exclusive access, calculates the number of allocation groups (cgroups) needed for checkpointing, and assigns workspace partitions to these cgroups in a load-balanced manner. It then creates a checkpoint file, writes metadata and data for each cgroup, and includes a footer to finalize the checkpoint. The function handles errors by logging warnings and attempting to continue, and it ensures that resources are properly released in case of failure. The function returns a status code indicating success or the type of error encountered.
# Imports and Dependencies

---
- `fd_wksp_private.h`
- `errno.h`
- `unistd.h`
- `fcntl.h`
- `sys/stat.h`


# Functions

---
### fd\_wksp\_private\_checkpt\_v2<!-- {{#callable:fd_wksp_private_checkpt_v2}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_checkpt_v2.c#L13>)

Creates a checkpoint of a workspace by organizing its partitions into load-balanced cgroups and writing them to a file.
- **Inputs**:
    - `tpool`: A pointer to a thread pool, currently unused.
    - `t0`: A starting time value, currently unused.
    - `t1`: An ending time value, currently unused.
    - `wksp`: A pointer to the workspace to checkpoint.
    - `path`: A string representing the file path where the checkpoint will be saved.
    - `mode`: File mode for creating the checkpoint file.
    - `uinfo`: A string containing user information to include in the checkpoint.
    - `frame_style_compressed`: An integer indicating whether to use compressed frame style.
- **Logic and Control Flow**:
    - Check if the compressed frame style is supported; if not, log a warning and return an error.
    - Retrieve workspace partition information and validate the workspace name.
    - Lock the workspace to prevent concurrent modifications.
    - Calculate the number of cgroups needed based on the number of allocations and ensure load balancing.
    - Assign workspace partitions to cgroups in a load-balanced manner using a combination of deterministic and random sampling.
    - Create and open a checkpoint file with the specified mode.
    - Initialize the checkpoint stream and write the workspace header information.
    - Write additional metadata and user information to the checkpoint file.
    - Iterate over each cgroup, writing partition metadata and data to the checkpoint file.
    - Write an appendix and footer to the checkpoint file to finalize the checkpoint.
    - Close the checkpoint file and unlock the workspace.
    - Handle any errors by releasing resources and logging warnings.
- **Output**: Returns `FD_WKSP_SUCCESS` on success or an error code on failure.
- **Functions Called**:
    - [`fd_wksp_private_pinfo`](<fd_wksp_private.h.md#fd_wksp_private_pinfo>)
    - [`fd_wksp_private_lock`](<fd_wksp_admin.c.md#fd_wksp_private_lock>)
    - [`fd_wksp_private_pinfo_idx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx>)
    - [`fd_wksp_private_pinfo_idx_is_null`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx_is_null>)
    - [`fd_wksp_private_pinfo_cidx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_cidx>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)