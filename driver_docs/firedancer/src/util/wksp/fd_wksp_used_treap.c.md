<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for querying, inserting, and removing nodes in a workspace treap data structure.

# Purpose
The code defines functions for managing a data structure known as a "treap" within a workspace. A treap is a combination of a binary search tree and a heap, which allows for efficient searching, insertion, and deletion operations. The functions [`fd_wksp_private_used_treap_query`](<#fd_wksp_private_used_treap_query>), [`fd_wksp_private_used_treap_insert`](<#fd_wksp_private_used_treap_insert>), and [`fd_wksp_private_used_treap_remove`](<#fd_wksp_private_used_treap_remove>) are responsible for querying, inserting, and removing nodes in the treap, respectively. These operations are performed on a workspace represented by the `fd_wksp_t` structure, which contains information about the address range and partitioning of the workspace.

The code uses several macros, such as `TEST`, `TEST_AND_MARK`, and `TEST_PARENT`, to ensure the integrity of the treap during operations. These macros check conditions like index validity, cycle detection, and parent-child relationships. The functions manipulate the `fd_wksp_private_pinfo_t` structure, which holds information about each node in the treap, including address ranges and heap priorities. The code is part of a private implementation, as indicated by the inclusion of the header `fd_wksp_private.h`, and is likely intended for internal use within a larger system managing memory or resource allocation.
# Imports and Dependencies

---
- `fd_wksp_private.h`


# Functions

---
### fd\_wksp\_private\_used\_treap\_query<!-- {{#callable:fd_wksp_private_used_treap_query}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_used_treap.c#L3>)

Searches for a global address within a workspace's used partition treap and returns the index of the partition containing it.
- **Inputs**:
    - `gaddr`: The global address to search for within the workspace.
    - `wksp`: A pointer to the `fd_wksp_t` structure representing the workspace.
    - `pinfo`: A pointer to an array of `fd_wksp_private_pinfo_t` structures containing partition information.
- **Logic and Control Flow**:
    - Check if `gaddr` is within the range defined by `wksp->gaddr_lo` and `wksp->gaddr_hi`; if not, return `FD_WKSP_PRIVATE_PINFO_IDX_NULL`.
    - Initialize `part_max` with `wksp->part_max` and increment `wksp->cycle_tag` to use as a cycle detection tag.
    - Start with the index `i` obtained from `fd_wksp_private_pinfo_idx(wksp->part_used_cidx)` and iterate while `i` is not null.
    - In each iteration, check if `i` is a valid index and if the current partition has already been visited in this cycle; if either condition fails, return `FD_WKSP_PRIVATE_PINFO_IDX_NULL`.
    - Mark the current partition as visited by setting its `cycle_tag`.
    - Compare `gaddr` with the current partition's address range (`gaddr_lo` and `gaddr_hi`); if `gaddr` is less than `gaddr_lo`, move to the left child; if `gaddr` is greater than or equal to `gaddr_hi`, move to the right child.
    - If `gaddr` is within the current partition's range, break the loop.
- **Output**: Returns the index of the partition containing `gaddr`, or `FD_WKSP_PRIVATE_PINFO_IDX_NULL` if not found or if an error occurs.
- **Functions Called**:
    - [`fd_wksp_private_pinfo_idx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx>)
    - [`fd_wksp_private_pinfo_idx_is_null`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx_is_null>)


---
### fd\_wksp\_private\_used\_treap\_insert<!-- {{#callable:fd_wksp_private_used_treap_insert}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_used_treap.c#L41>)

Inserts a node into a treap data structure while maintaining heap properties.
- **Inputs**:
    - `n`: The index of the node to insert into the treap.
    - `wksp`: A pointer to the workspace structure containing the treap.
    - `pinfo`: An array of private partition information structures, where each element corresponds to a node in the treap.
- **Logic and Control Flow**:
    - Check if `n` is a valid index within the bounds of `part_max` and mark it with the current `cycle_tag`.
    - Retrieve the global address range (`g0` and `g1`) for the node `n` and ensure it is within the valid range of the workspace.
    - Initialize `_p_child_cidx` to point to the root of the treap.
    - If the treap is empty, set `n` as the root and return success.
    - Validate the parent link of the current node `i`.
    - Traverse the treap to find the appropriate leaf node for insertion, checking left and right child links for validity.
    - If `n` overlaps with an existing node, return an error indicating corruption.
    - Insert `n` as a child of the found node `i`, potentially breaking the heap property temporarily.
    - Bubble `n` up the treap to restore the heap property, swapping nodes as necessary based on priority.
- **Output**: Returns `FD_WKSP_SUCCESS` on successful insertion or `FD_WKSP_ERR_CORRUPT` if an overlap is detected.
- **Functions Called**:
    - [`fd_wksp_private_pinfo_idx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx>)
    - [`fd_wksp_private_pinfo_idx_is_null`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx_is_null>)
    - [`fd_wksp_private_pinfo_cidx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_cidx>)


---
### fd\_wksp\_private\_used\_treap\_remove<!-- {{#callable:fd_wksp_private_used_treap_remove}} -->
[View Source →](<../../../../../src/util/wksp/fd_wksp_used_treap.c#L172>)

Removes a node from a used treap in a workspace, maintaining the treap's properties.
- **Inputs**:
    - `d`: The index of the node to remove from the treap.
    - `wksp`: A pointer to the workspace structure containing the treap.
    - `pinfo`: An array of private information structures for each node in the treap.
- **Logic and Control Flow**:
    - Check if `d` is within the valid range of `part_max` and mark it with the current `cycle_tag`.
    - Ensure that `d` is not part of a 'same' list in the treap.
    - Load and validate the left, right, and parent indices of `d`, marking them with the current `cycle_tag`.
    - Determine the location of the link from the parent to `d` or the root of the tree if `d` is the root.
    - If `d` has no left subtree, replace `d` with its right subtree and exit.
    - If `d` has no right subtree, replace `d` with its left subtree and exit.
    - If `d` has both subtrees, decide whether to promote the left or right subtree based on heap priorities, and push the hole down accordingly.
    - Repeat the process until the hole is filled, maintaining the treap's properties.
    - Clear the `in_same`, `left_cidx`, `right_cidx`, `same_cidx`, and `parent_cidx` fields of `d`.
- **Output**: Returns `FD_WKSP_SUCCESS` to indicate successful removal of the node.
- **Functions Called**:
    - [`fd_wksp_private_pinfo_idx_is_null`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx_is_null>)
    - [`fd_wksp_private_pinfo_idx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_idx>)
    - [`fd_wksp_private_pinfo_cidx`](<fd_wksp_private.h.md#fd_wksp_private_pinfo_cidx>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)