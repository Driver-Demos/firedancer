<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements address sanitization and tracking with ASAN, including address watching and backtrace logging.

# Purpose
The code provides functionality for monitoring memory addresses using AddressSanitizer (ASan) in a C program. It includes mechanisms to track and log the status of specific memory addresses, indicating whether they are "poisoned" (i.e., potentially corrupted or invalid) or "not poisoned." The code is part of a larger system, as indicated by the inclusion of headers such as `fd_util.h`, `fd_log.h`, and `fd_asan.h`. It is conditionally compiled with the `FD_HAS_DEEPASAN_WATCH` macro, suggesting that this functionality is optional and can be enabled or disabled based on the build configuration.

The main components of the code are two functions: [`fd_asan_watch`](<#fd_asan_watch>) and [`fd_asan_check_watch`](<#fd_asan_check_watch>). The [`fd_asan_watch`](<#fd_asan_watch>) function adds a memory address to a watch list and logs its status using ASan. It also prints a backtrace to help identify where the address was accessed. The [`fd_asan_check_watch`](<#fd_asan_check_watch>) function iterates over the watched addresses and logs updates to their status. The code uses a static array `fd_asan_watch_addrs` to store up to 64 addresses, and it maintains a count of the addresses being watched. The use of `FD_ATOMIC_FETCH_AND_ADD` ensures thread-safe updates to the address count. The code is intended to be used in debugging scenarios to help developers identify and diagnose memory-related issues in their applications.
# Imports and Dependencies

---
- `../fd_util.h`
- `../log/fd_log.h`
- `fd_asan.h`
- `fd_backtrace.h`
- `stdio.h`


# Global Variables

---
### fd\_asan\_watch\_addrs
- **Type**: ``ulong[64]``
- **Description**: An array of 64 unsigned long integers that stores addresses to be monitored by AddressSanitizer (ASan).
- **Use**: Used to keep track of memory addresses that are being watched for potential issues by ASan.


---
### fd\_asan\_watch\_addrs\_cnt
- **Type**: ``uint``
- **Description**: A static volatile unsigned integer that counts the number of addresses being watched by the AddressSanitizer (ASAN) in the `fd_asan_watch_addrs` array.
- **Use**: Tracks the number of addresses currently being monitored for memory access issues.


# Functions

---
### fd\_asan\_watch<!-- {{#callable:fd_asan_watch}} -->
[View Source →](<../../../../../src/util/sanitize/fd_asan.c#L12>)

Monitors a memory address for AddressSanitizer (ASan) poisoning and logs its status.
- **Inputs**:
    - `addr`: A constant pointer to the memory address to monitor.
- **Logic and Control Flow**:
    - Fetches and increments the atomic counter `fd_asan_watch_addrs_cnt` to get the index `n` for storing the address.
    - Checks if `n` is 64 or more, logs a critical error if true, indicating too many addresses are being watched.
    - Stores the address `addr` in the `fd_asan_watch_addrs` array at index `n`.
    - Calls `__asan_address_is_poisoned` to check if the address is poisoned.
    - Logs the address and its poisoned status to `stderr`.
    - Flushes the `stderr` stream to ensure the log is written immediately.
    - Prints a backtrace to `stderr` using [`fd_backtrace_print`](<fd_backtrace.c.md#fd_backtrace_print>).
- **Output**: No return value; outputs log messages to `stderr`.
- **Functions Called**:
    - [`fd_backtrace_print`](<fd_backtrace.c.md#fd_backtrace_print>)


---
### fd\_asan\_check\_watch<!-- {{#callable:fd_asan_check_watch}} -->
[View Source →](<../../../../../src/util/sanitize/fd_asan.c#L23>)

Checks if any watched addresses fall within a specified memory range and logs their status as poisoned or not.
- **Inputs**:
    - `poison`: An integer indicating whether the address is poisoned (non-zero) or not (zero).
    - `addr`: A pointer to the start of the memory range to check.
    - `sz`: The size of the memory range to check, in bytes.
- **Logic and Control Flow**:
    - Iterates over the array `fd_asan_watch_addrs` which contains addresses being watched.
    - For each watched address, checks if it falls within the memory range specified by `addr` and `sz`.
    - If a watched address is within the range, logs the address and its poisoned status to `stderr`.
    - Flushes the `stderr` stream to ensure the log is written immediately.
    - Prints a backtrace to `stderr` using [`fd_backtrace_print`](<fd_backtrace.c.md#fd_backtrace_print>).
- **Output**: No return value; outputs log information to `stderr`.
- **Functions Called**:
    - [`fd_backtrace_print`](<fd_backtrace.c.md#fd_backtrace_print>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)