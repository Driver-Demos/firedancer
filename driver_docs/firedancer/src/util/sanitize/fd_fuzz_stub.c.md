<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

A stub fuzz harness for regression testing without a fuzz engine, simulating libFuzzer command-line.

# Purpose
The code in `fd_fuzz_stub.c` is a stub fuzz harness designed for build targets that do not include an actual fuzz engine. It simulates the command-line interface of `libFuzzer` and allows for regression testing against existing input files. However, it does not perform any fuzz exploration. The primary function [`main`](<#main>) processes command-line arguments, opening each specified file or directory, and attempts to execute fuzz tests on the contents using the [`LLVMFuzzerTestOneInput`](<#llvmfuzzertestoneinput>) function. If a directory is specified, it iterates over each file within the directory to perform the tests.

The code includes several key components: the [`i_am_a_stub`](<#i_am_a_stub>) function, which provides feedback when no fuzz engine is present; the [`execute`](<#execute>) function, which handles the reading and testing of individual files; and the [`LLVMFuzzerInitialize`](<#llvmfuzzerinitialize>) and [`LLVMFuzzerTestOneInput`](<#llvmfuzzertestoneinput>) functions, which are external and expected to be defined elsewhere. The [`LLVMFuzzerMutate`](<#llvmfuzzermutate>) function is defined as a weak symbol, allowing for optional overriding. The code is structured to handle errors robustly, logging issues with file operations and memory allocation. It is intended to be compiled with `clang` and additional fuzzing support to enable full fuzzing capabilities.
# Imports and Dependencies

---
- `fd_fuzz.h`
- `../fd_util.h`
- `errno.h`
- `dirent.h`
- `fcntl.h`
- `stdlib.h`
- `stdio.h`
- `sys/stat.h`
- `sys/types.h`
- `unistd.h`


# Functions

---
### i\_am\_a\_stub<!-- {{#callable:i_am_a_stub}} -->
[View Source →](<../../../../../src/util/sanitize/fd_fuzz_stub.c#L18>)

Outputs a message indicating the absence of a fuzz engine and provides instructions for compiling with a fuzz engine.
- **Inputs**: None
- **Logic and Control Flow**:
    - Outputs a message to `stderr` indicating that the fuzz target was compiled without a fuzz engine.
    - Provides instructions on how to re-run individual test cases and how to compile with the `libFuzzer` engine.
    - Returns the integer `1` to indicate failure.
- **Output**: Returns `1` to indicate that the function executed without a fuzz engine.


---
### LLVMFuzzerMutate<!-- {{#callable:LLVMFuzzerMutate}} -->
[View Source →](<../../../../../src/util/sanitize/fd_fuzz_stub.c#L39>)

Returns zero without performing any mutation on the input data.
- **Inputs**:
    - `data`: A pointer to an array of unsigned characters that represents the data to mutate.
    - `data_sz`: The size of the data array in bytes.
    - `max_sz`: The maximum size that the mutated data can have.
- **Logic and Control Flow**:
    - The function takes three parameters: `data`, `data_sz`, and `max_sz`, but does not use them.
    - The function explicitly casts the parameters to void to avoid compiler warnings about unused variables.
    - Returns a constant value of `0UL`.
- **Output**: Always returns `0UL`, indicating no mutation is performed.


---
### execute<!-- {{#callable:execute}} -->
[View Source →](<../../../../../src/util/sanitize/fd_fuzz_stub.c#L48>)

Executes a fuzz test on the contents of a file if it is a regular file.
- **Inputs**:
    - `file`: A file descriptor for the file to be tested.
- **Logic and Control Flow**:
    - Use `fstat` to get the status of the file associated with the file descriptor `file`.
    - If `fstat` fails, log an error and return the error number.
    - Check if the file is a directory using `st.st_mode & S_IFDIR`; if true, return `EISDIR`.
    - Check if the file is a regular file using `st.st_mode & S_IFREG`; if false, return `EBADF`.
    - Allocate a buffer of size `st.st_size` using `malloc`.
    - If memory allocation fails, log an error.
    - Read the file contents into the buffer using `fd_io_read`.
    - If reading fails, log an error and return 1.
    - Pass the buffer and the actual read size to `LLVMFuzzerTestOneInput` for fuzz testing.
    - Free the allocated buffer.
    - Return 0 to indicate successful execution.
- **Output**: Returns 0 on success, `EISDIR` if the file is a directory, `EBADF` if the file is not a regular file, or an error code if an error occurs.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/util/sanitize/fd_fuzz_stub.c#L77>)

Processes command-line arguments to execute files or directories using a fuzz testing harness.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of strings representing the command-line arguments.
- **Logic and Control Flow**:
    - If `argc` is less than or equal to 1, call `i_am_a_stub()` and return its result.
    - Call `LLVMFuzzerInitialize()` to initialize the fuzzer with the command-line arguments.
    - Iterate over each command-line argument starting from index 1.
    - Skip arguments that start with a dash ('-').
    - Open each file specified by the command-line arguments using `open()`.
    - If the file cannot be opened, log an error and continue to the next argument.
    - Call `execute()` on the opened file descriptor.
    - If `execute()` returns `EISDIR`, treat the file as a directory and open it using `fdopendir()`.
    - Iterate over each entry in the directory using `readdir()`.
    - Open each entry in the directory using `openat()` and call `execute()` on it.
    - Log the execution result for each file or directory entry.
    - Close the file or directory descriptors after processing.
- **Output**: Returns 0 on successful execution of all files or directories, or 1 if `i_am_a_stub()` is called.
- **Functions Called**:
    - [`i_am_a_stub`](<#i_am_a_stub>)
    - [`execute`](<#execute>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)