<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a TAR file reader with functions for processing headers and reading data.

# Purpose
The code provides functionality for reading and processing TAR archive headers and data. It defines a TAR reader that uses a callback mechanism to handle file headers and data chunks. The main components include functions to create and delete a TAR reader ([`fd_tar_reader_new`](<#fd_tar_reader_new>) and [`fd_tar_reader_delete`](<#fd_tar_reader_delete>)), process TAR headers ([`fd_tar_process_hdr`](<#fd_tar_process_hdr>)), read TAR headers ([`fd_tar_read_hdr`](<#fd_tar_read_hdr>)), and read TAR data ([`fd_tar_read_data`](<#fd_tar_read_data>)). The [`fd_tar_read`](<#fd_tar_read>) function orchestrates the reading process, handling both headers and data, and ensuring that the entire data buffer is processed.

The code also includes utility functions such as [`fd_tar_meta_get_size`](<#fd_tar_meta_get_size>) to extract the size of a file from a TAR header, and [`fd_tar_set_octal`](<#fd_tar_set_octal>) to set a buffer with an octal representation of a value. The code is structured to handle errors and align memory as required, and it uses a callback interface (`fd_tar_read_vtable_t`) to allow external handling of file data and headers. This code is intended to be part of a larger system where it can be integrated to read TAR files, providing a specific and narrow functionality focused on TAR archive processing.
# Imports and Dependencies

---
- `fd_tar.h`
- `../fd_util.h`
- `errno.h`


# Functions

---
### fd\_tar\_reader\_new<!-- {{#callable:fd_tar_reader_new}} -->
[View Source →](<../../../../../src/util/archive/fd_tar_reader.c#L6>)

Initializes a new `fd_tar_reader_t` structure with provided memory, callback vtable, and callback argument.
- **Inputs**:
    - `mem`: A pointer to the memory where the `fd_tar_reader_t` structure will be initialized.
    - `cb_vt`: A pointer to a `fd_tar_read_vtable_t` structure containing callback functions for file and read operations.
    - `cb_arg`: A pointer to an argument that will be passed to the callback functions.
- **Logic and Control Flow**:
    - Check if `mem` is NULL; if true, log a warning and return NULL.
    - Check if `cb_vt` is NULL or if its `file` or `read` members are NULL; if true, log a warning and return NULL.
    - Check if `mem` is aligned according to `fd_tar_reader_align()`; if not, log a warning and return NULL.
    - Cast `mem` to `fd_tar_reader_t *` and assign it to `self`.
    - Initialize the memory pointed to by `self` to zero using `fd_memset`.
    - Copy the contents of `cb_vt` to `self->cb_vt`.
    - Assign `cb_arg` to `self->cb_arg`.
    - Return the pointer `self`.
- **Output**: A pointer to the initialized `fd_tar_reader_t` structure, or NULL if any checks fail.
- **Functions Called**:
    - [`fd_tar_reader_align`](<fd_tar.h.md#fd_tar_reader_align>)


---
### fd\_tar\_reader\_delete<!-- {{#callable:fd_tar_reader_delete}} -->
[View Source →](<../../../../../src/util/archive/fd_tar_reader.c#L31>)

Resets the memory of a `fd_tar_reader_t` object to zero and returns the pointer to the object.
- **Inputs**:
    - `reader`: A pointer to a `fd_tar_reader_t` object that needs to be deleted or reset.
- **Logic and Control Flow**:
    - Check if the `reader` pointer is NULL using `FD_UNLIKELY`; if it is NULL, return NULL immediately.
    - Use `fd_memset` to set the memory of the `reader` object to zero, effectively resetting it.
    - Return the `reader` pointer after resetting its memory.
- **Output**: Returns the pointer to the `fd_tar_reader_t` object after resetting its memory, or NULL if the input pointer was NULL.


---
### fd\_tar\_process\_hdr<!-- {{#callable:fd_tar_process_hdr}} -->
[View Source →](<../../../../../src/util/archive/fd_tar_reader.c#L38>)

Processes a TAR header from the reader's buffer and validates its magic value, file size, and name termination.
- **Inputs**:
    - `reader`: A pointer to an `fd_tar_reader_t` structure that contains the TAR reader's state and buffer.
- **Logic and Control Flow**:
    - Cast the buffer in the reader to a `fd_tar_meta_t` structure to access the TAR header.
    - Check if the magic value in the header matches the expected TAR magic value (`FD_TAR_MAGIC`).
    - If the magic value does not match, check if the buffer is filled with zeros to detect EOF; return -1 if EOF is detected.
    - If not EOF, log a warning for invalid TAR header magic and return `EPROTO` for protocol error.
    - Retrieve the file size from the header using [`fd_tar_meta_get_size`](<#fd_tar_meta_get_size>) and check for errors; log a warning and return `EPROTO` if the size is invalid.
    - Set the reader's file size and reset the buffer counter to zero.
    - Ensure the file name in the header is null-terminated by setting the last character to '\0'.
    - Invoke the callback function `file` from the reader's callback vtable with the header and file size.
    - Return the result of the callback function, using `fd_int_if` to map errors to `EIO` or success to 0.
- **Output**: Returns 0 on success, -1 if EOF is detected, or an error code (`EPROTO` or `EIO`) if a protocol error or I/O error occurs.
- **Functions Called**:
    - [`fd_tar_meta_get_size`](<#fd_tar_meta_get_size>)


---
### fd\_tar\_read\_hdr<!-- {{#callable:fd_tar_read_hdr}} -->
[View Source →](<../../../../../src/util/archive/fd_tar_reader.c#L77>)

Reads and processes a TAR file header from a buffer, handling padding and incomplete headers.
- **Inputs**:
    - `reader`: A pointer to an `fd_tar_reader_t` structure that maintains the state of the TAR reading process.
    - `pcur`: A pointer to a pointer to the current position in the buffer, which will be updated as the function reads data.
    - `end`: A pointer to the end of the buffer, indicating the limit up to which data can be read.
- **Logic and Control Flow**:
    - Initialize `cur` to the current position pointed by `*pcur`.
    - If `reader->buf_ctr` is zero, calculate the padding size needed to align the position to 512 bytes and skip this padding in the buffer.
    - Calculate the number of bytes needed to complete the TAR header (`chunk_sz`) and adjust it if the remaining buffer size is smaller.
    - Copy the determined number of bytes from the buffer to the reader's buffer (`reader->buf`).
    - Update `cur` and `reader->buf_ctr` with the number of bytes read.
    - If the reader's buffer now contains a complete TAR header, call [`fd_tar_process_hdr`](<#fd_tar_process_hdr>) to process it.
    - Update `*pcur` to the new position `cur`.
    - Return the result of [`fd_tar_process_hdr`](<#fd_tar_process_hdr>) if a complete header was processed, otherwise return 0.
- **Output**: Returns an integer indicating the result of processing the TAR header, where 0 means success and a non-zero value indicates an error.
- **Functions Called**:
    - [`fd_tar_process_hdr`](<#fd_tar_process_hdr>)


---
### fd\_tar\_read\_data<!-- {{#callable:fd_tar_read_data}} -->
[View Source →](<../../../../../src/util/archive/fd_tar_reader.c#L110>)

Reads data from a TAR file and updates the reader's state.
- **Inputs**:
    - ``reader``: A pointer to an `fd_tar_reader_t` structure that maintains the state of the TAR reading process.
    - ``pcur``: A pointer to a pointer to the current position in the data buffer, which will be updated as data is read.
    - ``end``: A pointer to the end of the data buffer, indicating the limit for reading data.
- **Logic and Control Flow**:
    - Initialize `cur` with the value pointed to by `pcur` and ensure `cur` is less than or equal to `end`.
    - Calculate `chunk_sz` as the minimum of `reader->file_sz` and the available size (`end - cur`).
    - Invoke the `read` callback function from the reader's callback virtual table (`cb_vt`) with the current position, `cur`, and `chunk_sz`.
    - Advance `cur` by `chunk_sz` and decrease `reader->file_sz` by `chunk_sz`.
    - Update `pcur` to point to the new position of `cur`.
    - Return the error code from the `read` callback function.
- **Output**: Returns an integer error code from the `read` callback function, indicating success or failure of the read operation.


---
### fd\_tar\_read<!-- {{#callable:fd_tar_read}} -->
[View Source →](<../../../../../src/util/archive/fd_tar_reader.c#L135>)

Processes a TAR archive data buffer and updates the reader's position, handling errors as specified.
- **Inputs**:
    - `reader_`: A pointer to a `fd_tar_reader_t` structure that maintains the state of the TAR reading process.
    - `data`: A pointer to the buffer containing the TAR archive data to be processed.
    - `data_sz`: The size of the data buffer in bytes.
    - `track_err`: An integer representing a specific error code to track during processing.
- **Logic and Control Flow**:
    - Initialize `cur` to point to the start of the data buffer and `end` to point to the end of the data buffer.
    - Initialize `seen_tracked_err` to 0 to track if the specified error has been encountered.
    - Enter a loop that continues until `cur` equals `end`.
    - If `reader->file_sz` is non-zero, call [`fd_tar_read_data`](<#fd_tar_read_data>) to process file data, update `seen_tracked_err` if `track_err` is encountered, and update `reader->pos`.
    - If `reader->file_sz` is zero, call [`fd_tar_read_hdr`](<#fd_tar_read_hdr>) to process the TAR header and update `reader->pos`.
    - If any error other than `track_err` is encountered, return the error immediately.
    - After processing the entire buffer, return `track_err` if it was seen, otherwise return 0.
- **Output**: Returns 0 if the buffer is processed without errors, `track_err` if the tracked error is encountered, or another error code if a different error occurs.
- **Functions Called**:
    - [`fd_tar_read_data`](<#fd_tar_read_data>)
    - [`fd_tar_read_hdr`](<#fd_tar_read_hdr>)


---
### fd\_tar\_meta\_get\_size<!-- {{#callable:fd_tar_meta_get_size}} -->
[View Source →](<../../../../../src/util/archive/fd_tar_reader.c#L174>)

Calculates the size of a tar file entry from its metadata.
- **Inputs**:
    - `meta`: A pointer to a `fd_tar_meta_t` structure containing the tar file metadata.
- **Logic and Control Flow**:
    - Get the pointer `buf` to the `size` field of the `meta` structure.
    - Check if the first byte of `buf` has the highest bit set, indicating OLDGNU binary size encoding.
    - If OLDGNU encoding is detected, load the size from `buf+4` using `FD_LOAD` and byte-swap it using `fd_ulong_bswap`.
    - If not using OLDGNU encoding, initialize `ret` to 0 and iterate over the first 12 bytes of `buf`.
    - For each byte, if it is a null character, break the loop.
    - Otherwise, shift `ret` left by 3 bits and add the numeric value of the current byte minus '0'.
- **Output**: Returns the size of the tar file entry as an `ulong`.


---
### fd\_tar\_set\_octal<!-- {{#callable:fd_tar_set_octal}} -->
[View Source →](<../../../../../src/util/archive/fd_tar_reader.c#L191>)

Converts an unsigned long integer to an 11-character octal string and stores it in a buffer.
- **Inputs**:
    - `buf`: A character array of at least 12 elements to store the octal string.
    - `val`: An unsigned long integer to convert to an octal string.
- **Logic and Control Flow**:
    - Set the last character of `buf` to the null terminator '\0'.
    - Iterate from index 10 to 0 of `buf`.
    - In each iteration, calculate the least significant octal digit of `val` using bitwise AND with 7UL, convert it to a character, and store it in `buf[i]`.
    - Right shift `val` by 3 bits to process the next octal digit.
    - Return 1 if `val` is zero after processing all digits, otherwise return 0.
- **Output**: Returns 1 if the entire value was successfully converted to octal, otherwise returns 0.



---
Made with ❤️ by [Driver](https://www.driver.ai/)