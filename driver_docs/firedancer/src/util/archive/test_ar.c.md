<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Unit tests for validating AR archive file handling, including valid, empty, and invalid cases.

# Purpose
This code is a C test suite designed to validate the functionality of reading AR archive files. It includes several test cases that check different scenarios when handling AR files. The code uses the `fd_ar` library to perform operations on AR files, and it is intended to be executed in a hosted environment, as indicated by the `FD_HAS_HOSTED` preprocessor directive. The test suite includes functions to test reading valid AR files, handling empty AR files, and managing files with invalid AR magic numbers or invalid entry headers. Each test function opens a file stream using `fmemopen`, performs a series of checks using the `FD_TEST` macro, and ensures that the file is closed properly after the tests.

The [`main`](<#main>) function initializes the test environment and executes each test function sequentially. If the tests are successful, it logs a "pass" message; otherwise, it logs warnings or errors as appropriate. The code also includes a conditional compilation block that skips the tests if the `FD_HAS_HOSTED` condition is not met, logging a warning message instead. This ensures that the tests are only run in suitable environments. The test suite is structured to provide comprehensive coverage of the AR file reading functionality, ensuring that the library behaves correctly under various conditions.
# Imports and Dependencies

---
- `../fd_util.h`
- `fd_ar.h`
- `stdio.h`
- `errno.h`


# Functions

---
### test\_valid\_ar<!-- {{#callable:test_valid_ar}} -->
[View Source →](<../../../../../src/util/archive/test_ar.c#L13>)

Validates reading entries from a valid AR archive file and checks for expected metadata and content.
- **Inputs**: None
- **Logic and Control Flow**:
    - Opens a valid AR file using `fmemopen` with the binary data `test_ar` and size `test_ar_sz` in read-binary mode.
    - Checks if the file is successfully opened and initializes the AR reading process with `fd_ar_read_init`.
    - Defines a macro `CHECK_NEXT_AR` to validate the metadata and content of each entry read from the AR file.
    - Uses `CHECK_NEXT_AR` to read and validate four entries, checking metadata fields like `mtime`, `uid`, `gid`, `mode`, `filesz`, and specific content at a given offset.
    - After reading the entries, checks for the end of the archive by expecting `fd_ar_read_next` to return `ENOENT`.
    - Closes the file using `fclose` and checks for successful closure.
- **Output**: No output is returned; the function performs validation checks using `FD_TEST` assertions.


---
### test\_empty\_ar<!-- {{#callable:test_empty_ar}} -->
[View Source →](<../../../../../src/util/archive/test_ar.c#L52>)

Tests the handling of an empty archive file by verifying that no entries are present.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initializes a buffer `buf` with the AR file magic string `!<arch>\n`.
    - Opens a memory stream `file` using `fmemopen` with the buffer `buf` as the source.
    - Checks if the file stream `file` is successfully opened using `FD_TEST`.
    - Initializes the AR reading process on the file stream using `fd_ar_read_init` and checks for success.
    - Declares a metadata structure `meta` for reading AR entries.
    - Attempts to read the next AR entry using `fd_ar_read_next` and checks if it returns `ENOENT`, indicating no entries are present.
    - Closes the file stream `file` and checks for successful closure using `FD_TEST`.
- **Output**: No output is returned; the function uses assertions to validate behavior.


---
### test\_invalid\_ar\_magic<!-- {{#callable:test_invalid_ar_magic}} -->
[View Source →](<../../../../../src/util/archive/test_ar.c#L65>)

Tests the behavior of the archive reading function when given a file with invalid AR magic.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize a buffer `buf` with 128 bytes set to zero.
    - Open a memory stream `file` using `fmemopen` with the zeroed buffer, specifying a size of 128 bytes and read-only mode.
    - Check if the file stream `file` is successfully opened using `FD_TEST`.
    - Call `fd_ar_read_init` on the file stream and verify it returns `EPROTO`, indicating a protocol error due to invalid AR magic.
    - Close the file stream `file` and verify it closes successfully using `FD_TEST`.
- **Output**: No output is returned as the function is void; it performs tests and assertions internally.


---
### test\_invalid\_entry\_magic<!-- {{#callable:test_invalid_entry_magic}} -->
[View Source →](<../../../../../src/util/archive/test_ar.c#L76>)

Tests the behavior of the archive reading function when encountering an invalid file header magic in the archive stream.
- **Inputs**:
    - `void`: No input parameters.
- **Logic and Control Flow**:
    - Initialize a buffer `buf` with 128 bytes set to zero.
    - Copy the string `!<arch>\n` into the first 8 bytes of `buf`.
    - Open a memory stream `file` using `fmemopen` with `buf` as the data source, a size of 128 bytes, and read mode `rb`.
    - Check if `file` is successfully opened using `FD_TEST`.
    - Initialize the archive reading process on `file` using `fd_ar_read_init` and verify it returns success using `FD_TEST`.
    - Declare a metadata structure `meta` of type `fd_ar_meta_t`.
    - Attempt to read the next archive entry using `fd_ar_read_next` and check if it returns `EPROTO`, indicating an invalid entry magic, using `FD_TEST`.
    - Close the file stream `file` and verify it closes successfully using `FD_TEST`.
- **Output**: No output is returned, but the function uses assertions to validate the behavior of the archive reading process.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/util/archive/test_ar.c#L105>)

Initializes the environment and logs a warning if `FD_HAS_HOSTED` is not defined, then halts execution.
- **Inputs**:
    - `argc`: The count of command-line arguments.
    - `argv`: The array of command-line argument strings.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with `argc` and `argv`.
    - Logs a warning message indicating that the unit test requires `FD_HAS_HOSTED`.
    - Calls `fd_halt` to terminate the program execution.
    - Returns 0 to indicate successful execution.
- **Output**: Returns 0, indicating successful execution.



---
Made with ❤️ by [Driver](https://www.driver.ai/)