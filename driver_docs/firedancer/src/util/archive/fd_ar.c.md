<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for reading and parsing headers from ar archive files, including error handling and metadata extraction.

# Purpose
The code is a C module designed to read and interpret archive (`ar`) file headers. It provides functionality to initialize reading from an `ar` file and to read the next file entry within the archive. The module defines a structure `fd_ar_hdr_t` to represent the raw header of a file entry in the `ar` file, including fields such as file identifier, modification timestamp, owner ID, group ID, file mode, and file size. These fields are stored as ASCII strings and are converted to long integers using the [`fd_ar_ascii_to_long`](<#fd_ar_ascii_to_long>) function, which handles the conversion and error checking.

The module includes functions [`fd_ar_read_init`](<#fd_ar_read_init>) and [`fd_ar_read_next`](<#fd_ar_read_next>). The [`fd_ar_read_init`](<#fd_ar_read_init>) function checks the archive header magic to ensure the file is a valid `ar` archive. The [`fd_ar_read_next`](<#fd_ar_read_next>) function reads the next file header in the archive, parses its fields, and optionally stores the metadata in a `fd_ar_meta_t` structure. The code handles potential errors such as invalid input arguments, incorrect magic numbers, and conversion errors. The module is conditionally compiled to work only in hosted environments, as indicated by the `FD_HAS_HOSTED` preprocessor directive. If the target environment does not support hosted features, the functions return an error immediately.
# Imports and Dependencies

---
- `fd_ar.h`
- `stdio.h`
- `stdlib.h`
- `errno.h`


# Data Structures

---
### fd\_ar\_hdr
- **Type**: ``struct``
- **Members**:
    - `ident`: Array of characters representing the file identifier, which may not be null-terminated.
    - `mtime_dec`: Array of characters representing the file modification timestamp in ASCII decimal, which may not be null-terminated.
    - `uid_dec`: Array of characters representing the owner ID in ASCII decimal, which may not be null-terminated.
    - `gid_dec`: Array of characters representing the group ID in ASCII decimal, which may not be null-terminated.
    - `mode_oct`: Array of characters representing the file mode in ASCII octal, which may not be null-terminated.
    - `filesz_dec`: Array of characters representing the file size in ASCII decimal, which may not be null-terminated.
    - `magic`: Unsigned short integer that should equal `FD_AR_HDR_MAGIC`.
- **Description**: Represents the raw header of a file entry in an archive file, containing metadata such as file identifier, modification timestamp, owner and group IDs, file mode, and file size, all stored as character arrays that may not be null-terminated, along with a magic number for validation.


---
### fd\_ar\_hdr\_t
- **Type**: ``struct``
- **Members**:
    - `ident`: File identifier, which may not be '\0' terminated.
    - `mtime_dec`: File modification timestamp in ASCII decimal, which may not be '\0' terminated.
    - `uid_dec`: Owner ID in ASCII decimal, which may not be '\0' terminated.
    - `gid_dec`: Group ID in ASCII decimal, which may not be '\0' terminated.
    - `mode_oct`: File mode in ASCII octal, which may not be '\0' terminated.
    - `filesz_dec`: File size in ASCII decimal, which may not be '\0' terminated.
    - `magic`: A constant value equal to `FD_AR_HDR_MAGIC`.
- **Description**: Represents the raw header of a file entry in an ar file, containing fields for file identification, modification time, owner and group IDs, file mode, file size, and a magic number for validation. The fields are stored as character arrays and may not be null-terminated, requiring careful handling when converting to numeric values.


# Functions

---
### fd\_ar\_ascii\_to\_long<!-- {{#callable:fd_ar_ascii_to_long}} -->
[View Source →](<../../../../../src/util/archive/fd_ar.c#L62>)

Converts a string field to a long integer using a specified base, handling potential errors.
- **Inputs**:
    - `field`: A pointer to the character array representing the string to convert.
    - `width`: The number of characters in the field to consider, which must be less than 32.
    - `base`: The numerical base to use for conversion, which should be a valid base for `strtol`.
    - `_val`: A pointer to a long where the converted value will be stored.
- **Logic and Control Flow**:
    - Check if `width` is 32 or more; if so, return `EINVAL`.
    - Copy `width` characters from `field` to a local buffer `cstr` and null-terminate it.
    - Set `errno` to 0 and use `strtol` to convert `cstr` to a long integer, storing the result in `val`.
    - Check if `errno` is set after `strtol`; if so, return the error number.
    - Check if `cstr` is equal to `endptr` (indicating no conversion was performed); if so, return `EINVAL`.
    - Store the converted value in the location pointed to by `_val`.
    - Return 0 to indicate success.
- **Output**: Returns 0 on success, or an error code such as `EINVAL` or the value of `errno` if an error occurs during conversion.


---
### fd\_ar\_read\_init<!-- {{#callable:fd_ar_read_init}} -->
[View Source →](<../../../../../src/util/archive/fd_ar.c#L149>)

Initializes reading from an archive file stream by verifying the archive header magic.
- **Inputs**:
    - `_stream`: A pointer to a file stream (`void *`) that represents the archive file to read from.
- **Logic and Control Flow**:
    - Cast `_stream` to a `FILE *` type named `stream`.
    - Check if `stream` is `NULL`; if so, return `EINVAL`.
    - Read 8 bytes from `stream` into the `magic` array to check the archive header magic.
    - If reading fails, return `ENOENT` if end-of-file is reached, otherwise return `EIO`.
    - Compare the `magic` array with the expected archive header string `!<arch>\n`; if they do not match, return `EPROTO`.
    - If all checks pass, return 0 indicating successful initialization.
- **Output**: Returns 0 on successful initialization, or an error code (`EINVAL`, `ENOENT`, `EIO`, `EPROTO`) if an error occurs.


---
### fd\_ar\_read\_next<!-- {{#callable:fd_ar_read_next}} -->
[View Source →](<../../../../../src/util/archive/fd_ar.c#L150>)

Returns a constant value of 1 after executing a memory fence operation.
- **Inputs**:
    - `stream`: A pointer to a stream, which is not used in this function.
    - `meta`: A pointer to an `fd_ar_meta_t` structure, which is not used in this function.
- **Logic and Control Flow**:
    - The function takes two arguments, `stream` and `meta`, but does not use them.
    - A memory fence operation is executed using `FD_COMPILER_MFENCE()`.
    - The function returns a constant value of 1.
- **Output**: A constant integer value of 1.



---
Made with ❤️ by [Driver](https://www.driver.ai/)