<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for the `fd_spad` memory allocation and management functions, including alignment, allocation, and deallocation operations.

# Purpose
The code is a C test suite designed to validate the functionality of a memory management system, specifically focusing on a stack-based memory allocator (`spad`). The code includes various tests to ensure that memory allocation, deallocation, and alignment operations are performed correctly. It uses a series of assertions (`FD_TEST`) to verify that the memory operations conform to expected behaviors, such as alignment requirements and memory poisoning checks. The test suite also includes stress tests with random inputs to simulate different scenarios and edge cases, ensuring the robustness of the memory management system.

The code defines a main function that initializes the test environment, sets up random number generation, and iterates through a series of tests. These tests cover memory allocation with different alignments and sizes, the use of stack frames for memory management, and the behavior of the system under various conditions, such as pushing and popping memory frames. The code also includes tests for the constructors and destructors of the memory management system, ensuring that resources are correctly allocated and freed. Additionally, the code uses conditional compilation to include deep memory checks (`DEEPASAN`) if available, further enhancing the test coverage.
# Imports and Dependencies

---
- `../fd_util.h`


# Global Variables

---
### mem
- **Type**: ``uchar[]``
- **Description**: An array of unsigned characters with a size defined by `FOOTPRINT_MAX`, which is set to 1048576. The array is aligned according to `FD_SPAD_ALIGN` using the `__attribute__((aligned(FD_SPAD_ALIGN)))` directive.
- **Use**: Serves as a memory buffer for operations related to the `fd_spad` functions, providing aligned storage for memory allocation and management.


# Functions

---
### test\_spad\_deepasan\_allocation<!-- {{#callable:test_spad_deepasan_allocation}} -->
[View Source →](<../../../../../src/util/spad/test_spad.c#L26>)

Validates memory allocation and poisoning status for a given memory address in a shadow memory system.
- **Inputs**:
    - ``addr``: Pointer to the start of the allocated memory block.
    - ``sz``: Size of the allocated memory block in bytes.
    - ``is_first_alloc``: Flag indicating if this is the first allocation (1 for true, 0 for false).
- **Logic and Control Flow**:
    - If `is_first_alloc` is false, check that the byte before `addr` is poisoned using `fd_asan_test` and assert it returns 1.
    - Check that the memory block from `addr` to `addr + sz` is unpoisoned using `fd_asan_query` and assert it returns NULL.
    - Check that the byte immediately after the allocated block (`addr + sz`) is poisoned using `fd_asan_test` and assert it returns 1.
- **Output**: No return value; the function uses assertions to validate memory conditions.


---
### test\_spad\_deepasan<!-- {{#callable:test_spad_deepasan}} -->
[View Source →](<../../../../../src/util/spad/test_spad.c#L41>)

Tests various memory allocation, deallocation, and manipulation operations on a `fd_spad_t` structure using deep ASAN checks.
- **Inputs**:
    - `spad`: A pointer to a `fd_spad_t` structure, which represents a memory space allocator.
- **Logic and Control Flow**:
    - Calls `fd_spad_reset` to reset the memory allocator state.
    - Pushes the current state of the memory allocator with `fd_spad_push`.
    - Allocates a non-8-byte aligned memory block and tests its allocation using [`test_spad_deepasan_allocation`](<#test_spad_deepasan_allocation>).
    - Pushes the state again and tests allocation and trimming of memory blocks, ensuring correct poisoning and unpoisoning of memory regions.
    - Prepares a memory block, tests its cancellation, and verifies memory poisoning using `fd_spad_cancel`.
    - Prepares and publishes a memory block, verifying the allocation with [`test_spad_deepasan_allocation`](<#test_spad_deepasan_allocation>).
    - Tests the behavior of preparing, allocating, and trimming memory blocks, ensuring correct memory poisoning and frame high pointer adjustments.
    - Tests the prepare, push, and pop operations, ensuring memory regions are correctly poisoned and unpoisoned.
    - Pops the memory frame and verifies that memory regions are correctly poisoned after popping.
    - Resets the memory allocator state at the end.
- **Output**: No output is returned as the function is of type `void` and is used for testing purposes.
- **Functions Called**:
    - [`test_spad_deepasan_allocation`](<#test_spad_deepasan_allocation>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/util/spad/test_spad.c#L144>)

Executes a series of tests on memory allocation, alignment, and management using a shared memory allocator.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Initializes the environment and parses the '--mem-max' command-line argument to set the maximum memory size.
    - Logs the memory size being tested.
    - Initializes a random number generator for use in tests.
    - Performs a loop to test memory alignment and footprint calculations for 1,000,000 iterations.
    - Checks constructors for shared memory allocation and alignment, logging errors if conditions are not met.
    - Tests memory accessors to verify frame and memory usage statistics.
    - Performs allocation tests with different alignment and size parameters, validating the results.
    - Conducts a loop to test frame operations, including push and pop, and verifies memory integrity.
    - Tests the `FD_SPAD_FRAME_{BEGIN,END}` macros for frame management.
    - Optionally tests deep ASAN (AddressSanitizer) features if enabled.
    - Tests destructors for shared memory, ensuring proper cleanup and logging errors if necessary.
    - Deletes the random number generator and logs a success message before halting the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`test_spad_deepasan`](<#test_spad_deepasan>)


---
### FD\_SPAD\_FRAME\_BEGIN<!-- {{#callable:main::FD_SPAD_FRAME_BEGIN::FD_SPAD_FRAME_BEGIN}} -->
[View Source →](<../../../../../src/util/spad/test_spad.c#L364>)

Executes a loop that tests the state of a stack-based memory allocation frame and conditionally breaks out of the loop based on a random condition.
- **Inputs**:
    - `spad`: A pointer to a stack-based memory allocation frame.
- **Logic and Control Flow**:
    - Check if the current frame usage of `spad` is 2 using `FD_TEST(fd_spad_frame_used(spad)==2UL)`.
    - Enter a loop where a random condition is evaluated using `fd_rng_uint(rng) & 1U`.
    - If the random condition is true, break out of the loop.
    - Increment the `dummy[0]` variable if the loop does not break.
    - Recheck if the current frame usage of `spad` is still 2 using `FD_TEST(fd_spad_frame_used(spad)==2UL)` after the loop.
- **Output**: No direct output; the function modifies the state of the `spad` frame and potentially the `dummy` variable.



---
Made with ❤️ by [Driver](https://www.driver.ai/)