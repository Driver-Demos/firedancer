<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for sending and managing asynchronous I/O with PCAPNG format in a network context.

# Purpose
The code provides functionality for handling asynchronous input/output (AIO) operations with PCAP Next Generation (pcapng) files. It defines functions to send packets to a pcapng file, initialize pcapng file headers, and manage the lifecycle of a pcapng context. The primary function, [`fd_aio_pcapng_send`](<#fd_aio_pcapng_send>), writes packet data to a pcapng file and optionally forwards the packets to another destination if specified. The function uses a wall clock timestamp for each packet and logs warnings if writing fails.

The code also includes functions to start writing to a pcapng file with either Ethernet or raw link types, as seen in [`fd_aio_pcapng_start`](<#fd_aio_pcapng_start>) and [`fd_aio_pcapng_start_l3`](<#fd_aio_pcapng_start_l3>). The [`fd_aio_pcapng_join`](<#fd_aio_pcapng_join>) and [`fd_aio_pcapng_leave`](<#fd_aio_pcapng_leave>) functions manage the association and disassociation of a pcapng context with an AIO destination. The code is intended to be part of a larger system, as indicated by the inclusion of external headers and the use of a custom logging and error handling system. It does not define a public API but provides specific functionality for integrating pcapng file operations within an asynchronous I/O framework.
# Imports and Dependencies

---
- `fd_aio_pcapng.h`
- `../../util/net/fd_pcapng.h`
- `errno.h`


# Functions

---
### fd\_aio\_pcapng\_send<!-- {{#callable:fd_aio_pcapng_send}} -->
[View Source →](<../../../../../src/waltz/aio/fd_aio_pcapng.c#L8>)

Writes packet data to a pcapng file and optionally forwards it to another destination.
- **Inputs**:
    - `ctx`: A pointer to a `fd_aio_pcapng_t` structure that contains the context for the operation.
    - `batch`: A pointer to an array of `fd_aio_pkt_info_t` structures, each containing packet data to be processed.
    - `batch_cnt`: The number of packets in the `batch` array.
    - `opt_batch_idx`: An optional pointer to a variable that can store the index of the batch if needed.
    - `flush`: An integer flag indicating whether to flush the data.
- **Logic and Control Flow**:
    - Get the current wallclock timestamp using `fd_log_wallclock()`.
    - Cast the `ctx` pointer to a `fd_aio_pcapng_t` pointer named `mitm`.
    - Iterate over each packet in the `batch` array up to `batch_cnt`.
    - For each packet, call `fd_pcapng_fwrite_pkt` to write the packet data to the pcapng file using the timestamp, packet buffer, and buffer size.
    - If `fd_pcapng_fwrite_pkt` fails, log a warning message and break the loop.
    - If `mitm->dst` is not NULL, call [`fd_aio_send`](<fd_aio.h.md#fd_aio_send>) to forward the batch to the destination and return its result.
    - If `mitm->dst` is NULL, return `FD_AIO_SUCCESS`.
- **Output**: Returns `FD_AIO_SUCCESS` if successful, or the result of [`fd_aio_send`](<fd_aio.h.md#fd_aio_send>) if forwarding to another destination.
- **Functions Called**:
    - [`fd_aio_send`](<fd_aio.h.md#fd_aio_send>)


---
### fd\_aio\_pcapng\_get\_aio<!-- {{#callable:fd_aio_pcapng_get_aio}} -->
[View Source →](<../../../../../src/waltz/aio/fd_aio_pcapng.c#L34>)

Returns a pointer to the `local` member of the `fd_aio_pcapng_t` structure.
- **Inputs**:
    - `mitm`: A pointer to a constant `fd_aio_pcapng_t` structure.
- **Logic and Control Flow**:
    - Accesses the `local` member of the `fd_aio_pcapng_t` structure pointed to by `mitm`.
    - Returns the address of the `local` member.
- **Output**: A constant pointer to an `fd_aio_t` structure.


---
### fd\_aio\_pcapng\_start<!-- {{#callable:fd_aio_pcapng_start}} -->
[View Source →](<../../../../../src/waltz/aio/fd_aio_pcapng.c#L39>)

Initializes a PCAPNG file by writing the Section Header Block (SHB) and Interface Description Block (IDB) for Ethernet.
- **Inputs**:
    - `pcapng`: A pointer to the PCAPNG file or buffer where the SHB and IDB will be written.
- **Logic and Control Flow**:
    - Initialize `fd_pcapng_shb_opts_t` structure `shb_opts` to zero.
    - Call `fd_pcapng_shb_defaults` to set default values in `shb_opts`.
    - Write the Section Header Block (SHB) to `pcapng` using `fd_pcapng_fwrite_shb`. If this fails, return `0UL`.
    - Write the Interface Description Block (IDB) for Ethernet to `pcapng` using `fd_pcapng_fwrite_idb`. If this fails, return `0UL`.
    - Return `1UL` to indicate success.
- **Output**: Returns `1UL` on success, or `0UL` if writing the SHB or IDB fails.


---
### fd\_aio\_pcapng\_start\_l3<!-- {{#callable:fd_aio_pcapng_start_l3}} -->
[View Source →](<../../../../../src/waltz/aio/fd_aio_pcapng.c#L54>)

Initializes a PCAP-NG file for Layer 3 (network layer) packet capture by writing the Section Header Block (SHB) and Interface Description Block (IDB) with a RAW link type.
- **Inputs**:
    - `pcapng`: A pointer to the PCAP-NG file context where the SHB and IDB will be written.
- **Logic and Control Flow**:
    - Initialize `fd_pcapng_shb_opts_t` structure `shb_opts` to zero.
    - Call `fd_pcapng_shb_defaults` to set default values in `shb_opts`.
    - Write the Section Header Block (SHB) to `pcapng` using `fd_pcapng_fwrite_shb`. If this fails, return 0UL.
    - Write the Interface Description Block (IDB) with `FD_PCAPNG_LINKTYPE_RAW` to `pcapng` using `fd_pcapng_fwrite_idb`. If this fails, return 0UL.
    - If both writes succeed, return 1UL.
- **Output**: Returns 1UL if both the SHB and IDB are successfully written to the PCAP-NG file, otherwise returns 0UL.


---
### fd\_aio\_pcapng\_join<!-- {{#callable:fd_aio_pcapng_join}} -->
[View Source →](<../../../../../src/waltz/aio/fd_aio_pcapng.c#L69>)

Initializes and joins a `fd_aio_pcapng_t` structure with a destination and a pcapng context.
- **Inputs**:
    - `_mitm`: A pointer to a `fd_aio_pcapng_t` structure to initialize and join.
    - `dst`: A constant pointer to a `fd_aio_t` structure representing the destination for asynchronous I/O operations.
    - `pcapng`: A pointer to a pcapng context for packet capture operations.
- **Logic and Control Flow**:
    - Cast `_mitm` to a `fd_aio_pcapng_t` pointer and assign it to `mitm`.
    - Set the `dst` field of `mitm` to the provided `dst` argument.
    - Set the `pcapng` field of `mitm` to the provided `pcapng` argument.
    - Call [`fd_aio_new`](<fd_aio.c.md#fd_aio_new>) with `&mitm->local`, `mitm`, and `fd_aio_pcapng_send` to create a new asynchronous I/O object.
    - Call [`fd_aio_join`](<fd_aio.c.md#fd_aio_join>) with the result of [`fd_aio_new`](<fd_aio.c.md#fd_aio_new>) to join the asynchronous I/O object.
    - Return the initialized `mitm` structure.
- **Output**: Returns a pointer to the initialized `fd_aio_pcapng_t` structure.
- **Functions Called**:
    - [`fd_aio_join`](<fd_aio.c.md#fd_aio_join>)
    - [`fd_aio_new`](<fd_aio.c.md#fd_aio_new>)


---
### fd\_aio\_pcapng\_leave<!-- {{#callable:fd_aio_pcapng_leave}} -->
[View Source →](<../../../../../src/waltz/aio/fd_aio_pcapng.c#L83>)

Releases resources associated with a `fd_aio_pcapng_t` instance and resets its pointers.
- **Inputs**:
    - `mitm`: A pointer to a `fd_aio_pcapng_t` structure that represents the instance to leave.
- **Logic and Control Flow**:
    - Call [`fd_aio_leave`](<fd_aio.c.md#fd_aio_leave>) on the `local` member of `mitm` and pass its result to [`fd_aio_delete`](<fd_aio.c.md#fd_aio_delete>) to release resources.
    - Set the `dst` member of `mitm` to `NULL`.
    - Set the `pcapng` member of `mitm` to `NULL`.
    - Return the `mitm` pointer cast to `void *`.
- **Output**: Returns a `void *` pointer to the `mitm` structure after resetting its members.
- **Functions Called**:
    - [`fd_aio_delete`](<fd_aio.c.md#fd_aio_delete>)
    - [`fd_aio_leave`](<fd_aio.c.md#fd_aio_leave>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)