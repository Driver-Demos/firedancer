<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a man-in-the-middle asynchronous I/O for capturing packets to a PCAPNG file.

# Purpose
This C header file defines the interface for a module that implements a Man-in-the-Middle (MitM) asynchronous I/O (aio) mechanism for capturing network packets in the PCAP Next Generation (pcapng) format. The `fd_aio_pcapng` structure acts as an intermediary between a sender and receiver, logging all transmitted packets to a specified stream, typically a file. The module supports multiple writers on the same thread but does not support sharing a pcapng stream across threads. Key functions include [`fd_aio_pcapng_start`](<#fd_aio_pcapng_start>) for initializing a new pcapng section, [`fd_aio_pcapng_join`](<#fd_aio_pcapng_join>) for configuring a memory region to forward and log traffic, and [`fd_aio_pcapng_leave`](<#fd_aio_pcapng_leave>) for disconnecting the MitM object. The [`fd_aio_pcapng_get_aio`](<#fd_aio_pcapng_get_aio>) function provides access to the base aio class, ensuring that packets are logged even if write operations to the pcapng stream fail.
# Imports and Dependencies

---
- `fd_aio.h`


# Data Structures

---
### fd\_aio\_pcapng
- **Type**: ``struct``
- **Members**:
    - ``local``: An abstract base class of type `fd_aio_t`.
    - ``dst``: A pointer to an `fd_aio_t` object in the local address space.
    - ``pcapng``: A pointer to a stream object, typically a `FILE`.
- **Description**: Implements a man-in-the-middle asynchronous I/O (aio) that captures packets between a sender and receiver, logging them to a file in the PCAPNG format. It supports multiple writers on the same thread but does not support sharing across threads. Capture is unidirectional, requiring separate instances for duplex communication.


---
### fd\_aio\_pcapng\_t
- **Type**: ``struct``
- **Members**:
    - ``local``: Abstract base class of type `fd_aio_t`.
    - ``dst``: Pointer to an `fd_aio_t` in the local address space.
    - ``pcapng``: Pointer to a stream object, typically a `FILE`.
- **Description**: Implements a man-in-the-middle asynchronous I/O (aio) that captures packets between a sender and receiver to a file. It supports multiple writers on the same thread but does not support sharing across threads. Capture is unidirectional, requiring separate instances for duplex communication. The structure includes a local `fd_aio_t` base class, a destination `fd_aio_t` pointer, and a pointer to a stream object for packet capture.


# Function Declarations (Public API)

---
### fd\_aio\_pcapng\_start<!-- {{#callable_declaration:fd_aio_pcapng_start}} -->
[View Source →](<../../../../../src/waltz/aio/fd_aio_pcapng.h#L29>)

Starts a new PCAPNG section and defines an interface.
- **Description**: Use this function to initialize a new PCAPNG section and define a single interface on the provided PCAPNG stream handle. This is necessary if the stream does not already have a section header block (SHB) and interface description block (IDB). The function returns a success indicator and sets `errno` on failure, leaving the stream state undefined.
- **Inputs**:
    - `pcapng`: A pointer to the PCAPNG stream handle, typically a `FILE`. The caller must ensure this is a valid stream handle. Invalid or null pointers will result in failure.
- **Output**: Returns 1 on success. Returns 0 on failure and sets `errno`, leaving the stream state undefined.
- **See Also**: [`fd_aio_pcapng_start`](<fd_aio_pcapng.c.md#fd_aio_pcapng_start>)  (Implementation)


---
### fd\_aio\_pcapng\_start\_l3<!-- {{#callable_declaration:fd_aio_pcapng_start_l3}} -->
[View Source →](<../../../../../src/waltz/aio/fd_aio_pcapng.h#L40>)

Starts a new PCAPNG section and defines a single interface.
- **Description**: Use this function to start a new PCAPNG section and define a single interface on the given PCAPNG stream handle. This is necessary if the caller has not already created a section header block (SHB) and interface description block (IDB) pair. The function returns a success indicator and modifies the stream state, which becomes undefined on failure. Ensure that the stream handle is valid and ready for writing before calling this function.
- **Inputs**:
    - `pcapng`: A pointer to the PCAPNG stream handle, typically a FILE. The caller must ensure this handle is valid and ready for writing. The function does not take ownership of the handle.
- **Output**: Returns 1 on success. On failure, returns 0 and sets errno, leaving the stream state undefined.
- **See Also**: [`fd_aio_pcapng_start_l3`](<fd_aio_pcapng.c.md#fd_aio_pcapng_start_l3>)  (Implementation)


---
### fd\_aio\_pcapng\_join<!-- {{#callable_declaration:fd_aio_pcapng_join}} -->
[View Source →](<../../../../../src/waltz/aio/fd_aio_pcapng.h#L50>)

Formats a memory region for use as a packet capture middleman.
- **Description**: Use this function to configure a memory region to act as a middleman for packet capture, forwarding traffic to a specified destination and logging it to a provided stream handle. This function is useful when you need to capture network traffic between a sender and receiver while maintaining a transparent connection. Ensure that the `pcapng` stream has valid SHB and IDB headers before calling this function, as it relies on these headers to log traffic correctly. This function is not thread-safe for shared `pcapng` streams, so use separate streams or implement a buffering mechanism for multi-threaded environments.
- **Inputs**:
    - `mitm`: A pointer to a memory region that will be formatted as an `fd_aio_pcapng_t` structure. The caller must ensure this memory region meets the size and alignment requirements of `fd_aio_pcapng_t`.
    - `dst`: A pointer to an `fd_aio_t` structure representing the destination for forwarded traffic. This must not be null.
    - `pcapng`: A pointer to a stream handle (typically a `FILE`) where captured traffic will be logged. This must have valid SHB and IDB headers before calling this function.
- **Output**: Returns a pointer to the configured `fd_aio_pcapng_t` structure, which is ready to forward and log traffic.
- **See Also**: [`fd_aio_pcapng_join`](<fd_aio_pcapng.c.md#fd_aio_pcapng_join>)  (Implementation)


---
### fd\_aio\_pcapng\_leave<!-- {{#callable_declaration:fd_aio_pcapng_leave}} -->
[View Source →](<../../../../../src/waltz/aio/fd_aio_pcapng.h#L59>)

Leaves the current join to the MitM object.
- **Description**: Use this function to leave the current join to the `mitm` object. Before calling, ensure that all other objects configured to send to the aio provided by this `mitm` are disconnected. This function resets the `dst` and `pcapng` fields of the `mitm` structure to `NULL`, effectively disabling packet forwarding and logging. It returns a pointer to the `mitm` object for further use or cleanup.
- **Inputs**:
    - `mitm`: A pointer to an `fd_aio_pcapng_t` structure. This must not be null and should be a valid MitM object that was previously joined. The caller must ensure that no other objects are sending to this aio before calling this function.
- **Output**: Returns a pointer to the `mitm` object.
- **See Also**: [`fd_aio_pcapng_leave`](<fd_aio_pcapng.c.md#fd_aio_pcapng_leave>)  (Implementation)


---
### fd\_aio\_pcapng\_get\_aio<!-- {{#callable_declaration:fd_aio_pcapng_get_aio}} -->
[View Source →](<../../../../../src/waltz/aio/fd_aio_pcapng.h#L68>)

Returns the base class of a packet capture object.
- **Description**: Use this function to obtain the base `fd_aio_t` object from a `fd_aio_pcapng_t` instance. This is useful when you need to interact with the base class functionality of the packet capture object. The returned base class is valid for the duration of the join operation. Packets sent to this base class will be logged to the associated pcapng stream. If writing to the pcapng stream fails, the function will continue to forward packets and log warnings.
- **Inputs**:
    - `mitm`: A pointer to a `fd_aio_pcapng_t` object. This must not be null and must point to a valid packet capture object that has been properly initialized and joined.
- **Output**: A pointer to the `fd_aio_t` base class of the provided `fd_aio_pcapng_t` object.
- **See Also**: [`fd_aio_pcapng_get_aio`](<fd_aio_pcapng.c.md#fd_aio_pcapng_get_aio>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)