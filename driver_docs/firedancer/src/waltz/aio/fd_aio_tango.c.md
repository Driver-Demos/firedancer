<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements asynchronous I/O operations for sending and receiving packet data using a memory cache.

# Purpose
The code provides functionality for asynchronous input/output (AIO) operations in a network communication context. It defines functions and structures for sending and receiving data packets using a memory cache (`mcache`) and a data cache (`dcache`). The code includes functions to initialize and delete transmitter (`fd_aio_tango_tx_t`) and receiver (`fd_aio_tango_rx_t`) objects, which manage the state and operations for sending and receiving data fragments.

The [`fd_aio_tango_send1`](<#fd_aio_tango_send1>) function is responsible for sending a single packet by fragmenting it into smaller pieces if necessary, and publishing these fragments to the memory cache. The [`fd_aio_tango_send`](<#fd_aio_tango_send>) function handles sending a batch of packets by calling [`fd_aio_tango_send1`](<#fd_aio_tango_send1>) for each packet in the batch. The [`fd_aio_tango_rx_poll`](<#fd_aio_tango_rx_poll>) function is used to poll for incoming data fragments, assembling them into packets and sending them to a specified asynchronous I/O interface. The code is structured to handle packet fragmentation and reassembly, ensuring data integrity and order during transmission and reception.
# Imports and Dependencies

---
- `fd_aio_tango.h`


# Functions

---
### fd\_aio\_tango\_send1<!-- {{#callable:fd_aio_tango_send1}} -->
[View Source →](<../../../../../src/waltz/aio/fd_aio_tango.c#L3>)

Sends a packet by fragmenting it into smaller chunks and publishing each fragment to a memory cache.
- **Inputs**:
    - `self`: A pointer to an `fd_aio_tango_tx_t` structure containing transmission context and metadata.
    - `pkt`: A pointer to a `fd_aio_pkt_info_t` structure containing the packet buffer and its size.
- **Logic and Control Flow**:
    - Initialize local variables from the `self` and `pkt` structures, including cache pointers, buffer base, and packet data.
    - Calculate the current timestamp using `fd_frag_meta_ts_comp` and `fd_tickcount`.
    - Set the start-of-message (`som`) flag to 1 and end-of-message (`eom`) flag to 0.
    - Enter a loop that continues until the entire packet is sent (i.e., `eom` is true).
    - In each iteration, calculate the fragment size as the minimum of the remaining data size and the maximum transmission unit (`mtu`).
    - Convert the current chunk index to a local address using `fd_chunk_to_laddr`.
    - Determine if the current fragment is the end of the message by comparing `frag_sz` and `data_sz`.
    - Create a control word using `fd_frag_meta_ctl` with the original sequence, `som`, `eom`, and error flags.
    - Copy the fragment data to the calculated local address using `fd_memcpy`.
    - Publish the fragment metadata to the memory cache using `fd_mcache_publish`.
    - Increment the sequence number using `fd_seq_inc`.
    - Calculate the next chunk index using `fd_dcache_compact_next`.
    - Update the data pointer and size to reflect the sent fragment.
    - Set `som` to 0 for subsequent fragments.
    - Repeat the loop if `eom` is false.
- **Output**: No return value; the function operates by side effects on the `self` structure and the memory cache.


---
### fd\_aio\_tango\_send<!-- {{#callable:fd_aio_tango_send}} -->
[View Source →](<../../../../../src/waltz/aio/fd_aio_tango.c#L39>)

Sends a batch of packets using the [`fd_aio_tango_send1`](<#fd_aio_tango_send1>) function for each packet in the batch.
- **Inputs**:
    - `ctx`: A context pointer passed to the [`fd_aio_tango_send1`](<#fd_aio_tango_send1>) function.
    - `batch`: A pointer to an array of `fd_aio_pkt_info_t` structures representing the batch of packets to send.
    - `batch_cnt`: The number of packets in the batch.
    - `opt_batch_idx`: An optional pointer to a `ulong` that is not used in this function.
    - `flush`: An integer that is not used in this function, as the function always immediately publishes to mcache.
- **Logic and Control Flow**:
    - Ignores `opt_batch_idx` and `flush` as they are not used in the function.
    - Iterates over each packet in the `batch` using a for loop with index `j` from 0 to `batch_cnt - 1`.
    - Calls [`fd_aio_tango_send1`](<#fd_aio_tango_send1>) with `ctx` and the current packet `batch+j`.
    - Returns `FD_AIO_SUCCESS` after processing all packets.
- **Output**: Returns `FD_AIO_SUCCESS` to indicate successful processing of the batch.
- **Functions Called**:
    - [`fd_aio_tango_send1`](<#fd_aio_tango_send1>)


---
### fd\_aio\_tango\_tx\_new<!-- {{#callable:fd_aio_tango_tx_new}} -->
[View Source →](<../../../../../src/waltz/aio/fd_aio_tango.c#L53>)

Initializes a `fd_aio_tango_tx_t` structure with provided metadata and configuration parameters for asynchronous I/O operations.
- **Inputs**:
    - `self`: A pointer to a `fd_aio_tango_tx_t` structure to initialize.
    - `mcache`: A pointer to a `fd_frag_meta_t` structure representing the metadata cache.
    - `dcache`: A pointer to a data cache.
    - `base`: A pointer to the base address for data operations.
    - `mtu`: The maximum transmission unit size.
    - `orig`: The origin identifier for the transmission.
    - `sig`: The signature for the transmission.
- **Logic and Control Flow**:
    - Calculate the depth of the metadata cache using `fd_mcache_depth` and store it in `depth`.
    - Determine the initial chunk index using `fd_dcache_compact_chunk0` and store it in `chunk`.
    - Calculate the watermark using `fd_dcache_compact_wmark` and store it in `wmark`.
    - Get the initial sequence number from the metadata cache using `fd_mcache_seq0` and store it in `seq`.
    - Assign the calculated values and input parameters to the `fd_aio_tango_tx_t` structure pointed to by `self`.
    - Initialize the asynchronous I/O operation using [`fd_aio_new`](<fd_aio.c.md#fd_aio_new>) with the `fd_aio_tango_send` function.
    - Return the pointer to the initialized `fd_aio_tango_tx_t` structure.
- **Output**: A pointer to the initialized `fd_aio_tango_tx_t` structure.
- **Functions Called**:
    - [`fd_aio_new`](<fd_aio.c.md#fd_aio_new>)


---
### fd\_aio\_tango\_tx\_delete<!-- {{#callable:fd_aio_tango_tx_delete}} -->
[View Source →](<../../../../../src/waltz/aio/fd_aio_tango.c#L82>)

Deletes the asynchronous I/O transaction object and returns a pointer to it.
- **Inputs**:
    - `self`: A pointer to the `fd_aio_tango_tx_t` object to delete.
- **Logic and Control Flow**:
    - Calls [`fd_aio_delete`](<fd_aio.c.md#fd_aio_delete>) to delete the asynchronous I/O object within `self`.
    - Returns the pointer `self`.
- **Output**: A pointer to the `fd_aio_tango_tx_t` object that was deleted.
- **Functions Called**:
    - [`fd_aio_delete`](<fd_aio.c.md#fd_aio_delete>)


---
### fd\_aio\_tango\_rx\_new<!-- {{#callable:fd_aio_tango_rx_new}} -->
[View Source →](<../../../../../src/waltz/aio/fd_aio_tango.c#L89>)

Initializes a `fd_aio_tango_rx_t` structure with specified parameters and returns a pointer to it.
- **Inputs**:
    - `self`: A pointer to a `fd_aio_tango_rx_t` structure to initialize.
    - `aio`: A constant pointer to a `fd_aio_t` structure.
    - `mcache`: A constant pointer to a `fd_frag_meta_t` structure representing the metadata cache.
    - `seq0`: An unsigned long integer representing the initial sequence number.
    - `base`: A pointer to a base address for data operations.
- **Logic and Control Flow**:
    - Calls `fd_mcache_depth` to get the depth of the metadata cache from `mcache` and stores it in `depth`.
    - Assigns values to the `fd_aio_tango_rx_t` structure pointed to by `self`, including `mcache`, `depth`, `base`, `seq0`, and `aio`.
    - Returns the pointer `self`.
- **Output**: Returns a pointer to the initialized `fd_aio_tango_rx_t` structure.


---
### fd\_aio\_tango\_rx\_delete<!-- {{#callable:fd_aio_tango_rx_delete}} -->
[View Source →](<../../../../../src/waltz/aio/fd_aio_tango.c#L106>)

Returns the input `fd_aio_tango_rx_t` pointer without modification.
- **Inputs**:
    - `self`: A pointer to an `fd_aio_tango_rx_t` structure that is to be deleted.
- **Logic and Control Flow**:
    - The function takes a pointer to an `fd_aio_tango_rx_t` structure as input.
    - It returns the same pointer without performing any operations on it.
- **Output**: A pointer to the `fd_aio_tango_rx_t` structure that was passed as input.


---
### fd\_aio\_tango\_rx\_poll<!-- {{#callable:fd_aio_tango_rx_poll}} -->
[View Source →](<../../../../../src/waltz/aio/fd_aio_tango.c#L111>)

Polls for incoming data fragments, processes them, and sends them to an asynchronous I/O interface.
- **Inputs**:
    - `self`: A pointer to an `fd_aio_tango_rx_t` structure containing the metadata cache, depth, base address, and asynchronous I/O interface.
- **Logic and Control Flow**:
    - Initialize a batch array to store packet information and set `batch_idx` to 0.
    - Loop up to `RX_BATCH` times to poll for the next data fragment.
    - Calculate the expected sequence number and retrieve the corresponding metadata line from the cache.
    - Use memory fences to ensure proper ordering of memory operations.
    - Check if the sequence numbers match; if not, break the loop due to an overrun.
    - If the expected sequence number is greater than the found sequence number, break the loop as the receiver has caught up.
    - If the expected sequence number is less than the found sequence number, update the sequence number in `self` and break the loop due to an overrun.
    - Check for errors in the control field or if the start of message bit is not set; if so, decrement `batch_idx` to retry the current index.
    - If no errors, store the buffer address and size in the batch array.
    - Increment the expected sequence number for the next iteration.
    - After the loop, send the batch of packets using the asynchronous I/O interface.
- **Output**: No return value; the function operates on the `self` structure and sends data through the asynchronous I/O interface.
- **Functions Called**:
    - [`fd_aio_send`](<fd_aio.h.md#fd_aio_send>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)