<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for loading and translating IPv4 routing tables using Netlink on Linux systems.

# Purpose
The code is a C source file that provides functionality for interacting with the Linux kernel's routing table using the Netlink protocol. It is designed to work specifically on Linux systems, as indicated by the preprocessor directive that checks for the Linux environment. The file includes functions to parse and translate routing attributes from Netlink messages into a format suitable for use in a Forwarding Information Base (FIB) for IPv4 routing. The primary functions include [`fd_fib4_netlink_translate`](<#fd_fib4_netlink_translate>), which processes Netlink messages to extract routing information, and [`fd_fib4_netlink_load_table`](<#fd_fib4_netlink_load_table>), which sends a request to the kernel to dump the routing table and processes the response.

The code defines static functions to handle specific routing attributes such as gateway, output interface, and preferred source address. It uses assertions to ensure that certain route types match expected values. The file also includes error handling and logging to manage various conditions, such as unsupported route types or parsing errors. The function [`fd_fib4_netlink_strerror`](<#fd_fib4_netlink_strerror>) provides string representations of error codes related to Netlink operations. This code is intended to be part of a larger system that manages routing information, and it interfaces with other components through the use of structures and functions defined in included headers.
# Imports and Dependencies

---
- `fd_fib4_netlink.h`
- `fd_fib4.h`
- `fd_netlink1.h`
- `errno.h`
- `linux/netlink.h`
- `linux/rtnetlink.h`
- `arpa/inet.h`
- `../../util/fd_util.h`


# Functions

---
### fd\_fib4\_rta\_gateway<!-- {{#callable:fd_fib4_rta_gateway}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4_netlink.c#L23>)

Parses a 4-byte RTA_GATEWAY attribute from a routing table entry and updates the gateway IP address in the `fd_fib4_hop_t` structure.
- **Inputs**:
    - ``hop``: A pointer to an `fd_fib4_hop_t` structure where the parsed gateway IP address will be stored.
    - ``rta``: A pointer to the routing table attribute data to be parsed.
    - ``rta_sz``: The size of the routing table attribute data, expected to be 4 bytes.
- **Logic and Control Flow**:
    - Check if `rta_sz` is not equal to 4; if true, log a debug message, set the parse error flag in `hop->flags`, and return.
    - Load a 4-byte big-endian IP address from `rta` using `FD_LOAD` and store it in `hop->ip4_gw`.
- **Output**: No return value; updates the `ip4_gw` field of the `fd_fib4_hop_t` structure and may set a flag in `hop->flags` if a parse error occurs.


---
### fd\_fib4\_rta\_oif<!-- {{#callable:fd_fib4_rta_oif}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4_netlink.c#L36>)

Parses the RTA_OIF attribute from a routing table entry and updates the `fd_fib4_hop_t` structure with the interface index.
- **Inputs**:
    - `hop`: A pointer to an `fd_fib4_hop_t` structure that will be updated with the parsed interface index.
    - `rta`: A pointer to the routing table attribute data to be parsed.
    - `rta_sz`: The size of the routing table attribute data, expected to be 4 bytes.
- **Logic and Control Flow**:
    - Check if `rta_sz` is not equal to 4; if true, log a debug message, set the `FD_FIB4_FLAG_RTA_PARSE_ERR` flag in `hop->flags`, and return.
    - If `rta_sz` is 4, load the interface index from `rta` using `FD_LOAD` and store it in `hop->if_idx`.
- **Output**: No return value; updates the `hop` structure in place.


---
### fd\_fib4\_rta\_prefsrc<!-- {{#callable:fd_fib4_rta_prefsrc}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4_netlink.c#L48>)

Parses the preferred source IP address from a routing attribute and updates the `fd_fib4_hop_t` structure.
- **Inputs**:
    - `hop`: A pointer to an `fd_fib4_hop_t` structure that will be updated with the preferred source IP address.
    - `rta`: A pointer to the routing attribute data containing the preferred source IP address.
    - `rta_sz`: The size of the routing attribute data, expected to be 4 bytes.
- **Logic and Control Flow**:
    - Check if `rta_sz` is not equal to 4; if true, log a debug message, set the parse error flag in `hop->flags`, and return.
    - Load the preferred source IP address from `rta` using `FD_LOAD` and store it in `hop->ip4_src`.
- **Output**: No return value; updates the `fd_fib4_hop_t` structure with the preferred source IP address or sets an error flag if parsing fails.


---
### fd\_fib4\_netlink\_translate<!-- {{#callable:fd_fib4_netlink_translate}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4_netlink.c#L60>)

Translates a Netlink message into a routing table entry and inserts it into the IPv4 FIB.
- **Inputs**:
    - ``fib``: A pointer to the `fd_fib4_t` structure where the routing entry will be inserted.
    - ``msg_hdr``: A constant pointer to a `nlmsghdr` structure containing the Netlink message header.
    - ``table_id``: An unsigned integer representing the ID of the routing table to which the entry belongs.
- **Logic and Control Flow**:
    - Initialize variables for destination IP, prefix, priority, and a hop structure.
    - Extract the `rtmsg` and `rtattr` from the Netlink message header.
    - Check if the route is cloned or if the table ID does not match; return 0 if true.
    - Determine the route type and set the hop type accordingly, logging unsupported types as blackholes.
    - Iterate over route attributes, processing each based on its type (e.g., gateway, destination, output interface, preferred source, priority, table).
    - For unsupported or malformed attributes, log a debug message and set the appropriate flags.
    - Insert the parsed route into the FIB using [`fd_fib4_insert`](<fd_fib4.c.md#fd_fib4_insert>); return `ENOSPC` if insertion fails due to lack of space.
    - Return 0 on successful translation and insertion.
- **Output**: Returns 0 on success or `ENOSPC` if there is no space to insert the route.
- **Functions Called**:
    - [`fd_netlink_rtm_type_str`](<fd_netlink1.c.md#fd_netlink_rtm_type_str>)
    - [`fd_fib4_rta_gateway`](<#fd_fib4_rta_gateway>)
    - [`fd_fib4_rta_oif`](<#fd_fib4_rta_oif>)
    - [`fd_fib4_rta_prefsrc`](<#fd_fib4_rta_prefsrc>)
    - [`fd_netlink_rtattr_str`](<fd_netlink1.c.md#fd_netlink_rtattr_str>)
    - [`fd_fib4_insert`](<fd_fib4.c.md#fd_fib4_insert>)


---
### fd\_fib4\_netlink\_load\_table<!-- {{#callable:fd_fib4_netlink_load_table}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4_netlink.c#L162>)

Loads an IPv4 routing table from a Netlink socket into a FIB structure.
- **Inputs**:
    - ``fib``: A pointer to an `fd_fib4_t` structure where the routing table will be loaded.
    - ``netlink``: A pointer to an `fd_netlink_t` structure representing the Netlink socket used for communication.
    - ``table_id``: An unsigned integer representing the ID of the routing table to load.
- **Logic and Control Flow**:
    - Increment the sequence number in the `netlink` structure.
    - Initialize a request structure with Netlink headers and the specified `table_id`.
    - Send the request to the Netlink socket using `sendto` and check for errors.
    - Clear the existing routing table in `fib`.
    - Initialize a buffer and an iterator for reading Netlink messages.
    - Iterate over the Netlink messages received, checking for errors and processing each route message.
    - Translate each route message into the `fib` structure using [`fd_fib4_netlink_translate`](<#fd_fib4_netlink_translate>).
    - Check for errors such as insufficient space, interrupted dumps, or unexpected message types.
    - Drain any remaining messages from the Netlink socket.
    - Return appropriate error codes or success based on the operations performed.
- **Output**: Returns 0 on success or an error code on failure, indicating the type of error encountered.
- **Functions Called**:
    - [`fd_fib4_clear`](<fd_fib4.c.md#fd_fib4_clear>)
    - [`fd_netlink_iter_init`](<fd_netlink1.c.md#fd_netlink_iter_init>)
    - [`fd_netlink_iter_done`](<fd_netlink1.c.md#fd_netlink_iter_done>)
    - [`fd_netlink_iter_next`](<fd_netlink1.c.md#fd_netlink_iter_next>)
    - [`fd_netlink_iter_msg`](<fd_netlink1.h.md#fd_netlink_iter_msg>)
    - [`fd_fib4_netlink_translate`](<#fd_fib4_netlink_translate>)
    - [`fd_netlink_iter_drain`](<fd_netlink1.h.md#fd_netlink_iter_drain>)
    - [`fd_fib4_max`](<fd_fib4.c.md#fd_fib4_max>)


---
### fd\_fib4\_netlink\_strerror<!-- {{#callable:fd_fib4_netlink_strerror}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4_netlink.c#L254>)

Maps error codes to their corresponding error message strings.
- **Inputs**:
    - `err`: An integer representing the error code to be translated into a string message.
- **Logic and Control Flow**:
    - Use a switch statement to match the input error code `err` against predefined error codes.
    - Return the corresponding string message for each matched error code.
    - If the error code does not match any predefined cases, return the string "unknown".
- **Output**: A constant character pointer to a string that describes the error message corresponding to the input error code.



---
Made with ❤️ by [Driver](https://www.driver.ai/)