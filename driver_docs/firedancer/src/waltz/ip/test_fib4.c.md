<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for the `fd_fib4` module, including insertion, lookup, and edge cases for IPv4 routing.

# Purpose
The code is a C program designed to test the functionality of a Forwarding Information Base (FIB) for IPv4 routing, specifically using a data structure referred to as `fd_fib4`. The program includes a series of test functions that validate various aspects of the FIB's behavior, such as insertion, lookup, capacity handling, precedence of routes, handling of special IP addresses, and duplicate entries. The tests are organized into functions like [`test_fib4_hmap_precedence`](<#test_fib4_hmap_precedence>), [`test_fib4_hmap_capacity`](<#test_fib4_hmap_capacity>), and others, each focusing on a specific aspect of the FIB's functionality.

The program is structured to be executed as a standalone application, with a [`main`](<#main>) function that initializes the environment, sets up memory for the FIB, and runs the test suite. The tests use a combination of static memory allocation and dynamic operations to simulate real-world routing scenarios, including default routes, subnet routes, and host-specific routes. The program also includes conditional compilation to handle different environments, such as hosted and non-hosted systems, and uses a series of assertions (`FD_TEST`) to verify the correctness of operations. The code is intended to ensure that the FIB implementation behaves as expected under various conditions, providing a robust test suite for developers working with this routing data structure.
# Imports and Dependencies

---
- `fd_fib4_private.h`
- `fd_fib4.h`
- `../../util/fd_util.h`
- `../../util/net/fd_ip4.h`
- `stdio.h`


# Global Variables

---
### fib1\_mem
- **Type**: ``uchar[]``
- **Description**: An array of unsigned characters with a size of 2^18 bytes, aligned according to `FD_FIB4_ALIGN`. This alignment ensures that the memory is properly structured for operations that require specific memory boundaries.
- **Use**: Used as a memory buffer for operations related to the `fd_fib4` data structure.


---
### fib2\_mem
- **Type**: `uchar`
- **Description**: An array of unsigned characters with a size of 2^18 bytes, aligned according to the `FD_FIB4_ALIGN` attribute.
- **Use**: Used as a memory buffer for operations related to the `fd_fib4` data structure.


# Functions

---
### test\_fib\_print<!-- {{#callable:test_fib_print}} -->
[View Source →](<../../../../../src/waltz/ip/test_fib4.c#L16>)

Compares the output of [`fd_fib4_fprintf`](<fd_fib4.c.md#fd_fib4_fprintf>) with an expected string and logs an error if they do not match.
- **Inputs**:
    - ``fib``: A pointer to a `fd_fib4_t` structure representing the FIB (Forwarding Information Base) to be printed.
    - ``actual``: A pointer to a string containing the expected output for comparison.
- **Logic and Control Flow**:
    - Opens a memory stream `dump` using `fmemopen` with `dump_buf` as the buffer.
    - Calls [`fd_fib4_fprintf`](<fd_fib4.c.md#fd_fib4_fprintf>) to print the FIB to the `dump` stream and checks if it returns 0.
    - Determines the size of the output by calling `ftell` on `dump`.
    - Closes the `dump` stream using `fclose`.
    - Compares the content of `dump_buf` with `actual` using `strncmp`.
    - If the contents do not match, writes `dump_buf` to `stderr` and logs an error message.
- **Output**: No return value; outputs error information to `stderr` if the comparison fails.
- **Functions Called**:
    - [`fd_fib4_fprintf`](<fd_fib4.c.md#fd_fib4_fprintf>)


---
### test\_fib4\_hmap\_precedence<!-- {{#callable:test_fib4_hmap_precedence}} -->
[View Source →](<../../../../../src/waltz/ip/test_fib4.c#L39>)

Tests the precedence of specific host routes in a hashmap over broader routes in a routing table for IPv4 forwarding information base.
- **Inputs**:
    - `fib`: A pointer to an `fd_fib4_t` structure representing the IPv4 forwarding information base.
- **Logic and Control Flow**:
    - Check if `fib` is not null using `FD_TEST` and clear the forwarding information base with [`fd_fib4_clear`](<fd_fib4.c.md#fd_fib4_clear>).
    - Define `target_ip` as the IP address `10.0.0.100`.
    - Create a broad route `route_hop` with source IP `10.0.0.2`, unicast type, interface index 1, and gateway IP `10.0.0.1`.
    - Insert the broad route into the routing table with a prefix length of 24 and a metric of 100 using [`fd_fib4_insert`](<fd_fib4.c.md#fd_fib4_insert>).
    - Perform a lookup for `target_ip` and verify that the lookup result matches `route_hop` using `FD_TEST`.
    - Create a specific host route `hmap_hop` with source IP `10.0.0.3`, unicast type, interface index 2, and gateway IP `10.0.0.2`.
    - Insert the specific host route into the hashmap with a prefix length of 32 and a metric of 0 using [`fd_fib4_insert`](<fd_fib4.c.md#fd_fib4_insert>).
    - Perform a lookup for `target_ip` again and verify that the lookup result matches `hmap_hop`, confirming hashmap precedence.
    - Define `other_ip` as the IP address `10.0.0.101` and perform a lookup to verify that it still uses the broad route `route_hop`.
- **Output**: No return value; the function performs tests and uses `FD_TEST` to assert conditions.
- **Functions Called**:
    - [`fd_fib4_clear`](<fd_fib4.c.md#fd_fib4_clear>)
    - [`fd_fib4_insert`](<fd_fib4.c.md#fd_fib4_insert>)
    - [`fd_fib4_lookup`](<fd_fib4.c.md#fd_fib4_lookup>)


---
### test\_fib4\_hmap\_capacity<!-- {{#callable:test_fib4_hmap_capacity}} -->
[View Source →](<../../../../../src/waltz/ip/test_fib4.c#L83>)

Tests the capacity limits of a FIB4 hashmap by inserting entries until full and verifying behavior when attempting to exceed capacity.
- **Inputs**:
    - ``fib``: A pointer to an `fd_fib4_t` structure representing the FIB4 hashmap to test.
- **Logic and Control Flow**:
    - Check if `fib` is valid and clear its contents using [`fd_fib4_clear`](<fd_fib4.c.md#fd_fib4_clear>).
    - Initialize a `fd_fib4_hop_t` structure `hop` with specific IP and routing information.
    - Determine the maximum number of entries for the hashmap (`hmap_max`) and the routing table (`table_max`) using [`fd_fib4_peer_max`](<fd_fib4.c.md#fd_fib4_peer_max>) and [`fd_fib4_max`](<fd_fib4.c.md#fd_fib4_max>).
    - Set a base IP address `ip_base` for insertion.
    - Insert entries into the hashmap up to its capacity (`hmap_max`) using a loop and [`fd_fib4_insert`](<fd_fib4.c.md#fd_fib4_insert>).
    - Attempt to insert one more entry beyond the hashmap capacity and verify it fails, expecting [`fd_fib4_insert`](<fd_fib4.c.md#fd_fib4_insert>) to return 0.
    - Insert entries into the routing table up to its capacity (`table_max-1`) and verify each insertion by looking up the entry and checking its properties against `hop`.
    - Attempt to insert one more entry beyond the routing table capacity and verify it fails, expecting [`fd_fib4_insert`](<fd_fib4.c.md#fd_fib4_insert>) to return 0.
    - Verify that all inserted routes are still accessible by looking them up and checking their properties against `hop`.
    - Verify that routes not inserted cannot be found, expecting [`fd_fib4_lookup`](<fd_fib4.c.md#fd_fib4_lookup>) to return a hop with `rtype` set to `FD_FIB4_RTYPE_THROW`.
- **Output**: No return value; the function uses assertions (`FD_TEST`) to validate behavior and will log errors if tests fail.
- **Functions Called**:
    - [`fd_fib4_clear`](<fd_fib4.c.md#fd_fib4_clear>)
    - [`fd_fib4_peer_max`](<fd_fib4.c.md#fd_fib4_peer_max>)
    - [`fd_fib4_max`](<fd_fib4.c.md#fd_fib4_max>)
    - [`fd_fib4_insert`](<fd_fib4.c.md#fd_fib4_insert>)
    - [`fd_fib4_lookup`](<fd_fib4.c.md#fd_fib4_lookup>)


---
### test\_fib4\_hmap\_edge\_cases<!-- {{#callable:test_fib4_hmap_edge_cases}} -->
[View Source →](<../../../../../src/waltz/ip/test_fib4.c#L141>)

Tests the insertion and lookup of special IP addresses in a FIB4 hashmap.
- **Inputs**:
    - ``fib``: A pointer to an `fd_fib4_t` structure representing the FIB4 hashmap to test.
- **Logic and Control Flow**:
    - Check if `fib` is not null using `FD_TEST` macro.
    - Clear the FIB4 hashmap using [`fd_fib4_clear`](<fd_fib4.c.md#fd_fib4_clear>).
    - Initialize a `fd_fib4_hop_t` structure `hop` with a specific IP source, route type as unicast, and interface index 1.
    - Define an array `special_ips` containing special IP addresses to test.
    - Iterate over each IP address in `special_ips`.
    - For each IP, insert it into the FIB4 hashmap with a prefix length of 32 and the `hop` structure using [`fd_fib4_insert`](<fd_fib4.c.md#fd_fib4_insert>).
    - Perform a lookup for each IP in the FIB4 hashmap using [`fd_fib4_lookup`](<fd_fib4.c.md#fd_fib4_lookup>) and store the result in `lookup_hop`.
    - Verify that the `rtype` and `if_idx` of `lookup_hop` match those of `hop` using `FD_TEST`.
- **Output**: No return value; the function performs tests and uses assertions to validate behavior.
- **Functions Called**:
    - [`fd_fib4_clear`](<fd_fib4.c.md#fd_fib4_clear>)
    - [`fd_fib4_insert`](<fd_fib4.c.md#fd_fib4_insert>)
    - [`fd_fib4_lookup`](<fd_fib4.c.md#fd_fib4_lookup>)


---
### test\_fib4\_hmap\_duplicates<!-- {{#callable:test_fib4_hmap_duplicates}} -->
[View Source →](<../../../../../src/waltz/ip/test_fib4.c#L170>)

Tests the behavior of inserting duplicate entries into a FIB4 hashmap and verifies that the second entry overwrites the first.
- **Inputs**:
    - ``fib``: A pointer to an `fd_fib4_t` structure representing the FIB4 hashmap to test.
- **Logic and Control Flow**:
    - Check if `fib` is valid using `FD_TEST` macro.
    - Clear the FIB4 hashmap using [`fd_fib4_clear`](<fd_fib4.c.md#fd_fib4_clear>).
    - Verify that the count of entries in the FIB4 hashmap is 1 using [`fd_fib4_cnt`](<fd_fib4.c.md#fd_fib4_cnt>).
    - Define an IP address `ip` using `FD_IP4_ADDR` macro.
    - Create two `fd_fib4_hop_t` structures, `hop1` and `hop2`, with different source IPs, interface indices, and gateway IPs.
    - Insert `hop1` into the FIB4 hashmap for the IP address `ip` using [`fd_fib4_insert`](<fd_fib4.c.md#fd_fib4_insert>).
    - Verify that the inserted hop matches `hop1` by looking it up and comparing its fields.
    - Insert `hop2` into the FIB4 hashmap for the same IP address `ip`, which should overwrite the existing entry.
    - Verify that the inserted hop now matches `hop2` by looking it up and comparing its fields.
- **Output**: No output is returned; the function uses assertions to verify correct behavior.
- **Functions Called**:
    - [`fd_fib4_clear`](<fd_fib4.c.md#fd_fib4_clear>)
    - [`fd_fib4_cnt`](<fd_fib4.c.md#fd_fib4_cnt>)
    - [`fd_fib4_insert`](<fd_fib4.c.md#fd_fib4_insert>)
    - [`fd_fib4_lookup`](<fd_fib4.c.md#fd_fib4_lookup>)


---
### test\_fib4\_hmap\_clear<!-- {{#callable:test_fib4_hmap_clear}} -->
[View Source →](<../../../../../src/waltz/ip/test_fib4.c#L212>)

Clears a FIB4 structure, inserts entries into both the hashmap and routing table, verifies their existence, clears them again, and verifies their removal.
- **Inputs**:
    - `fib`: A pointer to an `fd_fib4_t` structure representing the FIB4 instance to be tested and cleared.
- **Logic and Control Flow**:
    - Check if `fib` is not null using `FD_TEST` macro.
    - Clear the FIB4 structure using [`fd_fib4_clear`](<fd_fib4.c.md#fd_fib4_clear>).
    - Define a `fd_fib4_hop_t` structure `hop` with specific IP source, route type, and interface index.
    - Insert an entry into the hashmap with IP `10.0.0.1` and verify insertion using `FD_TEST`.
    - Insert an entry into the routing table with IP `192.168.0.0` and verify insertion using `FD_TEST`.
    - Perform a lookup for the hashmap entry and verify the returned hop matches the inserted hop.
    - Perform a lookup for the routing table entry and verify the returned hop matches the inserted hop.
    - Clear the FIB4 structure again using [`fd_fib4_clear`](<fd_fib4.c.md#fd_fib4_clear>).
    - Perform lookups for both previously inserted entries and verify they return `FD_FIB4_RTYPE_THROW`, indicating they are removed.
- **Output**: No return value; the function performs tests and uses assertions to verify behavior.
- **Functions Called**:
    - [`fd_fib4_clear`](<fd_fib4.c.md#fd_fib4_clear>)
    - [`fd_fib4_insert`](<fd_fib4.c.md#fd_fib4_insert>)
    - [`fd_fib4_lookup`](<fd_fib4.c.md#fd_fib4_lookup>)


---
### test\_fib4\_hmap\_counts<!-- {{#callable:test_fib4_hmap_counts}} -->
[View Source →](<../../../../../src/waltz/ip/test_fib4.c#L250>)

Tests the count of entries in a FIB4 structure after inserting entries into both the hashmap and routing table.
- **Inputs**:
    - `fib`: A pointer to an `fd_fib4_t` structure representing the FIB4 instance to test.
- **Logic and Control Flow**:
    - Check if `fib` is not NULL using `FD_TEST` macro.
    - Clear the FIB4 structure using [`fd_fib4_clear`](<fd_fib4.c.md#fd_fib4_clear>).
    - Get the initial count of entries in the FIB4 structure using [`fd_fib4_cnt`](<fd_fib4.c.md#fd_fib4_cnt>).
    - Define a `fd_fib4_hop_t` structure `hop` with specific IP source, route type, and interface index.
    - Insert two IP addresses into the hashmap using [`fd_fib4_insert`](<fd_fib4.c.md#fd_fib4_insert>) and verify the count increases by 2.
    - Insert an IP address into the routing table and verify the count increases by 3.
- **Output**: No return value; the function uses assertions to verify the expected behavior.
- **Functions Called**:
    - [`fd_fib4_clear`](<fd_fib4.c.md#fd_fib4_clear>)
    - [`fd_fib4_cnt`](<fd_fib4.c.md#fd_fib4_cnt>)
    - [`fd_fib4_insert`](<fd_fib4.c.md#fd_fib4_insert>)


---
### test\_fib4\_hmap\_basic\_insert<!-- {{#callable:test_fib4_hmap_basic_insert}} -->
[View Source →](<../../../../../src/waltz/ip/test_fib4.c#L278>)

Tests the insertion and lookup of IPv4 routes in a FIB (Forwarding Information Base) using a hashmap.
- **Inputs**:
    - `fib`: A pointer to an `fd_fib4_t` structure representing the FIB to be tested.
- **Logic and Control Flow**:
    - Checks if the `fib` pointer is valid using `FD_TEST` macro.
    - Clears the FIB using [`fd_fib4_clear`](<fd_fib4.c.md#fd_fib4_clear>).
    - Verifies the FIB count is 1 after clearing using [`fd_fib4_cnt`](<fd_fib4.c.md#fd_fib4_cnt>).
    - Defines six `fd_fib4_hop_t` structures with specific attributes for testing.
    - Defines six destination IP addresses for testing.
    - Performs a lookup for `ip_dst1` and checks if the result is `FD_FIB4_RTYPE_THROW`.
    - Inserts six routes into the FIB using [`fd_fib4_insert`](<fd_fib4.c.md#fd_fib4_insert>) with the defined hops and IPs.
    - Performs lookups for each inserted IP and verifies that the returned hop matches the inserted hop using `FD_TEST`.
- **Output**: No return value; the function uses assertions to validate the behavior of the FIB.
- **Functions Called**:
    - [`fd_fib4_clear`](<fd_fib4.c.md#fd_fib4_clear>)
    - [`fd_fib4_cnt`](<fd_fib4.c.md#fd_fib4_cnt>)
    - [`fd_fib4_lookup`](<fd_fib4.c.md#fd_fib4_lookup>)
    - [`fd_fib4_insert`](<fd_fib4.c.md#fd_fib4_insert>)


---
### test\_fib4\_mix<!-- {{#callable:test_fib4_mix}} -->
[View Source →](<../../../../../src/waltz/ip/test_fib4.c#L341>)

Tests the insertion and lookup of different types of routes in a FIB (Forwarding Information Base) and verifies the correct route is selected based on IP address specificity.
- **Inputs**:
    - ``fib``: A pointer to an `fd_fib4_t` structure representing the FIB to be tested.
- **Logic and Control Flow**:
    - Check if `fib` is not null using `FD_TEST` macro.
    - Clear the FIB using [`fd_fib4_clear`](<fd_fib4.c.md#fd_fib4_clear>).
    - Define three `fd_fib4_hop_t` structures: `default_hop`, `subnet_hop`, and `host_hop` with different interface indices and gateway IPs.
    - Insert a default route into the FIB with [`fd_fib4_insert`](<fd_fib4.c.md#fd_fib4_insert>) using `default_hop`.
    - Insert a subnet route into the FIB with [`fd_fib4_insert`](<fd_fib4.c.md#fd_fib4_insert>) using `subnet_hop`.
    - Perform a lookup for `target_ip` and verify it matches `subnet_hop` using `FD_TEST`.
    - Insert a host-specific route for `target_ip` using `host_hop` and verify the lookup matches `host_hop`.
    - Perform a lookup for `other_ip` and verify it matches `subnet_hop`.
    - Perform a lookup for `outside_ip` and verify it matches `default_hop`.
- **Output**: No return value; the function uses assertions to verify correct behavior.
- **Functions Called**:
    - [`fd_fib4_clear`](<fd_fib4.c.md#fd_fib4_clear>)
    - [`fd_fib4_insert`](<fd_fib4.c.md#fd_fib4_insert>)
    - [`fd_fib4_lookup`](<fd_fib4.c.md#fd_fib4_lookup>)


---
### test\_fib4\_hmap<!-- {{#callable:test_fib4_hmap}} -->
[View Source →](<../../../../../src/waltz/ip/test_fib4.c#L387>)

Executes a series of tests on a `fd_fib4_t` structure to verify its functionality, including basic insertion, capacity handling, precedence, edge cases, duplicate handling, clearing, counting, and mixed operations.
- **Inputs**:
    - `fib`: A pointer to a `fd_fib4_t` structure, which represents a Forwarding Information Base (FIB) for IPv4 routing.
- **Logic and Control Flow**:
    - Calls [`test_fib4_hmap_basic_insert`](<#test_fib4_hmap_basic_insert>) to test basic insertion operations on the FIB.
    - Calls [`test_fib4_hmap_capacity`](<#test_fib4_hmap_capacity>) to test the capacity limits of the FIB and ensure it handles maximum entries correctly.
    - Calls [`test_fib4_hmap_precedence`](<#test_fib4_hmap_precedence>) to verify that specific host routes take precedence over broader routes.
    - Calls [`test_fib4_hmap_edge_cases`](<#test_fib4_hmap_edge_cases>) to test the handling of special IP addresses.
    - Calls [`test_fib4_hmap_duplicates`](<#test_fib4_hmap_duplicates>) to ensure that duplicate entries update existing entries correctly.
    - Calls [`test_fib4_hmap_clear`](<#test_fib4_hmap_clear>) to test the clearing of the FIB and verify that entries are removed.
    - Calls [`test_fib4_hmap_counts`](<#test_fib4_hmap_counts>) to verify that the count of entries in the FIB is accurate.
    - Calls [`test_fib4_mix`](<#test_fib4_mix>) to test a mix of operations, including default, subnet, and host routes.
- **Output**: No direct output; the function performs tests and relies on assertions to validate the behavior of the `fd_fib4_t` structure.
- **Functions Called**:
    - [`test_fib4_hmap_basic_insert`](<#test_fib4_hmap_basic_insert>)
    - [`test_fib4_hmap_capacity`](<#test_fib4_hmap_capacity>)
    - [`test_fib4_hmap_precedence`](<#test_fib4_hmap_precedence>)
    - [`test_fib4_hmap_edge_cases`](<#test_fib4_hmap_edge_cases>)
    - [`test_fib4_hmap_duplicates`](<#test_fib4_hmap_duplicates>)
    - [`test_fib4_hmap_clear`](<#test_fib4_hmap_clear>)
    - [`test_fib4_hmap_counts`](<#test_fib4_hmap_counts>)
    - [`test_fib4_mix`](<#test_fib4_mix>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/waltz/ip/test_fib4.c#L407>)

Initializes and tests a Forwarding Information Base (FIB) for IPv4 routing, including alignment checks, footprint tests, route insertion, and lookup validation.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Checks memory alignment of `fib1_mem` using `fd_ulong_is_aligned`.
    - Performs footprint tests on [`fd_fib4_footprint`](<fd_fib4.c.md#fd_fib4_footprint>) with various parameters to validate expected behavior.
    - Initializes two FIB structures, `fib_local` and `fib_main`, using [`fd_fib4_new`](<fd_fib4.c.md#fd_fib4_new>) and [`fd_fib4_join`](<fd_fib4.c.md#fd_fib4_join>).
    - Clears `fib_local` and inserts several routes using [`fd_fib4_insert`](<fd_fib4.c.md#fd_fib4_insert>), then verifies the count with [`fd_fib4_cnt`](<fd_fib4.c.md#fd_fib4_cnt>).
    - Prints the FIB contents using [`test_fib_print`](<#test_fib_print>) to ensure correct route insertion.
    - Clears `fib_main`, inserts routes, and prints the FIB contents again for verification.
    - Defines a macro `QUERY` to perform route lookups in both `fib_local` and `fib_main`, and validates the results with `FD_TEST`.
    - Clears `fib_main` and performs a lookup to ensure it returns `FD_FIB4_RTYPE_THROW`.
    - Calls [`test_fib4_hmap`](<#test_fib4_hmap>) to perform additional tests on the FIB hashmap.
    - Deletes the FIB structures using [`fd_fib4_delete`](<fd_fib4.c.md#fd_fib4_delete>) and [`fd_fib4_leave`](<fd_fib4.c.md#fd_fib4_leave>).
    - Logs a notice of successful execution and halts the program with `fd_halt`.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`fd_fib4_align`](<fd_fib4.c.md#fd_fib4_align>)
    - [`fd_fib4_footprint`](<fd_fib4.c.md#fd_fib4_footprint>)
    - [`fd_fib4_hmap_get_lock_cnt`](<fd_fib4_private.h.md#fd_fib4_hmap_get_lock_cnt>)
    - [`fd_fib4_join`](<fd_fib4.c.md#fd_fib4_join>)
    - [`fd_fib4_new`](<fd_fib4.c.md#fd_fib4_new>)
    - [`fd_fib4_lookup`](<fd_fib4.c.md#fd_fib4_lookup>)
    - [`fd_fib4_clear`](<fd_fib4.c.md#fd_fib4_clear>)
    - [`fd_fib4_cnt`](<fd_fib4.c.md#fd_fib4_cnt>)
    - [`fd_fib4_insert`](<fd_fib4.c.md#fd_fib4_insert>)
    - [`test_fib_print`](<#test_fib_print>)
    - [`test_fib4_hmap`](<#test_fib4_hmap>)
    - [`fd_fib4_delete`](<fd_fib4.c.md#fd_fib4_delete>)
    - [`fd_fib4_leave`](<fd_fib4.c.md#fd_fib4_leave>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)