<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Header file for a query-optimized IPv4 routing table with multi-threaded support and basic route management.

# Purpose
The code defines a C header file for managing a Forwarding Information Base (FIB) specifically for IPv4 routes, referred to as `fib4`. This data structure is optimized for querying routes but does not scale well with a large number of routes, as each lookup operation has a time complexity of O(n). The `fib4` is designed to support multi-threaded environments with many reader threads and one writer thread, typical of x86-TSO environments. It provides a minimal set of features necessary for end devices, excluding packet forwarding capabilities. The header file includes definitions for route types, a structure for handling FIB lookup results (`fd_fib4_hop_t`), and a set of APIs for constructing, modifying, and querying the `fib4` data structure.

The header file defines several constants and types, including route types that align with Linux's route types, such as `FD_FIB4_RTYPE_UNICAST` and `FD_FIB4_RTYPE_LOCAL`. It provides a set of constructor APIs for creating and managing `fib4` instances, such as [`fd_fib4_new`](<#fd_fib4_new>), [`fd_fib4_join`](<#fd_fib4_join>), and [`fd_fib4_delete`](<#fd_fib4_delete>). The write APIs allow for route insertion and clearing, while the read APIs enable route lookup and provide helper functions for chaining lookups. The file also includes functions to retrieve the maximum number of routes and the current count of routes in the `fib4`. Additionally, if hosted, it provides a function to print the routing table to a file. The header file is intended to be included in other C source files that require IPv4 route management functionality.
# Imports and Dependencies

---
- `../../util/fd_util_base.h`


# Data Structures

---
### fd\_fib4\_t
- **Type**: ``fd_fib4_t``
- **Members**:
    - ``fd_fib4``: A local handle to a `fib4` object.
- **Description**: `fd_fib4_t` is a data structure that represents a handle to a `fib4` object, which stores IPv4 routes in a query-optimized format. It supports multi-threaded operations with many reader threads and one writer thread, but does not scale well with a large number of routes as each lookup is O(n). The structure is designed for end devices and does not support packet forwarding. It includes a dummy route at index 0 and uses a minimal set of features necessary for operation.


---
### fd\_fib4\_hop
- **Type**: ``struct``
- **Members**:
    - ``ip4_gw``: Gateway address in big endian format.
    - ``if_idx``: Output interface index.
    - ``ip4_src``: Override source address in big endian format; 0 implies unset.
    - ``rtype``: Route type, such as `FD_FIB4_RTYPE_UNICAST`.
    - ``scope``: Used to select the source address.
    - ``flags``: Application-specific flags.
- **Description**: Holds a FIB lookup result, providing details about the next hop in an IPv4 routing table, including gateway address, interface index, source address, route type, scope, and flags.


---
### fd\_fib4\_hop\_t
- **Type**: ``struct``
- **Members**:
    - ``ip4_gw``: Gateway address in big endian format.
    - ``if_idx``: Output interface index.
    - ``ip4_src``: Override source address in big endian format; 0 implies unset.
    - ``rtype``: Route type, such as `FD_FIB4_RTYPE_UNICAST`.
    - ``scope``: Used to select the source address.
    - ``flags``: Application-specific flags.
- **Description**: Holds the result of a Forwarding Information Base (FIB) lookup, including gateway address, interface index, source address override, route type, scope, and application-specific flags.


# Functions

---
### fd\_fib4\_hop\_or<!-- {{#callable:fd_fib4_hop_or}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4.h#L133>)

Selects the left hop unless its route type is `FD_FIB4_RTYPE_THROW`, in which case it selects the right hop.
- **Inputs**:
    - `left`: A pointer to a `fd_fib4_hop_t` structure representing the left hop.
    - `right`: A pointer to a `fd_fib4_hop_t` structure representing the right hop.
- **Logic and Control Flow**:
    - Check if the `rtype` of the `left` hop is not equal to `FD_FIB4_RTYPE_THROW`.
    - If true, return the `left` hop.
    - If false, return the `right` hop.
- **Output**: A pointer to a `fd_fib4_hop_t` structure, either `left` or `right`, based on the route type of `left`.


# Function Declarations (Public API)

---
### fd\_fib4\_align<!-- {{#callable_declaration:fd_fib4_align}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4.h#L60>)

Returns the alignment requirement for a fib4 object.
- **Description**: Use this function to obtain the alignment requirement for a `fd_fib4_t` object. This is necessary when allocating memory for a fib4 object to ensure proper alignment. The function does not require any parameters and can be called at any time to retrieve the alignment value.
- **Inputs**: None
- **Output**: The function returns an `ulong` representing the alignment requirement for a `fd_fib4_t` object.
- **See Also**: [`fd_fib4_align`](<fd_fib4.c.md#fd_fib4_align>)  (Implementation)


---
### fd\_fib4\_footprint<!-- {{#callable_declaration:fd_fib4_footprint}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4.h#L67>)

Calculates the memory footprint required for a fib4 structure.
- **Description**: Use this function to determine the memory size needed to store a fib4 structure with specified maximum numbers of routes and peer routes. This function is useful for allocating memory before creating a fib4 instance. It returns zero if the input parameters are invalid, such as when they exceed `UINT_MAX` or are zero, indicating that the requested configuration is not supported.
- **Inputs**:
    - `route_max`: Specifies the maximum number of routes the fib4 can store. Must be greater than zero and less than or equal to `UINT_MAX`. If invalid, the function returns zero.
    - `route_peer_max`: Specifies the maximum number of peer routes (with /32 netmask) the fib4 can store. Must be greater than zero and less than or equal to `UINT_MAX`. If invalid, the function returns zero.
- **Output**: Returns the memory footprint in bytes required for the fib4 structure, or zero if the input parameters are invalid.
- **See Also**: [`fd_fib4_footprint`](<fd_fib4.c.md#fd_fib4_footprint>)  (Implementation)


---
### fd\_fib4\_new<!-- {{#callable_declaration:fd_fib4_new}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4.h#L71>)

Creates a new IPv4 forwarding information base (FIB) instance.
- **Description**: Use this function to create a new FIB instance for storing IPv4 routes. The function requires a memory block that is properly aligned and has sufficient size to accommodate the FIB structure. It initializes the FIB with a dummy route and prepares it for use. Ensure that the `mem` parameter is not null and is aligned according to the alignment requirements. The `route_max` and `route_peer_max` parameters must be within valid ranges, specifically greater than zero and not exceeding `UINT_MAX`. If any of these conditions are not met, the function will return null.
- **Inputs**:
    - `mem`: A pointer to a memory block where the FIB will be created. Must not be null and must be aligned according to `fd_fib4_align()`.
    - `route_max`: The maximum number of routes the FIB can store. Must be greater than zero and not exceed `UINT_MAX`.
    - `route_peer_max`: The maximum number of /32 routes the FIB can store, backed by a hashmap. Must be greater than zero and not exceed `UINT_MAX`.
    - `route_peer_seed`: A seed value for initializing the route peer hashmap. Can be any unsigned long value.
- **Output**: Returns a pointer to the newly created FIB instance, or null if any input validation fails.
- **See Also**: [`fd_fib4_new`](<fd_fib4.c.md#fd_fib4_new>)  (Implementation)


---
### fd\_fib4\_join<!-- {{#callable_declaration:fd_fib4_join}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4.h#L77>)

Returns a handle to a fib4 object from a memory location.
- **Description**: Use this function to obtain a handle to a fib4 object from a given memory location. This function is typically called after memory allocation and initialization of a fib4 object. Ensure that the memory location provided is valid and properly aligned according to `FD_FIB4_ALIGN`. This function does not perform any validation on the memory content, so incorrect usage may lead to undefined behavior.
- **Inputs**:
    - `mem`: A pointer to a memory location that contains a fib4 object. The memory must be valid and properly aligned. The caller retains ownership of the memory.
- **Output**: A pointer to a `fd_fib4_t` object located at the specified memory location.
- **See Also**: [`fd_fib4_join`](<fd_fib4.c.md#fd_fib4_join>)  (Implementation)


---
### fd\_fib4\_leave<!-- {{#callable_declaration:fd_fib4_leave}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4.h#L80>)

Leaves a `fd_fib4_t` instance.
- **Description**: Use this function to leave a `fd_fib4_t` instance when it is no longer needed. This function is part of the lifecycle management of a `fd_fib4_t` object and should be called to properly release resources associated with the instance. Ensure that no other operations are performed on the `fd_fib4_t` instance after calling this function.
- **Inputs**:
    - `fib4`: A pointer to a `fd_fib4_t` instance. Must not be null. The caller retains ownership and is responsible for ensuring the instance is valid and not in use by other threads when calling this function.
- **Output**: Returns the same pointer that was passed in, allowing for potential chaining of operations.
- **See Also**: [`fd_fib4_leave`](<fd_fib4.c.md#fd_fib4_leave>)  (Implementation)


---
### fd\_fib4\_delete<!-- {{#callable_declaration:fd_fib4_delete}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4.h#L83>)

Deletes a fib4 object.
- **Description**: Use this function to delete a fib4 object and release its associated resources. This function is part of the lifecycle management of a fib4 object and should be called when the fib4 is no longer needed. Ensure that no other operations are performed on the fib4 object after calling this function, as it will invalidate the memory associated with the fib4.
- **Inputs**:
    - `mem`: A pointer to the memory associated with the fib4 object to delete. The pointer must not be null, and the memory must have been previously allocated and initialized for a fib4 object. The function returns the same pointer.
- **Output**: Returns the input pointer `mem`.
- **See Also**: [`fd_fib4_delete`](<fd_fib4.c.md#fd_fib4_delete>)  (Implementation)


---
### fd\_fib4\_clear<!-- {{#callable_declaration:fd_fib4_clear}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4.h#L98>)

Removes all route table entries except the first.
- **Description**: Use this function to clear all entries in the route table of a `fd_fib4_t` object, except for the first entry, which is set to a default route. This function is useful when you need to reset the routing table to a known state before adding new routes. It is important to ensure that the `fd_fib4_t` object is properly initialized before calling this function. The function does not return a value and does not handle invalid input explicitly, so the caller must ensure that the `fib4` parameter is valid.
- **Inputs**:
    - `fib4`: A pointer to a `fd_fib4_t` object representing the routing table to clear. Must not be null. The caller retains ownership of the object.
- **Output**: None
- **See Also**: [`fd_fib4_clear`](<fd_fib4.c.md#fd_fib4_clear>)  (Implementation)


---
### fd\_fib4\_insert<!-- {{#callable_declaration:fd_fib4_insert}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4.h#L107>)

Attempts to add a new route entry to the FIB routing table.
- **Description**: Use this function to add a new route to the FIB routing table. It supports both /32 netmask prefix routes, which are stored in a hashmap for faster lookup, and other routes, which use the main table. The function must be called in a context where the FIB is initialized and not full. It returns 1 on successful insertion and 0 if the internal data structures are full, logging a warning in that case. Ensure that the `hop` parameter is valid and not null before calling this function.
- **Inputs**:
    - `fib`: A pointer to an `fd_fib4_t` structure representing the FIB. Must not be null and must point to a valid, initialized FIB object.
    - `ip4_dst`: The destination IPv4 address for the route, in big-endian format. A value of 0 is allowed but has special handling when combined with a prefix of 32.
    - `prefix`: The netmask prefix length for the route. Valid values are from 0 to 32. A prefix of 32 indicates a /32 route, which is handled differently.
    - `prio`: The priority of the route. This is an unsigned integer and should be set according to the desired priority of the route.
    - `hop`: A pointer to an `fd_fib4_hop_t` structure that holds the FIB lookup result. Must not be null and must point to a valid `fd_fib4_hop_t` object.
- **Output**: Returns 1 on successful insertion of the route, or 0 if the route table is full.
- **See Also**: [`fd_fib4_insert`](<fd_fib4.c.md#fd_fib4_insert>)  (Implementation)


---
### fd\_fib4\_lookup<!-- {{#callable_declaration:fd_fib4_lookup}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4.h#L125>)

Resolves the next hop for a given IPv4 address.
- **Description**: Use this function to find the next hop for an IPv4 address in a fib4 routing table. It is thread-safe for concurrent reads, but during a write operation, it may temporarily return a blackhole route. Ensure that the `fib` parameter is a valid pointer to a fib4 object and that `out` is a valid pointer where the result will be stored. If the `flags` parameter is non-zero, the function will return a dead route immediately. This function is useful for applications that need to determine routing paths based on IPv4 addresses.
- **Inputs**:
    - `fib`: A pointer to a constant `fd_fib4_t` object representing the fib4 routing table. Must not be null.
    - `out`: A pointer to an `fd_fib4_hop_t` where the function will store the lookup result. Must not be null.
    - `ip4_dst`: An unsigned integer representing the destination IPv4 address in big-endian format.
    - `flags`: An unsigned long integer used to modify the function's behavior. If non-zero, the function returns a dead route.
- **Output**: A pointer to a constant `fd_fib4_hop_t` structure containing the next hop information. If the lookup fails or during a write operation, it may return a blackhole route.
- **See Also**: [`fd_fib4_lookup`](<fd_fib4.c.md#fd_fib4_lookup>)  (Implementation)


---
### fd\_fib4\_max<!-- {{#callable_declaration:fd_fib4_max}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4.h#L141>)

Returns the maximum number of routes in the table.
- **Description**: Use this function to get the maximum number of routes that the `fd_fib4_t` data structure can store. This function is useful for understanding the capacity of the routing table and for planning route management operations. It is a read-only operation and does not modify the state of the `fd_fib4_t` object. The function is thread-safe and can be called concurrently by multiple threads.
- **Inputs**:
    - `fib`: A pointer to a constant `fd_fib4_t` object. This must not be null, and the caller retains ownership of the object. The function does not modify the object.
- **Output**: The function returns an unsigned long integer representing the maximum number of routes that can be stored in the `fd_fib4_t` routing table.
- **See Also**: [`fd_fib4_max`](<fd_fib4.c.md#fd_fib4_max>)  (Implementation)


---
### fd\_fib4\_peer\_max<!-- {{#callable_declaration:fd_fib4_peer_max}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4.h#L146>)

Returns the maximum number of /32 routes supported by the FIB.
- **Description**: Use this function to determine the maximum number of /32 routes that the FIB can handle. This is useful for understanding the capacity of the FIB in terms of specific routes that are stored in a hashmap for faster lookup. It is important to know this limit when planning the routing table size and ensuring that the FIB does not exceed its capacity for /32 routes.
- **Inputs**:
    - `fib`: A pointer to a constant `fd_fib4_t` structure representing the FIB. Must not be null. The caller retains ownership of the memory.
- **Output**: The function returns an unsigned long integer representing the maximum number of /32 routes that the FIB can support.
- **See Also**: [`fd_fib4_peer_max`](<fd_fib4.c.md#fd_fib4_peer_max>)  (Implementation)


---
### fd\_fib4\_cnt<!-- {{#callable_declaration:fd_fib4_cnt}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4.h#L152>)

Returns the total number of routes in the FIB.
- **Description**: Use this function to get the total count of routes stored in a `fd_fib4_t` object, including both general routes and /32 routes. This function is useful for monitoring or debugging purposes to understand the size of the routing table. It is thread-safe and can be called concurrently by multiple threads.
- **Inputs**:
    - `fib`: A pointer to a `fd_fib4_t` object. Must not be null. The caller retains ownership of the object.
- **Output**: The function returns an unsigned long integer representing the total number of routes in the FIB, including /32 routes.
- **See Also**: [`fd_fib4_cnt`](<fd_fib4.c.md#fd_fib4_cnt>)  (Implementation)


---
### fd\_fib4\_fprintf<!-- {{#callable_declaration:fd_fib4_fprintf}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4.h#L162>)

Prints the routing table and hash map to a specified file.
- **Description**: Use this function to output the current state of the routing table and hash map associated with a `fd_fib4_t` object to a specified file. This function is useful for debugging or logging purposes, as it provides a stable, ASCII-encoded representation of the routes, with each entry followed by a line feed. The order of routes is not defined but remains consistent across calls. Ensure that the `fd_fib4_t` object is properly initialized and that the file pointer is valid before calling this function. The function returns 0 on success and an error code on failure.
- **Inputs**:
    - `fib`: A pointer to a constant `fd_fib4_t` object representing the routing table. Must not be null.
    - `file`: A pointer to a `FILE` object or equivalent where the output will be written. Must not be null.
- **Output**: Returns 0 on success. On failure, returns an error code.
- **See Also**: [`fd_fib4_fprintf`](<fd_fib4.c.md#fd_fib4_fprintf>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)