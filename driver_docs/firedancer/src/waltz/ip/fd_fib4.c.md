<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a data structure and functions for managing IPv4 forwarding information bases (FIBs).

# Purpose
The code is a C module that implements a data structure for managing IPv4 routing tables, specifically a Forwarding Information Base (FIB) for IPv4 addresses. It provides functions to create, manage, and query a routing table that supports both direct and longest-prefix match lookups. The module includes functions to initialize a new FIB ([`fd_fib4_new`](<#fd_fib4_new>)), insert routes ([`fd_fib4_insert`](<#fd_fib4_insert>)), and perform lookups ([`fd_fib4_lookup`](<#fd_fib4_lookup>)). It also includes functions to manage the lifecycle of the FIB, such as [`fd_fib4_join`](<#fd_fib4_join>), [`fd_fib4_leave`](<#fd_fib4_leave>), and [`fd_fib4_delete`](<#fd_fib4_delete>).

The module uses a combination of a hash map and a linear table to store routing entries. The hash map is used for exact match lookups, while the linear table is used for longest-prefix match lookups. The code defines several constants and utility functions to manage memory alignment and footprint calculations for the data structures involved. It also includes error handling and logging to ensure robustness in memory allocation and route management. The module is designed to be part of a larger system, as indicated by the inclusion of headers and utility functions from other parts of the codebase. Additionally, the module provides functionality to print the routing table to a file, which is useful for debugging and verification purposes.
# Imports and Dependencies

---
- `fd_fib4.h`
- `fd_fib4_private.h`
- `../../util/net/fd_ip4.h`
- `errno.h`
- `stdio.h`


# Global Variables

---
### fd\_fib4\_hop\_blackhole
- **Type**: ``fd_fib4_hop_t``
- **Description**: Defines a constant instance of the `fd_fib4_hop_t` structure with the `rtype` field set to `FD_FIB4_RTYPE_BLACKHOLE`. This indicates a route type that discards packets, effectively acting as a 'blackhole' in the routing table.
- **Use**: Used to represent a blackhole route in the FIB4 routing table.


# Functions

---
### fd\_fib4\_align<!-- {{#callable:fd_fib4_align}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4.c#L10>)

Returns the alignment requirement of the `fd_fib4_t` type.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls the `alignof` operator on `fd_fib4_t` to determine its alignment requirement.
    - Returns the result of the `alignof` operator.
- **Output**: The function returns an `ulong` representing the alignment requirement of the `fd_fib4_t` type.


---
### fd\_fib4\_footprint<!-- {{#callable:fd_fib4_footprint}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4.c#L15>)

Calculates the memory footprint required for a FIB4 data structure based on the maximum number of routes and route peers.
- **Inputs**:
    - `route_max`: The maximum number of routes that the FIB4 can handle.
    - `route_peer_max`: The maximum number of route peers that the FIB4 can handle.
- **Logic and Control Flow**:
    - Check if `route_max` or `route_peer_max` is zero or exceeds `UINT_MAX`; if so, return 0.
    - Calculate `elem_max` using [`fd_fib4_hmap_get_ele_max`](<fd_fib4_private.h.md#fd_fib4_hmap_get_ele_max>) with `route_peer_max`.
    - Calculate `probe_max` using [`fd_fib4_hmap_get_probe_max`](<fd_fib4_private.h.md#fd_fib4_hmap_get_probe_max>) with `elem_max`.
    - Calculate `lock_cnt` using [`fd_fib4_hmap_get_lock_cnt`](<fd_fib4_private.h.md#fd_fib4_hmap_get_lock_cnt>) with `elem_max`.
    - Calculate `hmap_footprint` using `fd_fib4_hmap_footprint` with `elem_max`, `lock_cnt`, and `probe_max`; if zero, return 0.
    - Calculate and return the total memory footprint using `FD_LAYOUT_INIT`, `FD_LAYOUT_APPEND`, and `FD_LAYOUT_FINI` with alignment and size parameters for various FIB4 components.
- **Output**: Returns the total memory footprint in bytes as an unsigned long integer.
- **Functions Called**:
    - [`fd_fib4_hmap_get_ele_max`](<fd_fib4_private.h.md#fd_fib4_hmap_get_ele_max>)
    - [`fd_fib4_hmap_get_probe_max`](<fd_fib4_private.h.md#fd_fib4_hmap_get_probe_max>)
    - [`fd_fib4_hmap_get_lock_cnt`](<fd_fib4_private.h.md#fd_fib4_hmap_get_lock_cnt>)


---
### fd\_fib4\_new<!-- {{#callable:fd_fib4_new}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4.c#L35>)

Initializes a new `fd_fib4_t` structure for managing IPv4 routing tables with specified parameters.
- **Inputs**:
    - `mem`: A pointer to the memory location where the `fd_fib4_t` structure will be initialized.
    - `route_max`: The maximum number of routes that the routing table can hold.
    - `route_peer_max`: The maximum number of peer routes that the routing table can manage.
    - `route_peer_seed`: A seed value used for initializing the hash map within the routing table.
- **Logic and Control Flow**:
    - Check if `mem` is NULL and log a warning if true, then return NULL.
    - Check if `mem` is aligned according to `fd_fib4_align()` and log a warning if not, then return NULL.
    - Validate `route_max` and `route_peer_max` to ensure they are within valid ranges, logging warnings and returning NULL if not.
    - Initialize scratch memory allocation using `FD_SCRATCH_ALLOC_INIT`.
    - Allocate memory for `fd_fib4_t`, keys, and values using `FD_SCRATCH_ALLOC_APPEND`.
    - Calculate hash map parameters (`hmap_elem_max`, `hmap_probe_max`, `hmap_lock_cnt`, `hmap_footprint`) and allocate memory for the hash map and its elements.
    - Initialize allocated memory to zero using `fd_memset`.
    - Create a new hash map with `fd_fib4_hmap_new` using the allocated memory and parameters.
    - Set initial values for the `fd_fib4_t` structure, including route count, maximums, offsets, and default route settings.
    - Return the pointer to the initialized `fd_fib4_t` structure.
- **Output**: A pointer to the newly initialized `fd_fib4_t` structure, or NULL if initialization fails.
- **Functions Called**:
    - [`fd_fib4_align`](<#fd_fib4_align>)
    - [`fd_fib4_hmap_get_ele_max`](<fd_fib4_private.h.md#fd_fib4_hmap_get_ele_max>)
    - [`fd_fib4_hmap_get_probe_max`](<fd_fib4_private.h.md#fd_fib4_hmap_get_probe_max>)
    - [`fd_fib4_hmap_get_lock_cnt`](<fd_fib4_private.h.md#fd_fib4_hmap_get_lock_cnt>)


---
### fd\_fib4\_join<!-- {{#callable:fd_fib4_join}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4.c#L93>)

Casts a memory pointer to a `fd_fib4_t` pointer.
- **Inputs**:
    - `mem`: A pointer to memory that is expected to be aligned and suitable for use as a `fd_fib4_t` structure.
- **Logic and Control Flow**:
    - Casts the input `mem` pointer to a `fd_fib4_t` pointer.
    - Returns the casted pointer.
- **Output**: A pointer to `fd_fib4_t` that is cast from the input `mem`.


---
### fd\_fib4\_leave<!-- {{#callable:fd_fib4_leave}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4.c#L98>)

Returns the input `fd_fib4_t` pointer without modification.
- **Inputs**:
    - `fib4`: A pointer to an `fd_fib4_t` structure.
- **Logic and Control Flow**:
    - The function takes a single argument, `fib4`, which is a pointer to an `fd_fib4_t` structure.
    - It returns the same `fd_fib4_t` pointer that it receives as input.
- **Output**: A pointer to the `fd_fib4_t` structure passed as input.


---
### fd\_fib4\_delete<!-- {{#callable:fd_fib4_delete}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4.c#L103>)

Returns the input memory pointer without modification.
- **Inputs**:
    - `mem`: A pointer to a memory block that is intended to be deleted.
- **Logic and Control Flow**:
    - The function takes a single input parameter `mem`.
    - It returns the `mem` pointer directly without performing any operations on it.
- **Output**: The same memory pointer that was passed as input.


---
### fd\_fib4\_clear<!-- {{#callable:fd_fib4_clear}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4.c#L108>)

Clears the `fd_fib4_t` structure by resetting its count and reinitializing its hashmap.
- **Inputs**:
    - `fib4`: A pointer to an `fd_fib4_t` structure that represents the FIB4 instance to clear.
- **Logic and Control Flow**:
    - Set `fib4->cnt` to 1UL, indicating the first route entry is 0.0.0.0/0.
    - Check if `fib4->hmap_cnt` is 0; if true, return immediately as there is nothing to clear.
    - Declare a local `fd_fib4_hmap_t` array `hmap` with one element.
    - Join the hashmap memory and element memory of `fib4` into `hmap` using `fd_fib4_hmap_join`.
    - Set `fib4->hmap_cnt` to 0, indicating the hashmap is now empty.
    - Calculate `elem_max`, `probe_max`, `lock_cnt`, and `seed` using the respective functions and `fib4->hmap_max`.
    - Declare an `ignored` array with a size of `fd_fib4_hmap_lock_max()`.
    - Lock the range of the hashmap using `fd_fib4_hmap_lock_range` with blocking flag and check for success.
    - Reinitialize the hashmap with `fd_fib4_hmap_new` using the calculated parameters.
    - Clear the element memory of the hashmap by setting it to zero using `fd_memset`.
- **Output**: No return value; the function operates directly on the `fd_fib4_t` structure pointed to by `fib4`.
- **Functions Called**:
    - [`fd_fib4_hmap_mem`](<fd_fib4_private.h.md#fd_fib4_hmap_mem>)
    - [`fd_fib4_hmap_ele_mem`](<fd_fib4_private.h.md#fd_fib4_hmap_ele_mem>)
    - [`fd_fib4_hmap_get_ele_max`](<fd_fib4_private.h.md#fd_fib4_hmap_get_ele_max>)
    - [`fd_fib4_hmap_get_probe_max`](<fd_fib4_private.h.md#fd_fib4_hmap_get_probe_max>)
    - [`fd_fib4_hmap_get_lock_cnt`](<fd_fib4_private.h.md#fd_fib4_hmap_get_lock_cnt>)


---
### fd\_fib4\_max<!-- {{#callable:fd_fib4_max}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4.c#L128>)

Retrieves the maximum number of routes that can be stored in a `fd_fib4_t` structure.
- **Inputs**:
    - `fib`: A pointer to a constant `fd_fib4_t` structure from which to retrieve the maximum route count.
- **Logic and Control Flow**:
    - Accesses the `max` field of the `fd_fib4_t` structure pointed to by `fib`.
    - Returns the value of the `max` field.
- **Output**: The function returns an `ulong` representing the maximum number of routes that the `fd_fib4_t` structure can store.


---
### fd\_fib4\_peer\_max<!-- {{#callable:fd_fib4_peer_max}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4.c#L133>)

Returns the maximum number of peers that the `fd_fib4_t` structure can handle.
- **Inputs**:
    - `fib`: A pointer to a constant `fd_fib4_t` structure.
- **Logic and Control Flow**:
    - Accesses the `hmap_max` member of the `fd_fib4_t` structure pointed to by `fib`.
    - Returns the value of `hmap_max`.
- **Output**: The function returns an unsigned long integer representing the maximum number of peers.


---
### fd\_fib4\_cnt<!-- {{#callable:fd_fib4_cnt}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4.c#L138>)

Calculates the total number of routes in a `fd_fib4_t` structure by summing the direct route count and the hashmap route count.
- **Inputs**:
    - `fib`: A pointer to a constant `fd_fib4_t` structure, which contains the route and hashmap counts.
- **Logic and Control Flow**:
    - Accesses the `cnt` field of the `fd_fib4_t` structure to get the number of direct routes.
    - Accesses the `hmap_cnt` field of the `fd_fib4_t` structure to get the number of routes in the hashmap.
    - Returns the sum of `cnt` and `hmap_cnt`.
- **Output**: Returns an `ulong` representing the total number of routes in the `fd_fib4_t` structure.


---
### fd\_fib4\_hmap\_insert<!-- {{#callable:fd_fib4_hmap_insert}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4.c#L149>)

Inserts a new entry into the FIB4 hash map with a specified IP destination and next hop.
- **Inputs**:
    - `fib`: A pointer to the `fd_fib4_t` structure representing the FIB4 instance.
    - `ip4_dst`: An unsigned integer representing the IPv4 destination address for the new entry.
    - `hop`: A pointer to the `fd_fib4_hop_t` structure representing the next hop information for the new entry.
- **Logic and Control Flow**:
    - Check if the current count of entries in the hash map (`fib->hmap_cnt`) is greater than or equal to the maximum allowed (`fib->hmap_max`). If true, return `FD_MAP_ERR_FULL`.
    - Join the hash map using `fd_fib4_hmap_join` to initialize the `hmap` variable.
    - Prepare the hash map for insertion using `fd_fib4_hmap_prepare`. If the map is full, return `FD_MAP_ERR_FULL`. If there is another error, log it and terminate the function.
    - Retrieve the element pointer from the query using `fd_fib4_hmap_query_ele` and set its `dst_addr` to `ip4_dst`.
    - Verify that `hop` is not NULL and assign its value to `ele->next_hop`.
    - Increment the hash map entry count (`fib->hmap_cnt`).
    - Publish the new entry to the hash map using `fd_fib4_hmap_publish`.
    - Return `FD_MAP_SUCCESS` to indicate successful insertion.
- **Output**: Returns `FD_MAP_SUCCESS` on successful insertion or `FD_MAP_ERR_FULL` if the hash map is full.
- **Functions Called**:
    - [`fd_fib4_hmap_mem`](<fd_fib4_private.h.md#fd_fib4_hmap_mem>)
    - [`fd_fib4_hmap_ele_mem`](<fd_fib4_private.h.md#fd_fib4_hmap_ele_mem>)


---
### fd\_fib4\_insert<!-- {{#callable:fd_fib4_insert}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4.c#L177>)

Inserts a new IPv4 route into a forwarding information base (FIB) with specified destination, prefix, priority, and hop information.
- **Inputs**:
    - `fib`: A pointer to the `fd_fib4_t` structure representing the forwarding information base.
    - `ip4_dst`: The IPv4 destination address for the route.
    - `prefix`: The prefix length of the route, indicating the subnet mask.
    - `prio`: The priority of the route, used to determine route preference.
    - `hop`: A pointer to the `fd_fib4_hop_t` structure containing the next hop information for the route.
- **Logic and Control Flow**:
    - Check if `ip4_dst` is not zero and `prefix` is 32; if true, attempt to insert the route into the FIB hashmap using [`fd_fib4_hmap_insert`](<#fd_fib4_hmap_insert>) and return 1 on success, otherwise log a warning and return 0.
    - Retrieve the current generation number from the FIB and check if the route table is full; if full, log a warning and return 0.
    - Increment the FIB generation number, ensuring memory fence operations for synchronization.
    - Calculate the index for the new route entry, increment the route count, and prepare the key and hop entries for the new route.
    - Set the key's address, mask, and priority based on the input parameters, and store the hop information.
    - Increment the FIB generation number again with memory fence operations for synchronization.
    - Return 1 to indicate successful insertion.
- **Output**: Returns 1 if the route is successfully inserted, otherwise returns 0.
- **Functions Called**:
    - [`fd_fib4_hmap_insert`](<#fd_fib4_hmap_insert>)


---
### fd\_fib4\_lookup<!-- {{#callable:fd_fib4_lookup}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4.c#L222>)

Finds the next hop for a given IPv4 destination address in a forwarding information base (FIB) and returns it.
- **Inputs**:
    - `fib`: A pointer to a constant `fd_fib4_t` structure representing the forwarding information base.
    - `out`: A pointer to an `fd_fib4_hop_t` structure where the function will store the next hop information.
    - `ip4_dst`: An unsigned integer representing the IPv4 destination address to look up.
    - `flags`: An unsigned long integer used to modify the function's behavior; if non-zero, the function returns a dead route.
- **Logic and Control Flow**:
    - Check if `flags` is non-zero; if true, return a dead route.
    - Verify that `out` is not NULL.
    - If the FIB's hashmap count is greater than zero, attempt to find the destination in the hashmap.
    - If the destination is found in the hashmap, save the next hop and verify the query; if verification fails, return a blackhole route.
    - If the destination is not found in the hashmap, or if the hashmap is empty, perform a lookup in the routing table.
    - Convert `ip4_dst` to network byte order and iterate over the routing table to find the most specific matching route.
    - If a matching route is found, store the next hop in `out`.
    - Check for torn reads by comparing the FIB's generation before and after the lookup; if they differ, return a blackhole route.
- **Output**: A pointer to a constant `fd_fib4_hop_t` structure representing the next hop for the given destination, or a blackhole route if no valid route is found.
- **Functions Called**:
    - [`fd_fib4_hop_tbl_const`](<fd_fib4_private.h.md#fd_fib4_hop_tbl_const>)
    - [`fd_fib4_hmap_mem`](<fd_fib4_private.h.md#fd_fib4_hmap_mem>)
    - [`fd_fib4_hmap_ele_mem`](<fd_fib4_private.h.md#fd_fib4_hmap_ele_mem>)
    - [`fd_fib4_key_tbl_const`](<fd_fib4_private.h.md#fd_fib4_key_tbl_const>)


---
### fd\_fib4\_fprintf\_route<!-- {{#callable:fd_fib4_fprintf_route}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4.c#L294>)

Formats and writes a routing entry to a specified file stream based on the provided key and hop information.
- **Inputs**:
    - ``key``: A pointer to a `fd_fib4_key_t` structure containing the routing key information, including address, mask, and priority.
    - ``hop``: A pointer to a `fd_fib4_hop_t` structure containing the hop information, including route type, gateway IP, interface index, scope, and source IP.
    - ``file``: A pointer to a `FILE` stream where the formatted routing entry will be written.
- **Logic and Control Flow**:
    - Check the `rtype` of `hop` and write the corresponding route type string to `file` using `WRAP_PRINT` or `WRAP_PRINTF` macros.
    - If `key->mask` is zero, write 'default' to `file`; otherwise, write the IP address and mask length.
    - If `hop->ip4_gw` is non-zero, write the gateway IP address to `file`.
    - If `hop->if_idx` is non-zero, write the interface index to `file`.
    - Check the `scope` of `hop` and write the corresponding scope string to `file`.
    - If `hop->ip4_src` is non-zero, write the source IP address to `file`.
    - If `key->prio` is non-zero, write the priority metric to `file`.
    - Write a newline character to `file` at the end of the entry.
- **Output**: Returns 0 on success, or an error code if writing to the file fails.


---
### fd\_fib4\_fprintf<!-- {{#callable:fd_fib4_fprintf}} -->
[View Source →](<../../../../../src/waltz/ip/fd_fib4.c#L372>)

Prints the routing table and hashmap entries of a `fd_fib4_t` structure to a specified file.
- **Inputs**:
    - ``fib``: A pointer to a constant `fd_fib4_t` structure representing the routing table.
    - ``file_``: A pointer to a `FILE` object where the function will print the routing information.
- **Logic and Control Flow**:
    - Initialize `file` as a `FILE` pointer from `file_` and retrieve constant pointers to the key and hop tables from `fib`.
    - Use memory fences to ensure memory consistency and retrieve the count and generation from `fib`.
    - Iterate over each entry in the key and hop tables, checking for torn reads by comparing the current generation with the initial generation.
    - If a torn read is detected, print '=== TORN READ ===' to the file and return 0.
    - For each valid entry, call [`fd_fib4_fprintf_route`](<#fd_fib4_fprintf_route>) to print the route information to the file.
    - Initialize a hashmap and attempt to join it with the memory from `fib`.
    - Iterate over each element in the hashmap, attempting to lock and read each entry.
    - For each valid entry in the hashmap, construct a key and call [`fd_fib4_fprintf_route`](<#fd_fib4_fprintf_route>) to print the route information to the file.
- **Output**: Returns 0 after printing all entries, or immediately if a torn read is detected.
- **Functions Called**:
    - [`fd_fib4_key_tbl_const`](<fd_fib4_private.h.md#fd_fib4_key_tbl_const>)
    - [`fd_fib4_hop_tbl_const`](<fd_fib4_private.h.md#fd_fib4_hop_tbl_const>)
    - [`fd_fib4_fprintf_route`](<#fd_fib4_fprintf_route>)
    - [`fd_fib4_hmap_ele_mem`](<fd_fib4_private.h.md#fd_fib4_hmap_ele_mem>)
    - [`fd_fib4_hmap_mem`](<fd_fib4_private.h.md#fd_fib4_hmap_mem>)
    - [`fd_fib4_hmap_get_ele_max`](<fd_fib4_private.h.md#fd_fib4_hmap_get_ele_max>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)