<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Netlink socket management and iteration utilities for Linux, including session initialization and message handling.

# Purpose
The code is a C header file that provides an interface for working with netlink sockets on Linux systems. It defines structures and functions to manage netlink sessions, handle netlink messages, and iterate over multipart netlink messages. The primary structures defined are `fd_netlink`, which represents a netlink session with a socket file descriptor and a sequence number, and `fd_netlink_iter`, which is used to iterate over netlink messages. The file includes function prototypes for initializing and finalizing netlink sessions, reading from netlink sockets, and managing the iteration over netlink messages.

The header file also includes utility functions for debugging, such as converting route message types and route attribute types to strings. The code is designed to handle specific errors like `EINTR` and `ENOBUFS` when reading from netlink sockets, ensuring robust message processing. The file is intended to be included in other C source files that require netlink communication capabilities, and it is specific to Linux environments, as indicated by the conditional compilation directive `#if defined(__linux__)`.
# Imports and Dependencies

---
- `../../util/fd_util_base.h`


# Global Variables

---
### fd\_netlink\_enobufs\_cnt
- **Type**: ``ulong``
- **Description**: Counts the number of ENOBUFS error occurrences in the netlink communication process.
- **Use**: Used to track how often ENOBUFS errors occur during netlink operations.


# Data Structures

---
### fd\_netlink
- **Type**: ``struct``
- **Members**:
    - `fd`: An integer representing the netlink socket.
    - `seq`: An unsigned integer representing the netlink sequence number.
- **Description**: Facilitates communication with the Linux kernel via netlink sockets, using a file descriptor (`fd`) and a sequence number (`seq`) to manage message exchanges.


---
### fd\_netlink\_t
- **Type**: ``struct``
- **Members**:
    - ``fd``: An integer representing the netlink socket.
    - ``seq``: An unsigned integer representing the netlink sequence number.
- **Description**: Defines a structure for managing a netlink session, including a socket file descriptor and a sequence number for tracking netlink messages.


---
### fd\_netlink\_iter
- **Type**: ``struct``
- **Members**:
    - ``buf``: Pointer to a buffer for storing data.
    - ``buf_sz``: Size of the buffer in bytes.
    - ``msg0``: Pointer to the start of the current netlink message.
    - ``msg1``: Pointer to the end of the current netlink message.
    - ``err``: Error code indicating the status of the iteration.
- **Description**: Facilitates iteration over a sequence of incoming netlink multipart messages by maintaining pointers to the current message and buffer, as well as tracking errors.


---
### fd\_netlink\_iter\_t
- **Type**: ``struct``
- **Members**:
    - ``buf``: Pointer to a buffer used for storing netlink messages.
    - ``buf_sz``: Size of the buffer pointed to by `buf`.
    - ``msg0``: Pointer to the start of the current netlink message.
    - ``msg1``: Pointer to the start of the next netlink message.
    - ``err``: Error code indicating the status of the iteration.
- **Description**: Facilitates iteration over a sequence of netlink multipart messages by maintaining pointers to the current and next messages, as well as a buffer for message storage and an error code for iteration status.


# Functions

---
### fd\_netlink\_iter\_msg<!-- {{#callable:fd_netlink_iter_msg}} -->
[View Source →](<../../../../../src/waltz/ip/fd_netlink1.h#L80>)

Returns a pointer to the current netlink message header from the iterator.
- **Inputs**:
    - `iter`: A constant pointer to an `fd_netlink_iter_t` structure representing the current state of the netlink message iteration.
- **Logic and Control Flow**:
    - Calls `fd_type_pun_const` with `iter->msg0` to obtain a constant pointer to the current netlink message header.
    - Returns the result of `fd_type_pun_const`.
- **Output**: A constant pointer to a `struct nlmsghdr`, representing the current netlink message header.


---
### fd\_netlink\_iter\_drain<!-- {{#callable:fd_netlink_iter_drain}} -->
[View Source →](<../../../../../src/waltz/ip/fd_netlink1.h#L85>)

Iterates over all netlink messages and returns the count of messages processed.
- **Inputs**:
    - ``iter``: A pointer to an `fd_netlink_iter_t` structure, which represents the iterator for netlink messages.
    - ``netlink``: A pointer to an `fd_netlink_t` structure, which represents the netlink session.
- **Logic and Control Flow**:
    - Initialize `cnt` to 0.
    - Enter a loop that continues as long as `fd_netlink_iter_done(iter)` returns 0, indicating there are more messages to process.
    - In each iteration, call `fd_netlink_iter_next(iter, netlink)` to advance to the next message.
    - Increment `cnt` by 1 for each message processed.
    - Exit the loop when there are no more messages to process.
- **Output**: Returns the number of netlink messages processed as an `ulong`.
- **Functions Called**:
    - [`fd_netlink_iter_done`](<fd_netlink1.c.md#fd_netlink_iter_done>)
    - [`fd_netlink_iter_next`](<fd_netlink1.c.md#fd_netlink_iter_next>)


# Function Declarations (Public API)

---
### fd\_netlink\_init<!-- {{#callable_declaration:fd_netlink_init}} -->
[View Source →](<../../../../../src/waltz/ip/fd_netlink1.h#L37>)

Creates a new netlink session with a specified initial sequence number.
- **Description**: Use this function to initialize a netlink session by creating a new netlink socket and setting an initial sequence number. This function must be called before any netlink operations are performed. If the socket creation fails, the function returns `NULL`, indicating that the session could not be initialized. Ensure that the `fd_netlink_t` structure provided is valid and that the system supports netlink sockets.
- **Inputs**:
    - `netlink`: A pointer to an `fd_netlink_t` structure that will be initialized. Must not be null. The caller retains ownership.
    - `seq0`: An unsigned integer representing the initial sequence number for the netlink session. There are no specific constraints on the value.
- **Output**: Returns a pointer to the initialized `fd_netlink_t` structure on success, or `NULL` if the socket creation fails.
- **See Also**: [`fd_netlink_init`](<fd_netlink1.c.md#fd_netlink_init>)  (Implementation)


---
### fd\_netlink\_fini<!-- {{#callable_declaration:fd_netlink_fini}} -->
[View Source →](<../../../../../src/waltz/ip/fd_netlink1.h#L43>)

Closes the netlink socket and resets its file descriptor.
- **Description**: Use this function to close an active netlink session and reset its file descriptor to an invalid state. This function should be called when the netlink session is no longer needed to release resources. It is important to ensure that the `fd_netlink_t` structure is valid and initialized before calling this function. After execution, the file descriptor within the structure is set to -1, indicating that it is no longer valid.
- **Inputs**:
    - `netlink`: A pointer to a `fd_netlink_t` structure representing the netlink session to close. The structure must be valid and initialized. The function does not handle null pointers, so the caller must ensure the pointer is not null.
- **Output**: Returns the same `fd_netlink_t` pointer passed as input, with its file descriptor set to -1.
- **See Also**: [`fd_netlink_fini`](<fd_netlink1.c.md#fd_netlink_fini>)  (Implementation)


---
### fd\_netlink\_read\_socket<!-- {{#callable_declaration:fd_netlink_read_socket}} -->
[View Source →](<../../../../../src/waltz/ip/fd_netlink1.h#L49>)

Reads data from a netlink socket into a buffer.
- **Description**: Use this function to read data from a netlink socket specified by the file descriptor. It handles specific errors by retrying the read operation when interrupted by signals or when buffer space is temporarily unavailable. This function is useful in scenarios where you need to ensure that the read operation continues despite these common interruptions. It is important to provide a valid buffer and specify the correct buffer size to avoid data loss.
- **Inputs**:
    - `fd`: The file descriptor of the netlink socket to read from. Must be a valid, open socket descriptor.
    - `buf`: A pointer to a buffer where the read data will be stored. Must not be null and should have enough space to hold the data specified by `buf_sz`.
    - `buf_sz`: The size of the buffer in bytes. Must be a positive value indicating the maximum number of bytes to read.
- **Output**: Returns the number of bytes read on success. Returns a negative value representing the negated error code on failure.
- **See Also**: [`fd_netlink_read_socket`](<fd_netlink1.c.md#fd_netlink_read_socket>)  (Implementation)


---
### fd\_netlink\_iter\_init<!-- {{#callable_declaration:fd_netlink_iter_init}} -->
[View Source →](<../../../../../src/waltz/ip/fd_netlink1.h#L57>)

Prepares iteration over a sequence of incoming netlink multipart messages.
- **Description**: Use this function to initialize an iterator for processing a sequence of netlink multipart messages. It sets up the iterator with the provided buffer and buffer size, and prepares it to receive messages from the specified netlink session. This function must be called before using the iterator to process messages. Ensure that the buffer is large enough to hold the expected messages.
- **Inputs**:
    - `iter`: A pointer to an `fd_netlink_iter_t` structure that will be initialized. Must not be null.
    - `netlink`: A pointer to an `fd_netlink_t` structure representing the netlink session. Must not be null.
    - `buf`: A pointer to a buffer where incoming messages will be stored. Must not be null.
    - `buf_sz`: The size of the buffer in bytes. Must be large enough to hold the expected netlink messages.
- **Output**: Returns a pointer to the initialized `fd_netlink_iter_t` structure.
- **See Also**: [`fd_netlink_iter_init`](<fd_netlink1.c.md#fd_netlink_iter_init>)  (Implementation)


---
### fd\_netlink\_iter\_done<!-- {{#callable_declaration:fd_netlink_iter_done}} -->
[View Source →](<../../../../../src/waltz/ip/fd_netlink1.h#L66>)

Checks if there are no more netlink messages to iterate over.
- **Description**: Use this function to determine if the iteration over netlink messages is complete. It returns a non-zero value if there are no more messages to process or if an error occurred during iteration. This function is typically called in a loop to check for the end of message processing. Ensure that the iterator is properly initialized before calling this function.
- **Inputs**:
    - `iter`: A pointer to a `fd_netlink_iter_t` structure representing the current state of the iteration. Must not be null. The function checks the `err` field and the difference between `msg1` and `msg0` to determine if iteration is complete.
- **Output**: Returns 1 if there are no more messages to iterate over or if an error occurred; otherwise, returns 0.
- **See Also**: [`fd_netlink_iter_done`](<fd_netlink1.c.md#fd_netlink_iter_done>)  (Implementation)


---
### fd\_netlink\_iter\_next<!-- {{#callable_declaration:fd_netlink_iter_next}} -->
[View Source →](<../../../../../src/waltz/ip/fd_netlink1.h#L73>)

Advances the iterator to the next netlink message.
- **Description**: Use this function to move to the next message in a sequence of netlink multipart messages. It must be called only when there are more messages to process, as indicated by `fd_netlink_iter_done`. This function invalidates any pointers previously returned by `fd_netlink_iter_msg`. If the current message is not part of a multipart message, the function sets an error state in the iterator.
- **Inputs**:
    - `iter`: A pointer to an `fd_netlink_iter_t` structure representing the current state of the iteration. Must not be null and must be in a valid state for iteration.
    - `netlink`: A pointer to an `fd_netlink_t` structure representing the netlink session. Must not be null.
- **Output**: Returns a pointer to the updated `fd_netlink_iter_t` structure. If the current message is not multipart, the iterator's error state is set.
- **See Also**: [`fd_netlink_iter_next`](<fd_netlink1.c.md#fd_netlink_iter_next>)  (Implementation)


---
### fd\_netlink\_rtm\_type\_str<!-- {{#callable_declaration:fd_netlink_rtm_type_str}} -->
[View Source →](<../../../../../src/waltz/ip/fd_netlink1.h#L97>)

Converts a routing message type to its string representation.
- **Description**: Use this function to obtain a human-readable string that represents a given routing message type. This is useful for debugging or logging purposes when you need to interpret or display the type of a routing message. The function maps known routing message types to their corresponding string names. If the input type is not recognized, the function returns "unknown". This function does not modify any input parameters and is safe to call with any integer value.
- **Inputs**:
    - `rtm_type`: An integer representing the routing message type. Valid values are predefined constants such as `RTN_UNSPEC`, `RTN_UNICAST`, `RTN_LOCAL`, etc. If the value does not match any known type, the function returns "unknown".
- **Output**: A constant string representing the name of the routing message type. Returns "unknown" if the input type is not recognized.
- **See Also**: [`fd_netlink_rtm_type_str`](<fd_netlink1.c.md#fd_netlink_rtm_type_str>)  (Implementation)


---
### fd\_netlink\_rtattr\_str<!-- {{#callable_declaration:fd_netlink_rtattr_str}} -->
[View Source →](<../../../../../src/waltz/ip/fd_netlink1.h#L100>)

Returns a string representation of a netlink route attribute type.
- **Description**: Use this function to get a human-readable string that corresponds to a given netlink route attribute type. This is useful for debugging or logging purposes when you need to interpret the integer values of route attribute types. The function handles a predefined set of attribute types and returns "unknown" for any type not explicitly recognized. This function is safe to call with any integer value, but only specific values will return meaningful strings.
- **Inputs**:
    - `rta_type`: An integer representing the netlink route attribute type. Valid values are predefined constants like `RTA_DST`, `RTA_SRC`, etc. The function returns "unknown" for any unrecognized values.
- **Output**: A constant string that represents the name of the netlink route attribute type. Returns "unknown" if the input type is not recognized.
- **See Also**: [`fd_netlink_rtattr_str`](<fd_netlink1.c.md#fd_netlink_rtattr_str>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)