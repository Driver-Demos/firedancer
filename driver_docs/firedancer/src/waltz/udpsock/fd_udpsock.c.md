<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implementation of a UDP socket abstraction with functions for sending, receiving, and managing packet data.

# Purpose
The code defines a C module for managing UDP socket operations with additional support for mock Ethernet and IPv4 headers. It provides a structure, `fd_udpsock_t`, which encapsulates the necessary data and operations for handling UDP communication, including file descriptors, network addresses, and packet information. The module includes functions for creating, joining, and deleting UDP socket instances, as well as setting up and managing the transmission and reception of packets. It also provides functions to configure the network layer (Ethernet or IP) and to retrieve the socket's IP address and listening port.

The module is designed to be integrated into a larger system, as indicated by its inclusion of external headers and its use of shared memory for socket management. It defines public APIs for socket lifecycle management ([`fd_udpsock_new`](<#fd_udpsock_new>), [`fd_udpsock_join`](<#fd_udpsock_join>), [`fd_udpsock_leave`](<#fd_udpsock_leave>), [`fd_udpsock_delete`](<#fd_udpsock_delete>)) and packet handling ([`fd_udpsock_service`](<#fd_udpsock_service>), [`fd_udpsock_send`](<#fd_udpsock_send>)). The code also includes utility functions for alignment and footprint calculations, ensuring that memory is correctly allocated and aligned for the socket's data structures. The use of mock headers allows for testing and simulation of network communication without requiring actual network interfaces.
# Imports and Dependencies

---
- `errno.h`
- `netinet/in.h`
- `sys/socket.h`
- `sys/stat.h`
- `sys/uio.h`
- `fd_udpsock.h`
- `../../util/net/fd_eth.h`
- `../../util/net/fd_ip4.h`
- `../../util/net/fd_udp.h`


# Data Structures

---
### fd\_udpsock
- **Type**: ``struct``
- **Members**:
    - ``aio_self``: Asynchronous I/O (AIO) provided by the UDP socket.
    - ``aio_rx``: Pointer to AIO provided by the receiver.
    - ``fd``: File descriptor of the actual socket.
    - ``hdr_sz``: Size of the header.
    - ``eth_self_addr``: Mock Ethernet self address.
    - ``eth_peer_addr``: Mock Ethernet peer address.
    - ``ip_self_addr``: Mock IP self address in network byte order.
    - ``udp_self_port``: Mock UDP self port in little endian.
    - ``rx_cnt``: Count of received packets.
    - ``rx_msg``: Pointer to an array of message headers for received packets.
    - ``rx_iov``: Pointer to an array of I/O vectors for received packets.
    - ``rx_frame``: Pointer to the frame data for received packets.
    - ``rx_pkt``: Pointer to an array of packet information for received packets.
    - ``tx_cnt``: Count of transmitted packets.
    - ``tx_msg``: Pointer to an array of message headers for transmitted packets.
    - ``tx_iov``: Pointer to an array of I/O vectors for transmitted packets.
    - ``tx_frame``: Pointer to the frame data for transmitted packets.
- **Description**: Represents a UDP socket with mock Ethernet and UDP/IPv4 fields, managing asynchronous I/O operations and variable-length data structures for packet transmission and reception.


# Functions

---
### fd\_udpsock\_align<!-- {{#callable:fd_udpsock_align}} -->
[View Source →](<../../../../../src/waltz/udpsock/fd_udpsock.c#L66>)

Returns the alignment requirement of the `fd_udpsock_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls the `alignof` operator on the `fd_udpsock_t` type to determine its alignment requirement.
    - Returns the result of the `alignof` operation.
- **Output**: The alignment requirement of the `fd_udpsock_t` structure as an `ulong`.


---
### fd\_udpsock\_footprint<!-- {{#callable:fd_udpsock_footprint}} -->
[View Source →](<../../../../../src/waltz/udpsock/fd_udpsock.c#L71>)

Calculates the memory footprint required for a UDP socket structure based on the given MTU and packet counts.
- **Inputs**:
    - `mtu`: The maximum transmission unit size in bytes.
    - `rx_pkt_cnt`: The number of packets expected to be received.
    - `tx_pkt_cnt`: The number of packets expected to be transmitted.
- **Logic and Control Flow**:
    - Check if `mtu` is zero, less than or equal to `FD_UDPSOCK_HEADROOM`, or if `rx_pkt_cnt` or `tx_pkt_cnt` is zero; if any condition is true, return 0.
    - Calculate `tot_pkt_cnt` as the sum of `rx_pkt_cnt` and `tx_pkt_cnt`.
    - Align `mtu` to `FD_UDPSOCK_FRAME_ALIGN` using `fd_ulong_align_up`.
    - Calculate the total memory footprint using a series of `FD_LAYOUT_APPEND` calls to account for the alignment and size of various structures (`fd_udpsock_t`, `struct mmsghdr`, `struct iovec`, packet frames, `fd_aio_pkt_info_t`, and `struct sockaddr_in`).
    - Return the final calculated footprint using `FD_LAYOUT_FINI`.
- **Output**: Returns the calculated memory footprint as an unsigned long integer.


---
### fd\_udpsock\_new<!-- {{#callable:fd_udpsock_new}} -->
[View Source →](<../../../../../src/waltz/udpsock/fd_udpsock.c#L98>)

Initializes a new UDP socket structure in shared memory with specified MTU and packet counts for receiving and transmitting.
- **Inputs**:
    - `shmem`: Pointer to shared memory where the UDP socket structure will be initialized.
    - `mtu`: Maximum Transmission Unit size for the UDP socket.
    - `rx_pkt_cnt`: Number of packets that can be received.
    - `tx_pkt_cnt`: Number of packets that can be transmitted.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL and log a warning if true, then return NULL.
    - Convert `shmem` to an unsigned long and check if it is aligned according to `fd_udpsock_align()`, log a warning and return NULL if not aligned.
    - Calculate the footprint using `fd_udpsock_footprint()` and log a warning if it is invalid, then return NULL.
    - Align the address for the main structure and initialize a `fd_udpsock_t` structure, setting default values for its fields.
    - Calculate total packet count and aligned MTU, then set default mock network headers for Ethernet and IP/UDP.
    - Allocate and align memory for variable-length data structures such as `mmsghdr`, `iovec`, and packet frames.
    - Prepare `iovec` and `msghdr` buffers for receiving and transmitting packets.
    - Set the default layer for the UDP socket to Ethernet using `fd_udpsock_set_layer()`.
- **Output**: Returns a pointer to the initialized shared memory if successful, or NULL if any error occurs during initialization.
- **Functions Called**:
    - [`fd_udpsock_align`](<#fd_udpsock_align>)
    - [`fd_udpsock_footprint`](<#fd_udpsock_footprint>)
    - [`fd_udpsock_set_layer`](<#fd_udpsock_set_layer>)


---
### fd\_udpsock\_join<!-- {{#callable:fd_udpsock_join}} -->
[View Source →](<../../../../../src/waltz/udpsock/fd_udpsock.c#L197>)

Initializes a UDP socket structure with a given file descriptor and extracts its IPv4 address and port.
- **Inputs**:
    - `shsock`: A pointer to a shared memory region that will be cast to a `fd_udpsock_t` structure.
    - `fd`: A file descriptor for the UDP socket to join.
- **Logic and Control Flow**:
    - Check if `shsock` is NULL; if so, log a warning and return NULL.
    - Cast `shsock` to a `fd_udpsock_t` pointer and assign the file descriptor `fd` to `sock->fd`.
    - Declare a `sockaddr` structure and a `socklen_t` variable to store the socket address length.
    - Call `getsockname` to retrieve the socket's address; if it fails, log a warning and return NULL.
    - Check if the socket address family is not `AF_INET`; if so, log a warning and return NULL.
    - Cast the socket address to a `sockaddr_in` structure and extract the IPv4 address and port, storing them in `sock->ip_self_addr` and `sock->udp_self_port`, respectively.
    - Return the initialized `fd_udpsock_t` structure.
- **Output**: A pointer to the initialized `fd_udpsock_t` structure, or NULL if an error occurs.


---
### fd\_udpsock\_leave<!-- {{#callable:fd_udpsock_leave}} -->
[View Source →](<../../../../../src/waltz/udpsock/fd_udpsock.c#L228>)

Sets the file descriptor of a UDP socket to -1 and returns the socket pointer.
- **Inputs**:
    - `sock`: A pointer to an `fd_udpsock_t` structure representing the UDP socket to leave.
- **Logic and Control Flow**:
    - Check if `sock` is NULL using `FD_UNLIKELY`; if true, log a warning and return NULL.
    - Set the `fd` field of the `sock` structure to -1, indicating the socket is no longer in use.
    - Return the `sock` pointer cast to a `void *`.
- **Output**: Returns a `void *` pointer to the `fd_udpsock_t` structure, or NULL if the input `sock` is NULL.


---
### fd\_udpsock\_delete<!-- {{#callable:fd_udpsock_delete}} -->
[View Source →](<../../../../../src/waltz/udpsock/fd_udpsock.c#L238>)

Checks if the input `shsock` is NULL and returns it if not.
- **Inputs**:
    - `shsock`: A pointer to a shared socket object that the function will check and return.
- **Logic and Control Flow**:
    - Check if `shsock` is NULL using `FD_UNLIKELY` macro.
    - If `shsock` is NULL, log a warning message 'NULL shsock' and return NULL.
    - If `shsock` is not NULL, return `shsock`.
- **Output**: Returns the input `shsock` if it is not NULL; otherwise, returns NULL.


---
### fd\_udpsock\_set\_rx<!-- {{#callable:fd_udpsock_set_rx}} -->
[View Source →](<../../../../../src/waltz/udpsock/fd_udpsock.c#L247>)

Sets the receive asynchronous I/O (AIO) handler for a UDP socket.
- **Inputs**:
    - `sock`: A pointer to the `fd_udpsock_t` structure representing the UDP socket.
    - `aio`: A constant pointer to the `fd_aio_t` structure representing the AIO handler to be set for receiving data.
- **Logic and Control Flow**:
    - Assigns the `aio` parameter to the `aio_rx` member of the `sock` structure.
- **Output**: No output is returned as the function has a void return type.


---
### fd\_udpsock\_get\_tx<!-- {{#callable:fd_udpsock_get_tx}} -->
[View Source →](<../../../../../src/waltz/udpsock/fd_udpsock.c#L253>)

Returns a constant pointer to the `aio_self` member of a `fd_udpsock_t` structure.
- **Inputs**:
    - `sock`: A pointer to a `fd_udpsock_t` structure from which to retrieve the `aio_self` member.
- **Logic and Control Flow**:
    - Accesses the `aio_self` member of the `fd_udpsock_t` structure pointed to by `sock`.
    - Returns a constant pointer to the `aio_self` member.
- **Output**: A constant pointer to the `aio_self` member of the `fd_udpsock_t` structure.


---
### fd\_udpsock\_service<!-- {{#callable:fd_udpsock_service}} -->
[View Source →](<../../../../../src/waltz/udpsock/fd_udpsock.c#L258>)

Processes incoming UDP packets, constructs network headers, and dispatches them to a recipient.
- **Inputs**:
    - `sock`: A pointer to an `fd_udpsock_t` structure representing the UDP socket to service.
- **Logic and Control Flow**:
    - Receive packets using `recvmmsg` into the `rx_msg` array of the `sock` structure.
    - Check if the `recvmmsg` call failed; if so, log a warning and return if the error is not `EAGAIN` or `EWOULDBLOCK`.
    - Iterate over the received messages to construct fake Ethernet and IP headers if necessary, based on the `hdr_sz` field of the `sock`.
    - For each message, create an IP header and a UDP header, setting fields such as source and destination addresses and ports.
    - Convert the IP header to network byte order and calculate its checksum.
    - Store the packet information in the `rx_pkt` array of the `sock` structure.
    - Dispatch the packets to the recipient using `fd_aio_send`, ignoring any errors.
- **Output**: No return value; the function operates on the `sock` structure to process and dispatch packets.


---
### fd\_udpsock\_send<!-- {{#callable:fd_udpsock_send}} -->
[View Source →](<../../../../../src/waltz/udpsock/fd_udpsock.c#L328>)

Sends a batch of UDP packets using a socket context, handling IP and UDP header processing and error conditions.
- **Inputs**:
    - `ctx`: A pointer to the socket context (`fd_udpsock_t`).
    - `batch`: A pointer to an array of packet information (`fd_aio_pkt_info_t`).
    - `batch_cnt`: The number of packets in the batch.
    - `opt_batch_idx`: A pointer to store the index of the batch in case of partial sends or errors.
    - `flush`: A flag indicating whether to block until all packets are sent (non-zero) or to return immediately if the operation would block (zero).
- **Logic and Control Flow**:
    - Cast `ctx` to `fd_udpsock_t` to access the socket context.
    - Check if `batch_cnt` is zero; if so, return `FD_AIO_SUCCESS`.
    - Determine the number of packets to send (`send_cnt`) based on the lesser of `batch_cnt` and `sock->tx_cnt`.
    - Initialize a dummy batch index if `opt_batch_idx` is NULL.
    - Iterate over each packet in the batch up to `send_cnt`.
    - For each packet, check if the buffer size is less than the header size; if so, skip the packet.
    - If the header size is 42, check if the packet is an IP packet; if not, skip it.
    - Convert IP and UDP headers to host byte order and extract destination address and port.
    - Set up the `iovec` structure for each valid packet, including payload and address information.
    - Use `sendmmsg` to send the packets, handling errors and setting `opt_batch_idx` appropriately.
    - Return `FD_AIO_SUCCESS` if all packets are sent, or an error code if not.
- **Output**: Returns `FD_AIO_SUCCESS` on successful send of all packets, `FD_AIO_ERR_AGAIN` if the operation should be retried, or `FD_AIO_ERR_INVAL` on invalid operation.


---
### fd\_udpsock\_get\_ip4\_address<!-- {{#callable:fd_udpsock_get_ip4_address}} -->
[View Source →](<../../../../../src/waltz/udpsock/fd_udpsock.c#L394>)

Retrieves the IPv4 address of the UDP socket in network byte order.
- **Inputs**:
    - `sock`: A pointer to a constant `fd_udpsock_t` structure representing the UDP socket.
- **Logic and Control Flow**:
    - Accesses the `ip_self_addr` field of the `fd_udpsock_t` structure pointed to by `sock`.
    - Returns the value of `ip_self_addr`, which is the IPv4 address in network byte order.
- **Output**: The function returns the IPv4 address of the UDP socket in network byte order as an unsigned integer.


---
### fd\_udpsock\_get\_listen\_port<!-- {{#callable:fd_udpsock_get_listen_port}} -->
[View Source →](<../../../../../src/waltz/udpsock/fd_udpsock.c#L399>)

Retrieves the UDP listening port number from a given UDP socket structure.
- **Inputs**:
    - `sock`: A pointer to a constant `fd_udpsock_t` structure representing the UDP socket.
- **Logic and Control Flow**:
    - Access the `udp_self_port` field of the `fd_udpsock_t` structure pointed to by `sock`.
    - Return the value of `udp_self_port`.
- **Output**: Returns the UDP listening port number as an unsigned integer.


---
### fd\_udpsock\_set\_layer<!-- {{#callable:fd_udpsock_set_layer}} -->
[View Source →](<../../../../../src/waltz/udpsock/fd_udpsock.c#L404>)

Sets the header size of a UDP socket based on the specified network layer.
- **Inputs**:
    - `sock`: A pointer to a `fd_udpsock_t` structure representing the UDP socket.
    - `layer`: An unsigned integer representing the network layer to set, either `FD_UDPSOCK_LAYER_ETH` or `FD_UDPSOCK_LAYER_IP`.
- **Logic and Control Flow**:
    - Check the value of `layer` using a switch statement.
    - If `layer` is `FD_UDPSOCK_LAYER_ETH`, set `sock->hdr_sz` to the combined size of Ethernet, IPv4, and UDP headers.
    - If `layer` is `FD_UDPSOCK_LAYER_IP`, set `sock->hdr_sz` to the combined size of IPv4 and UDP headers.
    - If `layer` is not recognized, log a warning and return `NULL`.
    - Return the `sock` pointer if the layer is valid.
- **Output**: Returns a pointer to the `fd_udpsock_t` structure if successful, or `NULL` if the layer is invalid.


# Function Declarations (Public API)

---
### fd\_udpsock\_send<!-- {{#callable_declaration:fd_udpsock_send}} -->
[View Source →](<../../../../../src/waltz/udpsock/fd_udpsock.c#L59>)

Sends a batch of UDP packets through a socket.
- **Description**: Use this function to send a batch of UDP packets through a specified socket context. It processes the packets in the batch, skipping those that are not IP packets or have insufficient buffer size. The function can handle up to the maximum number of packets the socket can transmit in one call. If the `flush` parameter is set, the function will block until all packets are sent; otherwise, it will return immediately if the socket is not ready to send. The function returns success or an error code indicating whether the operation should be retried or if an invalid parameter was provided.
- **Inputs**:
    - `ctx`: A pointer to the socket context (`fd_udpsock_t`). Must not be null.
    - `batch`: A pointer to an array of `fd_aio_pkt_info_t` structures representing the packets to send. Must not be null.
    - `batch_cnt`: The number of packets in the batch. Must be greater than zero.
    - `opt_batch_idx`: An optional pointer to a variable that will receive the index of the first unsent packet if the function returns an error. Can be null.
    - `flush`: An integer flag indicating whether to block until all packets are sent (non-zero) or to return immediately if the socket is not ready (zero).
- **Output**: Returns an integer status code: `FD_AIO_SUCCESS` on success, `FD_AIO_ERR_AGAIN` if the operation should be retried, or `FD_AIO_ERR_INVAL` if an invalid parameter was provided.
- **See Also**: [`fd_udpsock_send`](<#fd_udpsock_send>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)