<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

A UDP echo server test that swaps source and destination addresses in received packets.

# Purpose
The code is a C program that implements a simple UDP echo server. It listens for incoming UDP packets on a specified port, swaps the source and destination addresses and ports in the packet headers, and sends the modified packets back to the original sender. The program uses several utility functions and structures, such as `fd_udpsock_t` for managing UDP sockets and `fd_aio_t` for asynchronous input/output operations. The [`echo_aio_recv`](<#echo_aio_recv>) function is responsible for processing each received packet by swapping the UDP/IP source and destination addresses and ports, decrementing the IP time-to-live (TTL) value, and then sending the packet back using the `fd_aio_send` function.

The [`main`](<#main>) function initializes the environment, creates a UDP socket, and binds it to the specified port. It then allocates resources for handling UDP packets, including setting up the asynchronous I/O context with the [`echo_aio_recv`](<#echo_aio_recv>) callback function. The program enters an infinite loop where it continuously services the UDP socket to handle incoming packets. Upon termination, it cleans up resources by deleting the asynchronous I/O context and the UDP socket, and closes the socket file descriptor. The program logs various events and errors using the `FD_LOG_NOTICE` and `FD_LOG_ERR` macros.
# Imports and Dependencies

---
- `../../util/fd_util.h`
- `fd_udpsock.h`
- `errno.h`
- `stdlib.h`
- `unistd.h`
- `sys/socket.h`
- `arpa/inet.h`
- `netinet/in.h`
- `../../util/net/fd_eth.h`
- `../../util/net/fd_ip4.h`
- `../../util/net/fd_udp.h`


# Functions

---
### echo\_aio\_recv<!-- {{#callable:echo_aio_recv}} -->
[View Source →](<../../../../../src/waltz/udpsock/test_udpsock_echo.c#L13>)

Swaps the source and destination addresses of UDP/IP packets and sends them using asynchronous I/O.
- **Inputs**:
    - `ctx`: A pointer to the context, which is expected to be a `fd_aio_t` structure for asynchronous I/O operations.
    - `batch`: A pointer to an array of `fd_aio_pkt_info_t` structures, each containing a buffer with a packet to process.
    - `batch_cnt`: The number of packets in the `batch` array.
    - `opt_batch_idx`: An optional pointer to a variable that can store the index of the batch being processed.
    - `flush`: An integer flag indicating whether to flush the send operation.
- **Logic and Control Flow**:
    - Iterates over each packet in the `batch` array.
    - For each packet, retrieves the Ethernet, IP, and UDP headers from the packet buffer.
    - Copies the source and destination IP addresses and UDP ports from the headers.
    - Swaps the source and destination IP addresses and UDP ports.
    - Decrements the IP header's TTL (Time To Live) field by one.
    - Calls `fd_aio_send` to send the modified packets using the context `ctx`.
- **Output**: Returns `FD_AIO_SUCCESS` to indicate successful processing and sending of packets.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/waltz/udpsock/test_udpsock_echo.c#L45>)

Initializes and runs a UDP echo server that listens on a specified port and echoes received packets back to the sender.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
- **Logic and Control Flow**:
    - Call `fd_boot` to initialize the environment with command-line arguments.
    - Extract the port number from the command-line arguments using `fd_env_strip_cmdline_ushort`, defaulting to 8080 if not specified.
    - Log a notice indicating the server is listening on the specified port.
    - Create a UDP socket using `socket` with `AF_INET`, `SOCK_DGRAM`, and `IPPROTO_UDP`.
    - Check if socket creation failed and log an error if it did.
    - Set up a `sockaddr_in` structure for the server to listen on all interfaces at the specified port.
    - Bind the socket to the address and port, logging an error if binding fails.
    - Allocate and initialize a `fd_udpsock_t` structure for UDP socket management with specified MTU and packet counts.
    - Join the UDP socket to the `fd_udpsock_t` structure and test for success.
    - Create and join an `fd_aio_t` structure for asynchronous I/O operations, using `echo_aio_recv` as the receive callback.
    - Set the receive callback for the UDP socket to the `fd_aio_t` structure.
    - Enter an infinite loop calling [`fd_udpsock_service`](<fd_udpsock.c.md#fd_udpsock_service>) to process incoming packets.
    - Log a notice indicating cleanup is starting.
    - Delete and free the `fd_aio_t` and `fd_udpsock_t` structures.
    - Close the socket and log an error if closing fails.
    - Log a notice indicating successful completion and call `fd_halt` to terminate the program.
- **Output**: Returns 0 upon successful execution.
- **Functions Called**:
    - [`fd_udpsock_join`](<fd_udpsock.c.md#fd_udpsock_join>)
    - [`fd_udpsock_new`](<fd_udpsock.c.md#fd_udpsock_new>)
    - [`fd_udpsock_align`](<fd_udpsock.c.md#fd_udpsock_align>)
    - [`fd_udpsock_footprint`](<fd_udpsock.c.md#fd_udpsock_footprint>)
    - [`fd_udpsock_get_tx`](<fd_udpsock.c.md#fd_udpsock_get_tx>)
    - [`fd_udpsock_set_rx`](<fd_udpsock.c.md#fd_udpsock_set_rx>)
    - [`fd_udpsock_service`](<fd_udpsock.c.md#fd_udpsock_service>)
    - [`fd_udpsock_delete`](<fd_udpsock.c.md#fd_udpsock_delete>)
    - [`fd_udpsock_leave`](<fd_udpsock.c.md#fd_udpsock_leave>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)