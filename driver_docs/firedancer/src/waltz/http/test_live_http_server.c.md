<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests a live HTTP server with signal handling, request processing, and WebSocket support.

# Purpose
The code is an implementation of a simple HTTP server with WebSocket support. It uses the `fd_http_server` library to handle HTTP requests and WebSocket connections. The server is configured to handle a limited number of connections and WebSocket connections, and it processes incoming HTTP requests by checking the request method and responding accordingly. For GET requests, it serves an HTML page or upgrades the connection to a WebSocket if requested. For other methods, it processes the request body and responds with a JSON-RPC formatted message.

The server includes signal handling to allow graceful shutdown on receiving a SIGINT signal. It defines several callback functions for handling HTTP requests, WebSocket events, and connection closures. The [`main`](<#main>) function initializes the server, sets up the signal handler, and enters a loop to poll for incoming connections and requests. The server periodically broadcasts a JSON message to all WebSocket clients. The code is structured to be compiled and executed as a standalone application, providing a basic HTTP and WebSocket server for testing or demonstration purposes.
# Imports and Dependencies

---
- `fd_http_server.h`
- `../../util/fd_util.h`
- `signal.h`
- `stdio.h`
- `errno.h`
- `stdlib.h`


# Global Variables

---
### stop
- **Type**: ``int``
- **Description**: A static volatile integer variable that indicates whether the server should stop running. It is initialized to 0, meaning the server should continue running.
- **Use**: Used in the main loop to determine when to exit the loop and stop the server, typically set to 1 by a signal handler when a termination signal is received.


# Data Structures

---
### test\_http\_server
- **Type**: ``struct``
- **Members**:
    - ``http``: A pointer to an `fd_http_server_t` instance, representing the HTTP server.
- **Description**: Manages an HTTP server by holding a pointer to an `fd_http_server_t` instance, which is used to handle HTTP requests and responses.


---
### test\_http\_server\_t
- **Type**: ``struct``
- **Members**:
    - ``http``: A pointer to an `fd_http_server_t` instance.
- **Description**: Encapsulates an HTTP server by holding a pointer to an `fd_http_server_t` instance, which manages HTTP server operations and interactions.


# Functions

---
### signal\_handler<!-- {{#callable:signal_handler}} -->
[View Source →](<../../../../../src/waltz/http/test_live_http_server.c#L11>)

Handles a signal by setting a stop flag to 1.
- **Inputs**:
    - `sig`: The signal number received by the handler, which is ignored in this function.
- **Logic and Control Flow**:
    - Casts the input signal number to void to indicate it is unused.
    - Sets the global variable `stop` to 1, which is used to signal the program to stop running.
- **Output**: No output is returned from this function.


---
### install\_signal\_handler<!-- {{#callable:install_signal_handler}} -->
[View Source →](<../../../../../src/waltz/http/test_live_http_server.c#L17>)

Sets up a signal handler for `SIGINT` to allow graceful termination of the program.
- **Inputs**: None
- **Logic and Control Flow**:
    - Defines a `sigaction` structure `sa` with `sa_handler` set to `signal_handler` and `sa_flags` set to 0.
    - Calls `sigaction` to associate the `SIGINT` signal with the `signal_handler` function using the `sa` structure.
    - Checks if `sigaction` fails using `FD_UNLIKELY`, and logs an error message with `FD_LOG_ERR` if it does.
- **Output**: No output is returned.


---
### request<!-- {{#callable:request}} -->
[View Source →](<../../../../../src/waltz/http/test_live_http_server.c#L34>)

Processes HTTP server requests and generates appropriate responses based on the request method and headers.
- **Inputs**:
    - ``request``: A pointer to a `fd_http_server_request_t` structure containing details of the HTTP request, such as method, path, headers, and context.
- **Logic and Control Flow**:
    - Cast the `ctx` field of the `request` to a `test_http_server_t` pointer and store it in `state`.
    - Log the request details including connection ID, method, path, content type, and context.
    - Check if the request method is `FD_HTTP_SERVER_METHOD_GET`.
    - If the method is GET and the `upgrade_websocket` header is true, create a response with status 200, set `upgrade_websocket` to 1, and content type to `application/json`, then return it.
    - If the method is GET and `upgrade_websocket` is false, send an HTML response with a simple "Hello, world!" message, create a response with status 200, set `upgrade_websocket` to 0, and content type to `text/html`, then return it.
    - If the method is not GET, write the request body to standard output, send a JSON-RPC response, create a response with status 200, set `upgrade_websocket` to 0, and content type to `application/json`, then return it.
- **Output**: Returns a `fd_http_server_response_t` structure containing the HTTP response details, such as status, upgrade_websocket flag, and content type.
- **Functions Called**:
    - [`fd_http_server_method_str`](<fd_http_server.c.md#fd_http_server_method_str>)
    - [`fd_http_server_printf`](<fd_http_server.c.md#fd_http_server_printf>)
    - [`fd_http_server_stage_body`](<fd_http_server.c.md#fd_http_server_stage_body>)


---
### http\_close<!-- {{#callable:http_close}} -->
[View Source →](<../../../../../src/waltz/http/test_live_http_server.c#L79>)

Logs the closure of an HTTP connection with its ID, reason, and context.
- **Inputs**:
    - `conn_id`: The unique identifier for the HTTP connection to close.
    - `reason`: The reason code for closing the connection.
    - `ctx`: A pointer to the context associated with the connection.
- **Logic and Control Flow**:
    - Logs a notice message indicating the closure of an HTTP connection.
    - Uses the `FD_LOG_NOTICE` macro to format and output the log message.
    - Includes the connection ID, the string representation of the reason, and the context in the log message.
- **Output**: No return value; the function performs logging as a side effect.
- **Functions Called**:
    - [`fd_http_server_connection_close_reason_str`](<fd_http_server.c.md#fd_http_server_connection_close_reason_str>)


---
### ws\_open<!-- {{#callable:ws_open}} -->
[View Source →](<../../../../../src/waltz/http/test_live_http_server.c#L86>)

Logs a notice message when a WebSocket connection opens.
- **Inputs**:
    - ``ws_conn_id``: The unique identifier for the WebSocket connection.
    - ``ctx``: A pointer to the context associated with the WebSocket connection.
- **Logic and Control Flow**:
    - Logs a notice message using `FD_LOG_NOTICE` with the WebSocket connection ID and context pointer.
- **Output**: No output is returned as the function is of type `void`.


---
### ws\_close<!-- {{#callable:ws_close}} -->
[View Source →](<../../../../../src/waltz/http/test_live_http_server.c#L92>)

Logs a WebSocket connection closure event with the connection ID, reason, and context.
- **Inputs**:
    - `ws_conn_id`: The unique identifier for the WebSocket connection.
    - `reason`: The reason code for closing the WebSocket connection.
    - `ctx`: A pointer to the context associated with the WebSocket connection.
- **Logic and Control Flow**:
    - Logs a notice message using `FD_LOG_NOTICE` with the WebSocket connection ID, the string representation of the reason for closure, and the context pointer.
    - Uses [`fd_http_server_connection_close_reason_str`](<fd_http_server.c.md#fd_http_server_connection_close_reason_str>) to convert the reason code into a human-readable string.
- **Output**: No return value; the function performs logging as a side effect.
- **Functions Called**:
    - [`fd_http_server_connection_close_reason_str`](<fd_http_server.c.md#fd_http_server_connection_close_reason_str>)


---
### ws\_message<!-- {{#callable:ws_message}} -->
[View Source →](<../../../../../src/waltz/http/test_live_http_server.c#L99>)

Logs a WebSocket message and writes it to the standard output.
- **Inputs**:
    - `ws_conn_id`: The WebSocket connection identifier.
    - `data`: A pointer to the data received in the WebSocket message.
    - `data_len`: The length of the data received.
    - `ctx`: A context pointer, typically used to pass additional information.
- **Logic and Control Flow**:
    - Logs the WebSocket connection ID and context using `FD_LOG_NOTICE`.
    - Writes the string '>>>' to the standard output.
    - Writes the received data to the standard output using `fwrite`.
    - Writes the string '<<<\n' to the standard output.
- **Output**: No return value; the function performs logging and output operations.


---
### ws\_send\_all<!-- {{#callable:ws_send_all}} -->
[View Source →](<../../../../../src/waltz/http/test_live_http_server.c#L110>)

Sends a JSON-RPC response to all connected WebSocket clients and verifies the broadcast operation.
- **Inputs**:
    - `http`: A pointer to an `fd_http_server_t` structure representing the HTTP server instance.
- **Logic and Control Flow**:
    - Calls [`fd_http_server_printf`](<fd_http_server.c.md#fd_http_server_printf>) to send a JSON-RPC response with a result of 0 and an ID of 1 to the HTTP server.
    - Uses `FD_TEST` to assert that [`fd_http_server_ws_broadcast`](<fd_http_server.c.md#fd_http_server_ws_broadcast>) returns a non-error value, indicating successful broadcast to all WebSocket clients.
- **Output**: No return value; the function performs actions on the HTTP server instance.
- **Functions Called**:
    - [`fd_http_server_printf`](<fd_http_server.c.md#fd_http_server_printf>)
    - [`fd_http_server_ws_broadcast`](<fd_http_server.c.md#fd_http_server_ws_broadcast>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/waltz/http/test_live_http_server.c#L116>)

Initializes and runs an HTTP server with WebSocket support, handling requests and managing server lifecycle.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Defines `fd_http_server_params_t` with server parameters such as maximum connections and buffer sizes.
    - Defines `fd_http_server_callbacks_t` with callback functions for handling HTTP requests and WebSocket events.
    - Creates and joins a new HTTP server instance using [`fd_http_server_new`](<fd_http_server.c.md#fd_http_server_new>) and [`fd_http_server_join`](<fd_http_server.c.md#fd_http_server_join>).
    - Starts listening on port 4321 using [`fd_http_server_listen`](<fd_http_server.c.md#fd_http_server_listen>).
    - Logs a notice to run a test script `test_http_server.py`.
    - Installs a signal handler to handle `SIGINT` for graceful shutdown.
    - Enters a loop that continues until `stop` is set to 1 by the signal handler.
    - Within the loop, polls the HTTP server for events using [`fd_http_server_poll`](<fd_http_server.c.md#fd_http_server_poll>).
    - Checks if one second has passed since the last WebSocket broadcast and sends a message to all WebSocket clients if true.
    - Frees resources by deleting and leaving the HTTP server instance when the loop exits.
    - Logs a notice indicating successful execution and calls `fd_halt` to terminate the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`fd_http_server_join`](<fd_http_server.c.md#fd_http_server_join>)
    - [`fd_http_server_new`](<fd_http_server.c.md#fd_http_server_new>)
    - [`fd_http_server_align`](<fd_http_server.c.md#fd_http_server_align>)
    - [`fd_http_server_footprint`](<fd_http_server.c.md#fd_http_server_footprint>)
    - [`fd_http_server_listen`](<fd_http_server.c.md#fd_http_server_listen>)
    - [`install_signal_handler`](<#install_signal_handler>)
    - [`fd_http_server_poll`](<fd_http_server.c.md#fd_http_server_poll>)
    - [`ws_send_all`](<#ws_send_all>)
    - [`fd_http_server_delete`](<fd_http_server.c.md#fd_http_server_delete>)
    - [`fd_http_server_leave`](<fd_http_server.c.md#fd_http_server_leave>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)