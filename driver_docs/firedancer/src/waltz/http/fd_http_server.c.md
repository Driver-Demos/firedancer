<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implementation of an HTTP server with WebSocket support, connection management, and optional ZSTD compression.

# Purpose
The code is a C implementation of an HTTP server with WebSocket support. It provides functionality for handling HTTP requests and WebSocket connections, including connection management, request parsing, response generation, and data transmission. The server uses a pool and treap data structures to manage HTTP and WebSocket connections efficiently. It supports various HTTP methods such as GET, POST, and PUT, and can handle WebSocket upgrades and communication.

Key components of the code include functions for creating, joining, and deleting HTTP server instances, managing connection pools and treaps, and handling network events using the `poll` system call. The server can accept new connections, read incoming data, and write responses. It also includes mechanisms for handling WebSocket frames, including compression using Zstandard (ZSTD) if enabled. The code defines several constants and macros for configuration and uses external libraries for HTTP parsing and cryptographic operations. The server provides a public API for initializing and managing server instances, handling connections, and sending data over WebSocket connections.
# Imports and Dependencies

---
- `fd_http_server_private.h`
- `picohttpparser.h`
- `../../ballet/sha1/fd_sha1.h`
- `../../ballet/base64/fd_base64.h`
- `../../util/net/fd_ip4.h`
- `stdarg.h`
- `stdio.h`
- `errno.h`
- `unistd.h`
- `poll.h`
- `stdlib.h`
- `strings.h`
- `sys/socket.h`
- `netinet/in.h`
- `zstd.h`
- `../../util/tmpl/fd_pool.c`
- `../../util/tmpl/fd_treap.c`


# Functions

---
### fd\_http\_server\_connection\_close\_reason\_str<!-- {{#callable:fd_http_server_connection_close_reason_str}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L61>)

Maps an integer reason code to a corresponding string description for HTTP server connection closure reasons.
- **Inputs**:
    - `reason`: An integer representing the reason code for closing an HTTP server connection.
- **Logic and Control Flow**:
    - Uses a `switch` statement to match the `reason` code with predefined constants representing different closure reasons.
    - For each matched case, returns a string that describes the reason for the connection closure.
    - If the `reason` code does not match any predefined case, returns the string "unknown".
- **Output**: A constant character pointer to a string that describes the reason for the connection closure.


---
### fd\_http\_server\_method\_str<!-- {{#callable:fd_http_server_method_str}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L93>)

Maps an HTTP method code to its corresponding string representation.
- **Inputs**:
    - `method`: An unsigned character representing the HTTP method code.
- **Logic and Control Flow**:
    - Checks the value of `method` using a switch statement.
    - Returns "GET" if `method` is `FD_HTTP_SERVER_METHOD_GET`.
    - Returns "POST" if `method` is `FD_HTTP_SERVER_METHOD_POST`.
    - Returns "PUT" if `method` is `FD_HTTP_SERVER_METHOD_PUT`.
    - Returns "unknown" for any other value of `method`.
- **Output**: A constant character pointer to the string representation of the HTTP method.


---
### fd\_http\_server\_align<!-- {{#callable:fd_http_server_align}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L105>)

Returns the alignment requirement for the HTTP server.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the constant `FD_HTTP_SERVER_ALIGN`.
- **Output**: The function returns an `ulong` representing the alignment requirement for the HTTP server.


---
### fd\_http\_server\_footprint<!-- {{#callable:fd_http_server_footprint}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L110>)

Calculates the memory footprint required for an HTTP server based on given parameters.
- **Inputs**:
    - `params`: A structure of type `fd_http_server_params_t` containing parameters such as maximum connection counts and buffer sizes.
- **Logic and Control Flow**:
    - Initialize a variable `l` with `FD_LAYOUT_INIT` to start the layout calculation.
    - Append the size of `fd_http_server_t` to `l` with alignment `FD_HTTP_SERVER_ALIGN`.
    - Append the footprint of connection pool, WebSocket connection pool, connection treap, and WebSocket connection treap to `l` using their respective alignment and footprint functions.
    - Append the size of an array of `struct pollfd` based on the sum of maximum connection counts to `l`.
    - Append the size of request and WebSocket receive frame buffers based on their respective maximum lengths and connection counts to `l`.
    - Append the size of WebSocket send frame buffer based on its maximum frame count and connection count to `l`.
    - Append the outgoing buffer size to `l`.
    - If ZSTD compression is enabled, append the estimated size of a ZSTD compression context to `l`.
    - Finalize the layout calculation with `FD_LAYOUT_FINI` using the alignment of the HTTP server.
- **Output**: Returns an `ulong` representing the total memory footprint required for the HTTP server.
- **Functions Called**:
    - [`fd_http_server_align`](<#fd_http_server_align>)


---
### fd\_http\_server\_new<!-- {{#callable:fd_http_server_new}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L129>)

Initializes a new HTTP server instance using shared memory and specified parameters and callbacks.
- **Inputs**:
    - ``shmem``: Pointer to shared memory for server allocation.
    - ``params``: Structure containing server parameters such as maximum connection counts and buffer sizes.
    - ``callbacks``: Structure containing callback functions for server events.
    - ``callback_ctx``: Context pointer passed to callback functions.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL or misaligned; log a warning and return NULL if true.
    - Validate WebSocket frame length against request length; log a warning and return NULL if invalid.
    - Initialize scratch memory allocator with `shmem`.
    - Allocate memory for server structures and connection pools using `FD_SCRATCH_ALLOC_APPEND`.
    - Set server parameters and initialize connection and WebSocket connection pools and treaps.
    - Initialize poll file descriptors and connection structures for HTTP and WebSocket connections.
    - Set up ZSTD compression context if available and enabled.
    - Return a pointer to the initialized `fd_http_server_t` structure.
- **Output**: Returns a pointer to the newly created `fd_http_server_t` structure, or NULL if initialization fails.
- **Functions Called**:
    - [`fd_http_server_align`](<#fd_http_server_align>)


---
### fd\_http\_server\_join<!-- {{#callable:fd_http_server_join}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L225>)

Validates and returns a pointer to an `fd_http_server_t` structure if the input pointer is valid and properly aligned.
- **Inputs**:
    - ``shhttp``: A pointer to a shared memory region that is expected to contain an `fd_http_server_t` structure.
- **Logic and Control Flow**:
    - Check if `shhttp` is NULL; if so, log a warning and return NULL.
    - Check if `shhttp` is aligned according to [`fd_http_server_align`](<#fd_http_server_align>); if not, log a warning and return NULL.
    - Cast `shhttp` to an `fd_http_server_t` pointer and store it in `http`.
    - Check if the `magic` field of `http` matches `FD_HTTP_SERVER_MAGIC`; if not, log a warning and return NULL.
    - Return the `http` pointer.
- **Output**: A pointer to an `fd_http_server_t` structure if all checks pass, otherwise NULL.
- **Functions Called**:
    - [`fd_http_server_align`](<#fd_http_server_align>)


---
### fd\_http\_server\_leave<!-- {{#callable:fd_http_server_leave}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L248>)

Returns the input `fd_http_server_t` pointer if it is not NULL, otherwise logs a warning and returns NULL.
- **Inputs**:
    - `http`: A pointer to an `fd_http_server_t` structure, representing the HTTP server instance to leave.
- **Logic and Control Flow**:
    - Check if the `http` pointer is NULL using `FD_UNLIKELY` macro.
    - If `http` is NULL, log a warning message 'NULL http' and return NULL.
    - If `http` is not NULL, cast it to a `void *` and return it.
- **Output**: A `void *` pointer to the `fd_http_server_t` structure if `http` is not NULL, otherwise NULL.


---
### fd\_http\_server\_delete<!-- {{#callable:fd_http_server_delete}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L259>)

Validates and deletes an HTTP server instance if it is correctly aligned and has a valid magic number.
- **Inputs**:
    - `shhttp`: A pointer to the shared HTTP server instance to delete.
- **Logic and Control Flow**:
    - Check if `shhttp` is NULL; if so, log a warning and return NULL.
    - Check if `shhttp` is aligned according to [`fd_http_server_align`](<#fd_http_server_align>); if not, log a warning and return NULL.
    - Cast `shhttp` to `fd_http_server_t *` and store it in `http`.
    - Check if `http->magic` matches `FD_HTTP_SERVER_MAGIC`; if not, log a warning and return NULL.
    - Set `http->magic` to 0 using memory fences to ensure proper ordering.
    - Return the `http` pointer cast back to `void *`.
- **Output**: Returns a pointer to the deleted HTTP server instance if successful, or NULL if any validation fails.
- **Functions Called**:
    - [`fd_http_server_align`](<#fd_http_server_align>)


---
### fd\_http\_server\_fd<!-- {{#callable:fd_http_server_fd}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L286>)

Returns the socket file descriptor from the `fd_http_server_t` structure.
- **Inputs**:
    - `http`: A pointer to an `fd_http_server_t` structure, which contains the server's state and configuration.
- **Logic and Control Flow**:
    - Accesses the `socket_fd` member of the `fd_http_server_t` structure pointed to by `http`.
    - Returns the value of `socket_fd`.
- **Output**: The function returns an integer representing the socket file descriptor.


---
### fd\_http\_server\_listen<!-- {{#callable:fd_http_server_listen}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L291>)

Sets up a non-blocking HTTP server socket to listen for incoming connections on a specified IP address and port.
- **Inputs**:
    - ``http``: A pointer to an `fd_http_server_t` structure that represents the HTTP server.
    - ``address``: An unsigned integer representing the IP address to bind the server to.
    - ``port``: An unsigned short representing the port number to bind the server to.
- **Logic and Control Flow**:
    - Create a non-blocking socket using `socket()` with `AF_INET` and `SOCK_STREAM` flags.
    - Check if the socket creation failed and log an error if it did.
    - Set the socket option `SO_REUSEADDR` to allow reuse of local addresses using `setsockopt()`.
    - Check if setting the socket option failed and log an error if it did.
    - Initialize a `sockaddr_in` structure with the provided `address` and `port`, converting the port to network byte order using `fd_ushort_bswap()`.
    - Bind the socket to the specified address and port using `bind()`, and log an error if binding fails.
    - Start listening for incoming connections on the socket using `listen()`, with the maximum number of connections specified by `http->max_conns`.
    - Log an error if the `listen()` call fails.
    - Store the socket file descriptor in `http->socket_fd` and update the `pollfds` array to include this socket.
- **Output**: Returns a pointer to the `fd_http_server_t` structure passed as input, now configured to listen for connections.


---
### close\_conn<!-- {{#callable:close_conn}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L321>)

Closes a connection in the HTTP server, handling both HTTP and WebSocket connections, and performs necessary cleanup and callback invocations.
- **Inputs**:
    - `http`: A pointer to the `fd_http_server_t` structure representing the HTTP server.
    - `conn_idx`: The index of the connection to close, as an unsigned long integer.
    - `reason`: An integer representing the reason for closing the connection.
- **Logic and Control Flow**:
    - Checks if the file descriptor for the connection is valid using `FD_TEST`.
    - Logs a notice about the connection closure if `FD_HTTP_SERVER_DEBUG` is enabled.
    - Attempts to close the file descriptor using `close` and logs an error if it fails.
    - Sets the file descriptor in `http->pollfds` at `conn_idx` to -1 to mark it as closed.
    - Determines if the connection is an HTTP or WebSocket connection based on `conn_idx` and `http->max_conns`.
    - Invokes the appropriate close callback (`http->callbacks.close` or `http->callbacks.ws_close`) if they are set.
    - For HTTP connections, checks the connection state and removes it from the treap if necessary, then releases the connection back to the pool.
    - For WebSocket connections, removes the connection from the treap if it has pending frames and releases it back to the pool.
- **Output**: No return value; the function performs its operations directly on the provided `http` structure.
- **Functions Called**:
    - [`fd_http_server_connection_close_reason_str`](<#fd_http_server_connection_close_reason_str>)


---
### fd\_http\_server\_close<!-- {{#callable:fd_http_server_close}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L353>)

Closes a connection on the HTTP server with a specified reason.
- **Inputs**:
    - ``http``: A pointer to the `fd_http_server_t` structure representing the HTTP server.
    - ``conn_id``: The identifier of the connection to close.
    - ``reason``: An integer representing the reason for closing the connection.
- **Logic and Control Flow**:
    - Calls the [`close_conn`](<#close_conn>) function with the provided `http`, `conn_id`, and `reason` arguments.
- **Output**: No return value.
- **Functions Called**:
    - [`close_conn`](<#close_conn>)


---
### fd\_http\_server\_ws\_close<!-- {{#callable:fd_http_server_ws_close}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L360>)

Closes a WebSocket connection on an HTTP server with a specified reason.
- **Inputs**:
    - ``http``: A pointer to the `fd_http_server_t` structure representing the HTTP server.
    - ``ws_conn_id``: An unsigned long integer representing the WebSocket connection ID to close.
    - ``reason``: An integer representing the reason for closing the connection.
- **Logic and Control Flow**:
    - Calls the [`close_conn`](<#close_conn>) function with the HTTP server pointer, the sum of `http->max_conns` and `ws_conn_id`, and the `reason` as arguments.
- **Output**: No return value (void function).
- **Functions Called**:
    - [`close_conn`](<#close_conn>)


---
### is\_expected\_network\_error<!-- {{#callable:is_expected_network_error}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L372>)

Checks if a given network error code is one of the expected errors that indicate a connection should be closed.
- **Inputs**:
    - `err`: An integer representing the network error code to check.
- **Logic and Control Flow**:
    - Compares the input error code `err` against a list of predefined network error codes.
    - Returns true if `err` matches any of the predefined error codes, indicating an expected network error.
    - Returns false if `err` does not match any of the predefined error codes.
- **Output**: Returns an integer value of 1 if the error code is an expected network error, otherwise returns 0.


---
### accept\_conns<!-- {{#callable:accept_conns}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L390>)

Manages incoming connections for an HTTP server by accepting new connections and handling connection pool limits.
- **Inputs**:
    - `http`: A pointer to an `fd_http_server_t` structure representing the HTTP server instance.
- **Logic and Control Flow**:
    - Enters an infinite loop to continuously accept new connections.
    - Uses `accept4` to accept a new connection on the server's socket file descriptor.
    - Checks if the `accept4` call failed; if it failed due to `EAGAIN`, it breaks the loop, if it failed due to an expected network error, it continues, otherwise, it logs an error and exits.
    - Checks if there is space in the connection pool; if not, it evicts the least recently used connection or evicts connections in a round-robin fashion if none are slow to read.
    - Acquires an index from the connection pool for the new connection.
    - Initializes the new connection's state and resets its read and write byte counters.
    - Calls the `open` callback if it is set, passing the connection ID, file descriptor, and callback context.
    - Logs the accepted connection if debugging is enabled.
- **Output**: No explicit return value; modifies the state of the `fd_http_server_t` structure by adding new connections.
- **Functions Called**:
    - [`is_expected_network_error`](<#is_expected_network_error>)
    - [`close_conn`](<#close_conn>)


---
### read\_conn\_http<!-- {{#callable:read_conn_http}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L430>)

Processes HTTP requests for a specific connection index, handling reading, parsing, and responding to the request.
- **Inputs**:
    - `http`: A pointer to the `fd_http_server_t` structure representing the HTTP server.
    - `conn_idx`: The index of the connection in the server's connection array to process.
- **Logic and Control Flow**:
    - Check if the connection state is not `FD_HTTP_SERVER_CONNECTION_STATE_READING` and close the connection if true.
    - Attempt to read data from the connection's file descriptor into the request buffer.
    - Handle various read errors, including no data, expected network errors, and unexpected errors, closing the connection if necessary.
    - Parse the HTTP request using [`phr_parse_request`](<picohttpparser.c.md#phr_parse_request>) and handle partial or malformed requests by closing the connection.
    - Determine the HTTP method and handle unknown methods by closing the connection.
    - For POST and PUT methods, validate and parse the 'Content-Length' header, handling missing or malformed headers by closing the connection.
    - Check if the request is complete and handle partial requests by waiting for more data.
    - Extract and validate headers such as 'Content-Type' and 'Accept-Encoding', closing the connection if headers are malformed.
    - Handle WebSocket upgrade requests by checking headers and setting connection flags.
    - Prepare a `fd_http_server_request_t` structure with parsed request data and invoke the server's request callback.
    - Check if the connection was closed by the callback and update the connection's response data.
    - Insert the connection into a treap if the response does not have a static body.
- **Output**: No direct output; the function modifies the state of the connection and may close it or prepare it for writing a response.
- **Functions Called**:
    - [`close_conn`](<#close_conn>)
    - [`is_expected_network_error`](<#is_expected_network_error>)
    - [`phr_parse_request`](<picohttpparser.c.md#phr_parse_request>)
    - [`fd_http_server_method_str`](<#fd_http_server_method_str>)


---
### read\_conn\_ws<!-- {{#callable:read_conn_ws}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L656>)

Processes WebSocket frames for a specific connection index, handling reading, validation, and processing of the frames.
- **Inputs**:
    - ``http``: A pointer to the `fd_http_server_t` structure representing the HTTP server.
    - ``conn_idx``: An unsigned long integer representing the connection index for the WebSocket connection to process.
- **Logic and Control Flow**:
    - Retrieve the WebSocket connection structure using the connection index.
    - Attempt to read data from the connection's file descriptor into the receive buffer.
    - If no data is available or a non-fatal error occurs, return immediately.
    - If a fatal error occurs during reading, log the error and abort.
    - Update the number of bytes read into the receive buffer.
    - Check if there are at least 2 bytes to determine the frame length; if not, return.
    - Verify that the mask bit is set in the frame; if not, close the connection with a bad mask error.
    - Validate the opcode of the frame; if it is unknown, close the connection with an unknown opcode error.
    - Determine the payload length and validate it against control frame size limits.
    - Calculate the total frame length and check for overflow or oversize frame conditions.
    - If the complete frame is not yet read, return to wait for more data.
    - Process the data frame by unmasking the payload using the mask key.
    - If the frame is a close, ping, or pong frame, handle accordingly and return.
    - Check for continuation frames and validate the opcode sequence; close the connection if invalid.
    - If the frame is not a complete message, update the state and return.
    - If the frame is a complete message, process it by invoking the WebSocket message callback.
    - If there is trailing data after processing a complete message, move it to the start of the buffer and continue processing.
- **Output**: No direct output; the function processes WebSocket frames and may invoke callbacks or close connections based on the frame content.
- **Functions Called**:
    - [`is_expected_network_error`](<#is_expected_network_error>)
    - [`close_conn`](<#close_conn>)


---
### read\_conn<!-- {{#callable:read_conn}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L808>)

Determines whether to read an HTTP or WebSocket connection based on the connection index and calls the appropriate function.
- **Inputs**:
    - ``http``: A pointer to an `fd_http_server_t` structure representing the HTTP server.
    - ``conn_idx``: An unsigned long integer representing the connection index to be read.
- **Logic and Control Flow**:
    - Checks if `conn_idx` is less than `http->max_conns` using `FD_LIKELY` macro.
    - If true, calls [`read_conn_http`](<#read_conn_http>) with `http` and `conn_idx` as arguments.
    - If false, calls [`read_conn_ws`](<#read_conn_ws>) with `http` and `conn_idx` as arguments.
- **Output**: No return value (void function).
- **Functions Called**:
    - [`read_conn_http`](<#read_conn_http>)
    - [`read_conn_ws`](<#read_conn_ws>)


---
### write\_conn\_http<!-- {{#callable:write_conn_http}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L815>)

Handles the writing of HTTP responses to a client connection based on the connection's current state and response status.
- **Inputs**:
    - ``http``: A pointer to the `fd_http_server_t` structure representing the HTTP server.
    - ``conn_idx``: An unsigned long integer representing the index of the connection in the server's connection array.
- **Logic and Control Flow**:
    - Retrieve the connection object from the server's connection array using `conn_idx`.
    - Initialize a buffer `header_buf` to store the HTTP response header.
    - Determine the connection's state and handle accordingly:
    - If the state is `FD_HTTP_SERVER_CONNECTION_STATE_READING`, return immediately as no data is staged for writing.
    - If the state is `FD_HTTP_SERVER_CONNECTION_STATE_WRITING_HEADER`, construct the HTTP response header based on the response status and other response attributes.
    - If the state is `FD_HTTP_SERVER_CONNECTION_STATE_WRITING_BODY`, set the response to the body data, either static or dynamic.
    - Send the response data using the `send` function, handling any errors or partial sends.
    - Update the number of bytes written to the response and check if the entire response has been sent.
    - If the entire response is sent, transition the connection state or close the connection based on the current state and response attributes.
- **Output**: No direct output; the function sends data over a network socket and updates the connection state.
- **Functions Called**:
    - [`close_conn`](<#close_conn>)
    - [`is_expected_network_error`](<#is_expected_network_error>)


---
### maybe\_write\_pong<!-- {{#callable:maybe_write_pong}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L1007>)

Handles the sending of a WebSocket pong frame if necessary.
- **Inputs**:
    - ``http``: A pointer to the `fd_http_server_t` structure representing the HTTP server.
    - ``conn_idx``: An unsigned long integer representing the index of the WebSocket connection in the server's connection array.
- **Logic and Control Flow**:
    - Retrieve the WebSocket connection from the server's connection array using `conn_idx`.
    - Check if the connection's `pong_state` is `FD_HTTP_SERVER_PONG_STATE_NONE`; if true, return 0 as no pong is needed.
    - Check if the connection is in the middle of writing a data frame; if true, return 0 as pong cannot be sent now.
    - If `pong_state` is `FD_HTTP_SERVER_PONG_STATE_WAITING`, set `pong_state` to `FD_HTTP_SERVER_PONG_STATE_WRITING` and reset `pong_bytes_written` to 0.
    - Prepare a pong frame with a fixed header and copy the pong data into it.
    - Attempt to send the pong frame using the `send` function.
    - If `send` returns -1 and `errno` is `EAGAIN`, return 1 to indicate that no data was written and the operation should continue later.
    - If `send` returns -1 and the error is an expected network error, close the connection and return 1.
    - If `send` returns -1 for any other reason, log an error and abort.
    - Update `pong_bytes_written` with the number of bytes sent.
    - If all bytes of the pong frame are sent, reset `pong_state` to `FD_HTTP_SERVER_PONG_STATE_NONE` and return 0.
    - Return 1 if the pong frame is partially sent and more data needs to be sent later.
- **Output**: Returns 0 if the pong frame is fully sent or not needed, and 1 if the operation should continue later.
- **Functions Called**:
    - [`is_expected_network_error`](<#is_expected_network_error>)
    - [`close_conn`](<#close_conn>)


---
### write\_conn\_ws<!-- {{#callable:write_conn_ws}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L1047>)

Handles the sending of WebSocket frames for a specific connection in an HTTP server.
- **Inputs**:
    - ``http``: A pointer to the `fd_http_server_t` structure representing the HTTP server.
    - ``conn_idx``: An unsigned long integer representing the index of the WebSocket connection to write to.
- **Logic and Control Flow**:
    - Retrieve the WebSocket connection from the `http` server using the `conn_idx`.
    - Check if a pong response needs to be sent using [`maybe_write_pong`](<#maybe_write_pong>); if so, return immediately.
    - Check if there are frames to send; if not, return immediately.
    - Retrieve the current frame to send from the connection's `send_frames` array.
    - If the frame state is `FD_HTTP_SERVER_SEND_FRAME_STATE_HEADER`, construct the WebSocket frame header based on the frame length and send it using `send`.
    - If the header is fully sent, update the state to `FD_HTTP_SERVER_SEND_FRAME_STATE_DATA` and reset the bytes written counter.
    - If the frame state is `FD_HTTP_SERVER_SEND_FRAME_STATE_DATA`, send the frame data using `send`.
    - If the data is fully sent, update the state to `FD_HTTP_SERVER_SEND_FRAME_STATE_HEADER`, update the frame index, decrement the frame count, and reset the bytes written counter.
    - Remove the connection from the treap if no frames are left to send; otherwise, reinsert it.
- **Output**: No direct output; the function sends data over a network socket.
- **Functions Called**:
    - [`maybe_write_pong`](<#maybe_write_pong>)
    - [`is_expected_network_error`](<#is_expected_network_error>)
    - [`close_conn`](<#close_conn>)


---
### write\_conn<!-- {{#callable:write_conn}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L1125>)

Determines whether to write an HTTP or WebSocket connection based on the connection index.
- **Inputs**:
    - ``http``: A pointer to an `fd_http_server_t` structure representing the HTTP server.
    - ``conn_idx``: An unsigned long integer representing the connection index.
- **Logic and Control Flow**:
    - Checks if `conn_idx` is less than `http->max_conns` using `FD_LIKELY` macro.
    - If true, calls [`write_conn_http`](<#write_conn_http>) with `http` and `conn_idx` as arguments.
    - If false, calls [`write_conn_ws`](<#write_conn_ws>) with `http` and `conn_idx` as arguments.
- **Output**: No return value (void function).
- **Functions Called**:
    - [`write_conn_http`](<#write_conn_http>)
    - [`write_conn_ws`](<#write_conn_ws>)


---
### fd\_http\_server\_poll<!-- {{#callable:fd_http_server_poll}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L1132>)

Polls the HTTP server for events on connections and processes them accordingly.
- **Inputs**:
    - ``http``: A pointer to an `fd_http_server_t` structure representing the HTTP server.
    - ``poll_timeout``: An integer specifying the timeout for the poll operation in milliseconds.
- **Logic and Control Flow**:
    - Calls `fd_syscall_poll` to poll the file descriptors in `http->pollfds` for events, with a maximum of `http->max_conns + http->max_ws_conns + 1` file descriptors and the specified `poll_timeout`.
    - Checks the return value `nfds` from `fd_syscall_poll` to determine if any file descriptors have events or if an error occurred.
    - If `nfds` is 0 or -1 with `errno` set to `EINTR`, returns 0 indicating no events or interrupted poll.
    - If `nfds` is -1 with any other error, logs an error and terminates the server.
    - Iterates over each file descriptor in `http->pollfds` to check for events.
    - If the file descriptor is -1, continues to the next iteration.
    - If the index `i` is equal to `http->max_conns + http->max_ws_conns`, calls [`accept_conns`](<#accept_conns>) to accept new connections.
    - Otherwise, checks for `POLLIN` and `POLLOUT` events on the file descriptor.
    - If `POLLIN` is set, calls [`read_conn`](<#read_conn>) to read data from the connection.
    - If the file descriptor is still valid after reading, checks for `POLLOUT` and calls [`write_conn`](<#write_conn>) to write data to the connection.
- **Output**: Returns 1 if events were processed successfully, or 0 if no events were processed due to timeout or interruption.
- **Functions Called**:
    - [`accept_conns`](<#accept_conns>)
    - [`read_conn`](<#read_conn>)
    - [`write_conn`](<#write_conn>)


---
### fd\_http\_server\_evict\_until<!-- {{#callable:fd_http_server_evict_until}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L1156>)

Evicts HTTP and WebSocket connections from the server until their respective offsets are greater than or equal to a specified offset.
- **Inputs**:
    - ``http``: A pointer to an `fd_http_server_t` structure representing the HTTP server.
    - ``off``: An unsigned long integer representing the offset threshold for eviction.
- **Logic and Control Flow**:
    - Initialize a forward iterator `it` for the HTTP connections treap using `conn_treap_fwd_iter_init` with `http->conn_treap` and `http->conns`.
    - Iterate over the HTTP connections using the iterator `it` until `conn_treap_fwd_iter_done` returns true.
    - For each connection, check if `conn->response._body_off` is less than `off`.
    - If true, call [`close_conn`](<#close_conn>) to evict the connection with the reason `FD_HTTP_SERVER_CONNECTION_CLOSE_EVICTED`.
    - Break the loop if a connection's `_body_off` is not less than `off`.
    - Initialize a forward iterator `it` for the WebSocket connections treap using `ws_conn_treap_fwd_iter_init` with `http->ws_conn_treap` and `http->ws_conns`.
    - Iterate over the WebSocket connections using the iterator `it` until `ws_conn_treap_fwd_iter_done` returns true.
    - For each WebSocket connection, check if `conn->send_frames[conn->send_frame_idx].off` is less than `off`.
    - If true, call [`close_conn`](<#close_conn>) to evict the connection with the reason `FD_HTTP_SERVER_CONNECTION_CLOSE_WS_CLIENT_TOO_SLOW`.
    - Break the loop if a connection's `send_frames[conn->send_frame_idx].off` is not less than `off`.
- **Output**: No return value (void function).
- **Functions Called**:
    - [`close_conn`](<#close_conn>)


---
### fd\_http\_server\_reserve<!-- {{#callable:fd_http_server_reserve}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L1184>)

Reserves space in the HTTP server's buffer for an outgoing message, ensuring it fits within the buffer constraints.
- **Inputs**:
    - ``http``: A pointer to an `fd_http_server_t` structure representing the HTTP server.
    - ``len``: The length in bytes of the space to reserve in the buffer.
- **Logic and Control Flow**:
    - Checks that `fd_http_server_reserve` is not called after `fd_http_server_compress` by asserting `http->stage_comp_len == 0`.
    - Calculates the remaining space in the buffer using `http->oring_sz`, `http->stage_off`, and `http->stage_len`.
    - If the requested length `len` is greater than the remaining space, checks if the total length (`http->stage_len + len`) exceeds the buffer size `http->oring_sz`.
    - If the total length exceeds the buffer size, logs a warning, sets `http->stage_err` to 1, and exits.
    - If the total length can fit by relocating to the start of the buffer, calculates `stage_end` and `clamp`, evicts data until `clamp`, moves data to the start of the buffer, and updates `http->stage_off`.
    - If the requested length can fit in the buffer, calculates `stage_end` and `clamp`, and evicts data until `clamp`.
- **Output**: No return value; modifies the `http` structure to reserve space or set an error flag.
- **Functions Called**:
    - [`fd_http_server_evict_until`](<#fd_http_server_evict_until>)


---
### fd\_http\_ws\_compress\_maybe<!-- {{#callable:fd_http_ws_compress_maybe}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L1225>)

Attempts to compress a WebSocket message if conditions allow, using Zstandard compression.
- **Inputs**:
    - ``http``: A pointer to an `fd_http_server_t` structure representing the HTTP server context.
- **Logic and Control Flow**:
    - Checks if WebSocket compression is enabled, the message length is greater than 200, and there are no existing errors; if any condition fails, returns 0.
    - If Zstandard compression is available (`FD_HAS_ZSTD` is defined), calculates the worst-case compressed size using `ZSTD_compressBound`.
    - Calls [`fd_http_server_reserve`](<#fd_http_server_reserve>) to ensure there is enough space for the worst-case compressed size.
    - If an error occurs during reservation, returns 0.
    - Attempts to compress the message using `ZSTD_compress2` and checks for errors using `ZSTD_isError`; if an error occurs, logs a warning, sets the error flag, and returns 0.
    - If compression is successful, updates `http->stage_comp_len` with the compressed size and returns 1.
- **Output**: Returns 1 if compression is successful, otherwise returns 0.
- **Functions Called**:
    - [`fd_http_server_reserve`](<#fd_http_server_reserve>)


---
### fd\_http\_server\_ws\_send<!-- {{#callable:fd_http_server_ws_send}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L1253>)

Sends a WebSocket frame over an HTTP server connection, handling compression and connection state.
- **Inputs**:
    - ``http``: A pointer to the `fd_http_server_t` structure representing the HTTP server.
    - ``ws_conn_id``: An unsigned long integer representing the WebSocket connection ID.
- **Logic and Control Flow**:
    - Retrieve the WebSocket connection from the `http` structure using `ws_conn_id`.
    - Check if the connection is configured to compress WebSocket frames and attempt compression if applicable.
    - If there is a staging error, reset the error state and return -1.
    - Check if the WebSocket connection has been closed; if so, reset the stage length and return 0.
    - If the connection's send frame count has reached the maximum, close the connection due to the client being too slow, reset the stage length, and return 0.
    - Create a WebSocket frame with the appropriate offset, length, and compression status.
    - Add the frame to the connection's send frames and increment the send frame count.
    - If this is the first frame in the queue, insert the connection into the WebSocket connection treap.
    - Update the stage offset and reset the stage length and compressed length.
    - Return 0 to indicate success.
- **Output**: Returns 0 on success, or -1 if there is a staging error.
- **Functions Called**:
    - [`fd_http_ws_compress_maybe`](<#fd_http_ws_compress_maybe>)
    - [`close_conn`](<#close_conn>)


---
### fd\_http\_server\_ws\_broadcast<!-- {{#callable:fd_http_server_ws_broadcast}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L1307>)

Broadcasts a WebSocket message to all active WebSocket connections in the HTTP server.
- **Inputs**:
    - ``http``: A pointer to an `fd_http_server_t` structure representing the HTTP server instance.
- **Logic and Control Flow**:
    - Calls [`fd_http_ws_compress_maybe`](<#fd_http_ws_compress_maybe>) to attempt compression of the message if applicable.
    - Checks if there is an error in the staging process (`http->stage_err`), resets error and length fields, and returns -1 if an error is present.
    - Iterates over all WebSocket connections (`http->max_ws_conns`).
    - For each connection, checks if the connection is active by verifying the file descriptor (`fd`) is not -1.
    - Checks if the connection's send frame count has reached the maximum allowed (`http->max_ws_send_frame_cnt`), closes the connection if true, and continues to the next connection.
    - Creates a `fd_http_server_ws_frame_t` frame with the appropriate offset, length, and compression status based on whether the connection supports compression and if the message was compressed.
    - Adds the frame to the connection's send frames buffer and increments the send frame count.
    - Inserts the connection into the WebSocket connection treap if it is the first frame being sent.
    - Updates the `http->stage_off` by adding the lengths of the staged and compressed data, and resets `http->stage_len` and `http->stage_comp_len` to 0.
    - Returns 0 to indicate successful broadcast.
- **Output**: Returns 0 on success, or -1 if there was an error during the staging process.
- **Functions Called**:
    - [`fd_http_ws_compress_maybe`](<#fd_http_ws_compress_maybe>)
    - [`close_conn`](<#close_conn>)


---
### fd\_http\_server\_stage\_trunc<!-- {{#callable:fd_http_server_stage_trunc}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L1348>)

Sets the `stage_comp_len` to 0 and updates `stage_len` to the specified length in the `fd_http_server_t` structure.
- **Inputs**:
    - ``http``: A pointer to an `fd_http_server_t` structure, which represents the HTTP server context.
    - ``len``: An unsigned long integer representing the new length to set for `stage_len` in the HTTP server context.
- **Logic and Control Flow**:
    - Set `http->stage_comp_len` to 0 to indicate no compression length is currently staged.
    - Set `http->stage_len` to the value of `len` to update the staged length.
- **Output**: No return value; the function modifies the `fd_http_server_t` structure in place.


---
### fd\_http\_server\_stage\_len<!-- {{#callable:fd_http_server_stage_len}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L1355>)

Returns the length of the current stage in the HTTP server.
- **Inputs**:
    - `http`: A pointer to an `fd_http_server_t` structure, representing the HTTP server instance.
- **Logic and Control Flow**:
    - Accesses the `stage_len` member of the `fd_http_server_t` structure pointed to by `http`.
    - Returns the value of `stage_len`.
- **Output**: The function returns an `ulong` representing the length of the current stage in the HTTP server.


---
### fd\_http\_server\_printf<!-- {{#callable:fd_http_server_printf}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L1360>)

Formats a string using a variable argument list and appends it to the HTTP server's outgoing buffer.
- **Inputs**:
    - ``http``: A pointer to an `fd_http_server_t` structure representing the HTTP server.
    - ``fmt``: A constant character pointer representing the format string.
    - ``...``: A variable argument list to be formatted according to `fmt`.
- **Logic and Control Flow**:
    - Checks if `http->stage_err` is set; if true, returns immediately.
    - Initializes a `va_list` and calculates the length of the formatted string using `vsnprintf` with a `NULL` buffer to determine the required length.
    - Calls [`fd_http_server_reserve`](<#fd_http_server_reserve>) to ensure there is enough space in the buffer for the formatted string.
    - Checks again if `http->stage_err` is set; if true, returns immediately.
    - Reinitializes the `va_list` and writes the formatted string into the buffer at the calculated position using `vsnprintf`.
    - Updates `http->stage_len` by adding the length of the formatted string.
- **Output**: No return value; the function modifies the `http` structure's buffer directly.
- **Functions Called**:
    - [`fd_http_server_reserve`](<#fd_http_server_reserve>)


---
### fd\_http\_server\_memcpy<!-- {{#callable:fd_http_server_memcpy}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L1384>)

Copies data into the HTTP server's outgoing buffer and updates the buffer's length.
- **Inputs**:
    - ``http``: A pointer to an `fd_http_server_t` structure representing the HTTP server.
    - ``data``: A pointer to the data to be copied into the server's outgoing buffer.
    - ``data_len``: The length of the data to be copied.
- **Logic and Control Flow**:
    - Calls [`fd_http_server_reserve`](<#fd_http_server_reserve>) to ensure there is enough space in the buffer for the data.
    - Checks if `http->stage_err` is set, and if so, returns immediately without copying data.
    - Uses `fd_memcpy` to copy the data into the buffer at the calculated position.
    - Increments `http->stage_len` by `data_len` to reflect the new length of the data in the buffer.
- **Output**: No return value; the function modifies the state of the `http` server's buffer.
- **Functions Called**:
    - [`fd_http_server_reserve`](<#fd_http_server_reserve>)


---
### fd\_http\_server\_unstage<!-- {{#callable:fd_http_server_unstage}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L1397>)

Resets the staging error and lengths for an HTTP server.
- **Inputs**:
    - ``http``: A pointer to an `fd_http_server_t` structure representing the HTTP server.
- **Logic and Control Flow**:
    - Set `http->stage_err` to 0, indicating no error in the staging process.
    - Set `http->stage_len` to 0UL, resetting the length of the staged data.
    - Set `http->stage_comp_len` to 0UL, resetting the length of the compressed staged data.
- **Output**: No return value (void function).


---
### fd\_http\_server\_stage\_body<!-- {{#callable:fd_http_server_stage_body}} -->
[View Source →](<../../../../../src/waltz/http/fd_http_server.c#L1404>)

Stages the body of an HTTP response by updating the response's body offset and length based on the current stage offset and length of the HTTP server.
- **Inputs**:
    - ``http``: A pointer to an `fd_http_server_t` structure representing the HTTP server.
    - ``response``: A pointer to an `fd_http_server_response_t` structure where the body offset and length will be updated.
- **Logic and Control Flow**:
    - Check if `http->stage_err` is set; if true, reset `http->stage_err` and `http->stage_len` to 0 and return -1.
    - Set `response->_body_off` to `http->stage_off`.
    - Set `response->_body_len` to `http->stage_len`.
    - Increment `http->stage_off` by `http->stage_len`.
    - Reset `http->stage_len` to 0.
    - Return 0 to indicate success.
- **Output**: Returns 0 on success, or -1 if there was an error in the staging process.



---
Made with ❤️ by [Driver](https://www.driver.ai/)