<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines private structures and constants for managing HTTP and WebSocket server connections in Firedancer.

# Purpose
The code is a C header file that defines private structures and constants for an HTTP server implementation. It is intended to be used internally within the HTTP server module, as indicated by the inclusion guard and the naming convention. The file includes definitions for managing HTTP and WebSocket connections, handling data compression, and maintaining server state. It uses conditional compilation to include Zstandard (ZSTD) compression support if available, which is indicated by the `FD_HAS_ZSTD` macro.

Key components include the `fd_http_server_connection` and `fd_http_server_ws_connection` structures, which manage the state and data for HTTP and WebSocket connections, respectively. These structures include fields for tracking connection states, data buffers, and WebSocket-specific parameters such as frame handling and compression. The `fd_http_server_private` structure encapsulates the server's operational parameters, including socket file descriptors, data buffers, and callback functions. It also manages connection limits and staging areas for message data, supporting both compressed and uncompressed data handling. The file defines several constants for connection states and server operations, which help manage the flow of data and control within the server.
# Imports and Dependencies

---
- `fd_http_server.h`
- `zstd.h`


# Data Structures

---
### fd\_http\_server\_connection
- **Type**: ``struct``
- **Members**:
    - `state`: Indicates the current state of the HTTP server connection.
    - `upgrade_websocket`: Indicates if the connection should upgrade to a WebSocket.
    - `compress_websocket`: Indicates if WebSocket compression is enabled.
    - `request_bytes_len`: Stores the length of the request bytes.
    - `sec_websocket_key`: Holds the security key for WebSocket connections.
    - `request_bytes`: Points to the request data bytes.
    - `request_bytes_read`: Tracks the number of request bytes read.
    - `response`: Contains the HTTP server response data.
    - `response_bytes_written`: Tracks the number of response bytes written.
    - `left`: Treap field indicating the left child node.
    - `right`: Treap field indicating the right child node.
    - `parent`: Treap field indicating the parent node.
    - `prio`: Treap field indicating the priority of the node.
    - `prev`: Treap field indicating the previous node in the treap.
    - `next`: Treap field indicating the next node in the treap.
- **Description**: Manages an HTTP server connection, including state management, WebSocket upgrade and compression options, request and response data handling, and treap-based memory management for efficient node operations.


---
### fd\_http\_server\_ws\_frame
- **Type**: ``struct``
- **Members**:
    - ``off``: The offset of the WebSocket frame data.
    - ``len``: The length of the WebSocket frame data.
    - ``compressed``: Indicates if the WebSocket frame data is compressed.
- **Description**: Defines a WebSocket frame in the HTTP server context, including its offset, length, and compression status.


---
### fd\_http\_server\_ws\_frame\_t
- **Type**: ``struct``
- **Members**:
    - `off`: Offset of the WebSocket frame data.
    - `len`: Length of the WebSocket frame data.
    - `compressed`: Indicates if the WebSocket frame data is compressed.
- **Description**: The `fd_http_server_ws_frame_t` structure represents a WebSocket frame in the HTTP server context. It contains information about the frame's offset, length, and whether the data is compressed. This structure is used to manage and process WebSocket frames within the server's operations.


---
### fd\_http\_server\_ws\_connection
- **Type**: ``struct``
- **Members**:
    - `pong_state`: Indicates the current state of the pong operation.
    - `pong_data_len`: Stores the length of the pong data.
    - `pong_data`: Holds the pong data with a maximum size of 125 bytes.
    - `pong_bytes_written`: Tracks the number of bytes written for the pong operation.
    - `recv_started_msg`: Indicates if a message reception has started.
    - `recv_last_opcode`: Stores the last received opcode.
    - `recv_bytes_parsed`: Tracks the number of bytes parsed from the received data.
    - `recv_bytes_read`: Tracks the number of bytes read from the received data.
    - `recv_bytes`: Points to the buffer holding the received bytes.
    - `send_frame_state`: Indicates the current state of the send frame operation.
    - `send_frame_bytes_written`: Tracks the number of bytes written for the send frame operation.
    - `send_frame_cnt`: Stores the count of frames to be sent.
    - `send_frame_idx`: Tracks the index of the current frame being sent.
    - `send_frames`: Points to the frames to be sent.
    - `compress_websocket`: Indicates if the WebSocket connection is compressed.
    - `left`: Treap field indicating the left child node.
    - `right`: Treap field indicating the right child node.
    - `parent`: Treap field indicating the parent node.
    - `prio`: Treap field indicating the priority of the node.
    - `prev`: Treap field indicating the previous node.
    - `next`: Treap field indicating the next node.
- **Description**: Manages the state and data for a WebSocket connection in an HTTP server, including pong operations, message reception, frame sending, and treap-based connection management.


---
### fd\_http\_server\_hcache\_private
- **Type**: ``struct``
- **Members**:
    - `err`: Indicates if there has been an error while printing.
    - `off`: Represents the offset into the staging buffer.
    - `len`: Specifies the length of the staging buffer.
- **Description**: The `fd_http_server_hcache_private` structure is used to manage the state of a staging buffer in an HTTP server context. It tracks errors that occur during printing operations, the current offset within the buffer, and the total length of the buffer. This structure is likely used internally to handle data staging for HTTP responses or requests.


---
### fd\_http\_server\_private
- **Type**: ``struct``
- **Members**:
    - `socket_fd`: File descriptor for the server socket.
    - `oring`: Pointer to the output ring buffer.
    - `oring_sz`: Size of the output ring buffer.
    - `compress_websocket`: Flag to indicate if WebSocket compression is enabled.
    - `zstd_scratch`: Pointer to the scratch space for ZSTD compression (if enabled).
    - `zstd_scratch_sz`: Size of the ZSTD scratch space.
    - `zstd_ctx`: Pointer to the ZSTD compression context.
    - `stage_err`: Error code for the staging process.
    - `stage_off`: Offset into the staging buffer.
    - `stage_len`: Length of the staged data.
    - `stage_comp_len`: Length of the compressed staged data.
    - `max_conns`: Maximum number of connections.
    - `max_ws_conns`: Maximum number of WebSocket connections.
    - `max_request_len`: Maximum length of an HTTP request.
    - `max_ws_recv_frame_len`: Maximum length of a WebSocket receive frame.
    - `max_ws_send_frame_cnt`: Maximum count of WebSocket send frames.
    - `evict_conn_id`: ID of the connection to evict.
    - `evict_ws_conn_id`: ID of the WebSocket connection to evict.
    - `callback_ctx`: Context for callback functions.
    - `callbacks`: Structure containing server callback functions.
    - `magic`: Magic number for structure validation.
    - `conns`: Pointer to an array of HTTP server connections.
    - `ws_conns`: Pointer to an array of WebSocket server connections.
    - `pollfds`: Pointer to an array of poll file descriptors.
    - `conn_treap`: Pointer to the connection treap data structure.
    - `ws_conn_treap`: Pointer to the WebSocket connection treap data structure.
- **Description**: The `fd_http_server_private` structure is used to manage the internal state of an HTTP server, including socket management, data staging, and connection handling. It supports both HTTP and WebSocket connections, with optional ZSTD compression for WebSocket data. The structure maintains separate buffers for compressed and uncompressed data to accommodate different client requirements. It also includes fields for managing connection limits, eviction policies, and callback functions for server operations. The structure is aligned according to `FD_HTTP_SERVER_ALIGN` and includes a magic number for validation.



---
Made with ❤️ by [Driver](https://www.driver.ai/)