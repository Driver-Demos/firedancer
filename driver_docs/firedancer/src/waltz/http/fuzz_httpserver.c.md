<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Fuzz testing implementation for an HTTP server with WebSocket support, using random input generation and callbacks.

# Purpose
The code is a C source file that implements a fuzz testing framework for an HTTP server with WebSocket support. It uses a combination of random input generation and structured callbacks to test the server's handling of HTTP and WebSocket requests. The file includes several components, such as random data generation functions, HTTP and WebSocket request builders, and callback functions for handling server events like connection opening, closing, and message reception. The code is designed to be used with a fuzzer, which provides random input data to test the server's robustness and error handling capabilities.

The file defines several constants and structures to manage server parameters and client connections. It uses a `Xorshift` random number generator to produce pseudo-random numbers for various operations, such as selecting actions to perform or generating request data. The [`LLVMFuzzerTestOneInput`](<#llvmfuzzertestoneinput>) function is the main entry point for the fuzzer, initializing the server, creating a separate thread to simulate server operations, and executing a series of random actions to test the server's behavior. The code also includes functions to manage client connections, send HTTP and WebSocket requests, and handle server responses, making it a comprehensive test suite for the HTTP server's functionality.
# Imports and Dependencies

---
- `assert.h`
- `stdio.h`
- `stdlib.h`
- `unistd.h`
- `arpa/inet.h`
- `netinet/in.h`
- `pthread.h`
- `poll.h`
- `errno.h`
- `../../util/fd_util.h`
- `../../util/sanitize/fd_fuzz.h`
- `fd_http_server_private.h`
- `fd_http_server.h`


# Global Variables

---
### PARAMS
- **Type**: ``fd_http_server_params_t``
- **Description**: Defines the parameters for configuring an HTTP server. It includes settings for maximum connections, request lengths, and buffer sizes.
- **Use**: Used to initialize and configure an HTTP server with specific limits and buffer sizes.


---
### http\_server
- **Type**: ``fd_http_server_t *``
- **Description**: A pointer to an `fd_http_server_t` structure, which represents an HTTP server instance. It is initialized to `NULL` and is used to manage the server's state and operations.
- **Use**: Used to store and manage the state of the HTTP server instance throughout the program.


---
### port
- **Type**: ``uint16_t``
- **Description**: A 16-bit unsigned integer that stores the port number for the HTTP server.
- **Use**: Used to store the port number on which the HTTP server listens for incoming connections.


---
### clients\_fd
- **Type**: ``int[]``
- **Description**: An array of integers that stores file descriptors for client connections. The array size is determined by the constant `FD_HTTP_SERVER_GUI_MAX_CONNS` multiplied by 2, and it is initialized with all elements set to -1.
- **Use**: Stores file descriptors for managing client connections in the HTTP server.


---
### clients\_ws\_fd
- **Type**: ``char[]``
- **Description**: An array of characters that stores the state of WebSocket connections for clients. The size of the array is determined by the constant `FD_HTTP_SERVER_GUI_MAX_CONNS` multiplied by 2, and it is initialized with zeros.
- **Use**: Tracks the WebSocket connection status for each client in the HTTP server.


---
### clients\_fd\_cnt
- **Type**: ``uint``
- **Description**: A static global variable that counts the number of client file descriptors currently in use.
- **Use**: Tracks the number of active client connections by incrementing or decrementing as connections are opened or closed.


---
### poll\_rng
- **Type**: ``Xorshift``
- **Description**: Represents a static instance of the `Xorshift` structure used for random number generation. The `Xorshift` algorithm is a type of pseudorandom number generator that uses bitwise operations to produce random numbers.
- **Use**: Used to generate random numbers for various operations in the HTTP server, such as deciding actions in callbacks and generating random data.


---
### stem\_iters
- **Type**: `ulong`
- **Description**: `stem_iters` is a static global variable of type `ulong` that counts the number of iterations in the `stem_thread` function.
- **Use**: Used to track the number of iterations executed by the `stem_thread` function.


---
### stop
- **Type**: ``int``
- **Description**: A static integer variable initialized to 0. It is used as a flag to control the termination of a loop in the `stem_thread` function.
- **Use**: Used to signal the `stem_thread` function to stop its execution when set to a non-zero value.


# Data Structures

---
### Unstructured
- **Type**: ``struct``
- **Members**:
    - ``data``: Pointer to a constant unsigned character array.
    - ``size``: Total size of the data array.
    - ``used``: Amount of data that has been used.
- **Description**: Stores a pointer to a data array and tracks the total size and the amount of data used. This structure is useful for managing a buffer of data where the size and usage need to be tracked separately.


---
### Xorshift
- **Type**: ``struct``
- **Members**:
    - ``state``: Stores the current state of the Xorshift random number generator as a 32-bit unsigned integer.
- **Description**: A `Xorshift` is a simple data structure that encapsulates a 32-bit state used in the Xorshift random number generation algorithm. This algorithm is known for its speed and simplicity, and the `state` member is crucial for maintaining the internal state of the generator across calls to generate new random numbers.


---
### Action
- **Type**: ``enum``
- **Members**:
    - ``HttpOpen``: Represents the action to open an HTTP connection.
    - ``Close``: Represents the action to close a connection.
    - ``Send``: Represents the action to send data over a connection.
    - ``ActionEnd``: Marks the end of the `Action` enumeration.
- **Description**: Defines a set of actions that can be performed in the context of an HTTP server, including opening, closing, and sending data over connections. The `ActionEnd` member is used to indicate the end of the enumeration.


---
### sockaddr\_pun
- **Type**: ``union``
- **Members**:
    - ``addr_in``: A `struct sockaddr_in` member that stores an IPv4 address and port.
    - ``sa``: A `struct sockaddr` member that stores a generic socket address.
- **Description**: Provides a union that allows the storage of either an IPv4-specific socket address (`struct sockaddr_in`) or a generic socket address (`struct sockaddr`). This union is useful for operations that need to handle both specific and generic socket address types interchangeably.


# Functions

---
### rand\_uchar<!-- {{#callable:rand_uchar}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L42>)

Generates a random unsigned character from a data buffer or falls back to a random number generator.
- **Inputs**:
    - `u`: A pointer to a `struct Unstructured` which contains a data buffer, its total size, and the amount of data already used.
- **Logic and Control Flow**:
    - Check if there is enough unused data in the buffer to read an `uchar` by comparing `sizeof(uchar) + u->used` with `u->size`.
    - If there is enough data, read an `uchar` from the buffer at the position `u->data + u->used`, increment `u->used` by `sizeof(uchar)`, and return the read value.
    - If there is not enough data, return a random `uchar` generated by casting the result of `rand()` to `uchar`.
- **Output**: An `uchar` value, either from the buffer or generated randomly.


---
### rand\_uint<!-- {{#callable:rand_uint}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L51>)

Generates a random unsigned integer from a given data structure or falls back to a standard random function.
- **Inputs**:
    - `u`: A pointer to a `struct Unstructured` which contains a data buffer, its size, and the amount of data already used.
- **Logic and Control Flow**:
    - Check if there is enough unused data in the `Unstructured` structure to extract a `uint` value.
    - If there is enough data, extract a `uint` from the current position in the data buffer, update the `used` field, and return the extracted value.
    - If there is not enough data, return a random `uint` generated by the `rand()` function.
- **Output**: Returns a `uint` value either from the `Unstructured` data buffer or from the `rand()` function.


---
### rand\_ulong<!-- {{#callable:rand_ulong}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L60>)

Generates a random unsigned long integer from a given data structure or falls back to a random number generator.
- **Inputs**:
    - `u`: A pointer to a `struct Unstructured` which contains a data buffer, its size, and the amount of data already used.
- **Logic and Control Flow**:
    - Check if there is enough unused data in the `struct Unstructured` to extract an `ulong` value.
    - If there is enough data, extract the `ulong` value from the data buffer at the current `used` position, update the `used` counter, and return the extracted value.
    - If there is not enough data, generate a random `ulong` by combining two calls to `rand()` and return the result.
- **Output**: Returns an `ulong` value either extracted from the data buffer or generated randomly.


---
### rand\_bytes<!-- {{#callable:rand_bytes}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L69>)

Copies random bytes from an `Unstructured` data source to a buffer or generates random bytes if the source is insufficient.
- **Inputs**:
    - `u`: A pointer to a `struct Unstructured` which contains the data source and its current usage state.
    - `len`: The number of bytes to copy or generate.
    - `p`: A pointer to the buffer where the bytes will be stored.
- **Logic and Control Flow**:
    - Checks if the sum of `len` and `u->used` is less than `u->size` to determine if there is enough data in `u` to copy.
    - If there is enough data, uses `memcpy` to copy `len` bytes from `u->data` starting at `u->used` to the buffer `p`, and increments `u->used` by `len`.
    - If there is not enough data, generates `len` random bytes using `rand()` and stores them in the buffer `p`.
- **Output**: No return value; the function modifies the buffer `p` and updates `u->used` if applicable.


---
### reset\_clients\_fd<!-- {{#callable:reset_clients_fd}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L89>)

Resets the client file descriptors and WebSocket flags to their initial states.
- **Inputs**: None
- **Logic and Control Flow**:
    - Set `clients_fd_cnt` to 0 to reset the count of active client file descriptors.
    - Iterate over the range from 0 to `FD_HTTP_SERVER_GUI_MAX_CONNS * 2`.
    - For each index in the iteration, set `clients_fd[i]` to -1 to indicate an unused file descriptor.
    - Set `clients_ws_fd[i]` to 0 to reset the WebSocket flag for each client.
- **Output**: No output is returned as the function is of type `void`.


---
### LLVMFuzzerInitialize<!-- {{#callable:LLVMFuzzerInitialize}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L97>)

Initializes the fuzzer environment by setting up logging, booting the system, and resetting client file descriptors.
- **Inputs**:
    - `argc`: A pointer to the argument count, typically from the command line.
    - `argv`: A pointer to the argument vector, typically from the command line.
- **Logic and Control Flow**:
    - Sets the environment variable `FD_LOG_BACKTRACE` to `0` to disable backtrace logging.
    - Calls `fd_boot` with `argc` and `argv` to initialize the system.
    - Registers `fd_halt` to be called at program exit using `atexit`.
    - Sets the core log level to `3` using `fd_log_level_core_set`, which crashes on warning logs.
    - Sets the standard error log level to `4` using `fd_log_level_stderr_set` to disable parsing error logging.
    - Calls [`reset_clients_fd`](<#reset_clients_fd>) to reset the client file descriptors.
- **Output**: Returns `0` to indicate successful initialization.
- **Functions Called**:
    - [`reset_clients_fd`](<#reset_clients_fd>)


---
### xorshift\_init<!-- {{#callable:xorshift_init}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L118>)

Initializes the state of a `Xorshift` structure with a given seed, defaulting to 1 if the seed is zero.
- **Inputs**:
    - `x`: A pointer to a `Xorshift` structure whose state will be initialized.
    - `seed`: A 32-bit unsigned integer used to initialize the state; if zero, the state is set to 1.
- **Logic and Control Flow**:
    - Check if the `seed` is non-zero.
    - If `seed` is non-zero, set `x->state` to `seed`.
    - If `seed` is zero, set `x->state` to 1.
- **Output**: No return value; the function modifies the `state` member of the `Xorshift` structure pointed to by `x`.


---
### xorshift\_next<!-- {{#callable:xorshift_next}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L122>)

Generates the next random number in the sequence using the xorshift algorithm.
- **Inputs**:
    - `x`: A pointer to an `Xorshift` structure containing the current state of the random number generator.
- **Logic and Control Flow**:
    - Retrieve the current state from the `Xorshift` structure.
    - Perform a bitwise XOR operation on the state with itself shifted left by 13 bits.
    - Perform a bitwise XOR operation on the result with itself shifted right by 17 bits.
    - Perform a bitwise XOR operation on the result with itself shifted left by 5 bits.
    - Update the state in the `Xorshift` structure with the new value.
    - Return the new state as the next random number.
- **Output**: Returns the next random number as a `uint32_t`.


---
### random\_api\_call<!-- {{#callable:random_api_call}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L170>)

Executes a random API call on the HTTP server based on a pseudo-random number generated by the `Xorshift` algorithm.
- **Inputs**:
    - `u`: A pointer to an `Xorshift` structure used to generate pseudo-random numbers.
- **Logic and Control Flow**:
    - Generate a pseudo-random number using `xorshift_next(u)` and take the modulo 4 of the result to determine the case to execute.
    - If the result is 0, generate another pseudo-random number to select a WebSocket connection position, check if the connection is active, and send a WebSocket message using [`fd_http_server_ws_send`](<fd_http_server.c.md#fd_http_server_ws_send>).
    - If the result is 1, broadcast a WebSocket message to all connections using [`fd_http_server_ws_broadcast`](<fd_http_server.c.md#fd_http_server_ws_broadcast>).
    - If the result is 2, generate a pseudo-random length, fill a buffer with the value 0xcc up to that length, and copy the buffer to the server using [`fd_http_server_memcpy`](<fd_http_server.c.md#fd_http_server_memcpy>).
    - If the result is 3, generate a pseudo-random length, fill a buffer with the value 0xcc up to that length, and print the buffer to the server using [`fd_http_server_printf`](<fd_http_server.c.md#fd_http_server_printf>).
- **Output**: No return value; the function performs actions on the HTTP server.
- **Functions Called**:
    - [`xorshift_next`](<#xorshift_next>)
    - [`fd_http_server_ws_send`](<fd_http_server.c.md#fd_http_server_ws_send>)
    - [`fd_http_server_ws_broadcast`](<fd_http_server.c.md#fd_http_server_ws_broadcast>)
    - [`fd_http_server_memcpy`](<fd_http_server.c.md#fd_http_server_memcpy>)
    - [`fd_http_server_printf`](<fd_http_server.c.md#fd_http_server_printf>)


---
### open\_callback<!-- {{#callable:open_callback}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L203>)

Executes a random number of API calls using a pseudo-random number generator.
- **Inputs**:
    - `conn_id`: The connection identifier, which is not used in the function.
    - `sockfd`: The socket file descriptor, which is not used in the function.
    - `ctx`: A context pointer, which is not used in the function.
- **Logic and Control Flow**:
    - Ignores the input parameters `conn_id`, `sockfd`, and `ctx` by casting them to void.
    - Generates a random number between 0 and 2 using the [`xorshift_next`](<#xorshift_next>) function with `poll_rng`.
    - Iterates up to the generated random number, calling [`random_api_call`](<#random_api_call>) with `poll_rng` in each iteration.
- **Output**: No output is returned from this function.
- **Functions Called**:
    - [`xorshift_next`](<#xorshift_next>)
    - [`random_api_call`](<#random_api_call>)


---
### close\_callback<!-- {{#callable:close_callback}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L213>)

Executes a series of random API calls based on a pseudo-random number generator.
- **Inputs**:
    - `conn_id`: The connection identifier, which is not used in the function.
    - `reason`: The reason for the closure, which is not used in the function.
    - `ctx`: A context pointer, which is not used in the function.
- **Logic and Control Flow**:
    - Ignores the input parameters `conn_id`, `reason`, and `ctx` by casting them to void.
    - Generates a random number using [`xorshift_next`](<#xorshift_next>) with `poll_rng` and takes the modulus with 3 to determine the number of iterations.
    - Iterates up to the random number of times, calling [`random_api_call`](<#random_api_call>) with `poll_rng` in each iteration.
- **Output**: No output is returned from this function.
- **Functions Called**:
    - [`xorshift_next`](<#xorshift_next>)
    - [`random_api_call`](<#random_api_call>)


---
### request\_callback<!-- {{#callable:request_callback}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L223>)

Generates a random HTTP server response based on a request and random number generation.
- **Inputs**:
    - `request`: A pointer to a constant `fd_http_server_request_t` structure representing the incoming HTTP request.
- **Logic and Control Flow**:
    - Initialize a `fd_http_server_response_t` structure `resp` to zero.
    - Use a switch statement with a random number to set the `resp.status` to one of several HTTP status codes (200, 204, 400, 404, 405, 500) or a random value.
    - Randomly set various fields of `resp` such as `content_type`, `cache_control`, `content_encoding`, `access_control_allow_origin`, `access_control_allow_methods`, `access_control_allow_headers`, `access_control_max_age`, `static_body`, and `static_body_len` based on random number generation.
    - If the request header `upgrade_websocket` is true and a random condition is met, set `resp.status` to 200 and `resp.upgrade_websocket` to 1.
    - Perform a random number of [`random_api_call`](<#random_api_call>) invocations to simulate additional random behavior.
    - Return the constructed `resp` structure.
- **Output**: A `fd_http_server_response_t` structure containing the generated HTTP response.
- **Functions Called**:
    - [`xorshift_next`](<#xorshift_next>)
    - [`random_api_call`](<#random_api_call>)


---
### ws\_open\_callback<!-- {{#callable:ws_open_callback}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L312>)

Executes a series of random API calls based on a pseudo-random number generator when a WebSocket connection opens.
- **Inputs**:
    - ``ws_conn_id``: The identifier for the WebSocket connection, which is not used in the function.
    - ``ctx``: A context pointer, which is not used in the function.
- **Logic and Control Flow**:
    - Ignore the input parameters `ws_conn_id` and `ctx` by casting them to void.
    - Generate a random number between 0 and 2 using the [`xorshift_next`](<#xorshift_next>) function with the `poll_rng` random number generator.
    - Iterate up to the generated random number, calling [`random_api_call`](<#random_api_call>) in each iteration.
- **Output**: No output is returned from this function.
- **Functions Called**:
    - [`xorshift_next`](<#xorshift_next>)
    - [`random_api_call`](<#random_api_call>)


---
### ws\_close\_callback<!-- {{#callable:ws_close_callback}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L321>)

Executes a series of random API calls when a WebSocket connection closes.
- **Inputs**:
    - ``ws_conn_id``: The identifier for the WebSocket connection that is closing.
    - ``reason``: The reason code for the WebSocket connection closure.
    - ``ctx``: A context pointer, which is not used in this function.
- **Logic and Control Flow**:
    - Ignores the input parameters `ws_conn_id`, `reason`, and `ctx` by casting them to void.
    - Generates a random number between 0 and 2 using [`xorshift_next`](<#xorshift_next>) with `poll_rng`.
    - Executes the [`random_api_call`](<#random_api_call>) function a number of times equal to the random number generated.
- **Output**: No output is returned from this function.
- **Functions Called**:
    - [`xorshift_next`](<#xorshift_next>)
    - [`random_api_call`](<#random_api_call>)


---
### ws\_message\_callback<!-- {{#callable:ws_message_callback}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L331>)

Executes a random number of API calls using a pseudo-random number generator.
- **Inputs**:
    - ``ws_conn_id``: The WebSocket connection identifier, which is not used in the function.
    - ``data``: A pointer to the data received, which is not used in the function.
    - ``data_len``: The length of the data received, which is not used in the function.
    - ``ctx``: A context pointer, which is not used in the function.
- **Logic and Control Flow**:
    - Ignores all input parameters by casting them to void.
    - Generates a random number between 0 and 2 using the [`xorshift_next`](<#xorshift_next>) function and the `poll_rng` random number generator.
    - Executes the [`random_api_call`](<#random_api_call>) function a number of times equal to the random number generated.
- **Output**: No output is returned from this function.
- **Functions Called**:
    - [`xorshift_next`](<#xorshift_next>)
    - [`random_api_call`](<#random_api_call>)


---
### close\_reset\_clients\_fd<!-- {{#callable:close_reset_clients_fd}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L342>)

Closes and resets all client file descriptors and poll file descriptors in the HTTP server.
- **Inputs**:
    - `http`: A pointer to an `fd_http_server_t` structure representing the HTTP server.
- **Logic and Control Flow**:
    - Iterates over the `clients_fd` array up to `clients_fd_cnt` and closes each file descriptor that is not -1, then sets it to -1 and resets the corresponding `clients_ws_fd` to 0.
    - Resets `clients_fd_cnt` to 0 after closing all client file descriptors.
    - Iterates over the `http->pollfds` array up to the sum of `PARAMS.max_connection_cnt` and `PARAMS.max_ws_connection_cnt`, closing each file descriptor that is not -1.
- **Output**: No return value; the function operates by side effects on the `http` structure and global variables.


---
### reserve\_client\_fd<!-- {{#callable:reserve_client_fd}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L359>)

Reserves a file descriptor for a client connection if the maximum limit is not reached.
- **Inputs**: None
- **Logic and Control Flow**:
    - Checks if `clients_fd_cnt` is greater than or equal to `FD_HTTP_SERVER_GUI_MAX_CONNS * 2`.
    - If the condition is true, returns `NULL`.
    - If the condition is false, returns a pointer to the next available file descriptor in the `clients_fd` array and increments `clients_fd_cnt`.
- **Output**: Returns a pointer to an integer representing the reserved client file descriptor, or `NULL` if the maximum number of connections is reached.


---
### build\_http\_header<!-- {{#callable:build_http_header}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L366>)

Generates an HTTP header based on random selection of header types and writes it to a buffer.
- **Inputs**:
    - `u`: A pointer to a `struct Unstructured` which provides random data for header selection.
    - `buf`: A character buffer where the generated HTTP header will be written.
    - `max_len`: The maximum length of the buffer `buf`.
    - `use_web_socket`: A pointer to an integer that will be set to 1 if a WebSocket header is generated, otherwise remains unchanged.
- **Logic and Control Flow**:
    - Check if `max_len` is less than or equal to 0; if true, return 0 immediately.
    - Initialize `used` to 0 to track the number of characters written to `buf`.
    - Use a random number to select one of three cases: Content-Type, Accept-Encoding, or WebSocket header.
    - For Content-Type, randomly select a content type and optionally append a charset, then write to `buf`.
    - For Accept-Encoding, randomly select and concatenate encoding types, then write to `buf`.
    - For WebSocket, write a WebSocket upgrade header to `buf` and set `*use_web_socket` to 1.
    - If the number of characters written (`used`) exceeds `max_len`, reset `buf` to an empty string and set `used` to 0.
    - Return the number of characters written to `buf`.
- **Output**: Returns the number of characters written to the buffer `buf`, or 0 if the buffer is too small.
- **Functions Called**:
    - [`rand_uchar`](<#rand_uchar>)


---
### build\_http\_req<!-- {{#callable:build_http_req}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L422>)

Constructs an HTTP request and writes it to a buffer.
- **Inputs**:
    - `u`: A pointer to a `struct Unstructured` that provides random data for generating the request.
    - `buf`: A pointer to a buffer where the HTTP request will be written.
    - `len`: A pointer to an integer that initially contains the maximum size of the buffer and will be updated with the size of the generated request.
    - `use_websocket`: A pointer to an integer that will be set to 1 if the request includes a WebSocket upgrade header, otherwise it remains unchanged.
- **Logic and Control Flow**:
    - Initialize `max_size` with the value pointed to by `len` and set `size` to 0.
    - Clear the buffer `buf` by setting all its bytes to 0.
    - Select a random HTTP method from `METHODS` array and determine if it is a POST method.
    - Set the URI to `/home` and HTTP version to `HTTP/1.1`.
    - Initialize `headers` array to store HTTP headers and set `n_headers` to 0.
    - If the method is POST, add a `Content-Length` header to `headers` and update `cur_header_pos` and `rem`.
    - Randomly add additional headers using [`build_http_header`](<#build_http_header>) until `n_headers` reaches a random limit.
    - Format the HTTP request line and headers into `buf` using `snprintf`, updating `size`.
    - If the method is POST, append a body to the request and update `size`.
    - Update `len` with the final size of the HTTP request.
- **Output**: The function writes the constructed HTTP request to `buf` and updates `len` with the size of the request. If a WebSocket upgrade header is included, `use_websocket` is set to 1.
- **Functions Called**:
    - [`rand_uchar`](<#rand_uchar>)
    - [`rand_uint`](<#rand_uint>)
    - [`build_http_header`](<#build_http_header>)


---
### build\_ws\_req<!-- {{#callable:build_ws_req}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L466>)

Constructs a WebSocket request frame with a random opcode, payload length, and payload data.
- **Inputs**:
    - ``u``: A pointer to a `struct Unstructured` that provides random data for generating the WebSocket request.
    - ``buf``: A pointer to a buffer where the WebSocket request frame will be constructed.
    - ``len``: A pointer to an integer that initially contains the maximum length of the buffer and will be updated to the length of the constructed WebSocket request frame.
- **Logic and Control Flow**:
    - Initialize `cur_pos` to point to the start of the buffer `buf`.
    - Select a random opcode from the predefined `OPCODES` array and store it in `opcode`.
    - Set the first byte of the buffer to the `opcode`, optionally setting the FIN bit based on a random condition.
    - Increment `cur_pos` to point to the next position in the buffer.
    - Generate a random payload length and adjust it based on the opcode and the initial value of `*len`.
    - Determine the payload length encoding (7-bit, 16-bit, or 64-bit) and set the appropriate byte in the buffer.
    - Set the MASK bit in the payload length byte.
    - Increment `cur_pos` to point to the next position in the buffer.
    - If the payload length is encoded as 16-bit or 64-bit, write the length to the buffer and adjust `cur_pos` accordingly.
    - Write a zero mask key to the buffer and increment `cur_pos`.
    - Fill the buffer with random payload data up to the determined payload length.
    - Update `*len` to reflect the total length of the constructed WebSocket request frame.
- **Output**: The function updates the buffer `buf` with a WebSocket request frame and sets `*len` to the length of the constructed frame.
- **Functions Called**:
    - [`rand_uchar`](<#rand_uchar>)
    - [`rand_uint`](<#rand_uint>)


---
### stem\_thread<!-- {{#callable:stem_thread}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L518>)

Executes a loop that performs random API calls and polls an HTTP server until a stop condition is met.
- **Inputs**:
    - `arg`: Unused argument, typically used for thread functions.
- **Logic and Control Flow**:
    - Initialize `stem_iters` to 0.
    - Enter an infinite loop.
    - Generate a random number of iterations (0 to 2) and perform [`random_api_call`](<#random_api_call>) for each iteration.
    - Call [`fd_http_server_poll`](<fd_http_server.c.md#fd_http_server_poll>) to poll the HTTP server with a timeout of 0.
    - Generate another random number of iterations (0 to 2) and perform [`random_api_call`](<#random_api_call>) for each iteration.
    - Increment `stem_iters`.
    - Check if `stop` is true; if so, break the loop.
    - Call `sched_yield` to yield the processor to other threads.
- **Output**: Returns `NULL` after the loop exits.
- **Functions Called**:
    - [`xorshift_next`](<#xorshift_next>)
    - [`random_api_call`](<#random_api_call>)
    - [`fd_http_server_poll`](<fd_http_server.c.md#fd_http_server_poll>)


---
### do\_action<!-- {{#callable:do_action}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L548>)

Executes a random action on a network client, such as opening a connection, closing a connection, or sending data.
- **Inputs**:
    - `u`: A pointer to a `struct Unstructured` that provides random data for decision making.
- **Logic and Control Flow**:
    - Generate a random number using `rand_uchar(u) % ActionEnd` to decide which action to perform.
    - If the action is `HttpOpen`, attempt to reserve a client file descriptor and open a socket connection to localhost on a specified port.
    - If the action is `Close`, randomly select an active client connection and close it if it exists.
    - If the action is `Send`, randomly select an active client connection and send either an HTTP or WebSocket request, possibly mutating the data before sending.
- **Output**: No return value; the function performs actions on network connections.
- **Functions Called**:
    - [`rand_uchar`](<#rand_uchar>)
    - [`reserve_client_fd`](<#reserve_client_fd>)
    - [`build_http_req`](<#build_http_req>)
    - [`build_ws_req`](<#build_ws_req>)


---
### LLVMFuzzerTestOneInput<!-- {{#callable:LLVMFuzzerTestOneInput}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L632>)

Processes input data to simulate HTTP server operations and client interactions for fuzz testing.
- **Inputs**:
    - `data`: A pointer to an array of unsigned characters representing the input data for fuzz testing.
    - `size`: The size of the input data array in bytes.
- **Logic and Control Flow**:
    - Checks if the input size is at least the size of an integer.
    - Initializes an `Unstructured` struct with the input data and size.
    - Converts the IP address "0.0.0.0" to a network address and stores it in `ip_as_int`.
    - Seeds the random number generator with a value derived from the input data.
    - Allocates aligned memory for the HTTP server using `aligned_alloc`.
    - Initializes HTTP server callbacks for open, close, request, and WebSocket events.
    - Creates and starts an HTTP server with the specified parameters and callbacks.
    - Retrieves and stores the port number assigned to the server socket.
    - Initializes a `Xorshift` random number generator with a seed from the input data.
    - Starts a separate thread to handle server operations using `pthread_create`.
    - Performs a series of random actions on the server and clients based on the input data.
    - Stops the server operations and joins the thread after completing the actions.
    - Closes and resets client connections and cleans up server resources.
- **Output**: Returns 0 after processing the input data and simulating server operations.
- **Functions Called**:
    - [`rand_uint`](<#rand_uint>)
    - [`fd_http_server_align`](<fd_http_server.c.md#fd_http_server_align>)
    - [`fd_http_server_footprint`](<fd_http_server.c.md#fd_http_server_footprint>)
    - [`fd_http_server_join`](<fd_http_server.c.md#fd_http_server_join>)
    - [`fd_http_server_new`](<fd_http_server.c.md#fd_http_server_new>)
    - [`fd_http_server_listen`](<fd_http_server.c.md#fd_http_server_listen>)
    - [`xorshift_init`](<#xorshift_init>)
    - [`rand_uchar`](<#rand_uchar>)
    - [`do_action`](<#do_action>)
    - [`close_reset_clients_fd`](<#close_reset_clients_fd>)
    - [`fd_http_server_fd`](<fd_http_server.c.md#fd_http_server_fd>)
    - [`fd_http_server_delete`](<fd_http_server.c.md#fd_http_server_delete>)
    - [`fd_http_server_leave`](<fd_http_server.c.md#fd_http_server_leave>)


# Function Declarations (Public API)

---
### build\_http\_req<!-- {{#callable_declaration:build_http_req}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L80>)

Constructs an HTTP request in the provided buffer.
- **Description**: Use this function to create an HTTP request based on random data from the `Unstructured` input. It writes the request to the provided buffer and updates the length to reflect the size of the request. The function can generate requests with different HTTP methods and headers, and it may include a body if the method is POST. Ensure the buffer is large enough to hold the request, as specified by the initial value of `len`. The function does not handle buffer overflow; if the request exceeds the buffer size, it will not complete the request.
- **Inputs**:
    - `u`: A pointer to an `Unstructured` structure that provides random data for constructing the request. Must not be null.
    - `buf`: A pointer to a buffer where the HTTP request will be written. Must not be null and should have enough space as specified by `len`.
    - `len`: A pointer to an integer that initially specifies the maximum size of the buffer. After execution, it contains the actual size of the constructed request. Must not be null.
    - `use_websocket`: A pointer to an integer that indicates if the request includes a WebSocket upgrade header. Must not be null.
- **Output**: None
- **See Also**: [`build_http_req`](<#build_http_req>)  (Implementation)


---
### build\_ws\_req<!-- {{#callable_declaration:build_ws_req}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L81>)

Constructs a WebSocket request frame.
- **Description**: Use this function to create a WebSocket request frame in the provided buffer. The function generates a random opcode and payload length, and fills the buffer with a WebSocket frame. The payload is filled with random data. Ensure that the buffer is large enough to hold the frame, and the `len` parameter is set to the maximum buffer size before calling. The function updates `len` to reflect the actual size of the constructed frame.
- **Inputs**:
    - `u`: A pointer to a `struct Unstructured` that provides random data for frame construction. Must not be null.
    - `buf`: A pointer to a buffer where the WebSocket frame will be constructed. Must not be null and should have sufficient space to hold the frame.
    - `len`: A pointer to an integer that initially contains the maximum size of the buffer. The function updates it to the actual size of the constructed frame. Must not be null.
- **Output**: None
- **See Also**: [`build_ws_req`](<#build_ws_req>)  (Implementation)


---
### fd\_http\_server\_close<!-- {{#callable_declaration:fd_http_server_close}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L133>)

Closes a connection on the HTTP server.
- **Description**: Use this function to close an active connection on the HTTP server. This function requires a valid connection identifier and a reason for closing the connection. It is important to ensure that the connection identifier corresponds to an active connection managed by the server. This function does not return a value and does not provide feedback on the success of the operation.
- **Inputs**:
    - `http`: A pointer to an `fd_http_server_t` structure representing the HTTP server. Must not be null and must point to a valid server instance.
    - `conn_id`: An unsigned long integer representing the connection identifier. Must correspond to an active connection managed by the server.
    - `reason`: An integer representing the reason for closing the connection. The specific values and their meanings are determined by the application.
- **Output**: None
- **See Also**: [`fd_http_server_close`](<fd_http_server.c.md#fd_http_server_close>)  (Implementation)


---
### fd\_http\_server\_ws\_close<!-- {{#callable_declaration:fd_http_server_ws_close}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L138>)

Closes a WebSocket connection on the HTTP server.
- **Description**: Use this function to close an active WebSocket connection on the HTTP server. This function is useful when you need to terminate a WebSocket connection for a specific reason, such as an error or a protocol violation. Ensure that the `http` parameter is a valid pointer to an initialized HTTP server instance and that `ws_conn_id` corresponds to an active WebSocket connection. The function does not return a value and does not provide feedback on the success of the operation.
- **Inputs**:
    - `http`: Pointer to an `fd_http_server_t` structure representing the HTTP server. Must not be null and must point to a valid, initialized server instance.
    - `ws_conn_id`: Unsigned long integer representing the WebSocket connection ID to close. Must correspond to an active WebSocket connection on the server.
    - `reason`: Integer representing the reason for closing the connection. The specific values and their meanings are determined by the application.
- **Output**: None
- **See Also**: [`fd_http_server_ws_close`](<fd_http_server.c.md#fd_http_server_ws_close>)  (Implementation)


---
### fd\_http\_server\_ws\_send<!-- {{#callable_declaration:fd_http_server_ws_send}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L142>)

Sends a WebSocket frame for a specified connection.
- **Description**: Use this function to send a WebSocket frame for a specific connection identified by `ws_conn_id`. Ensure that the connection is open and not closed by other operations before calling this function. The function handles frame compression if configured and manages connection closure if the client is too slow. It must be called in the context of a valid `fd_http_server_t` instance.
- **Inputs**:
    - `http`: A pointer to an `fd_http_server_t` structure representing the HTTP server. Must not be null.
    - `ws_conn_id`: An unsigned long integer representing the WebSocket connection ID. Must be within the range of active connections.
- **Output**: Returns 0 on success, or -1 if an error occurs during the operation.
- **See Also**: [`fd_http_server_ws_send`](<fd_http_server.c.md#fd_http_server_ws_send>)  (Implementation)


---
### fd\_http\_server\_ws\_broadcast<!-- {{#callable_declaration:fd_http_server_ws_broadcast}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L146>)

Broadcasts a WebSocket message to all connected clients.
- **Description**: Use this function to send a WebSocket message to all currently connected clients of the HTTP server. It must be called when there is a message staged for broadcasting. The function handles compression if applicable and manages the connection state, including closing connections that are too slow to receive messages. Ensure that the HTTP server is properly initialized and running before calling this function.
- **Inputs**:
    - `http`: A pointer to an `fd_http_server_t` structure representing the HTTP server. Must not be null. The server must be initialized and running. If the server encounters an error during the broadcast, the function will reset the error state and return -1.
- **Output**: Returns 0 on success. Returns -1 if an error occurs during the broadcast, such as a stage error in the HTTP server.
- **See Also**: [`fd_http_server_ws_broadcast`](<fd_http_server.c.md#fd_http_server_ws_broadcast>)  (Implementation)


---
### fd\_http\_server\_printf<!-- {{#callable_declaration:fd_http_server_printf}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L149>)

Formats and appends data to the HTTP server's output buffer.
- **Description**: Use this function to format a string with variable arguments and append it to the HTTP server's output buffer. This function is useful for constructing dynamic HTTP responses. It must be called only when the server is in a valid state, as indicated by the absence of a stage error. The function does not perform any action if a stage error is present. Ensure that the server has enough buffer space to accommodate the formatted string.
- **Inputs**:
    - `http`: A pointer to an `fd_http_server_t` structure representing the HTTP server. Must not be null and must point to a valid server instance.
    - `fmt`: A format string similar to those used in `printf`. Must not be null and should be a valid format string.
    - `...`: A variable number of arguments that correspond to the format specifiers in `fmt`. The types and number of arguments must match the format specifiers.
- **Output**: None
- **See Also**: [`fd_http_server_printf`](<fd_http_server.c.md#fd_http_server_printf>)  (Implementation)


---
### fd\_http\_server\_memcpy<!-- {{#callable_declaration:fd_http_server_memcpy}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L154>)

Copies data to the HTTP server's buffer.
- **Description**: Use this function to copy a specified amount of data into the buffer of an HTTP server instance. Ensure that the server instance is properly initialized before calling this function. The function reserves space in the server's buffer for the data and then copies the data into it. If an error occurs during the reservation, the function will not perform the copy operation.
- **Inputs**:
    - `http`: A pointer to an `fd_http_server_t` instance. Must not be null. The server instance must be initialized and ready to receive data.
    - `data`: A pointer to the data to copy. Must not be null. The caller retains ownership of the data.
    - `data_len`: The length of the data to copy, in bytes. Must be a valid length that fits within the server's buffer constraints.
- **Output**: None
- **See Also**: [`fd_http_server_memcpy`](<fd_http_server.c.md#fd_http_server_memcpy>)  (Implementation)


---
### fd\_http\_server\_stage\_trunc<!-- {{#callable_declaration:fd_http_server_stage_trunc}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L159>)

Truncates the HTTP server's staging buffer to a specified length.
- **Description**: Use this function to set the length of the HTTP server's staging buffer to a specific value. This operation resets the completed length of the staging buffer to zero and sets the current length to the specified value. It is important to ensure that the `http` parameter is a valid pointer to an `fd_http_server_t` structure before calling this function.
- **Inputs**:
    - `http`: A pointer to an `fd_http_server_t` structure. Must not be null. The caller retains ownership.
    - `len`: The new length for the staging buffer. Must be a valid unsigned long value.
- **Output**: None
- **See Also**: [`fd_http_server_stage_trunc`](<fd_http_server.c.md#fd_http_server_stage_trunc>)  (Implementation)


---
### fd\_http\_server\_unstage<!-- {{#callable_declaration:fd_http_server_unstage}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L163>)

Resets the staging state of the HTTP server.
- **Description**: Use this function to reset the staging state of an HTTP server instance. This function sets the error and length fields related to staging to zero, effectively clearing any staged data or errors. Call this function when you need to discard any partially staged data or reset the staging state before starting a new operation. Ensure that the `http` parameter is a valid pointer to an `fd_http_server_t` instance.
- **Inputs**:
    - `http`: A pointer to an `fd_http_server_t` instance. Must not be null. The function will reset the staging-related fields of this instance.
- **Output**: None
- **See Also**: [`fd_http_server_unstage`](<fd_http_server.c.md#fd_http_server_unstage>)  (Implementation)


---
### fd\_http\_server\_stage\_body<!-- {{#callable_declaration:fd_http_server_stage_body}} -->
[View Source →](<../../../../../src/waltz/http/fuzz_httpserver.c#L166>)

Stages the HTTP response body for transmission.
- **Description**: Use this function to prepare the HTTP response body for sending. It updates the response object with the current stage offset and length, and then advances the stage offset. If an error is detected in the staging process, it resets the error state and returns an error code. This function must be called after the HTTP server has been initialized and before sending a response.
- **Inputs**:
    - `http`: A pointer to an `fd_http_server_t` structure representing the HTTP server. Must not be null. The function checks for errors in the staging process using this parameter.
    - `response`: A pointer to an `fd_http_server_response_t` structure where the function will store the body offset and length. Must not be null.
- **Output**: Returns 0 on success, or -1 if there was an error in the staging process.
- **See Also**: [`fd_http_server_stage_body`](<fd_http_server.c.md#fd_http_server_stage_body>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)