<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

BPF syscall wrappers for operations like map manipulation and object pinning on Linux.

# Purpose
The `fd_linux_bpf.h` file provides a set of inline functions that serve as wrappers for BPF (Berkeley Packet Filter) syscalls on Linux systems. These functions facilitate interaction with BPF maps and objects by abstracting the complexity of direct syscall usage. The file includes necessary headers and checks for compatibility with Linux systems before defining the functions. The primary functions include [`fd_bpf_map_get_next_key`](<#fd_bpf_map_get_next_key>), [`fd_bpf_map_update_elem`](<#fd_bpf_map_update_elem>), [`fd_bpf_map_delete_elem`](<#fd_bpf_map_delete_elem>), [`fd_bpf_obj_get`](<#fd_bpf_obj_get>), and [`fd_bpf_obj_pin`](<#fd_bpf_obj_pin>). Each function corresponds to a specific BPF operation, such as retrieving the next key in a BPF map, updating or deleting map elements, and managing BPF objects in the filesystem.

The functions use a `union bpf_attr` structure to pass parameters to the [`bpf`](<#bpf>) syscall, which is defined as a static inline function. This design allows for efficient execution by minimizing function call overhead. The functions return standard success or failure codes, with detailed error handling through the `errno` variable. This header file is intended to be included in other C source files that require BPF functionality, providing a streamlined interface for BPF operations without exposing the underlying syscall details.
# Imports and Dependencies

---
- `../../util/fd_util_base.h`
- `sys/syscall.h`
- `unistd.h`
- `linux/bpf.h`


# Functions

---
### bpf<!-- {{#callable:bpf}} -->
[View Source →](<../../../../../src/waltz/ebpf/fd_linux_bpf.h#L16>)

Executes a BPF syscall with specified command and attributes.
- **Inputs**:
    - `cmd`: An integer representing the BPF command to execute.
    - `attr`: A pointer to a `union bpf_attr` structure containing the attributes for the BPF command.
    - `attr_sz`: An unsigned long representing the size of the `attr` structure.
- **Logic and Control Flow**:
    - Calls the `syscall` function with `SYS_bpf`, `cmd`, `attr`, and `attr_sz` as arguments.
    - Returns the result of the `syscall` function call.
- **Output**: Returns a long integer which is the result of the BPF syscall.


---
### fd\_bpf\_map\_get\_next\_key<!-- {{#callable:fd_bpf_map_get_next_key}} -->
[View Source →](<../../../../../src/waltz/ebpf/fd_linux_bpf.h#L33>)

Retrieves the next key in a BPF map given a current key and map file descriptor.
- **Inputs**:
    - `map_fd`: The file descriptor of the BPF map.
    - `key`: A pointer to the current key in the BPF map.
    - `next_key`: A pointer where the function will store the next key in the BPF map.
- **Logic and Control Flow**:
    - Initializes a `bpf_attr` union with the provided `map_fd`, `key`, and `next_key` pointers.
    - Calls the [`bpf`](<#bpf>) function with the command `BPF_MAP_GET_NEXT_KEY`, passing the `bpf_attr` union and its size.
    - Returns the result of the [`bpf`](<#bpf>) syscall, which is 0 on success or -1 on failure.
- **Output**: Returns 0 on success, indicating the next key was found and stored in `next_key`, or -1 on failure, with `errno` set to indicate the error.
- **Functions Called**:
    - [`bpf`](<#bpf>)


---
### fd\_bpf\_map\_update\_elem<!-- {{#callable:fd_bpf_map_update_elem}} -->
[View Source →](<../../../../../src/waltz/ebpf/fd_linux_bpf.h#L55>)

Creates or updates an entry in a BPF map using the specified key, value, and flags.
- **Inputs**:
    - `map_fd`: The file descriptor of the BPF map.
    - `key`: A pointer to the key for the entry to be created or updated.
    - `value`: A pointer to the value associated with the key.
    - `flags`: Flags indicating the operation type: BPF_ANY, BPF_NOEXIST, or BPF_EXIST.
- **Logic and Control Flow**:
    - Initialize a `bpf_attr` union with the provided `map_fd`, `key`, `value`, and `flags`.
    - Call the [`bpf`](<#bpf>) function with the command `BPF_MAP_UPDATE_ELEM`, passing the address of the `bpf_attr` union and its size.
    - Return the result of the [`bpf`](<#bpf>) function call as an integer.
- **Output**: Returns 0 on success or -1 on failure, setting `errno` to indicate the error.
- **Functions Called**:
    - [`bpf`](<#bpf>)


---
### fd\_bpf\_map\_delete\_elem<!-- {{#callable:fd_bpf_map_delete_elem}} -->
[View Source →](<../../../../../src/waltz/ebpf/fd_linux_bpf.h#L76>)

Deletes an entry from a BPF map using the specified key.
- **Inputs**:
    - `map_fd`: The file descriptor of the BPF map from which to delete the entry.
    - `key`: A pointer to the key of the entry to be deleted, which must match the key size of the map object.
- **Logic and Control Flow**:
    - Initialize a `bpf_attr` union with the `map_fd` and `key` values cast to `uint` and `ulong`, respectively.
    - Call the [`bpf`](<#bpf>) function with the command `BPF_MAP_DELETE_ELEM`, passing the address of the `bpf_attr` union and its size.
    - Return the result of the [`bpf`](<#bpf>) function call, which is an integer indicating success or failure.
- **Output**: Returns 0 on success and -1 on failure, with `errno` set to indicate the error (e.g., `ENOENT` if the key does not exist).
- **Functions Called**:
    - [`bpf`](<#bpf>)


---
### fd\_bpf\_obj\_get<!-- {{#callable:fd_bpf_obj_get}} -->
[View Source →](<../../../../../src/waltz/ebpf/fd_linux_bpf.h#L92>)

Opens a BPF map at a specified filesystem path using the BPF_OBJ_GET operation.
- **Inputs**:
    - `pathname`: A constant character pointer to the filesystem path where the BPF map is located. The path must be within a valid bpffs mount and point to a BPF map pinned via BPF_OBJ_PIN.
- **Logic and Control Flow**:
    - Initialize a `bpf_attr` union with the `pathname` cast to an unsigned long.
    - Call the [`bpf`](<#bpf>) function with the command `BPF_OBJ_GET`, passing the address of the `attr` union and the size of the `bpf_attr` union.
    - Return the result of the [`bpf`](<#bpf>) function call cast to an integer.
- **Output**: Returns a file descriptor number on success or a negative integer on failure.
- **Functions Called**:
    - [`bpf`](<#bpf>)


---
### fd\_bpf\_obj\_pin<!-- {{#callable:fd_bpf_obj_pin}} -->
[View Source →](<../../../../../src/waltz/ebpf/fd_linux_bpf.h#L106>)

Pins a BPF object to a specified filesystem path using the BPF_OBJ_PIN operation.
- **Inputs**:
    - `bpf_fd`: The file descriptor of the BPF object to pin.
    - `pathname`: The filesystem path where the BPF object will be pinned.
- **Logic and Control Flow**:
    - Creates a `bpf_attr` union and initializes its `bpf_fd` and `pathname` fields with the provided `bpf_fd` and `pathname` arguments.
    - Calls the [`bpf`](<#bpf>) function with the command `BPF_OBJ_PIN`, passing the address of the `bpf_attr` union and its size.
    - Returns the result of the [`bpf`](<#bpf>) function call, which is 0 on success and -1 on failure.
- **Output**: Returns 0 on success and -1 on failure.
- **Functions Called**:
    - [`bpf`](<#bpf>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)