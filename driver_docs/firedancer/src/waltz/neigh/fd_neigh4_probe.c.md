<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Initializes, finalizes, and sends probe packets to Ethernet neighbors using a UDP socket.

# Purpose
The code defines a set of functions for managing and using a network probe mechanism, specifically targeting IPv4 Ethernet neighbors. It includes the initialization and finalization of a probe structure (`fd_neigh4_prober_t`), as well as a function to send probe packets ([`fd_neigh4_probe`](<#fd_neigh4_probe>)). The [`fd_neigh4_prober_init`](<#fd_neigh4_prober_init>) function sets up a UDP socket with specific options, such as setting the IP Time-To-Live (TTL) to 1 and enabling the `SO_DONTROUTE` option to restrict packet routing to local networks. It also configures a rate-limiting mechanism using a token bucket model to control the frequency of probe packets. The [`fd_neigh4_prober_fini`](<#fd_neigh4_prober_fini>) function closes the socket and cleans up resources.

The [`fd_neigh4_probe`](<#fd_neigh4_probe>) function sends a probe packet to a specified IPv4 address using the initialized socket. It constructs a destination address structure and uses the `sendto` function to transmit the packet. The function also updates the `probe_suppress_until` field of the `fd_neigh4_entry_t` structure to enforce a delay before the next probe can be sent to the same address. This code is part of a network probing library and is intended to be used in applications that require monitoring or discovery of local network neighbors.
# Imports and Dependencies

---
- `fd_neigh4_probe.h`
- `../../tango/tempo/fd_tempo.h`
- `errno.h`
- `sys/socket.h`
- `netinet/in.h`
- `unistd.h`


# Functions

---
### fd\_neigh4\_prober\_init<!-- {{#callable:fd_neigh4_prober_init}} -->
[View Source →](<../../../../../src/waltz/neigh/fd_neigh4_probe.c#L9>)

Initializes a `fd_neigh4_prober_t` structure for probing Ethernet neighbors with specified rate limits and delay.
- **Inputs**:
    - `prober`: A pointer to a `fd_neigh4_prober_t` structure to initialize.
    - `max_probes_per_second`: The maximum number of probes allowed per second.
    - `max_probe_burst`: The maximum number of probes that can be sent in a burst.
    - `probe_delay_seconds`: The delay in seconds between probes.
- **Logic and Control Flow**:
    - Create a UDP socket with `AF_INET` and `SOCK_DGRAM` parameters.
    - Check if socket creation fails and log an error if it does.
    - Set the IP Time-To-Live (TTL) option to 1 for the socket and log an error if setting fails.
    - Set the socket option `SO_DONTROUTE` to 1 to restrict packet sending to Ethernet neighbors and log an error if setting fails.
    - Calculate the number of ticks per nanosecond using `fd_tempo_tick_per_ns`.
    - Initialize the `fd_neigh4_prober_t` structure with the socket file descriptor, calculated probe delay, and rate limit settings.
- **Output**: A fully initialized `fd_neigh4_prober_t` structure with a configured socket and rate limiting parameters.


---
### fd\_neigh4\_prober\_fini<!-- {{#callable:fd_neigh4_prober_fini}} -->
[View Source →](<../../../../../src/waltz/neigh/fd_neigh4_probe.c#L54>)

Closes the socket file descriptor in the `fd_neigh4_prober_t` structure and sets it to -1.
- **Inputs**:
    - `prober`: A pointer to an `fd_neigh4_prober_t` structure that contains the socket file descriptor to close.
- **Logic and Control Flow**:
    - Check if closing the socket file descriptor `prober->sock_fd` returns a non-zero value, indicating an error.
    - If an error occurs, log the error message with the file descriptor number, error number, and error string.
    - Set `prober->sock_fd` to -1 to indicate that the socket is no longer valid.
- **Output**: No return value; the function modifies the `prober` structure in place.


---
### fd\_neigh4\_probe<!-- {{#callable:fd_neigh4_probe}} -->
[View Source →](<../../../../../src/waltz/neigh/fd_neigh4_probe.c#L63>)

Sends a probe packet to a specified IPv4 address and updates the probe suppression time for the entry.
- **Inputs**:
    - `prober`: A pointer to an `fd_neigh4_prober_t` structure that contains the socket file descriptor and probe delay information.
    - `entry`: A pointer to an `fd_neigh4_entry_t` structure that will have its `probe_suppress_until` field updated.
    - `ip4_addr`: An unsigned integer representing the IPv4 address to which the probe packet is sent.
    - `now`: A long integer representing the current time, used to calculate the next probe suppression time.
- **Logic and Control Flow**:
    - Initialize a `sockaddr_in` structure `dst` with the IPv4 address `ip4_addr`, family `AF_INET`, and port `0xFFFF`.
    - Attempt to send a probe packet using the `sendto` function with the socket file descriptor from `prober`, sending to the address specified in `dst`.
    - If the `sendto` call fails, return the error number `errno`.
    - Update the `probe_suppress_until` field of `entry` to `now` plus the probe delay from `prober`.
    - Return 0 to indicate success.
- **Output**: Returns 0 on success, or an error number if the `sendto` call fails.



---
Made with ❤️ by [Driver](https://www.driver.ai/)