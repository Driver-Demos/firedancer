<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests the functionality of dumping neighbor tables for all Ethernet interfaces using netlink.

# Purpose
The code is an executable C program that interacts with network interfaces to manage and display neighbor tables for Ethernet interfaces using the Netlink protocol. It includes functions to request and process network interface information and neighbor table entries. The program initializes a workspace and sets up Netlink sockets to communicate with the kernel. It uses these sockets to send requests for network interface information and to dump neighbor tables for each Ethernet interface found. The neighbor table entries are stored in a hash map structure, which is initialized, populated, and then reinitialized after dumping the current state to standard error output.

The main components of the code include the [`dump_neighbor_table`](<#dump_neighbor_table>) and [`dump_all_neighbor_tables`](<#dump_all_neighbor_tables>) functions, which handle the retrieval and display of neighbor table information. The [`main`](<#main>) function sets up the environment, initializes necessary resources, and orchestrates the process of dumping neighbor tables. The program uses several utility functions and structures, such as `fd_neigh4_hmap_t` for managing neighbor table entries and `fd_netlink_t` for Netlink communication. The code is structured to handle errors and log messages, ensuring that the operations are traceable and any issues are reported.
# Imports and Dependencies

---
- `fd_neigh4_netlink.h`
- `errno.h`
- `stdio.h`
- `sys/socket.h`
- `net/if.h`
- `linux/if_arp.h`
- `linux/netlink.h`
- `linux/rtnetlink.h`
- `../../util/fd_util.h`


# Functions

---
### dump\_neighbor\_table<!-- {{#callable:dump_neighbor_table}} -->
[View Source →](<../../../../../src/waltz/neigh/test_neigh4_netlink.c#L11>)

Dumps and reinitializes the neighbor table for a specified network interface.
- **Inputs**:
    - `map`: A pointer to the `fd_neigh4_hmap_t` structure representing the neighbor table.
    - `netlink1`: A pointer to the `fd_netlink_t` structure used for netlink communication.
    - `if_idx`: An integer representing the index of the network interface.
- **Logic and Control Flow**:
    - Calls [`fd_neigh4_netlink_request_dump`](<fd_neigh4_netlink.c.md#fd_neigh4_netlink_request_dump>) to request a dump of the neighbor table for the specified interface.
    - Initializes a buffer and an iterator for processing netlink messages.
    - Iterates over the netlink messages using `fd_netlink_iter_init`, `fd_netlink_iter_done`, and `fd_netlink_iter_next`.
    - Ingests each netlink message into the neighbor table using [`fd_neigh4_netlink_ingest_message`](<fd_neigh4_netlink.c.md#fd_neigh4_netlink_ingest_message>).
    - Prints the current state of the neighbor table to `stderr` using [`fd_neigh4_hmap_fprintf`](<fd_neigh4_map.c.md#fd_neigh4_hmap_fprintf>).
    - Reinitializes the neighbor table by deleting the current map, clearing the entries, and creating a new map with the same parameters.
- **Output**: No return value; the function operates on the provided data structures and outputs to `stderr`.
- **Functions Called**:
    - [`fd_neigh4_netlink_request_dump`](<fd_neigh4_netlink.c.md#fd_neigh4_netlink_request_dump>)
    - [`fd_neigh4_netlink_ingest_message`](<fd_neigh4_netlink.c.md#fd_neigh4_netlink_ingest_message>)
    - [`fd_neigh4_hmap_fprintf`](<fd_neigh4_map.c.md#fd_neigh4_hmap_fprintf>)


---
### dump\_all\_neighbor\_tables<!-- {{#callable:dump_all_neighbor_tables}} -->
[View Source →](<../../../../../src/waltz/neigh/test_neigh4_netlink.c#L46>)

Dumps neighbor tables for all Ethernet interfaces by sending a netlink request and processing the responses.
- **Inputs**:
    - ``map``: A pointer to `fd_neigh4_hmap_t`, which is used to store the neighbor table data.
    - ``netlink0``: A pointer to `fd_netlink_t`, used to send and receive netlink messages for listing network interfaces.
    - ``netlink1``: A pointer to `fd_netlink_t`, used to send and receive netlink messages for dumping neighbor tables.
- **Logic and Control Flow**:
    - Initialize a netlink request to list all network interfaces with `RTM_GETLINK` and `NLM_F_DUMP` flags.
    - Send the netlink request using `netlink0` and check for errors in sending.
    - Log a notice about dumping neighbor tables for all Ethernet interfaces.
    - Initialize a buffer and an iterator for processing netlink messages.
    - Iterate over the received netlink messages using `fd_netlink_iter_t`.
    - For each message, check if it is an error message (`NLMSG_ERROR`) and log an error if so.
    - If the message type is not `RTM_NEWLINK`, log a debug message and continue to the next message.
    - For each valid `RTM_NEWLINK` message, extract the interface index and call [`dump_neighbor_table`](<#dump_neighbor_table>) to process the neighbor table for that interface.
- **Output**: No return value; the function logs errors and notices, and processes neighbor tables for each Ethernet interface.
- **Functions Called**:
    - [`dump_neighbor_table`](<#dump_neighbor_table>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/waltz/neigh/test_neigh4_netlink.c#L102>)

Initializes the environment, sets up shared memory and network link structures, processes command-line arguments, and dumps neighbor tables for all Ethernet interfaces.
- **Inputs**:
    - `argc`: The count of command-line arguments.
    - `argv`: The array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Determines the CPU index using `fd_tile_cpu_id` and `fd_tile_idx`, and adjusts it if it exceeds the shared memory CPU count.
    - Processes command-line arguments to get page size, page count, and NUMA index, with defaults if not provided.
    - Converts the page size string to an unsigned long and logs an error if the conversion fails.
    - Creates an anonymous workspace with the specified page size, page count, and NUMA index, and checks for successful creation.
    - Initializes two `fd_netlink_t` structures with different IDs and checks for successful initialization.
    - Allocates memory for a hash map and element storage in the workspace, and checks for successful allocation.
    - Creates a new neighbor hash map and joins it to the allocated memory, checking for success.
    - Calls [`dump_all_neighbor_tables`](<#dump_all_neighbor_tables>) to process and display neighbor tables for all Ethernet interfaces.
    - Finalizes the `fd_netlink_t` structures and releases resources associated with the neighbor hash map and workspace.
    - Logs a notice indicating successful completion and calls `fd_halt` to terminate the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`dump_all_neighbor_tables`](<#dump_all_neighbor_tables>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)