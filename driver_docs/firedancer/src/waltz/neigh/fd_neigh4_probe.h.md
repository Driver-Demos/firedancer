<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a mechanism to trigger ARP requests using UDP packets with minimal privileges.

# Purpose
The `fd_neigh4_probe.h` file provides functionality to indirectly trigger ARP (Address Resolution Protocol) requests in Linux using the Firedancer network stack. This is achieved by sending empty UDP packets to a specified IP address, which prompts the kernel to perform ARP requests without requiring elevated privileges. The file defines a structure, `fd_neigh4_prober_t`, which includes a UDP socket, a delay for successive ARP requests, a token bucket rate limiter, and counters for rate-limited probes. The primary purpose of this code is to manage neighbor probing with minimal privileges, using solution 3 from the documented possible solutions.

The file includes functions to initialize and finalize the `fd_neigh4_prober_t` structure, as well as to send probes. The [`fd_neigh4_prober_init`](<#fd_neigh4_prober_init>) function sets up a UDP socket with a TTL of zero and configures rate limiting parameters. The [`fd_neigh4_probe`](<#fd_neigh4_probe>) function sends an empty UDP packet to initiate the neighbor discovery process. Additionally, the [`fd_neigh4_probe_rate_limited`](<#fd_neigh4_probe_rate_limited>) function ensures that probes adhere to local and global rate limits, incrementing counters when limits are reached. This header file is intended to be included in other C files, providing a public API for neighbor probing in network applications.
# Imports and Dependencies

---
- `fd_neigh4_map.h`
- `../fd_token_bucket.h`


# Data Structures

---
### fd\_neigh4\_prober
- **Type**: ``struct``
- **Members**:
    - `sock_fd`: UDP socket with IP_TTL 0.
    - `probe_delay`: Specifies the delay in ticks for successive ARP requests to the same IP address.
    - `rate_limit`: Token bucket rate limiter on any outgoing ARP probes.
    - `local_rate_limited_cnt`: Metric counter for probes suppressed by local rate limit.
    - `global_rate_limited_cnt`: Metric counter for probes suppressed by global rate limit.
- **Description**: Provides a structure for managing ARP probe operations using UDP sockets with rate limiting and delay mechanisms. It includes fields for socket file descriptor, probe delay, rate limiting, and counters for rate-limited probes.


---
### fd\_neigh4\_prober\_t
- **Type**: ``struct``
- **Members**:
    - `sock_fd`: UDP socket with IP_TTL 0.
    - `probe_delay`: Specifies the delay in ticks for successive ARP requests to the same IP address.
    - `rate_limit`: Token bucket rate limiter on any outgoing ARP probes.
    - `local_rate_limited_cnt`: Metric counter for probes suppressed by local rate limit.
    - `global_rate_limited_cnt`: Metric counter for probes suppressed by global rate limit.
- **Description**: Provides neighbor probing functionality using empty UDP/IP packets to indirectly trigger ARP requests in Linux, implementing a solution that requires minimal privileges.


# Functions

---
### fd\_neigh4\_probe\_rate\_limited<!-- {{#callable:fd_neigh4_probe_rate_limited}} -->
[View Source →](<../../../../../src/waltz/neigh/fd_neigh4_probe.h#L110>)

Calls [`fd_neigh4_probe`](<fd_neigh4_probe.c.md#fd_neigh4_probe>) to send a probe unless local or global rate limits are exceeded.
- **Inputs**:
    - `prober`: A pointer to an `fd_neigh4_prober_t` structure that manages probe operations and rate limits.
    - `entry`: A pointer to an `fd_neigh4_entry_t` structure that contains information about the neighbor entry, including the next allowed probe time.
    - `ip4_addr`: An unsigned integer representing the IPv4 address of the target neighbor in big-endian format.
    - `now`: A long integer representing the current time in ticks, used to check rate limits.
- **Logic and Control Flow**:
    - Check if the current time `now` is less than `entry->probe_suppress_until`; if true, increment `prober->local_rate_limited_cnt` and return -1.
    - Update `entry->probe_suppress_until` to `now + prober->probe_delay`.
    - Attempt to consume a token from `prober->rate_limit` using `fd_token_bucket_consume`; if unsuccessful, increment `prober->global_rate_limited_cnt` and return -1.
    - Call [`fd_neigh4_probe`](<fd_neigh4_probe.c.md#fd_neigh4_probe>) with the provided arguments to send a probe.
- **Output**: Returns 0 if a probe is sent successfully, -1 if a rate limit is hit, or a positive errno value if [`fd_neigh4_probe`](<fd_neigh4_probe.c.md#fd_neigh4_probe>) fails.
- **Functions Called**:
    - [`fd_neigh4_probe`](<fd_neigh4_probe.c.md#fd_neigh4_probe>)


# Function Declarations (Public API)

---
### fd\_neigh4\_prober\_init<!-- {{#callable_declaration:fd_neigh4_prober_init}} -->
[View Source →](<../../../../../src/waltz/neigh/fd_neigh4_probe.h#L74>)

Initializes a neighbor prober for ARP requests.
- **Description**: Use this function to set up a `fd_neigh4_prober_t` object for sending ARP requests via UDP packets. This function creates a new unbound UDP socket with specific configurations, including an IPv4 TTL of zero. It configures rate limiting for outgoing probe packets using a token bucket algorithm, and sets a minimum delay between successive probes to the same IP address. Call this function before using the prober to ensure it is properly initialized.
- **Inputs**:
    - `prober`: A pointer to a `fd_neigh4_prober_t` structure. Must not be null. The function initializes this structure with the necessary socket and rate limiting configurations.
    - `max_probes_per_second`: A float specifying the maximum number of probes allowed per second. Must be a positive value. Used to configure the rate limiter.
    - `max_probe_burst`: An unsigned long specifying the maximum burst size for probe packets. Must be a positive value. Used to configure the rate limiter.
    - `probe_delay_seconds`: A float specifying the minimum delay in seconds between successive probes to the same IP address. Must be a non-negative value.
- **Output**: None
- **See Also**: [`fd_neigh4_prober_init`](<fd_neigh4_probe.c.md#fd_neigh4_prober_init>)  (Implementation)


---
### fd\_neigh4\_prober\_fini<!-- {{#callable_declaration:fd_neigh4_prober_fini}} -->
[View Source →](<../../../../../src/waltz/neigh/fd_neigh4_probe.h#L91>)

Closes the socket associated with a neighbor prober.
- **Description**: Use this function to close the socket of a `fd_neigh4_prober_t` instance when it is no longer needed. This function should be called to release the resources associated with the prober, specifically the UDP socket. It is important to ensure that the prober is properly initialized before calling this function. After execution, the socket file descriptor within the prober is set to -1, indicating that it is closed. This function does not handle invalid input and assumes that the provided prober is valid and initialized.
- **Inputs**:
    - `prober`: A pointer to a `fd_neigh4_prober_t` instance. The prober must be initialized and must not be null. The function does not perform any checks on the validity of the pointer, so passing a null or uninitialized pointer can lead to undefined behavior.
- **Output**: None
- **See Also**: [`fd_neigh4_prober_fini`](<fd_neigh4_probe.c.md#fd_neigh4_prober_fini>)  (Implementation)


---
### fd\_neigh4\_probe<!-- {{#callable_declaration:fd_neigh4_probe}} -->
[View Source →](<../../../../../src/waltz/neigh/fd_neigh4_probe.h#L100>)

Sends an empty UDP packet to trigger ARP requests.
- **Description**: Use this function to initiate the neighbor discovery process by sending an empty UDP packet to a specified IP address on a neighboring subnet. This action indirectly triggers the kernel to send an ARP request. The function requires a valid `fd_neigh4_prober_t` object, which must be initialized before calling this function. The `ip4_addr` parameter must be in big-endian format. The `now` parameter should be a recent tick count value. The function updates the `probe_suppress_until` field in the `entry` to prevent immediate successive probes to the same IP address. It returns 0 on success or an error code if the `sendto` operation fails.
- **Inputs**:
    - `prober`: A pointer to an `fd_neigh4_prober_t` object. Must be initialized and not null. The function uses this object to send the UDP packet.
    - `entry`: A pointer to an `fd_neigh4_entry_t` object. Must not be null. The function updates the `probe_suppress_until` field in this object.
    - `ip4_addr`: An unsigned integer representing the IP address in big-endian format. Must be a valid IP address on a neighboring subnet.
    - `now`: A long integer representing the current tick count. Used to calculate the next allowable probe time.
- **Output**: Returns 0 on success. If `sendto` fails, returns the corresponding errno value.
- **See Also**: [`fd_neigh4_probe`](<fd_neigh4_probe.c.md#fd_neigh4_probe>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)