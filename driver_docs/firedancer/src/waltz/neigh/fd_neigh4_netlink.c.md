<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Handles IPv4 neighbor table updates using netlink messages for adding, removing, or updating entries.

# Purpose
The code provides functionality for managing IPv4 neighbor entries using the Netlink protocol in a Linux environment. It includes two main functions: [`fd_neigh4_netlink_request_dump`](<#fd_neigh4_netlink_request_dump>) and [`fd_neigh4_netlink_ingest_message`](<#fd_neigh4_netlink_ingest_message>). The [`fd_neigh4_netlink_request_dump`](<#fd_neigh4_netlink_request_dump>) function sends a Netlink request to dump the neighbor table for a specified network interface, identified by `if_idx`. It constructs a Netlink message with the type `RTM_GETNEIGH` and flags `NLM_F_REQUEST | NLM_F_DUMP`, then sends this message through a Netlink socket. The function handles errors related to sending the message and logs warnings if any issues occur.

The [`fd_neigh4_netlink_ingest_message`](<#fd_neigh4_netlink_ingest_message>) function processes incoming Netlink messages related to neighbor entries. It checks the message type to determine if it is a new or deleted neighbor entry (`RTM_NEWNEIGH` or `RTM_DELNEIGH`). The function extracts the IPv4 address and MAC address from the message attributes and updates the neighbor table accordingly. It uses a hash map (`fd_neigh4_hmap_t`) to manage the neighbor entries, either removing or updating them based on the state of the neighbor (`ndm_state`). The function ensures that only valid entries with both Layer 2 and Layer 3 addresses are processed, and it logs warnings for unexpected conditions.
# Imports and Dependencies

---
- `fd_neigh4_netlink.h`
- `errno.h`
- `sys/socket.h`
- `linux/netlink.h`
- `linux/rtnetlink.h`
- `linux/neighbour.h`
- `../ip/fd_netlink1.h`
- `fd_neigh4_map.h`


# Functions

---
### fd\_neigh4\_netlink\_request\_dump<!-- {{#callable:fd_neigh4_netlink_request_dump}} -->
[View Source →](<../../../../../src/waltz/neigh/fd_neigh4_netlink.c#L11>)

Sends a netlink request to dump IPv4 neighbor information for a specified network interface.
- **Inputs**:
    - ``netlink``: A pointer to an `fd_netlink_t` structure that contains the netlink socket file descriptor and sequence number.
    - ``if_idx``: An unsigned integer representing the index of the network interface for which to request neighbor information.
- **Logic and Control Flow**:
    - Increment the sequence number in the `netlink` structure.
    - Initialize a `request` structure with netlink message header and neighbor message details.
    - Set the netlink message type to `RTM_GETNEIGH` and flags to `NLM_F_REQUEST | NLM_F_DUMP`.
    - Set the neighbor message family to `AF_INET` and interface index to `if_idx`.
    - Send the `request` structure through the netlink socket using the `send` function.
    - If the `send` function returns a negative value, log a warning and return the error number.
    - If the `send` function returns a value not equal to the size of the `request`, log a warning and return `EPIPE`.
    - Return 0 on successful execution.
- **Output**: Returns 0 on success, or an error code if the send operation fails.


---
### fd\_neigh4\_netlink\_ingest\_message<!-- {{#callable:fd_neigh4_netlink_ingest_message}} -->
[View Source →](<../../../../../src/waltz/neigh/fd_neigh4_netlink.c#L45>)

Processes a netlink message to update or remove an entry in the IPv4 neighbor table.
- **Inputs**:
    - `map`: A pointer to the `fd_neigh4_hmap_t` structure representing the neighbor table.
    - `msg_hdr`: A constant pointer to a `struct nlmsghdr` representing the netlink message header.
    - `if_idx`: An unsigned integer representing the interface index to match against the message.
- **Logic and Control Flow**:
    - Check if the message type is either `RTM_NEWNEIGH` or `RTM_DELNEIGH`; log a warning and return if not.
    - Extract the `ndmsg` and `rtattr` structures from the message header.
    - Verify that the address family is `AF_INET` and the interface index matches `if_idx`; return if not.
    - Initialize `ip4_dst` and `mac_addr` to store the destination IP and MAC address respectively.
    - Iterate over the attributes in the message to extract `NDA_DST` and `NDA_LLADDR` attributes; log a warning and return if sizes are unexpected.
    - Check if both `ip4_dst` and `mac_addr` are valid; log a debug message and return if not.
    - Determine if the entry should be removed based on the neighbor state and message type.
    - If removing, call `fd_neigh4_hmap_remove` to remove the entry from the map.
    - If updating, prepare the map for update using `fd_neigh4_hmap_prepare`; log a warning and return if preparation fails.
    - Update the entry with the new state, IP address, and MAC address, then publish the changes using `fd_neigh4_hmap_publish`.
- **Output**: No return value; the function updates or removes entries in the neighbor table as a side effect.



---
Made with ❤️ by [Driver](https://www.driver.ai/)