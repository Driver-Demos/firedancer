<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a function for sending multiple DNS queries and handling responses over UDP and TCP.

# Purpose
The code is a C source file that implements a DNS query mechanism using both UDP and TCP protocols. It is designed to send multiple DNS queries to configured nameservers and handle their responses. The file includes functions to manage socket connections, send DNS queries, and process responses. The [`fd_res_msend_rc`](<#fd_res_msend_rc>) function is the main entry point, which takes multiple DNS queries and attempts to resolve them by sending requests to the specified nameservers. It handles both IPv4 and IPv6 addresses and can fall back to TCP if a response is truncated or if UDP fails.

The code uses several system calls and socket options to manage network communication, such as `socket`, `sendmsg`, `recvmsg`, and `setsockopt`. It also includes error handling for various network conditions, such as server failures and unsupported address families. The file defines internal helper functions like [`cleanup`](<#cleanup>), [`mtime`](<#mtime>), [`start_tcp`](<#start_tcp>), and [`step_mh`](<#step_mh>) to manage resources and adjust message headers. The code is intended to be part of a larger system, as indicated by the inclusion of custom headers like `syscall.h` and `fd_lookup.h`, and it does not define a public API or external interface.
# Imports and Dependencies

---
- `sys/socket.h`
- `netinet/in.h`
- `netinet/tcp.h`
- `netdb.h`
- `arpa/inet.h`
- `stdint.h`
- `string.h`
- `poll.h`
- `time.h`
- `unistd.h`
- `errno.h`
- `pthread.h`
- `syscall.h`
- `fd_lookup.h`
- `../../util/fd_util.h`


# Functions

---
### cleanup<!-- {{#callable:cleanup}} -->
[View Source →](<../../../../../src/waltz/resolv/fd_res_msend.c#L22>)

Closes all file descriptors in a given `pollfd` array that are open.
- **Inputs**:
    - `pfd`: A pointer to an array of `struct pollfd`, which contains file descriptors to be checked and potentially closed.
- **Logic and Control Flow**:
    - Iterates over the `pollfd` array until a file descriptor with a value less than -1 is encountered.
    - For each file descriptor that is greater than or equal to 0, calls the `syscall` function with `SYS_close` to close the file descriptor.
- **Output**: No return value, as the function is `void`.


---
### mtime<!-- {{#callable:mtime}} -->
[View Source →](<../../../../../src/waltz/resolv/fd_res_msend.c#L31>)

Calculates the current time in milliseconds since an unspecified starting point using either the monotonic or real-time clock.
- **Inputs**: None
- **Logic and Control Flow**:
    - Declare a `struct timespec` variable `ts` to store the time.
    - Call `clock_gettime` with `CLOCK_MONOTONIC` to get the monotonic time and store it in `ts`.
    - If `clock_gettime` returns an error and `errno` is `ENOSYS`, call `clock_gettime` with `CLOCK_REALTIME` to get the real-time clock instead.
    - Convert the seconds in `ts` to milliseconds and add the nanoseconds converted to milliseconds to get the total time in milliseconds.
    - Return the calculated time as an `ulong`.
- **Output**: Returns the current time in milliseconds as an `ulong`.


---
### start\_tcp<!-- {{#callable:start_tcp}} -->
[View Source →](<../../../../../src/waltz/resolv/fd_res_msend.c#L40>)

Initiates a non-blocking TCP connection with optional TCP Fast Open and sends a message.
- **Inputs**:
    - ``pfd``: A pointer to a `struct pollfd` that will store the file descriptor and event flags for the socket.
    - ``family``: The address family for the socket, typically `AF_INET` or `AF_INET6`.
    - ``sa``: A pointer to a socket address structure that specifies the address to connect to.
    - ``sl``: The length of the socket address structure pointed to by `sa`.
    - ``q``: A pointer to the data to be sent over the TCP connection.
    - ``ql``: The length of the data to be sent.
- **Logic and Control Flow**:
    - Initialize a `struct msghdr` with the socket address and data to send.
    - Create a non-blocking TCP socket with the specified address family and set it in `pfd`.
    - Set the socket option `TCP_FASTOPEN_CONNECT` to enable TCP Fast Open if possible.
    - Attempt to send the message using `sendmsg` with `MSG_FASTOPEN` and `MSG_NOSIGNAL` flags.
    - If the message is sent successfully, update `pfd->events` to `POLLIN` and return the number of bytes sent.
    - If the send operation is in progress, return 0.
    - If `sendmsg` fails, attempt a regular `connect` call to the socket address.
    - If `connect` succeeds or is in progress, return 0.
    - If all attempts fail, close the socket, set `pfd->fd` to -1, and return -1.
- **Output**: Returns the number of bytes sent if successful, 0 if the operation is in progress, or -1 if an error occurs.


---
### step\_mh<!-- {{#callable:step_mh}} -->
[View Source →](<../../../../../src/waltz/resolv/fd_res_msend.c#L75>)

Adjusts the `iovec` structures in a `msghdr` to skip the first `n` bytes.
- **Inputs**:
    - `mh`: A pointer to a `msghdr` structure that contains an array of `iovec` structures.
    - `n`: The number of bytes to skip in the `iovec` structures.
- **Logic and Control Flow**:
    - Check if `msg_iovlen` is non-zero and `n` is greater than or equal to the length of the current `iovec`.
    - Subtract the length of the current `iovec` from `n`, increment the `msg_iov` pointer, and decrement `msg_iovlen`.
    - Repeat the above step until `msg_iovlen` is zero or `n` is less than the length of the current `iovec`.
    - If `msg_iovlen` is zero, return from the function.
    - Adjust the `iov_base` pointer of the current `iovec` by adding `n` to it.
    - Subtract `n` from the `iov_len` of the current `iovec`.
- **Output**: The function does not return a value; it modifies the `msghdr` structure in place.


---
### fd\_res\_msend\_rc<!-- {{#callable:fd_res_msend_rc}} -->
[View Source →](<../../../../../src/waltz/resolv/fd_res_msend.c#L93>)

Sends multiple DNS queries to configured nameservers and processes their responses, handling both UDP and TCP protocols.
- **Inputs**:
    - `nqueries`: The number of DNS queries to send.
    - `queries`: An array of pointers to the DNS query data.
    - `qlens`: An array of lengths for each DNS query.
    - `answers`: An array of pointers where the DNS answers will be stored.
    - `alens`: An array where the lengths of the received answers will be stored.
    - `asize`: The maximum size of each answer buffer.
    - `conf`: A pointer to a `fd_resolvconf_t` structure containing the resolver configuration.
- **Logic and Control Flow**:
    - Initialize socket and address structures for communication with nameservers.
    - Iterate over the configured nameservers to set up their addresses.
    - Open a socket for UDP communication, handling IPv6 support if necessary.
    - Bind the socket to a local address and prepare for sending queries.
    - Enter a loop to send queries and wait for responses until a timeout occurs.
    - Send queries to all nameservers in parallel if no response is received within a retry interval.
    - Use `poll` to wait for responses or retry sending queries if necessary.
    - Process incoming responses, matching them to the original queries and storing the results.
    - Handle server failures by retrying queries and switch to TCP if responses are truncated.
    - Close sockets and clean up resources after processing all queries.
- **Output**: Returns 0 on success, with the `answers` and `alens` arrays filled with the received data and their lengths, or -1 on failure.
- **Functions Called**:
    - [`mtime`](<#mtime>)
    - [`start_tcp`](<#start_tcp>)
    - [`step_mh`](<#step_mh>)
    - [`cleanup`](<#cleanup>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)