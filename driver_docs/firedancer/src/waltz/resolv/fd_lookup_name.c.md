<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for resolving hostnames to addresses using various methods, including DNS and local hosts file.

# Purpose
The code is a C source file that implements a network address resolution system. It provides functionality to resolve hostnames into network addresses, supporting both IPv4 and IPv6 address families. The code includes several static functions that handle different aspects of name resolution, such as checking if a hostname is valid, resolving names from numeric addresses, local hosts files, and DNS queries. It also includes logic for handling DNS search domains and applying address selection policies based on RFC 3484/6724.

The file defines a public API function [`fd_lookup_name`](<#fd_lookup_name>), which is responsible for orchestrating the resolution process. This function attempts to resolve a given hostname into a list of network addresses, considering various flags and options such as passive address resolution and IPv4-mapped IPv6 addresses. The code uses several utility functions and structures, such as `fd_resolvconf_t` for DNS configuration and `struct address` for storing resolved addresses. The file also includes logic for sorting and filtering the resolved addresses based on predefined policies and criteria, ensuring that the most appropriate addresses are selected for use.
# Imports and Dependencies

---
- `sys/socket.h`
- `netinet/in.h`
- `fd_netdb.h`
- `net/if.h`
- `arpa/inet.h`
- `ctype.h`
- `stdlib.h`
- `string.h`
- `fcntl.h`
- `unistd.h`
- `pthread.h`
- `errno.h`
- `fd_resolv.h`
- `fd_lookup.h`
- `fd_io_readline.h`
- `../../util/cstr/fd_cstr.h`
- `../../util/log/fd_log.h`
- `../../util/io/fd_io.h`
- `../../util/net/fd_ip6.h`


# Global Variables

---
### defpolicy
- **Type**: ``struct policy[]``
- **Description**: Defines an array of `struct policy` that contains IPv6 address policies. Each policy includes an address, length, mask, precedence, and label.
- **Use**: Used to determine the policy for IPv6 addresses based on predefined rules.


# Data Structures

---
### dpc\_ctx
- **Type**: ``struct``
- **Members**:
    - ``addrs``: Pointer to an array of `struct address` that stores address information.
    - ``canon``: Pointer to a character array that stores the canonical name.
    - ``cnt``: Integer that represents the count of addresses.
    - ``rrtype``: Integer that specifies the resource record type.
- **Description**: Stores context information for DNS processing, including address data, canonical name, address count, and resource record type.


---
### policy
- **Type**: ``struct``
- **Members**:
    - ``addr``: An array of 16 unsigned characters representing an IPv6 address.
    - ``len``: An unsigned character indicating the length of the address prefix.
    - ``mask``: An unsigned character used as a mask for address comparison.
    - ``prec``: An unsigned character representing the precedence of the policy.
    - ``label``: An unsigned character used to label the policy for address selection.
- **Description**: Defines a policy structure used for IPv6 address selection, containing fields for address, prefix length, mask, precedence, and label. The `defpolicy` array holds default policies for address selection, which are used to determine the best address to use based on the given criteria.


# Functions

---
### is\_valid\_hostname<!-- {{#callable:is_valid_hostname}} -->
[View Source →](<../../../../../src/waltz/resolv/fd_lookup_name.c#L21>)

Checks if a given hostname is valid according to specific character rules and length constraints.
- **Inputs**:
    - `host`: A constant character pointer to the hostname string to validate.
- **Logic and Control Flow**:
    - Declare a pointer `s` of type `uchar` to iterate over the `host` string.
    - Check if the length of `host` is greater than 254 characters using `strnlen`; if true, return 0 indicating invalid hostname.
    - Iterate over each character in `host` using `s`.
    - In the loop, check if the character is a valid ASCII character (less than 0x80), a period ('.'), a hyphen ('-'), or an alphanumeric character using `fd_isalnum`.
    - If a character does not meet these conditions, exit the loop.
    - Return 1 if the end of the string is reached (indicating a valid hostname), otherwise return 0.
- **Output**: Returns an integer: 1 if the hostname is valid, 0 if it is not.


---
### name\_from\_null<!-- {{#callable:name_from_null}} -->
[View Source →](<../../../../../src/waltz/resolv/fd_lookup_name.c#L29>)

Generates a list of default addresses based on the provided family and flags when the name is null.
- **Inputs**:
    - `buf`: An array of `struct address` with a minimum size of 2 to store the generated addresses.
    - `name`: A constant character pointer representing the name, which should be null for this function to proceed.
    - `family`: An integer representing the address family, such as `AF_INET` or `AF_INET6`.
    - `flags`: An integer representing flags that modify the behavior, such as `FD_AI_PASSIVE`.
- **Logic and Control Flow**:
    - Initialize `cnt` to 0 to count the number of addresses added to `buf`.
    - Check if `name` is not null; if true, return 0 immediately.
    - Check if `flags` has `FD_AI_PASSIVE` set.
    - If `FD_AI_PASSIVE` is set, check if `family` is not `AF_INET6`; if true, add an `AF_INET` address to `buf` and increment `cnt`.
    - If `family` is not `AF_INET`, add an `AF_INET6` address to `buf` and increment `cnt`.
    - If `FD_AI_PASSIVE` is not set, check if `family` is not `AF_INET6`; if true, add a loopback `AF_INET` address to `buf` and increment `cnt`.
    - If `family` is not `AF_INET`, add a loopback `AF_INET6` address to `buf` and increment `cnt`.
    - Return the value of `cnt`, indicating the number of addresses added to `buf`.
- **Output**: Returns an integer representing the number of addresses added to `buf`.


---
### name\_from\_numeric<!-- {{#callable:name_from_numeric}} -->
[View Source →](<../../../../../src/waltz/resolv/fd_lookup_name.c#L50>)

Calls [`fd_lookup_ipliteral`](<fd_lookup_ipliteral.c.md#fd_lookup_ipliteral>) to resolve a numeric IP address into a `struct address`.
- **Inputs**:
    - `buf`: A pointer to a `struct address` array where the resolved address will be stored.
    - `name`: A constant character pointer representing the numeric IP address to resolve.
    - `family`: An integer representing the address family (e.g., `AF_INET` or `AF_INET6`).
- **Logic and Control Flow**:
    - Calls the [`fd_lookup_ipliteral`](<fd_lookup_ipliteral.c.md#fd_lookup_ipliteral>) function with `buf`, `name`, and `family` as arguments.
    - Returns the result of the [`fd_lookup_ipliteral`](<fd_lookup_ipliteral.c.md#fd_lookup_ipliteral>) function call.
- **Output**: Returns an integer result from the [`fd_lookup_ipliteral`](<fd_lookup_ipliteral.c.md#fd_lookup_ipliteral>) function, indicating success or failure of the address resolution.
- **Functions Called**:
    - [`fd_lookup_ipliteral`](<fd_lookup_ipliteral.c.md#fd_lookup_ipliteral>)


---
### name\_from\_hosts<!-- {{#callable:name_from_hosts}} -->
[View Source →](<../../../../../src/waltz/resolv/fd_lookup_name.c#L57>)

Retrieves IP addresses and a canonical name for a given hostname from the `/etc/hosts` file.
- **Inputs**:
    - `buf`: An array of `struct address` to store the resolved IP addresses, with a size of at least `MAXADDRS`.
    - `canon`: A character array to store the canonical name of the host, with a size of at least 256.
    - `name`: A constant character pointer representing the hostname to resolve.
    - `family`: An integer representing the address family (e.g., `AF_INET` for IPv4, `AF_INET6` for IPv6).
- **Logic and Control Flow**:
    - Calculate the length of the `name` and initialize counters and flags.
    - Check if the file descriptor `fd_etc_hosts_fd` is valid; return 0 if not.
    - Attempt to seek to the start of the `/etc/hosts` file; log an error if it fails.
    - Initialize a buffered input stream for reading the `/etc/hosts` file.
    - Iterate over each line in the file until `MAXADDRS` addresses are found or the end of the file is reached.
    - For each line, remove comments and search for the `name` in the line, ensuring it is a standalone word.
    - If the `name` is found, isolate the IP address and attempt to parse it using [`name_from_numeric`](<#name_from_numeric>).
    - If parsing is successful, increment the address count; otherwise, set `badfam` if the family is unsupported.
    - If a canonical name has not been set, extract the first valid hostname from the line and set it as the canonical name.
    - Return the count of addresses found, or `badfam` if no addresses were found but an unsupported family was encountered.
- **Output**: Returns the number of addresses found, or an error code if no addresses are found and an unsupported family is encountered.
- **Functions Called**:
    - [`fd_io_fgets`](<fd_io_readline.c.md#fd_io_fgets>)
    - [`name_from_numeric`](<#name_from_numeric>)
    - [`is_valid_hostname`](<#is_valid_hostname>)


---
### dns\_parse\_callback<!-- {{#callable:dns_parse_callback}} -->
[View Source →](<../../../../../src/waltz/resolv/fd_lookup_name.c#L128>)

Parses DNS resource records and updates the context with canonical names or IP addresses.
- **Inputs**:
    - `c`: A pointer to a `struct dpc_ctx` which holds the context for DNS parsing.
    - `rr`: An integer representing the resource record type (e.g., `RR_CNAME`, `RR_A`, `RR_AAAA`).
    - `data`: A pointer to the data of the resource record.
    - `len`: An integer representing the length of the data.
    - `packet`: A pointer to the DNS packet containing the resource record.
    - `plen`: An integer representing the length of the DNS packet.
- **Logic and Control Flow**:
    - Initialize a temporary buffer `tmp` and set `family` to `AF_UNSPEC`.
    - Cast the input `c` to a `struct dpc_ctx` pointer `ctx`.
    - Check if the resource record type `rr` is `RR_CNAME`.
    - If `rr` is `RR_CNAME`, expand the domain name from the packet and validate it as a hostname.
    - If the hostname is valid, copy it to `ctx->canon` and return 0.
    - Check if the count of addresses in `ctx` has reached `MAXADDRS`; if so, return 0.
    - Check if `rr` matches `ctx->rrtype`; if not, return 0.
    - Use a switch statement to handle `RR_A` and `RR_AAAA` record types, setting `family` to `AF_INET` or `AF_INET6` respectively.
    - If the length of the data does not match the expected length for the record type, return -1.
    - Update the `ctx->addrs` array with the family and address data, incrementing the count.
    - Return 0 to indicate successful processing.
- **Output**: Returns 0 on successful parsing and updating of the context, or -1 if there is an error with the data length.
- **Functions Called**:
    - [`fd_dn_expand`](<fd_dn_expand.c.md#fd_dn_expand>)
    - [`is_valid_hostname`](<#is_valid_hostname>)


---
### name\_from\_dns<!-- {{#callable:name_from_dns}} -->
[View Source →](<../../../../../src/waltz/resolv/fd_lookup_name.c#L162>)

Resolves a hostname to its corresponding IP addresses using DNS queries.
- **Inputs**:
    - `buf`: An array of `struct address` to store the resolved IP addresses.
    - `canon`: A character array to store the canonical name of the host.
    - `name`: A constant character pointer representing the hostname to resolve.
    - `family`: An integer specifying the address family (e.g., `AF_INET` or `AF_INET6`).
    - `conf`: A constant pointer to `fd_resolvconf_t` containing DNS resolver configuration.
- **Logic and Control Flow**:
    - Initialize query and answer buffers for DNS queries.
    - Iterate over possible address families (IPv4 and IPv6) and prepare DNS queries for each, unless the specified family matches.
    - Send the prepared DNS queries using [`fd_res_msend_rc`](<fd_res_msend.c.md#fd_res_msend_rc>) and check for errors.
    - Process the DNS responses: if the response is truncated or indicates a server failure, return specific error codes.
    - Parse the DNS response using [`fd_dns_parse`](<fd_dns_parse.c.md#fd_dns_parse>) and a callback function to extract IP addresses and canonical names.
    - Return the number of addresses found or a specific error code if no data is found.
- **Output**: Returns the number of addresses found or a negative error code if the resolution fails.
- **Functions Called**:
    - [`fd_res_mkquery`](<fd_res_mkquery.c.md#fd_res_mkquery>)
    - [`fd_res_msend_rc`](<fd_res_msend.c.md#fd_res_msend_rc>)
    - [`fd_dns_parse`](<fd_dns_parse.c.md#fd_dns_parse>)


---
### name\_from\_dns\_search<!-- {{#callable:name_from_dns_search}} -->
[View Source →](<../../../../../src/waltz/resolv/fd_lookup_name.c#L213>)

Resolves a domain name to an IP address using DNS search and appends a search domain if necessary.
- **Inputs**:
    - `buf`: An array of `struct address` to store the resolved addresses, with a minimum size of `MAXADDRS`.
    - `canon`: A character array to store the canonical name of the resolved address, with a minimum size of 256.
    - `name`: A constant character pointer representing the domain name to resolve.
    - `family`: An integer representing the address family (e.g., `AF_INET` for IPv4, `AF_INET6` for IPv6).
- **Logic and Control Flow**:
    - Calls [`fd_get_resolv_conf`](<fd_resolvconf.c.md#fd_get_resolv_conf>) to retrieve the DNS resolver configuration; returns -1 if it fails.
    - Counts the number of dots in `name` to determine if a search domain should be appended.
    - Strips the final dot from `name` if present and checks for multiple trailing dots; returns `FD_EAI_NONAME` if invalid.
    - Copies `name` to `canon` and appends a dot to prepare for DNS resolution.
    - Calls [`name_from_dns`](<#name_from_dns>) to perform the DNS resolution with the prepared `canon` and `conf`.
- **Output**: Returns the result of [`name_from_dns`](<#name_from_dns>), which is the number of addresses found or an error code.
- **Functions Called**:
    - [`fd_get_resolv_conf`](<fd_resolvconf.c.md#fd_get_resolv_conf>)
    - [`name_from_dns`](<#name_from_dns>)


---
### policyof<!-- {{#callable:policyof}} -->
[View Source →](<../../../../../src/waltz/resolv/fd_lookup_name.c#L269>)

Finds and returns a pointer to the policy that matches a given IPv6 address from a predefined list of policies.
- **Inputs**:
    - `a`: A pointer to a `struct in6_addr` representing the IPv6 address to match against the policy list.
- **Logic and Control Flow**:
    - Iterates over the `defpolicy` array indefinitely.
    - Compares the address in `a` with the `addr` field of each policy using `memcmp` for the length specified by `len`.
    - If the addresses do not match, continues to the next iteration.
    - Checks if the masked byte of the address in `a` matches the corresponding byte in the policy's `addr` field.
    - If the masked byte does not match, continues to the next iteration.
    - Returns a pointer to the matching policy when both checks pass.
- **Output**: A pointer to a `struct policy` that matches the given IPv6 address.


---
### labelof<!-- {{#callable:labelof}} -->
[View Source →](<../../../../../src/waltz/resolv/fd_lookup_name.c#L281>)

Retrieves the label from the policy associated with a given IPv6 address.
- **Inputs**:
    - `a`: A pointer to a `struct in6_addr` representing an IPv6 address.
- **Logic and Control Flow**:
    - Calls the [`policyof`](<#policyof>) function with the given IPv6 address `a` to retrieve the associated policy.
    - Accesses the `label` field of the returned policy structure.
    - Returns the value of the `label` field.
- **Output**: An integer representing the label of the policy associated with the given IPv6 address.
- **Functions Called**:
    - [`policyof`](<#policyof>)


---
### scopeof<!-- {{#callable:scopeof}} -->
[View Source →](<../../../../../src/waltz/resolv/fd_lookup_name.c#L286>)

Determines the scope of an IPv6 address based on its type.
- **Inputs**:
    - `a`: A pointer to a `struct in6_addr` representing the IPv6 address to evaluate.
- **Logic and Control Flow**:
    - Check if the address is multicast using `IN6_IS_ADDR_MULTICAST`; if true, return the value of the second byte of the address bitwise ANDed with 15.
    - Check if the address is link-local using `IN6_IS_ADDR_LINKLOCAL`; if true, return 2.
    - Check if the address is loopback using `IN6_IS_ADDR_LOOPBACK`; if true, return 2.
    - Check if the address is site-local using `IN6_IS_ADDR_SITELOCAL`; if true, return 5.
    - If none of the above conditions are met, return 14.
- **Output**: An integer representing the scope of the IPv6 address.


---
### prefixmatch<!-- {{#callable:prefixmatch}} -->
[View Source →](<../../../../../src/waltz/resolv/fd_lookup_name.c#L295>)

Calculates the length of the common prefix between two IPv6 addresses.
- **Inputs**:
    - `s`: Pointer to the source IPv6 address structure (`struct in6_addr`).
    - `d`: Pointer to the destination IPv6 address structure (`struct in6_addr`).
- **Logic and Control Flow**:
    - Initialize a variable `i` to zero to track the prefix length.
    - Iterate over each bit position up to 128 (the length of an IPv6 address in bits).
    - For each bit position, calculate the byte index and bit mask to compare the corresponding bits of the source and destination addresses.
    - Use XOR to compare the bits of the source and destination addresses; if they differ, break the loop.
    - If the bits are the same, increment `i` to extend the common prefix length.
    - Return the value of `i` as the length of the common prefix.
- **Output**: Returns an integer representing the length of the common prefix between the two IPv6 addresses.


---
### addrcmp<!-- {{#callable:addrcmp}} -->
[View Source →](<../../../../../src/waltz/resolv/fd_lookup_name.c#L315>)

Compares two `struct address` objects based on their `sortkey` values.
- **Inputs**:
    - `_a`: Pointer to the first `struct address` object to compare.
    - `_b`: Pointer to the second `struct address` object to compare.
- **Logic and Control Flow**:
    - Cast the input pointers `_a` and `_b` to pointers of type `struct address`.
    - Access the `sortkey` field of both `struct address` objects.
    - Subtract the `sortkey` of the first address from the `sortkey` of the second address.
- **Output**: Returns an integer that is the difference between the `sortkey` of the second address and the `sortkey` of the first address.


---
### fd\_lookup\_name<!-- {{#callable:fd_lookup_name}} -->
[View Source →](<../../../../../src/waltz/resolv/fd_lookup_name.c#L322>)

Resolves a hostname to a list of network addresses, applying various filters and transformations based on input flags and family.
- **Inputs**:
    - `buf`: An array of `struct address` to store the resolved addresses, with a size of at least `MAXADDRS`.
    - `canon`: A character array of size 256 to store the canonical name of the host.
    - `name`: A constant character pointer to the hostname to resolve.
    - `family`: An integer specifying the address family (e.g., `AF_INET`, `AF_INET6`, or `AF_UNSPEC`).
    - `flags`: An integer representing flags that modify the lookup behavior, such as `FD_AI_V4MAPPED` or `FD_AI_NUMERICHOST`.
- **Logic and Control Flow**:
    - Initialize `cnt` to 0 and set the first character of `canon` to 0.
    - If `name` is not null, check its length and copy it to `canon` if valid.
    - If `FD_AI_V4MAPPED` flag is set and `family` is `AF_INET6`, change `family` to `AF_UNSPEC`.
    - Attempt to resolve the name using various backends ([`name_from_null`](<#name_from_null>), [`name_from_numeric`](<#name_from_numeric>), [`name_from_hosts`](<#name_from_hosts>), [`name_from_dns_search`](<#name_from_dns_search>)) until at least one result is found.
    - If `FD_AI_V4MAPPED` flag is set, filter and transform results to handle IPv4-mapped IPv6 addresses.
    - If there are fewer than 2 results or only IPv4 results, return `cnt`.
    - For more than one result, generate a sort key for each address based on a subset of RFC 3484/6724 rules and sort the addresses.
    - Return the count of resolved addresses.
- **Output**: Returns the number of resolved addresses stored in `buf`, or an error code if no addresses are found.
- **Functions Called**:
    - [`name_from_null`](<#name_from_null>)
    - [`name_from_numeric`](<#name_from_numeric>)
    - [`name_from_hosts`](<#name_from_hosts>)
    - [`name_from_dns_search`](<#name_from_dns_search>)
    - [`policyof`](<#policyof>)
    - [`scopeof`](<#scopeof>)
    - [`labelof`](<#labelof>)
    - [`prefixmatch`](<#prefixmatch>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)