<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Header file for DNS resolution functions and data structures, including address and resolver configurations.

# Purpose
This C header file defines data structures and function prototypes for DNS resolution and network address handling. It includes necessary headers and declares structures such as `aibuf` and `address` to store address information and configuration details. The `fd_resolvconf` structure holds DNS resolver configuration, including name server addresses and timeout settings. The file defines several function prototypes with hidden visibility attributes, such as [`fd_lookup_name`](<#fd_lookup_name>), [`fd_lookup_ipliteral`](<#fd_lookup_ipliteral>), and [`fd_get_resolv_conf`](<#fd_get_resolv_conf>), which are used for name resolution and configuration retrieval. Additionally, it declares external thread-local variables `fd_etc_hosts_fd` and `fd_etc_resolv_conf_fd` for handling pre-opened file descriptors related to hosts and resolver configuration files.
# Imports and Dependencies

---
- `stdint.h`
- `stddef.h`
- `features.h`
- `netinet/in.h`
- `fd_netdb.h`


# Global Variables

---
### fd\_etc\_hosts\_fd
- **Type**: ``int``
- **Description**: A global variable that represents a file descriptor for the '/etc/hosts' file. It is declared with the `FD_TL` storage class specifier, which suggests it is thread-local.
- **Use**: Used to access the '/etc/hosts' file for reading or writing operations.


---
### fd\_etc\_resolv\_conf\_fd
- **Type**: ``int``
- **Description**: A global variable that represents a file descriptor for the `/etc/resolv.conf` file. This file typically contains DNS configuration settings for the system.
- **Use**: Used to access or manipulate the `/etc/resolv.conf` file within the program.


# Data Structures

---
### aibuf
- **Type**: ``struct``
- **Members**:
    - ``ai``: Holds address information using the `fd_addrinfo_t` type.
    - ``sa``: A union that can store either an IPv4 or IPv6 socket address.
    - ``slot``: A short integer used for indexing or identification purposes.
    - ``ref``: A short integer used as a reference counter or identifier.
- **Description**: Stores network address information and related metadata, including address information (`ai`), a union for socket addresses (`sa`), and short integers for slot and reference tracking (`slot` and `ref`).


---
### sa
- **Type**: `union`
- **Members**:
    - `sin`: A member of type `struct sockaddr_in` for IPv4 addresses.
    - `sin6`: A member of type `struct sockaddr_in6` for IPv6 addresses.
- **Description**: The `sa` union can store either an IPv4 address using `struct sockaddr_in` or an IPv6 address using `struct sockaddr_in6`, allowing flexible handling of network addresses.


---
### address
- **Type**: ``struct``
- **Members**:
    - `family`: Specifies the address family, such as `AF_INET` for IPv4 or `AF_INET6` for IPv6.
    - `scopeid`: Holds the scope identifier for the address, used in IPv6.
    - `addr`: Stores the address in a 16-byte array, accommodating both IPv4 and IPv6 addresses.
    - `sortkey`: Used to sort addresses, possibly based on preference or priority.
- **Description**: Defines an address structure that holds information about a network address, including its family, scope, and the address itself, which can be either IPv4 or IPv6.


---
### fd\_resolvconf
- **Type**: ``struct``
- **Members**:
    - ``ns``: An array of `struct address` with a maximum size of `MAXNS` to store nameserver addresses.
    - ``nns``: An unsigned integer representing the number of nameservers.
    - ``attempts``: An unsigned integer indicating the number of attempts to resolve a query.
    - ``ndots``: An unsigned integer specifying the minimum number of dots in a domain name to trigger a search.
    - ``timeout``: An unsigned integer defining the timeout duration for a query.
- **Description**: Stores configuration settings for DNS resolution, including nameserver addresses, the number of nameservers, query attempts, domain name dot threshold, and query timeout.


---
### fd\_resolvconf\_t
- **Type**: ``struct fd_resolvconf``
- **Members**:
    - ``ns``: An array of `struct address` representing the name servers.
    - ``nns``: The number of name servers in the `ns` array.
    - ``attempts``: The number of attempts to resolve a name.
    - ``ndots``: The number of dots in a name before an initial absolute query.
    - ``timeout``: The timeout duration for a name resolution attempt.
- **Description**: Defines the configuration for DNS resolution, including name servers, the number of resolution attempts, the number of dots in a domain name before considering it absolute, and the timeout for resolution attempts.


# Function Declarations (Public API)

---
### fd\_lookup\_name<!-- {{#callable_declaration:fd_lookup_name}} -->
[View Source →](<../../../../../src/waltz/resolv/fd_lookup.h#L42>)

Resolves a hostname to a list of network addresses.
- **Description**: Use this function to resolve a given hostname into a list of network addresses, which can include both IPv4 and IPv6 addresses. The function populates the provided buffer with address information and returns the number of addresses found. It can handle special flags for IPv4-mapped IPv6 addresses and can perform DNS lookups if necessary. Ensure that the `name` parameter is not null and does not exceed 254 characters. The function must be called with a valid buffer capable of holding up to `MAXADDRS` addresses. It returns an error code if the name is invalid or if no addresses are found.
- **Inputs**:
    - `buf`: An array of `struct address` with a size of at least `MAXADDRS`. The function populates this buffer with the resolved addresses. The caller must ensure the buffer is valid and has sufficient space.
    - `canon`: A character array with a size of at least 256. The function writes the canonical name of the host into this buffer. The caller must ensure the buffer is valid and has sufficient space.
    - `name`: A null-terminated string representing the hostname to resolve. It must not be null and should not exceed 254 characters in length. If the name is invalid, the function returns an error code.
    - `family`: An integer specifying the address family to use for the lookup. It can be `AF_INET` for IPv4, `AF_INET6` for IPv6, or `AF_UNSPEC` for unspecified.
    - `flags`: An integer representing flags that modify the lookup behavior. It can include `FD_AI_V4MAPPED` to request IPv4-mapped IPv6 addresses and other flags that affect the resolution process.
- **Output**: Returns the number of addresses found and stored in `buf`. If no addresses are found or if an error occurs, it returns an error code such as `FD_EAI_NONAME`.
- **See Also**: [`fd_lookup_name`](<fd_lookup_name.c.md#fd_lookup_name>)  (Implementation)


---
### fd\_lookup\_ipliteral<!-- {{#callable_declaration:fd_lookup_ipliteral}} -->
[View Source →](<../../../../../src/waltz/resolv/fd_lookup.h#L49>)

Converts an IP address literal to a structured address format.
- **Description**: Use this function to convert a string representation of an IP address into a structured `address` format. It supports both IPv4 and IPv6 addresses. The function requires a valid IP address string and a specified address family. If the address family does not match the IP version of the input string, the function returns an error code. The function writes the converted address into the provided buffer. Ensure that the buffer is not null and has space for at least one `address` structure. The function returns specific error codes for invalid input or mismatched address families.
- **Inputs**:
    - `buf`: A pointer to an array of at least one `address` structure where the function will store the converted address. Must not be null.
    - `name`: A null-terminated string representing the IP address to convert. Must be a valid IPv4 or IPv6 address.
    - `family`: An integer specifying the address family, either `AF_INET` for IPv4 or `AF_INET6` for IPv6. The function returns an error if this does not match the IP version of `name`.
- **Output**: Returns 1 on success, 0 if the IP address is invalid, or a negative error code if the address family is incorrect or other errors occur.
- **See Also**: [`fd_lookup_ipliteral`](<fd_lookup_ipliteral.c.md#fd_lookup_ipliteral>)  (Implementation)


---
### fd\_get\_resolv\_conf<!-- {{#callable_declaration:fd_get_resolv_conf}} -->
[View Source →](<../../../../../src/waltz/resolv/fd_lookup.h#L54>)

Reads DNS resolver configuration from a file.
- **Description**: Use this function to populate a `fd_resolvconf_t` structure with DNS resolver settings from a configuration file. It reads the number of name servers, the number of attempts, the timeout, and the ndots option. If the configuration file is not available or no name servers are specified, it defaults to using the local host as the name server. This function must be called with a valid `fd_resolvconf_t` pointer, and it assumes that the file descriptor `fd_etc_resolv_conf_fd` is set to the correct file. The function does not return error codes but initializes the configuration with default values if the file cannot be read.
- **Inputs**:
    - `conf`: A pointer to a `fd_resolvconf_t` structure that will be populated with the DNS resolver configuration. Must not be null. The caller retains ownership of the structure.
- **Output**: Returns 0 after populating the `fd_resolvconf_t` structure with the configuration data or default values.
- **See Also**: [`fd_get_resolv_conf`](<fd_resolvconf.c.md#fd_get_resolv_conf>)  (Implementation)


---
### fd\_res\_msend\_rc<!-- {{#callable_declaration:fd_res_msend_rc}} -->
[View Source →](<../../../../../src/waltz/resolv/fd_lookup.h#L57>)

Sends multiple DNS queries and receives their responses.
- **Description**: Use this function to send multiple DNS queries in parallel and receive their responses. It requires a configuration structure that specifies the DNS servers to query and other parameters like timeout and retry attempts. The function sends queries to the specified DNS servers and waits for responses. It handles both IPv4 and IPv6 addresses and can retry queries in case of server failures. The function must be called with valid query data and buffer sizes to store the responses. It returns 0 on success, indicating that all queries have been processed, or -1 if an error occurs during socket operations.
- **Inputs**:
    - `nqueries`: The number of DNS queries to send. Must be a positive integer.
    - `queries`: An array of pointers to the DNS query data. Each query must be a valid DNS query packet. The caller retains ownership of the data.
    - `qlens`: An array of integers specifying the length of each query in the 'queries' array. Each length must correspond to the respective query.
    - `answers`: An array of pointers to buffers where the function will store the DNS responses. Each buffer must be large enough to hold the response data. The caller retains ownership of the buffers.
    - `alens`: An array of integers where the function will store the length of each response. The array must have space for 'nqueries' integers.
    - `asize`: The size of each buffer in the 'answers' array. Must be large enough to store the expected DNS response.
    - `conf`: A pointer to a 'fd_resolvconf_t' structure containing the DNS server configuration and other parameters. Must not be null.
- **Output**: Returns 0 on success, or -1 if an error occurs during socket operations. The 'alens' array is updated with the length of each response, or zero if no response is received.
- **See Also**: [`fd_res_msend_rc`](<fd_res_msend.c.md#fd_res_msend_rc>)  (Implementation)


---
### fd\_dns\_parse<!-- {{#callable_declaration:fd_dns_parse}} -->
[View Source →](<../../../../../src/waltz/resolv/fd_lookup.h#L66>)

Parses a DNS response and invokes a callback for each answer.
- **Description**: Use this function to parse a DNS response message and process each answer section through a callback function. The function expects a valid DNS response message in the form of a byte array. It checks for a minimum length and a valid response code before parsing. The callback function is called for each answer, and if it returns a negative value, the parsing stops and the function returns an error. This function is useful when you need to handle DNS responses and process each answer individually.
- **Inputs**:
    - `r`: Pointer to a byte array containing the DNS response message. Must not be null and must have a length of at least 12 bytes.
    - `rlen`: Length of the DNS response message in bytes. Must be at least 12.
    - `callback`: Function pointer to a callback that processes each DNS answer. The callback receives a context pointer, type, data pointer, data length, the original DNS response, and its length. Must not be null.
    - `ctx`: Pointer to user-defined data passed to the callback function. Can be null if the callback does not require context.
- **Output**: Returns 0 on success, -1 on error, or 0 if the response code indicates an error.
- **See Also**: [`fd_dns_parse`](<fd_dns_parse.c.md#fd_dns_parse>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)