<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Creates a DNS query message in a buffer with specified operation, domain name, class, and type.

# Purpose
The code defines a function [`fd_res_mkquery`](<#fd_res_mkquery>) that constructs a DNS query message. This function takes several parameters: `op` (operation code), `dname` (domain name), `class`, `type`, `buf` (buffer to store the query), and `buflen` (length of the buffer). The function checks the validity of the input parameters, such as ensuring the domain name length does not exceed 253 characters and that the buffer is large enough to hold the query. It then constructs a query template, setting specific fields like the operation code and class/type of the DNS query. The function also generates a unique identifier for the query using a hash of the current tick count, which is obtained from the `fd_tickcount` function.

The code includes headers for DNS resolution and logging utilities, and it uses several compiler directives to ignore specific warnings. The function is designed to be part of a larger system that handles DNS queries, and it is likely intended to be used by other components that require DNS query construction. The function returns the length of the constructed query or `-1` if an error occurs during the construction process.
# Imports and Dependencies

---
- `fd_resolv.h`
- `../../util/log/fd_log.h`
- `string.h`


# Functions

---
### fd\_res\_mkquery<!-- {{#callable:fd_res_mkquery}} -->
[View Source →](<../../../../../src/waltz/resolv/fd_res_mkquery.c#L9>)

Creates a DNS query message and stores it in a buffer.
- **Inputs**:
    - `op`: An integer representing the operation code for the DNS query.
    - `dname`: A constant character pointer to the domain name for the DNS query.
    - `class`: An integer representing the class of the DNS query.
    - `type`: An integer representing the type of the DNS query.
    - `buf`: A pointer to an unsigned character buffer where the query will be stored.
    - `buflen`: An integer representing the length of the buffer.
- **Logic and Control Flow**:
    - Calculate the length of the domain name `dname` using `strnlen` with a maximum of 255 characters.
    - If the domain name ends with a period, decrement the length by one; if it still ends with a period, return -1.
    - Calculate the total length `n` of the query message.
    - Check if the domain name length is greater than 253, the buffer length is less than `n`, or if `op`, `class`, or `type` exceed their limits; if any condition is true, return -1.
    - Initialize a query template `q` with zeros and set specific fields for operation, flags, and question count.
    - Copy the domain name into the query template starting at position 13.
    - Iterate over the domain name to replace dots with length-prefixed labels; if a label exceeds 62 characters, return -1.
    - Set the type and class fields in the query template.
    - Generate a pseudo-random ID using `fd_ulong_hash` and `fd_tickcount`, and store it in the first two bytes of the query template.
    - Copy the constructed query template into the provided buffer `buf`.
    - Return the length `n` of the constructed query message.
- **Output**: Returns the length of the constructed DNS query message, or -1 if an error occurs.



---
Made with ❤️ by [Driver](https://www.driver.ai/)