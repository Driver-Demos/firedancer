<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines data structures and functions for managing QUIC streams, including buffers and linked lists.

# Purpose
The code is a C header file that defines structures and functions for managing QUIC streams within a QUIC connection. It provides the necessary data structures and operations to handle the lifecycle and data flow of QUIC streams, which are essential components in the QUIC protocol for data transmission. The file includes definitions for `fd_quic_stream_t`, which represents a QUIC stream, and `fd_quic_buffer_t`, a circular buffer used for managing data transmission within a stream. The header also defines macros for managing stream states and actions, such as checking if a stream requires action or is in a particular state.

The file provides several functions for stream management, including creating and deleting streams, storing and loading data in the circular buffer, and setting or retrieving user-defined contexts associated with streams. It also includes macros for managing linked lists of streams, which are used to organize and manipulate streams efficiently. The header file is intended to be included in other C source files that implement or utilize QUIC protocol functionality, providing a public API for stream management in a QUIC connection.
# Imports and Dependencies

---
- `fd_quic_common.h`
- `../../util/fd_util.h`


# Data Structures

---
### fd\_quic\_conn\_t
- **Type**: ``fd_quic_conn_t``
- **Description**: `fd_quic_conn_t` is a forward declaration of a data structure that represents a QUIC connection. The actual definition of this structure is not provided in the given code, indicating that it is likely defined elsewhere. This structure is used as a reference in other structures, such as `fd_quic_stream`, to associate streams with their respective connections.


---
### fd\_quic\_stream\_t
- **Type**: ``struct``
- **Members**:
    - ``conn``: Pointer to the associated QUIC connection.
    - ``stream_id``: Identifier for the stream; all 1's indicates an unused stream.
    - ``context``: User-defined context for callbacks.
    - ``tx_buf``: Transmit buffer for the stream.
    - ``tx_ack``: Acknowledgment bits for each byte in the transmit buffer.
    - ``tx_sent``: Offset of the first unsent byte in the transmit buffer.
    - ``stream_flags``: Flags indicating actions required for the stream.
    - ``sentinel``: Indicates if the stream is a sentinel.
    - ``state``: Current state of the stream, represented by a mask.
    - ``list_memb``: Membership status in a list.
    - ``tx_max_stream_data``: Maximum number of bytes allowed to send to the peer.
    - ``tx_tot_data``: Total number of bytes transmitted on the stream.
    - ``rx_tot_data``: Total number of bytes received on the stream.
    - ``upd_pkt_number``: Packet number for the last transmitted packet with a stream frame.
    - ``next``: Pointer to the next stream in a doubly linked list.
    - ``prev``: Pointer to the previous stream in a doubly linked list.
- **Description**: Represents a QUIC stream, managing data transmission and reception, flow control, and state tracking within a QUIC connection. It includes a transmit buffer, acknowledgment tracking, and state flags to manage the stream's lifecycle and actions. The structure also supports linked list operations for stream management and includes user-defined context for callback operations.


---
### fd\_quic\_stream\_map\_t
- **Type**: ``struct``
- **Members**:
    - ``stream_id``: The key for the stream map.
    - ``hash``: The hash value for the stream map entry.
    - ``stream``: The value associated with the key, pointing to a `fd_quic_stream_t`.
- **Description**: Maps a stream ID to its corresponding stream object in a QUIC connection, using a hash for efficient lookup.


---
### fd\_quic\_buffer
- **Type**: ``struct``
- **Members**:
    - ``buf``: Pointer to the buffer data.
    - ``cap``: Capacity of the buffer, which must be a power of two.
    - ``head``: Offset to the first unused byte in the buffer.
    - ``tail``: Offset to the first byte of the used range in the buffer.
- **Description**: Defines a circular buffer structure used in QUIC streams, where `buf` is the data storage, `cap` ensures the buffer's capacity is a power of two, and `head` and `tail` manage the buffer's data usage and availability.


---
### fd\_quic\_buffer\_t
- **Type**: ``struct``
- **Members**:
    - ``buf``: Pointer to the buffer memory.
    - ``cap``: Capacity of the buffer, which must be a power of two.
    - ``head``: Offset to the first unused byte in the buffer.
    - ``tail``: Offset to the first byte of the used range in the buffer.
- **Description**: A circular buffer structure used to manage a buffer of bytes with a fixed capacity. The `head` and `tail` offsets are used to track the start and end of the data within the buffer, and they must be masked before accessing the buffer data. This structure is used to efficiently manage data streams by reusing buffer space as data is consumed.


---
### fd\_quic\_stream
- **Type**: ``struct``
- **Members**:
    - ``conn``: Pointer to the connection associated with the stream.
    - ``stream_id``: Identifier for the stream; all 1's indicates an unused stream.
    - ``context``: User-defined context for callbacks.
    - ``tx_buf``: Transmit buffer for the stream.
    - ``tx_ack``: Acknowledgment bits for each byte in the transmit buffer.
    - ``tx_sent``: Offset of the first unsent byte in the transmit buffer.
    - ``stream_flags``: Flags indicating actions required for the stream.
    - ``sentinel``: Indicates if the stream is a sentinel.
    - ``state``: Current state of the stream, represented by a mask.
    - ``list_memb``: Membership status in a list.
    - ``tx_max_stream_data``: Maximum number of bytes allowed to be sent to the peer.
    - ``tx_tot_data``: Total number of bytes transmitted on the stream.
    - ``rx_tot_data``: Total number of bytes received on the stream.
    - ``upd_pkt_number``: Last packet number with a stream frame referring to this stream.
    - ``next``: Pointer to the next stream in a doubly linked list.
    - ``prev``: Pointer to the previous stream in a doubly linked list.
- **Description**: Manages a QUIC stream, including its state, data transmission, and flow control. It contains fields for connection association, stream identification, user context, transmit buffer management, acknowledgment tracking, and stream state flags. The structure also supports flow control with fields for tracking transmitted and received data, and it is part of a doubly linked list for stream management.


---
### fd\_quic\_stream\_map
- **Type**: ``struct``
- **Members**:
    - `stream_id`: A unique identifier for the stream, used as a key.
    - `hash`: A hash value associated with the stream.
    - `stream`: A pointer to the `fd_quic_stream_t` structure, representing the stream value.
- **Description**: Maps a unique stream identifier to its corresponding stream object and hash value, facilitating efficient stream management and lookup operations in a QUIC protocol implementation.


# Functions

---
### fd\_quic\_stream\_align<!-- {{#callable:fd_quic_stream_align}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_stream.h#L177>)

Returns the alignment requirement for `fd_quic_stream_t`.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the constant value `128ul`.
- **Output**: The function returns an `unsigned long` value of `128ul`, indicating the alignment requirement for `fd_quic_stream_t`.


# Function Declarations (Public API)

---
### fd\_quic\_buffer\_store<!-- {{#callable_declaration:fd_quic_buffer_store}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_stream.h#L159>)

Stores data into a circular buffer.
- **Description**: Use this function to add data to a circular buffer. Ensure that there is enough available space in the buffer before calling this function, as it does not handle cases where the buffer is full. The function does not modify the buffer if there is insufficient space for the data. This function is typically used in scenarios where data needs to be buffered for later processing or transmission.
- **Inputs**:
    - `buf`: A pointer to an `fd_quic_buffer_t` structure representing the circular buffer. The buffer must be properly initialized and must not be null.
    - `data`: A pointer to the data to store in the buffer. The data must not be null.
    - `data_sz`: The size of the data to store, in bytes. Must be less than or equal to the available space in the buffer.
- **Output**: None
- **See Also**: [`fd_quic_buffer_store`](<fd_quic_stream.c.md#fd_quic_buffer_store>)  (Implementation)


---
### fd\_quic\_buffer\_load<!-- {{#callable_declaration:fd_quic_buffer_load}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_stream.h#L170>)

Loads data from a circular buffer.
- **Description**: Use this function to retrieve data from a specified offset in a circular buffer into a provided data buffer. Ensure that the operation is valid by checking that the offset is within the used range of the buffer and that the data size does not exceed the available data. This function does not handle invalid operations, and the caller must ensure the offset and data size are appropriate.
- **Inputs**:
    - `buf`: A pointer to an `fd_quic_buffer_t` structure representing the circular buffer. The buffer must be properly initialized and must not be null.
    - `offs`: An unsigned long integer representing the offset from which to start loading data. It must be within the range of used data in the buffer.
    - `data`: A pointer to an unsigned char array where the loaded data will be stored. The array must have enough space to hold `data_sz` bytes and must not be null.
    - `data_sz`: An unsigned long integer representing the number of bytes to load from the buffer. It must not exceed the available data from the specified offset.
- **Output**: None
- **See Also**: [`fd_quic_buffer_load`](<fd_quic_stream.c.md#fd_quic_buffer_load>)  (Implementation)


---
### fd\_quic\_stream\_footprint<!-- {{#callable_declaration:fd_quic_stream_footprint}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_stream.h#L187>)

Calculates the memory footprint required for a QUIC stream.
- **Description**: Use this function to determine the amount of memory needed to allocate a QUIC stream with a specified transmit buffer size. This is necessary before creating a new stream to ensure that sufficient memory is available. The function computes the total memory requirement by considering the alignment and size of the stream structure, the transmit buffer, and the acknowledgment buffer. Ensure that the transmit buffer size is a valid non-negative value to avoid incorrect memory calculations.
- **Inputs**:
    - `tx_buf_sz`: The size of the transmit buffer in bytes. Must be a non-negative value. If the value is invalid, the function may return an incorrect footprint size.
- **Output**: Returns the total memory footprint in bytes required to allocate a QUIC stream with the specified transmit buffer size.
- **See Also**: [`fd_quic_stream_footprint`](<fd_quic_stream.c.md#fd_quic_stream_footprint>)  (Implementation)


---
### fd\_quic\_stream\_new<!-- {{#callable_declaration:fd_quic_stream_new}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_stream.h#L197>)

Creates and initializes a new QUIC stream.
- **Description**: Use this function to create a new QUIC stream with a specified transmit buffer size. The function requires a memory block that is aligned to the alignment requirements of `fd_quic_stream_t` and is large enough to accommodate the stream's footprint. The function initializes the stream and associates it with a given connection. Ensure that the memory provided is correctly aligned and of sufficient size to avoid errors.
- **Inputs**:
    - `mem`: A pointer to a memory block that must be aligned to `fd_quic_stream_align()` and have at least `fd_quic_stream_footprint(tx_buf_sz)` bytes. The caller retains ownership of this memory.
    - `conn`: A pointer to an `fd_quic_conn_t` structure representing the connection to associate with the new stream. Must not be null.
    - `tx_buf_sz`: The size of the transmit buffer in bytes. Must be a positive value.
- **Output**: Returns a pointer to the newly initialized `fd_quic_stream_t` structure. If the memory size does not match the expected footprint, an error is logged.
- **See Also**: [`fd_quic_stream_new`](<fd_quic_stream.c.md#fd_quic_stream_new>)  (Implementation)


---
### fd\_quic\_stream\_delete<!-- {{#callable_declaration:fd_quic_stream_delete}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_stream.h#L204>)

Removes a QUIC stream from any list it belongs to.
- **Description**: Use this function to remove a QUIC stream from any list it is part of, effectively marking it as not belonging to any list. This function is typically called when a stream is no longer needed and should be cleaned up. It is important to ensure that the `stream` parameter is valid and not null before calling this function. The function does not free the memory associated with the stream; it only updates the stream's list membership status.
- **Inputs**:
    - `stream`: A pointer to the `fd_quic_stream_t` structure representing the stream to be removed from any list. Must not be null. The function assumes the stream is valid and does not perform null checks.
- **Output**: None
- **See Also**: [`fd_quic_stream_delete`](<fd_quic_stream.c.md#fd_quic_stream_delete>)  (Implementation)


---
### fd\_quic\_stream\_set\_context<!-- {{#callable_declaration:fd_quic_stream_set_context}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_stream.h#L213>)

Associates a user-defined context with a QUIC stream.
- **Description**: Use this function to associate a user-defined context with a specific QUIC stream. This can be useful for storing additional information or state related to the stream that can be accessed later. Ensure that the `stream` parameter is a valid and initialized `fd_quic_stream_t` object before calling this function. The function does not perform any validation on the `context` parameter, so it is the caller's responsibility to manage the lifecycle and validity of the context data.
- **Inputs**:
    - `stream`: A pointer to an `fd_quic_stream_t` object. Must not be null and should point to a valid, initialized stream.
    - `context`: A pointer to user-defined data to associate with the stream. Can be null if no context is needed. The caller retains ownership and is responsible for the context's lifecycle.
- **Output**: None
- **See Also**: [`fd_quic_stream_set_context`](<fd_quic_stream.c.md#fd_quic_stream_set_context>)  (Implementation)


---
### fd\_quic\_stream\_get\_context<!-- {{#callable_declaration:fd_quic_stream_get_context}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_stream.h#L224>)

Retrieves the user-defined context associated with a QUIC stream.
- **Description**: Use this function to obtain the context pointer that is associated with a specific QUIC stream. This context is user-defined and can be set using the appropriate function. It is important to ensure that the stream is valid and properly initialized before calling this function. The function does not modify the stream or the context.
- **Inputs**:
    - `stream`: A pointer to an `fd_quic_stream_t` structure. This must not be null and should point to a valid and initialized QUIC stream. If the stream is invalid, the behavior is undefined.
- **Output**: Returns a pointer to the user-defined context associated with the specified stream. The return value can be null if no context has been set.
- **See Also**: [`fd_quic_stream_get_context`](<fd_quic_stream.c.md#fd_quic_stream_get_context>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)