<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements service queue and timer management for QUIC connections, including scheduling and validation.

# Purpose
The code is a C module that manages service timers for QUIC (Quick UDP Internet Connections) connections. It provides functionality to initialize, schedule, cancel, and validate timers associated with QUIC connections. The module uses two types of queues to manage timers: an "instant" queue for immediate events and a "dynamic" priority queue for events scheduled to occur at a specific time. The code includes functions to handle the insertion and removal of connections from these queues, ensuring that the timers are managed efficiently.

The module defines several setup functions, such as [`fd_quic_svc_timers_init`](<#fd_quic_svc_timers_init>), which initializes the timer structures and allocates memory for the priority queue. It also includes task functions like [`fd_quic_svc_timers_schedule`](<#fd_quic_svc_timers_schedule>) and [`fd_quic_svc_timers_cancel`](<#fd_quic_svc_timers_cancel>), which manage the scheduling and cancellation of timers for connections. The [`fd_quic_svc_timers_validate`](<#fd_quic_svc_timers_validate>) function checks the integrity of the timer queues, ensuring that connections are correctly indexed and not duplicated. The module is intended to be part of a larger system managing QUIC connections, providing a specialized service for handling timed events within the QUIC protocol.
# Imports and Dependencies

---
- `fd_quic_svc_q.h`
- `fd_quic_private.h`
- `fd_quic_conn.h`
- `../../util/tmpl/fd_prq.c`


# Functions

---
### fd\_quic\_svc\_timers\_footprint<!-- {{#callable:fd_quic_svc_timers_footprint}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_svc_q.c#L20>)

Calculates the memory footprint required for QUIC service timers based on the maximum number of connections.
- **Inputs**:
    - `max_conn`: The maximum number of connections for which to calculate the memory footprint.
- **Logic and Control Flow**:
    - Initialize `l` with `FD_LAYOUT_INIT`.
    - Append the alignment and size of `fd_quic_svc_timers_t` to `l` using `FD_LAYOUT_APPEND`.
    - Append the alignment and footprint of the priority queue for the given `max_conn` using `FD_LAYOUT_APPEND`.
    - Finalize the layout with the alignment of `fd_quic_svc_timers_t` using `FD_LAYOUT_FINI`.
    - Return the calculated memory footprint `l`.
- **Output**: Returns the calculated memory footprint as an unsigned long integer.
- **Functions Called**:
    - [`fd_quic_svc_timers_align`](<#fd_quic_svc_timers_align>)


---
### fd\_quic\_svc\_timers\_align<!-- {{#callable:fd_quic_svc_timers_align}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_svc_q.c#L29>)

Calculates the maximum alignment requirement between `fd_quic_svc_timers_t` and `fd_quic_svc_queue_prq`.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `fd_ulong_max` to determine the maximum alignment requirement.
    - Uses `alignof(fd_quic_svc_timers_t)` to get the alignment of `fd_quic_svc_timers_t`.
    - Calls `fd_quic_svc_queue_prq_align()` to get the alignment of `fd_quic_svc_queue_prq`.
    - Returns the maximum of the two alignment values.
- **Output**: Returns an `ulong` representing the maximum alignment requirement.


---
### fd\_quic\_svc\_timers\_init<!-- {{#callable:fd_quic_svc_timers_init}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_svc_q.c#L35>)

Initializes a `fd_quic_svc_timers_t` structure with memory allocation and configuration for managing QUIC service timers.
- **Inputs**:
    - `mem`: A pointer to the memory block where the timers structure will be initialized.
    - `max_conn`: The maximum number of connections that the timers can handle.
    - `state`: A pointer to the `fd_quic_state_t` structure representing the current QUIC state.
- **Logic and Control Flow**:
    - Check if `mem` is NULL and log an error if true, then return NULL.
    - Check if `mem` is aligned according to `fd_quic_svc_timers_align()` and log an error if not, then return NULL.
    - Initialize a scratch allocator with `mem`.
    - Allocate memory for a `fd_quic_svc_timers_t` structure and a priority queue memory block using the scratch allocator.
    - Create and join a priority queue (`prq`) for the timers using the allocated memory.
    - Log an error if joining the priority queue fails.
    - Initialize the `instant` queue's count, head, and tail to zero and invalid indices, respectively.
    - Set the `state` of the timers to the provided `state` argument.
    - Return the initialized `fd_quic_svc_timers_t` structure.
- **Output**: A pointer to the initialized `fd_quic_svc_timers_t` structure, or NULL if an error occurs.
- **Functions Called**:
    - [`fd_quic_svc_timers_align`](<#fd_quic_svc_timers_align>)


---
### fd\_quic\_svc\_timers\_init\_conn<!-- {{#callable:fd_quic_svc_timers_init_conn}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_svc_q.c#L70>)

Initializes the service metadata for a QUIC connection with default values.
- **Inputs**:
    - ``conn``: A pointer to an `fd_quic_conn_t` structure representing the QUIC connection to initialize.
- **Logic and Control Flow**:
    - Set `conn->svc_meta.next_timeout` to `LONG_MAX` to indicate no timeout is set.
    - Set `conn->svc_meta.private.prq_idx` to `FD_QUIC_SVC_PRQ_IDX_INVAL` to mark the priority queue index as invalid.
    - Set `conn->svc_meta.private.svc_type` to `FD_QUIC_SVC_CNT` to initialize the service type.
- **Output**: No output is returned as the function operates directly on the `conn` structure.


---
### fd\_quic\_svc\_dlist\_insert\_tail<!-- {{#callable:fd_quic_svc_dlist_insert_tail}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_svc_q.c#L81>)

Inserts a connection at the tail of a doubly-linked list within a service queue.
- **Inputs**:
    - `queue`: A pointer to `fd_quic_svc_queue_t`, representing the service queue where the connection will be inserted.
    - `state`: A pointer to `fd_quic_state_t`, representing the current state of the QUIC service.
    - `conn`: A pointer to `fd_quic_conn_t`, representing the connection to be inserted into the queue.
- **Logic and Control Flow**:
    - Retrieve the connection index from the `conn` structure.
    - Get the connection at the current tail index of the queue using [`fd_quic_conn_at_idx`](<fd_quic_private.h.md#fd_quic_conn_at_idx>).
    - Determine the location to store the new connection index using `fd_ptr_if`, which checks if the queue is not empty.
    - Set the `prev` pointer of the new connection to the current tail of the queue.
    - Set the `next` pointer of the new connection to `FD_QUIC_SVC_DLIST_IDX_INVAL`, indicating the end of the list.
    - Update the queue's tail to the new connection index.
    - Increment the connection count in the queue.
- **Output**: No return value; the function modifies the queue and connection structures in place.
- **Functions Called**:
    - [`fd_quic_conn_at_idx`](<fd_quic_private.h.md#fd_quic_conn_at_idx>)


---
### fd\_quic\_svc\_dlist\_remove<!-- {{#callable:fd_quic_svc_dlist_remove}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_svc_q.c#L96>)

Removes a connection from a doubly linked list within a service queue.
- **Inputs**:
    - `queue`: A pointer to the `fd_quic_svc_queue_t` structure representing the service queue from which the connection will be removed.
    - `state`: A pointer to the `fd_quic_state_t` structure representing the current state of the QUIC service.
    - `conn`: A pointer to the `fd_quic_conn_t` structure representing the connection to be removed from the queue.
- **Logic and Control Flow**:
    - Retrieve the connection index, queue head, and queue tail from the `conn` and `queue` structures.
    - Get the previous and next connections in the list using [`fd_quic_conn_at_idx`](<fd_quic_private.h.md#fd_quic_conn_at_idx>) with the indices stored in `conn`'s metadata.
    - Update the `queue` head or the `prev_conn`'s next pointer based on whether the connection is at the head of the queue.
    - Update the `queue` tail or the `next_conn`'s previous pointer based on whether the connection is at the tail of the queue.
    - Invalidate the `next` and `prev` pointers in the `conn`'s metadata to indicate removal.
    - Decrement the connection count in the `queue`.
- **Output**: The function does not return a value; it modifies the `queue` and `conn` structures in place.
- **Functions Called**:
    - [`fd_quic_conn_at_idx`](<fd_quic_private.h.md#fd_quic_conn_at_idx>)


---
### fd\_quic\_svc\_timers\_cancel<!-- {{#callable:fd_quic_svc_timers_cancel}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_svc_q.c#L117>)

Cancels a scheduled timer for a connection and reinitializes the connection's service metadata.
- **Inputs**:
    - `timers`: A pointer to `fd_quic_svc_timers_t`, which manages the service timers.
    - `conn`: A pointer to `fd_quic_conn_t`, representing the connection whose timer is to be canceled.
- **Logic and Control Flow**:
    - Retrieve the service type from the connection's service metadata.
    - Get the state from the `timers` structure.
    - If the service type is `FD_QUIC_SVC_INSTANT`, remove the connection from the `instant` queue using [`fd_quic_svc_dlist_remove`](<#fd_quic_svc_dlist_remove>).
    - If the service type is `FD_QUIC_SVC_DYNAMIC`, remove the connection from the priority queue using `fd_quic_svc_queue_prq_remove`.
    - Reinitialize the connection's service metadata by calling [`fd_quic_svc_timers_init_conn`](<#fd_quic_svc_timers_init_conn>).
- **Output**: No return value; the function operates by modifying the state of the `timers` and `conn` structures.
- **Functions Called**:
    - [`fd_quic_svc_dlist_remove`](<#fd_quic_svc_dlist_remove>)
    - [`fd_quic_svc_timers_init_conn`](<#fd_quic_svc_timers_init_conn>)


---
### fd\_quic\_svc\_timers\_schedule<!-- {{#callable:fd_quic_svc_timers_schedule}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_svc_q.c#L132>)

Schedules a QUIC connection's service timer based on its current state and timeout.
- **Inputs**:
    - ``timers``: A pointer to `fd_quic_svc_timers_t`, which manages the service timers.
    - ``conn``: A pointer to `fd_quic_conn_t`, representing the QUIC connection to schedule.
    - ``now``: A long integer representing the current time.
- **Logic and Control Flow**:
    - Check if `conn` is null or in an invalid state; if so, return immediately.
    - Retrieve the current state, expiry time, and service type of the connection.
    - Determine the new service type based on whether the expiry time equals `now`.
    - Check if the current and new service types are both dynamic and if the expiry time is increasing.
    - If the operation is a no-op (already INSTANT or increasing/preserving DYNAMIC expiry), return.
    - If the old service type is dynamic, remove the existing dynamic timer.
    - Set the connection's service type to the new service type.
    - If the new service type is INSTANT, insert the connection into the instant queue.
    - If the new service type is DYNAMIC, create an event and insert it into the priority queue.
- **Output**: No output is returned; the function modifies the state of the `timers` and `conn` objects.
- **Functions Called**:
    - [`fd_quic_svc_dlist_insert_tail`](<#fd_quic_svc_dlist_insert_tail>)


---
### fd\_quic\_svc\_timers\_validate<!-- {{#callable:fd_quic_svc_timers_validate}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_svc_q.c#L180>)

Validates the integrity of service timers in a QUIC connection by checking dynamic and instant queues.
- **Inputs**:
    - `timers`: A pointer to `fd_quic_svc_timers_t`, which contains the service timers to validate.
    - `quic`: A pointer to `fd_quic_t`, representing the QUIC connection state.
- **Logic and Control Flow**:
    - Retrieve the QUIC state using [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>) with the `quic` pointer.
    - Validate the dynamic queue by iterating over `timers->prq` and checking if each connection's `prq_idx` matches its index and if the service type is `FD_QUIC_SVC_DYNAMIC`.
    - Ensure each connection in the dynamic queue is visited only once by checking and setting the `visited` flag.
    - Validate the instant queue by traversing the doubly linked list starting from `timers->instant.head`, checking if each connection's service type is `FD_QUIC_SVC_INSTANT`, and ensuring each connection is visited only once.
    - Count the number of connections in the instant queue and compare it with `timers->instant.cnt`.
    - Iterate over all connections in the QUIC state to ensure that connections not in any queue have an invalid `prq_idx`.
    - Return 1 if all validations pass, otherwise return 0.
- **Output**: Returns 1 if all validations pass, otherwise returns 0.
- **Functions Called**:
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_conn_at_idx`](<fd_quic_private.h.md#fd_quic_conn_at_idx>)


---
### fd\_quic\_svc\_timers\_next<!-- {{#callable:fd_quic_svc_timers_next}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_svc_q.c#L223>)

Retrieves the next service event from the timers, prioritizing the INSTANT queue over the DYNAMIC queue, and optionally removes it.
- **Inputs**:
    - `timers`: A pointer to `fd_quic_svc_timers_t`, which contains the INSTANT and DYNAMIC queues of service events.
    - `now`: A `long` integer representing the current time, used to determine the next event's timeout.
    - `pop`: An `int` flag indicating whether to remove the event from the queue (1 to remove, 0 to keep).
- **Logic and Control Flow**:
    - Initialize `next` with a default event having `timeout` set to `LONG_MAX` and `conn` set to `NULL`.
    - Check if the INSTANT queue has events using `timers->instant.cnt`.
    - If the INSTANT queue is not empty, retrieve the connection at the head of the INSTANT queue using [`fd_quic_conn_at_idx`](<fd_quic_private.h.md#fd_quic_conn_at_idx>).
    - Set `next` to the event with the connection and the minimum of `now` and the connection's `next_timeout`.
    - If `pop` is true, remove the connection from the INSTANT queue using [`fd_quic_svc_dlist_remove`](<#fd_quic_svc_dlist_remove>) and reinitialize it with [`fd_quic_svc_timers_init_conn`](<#fd_quic_svc_timers_init_conn>).
    - Return `next` if an event was found in the INSTANT queue.
    - If the INSTANT queue is empty, check if the DYNAMIC queue has events using `fd_quic_svc_queue_prq_cnt`.
    - If the DYNAMIC queue is empty or `pop` is true and `now` is less than the timeout of the first event in the DYNAMIC queue, return `next`.
    - Otherwise, set `next` to the first event in the DYNAMIC queue.
    - If `pop` is true, remove the minimum event from the DYNAMIC queue using `fd_quic_svc_queue_prq_remove_min` and reinitialize the connection with [`fd_quic_svc_timers_init_conn`](<#fd_quic_svc_timers_init_conn>).
    - Return `next`.
- **Output**: An `fd_quic_svc_event_t` structure representing the next service event, with its `timeout` and `conn` fields set appropriately.
- **Functions Called**:
    - [`fd_quic_conn_at_idx`](<fd_quic_private.h.md#fd_quic_conn_at_idx>)
    - [`fd_quic_svc_dlist_remove`](<#fd_quic_svc_dlist_remove>)
    - [`fd_quic_svc_timers_init_conn`](<#fd_quic_svc_timers_init_conn>)


---
### fd\_quic\_svc\_timers\_get\_event<!-- {{#callable:fd_quic_svc_timers_get_event}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_svc_q.c#L257>)

Retrieves the service event for a given connection based on its service type.
- **Inputs**:
    - `timers`: A pointer to `fd_quic_svc_timers_t`, which contains the service timers and event queues.
    - `conn`: A pointer to `fd_quic_conn_t`, representing the connection for which the event is being retrieved.
    - `now`: A `long` integer representing the current time.
- **Logic and Control Flow**:
    - Retrieve the service type from the connection's metadata.
    - If the service type is `FD_QUIC_SVC_INSTANT`, return an event with the current time and the connection.
    - If the service type is `FD_QUIC_SVC_DYNAMIC`, retrieve the event from the priority queue using the connection's index and return it.
    - If the service type is neither, return an event with `LONG_MAX` timeout and a `NULL` connection.
- **Output**: Returns an `fd_quic_svc_event_t` structure containing the timeout and connection information for the specified service event.


---
### fd\_quic\_svc\_timers\_cnt\_events<!-- {{#callable:fd_quic_svc_timers_cnt_events}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_svc_q.c#L272>)

Calculates the total number of events in both the instant and dynamic queues of the `fd_quic_svc_timers_t` structure.
- **Inputs**:
    - `timers`: A pointer to an `fd_quic_svc_timers_t` structure that contains the instant and dynamic queues.
- **Logic and Control Flow**:
    - Accesses the `instant.cnt` field of the `timers` structure to get the count of events in the instant queue.
    - Calls the `fd_quic_svc_queue_prq_cnt` function with `timers->prq` to get the count of events in the dynamic queue.
    - Returns the sum of the counts from the instant and dynamic queues.
- **Output**: Returns an `ulong` representing the total number of events in both the instant and dynamic queues.



---
Made with ❤️ by [Driver](https://www.driver.ai/)