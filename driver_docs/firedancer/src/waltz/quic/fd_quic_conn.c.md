<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines and manages QUIC connection structures, including stream mapping, initialization, and context handling.

# Purpose
The code defines and manages QUIC (Quick UDP Internet Connections) connections within a network application. It includes functions and structures to initialize, configure, and manage the lifecycle of QUIC connections. The code provides a mechanism to allocate and align memory for connection structures, initialize connection states, and manage associated resources such as stream maps and packet metadata. The [`fd_quic_conn_new`](<#fd_quic_conn_new>) function is responsible for creating a new QUIC connection, ensuring that memory is correctly aligned and initialized, and setting up necessary data structures like stream lists and hash maps.

The code also includes utility functions for setting and retrieving user-defined context values associated with a connection, as well as mapping reason codes to human-readable names. The [`fd_quic_conn_validate_init`](<#fd_quic_conn_validate_init>) function is used to initialize validation states for connections, ensuring that each connection is marked as unvisited. The code relies on several included headers and a dynamic map template to manage stream identifiers and their associated data. Overall, the code is part of a larger system that handles QUIC protocol operations, focusing on connection management and resource allocation.
# Imports and Dependencies

---
- `fd_quic_conn.h`
- `fd_quic_common.h`
- `fd_quic_enum.h`
- `fd_quic_pkt_meta.h`
- `fd_quic_private.h`
- `../../util/tmpl/fd_map_dynamic.c`


# Data Structures

---
### fd\_quic\_conn\_layout
- **Type**: ``struct``
- **Members**:
    - `stream_map_lg`: Stores the logarithmic size of the stream map.
    - `stream_map_off`: Stores the offset of the stream map in memory.
- **Description**: Defines the layout for a QUIC connection, specifically managing the stream map's size and memory offset. This structure is used to allocate and align memory for stream maps within a QUIC connection, ensuring efficient memory usage and access.


---
### fd\_quic\_conn\_layout\_t
- **Type**: ``struct``
- **Members**:
    - `stream_map_lg`: Stores the logarithmic size of the stream map.
    - `stream_map_off`: Stores the offset of the stream map in memory.
- **Description**: Defines the layout of a QUIC connection, specifically managing the configuration of the stream map, which is used to map stream IDs to stream pointers. The `stream_map_lg` member determines the size of the stream map, while `stream_map_off` indicates its memory offset, facilitating efficient memory allocation and access for QUIC streams.


# Functions

---
### fd\_quic\_conn\_align<!-- {{#callable:fd_quic_conn_align}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_conn.c#L23>)

Calculates the maximum alignment requirement for QUIC connection-related structures.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calculate the maximum alignment between `fd_quic_conn_t` and `fd_quic_stream_t` using `fd_ulong_max`.
    - Update the alignment to the maximum of the current alignment and the alignment required by `fd_quic_stream_map_align()`.
    - Return the calculated maximum alignment.
- **Output**: Returns the maximum alignment requirement as an unsigned long integer.


---
### fd\_quic\_conn\_footprint\_ext<!-- {{#callable:fd_quic_conn_footprint_ext}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_conn.c#L30>)

Calculates the memory footprint required for a QUIC connection and updates the connection layout with stream map details.
- **Inputs**:
    - ``limits``: A pointer to a `fd_quic_limits_t` structure that contains the limits for the QUIC connection, including the number of stream IDs.
    - ``layout``: A pointer to a `fd_quic_conn_layout_t` structure that will be updated with the layout details of the stream map.
- **Logic and Control Flow**:
    - Initialize `stream_id_cnt` with the number of stream IDs from `limits`.
    - Set `off` to the size of `fd_quic_conn_t`.
    - If `stream_id_cnt` is greater than zero, calculate the logarithm `lg` to determine the size of the stream hash map based on `FD_QUIC_DEFAULT_SPARSITY`.
    - Align `off` to the alignment required by the stream map and update `layout->stream_map_off` with this offset.
    - Calculate the footprint of the stream map using `fd_quic_stream_map_footprint` and add it to `off`.
    - If `stream_id_cnt` is zero, set `layout->stream_map_lg` and `layout->stream_map_off` to zero.
    - Return the aligned value of `off` using [`fd_quic_conn_align`](<#fd_quic_conn_align>).
- **Output**: Returns the aligned memory footprint required for the QUIC connection as an `ulong`.
- **Functions Called**:
    - [`fd_quic_conn_align`](<#fd_quic_conn_align>)


---
### fd\_quic\_conn\_footprint<!-- {{#callable:fd_quic_conn_footprint}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_conn.c#L60>)

Calculates the memory footprint required for a QUIC connection based on specified limits.
- **Inputs**:
    - `limits`: A pointer to a `fd_quic_limits_t` structure that specifies the limits for the QUIC connection.
- **Logic and Control Flow**:
    - Declare a variable `layout` of type `fd_quic_conn_layout_t`.
    - Call the function [`fd_quic_conn_footprint_ext`](<#fd_quic_conn_footprint_ext>) with `limits` and the address of `layout` as arguments.
    - Return the result of the [`fd_quic_conn_footprint_ext`](<#fd_quic_conn_footprint_ext>) function call.
- **Output**: Returns an `ulong` representing the calculated memory footprint for the QUIC connection.
- **Functions Called**:
    - [`fd_quic_conn_footprint_ext`](<#fd_quic_conn_footprint_ext>)


---
### fd\_quic\_conn\_new<!-- {{#callable:fd_quic_conn_new}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_conn.c#L66>)

Creates and initializes a new QUIC connection using the provided memory, QUIC instance, and connection limits.
- **Inputs**:
    - `mem`: A pointer to the memory location where the new QUIC connection will be created.
    - `quic`: A pointer to the `fd_quic_t` instance representing the QUIC context.
    - `limits`: A pointer to the `fd_quic_limits_t` structure containing the connection limits.
- **Logic and Control Flow**:
    - Check if `mem`, `quic`, or `limits` is NULL and log a warning if any are NULL, returning NULL.
    - Check if `mem` is aligned according to the required alignment and log a warning if it is not, returning NULL.
    - Calculate the memory footprint required for the connection using [`fd_quic_conn_footprint_ext`](<#fd_quic_conn_footprint_ext>) and log a warning if it is invalid, returning NULL.
    - Initialize the `fd_quic_conn_t` structure at the memory location pointed to by `mem`.
    - Set the connection's QUIC context and state to `FD_QUIC_CONN_STATE_INVALID`.
    - Increment the connection state count for `FD_QUIC_CONN_STATE_INVALID` in the QUIC metrics.
    - Initialize the send and used stream lists with sentinels.
    - If a stream map is required, initialize it using `fd_quic_stream_map_new` and `fd_quic_stream_map_join`, returning NULL if initialization fails.
    - Initialize the packet meta tracker using [`fd_quic_pkt_meta_tracker_init`](<fd_quic_pkt_meta.c.md#fd_quic_pkt_meta_tracker_init>).
    - Initialize the service timers for the connection using [`fd_quic_svc_timers_init_conn`](<fd_quic_svc_q.c.md#fd_quic_svc_timers_init_conn>).
- **Output**: A pointer to the newly created and initialized `fd_quic_conn_t` structure, or NULL if any error occurs during initialization.
- **Functions Called**:
    - [`fd_quic_conn_align`](<#fd_quic_conn_align>)
    - [`fd_quic_conn_footprint_ext`](<#fd_quic_conn_footprint_ext>)
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_pkt_meta_tracker_init`](<fd_quic_pkt_meta.c.md#fd_quic_pkt_meta_tracker_init>)
    - [`fd_quic_svc_timers_init_conn`](<fd_quic_svc_q.c.md#fd_quic_svc_timers_init_conn>)


---
### fd\_quic\_conn\_set\_context<!-- {{#callable:fd_quic_conn_set_context}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_conn.c#L138>)

Sets a user-defined context value for a QUIC connection.
- **Inputs**:
    - `conn`: A pointer to an `fd_quic_conn_t` structure representing the QUIC connection.
    - `context`: A pointer to a user-defined context that you want to associate with the connection.
- **Logic and Control Flow**:
    - Assigns the `context` pointer to the `context` field of the `conn` structure.
- **Output**: No return value.


---
### fd\_quic\_conn\_get\_context<!-- {{#callable:fd_quic_conn_get_context}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_conn.c#L145>)

Retrieves the user-defined context value from a QUIC connection.
- **Inputs**:
    - ``conn``: A pointer to an `fd_quic_conn_t` structure representing the QUIC connection from which to retrieve the context.
- **Logic and Control Flow**:
    - Accesses the `context` member of the `fd_quic_conn_t` structure pointed to by `conn`.
    - Returns the value of the `context` member.
- **Output**: Returns a pointer to the user-defined context associated with the specified QUIC connection.


---
### fd\_quic\_conn\_reason\_name<!-- {{#callable:fd_quic_conn_reason_name}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_conn.c#L150>)

Maps a reason code to its corresponding name as a string.
- **Inputs**:
    - `reason`: An unsigned integer representing the reason code to map to a name.
- **Logic and Control Flow**:
    - Defines a static array `fd_quic_conn_reason_names` that maps reason codes to their corresponding names using the `FD_QUIC_REASON_CODES` macro.
    - Calculates the number of elements in the `fd_quic_conn_reason_names` array using the `ELEMENTS` macro.
    - Checks if the `reason` is greater than or equal to `ELEMENTS`; if true, returns "N/A".
    - Retrieves the name corresponding to the `reason` from the `fd_quic_conn_reason_names` array.
    - Returns the name if it exists; otherwise, returns "N/A".
- **Output**: A constant character pointer to the name corresponding to the reason code, or "N/A" if the reason code is invalid.


---
### fd\_quic\_conn\_validate\_init<!-- {{#callable:fd_quic_conn_validate_init}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_conn.c#L171>)

Initializes the `visited` field of all connections in a QUIC state to zero.
- **Inputs**:
    - `quic`: A pointer to an `fd_quic_t` structure representing the QUIC instance.
- **Logic and Control Flow**:
    - Retrieve the QUIC state using [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>) with the `quic` parameter.
    - Get the connection count from `quic->limits.conn_cnt`.
    - Iterate over each connection index from 0 to `conn_cnt - 1`.
    - For each connection, retrieve the connection object using [`fd_quic_conn_at_idx`](<fd_quic_private.h.md#fd_quic_conn_at_idx>).
    - Set the `visited` field of each connection to zero.
- **Output**: None (the function returns void).
- **Functions Called**:
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_conn_at_idx`](<fd_quic_private.h.md#fd_quic_conn_at_idx>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)