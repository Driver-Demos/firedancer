<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for pretty-printing QUIC frames and headers in JSON format.

# Purpose
The code is a C module designed to parse and pretty-print QUIC (Quick UDP Internet Connections) protocol packets. It provides functions to decode and format various QUIC packet headers and frames into a human-readable JSON format. The primary function, [`fd_quic_pretty_print_quic_pkt`](<#fd_quic_pretty_print_quic_pkt>), takes a QUIC packet and outputs a JSON representation that includes metadata such as packet type, connection index, source and destination IP addresses, and UDP ports. It also processes the packet's frames, converting them into a structured JSON format.

The module includes several functions to handle different types of QUIC headers, such as [`fd_quic_pretty_print_quic_hdr_initial`](<#fd_quic_pretty_print_quic_hdr_initial>), [`fd_quic_pretty_print_quic_hdr_handshake`](<#fd_quic_pretty_print_quic_hdr_handshake>), and [`fd_quic_pretty_print_quic_hdr_one_rtt`](<#fd_quic_pretty_print_quic_hdr_one_rtt>). These functions decode specific header types and extract relevant information, such as packet numbers and payload sizes. The code also defines macros and utility functions, such as `safe_snprintf` for safe string formatting and [`ip4_to_str`](<#ip4_to_str>) for converting IP addresses to strings. The module is intended to be part of a larger system that requires detailed logging or analysis of QUIC traffic, providing a clear and structured output for debugging or monitoring purposes.
# Imports and Dependencies

---
- `templ/fd_quic_pretty_print.h`
- `templ/fd_quic_templ.h`
- `templ/fd_quic_frames_templ.h`
- `templ/fd_quic_undefs.h`
- `fd_quic_private.h`
- `fd_quic_pretty_print.h`
- `templ/fd_quic_dft.h`
- `templ/fd_quic_frame.h`


# Functions

---
### fd\_quic\_pretty\_print\_frame<!-- {{#callable:fd_quic_pretty_print_frame}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_pretty_print.c#L46>)

Parses and pretty-prints QUIC frames from a buffer into a JSON-like format.
- **Inputs**:
    - ``out_buf``: A pointer to a buffer where the function will write the pretty-printed output.
    - ``out_buf_sz``: A pointer to the size of the output buffer, which will be updated as the buffer is filled.
    - ``buf``: A pointer to the input buffer containing the QUIC frames to be parsed.
    - ``buf_sz``: The size of the input buffer.
- **Logic and Control Flow**:
    - Check if `buf_sz` is less than 1; if true, return `FD_QUIC_PARSE_FAIL`.
    - Initialize `cur_buf` to point to the start of `buf` and `buf_end` to point to the end of `buf`.
    - Check if the first byte of `cur_buf` indicates padding or ping frames; if so, count and pretty-print them, then return the number of bytes consumed.
    - Extract the frame ID from the first byte of `cur_buf`; if the ID is invalid, pretty-print an unknown frame type and return `FD_QUIC_PARSE_FAIL`.
    - Initialize a union `data` to store frame-specific data and set it to zero.
    - Use a switch statement on the frame ID to call the appropriate frame handler function, which parses and pretty-prints the frame, updating `consumed`.
    - If `consumed` equals `FD_QUIC_PARSE_FAIL`, return `FD_QUIC_PARSE_FAIL`.
    - Handle specific frame types (e.g., ACK, crypto, stream, connection close) with additional parsing and pretty-printing logic.
    - Return the number of bytes consumed from the input buffer.
- **Output**: The number of bytes consumed from the input buffer, or `FD_QUIC_PARSE_FAIL` if parsing fails.


---
### fd\_quic\_pretty\_print\_quic\_hdr\_initial<!-- {{#callable:fd_quic_pretty_print_quic_hdr_initial}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_pretty_print.c#L343>)

Parses and pretty-prints the initial QUIC header from a buffer, updating output buffer pointers and sizes.
- **Inputs**:
    - ``out_buf``: Pointer to the output buffer where the pretty-printed header will be written.
    - ``out_buf_sz``: Pointer to the size of the output buffer, which will be decremented by the number of bytes written.
    - ``frame_ptr``: Pointer to a location where the function will store the pointer to the start of the frame data in the buffer.
    - ``frame_sz``: Pointer to a location where the function will store the size of the frame data.
    - ``buf``: Pointer to the input buffer containing the QUIC packet data to be parsed.
    - ``buf_sz``: Size of the input buffer.
- **Logic and Control Flow**:
    - Writes the initial header type to the output buffer using `safe_snprintf` and updates the buffer pointers and sizes.
    - Initializes a `fd_quic_initial_t` structure and attempts to decode the initial header from the input buffer using `fd_quic_decode_initial`.
    - If decoding fails, writes an error message to the output buffer, logs the error, and returns `FD_QUIC_PARSE_FAIL`.
    - Calculates the size of the packet number and the offset to the payload.
    - Decodes the packet number from the buffer and updates the `initial` structure with this value.
    - Sets `frame_ptr` to point to the start of the frame data and calculates `frame_sz` as the size of the frame data.
    - Calls `fd_quic_pretty_print_struct_initial` to pretty-print the `initial` structure into the output buffer.
    - Returns the offset to the payload.
- **Output**: Returns the offset to the payload within the buffer, or `FD_QUIC_PARSE_FAIL` if parsing fails.


---
### fd\_quic\_pretty\_print\_quic\_hdr\_handshake<!-- {{#callable:fd_quic_pretty_print_quic_hdr_handshake}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_pretty_print.c#L387>)

Processes a QUIC handshake header, decodes it, and formats it into a JSON-like string.
- **Inputs**:
    - ``out_buf``: A pointer to a buffer where the formatted output will be written.
    - ``out_buf_sz``: A pointer to the size of the output buffer.
    - ``frame_ptr``: A pointer to a location where the function will store the start of the frame data.
    - ``frame_sz``: A pointer to a location where the function will store the size of the frame data.
    - ``buf``: A pointer to the input buffer containing the QUIC packet data.
    - ``buf_sz``: The size of the input buffer.
- **Logic and Control Flow**:
    - Writes the header type 'handshake' to the output buffer using `safe_snprintf`.
    - Decodes the handshake data from the input buffer using `fd_quic_decode_handshake`.
    - Checks if the decoding fails and logs an error if it does, then returns `FD_QUIC_PARSE_FAIL`.
    - Calculates the size of the packet number and the payload offset.
    - Decodes the packet number from the buffer and stores it in the handshake structure.
    - Sets the `frame_ptr` to point to the start of the frame data and calculates the `frame_sz`.
    - Formats the handshake structure into the output buffer using `fd_quic_pretty_print_struct_handshake`.
- **Output**: Returns the offset to the payload within the buffer, or `FD_QUIC_PARSE_FAIL` if parsing fails.


---
### fd\_quic\_pretty\_print\_quic\_hdr\_one\_rtt<!-- {{#callable:fd_quic_pretty_print_quic_hdr_one_rtt}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_pretty_print.c#L431>)

Parses and pretty-prints a QUIC 1-RTT header from a buffer, updating output buffer pointers and sizes.
- **Inputs**:
    - ``out_buf``: Pointer to the output buffer where the pretty-printed header will be written.
    - ``out_buf_sz``: Pointer to the size of the output buffer, which will be updated as data is written.
    - ``frame_ptr``: Pointer to a location where the function will store the pointer to the start of the frame data in the buffer.
    - ``frame_sz``: Pointer to a location where the function will store the size of the frame data.
    - ``buf``: Pointer to the input buffer containing the QUIC packet data to be parsed.
    - ``buf_sz``: Size of the input buffer.
- **Logic and Control Flow**:
    - Writes the header type '1-rtt' to the output buffer using `safe_snprintf` and updates `out_buf` and `out_buf_sz` accordingly.
    - Initializes a `fd_quic_one_rtt_t` structure and sets a hidden field `dst_conn_id_len` to 8.
    - Calls `fd_quic_decode_one_rtt` to decode the 1-RTT header from the input buffer.
    - If decoding fails, writes an error message to the output buffer, logs the error, and returns `FD_QUIC_PARSE_FAIL`.
    - Calculates the packet number offset, size, and payload offset and size.
    - Decodes the packet number using `fd_quic_pktnum_decode` and updates the `one_rtt` structure with the packet number.
    - Sets `frame_ptr` to point to the start of the frame data and `frame_sz` to the size of the frame data minus the crypto tag size.
    - Calls `fd_quic_pretty_print_struct_one_rtt` to pretty-print the `one_rtt` structure into the output buffer.
    - Returns the payload offset.
- **Output**: Returns the payload offset as an `ulong`, or `FD_QUIC_PARSE_FAIL` if parsing fails.


---
### fd\_quic\_pretty\_print\_quic\_hdr<!-- {{#callable:fd_quic_pretty_print_quic_hdr}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_pretty_print.c#L479>)

Processes a QUIC header and determines its type, then delegates to specific functions for detailed processing based on the header type.
- **Inputs**:
    - ``out_buf``: A pointer to a buffer where the function will write the pretty-printed output.
    - ``out_buf_sz``: A pointer to the size of the output buffer, which will be updated as the buffer is filled.
    - ``frame_ptr``: A pointer to a pointer that will be set to the start of the frame data within the buffer.
    - ``frame_sz``: A pointer to a variable that will be set to the size of the frame data.
    - ``buf``: A pointer to the input buffer containing the QUIC header to be processed.
    - ``buf_sz``: The size of the input buffer.
- **Logic and Control Flow**:
    - Extracts the first byte from `buf` to determine if the header is a long header or a short header.
    - If the header is a short header, calls [`fd_quic_pretty_print_quic_hdr_one_rtt`](<#fd_quic_pretty_print_quic_hdr_one_rtt>) to process it.
    - If the header is a long header, extracts the long header type from the first byte.
    - Uses a switch statement to handle different long header types:
    - For type `0x00`, calls [`fd_quic_pretty_print_quic_hdr_initial`](<#fd_quic_pretty_print_quic_hdr_initial>).
    - For type `0x01`, writes an error message to `out_buf` and returns `FD_QUIC_PARSE_FAIL`.
    - For type `0x02`, calls [`fd_quic_pretty_print_quic_hdr_handshake`](<#fd_quic_pretty_print_quic_hdr_handshake>).
    - For type `0x03`, writes an error message to `out_buf` and returns `FD_QUIC_PARSE_FAIL`.
    - If none of the cases match, returns `FD_QUIC_PARSE_FAIL`.
- **Output**: Returns the number of bytes processed from the input buffer, or `FD_QUIC_PARSE_FAIL` if an error occurs.
- **Functions Called**:
    - [`fd_quic_pretty_print_quic_hdr_one_rtt`](<#fd_quic_pretty_print_quic_hdr_one_rtt>)
    - [`fd_quic_pretty_print_quic_hdr_initial`](<#fd_quic_pretty_print_quic_hdr_initial>)
    - [`fd_quic_pretty_print_quic_hdr_handshake`](<#fd_quic_pretty_print_quic_hdr_handshake>)


---
### ip4\_to\_str<!-- {{#callable:ip4_to_str}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_pretty_print.c#L521>)

Converts an IPv4 address from a numeric format to a string format.
- **Inputs**:
    - `buf`: A character buffer with a size of `IP4_TO_STR_BUF_SZ` to store the resulting string representation of the IPv4 address.
    - `ip4_addr`: An unsigned integer representing the IPv4 address to convert.
- **Logic and Control Flow**:
    - Calls `safe_snprintf` to format the IPv4 address into the `buf` using the format specified by `FD_IP4_ADDR_FMT` and arguments from `FD_IP4_ADDR_FMT_ARGS(ip4_addr)`.
    - Checks if the formatted size `sz` is greater than or equal to `IP4_TO_STR_BUF_SZ`, which should not happen under normal circumstances.
    - If the size `sz` is too large, it sets the last character of `buf` to a null terminator to ensure the string is properly terminated.
- **Output**: Returns a pointer to the `buf` containing the string representation of the IPv4 address.


---
### fd\_quic\_pretty\_print\_quic\_pkt<!-- {{#callable:fd_quic_pretty_print_quic_pkt}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_pretty_print.c#L532>)

Formats and prints a QUIC packet in a human-readable JSON format.
- **Inputs**:
    - `pkt_ctx`: A pointer to `fd_quic_pretty_print_t` structure containing context information for the packet.
    - `now`: A long integer representing the current time, which is not used in the function.
    - `buf`: A pointer to an array of unsigned characters representing the packet data to be pretty-printed.
    - `buf_sz`: An unsigned long integer representing the size of the buffer `buf`.
- **Logic and Control Flow**:
    - Check if `buf` is NULL; if so, return `FD_QUIC_PARSE_FAIL`.
    - Initialize a static buffer `pretty_print_buf` to store the formatted output.
    - Format and append packet metadata such as flow direction, connection index, trace time, source and destination IP addresses, and ports to `pretty_print_buf`.
    - Call [`fd_quic_pretty_print_quic_hdr`](<#fd_quic_pretty_print_quic_hdr>) to parse and format the QUIC header; if it fails, append an error message and return `FD_QUIC_PARSE_FAIL`.
    - Format and append the start of the frames array to `pretty_print_buf`.
    - Call [`fd_quic_pretty_print_frames`](<#fd_quic_pretty_print_frames>) to parse and format the frames; if it fails, append an error message, print the buffer, and return `FD_QUIC_PARSE_FAIL`.
    - Append the closing bracket for the frames array and the JSON object to `pretty_print_buf`.
    - Replace any null characters in `pretty_print_buf` with asterisks.
    - Print the formatted JSON string to standard output.
    - Return the result code from [`fd_quic_pretty_print_frames`](<#fd_quic_pretty_print_frames>).
- **Output**: Returns an unsigned long integer indicating success or failure of the parsing and printing process.
- **Functions Called**:
    - [`ip4_to_str`](<#ip4_to_str>)
    - [`fd_quic_pretty_print_quic_hdr`](<#fd_quic_pretty_print_quic_hdr>)
    - [`fd_quic_pretty_print_frames`](<#fd_quic_pretty_print_frames>)


---
### fd\_quic\_pretty\_print\_frames<!-- {{#callable:fd_quic_pretty_print_frames}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_pretty_print.c#L623>)

Processes a buffer of QUIC frames and appends their pretty-printed JSON representation to an output buffer.
- **Inputs**:
    - ``out_buf``: A pointer to a character buffer where the function will append the JSON representation of the frames.
    - ``out_buf_sz``: A pointer to the size of the output buffer, which will be decremented as data is written.
    - ``buf``: A pointer to the input buffer containing the QUIC frames to be processed.
    - ``buf_sz``: The size of the input buffer.
- **Logic and Control Flow**:
    - Initialize `orig_buf` to the start of `buf` and declare `sz` for size tracking.
    - Enter a loop that continues while `buf_sz` is greater than 0.
    - Use `safe_snprintf` to append the JSON opening for a frame to `out_buf` and adjust `out_buf` and `out_buf_sz` accordingly.
    - Call [`fd_quic_pretty_print_frame`](<#fd_quic_pretty_print_frame>) to process a single frame from `buf`.
    - If [`fd_quic_pretty_print_frame`](<#fd_quic_pretty_print_frame>) returns `FD_QUIC_PARSE_FAIL`, append an error message to `out_buf`, adjust `out_buf` and `out_buf_sz`, and break the loop.
    - Append the closing JSON for a frame to `out_buf` using `safe_snprintf`, and adjust `out_buf` and `out_buf_sz`.
    - If the return code `rc` from [`fd_quic_pretty_print_frame`](<#fd_quic_pretty_print_frame>) is greater than or equal to `buf_sz`, break the loop.
    - Increment `buf` by `rc` and decrement `buf_sz` by `rc`.
- **Output**: Returns the number of bytes processed from the input buffer `buf`.
- **Functions Called**:
    - [`fd_quic_pretty_print_frame`](<#fd_quic_pretty_print_frame>)


# Function Declarations (Public API)

---
### fd\_quic\_pretty\_print\_frames<!-- {{#callable_declaration:fd_quic_pretty_print_frames}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_pretty_print.c#L336>)

Converts QUIC frames to a JSON-like string format.
- **Description**: Use this function to convert a buffer of QUIC frames into a JSON-like string format for easier readability and debugging. It processes each frame in the buffer, appending its formatted representation to the output buffer. The function continues until all frames are processed or an error occurs. Ensure that the output buffer is large enough to hold the formatted data. If a frame cannot be parsed, the function appends an error message to the output and stops processing further frames.
- **Inputs**:
    - `out_buf`: A pointer to a character pointer where the function writes the formatted output. The caller must ensure this pointer is valid and points to a sufficiently large buffer. The function updates this pointer to the end of the written data.
    - `out_buf_sz`: A pointer to an unsigned long representing the size of the output buffer. The function updates this value to reflect the remaining size after writing.
    - `buf`: A pointer to the input buffer containing QUIC frames to be formatted. This buffer must not be null and should contain valid frame data.
    - `buf_sz`: The size of the input buffer in bytes. It must be greater than zero for the function to process the frames.
- **Output**: Returns the number of bytes processed from the input buffer. If a frame cannot be parsed, the function returns the number of bytes processed up to the error point.
- **See Also**: [`fd_quic_pretty_print_frames`](<#fd_quic_pretty_print_frames>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)