<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for managing QUIC streams, including buffer operations, stream creation, and context handling.

# Purpose
The code provides functionality for managing QUIC streams, specifically focusing on buffer operations and stream lifecycle management. It includes functions for storing and loading data in a circular buffer, which is used to handle data transmission in a QUIC stream. The [`fd_quic_buffer_store`](<#fd_quic_buffer_store>) and [`fd_quic_buffer_load`](<#fd_quic_buffer_load>) functions manage data storage and retrieval from the buffer, ensuring that data is correctly handled even when it wraps around the end of the buffer.

Additionally, the code defines functions for creating and deleting QUIC streams. The [`fd_quic_stream_new`](<#fd_quic_stream_new>) function initializes a new stream, allocating memory for the stream's transmission buffer and acknowledgment buffer, and setting up the stream's initial state. The [`fd_quic_stream_delete`](<#fd_quic_stream_delete>) function handles the cleanup of a stream, ensuring it is removed from any lists it may be part of. The code also provides functions to set and get a user-defined context associated with a stream, allowing for additional data to be linked to a stream instance. This code is part of a larger system that manages QUIC connections and streams, and it is intended to be used as a library component within that system.
# Imports and Dependencies

---
- `fd_quic_stream.h`
- `fd_quic_enum.h`


# Functions

---
### fd\_quic\_buffer\_store<!-- {{#callable:fd_quic_buffer_store}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_stream.c#L7>)

Stores data into a circular buffer if there is enough space available.
- **Inputs**:
    - ``buf``: A pointer to the `fd_quic_buffer_t` structure representing the circular buffer where data will be stored.
    - ``data``: A pointer to the data to be stored in the buffer.
    - ``data_sz``: The size of the data to be stored, in bytes.
- **Logic and Control Flow**:
    - Calculate the current used and free space in the buffer using the `head` and `tail` pointers.
    - Check if there is enough free space to store the data; if not, return immediately.
    - Determine if the data can fit into the contiguous free space at the `mhead` position or if it needs to be split between the end and the beginning of the buffer.
    - If the data fits in the contiguous space, use `fd_memcpy` to copy the data directly.
    - If the data needs to be split, copy the first part to the end of the buffer and the remaining part to the beginning of the buffer using `fd_memcpy`.
- **Output**: No output is returned; the function modifies the buffer in place.


---
### fd\_quic\_buffer\_load<!-- {{#callable:fd_quic_buffer_load}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_stream.c#L54>)

Loads data from a circular buffer into a specified memory location.
- **Inputs**:
    - ``buf``: A pointer to the `fd_quic_buffer_t` structure representing the circular buffer.
    - ``offs``: An unsigned long integer representing the offset from which to start loading data in the buffer.
    - ``data``: A pointer to an unsigned character array where the loaded data will be stored.
    - ``data_sz``: An unsigned long integer representing the size of the data to load.
- **Logic and Control Flow**:
    - Calculate `mtail` and `mhead` as the masked values of `tail` and `head` respectively, using the buffer's capacity minus one as the mask.
    - Check if the operation is valid by ensuring `tail` is not greater than `head` and `offs` is not less than `buf->tail`; if invalid, return immediately.
    - Determine if the data fits within the free contiguous space at `mtail` or if it needs to be split across the buffer's end and start.
    - If `mtail` is greater than or equal to `mhead`, handle the case where the free space is split; calculate `end_sz` as the space from `mtail` to the end of the buffer.
    - If `data_sz` is less than or equal to `end_sz`, copy the data entirely from the end of the buffer; otherwise, split the copy operation between the end and the start of the buffer.
    - If `mtail` is less than `mhead`, copy the data contiguously from `mtail`.
- **Output**: The function does not return a value; it performs the operation of loading data into the provided `data` buffer.


---
### fd\_quic\_stream\_footprint<!-- {{#callable:fd_quic_stream_footprint}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_stream.c#L98>)

Calculates the memory footprint required for a QUIC stream based on the given transmission buffer size.
- **Inputs**:
    - `tx_buf_sz`: The size of the transmission buffer in bytes, which must be a power of two.
- **Logic and Control Flow**:
    - Check if `tx_buf_sz` is a power of two using `fd_ulong_is_pow2`; if not, return 0.
    - Retrieve the alignment size using `fd_quic_stream_align()`.
    - Initialize `offs` to 0 to accumulate the total memory footprint.
    - Calculate `tx_ack_sz` as one-eighth of `tx_buf_sz`.
    - Align the size of `fd_quic_stream_t`, `tx_ack_sz`, and `tx_buf_sz` to the alignment size using `fd_ulong_align_up`.
    - Add the aligned sizes of the stream instance, transmission buffer, and acknowledgment buffer to `offs`.
    - Return the total memory footprint stored in `offs`.
- **Output**: The total memory footprint in bytes required for the QUIC stream, or 0 if `tx_buf_sz` is not a power of two.
- **Functions Called**:
    - [`fd_quic_stream_align`](<fd_quic_stream.h.md#fd_quic_stream_align>)


---
### fd\_quic\_stream\_new<!-- {{#callable:fd_quic_stream_new}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_stream.c#L123>)

Initializes a new QUIC stream with allocated memory for transmission buffers and acknowledgment buffers.
- **Inputs**:
    - `mem`: A pointer to memory aligned to [`fd_quic_stream_align`](<fd_quic_stream.h.md#fd_quic_stream_align>) and at least `fd_quic_stream_footprint(tx_buf_sz)` bytes in size.
    - `conn`: A pointer to an `fd_quic_conn_t` connection object associated with the stream.
    - `tx_buf_sz`: The size of the transmission buffer for the stream.
- **Logic and Control Flow**:
    - Calculate alignment size using [`fd_quic_stream_align`](<fd_quic_stream.h.md#fd_quic_stream_align>).
    - Determine the size of the acknowledgment buffer as one-eighth of `tx_buf_sz`.
    - Align the sizes of the stream, transmission buffer, and acknowledgment buffer using `fd_ulong_align_up`.
    - Initialize the stream object at the base memory address `mem`.
    - Allocate memory for the transmission buffer and set its capacity.
    - Allocate memory for the acknowledgment buffer.
    - Verify that the total allocated size matches the expected footprint using [`fd_quic_stream_footprint`](<#fd_quic_stream_footprint>).
    - Set the connection and stream ID for the stream.
    - Initialize the stream's `next` and `prev` pointers to point to itself, indicating it is not part of any list.
    - Return the initialized stream object.
- **Output**: A pointer to the newly initialized `fd_quic_stream_t` stream object.
- **Functions Called**:
    - [`fd_quic_stream_align`](<fd_quic_stream.h.md#fd_quic_stream_align>)
    - [`fd_quic_stream_footprint`](<#fd_quic_stream_footprint>)


---
### fd\_quic\_stream\_delete<!-- {{#callable:fd_quic_stream_delete}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_stream.c#L168>)

Removes a QUIC stream from any list by setting its `next` and `prev` pointers to itself and marking it as not a member of any list.
- **Inputs**:
    - `stream`: A pointer to the `fd_quic_stream_t` structure representing the QUIC stream to delete.
- **Logic and Control Flow**:
    - Set the `next` pointer of the `stream` to point to itself.
    - Set the `prev` pointer of the `stream` to point to itself.
    - Set the `list_memb` field of the `stream` to `FD_QUIC_STREAM_LIST_MEMB_NONE` to indicate it is not part of any list.
- **Output**: No return value.


---
### fd\_quic\_stream\_set\_context<!-- {{#callable:fd_quic_stream_set_context}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_stream.c#L181>)

Associates a user-defined context with a QUIC stream.
- **Inputs**:
    - `stream`: A pointer to an `fd_quic_stream_t` structure representing the QUIC stream.
    - `context`: A pointer to the user-defined context to associate with the stream.
- **Logic and Control Flow**:
    - Assigns the `context` pointer to the `context` field of the `stream` structure.
- **Output**: No return value.


---
### fd\_quic\_stream\_get\_context<!-- {{#callable:fd_quic_stream_get_context}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_stream.c#L194>)

Retrieves the user-defined context associated with a given QUIC stream.
- **Inputs**:
    - `stream`: A pointer to an `fd_quic_stream_t` structure from which to obtain the context.
- **Logic and Control Flow**:
    - Accesses the `context` member of the `fd_quic_stream_t` structure pointed to by `stream`.
    - Returns the value of the `context` member.
- **Output**: A pointer to the user-defined context associated with the specified stream.


# Function Declarations (Public API)

---
### fd\_quic\_stream\_align<!-- {{#callable_declaration:fd_quic_stream_align}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_stream.c#L94>)

Returns the required memory alignment for QUIC streams.
- **Description**: Use this function to obtain the memory alignment requirement for QUIC streams. This alignment value is necessary when allocating memory for QUIC stream operations to ensure proper data structure alignment. It is important to use this function before allocating memory for QUIC streams to avoid misalignment issues.
- **Inputs**: None
- **Output**: Returns an unsigned long integer representing the alignment size, which is 128 bytes.
- **See Also**: [`fd_quic_stream_align`](<fd_quic_stream.h.md#fd_quic_stream_align>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)