<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines QUIC v1 crypto suites, structures, and functions for key generation, encryption, and decryption.

# Purpose
The code defines cryptographic functionalities for QUIC (Quick UDP Internet Connections) version 1, focusing on the implementation of cryptographic suites and key management. It includes definitions for various cryptographic suites used in QUIC, such as `TLS_AES_128_GCM_SHA256` and `TLS_CHACHA20_POLY1305_SHA256`, and excludes certain suites that are not applicable according to the RFC 9001 specifications. The code provides structures and functions to manage cryptographic keys and secrets, including the generation of initial secrets and keys, key updates, and encryption and decryption of QUIC packets.

Key components include the `fd_quic_crypto_keys_t` and `fd_quic_crypto_secrets_t` structures, which store cryptographic keys and secrets, respectively. Functions such as [`fd_quic_gen_initial_secrets`](<#fd_quic_gen_initial_secrets>), [`fd_quic_gen_keys`](<#fd_quic_gen_keys>), and [`fd_quic_key_update_derive`](<#fd_quic_key_update_derive>) handle the derivation and update of cryptographic keys and secrets. The code also includes functions for encrypting and decrypting QUIC packets and headers, ensuring secure communication. The header file is intended to be included in other C files, providing a public API for cryptographic operations in a QUIC implementation.
# Imports and Dependencies

---
- `../fd_quic_enum.h`
- `../../../ballet/aes/fd_aes_gcm.h`


# Data Structures

---
### fd\_quic\_crypto\_keys\_t
- **Type**: ``struct``
- **Members**:
    - `pkt_key`: An array of unsigned characters used as the packet protection key.
    - `iv`: An array of unsigned characters used as the initialization vector for encryption.
    - `hp_key`: An array of unsigned characters used as the header protection key.
- **Description**: Defines the cryptographic keys used for packet protection in the QUIC protocol, including keys for packet encryption, initialization vector, and header protection.


---
### fd\_quic\_crypto\_secrets\_t
- **Type**: ``struct``
- **Members**:
    - ``initial_secret``: An array of unsigned characters that stores the initial secret for QUIC encryption.
    - ``secret``: A 3D array of unsigned characters that stores secrets for each encryption level and direction.
    - ``new_secret``: A 2D array of unsigned characters that stores new secrets for key updates.
- **Description**: Manages cryptographic secrets for QUIC encryption, including initial secrets, secrets for different encryption levels and directions, and new secrets for key updates.


---
### fd\_quic\_crypto\_keys
- **Type**: ``struct``
- **Members**:
    - ``pkt_key``: An array of unsigned characters used as the packet protection key.
    - ``iv``: An array of unsigned characters used as the initialization vector for encryption.
    - ``hp_key``: An array of unsigned characters used as the header protection key.
- **Description**: Defines the cryptographic keys used for packet protection in QUIC, including keys for packet encryption, initialization vector, and header protection.


---
### fd\_quic\_crypto\_secrets
- **Type**: ``struct``
- **Members**:
    - ``initial_secret``: An array to store the initial secret used in QUIC encryption.
    - ``secret``: A 3D array to store secrets for each encryption level and direction (incoming or outgoing).
    - ``new_secret``: A 2D array to store new secrets for key updates.
- **Description**: Manages cryptographic secrets for QUIC protocol, including initial secrets, secrets for different encryption levels and directions, and new secrets for key updates.


# Functions

---
### fd\_quic\_get\_nonce<!-- {{#callable:fd_quic_get_nonce}} -->
[View Source →](<../../../../../../src/waltz/quic/crypto/fd_quic_crypto_suites.h#L239>)

Generates a nonce by XORing the QUIC IV with the lower 62 bits of the packet number.
- **Inputs**:
    - `nonce`: A pointer to a buffer where the generated nonce will be stored.
    - `iv`: A pointer to the initialization vector (IV) used in the nonce generation.
    - `pkt_number`: The packet number used in the nonce generation, which will be masked to 62 bits.
- **Logic and Control Flow**:
    - Copy the first 4 bytes of the `iv` to the `nonce` buffer.
    - Load the next 8 bytes from the `iv` starting at the 5th byte.
    - Mask the `pkt_number` to retain only the lower 62 bits.
    - Byte-swap the masked `pkt_number` to match the endianness.
    - XOR the byte-swapped `pkt_number` with the loaded 8 bytes from the `iv`.
    - Store the result in the `nonce` buffer starting at the 5th byte.
- **Output**: The function does not return a value; it modifies the `nonce` buffer in place.


# Function Declarations (Public API)

---
### fd\_quic\_gen\_initial\_secrets<!-- {{#callable_declaration:fd_quic_gen_initial_secrets}} -->
[View Source →](<../../../../../../src/waltz/quic/crypto/fd_quic_crypto_suites.h#L101>)

Generates initial cryptographic secrets for a QUIC connection.
- **Description**: Use this function to initialize the cryptographic secrets for a QUIC connection based on a given connection ID. This function must be called before any cryptographic operations are performed on the connection. It sets the initial secret and the initial incoming and outgoing secrets in the `fd_quic_crypto_secrets_t` structure. The function distinguishes between client and server roles using the `is_server` parameter, which affects the assignment of read and write secrets. Ensure that the `secrets` parameter is a valid pointer to a `fd_quic_crypto_secrets_t` structure, and that `conn_id` is a valid pointer to a connection ID of size `conn_id_sz`.
- **Inputs**:
    - `secrets`: A pointer to an `fd_quic_crypto_secrets_t` structure where the generated secrets will be stored. Must not be null.
    - `conn_id`: A pointer to a buffer containing the connection ID. Must not be null.
    - `conn_id_sz`: The size of the connection ID in bytes. Must be a valid size for the connection ID.
    - `is_server`: An integer indicating the role of the QUIC instance. Use 1 for server and 0 for client.
- **Output**: None
- **See Also**: [`fd_quic_gen_initial_secrets`](<fd_quic_crypto_suites.c.md#fd_quic_gen_initial_secrets>)  (Implementation)


---
### fd\_quic\_gen\_keys<!-- {{#callable_declaration:fd_quic_gen_keys}} -->
[View Source →](<../../../../../../src/waltz/quic/crypto/fd_quic_crypto_suites.h#L121>)

Derives cryptographic keys from a given secret.
- **Description**: Use this function to derive a packet protection key, a header protection key, and an initialization vector (IV) from a 32-byte secret. This function fully initializes the `fd_quic_crypto_keys_t` structure with the derived keys. It is typically called twice per encryption level, once for incoming keys and once for outgoing keys. Ensure that the `keys` parameter points to a valid `fd_quic_crypto_keys_t` structure and that the `secret` array contains exactly 32 bytes.
- **Inputs**:
    - `keys`: A pointer to an `fd_quic_crypto_keys_t` structure where the derived keys will be stored. Must not be null.
    - `secret`: A constant array of 32 bytes used as the input secret for key derivation. Must contain exactly 32 bytes.
- **Output**: None
- **See Also**: [`fd_quic_gen_keys`](<fd_quic_crypto_suites.c.md#fd_quic_gen_keys>)  (Implementation)


---
### fd\_quic\_key\_update\_derive<!-- {{#callable_declaration:fd_quic_key_update_derive}} -->
[View Source →](<../../../../../../src/waltz/quic/crypto/fd_quic_crypto_suites.h#L142>)

Derives new IVs and packet protection keys for key updates.
- **Description**: Use this function to derive the next set of IVs and packet protection keys during a key update in a QUIC connection. This function does not update header protection keys. It is important for maintaining secure communication by periodically rotating keys. Ensure that the `secrets` parameter contains valid current secrets before calling this function. The function updates the `new_keys` array with the derived keys for both incoming and outgoing directions.
- **Inputs**:
    - `secrets`: A pointer to `fd_quic_crypto_secrets_t` containing the current secrets. Must not be null and must have valid data for the function to derive new keys.
    - `new_keys`: An array of two `fd_quic_crypto_keys_t` structures where the function will store the derived keys. The caller must allocate this array before calling the function.
- **Output**: None
- **See Also**: [`fd_quic_key_update_derive`](<fd_quic_crypto_suites.c.md#fd_quic_key_update_derive>)  (Implementation)


---
### fd\_quic\_crypto\_encrypt<!-- {{#callable_declaration:fd_quic_crypto_encrypt}} -->
[View Source →](<../../../../../../src/waltz/quic/crypto/fd_quic_crypto_suites.h#L166>)

Encrypts a QUIC packet with header and payload protection.
- **Description**: Use this function to encrypt a QUIC packet according to RFC 9001 standards, which includes both packet and header protection. Ensure that the output buffer is large enough to accommodate the encrypted data, which includes the header, payload, and a tag. The function requires valid encryption keys for both packet and header protection. It returns a success or failure status based on the operation's outcome.
- **Inputs**:
    - `out`: A pointer to the buffer where the encrypted packet will be stored. The buffer must be large enough to hold the header, payload, and tag. The caller retains ownership.
    - `out_sz`: A pointer to a variable that initially contains the size of the output buffer. On return, it will contain the size of the written encrypted data. The caller retains ownership.
    - `hdr`: A pointer to the plain text header of the packet. Must not be null. The caller retains ownership.
    - `hdr_sz`: The size of the input header in bytes. Must be at least 4 and not exceed INT_MAX.
    - `pkt`: A pointer to the plain text payload of the packet. Must not be null. The caller retains ownership.
    - `pkt_sz`: The size of the input payload in bytes. Must not exceed INT_MAX.
    - `pkt_keys`: A pointer to the `fd_quic_crypto_keys_t` structure containing the packet protection keys. Must not be null. The caller retains ownership.
    - `hp_keys`: A pointer to the `fd_quic_crypto_keys_t` structure containing the header protection keys. Must not be null. The caller retains ownership.
    - `pkt_number`: The packet number used in the encryption process. Must be a valid unsigned long value.
- **Output**: Returns `FD_QUIC_SUCCESS` if encryption succeeds, otherwise returns `FD_QUIC_FAILED`. The `out_sz` is updated with the size of the encrypted data.
- **See Also**: [`fd_quic_crypto_encrypt`](<fd_quic_crypto_suites.c.md#fd_quic_crypto_encrypt>)  (Implementation)


---
### fd\_quic\_crypto\_decrypt<!-- {{#callable_declaration:fd_quic_crypto_decrypt}} -->
[View Source →](<../../../../../../src/waltz/quic/crypto/fd_quic_crypto_suites.h#L200>)

Decrypts a QUIC protected packet.
- **Description**: Use this function to decrypt a QUIC packet that contains a decrypted header, an encrypted payload, and an authentication tag. Ensure the buffer is large enough to hold the packet, including the authentication tag of size `FD_QUIC_CRYPTO_TAG_SZ`. The function requires the offset of the packet number within the ciphertext, which must be determined from unprotected header data. It returns a success or failure status based on the decryption outcome.
- **Inputs**:
    - `buf`: A buffer containing a QUIC packet with a decrypted header, encrypted payload, and an authentication tag. The buffer must be large enough to hold the entire packet, including the authentication tag. On return, the payload will be decrypted.
    - `buf_sz`: The size of the QUIC packet in the buffer. It must be at least `FD_QUIC_SHORTEST_PKT`.
    - `pkt_number_off`: The offset of the packet number within the ciphertext. This must be determined from unprotected header data.
    - `pkt_number`: The packet number used in the decryption process. It is used to calculate the nonce.
    - `keys`: A pointer to `fd_quic_crypto_keys_t` containing the keys needed for decryption. The caller retains ownership of this pointer.
- **Output**: Returns `FD_QUIC_SUCCESS` if decryption succeeds, otherwise returns `FD_QUIC_FAILED`.
- **See Also**: [`fd_quic_crypto_decrypt`](<fd_quic_crypto_suites.c.md#fd_quic_crypto_decrypt>)  (Implementation)


---
### fd\_quic\_crypto\_decrypt\_hdr<!-- {{#callable_declaration:fd_quic_crypto_decrypt_hdr}} -->
[View Source →](<../../../../../../src/waltz/quic/crypto/fd_quic_crypto_suites.h#L231>)

Decrypts a QUIC packet header by removing header protection.
- **Description**: Use this function to decrypt the header of a QUIC packet by removing the header protection. This function should be called when you need to access the unprotected header of a QUIC packet while keeping the payload encrypted. Ensure that the buffer size is sufficient and that the packet number offset is correctly determined from unprotected header data. The function requires valid decryption keys and will return an error if the buffer is too small or if decryption fails.
- **Inputs**:
    - `buf`: A pointer to a buffer containing an encrypted QUIC packet. The buffer must not be null and must have enough space to hold the packet. On return, the header is decrypted, but the rest of the packet remains encrypted.
    - `buf_sz`: The size of the buffer in bytes. It must be at least `FD_QUIC_CRYPTO_TAG_SZ` and larger than the packet number offset plus the sample size.
    - `pkt_number_off`: The offset of the packet number within the cipher text. This must be determined from unprotected header data and must be less than `buf_sz`.
    - `keys`: A pointer to `fd_quic_crypto_keys_t` containing the keys needed for decryption. This must not be null and must be properly initialized before calling the function.
- **Output**: Returns `FD_QUIC_SUCCESS` if the header is successfully decrypted, or `FD_QUIC_FAILED` if an error occurs, such as insufficient buffer size or decryption failure.
- **See Also**: [`fd_quic_crypto_decrypt_hdr`](<fd_quic_crypto_suites.c.md#fd_quic_crypto_decrypt_hdr>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)