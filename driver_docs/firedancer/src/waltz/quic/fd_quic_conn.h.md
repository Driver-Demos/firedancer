<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Header file defining structures, constants, and functions for managing QUIC connections.

# Purpose
The code is a C header file that defines structures, constants, and functions related to managing QUIC (Quick UDP Internet Connections) connections. It provides a detailed implementation of a QUIC connection, including state management, error handling, and data transmission. The file includes several header files that are likely part of a larger QUIC library, indicating that it is designed to be part of a comprehensive system for handling QUIC connections.

Key components of the code include the `fd_quic_conn` structure, which encapsulates the state and metadata of a QUIC connection, and the `fd_quic_conn_stream_rx` structure, which manages the reception of data streams. The file defines various connection states and reason codes for connection termination, which are used to manage the lifecycle of a connection. It also provides functions for initializing, clearing, and managing connection objects, as well as utility functions for handling connection identifiers. The header file is intended to be included in other C source files that implement or utilize QUIC connections, providing a public API for managing these connections within the broader QUIC protocol implementation.
# Imports and Dependencies

---
- `fd_quic.h`
- `fd_quic_common.h`
- `fd_quic_ack_tx.h`
- `fd_quic_stream.h`
- `fd_quic_conn_id.h`
- `crypto/fd_quic_crypto_suites.h`
- `fd_quic_pkt_meta.h`
- `fd_quic_svc_q.h`
- `../fd_rtt_est.h`


# Data Structures

---
### fd\_quic\_conn\_stream\_rx
- **Type**: ``struct``
- **Members**:
    - `rx_hi_stream_id`: Highest RX stream ID sent by peer plus 4.
    - `rx_sup_stream_id`: Highest allowed RX stream ID plus 4.
    - `rx_max_data`: Limit on the number of bytes the peer is allowed to send.
    - `rx_tot_data`: Total of all bytes received across all streams, including implied bytes.
    - `rx_max_data_ackd`: Maximum `max_data` acknowledged by peer.
    - `rx_max_streams_unidir_ackd`: Value of `MAX_STREAMS` acknowledged for unidirectional streams.
    - `rx_streams_active`: User scratch field, not in use by `fd_quic`.
- **Description**: Manages the state and limits of data reception for a QUIC connection stream, including tracking the highest stream IDs, data limits, and acknowledgment states.


---
### fd\_quic\_conn\_stream\_rx\_t
- **Type**: ``struct``
- **Members**:
    - `rx_hi_stream_id`: Highest RX stream ID sent by peer plus 4.
    - `rx_sup_stream_id`: Highest allowed RX stream ID plus 4.
    - `rx_max_data`: Limit on the number of bytes the peer can send.
    - `rx_tot_data`: Total bytes received across all streams, including implied bytes.
    - `rx_max_data_ackd`: Maximum `max_data` acknowledged by peer.
    - `rx_max_streams_unidir_ackd`: Value of `MAX_STREAMS` acknowledged for unidirectional streams.
    - `rx_streams_active`: User scratch field, not used by `fd_quic`.
- **Description**: Manages the reception state of QUIC streams, tracking stream IDs, data limits, and acknowledgment states for received data.


---
### fd\_quic\_conn
- **Type**: ``struct``
- **Members**:
    - ``conn_idx``: Connection index that persists across connection clears.
    - ``conn_gen``: Generation of the connection slot that persists across connection clears.
    - ``quic``: Pointer to the QUIC instance associated with the connection.
    - ``context``: User-defined context pointer.
    - ``server``: Indicates the role of the connection: 0 for client, 1 for server.
    - ``established``: Indicates if the connection is established, used by clients.
    - ``transport_params_set``: Indicates if transport parameters are set.
    - ``called_conn_new``: Indicates if `conn_final` needs to be called on teardown.
    - ``visited``: Scratch bit with no strict definition.
    - ``key_phase``: Indicates the current key phase.
    - ``key_update``: Indicates if a key update is needed.
    - ``svc_meta``: Metadata used by the service queue.
    - ``free_conn_next``: Index of the next free connection in a list.
    - ``our_conn_id``: Connection ID for the local endpoint.
    - ``retry_src_conn_id``: Original retry source connection ID for comparison.
    - ``host``: Host network endpoint for source address and port determination.
    - ``peer``: Array of peer network endpoints with connection IDs and IP:port.
    - ``peer_cids``: Array of peer connection IDs.
    - ``initial_source_conn_id``: Initial source connection ID.
    - ``tx_max_datagram_sz``: Maximum datagram size allowed by the peer.
    - ``handshake_complete``: Indicates if the handshake is complete.
    - ``handshake_done_send``: Indicates if handshake-done needs to be sent to the peer.
    - ``handshake_done_ackd``: Indicates if handshake-done was acknowledged.
    - ``tls_hs``: Pointer to TLS handshake data.
    - ``hs_sent_bytes``: Array tracking the amount of handshake data sent.
    - ``hs_ackd_bytes``: Array tracking the amount of handshake data acknowledged by the peer.
    - ``secrets``: Contains master secrets for key derivation.
    - ``keys``: Current keys for each encryption level and direction.
    - ``new_keys``: Application keys for the next key update.
    - ``keys_avail``: Bit set of available keys indexed by encryption level.
    - ``send_streams``: Sentinel for the list of streams needing action.
    - ``used_streams``: Sentinel for the list of used streams.
    - ``tx_next_stream_id``: Stream ID to be used for a new stream.
    - ``tx_sup_stream_id``: Highest allowed TX stream ID plus 4.
    - ``stream_map``: Map from stream ID to stream, persistent across connection clears.
    - ``exp_pkt_number``: Array of expected packet numbers for different spaces.
    - ``pkt_number``: Array of transmitted packet numbers by packet number space.
    - ``last_pkt_number``: Array of the last seen packet numbers.
    - ``ipv4_id``: IPv4 ID field.
    - ``tx_buf_conn``: Buffer for the next transmission, must be at least `FD_QUIC_MAX_UDP_PAYLOAD_SZ`.
    - ``tx_ptr``: Pointer to free space in `tx_buf_conn`.
    - ``state``: Persistent state of the connection.
    - ``reason``: Reason for closing the connection, based on QUIC reason codes.
    - ``app_reason``: Application-specific reason for closing the connection.
    - ``ack_gen``: Acknowledgment generator.
    - ``unacked_sz``: Size of unacknowledged stream frame payload bytes.
    - ``pkt_meta_tracker``: Packet metadata tracker.
    - ``tx_max_data``: Maximum number of bytes allowed to be sent to the peer across all streams.
    - ``tx_tot_data``: Total number of bytes received across all streams, including implied bytes.
    - ``flags``: Flags for various connection states and actions.
    - ``tx_initial_max_stream_data_uni``: Maximum stream data for unidirectional streams.
    - ``upd_pkt_number``: Last transmitted packet number with a max_data frame for this stream.
    - ``peer_enc_level``: Highest peer encryption level.
    - ``idle_timeout_ns``: Idle timeout in nanoseconds.
    - ``last_activity``: Timestamp of the last activity.
    - ``last_ack``: Timestamp of the last acknowledgment.
    - ``let_die_time_ns``: Time after which keep-alive stops.
    - ``rtt``: Round trip time estimate.
    - ``rtt_period_ns``: Bound on time between RTT measurements.
    - ``peer_ack_delay_scale``: Scale to convert peer ACK delay units to nanoseconds.
    - ``peer_max_ack_delay_ns``: Maximum acknowledgment delay from the peer in nanoseconds.
    - ``token_len``: Length of the token.
    - ``token``: Token used for connection retry.
    - ``srx``: Stream receive data structure.
    - ``used_pkt_meta``: Number of used packet metadata entries.
- **Description**: Manages a QUIC connection, handling connection state, encryption, stream management, and flow control. It includes persistent fields for connection identification, user context, and state management. The structure supports handshake operations, packet number tracking, and stream data management. It also manages encryption keys, connection IDs, and network endpoints for both host and peer. The structure facilitates flow control by tracking data limits and stream IDs, and it includes mechanisms for handling connection timeouts and round trip time estimation.


# Functions

---
### fd\_quic\_conn\_uid<!-- {{#callable:fd_quic_conn_uid}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_conn.h#L237>)

Calculates a unique identifier for a QUIC connection using its index and generation.
- **Inputs**:
    - `conn`: A pointer to a constant `fd_quic_conn_t` structure representing the QUIC connection.
- **Logic and Control Flow**:
    - Cast `conn->conn_idx` to `ulong` and shift it left by 32 bits.
    - Cast `conn->conn_gen` to `ulong`.
    - Combine the shifted `conn_idx` and `conn_gen` using a bitwise OR operation.
- **Output**: Returns a `ulong` representing the unique identifier for the connection.


---
### fd\_quic\_conn\_uid\_idx<!-- {{#callable:fd_quic_conn_uid_idx}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_conn.h#L242>)

Extracts the connection index from a 64-bit connection UID by shifting it right by 32 bits.
- **Inputs**:
    - `conn_uid`: A 64-bit unsigned long integer representing the connection UID.
- **Logic and Control Flow**:
    - Shift the `conn_uid` right by 32 bits to isolate the upper 32 bits.
    - Cast the result to a 32-bit unsigned integer.
- **Output**: Returns a 32-bit unsigned integer representing the connection index extracted from the `conn_uid`.


---
### fd\_quic\_conn\_uid\_gen<!-- {{#callable:fd_quic_conn_uid_gen}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_conn.h#L247>)

Extracts the lower 32 bits from a 64-bit connection UID.
- **Inputs**:
    - `conn_uid`: A 64-bit unsigned long integer representing the connection UID.
- **Logic and Control Flow**:
    - Perform a bitwise AND operation between `conn_uid` and `0xffffffffUL` to isolate the lower 32 bits.
    - Cast the result of the bitwise operation to a 32-bit unsigned integer (`uint`).
    - Return the 32-bit unsigned integer as the function's output.
- **Output**: A 32-bit unsigned integer representing the lower 32 bits of the input `conn_uid`.


---
### fd\_quic\_conn\_clear<!-- {{#callable:fd_quic_conn_clear}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_conn.h#L268>)

Clears all non-persistent members of a QUIC connection object while preserving certain persistent fields.
- **Inputs**:
    - ``conn``: A pointer to an `fd_quic_conn_t` structure representing the QUIC connection to clear.
- **Logic and Control Flow**:
    - Store the current values of the persistent fields `quic`, `conn_idx`, `conn_gen`, `state`, and `stream_map` from the `conn` structure.
    - Call `fd_memset` to set all bytes of the `conn` structure to zero, effectively clearing it.
    - Restore the previously stored values of `quic`, `conn_idx`, `conn_gen`, `state`, and `stream_map` back into the `conn` structure.
- **Output**: The function does not return a value; it modifies the `conn` structure in place.


# Function Declarations (Public API)

---
### fd\_quic\_conn\_reason\_name<!-- {{#callable_declaration:fd_quic_conn_reason_name}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_conn.h#L57>)

Returns the name of a QUIC connection reason code.
- **Description**: Use this function to get a human-readable name for a given QUIC connection reason code. This is useful for logging or debugging purposes when you need to interpret the reason codes defined in the QUIC protocol. The function expects a valid reason code as input and returns a string representing the name of the reason. If the input reason code is not valid or not recognized, the function returns "N/A".
- **Inputs**:
    - `reason`: An unsigned integer representing the QUIC connection reason code. Valid values are those defined in the `FD_QUIC_REASON_CODES` macro. If the value is outside the range of defined reason codes, the function returns "N/A".
- **Output**: A constant character pointer to a string representing the name of the reason code. Returns "N/A" if the reason code is invalid or not recognized.
- **See Also**: [`fd_quic_conn_reason_name`](<fd_quic_conn.c.md#fd_quic_conn_reason_name>)  (Implementation)


---
### fd\_quic\_conn\_align<!-- {{#callable_declaration:fd_quic_conn_align}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_conn.h#L253>)

Returns the alignment requirement of a QUIC connection object.
- **Description**: Use this function to obtain the alignment requirement for a `fd_quic_conn_t` object. This is necessary when allocating memory for such objects to ensure proper alignment, which can prevent undefined behavior and improve performance. The function does not require any parameters and can be called at any time.
- **Inputs**: None
- **Output**: The function returns an `ulong` representing the alignment requirement in bytes for a `fd_quic_conn_t` object.
- **See Also**: [`fd_quic_conn_align`](<fd_quic_conn.c.md#fd_quic_conn_align>)  (Implementation)


---
### fd\_quic\_conn\_footprint<!-- {{#callable_declaration:fd_quic_conn_footprint}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_conn.h#L257>)

Returns the memory footprint of a connection object for specified limits.
- **Description**: Use this function to determine the memory size required for a connection object based on the provided limits. This is useful for memory allocation purposes when setting up a new connection. Ensure that the `limits` parameter is correctly initialized before calling this function to avoid undefined behavior.
- **Inputs**:
    - `limits`: A pointer to a `fd_quic_limits_t` structure that specifies the limits for the connection. Must not be null. The structure should be properly initialized before use.
- **Output**: An unsigned long integer representing the memory footprint in bytes for the connection object with the given limits.
- **See Also**: [`fd_quic_conn_footprint`](<fd_quic_conn.c.md#fd_quic_conn_footprint>)  (Implementation)


---
### fd\_quic\_conn\_new<!-- {{#callable_declaration:fd_quic_conn_new}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_conn.h#L262>)

Creates a new QUIC connection object.
- **Description**: Use this function to create and initialize a new QUIC connection object. Ensure that the memory provided is properly aligned and has sufficient space for the connection object. This function must be called with valid pointers for the QUIC context and connection limits. It returns a pointer to the initialized connection object or NULL if any input is invalid or if initialization fails.
- **Inputs**:
    - `mem`: Pointer to memory where the connection object will be created. Must not be null and must be aligned according to the alignment requirements of `fd_quic_conn_t`.
    - `quic`: Pointer to an existing `fd_quic_t` object representing the QUIC context. Must not be null.
    - `limits`: Pointer to a `fd_quic_limits_t` structure defining the limits for the connection. Must not be null.
- **Output**: Returns a pointer to the newly created `fd_quic_conn_t` object, or NULL if any input is invalid or if initialization fails.
- **See Also**: [`fd_quic_conn_new`](<fd_quic_conn.c.md#fd_quic_conn_new>)  (Implementation)


---
### fd\_quic\_conn\_set\_context<!-- {{#callable_declaration:fd_quic_conn_set_context}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_conn.h#L286>)

Set a user-defined context for a QUIC connection.
- **Description**: Use this function to associate a user-defined context with a QUIC connection. This context can be any pointer-sized data that the user wants to associate with the connection for later retrieval. It is important to ensure that the connection object is valid and properly initialized before calling this function. The function does not perform any validation on the context pointer itself, so it is the caller's responsibility to ensure that the context is valid and remains valid for the duration of its use.
- **Inputs**:
    - `conn`: A pointer to a `fd_quic_conn_t` structure representing the QUIC connection. Must not be null and must point to a valid, initialized connection object.
    - `context`: A pointer to user-defined data to associate with the connection. The function does not validate this pointer, so it is the caller's responsibility to ensure its validity.
- **Output**: None
- **See Also**: [`fd_quic_conn_set_context`](<fd_quic_conn.c.md#fd_quic_conn_set_context>)  (Implementation)


---
### fd\_quic\_conn\_get\_context<!-- {{#callable_declaration:fd_quic_conn_get_context}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_conn.h#L290>)

Retrieves the user-defined context from a connection.
- **Description**: Use this function to obtain the context associated with a specific QUIC connection. This context is user-defined and can store any data relevant to the connection. Ensure that the connection object is valid before calling this function to avoid undefined behavior.
- **Inputs**:
    - `conn`: A pointer to a `fd_quic_conn_t` structure representing the connection. Must not be null. The caller retains ownership of the connection object.
- **Output**: Returns a pointer to the user-defined context associated with the connection.
- **See Also**: [`fd_quic_conn_get_context`](<fd_quic_conn.c.md#fd_quic_conn_get_context>)  (Implementation)


---
### fd\_quic\_conn\_validate\_init<!-- {{#callable_declaration:fd_quic_conn_validate_init}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_conn.h#L295>)

Sets all connections to not visited for validation.
- **Description**: Use this function to reset the 'visited' status of all connections managed by the given QUIC instance. This is typically done as a preparatory step before performing validation operations on the connections. Ensure that the `quic` parameter is a valid pointer to an initialized `fd_quic_t` structure.
- **Inputs**:
    - `quic`: A pointer to an `fd_quic_t` structure representing the QUIC instance. Must not be null. The function assumes this structure is properly initialized and contains valid connection data.
- **Output**: None
- **See Also**: [`fd_quic_conn_validate_init`](<fd_quic_conn.c.md#fd_quic_conn_validate_init>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)