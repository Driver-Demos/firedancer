<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

APIs for QUIC v1 Retry mechanism, Retry Integrity Tag, and a non-standard retry token scheme.

# Purpose
The `fd_quic_retry.h` file is a C header file that defines APIs and data structures for handling the QUIC v1 Retry mechanism as specified in RFC 9000 and the QUIC-TLS v1 Retry Integrity Tag as specified in RFC 9001. It also includes a custom retry token scheme that is loosely based on a draft specification but is not compatible with it. The file provides functionality for creating and verifying retry integrity tags and tokens, which are essential for the QUIC protocol's retry process. The retry integrity tag is generated using the AES-128-GCM algorithm, and it serves as a mechanism to ensure the integrity of retry packets, although it functions more like a hash than a secure encryption.

The file defines several key components, including the `fd_quic_retry_data_t` and `fd_quic_retry_token_t` structures, which encode data within the QUIC Retry token and the token itself, respectively. Functions such as [`fd_quic_retry_integrity_tag_sign`](<#fd_quic_retry_integrity_tag_sign>) and [`fd_quic_retry_integrity_tag_verify`](<#fd_quic_retry_integrity_tag_verify>) are used to sign and verify the integrity tags, while [`fd_quic_retry_token_sign`](<#fd_quic_retry_token_sign>) and [`fd_quic_retry_token_verify`](<#fd_quic_retry_token_verify>) handle the creation and verification of retry tokens. The file also includes functions for creating and verifying retry packets on the server side, such as [`fd_quic_retry_create`](<#fd_quic_retry_create>) and [`fd_quic_retry_server_verify`](<#fd_quic_retry_server_verify>). These components and functions are crucial for implementing the retry mechanism in QUIC, ensuring that retry packets are authenticated and integrity-checked as part of the connection establishment process.
# Imports and Dependencies

---
- `fd_quic_conn_id.h`
- `fd_quic_enum.h`
- `fd_quic_proto_structs.h`
- `crypto/fd_quic_crypto_suites.h`
- `../../ballet/aes/fd_aes_gcm.h`


# Global Variables

---
### struct
- **Type**: `struct`
- **Description**: Represents the data structure used to encode information within a QUIC Retry token. It contains fields that store claims about the client, such as a magic number, a pseudorandom token ID, the client's IP address, UDP port, expiration time, and connection IDs.
- **Use**: Used to store and manage client-related data for the QUIC Retry token authentication process.


---
### FD\_PROTOTYPES\_BEGIN
- **Type**: `FD_PROTOTYPES_BEGIN`
- **Description**: Marks the beginning of a section in the code where function prototypes are declared. It is used to organize and separate different parts of the code for clarity and maintainability.
- **Use**: Used to indicate the start of a block of function prototypes in the source code.


# Data Structures

---
### fd\_quic\_retry\_data\_t
- **Type**: ``struct``
- **Members**:
    - ``magic``: A `ushort` that serves as a magic number to identify the structure, set to `0xdaa5`.
    - ``token_id``: A 12-byte array that holds a pseudorandom, guessable identifier for the token.
    - ``ip6_addr``: A 16-byte array that stores the source IPv6 or IPv4-mapped IPv6 address in network byte order.
    - ``udp_port``: A `ushort` that represents the source UDP port in host byte order.
    - ``expire_comp``: A `ulong` that indicates the expiration time of the token, calculated as `unix_nanos>>22`.
    - ``rscid``: A `ulong` that holds the Retry Source Connection ID.
    - ``odcid``: A 20-byte array that contains the Original Destination Connection ID.
    - ``odcid_sz``: A `uchar` that specifies the size of `odcid`, ranging from 1 to 20.
- **Description**: Encodes data within the QUIC Retry token, containing claims about the client such as a magic number, token identifier, IP address, UDP port, expiration time, and connection IDs. This structure is used to authenticate and manage retry tokens in the QUIC protocol, ensuring secure and stateless handling of retries.


---
### fd\_quic\_retry\_token
- **Type**: ``struct``
- **Members**:
    - ``data``: A union member that holds `fd_quic_retry_data_t` which encodes data within the QUIC Retry token.
    - ``data_opaque``: A union member that holds an opaque byte array of the same size as `fd_quic_retry_data_t`.
    - ``mac_tag``: An array of bytes that stores the message authentication code (MAC) tag for the retry token.
- **Description**: Encodes the QUIC Retry token, which is used in the QUIC protocol to authenticate retry packets. It contains a union that can store either structured retry data or an opaque byte array, and a MAC tag for authentication purposes. The structure is part of a mechanism to handle retries safely and statelessly by authenticating the token itself using a construction similar to a HMAC scheme with AES-GCM.


---
### fd\_quic\_retry\_token\_t
- **Type**: ``struct``
- **Members**:
    - ``data``: Contains the `fd_quic_retry_data_t` structure, which encodes data within the QUIC Retry token.
    - ``data_opaque``: An array of `uchar` that is the same size as `fd_quic_retry_data_t`, used for opaque data handling.
    - ``mac_tag``: An array of `uchar` with size `FD_AES_GCM_TAG_SZ`, used to store the message authentication code tag.
- **Description**: Encodes the QUIC Retry token, which is used in the QUIC protocol to handle retry mechanisms securely. It includes a union that either holds the `fd_quic_retry_data_t` structure or an opaque byte array of the same size, and a `mac_tag` for authentication purposes. This structure is part of a non-standard implementation to authenticate retry tokens using AES-GCM.


# Functions

---
### fd\_quic\_retry\_integrity\_tag\_sign<!-- {{#callable:fd_quic_retry_integrity_tag_sign}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_retry.h#L23>)

Generates a Message Authentication Code (MAC) for a given pseudo-packet using AES-128-GCM encryption.
- **Inputs**:
    - ``aes_gcm``: A pointer to an `fd_aes_gcm_t` structure used for AES-GCM encryption.
    - ``retry_pseudo_pkt``: A pointer to the byte array representing the pseudo-packet to be signed.
    - ``retry_pseudo_pkt_len``: The length of the `retry_pseudo_pkt` byte array.
    - ``retry_integrity_tag``: An array where the generated integrity tag (MAC) will be stored.
- **Logic and Control Flow**:
    - Initialize the AES-GCM context using the predefined key and nonce by calling `fd_aes_128_gcm_init` with `aes_gcm`, `FD_QUIC_RETRY_INTEGRITY_TAG_KEY`, and `FD_QUIC_RETRY_INTEGRITY_TAG_NONCE`.
    - Encrypt the `retry_pseudo_pkt` using `fd_aes_gcm_encrypt`, which writes the resulting integrity tag into `retry_integrity_tag`.
- **Output**: No return value; the function writes the integrity tag directly into the `retry_integrity_tag` array.


---
### fd\_quic\_retry\_integrity\_tag\_verify<!-- {{#callable:fd_quic_retry_integrity_tag_verify}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_retry.h#L59>)

Verifies the integrity of a QUIC retry packet using AES-128-GCM decryption.
- **Inputs**:
    - ``aes_gcm``: A pointer to an `fd_aes_gcm_t` structure used for AES-GCM operations.
    - ``retry_pseudo_pkt``: A pointer to the retry pseudo packet data to verify.
    - ``retry_pseudo_pkt_len``: The length of the retry pseudo packet data.
    - ``retry_integrity_tag``: A 16-byte array containing the retry integrity tag to verify against.
- **Logic and Control Flow**:
    - Initialize the AES-GCM context with a predefined key and nonce using `fd_aes_128_gcm_init`.
    - Attempt to decrypt the `retry_pseudo_pkt` using `fd_aes_gcm_decrypt` with the provided integrity tag.
    - Return `FD_QUIC_SUCCESS` if decryption is successful, otherwise return `FD_QUIC_FAILED`.
- **Output**: Returns `FD_QUIC_SUCCESS` if the integrity tag is valid, otherwise returns `FD_QUIC_FAILED`.


---
### fd\_quic\_retry\_data\_set\_ip4<!-- {{#callable:fd_quic_retry_data_set_ip4}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_retry.h#L139>)

Sets the IPv4 address in the `fd_quic_retry_data_t` structure as an IPv4-mapped IPv6 address.
- **Inputs**:
    - ``data``: A pointer to an `fd_quic_retry_data_t` structure where the IP address will be set.
    - ``ip4_addr``: An unsigned integer representing the IPv4 address in big-endian order.
- **Logic and Control Flow**:
    - Set the first 10 bytes of `data->ip6_addr` to 0x00 using `memset`.
    - Set the next 2 bytes of `data->ip6_addr` to 0xFF using `memset`.
    - Store the `ip4_addr` in the last 4 bytes of `data->ip6_addr` using `FD_STORE`.
    - Return the modified `data` pointer.
- **Output**: Returns a pointer to the modified `fd_quic_retry_data_t` structure.


---
### fd\_quic\_retry\_token\_sign<!-- {{#callable:fd_quic_retry_token_sign}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_retry.h#L154>)

Generates a MAC tag for a QUIC retry token using AES-GCM encryption with a derived initialization vector.
- **Inputs**:
    - ``token``: A pointer to `fd_quic_retry_token_t`, which contains the data to be signed and where the MAC tag will be stored.
    - ``aes_gcm``: A pointer to `fd_aes_gcm_t`, which is the AES-GCM encryption context used for signing.
    - ``aes_key``: A constant pointer to an array of unsigned characters representing the AES encryption key.
    - ``aes_iv``: A constant pointer to an array of unsigned characters representing the AES initialization vector.
- **Logic and Control Flow**:
    - Create a 12-byte initialization vector `iv` by XORing each byte of `aes_iv` with the corresponding byte in `token->data.token_id`.
    - Initialize the AES-GCM encryption context `aes_gcm` with the `aes_key` and the derived `iv`.
    - Set `aad` to point to `token->data_opaque`, which is the associated data for encryption.
    - Set `aad_sz` to the size of `fd_quic_retry_data_t`, which is the size of the associated data.
    - Encrypt the associated data using `fd_aes_gcm_encrypt` with the initialized `aes_gcm`, and store the resulting MAC tag in `token->mac_tag`.
- **Output**: The function does not return a value; it outputs the MAC tag directly into `token->mac_tag`.


---
### fd\_quic\_retry\_token\_verify<!-- {{#callable:fd_quic_retry_token_verify}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_retry.h#L173>)

Verifies the validity of a QUIC retry token using AES-GCM decryption.
- **Inputs**:
    - `token`: A pointer to a `fd_quic_retry_token_t` structure containing the token to verify.
    - `aes_gcm`: A pointer to an `fd_aes_gcm_t` structure used for AES-GCM operations.
    - `aes_key`: A pointer to an array of unsigned characters representing the AES key.
    - `aes_iv`: A pointer to an array of unsigned characters representing the AES initialization vector.
- **Logic and Control Flow**:
    - Initialize a 12-byte array `iv` by XORing each byte of `aes_iv` with the corresponding byte in `token->data.token_id`.
    - Call `fd_aes_128_gcm_init` to initialize the AES-GCM context with `aes_key` and the computed `iv`.
    - Set `aad` to point to `token->data_opaque` and `aad_sz` to the size of `fd_quic_retry_data_t`.
    - Call `fd_aes_gcm_decrypt` to attempt decryption using the AES-GCM context, `aad`, `aad_sz`, and `token->mac_tag`.
    - Return `FD_QUIC_SUCCESS` if decryption is successful, otherwise return `FD_QUIC_FAILED`.
- **Output**: Returns `FD_QUIC_SUCCESS` if the token's MAC tag is valid, otherwise returns `FD_QUIC_FAILED`.


# Function Declarations (Public API)

---
### fd\_quic\_retry\_create<!-- {{#callable_declaration:fd_quic_retry_create}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_retry.h#L207>)

Generates a QUIC Retry packet.
- **Description**: Use this function to create a QUIC Retry packet as part of the server-side QUIC protocol handling. It requires a valid QUIC packet, a random number generator, and specific cryptographic parameters. The function must be called with a buffer to store the generated Retry packet, and it returns the size of the created packet. Ensure that the provided buffer is large enough to hold the packet. This function is typically used when a server needs to issue a Retry packet in response to a client's initial connection attempt.
- **Inputs**:
    - `retry`: A buffer to store the generated Retry packet. Must have a size of at least `FD_QUIC_RETRY_LOCAL_SZ`. The caller retains ownership.
    - `pkt`: A pointer to a `fd_quic_pkt_t` structure representing the original QUIC packet. Must not be null.
    - `rng`: A pointer to an `fd_rng_t` structure used for generating random values. Must not be null.
    - `retry_secret`: A constant array of bytes used as the secret key for cryptographic operations. Must have a size of `FD_QUIC_RETRY_SECRET_SZ`.
    - `retry_iv`: A constant array of bytes used as the initialization vector for cryptographic operations. Must have a size of `FD_QUIC_RETRY_IV_SZ`.
    - `orig_dst_conn_id`: A pointer to a `fd_quic_conn_id_t` structure representing the original destination connection ID. Must not be null.
    - `src_conn_id`: A pointer to a `fd_quic_conn_id_t` structure representing the source connection ID. Must not be null.
    - `new_conn_id`: An unsigned long representing the new connection ID to be used in the Retry packet.
    - `expire_at`: A long integer representing the expiration time for the Retry token, in nanoseconds since the Unix epoch.
- **Output**: Returns the size of the generated Retry packet as an unsigned long.
- **See Also**: [`fd_quic_retry_create`](<fd_quic_retry.c.md#fd_quic_retry_create>)  (Implementation)


---
### fd\_quic\_retry\_server\_verify<!-- {{#callable_declaration:fd_quic_retry_server_verify}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_retry.h#L220>)

Verifies a QUIC retry token on the server side.
- **Description**: Use this function to verify the authenticity and validity of a QUIC retry token received by the server. It checks the token's integrity, expiration, and matching criteria against the provided packet and initial data. This function must be called with valid packet and initial structures, and it expects the retry token to conform to specific size and format requirements. The function outputs the original destination connection ID and the retry source connection ID if the verification is successful. Ensure that the `retry_secret` and `retry_iv` are correctly set for the verification process.
- **Inputs**:
    - `pkt`: A pointer to a `fd_quic_pkt_t` structure representing the received packet. Must not be null.
    - `initial`: A pointer to a `fd_quic_initial_t` structure containing the initial connection data. Must not be null and must have valid token and destination connection ID sizes.
    - `orig_dst_conn_id`: A pointer to a `fd_quic_conn_id_t` structure where the original destination connection ID will be stored if verification is successful. Must not be null.
    - `retry_src_conn_id`: A pointer to an `ulong` where the retry source connection ID will be stored if verification is successful. Must not be null.
    - `retry_secret`: An array of `uchar` with size `FD_QUIC_RETRY_SECRET_SZ` containing the secret used for token verification. Must not be null.
    - `retry_iv`: An array of `uchar` with size `FD_QUIC_RETRY_IV_SZ` containing the initialization vector used for token verification. Must not be null.
    - `now`: A `long` representing the current time in nanoseconds. Used to check token expiration.
    - `ttl`: A `long` representing the time-to-live in nanoseconds for the token. Used to determine the expiration window.
- **Output**: Returns `FD_QUIC_SUCCESS` if the token is valid and matches the expected criteria, otherwise returns `FD_QUIC_FAILED`. The function also writes the original destination connection ID and retry source connection ID to the provided output parameters if successful.
- **See Also**: [`fd_quic_retry_server_verify`](<fd_quic_retry.c.md#fd_quic_retry_server_verify>)  (Implementation)


---
### fd\_quic\_retry\_client\_verify<!-- {{#callable_declaration:fd_quic_retry_client_verify}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_retry.h#L232>)

Verifies a QUIC Retry packet on the client side.
- **Description**: Use this function to verify the integrity and validity of a QUIC Retry packet received by a client. It checks the Retry Integrity Tag and extracts the source connection ID and token from the packet. This function must be called with a valid Retry packet and the original destination connection ID. It returns a success or failure code based on the verification result.
- **Inputs**:
    - `retry_ptr`: Pointer to the start of the Retry packet data. Must not be null.
    - `retry_sz`: Size of the Retry packet data in bytes. Must be greater than the size of the Retry Integrity Tag.
    - `orig_dst_conn_id`: Pointer to the original destination connection ID used in the initial packet. Must not be null.
    - `src_conn_id`: Pointer to a `fd_quic_conn_id_t` structure where the source connection ID will be stored. Must not be null.
    - `token`: Pointer to a location where the function will store a pointer to the extracted token. Must not be null.
    - `token_sz`: Pointer to a location where the function will store the size of the extracted token. Must not be null.
- **Output**: Returns `FD_QUIC_SUCCESS` if the verification is successful, otherwise returns `FD_QUIC_FAILED`. On success, `src_conn_id` is populated with the source connection ID, and `token` and `token_sz` are set to point to the token and its size, respectively.
- **See Also**: [`fd_quic_retry_client_verify`](<fd_quic_retry.c.md#fd_quic_retry_client_verify>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)