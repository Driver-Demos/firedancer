<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests QUIC stream functionality, including connection setup, data transmission, and cleanup.

# Purpose
The code is a C program designed to test the functionality of a QUIC (Quick UDP Internet Connections) protocol implementation. It includes the setup and execution of both server and client QUIC instances, simulating a network environment where data is transmitted and received over QUIC connections. The program defines callback functions such as [`my_stream_rx_cb`](<#my_stream_rx_cb>) for handling received stream data and [`my_connection_new`](<#my_connection_new>) for managing new connections. It also includes a test function [`test_invalid_tx_buf_sz`](<#test_invalid_tx_buf_sz>) to verify the behavior of the system with invalid transmission buffer sizes.

The main function initializes the QUIC server and client, sets up a virtual pair to simulate network communication, and uses a spammer to generate and send data streams. The program monitors the completion of handshakes and the reception of data, logging the progress and results. It ensures that both server and client complete their handshakes and that a specified amount of data is received. After the test execution, the program performs cleanup operations, closing connections and freeing resources. The code is structured to provide a comprehensive test suite for validating the QUIC protocol's performance and reliability in handling data streams.
# Imports and Dependencies

---
- `../fd_quic.h`
- `fd_quic_test_helpers.h`
- `fd_quic_stream_spam.h`


# Global Variables

---
### recvd
- **Type**: `ulong`
- **Description**: `recvd` is a static global variable of type `ulong` initialized to 0. It is used to count the number of received data streams in the QUIC server.
- **Use**: Increments each time a data stream is successfully received and verified in the `my_stream_rx_cb` callback function.


---
### server\_complete
- **Type**: `int`
- **Description**: Indicates whether the server handshake process is complete.
- **Use**: Used to track the completion status of the server handshake in the QUIC connection process.


---
### client\_complete
- **Type**: `int`
- **Description**: Indicates whether the client handshake process is complete.
- **Use**: Used to track the completion status of the client handshake in the QUIC connection process.


---
### server\_conn
- **Type**: ``fd_quic_conn_t *``
- **Description**: A pointer to an `fd_quic_conn_t` structure, which represents a QUIC connection in the system. It is initialized to `NULL` and is used to store the server connection once it is established.
- **Use**: Stores the server connection received in the `my_connection_new` callback function.


---
### now
- **Type**: `long`
- **Description**: Represents a global variable that acts as a clock or timestamp in the program.
- **Use**: Used to synchronize or track time-related operations in the QUIC protocol implementation.


# Data Structures

---
### my\_context
- **Type**: ``struct``
- **Members**:
    - `server`: An integer that likely represents a server identifier or status.
- **Description**: Defines a context structure named `my_context` with a single integer member `server`, which is used to store server-related information. The `typedef` creates an alias `my_context_t` for this structure, allowing for easier reference in the code.


---
### my\_context\_t
- **Type**: ``struct``
- **Members**:
    - `server`: An integer that likely indicates the server status or role.
- **Description**: `my_context_t` is a `struct` that contains a single integer member named `server`. This member is likely used to store information related to the server's status or role within the context of a QUIC connection or test environment. The `my_context_t` type is used in the context of QUIC server and client operations, as seen in the provided code.


# Functions

---
### my\_stream\_rx\_cb<!-- {{#callable:my_stream_rx_cb}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_streams.c#L7>)

Validates received stream data against expected payload and logs errors if discrepancies are found.
- **Inputs**:
    - ``conn``: A pointer to the `fd_quic_conn_t` connection object, which is not used in this function.
    - ``stream_id``: The identifier of the stream from which data is received.
    - ``offset``: The offset in the stream where the received data starts.
    - ``data``: A pointer to the received data buffer.
    - ``data_sz``: The size of the received data.
    - ``fin``: An integer indicating if this is the final data segment of the stream (non-zero if true).
- **Logic and Control Flow**:
    - Initializes a buffer `payload_buf` and a packet info structure `pkt` with a buffer size of 4096 bytes.
    - Generates expected payload data for the given `stream_id` using [`fd_quic_stream_spam_gen`](<fd_quic_stream_spam.c.md#fd_quic_stream_spam_gen>).
    - Logs the stream ID, data size, and offset for debugging purposes.
    - Checks if the total size of received data (`offset + data_sz`) matches the expected payload size (`pkt.buf_sz`) when `fin` is true, or if it exceeds the expected size, and logs an error if either condition is true.
    - Compares the received data with the expected data at the given offset using `memcmp`, logs a warning and an error if they do not match.
    - Increments the global `recvd` counter to track the number of successfully processed data segments.
    - Returns `FD_QUIC_SUCCESS` to indicate successful processing.
- **Output**: Returns `FD_QUIC_SUCCESS` if the data is successfully validated and processed.
- **Functions Called**:
    - [`fd_quic_stream_spam_gen`](<fd_quic_stream_spam.c.md#fd_quic_stream_spam_gen>)


---
### my\_connection\_new<!-- {{#callable:my_connection_new}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_streams.c#L53>)

Handles the completion of a server-side QUIC connection handshake.
- **Inputs**:
    - ``conn``: A pointer to an `fd_quic_conn_t` structure representing the QUIC connection.
    - ``vp_context``: A void pointer to a context, which is not used in this function.
- **Logic and Control Flow**:
    - Logs a debug message indicating the server handshake is complete.
    - Sets the global variable `server_complete` to 1, indicating the server handshake is complete.
    - Assigns the `conn` pointer to the global variable `server_conn`.
- **Output**: No return value; the function operates through side effects on global variables.


---
### my\_handshake\_complete<!-- {{#callable:my_handshake_complete}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_streams.c#L62>)

Marks the completion of a client handshake and sets the `client_complete` flag to 1.
- **Inputs**:
    - ``conn``: A pointer to an `fd_quic_conn_t` structure representing the QUIC connection. It is not used in the function.
    - ``vp_context``: A pointer to a context object. It is not used in the function.
- **Logic and Control Flow**:
    - Logs a debug message indicating the client handshake is complete.
    - Sets the global variable `client_complete` to 1.
- **Output**: No output is returned from this function.


---
### test\_invalid\_tx\_buf\_sz<!-- {{#callable:test_invalid_tx_buf_sz}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_streams.c#L75>)

Tests the creation of a QUIC instance with an invalid `tx_buf_sz` parameter.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for memory allocation.
- **Logic and Control Flow**:
    - Logs a notice indicating the start of the test for invalid `tx_buf_sz`.
    - Checks if `FD_TXN_MTU` is not a power of two using `fd_ulong_pow2` and asserts the result is false.
    - Initializes a `fd_quic_limits_t` structure named `bad_limits` with specific parameters, including `tx_buf_sz` set to `FD_TXN_MTU`.
    - Attempts to create a new QUIC instance with `fd_quic_new` using the `wksp` and `bad_limits`, and asserts that the creation fails.
- **Output**: No return value; the function uses assertions to validate conditions.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_streams.c#L91>)

Initializes and tests a QUIC server and client, performs data transmission, and cleans up resources.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Initialize the environment and QUIC test framework with `fd_boot` and [`fd_quic_test_boot`](<fd_quic_test_helpers.c.md#fd_quic_test_boot>).
    - Create a random number generator `rng` using `fd_rng_new` and `fd_rng_join`.
    - Determine the CPU index and adjust if it exceeds the shared memory CPU count.
    - Parse command-line arguments for page size, page count, and NUMA index using `fd_env_strip_cmdline_cstr` and `fd_env_strip_cmdline_ulong`.
    - Convert the page size string to an actual size with `fd_cstr_to_shmem_page_sz` and log an error if unsupported.
    - Create a new anonymous workspace with `fd_wksp_new_anonymous` and test for validity.
    - Test invalid transaction buffer size with [`test_invalid_tx_buf_sz`](<#test_invalid_tx_buf_sz>).
    - Define QUIC server and client limits and create them using [`fd_quic_new_anonymous`](<fd_quic_test_helpers.c.md#fd_quic_new_anonymous>).
    - Assign callback functions for server and client QUIC events.
    - Initialize a virtual pair for server and client QUICs with [`fd_quic_virtual_pair_init`](<fd_quic_test_helpers.c.md#fd_quic_virtual_pair_init>).
    - Create and join a spammer for stream data generation with [`fd_quic_stream_spam_new`](<fd_quic_stream_spam.c.md#fd_quic_stream_spam_new>) and [`fd_quic_stream_spam_join`](<fd_quic_stream_spam.c.md#fd_quic_stream_spam_join>).
    - Initialize server and client QUICs with `fd_quic_init`.
    - Create a client connection with `fd_quic_connect` and test for validity.
    - Run services for both client and server QUICs in a loop until handshakes are complete.
    - Perform data transmission in a loop until a specified amount of data is received.
    - Close the client connection with `fd_quic_conn_close`.
    - Run services to wait for acknowledgments.
    - Clean up resources by finalizing and deleting QUICs, spammers, and workspaces.
    - Log the completion of the test and halt the environment with [`fd_quic_test_halt`](<fd_quic_test_helpers.c.md#fd_quic_test_halt>) and `fd_halt`.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`fd_quic_test_boot`](<fd_quic_test_helpers.c.md#fd_quic_test_boot>)
    - [`test_invalid_tx_buf_sz`](<#test_invalid_tx_buf_sz>)
    - [`fd_quic_new_anonymous`](<fd_quic_test_helpers.c.md#fd_quic_new_anonymous>)
    - [`fd_quic_virtual_pair_init`](<fd_quic_test_helpers.c.md#fd_quic_virtual_pair_init>)
    - [`fd_quic_stream_spam_join`](<fd_quic_stream_spam.c.md#fd_quic_stream_spam_join>)
    - [`fd_quic_stream_spam_new`](<fd_quic_stream_spam.c.md#fd_quic_stream_spam_new>)
    - [`fd_quic_stream_spam_service`](<fd_quic_stream_spam.c.md#fd_quic_stream_spam_service>)
    - [`fd_quic_virtual_pair_fini`](<fd_quic_test_helpers.c.md#fd_quic_virtual_pair_fini>)
    - [`fd_quic_stream_spam_delete`](<fd_quic_stream_spam.c.md#fd_quic_stream_spam_delete>)
    - [`fd_quic_test_halt`](<fd_quic_test_helpers.c.md#fd_quic_test_halt>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)