<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Test helpers for QUIC protocol in Firedancer, including callbacks, configuration, and UDP socket management.

# Purpose
The code is a C source file that provides functionality for testing and configuring QUIC (Quick UDP Internet Connections) protocols. It includes several components that facilitate the creation, configuration, and management of QUIC connections and UDP sockets. The file defines default callback implementations for various QUIC connection events, such as connection creation, handshake completion, and stream notifications. These callbacks are used to log debug information during the testing process.

The file also includes functions to initialize and manage QUIC configurations, such as [`fd_quic_config_anonymous`](<#fd_quic_config_anonymous>) and [`fd_quic_config_test_signer`](<#fd_quic_config_test_signer>), which set up default settings and cryptographic contexts for QUIC connections. Additionally, it provides utilities for creating and managing UDP sockets, including functions like [`fd_quic_client_create_udpsock`](<#fd_quic_client_create_udpsock>) and [`fd_quic_udpsock_create`](<#fd_quic_udpsock_create>), which handle socket creation, binding, and configuration. The code also includes mechanisms for simulating network conditions, such as packet dropping and reordering, through the [`fd_quic_netem_send`](<#fd_quic_netem_send>) function. This file is intended to be part of a larger test suite or library for QUIC protocol testing and development.
# Imports and Dependencies

---
- `fd_quic_test_helpers.h`
- `../../../util/net/fd_pcapng.h`
- `errno.h`
- `net/if.h`
- `stdlib.h`
- `stdio.h`
- `unistd.h`
- `sys/socket.h`
- `arpa/inet.h`
- `netinet/in.h`
- `../../../util/net/fd_ip4.h`
- `linux/if_link.h`


# Global Variables

---
### fd\_quic\_test\_pcap
- **Type**: ``FILE *``
- **Description**: A pointer to a `FILE` object used for file operations.
- **Use**: Used to log QUIC test data to a pcap file if specified.


---
### test\_ip\_addr\_seq
- **Type**: ``uint``
- **Description**: Represents an IP address counter initialized to the IPv4 address `127.10.0.0`. This variable is used to generate unique IP addresses for each new QUIC connection.
- **Use**: Used to increment and generate a new IP address for each QUIC connection.


# Functions

---
### fd\_quic\_test\_cb\_conn\_new<!-- {{#callable:fd_quic_test_cb_conn_new}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.c#L24>)

Logs a debug message when a new QUIC connection is created.
- **Inputs**:
    - ``conn``: A pointer to an `fd_quic_conn_t` structure representing the new QUIC connection.
    - ``quic_ctx``: A pointer to a context object associated with the QUIC connection.
- **Logic and Control Flow**:
    - Logs a debug message using `FD_LOG_DEBUG` with the memory addresses of `conn` and `quic_ctx`.
- **Output**: No output is returned as the function's return type is `void`.


---
### fd\_quic\_test\_cb\_conn\_handshake\_complete<!-- {{#callable:fd_quic_test_cb_conn_handshake_complete}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.c#L31>)

Logs a debug message indicating that a QUIC connection handshake has completed.
- **Inputs**:
    - ``conn``: A pointer to an `fd_quic_conn_t` structure representing the QUIC connection.
    - ``quic_ctx``: A pointer to a context object associated with the QUIC connection.
- **Logic and Control Flow**:
    - Logs a debug message using `FD_LOG_DEBUG` with the message 'cb_conn_handshake_complete' and the memory addresses of `conn` and `quic_ctx`.
- **Output**: No output is returned from this function.


---
### fd\_quic\_test\_cb\_conn\_final<!-- {{#callable:fd_quic_test_cb_conn_final}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.c#L38>)

Logs a debug message indicating the finalization of a QUIC connection.
- **Inputs**:
    - ``conn``: A pointer to an `fd_quic_conn_t` structure representing the QUIC connection.
    - ``quic_ctx``: A pointer to a context object associated with the QUIC connection.
- **Logic and Control Flow**:
    - Logs a debug message using `FD_LOG_DEBUG` with the connection and context pointers.
- **Output**: No return value; the function performs logging as a side effect.


---
### fd\_quic\_test\_cb\_stream\_notify<!-- {{#callable:fd_quic_test_cb_stream_notify}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.c#L45>)

Logs a debug message with details about a QUIC stream notification.
- **Inputs**:
    - ``stream``: A pointer to an `fd_quic_stream_t` structure representing the QUIC stream.
    - ``quic_ctx``: A pointer to a context object associated with the QUIC operation.
    - ``notify_type``: An integer representing the type of notification for the stream.
- **Logic and Control Flow**:
    - Logs a debug message using the `FD_LOG_DEBUG` macro.
    - The message includes the stream's ID, the QUIC context pointer, and the notification type.
- **Output**: No return value; the function performs logging as a side effect.


---
### fd\_quic\_test\_cb\_stream\_rx<!-- {{#callable:fd_quic_test_cb_stream_rx}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.c#L53>)

Logs the reception of a QUIC stream and returns a success status.
- **Inputs**:
    - ``conn``: A pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
    - ``stream_id``: An unsigned long integer representing the identifier of the stream.
    - ``offset``: An unsigned long integer indicating the offset in the stream where the data starts.
    - ``data``: A pointer to an array of unsigned characters representing the data received.
    - ``data_sz``: An unsigned long integer representing the size of the data received.
    - ``fin``: An integer indicating if this is the final part of the stream (1 if true, 0 otherwise).
- **Logic and Control Flow**:
    - Logs a debug message with details of the received stream, including connection pointer, stream ID, offset, data pointer, data size, and final flag.
    - Returns the constant `FD_QUIC_SUCCESS`.
- **Output**: Returns an integer constant `FD_QUIC_SUCCESS` indicating successful processing.


---
### fd\_quic\_test\_cb\_tls\_keylog<!-- {{#callable:fd_quic_test_cb_tls_keylog}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.c#L65>)

Logs TLS key information to a pcap file if logging is enabled.
- **Inputs**:
    - ``quic_ctx``: A context pointer for QUIC, which is not used in this function.
    - ``line``: A constant character pointer to the line of TLS key log data to be written.
- **Logic and Control Flow**:
    - Casts `quic_ctx` to void to indicate it is unused.
    - Checks if `fd_quic_test_pcap` is not NULL, indicating that pcap logging is enabled.
    - If logging is enabled, calls `fd_pcapng_fwrite_tls_key_log` to write the TLS key log data to the pcap file.
- **Output**: No return value; the function performs logging as a side effect.


---
### flush\_pcap<!-- {{#callable:flush_pcap}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.c#L73>)

Flushes the output buffer of the file stream `fd_quic_test_pcap` to ensure all data is written to the file.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls the `fflush` function on the global file pointer `fd_quic_test_pcap`.
- **Output**: No return value; the function ensures that any buffered data for the file stream `fd_quic_test_pcap` is written to the file.


---
### fd\_quic\_test\_boot<!-- {{#callable:fd_quic_test_boot}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.c#L80>)

Initializes logging to a specified pcap file if the '--pcap' command-line argument is provided.
- **Inputs**:
    - ``pargc``: A pointer to an integer representing the number of command-line arguments.
    - ``pargv``: A pointer to an array of strings representing the command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_env_strip_cmdline_cstr` to check for the '--pcap' argument in the command-line arguments.
    - If the '--pcap' argument is found, logs a notice message with the pcap file name.
    - Opens the specified pcap file in append-binary mode and assigns the file pointer to `fd_quic_test_pcap`.
    - Checks if the file was successfully opened using `FD_TEST`.
    - Registers the `flush_pcap` function to be called at program exit using `atexit`.
- **Output**: No return value; the function operates by side effects, such as opening a file and setting up exit handlers.


---
### fd\_quic\_test\_halt<!-- {{#callable:fd_quic_test_halt}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.c#L93>)

Closes the `fd_quic_test_pcap` file if it is open and sets the pointer to NULL.
- **Inputs**: None
- **Logic and Control Flow**:
    - Checks if `fd_quic_test_pcap` is not NULL, indicating an open file.
    - If the file is open, calls `fclose` on `fd_quic_test_pcap` and verifies the return value is 0, indicating success.
    - Sets `fd_quic_test_pcap` to NULL to indicate the file is closed.
- **Output**: No output is returned.


---
### fd\_quic\_config\_anonymous<!-- {{#callable:fd_quic_config_anonymous}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.c#L103>)

Configures a QUIC instance with default settings and callbacks for anonymous operation.
- **Inputs**:
    - ``quic``: A pointer to an `fd_quic_t` structure that represents the QUIC instance to configure.
    - ``role``: An integer representing the role of the QUIC instance, which is set in the configuration.
- **Logic and Control Flow**:
    - Assigns the `role` to the `role` field in the `config` structure of the `quic` instance.
    - Generates a new IP address by incrementing and byte-swapping the `test_ip_addr_seq` variable.
    - Sets default configuration values for `idle_timeout`, `ack_delay`, `ack_threshold`, and `initial_rx_max_stream_data` in the `config` structure.
    - Assigns default callback functions for connection and stream events to the `cb` structure of the `quic` instance.
- **Output**: No return value; the function modifies the `quic` instance in place.


---
### fd\_quic\_config\_test\_signer<!-- {{#callable:fd_quic_config_test_signer}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.c#L128>)

Configures a QUIC instance with a test signer by copying the public key and setting the signing context and function.
- **Inputs**:
    - ``quic``: A pointer to an `fd_quic_t` structure representing the QUIC instance to configure.
    - ``sign_ctx``: A pointer to an `fd_tls_test_sign_ctx_t` structure containing the signing context and public key.
- **Logic and Control Flow**:
    - Retrieve the `fd_quic_config_t` configuration from the `quic` instance.
    - Copy the `public_key` from `sign_ctx` to `config->identity_public_key` using `fd_memcpy`.
    - Set `config->sign_ctx` to `sign_ctx`.
    - Assign the signing function `fd_tls_test_sign_sign` to `config->sign`.
- **Output**: No return value; the function modifies the `quic` configuration in place.


---
### fd\_quic\_new\_anonymous<!-- {{#callable:fd_quic_new_anonymous}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.c#L137>)

Creates and configures a new anonymous QUIC instance with specified limits, role, and random number generator.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace where memory allocations will occur.
    - ``limits``: A constant pointer to `fd_quic_limits_t` that specifies the resource limits for the QUIC instance.
    - ``role``: An integer representing the role of the QUIC instance (e.g., client or server).
    - ``rng``: A pointer to a `fd_rng_t` random number generator used for cryptographic operations.
- **Logic and Control Flow**:
    - Allocate memory for the QUIC instance using `fd_wksp_alloc_laddr` with alignment and footprint based on `limits`.
    - Create a new QUIC instance with `fd_quic_new` and check if it is successful using `FD_TEST`.
    - Join the shared QUIC instance with `fd_quic_join` and verify success with `FD_TEST`.
    - Configure the QUIC instance anonymously with [`fd_quic_config_anonymous`](<#fd_quic_config_anonymous>), setting the role.
    - Set the current time in the QUIC state to 1 using `fd_quic_get_state`.
    - Allocate memory for a TLS test signing context using `fd_wksp_alloc_laddr` and initialize it with `fd_tls_test_sign_ctx`.
    - Configure the QUIC instance with the test signer using [`fd_quic_config_test_signer`](<#fd_quic_config_test_signer>).
    - Return the configured QUIC instance.
- **Output**: A pointer to the newly created and configured `fd_quic_t` instance.
- **Functions Called**:
    - [`fd_quic_config_anonymous`](<#fd_quic_config_anonymous>)
    - [`fd_quic_config_test_signer`](<#fd_quic_config_test_signer>)


---
### fd\_quic\_new\_anonymous\_small<!-- {{#callable:fd_quic_new_anonymous_small}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.c#L158>)

Creates a new anonymous QUIC instance with predefined small limits.
- **Inputs**:
    - ``wksp``: A pointer to a workspace (`fd_wksp_t`) used for memory allocation.
    - ``role``: An integer representing the role of the QUIC instance.
    - ``rng``: A pointer to a random number generator (`fd_rng_t`) used for cryptographic operations.
- **Logic and Control Flow**:
    - Initialize `fd_quic_limits_t` structure with small predefined limits for connection count, handshake count, connection ID count, inflight frame count, transmission buffer size, and stream pool count.
    - Call [`fd_quic_new_anonymous`](<#fd_quic_new_anonymous>) with the workspace, the initialized limits, the role, and the random number generator to create a new anonymous QUIC instance.
- **Output**: Returns a pointer to the newly created `fd_quic_t` instance.
- **Functions Called**:
    - [`fd_quic_new_anonymous`](<#fd_quic_new_anonymous>)


---
### fd\_quic\_virtual\_pair\_direct<!-- {{#callable:fd_quic_virtual_pair_direct}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.c#L175>)

Establishes a direct virtual connection between two QUIC instances by swapping their receive and transmit asynchronous I/O (AIO) interfaces.
- **Inputs**:
    - `pair`: A pointer to an `fd_quic_virtual_pair_t` structure that will store the virtual pair information.
    - `quic_a`: A pointer to the first `fd_quic_t` QUIC instance.
    - `quic_b`: A pointer to the second `fd_quic_t` QUIC instance.
- **Logic and Control Flow**:
    - Assigns `quic_a` to `pair->quic_a` and `quic_b` to `pair->quic_b`.
    - Retrieves the receive AIO interface of `quic_a` using `fd_quic_get_aio_net_rx` and stores it in `rx_a`.
    - Retrieves the receive AIO interface of `quic_b` using `fd_quic_get_aio_net_rx` and stores it in `rx_b`.
    - Sets the transmit AIO interface of `quic_a` to `rx_b` using `fd_quic_set_aio_net_tx`.
    - Sets the transmit AIO interface of `quic_b` to `rx_a` using `fd_quic_set_aio_net_tx`.
    - Assigns `rx_b` to `pair->aio_a2b` and `rx_a` to `pair->aio_b2a`.
- **Output**: No return value; the function modifies the `fd_quic_virtual_pair_t` structure pointed to by `pair`.


---
### fd\_quic\_virtual\_pair\_pcap<!-- {{#callable:fd_quic_virtual_pair_pcap}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.c#L193>)

Configures a QUIC virtual pair to capture network traffic and log it to a pcap file.
- **Inputs**:
    - ``pair``: A pointer to an `fd_quic_virtual_pair_t` structure that will be configured.
    - ``quic_a``: A pointer to the first `fd_quic_t` QUIC instance in the pair.
    - ``quic_b``: A pointer to the second `fd_quic_t` QUIC instance in the pair.
    - ``pcap``: A pointer to a `FILE` object where the pcap data will be logged.
- **Logic and Control Flow**:
    - Assigns `quic_a` and `quic_b` to the `pair` structure.
    - Retrieves the AIO network receive interfaces for both `quic_a` and `quic_b`.
    - Writes the pcapng header to the `pcap` file and checks for success.
    - Joins the receive interfaces to the pcapng capture for both directions (b2a and a2b) and checks for success.
    - Sets the AIO network transmit interfaces for `quic_a` and `quic_b` to the corresponding pcapng capture interfaces.
    - Assigns the local AIO interfaces of the pcapng captures to `pair->aio_a2b` and `pair->aio_b2a`.
- **Output**: No return value; the function modifies the `pair` structure and writes to the `pcap` file.


---
### fd\_quic\_virtual\_pair\_init<!-- {{#callable:fd_quic_virtual_pair_init}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.c#L223>)

Initializes a QUIC virtual pair with either direct or pcap-based communication based on the presence of a pcap file.
- **Inputs**:
    - `pair`: A pointer to an `fd_quic_virtual_pair_t` structure to initialize.
    - `quic_a`: A pointer to the first `fd_quic_t` QUIC instance.
    - `quic_b`: A pointer to the second `fd_quic_t` QUIC instance.
- **Logic and Control Flow**:
    - Set the memory of `pair` to zero using `memset`.
    - Check if `fd_quic_test_pcap` is not set (NULL).
    - If `fd_quic_test_pcap` is not set, call [`fd_quic_virtual_pair_direct`](<#fd_quic_virtual_pair_direct>) to establish direct communication between `quic_a` and `quic_b`.
    - If `fd_quic_test_pcap` is set, call [`fd_quic_virtual_pair_pcap`](<#fd_quic_virtual_pair_pcap>) to establish pcap-based communication between `quic_a` and `quic_b` using the pcap file.
- **Output**: No return value; the function initializes the `pair` structure.
- **Functions Called**:
    - [`fd_quic_virtual_pair_direct`](<#fd_quic_virtual_pair_direct>)
    - [`fd_quic_virtual_pair_pcap`](<#fd_quic_virtual_pair_pcap>)


---
### fd\_quic\_virtual\_pair\_fini<!-- {{#callable:fd_quic_virtual_pair_fini}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.c#L234>)

Finalizes a QUIC virtual pair by leaving pcapng sessions and setting network transmission targets to NULL.
- **Inputs**:
    - `pair`: A pointer to an `fd_quic_virtual_pair_t` structure representing the QUIC virtual pair to finalize.
- **Logic and Control Flow**:
    - Checks if `pair->pcapng_a2b.pcapng` is not NULL.
    - If not NULL, calls `fd_aio_pcapng_leave` on `pair->pcapng_a2b` and `pair->pcapng_b2a` to leave the pcapng sessions.
    - Sets the network transmission target of `pair->quic_a` to NULL using `fd_quic_set_aio_net_tx`.
    - Sets the network transmission target of `pair->quic_b` to NULL using `fd_quic_set_aio_net_tx`.
- **Output**: No return value; the function operates directly on the `pair` structure.


---
### fd\_quic\_client\_create\_udpsock<!-- {{#callable:fd_quic_client_create_udpsock}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.c#L244>)

Creates and initializes a UDP socket for a QUIC client, binding it to a specified IP address and setting up necessary resources.
- **Inputs**:
    - ``udpsock``: A pointer to a `fd_quic_udpsock_t` structure where the function will store the created UDP socket information.
    - ``wksp``: A pointer to a `fd_wksp_t` workspace used for memory allocation.
    - ``rx_aio``: A constant pointer to a `fd_aio_t` structure for receiving asynchronous I/O operations.
    - ``listen_ip``: An unsigned integer representing the IP address to bind the socket to.
- **Logic and Control Flow**:
    - Initialize default values for `mtu`, `rx_depth`, and `tx_depth`.
    - Create a UDP socket using `socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP)`.
    - Check if socket creation failed; if so, log a warning and return `NULL`.
    - Set up a `sockaddr_in` structure with the provided `listen_ip` and bind the socket to it.
    - Check if binding failed; if so, log a warning, close the socket, and return `NULL`.
    - Allocate memory for the socket using `fd_wksp_alloc_laddr` with the workspace `wksp`.
    - Check if memory allocation failed; if so, log a warning, close the socket, and return `NULL`.
    - Create and join a new UDP socket using `fd_udpsock_new` and `fd_udpsock_join`.
    - Check if socket joining failed; if so, log a warning, close the socket, free allocated memory, and return `NULL`.
    - Set the UDP socket layer to `FD_UDPSOCK_LAYER_IP`.
    - Initialize the `udpsock` structure with the created socket, file descriptor, and other parameters.
    - Set the receive asynchronous I/O operations using `fd_udpsock_set_rx`.
    - Log a notice indicating the UDP socket is listening on the specified IP and port.
    - Return the initialized `udpsock` structure.
- **Output**: A pointer to the initialized `fd_quic_udpsock_t` structure, or `NULL` if an error occurs.


---
### fd\_quic\_udpsock\_create<!-- {{#callable:fd_quic_udpsock_create}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.c#L302>)

Creates and initializes a UDP socket for QUIC communication with specified parameters.
- **Inputs**:
    - `_sock`: A pointer to a `fd_quic_udpsock_t` structure to initialize.
    - `pargc`: A pointer to an integer representing the argument count for command-line parameters.
    - `pargv`: A pointer to an array of strings representing the command-line arguments.
    - `wksp`: A pointer to a `fd_wksp_t` workspace for memory allocation.
    - `rx_aio`: A constant pointer to an `fd_aio_t` structure for asynchronous I/O operations.
- **Logic and Control Flow**:
    - Extracts MTU, RX depth, TX depth, listen IP, and listen port from command-line arguments with default values if not provided.
    - Converts the listen IP string to a 32-bit integer format and logs an error if conversion fails.
    - Creates a UDP socket using `socket()` with `AF_INET`, `SOCK_DGRAM`, and `IPPROTO_UDP` parameters.
    - Binds the socket to the specified IP and port using `bind()` and logs a warning if binding fails.
    - Allocates memory for the UDP socket using `fd_wksp_alloc_laddr()` and logs a warning if allocation fails.
    - Initializes the UDP socket with `fd_udpsock_new()` and `fd_udpsock_join()` and logs a warning if initialization fails.
    - Sets the socket layer to IP using `fd_udpsock_set_layer()`.
    - Configures the `quic_sock` structure with the initialized socket, workspace, and asynchronous I/O settings.
    - Logs a notice indicating the UDP socket is listening on the specified IP and port.
- **Output**: Returns a pointer to the initialized `fd_quic_udpsock_t` structure or `NULL` if an error occurs.


---
### fd\_quic\_udpsock\_destroy<!-- {{#callable:fd_quic_udpsock_destroy}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.c#L374>)

Destroys a QUIC UDP socket by freeing resources and closing the socket file descriptor.
- **Inputs**:
    - `udpsock`: A pointer to an `fd_quic_udpsock_t` structure representing the QUIC UDP socket to destroy.
- **Logic and Control Flow**:
    - Check if `udpsock` is NULL; if so, return NULL.
    - Switch on the `type` of `udpsock`.
    - If the type is `FD_QUIC_UDPSOCK_TYPE_UDPSOCK`, call `fd_udpsock_leave` on `udpsock->udpsock.sock`, then `fd_udpsock_delete` on the result, and finally `fd_wksp_free_laddr` to free the memory.
    - Close the socket file descriptor `udpsock->udpsock.sock_fd`.
    - Return the `udpsock` pointer.
- **Output**: Returns the `udpsock` pointer if successful, or NULL if `udpsock` is NULL.


---
### fd\_quic\_udpsock\_service<!-- {{#callable:fd_quic_udpsock_service}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.c#L389>)

Services a UDP socket based on its type.
- **Inputs**:
    - ``udpsock``: A pointer to a constant `fd_quic_udpsock_t` structure that represents the UDP socket to be serviced.
- **Logic and Control Flow**:
    - Check the type of the `udpsock` using a switch statement.
    - If the type is `FD_QUIC_UDPSOCK_TYPE_UDPSOCK`, call `fd_udpsock_service` with the socket from `udpsock` to service it.
- **Output**: No return value; the function performs an action based on the type of the UDP socket.


---
### fd\_quic\_netem\_init<!-- {{#callable:fd_quic_netem_init}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.c#L399>)

Initializes a `fd_quic_netem_t` structure with specified drop and reorder thresholds and sets up asynchronous I/O.
- **Inputs**:
    - `netem`: A pointer to a `fd_quic_netem_t` structure to initialize.
    - `thres_drop`: A float representing the threshold for packet drop probability.
    - `thres_reorder`: A float representing the threshold for packet reorder probability.
- **Logic and Control Flow**:
    - Assigns the `thresh_drop` and `thresh_reorder` values to the `netem` structure.
    - Calls `fd_aio_new` to initialize asynchronous I/O for the `netem` structure with `fd_quic_netem_send` as the callback function.
    - Returns the initialized `netem` structure.
- **Output**: Returns a pointer to the initialized `fd_quic_netem_t` structure.


---
### fd\_quic\_netem\_send<!-- {{#callable:fd_quic_netem_send}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.c#L411>)

Simulates network conditions by randomly dropping, reordering, or sending packets based on thresholds.
- **Inputs**:
    - `ctx`: A pointer to `fd_quic_netem_t` context, which contains thresholds and buffers for packet manipulation.
    - `batch`: An array of `fd_aio_pkt_info_t` structures representing the packets to process.
    - `batch_cnt`: The number of packets in the `batch` array.
    - `opt_batch_idx`: An optional pointer to a batch index, marked as unused in this function.
    - `flush`: An integer flag indicating whether to flush the send operation.
- **Logic and Control Flow**:
    - Initialize a static seed for random number generation.
    - Iterate over each packet in the `batch`.
    - Generate a random number and determine if the packet should be dropped based on `thresh_drop`.
    - If not dropped, check if the packet should be reordered based on `thresh_reorder`.
    - If reordering, check if there is a free buffer slot; if so, store the packet in the buffer.
    - If no free buffer slot, send the most recently used buffered packet and replace it with the current packet if necessary.
    - If not dropping or reordering, send the packet immediately.
    - After sending, check if there are any buffered packets to send and send them if necessary.
- **Output**: Returns `FD_AIO_SUCCESS` to indicate successful processing of the packet batch.



---
Made with ❤️ by [Driver](https://www.driver.ai/)