<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests the QUIC client by sending a flood of QUIC INITIAL frames and handling connection events.

# Purpose
The code is a C program designed to test a QUIC (Quick UDP Internet Connections) client by sending a flood of QUIC INITIAL frames to a server. It includes functions to handle the client-side operations of a QUIC connection, such as establishing a connection, completing a handshake, and sending data streams. The program uses various libraries for cryptographic operations, such as SHA-512 hashing and Ed25519 signing, to generate and verify messages. It also manages network operations using UDP sockets and handles asynchronous input/output for QUIC data transmission.

The main function initializes the environment, sets up the necessary configurations, and creates a workspace for the QUIC client. It then enters a loop where it continuously attempts to establish and maintain a connection with a specified server, sending data in batches. The program includes callback functions to handle events like handshake completion and connection closure. It also manages resources such as random number generators and memory allocations for message buffers. The code is structured to handle reconnections if the connection is lost, ensuring continuous operation.
# Imports and Dependencies

---
- `../fd_quic.h`
- `fd_quic_test_helpers.h`
- `stdlib.h`
- `stdio.h`
- `../../../ballet/sha512/fd_sha512.h`
- `../../../ballet/ed25519/fd_ed25519.h`
- `../../../tango/tempo/fd_tempo.h`
- `../../../waltz/quic/fd_quic_private.h`
- `../../../util/fd_util.h`
- `../../../util/net/fd_eth.h`
- `../../../util/net/fd_ip4.h`


# Global Variables

---
### g\_unreliable
- **Type**: `_Bool`
- **Description**: Indicates whether the QUIC client should treat all packets as acknowledged, which affects the handling of packet metadata.
- **Use**: Used to determine if packet metadata should be reclaimed as if all packets are acknowledged.


---
### clock
- **Type**: ``fd_clock_t[1]``
- **Description**: A static array of type `fd_clock_t` with a single element. This array is used to store clock-related data for timing operations in the QUIC client.
- **Use**: Used to obtain the current time for various operations in the QUIC client, such as connection management and data transmission.


---
### clock\_shmem
- **Type**: ``fd_clock_shmem_t[1]``
- **Description**: An array of one `fd_clock_shmem_t` element, which is a type used for shared memory clock operations. This variable is used to initialize and manage shared memory resources for clock operations in the program.
- **Use**: Used to initialize the clock with shared memory resources in the `fd_clock_default_init` function.


---
### client\_conn
- **Type**: ``fd_quic_conn_t *``
- **Description**: A pointer to a `fd_quic_conn_t` structure, which represents a QUIC connection in the program. It is initialized to `NULL` and is used to manage the state of the client connection to a server.
- **Use**: Used to store and manage the state of the client QUIC connection, including connection establishment, data transmission, and connection closure.


---
### client\_complete
- **Type**: `int`
- **Description**: Indicates whether the client handshake process is complete in a QUIC connection.
- **Use**: Used to control the flow of the QUIC client operations, particularly to determine when the handshake is complete and the client can proceed with further actions.


# Functions

---
### my\_stream\_rx\_cb<!-- {{#callable:my_stream_rx_cb}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_client_flood.c#L22>)

Logs received data from a QUIC stream and returns a success status.
- **Inputs**:
    - `conn`: A pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
    - `stream_id`: The identifier of the QUIC stream.
    - `offset`: The offset in the stream where the data starts.
    - `data`: A pointer to the data received from the stream.
    - `data_sz`: The size of the data received.
    - `fin`: An integer indicating if this is the final part of the data (1 if true, 0 otherwise).
- **Logic and Control Flow**:
    - Ignores the `conn`, `stream_id`, and `fin` parameters by casting them to void.
    - Logs a debug message indicating the size and offset of the received data using `FD_LOG_DEBUG`.
    - Logs a hexdump of the received data using `FD_LOG_HEXDUMP_DEBUG`.
    - Returns `FD_QUIC_SUCCESS` to indicate successful processing.
- **Output**: Returns `FD_QUIC_SUCCESS` to indicate successful processing of the received data.


---
### my\_handshake\_complete<!-- {{#callable:my_handshake_complete}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_client_flood.c#L40>)

Marks the completion of a client handshake and logs this event.
- **Inputs**:
    - ``conn``: A pointer to an `fd_quic_conn_t` structure representing the QUIC connection. It is not used in the function.
    - ``vp_context``: A pointer to a context object, which is not used in the function.
- **Logic and Control Flow**:
    - Logs the message 'client handshake complete' using `FD_LOG_INFO` to indicate that the client handshake is complete.
    - Sets the global variable `client_complete` to 1 to signal that the handshake process is finished.
- **Output**: No return value; the function operates through side effects on global state and logging.


---
### my\_connection\_closed<!-- {{#callable:my_connection_closed}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_client_flood.c#L49>)

Handles the closure of a QUIC connection by logging the closure reason, setting the client connection to NULL, and marking the client as complete.
- **Inputs**:
    - ``conn``: A pointer to the `fd_quic_conn_t` structure representing the QUIC connection that is being closed.
    - ``vp_context``: A void pointer to additional context, which is not used in this function.
- **Logic and Control Flow**:
    - Logs the closure of the client connection with the reason code from the `conn` structure.
    - Sets the global `client_conn` variable to `NULL`, indicating that there is no active client connection.
    - Sets the global `client_complete` variable to `1`, marking the client process as complete.
- **Output**: This function does not return a value.


---
### run\_quic\_client<!-- {{#callable:run_quic_client}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_client_flood.c#L57>)

Establishes a QUIC client connection, sends data in batches, and handles connection lifecycle.
- **Inputs**:
    - `quic`: A pointer to an `fd_quic_t` structure representing the QUIC client instance.
    - `udpsock`: A constant pointer to an `fd_quic_udpsock_t` structure for UDP socket operations.
    - `dst_ip`: The destination IP address for the QUIC connection.
    - `dst_port`: The destination port for the QUIC connection.
    - `batch_sz`: The number of messages to send in each batch.
- **Logic and Control Flow**:
    - Initialize local variables and set callback functions for connection events.
    - Configure QUIC for network transmission using the provided UDP socket.
    - Initialize the QUIC client and attempt to connect to the server using the specified IP and port.
    - Enter a loop to process incoming and outgoing QUIC data until the connection is complete.
    - If the connection is successful, generate and sign messages of varying sizes for transmission.
    - Create QUIC batches with the generated messages and send them over new streams in a loop.
    - Periodically log the number of streams and total size of data sent.
    - If the connection is unreliable, reclaim packet metadata to free resources.
    - Close the connection and clean up resources when finished.
- **Output**: No direct output is returned; the function manages the QUIC client connection and data transmission.
- **Functions Called**:
    - [`fd_quic_udpsock_service`](<fd_quic_test_helpers.c.md#fd_quic_udpsock_service>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_client_flood.c#L235>)

Initializes and runs a QUIC client that sends data to a specified destination using command-line parameters.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Initializes a random number generator `rng` using `fd_rng_new` and `fd_rng_join`.
    - Initializes the default clock using `fd_clock_default_init`.
    - Determines the CPU index using `fd_tile_cpu_id` and `fd_tile_idx`, adjusting if necessary.
    - Parses command-line arguments for page size, page count, NUMA index, destination IP, destination port, gateway, batch size, and unreliability flag using `fd_env_strip_cmdline_*` functions.
    - Converts the page size string to a numeric value using `fd_cstr_to_shmem_page_sz` and checks for validity.
    - Validates the presence and correctness of destination IP, destination port, and gateway, logging errors if invalid.
    - Creates a workspace using `fd_wksp_new_anonymous` with the parsed parameters.
    - Initializes QUIC limits from the environment and calculates the QUIC footprint using `fd_quic_footprint`.
    - Creates a new QUIC client instance using [`fd_quic_new_anonymous`](<fd_quic_test_helpers.c.md#fd_quic_new_anonymous>) and sets up UDP socket using [`fd_quic_udpsock_create`](<fd_quic_test_helpers.c.md#fd_quic_udpsock_create>).
    - Configures the QUIC client using `fd_quic_config_from_env`.
    - Enters an infinite loop to run the QUIC client using [`run_quic_client`](<#run_quic_client>), which handles connection and data transmission.
    - Cleans up resources by finalizing and deleting QUIC instances, destroying UDP socket, deleting workspace, and halting the program.
- **Output**: Returns 0 upon successful execution.
- **Functions Called**:
    - [`fd_quic_new_anonymous`](<fd_quic_test_helpers.c.md#fd_quic_new_anonymous>)
    - [`fd_quic_udpsock_create`](<fd_quic_test_helpers.c.md#fd_quic_udpsock_create>)
    - [`run_quic_client`](<#run_quic_client>)
    - [`fd_quic_udpsock_destroy`](<fd_quic_test_helpers.c.md#fd_quic_udpsock_destroy>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)