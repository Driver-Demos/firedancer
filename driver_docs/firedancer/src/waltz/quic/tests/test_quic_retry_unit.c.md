<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Unit tests and benchmarks for QUIC retry packet integrity and token handling in the Firedancer codebase.

# Purpose
The code is a C source file that implements tests and benchmarks for QUIC protocol retry mechanisms, specifically focusing on retry integrity tags and token handling as defined in RFC 9001. It includes functions to test the integrity and authenticity of retry packets, ensuring that the retry integrity tags are correctly generated and verified. The file also contains benchmark functions to measure the performance of creating and verifying retry tokens on both the server and client sides. These benchmarks assess the packet processing throughput, providing metrics in terms of millions of packets per second (Mpps) and nanoseconds per packet.

The file includes several test functions such as [`test_retry_integrity_tag`](<#test_retry_integrity_tag>), which verifies the integrity tag against a sample retry packet, and [`test_retry_token_malleability`](<#test_retry_token_malleability>), which checks the robustness of retry tokens against bit manipulation. Additionally, [`test_retry_token_time`](<#test_retry_token_time>) ensures that retry tokens expire as expected. The main function orchestrates the execution of these tests and benchmarks, initializing necessary components and logging the results. The code relies on several included headers for cryptographic operations and QUIC protocol definitions, indicating its role as part of a larger QUIC implementation.
# Imports and Dependencies

---
- `../crypto/fd_quic_crypto_suites.h`
- `../fd_quic_common.h`
- `../fd_quic_private.h`
- `../fd_quic_retry_private.h`
- `../templ/fd_quic_encoders_decl.h`
- `../templ/fd_quic_frames_templ.h`
- `../templ/fd_quic_templ.h`
- `../templ/fd_quic_undefs.h`
- `../../../ballet/aes/fd_aes_gcm.h`


# Functions

---
### test\_retry\_integrity\_tag<!-- {{#callable:test_retry_integrity_tag}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_retry_unit.c#L31>)

Verifies the retry integrity tag implementation using a sample retry packet from RFC 9001.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initializes an `fd_aes_gcm_t` array for AES-GCM operations.
    - Defines a static array `retry_a41` containing a sample retry packet and a static `fd_quic_conn_id_t` structure `conn_id_a41`.
    - Creates a retry pseudo packet using `fd_quic_retry_pseudo` and checks its length against a predefined array `pseudo_a41`.
    - Compares the generated pseudo packet with `pseudo_a41` and logs a warning if they do not match.
    - Generates a retry integrity tag using `fd_quic_retry_integrity_tag_sign` and verifies it against a portion of `retry_a41`.
    - Verifies the retry packet using `fd_quic_retry_client_verify` and checks for success.
- **Output**: No output is returned; the function performs internal tests and logs warnings if mismatches occur.


---
### bench\_retry\_create<!-- {{#callable:bench_retry_create}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_retry_unit.c#L88>)

Benchmarks the performance of the `fd_quic_retry_create` function by measuring the time taken to create retry tokens over a large number of iterations.
- **Inputs**: None
- **Logic and Control Flow**:
    - Logs the start of the benchmarking process with a notice message.
    - Initializes a random number generator `rng` using `fd_rng_new` and `fd_rng_join`.
    - Defines and initializes several variables including `retry`, `pkt`, `orig_dst_conn_id`, `peer_src_conn_id`, `retry_src_conn_id`, `aes_key`, `aes_iv`, and `ttl`.
    - Calls `fd_quic_retry_create` to create a retry token and logs the token using a hex dump.
    - Starts a timer using `fd_log_wallclock` to measure the time taken for a loop of 1,000,000 iterations.
    - In each iteration, calls `fd_quic_retry_create` to create a retry token and uses `FD_COMPILER_UNPREDICTABLE` to prevent compiler optimizations on `retry[0]`.
    - Ends the timer and calculates the million packets per second (Mpps) and nanoseconds per packet, logging these metrics as notices.
    - Cleans up the random number generator using `fd_rng_leave` and `fd_rng_delete`.
- **Output**: No output is returned from this function as it is a void function; it logs performance metrics to the console.


---
### bench\_retry\_server\_verify<!-- {{#callable:bench_retry_server_verify}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_retry_unit.c#L123>)

Benchmarks the performance of the `fd_quic_retry_server_verify` function by repeatedly verifying a retry packet and measuring the throughput and latency.
- **Inputs**: None
- **Logic and Control Flow**:
    - Logs the start of the benchmarking process with `FD_LOG_NOTICE`.
    - Initializes a static token array with predefined values.
    - Creates a random number generator `rng` using `fd_rng_new` and `fd_rng_join`.
    - Defines a constant `fd_quic_pkt_t` structure `pkt` initialized to zero.
    - Initializes an `fd_quic_initial_t` structure `initial` with a destination connection ID length of 8 and assigns the static token to it.
    - Declares variables `odcid` and `rscid` for connection ID and source connection ID, respectively.
    - Sets up AES key and IV arrays with predefined values and initializes `now` and `ttl` for time-related operations.
    - Starts a timer by calling `fd_log_wallclock` and negating its result to `dt`.
    - Runs a loop for 1,000,000 iterations, where in each iteration it calls `fd_quic_retry_server_verify` with the packet, initial structure, connection IDs, AES key, IV, current time, and TTL, and checks the result with `FD_TEST`.
    - Ends the timer by adding the current `fd_log_wallclock` value to `dt`.
    - Calculates the million packets per second (Mpps) and nanoseconds per packet (ns) based on the elapsed time and logs these metrics with `FD_LOG_NOTICE`.
    - Cleans up the random number generator by calling `fd_rng_leave` and `fd_rng_delete`.
- **Output**: No output is returned as the function is void; it logs performance metrics to the console.


---
### bench\_retry\_client\_verify<!-- {{#callable:bench_retry_client_verify}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_retry_unit.c#L173>)

Benchmarks the performance of the `fd_quic_retry_client_verify` function by measuring the time taken to verify a retry packet over a large number of iterations.
- **Inputs**: None
- **Logic and Control Flow**:
    - Logs the start of the benchmarking process with a notice message.
    - Defines a static array `retry` containing a sample retry packet data.
    - Initializes `orig_dst_conn_id` with a size of 8 and declares `src_conn_id`, `token`, and `token_sz`.
    - Records the start time using `fd_log_wallclock`.
    - Runs a loop for 1,000,000 iterations, calling `fd_quic_retry_client_verify` with the retry packet and checks if the result is `FD_QUIC_SUCCESS`.
    - Records the end time and calculates the elapsed time `dt`.
    - Calculates the million packets per second (Mpps) and nanoseconds per packet (ns) based on the elapsed time and logs these metrics as notice messages.
- **Output**: No direct output; logs performance metrics to the console.


---
### test\_retry\_token\_malleability<!-- {{#callable:test_retry_token_malleability}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_retry_unit.c#L210>)

Tests the malleability of retry tokens by flipping each bit and verifying the token's integrity.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize a static array `retry` with predefined values representing a retry token.
    - Define a constant `orig_dst_conn_id` with a size of 8 and a variable `src_conn_id`.
    - Iterate over each byte in the `retry` array.
    - For each byte, iterate over each bit position (0 to 7).
    - Flip the current bit in the `retry` byte using XOR operation.
    - Call `fd_quic_retry_client_verify` to verify the modified retry token against the original destination connection ID and store the result in `res`.
    - Assert that the result `res` is equal to `FD_QUIC_FAILED`, indicating the token verification failed.
    - Revert the bit flip in the `retry` byte using XOR operation again.
    - Repeat the process for a static array `token` with predefined values, representing another token.
    - Initialize `fd_quic_initial_t` structure `initial` with the token and its length.
    - Define a constant `pkt` and arrays `aes_key` and `aes_iv` with predefined values.
    - Set `now` to 50 and `ttl` to 3e9.
    - Iterate over each byte in the `token` array.
    - For each byte, iterate over each bit position (0 to 7).
    - Flip the current bit in the `token` byte using XOR operation.
    - Call `fd_quic_retry_server_verify` to verify the modified token against the initial packet and store the result in `res`.
    - Assert that the result `res` is equal to `FD_QUIC_SUCCESS`, indicating the token verification succeeded.
    - Revert the bit flip in the `token` byte using XOR operation again.
- **Output**: No output is returned; the function uses assertions to verify conditions.


---
### test\_retry\_token\_time<!-- {{#callable:test_retry_token_time}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_retry_unit.c#L267>)

Tests the expiration of retry tokens by verifying them at different timestamps.
- **Inputs**: None
- **Logic and Control Flow**:
    - Defines a static array `token` with predefined values.
    - Initializes `fd_quic_initial_t` structure `initial` with `dst_conn_id_len` set to 8 and assigns `token` to `initial.token`.
    - Sets `initial.token_len` to the size of `token`.
    - Defines `fd_quic_pkt_t` structure `pkt` and initializes it to zero.
    - Defines `aes_key` and `aes_iv` arrays with specific values.
    - Sets `ttl` to 3 billion (3e9).
    - Defines `fd_quic_conn_id_t` `odcid` and `ulong` `rscid`.
    - Uses a macro `TRY` to test `fd_quic_retry_server_verify` function with different timestamps and expected results.
    - The macro `TRY` calls `FD_TEST` to assert the result of `fd_quic_retry_server_verify` against the expected result.
    - Tests are performed with timestamps 0, 7315968, 7315969, 3007315967, 3007315968, 3007315969, and `LONG_MAX`.
- **Output**: No output is returned; the function uses assertions to verify the behavior of retry token expiration.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_retry_unit.c#L299>)

Initializes the environment, runs a series of tests and benchmarks related to QUIC retry mechanisms, and logs the results.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Executes [`test_retry_integrity_tag`](<#test_retry_integrity_tag>) to verify the retry integrity tag implementation.
    - Runs [`bench_retry_create`](<#bench_retry_create>) to benchmark the creation of retry tokens.
    - Executes [`bench_retry_server_verify`](<#bench_retry_server_verify>) to benchmark server-side retry verification.
    - Runs [`bench_retry_client_verify`](<#bench_retry_client_verify>) to benchmark client-side retry verification.
    - Executes [`test_retry_token_malleability`](<#test_retry_token_malleability>) to test the malleability of retry tokens.
    - Runs [`test_retry_token_time`](<#test_retry_token_time>) to ensure retry tokens expire correctly.
    - Logs a notice message indicating the tests passed.
    - Calls `fd_halt` to clean up and terminate the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`test_retry_integrity_tag`](<#test_retry_integrity_tag>)
    - [`bench_retry_create`](<#bench_retry_create>)
    - [`bench_retry_server_verify`](<#bench_retry_server_verify>)
    - [`bench_retry_client_verify`](<#bench_retry_client_verify>)
    - [`test_retry_token_malleability`](<#test_retry_token_malleability>)
    - [`test_retry_token_time`](<#test_retry_token_time>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)