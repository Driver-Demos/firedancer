<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for QUIC keep-alive functionality, connection timeouts, and connection management in the Firedancer codebase.

# Purpose
The code is a test suite for a QUIC (Quick UDP Internet Connections) implementation. It is designed to test various aspects of QUIC connections, including connection establishment, handshake completion, and connection timeout handling. The code includes functions to initialize and manage QUIC connections between a client and a server, simulate connection activity, and verify the correct behavior of the QUIC protocol under different conditions. The test suite uses callback functions to track the state of connections and validate that the expected events occur, such as the completion of handshakes and the expiration of idle timeouts.

The main function sets up the testing environment by initializing the necessary resources, such as random number generators and shared memory workspaces. It configures the client and server QUIC instances with specific limits and parameters, such as connection counts and timeout values. The code then runs a series of tests to verify the behavior of the QUIC implementation, including tests for keep-alive functionality, connection termination, and handling of timed-out connections. The test suite ensures that the QUIC implementation adheres to expected behaviors and constraints, providing a framework for validating the reliability and correctness of the QUIC protocol in various scenarios.
# Imports and Dependencies

---
- `../fd_quic.h`
- `fd_quic_test_helpers.h`


# Global Variables

---
### server\_complete
- **Type**: `int`
- **Description**: Indicates whether the server connection process is complete.
- **Use**: Used to track the completion status of the server connection in the QUIC protocol test.


---
### client\_complete
- **Type**: `int`
- **Description**: Indicates whether the client handshake process is complete.
- **Use**: Used to track the completion status of the client handshake in the QUIC connection process.


---
### server\_conn
- **Type**: ``fd_quic_conn_t *``
- **Description**: A pointer to an `fd_quic_conn_t` structure, which represents a QUIC connection on the server side. It is initialized to `NULL` and later assigned a value when a new connection is established.
- **Use**: Used to store and manage the state of a server-side QUIC connection during the execution of the program.


---
### called\_final
- **Type**: `int`
- **Description**: A global integer variable initialized to 0.
- **Use**: Tracks whether the `my_connection_final` function has been called by setting its value to 1.


---
### my\_connection\_new
- **Type**: `function`
- **Description**: Initializes a new connection by setting the `server_complete` flag to 1 and assigning the provided connection pointer to the global `server_conn` variable.
- **Use**: Used as a callback function to handle new connection events in the QUIC server.


---
### my\_handshake\_complete
- **Type**: `function`
- **Description**: Executes when a QUIC handshake is complete for a client connection. It sets the global variable `client_complete` to 1, indicating that the client handshake process has finished.
- **Use**: Used as a callback function to update the handshake completion status for a client connection.


---
### my\_connection\_final
- **Type**: `function`
- **Description**: Executes when a connection is finalized in the QUIC protocol. It sets the global variable `called_final` to 1 to indicate that the finalization process has occurred.
- **Use**: Used as a callback function to mark the completion of a connection's lifecycle.


---
### now
- **Type**: `long`
- **Description**: Represents a global variable that acts as a simulated clock or timestamp in the program.
- **Use**: Used to track and update the current time in the QUIC connection tests.


# Functions

---
### test\_init<!-- {{#callable:test_init}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_keep_alive.c#L33>)

Initializes and establishes a QUIC connection between a client and server, ensuring both handshakes complete successfully.
- **Inputs**:
    - `client_quic`: A pointer to the `fd_quic_t` structure representing the client QUIC instance.
    - `server_quic`: A pointer to the `fd_quic_t` structure representing the server QUIC instance.
- **Logic and Control Flow**:
    - Set `server_complete`, `client_complete`, and `server_conn` to initial values (0 and NULL).
    - Reset the metrics of both `server_quic` and `client_quic` to zero using `fd_memset`.
    - Initialize both `server_quic` and `client_quic` using `fd_quic_init` and validate their states.
    - Set the `now` field of both client and server QUIC states to the global `now` variable.
    - Establish a connection from the client using `fd_quic_connect` and verify the connection is successful.
    - Run a loop 20 times to service both client and server QUIC instances, logging progress and checking if both handshakes are complete.
    - Verify that both `server_complete` and `client_complete` are true and that `server_conn` is not NULL before returning the client connection.
- **Output**: Returns a pointer to the `fd_quic_conn_t` structure representing the client connection.


---
### walk\_timeout\_period<!-- {{#callable:walk_timeout_period}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_keep_alive.c#L68>)

Simulates the passage of time in a QUIC connection by incrementing the global clock and servicing client and server connections in steps of one-eighth of the idle timeout period.
- **Inputs**:
    - ``client_conn``: A pointer to the client QUIC connection structure.
    - ``server_quic``: A pointer to the server QUIC structure.
    - ``eighths``: The number of eighths of the idle timeout period to simulate.
- **Logic and Control Flow**:
    - Retrieve the `quic` field from `client_conn` to get the client QUIC structure.
    - Determine the minimum idle timeout between the server and client configurations.
    - Verify that the idle timeout for both server and client connections matches the calculated minimum idle timeout.
    - Calculate the timestep as one-eighth of the idle timeout.
    - Iterate `eighths` times, incrementing the global `now` by the timestep in each iteration.
    - In each iteration, service the client and server QUIC connections with the updated `now`.
    - Check if the client connection is active and if the current time is at least half the idle timeout since the last activity, then verify the next timeout for the client connection.
    - Check if the server connection is active, then verify the next timeout for the server connection.
- **Output**: Returns the calculated timestep, which is one-eighth of the idle timeout period.


---
### test\_quic\_keep\_alive<!-- {{#callable:test_quic_keep_alive}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_keep_alive.c#L96>)

Tests the behavior of a QUIC connection with and without the keep-alive feature.
- **Inputs**:
    - `client_quic`: A pointer to the client QUIC configuration and state.
    - `server_quic`: A pointer to the server QUIC configuration and state.
    - `keep_alive`: An integer flag indicating whether the keep-alive feature is enabled (non-zero) or disabled (zero).
- **Logic and Control Flow**:
    - Set `called_final` to 0 to reset the finalization state.
    - Set the `keep_alive` configuration of `client_quic` to the provided `keep_alive` value.
    - Initialize a client connection using [`test_init`](<#test_init>), which sets up the client and server QUIC states and performs a handshake.
    - Call [`walk_timeout_period`](<#walk_timeout_period>) to simulate the passage of time and service the QUIC connections.
    - If `keep_alive` is enabled, verify that the server connection remains active and the next timeout is correctly set.
    - If `keep_alive` is disabled, verify that the server connection is either invalid or dead and that `called_final` is set to 1, indicating the connection finalization callback was called.
- **Output**: No return value; the function performs tests and assertions to validate QUIC connection behavior.
- **Functions Called**:
    - [`test_init`](<#test_init>)
    - [`walk_timeout_period`](<#walk_timeout_period>)


---
### test\_quic\_let\_die<!-- {{#callable:test_quic_let_die}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_keep_alive.c#L114>)

Simulates a QUIC connection's lifecycle to ensure it transitions to a dead or invalid state after a timeout.
- **Inputs**:
    - `client_quic`: A pointer to the client QUIC instance.
    - `server_quic`: A pointer to the server QUIC instance.
- **Logic and Control Flow**:
    - Set `called_final` to 0 to indicate the final callback has not been called yet.
    - Initialize a client connection using [`test_init`](<#test_init>), which sets up the QUIC connection between client and server.
    - Calculate `timestep` as one-eighth of the client's idle timeout period.
    - Invoke `fd_quic_conn_let_die` to simulate the connection's lifecycle with the calculated `timestep`.
    - Call [`walk_timeout_period`](<#walk_timeout_period>) to simulate the passage of time and process the connection state over 8 time steps.
    - Verify that the server connection's state is either `FD_QUIC_CONN_STATE_INVALID` or `FD_QUIC_CONN_STATE_DEAD`.
    - Check that `called_final` is set, indicating the final callback was executed.
- **Output**: No return value; the function performs tests and assertions to validate connection state transitions.
- **Functions Called**:
    - [`test_init`](<#test_init>)
    - [`walk_timeout_period`](<#walk_timeout_period>)


---
### test\_quic\_free\_timed\_out<!-- {{#callable:test_quic_free_timed_out}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_keep_alive.c#L127>)

Tests the behavior of QUIC connections when they time out and ensures that timed-out connections are freed to allow new connections.
- **Inputs**:
    - `client_quic`: A pointer to the client QUIC instance.
    - `server_quic`: A pointer to the server QUIC instance.
- **Logic and Control Flow**:
    - Initialize the client and server QUIC connections using [`test_init`](<#test_init>) and store the original connections.
    - Calculate the number of connections allowed by the server and the original timeout count.
    - Increment the global time by one-eighth of the client's idle timeout.
    - Attempt to create connections up to the server's connection limit, expecting the last connection attempt to fail.
    - Verify that the server's connection timeout count has not changed after the connection attempts.
    - Simulate the passage of time using [`walk_timeout_period`](<#walk_timeout_period>) to trigger a timeout on the original connections.
    - Check that the original server and client connections have timed out and the server's timeout count has increased by one.
    - Attempt to create a new connection, expecting it to succeed due to the freed space from the timed-out connection.
    - Verify that the new connection is active and the server's timeout count remains consistent.
- **Output**: No return value; the function performs tests and assertions to validate connection timeout behavior.
- **Functions Called**:
    - [`test_init`](<#test_init>)
    - [`walk_timeout_period`](<#walk_timeout_period>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_keep_alive.c#L173>)

Initializes and tests a QUIC server-client setup with various configurations and scenarios.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` and [`fd_quic_test_boot`](<fd_quic_test_helpers.c.md#fd_quic_test_boot>) to initialize the environment and QUIC test setup.
    - Creates a random number generator using `fd_rng_new` and `fd_rng_join`.
    - Determines the CPU index and adjusts it if it exceeds the shared memory CPU count.
    - Parses command-line arguments for page size, page count, and NUMA index using `fd_env_strip_cmdline_cstr` and `fd_env_strip_cmdline_ulong`.
    - Converts the page size string to an actual size using `fd_cstr_to_shmem_page_sz` and logs an error if unsupported.
    - Creates an anonymous workspace with the specified page size and count using `fd_wksp_new_anonymous`.
    - Defines QUIC limits and calculates the QUIC footprint using `fd_quic_footprint`.
    - Creates anonymous QUIC server and client instances with the specified limits and roles using [`fd_quic_new_anonymous`](<fd_quic_test_helpers.c.md#fd_quic_new_anonymous>).
    - Assigns callback functions for connection events to the server and client QUIC instances.
    - Configures idle timeout and acknowledgment delay for both server and client QUIC instances.
    - Initializes a virtual pair for the server and client QUIC instances using [`fd_quic_virtual_pair_init`](<fd_quic_test_helpers.c.md#fd_quic_virtual_pair_init>).
    - Runs various tests on the QUIC setup, including keep-alive, let-die, and free-timed-out scenarios.
    - Finalizes the virtual pair and cleans up resources by deleting and freeing the QUIC instances and workspace.
    - Logs a notice indicating the tests passed and halts the QUIC test and environment.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`fd_quic_test_boot`](<fd_quic_test_helpers.c.md#fd_quic_test_boot>)
    - [`fd_quic_new_anonymous`](<fd_quic_test_helpers.c.md#fd_quic_new_anonymous>)
    - [`fd_quic_virtual_pair_init`](<fd_quic_test_helpers.c.md#fd_quic_virtual_pair_init>)
    - [`test_quic_keep_alive`](<#test_quic_keep_alive>)
    - [`test_quic_let_die`](<#test_quic_let_die>)
    - [`test_quic_free_timed_out`](<#test_quic_free_timed_out>)
    - [`fd_quic_virtual_pair_fini`](<fd_quic_test_helpers.c.md#fd_quic_virtual_pair_fini>)
    - [`fd_quic_test_halt`](<fd_quic_test_helpers.c.md#fd_quic_test_halt>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)