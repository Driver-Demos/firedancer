<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for QUIC handshake functionality, including connection setup, data transmission, and TLS cache validation.

# Purpose
The code is a C program that tests the functionality of a QUIC (Quick UDP Internet Connections) protocol implementation. It includes the necessary headers for QUIC operations and test helpers. The program sets up a QUIC server and client, establishes a connection between them, and performs various operations to validate the QUIC handshake, stream data transmission, and connection management. The program defines callback functions for handling new connections and stream data reception, which are used to log and verify the data received over the QUIC streams.

The main function initializes the QUIC server and client, configures their parameters, and creates a virtual pair to simulate network communication. It then performs a series of operations, including establishing connections, sending data over streams, and testing keep-alive functionality. The program also validates the TLS handshake cache to ensure proper management of handshake states. After completing the tests, the program cleans up resources and halts execution. The code is structured to test the QUIC protocol's capabilities, including connection establishment, data transmission, and resource management, making it a comprehensive test suite for QUIC implementations.
# Imports and Dependencies

---
- `../fd_quic.h`
- `../fd_quic_private.h`
- `fd_quic_test_helpers.h`
- `stdio.h`
- `stdlib.h`


# Global Variables

---
### server\_complete
- **Type**: `int`
- **Description**: Indicates whether the server handshake process is complete.
- **Use**: Used to track the completion status of the server handshake in the QUIC connection process.


---
### client\_complete
- **Type**: `int`
- **Description**: Indicates whether the client handshake process is complete.
- **Use**: Used to track the completion status of the client handshake in the QUIC protocol.


---
### server\_conn
- **Type**: ``fd_quic_conn_t *``
- **Description**: A pointer to an `fd_quic_conn_t` structure, which represents a QUIC connection in the system. Initially, it is set to `NULL` and later assigned a value when a new server connection is established.
- **Use**: Used to store the server connection object once the server handshake is complete.


---
### now
- **Type**: `long`
- **Description**: Represents a global variable that acts as a clock or timestamp in the program.
- **Use**: Used to track and update the current time throughout the QUIC connection operations.


# Functions

---
### my\_stream\_rx\_cb<!-- {{#callable:my_stream_rx_cb}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_hs.c#L8>)

Validates received QUIC stream data against specific conditions and logs debug information.
- **Inputs**:
    - ``conn``: A pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
    - ``stream_id``: An unsigned long integer representing the identifier of the stream.
    - ``offset``: An unsigned long integer representing the offset of the data in the stream.
    - ``data``: A pointer to an array of unsigned characters representing the data received.
    - ``data_sz``: An unsigned long integer representing the size of the data received.
    - ``fin``: An integer indicating if this is the final part of the data (1 if true, 0 if false).
- **Logic and Control Flow**:
    - Logs the stream ID, data size, and offset using `FD_LOG_DEBUG`.
    - Checks if the `offset` is aligned to 512 bytes using `FD_TEST` and `fd_ulong_is_aligned`.
    - Logs a hex dump of the received data using `FD_LOG_HEXDUMP_DEBUG`.
    - Validates that `data_sz` is exactly 512 bytes using `FD_TEST`.
    - Ensures that `fin` is false (0) using `FD_TEST`.
    - Compares the first 11 bytes of `data` to the string "Hello world" using `FD_TEST` and `memcmp`.
    - Returns `FD_QUIC_SUCCESS` if all tests pass.
- **Output**: Returns `FD_QUIC_SUCCESS` if all conditions are met.


---
### my\_connection\_new<!-- {{#callable:my_connection_new}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_hs.c#L33>)

Handles the completion of a server-side QUIC handshake by logging a notice, setting a completion flag, and storing the connection.
- **Inputs**:
    - ``conn``: A pointer to an `fd_quic_conn_t` structure representing the server connection that has completed the handshake.
    - ``vp_context``: A void pointer to additional context, which is not used in this function.
- **Logic and Control Flow**:
    - Logs a notice message indicating that the server handshake is complete.
    - Sets the global variable `server_complete` to 1 to indicate that the server handshake has completed.
    - Assigns the `conn` pointer to the global variable `server_conn` to store the connection for future use.
- **Output**: No return value; the function operates through side effects on global variables and logging.


---
### my\_handshake\_complete<!-- {{#callable:my_handshake_complete}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_hs.c#L44>)

Marks the client handshake as complete by setting the `client_complete` flag to 1 and logs a notice.
- **Inputs**:
    - ``conn``: A pointer to an `fd_quic_conn_t` structure representing the QUIC connection; it is not used in the function.
    - ``vp_context``: A pointer to a context object; it is not used in the function.
- **Logic and Control Flow**:
    - Logs a notice message indicating that the client handshake is complete.
    - Sets the global variable `client_complete` to 1 to indicate that the client handshake has completed.
- **Output**: No return value; the function operates by side effects on global state.


---
### validate\_quic\_hs\_tls\_cache<!-- {{#callable:validate_quic_hs_tls_cache}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_hs.c#L55>)

Validates the QUIC handshake TLS cache by ensuring the cache entries are in non-decreasing order of birthtime and that the cache count matches the used pool count.
- **Inputs**:
    - ``quic``: A pointer to an `fd_quic_t` structure representing the QUIC instance to validate.
- **Logic and Control Flow**:
    - Retrieve the QUIC state using `fd_quic_get_state` and store it in `state`.
    - Access the handshake TLS cache from `state` and store it in `hs_cache`.
    - Access the handshake pool from `state` and store it in `pool`.
    - Initialize `cache_cnt` to 0 and `prev_birth` to 0.
    - Iterate over the handshake cache using a forward iterator initialized by `fd_quic_tls_hs_cache_iter_fwd_init`.
    - For each element in the cache, retrieve the handshake structure using `fd_quic_tls_hs_cache_iter_ele`.
    - Check that the `birthtime` of the current handshake structure is greater than or equal to `prev_birth`.
    - Update `prev_birth` to the current handshake structure's `birthtime`.
    - Increment `cache_cnt` for each element in the cache.
    - After the loop, verify that `cache_cnt` equals the number of used entries in the handshake pool using `fd_quic_tls_hs_pool_used`.
- **Output**: No return value; the function performs validation checks and uses `FD_TEST` to assert conditions.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_hs.c#L80>)

Initializes and tests a QUIC server and client, including connection establishment, data transmission, and cleanup.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
- **Logic and Control Flow**:
    - Initialize the environment and QUIC test framework with `fd_boot` and [`fd_quic_test_boot`](<fd_quic_test_helpers.c.md#fd_quic_test_boot>).
    - Create a random number generator `rng` using `fd_rng_new` and `fd_rng_join`.
    - Determine the CPU index and adjust if it exceeds the shared memory CPU count.
    - Parse command-line arguments for page size, page count, and NUMA index using `fd_env_strip_cmdline_cstr` and `fd_env_strip_cmdline_ulong`.
    - Convert the page size string to a numeric value with `fd_cstr_to_shmem_page_sz` and log an error if unsupported.
    - Create an anonymous workspace with `fd_wksp_new_anonymous` and verify its creation.
    - Define QUIC limits and calculate the QUIC footprint using `fd_quic_footprint`.
    - Create server and client QUIC instances with [`fd_quic_new_anonymous`](<fd_quic_test_helpers.c.md#fd_quic_new_anonymous>) and set their callbacks for connection and stream events.
    - Initialize a virtual pair for the server and client QUICs using [`fd_quic_virtual_pair_init`](<fd_quic_test_helpers.c.md#fd_quic_virtual_pair_init>).
    - Initialize the QUIC instances with `fd_quic_init` and validate their states.
    - Establish a client connection with `fd_quic_connect` and perform general processing in a loop to complete handshakes.
    - Create streams for data transmission using `fd_quic_conn_new_stream` and send data over these streams in a loop.
    - Test the keep-alive functionality by adjusting the `keep_alive` configuration and verifying connection states.
    - Close the connections with `fd_quic_conn_close` and wait for acknowledgments in a loop.
    - Validate the QUIC state and TLS handshake cache, testing eviction behavior based on TTL.
    - Clean up resources by finalizing the virtual pair, deleting QUIC instances, and halting the test.
- **Output**: Returns 0 upon successful execution.
- **Functions Called**:
    - [`fd_quic_test_boot`](<fd_quic_test_helpers.c.md#fd_quic_test_boot>)
    - [`fd_quic_new_anonymous`](<fd_quic_test_helpers.c.md#fd_quic_new_anonymous>)
    - [`fd_quic_virtual_pair_init`](<fd_quic_test_helpers.c.md#fd_quic_virtual_pair_init>)
    - [`validate_quic_hs_tls_cache`](<#validate_quic_hs_tls_cache>)
    - [`fd_quic_virtual_pair_fini`](<fd_quic_test_helpers.c.md#fd_quic_virtual_pair_fini>)
    - [`fd_quic_test_halt`](<fd_quic_test_helpers.c.md#fd_quic_test_halt>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)