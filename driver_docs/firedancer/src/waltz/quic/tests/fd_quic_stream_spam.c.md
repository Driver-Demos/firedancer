<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for QUIC stream spam generation and management functions in the Firedancer codebase.

# Purpose
The code provides functionality for managing and sending QUIC streams with generated payloads. It defines several functions that operate on a data structure `fd_quic_stream_spam_t`, which is used to handle the generation and transmission of data over QUIC streams. The primary functions include [`fd_quic_stream_spam_new`](<#fd_quic_stream_spam_new>), which initializes a new `fd_quic_stream_spam_t` instance, and [`fd_quic_stream_spam_service`](<#fd_quic_stream_spam_service>), which manages the sending of data over a QUIC connection. The [`fd_quic_stream_spam_service`](<#fd_quic_stream_spam_service>) function generates payloads using a user-defined function and sends them over a QUIC stream, handling errors and flow control.

The code also includes utility functions such as [`fd_quic_stream_spam_join`](<#fd_quic_stream_spam_join>), [`fd_quic_stream_spam_leave`](<#fd_quic_stream_spam_leave>), and [`fd_quic_stream_spam_delete`](<#fd_quic_stream_spam_delete>), which manage the lifecycle of the `fd_quic_stream_spam_t` instances. The [`fd_quic_stream_spam_notify`](<#fd_quic_stream_spam_notify>) function handles notifications related to stream deallocation, and [`fd_quic_stream_spam_gen`](<#fd_quic_stream_spam_gen>) generates random payload data for the streams. The code is intended to be part of a larger system that uses QUIC for data transmission, and it provides a specific implementation for generating and sending data over QUIC streams.
# Imports and Dependencies

---
- `fd_quic_stream_spam.h`


# Functions

---
### fd\_quic\_stream\_spam\_new<!-- {{#callable:fd_quic_stream_spam_new}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_stream_spam.c#L3>)

Initializes a `fd_quic_stream_spam_t` structure with a generator function and context, ensuring memory alignment.
- **Inputs**:
    - `mem`: A pointer to the memory location where the `fd_quic_stream_spam_t` structure will be initialized.
    - `gen_fn`: A function pointer of type `fd_quic_stream_gen_spam_t` used to generate stream payloads.
    - `gen_ctx`: A pointer to the context that will be used by the generator function.
- **Logic and Control Flow**:
    - Check if `mem` is NULL; if true, log a warning and return NULL.
    - Check if `mem` is aligned to the alignment requirements of `fd_quic_stream_spam_t`; if not, log a warning and return NULL.
    - Cast `mem` to a `fd_quic_stream_spam_t` pointer and zero out the memory using `memset`.
    - Assign `gen_fn` to the `gen_fn` field of the `fd_quic_stream_spam_t` structure.
    - Assign `gen_ctx` to the `gen_ctx` field of the `fd_quic_stream_spam_t` structure.
    - Return the pointer to the initialized `fd_quic_stream_spam_t` structure.
- **Output**: A pointer to the initialized `fd_quic_stream_spam_t` structure, or NULL if there is an error.


---
### fd\_quic\_stream\_spam\_join<!-- {{#callable:fd_quic_stream_spam_join}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_stream_spam.c#L25>)

Validates and casts a pointer to a `fd_quic_stream_spam_t` type if it is non-null and properly aligned.
- **Inputs**:
    - `shspam`: A pointer to a memory location that is expected to be of type `fd_quic_stream_spam_t`.
- **Logic and Control Flow**:
    - Check if `shspam` is NULL; if true, log a warning and return NULL.
    - Check if `shspam` is aligned to the alignment requirements of `fd_quic_stream_spam_t`; if not, log a warning and return NULL.
    - Cast `shspam` to a `fd_quic_stream_spam_t` pointer and return it.
- **Output**: Returns a pointer to `fd_quic_stream_spam_t` if the input is valid; otherwise, returns NULL.


---
### fd\_quic\_stream\_spam\_leave<!-- {{#callable:fd_quic_stream_spam_leave}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_stream_spam.c#L40>)

Returns the input `fd_quic_stream_spam_t` pointer cast to a `void` pointer.
- **Inputs**:
    - `spam`: A pointer to an `fd_quic_stream_spam_t` structure.
- **Logic and Control Flow**:
    - Casts the `spam` pointer to a `void` pointer.
    - Returns the casted pointer.
- **Output**: A `void` pointer that is the casted input `spam` pointer.


---
### fd\_quic\_stream\_spam\_delete<!-- {{#callable:fd_quic_stream_spam_delete}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_stream_spam.c#L45>)

Returns the input pointer `shspam` without modification.
- **Inputs**:
    - `shspam`: A pointer to a memory block or object to be deleted.
- **Logic and Control Flow**:
    - Return the input pointer `shspam`.
- **Output**: The same pointer `shspam` that was passed as input.


---
### fd\_quic\_stream\_spam\_service<!-- {{#callable:fd_quic_stream_spam_service}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_stream_spam.c#L50>)

Sends data over a QUIC connection using a stream, generating payloads and handling errors.
- **Inputs**:
    - ``conn``: A pointer to an `fd_quic_conn_t` structure representing the QUIC connection.
    - ``spam``: A pointer to an `fd_quic_stream_spam_t` structure containing the stream and a function to generate payloads.
- **Logic and Control Flow**:
    - Initialize `streams_sent` to 0.
    - Enter an infinite loop to attempt sending data over a stream.
    - Check if `spam->stream` is NULL; if so, create a new stream using `fd_quic_conn_new_stream`.
    - If stream creation fails, exit the loop.
    - Retrieve the stream ID and set `spam->stream` to NULL.
    - Generate a payload using `spam->gen_fn` and store it in `payload_buf`.
    - Attempt to send the payload using `fd_quic_stream_send`.
    - If sending is successful, increment `streams_sent`, log the success, and break the loop.
    - If sending fails with an error other than `FD_QUIC_SEND_ERR_FLOW`, log a warning, set `streams_sent` to -1, and exit the loop.
    - If the error is `FD_QUIC_SEND_ERR_FLOW`, store the stream back in `spam->stream` and exit the loop.
    - Return the value of `streams_sent`.
- **Output**: Returns the number of streams successfully sent, or -1 if an error occurs.


---
### fd\_quic\_stream\_spam\_notify<!-- {{#callable:fd_quic_stream_spam_notify}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_stream_spam.c#L92>)

Marks a stream as a 'tombstone' in the pending stack to skip it during unwinding.
- **Inputs**:
    - `stream`: A pointer to the `fd_quic_stream_t` structure representing the stream to be notified.
    - `stream_ctx`: A pointer to the context associated with the stream, which indicates its position in the pending list.
    - `notify_type`: An integer representing the type of notification, though it is not used in this function.
- **Logic and Control Flow**:
    - Ignores the `stream` and `notify_type` parameters as they are not used in the function.
    - Checks if `stream_ctx` is NULL using `FD_LIKELY`; if true, the function returns immediately as there is nothing to do for completed streams.
    - If `stream_ctx` is not NULL, it casts `stream_ctx` to a double pointer to `fd_quic_stream_t` and sets the dereferenced value to NULL, marking it as a 'tombstone'.
- **Output**: No output is returned from this function as it is a void function.


---
### fd\_quic\_stream\_spam\_gen<!-- {{#callable:fd_quic_stream_spam_gen}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_stream_spam.c#L112>)

Generates random data to fill a packet buffer for a QUIC stream.
- **Inputs**:
    - `ctx`: A context pointer, which is not used in this function.
    - `pkt`: A pointer to an `fd_aio_pkt_info_t` structure that contains the buffer to fill with random data.
    - `stream_id`: An unsigned long integer representing the stream identifier, used to seed the random number generator.
- **Logic and Control Flow**:
    - Ignore the `ctx` parameter as it is not used.
    - Initialize a random number generator (`rng`) using the `stream_id` as a seed.
    - Determine the size of random data to generate, which is a random number up to the size of the packet buffer (`pkt->buf_sz`).
    - Update `pkt->buf_sz` to the determined random data size.
    - Fill the packet buffer with random data, ensuring the data is aligned to 8 bytes.
    - Clean up the random number generator by leaving and deleting it.
- **Output**: The function does not return a value; it modifies the `pkt` structure in place by filling its buffer with random data and updating its size.



---
Made with ❤️ by [Driver](https://www.driver.ai/)