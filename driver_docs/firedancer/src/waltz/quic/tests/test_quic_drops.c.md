<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests QUIC protocol functionality by simulating client-server communication with stream handling and packet dropping.

# Purpose
The code is a C program that tests a QUIC (Quick UDP Internet Connections) implementation. It sets up a client-server architecture using QUIC, where both the client and server are represented as fibers. The program includes functions to handle QUIC connections, stream notifications, and data reception. It defines several callback functions such as [`my_stream_notify_cb`](<#my_stream_notify_cb>), [`my_stream_rx_cb`](<#my_stream_rx_cb>), [`my_cb_conn_final`](<#my_cb_conn_final>), [`my_connection_new`](<#my_connection_new>), and [`my_handshake_complete`](<#my_handshake_complete>) to manage the lifecycle of QUIC connections and streams. The program uses a virtual pair to simulate network conditions and includes mechanisms to handle packet loss and delays.

The main function initializes the QUIC client and server, sets up the necessary configurations, and creates fibers for both the client and server. It uses a workspace for memory management and sets up a test environment with a random number generator and network emulation. The client and server fibers are scheduled to run, and the program continues to execute until all streams are processed and connections are tested. The program logs various events and results, such as the number of received stream fragments and tested connections, and performs cleanup operations before exiting.
# Imports and Dependencies

---
- `../fd_quic.h`
- `fd_quic_test_helpers.h`
- `../../../util/rng/fd_rng.h`
- `../../../util/fibre/fd_fibre.h`
- `stdlib.h`


# Global Variables

---
### client\_done
- **Type**: `int`
- **Description**: Indicates whether the client has completed its operations.
- **Use**: Used as a flag to signal the completion of client operations, transitioning from 0 to 1 when all streams have been received.


---
### server\_done
- **Type**: `int`
- **Description**: Indicates whether the server has completed its operations.
- **Use**: Used as a flag to signal the server to shut down when set to 1.


---
### rcvd
- **Type**: `ulong`
- **Description**: `rcvd` is a global variable of type `ulong` that tracks the number of data fragments received from a peer in a QUIC connection.
- **Use**: Used to incrementally count the number of received data fragments during the execution of the `my_stream_rx_cb` callback function.


---
### tot\_rcvd
- **Type**: `ulong`
- **Description**: `tot_rcvd` is a global variable of type `ulong` that tracks the total number of data streams received.
- **Use**: Used to count the total number of streams received and determine when the client has completed receiving all streams.


---
### client\_fibre
- **Type**: `fd_fibre_t *`
- **Description**: A pointer to a `fd_fibre_t` structure, which represents a fibre used in the client-side operations of the application.
- **Use**: Used to manage and execute client-side fibre operations in the application.


---
### server\_fibre
- **Type**: `fd_fibre_t *`
- **Description**: A pointer to an `fd_fibre_t` structure, which represents a fibre used in the server context of the application.
- **Use**: Used to manage and execute server-side operations in a fibre-based concurrency model.


---
### net\_fibre
- **Type**: `fd_fibre_t *`
- **Description**: A pointer to a `fd_fibre_t` structure, initialized to `NULL`. This variable is used to manage a fibre that simulates network operations such as dropping and capturing packets.
- **Use**: Used to manage network operations in a fibre context.


---
### state
- **Type**: `int`
- **Description**: A global integer variable initialized to 0.
- **Use**: Tracks the current state of the program or a specific process.


---
### server\_complete
- **Type**: `int`
- **Description**: Indicates whether the server has completed its handshake process.
- **Use**: Used to signal the completion of the server's handshake in the `my_connection_new` function.


---
### client\_complete
- **Type**: `int`
- **Description**: Indicates whether the client handshake process is complete.
- **Use**: Used to signal the completion of the client handshake in the QUIC protocol.


---
### pkt\_full
- **Type**: `uchar[]`
- **Description**: `pkt_full` is an external array of unsigned characters (`uchar`) that is declared but not defined in the provided code. It is likely used to store packet data.
- **Use**: Used to store packet data for operations involving packet processing or transmission.


---
### pkt\_full\_sz
- **Type**: `ulong`
- **Description**: `pkt_full_sz` is a global variable of type `ulong` that represents the size of a packet.
- **Use**: Used to store the size of the packet data in `pkt_full`.


---
### fail
- **Type**: `uchar`
- **Description**: A global variable of type `uchar` initialized to 0.
- **Use**: Indicates failure status in the program.


---
### conn\_final\_cnt
- **Type**: `ulong`
- **Description**: `conn_final_cnt` is a static unsigned long integer variable that counts the number of final connection callbacks executed in the QUIC protocol test.
- **Use**: Tracks the number of times the `my_cb_conn_final` callback function is called, indicating the completion of connections.


---
### now
- **Type**: `long`
- **Description**: Represents a global variable `now` initialized to a large integer value `1e18L`. This variable is used as a global clock to synchronize operations in the program.
- **Use**: Used to keep track of the current time in nanoseconds for synchronization purposes in the QUIC protocol operations.


# Data Structures

---
### net\_fibre\_args
- **Type**: ``struct``
- **Members**:
    - ``input``: Pointer to an `fd_fibre_pipe_t` structure for input operations.
    - ``release``: Pointer to an `fd_fibre_pipe_t` structure for release operations.
    - ``thresh``: Floating-point threshold value.
    - ``dir``: Integer indicating direction, where 0 is client-to-server and 1 is server-to-client.
- **Description**: Defines arguments for network fiber operations, including input and release pipes, a threshold value, and a direction indicator for data flow between client and server.


---
### net\_fibre\_args\_t
- **Type**: ``struct``
- **Members**:
    - ``input``: Pointer to an `fd_fibre_pipe_t` structure for input.
    - ``release``: Pointer to an `fd_fibre_pipe_t` structure for release.
    - ``thresh``: Floating-point threshold value.
    - ``dir``: Integer indicating direction, where 0 is client-to-server and 1 is server-to-client.
- **Description**: Defines the arguments for a network fibre, including input and release pipes, a threshold value, and a direction indicator for data flow between client and server.


---
### my\_context
- **Type**: ``struct``
- **Members**:
    - `server`: An integer that likely represents a server identifier or status.
- **Description**: Defines a context structure named `my_context` with a single integer member `server`. This structure is used to encapsulate server-related information, potentially for managing server state or configuration in a network communication context.


---
### my\_context\_t
- **Type**: ``struct``
- **Members**:
    - `server`: Indicates if the context is for a server (non-zero) or not (zero).
- **Description**: `my_context_t` is a structure that contains a single integer member `server`, which is used to indicate whether the context is associated with a server. This structure is likely used to manage or differentiate between server and client contexts in a network communication setup.


---
### client\_args
- **Type**: ``struct``
- **Members**:
    - `quic`: A pointer to an `fd_quic_t` structure representing the client's QUIC instance.
    - `server_quic`: A pointer to an `fd_quic_t` structure representing the server's QUIC instance.
- **Description**: The `client_args` structure holds pointers to QUIC instances for both the client and server, facilitating communication and connection management in a QUIC-based network application.


---
### client\_args\_t
- **Type**: ``struct``
- **Members**:
    - ``quic``: Pointer to a `fd_quic_t` structure representing the client's QUIC instance.
    - ``server_quic``: Pointer to a `fd_quic_t` structure representing the server's QUIC instance.
- **Description**: `client_args_t` is a structure that holds pointers to two `fd_quic_t` instances, one for the client and one for the server, facilitating the management of QUIC connections in a client-server setup.


---
### server\_args
- **Type**: ``struct``
- **Members**:
    - ``quic``: A pointer to an `fd_quic_t` structure, representing the QUIC server.
    - ``client_quic``: A pointer to an `fd_quic_t` structure, representing the QUIC client.
- **Description**: The `server_args` structure holds pointers to two `fd_quic_t` structures, one for the server and one for the client, facilitating the setup and management of QUIC connections in a server-client architecture.


---
### server\_args\_t
- **Type**: ``struct``
- **Members**:
    - ``quic``: Pointer to a `fd_quic_t` structure representing the server's QUIC instance.
    - ``client_quic``: Pointer to a `fd_quic_t` structure representing the client's QUIC instance.
- **Description**: `server_args_t` is a structure that holds arguments for the server fiber function, specifically pointers to the server's and client's QUIC instances. This structure is used to pass necessary context to the server fiber function, enabling it to manage and interact with the QUIC protocol instances during execution.


# Functions

---
### my\_stream\_notify\_cb<!-- {{#callable:my_stream_notify_cb}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_drops.c#L48>)

Does nothing with the provided arguments.
- **Inputs**:
    - `stream`: A pointer to an `fd_quic_stream_t` structure, representing the QUIC stream.
    - `ctx`: A pointer to a context, which is not used in this function.
    - `type`: An integer representing the type of notification, which is not used in this function.
- **Logic and Control Flow**:
    - The function takes three parameters: `stream`, `ctx`, and `type`.
    - Each parameter is explicitly cast to void to indicate that they are unused.
- **Output**: No output or return value; the function is a no-op.


---
### my\_stream\_rx\_cb<!-- {{#callable:my_stream_rx_cb}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_drops.c#L55>)

Handles received data on a QUIC stream, logs the data, increments counters, and checks if all streams are received.
- **Inputs**:
    - `conn`: A pointer to the QUIC connection object, which is not used in the function.
    - `stream_id`: The identifier of the stream, which is not used in the function.
    - `offset`: The offset of the data in the stream, which is not used in the function.
    - `data`: A pointer to the received data buffer.
    - `data_sz`: The size of the received data buffer.
    - `fin`: An integer indicating if this is the final data fragment, which is not used in the function.
- **Logic and Control Flow**:
    - Logs a debug message with a hexdump of the received data.
    - Logs a debug message indicating successful reception.
    - Increments the `rcvd` and `tot_rcvd` counters.
    - Checks if `tot_rcvd` equals `NUM_STREAMS`; if true, sets `client_done` to 1.
    - Returns `FD_QUIC_SUCCESS`.
- **Output**: Returns `FD_QUIC_SUCCESS` to indicate successful processing of the received data.


---
### my\_cb\_conn\_final<!-- {{#callable:my_cb_conn_final}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_drops.c#L86>)

Handles the finalization of a QUIC connection by clearing its context and incrementing a counter.
- **Inputs**:
    - ``conn``: A pointer to the `fd_quic_conn_t` structure representing the QUIC connection to finalize.
    - ``context``: A void pointer to additional context data, which is not used in this function.
- **Logic and Control Flow**:
    - Casts the result of `fd_quic_conn_get_context(conn)` to a double pointer to `fd_quic_conn_t` and assigns it to `ppconn`.
    - Checks if `ppconn` is not NULL.
    - If `ppconn` is not NULL, sets the dereferenced value of `ppconn` to NULL.
    - Increments the global `conn_final_cnt` counter.
- **Output**: No return value; the function operates through side effects on the connection context and a global counter.


---
### my\_connection\_new<!-- {{#callable:my_connection_new}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_drops.c#L100>)

Marks the server handshake as complete by setting the `server_complete` flag to 1.
- **Inputs**:
    - ``conn``: A pointer to an `fd_quic_conn_t` structure representing the connection.
    - ``vp_context``: A pointer to a context, which is not used in this function.
- **Logic and Control Flow**:
    - The function takes two parameters: `conn` and `vp_context`, but does not use them in its logic.
    - Sets the global variable `server_complete` to 1, indicating that the server handshake is complete.
    - The function does not perform any other operations or return any values.
- **Output**: No output is returned from this function.


---
### my\_handshake\_complete<!-- {{#callable:my_handshake_complete}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_drops.c#L112>)

Marks the client handshake as complete by setting the `client_complete` flag to 1.
- **Inputs**:
    - `conn`: A pointer to an `fd_quic_conn_t` structure representing the QUIC connection.
    - `vp_context`: A void pointer to a context, which is not used in this function.
- **Logic and Control Flow**:
    - The function casts `vp_context` to void to indicate it is unused.
    - Sets the global variable `client_complete` to 1, indicating the client handshake is complete.
    - Casts `conn` to void to indicate it is unused.
- **Output**: No output is returned from this function.


---
### test\_fibre\_clock<!-- {{#callable:test_fibre_clock}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_drops.c#L127>)

Returns the current value of the global variable `now`.
- **Inputs**: None
- **Logic and Control Flow**:
    - Accesses the global variable `now`.
    - Returns the value of `now`.
- **Output**: The function returns a `long` integer representing the current value of the global variable `now`.


---
### sync\_clocks<!-- {{#callable:sync_clocks}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_drops.c#L132>)

Synchronizes the `now` field of two `fd_quic_t` structures to a global `now` value.
- **Inputs**:
    - `x`: A pointer to an `fd_quic_t` structure whose `now` field will be synchronized.
    - `y`: A pointer to another `fd_quic_t` structure whose `now` field will also be synchronized.
- **Logic and Control Flow**:
    - Retrieve the state of the `fd_quic_t` structure pointed to by `x` using `fd_quic_get_state(x)`.
    - Retrieve the state of the `fd_quic_t` structure pointed to by `y` using `fd_quic_get_state(y)`.
    - Set the `now` field of both retrieved states to the global `now` value.
- **Output**: No output is returned as the function is of type `void`.


---
### client\_fibre\_fn<!-- {{#callable:client_fibre_fn}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_drops.c#L144>)

Manages a client-side QUIC connection to send data streams to a server, handling connection and stream creation, data transmission, and connection closure.
- **Inputs**:
    - `vp_arg`: A pointer to a `client_args_t` structure containing the QUIC client and server instances.
- **Logic and Control Flow**:
    - Initialize `client_args_t` from `vp_arg` to access `quic` and `server_quic` instances.
    - Set up initial variables including a buffer `buf` with the message 'Hello World!', a send period of 1 millisecond, and initialize `sent` counter.
    - Enter a loop that continues until `client_done` is set to true.
    - Calculate the next wakeup time using `fd_quic_get_next_wakeup` and wait until the minimum of the next wakeup or next send time using `fd_fibre_wait_until`.
    - Synchronize clocks between client and server using [`sync_clocks`](<#sync_clocks>) and service the QUIC client with `fd_quic_service`.
    - If no connection exists, attempt to establish a new connection with `fd_quic_connect`. If successful, set the connection context and wait for the handshake to complete.
    - If no stream exists, check if the received count matches the sent count. If not, service the client and wait for the next wakeup.
    - Attempt to create a new stream with `fd_quic_conn_new_stream`. If unsuccessful, log a warning and continue waiting until a stream is available.
    - Set the next send time and send data over the stream using `fd_quic_stream_send`. If successful, check if 15 messages have been sent, then close the connection and wait for it to be reaped.
    - If sending fails, log a warning and continue.
    - After exiting the loop, close any remaining connection and service it until it is fully closed.
    - Set `server_done` to true to signal the server to shut down.
- **Output**: No return value; the function operates as a side effect by managing the client-side QUIC connection and data transmission.
- **Functions Called**:
    - [`sync_clocks`](<#sync_clocks>)


---
### server\_fibre\_fn<!-- {{#callable:server_fibre_fn}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_drops.c#L304>)

Executes a server-side fibre loop that synchronizes clocks, services QUIC connections, and waits for the next event or a fixed period.
- **Inputs**:
    - `vp_arg`: A pointer to a `server_args_t` structure containing the QUIC server and client instances.
- **Logic and Control Flow**:
    - Cast `vp_arg` to a `server_args_t` pointer and extract `quic` and `client_quic` from it.
    - Set `period_ns` to 1 millisecond in nanoseconds.
    - Enter a loop that continues until `server_done` is non-zero.
    - In each iteration, call [`sync_clocks`](<#sync_clocks>) to synchronize the clocks of `quic` and `client_quic`.
    - Call `fd_quic_service` to process QUIC events for `quic`.
    - Calculate `next_wakeup` using `fd_quic_get_next_wakeup` for `quic`.
    - Calculate `next_period` as the current time plus `period_ns`.
    - Call `fd_fibre_wait_until` with the minimum of `next_wakeup` and `next_period` to wait for the next event or the fixed period.
- **Output**: No return value; the function operates in a loop until `server_done` is set.
- **Functions Called**:
    - [`sync_clocks`](<#sync_clocks>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_drops.c#L325>)

Initializes and runs a QUIC client-server test environment using fibers and virtual network pairs.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
- **Logic and Control Flow**:
    - Bootstraps the environment using `fd_boot` and [`fd_quic_test_boot`](<fd_quic_test_helpers.c.md#fd_quic_test_boot>) functions.
    - Initializes a random number generator `rng` using `fd_rng_new` and `fd_rng_join`.
    - Determines the CPU index and adjusts it if necessary.
    - Parses command-line arguments for page size, page count, and NUMA index using `fd_env_strip_cmdline_cstr` and `fd_env_strip_cmdline_ulong`.
    - Converts the page size string to an actual size using `fd_cstr_to_shmem_page_sz` and logs an error if unsupported.
    - Creates a workspace with the specified parameters using `fd_wksp_new_anonymous`.
    - Defines QUIC limits and calculates the QUIC footprint using `fd_quic_footprint`.
    - Creates server and client QUIC instances using [`fd_quic_new_anonymous`](<fd_quic_test_helpers.c.md#fd_quic_new_anonymous>) and sets their callbacks and configurations.
    - Initializes a virtual pair for the client and server QUICs using [`fd_quic_virtual_pair_init`](<fd_quic_test_helpers.c.md#fd_quic_virtual_pair_init>).
    - Sets up network emulation for the client and server using [`fd_quic_netem_init`](<fd_quic_test_helpers.c.md#fd_quic_netem_init>) and `fd_quic_set_aio_net_tx`.
    - Initializes the QUIC instances using `fd_quic_init`.
    - Allocates memory for and initializes fibers for the client and server using `fd_wksp_alloc_laddr`, `fd_fibre_init`, and `fd_fibre_start`.
    - Schedules and runs the fibers using `fd_fibre_schedule` and `fd_fibre_schedule_run`.
    - Logs the number of received stream fragments and tested connections.
    - Cleans up resources by finalizing the virtual pair, deleting QUIC instances, and freeing the workspace and RNG.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`fd_quic_test_boot`](<fd_quic_test_helpers.c.md#fd_quic_test_boot>)
    - [`fd_quic_new_anonymous`](<fd_quic_test_helpers.c.md#fd_quic_new_anonymous>)
    - [`fd_quic_virtual_pair_init`](<fd_quic_test_helpers.c.md#fd_quic_virtual_pair_init>)
    - [`fd_quic_netem_init`](<fd_quic_test_helpers.c.md#fd_quic_netem_init>)
    - [`fd_quic_virtual_pair_fini`](<fd_quic_test_helpers.c.md#fd_quic_virtual_pair_fini>)
    - [`fd_quic_test_halt`](<fd_quic_test_helpers.c.md#fd_quic_test_halt>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)