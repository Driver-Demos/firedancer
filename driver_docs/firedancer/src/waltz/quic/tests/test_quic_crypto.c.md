<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for QUIC cryptographic operations, including encryption, decryption, and nonce generation.

# Purpose
The code is a C program that tests and benchmarks the cryptographic operations used in the QUIC protocol, as specified in RFC 9001. It includes functions to generate and verify cryptographic secrets and keys for both client and server initial packets. The program imports binary data for testing purposes and defines expected cryptographic values, such as initial secrets, keys, and IVs, which are used to validate the correctness of the cryptographic operations. The main function initializes the necessary cryptographic secrets and keys, performs encryption and decryption of QUIC packets, and verifies that the operations produce the expected results.

The program also includes test functions, such as [`test_quic_crypto_helper`](<#test_quic_crypto_helper>), [`test_quic_short_pn`](<#test_quic_short_pn>), and [`test_quic_nonce`](<#test_quic_nonce>), which validate specific aspects of the QUIC cryptographic process, including packet number handling and nonce generation. Additionally, the program benchmarks the performance of the QUIC header and payload encryption and decryption processes, providing throughput measurements. The code is structured to ensure that the cryptographic operations conform to the specifications outlined in RFC 9001, and it uses predefined constants and test data to verify the implementation's accuracy.
# Imports and Dependencies

---
- `../crypto/fd_quic_crypto_suites.h`


# Global Variables

---
### test\_dst\_conn\_id
- **Type**: ``uchar const[8]``
- **Description**: An array of 8 unsigned characters that represents a destination connection ID used in QUIC protocol testing. The values are specified in hexadecimal format.
- **Use**: Used as a reference destination connection ID for QUIC protocol operations and testing.


---
### expected\_initial\_secret
- **Type**: ``uchar const[32]``
- **Description**: An array of 32 unsigned characters that represents the expected initial secret value as defined in RFC 9001. This value is used in the cryptographic processes for QUIC protocol initial packet protection.
- **Use**: Used to verify the correctness of the initial secret derived during the QUIC cryptographic operations.


---
### expected\_client\_initial\_secret
- **Type**: ``uchar const[32]``
- **Description**: A static constant array of 32 unsigned characters that represents the expected client initial secret as defined in RFC 9001. This array contains a specific sequence of hexadecimal values used in the cryptographic process for protecting client packets.
- **Use**: Used to verify the correctness of the client initial secret derived during the QUIC cryptographic process.


---
### expected\_client\_key
- **Type**: ``static uchar const[16]``
- **Description**: An array of 16 unsigned characters that represents the expected client key for QUIC encryption as specified in RFC 9001. The values are derived from the `client_initial_secret` using the HKDF-Expand-Label function with the label "quic key".
- **Use**: Used to store the expected client key for QUIC encryption to verify the correctness of encryption and decryption processes.


---
### expected\_client\_quic\_iv
- **Type**: ``uchar const[12]``
- **Description**: An array of 12 unsigned characters that represents the expected QUIC initialization vector (IV) for client packets as specified in RFC 9001. The values are derived from the `client_initial_secret` using the HKDF-Expand-Label function with the label "quic iv".
- **Use**: Used to initialize the IV for encrypting and decrypting client QUIC packets.


---
### expected\_client\_quic\_hp\_key
- **Type**: ``uchar const[16]``
- **Description**: A static constant array of unsigned characters with 16 elements, representing the expected header protection key for QUIC client packets as specified in RFC 9001.
- **Use**: Used to verify the correctness of the header protection key derived during QUIC client packet encryption and decryption processes.


---
### expected\_server\_initial\_secret
- **Type**: ``uchar const[32]``
- **Description**: Represents the expected server initial secret as defined in RFC 9001 for protecting server packets. It is a 32-byte array of unsigned characters that contains a predefined sequence of hexadecimal values.
- **Use**: Used to verify the server initial secret during the QUIC cryptographic operations.


---
### expected\_server\_key
- **Type**: ``static uchar const[16]``
- **Description**: Represents the expected server key for QUIC packet protection as defined in RFC 9001. It is a 16-byte array of unsigned characters.
- **Use**: Used to verify the server's packet protection key during QUIC communication.


---
### expected\_server\_quic\_iv
- **Type**: ``uchar const[12]``
- **Description**: An array of 12 unsigned characters that represents the expected server QUIC initialization vector (IV) as defined in RFC 9001. The values are used in the cryptographic process for protecting server packets.
- **Use**: Used to verify the correctness of the server's QUIC IV during cryptographic operations.


---
### expected\_server\_quic\_hp\_key
- **Type**: ``uchar const[16]``
- **Description**: An array of 16 unsigned characters that represents the expected header protection key for server packets in QUIC as specified in RFC 9001.
- **Use**: Used to verify the correctness of the server's header protection key during QUIC packet processing.


---
### packet\_header
- **Type**: ``uchar const[]``
- **Description**: An array of unsigned characters that represents an unprotected packet header. The header includes a connection ID and a packet number, as specified in RFC 9001.
- **Use**: Used to define the unprotected header for a packet, indicating a length of 1182 bytes, including the connection ID and packet number.


---
### packet\_header\_short\_pn
- **Type**: ``uchar const[]``
- **Description**: An array of unsigned characters that represents a packet header with a short packet number format. The array contains 20 bytes, which include connection ID and a packet number of 2.
- **Use**: Used in QUIC packet processing to test encryption and decryption with a short packet number.


# Functions

---
### test\_quic\_crypto\_helper<!-- {{#callable:test_quic_crypto_helper}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_crypto.c#L80>)

Tests the encryption and decryption of QUIC packets using predefined client keys and verifies the integrity of the decrypted data.
- **Inputs**:
    - `pkt_number`: The packet number used in the encryption and decryption process.
    - `hdr`: A pointer to the header data of the packet to be encrypted and decrypted.
    - `hdr_sz`: The size of the header data in bytes.
- **Logic and Control Flow**:
    - Initialize a buffer `cipher_text_` to store the encrypted data and set its size `cipher_text_sz`.
    - Create a `fd_quic_crypto_keys_t` structure `client_keys` and populate it with predefined client keys.
    - Call `fd_quic_crypto_encrypt` to encrypt the packet using the header, initial payload, and client keys, storing the result in `cipher_text_`.
    - Initialize a buffer `revert` and copy the encrypted data into it.
    - Decrypt the header of the encrypted data using `fd_quic_crypto_decrypt_hdr` and verify it matches the original header using `memcmp`.
    - Initialize a buffer `revert_partial` and copy the decrypted data into it.
    - Decrypt the full packet using `fd_quic_crypto_decrypt` and verify the payload matches the original initial payload using `memcmp`.
- **Output**: No output is returned; the function uses assertions to verify the correctness of the encryption and decryption process.


---
### test\_quic\_short\_pn<!-- {{#callable:test_quic_short_pn}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_crypto.c#L123>)

Tests the encryption and decryption of QUIC packets with short packet numbers using a helper function.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls [`test_quic_crypto_helper`](<#test_quic_crypto_helper>) with a packet number of `2UL`, the `packet_header_short_pn` array, and its size.
    - Calls [`test_quic_crypto_helper`](<#test_quic_crypto_helper>) with a large packet number `0xff00000002UL`, the same `packet_header_short_pn` array, and its size.
- **Output**: No output is returned as the function is `void` and is used for testing purposes.
- **Functions Called**:
    - [`test_quic_crypto_helper`](<#test_quic_crypto_helper>)


---
### test\_quic\_nonce<!-- {{#callable:test_quic_nonce}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_crypto.c#L131>)

Validates the correct generation of a QUIC nonce using a given initialization vector and packet number.
- **Inputs**: None
- **Logic and Control Flow**:
    - Define a constant initialization vector `iv` and an expected nonce `expected_nonce`.
    - Declare an array `nonce` to store the generated nonce.
    - Call `fd_quic_get_nonce` to generate a nonce using `nonce`, `iv`, and the packet number `654360564UL`.
    - Use `FD_TEST` to assert that the generated `nonce` matches `expected_nonce` by comparing them with `memcmp`.
- **Output**: No output is returned; the function performs an internal test and uses assertions to validate the result.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_crypto.c#L149>)

Initializes and tests QUIC cryptographic operations, including key generation, encryption, decryption, and benchmarking.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Creates a random number generator using `fd_rng_new` and `fd_rng_join`.
    - Generates initial secrets using `fd_quic_gen_initial_secrets` based on the QUIC version and destination connection ID.
    - Logs and verifies the generated client and server initial secrets against expected values.
    - Generates cryptographic keys for client and server using `fd_quic_gen_keys`.
    - Encrypts a test client initial packet using `fd_quic_crypto_encrypt` and verifies the ciphertext against expected values.
    - Decrypts the ciphertext using `fd_quic_crypto_decrypt_hdr` and `fd_quic_crypto_decrypt`, verifying the decrypted data matches the original packet.
    - Performs various tests to ensure correct handling of edge cases in decryption, such as undersized headers and corrupted ciphertext.
    - Benchmarks the performance of QUIC header and payload encryption and decryption for small and large packets.
    - Calls [`test_quic_short_pn`](<#test_quic_short_pn>) and [`test_quic_nonce`](<#test_quic_nonce>) to perform additional QUIC-specific tests.
    - Cleans up the random number generator and halts the program with `fd_halt`.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`test_quic_short_pn`](<#test_quic_short_pn>)
    - [`test_quic_nonce`](<#test_quic_nonce>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)