<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for QUIC protocol conformance, including stream data limits, concurrency, and error handling.

# Purpose
The code is a test suite for verifying the conformance of a QUIC implementation (`fd_quic`) with the QUIC protocol as specified in RFC 9000. It includes a series of test functions that check various aspects of the QUIC protocol, such as data flow control, stream concurrency, and handling of specific frame types like PING and ALPN. Each test function initializes a QUIC sandbox environment, sets up a connection, and performs operations to ensure that the implementation behaves correctly under different conditions. The tests validate that the QUIC implementation correctly handles errors, such as `FLOW_CONTROL_ERROR` and `STREAM_LIMIT_ERROR`, and that it adheres to protocol requirements like not exceeding stream limits set by peers.

The code is structured to be executed as a standalone program, with a [`main`](<#main>) function that initializes the testing environment, runs each test, and then cleans up resources. The tests are designed to be comprehensive, covering a wide range of scenarios to ensure the robustness of the QUIC implementation. The use of macros and utility functions, such as `FD_TEST` and `fd_quic_sandbox_send_lone_frame`, helps streamline the testing process by providing a consistent way to perform checks and send frames within the sandbox environment. The code also includes mechanisms for logging and debugging, which aid in identifying and resolving issues during the testing process.
# Imports and Dependencies

---
- `fd_quic_sandbox.h`
- `../fd_quic_proto.h`
- `../fd_quic_proto.c`
- `../fd_quic_private.h`
- `../templ/fd_quic_parse_util.h`
- `../../tls/fd_tls_proto.h`
- `../../../disco/metrics/generated/fd_metrics_enums.h`


# Functions

---
### test\_quic\_stream\_data\_limit\_enforcement<!-- {{#callable:test_quic_stream_data_limit_enforcement}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_conformance.c#L18>)

Tests the enforcement of QUIC stream data limits by simulating a flow control error scenario.
- **Inputs**:
    - ``sandbox``: A pointer to an `fd_quic_sandbox_t` structure, representing the QUIC sandbox environment.
    - ``rng``: A pointer to an `fd_rng_t` structure, used for random number generation.
- **Logic and Control Flow**:
    - Initialize the QUIC sandbox with the server role using [`fd_quic_sandbox_init`](<fd_quic_sandbox.c.md#fd_quic_sandbox_init>).
    - Set the initial maximum stream data limit to 1 byte in the sandbox configuration.
    - Establish a new QUIC connection using `fd_quic_sandbox_new_conn_established`.
    - Set the supported stream ID for receiving to a specific client unidirectional stream type.
    - Encode a stream frame with a length of 2 bytes and a final flag using `fd_quic_encode_stream_frame`.
    - Verify that the encoding did not fail using `FD_TEST`.
    - Fill the buffer with additional data and send the frame using [`fd_quic_sandbox_send_lone_frame`](<fd_quic_sandbox.c.md#fd_quic_sandbox_send_lone_frame>).
    - Check that the connection state is aborted and the reason is a flow control error using `FD_TEST`.
    - Retrieve the last log record from the shared memory log and verify the connection close event and error code.
    - Log a debug message indicating the source of the flow control error.
- **Output**: No return value; the function performs tests and assertions to verify QUIC stream data limit enforcement.
- **Functions Called**:
    - [`fd_quic_sandbox_init`](<fd_quic_sandbox.c.md#fd_quic_sandbox_init>)
    - [`fd_quic_sandbox_send_lone_frame`](<fd_quic_sandbox.c.md#fd_quic_sandbox_send_lone_frame>)


---
### test\_quic\_stream\_limit\_enforcement<!-- {{#callable:test_quic_stream_limit_enforcement}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_conformance.c#L58>)

Tests the enforcement of stream limits in a QUIC connection and verifies that exceeding these limits results in a connection error.
- **Inputs**:
    - ``sandbox``: A pointer to an `fd_quic_sandbox_t` structure, representing the QUIC testing environment.
    - ``rng``: A pointer to an `fd_rng_t` structure, used for random number generation.
- **Logic and Control Flow**:
    - Initialize the QUIC sandbox with the server role using [`fd_quic_sandbox_init`](<fd_quic_sandbox.c.md#fd_quic_sandbox_init>).
    - Establish a new QUIC connection using `fd_quic_sandbox_new_conn_established`.
    - Set the `rx_sup_stream_id` of the connection's `srx` to `FD_QUIC_STREAM_TYPE_UNI_CLIENT`.
    - Encode a stream frame with a client unidirectional stream ID, zero offset, zero length, and a FIN flag using `fd_quic_encode_stream_frame`.
    - Verify that the stream frame encoding did not fail using `FD_TEST`.
    - Send the encoded stream frame using [`fd_quic_sandbox_send_lone_frame`](<fd_quic_sandbox.c.md#fd_quic_sandbox_send_lone_frame>).
    - Check that the connection state is `FD_QUIC_CONN_STATE_ABORT` and the reason is `FD_QUIC_CONN_REASON_STREAM_LIMIT_ERROR` using `FD_TEST`.
    - Retrieve the last log record from the shared memory log using `fd_quic_log_rx_tail`.
    - Verify that the log record indicates a QUIC connection close event and the error code is `FD_QUIC_CONN_REASON_STREAM_LIMIT_ERROR` using `FD_TEST`.
    - Check that the error source file is `fd_quic.c` using `memcmp`.
    - Log a debug message indicating a stream limit error.
- **Output**: No return value; the function performs tests and assertions to verify correct behavior.
- **Functions Called**:
    - [`fd_quic_sandbox_init`](<fd_quic_sandbox.c.md#fd_quic_sandbox_init>)
    - [`fd_quic_sandbox_send_lone_frame`](<fd_quic_sandbox.c.md#fd_quic_sandbox_send_lone_frame>)


---
### test\_quic\_stream\_concurrency<!-- {{#callable:test_quic_stream_concurrency}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_conformance.c#L90>)

Tests the ability to handle concurrent QUIC streams by initiating multiple streams without closing them.
- **Inputs**:
    - ``sandbox``: A pointer to an `fd_quic_sandbox_t` structure, representing the QUIC sandbox environment.
    - ``rng``: A pointer to an `fd_rng_t` structure, used for random number generation.
- **Logic and Control Flow**:
    - Initializes the QUIC sandbox with the server role using [`fd_quic_sandbox_init`](<fd_quic_sandbox.c.md#fd_quic_sandbox_init>).
    - Establishes a new QUIC connection using `fd_quic_sandbox_new_conn_established`.
    - Sets the `rx_sup_stream_id` of the connection to a specific value to support unidirectional client streams.
    - Iterates 512 times to create and send stream frames, each initiating a new stream without closing it.
    - Encodes a stream frame with `fd_quic_encode_stream_frame` and checks for encoding success.
    - Appends a character to the buffer and sends the frame using [`fd_quic_sandbox_send_lone_frame`](<fd_quic_sandbox.c.md#fd_quic_sandbox_send_lone_frame>).
    - Verifies that the connection state remains active after each frame is sent.
- **Output**: No explicit output is returned; the function performs tests and assertions to verify stream concurrency handling.
- **Functions Called**:
    - [`fd_quic_sandbox_init`](<fd_quic_sandbox.c.md#fd_quic_sandbox_init>)
    - [`fd_quic_sandbox_send_lone_frame`](<fd_quic_sandbox.c.md#fd_quic_sandbox_send_lone_frame>)


---
### test\_quic\_ping\_frame<!-- {{#callable:test_quic_ping_frame}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_conformance.c#L117>)

Tests the behavior of a QUIC connection when sending a PING frame and verifies the connection's state and acknowledgment generation.
- **Inputs**:
    - ``sandbox``: A pointer to an `fd_quic_sandbox_t` structure, representing the QUIC testing environment.
    - ``rng``: A pointer to an `fd_rng_t` structure, used for random number generation.
- **Logic and Control Flow**:
    - Initialize the QUIC sandbox with the role set to server using [`fd_quic_sandbox_init`](<fd_quic_sandbox.c.md#fd_quic_sandbox_init>).
    - Establish a new QUIC connection using `fd_quic_sandbox_new_conn_established`.
    - Set the `is_elicited` field of the connection's acknowledgment generator to 0.
    - Verify that the connection's service metadata private request index is not invalid using `FD_TEST`.
    - Create a buffer `buf` containing a single byte with the value `0x01`.
    - Send a lone frame containing the buffer using [`fd_quic_sandbox_send_lone_frame`](<fd_quic_sandbox.c.md#fd_quic_sandbox_send_lone_frame>).
    - Verify that the connection's state is active using `FD_TEST`.
    - Verify that the `is_elicited` field of the acknowledgment generator is set to 1 using `FD_TEST`.
- **Output**: No return value; the function performs tests and assertions to verify the behavior of the QUIC connection.
- **Functions Called**:
    - [`fd_quic_sandbox_init`](<fd_quic_sandbox.c.md#fd_quic_sandbox_init>)
    - [`fd_quic_sandbox_send_lone_frame`](<fd_quic_sandbox.c.md#fd_quic_sandbox_send_lone_frame>)


---
### test\_quic\_server\_alpn\_fail<!-- {{#callable:test_quic_server_alpn_fail}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_conformance.c#L133>)

Tests the QUIC server's handling of an ALPN failure during the TLS handshake.
- **Inputs**:
    - ``sandbox``: A pointer to an `fd_quic_sandbox_t` structure, representing the QUIC sandbox environment.
    - ``rng``: A pointer to an `fd_rng_t` structure, used for generating random numbers.
- **Logic and Control Flow**:
    - Initialize the QUIC sandbox with the server role using [`fd_quic_sandbox_init`](<fd_quic_sandbox.c.md#fd_quic_sandbox_init>).
    - Define a static `crypto_frame` array representing a CRYPTO frame from an Initial Packet.
    - Retrieve the QUIC state and generate random connection IDs for both the server and peer.
    - Create a new QUIC connection using `fd_quic_conn_create` with the generated connection IDs and sandbox parameters.
    - Initialize a TLS handshake object for the connection using `fd_quic_tls_hs_new`.
    - Send a TLS handshake message using [`fd_quic_sandbox_send_frame`](<fd_quic_sandbox.c.md#fd_quic_sandbox_send_frame>) with the `crypto_frame`.
    - Verify that the connection state is aborted and the reason is an ALPN failure using `FD_TEST`.
    - Service the QUIC connection to process the response using `fd_quic_service`.
    - Retrieve the next packet from the sandbox and verify its contents, ensuring it indicates a connection close due to ALPN failure.
- **Output**: No return value; the function performs tests and assertions to verify correct behavior.
- **Functions Called**:
    - [`fd_quic_sandbox_init`](<fd_quic_sandbox.c.md#fd_quic_sandbox_init>)
    - [`fd_quic_sandbox_send_frame`](<fd_quic_sandbox.c.md#fd_quic_sandbox_send_frame>)
    - [`fd_quic_sandbox_next_packet`](<fd_quic_sandbox.c.md#fd_quic_sandbox_next_packet>)


---
### test\_quic\_pktnum\_skip<!-- {{#callable:test_quic_pktnum_skip}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_conformance.c#L237>)

Tests the behavior of QUIC packet number skipping and ACK transmission under specific conditions.
- **Inputs**:
    - `sandbox`: A pointer to an `fd_quic_sandbox_t` structure, representing the QUIC testing environment.
    - `rng`: A pointer to an `fd_rng_t` structure, used for random number generation.
- **Logic and Control Flow**:
    - Initialize the QUIC sandbox with the server role using [`fd_quic_sandbox_init`](<fd_quic_sandbox.c.md#fd_quic_sandbox_init>).
    - Establish a new QUIC connection using `fd_quic_sandbox_new_conn_established`.
    - Verify that the ACK generator's `tail` and `head` are both zero.
    - Fill the ACK transmission buffer by sending ping packets with incrementing packet numbers, ensuring the buffer is full.
    - Check that no packet decryption failures occurred and that the ACK transmission metrics are as expected.
    - Send an additional ping packet to overflow the ACK queue and verify that the `FD_QUIC_ACK_TX_ENOSPC` metric is incremented.
- **Output**: No return value; the function performs tests and assertions to validate QUIC behavior.
- **Functions Called**:
    - [`fd_quic_sandbox_init`](<fd_quic_sandbox.c.md#fd_quic_sandbox_init>)
    - [`fd_quic_sandbox_send_ping_pkt`](<fd_quic_sandbox.c.md#fd_quic_sandbox_send_ping_pkt>)


---
### test\_quic\_conn\_initial\_limits<!-- {{#callable:test_quic_conn_initial_limits}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_conformance.c#L268>)

Tests the initial connection limits for a QUIC connection in a sandbox environment.
- **Inputs**:
    - ``sandbox``: A pointer to an `fd_quic_sandbox_t` structure, representing the sandbox environment for the QUIC connection.
    - ``rng``: A pointer to an `fd_rng_t` structure, representing the random number generator, though it is not used in this function.
- **Logic and Control Flow**:
    - Initialize the QUIC sandbox with the server role using [`fd_quic_sandbox_init`](<fd_quic_sandbox.c.md#fd_quic_sandbox_init>).
    - Retrieve the transport parameters from the QUIC state and set `initial_max_data` to `987654321UL` and `initial_max_streams_uni` to `8192UL`.
    - Create a new QUIC connection with a specified connection ID, peer connection ID, destination IP address, and UDP port using `fd_quic_conn_create`.
    - Verify that the connection is in the handshake state using `FD_TEST`.
    - Encode a stream frame with a single byte of data and send it using [`fd_quic_sandbox_send_lone_frame`](<fd_quic_sandbox.c.md#fd_quic_sandbox_send_lone_frame>).
    - Verify again that the connection remains in the handshake state after sending the frame.
    - Check that the connection's receive limits match the expected values for `rx_sup_stream_id` and `rx_max_data`.
- **Output**: No return value; the function performs tests and assertions to verify the initial connection limits.
- **Functions Called**:
    - [`fd_quic_sandbox_init`](<fd_quic_sandbox.c.md#fd_quic_sandbox_init>)
    - [`fd_quic_sandbox_send_lone_frame`](<fd_quic_sandbox.c.md#fd_quic_sandbox_send_lone_frame>)


---
### test\_quic\_rx\_max\_data\_frame<!-- {{#callable:test_quic_rx_max_data_frame}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_conformance.c#L306>)

Tests the behavior of receiving and processing QUIC MAX_DATA frames in a sandbox environment.
- **Inputs**:
    - ``sandbox``: A pointer to an `fd_quic_sandbox_t` structure, representing the QUIC sandbox environment.
    - ``rng``: A pointer to an `fd_rng_t` structure, used for random number generation.
- **Logic and Control Flow**:
    - Initialize the QUIC sandbox with the server role using [`fd_quic_sandbox_init`](<fd_quic_sandbox.c.md#fd_quic_sandbox_init>).
    - Set the initial maximum stream data for receiving to 1 using `sandbox->quic->config.initial_rx_max_stream_data`.
    - Establish a new QUIC connection using `fd_quic_sandbox_new_conn_established`.
    - Set `frame.max_data` to 0x30 and encode it into a buffer using `fd_quic_encode_max_data_frame`.
    - Verify the encoding was successful and send the frame using [`fd_quic_sandbox_send_lone_frame`](<fd_quic_sandbox.c.md#fd_quic_sandbox_send_lone_frame>).
    - Check that the connection state is active, the acknowledgment is elicited, and the transmitted max data is 0x30.
    - Reset `conn->ack_gen->is_elicited` to 0, set `frame.max_data` to 0x10, and repeat the encoding and sending process.
    - Verify again that the connection state is active, the acknowledgment is elicited, and the transmitted max data remains 0x30.
- **Output**: No return value; the function performs tests and assertions to verify correct behavior.
- **Functions Called**:
    - [`fd_quic_sandbox_init`](<fd_quic_sandbox.c.md#fd_quic_sandbox_init>)
    - [`fd_quic_sandbox_send_lone_frame`](<fd_quic_sandbox.c.md#fd_quic_sandbox_send_lone_frame>)


---
### test\_quic\_rx\_max\_streams\_frame<!-- {{#callable:test_quic_rx_max_streams_frame}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_conformance.c#L335>)

Tests the reception and processing of QUIC MAX_STREAMS frames in a client role.
- **Inputs**:
    - `sandbox`: A pointer to an `fd_quic_sandbox_t` structure, representing the QUIC sandbox environment.
    - `rng`: A pointer to an `fd_rng_t` structure, used for random number generation.
- **Logic and Control Flow**:
    - Initialize the QUIC sandbox with the client role using [`fd_quic_sandbox_init`](<fd_quic_sandbox.c.md#fd_quic_sandbox_init>) and set `initial_rx_max_stream_data` to 1.
    - Establish a new QUIC connection using `fd_quic_sandbox_new_conn_established`.
    - Set the frame type to unidirectional (0x13) and `max_streams` to 0x30, then encode the frame using `fd_quic_encode_max_streams_frame`.
    - Verify the encoding was successful and the buffer's first byte matches the frame type, then send the frame using [`fd_quic_sandbox_send_lone_frame`](<fd_quic_sandbox.c.md#fd_quic_sandbox_send_lone_frame>).
    - Check that the connection state is active, `ack_gen->is_elicited` is set to 1, and `tx_sup_stream_id` is 0xc2.
    - Reset `ack_gen->is_elicited` to 0, change `max_streams` to 0x10, encode and send the frame again, and verify the same conditions as before.
    - Change the frame type to bidirectional (0x12) and `max_streams` to 0x60, encode and send the frame, and verify the same conditions as before.
- **Output**: No explicit output is returned; the function performs tests and assertions to verify correct behavior.
- **Functions Called**:
    - [`fd_quic_sandbox_init`](<fd_quic_sandbox.c.md#fd_quic_sandbox_init>)
    - [`fd_quic_sandbox_send_lone_frame`](<fd_quic_sandbox.c.md#fd_quic_sandbox_send_lone_frame>)


---
### test\_quic\_small\_pkt\_ping<!-- {{#callable:test_quic_small_pkt_ping}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_conformance.c#L378>)

Tests the sending and processing of a small QUIC ping packet in a client role.
- **Inputs**:
    - ``sandbox``: A pointer to an `fd_quic_sandbox_t` structure, representing the QUIC sandbox environment.
    - ``rng``: A pointer to an `fd_rng_t` structure, used for random number generation.
- **Logic and Control Flow**:
    - Initialize the QUIC sandbox with the client role using [`fd_quic_sandbox_init`](<fd_quic_sandbox.c.md#fd_quic_sandbox_init>).
    - Establish a new QUIC connection with `fd_quic_sandbox_new_conn_established` and set its state to active.
    - Set the connection's flags to include `FD_QUIC_CONN_FLAGS_PING`.
    - Service the connection with `fd_quic_conn_service` to send a ping packet.
    - Retrieve the sent packet using [`fd_quic_sandbox_next_packet`](<fd_quic_sandbox.c.md#fd_quic_sandbox_next_packet>) and log its contents for debugging.
    - Insert the connection into the connection map using `fd_quic_conn_map_insert`.
    - Process the packet with `fd_quic_process_packet` and verify that the ACK transmission metric has incremented by one.
- **Output**: No direct output; the function performs internal tests and logs results.
- **Functions Called**:
    - [`fd_quic_sandbox_init`](<fd_quic_sandbox.c.md#fd_quic_sandbox_init>)
    - [`fd_quic_sandbox_next_packet`](<fd_quic_sandbox.c.md#fd_quic_sandbox_next_packet>)


---
### test\_quic\_parse\_path\_challenge<!-- {{#callable:test_quic_parse_path_challenge}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_conformance.c#L412>)

Tests the decoding of QUIC path challenge and response frames with different data lengths.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initializes `path_challenge` and `path_response` frame structures.
    - Enters a `do-while` loop that executes once.
    - Sets the first byte of `data` to `0x1a` and tests `fd_quic_decode_path_challenge_frame` with data lengths 1, 8, 9, and 10, expecting failures for lengths 1 and 8, and success for lengths 9 and 10.
    - Changes the first byte of `data` to `0x1b` and tests `fd_quic_decode_path_response_frame` with data lengths 1, 8, 9, and 10, expecting failures for lengths 1 and 8, and success for lengths 9 and 10.
- **Output**: No output is returned; the function uses assertions to validate frame decoding.


---
### in\_stream\_list<!-- {{#callable:in_stream_list}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_conformance.c#L432>)

Checks if a given stream is present in a linked list of streams, starting from a sentinel node.
- **Inputs**:
    - `stream`: A pointer to the `fd_quic_stream_t` structure representing the stream to search for in the list.
    - `sentinel`: A pointer to the `fd_quic_stream_t` structure that acts as the sentinel node marking the start and end of the circular linked list.
- **Logic and Control Flow**:
    - Initialize `curr` to the node following the `sentinel` node.
    - Enter a loop that continues as long as `curr` is not equal to `sentinel` and `curr` is not NULL.
    - Check if `curr` is equal to `stream`; if true, return 1 indicating the stream is in the list.
    - Move `curr` to the next node in the list.
    - If the loop completes without finding the stream, return 0 indicating the stream is not in the list.
- **Output**: Returns 1 if the stream is found in the list, otherwise returns 0.


---
### test\_quic\_send\_streams<!-- {{#callable:test_quic_send_streams}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_conformance.c#L445>)

Tests edge cases for QUIC send streams by manipulating stream lists and generating stream frames.
- **Inputs**:
    - ``sandbox``: A pointer to an `fd_quic_sandbox_t` structure, representing the QUIC sandbox environment.
    - ``rng``: A pointer to an `fd_rng_t` structure, used for random number generation.
- **Logic and Control Flow**:
    - Initialize the QUIC sandbox with the server role using [`fd_quic_sandbox_init`](<fd_quic_sandbox.c.md#fd_quic_sandbox_init>).
    - Establish a new QUIC connection with `fd_quic_sandbox_new_conn_established`.
    - Set the `tx_sup_stream_id` of the connection to 20.
    - Create an empty stream and manually add it to the `send_streams` list of the connection.
    - Verify the stream is in the `send_streams` list using `FD_TEST` and [`in_stream_list`](<#in_stream_list>).
    - Generate stream frames with `fd_quic_gen_stream_frames` and verify the stream is moved to `used_streams`.
    - For two iterations (fin=0 and fin=1), create a big stream, send data, and verify it remains in `send_streams` after generating stream frames.
    - Reset the `send_streams` list for the next test by setting the `sentinel` of the next stream to 1.
- **Output**: No return value; the function performs tests and uses assertions to verify behavior.
- **Functions Called**:
    - [`fd_quic_sandbox_init`](<fd_quic_sandbox.c.md#fd_quic_sandbox_init>)
    - [`in_stream_list`](<#in_stream_list>)


---
### pretend\_stream<!-- {{#callable:pretend_stream}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_conformance.c#L495>)

Sets specific flags and buffer states for a QUIC stream to indicate it is unsent and ready for transmission.
- **Inputs**:
    - `stream`: A pointer to an `fd_quic_stream_t` structure representing the QUIC stream to modify.
- **Logic and Control Flow**:
    - Set the `FD_QUIC_STREAM_FLAGS_UNSENT` flag in the `stream_flags` of the `stream` to mark it as unsent.
    - Set the `head` of the `tx_buf` in the `stream` to 1, indicating the start of the transmission buffer.
    - Set the `tx_sent` of the `stream` to 0, indicating no data has been sent yet.
- **Output**: No return value; the function modifies the `stream` in place.


---
### test\_quic\_inflight\_pkt\_limit<!-- {{#callable:test_quic_inflight_pkt_limit}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_conformance.c#L501>)

Tests the enforcement of packet inflight limits in a QUIC connection.
- **Inputs**:
    - ``sandbox``: A pointer to an `fd_quic_sandbox_t` structure, representing the QUIC sandbox environment.
    - ``rng``: A pointer to an `fd_rng_t` structure, used for random number generation.
- **Logic and Control Flow**:
    - Initialize a QUIC connection using `fd_quic_sandbox_new_conn_established` and verify its state is active and `used_pkt_meta` is zero.
    - Set the `tx_sup_stream_id` to 4 and create a new stream using `fd_quic_conn_new_stream`.
    - For 12 iterations, update the packet number of the stream, manually add it to `send_streams`, and verify its presence in the list.
    - Call `fd_quic_conn_service` to process the connection and check if the 12th packet fails while the first 11 succeed by comparing `frame_tx_alloc_cnt` metrics.
    - Define `fd_quic_limits_t` with specific limits and verify that the footprint function returns false, ensuring the inflight frame count is within limits.
- **Output**: No return value; the function performs tests and assertions to validate packet inflight limits.
- **Functions Called**:
    - [`pretend_stream`](<#pretend_stream>)
    - [`in_stream_list`](<#in_stream_list>)


---
### test\_quic\_conn\_free<!-- {{#callable:test_quic_conn_free}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_conformance.c#L558>)

Tests the freeing and reallocation of QUIC connections in a sandbox environment, ensuring proper connection ID management and state validation.
- **Inputs**:
    - ``sandbox``: A pointer to an `fd_quic_sandbox_t` structure representing the QUIC sandbox environment.
    - ``rng``: A pointer to an `fd_rng_t` structure used for random number generation.
- **Logic and Control Flow**:
    - Initialize the QUIC sandbox with the server role using [`fd_quic_sandbox_init`](<fd_quic_sandbox.c.md#fd_quic_sandbox_init>).
    - Retrieve the QUIC state and connection limit from the sandbox.
    - Verify that all connection IDs (`our_conn_id`) are initialized to zero if no connection IDs are cached.
    - Validate the QUIC state using `fd_quic_state_validate`.
    - Establish a number of new connections up to the connection limit using `fd_quic_sandbox_new_conn_established`.
    - Validate the QUIC state again.
    - Ensure each connection is present in the connection ID map and then free each connection using `fd_quic_conn_free`.
    - Verify that the connection state is set to invalid and the connection ID is retained after freeing.
    - Reallocate new connections, ensuring that connection IDs are replaced one by one following a LIFO policy.
    - Validate the QUIC state once more.
    - Test that packet handlers correctly count freed connections as 'keys not available' in metrics by freeing a connection and checking the metrics.
- **Output**: No return value; the function performs tests and assertions to validate connection management.
- **Functions Called**:
    - [`fd_quic_sandbox_init`](<fd_quic_sandbox.c.md#fd_quic_sandbox_init>)


---
### test\_quic\_pktmeta\_pktnum\_skip<!-- {{#callable:test_quic_pktmeta_pktnum_skip}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_conformance.c#L634>)

Ensures that packet numbers do not skip when packet metadata is exhausted in a QUIC connection.
- **Inputs**:
    - ``sandbox``: A pointer to an `fd_quic_sandbox_t` structure, representing the testing environment for the QUIC connection.
    - ``rng``: A pointer to an `fd_rng_t` structure, used for random number generation within the test.
- **Logic and Control Flow**:
    - Initialize the QUIC sandbox with the server role using [`fd_quic_sandbox_init`](<fd_quic_sandbox.c.md#fd_quic_sandbox_init>).
    - Establish a new QUIC connection and retrieve the connection's state, metrics, and packet metadata tracker.
    - Trigger a series of pings to increment the packet number and verify the increment using `FD_TEST`.
    - Allocate all available packet metadata from the pool and link them in a list.
    - Verify that the allocation failure count for packet metadata is initially zero.
    - Trigger additional pings without available packet metadata, ensuring that packet numbers do not increase and the allocation failure count increments.
    - Send pings from a peer to verify that acknowledgments are still possible and increment the packet number accordingly.
    - Return some packet metadata to the pool and trigger more pings to verify packet number increment.
    - Ensure the allocation failure count remains consistent after returning packet metadata.
- **Output**: No return value; the function uses assertions (`FD_TEST`) to validate behavior.
- **Functions Called**:
    - [`fd_quic_sandbox_init`](<fd_quic_sandbox.c.md#fd_quic_sandbox_init>)
    - [`fd_quic_sandbox_send_ping_pkt`](<fd_quic_sandbox.c.md#fd_quic_sandbox_send_ping_pkt>)


---
### test\_quic\_rtt\_sample<!-- {{#callable:test_quic_rtt_sample}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_conformance.c#L734>)

Tests the application of peer transport parameters and the sampling of round-trip time (RTT) in a QUIC connection.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize a `fd_quic_t` structure `quic` and a `fd_quic_conn_t` structure `conn` with `quic` as its member.
    - Define and initialize a `fd_quic_transport_params_t` structure `peer_tp` with specific values for `ack_delay_exponent` and `max_ack_delay`.
    - Apply the peer transport parameters to `conn` using `fd_quic_apply_peer_params`.
    - Verify that `conn.peer_ack_delay_scale` and `conn.peer_max_ack_delay_ns` are set correctly using `FD_TEST`.
    - Define a macro `SAMPLE` to sample RTT using `fd_quic_sample_rtt` and log the RTT values.
    - Use the `SAMPLE` macro to test different RTT samples and ack delays, verifying the RTT estimates with `FD_TEST`.
- **Output**: No output is returned; the function performs tests and logs results.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_conformance.c#L794>)

Initializes the environment, sets up a random number generator, configures and allocates resources for a QUIC sandbox, runs a series of QUIC protocol tests, and then cleans up resources before exiting.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Call `fd_boot` to initialize the environment with command-line arguments.
    - Create a random number generator using `fd_rng_new` and `fd_rng_join`.
    - Determine the CPU index using `fd_tile_cpu_id` and `fd_tile_idx`, and adjust if necessary.
    - Parse command-line arguments for page size, page count, and NUMA index using `fd_env_strip_cmdline_cstr` and `fd_env_strip_cmdline_ulong`.
    - Convert the page size string to an actual size using `fd_cstr_to_shmem_page_sz` and log an error if unsupported.
    - Define `fd_quic_limits_t` structure with specific limits for QUIC connections and streams.
    - Log the creation of an anonymous workspace and create it using `fd_wksp_new_anonymous`.
    - Allocate memory for a QUIC sandbox using `fd_wksp_alloc_laddr` and initialize it with [`fd_quic_sandbox_new`](<fd_quic_sandbox.c.md#fd_quic_sandbox_new>).
    - Run a series of QUIC protocol tests by calling various `test_quic_*` functions with the sandbox and random number generator.
    - Free the allocated sandbox memory and delete the anonymous workspace.
    - Delete the random number generator and log the successful completion of tests.
    - Call `fd_halt` to terminate the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`fd_quic_sandbox_align`](<fd_quic_sandbox.c.md#fd_quic_sandbox_align>)
    - [`fd_quic_sandbox_footprint`](<fd_quic_sandbox.c.md#fd_quic_sandbox_footprint>)
    - [`fd_quic_sandbox_new`](<fd_quic_sandbox.c.md#fd_quic_sandbox_new>)
    - [`test_quic_stream_data_limit_enforcement`](<#test_quic_stream_data_limit_enforcement>)
    - [`test_quic_stream_limit_enforcement`](<#test_quic_stream_limit_enforcement>)
    - [`test_quic_stream_concurrency`](<#test_quic_stream_concurrency>)
    - [`test_quic_ping_frame`](<#test_quic_ping_frame>)
    - [`test_quic_server_alpn_fail`](<#test_quic_server_alpn_fail>)
    - [`test_quic_pktnum_skip`](<#test_quic_pktnum_skip>)
    - [`test_quic_conn_initial_limits`](<#test_quic_conn_initial_limits>)
    - [`test_quic_rx_max_data_frame`](<#test_quic_rx_max_data_frame>)
    - [`test_quic_rx_max_streams_frame`](<#test_quic_rx_max_streams_frame>)
    - [`test_quic_small_pkt_ping`](<#test_quic_small_pkt_ping>)
    - [`test_quic_send_streams`](<#test_quic_send_streams>)
    - [`test_quic_inflight_pkt_limit`](<#test_quic_inflight_pkt_limit>)
    - [`test_quic_parse_path_challenge`](<#test_quic_parse_path_challenge>)
    - [`test_quic_conn_free`](<#test_quic_conn_free>)
    - [`test_quic_pktmeta_pktnum_skip`](<#test_quic_pktmeta_pktnum_skip>)
    - [`test_quic_rtt_sample`](<#test_quic_rtt_sample>)
    - [`fd_quic_sandbox_delete`](<fd_quic_sandbox.c.md#fd_quic_sandbox_delete>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)