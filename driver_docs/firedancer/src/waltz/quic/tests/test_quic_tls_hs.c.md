<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests the QUIC TLS handshake process using the `fd_quic_tls` API in a client-server setup.

# Purpose
The code is a test suite for performing a QUIC handshake using the `fd_quic_tls` API, which is a lightweight wrapper over the `fd_tls` API. It includes the necessary headers and defines a set of transport parameters for testing. The code defines a structure `my_quic_tls_t` to hold the state of the handshake, including whether it is a server or client and whether the handshake is complete. The code provides callback functions for handling handshake completion, secret generation, and transport parameters. These callbacks are used to log information and verify the correctness of the handshake process.

The [`main`](<#main>) function initializes the necessary components for the handshake, including a random number generator and a certificate key. It configures the QUIC TLS settings with the defined callbacks and transport parameters. The function then creates client and server handshake contexts and enters a loop to simulate the handshake process. During each iteration, it checks for handshake data to transfer between the client and server, processes the data, and logs the progress. The loop continues until both handshakes are complete and no more data is available for exchange. The code verifies that both the client and server have reached the connected state before cleaning up resources and exiting.
# Imports and Dependencies

---
- `../../tls/test_tls_helper.h`
- `../tls/fd_quic_tls.h`
- `../templ/fd_quic_transport_params.h`


# Global Variables

---
### test\_tp
- **Type**: ``uchar const[]``
- **Description**: An array of unsigned characters that contains encoded transport parameters for QUIC (Quick UDP Internet Connections). The array is defined as a constant, meaning its contents cannot be modified after initialization.
- **Use**: Used to store and verify transport parameters during the QUIC handshake process.


# Data Structures

---
### my\_quic\_tls\_t
- **Type**: ``struct``
- **Members**:
    - `is_server`: Indicates if the instance is a server (1) or a client (0).
    - `is_hs_complete`: Indicates if the handshake process is complete (1) or not (0).
    - `state`: Represents the current state of the TLS connection.
    - `sec_level`: Indicates the security level of the TLS connection.
- **Description**: Manages the state and configuration of a QUIC TLS connection, including whether it is a server or client, the completion status of the handshake, the current state of the connection, and the security level.


---
### my\_quic\_tls
- **Type**: ``struct``
- **Members**:
    - `is_server`: Indicates if the instance is a server (1) or a client (0).
    - `is_hs_complete`: Indicates if the handshake process is complete (1) or not (0).
    - `state`: Represents the current state of the TLS connection.
    - `sec_level`: Indicates the security level of the TLS connection.
- **Description**: Represents a structure used in the QUIC TLS handshake process, containing fields to track whether the instance is a server or client, the completion status of the handshake, the current state of the TLS connection, and the security level.


# Functions

---
### my\_hs\_complete<!-- {{#callable:my_hs_complete}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_tls_hs.c#L25>)

Marks the handshake as complete by setting the `is_hs_complete` flag in the context.
- **Inputs**:
    - ``hs``: A pointer to `fd_quic_tls_hs_t`, which is not used in this function.
    - ``context``: A pointer to `my_quic_tls_t` structure, which holds the handshake state.
- **Logic and Control Flow**:
    - Logs a debug message indicating the handshake is complete.
    - Casts the `context` pointer to `my_quic_tls_t` type.
    - Sets the `is_hs_complete` field of the `my_quic_tls_t` structure to 1, indicating the handshake is complete.
- **Output**: No return value; the function modifies the `is_hs_complete` field in the provided context.


---
### my\_secrets<!-- {{#callable:my_secrets}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_tls_hs.c#L36>)

Logs the encryption level and secrets during a QUIC TLS handshake.
- **Inputs**:
    - ``hs``: A pointer to an `fd_quic_tls_hs_t` structure, which contains information about the QUIC TLS handshake state.
    - ``context``: A pointer to a context object, which is not used in this function.
    - ``secret``: A pointer to a constant `fd_quic_tls_secret_t` structure, which contains the encryption level and the read and write secrets.
- **Logic and Control Flow**:
    - The function begins by casting `context` to void to indicate it is unused.
    - It checks if `secret` is not NULL using `FD_TEST`.
    - Logs whether the handshake is for a server or client based on `hs->is_server`.
    - Logs the encryption level from `secret->enc_level`.
    - Logs the read secret using `FD_LOG_HEXDUMP_INFO`.
    - Logs the write secret using `FD_LOG_HEXDUMP_INFO`.
- **Output**: No output is returned as the function is of type `void` and is used for logging purposes.


---
### my\_transport\_params<!-- {{#callable:my_transport_params}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_tls_hs.c#L48>)

Validates that the given QUIC transport parameters match predefined test parameters.
- **Inputs**:
    - `context`: A pointer to user-defined data, not used in this function.
    - `quic_tp`: A pointer to the QUIC transport parameters to validate.
    - `quic_tp_sz`: The size of the QUIC transport parameters in bytes.
- **Logic and Control Flow**:
    - Ignore the `context` parameter as it is not used.
    - Check if `quic_tp_sz` is equal to the size of `test_tp` minus one using `FD_TEST`.
    - Compare the memory content of `quic_tp` with `test_tp` for `quic_tp_sz` bytes using `memcmp` and validate the result with `FD_TEST`.
- **Output**: No output is returned; the function performs validation checks and may trigger assertions if conditions are not met.


---
### fd\_quic\_tls\_provide\_data<!-- {{#callable:fd_quic_tls_provide_data}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_tls_hs.c#L57>)

Transfers TLS handshake data to a specified encryption level buffer and processes it.
- **Inputs**:
    - `tls_hs`: A pointer to an `fd_quic_tls_hs_t` structure representing the TLS handshake state.
    - `enc_level`: An unsigned integer representing the encryption level for the data.
    - `msg`: A pointer to a constant unsigned character array containing the message data to be provided.
    - `msg_sz`: An unsigned long integer representing the size of the message data.
- **Logic and Control Flow**:
    - Check if `msg_sz` is less than or equal to `FD_QUIC_TLS_RX_DATA_SZ` using `FD_TEST` macro.
    - Set `rx_enc_level` of `tls_hs` to the provided `enc_level` cast to `uchar`.
    - Set `rx_sz` of `tls_hs` to the provided `msg_sz` cast to `ushort`.
    - Initialize `rx_off` of `tls_hs` to 0.
    - Copy `msg_sz` bytes from `msg` to `rx_hs_buf` of `tls_hs` using `fd_memcpy`.
    - Call `fd_quic_tls_process` with `tls_hs` to process the provided data.
- **Output**: No direct output; modifies the `tls_hs` structure and processes the data.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_tls_hs.c#L70>)

Performs a QUIC TLS handshake simulation between a client and server using the `fd_quic_tls` API.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Initializes the random number generator and generates a certificate key.
    - Configures QUIC TLS parameters including callbacks for secrets and handshake completion.
    - Decodes and dumps transport parameters to standard output.
    - Creates a new QUIC TLS context and initializes handshake contexts for both client and server.
    - Enters a loop to simulate the handshake process, transferring data between client and server until handshakes are complete or no more data is available.
    - Checks if both client and server handshakes are complete and logs the status.
    - Deletes handshake contexts and cleans up resources before exiting.
- **Output**: Returns 0 upon successful completion of the handshake simulation.
- **Functions Called**:
    - [`fd_quic_tls_provide_data`](<#fd_quic_tls_provide_data>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)