<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for QUIC packet metadata handling, including initialization, comparison, and adversarial acknowledgment scenarios.

# Purpose
The code is a C program designed to test the functionality of QUIC packet metadata management. It includes functions to initialize and manage packet metadata trackers, perform comparisons of packet metadata, and simulate different acknowledgment scenarios. The program uses several helper functions and structures from the QUIC library, such as `fd_quic_pkt_meta_t`, `fd_quic_conn_t`, and `fd_quic_t`, to manage packet metadata and connections. The main function initializes the environment, sets up the necessary resources, and executes tests to verify the correct handling of packet metadata under various conditions.

The program is structured to test the QUIC protocol's handling of packet metadata, focusing on scenarios like adversarial acknowledgment patterns and reordering. It includes a [`main`](<#main>) function that sets up the testing environment, allocates memory for packet metadata, and runs tests to ensure the correct behavior of the QUIC packet metadata tracker. The tests include checking the initialization of packet metadata, comparing packet metadata keys, and processing acknowledgment ranges in different scenarios. The program logs the results of these tests, providing insights into the performance and correctness of the QUIC packet metadata handling.
# Imports and Dependencies

---
- `../fd_quic.h`
- `../fd_quic_private.h`
- `fd_quic_test_helpers.h`


# Global Variables

---
### conn
- **Type**: `fd_quic_conn_t`
- **Description**: Represents a QUIC connection structure used to manage packet metadata and track sent packets.
- **Use**: Used to initialize and manage the packet metadata tracker for QUIC connections.


---
### pkt\_meta\_mem
- **Type**: `fd_quic_pkt_meta_t *`
- **Description**: A pointer to a memory space allocated for packet metadata structures (`fd_quic_pkt_meta_t`).
- **Use**: Used to allocate and manage packet metadata for QUIC connections.


---
### quic
- **Type**: ``fd_quic_t *``
- **Description**: A pointer to an `fd_quic_t` structure, which is used to manage QUIC protocol operations. This variable is initialized in the `main` function and is used throughout the program to access and manipulate QUIC state and operations.
- **Use**: Used to store and manage the state and operations related to the QUIC protocol.


# Functions

---
### init\_tracker<!-- {{#callable:init_tracker}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_pkt_meta.c#L10>)

Initializes a packet metadata tracker with a specified maximum number of inflight packets.
- **Inputs**:
    - `max_inflight`: The maximum number of inflight packets to track.
- **Logic and Control Flow**:
    - Retrieve the packet metadata pool from the QUIC state using `fd_quic_get_state` and `quic`.
    - Initialize the packet metadata pool with `fd_quic_pkt_meta_ds_init_pool` using the retrieved pool and `max_inflight`.
    - Check if `fd_quic_pkt_meta_tracker_init` successfully initializes the packet metadata tracker; log an error and return if it fails.
    - Iterate over the range from 0 to `max_inflight`, acquiring packet metadata elements from the pool using `fd_quic_pkt_meta_pool_ele_acquire`.
    - For each acquired packet metadata, clear its memory with `memset`, set its packet number using `FD_QUIC_PKT_META_SET_PKT_NUM`, and insert it into the tracker's sent packet metadata using `fd_quic_pkt_meta_insert`.
    - Verify that the number of elements in the tracker's sent packet metadata matches `max_inflight` using `FD_TEST`.
- **Output**: No output is returned; the function initializes internal data structures for tracking packet metadata.


---
### fd\_quic\_pkt\_meta\_cmp\_test<!-- {{#callable:fd_quic_pkt_meta_cmp_test}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_pkt_meta.c#L34>)

Tests the `fd_quic_pkt_meta_cmp` function to ensure it correctly compares packet metadata keys based on packet number, type, and stream ID.
- **Inputs**: None
- **Logic and Control Flow**:
    - Logs the start of the test with `FD_LOG_INFO`.
    - Initializes two packet metadata keys, `pkt_1_big_type` and `pkt_2_small_type`, with different values for type, packet number, and stream ID.
    - Creates a packet metadata object `pkt_1_big_type_e` using `pkt_1_big_type`.
    - Tests if `fd_quic_pkt_meta_cmp` returns 0 when comparing `pkt_1_big_type` with `pkt_1_big_type_e`, indicating equality.
    - Tests if `fd_quic_pkt_meta_cmp` returns a positive value when comparing `pkt_2_small_type` with `pkt_1_big_type_e`, indicating `pkt_2_small_type` is greater due to a higher packet number.
    - Modifies `pkt_1_big_type` to create `pkt_1_big_type_small_stream_id` with a smaller stream ID.
    - Tests if `fd_quic_pkt_meta_cmp` returns a negative value when comparing `pkt_1_big_type_small_stream_id` with `pkt_1_big_type_e`, indicating it is smaller due to a lower stream ID.
- **Output**: No output is returned; the function performs tests and logs results.


---
### test\_adversarial\_ack<!-- {{#callable:test_adversarial_ack}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_pkt_meta.c#L54>)

Simulates different acknowledgment scenarios in a QUIC connection to test packet processing under adversarial, reordered, and normal conditions.
- **Inputs**:
    - ``max_inflight``: The maximum number of packets that can be in flight at any given time.
    - ``range_sz``: The size of the range of packet numbers to process in each acknowledgment scenario.
- **Logic and Control Flow**:
    - Initializes a packet tracker with `max_inflight` packets using [`init_tracker`](<#init_tracker>).
    - In the 'Very adversarial' scenario, processes acknowledgment ranges by sending the largest, middle, and higher-than-max packet numbers until all packets are acknowledged.
    - In the 'Reasonable reordering' scenario, alternates between sending the second and first range of packet numbers.
    - In the 'Happy case', processes acknowledgment ranges in order without reordering.
    - Logs the time taken for each scenario using `FD_LOG_NOTICE`.
- **Output**: No return value; the function performs operations and logs results for testing purposes.
- **Functions Called**:
    - [`init_tracker`](<#init_tracker>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_pkt_meta.c#L185>)

Initializes and tests a QUIC environment with specified parameters, including memory allocation and packet metadata management.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
- **Logic and Control Flow**:
    - Call `fd_boot` and [`fd_quic_test_boot`](<fd_quic_test_helpers.c.md#fd_quic_test_boot>) to initialize the environment.
    - Determine the CPU index using `fd_tile_cpu_id` and adjust if it exceeds the shared memory CPU count.
    - Parse command-line arguments to set `max_inflight`, `range_sz`, `_page_sz`, `page_cnt`, and `numa_idx` with default values if not provided.
    - Log the booting process with `FD_LOG_INFO`.
    - Run [`fd_quic_pkt_meta_cmp_test`](<#fd_quic_pkt_meta_cmp_test>) to test packet metadata comparison logic.
    - Define `fd_quic_limits_t` structure with various limits for QUIC operations.
    - Create and join a new anonymous workspace using `fd_wksp_new_anonymous` and `fd_wksp_join`.
    - Calculate the footprint for QUIC state and allocate memory for it, adjusting the local address pointer `laddr`.
    - Allocate and align memory for packet metadata, considering pool alignment requirements.
    - Log the allocation process with `FD_LOG_INFO`.
    - Create and join a packet metadata pool, updating the QUIC state with the pool reference.
    - Log the pool joining process with `FD_LOG_INFO`.
    - Assign the global `quic` variable to the connection structure `conn`.
    - Call [`test_adversarial_ack`](<#test_adversarial_ack>) to perform adversarial acknowledgment tests with the specified `max_inflight` and `range_sz`.
    - Log the successful completion of the process with `FD_LOG_NOTICE` and return 0.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`fd_quic_test_boot`](<fd_quic_test_helpers.c.md#fd_quic_test_boot>)
    - [`fd_quic_pkt_meta_cmp_test`](<#fd_quic_pkt_meta_cmp_test>)
    - [`test_adversarial_ack`](<#test_adversarial_ack>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)