<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests QUIC bandwidth performance by simulating client-server interactions and measuring data rates.

# Purpose
The code is a C program that tests the functionality of a QUIC (Quick UDP Internet Connections) protocol implementation. It sets up a client-server architecture where both the client and server are configured to communicate over a virtual network. The program initializes the necessary components, such as random number generators and clock settings, and creates workspaces for memory management. It defines callback functions for handling connection events, such as connection finalization and stream notifications, which are used to track the state of the connections and data transmission.

The main function orchestrates the setup and execution of the QUIC client and server. It configures the QUIC parameters, such as connection limits and acknowledgment thresholds, and initializes the QUIC instances. The program then establishes a connection from the client to the server and performs data transmission tests. It logs the progress and performance metrics, such as data rates and packet counts, during the test duration. After the test, the program closes the connections and cleans up resources, ensuring that all components are properly finalized and memory is released. This code is intended to verify the correct operation of the QUIC protocol implementation by simulating network conditions and measuring performance.
# Imports and Dependencies

---
- `../fd_quic.h`
- `fd_quic_test_helpers.h`
- `../../../tango/tempo/fd_tempo.h`


# Global Variables

---
### clock
- **Type**: ``fd_clock_t``
- **Description**: A static array of type `fd_clock_t` with a single element. This array is used to store clock-related data for the application.
- **Use**: Used to provide timing information for QUIC operations by passing the current time to functions like `fd_quic_service` and `fd_quic_connect`.


---
### clock\_shmem
- **Type**: ``fd_clock_shmem_t[1]``
- **Description**: An array of type `fd_clock_shmem_t` with a single element. This variable is used to manage shared memory for clock operations.
- **Use**: Used to initialize and delete shared memory for clock operations in the program.


---
### conn\_final\_cnt
- **Type**: `uchar`
- **Description**: `conn_final_cnt` is a global variable of type `uchar` (unsigned character) initialized to 0. It is used to count the number of times the `my_conn_final` function is called, which indicates the finalization of a connection in the QUIC protocol.
- **Use**: Tracks the number of finalized connections by incrementing each time `my_conn_final` is invoked.


---
### rx\_tot\_sz
- **Type**: `ulong`
- **Description**: `rx_tot_sz` is a global variable of type `ulong` that stores the total size of data received in bytes.
- **Use**: Tracks the cumulative size of data received during the execution of the program.


---
### server\_complete
- **Type**: `int`
- **Description**: Indicates whether the server handshake process is complete.
- **Use**: Used to track the completion status of the server handshake in the QUIC connection process.


---
### client\_complete
- **Type**: `int`
- **Description**: Indicates whether the client handshake process is complete in the QUIC protocol implementation.
- **Use**: Used to track the completion status of the client handshake, setting to 1 when the handshake is complete.


---
### server\_conn
- **Type**: ``fd_quic_conn_t *``
- **Description**: A pointer to a `fd_quic_conn_t` structure, which represents a QUIC connection in the Fast Data (FD) framework. It is initialized to `NULL` and is used to store the server-side connection object once a new connection is established.
- **Use**: Used to store the server-side QUIC connection object when a new connection is established in the `my_connection_new` callback function.


# Functions

---
### my\_conn\_final<!-- {{#callable:my_conn_final}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_bw.c#L12>)

Increments the `conn_final_cnt` counter when a connection is finalized.
- **Inputs**:
    - ``conn``: A pointer to an `fd_quic_conn_t` structure representing the QUIC connection.
    - ``quic_ctx``: A pointer to a context object for the QUIC connection, not used in this function.
- **Logic and Control Flow**:
    - Casts `conn` and `quic_ctx` to void to indicate they are unused.
    - Increments the global `conn_final_cnt` variable by 1.
- **Output**: No return value; the function modifies the global `conn_final_cnt` variable.


---
### my\_stream\_notify\_cb<!-- {{#callable:my_stream_notify_cb}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_bw.c#L20>)

Handles stream notifications by ignoring the input parameters.
- **Inputs**:
    - `stream`: A pointer to an `fd_quic_stream_t` structure representing the QUIC stream.
    - `stream_ctx`: A pointer to a context associated with the stream, typically used for user-defined data.
    - `notify_type`: An integer representing the type of notification for the stream.
- **Logic and Control Flow**:
    - The function takes three parameters: `stream`, `stream_ctx`, and `notify_type`.
    - Each parameter is explicitly cast to `void`, indicating that they are unused in the function body.
- **Output**: No output is produced as the function body is empty and does not perform any operations.


---
### my\_stream\_rx\_cb<!-- {{#callable:my_stream_rx_cb}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_bw.c#L27>)

Updates the total received data size by adding the size of the current data chunk and returns a success status.
- **Inputs**:
    - ``conn``: A pointer to the `fd_quic_conn_t` connection object, which is not used in this function.
    - ``stream_id``: The identifier of the stream, which is not used in this function.
    - ``offset``: The offset in the stream where the data starts, which is not used in this function.
    - ``data``: A pointer to the data received, which is not used in this function.
    - ``data_sz``: The size of the data received, which is added to the total received size.
    - ``fin``: An integer indicating if this is the final data chunk, which is not used in this function.
- **Logic and Control Flow**:
    - Ignore the `conn`, `stream_id`, `offset`, `data`, and `fin` parameters by casting them to void.
    - Add the value of `data_sz` to the global variable `rx_tot_sz`.
    - Return the constant `FD_QUIC_SUCCESS`.
- **Output**: Returns `FD_QUIC_SUCCESS`, indicating successful processing of the data.


---
### my\_connection\_new<!-- {{#callable:my_connection_new}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_bw.c#L45>)

Handles the completion of a server-side QUIC connection handshake.
- **Inputs**:
    - ``conn``: A pointer to an `fd_quic_conn_t` structure representing the server connection.
    - ``vp_context``: A void pointer to context data, which is not used in this function.
- **Logic and Control Flow**:
    - Logs the message 'server handshake complete' to indicate the completion of the server handshake.
    - Sets the global variable `server_complete` to 1 to mark the server handshake as complete.
    - Assigns the `conn` pointer to the global variable `server_conn` to store the server connection.
- **Output**: No return value; the function operates through side effects on global variables.


---
### my\_handshake\_complete<!-- {{#callable:my_handshake_complete}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_bw.c#L55>)

Marks the completion of a client handshake and logs this event.
- **Inputs**:
    - ``conn``: A pointer to an `fd_quic_conn_t` structure representing the QUIC connection; it is not used in the function.
    - ``vp_context``: A pointer to a context object; it is not used in the function.
- **Logic and Control Flow**:
    - Logs the message 'client handshake complete' using `FD_LOG_INFO`.
    - Sets the global variable `client_complete` to 1 to indicate that the client handshake is complete.
- **Output**: No return value; the function operates through side effects on global variables and logging.


---
### service\_client<!-- {{#callable:service_client}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_bw.c#L67>)

Executes the QUIC service for a client using the current clock time.
- **Inputs**:
    - `quic`: A pointer to an `fd_quic_t` structure representing the QUIC client to service.
- **Logic and Control Flow**:
    - Initializes a buffer `buf` of 16 unsigned characters to zero and marks the first element as unpredictable to the compiler.
    - Calls the `fd_quic_service` function with the `quic` pointer and the current time obtained from `fd_clock_now(clock)`.
    - Returns 0 to indicate successful execution.
- **Output**: Returns an integer value of 0, indicating successful execution.


---
### service\_server<!-- {{#callable:service_server}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_bw.c#L74>)

Executes the QUIC service routine for a server using the current clock time.
- **Inputs**:
    - `quic`: A pointer to an `fd_quic_t` structure representing the QUIC server instance to service.
- **Logic and Control Flow**:
    - Initializes a buffer `buf` of 16 unsigned characters to zero and marks the first element as unpredictable to the compiler.
    - Calls `fd_quic_service` with the `quic` pointer and the current time obtained from `fd_clock_now(clock)` to perform server servicing.
    - Returns 0 to indicate successful execution.
- **Output**: Returns an integer value of 0, indicating successful execution.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_bw.c#L81>)

Initializes and runs a QUIC client-server test environment, handling connections, data transmission, and cleanup.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Initialize the environment and QUIC test setup with `fd_boot` and [`fd_quic_test_boot`](<fd_quic_test_helpers.c.md#fd_quic_test_boot>).
    - Create a random number generator `rng` using `fd_rng_new` and `fd_rng_join`.
    - Initialize the default clock with `fd_clock_default_init`.
    - Determine the CPU index and adjust if it exceeds the shared memory CPU count.
    - Parse command-line arguments for page size, page count, NUMA index, loss, reorder, duration, and size using `fd_env_strip_cmdline_*` functions.
    - Convert the page size string to a numeric value with `fd_cstr_to_shmem_page_sz` and log an error if unsupported.
    - Create a workspace with `fd_wksp_new_anonymous` and verify its creation.
    - Define QUIC server and client limits and create QUIC instances for both roles using [`fd_quic_new_anonymous`](<fd_quic_test_helpers.c.md#fd_quic_new_anonymous>).
    - Configure server and client QUIC instances with roles, callbacks, and initial stream data limits.
    - Initialize a virtual pair for client-server communication with [`fd_quic_virtual_pair_init`](<fd_quic_test_helpers.c.md#fd_quic_virtual_pair_init>).
    - Optionally add network emulation for loss and reorder using [`fd_quic_netem_init`](<fd_quic_test_helpers.c.md#fd_quic_netem_init>) and `fd_quic_set_aio_net_tx`.
    - Initialize QUIC instances with `fd_quic_init` and synchronize their state with the current clock time.
    - Establish a connection from the client to the server using `fd_quic_connect`.
    - Run a loop to process client and server services, checking for handshake completion and logging connection states.
    - Attempt to send data over a new client stream using `fd_quic_stream_send` and log the result.
    - Run a timed loop to continue servicing client and server, sending data, and logging metrics until the duration ends or connection becomes inactive.
    - Close client and server connections with `fd_quic_conn_close` and verify their states.
    - Run additional service loops to allow acknowledgments to be processed.
    - Verify connection closure metrics and perform cleanup of resources, including QUIC instances, workspace, clock, and random number generator.
    - Log the completion of the test and halt the program with `fd_halt`.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`fd_quic_test_boot`](<fd_quic_test_helpers.c.md#fd_quic_test_boot>)
    - [`fd_quic_new_anonymous`](<fd_quic_test_helpers.c.md#fd_quic_new_anonymous>)
    - [`fd_quic_virtual_pair_init`](<fd_quic_test_helpers.c.md#fd_quic_virtual_pair_init>)
    - [`fd_quic_netem_init`](<fd_quic_test_helpers.c.md#fd_quic_netem_init>)
    - [`service_client`](<#service_client>)
    - [`service_server`](<#service_server>)
    - [`fd_quic_virtual_pair_fini`](<fd_quic_test_helpers.c.md#fd_quic_virtual_pair_fini>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)