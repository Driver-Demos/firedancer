<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests QUIC transaction functionality by simulating a QUIC client that sends transactions.

# Purpose
The code is a C program that implements a QUIC client. It is designed to establish a connection to a specified server, send transactions over the QUIC protocol, and handle various connection and stream events. The program includes several callback functions such as [`cb_conn_new`](<#cb_conn_new>), [`cb_conn_handshake_complete`](<#cb_conn_handshake_complete>), [`cb_conn_final`](<#cb_conn_final>), and [`cb_stream_notify`](<#cb_stream_notify>) to manage connection lifecycle events and stream notifications. The [`run_quic_client`](<#run_quic_client>) function is the core of the program, handling the connection setup, stream creation, and transaction sending. It uses a loop to continuously service the QUIC connection and UDP socket, attempting to read packets, send transactions, and manage the connection state.

The program initializes a QUIC client with specific configuration limits and allocates necessary resources using a workspace. It reads input data from standard input, decodes it from base64, and sends it over the QUIC connection. The main function sets up the environment, configures the QUIC client, and calls [`run_quic_client`](<#run_quic_client>) to execute the client operations. The program logs various events and errors, and it cleans up resources before exiting. The code is structured to be part of a larger system, as indicated by the inclusion of headers and the use of external functions and macros.
# Imports and Dependencies

---
- `../fd_quic.h`
- `fd_quic_test_helpers.h`
- `../../../ballet/base64/fd_base64.h`
- `../../../util/net/fd_ip4.h`
- `stdio.h`
- `errno.h`
- `string.h`


# Global Variables

---
### gbl\_conn
- **Type**: ``fd_quic_conn_t *``
- **Description**: A pointer to a `fd_quic_conn_t` structure, which represents a QUIC connection.
- **Use**: Used to manage and track the state of a QUIC connection in the client application.


---
### gbl\_stream
- **Type**: ``fd_quic_stream_t *``
- **Description**: A pointer to a `fd_quic_stream_t` structure, which represents a QUIC stream in the application. It is initialized to `NULL` and is used to manage the state of a stream within a QUIC connection.
- **Use**: Used to track and manage the current QUIC stream in the client application, allowing for operations such as sending data over the stream.


---
### g\_handshake\_complete
- **Type**: `int`
- **Description**: Indicates whether the handshake process in a QUIC connection is complete. It is initialized to 0, meaning the handshake is not complete.
- **Use**: Used to track the completion status of the QUIC handshake process.


---
### g\_conn\_final
- **Type**: `int`
- **Description**: Indicates whether the finalization of a QUIC connection has occurred. It is set to 1 when the `cb_conn_final` callback is executed, signaling that the connection is finalized.
- **Use**: Used to track the finalization state of a QUIC connection.


---
### g\_stream\_notify
- **Type**: `int`
- **Description**: A global integer variable initialized to 0.
- **Use**: Tracks notifications related to stream events.


---
### sent\_cnt
- **Type**: `ulong`
- **Description**: `sent_cnt` is a global variable of type `ulong` that is initialized to zero. It is used to track the number of transactions sent in the QUIC client application.
- **Use**: Tracks the number of transactions sent by incrementing its value each time a transaction is successfully sent.


# Functions

---
### cb\_conn\_new<!-- {{#callable:cb_conn_new}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_txns.c#L23>)

Logs a notice message with the maximum data that can be transmitted for a new QUIC connection.
- **Inputs**:
    - ``conn``: A pointer to an `fd_quic_conn_t` structure representing the QUIC connection.
    - ``quic_ctx``: A pointer to a context object for the QUIC connection, which is not used in this function.
- **Logic and Control Flow**:
    - The function casts `quic_ctx` to void to indicate it is unused.
    - Logs a notice message using `FD_LOG_NOTICE`, displaying the `tx_max_data` field of the `conn` structure.
- **Output**: No return value; the function performs logging as a side effect.


---
### cb\_conn\_handshake\_complete<!-- {{#callable:cb_conn_handshake_complete}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_txns.c#L30>)

Logs the completion of a QUIC connection handshake and sets a global flag to indicate the handshake is complete.
- **Inputs**:
    - ``conn``: A pointer to an `fd_quic_conn_t` structure representing the QUIC connection.
    - ``quic_ctx``: A void pointer to a context for the QUIC operation, which is not used in this function.
- **Logic and Control Flow**:
    - Logs a notice message with the maximum data that can be transmitted (`tx_max_data`) for the connection `conn`.
    - Sets the global variable `g_handshake_complete` to 1 to indicate that the handshake is complete.
- **Output**: No return value; the function operates through side effects such as logging and setting a global variable.


---
### cb\_conn\_final<!-- {{#callable:cb_conn_final}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_txns.c#L38>)

Logs the finalization of a QUIC connection and resets global connection and stream pointers.
- **Inputs**:
    - ``conn``: A pointer to an `fd_quic_conn_t` structure representing the QUIC connection to finalize.
    - ``quic_ctx``: A pointer to a context object for the QUIC connection, not used in this function.
- **Logic and Control Flow**:
    - Logs a notice message indicating the function `cb_conn_final` is called.
    - Sets the global variable `g_conn_final` to 1 to indicate the connection finalization.
    - Resets the global connection pointer `gbl_conn` to `NULL`.
    - Resets the global stream pointer `gbl_stream` to `NULL`.
- **Output**: No return value; the function operates through side effects on global variables.


---
### cb\_stream\_notify<!-- {{#callable:cb_stream_notify}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_txns.c#L50>)

Handles stream notifications by incrementing a counter if the stream ends successfully or logging a warning if it ends in failure.
- **Inputs**:
    - `stream`: A pointer to an `fd_quic_stream_t` structure, representing the QUIC stream.
    - `stream_ctx`: A pointer to a context associated with the stream, not used in this function.
    - `notify_type`: An integer indicating the type of notification, specifically whether the stream ended successfully or in failure.
- **Logic and Control Flow**:
    - Ignore the `stream` and `stream_ctx` parameters as they are not used in the function.
    - Check if `notify_type` equals `FD_QUIC_STREAM_NOTIFY_END`.
    - If `notify_type` is `FD_QUIC_STREAM_NOTIFY_END`, increment the `sent_cnt` counter.
    - If `notify_type` is not `FD_QUIC_STREAM_NOTIFY_END`, log a warning message indicating the stream ended in failure with the given `notify_type`.
- **Output**: No return value; the function operates through side effects such as incrementing a counter and logging messages.


---
### findch<!-- {{#callable:findch}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_txns.c#L64>)

Searches for a character in a buffer and returns its index or -1 if not found or if a null character is encountered.
- **Inputs**:
    - ``buf``: A pointer to the character buffer to search.
    - ``buf_sz``: The size of the buffer to search through.
    - ``ch``: The character to search for in the buffer.
- **Logic and Control Flow**:
    - Iterates over the buffer from index 0 to `buf_sz - 1`.
    - Checks if the current character is a null character; if so, returns -1.
    - Checks if the current character matches `ch`; if so, returns the current index.
    - If the loop completes without finding `ch`, returns -1.
- **Output**: Returns the index of the first occurrence of `ch` in `buf`, or -1 if `ch` is not found or a null character is encountered before `ch`.


---
### run\_quic\_client<!-- {{#callable:run_quic_client}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_txns.c#L81>)

Establishes a QUIC client connection, sends data over the connection, and manages the connection lifecycle.
- **Inputs**:
    - `quic`: A pointer to an `fd_quic_t` structure representing the QUIC client instance.
    - `udpsock`: A pointer to an `fd_quic_udpsock_t` structure representing the UDP socket used for network communication.
- **Logic and Control Flow**:
    - Initialize a buffer `buf` of size 2048 and a buffer size variable `buf_sz` to 0.
    - Convert the destination IP address '198.18.0.1' to a 32-bit integer and store it in `dst_ip`; log an error if conversion fails.
    - Set the destination port to 9001.
    - Assign callback functions for connection events (`conn_new`, `conn_hs_complete`, `conn_final`, `stream_notify`) to the `quic` structure.
    - Set the asynchronous I/O network transmission for `quic` using `udpsock->aio` and initialize `quic`.
    - Enter an infinite loop to manage the QUIC connection and data transmission.
    - Get the current wall clock time and service the QUIC client and UDP socket.
    - If no global connection (`gbl_conn`), attempt to create a new connection to the specified IP and port, then continue the loop.
    - If the connection is not active, continue the loop.
    - If no global stream (`gbl_stream`), create a new stream for the connection, then continue the loop.
    - If `buf_sz` is zero, read a packet into `buf` and update `buf_sz`; if no input is available, break the loop.
    - If `buf_sz` is still zero, skip the iteration.
    - Send data over the stream using `fd_quic_stream_send`; if successful, reset `buf_sz` to zero and set `gbl_stream` to NULL.
    - If a global connection exists, log a notice and close the connection.
    - Wait for the connection to close by servicing the QUIC client and UDP socket until `gbl_conn` is NULL.
    - Finalize the QUIC client.
- **Output**: No return value; the function manages the QUIC client connection and data transmission lifecycle.
- **Functions Called**:
    - [`fd_quic_udpsock_service`](<fd_quic_test_helpers.c.md#fd_quic_udpsock_service>)
    - [`read_pkt`](<#read_pkt>)


---
### read\_pkt<!-- {{#callable:read_pkt}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_txns.c#L170>)

Reads a line from standard input, decodes it from base64, and stores the result in the output buffer.
- **Inputs**:
    - ``out_buf``: A pointer to an unsigned character array where the decoded data will be stored.
    - ``out_buf_sz``: A pointer to an unsigned long where the size of the decoded data will be stored.
- **Logic and Control Flow**:
    - Declare a buffer `buf` of size 2048 and a variable `buf_sz` to store its size.
    - Use `fgets` to read a line from standard input into `buf`. If `fgets` returns `NULL`, check for an error using `ferror` and log a warning if an error occurred, then return 1.
    - Find the newline character in `buf` using [`findch`](<#findch>). If not found, log a warning about the line being too long and return 1.
    - Replace the newline character with a null terminator to properly terminate the string.
    - Decode the base64-encoded string in `buf` using `fd_base64_decode`. If decoding fails, log a warning and a hexdump of the data, then return 1.
    - Store the size of the decoded data in `out_buf_sz` and return 0 to indicate success.
- **Output**: Returns 0 on success, or 1 if an error occurs during reading or decoding.
- **Functions Called**:
    - [`findch`](<#findch>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_txns.c#L206>)

Initializes and runs a QUIC client to send transactions over a network, then cleans up resources.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Creates an anonymous workspace using `fd_wksp_new_anonymous` with specified size and CPU index.
    - Defines QUIC limits and calculates the required memory footprint using `fd_quic_footprint`.
    - Allocates memory for QUIC using `fd_wksp_alloc_laddr` and initializes a new QUIC instance with `fd_quic_new`.
    - Converts the string "0.0.0.0" to an IP address and checks for validity.
    - Creates a UDP socket for the QUIC client using `fd_quic_client_create_udpsock`.
    - Configures the QUIC client settings, including role, maximum stream data, and idle timeout.
    - Calls [`run_quic_client`](<#run_quic_client>) to execute the QUIC client operations.
    - Frees allocated resources and deletes the QUIC instance and workspace.
    - Logs the number of transactions sent and returns this count as the exit status.
- **Output**: Returns the number of transactions sent as an integer.
- **Functions Called**:
    - [`run_quic_client`](<#run_quic_client>)
    - [`fd_quic_udpsock_destroy`](<fd_quic_test_helpers.c.md#fd_quic_udpsock_destroy>)


# Function Declarations (Public API)

---
### read\_pkt<!-- {{#callable_declaration:read_pkt}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_txns.c#L77>)

Reads a line from standard input, decodes it from base64, and stores the result in a buffer.
- **Description**: Use this function to read a line of input from standard input, decode it from base64, and store the decoded data in a provided buffer. The function expects a newline character to terminate the input line. If the input line is too long or if base64 decoding fails, the function returns an error code. Ensure that the output buffer is large enough to hold the decoded data. This function must be called in an environment where standard input is available and properly configured.
- **Inputs**:
    - `out_buf`: A pointer to a buffer where the decoded data will be stored. The buffer must be large enough to hold the decoded data. The caller retains ownership of the buffer.
    - `out_buf_sz`: A pointer to a variable where the size of the decoded data will be stored. The function writes the size of the decoded data to this location. The caller retains ownership of the variable.
- **Output**: Returns 0 on success, with the decoded data stored in `out_buf` and its size in `out_buf_sz`. Returns 1 if an error occurs, such as input line being too long or base64 decoding failure.
- **See Also**: [`read_pkt`](<#read_pkt>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)