<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for QUIC service queue functionality, including connection scheduling and timer management.

# Purpose
The code is a C test suite for validating the functionality of QUIC service timers and connection scheduling. It includes several static functions that test different aspects of the QUIC service timers, such as initialization, scheduling, and cancellation of timers for QUIC connections. The code uses mock connections to simulate real-world scenarios and verify that the service timers behave as expected. The [`main`](<#main>) function orchestrates the tests by setting up the necessary environment, including initializing connection limits and creating mock connections, before executing the test functions.

The test suite is structured to cover various scenarios, including scheduling connections in order, rescheduling with different timeouts, and handling multiple connections. It uses assertions (`FD_TEST`) to ensure that the expected conditions are met during the tests. The code also includes logging statements to provide feedback on the progress and results of the tests. The suite is designed to be executed as a standalone program, with the [`main`](<#main>) function serving as the entry point. It does not define public APIs or external interfaces, as its primary purpose is to verify the internal logic of the QUIC service timers.
# Imports and Dependencies

---
- `../fd_quic_svc_q.h`
- `../fd_quic_private.h`
- `../fd_quic_conn.h`
- `stdlib.h`


# Functions

---
### create\_mock\_conns<!-- {{#callable:create_mock_conns}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_svc_q.c#L8>)

Allocates and initializes a specified number of mock QUIC connections for testing purposes.
- **Inputs**:
    - `limits`: A pointer to an `fd_quic_limits_t` structure that defines the limits and configuration for the QUIC connections.
    - `conn_cnt`: An unsigned long integer specifying the number of connections to create.
- **Logic and Control Flow**:
    - Calculate the memory footprint required for each connection using `fd_quic_conn_footprint` with the provided `limits`.
    - Allocate memory for the connections using `aligned_alloc`, ensuring the memory is aligned according to `fd_quic_conn_align` and is sufficient for `conn_cnt` connections.
    - Verify that the memory allocation was successful using `FD_TEST`.
    - Iterate over the number of connections (`conn_cnt`), initializing each connection's index (`conn_idx`) and calling `fd_quic_svc_timers_init_conn` to initialize service timers for each connection.
    - Return the pointer to the allocated memory block containing the initialized connections.
- **Output**: A pointer to the allocated memory block containing the initialized mock connections.


---
### test\_svc\_timers\_init<!-- {{#callable:test_svc_timers_init}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_svc_q.c#L25>)

Initializes and tests the service timers for QUIC connections.
- **Inputs**:
    - ``max_conn``: The maximum number of connections to support.
    - ``state``: A pointer to the QUIC state structure.
    - ``out_to_free``: A pointer to a memory location where the allocated memory address will be stored for later deallocation.
- **Logic and Control Flow**:
    - Logs the start of the `fd_quic_svc_timers_init` test.
    - Calculates the memory footprint required for the service timers using `fd_quic_svc_timers_footprint` with `max_conn`.
    - Checks that the calculated footprint is greater than zero.
    - Allocates aligned memory for the service timers using `aligned_alloc` with the calculated footprint and alignment from `fd_quic_svc_timers_align`.
    - Stores the allocated memory address in `out_to_free`.
    - Initializes the service timers using `fd_quic_svc_timers_init` with the allocated memory, `max_conn`, and `state`.
    - Checks that the service timers were successfully initialized.
    - Logs the successful completion of the `fd_quic_svc_timers_init` test.
- **Output**: Returns a pointer to the initialized `fd_quic_svc_timers_t` structure.


---
### check\_dynamic\_timer<!-- {{#callable:check_dynamic_timer}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_svc_q.c#L46>)

Validates that a dynamic timer for a QUIC connection is correctly set and matches the expected timeout.
- **Inputs**:
    - ``timers``: A pointer to `fd_quic_svc_timers_t`, representing the service timers for QUIC connections.
    - ``conn``: A pointer to `fd_quic_conn_t`, representing the QUIC connection to check.
    - ``timeout``: A long integer representing the expected timeout value for the connection.
    - ``now``: A long integer representing the current time.
- **Logic and Control Flow**:
    - Checks that the connection's private queue index is not invalid using `FD_TEST`.
    - Verifies that the connection's service type is `FD_QUIC_SVC_DYNAMIC` using `FD_TEST`.
    - Calls `fd_quic_svc_timers_next` to get the next service event for the timers at the current time `now`.
    - Checks that the timeout of the next service event matches the expected `timeout` using `FD_TEST`.
- **Output**: No output is returned; the function performs validation checks using assertions.


---
### check\_instant\_timer<!-- {{#callable:check_instant_timer}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_svc_q.c#L57>)

Validates that a connection's instant timer is correctly set and scheduled.
- **Inputs**:
    - ``timers``: A pointer to an `fd_quic_svc_timers_t` structure, which manages service timers for QUIC connections.
    - ``conn``: A pointer to an `fd_quic_conn_t` structure, representing the QUIC connection to check.
    - ``now``: A long integer representing the current time, used to validate the timer.
- **Logic and Control Flow**:
    - Check that the service type of the connection is `FD_QUIC_SVC_INSTANT` using `FD_TEST`.
    - Retrieve the next service event using `fd_quic_svc_timers_next` with `timers`, `now`, and `0` as arguments.
    - Verify that the connection in the retrieved event matches the input `conn` using `FD_TEST`.
    - Check that the timeout of the retrieved event matches `now` using `FD_TEST`.
    - Ensure that the head of the `instant` timer list in `timers` matches the connection index of `conn` using `FD_TEST`.
- **Output**: No output is returned; the function uses assertions (`FD_TEST`) to validate conditions.


---
### test\_svc\_schedule<!-- {{#callable:test_svc_schedule}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_svc_q.c#L68>)

Tests the scheduling and rescheduling of service timers for a QUIC connection.
- **Inputs**:
    - `timers`: A pointer to `fd_quic_svc_timers_t`, which manages the service timers for QUIC connections.
    - `conn`: A pointer to `fd_quic_conn_t`, representing the QUIC connection whose service timer is being tested.
- **Logic and Control Flow**:
    - Logs the start of the test with a notice message.
    - Sets the current time `now` to 1000UL.
    - Schedules a basic timer by setting `conn->svc_meta.next_timeout` to `now + 100L` and calls `fd_quic_svc_timers_schedule` to schedule it.
    - Verifies the scheduling with [`check_dynamic_timer`](<#check_dynamic_timer>) to ensure the timer is set for `now + 100L`.
    - Reschedules the timer with an earlier timeout (`now + 50L`) and verifies the change with [`check_dynamic_timer`](<#check_dynamic_timer>).
    - Attempts to reschedule the timer with a later timeout (`now + 150L`), but verifies that the earlier timeout (`now + 50L`) remains in effect using [`check_dynamic_timer`](<#check_dynamic_timer>).
    - Schedules an instant timer by setting `conn->svc_meta.next_timeout` to `now` and verifies it with [`check_instant_timer`](<#check_instant_timer>).
    - Attempts to change the instant timer to a dynamic one with a timeout of `now + 100L`, but verifies that the instant timer remains in effect using [`check_instant_timer`](<#check_instant_timer>).
    - Cancels the scheduled timer using `fd_quic_svc_timers_cancel`.
    - Logs the successful completion of the test with a notice message.
- **Output**: No return value; the function performs tests and logs results.
- **Functions Called**:
    - [`check_dynamic_timer`](<#check_dynamic_timer>)
    - [`check_instant_timer`](<#check_instant_timer>)


---
### test\_svc\_cancel<!-- {{#callable:test_svc_cancel}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_svc_q.c#L104>)

Tests the cancellation of a scheduled service event for a QUIC connection and verifies the cancellation.
- **Inputs**:
    - `timers`: A pointer to `fd_quic_svc_timers_t`, which manages the scheduling of QUIC service events.
    - `conn`: A pointer to `fd_quic_conn_t`, representing the QUIC connection whose service event is being tested for cancellation.
- **Logic and Control Flow**:
    - Logs the start of the test for `fd_quic_svc_cancel`.
    - Sets the current time `now` to 1000L and schedules a service event for the connection with a timeout of `now + 100L`.
    - Calls `fd_quic_svc_timers_schedule` to schedule the event and [`check_dynamic_timer`](<#check_dynamic_timer>) to verify the scheduling.
    - Cancels the scheduled event using `fd_quic_svc_timers_cancel`.
    - Verifies that the connection's `prq_idx` is set to `FD_QUIC_SVC_PRQ_IDX_INVAL`, indicating cancellation.
    - Retrieves the service event using `fd_quic_svc_timers_get_event` and checks that the event's connection is `NULL`, confirming cancellation.
    - Checks that no events are scheduled by calling `fd_quic_svc_timers_next` and verifying the returned connection is `NULL`.
    - Logs the successful completion of the `fd_quic_svc_cancel` test.
- **Output**: No return value; the function performs tests and logs results.
- **Functions Called**:
    - [`check_dynamic_timer`](<#check_dynamic_timer>)


---
### test\_multiple\_connections<!-- {{#callable:test_multiple_connections}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_svc_q.c#L128>)

Tests the scheduling and validation of multiple QUIC connections using service timers.
- **Inputs**:
    - `limits`: A pointer to an `fd_quic_limits_t` structure that defines the limits for QUIC connections, including the number of connections (`conn_cnt`).
- **Logic and Control Flow**:
    - Logs the start of the multiple connections test.
    - Retrieves the number of connections from `limits` and creates mock connections using [`create_mock_conns`](<#create_mock_conns>).
    - Calculates the connection size using `fd_quic_conn_footprint`.
    - Initializes service timers with [`test_svc_timers_init`](<#test_svc_timers_init>) and stores the result in `timers`.
    - Sets each connection's state to `FD_QUIC_CONN_STATE_ACTIVE`.
    - Schedules the first 10 connections in order with increasing timeouts and verifies they are popped in the same order.
    - Checks that the queue is empty after popping all scheduled connections.
    - Schedules the same 10 connections in reverse order and verifies they are popped in the correct order.
    - Validates the connection and timer setup using `fd_quic_conn_validate_init` and `fd_quic_svc_timers_validate`.
    - Frees allocated memory for connections and timers.
    - Logs the successful completion of the multiple connections test.
- **Output**: No return value; the function performs tests and logs results.
- **Functions Called**:
    - [`create_mock_conns`](<#create_mock_conns>)
    - [`test_svc_timers_init`](<#test_svc_timers_init>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_svc_q.c#L209>)

Initializes and tests QUIC service queue functionalities using mock connections and timers.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Defines `max_conn` as 10, representing the maximum number of connections.
    - Initializes `fd_quic_limits_t` structure with predefined limits for testing.
    - Logs the start of QUIC service queue tests.
    - Creates a mock connection using [`create_mock_conns`](<#create_mock_conns>) and initializes a mock state with connection details.
    - Initializes service timers using [`test_svc_timers_init`](<#test_svc_timers_init>) and assigns the connection state to active.
    - Tests scheduling and canceling of service timers using [`test_svc_schedule`](<#test_svc_schedule>) and [`test_svc_cancel`](<#test_svc_cancel>).
    - Frees allocated memory for the connection and timer base.
    - Tests multiple connections using [`test_multiple_connections`](<#test_multiple_connections>) with the defined limits.
    - Logs the successful completion of all tests.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`create_mock_conns`](<#create_mock_conns>)
    - [`test_svc_timers_init`](<#test_svc_timers_init>)
    - [`test_svc_schedule`](<#test_svc_schedule>)
    - [`test_svc_cancel`](<#test_svc_cancel>)
    - [`test_multiple_connections`](<#test_multiple_connections>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)