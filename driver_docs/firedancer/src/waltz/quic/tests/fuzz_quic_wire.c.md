<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

A stateless fuzz target for testing the early stages of QUIC packet processing, including custom mutator logic for handling encrypted UDP datagrams.

# Purpose
The code is a fuzz testing module for the QUIC protocol, specifically targeting the packet processing components of the `fd_quic` library. It is designed to test the robustness of the QUIC packet handlers by providing malformed or unexpected inputs to the system. The module uses the `libFuzzer` framework to generate random inputs, which are then processed by the QUIC packet handlers. The inputs are initially encrypted UDP datagrams, and a custom mutator is used to decrypt these inputs before mutation, ensuring that the fuzzing process can effectively test the packet processing logic without being hindered by encryption failures.

The code includes several key components: initialization functions for setting up the fuzzing environment, functions for sending and processing UDP packets, and custom mutator functions for handling encrypted inputs. The [`LLVMFuzzerInitialize`](<#llvmfuzzerinitialize>) function sets up the environment, while [`LLVMFuzzerTestOneInput`](<#llvmfuzzertestoneinput>) is the main entry point for processing each fuzzing input. The code also includes functions for decrypting and encrypting QUIC packets, allowing the fuzzing process to handle both encrypted and unencrypted data. The module is intended to be used as part of a larger fuzz testing suite to identify potential vulnerabilities or bugs in the QUIC packet processing pipeline.
# Imports and Dependencies

---
- `../../../util/sanitize/fd_fuzz.h`
- `fd_quic_test_helpers.h`
- `../crypto/fd_quic_crypto_suites.h`
- `../templ/fd_quic_parse_util.h`
- `../../tls/test_tls_helper.h`
- `../../../util/net/fd_ip4.h`
- `../../../util/net/fd_udp.h`
- `../fd_quic_proto.h`
- `../fd_quic_proto.c`
- `../fd_quic_private.h`
- `../fd_quic_svc_q.h`
- `assert.h`
- `stdlib.h`


# Global Variables

---
### g\_clock
- **Type**: ``long``
- **Description**: Represents a global variable that stores a clock value used in the QUIC packet processing pipeline.
- **Use**: Used to track the current time in the QUIC packet processing and service scheduling.


---
### keys
- **Type**: ``fd_quic_crypto_keys_t const``
- **Description**: The `keys` variable is a static constant array of type `fd_quic_crypto_keys_t` with a single element. It is initialized with zeroed packet key, initialization vector (IV), and header protection key (hp_key).
- **Use**: Used to store cryptographic keys for QUIC packet encryption and decryption.


# Functions

---
### LLVMFuzzerInitialize<!-- {{#callable:LLVMFuzzerInitialize}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fuzz_quic_wire.c#L31>)

Initializes the fuzzer environment by setting environment variables, booting the system, registering cleanup functions, and configuring logging levels.
- **Inputs**:
    - `pargc`: A pointer to an integer representing the number of command-line arguments.
    - `pargv`: A pointer to an array of strings representing the command-line arguments.
- **Logic and Control Flow**:
    - Set the environment variable `FD_LOG_BACKTRACE` to `0` to disable backtraces in logs.
    - Call `fd_boot` with `pargc` and `pargv` to initialize the system.
    - Register `fd_halt` to be called at program exit using `atexit`.
    - Set the log level for log files to `0` using `fd_log_level_logfile_set`.
    - Set the log level for standard error to `0` using `fd_log_level_stderr_set`.
    - If `FD_DEBUG_MODE` is not defined, set the core log level to `3` using `fd_log_level_core_set`, which will cause the program to crash on warning logs.
    - Return `0` to indicate successful initialization.
- **Output**: Returns `0` to indicate successful initialization.


---
### \_aio\_send<!-- {{#callable:_aio_send}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fuzz_quic_wire.c#L45>)

Returns 0 without performing any operations.
- **Inputs**:
    - ``ctx``: A pointer to a context, not used in the function.
    - ``batch``: A pointer to a constant `fd_aio_pkt_info_t` structure, not used in the function.
    - ``batch_cnt``: An unsigned long representing the count of packets in the batch, not used in the function.
    - ``opt_batch_idx``: A pointer to an unsigned long, not used in the function.
    - ``flush``: An integer, not used in the function.
- **Logic and Control Flow**:
    - Ignores all input parameters using the `(void)` cast to suppress unused variable warnings.
    - Returns 0 as the function's result.
- **Output**: Always returns 0.


---
### send\_udp\_packet<!-- {{#callable:send_udp_packet}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fuzz_quic_wire.c#L59>)

Sends a UDP packet with specified data and size using QUIC protocol.
- **Inputs**:
    - `quic`: A pointer to an `fd_quic_t` structure representing the QUIC instance.
    - `data`: A pointer to the data to be sent in the UDP packet.
    - `size`: The size of the data to be sent.
- **Logic and Control Flow**:
    - Declare a buffer `buf` of size 16384 bytes to hold the packet data.
    - Calculate the size of the headers (`headers_sz`) by adding the sizes of `fd_ip4_hdr_t` and `fd_udp_hdr_t`.
    - Initialize pointers `cur` and `end` to the start and end of the buffer `buf`, respectively.
    - Create and initialize an IPv4 header `ip4` with version, protocol, and total length fields.
    - Create and initialize a UDP header `udp` with source port, destination port, length, and checksum fields.
    - Encode the IPv4 header into the buffer using `fd_quic_encode_ip4` and update the `cur` pointer.
    - Encode the UDP header into the buffer using `fd_quic_encode_udp` and update the `cur` pointer.
    - Check if there is enough space in the buffer to copy the data; if not, return without sending the packet.
    - Copy the data into the buffer starting at the `cur` pointer.
    - Call `fd_quic_process_packet` to process the packet with the QUIC instance, buffer, total size, and global clock.
- **Output**: No explicit output; the function sends a UDP packet using the provided QUIC instance.


---
### LLVMFuzzerTestOneInput<!-- {{#callable:LLVMFuzzerTestOneInput}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fuzz_quic_wire.c#L95>)

Processes a given input data buffer to test the QUIC protocol implementation by simulating a network environment and handling QUIC connections.
- **Inputs**:
    - `data`: A pointer to an array of unsigned characters representing the input data buffer.
    - `size`: An unsigned long integer representing the size of the input data buffer.
- **Logic and Control Flow**:
    - Initialize a random number generator and join it to a new instance.
    - Allocate a static memory region for the QUIC instance and define its limits for performance.
    - Determine configuration settings based on the last byte of the input data, such as enabling retry, setting the role, and establishing connection state.
    - Create and join a new QUIC instance with the specified limits and configuration.
    - Configure the QUIC instance with anonymous settings and a test signer context.
    - Set up an asynchronous I/O network transmission context and associate it with the QUIC instance.
    - Initialize the QUIC instance and verify its idle timeout configuration.
    - Create a dummy QUIC connection and schedule service timers for it.
    - Simulate sending a UDP packet using the input data to the QUIC instance.
    - Service all 'instant' events by processing them until no more are left or the service quota is exhausted.
    - Generate acknowledgments for any remaining events within the acknowledgment delay period.
    - Simulate connection timeout by processing events until no more connections are active.
    - Verify that the connection is dead and that stream resources are freed.
    - Clean up by deleting and leaving the QUIC, AIO, and RNG instances.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`fd_quic_config_anonymous`](<fd_quic_test_helpers.c.md#fd_quic_config_anonymous>)
    - [`fd_quic_config_test_signer`](<fd_quic_test_helpers.c.md#fd_quic_config_test_signer>)
    - [`send_udp_packet`](<#send_udp_packet>)


---
### guess\_packet\_size<!-- {{#callable:guess_packet_size}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fuzz_quic_wire.c#L248>)

Determines the total length of a QUIC packet and sets the packet number offset.
- **Inputs**:
    - ``data``: Pointer to the start of the QUIC packet data.
    - ``size``: Size of the data buffer.
    - ``pn_off``: Pointer to store the packet number offset.
- **Logic and Control Flow**:
    - Initialize `cur_ptr` to point to `data` and `cur_sz` to `size`.
    - Set `pkt_num_pnoff` and `total_len` to 0 and `size`, respectively.
    - Check if `size` is less than 1; if true, return `FD_QUIC_PARSE_FAIL`.
    - Determine the header form using `fd_quic_h0_hdr_form` on the first byte of `data`.
    - If the header form is long (value 1), decode the long header and determine the packet type.
    - For `FD_QUIC_PKT_TYPE_INITIAL` and `FD_QUIC_PKT_TYPE_HANDSHAKE`, decode the respective headers, update `pkt_num_pnoff` and `total_len`, and adjust `cur_ptr` and `cur_sz`.
    - For `FD_QUIC_PKT_TYPE_RETRY` and `FD_QUIC_PKT_TYPE_ZERO_RTT`, return 0 as they are not supported or require additional handling.
    - If the header form is short, decode the short header and update `pkt_num_pnoff`.
    - Store `pkt_num_pnoff` in `*pn_off`.
    - Return `total_len`.
- **Output**: Returns the total length of the QUIC packet, or 0 on failure.


---
### decrypt\_packet<!-- {{#callable:decrypt_packet}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fuzz_quic_wire.c#L328>)

Decrypts the first QUIC packet in a given buffer and returns the number of bytes of the decrypted packet.
- **Inputs**:
    - `data`: A pointer to the first byte of the QUIC packet to decrypt.
    - `size`: The number of bytes available in the buffer from the start of the QUIC packet to the end of the UDP datagram.
- **Logic and Control Flow**:
    - Initialize `pkt_num_pnoff` to 0 and call [`guess_packet_size`](<#guess_packet_size>) to determine the total length of the packet and the packet number offset.
    - If [`guess_packet_size`](<#guess_packet_size>) returns 0, indicating failure, return 0.
    - Call `fd_quic_crypto_decrypt_hdr` to decrypt the packet header; if it fails, return 0.
    - Calculate the packet number size using `fd_quic_h0_pkt_num_len` and decode the packet number using `fd_quic_pktnum_decode`.
    - Call `fd_quic_crypto_decrypt` to decrypt the packet payload; if it fails, return 0.
    - Return the minimum of the total length plus the crypto tag size and the input size.
- **Output**: The number of bytes that belonged to the first decrypted packet, or 0 on failure.
- **Functions Called**:
    - [`guess_packet_size`](<#guess_packet_size>)


---
### decrypt\_payload<!-- {{#callable:decrypt_payload}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fuzz_quic_wire.c#L357>)

Attempts to decrypt a UDP datagram payload containing multiple QUIC packets in-place.
- **Inputs**:
    - ``data``: A pointer to the buffer containing the UDP datagram payload to decrypt.
    - ``size``: The size of the data buffer in bytes.
- **Logic and Control Flow**:
    - Check if the `size` is less than 16 bytes; if true, return 0 indicating failure.
    - Calculate a `mask` by OR-ing the last 16 bytes of `data`; if the `mask` is zero, return 1 indicating the packet is unencrypted.
    - Initialize `cur_ptr` to point to the start of `data` and `cur_sz` to `size`.
    - Enter a loop that continues while `cur_sz` is greater than zero.
    - In each iteration, call [`decrypt_packet`](<#decrypt_packet>) with `cur_ptr` and `cur_sz` to attempt decryption of a packet.
    - If [`decrypt_packet`](<#decrypt_packet>) returns zero, return 0 indicating decryption failure.
    - Assert that the size returned by [`decrypt_packet`](<#decrypt_packet>) is less than or equal to `cur_sz` to prevent out-of-bounds access.
    - Update `cur_ptr` and `cur_sz` to point to the next packet in the buffer.
    - Return 1 after successfully decrypting all packets.
- **Output**: Returns 1 if the payload is successfully decrypted or is unencrypted, and 0 if decryption fails.
- **Functions Called**:
    - [`decrypt_packet`](<#decrypt_packet>)


---
### encrypt\_packet<!-- {{#callable:encrypt_packet}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fuzz_quic_wire.c#L386>)

Encrypts a QUIC packet in-place using specified cryptographic keys.
- **Inputs**:
    - `data`: A pointer to the buffer containing the QUIC packet to encrypt.
    - `size`: The size of the data buffer in bytes.
- **Logic and Control Flow**:
    - Initialize a buffer `out` to store the encrypted packet.
    - Call [`guess_packet_size`](<#guess_packet_size>) to determine the total length of the packet and the packet number offset `pkt_num_pnoff`.
    - Check if the total length is valid and return `size` if not.
    - Extract the packet number size from the first byte of the packet.
    - Calculate the header size `hdr_sz` and extract the packet number from the header.
    - Check if the output size is valid and return `size` if not.
    - Extract the payload and its size from the packet.
    - Call `fd_quic_crypto_encrypt` to encrypt the packet header and payload using the cryptographic keys and packet number.
    - If encryption fails, return `size`.
    - Copy the encrypted packet from `out` back to `data`.
    - Return the size of the encrypted packet.
- **Output**: The size of the encrypted packet in bytes, or the original size if encryption fails.
- **Functions Called**:
    - [`guess_packet_size`](<#guess_packet_size>)


---
### encrypt\_payload<!-- {{#callable:encrypt_payload}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fuzz_quic_wire.c#L432>)

Encrypts a payload by processing each packet within the data buffer.
- **Inputs**:
    - ``data``: A pointer to the buffer containing the data to encrypt.
    - ``size``: The size of the data buffer in bytes.
- **Logic and Control Flow**:
    - Initialize `cur_ptr` to point to the start of the `data` buffer and `cur_sz` to the total `size` of the buffer.
    - Enter a loop that continues as long as `cur_sz` is greater than zero.
    - Within the loop, call [`encrypt_packet`](<#encrypt_packet>) with `cur_ptr` and `cur_sz` to encrypt the current packet.
    - Use `assert` to ensure [`encrypt_packet`](<#encrypt_packet>) returns a non-zero size to prevent an infinite loop and that the size is within bounds.
    - Update `cur_ptr` to point to the next packet by adding the size of the encrypted packet to it, and decrease `cur_sz` by the same amount.
- **Output**: No return value; the function modifies the `data` buffer in place.
- **Functions Called**:
    - [`encrypt_packet`](<#encrypt_packet>)


---
### LLVMFuzzerCustomMutator<!-- {{#callable:LLVMFuzzerCustomMutator}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fuzz_quic_wire.c#L458>)

Mutates input data for fuzz testing by decrypting, mutating, and optionally re-encrypting it.
- **Inputs**:
    - ``data``: A pointer to the input data buffer to be mutated.
    - ``data_sz``: The size of the input data buffer.
    - ``max_sz``: The maximum size allowed for the mutated data.
    - ``seed``: A seed value for randomization, though it is not used in this function.
- **Logic and Control Flow**:
    - Call [`decrypt_payload`](<#decrypt_payload>) to attempt to decrypt the input data.
    - Use `LLVMFuzzerMutate` to mutate the data, adjusting its size within the `max_sz` limit.
    - If decryption was successful, call [`encrypt_payload`](<#encrypt_payload>) to re-encrypt the mutated data.
    - Ignore the `seed` parameter as it is not used in the function.
    - Return the new size of the mutated data.
- **Output**: The size of the mutated data after processing.
- **Functions Called**:
    - [`decrypt_payload`](<#decrypt_payload>)
    - [`encrypt_payload`](<#encrypt_payload>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)