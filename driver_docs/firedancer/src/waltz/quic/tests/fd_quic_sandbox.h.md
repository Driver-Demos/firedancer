<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines a single-threaded QUIC sandbox for testing, capturing, and analyzing QUIC packet exchanges.

# Purpose
The `fd_quic_sandbox.h` file defines a C header for a sandbox environment used to test and analyze interactions with a QUIC protocol implementation, specifically an `fd_quic_t` instance. The primary structure defined is `fd_quic_sandbox_t`, which manages an instrumented QUIC instance and records outgoing packets in a ring buffer composed of an `mcache/dcache` pair. This setup allows for the capture and analysis of the last N packets sent by the QUIC instance. The sandbox is designed for single-threaded use and cannot be shared across different address spaces, eliminating the need for concurrency control mechanisms typically associated with packet capture.

The file provides several macros and functions to manage the lifecycle of the sandbox, including memory alignment and footprint requirements, initialization, and deletion of the sandbox instance. It also includes default configurations such as IP addresses, ports, and cryptographic keys for both the sandbox and a mock peer. Additionally, the file defines functions for packet capture and manipulation, such as reading the next packet, accessing packet data, and simulating QUIC connections and frame handling. The sandbox environment facilitates testing by allowing the injection of established connections and sending frames directly to the QUIC instance, bypassing certain protocol layers for testing purposes.
# Imports and Dependencies

---
- `../fd_quic.h`
- `../log/fd_quic_log_user.h`
- `../../../tango/mcache/fd_mcache.h`
- `../../../tango/dcache/fd_dcache.h`
- `../../../util/net/fd_ip4.h`


# Global Variables

---
### FD\_PROTOTYPES\_BEGIN
- **Type**: `macro`
- **Description**: `FD_PROTOTYPES_BEGIN` is a macro used to mark the beginning of a section in the code where function prototypes are declared. It is typically used to organize and separate different sections of code for clarity and maintainability.
- **Use**: Used to indicate the start of a section containing function prototypes.


---
### fd\_quic\_sandbox\_peer\_ed25519\_keypair
- **Type**: ``uchar const[64]``
- **Description**: A constant array of 64 unsigned characters representing the default Ed25519 key pair for the mock peer in the QUIC sandbox. The first 32 bytes are the private key, and the last 32 bytes are the public key.
- **Use**: Used to provide cryptographic identity for the mock peer in the QUIC sandbox environment.


---
### fd\_quic\_sandbox\_aes128\_key
- **Type**: ``uchar const[16]``
- **Description**: A constant array of 16 unsigned characters representing the AES-128-GCM secret key used in the QUIC sandbox environment. This key is used for symmetric encryption operations within the sandbox and mock peer communications.
- **Use**: Used as the default AES-128-GCM secret key for encryption in the QUIC sandbox.


---
### fd\_quic\_sandbox\_aes128\_iv
- **Type**: `uchar const [12]`
- **Description**: A constant array of 12 unsigned characters representing the default AES-128-GCM initialization vector (IV) for the sandbox `fd_quic_t` and mock peer.
- **Use**: Used as the initialization vector for AES-128-GCM encryption in the sandbox `fd_quic_t` and mock peer.


# Data Structures

---
### fd\_quic\_sandbox
- **Type**: ``struct``
- **Members**:
    - `magic`: A unique identifier for the `fd_quic_sandbox` object, set to `FD_QUIC_SANDBOX_MAGIC`.
    - `quic`: A pointer to the `fd_quic_t` instance being tested.
    - `pkt_mcache`: A pointer to the captured packet descriptor.
    - `pkt_dcache`: A pointer to the captured packet data.
    - `pkt_mtu`: The maximum payload size of the captured packet.
    - `log_rx`: An array for logging received packets.
    - `pkt_seq_r`: The sequence number of the next packet not yet read.
    - `pkt_seq_w`: The sequence number of the next packet to publish.
    - `pkt_chunk`: The index of the publisher chunk.
    - `wallclock`: The time as seen by `fd_quic` in nanoseconds.
- **Description**: Used to set up and analyze a conversation with `fd_quic`, `fd_quic_sandbox` manages an instrumented `fd_quic_t` instance and records its outgoing packets in a ring buffer. It is single-threaded and cannot be shared across different address spaces, eliminating the need for lockless concurrency patterns. The structure includes static members that are only changed by new/delete operations and state members that track packet sequences and time.


---
### fd\_quic\_sandbox\_t
- **Type**: ``struct``
- **Members**:
    - `magic`: A unique identifier for the `fd_quic_sandbox_t` object, set to `FD_QUIC_SANDBOX_MAGIC`.
    - `quic`: A pointer to the `fd_quic_t` instance being tested.
    - `pkt_mcache`: A pointer to the captured packet descriptor.
    - `pkt_dcache`: A pointer to the captured packet data.
    - `pkt_mtu`: The maximum payload size for captured packets.
    - `log_rx`: An array for logging received packets.
    - `pkt_seq_r`: The sequence number of the next packet not yet read.
    - `pkt_seq_w`: The sequence number of the next packet to publish.
    - `pkt_chunk`: The index of the publisher chunk.
    - `wallclock`: The time as seen by `fd_quic` in nanoseconds.
- **Description**: Used to set up and analyze a conversation with `fd_quic`, `fd_quic_sandbox_t` manages an instrumented `fd_quic_t` instance and records its outgoing packets in a ring buffer. It is single-threaded and cannot be shared across different address spaces, making lockless concurrency patterns unnecessary. The structure includes static members that are only changed by new/delete operations and state members that track packet sequences and time.


# Functions

---
### fd\_quic\_sandbox\_packet\_data<!-- {{#callable:fd_quic_sandbox_packet_data}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_sandbox.h#L171>)

Returns a pointer to the first byte of packet data in the sandbox packet capture memory cache.
- **Inputs**:
    - `sandbox`: A pointer to an `fd_quic_sandbox_t` structure, which represents the QUIC sandbox environment.
    - `frag`: A constant pointer to an `fd_frag_meta_t` structure, which contains metadata about a captured packet.
- **Logic and Control Flow**:
    - Cast the `sandbox` pointer to a `void *` and assign it to `base` to ensure alignment by `FD_CHUNK_ALIGN`.
    - Call `fd_chunk_to_laddr` with `base` and `frag->chunk` to compute the local address of the packet data.
- **Output**: A pointer to the first byte of the packet data, calculated from the sandbox base address and the chunk index from the fragment metadata.


# Function Declarations (Public API)

---
### fd\_quic\_sandbox\_align<!-- {{#callable_declaration:fd_quic_sandbox_align}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_sandbox.h#L72>)

Returns the alignment requirement for an `fd_quic_sandbox_t` object.
- **Description**: Use this function to determine the alignment requirement for memory regions intended to back an `fd_quic_sandbox_t` object. This is necessary to ensure that the memory is correctly aligned for the data structures used within the sandbox. Call this function before allocating memory for an `fd_quic_sandbox_t` to ensure proper alignment.
- **Inputs**: None
- **Output**: The function returns an `ulong` representing the alignment requirement in bytes.
- **See Also**: [`fd_quic_sandbox_align`](<fd_quic_sandbox.c.md#fd_quic_sandbox_align>)  (Implementation)


---
### fd\_quic\_sandbox\_footprint<!-- {{#callable_declaration:fd_quic_sandbox_footprint}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_sandbox.h#L88>)

Calculates the memory footprint for a QUIC sandbox.
- **Description**: Use this function to determine the memory size required to back a `fd_quic_sandbox_t` instance. This is necessary before allocating memory for the sandbox. The function requires valid parameters for QUIC limits, packet count, and maximum transmission unit (MTU). If any parameter is invalid, the function returns 0, indicating an error in the input parameters. Ensure that the packet count is a power of 2, as this is a requirement for the function to operate correctly.
- **Inputs**:
    - `quic_limits`: A pointer to a `fd_quic_limits_t` structure that defines the parameters for the QUIC instance. Must not be null and should contain valid configuration values.
    - `pkt_cnt`: The number of packets to buffer. Must be a power of 2. Invalid values result in a return value of 0.
    - `mtu`: The maximum size of each packet, specified as the size of the UDP datagram excluding Ethernet or IPv4 headers. Must be a valid size for the intended network configuration.
- **Output**: Returns the size in bytes of the memory footprint required for the sandbox. Returns 0 if any input parameter is invalid.
- **See Also**: [`fd_quic_sandbox_footprint`](<fd_quic_sandbox.c.md#fd_quic_sandbox_footprint>)  (Implementation)


---
### fd\_quic\_sandbox\_new<!-- {{#callable_declaration:fd_quic_sandbox_new}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_sandbox.h#L100>)

Formats a memory region for use as a QUIC sandbox.
- **Description**: Use this function to initialize a memory region as a `fd_quic_sandbox_t` object, which is used to manage and analyze a QUIC instance with packet capture capabilities. Ensure that the memory region is aligned according to `fd_quic_sandbox_align` and that the parameters match those used with `fd_quic_sandbox_footprint`. The function returns a pointer to the initialized sandbox on success, or NULL if the memory is NULL, misaligned, or if the parameters are invalid. It logs a warning or critical error message in case of failure.
- **Inputs**:
    - `mem`: A pointer to the memory region to format. Must not be NULL and must be aligned according to `fd_quic_sandbox_align`. Caller retains ownership.
    - `quic_limits`: A pointer to a `fd_quic_limits_t` structure specifying the parameters for the QUIC instance. Must not be NULL. Caller retains ownership.
    - `pkt_cnt`: The number of packets to buffer, which must be a power of 2. Used to determine the size of the packet capture ring.
    - `mtu`: The maximum size of each packet, specified as the UDP datagram size, excluding Ethernet or IPv4 headers.
- **Output**: Returns a pointer to the initialized `fd_quic_sandbox_t` on success, or NULL on failure.
- **See Also**: [`fd_quic_sandbox_new`](<fd_quic_sandbox.c.md#fd_quic_sandbox_new>)  (Implementation)


---
### fd\_quic\_sandbox\_init<!-- {{#callable_declaration:fd_quic_sandbox_init}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_sandbox.h#L119>)

Resets the QUIC sandbox to a common initial state.
- **Description**: Use this function to reset a `fd_quic_sandbox_t` instance to a predefined initial state. This function prepares the sandbox for a new session by setting the role, initializing the QUIC instance, and clearing any existing connections or packet captures. It must be called with a valid `fd_quic_sandbox_t` pointer and a role identifier, which should be either `FD_QUIC_ROLE_CLIENT` or `FD_QUIC_ROLE_SERVER`. The function returns the sandbox pointer on success or `NULL` if initialization fails.
- **Inputs**:
    - `sandbox`: A pointer to a `fd_quic_sandbox_t` instance. Must not be null and should point to a valid, joined sandbox object.
    - `role`: An integer representing the role of the QUIC instance. Must be either `FD_QUIC_ROLE_CLIENT` or `FD_QUIC_ROLE_SERVER`. Invalid values may cause the function to fail.
- **Output**: Returns a pointer to the initialized `fd_quic_sandbox_t` on success, or `NULL` if initialization fails.
- **See Also**: [`fd_quic_sandbox_init`](<fd_quic_sandbox.c.md#fd_quic_sandbox_init>)  (Implementation)


---
### fd\_quic\_sandbox\_delete<!-- {{#callable_declaration:fd_quic_sandbox_delete}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_sandbox.h#L126>)

Destroys a QUIC sandbox object and releases its memory.
- **Description**: Use this function to safely destroy a `fd_quic_sandbox_t` object and release the associated memory back to the caller. This function checks if the provided memory pointer is valid and if the sandbox object has the correct magic number before proceeding with the deletion. It is important to ensure that the memory region was previously formatted as a `fd_quic_sandbox_t` using `fd_quic_sandbox_new`. If the memory pointer is null or the magic number is incorrect, the function logs a warning and returns null.
- **Inputs**:
    - `mem`: A pointer to the memory region that contains the `fd_quic_sandbox_t` object. Must not be null and must have been previously initialized as a `fd_quic_sandbox_t`. If null or if the magic number is incorrect, the function logs a warning and returns null.
- **Output**: Returns the original memory pointer if the deletion is successful, or null if the input is invalid.
- **See Also**: [`fd_quic_sandbox_delete`](<fd_quic_sandbox.c.md#fd_quic_sandbox_delete>)  (Implementation)


---
### fd\_quic\_sandbox\_next\_packet<!-- {{#callable_declaration:fd_quic_sandbox_next_packet}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_sandbox.h#L152>)

Reads the next buffered packet from the sandbox.
- **Description**: Use this function to retrieve the next packet that the `fd_quic_t` instance might have sent earlier. It returns a pointer to the packet's fragment descriptor and advances the read index if a packet is available. If no new packet is available, it returns NULL. If packet loss occurs due to an overrun, a warning is logged. This function is useful for analyzing outgoing packets in a single-threaded environment.
- **Inputs**:
    - `sandbox`: A pointer to an `fd_quic_sandbox_t` instance. This must not be null and must point to a valid sandbox object that has been properly initialized. The function reads from the packet capture ring buffer within this sandbox.
- **Output**: Returns a pointer to an `fd_frag_meta_t` structure if a packet is available, or NULL if no new packet is available. Logs a warning if packet loss is detected due to an overrun.
- **See Also**: [`fd_quic_sandbox_next_packet`](<fd_quic_sandbox.c.md#fd_quic_sandbox_next_packet>)  (Implementation)


---
### fd\_quic\_sandbox\_send\_frame<!-- {{#callable_declaration:fd_quic_sandbox_send_frame}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_sandbox.h#L211>)

Sends a QUIC frame to a sandboxed QUIC instance.
- **Description**: Use this function to send a QUIC frame directly to a sandboxed QUIC instance through a specified connection. This function bypasses decryption and directly handles the frame, which requires packet metadata. Ensure that the `sandbox` and `conn` are properly initialized and that `frame` points to a valid memory region containing the wire-encoded frame data. The function does not return a value, but it logs a critical error if the frame handling fails.
- **Inputs**:
    - `sandbox`: A pointer to an `fd_quic_sandbox_t` structure representing the sandboxed QUIC instance. Must not be null and must be properly initialized.
    - `conn`: A pointer to an `fd_quic_conn_t` structure representing the connection through which the frame is sent. Must not be null and must be a valid connection.
    - `pkt_meta`: A pointer to an `fd_quic_pkt_t` structure containing packet metadata required for frame handling. Must not be null.
    - `frame_ptr`: A pointer to a constant unsigned character array containing the wire-encoded frame data. Must not be null and must point to a valid memory region.
    - `frame_sz`: An unsigned long representing the size of the frame data. Must be greater than zero and should not exceed the maximum allowable frame size.
- **Output**: None
- **See Also**: [`fd_quic_sandbox_send_frame`](<fd_quic_sandbox.c.md#fd_quic_sandbox_send_frame>)  (Implementation)


---
### fd\_quic\_sandbox\_send\_lone\_frame<!-- {{#callable_declaration:fd_quic_sandbox_send_lone_frame}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_sandbox.h#L222>)

Sends a single QUIC frame with realistic packet metadata.
- **Description**: Use this function to send a single QUIC frame through a specified connection in the sandbox environment. It simulates sending the frame in a single QUIC packet and updates the packet number accordingly. Ensure that the frame size does not exceed the maximum transmission unit (MTU) of the sandbox. This function is useful for testing and analyzing QUIC packet transmission in a controlled environment.
- **Inputs**:
    - `sandbox`: A pointer to an `fd_quic_sandbox_t` structure representing the sandbox environment. Must not be null.
    - `conn`: A pointer to an `fd_quic_conn_t` structure representing the connection through which the frame will be sent. Must not be null.
    - `frame`: A pointer to the frame data to be sent. The caller retains ownership and must ensure the data is valid for the duration of the call.
    - `frame_sz`: The size of the frame in bytes. Must be less than or equal to the sandbox's packet MTU. If the size exceeds the MTU, the function will not proceed.
- **Output**: None
- **See Also**: [`fd_quic_sandbox_send_lone_frame`](<fd_quic_sandbox.c.md#fd_quic_sandbox_send_lone_frame>)  (Implementation)


---
### fd\_quic\_sandbox\_send\_ping\_pkt<!-- {{#callable_declaration:fd_quic_sandbox_send_ping_pkt}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_sandbox.h#L231>)

Sends a 1-RTT packet containing only a PING frame.
- **Description**: Use this function to send a PING frame in a 1-RTT packet through a specified connection in the QUIC sandbox environment. This function is useful for testing and maintaining the connection's liveness. Ensure that the sandbox and connection are properly initialized before calling this function. The packet number must be valid and unique for the connection to avoid packet number duplication issues.
- **Inputs**:
    - `sandbox`: A pointer to an `fd_quic_sandbox_t` structure representing the QUIC sandbox environment. Must not be null and should be properly initialized.
    - `conn`: A pointer to an `fd_quic_conn_t` structure representing the QUIC connection through which the PING packet will be sent. Must not be null and should be a valid, established connection.
    - `pktnum`: An unsigned long integer representing the packet number for the PING packet. It should be unique for the connection to prevent packet number duplication.
- **Output**: None
- **See Also**: [`fd_quic_sandbox_send_ping_pkt`](<fd_quic_sandbox.c.md#fd_quic_sandbox_send_ping_pkt>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)