<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests QUIC key phase changes by simulating client-server communication with multiple streams and key updates.

# Purpose
The code is a C program designed to test the functionality of a QUIC (Quick UDP Internet Connections) protocol implementation. It sets up a client-server architecture using QUIC, where both the client and server are represented as separate fibres. The program tests the ability to handle multiple streams and key phase changes, which are critical for maintaining secure communication. The client and server communicate by sending and receiving data streams, and the program monitors the number of streams and key phase changes to ensure they meet predefined limits (`NUM_STREAMS` and `NUM_KEY_PHASE_CHANGES`).

The program initializes the QUIC client and server with specific configuration limits, such as connection counts and stream data sizes. It uses callback functions to handle events like connection establishment, handshake completion, and data reception. The main function orchestrates the setup of the QUIC instances, initializes the fibres, and runs the fibre scheduler to execute the client and server operations. The program logs key events and errors, ensuring that the QUIC connections are established and maintained correctly. Upon completion, it cleans up resources and logs the number of successful key updates.
# Imports and Dependencies

---
- `../fd_quic.h`
- `fd_quic_test_helpers.h`
- `../../../util/fibre/fd_fibre.h`
- `stdlib.h`


# Global Variables

---
### client\_done
- **Type**: ``int``
- **Description**: A static integer variable that indicates whether the client operations are complete.
- **Use**: Used as a flag to control the execution flow in the `client_fibre_fn` function, terminating the client operations when set to 1.


---
### server\_done
- **Type**: ``int``
- **Description**: A static integer variable that acts as a flag to indicate the completion status of the server process in the QUIC test environment.
- **Use**: Used to signal when the server should stop processing in the `server_fibre_fn` function.


---
### rcvd
- **Type**: `ulong`
- **Description**: `rcvd` is a static global variable of type `ulong` that tracks the number of streams received in the current key phase.
- **Use**: It is incremented in the `my_stream_rx_cb` callback function whenever a stream is received.


---
### tot\_rcvd
- **Type**: `ulong`
- **Description**: `tot_rcvd` is a static global variable of type `ulong` that tracks the total number of data streams received during the execution of the program.
- **Use**: Increments each time a data stream is received, providing a cumulative count of all received streams.


---
### tot\_key\_phase\_change
- **Type**: `ulong`
- **Description**: `tot_key_phase_change` is a static global variable of type `ulong` that tracks the total number of key phase changes that have occurred during the execution of the program.
- **Use**: It is incremented each time a key phase change is detected in the client connection.


---
### client\_fibre
- **Type**: ``fd_fibre_t *``
- **Description**: A pointer to a fibre structure used for managing the execution of the client-side operations in a QUIC protocol test.
- **Use**: Used to start and schedule the client fibre function `client_fibre_fn` which handles client-side QUIC operations.


---
### server\_fibre
- **Type**: ``fd_fibre_t *``
- **Description**: A pointer to a fibre structure used for server operations in the QUIC test environment. It is initialized to `NULL` and later assigned a fibre that executes the `server_fibre_fn` function.
- **Use**: Used to manage and execute server-side operations in a fibre-based scheduling environment.


---
### server\_complete
- **Type**: `int`
- **Description**: Indicates whether the server has completed its handshake process.
- **Use**: Used to signal the completion of the server's handshake in the `my_connection_new` function.


---
### client\_complete
- **Type**: `int`
- **Description**: Indicates whether the client handshake process is complete.
- **Use**: Used to signal the completion of the client handshake in the `my_handshake_complete` function.


---
### server\_conn
- **Type**: ``fd_quic_conn_t *``
- **Description**: A pointer to a `fd_quic_conn_t` structure, which represents a QUIC connection on the server side. It is initialized to `NULL` and is used to store the active server connection once established.
- **Use**: Used to track the active server connection in the QUIC protocol implementation.


---
### now
- **Type**: `long`
- **Description**: Represents a global clock value used for synchronizing operations in the QUIC test environment. It is initialized to a large value `1e18L` to simulate a specific point in time.
- **Use**: Used to synchronize the clocks of QUIC connections and to determine timing for operations such as sending data and servicing connections.


# Data Structures

---
### my\_context
- **Type**: ``struct``
- **Members**:
    - `server`: An integer representing the server state or identifier.
- **Description**: Represents a context structure with a single integer member `server`, which is likely used to store server-related information or state within the context of a QUIC connection or operation.


---
### my\_context\_t
- **Type**: ``struct``
- **Members**:
    - `server`: An integer that likely indicates the server status or role.
- **Description**: `my_context_t` is a structure that contains a single integer member named `server`. This structure is used to represent context information, possibly related to server operations or status, within the code. The `server` member is used to store an integer value that may indicate whether the context is associated with a server or client role, or it may represent some server-specific state or configuration.


---
### client\_args
- **Type**: ``struct``
- **Members**:
    - ``quic``: A pointer to an `fd_quic_t` structure representing the client's QUIC instance.
    - ``server_quic``: A pointer to an `fd_quic_t` structure representing the server's QUIC instance.
- **Description**: The `client_args` structure holds pointers to QUIC instances for both the client and server, facilitating communication and synchronization between them in a QUIC-based network test.


---
### client\_args\_t
- **Type**: ``struct``
- **Members**:
    - ``quic``: A pointer to an `fd_quic_t` structure representing the client's QUIC instance.
    - ``server_quic``: A pointer to an `fd_quic_t` structure representing the server's QUIC instance.
- **Description**: Holds pointers to the QUIC instances for both the client and server, facilitating communication and synchronization between them during the test.


---
### server\_args
- **Type**: ``struct``
- **Members**:
    - ``quic``: A pointer to a `fd_quic_t` structure, representing the QUIC server instance.
    - ``client_quic``: A pointer to a `fd_quic_t` structure, representing the QUIC client instance.
- **Description**: The `server_args` structure holds pointers to two `fd_quic_t` instances, one for the server and one for the client, facilitating the management of QUIC connections in a server-client setup.


---
### server\_args\_t
- **Type**: ``struct``
- **Members**:
    - ``quic``: A pointer to an `fd_quic_t` structure representing the server's QUIC instance.
    - ``client_quic``: A pointer to an `fd_quic_t` structure representing the client's QUIC instance.
- **Description**: `server_args_t` is a structure that holds pointers to QUIC instances for both the server and client, facilitating communication and synchronization between them in a QUIC-based network test.


# Functions

---
### my\_stream\_rx\_cb<!-- {{#callable:my_stream_rx_cb}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_key_phase.c#L33>)

Increments the global counters `rcvd` and `tot_rcvd` and returns `FD_QUIC_SUCCESS`.
- **Inputs**:
    - `conn`: A pointer to a `fd_quic_conn_t` structure representing the QUIC connection.
    - `stream_id`: An unsigned long integer representing the stream identifier.
    - `offset`: An unsigned long integer representing the offset in the stream.
    - `data`: A pointer to a constant unsigned char array containing the data received.
    - `data_sz`: An unsigned long integer representing the size of the data received.
    - `fin`: An integer indicating if this is the final part of the data stream (1 if final, 0 otherwise).
- **Logic and Control Flow**:
    - Ignores all input parameters using `(void)` casting to suppress unused variable warnings.
    - Increments the global variable `rcvd` by 1.
    - Increments the global variable `tot_rcvd` by 1.
    - Returns the constant `FD_QUIC_SUCCESS`.
- **Output**: Returns the constant `FD_QUIC_SUCCESS`, indicating successful processing.


---
### my\_cb\_conn\_final<!-- {{#callable:my_cb_conn_final}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_key_phase.c#L54>)

Clears the connection context pointer for a given QUIC connection.
- **Inputs**:
    - ``conn``: A pointer to an `fd_quic_conn_t` structure representing the QUIC connection.
    - ``context``: A void pointer to additional context, marked as unused with `FD_PARAM_UNUSED`.
- **Logic and Control Flow**:
    - Retrieve the context associated with the connection using `fd_quic_conn_get_context` and cast it to a double pointer to `fd_quic_conn_t`.
    - Check if the retrieved context pointer is not NULL.
    - If not NULL, log a success message with the pointer value and set the dereferenced pointer to NULL.
- **Output**: No return value; the function operates by side effect on the connection context.


---
### my\_connection\_new<!-- {{#callable:my_connection_new}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_key_phase.c#L64>)

Handles the completion of a server-side QUIC handshake and sets the server connection.
- **Inputs**:
    - ``conn``: A pointer to an `fd_quic_conn_t` structure representing the new QUIC connection.
    - ``vp_context``: A void pointer to additional context, which is not used in this function.
- **Logic and Control Flow**:
    - Logs the message 'SERVER - handshake complete' to indicate the handshake is complete.
    - Sets the `server_complete` flag to 1 to indicate the server has completed the handshake.
    - Checks if `server_conn` is already set; if so, logs an error message 'SERVER - Unexpected new connection'.
    - Assigns the `conn` pointer to `server_conn` to store the new connection.
- **Output**: No return value; the function operates by side effects, such as logging and setting global variables.


---
### my\_handshake\_complete<!-- {{#callable:my_handshake_complete}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_key_phase.c#L80>)

Logs a message indicating the client handshake is complete and sets the `client_complete` flag to 1.
- **Inputs**:
    - ``conn``: A pointer to an `fd_quic_conn_t` structure representing the QUIC connection; it is not used in the function.
    - ``vp_context``: A pointer to a context object; it is not used in the function.
- **Logic and Control Flow**:
    - Log the message 'CLIENT - handshake complete' using `FD_LOG_INFO`.
    - Set the `client_complete` variable to 1.
- **Output**: No return value; the function operates through side effects.


---
### test\_fibre\_clock<!-- {{#callable:test_fibre_clock}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_key_phase.c#L93>)

Returns the current value of the global variable `now`.
- **Inputs**: None
- **Logic and Control Flow**:
    - The function directly returns the value of the global variable `now`.
- **Output**: A `long` integer representing the current value of the global variable `now`.


---
### sync\_clocks<!-- {{#callable:sync_clocks}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_key_phase.c#L98>)

Synchronizes the `now` field of two `fd_quic_t` structures to ensure their clocks are aligned.
- **Inputs**:
    - `x`: A pointer to an `fd_quic_t` structure whose clock will be synchronized.
    - `y`: A pointer to another `fd_quic_t` structure whose clock will be synchronized.
- **Logic and Control Flow**:
    - Retrieve the state of the `fd_quic_t` structure pointed to by `x` using `fd_quic_get_state(x)`.
    - Retrieve the state of the `fd_quic_t` structure pointed to by `y` using `fd_quic_get_state(y)`.
    - Set the `now` field of both retrieved states to the global variable `now`, ensuring both clocks are synchronized.
- **Output**: No output is returned as the function is of type `void`.


---
### client\_fibre\_fn<!-- {{#callable:client_fibre_fn}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_key_phase.c#L109>)

Manages a client QUIC connection, sending data streams and handling key phase changes until a specified number of changes occur.
- **Inputs**:
    - `vp_arg`: A pointer to a `client_args_t` structure containing the client and server QUIC instances.
- **Logic and Control Flow**:
    - Cast `vp_arg` to `client_args_t` to extract `quic` and `server_quic` pointers.
    - Initialize connection and stream variables, and set up a buffer with the message 'Hello World!'.
    - Attempt to establish a QUIC connection using `fd_quic_connect`; log an error if unsuccessful.
    - Set the connection context and wait until the connection state is `FD_QUIC_CONN_STATE_ACTIVE`.
    - Synchronize clocks and service the client QUIC instance in a loop until the connection is active.
    - Log the establishment of the connection and initialize the key phase tracking.
    - Enter a loop that continues until `client_done` is set to 1, indicating the completion of key phase changes.
    - Within the loop, synchronize clocks, service the QUIC instance, and handle key phase changes.
    - If the number of received streams equals `NUM_STREAMS`, initiate a key phase change and reset the count.
    - Create a new stream if none exists, and send data if the current time is past `next_send`.
    - Log a warning if sending data fails, and prepare a new stream for the next send attempt.
    - Close the connection when `client_done` is set, and continue servicing until the connection is closed.
    - Set `server_done` to 1 to signal the server to shut down.
- **Output**: No return value; the function operates through side effects on the QUIC connection and global state variables.
- **Functions Called**:
    - [`sync_clocks`](<#sync_clocks>)


---
### server\_fibre\_fn<!-- {{#callable:server_fibre_fn}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_key_phase.c#L242>)

Manages server-side QUIC operations, including synchronization, servicing, and key phase tracking, until the server is marked as done.
- **Inputs**:
    - `vp_arg`: A pointer to a `server_args_t` structure containing the server and client QUIC instances.
- **Logic and Control Flow**:
    - Cast `vp_arg` to `server_args_t` to access server and client QUIC instances.
    - Initialize `last_key_phase` to an invalid value (-1u) to track key phase changes.
    - Set `period_ns` to 1 millisecond for periodic wake-up.
    - Enter a loop that continues until `server_done` is true.
    - In each iteration, synchronize clocks between server and client QUIC instances using [`sync_clocks`](<#sync_clocks>).
    - Service the server QUIC instance with `fd_quic_service`.
    - If a server connection exists, check if the key phase has changed and log the change if it has.
    - Calculate the next wake-up time using `fd_quic_get_next_wakeup` and compare it with the next period.
    - Use `fd_fibre_wait_until` to wait until the earlier of the next wake-up or next period.
- **Output**: No return value; the function operates in a loop until `server_done` is true, managing server-side QUIC operations.
- **Functions Called**:
    - [`sync_clocks`](<#sync_clocks>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_key_phase.c#L276>)

Initializes and runs a QUIC client-server test using fibers and virtual pairs, handling connections, streams, and key phase changes.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
- **Logic and Control Flow**:
    - Initialize the environment and QUIC test with `fd_boot` and [`fd_quic_test_boot`](<fd_quic_test_helpers.c.md#fd_quic_test_boot>).
    - Create a random number generator `rng` using `fd_rng_new` and `fd_rng_join`.
    - Determine the CPU index and adjust if it exceeds the shared memory CPU count.
    - Parse command-line arguments for page size, page count, and NUMA index using `fd_env_strip_cmdline_cstr` and `fd_env_strip_cmdline_ulong`.
    - Convert the page size string to a numeric value with `fd_cstr_to_shmem_page_sz` and log an error if unsupported.
    - Create an anonymous workspace `wksp` with `fd_wksp_new_anonymous` and verify its creation.
    - Define server and client QUIC limits and create QUIC instances `server_quic` and `client_quic` using [`fd_quic_new_anonymous`](<fd_quic_test_helpers.c.md#fd_quic_new_anonymous>).
    - Set callback functions for client and server QUICs for connection and stream events.
    - Initialize a virtual pair `vp` for the client and server QUICs using [`fd_quic_virtual_pair_init`](<fd_quic_test_helpers.c.md#fd_quic_virtual_pair_init>).
    - Initialize the QUIC instances with `fd_quic_init`.
    - Allocate memory for fibers and initialize them with `fd_fibre_init`.
    - Set the fiber scheduler clock using `fd_fibre_set_clock`.
    - Create and start fibers for the client and server using `fd_fibre_start` and pass the respective arguments.
    - Schedule the fibers with `fd_fibre_schedule`.
    - Run the fiber scheduler loop with `fd_fibre_schedule_run` until completion.
    - Log the number of key updates passed and clean up resources, including QUIC instances, workspace, and RNG.
    - Call [`fd_quic_test_halt`](<fd_quic_test_helpers.c.md#fd_quic_test_halt>) and `fd_halt` to terminate the test.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`fd_quic_test_boot`](<fd_quic_test_helpers.c.md#fd_quic_test_boot>)
    - [`fd_quic_new_anonymous`](<fd_quic_test_helpers.c.md#fd_quic_new_anonymous>)
    - [`fd_quic_virtual_pair_init`](<fd_quic_test_helpers.c.md#fd_quic_virtual_pair_init>)
    - [`fd_quic_virtual_pair_fini`](<fd_quic_test_helpers.c.md#fd_quic_virtual_pair_fini>)
    - [`fd_quic_test_halt`](<fd_quic_test_helpers.c.md#fd_quic_test_halt>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)