<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Helpers for QUIC tests, including virtual pair setup, UDP socket creation, and network emulation.

# Purpose
The code is a C header file that provides helper functions and structures for testing QUIC (Quick UDP Internet Connections) implementations. It includes definitions and prototypes for setting up and managing virtual QUIC connections, configuring QUIC instances, and handling network emulation for testing purposes. The file defines a structure `fd_quic_virtual_pair_t` to facilitate the connection of two local QUIC instances via asynchronous I/O (AIO), with optional packet capture capabilities. It also provides functions to initialize and finalize these virtual pairs, allowing for the simulation of QUIC communication in a controlled test environment.

Additionally, the file includes utilities for creating and managing UDP sockets (`fd_quic_udpsock_t`) and network emulation (`fd_quic_netem_t`). The UDP socket utilities help in setting up communication channels over UDP, while the network emulation utilities allow for the simulation of packet loss and reordering, which are common network conditions that can affect QUIC performance. The header file is intended to be included in test suites that require these functionalities, providing a common set of tools to facilitate the testing and validation of QUIC protocols.
# Imports and Dependencies

---
- `../fd_quic.h`
- `../fd_quic_private.h`
- `../../aio/fd_aio_pcapng.h`
- `../../udpsock/fd_udpsock.h`
- `../../tls/test_tls_helper.h`
- `../../../ballet/txn/fd_txn.h`
- `stdio.h`


# Global Variables

---
### fd\_quic\_test\_pcap
- **Type**: `FILE *`
- **Description**: A pointer to a `FILE` object that represents a file stream for packet capture data in QUIC tests.
- **Use**: Used to append test traffic to a pcapng 1.0 file, including encryption secrets, during QUIC tests.


# Data Structures

---
### fd\_quic\_virtual\_pair
- **Type**: ``struct``
- **Members**:
    - ``quic_a``: Pointer to a `fd_quic_t` structure representing the first QUIC instance.
    - ``quic_b``: Pointer to a `fd_quic_t` structure representing the second QUIC instance.
    - ``aio_a2b``: Pointer to a constant `fd_aio_t` structure for the first hop in the asynchronous I/O chain from `quic_a` to `quic_b`.
    - ``aio_b2a``: Pointer to a constant `fd_aio_t` structure for the first hop in the asynchronous I/O chain from `quic_b` to `quic_a`.
    - ``pcapng_a2b``: `fd_aio_pcapng_t` structure for packet capture from `quic_a` to `quic_b`.
    - ``pcapng_b2a``: `fd_aio_pcapng_t` structure for packet capture from `quic_b` to `quic_a`.
- **Description**: Connects two local QUIC instances using direct asynchronous I/O (AIO) and optionally supports packet capture. The structure contains pointers to two QUIC instances, `quic_a` and `quic_b`, and manages AIO chains and packet capture configurations for communication between them.


---
### fd\_quic\_virtual\_pair\_t
- **Type**: ``struct``
- **Members**:
    - `quic_a`: Pointer to the first QUIC instance in the virtual pair.
    - `quic_b`: Pointer to the second QUIC instance in the virtual pair.
    - `aio_a2b`: Pointer to the first hop of the asynchronous I/O chain from `quic_a` to `quic_b`.
    - `aio_b2a`: Pointer to the first hop of the asynchronous I/O chain from `quic_b` to `quic_a`.
    - `pcapng_a2b`: Packet capture configuration for traffic from `quic_a` to `quic_b`.
    - `pcapng_b2a`: Packet capture configuration for traffic from `quic_b` to `quic_a`.
- **Description**: Connects two local QUIC instances using direct asynchronous I/O, with optional packet capture support.


---
### fd\_quic\_udpsock\_t
- **Type**: ``struct``
- **Members**:
    - ``type``: Defines the type of UDP socket, with a specific value for `FD_QUIC_UDPSOCK_TYPE_UDPSOCK`.
    - ``listen_ip``: Specifies the IP address on which the socket listens.
    - ``listen_port``: Specifies the port number on which the socket listens.
    - ``wksp``: Pointer to the workspace that owns the objects.
    - ``udpsock``: Union containing a structure with a pointer to `fd_udpsock_t` and a socket file descriptor.
    - ``aio``: Pointer to a constant `fd_aio_t` structure.
- **Description**: Facilitates the creation of a UDP channel over AF_XDP or UDP sockets, providing fields for socket type, listening IP and port, workspace ownership, and asynchronous I/O handling.


---
### fd\_quic\_netem\_reorder\_buf
- **Type**: ``struct``
- **Members**:
    - ``sz``: Stores the size of the data in the buffer.
    - ``buf``: An array of 2048 unsigned characters used as a buffer.
- **Description**: Used to store and manage a buffer for packet reordering in a network emulation context, specifically for QUIC protocol testing.


---
### fd\_quic\_netem
- **Type**: ``struct``
- **Members**:
    - `local`: Represents the local asynchronous I/O endpoint.
    - `dst`: Points to the destination asynchronous I/O endpoint.
    - `thresh_drop`: Specifies the threshold for packet drop probability.
    - `thresh_reorder`: Specifies the threshold for packet reordering probability.
    - `reorder_buf`: Holds two buffers for packet reordering.
    - `reorder_mru`: Indicates the most recently used reorder buffer.
- **Description**: Injects packet loss and reordering into an asynchronous I/O link, using thresholds to determine the probability of these events and buffers to manage packet reordering.


---
### fd\_quic\_netem\_t
- **Type**: ``struct``
- **Members**:
    - ``local``: An `fd_aio_t` object representing the local asynchronous I/O interface.
    - ``dst``: A constant pointer to an `fd_aio_t` object representing the destination asynchronous I/O interface.
    - ``thresh_drop``: A float value representing the threshold for packet drop probability.
    - ``thresh_reorder``: A float value representing the threshold for packet reordering probability.
    - ``reorder_buf``: An array of two `fd_quic_netem_reorder_buf` structures used for packet reordering.
    - ``reorder_mru``: An integer indicating the most recently written reorder buffer.
- **Description**: Injects packet loss and reordering into an asynchronous I/O link, simulating network conditions for testing purposes. It uses thresholds to determine the probability of dropping or reordering packets and maintains buffers to manage packet reordering.


# Function Declarations (Public API)

---
### fd\_quic\_test\_boot<!-- {{#callable_declaration:fd_quic_test_boot}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.h#L45>)

Boots the QUIC test environment with optional packet capture.
- **Description**: Use this function to initialize the QUIC test environment, optionally enabling packet capture if the '--pcap' command-line option is provided. This function should be called after the system has been initialized with `fd_boot()`. If the '--pcap' option is specified, the function will open the specified file for appending test traffic data in pcapng format, including encryption secrets. The function registers a cleanup routine to flush the pcap data at program exit. Ensure that the command-line arguments are correctly passed to the function to enable the desired behavior.
- **Inputs**:
    - `pargc`: Pointer to the argument count. Must not be null. The function may modify the argument count if it processes the '--pcap' option.
    - `pargv`: Pointer to the argument vector. Must not be null. The function may modify the argument vector if it processes the '--pcap' option.
- **Output**: None
- **See Also**: [`fd_quic_test_boot`](<fd_quic_test_helpers.c.md#fd_quic_test_boot>)  (Implementation)


---
### fd\_quic\_test\_halt<!-- {{#callable_declaration:fd_quic_test_halt}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.h#L48>)

Halts the QUIC test environment.
- **Description**: Use this function to stop the QUIC test environment. It should be called before `fd_halt()` to ensure proper cleanup of resources. This function is particularly important if packet capture was enabled during the test, as it will close the capture file and reset the capture state. Ensure that the test environment is initialized before calling this function.
- **Inputs**: None
- **Output**: None
- **See Also**: [`fd_quic_test_halt`](<fd_quic_test_helpers.c.md#fd_quic_test_halt>)  (Implementation)


---
### fd\_quic\_config\_anonymous<!-- {{#callable_declaration:fd_quic_config_anonymous}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.h#L51>)

Configures a QUIC instance with default settings and role.
- **Description**: Use this function to set up a QUIC instance with default configuration values and specify its role as either a client or server. This function initializes various default parameters such as idle timeout, acknowledgment delay, and maximum stream data. It also sets default callback functions for connection and stream events. Call this function after creating a QUIC instance to ensure it is properly configured before use.
- **Inputs**:
    - `quic`: A pointer to an `fd_quic_t` structure representing the QUIC instance to configure. Must not be null.
    - `role`: An integer specifying the role of the QUIC instance. Typically, this is used to set the instance as a client or server.
- **Output**: None
- **See Also**: [`fd_quic_config_anonymous`](<fd_quic_test_helpers.c.md#fd_quic_config_anonymous>)  (Implementation)


---
### fd\_quic\_config\_test\_signer<!-- {{#callable_declaration:fd_quic_config_test_signer}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.h#L55>)

Configures a QUIC instance with a test signer context.
- **Description**: Use this function to set up a QUIC instance with a specific test signer context. This is typically done in a testing environment where you need to simulate or verify the behavior of QUIC with a known signing context. Ensure that the QUIC instance is properly initialized before calling this function. The function updates the QUIC configuration with the provided public key and signing context, which are essential for cryptographic operations during testing.
- **Inputs**:
    - `quic`: A pointer to an `fd_quic_t` structure representing the QUIC instance to configure. Must not be null and should be initialized before use.
    - `sign_ctx`: A pointer to an `fd_tls_test_sign_ctx_t` structure containing the test signing context. Must not be null and should contain a valid public key for the configuration.
- **Output**: None
- **See Also**: [`fd_quic_config_test_signer`](<fd_quic_test_helpers.c.md#fd_quic_config_test_signer>)  (Implementation)


---
### fd\_quic\_new\_anonymous<!-- {{#callable_declaration:fd_quic_new_anonymous}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.h#L65>)

Creates an anonymous QUIC instance with specified limits and role.
- **Description**: Use this function to create a new QUIC instance with anonymous configuration. It initializes the instance with the specified limits and role, which can be either server or client. The function automatically generates vacant configuration fields. It is important to note that the function halts the program if an error occurs during the creation process. The caller is responsible for cleaning up the QUIC instance after use.
- **Inputs**:
    - `wksp`: A pointer to an `fd_wksp_t` workspace where the QUIC instance will be allocated. Must not be null.
    - `limits`: A pointer to a constant `fd_quic_limits_t` structure specifying the limits for the QUIC instance. Must not be null.
    - `role`: An integer specifying the role of the QUIC instance, either as a server or a client. Valid values are typically defined elsewhere in the API.
    - `rng`: A pointer to an `fd_rng_t` random number generator used for configuration. Must not be null.
- **Output**: Returns a pointer to the newly created `fd_quic_t` instance. The caller must manage the lifecycle of this instance.
- **See Also**: [`fd_quic_new_anonymous`](<fd_quic_test_helpers.c.md#fd_quic_new_anonymous>)  (Implementation)


---
### fd\_quic\_new\_anonymous\_small<!-- {{#callable_declaration:fd_quic_new_anonymous_small}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.h#L74>)

Creates an anonymous QUIC instance with small limits.
- **Description**: Use this function to create a QUIC instance with predefined small limits for testing or lightweight applications. It simplifies the setup by using minimal resource allocations, making it suitable for scenarios where resource constraints are a priority. Ensure that the workspace is properly initialized before calling this function. The caller is responsible for managing the lifecycle of the returned QUIC instance, including cleanup.
- **Inputs**:
    - `wksp`: A pointer to an `fd_wksp_t` workspace. Must be initialized before use. The caller retains ownership.
    - `role`: An integer specifying the role of the QUIC instance, either as a server or client. Valid values are typically defined by the application.
    - `rng`: A pointer to an `fd_rng_t` random number generator. Must be initialized before use. The caller retains ownership.
- **Output**: Returns a pointer to a newly created `fd_quic_t` instance. The caller is responsible for cleanup.
- **See Also**: [`fd_quic_new_anonymous_small`](<fd_quic_test_helpers.c.md#fd_quic_new_anonymous_small>)  (Implementation)


---
### fd\_quic\_virtual\_pair\_init<!-- {{#callable_declaration:fd_quic_virtual_pair_init}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.h#L86>)

Sets up an asynchronous I/O loop between two QUIC objects.
- **Description**: Use this function to establish a direct communication loop between two QUIC instances, enabling synchronous callbacks for data transmission. This function can optionally log packet data if packet capture is enabled. It must be called only once per thread and is intended for use in a test environment. Ensure that any resources allocated during this process are released at the appropriate time, typically during a halt operation.
- **Inputs**:
    - `pair`: A pointer to an `fd_quic_virtual_pair_t` structure that will be initialized to connect the two QUIC instances. The caller must provide a valid, non-null pointer.
    - `quicA`: A pointer to the first `fd_quic_t` QUIC instance. The caller must provide a valid, non-null pointer.
    - `quicB`: A pointer to the second `fd_quic_t` QUIC instance. The caller must provide a valid, non-null pointer.
- **Output**: None
- **See Also**: [`fd_quic_virtual_pair_init`](<fd_quic_test_helpers.c.md#fd_quic_virtual_pair_init>)  (Implementation)


---
### fd\_quic\_virtual\_pair\_fini<!-- {{#callable_declaration:fd_quic_virtual_pair_fini}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.h#L94>)

Destroys an asynchronous I/O loop between two QUIC objects.
- **Description**: Use this function to clean up and release resources associated with an asynchronous I/O loop between two QUIC objects that were previously initialized. This function should be called when the loop is no longer needed to ensure proper resource management. It is important to call this function to avoid resource leaks, especially if packet capture was enabled during initialization. Ensure that the `pair` parameter is valid and was previously initialized with `fd_quic_virtual_pair_init`.
- **Inputs**:
    - `pair`: A pointer to an `fd_quic_virtual_pair_t` structure representing the QUIC pair to finalize. Must not be null and should have been initialized with `fd_quic_virtual_pair_init`. The function does not handle invalid or null pointers.
- **Output**: None
- **See Also**: [`fd_quic_virtual_pair_fini`](<fd_quic_test_helpers.c.md#fd_quic_virtual_pair_fini>)  (Implementation)


---
### fd\_quic\_test\_cb\_tls\_keylog<!-- {{#callable_declaration:fd_quic_test_cb_tls_keylog}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.h#L97>)

Logs TLS key information for QUIC tests.
- **Description**: Use this function to log TLS key information during QUIC tests when packet capture is enabled. It writes the provided TLS key log line to a pcapng file if the global `fd_quic_test_pcap` is set. This function is typically used in a testing environment where capturing encryption secrets is necessary for analysis. Ensure that packet capture is enabled before calling this function.
- **Inputs**:
    - `quic_ctx`: A context pointer for the QUIC instance. This parameter is not used in the function and can be set to any value.
    - `line`: A pointer to a null-terminated string containing the TLS key log line. Must not be null, and the string should be valid and properly formatted for logging.
- **Output**: None
- **See Also**: [`fd_quic_test_cb_tls_keylog`](<fd_quic_test_helpers.c.md#fd_quic_test_cb_tls_keylog>)  (Implementation)


---
### fd\_quic\_udpsock\_create<!-- {{#callable_declaration:fd_quic_udpsock_create}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.h#L133>)

Creates a UDP socket for QUIC communication.
- **Description**: Use this function to create a UDP socket for QUIC communication, configured with command-line options for MTU, RX depth, TX depth, listen IP, and listen port. This function initializes the socket and binds it to the specified IP and port. It must be called with valid command-line arguments and a workspace for memory allocation. The function returns a pointer to the created socket structure or NULL if an error occurs during socket creation or binding.
- **Inputs**:
    - `_sock`: Pointer to a pre-allocated `fd_quic_udpsock_t` structure. The function initializes this structure. Must not be null.
    - `argc`: Pointer to the argument count. The function modifies this to reflect consumed arguments. Must not be null.
    - `argv`: Pointer to the argument vector. The function modifies this to reflect consumed arguments. Must not be null.
    - `wksp`: Pointer to a workspace (`fd_wksp_t`) used for memory allocation. Must not be null.
    - `rx_aio`: Pointer to a constant `fd_aio_t` structure for receive asynchronous I/O operations. Must not be null.
- **Output**: Returns a pointer to the initialized `fd_quic_udpsock_t` structure on success, or NULL on failure.
- **See Also**: [`fd_quic_udpsock_create`](<fd_quic_test_helpers.c.md#fd_quic_udpsock_create>)  (Implementation)


---
### fd\_quic\_udpsock\_destroy<!-- {{#callable_declaration:fd_quic_udpsock_destroy}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.h#L140>)

Destroys a QUIC UDP socket.
- **Description**: Use this function to release resources associated with a QUIC UDP socket. It should be called when the socket is no longer needed to ensure proper cleanup. The function handles different types of UDP sockets, specifically those of type `FD_QUIC_UDPSOCK_TYPE_UDPSOCK`. It is important to pass a valid pointer to a `fd_quic_udpsock_t` structure; otherwise, the function will return `NULL`. This function does not handle other types of UDP sockets.
- **Inputs**:
    - `udpsock`: A pointer to a `fd_quic_udpsock_t` structure representing the UDP socket to destroy. Must not be null. If null, the function returns `NULL` without performing any operations.
- **Output**: Returns the pointer to the `fd_quic_udpsock_t` structure if successful, or `NULL` if the input is null.
- **See Also**: [`fd_quic_udpsock_destroy`](<fd_quic_test_helpers.c.md#fd_quic_udpsock_destroy>)  (Implementation)


---
### fd\_quic\_udpsock\_service<!-- {{#callable_declaration:fd_quic_udpsock_service}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.h#L143>)

Services a UDP socket for QUIC operations.
- **Description**: Use this function to service a UDP socket that is part of a QUIC operation. It processes the socket based on its type, specifically handling sockets of type `FD_QUIC_UDPSOCK_TYPE_UDPSOCK`. This function should be called when the UDP socket needs to be serviced as part of the QUIC communication process. Ensure that the `udpsock` parameter is correctly initialized and represents a valid UDP socket before calling this function.
- **Inputs**:
    - `udpsock`: A pointer to a `fd_quic_udpsock_t` structure representing the UDP socket to be serviced. The `type` field of this structure must be set to `FD_QUIC_UDPSOCK_TYPE_UDPSOCK`. The pointer must not be null, and the structure must be properly initialized before use.
- **Output**: None
- **See Also**: [`fd_quic_udpsock_service`](<fd_quic_test_helpers.c.md#fd_quic_udpsock_service>)  (Implementation)


---
### fd\_quic\_netem\_init<!-- {{#callable_declaration:fd_quic_netem_init}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.h#L166>)

Initialize a network emulator for packet loss and reordering.
- **Description**: Use this function to set up a network emulator that can simulate packet loss and reordering in a QUIC test environment. This function initializes the provided `fd_quic_netem_t` structure with specified thresholds for packet drop and reordering. It must be called before using the network emulator to ensure it is properly configured. The function also sets up the local asynchronous I/O context for the network emulator.
- **Inputs**:
    - `netem`: A pointer to an `fd_quic_netem_t` structure that will be initialized. Must not be null. The caller retains ownership.
    - `thres_drop`: A float value representing the threshold for packet drop. Valid values are typically between 0.0 and 1.0, where 0.0 means no packets are dropped and 1.0 means all packets are dropped.
    - `thres_reorder`: A float value representing the threshold for packet reordering. Valid values are typically between 0.0 and 1.0, where 0.0 means no packets are reordered and 1.0 means all packets are reordered.
- **Output**: Returns a pointer to the initialized `fd_quic_netem_t` structure.
- **See Also**: [`fd_quic_netem_init`](<fd_quic_test_helpers.c.md#fd_quic_netem_init>)  (Implementation)


---
### fd\_quic\_netem\_send<!-- {{#callable_declaration:fd_quic_netem_send}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_test_helpers.h#L173>)

Injects packet loss and reordering into a network emulation context.
- **Description**: Use this function to simulate packet loss and reordering in a network emulation context. It processes a batch of packets, deciding for each packet whether to drop it, reorder it, or send it immediately based on random thresholds. This function is useful for testing network protocols under conditions of packet loss and reordering. Ensure that the context is properly initialized and that the batch of packets is valid before calling this function. The function does not modify the input batch but may affect the order and delivery of packets.
- **Inputs**:
    - `ctx`: A pointer to a `fd_quic_netem_t` structure. Must not be null. The caller retains ownership.
    - `batch`: A pointer to an array of `fd_aio_pkt_info_t` structures representing the packets to process. Must not be null. The caller retains ownership.
    - `batch_cnt`: The number of packets in the batch. Must be greater than zero.
    - `opt_batch_idx`: An optional pointer to a `ulong` for batch indexing. This parameter is unused in the function.
    - `flush`: An integer flag indicating whether to flush the send buffer. Non-zero values indicate a flush.
- **Output**: Returns an integer status code. `FD_AIO_SUCCESS` indicates successful processing of the batch.
- **See Also**: [`fd_quic_netem_send`](<fd_quic_test_helpers.c.md#fd_quic_netem_send>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)