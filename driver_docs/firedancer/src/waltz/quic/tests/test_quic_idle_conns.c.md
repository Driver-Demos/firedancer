<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests QUIC idle connections by simulating client behavior and managing connection states.

# Purpose
The code is an implementation of a QUIC client in C. It is designed to establish and manage multiple QUIC connections to a specified destination IP and port. The code includes functions to handle connection events such as new connections, handshake completions, and connection terminations. It uses a global array `g_conn_meta` to track the state of each connection, which can be dead, initializing, or active. The main function initializes the environment, parses command-line arguments for configuration, and sets up the necessary resources such as memory workspace and UDP socket for the QUIC client. The [`run_quic_client`](<#run_quic_client>) function is responsible for the main loop, which continuously services the QUIC connections and manages their states.

The code defines several callback functions ([`cb_conn_new`](<#cb_conn_new>), [`cb_conn_handshake_complete`](<#cb_conn_handshake_complete>), and [`cb_conn_final`](<#cb_conn_final>)) to update the connection states and counters. It also includes logic to start new connections when there are available slots. The code uses the `fd_quic` library for QUIC protocol operations and the `fd_quic_udpsock` for UDP socket management. The configuration of the QUIC client is set through environment variables and command-line arguments, allowing customization of parameters such as the number of connections, page size, and NUMA index. The code is structured to be executed as a standalone application, with the [`main`](<#main>) function serving as the entry point.
# Imports and Dependencies

---
- `../fd_quic.h`
- `fd_quic_test_helpers.h`
- `../../../util/net/fd_ip4.h`
- `stdio.h`
- `string.h`


# Global Variables

---
### g\_conn\_meta
- **Type**: ``conn_meta_t` array`
- **Description**: An array of `conn_meta_t` structures, each representing metadata for a QUIC connection. Each element in the array holds a pointer to a connection, an index, and a state indicating the connection's lifecycle stage.
- **Use**: Stores metadata for up to `MAX_CONNS` QUIC connections, allowing the program to manage and track the state of each connection.


---
### g\_dead
- **Type**: `int`
- **Description**: Represents the number of available connection slots that are currently not in use or are 'dead'. It is initialized to the maximum number of connections, `MAX_CONNS`, indicating that all connection slots are initially available.
- **Use**: Tracks the number of available connection slots and is decremented when a new connection is initiated and incremented when a connection is finalized and marked as dead.


---
### g\_init
- **Type**: `int`
- **Description**: Tracks the number of connections that are in the initialization state.
- **Use**: Increments when a new connection is initialized and decrements when a connection transitions to another state.


---
### g\_active
- **Type**: `int`
- **Description**: Holds the count of active connections in the QUIC client application.
- **Use**: Tracks the number of connections that have completed the handshake and are currently active.


# Data Structures

---
### conn\_meta
- **Type**: ``struct``
- **Members**:
    - ``conn``: Pointer to a `fd_quic_conn_t` structure representing a QUIC connection.
    - ``conn_idx``: Unsigned integer representing the index of the connection.
    - ``state``: Unsigned integer representing the state of the connection.
- **Description**: Holds metadata for a QUIC connection, including a pointer to the connection object, an index for identifying the connection, and a state to track the connection's lifecycle.


---
### conn\_meta\_t
- **Type**: ``struct``
- **Members**:
    - ``conn``: Pointer to a `fd_quic_conn_t` structure.
    - ``conn_idx``: Unsigned integer representing the connection index.
    - ``state``: Unsigned integer representing the state of the connection.
- **Description**: `conn_meta_t` is a structure that holds metadata for a QUIC connection, including a pointer to the connection object, an index for identifying the connection, and a state indicating the current status of the connection (e.g., dead, initializing, or active).


# Functions

---
### cb\_conn\_new<!-- {{#callable:cb_conn_new}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_idle_conns.c#L28>)

Does nothing with the provided connection and context parameters.
- **Inputs**:
    - `conn`: A pointer to an `fd_quic_conn_t` structure representing the QUIC connection.
    - `quic_ctx`: A pointer to a context object, typically used for additional data or state management.
- **Logic and Control Flow**:
    - The function takes two parameters: `conn` and `quic_ctx`.
    - Both parameters are explicitly marked as unused using the `(void)` cast, indicating that the function does not perform any operations with them.
- **Output**: No output or return value; the function is a no-op.


---
### cb\_conn\_handshake\_complete<!-- {{#callable:cb_conn_handshake_complete}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_idle_conns.c#L35>)

Updates the connection state to active and adjusts global connection counters.
- **Inputs**:
    - ``conn``: A pointer to an `fd_quic_conn_t` structure representing the QUIC connection.
    - ``quic_ctx``: A pointer to a context object for QUIC, which is not used in this function.
- **Logic and Control Flow**:
    - Cast `quic_ctx` to void to indicate it is unused.
    - Retrieve the connection metadata from the global `g_conn_meta` array using the connection index from `conn`.
    - Set the state of the connection in `conn_meta` to `CONN_STATE_ACTIVE`.
    - Decrement the global `g_init` counter, which tracks initializing connections.
    - Increment the global `g_active` counter, which tracks active connections.
- **Output**: No return value; the function operates by side effects on global state and the `conn_meta` structure.


---
### cb\_conn\_final<!-- {{#callable:cb_conn_final}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_idle_conns.c#L48>)

Finalizes a QUIC connection by updating its state and adjusting global connection counters.
- **Inputs**:
    - ``conn``: A pointer to the `fd_quic_conn_t` structure representing the QUIC connection to finalize.
    - ``quic_ctx``: A pointer to a context object for QUIC, which is not used in this function.
- **Logic and Control Flow**:
    - Cast `quic_ctx` to void to indicate it is unused.
    - Retrieve the connection metadata from the global `g_conn_meta` array using the connection index from `conn`.
    - Set the `conn` field of the retrieved `conn_meta_t` structure to `NULL`.
    - Use a switch statement to check the current state of the connection (`conn_meta->state`).
    - If the state is `CONN_STATE_DEAD`, do nothing.
    - If the state is `CONN_STATE_INIT`, decrement `g_init` and increment `g_dead`.
    - If the state is `CONN_STATE_ACTIVE`, decrement `g_active` and increment `g_dead`.
    - Set the connection state to `CONN_STATE_DEAD`.
- **Output**: No return value; the function modifies global state and the `conn_meta_t` structure.


---
### run\_quic\_client<!-- {{#callable:run_quic_client}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_idle_conns.c#L66>)

Initializes and runs a QUIC client that manages connections and logs connection statistics.
- **Inputs**:
    - `quic`: A pointer to an `fd_quic_t` structure representing the QUIC client.
    - `udpsock`: A pointer to an `fd_quic_udpsock_t` structure representing the UDP socket for network communication.
    - `dst_ip`: The destination IP address for the QUIC connection, represented as an unsigned integer.
    - `dst_port`: The destination port for the QUIC connection, represented as an unsigned short.
- **Logic and Control Flow**:
    - Assigns callback functions for new connections, handshake completion, and connection finalization to the `quic` structure.
    - Sets the asynchronous I/O network transmission for the `quic` using the `udpsock`'s AIO.
    - Initializes the `quic` client and checks for successful initialization.
    - Enters an infinite loop to continuously service the QUIC client and UDP socket.
    - Checks if there are any dead connections and attempts to start a new connection if possible.
    - Updates connection metadata and state when a new connection is established.
    - Logs the number of active and initializing connections at regular intervals.
    - Finalizes the QUIC client when the loop exits (though the loop is infinite in the current implementation).
- **Output**: There is no return value as the function is of type `void`.
- **Functions Called**:
    - [`fd_quic_udpsock_service`](<fd_quic_test_helpers.c.md#fd_quic_udpsock_service>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_idle_conns.c#L115>)

Initializes and runs a QUIC client with specified configurations and command-line arguments.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Extracts source IP, destination IP, destination port, number of connections, number of pages, and page size from command-line arguments with default values if not provided.
    - Determines CPU and NUMA indices for shared memory allocation.
    - Converts page size string to a numeric value and checks for validity.
    - Checks if the number of connections exceeds the maximum allowed and logs an error if so.
    - Creates a new anonymous workspace for memory allocation.
    - Sets up QUIC limits and calculates the memory footprint required for QUIC operations.
    - Allocates memory for QUIC operations and initializes a new QUIC instance.
    - Initializes a random number generator and a test signing context for QUIC configuration.
    - Converts the source IP string to a numeric IP address and logs an error if invalid.
    - Creates a UDP socket for the QUIC client with the specified source IP.
    - Configures the QUIC client with role, maximum stream data, and idle timeout settings.
    - Converts the destination IP string to a numeric IP address and logs an error if invalid.
    - Runs the QUIC client with the specified configurations and UDP socket.
    - Frees allocated resources and halts the program.
- **Output**: Returns 0 on successful execution or 1 if there is an error with IP address conversion.
- **Functions Called**:
    - [`fd_quic_config_test_signer`](<fd_quic_test_helpers.c.md#fd_quic_config_test_signer>)
    - [`run_quic_client`](<#run_quic_client>)
    - [`fd_quic_udpsock_destroy`](<fd_quic_test_helpers.c.md#fd_quic_udpsock_destroy>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)