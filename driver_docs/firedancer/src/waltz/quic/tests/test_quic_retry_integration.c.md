<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for QUIC retry integration, including server-client handshake and token handling.

# Purpose
The code is a C program designed to test the functionality of a QUIC (Quick UDP Internet Connections) protocol implementation. It includes both server and client components, which are set up to communicate with each other using QUIC. The program defines several callback functions, such as [`my_stream_rx_cb`](<#my_stream_rx_cb>), [`my_connection_new`](<#my_connection_new>), and [`my_handshake_complete`](<#my_handshake_complete>), to handle events like receiving stream data, establishing new connections, and completing handshakes. These callbacks are registered with the server and client QUIC instances to facilitate the testing process.

The program includes two main test functions: [`test_initial_token_odd_sz`](<#test_initial_token_odd_sz>) and [`test_retry_integration`](<#test_retry_integration>). The [`test_initial_token_odd_sz`](<#test_initial_token_odd_sz>) function verifies that the server responds correctly with a Retry packet when it receives an Initial packet with an unexpected token size. The [`test_retry_integration`](<#test_retry_integration>) function tests the overall retry mechanism and connection establishment process between the client and server. The [`main`](<#main>) function initializes the testing environment, sets up the QUIC instances, and executes the test functions. It also manages resources such as memory and random number generators, ensuring proper cleanup after the tests are completed.
# Imports and Dependencies

---
- `../fd_quic.h`
- `fd_quic_test_helpers.h`
- `../../../util/net/fd_ip4.h`
- `stdio.h`
- `stdlib.h`


# Global Variables

---
### server\_complete
- **Type**: `int`
- **Description**: Indicates whether the server handshake process is complete. It is initialized to 0, meaning the handshake is not complete.
- **Use**: Used to track the completion status of the server handshake process.


---
### client\_complete
- **Type**: `int`
- **Description**: Indicates whether the client handshake process is complete.
- **Use**: Used to track the completion status of the client handshake in the QUIC protocol.


---
### server\_conn
- **Type**: ``fd_quic_conn_t *``
- **Description**: A pointer to an `fd_quic_conn_t` structure, which represents a QUIC connection in the system. It is initialized to `NULL` and is used to store the server connection once it is established.
- **Use**: Used to store the server connection object when a new connection is established in the `my_connection_new` callback function.


---
### now
- **Type**: `long`
- **Description**: Represents a global variable that acts as a clock or timestamp in the program. It is initialized with the value 123.
- **Use**: Used to provide a consistent time reference for functions like `fd_quic_connect` and `fd_quic_service`.


# Functions

---
### my\_stream\_rx\_cb<!-- {{#callable:my_stream_rx_cb}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_retry_integration.c#L8>)

Validates received QUIC stream data against specific conditions and logs debug information.
- **Inputs**:
    - `conn`: A pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
    - `stream_id`: The identifier of the stream from which data is received.
    - `offset`: The offset in the stream where the data starts.
    - `data`: A pointer to the received data buffer.
    - `data_sz`: The size of the received data in bytes.
    - `fin`: An integer indicating if this is the final part of the data (1 if true, 0 if false).
- **Logic and Control Flow**:
    - Logs the stream ID, data size, and offset using `FD_LOG_DEBUG`.
    - Checks if the `offset` is aligned to 512 bytes using `FD_TEST` and `fd_ulong_is_aligned`.
    - Logs a hex dump of the received data using `FD_LOG_HEXDUMP_DEBUG`.
    - Verifies that `data_sz` is exactly 512 bytes using `FD_TEST`.
    - Ensures that `fin` is false (0) using `FD_TEST`.
    - Compares the first 11 bytes of `data` to the string "Hello world" using `FD_TEST` and `memcmp`.
    - Returns `FD_QUIC_SUCCESS` if all tests pass.
- **Output**: Returns `FD_QUIC_SUCCESS` if all conditions are met.


---
### my\_connection\_new<!-- {{#callable:my_connection_new}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_retry_integration.c#L33>)

Handles the completion of a server-side QUIC connection handshake.
- **Inputs**:
    - ``conn``: A pointer to the `fd_quic_conn_t` structure representing the server connection.
    - ``vp_context``: A void pointer to additional context, which is not used in this function.
- **Logic and Control Flow**:
    - Logs a notice indicating that the server handshake is complete.
    - Sets the global variable `server_complete` to 1, indicating the server handshake is complete.
    - Assigns the `conn` pointer to the global variable `server_conn` to store the server connection.
- **Output**: No return value; the function operates through side effects on global variables.


---
### my\_handshake\_complete<!-- {{#callable:my_handshake_complete}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_retry_integration.c#L44>)

Logs a notice that the client handshake is complete and sets the `client_complete` flag to 1.
- **Inputs**:
    - ``conn``: A pointer to an `fd_quic_conn_t` structure representing the connection. It is not used in the function.
    - ``vp_context``: A pointer to a context object. It is not used in the function.
- **Logic and Control Flow**:
    - Logs a notice message indicating that the client handshake is complete using `FD_LOG_NOTICE`.
    - Sets the global variable `client_complete` to 1.
- **Output**: No return value; the function is of type `void`.


---
### test\_initial\_token\_odd\_sz<!-- {{#callable:test_initial_token_odd_sz}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_retry_integration.c#L61>)

Tests the server's response to an initial packet with a 46-byte token by verifying retry and connection metrics.
- **Inputs**:
    - `server_quic`: A pointer to the server's QUIC instance, used to track and verify connection metrics.
    - `client_quic`: A pointer to the client's QUIC instance, used to initiate a connection with a 46-byte token.
- **Logic and Control Flow**:
    - Log the start of the test for a 46-byte token.
    - Create a 46-byte token with sequential values from 1 to 46.
    - Store initial metrics from the server QUIC instance, including retry count, token length counts, and connection creation count.
    - Establish a new client connection using `fd_quic_connect` and verify its creation with `FD_TEST`.
    - Override the client's connection token with the 46-byte token and set the token length to 46.
    - Process packets by calling `fd_quic_service` on both client and server QUIC instances five times.
    - Verify that the server's retry count has increased by one, indicating a retry packet was sent.
    - Check that the 46-byte token is counted in the 'other sizes' category of the server's token length metrics.
    - Confirm that a new connection was created by checking the server's connection creation count.
    - Log the successful completion of the 46-byte token test.
- **Output**: No return value; the function uses assertions (`FD_TEST`) to verify expected behavior and logs the test results.


---
### test\_retry\_integration<!-- {{#callable:test_retry_integration}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_retry_integration.c#L105>)

Tests the retry mechanism in a QUIC connection by creating connections, sending data, and verifying metrics.
- **Inputs**:
    - `server_quic`: A pointer to the server QUIC instance.
    - `client_quic`: A pointer to the client QUIC instance.
- **Logic and Control Flow**:
    - Log the creation of a connection and initiate a client connection using `fd_quic_connect`.
    - Perform general processing in a loop, calling `fd_quic_service` for both client and server, and check if both handshakes are complete to break the loop.
    - Verify connection and retry metrics for both client and server QUIC instances using `FD_TEST`.
    - Check initial token length metrics to ensure expected packet counts and sizes.
    - Create two streams on the client connection using `fd_quic_conn_new_stream` and verify their creation.
    - Send data over the streams in a loop, alternating between the two streams, and log the result of `fd_quic_stream_send`.
    - Close the client and server connections using `fd_quic_conn_close`.
    - Run additional service loops to wait for acknowledgments and verify final connection metrics.
    - Log the completion of the retry integration test.
- **Output**: No return value; the function performs tests and logs results.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_retry_integration.c#L198>)

Initializes and tests a QUIC server and client setup, including workspace creation, QUIC configuration, and running integration tests.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
- **Logic and Control Flow**:
    - Calls `fd_boot` and [`fd_quic_test_boot`](<fd_quic_test_helpers.c.md#fd_quic_test_boot>) to initialize the environment and QUIC test setup.
    - Creates a random number generator `rng` using `fd_rng_new` and `fd_rng_join`.
    - Determines the CPU index using `fd_tile_cpu_id` and `fd_tile_idx`, adjusting if necessary.
    - Parses command-line arguments for page size, page count, and NUMA index using `fd_env_strip_cmdline_cstr` and `fd_env_strip_cmdline_ulong`.
    - Converts the page size string to an actual size using `fd_cstr_to_shmem_page_sz` and logs an error if unsupported.
    - Creates a workspace with `fd_wksp_new_anonymous` and checks its validity with `FD_TEST`.
    - Defines QUIC limits in a `fd_quic_limits_t` structure and calculates the QUIC footprint with `fd_quic_footprint`.
    - Creates server and client QUIC instances using [`fd_quic_new_anonymous`](<fd_quic_test_helpers.c.md#fd_quic_new_anonymous>) and sets up callbacks for connection and stream events.
    - Configures initial receive maximum stream data for both server and client QUICs.
    - Initializes a virtual pair with [`fd_quic_virtual_pair_init`](<fd_quic_test_helpers.c.md#fd_quic_virtual_pair_init>) and initializes both QUICs with `fd_quic_init`.
    - Runs [`test_retry_integration`](<#test_retry_integration>) and [`test_initial_token_odd_sz`](<#test_initial_token_odd_sz>) to perform integration tests on the QUIC setup.
    - Cleans up by finalizing the virtual pair, deleting QUIC instances, and freeing resources.
    - Logs a success message and halts the QUIC test and environment.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`fd_quic_test_boot`](<fd_quic_test_helpers.c.md#fd_quic_test_boot>)
    - [`fd_quic_new_anonymous`](<fd_quic_test_helpers.c.md#fd_quic_new_anonymous>)
    - [`fd_quic_virtual_pair_init`](<fd_quic_test_helpers.c.md#fd_quic_virtual_pair_init>)
    - [`test_retry_integration`](<#test_retry_integration>)
    - [`test_initial_token_odd_sz`](<#test_initial_token_odd_sz>)
    - [`fd_quic_virtual_pair_fini`](<fd_quic_test_helpers.c.md#fd_quic_virtual_pair_fini>)
    - [`fd_quic_test_halt`](<fd_quic_test_helpers.c.md#fd_quic_test_halt>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)