<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a QUIC sandbox for testing packet capture, sending, and connection management.

# Purpose
The code is a C module that implements a sandbox environment for testing and capturing packets in a QUIC (Quick UDP Internet Connections) protocol context. It provides functions to initialize, manage, and delete a `fd_quic_sandbox_t` structure, which acts as a container for QUIC operations. The module includes functions to capture outgoing packets, send response packets, and manage packet sequences. It also defines cryptographic keys for self and peer entities, as well as AES encryption parameters, which are used in the QUIC communication process.

The module includes several key functions: [`fd_quic_sandbox_capture_pkt`](<#fd_quic_sandbox_capture_pkt>) captures outgoing packets, [`fd_quic_sandbox_aio_send`](<#fd_quic_sandbox_aio_send>) handles sending packets in an asynchronous I/O context, and [`fd_quic_sandbox_next_packet`](<#fd_quic_sandbox_next_packet>) retrieves the next packet from the capture ring. The module also provides functions to create and initialize a new QUIC connection, send frames and packets, and manage the lifecycle of the sandbox. The code defines a public API for creating and managing a QUIC sandbox, which can be used for testing and debugging QUIC implementations.
# Imports and Dependencies

---
- `fd_quic_sandbox.h`
- `../fd_quic_private.h`
- `../templ/fd_quic_parse_util.h`


# Global Variables

---
### fd\_quic\_sandbox\_self\_ed25519\_keypair
- **Type**: `uchar const[64]`
- **Description**: Contains a 64-byte Ed25519 key pair used in the QUIC sandbox. The first 32 bytes represent the private key, and the last 32 bytes represent the public key.
- **Use**: Used to store the Ed25519 key pair for cryptographic operations in the QUIC sandbox.


---
### fd\_quic\_sandbox\_peer\_ed25519\_keypair
- **Type**: ``uchar const[64]``
- **Description**: Contains a 64-byte Ed25519 key pair used for cryptographic operations. The first 32 bytes represent the private key, and the last 32 bytes represent the public key.
- **Use**: Used to store the peer's Ed25519 key pair for secure communication in the QUIC sandbox environment.


---
### fd\_quic\_sandbox\_aes128\_key
- **Type**: ``uchar const[16]``
- **Description**: An array of 16 constant unsigned characters that represents an AES-128 encryption key. Each element in the array is initialized to the hexadecimal value `0x43`. This key is used for encryption or decryption operations within the QUIC sandbox environment.
- **Use**: Used as an AES-128 encryption key in the QUIC sandbox for cryptographic operations.


---
### fd\_quic\_sandbox\_aes128\_iv
- **Type**: ``uchar const[12]``
- **Description**: An array of 12 unsigned characters that represents the initialization vector (IV) for AES-128 encryption in the QUIC sandbox environment. The IV is initialized to all zeros.
- **Use**: Used as the initialization vector for AES-128 encryption operations in the QUIC sandbox.


# Functions

---
### fd\_quic\_sandbox\_capture\_pkt<!-- {{#callable:fd_quic_sandbox_capture_pkt}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_sandbox.c#L8>)

Captures an outgoing packet in the QUIC sandbox by copying its data and updating metadata.
- **Inputs**:
    - ``sandbox``: A pointer to the `fd_quic_sandbox_t` structure, which contains the state and configuration for the QUIC sandbox.
    - ``pkt``: A pointer to a constant `fd_aio_pkt_info_t` structure, which contains information about the packet to capture, including its buffer and size.
- **Logic and Control Flow**:
    - Retrieve the current packet sequence number, metadata cache, data cache, MTU, and chunk information from the `sandbox` structure.
    - Calculate the initial chunk and watermark for the data cache using `fd_dcache_compact_chunk0` and `fd_dcache_compact_wmark` functions.
    - Determine the depth of the metadata cache using `fd_mcache_depth`.
    - Get the size of the packet buffer from `pkt` and convert the current chunk to a local address using `fd_chunk_to_laddr`.
    - Set control metadata using `fd_frag_meta_ctl` with specific flags for start-of-message, end-of-message, and no error.
    - Copy the packet buffer data to the local address using `fd_memcpy`.
    - Compute the timestamp component using `fd_frag_meta_ts_comp` and publish the metadata using `fd_mcache_publish`.
    - Increment the packet sequence number using `fd_seq_inc` and update the next chunk using `fd_dcache_compact_next`.
- **Output**: No return value; the function updates the `sandbox` structure to reflect the captured packet.


---
### fd\_quic\_sandbox\_aio\_send<!-- {{#callable:fd_quic_sandbox_aio_send}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_sandbox.c#L37>)

Captures a batch of outgoing packets into the sandbox capture ring and updates the batch index.
- **Inputs**:
    - ``ctx``: A pointer to the context, which is cast to `fd_quic_sandbox_t *`.
    - ``batch``: A pointer to an array of `fd_aio_pkt_info_t` structures representing the batch of packets to send.
    - ``batch_cnt``: The number of packets in the batch.
    - ``opt_batch_idx``: An optional pointer to a `ulong` where the function stores the batch count.
    - ``flush``: An integer flag indicating whether to flush, but it is not used in this function.
- **Logic and Control Flow**:
    - Cast `ctx` to `fd_quic_sandbox_t *` and store it in `sandbox`.
    - Iterate over each packet in the batch using a loop from `0` to `batch_cnt - 1`.
    - For each packet, call [`fd_quic_sandbox_capture_pkt`](<#fd_quic_sandbox_capture_pkt>) to capture the packet into the sandbox.
    - Check if `opt_batch_idx` is `NULL`; if so, use a local `_batch_idx` array to store the batch count.
    - Set the value pointed to by `opt_batch_idx` to `batch_cnt`.
    - Ignore the `flush` parameter as it is not used.
    - Return `FD_AIO_SUCCESS` to indicate successful execution.
- **Output**: Returns `FD_AIO_SUCCESS` to indicate successful processing of the batch.
- **Functions Called**:
    - [`fd_quic_sandbox_capture_pkt`](<#fd_quic_sandbox_capture_pkt>)


---
### fd\_quic\_sandbox\_next\_packet<!-- {{#callable:fd_quic_sandbox_next_packet}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_sandbox.c#L58>)

Retrieves the next packet from the sandbox's packet metadata cache, updating the read sequence number and handling potential overruns.
- **Inputs**:
    - `sandbox`: A pointer to an `fd_quic_sandbox_t` structure, which contains the packet metadata cache and the current read sequence number.
- **Logic and Control Flow**:
    - Retrieve the packet metadata cache (`mcache`) from the `sandbox` structure.
    - Calculate the depth of the metadata cache using `fd_mcache_depth`.
    - Get the current read sequence number (`seq`) from the `sandbox` structure.
    - Calculate the line index (`mline`) in the metadata cache using `fd_mcache_line_idx` with the current sequence number and depth.
    - Retrieve the fragment metadata (`frag`) from the cache at the calculated line index.
    - Check if the sequence number of the fragment is less than the current sequence number (`seq`). If true, return `NULL`.
    - Check if the sequence number of the fragment is greater than the current sequence number (`seq`). If true, log a warning about an overrun and update the sequence number to the fragment's sequence number.
    - Increment the read sequence number in the `sandbox` structure by 1.
    - Return the fragment metadata.
- **Output**: A pointer to an `fd_frag_meta_t` structure representing the next packet's metadata, or `NULL` if no valid packet is available.


---
### fd\_quic\_sandbox\_align<!-- {{#callable:fd_quic_sandbox_align}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_sandbox.c#L113>)

Calculates the maximum alignment requirement among several components related to the QUIC sandbox.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `fd_ulong_max` to determine the maximum alignment requirement among `alignof(fd_quic_sandbox_t)`, `fd_quic_align()`, `fd_mcache_align()`, `fd_dcache_align()`, and `FD_CHUNK_ALIGN`.
- **Output**: Returns an `ulong` representing the maximum alignment requirement.


---
### fd\_quic\_sandbox\_footprint<!-- {{#callable:fd_quic_sandbox_footprint}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_sandbox.c#L123>)

Calculates the memory footprint required for a QUIC sandbox based on given limits, packet count, and MTU.
- **Inputs**:
    - ``quic_limits``: A pointer to `fd_quic_limits_t` structure that defines the limits for the QUIC configuration.
    - ``pkt_cnt``: An unsigned long integer representing the number of packets.
    - ``mtu``: An unsigned long integer representing the maximum transmission unit size.
- **Logic and Control Flow**:
    - Calculate `root_align` by calling `fd_quic_sandbox_align()` to get the alignment requirement for the sandbox.
    - Calculate `quic_fp` by calling `fd_quic_footprint()` with `quic_limits` to get the footprint of the QUIC configuration.
    - Calculate `mcache_fp` by calling `fd_mcache_footprint()` with `pkt_cnt` and 0UL to get the footprint of the memory cache.
    - Calculate `dcache_fp` by calling `fd_dcache_footprint()` with the required data size for the data cache, obtained by calling `fd_dcache_req_data_sz()` with `mtu`, `pkt_cnt`, 1UL, and 1.
    - Check if any of `quic_fp`, `mcache_fp`, or `dcache_fp` is zero using `FD_UNLIKELY`; if so, return 0UL as the footprint cannot be calculated.
    - Initialize `l` with `FD_LAYOUT_INIT` and append the calculated footprints and alignments using `FD_LAYOUT_APPEND`.
    - Finalize the layout with `FD_LAYOUT_FINI` and return the calculated footprint.
- **Output**: Returns an unsigned long integer representing the total memory footprint required for the QUIC sandbox.
- **Functions Called**:
    - [`fd_quic_sandbox_align`](<#fd_quic_sandbox_align>)


---
### fd\_quic\_sandbox\_new<!-- {{#callable:fd_quic_sandbox_new}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_sandbox.c#L145>)

Creates and initializes a new `fd_quic_sandbox_t` structure using the provided memory and configuration parameters.
- **Inputs**:
    - `mem`: A pointer to the memory where the sandbox will be allocated.
    - `quic_limits`: A pointer to a `fd_quic_limits_t` structure that defines the limits for the QUIC configuration.
    - `pkt_cnt`: The number of packets that the sandbox can handle.
    - `mtu`: The maximum transmission unit size for the packets.
- **Logic and Control Flow**:
    - Check if `mem` is NULL and log a warning if true, then return NULL.
    - Check if `mem` is aligned according to `fd_quic_sandbox_align()` and log a warning if not, then return NULL.
    - Calculate the footprint required for the sandbox using `fd_quic_sandbox_footprint()` and log a warning if it is zero, then return NULL.
    - Initialize scratch memory allocation with `FD_SCRATCH_ALLOC_INIT` using `mem`.
    - Allocate memory for the sandbox structure, QUIC, mcache, and dcache using `FD_SCRATCH_ALLOC_APPEND`.
    - Finalize the scratch memory allocation with `FD_SCRATCH_ALLOC_FINI`.
    - Initialize the sandbox structure with the newly allocated memory and join the QUIC, mcache, and dcache components.
    - Set the initial packet sequence number to zero.
    - Attempt to join the QUIC log and log a critical error if it fails.
    - Set the sandbox magic number to `FD_QUIC_SANDBOX_MAGIC` with memory fences before and after.
    - Return the initialized sandbox.
- **Output**: A pointer to the newly created `fd_quic_sandbox_t` structure, or NULL if an error occurs.
- **Functions Called**:
    - [`fd_quic_sandbox_align`](<#fd_quic_sandbox_align>)
    - [`fd_quic_sandbox_footprint`](<#fd_quic_sandbox_footprint>)


---
### fd\_quic\_sandbox\_init<!-- {{#callable:fd_quic_sandbox_init}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_sandbox.c#L201>)

Initializes a QUIC sandbox with specified role and configuration settings.
- **Inputs**:
    - ``sandbox``: A pointer to an `fd_quic_sandbox_t` structure that represents the QUIC sandbox to initialize.
    - ``role``: An integer representing the role of the QUIC configuration, typically client or server.
- **Logic and Control Flow**:
    - Retrieve the `quic` and `quic_cfg` pointers from the `sandbox` structure.
    - Set the `role` and other configuration parameters in `quic_cfg`, including `idle_timeout` and `initial_rx_max_stream_data`.
    - Copy the public key from `fd_quic_sandbox_self_ed25519_keypair` to `quic_cfg->identity_public_key`.
    - Clear the `metrics` structure in `quic` using `memset`.
    - Create an `fd_aio_t` structure for asynchronous I/O transmission and set its `send_func` to `fd_quic_sandbox_aio_send`.
    - Call `fd_quic_set_aio_net_tx` to set the asynchronous I/O network transmission for `quic`.
    - Check if `fd_quic_init` returns false, log a warning, and return `NULL` if initialization fails.
    - Verify that the connection state counts in `quic->metrics` are initialized correctly using `FD_TEST`.
    - Retrieve the `state` from `quic` and set `state->now` and `sandbox->wallclock` to 1.
    - Initialize packet sequence numbers and mark the first entry in `pkt_mcache` as unpublished.
    - Calculate the initial packet chunk using `fd_dcache_compact_chunk0`.
    - Advance the log sequence number in `state->log_tx` by 4093.
    - Return the initialized `sandbox` pointer.
- **Output**: Returns a pointer to the initialized `fd_quic_sandbox_t` structure, or `NULL` if initialization fails.


---
### fd\_quic\_sandbox\_delete<!-- {{#callable:fd_quic_sandbox_delete}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_sandbox.c#L250>)

Deletes a `fd_quic_sandbox_t` object after verifying its validity and cleaning up associated resources.
- **Inputs**:
    - ``mem``: A pointer to a `fd_quic_sandbox_t` object to be deleted.
- **Logic and Control Flow**:
    - Check if `mem` is NULL; if so, log a warning and return NULL.
    - Cast `mem` to a `fd_quic_sandbox_t` pointer named `sandbox`.
    - Verify if `sandbox->magic` matches `FD_QUIC_SANDBOX_MAGIC`; if not, log a warning and return NULL.
    - Use `FD_COMPILER_MFENCE()` to ensure memory operations are completed before setting `sandbox->magic` to 0.
    - Call `fd_quic_leave` on `sandbox->quic` and pass the result to `fd_quic_delete` to clean up QUIC resources.
    - Call `fd_mcache_leave` on `sandbox->pkt_mcache` and pass the result to `fd_mcache_delete` to clean up memory cache resources.
    - Call `fd_dcache_leave` on `sandbox->pkt_dcache` and pass the result to `fd_dcache_delete` to clean up data cache resources.
    - Return the original `mem` pointer.
- **Output**: Returns the original `mem` pointer if successful, or NULL if an error occurs.


---
### fd\_quic\_sandbox\_new\_conn\_established<!-- {{#callable:fd_quic_sandbox_new_conn_established}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_sandbox.c#L275>)

Establishes a new QUIC connection in a sandbox environment with mock handshake completion and flow control reset.
- **Inputs**:
    - `sandbox`: A pointer to an `fd_quic_sandbox_t` structure representing the sandbox environment.
    - `rng`: A pointer to an `fd_rng_t` structure used to generate random connection IDs.
- **Logic and Control Flow**:
    - Retrieve the `fd_quic_t` instance from the `sandbox`.
    - Generate a random 8-byte connection ID for both local and peer using `fd_rng_ulong`.
    - Create a new peer connection ID using `fd_quic_conn_id_new` with the generated peer connection ID.
    - Call `fd_quic_conn_create` to establish a new connection with the generated IDs and predefined IP and port addresses.
    - Check if the connection creation failed and log a warning if it did, returning `NULL`.
    - Set the connection state to `FD_QUIC_CONN_STATE_ACTIVE` and mark it as established.
    - Mock the handshake completion by setting `handshake_complete` to 1 and configuring encryption levels and keys.
    - Set the connection's idle timeout and last activity timestamp using the sandbox's wallclock.
    - Reset flow control limits for transmission and reception data.
    - Retrieve the QUIC state and schedule service timers for the connection.
    - Return the newly established connection.
- **Output**: Returns a pointer to the newly established `fd_quic_conn_t` connection, or `NULL` if the connection creation failed.


---
### fd\_quic\_sandbox\_send\_frame<!-- {{#callable:fd_quic_sandbox_send_frame}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_sandbox.c#L330>)

Sends a QUIC frame by bypassing packet processing checks and handling the frame directly.
- **Inputs**:
    - ``sandbox``: A pointer to the `fd_quic_sandbox_t` structure, representing the QUIC sandbox environment.
    - ``conn``: A pointer to the `fd_quic_conn_t` structure, representing the QUIC connection.
    - ``pkt_meta``: A pointer to the `fd_quic_pkt_t` structure, containing metadata about the packet.
    - ``frame_ptr``: A pointer to the frame data to be sent.
    - ``frame_sz``: The size of the frame data in bytes.
- **Logic and Control Flow**:
    - Retrieve the `fd_quic_t` instance from the `sandbox` structure.
    - Set the packet type to `FD_QUIC_PKT_TYPE_ONE_RTT` to allow all frame types.
    - Call `fd_quic_handle_v1_frame` with the provided parameters to handle the frame.
    - Check if the return code `rc` from `fd_quic_handle_v1_frame` indicates a parse failure and return if true.
    - Log a critical error if `rc` is zero or greater than `frame_sz`.
- **Output**: No explicit output is returned; the function sends a frame and logs errors if necessary.


---
### fd\_quic\_sandbox\_send\_lone\_frame<!-- {{#callable:fd_quic_sandbox_send_lone_frame}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_sandbox.c#L354>)

Sends a single QUIC frame as a packet in a sandbox environment, updating connection and logging states.
- **Inputs**:
    - `sandbox`: A pointer to the `fd_quic_sandbox_t` structure representing the sandbox environment.
    - `conn`: A pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
    - `frame`: A pointer to the `uchar` array containing the frame data to send.
    - `frame_sz`: The size of the frame data in bytes.
- **Logic and Control Flow**:
    - Check if `frame_sz` is less than or equal to `sandbox->pkt_mtu` using `FD_TEST` macro.
    - Increment the expected packet number for the connection and store it in `pkt_num`.
    - Set `quic_pkt_sz` to `frame_sz` to represent the QUIC packet size.
    - Initialize `fd_quic_pkt_t` structure `pkt_meta` with IP and UDP header information, packet number, receive time, and encryption level.
    - Call [`fd_quic_sandbox_send_frame`](<#fd_quic_sandbox_send_frame>) to send the frame using the initialized packet metadata.
    - Call `fd_quic_lazy_ack_pkt` to acknowledge the packet lazily.
    - Update the log sequence number from transmission to reception using `fd_quic_log_tx_seq_update`.
- **Output**: No return value; the function operates by side effects on the sandbox and connection states.
- **Functions Called**:
    - [`fd_quic_sandbox_send_frame`](<#fd_quic_sandbox_send_frame>)


---
### fd\_quic\_sandbox\_send\_ping\_pkt<!-- {{#callable:fd_quic_sandbox_send_ping_pkt}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/fd_quic_sandbox.c#L392>)

Sends a QUIC PING packet from a sandbox environment using specified connection and packet number.
- **Inputs**:
    - ``sandbox``: A pointer to the `fd_quic_sandbox_t` structure representing the sandbox environment.
    - ``conn``: A pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
    - ``pktnum``: An unsigned long integer representing the packet number to use for the PING packet.
- **Logic and Control Flow**:
    - Initialize a buffer `pkt_buf` of 256 bytes to construct the packet.
    - Set the first byte of `pkt_buf` using `fd_quic_one_rtt_h0` with parameters for spin, key phase, and packet number length.
    - Copy the connection ID from `conn` into `pkt_buf` starting at index 1.
    - Convert `pktnum` to network byte order and copy it into `pkt_buf` starting at index 9.
    - Set the byte at index 13 to `0x01` to indicate a PING frame.
    - Zero out the next 18 bytes in `pkt_buf` starting at index 14.
    - Retrieve encryption keys from `conn` for the application data encryption level.
    - Encrypt the packet using `fd_quic_crypto_encrypt`, updating `out_sz` with the encrypted size.
    - Create a `fd_quic_pkt_t` structure `pkt` with IP and UDP headers, setting fields like total length, fragment offset, TTL, protocol, source and destination ports, packet number, receive time, and encryption level.
    - Call `fd_quic_process_quic_packet_v1` to process the constructed and encrypted packet.
- **Output**: No return value; the function sends a PING packet within the sandbox environment.



---
Made with ❤️ by [Driver](https://www.driver.ai/)