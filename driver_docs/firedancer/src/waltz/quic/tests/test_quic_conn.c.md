<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests repeated opening and closing of QUIC connections with data transmission and handshake verification.

# Purpose
The code is a C program designed to test the functionality of QUIC (Quick UDP Internet Connections) by repeatedly opening and closing connections. It includes the main function, which initializes the environment and sets up both server and client QUIC instances. The program uses a virtual pair to simulate the communication between the server and client. It defines several callback functions to handle events such as stream reception, connection finalization, and handshake completion. The [`my_stream_rx_cb`](<#my_stream_rx_cb>) function checks the integrity of the received data, ensuring it matches expected values, and logs the results.

The program configures the QUIC instances with specific limits and initializes them. It then enters a loop where it simulates the passage of time and services the QUIC instances to process events. The loop manages the state of the client connection, sending data when a connection is established and closing it after a certain number of messages. The program logs various events and conditions throughout its execution, providing detailed feedback on the test's progress. After completing the test, it cleans up resources and exits. This code is intended to be executed as a standalone test suite for QUIC connection handling.
# Imports and Dependencies

---
- `../fd_quic.h`
- `fd_quic_test_helpers.h`


# Global Variables

---
### state
- **Type**: `int`
- **Description**: Represents the current state of the QUIC connection process in the test program.
- **Use**: Used to control the flow of the connection process, switching between different states such as starting a new connection or waiting for a connection to close.


---
### server\_complete
- **Type**: `int`
- **Description**: Indicates whether the server handshake process is complete in the QUIC connection test.
- **Use**: Used to track the completion status of the server handshake in the QUIC connection process.


---
### client\_complete
- **Type**: `int`
- **Description**: Indicates whether the client handshake process is complete.
- **Use**: Used to track the completion status of the client handshake in the QUIC connection process.


---
### server\_conn
- **Type**: ``fd_quic_conn_t *``
- **Description**: A pointer to a `fd_quic_conn_t` structure, which represents a QUIC server connection. It is initialized to `NULL` and is used to store the server connection received in a callback.
- **Use**: Used to manage and track the state of the server-side QUIC connection during the test.


---
### client\_conn
- **Type**: `fd_quic_conn_t *`
- **Description**: A pointer to a `fd_quic_conn_t` structure, which represents a client-side QUIC connection.
- **Use**: Used to manage and track the state of the client-side QUIC connection during the test.


---
### pkt\_full
- **Type**: `uchar[]`
- **Description**: `pkt_full` is an external array of unsigned characters (`uchar`) that is declared but not defined in the provided code. The size of this array is determined by the external variable `pkt_full_sz`. This array is likely used to store packet data for processing in the QUIC connection tests.
- **Use**: Used to store packet data for QUIC connection tests.


---
### pkt\_full\_sz
- **Type**: `ulong`
- **Description**: `pkt_full_sz` is an external global variable of type `ulong` that represents the size of the packet data stored in the `pkt_full` array.
- **Use**: Used to determine the size of the packet data for operations involving the `pkt_full` array.


---
### fail
- **Type**: `uchar`
- **Description**: A global variable of type `uchar` initialized to 0.
- **Use**: Indicates if a failure condition has occurred during the execution of the program.


---
### \_recv
- **Type**: `ulong`
- **Description**: The `_recv` variable is a static unsigned long integer initialized to zero.
- **Use**: Tracks the number of successful data receptions in the `my_stream_rx_cb` callback function.


---
### now
- **Type**: `long`
- **Description**: Represents a global clock variable initialized to a large value, specifically 1e18, to simulate the passage of time in the program.
- **Use**: Used to incrementally advance time in the QUIC connection handling loop.


# Data Structures

---
### my\_context
- **Type**: ``struct``
- **Members**:
    - `server`: An integer that likely represents a server identifier or status.
- **Description**: Defines a context structure named `my_context` that contains a single integer member `server`. This structure is used to encapsulate server-related information, potentially for managing server state or configuration in the context of QUIC connections.


---
### my\_context\_t
- **Type**: ``struct``
- **Members**:
    - `server`: An integer field that likely indicates the server state or identifier.
- **Description**: `my_context_t` is a structure that contains a single integer member named `server`. This structure is used in the context of managing QUIC connections, possibly to store state or configuration related to the server side of a connection.


# Functions

---
### my\_stream\_rx\_cb<!-- {{#callable:my_stream_rx_cb}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_conn.c#L20>)

Processes received data from a QUIC stream, checks its size and content, and logs the results.
- **Inputs**:
    - `conn`: A pointer to the QUIC connection object.
    - `stream_id`: The identifier of the stream from which data is received.
    - `offset`: The offset in the stream where the data starts.
    - `data`: A pointer to the received data buffer.
    - `data_sz`: The size of the received data.
    - `fin`: An integer indicating if this is the final part of the data stream.
- **Logic and Control Flow**:
    - Logs the size and offset of the received data.
    - Logs a hexdump of the received data for debugging purposes.
    - Checks if the size of the received data is 512 bytes; if not, logs a warning and sets the `fail` flag.
    - Compares the first 11 bytes of the received data to the string "Hello world"; if they do not match, logs a warning and sets the `fail` flag.
    - Logs a debug message indicating successful reception if the data size and content are correct.
    - Increments the `_recv` counter to track the number of successful receptions.
    - Returns `FD_QUIC_SUCCESS` to indicate the callback was processed successfully.
- **Output**: Returns `FD_QUIC_SUCCESS` to indicate successful processing of the callback.


---
### my\_cb\_conn\_final<!-- {{#callable:my_cb_conn_final}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_conn.c#L60>)

Handles the finalization of a QUIC connection by logging the result and clearing the connection context.
- **Inputs**:
    - ``conn``: A pointer to the `fd_quic_conn_t` structure representing the QUIC connection to finalize.
    - ``context``: A pointer to a context object, which is not used in this function.
- **Logic and Control Flow**:
    - Cast the `context` parameter to void to indicate it is unused.
    - Retrieve the connection context from `conn->context` and store it in `ppconn`.
    - Check if `ppconn` is not NULL.
    - If `ppconn` is not NULL, log a success message with the pointer value of `*ppconn` and set `*ppconn` to NULL.
    - If `ppconn` is NULL, log a failure message.
- **Output**: No return value; the function performs logging and modifies the connection context.


---
### my\_connection\_new<!-- {{#callable:my_connection_new}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_conn.c#L74>)

Handles the completion of a server-side QUIC connection handshake and sets the connection context.
- **Inputs**:
    - ``conn``: A pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
    - ``vp_context``: A void pointer to additional context, which is not used in this function.
- **Logic and Control Flow**:
    - Logs the message 'server handshake complete' to indicate the handshake completion.
    - Sets the global variable `server_complete` to 1 to mark the server handshake as complete.
    - Assigns the `conn` pointer to the global variable `server_conn` to store the server connection.
    - Calls `fd_quic_conn_set_context` to set the context of the connection to the address of `server_conn`.
- **Output**: No return value; the function operates through side effects on global variables and the connection context.


---
### my\_handshake\_complete<!-- {{#callable:my_handshake_complete}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_conn.c#L87>)

Marks the client handshake as complete and sets the connection context.
- **Inputs**:
    - `conn`: A pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
    - `vp_context`: A void pointer to additional context, which is not used in this function.
- **Logic and Control Flow**:
    - Logs the message 'client handshake complete' to indicate the handshake completion.
    - Sets the global variable `client_complete` to 1 to mark the handshake as complete.
    - Calls `fd_quic_conn_set_context` to set the connection context to `client_conn`.
- **Output**: No return value; the function operates through side effects on global variables and the connection context.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../../src/waltz/quic/tests/test_quic_conn.c#L102>)

Initializes and manages QUIC connections for testing by repeatedly opening and closing them, while logging the process and handling data transmission.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Initialize the environment and QUIC test setup with `fd_boot` and [`fd_quic_test_boot`](<fd_quic_test_helpers.c.md#fd_quic_test_boot>).
    - Create a random number generator `rng` using `fd_rng_new` and `fd_rng_join`.
    - Determine the CPU index and adjust if it exceeds the shared memory CPU count.
    - Parse command-line arguments for page size, page count, and NUMA index using `fd_env_strip_cmdline_cstr` and `fd_env_strip_cmdline_ulong`.
    - Convert the page size string to an actual size with `fd_cstr_to_shmem_page_sz` and log an error if unsupported.
    - Create a workspace with `fd_wksp_new_anonymous` and verify its creation with `FD_TEST`.
    - Define QUIC limits and calculate the QUIC footprint using `fd_quic_footprint`, logging the result.
    - Create server and client QUIC instances with [`fd_quic_new_anonymous`](<fd_quic_test_helpers.c.md#fd_quic_new_anonymous>) and set up callbacks for connection and stream events.
    - Initialize a virtual pair for the QUIC instances with [`fd_quic_virtual_pair_init`](<fd_quic_test_helpers.c.md#fd_quic_virtual_pair_init>).
    - Enter a loop to manage QUIC connections, sending data and handling connection states.
    - In the loop, update the global clock, service the QUIC instances, and manage connection states using a switch-case structure.
    - Log the completion of data sending and close any remaining connections.
    - Clean up resources by finalizing and deleting QUIC instances, the workspace, and the random number generator.
    - Log the completion of the test and halt the program with [`fd_quic_test_halt`](<fd_quic_test_helpers.c.md#fd_quic_test_halt>) and `fd_halt`.
- **Output**: Returns 0 upon successful completion.
- **Functions Called**:
    - [`fd_quic_test_boot`](<fd_quic_test_helpers.c.md#fd_quic_test_boot>)
    - [`fd_quic_new_anonymous`](<fd_quic_test_helpers.c.md#fd_quic_new_anonymous>)
    - [`fd_quic_virtual_pair_init`](<fd_quic_test_helpers.c.md#fd_quic_virtual_pair_init>)
    - [`fd_quic_virtual_pair_fini`](<fd_quic_test_helpers.c.md#fd_quic_virtual_pair_fini>)
    - [`fd_quic_test_halt`](<fd_quic_test_helpers.c.md#fd_quic_test_halt>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)