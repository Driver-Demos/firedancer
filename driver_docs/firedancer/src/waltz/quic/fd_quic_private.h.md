<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Header file for internal QUIC protocol implementation, including state management, connection handling, and callbacks.

# Purpose
The code is a C header file that defines private structures, macros, and functions for managing QUIC (Quick UDP Internet Connections) protocol operations. It is part of a larger QUIC implementation and is intended for internal use within the QUIC library. The file includes various headers that provide necessary data structures and functions related to QUIC transport parameters, connection mapping, stream management, logging, packet metadata, and TLS (Transport Layer Security) operations. It defines several macros for configuration and state management, such as `FD_QUIC_DISABLE_CRYPTO` for disabling encryption during testing and `FD_QUIC_MAGIC` for identifying the layout of shared memory regions.

The file defines the `fd_quic_state_private` structure, which holds the internal state of a QUIC connection, including transport parameters, connection maps, TLS handshake pools, and stream pools. It also includes functions for managing connections, such as [`fd_quic_conn_create`](<#fd_quic_conn_create>) and [`fd_quic_conn_free`](<#fd_quic_conn_free>), and callback functions for handling network events and TLS operations. The file provides inline functions for accessing and manipulating connection states and packet metadata, as well as functions for processing QUIC packets and frames. The header is designed to be included in other source files within the QUIC library to facilitate the implementation of QUIC protocol features and operations.
# Imports and Dependencies

---
- `fd_quic.h`
- `templ/fd_quic_transport_params.h`
- `fd_quic_conn_map.h`
- `fd_quic_stream.h`
- `log/fd_quic_log_tx.h`
- `fd_quic_pkt_meta.h`
- `tls/fd_quic_tls.h`
- `fd_quic_stream_pool.h`
- `fd_quic_pretty_print.h`
- `fd_quic_svc_q.h`
- `math.h`
- `../../util/log/fd_dtrace.h`
- `../../util/net/fd_ip4.h`
- `../../util/net/fd_udp.h`
- `../../util/tmpl/fd_pool.c`
- `../../util/tmpl/fd_dlist.c`


# Data Structures

---
### fd\_quic\_state\_private
- **Type**: ``struct``
- **Members**:
    - ``flags``: Stores various flags related to the QUIC state.
    - ``now``: Holds the recent timestamp in nanoseconds.
    - ``transport_params``: Contains QUIC-TLS transport parameters with mutable and immutable fields.
    - ``max_inflight_frame_cnt_conn``: Specifies the maximum number of inflight frames per connection.
    - ``log_tx``: Array for logging transmission data.
    - ``free_conn_list``: Free list of unused connections.
    - ``conn_map``: Maps connection IDs to connections.
    - ``tls``: Holds TLS-related data for QUIC.
    - ``hs_pool``: Pointer to the handshake pool.
    - ``hs_cache``: Cache for handshake data using a doubly linked list.
    - ``stream_pool``: Pointer to the stream pool, which can be null.
    - ``pkt_meta_pool``: Pointer to the packet metadata pool.
    - ``_rng``: Random number generator instance.
    - ``conn_base``: Base address of the array of all connections.
    - ``conn_sz``: Size of one connection element.
    - ``initial_max_data``: Initial maximum data limit from transport parameters.
    - ``initial_max_stream_data``: Array of initial maximum stream data limits indexed by stream type.
    - ``ip_table_upd``: Timestamp of the last ARP/routing tables update.
    - ``retry_secret``: Secret used for generating RETRY tokens.
    - ``retry_iv``: Initialization vector for RETRY tokens.
    - ``crypt_scratch``: Scratch space for packet protection.
    - ``svc_timers``: Pointer to service timers for managing time-related events.
- **Description**: The `fd_quic_state_private` struct is a comprehensive data structure that encapsulates the internal state of a QUIC connection. It includes various fields for managing connection parameters, transport settings, and cryptographic elements. The struct maintains state information such as flags, timestamps, and transport parameters, and it provides mechanisms for handling connections, streams, and packet metadata. It also includes fields for managing flow control, retry tokens, and service timers, making it integral to the operation and management of QUIC connections.


---
### fd\_quic\_pkt
- **Type**: ``struct``
- **Members**:
    - ``ip4``: An array of one `fd_ip4_hdr_t` structure representing the IPv4 header.
    - ``udp``: An array of one `fd_udp_hdr_t` structure representing the UDP header.
    - ``pkt_number``: The QUIC packet number currently being decoded or parsed.
    - ``rcv_time``: The time when the packet was received.
    - ``enc_level``: The encryption level of the packet.
    - ``datagram_sz``: The length of the original datagram.
    - ``ack_flag``: A flag indicating acknowledgment status: 0 for don't ack, 1 for ack, 2 for cancel ack.
    - ``rtt_pkt_number``: The packet number used for round-trip time (RTT) measurement.
    - ``rtt_ack_time``: The time when the acknowledgment for RTT was received.
    - ``rtt_ack_delay``: The delay in acknowledgment for RTT.
- **Description**: The `fd_quic_pkt` structure represents a QUIC packet within a UDP datagram, containing headers for both IPv4 and UDP, and various fields for managing the current state of packet processing. It includes fields for tracking packet numbers, receive time, encryption level, datagram size, acknowledgment flags, and round-trip time metrics. This structure is used to handle the current QUIC packet being processed, with the possibility of multiple QUIC packets existing within a single UDP datagram.


---
### fd\_quic\_frame\_ctx
- **Type**: ``struct``
- **Members**:
    - ``quic``: Pointer to an `fd_quic_t` structure, representing the QUIC instance.
    - ``conn``: Pointer to an `fd_quic_conn_t` structure, representing the QUIC connection.
    - ``pkt``: Pointer to an `fd_quic_pkt_t` structure, representing the QUIC packet.
- **Description**: The `fd_quic_frame_ctx` structure holds context information for processing QUIC frames, including pointers to the QUIC instance, connection, and packet involved in the frame processing.


---
### fd\_quic\_frame\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``quic``: Pointer to an `fd_quic_t` structure, representing the QUIC instance.
    - ``conn``: Pointer to an `fd_quic_conn_t` structure, representing the QUIC connection.
    - ``pkt``: Pointer to an `fd_quic_pkt_t` structure, representing the QUIC packet.
- **Description**: The `fd_quic_frame_ctx` structure provides a context for handling QUIC frames, associating a specific QUIC instance, connection, and packet. It is used to manage and process QUIC frames within the context of a particular connection and packet, facilitating operations such as frame parsing and handling.


# Functions

---
### fd\_quic\_get\_state<!-- {{#callable:fd_quic_get_state}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L142>)

Returns a pointer to the private state area of a `fd_quic_t` structure.
- **Inputs**:
    - `quic`: A pointer to a `fd_quic_t` structure from which the state is to be retrieved.
- **Logic and Control Flow**:
    - Calculate the address of the `fd_quic_state_t` by adding the offset `FD_QUIC_STATE_OFF` to the address of the `quic` pointer.
    - Cast the calculated address to a `fd_quic_state_t` pointer.
    - Return the casted pointer.
- **Output**: A pointer to the `fd_quic_state_t` structure, which represents the internal state of the given `fd_quic_t`.


---
### fd\_quic\_get\_state\_const<!-- {{#callable:fd_quic_get_state_const}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L147>)

Returns a constant pointer to the internal state of a `fd_quic_t` object.
- **Inputs**:
    - `quic`: A constant pointer to a `fd_quic_t` object.
- **Logic and Control Flow**:
    - Calculates the address of the internal state by adding the offset `FD_QUIC_STATE_OFF` to the base address of the `quic` object.
    - Casts the calculated address to a constant pointer of type `fd_quic_state_t`.
    - Returns the casted pointer.
- **Output**: A constant pointer to the `fd_quic_state_t` structure, representing the internal state of the `fd_quic_t` object.


---
### fd\_quic\_conn\_query1<!-- {{#callable:fd_quic_conn_query1}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L152>)

Queries a connection map for a connection ID and returns a sentinel if the ID is zero.
- **Inputs**:
    - `map`: A pointer to the connection map to query.
    - `conn_id`: The connection ID to query in the map.
    - `sentinel`: A pointer to a sentinel value to return if the connection ID is zero.
- **Logic and Control Flow**:
    - Check if `conn_id` is zero.
    - If `conn_id` is zero, return `sentinel`.
    - If `conn_id` is not zero, call `fd_quic_conn_map_query` with `map`, `conn_id`, and `sentinel` and return its result.
- **Output**: A pointer to a `fd_quic_conn_map_t` structure, either the result of the query or the sentinel if the connection ID is zero.


---
### fd\_quic\_conn\_query<!-- {{#callable:fd_quic_conn_query}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L160>)

Queries a connection from a connection map using a connection ID and returns the connection if valid.
- **Inputs**:
    - `map`: A pointer to an `fd_quic_conn_map_t` structure representing the connection map.
    - `conn_id`: An unsigned long integer representing the connection ID to query.
- **Logic and Control Flow**:
    - Initialize a `sentinel` variable of type `fd_quic_conn_map_t` with zero values.
    - Check if `conn_id` is zero; if true, return `NULL`.
    - Call `fd_quic_conn_map_query` with `map`, `conn_id`, and `sentinel` to get the `entry`.
    - Check if `entry->conn` is not `NULL` and `entry->conn->state` is `FD_QUIC_CONN_STATE_INVALID`; if true, return `NULL`.
    - Return `entry->conn`.
- **Output**: Returns a pointer to an `fd_quic_conn_t` structure if the connection is valid, otherwise returns `NULL`.


---
### fd\_quic\_cb\_conn\_new<!-- {{#callable:fd_quic_cb_conn_new}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L255>)

Initializes a new QUIC connection callback if it has not been called yet.
- **Inputs**:
    - ``quic``: A pointer to an `fd_quic_t` structure representing the QUIC instance.
    - ``conn``: A pointer to an `fd_quic_conn_t` structure representing the connection to initialize.
- **Logic and Control Flow**:
    - Checks if the `called_conn_new` flag in the `conn` structure is set; if it is, the function returns immediately.
    - Sets the `called_conn_new` flag in the `conn` structure to 1 to indicate that the connection has been initialized.
    - Checks if the `conn_new` callback in the `quic` structure is not set; if it is not set, the function returns immediately.
    - Calls the `conn_new` callback function with `conn` and `quic->cb.quic_ctx` as arguments.
- **Output**: No output is returned as the function is of type `void`.


---
### fd\_quic\_cb\_conn\_hs\_complete<!-- {{#callable:fd_quic_cb_conn_hs_complete}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L265>)

Triggers the connection handshake complete callback if it is set.
- **Inputs**:
    - ``quic``: A pointer to an `fd_quic_t` structure representing the QUIC instance.
    - ``conn``: A pointer to an `fd_quic_conn_t` structure representing the connection for which the handshake is complete.
- **Logic and Control Flow**:
    - Check if the `conn_hs_complete` callback in the `quic` structure is set.
    - If the callback is set, call `conn_hs_complete` with `conn` and `quic->cb.quic_ctx` as arguments.
- **Output**: No return value; the function is `void`.


---
### fd\_quic\_cb\_conn\_final<!-- {{#callable:fd_quic_cb_conn_final}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L272>)

Executes the `conn_final` callback for a QUIC connection if certain conditions are met.
- **Inputs**:
    - ``quic``: A pointer to an `fd_quic_t` structure representing the QUIC instance.
    - ``conn``: A pointer to an `fd_quic_conn_t` structure representing the QUIC connection.
- **Logic and Control Flow**:
    - Check if the `conn_final` callback is set in the `quic` structure and if the `called_conn_new` flag is set in the `conn` structure.
    - If either condition is false, return immediately without executing the callback.
    - If both conditions are true, call the `conn_final` callback with `conn` and `quic->cb.quic_ctx` as arguments.
- **Output**: No return value; the function executes a callback if conditions are met.


---
### fd\_quic\_cb\_stream\_rx<!-- {{#callable:fd_quic_cb_stream_rx}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L279>)

Handles the reception of data on a QUIC stream, updating metrics and invoking a callback if defined.
- **Inputs**:
    - ``quic``: A pointer to an `fd_quic_t` structure representing the QUIC instance.
    - ``conn``: A pointer to an `fd_quic_conn_t` structure representing the connection associated with the stream.
    - ``stream_id``: An unsigned long integer representing the identifier of the stream.
    - ``offset``: An unsigned long integer representing the offset in the stream where the data starts.
    - ``data``: A pointer to an array of unsigned characters representing the data received on the stream.
    - ``data_sz``: An unsigned long integer representing the size of the data array.
    - ``fin``: An integer indicating if this is the final data for the stream (1 for final, 0 otherwise).
- **Logic and Control Flow**:
    - Increment the `stream_rx_event_cnt` metric in the `quic` structure.
    - Add `data_sz` to the `stream_rx_byte_cnt` metric in the `quic` structure.
    - Check if the `stream_rx` callback is defined in the `quic` structure.
    - If the `stream_rx` callback is not defined, return `FD_QUIC_SUCCESS`.
    - If the `stream_rx` callback is defined, call it with the provided parameters and return its result.
- **Output**: Returns an integer status code, either `FD_QUIC_SUCCESS` or the result of the `stream_rx` callback.


---
### fd\_quic\_cb\_stream\_notify<!-- {{#callable:fd_quic_cb_stream_notify}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L294>)

Updates stream metrics and triggers a callback for stream events if defined.
- **Inputs**:
    - ``quic``: A pointer to an `fd_quic_t` structure representing the QUIC instance.
    - ``stream``: A pointer to an `fd_quic_stream_t` structure representing the stream.
    - ``stream_ctx``: A pointer to a context associated with the stream, used in the callback.
    - ``event``: An integer representing the event type for the stream.
- **Logic and Control Flow**:
    - Increment the `stream_closed_cnt` metric for the given `event` in the `quic` structure.
    - Decrement the `stream_active_cnt` metric in the `quic` structure.
    - Check if the `stream_notify` callback is defined in the `quic` structure.
    - If the `stream_notify` callback is defined, call it with `stream`, `stream_ctx`, and `event` as arguments.
- **Output**: No return value; the function operates through side effects on the `quic` structure and potentially calls a callback.


---
### fd\_quic\_conn\_at\_idx<!-- {{#callable:fd_quic_conn_at_idx}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L385>)

Calculates the address of a QUIC connection at a given index in the connection array.
- **Inputs**:
    - `quic_state`: A pointer to an `fd_quic_state_t` structure that contains the base address and size of the connection array.
    - `idx`: An unsigned long integer representing the index of the connection in the connection array.
- **Logic and Control Flow**:
    - Retrieve the base address of the connection array from `quic_state->conn_base`.
    - Retrieve the size of each connection element from `quic_state->conn_sz`.
    - Calculate the address of the connection at the specified index by adding `idx * sz` to the base address.
    - Return the calculated address cast to a pointer of type `fd_quic_conn_t *`.
- **Output**: A pointer to the `fd_quic_conn_t` structure at the specified index in the connection array.


---
### fd\_quic\_sample\_rtt<!-- {{#callable:fd_quic_sample_rtt}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L394>)

Samples the round-trip time (RTT) for a QUIC connection, adjusting for acknowledgment delay.
- **Inputs**:
    - `conn`: A pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
    - `rtt_ns`: The measured round-trip time in nanoseconds.
    - `ack_delay`: The acknowledgment delay in nanoseconds.
- **Logic and Control Flow**:
    - Retrieve the RTT estimate from the connection structure for convenience.
    - Calculate the acknowledgment delay in nanoseconds by scaling it with the peer's acknowledgment delay scale factor.
    - Limit the acknowledgment delay to the peer's maximum acknowledgment delay.
    - Call `fd_rtt_sample` to update the RTT estimate with the measured RTT and the bounded acknowledgment delay.
    - If debugging is enabled, log the connection index, minimum RTT, smoothed RTT, RTT variance, measured RTT, acknowledgment delay, and the difference between the measured RTT and acknowledgment delay.
- **Output**: No return value; updates the RTT estimate within the connection structure.


---
### fd\_quic\_calc\_expiry<!-- {{#callable:fd_quic_calc_expiry}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L421>)

Calculates the expiry time for a QUIC packet based on the current time and round-trip time estimates.
- **Inputs**:
    - ``conn``: A pointer to an `fd_quic_conn_t` structure representing the QUIC connection, which contains round-trip time estimates and peer maximum acknowledgment delay.
    - ``now``: A long integer representing the current timestamp in nanoseconds.
- **Logic and Control Flow**:
    - Retrieve the round-trip time estimates from the `conn` structure.
    - Calculate the duration using the formula: `smoothed_rtt + 4 * var_rtt + peer_max_ack_delay_ns`.
    - Log the calculated duration using the `FD_DTRACE_PROBE_2` macro.
    - Return the sum of `now` and 500 milliseconds (500e6 nanoseconds) as the expiry time.
- **Output**: Returns a long integer representing the calculated expiry time in nanoseconds.


# Function Declarations (Public API)

---
### fd\_quic\_conn\_service<!-- {{#callable_declaration:fd_quic_conn_service}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L177>)

Performs periodic operations for a QUIC connection.
- **Description**: Use this function to perform necessary periodic operations on a QUIC connection, such as sending probes, handling packet metadata expiry, and managing connection states. It must be called regularly to ensure the connection remains active and responsive. The function checks the connection state and performs actions like sending data, handling handshake completion, and transitioning connection states. It also updates metrics related to connection closures and aborts. Ensure that the connection is valid and the QUIC instance is properly initialized before calling this function.
- **Inputs**:
    - `quic`: A pointer to an `fd_quic_t` structure representing the managing QUIC instance. Must not be null. The caller retains ownership.
    - `conn`: A pointer to an `fd_quic_conn_t` structure representing the connection to service. Must not be null. The caller retains ownership.
    - `now`: A `long` representing the current timestamp in nanoseconds. It is used to determine timing for operations like sending probes.
- **Output**: None
- **See Also**: [`fd_quic_conn_service`](<fd_quic.c.md#fd_quic_conn_service>)  (Implementation)


---
### fd\_quic\_conn\_create<!-- {{#callable_declaration:fd_quic_conn_create}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L185>)

Creates a new QUIC connection.
- **Description**: Use this function to establish a new QUIC connection with specified parameters. It requires a valid QUIC context and connection identifiers. The function initializes the connection state and prepares it for communication. Ensure that the `our_conn_id` is non-zero and that the `quic` context is properly initialized before calling. The function returns `NULL` if it fails to allocate a connection or if the connection identifiers are invalid.
- **Inputs**:
    - `quic`: A pointer to an `fd_quic_t` structure representing the QUIC context. Must not be null.
    - `our_conn_id`: An unsigned long representing the connection ID for the local endpoint. Must be non-zero.
    - `peer_conn_id`: A pointer to a `fd_quic_conn_id_t` structure representing the connection ID for the peer. Must not be null.
    - `peer_ip_addr`: An unsigned integer representing the IP address of the peer. Must be a valid IP address.
    - `peer_udp_port`: An unsigned short representing the UDP port of the peer. Must be a valid port number.
    - `self_ip_addr`: An unsigned integer representing the IP address of the local endpoint. Can be zero if outgoing.
    - `self_udp_port`: An unsigned short representing the UDP port of the local endpoint. Must be a valid port number.
    - `server`: An integer indicating if the connection is a server (non-zero) or client (zero).
- **Output**: Returns a pointer to an `fd_quic_conn_t` structure representing the new connection, or `NULL` if the creation fails.
- **See Also**: [`fd_quic_conn_create`](<fd_quic.c.md#fd_quic_conn_create>)  (Implementation)


---
### fd\_quic\_conn\_free<!-- {{#callable_declaration:fd_quic_conn_free}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L198>)

Frees resources related to a QUIC connection.
- **Description**: Use this function to release most resources associated with a QUIC connection and return it to the connection free list. This function should be called when a connection is no longer needed. It ensures that the connection is marked as invalid to prevent double freeing and handles the cleanup of associated streams and metadata. The function does not remove the connection from the connection ID map, allowing it to catch in-flight packets from the peer.
- **Inputs**:
    - `quic`: A pointer to an `fd_quic_t` structure representing the QUIC instance managing the connection. Must not be null.
    - `conn`: A pointer to an `fd_quic_conn_t` structure representing the connection to free. If null, the function logs a warning and returns without performing any action. If the connection state is invalid, indicating a double free, the function logs a critical error and returns.
- **Output**: None
- **See Also**: [`fd_quic_conn_free`](<fd_quic.c.md#fd_quic_conn_free>)  (Implementation)


---
### fd\_quic\_tx\_stream\_free<!-- {{#callable_declaration:fd_quic_tx_stream_free}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L202>)

Releases resources associated with a QUIC stream.
- **Description**: Use this function to release resources associated with a specific QUIC stream. It should be called when a stream is no longer needed, ensuring that the stream is marked as unused and removed from the connection's stream map. This function also notifies the stream's context of the closure event using the provided code. It is important to ensure that the stream is in use before calling this function, as it will not perform any operations if the stream is already marked as unused.
- **Inputs**:
    - `quic`: A pointer to an `fd_quic_t` structure representing the QUIC instance. Must not be null.
    - `conn`: A pointer to an `fd_quic_conn_t` structure representing the connection associated with the stream. Must not be null.
    - `stream`: A pointer to an `fd_quic_stream_t` structure representing the stream to be freed. Must not be null and must be in use.
    - `code`: An integer code used to notify the stream's context of the closure event. The specific meaning of the code is determined by the application.
- **Output**: None
- **See Also**: [`fd_quic_tx_stream_free`](<fd_quic.c.md#fd_quic_tx_stream_free>)  (Implementation)


---
### fd\_quic\_aio\_cb\_receive<!-- {{#callable_declaration:fd_quic_aio_cb_receive}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L211>)

Receives and processes a batch of QUIC packets.
- **Description**: Use this function to handle incoming QUIC packets in a batch. It processes each packet individually and assumes that any packet that cannot be processed is dropped. This function is typically called when packets are received from the network. It requires a valid context that represents the QUIC state. The function updates the optional batch index to indicate the number of packets processed if the pointer is provided.
- **Inputs**:
    - `context`: A pointer to the QUIC state (`fd_quic_t`). Must not be null.
    - `batch`: A pointer to an array of `fd_aio_pkt_info_t` structures representing the packets to process. Must not be null.
    - `batch_cnt`: The number of packets in the batch. Must be greater than zero.
    - `opt_batch_idx`: An optional pointer to a `ulong` where the function writes the number of packets processed. Can be null.
    - `flush`: An integer flag that is currently unused in this function.
- **Output**: Returns `FD_AIO_SUCCESS` to indicate successful processing of the batch.
- **See Also**: [`fd_quic_aio_cb_receive`](<fd_quic.c.md#fd_quic_aio_cb_receive>)  (Implementation)


---
### fd\_quic\_tls\_cb\_alert<!-- {{#callable_declaration:fd_quic_tls_cb_alert}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L230>)

Handles a TLS alert during a QUIC handshake.
- **Description**: Use this function to process a TLS alert received during a QUIC handshake. It logs the alert details for debugging purposes. This function does not modify the handshake state or connection directly, but it is expected to store the alert for future handling. Ensure that the `context` parameter is a valid pointer to a `fd_quic_conn_t` structure.
- **Inputs**:
    - `hs`: A pointer to a `fd_quic_tls_hs_t` structure representing the TLS handshake state. The function does not use this parameter, so it can be any valid pointer.
    - `context`: A pointer to a `fd_quic_conn_t` structure representing the QUIC connection context. Must not be null, as it is used to determine the connection type (server or client) for logging.
    - `alert`: An integer representing the TLS alert code. The function logs this alert code for debugging purposes.
- **Output**: None
- **See Also**: [`fd_quic_tls_cb_alert`](<fd_quic.c.md#fd_quic_tls_cb_alert>)  (Implementation)


---
### fd\_quic\_tls\_cb\_secret<!-- {{#callable_declaration:fd_quic_tls_cb_secret}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L235>)

Sets encryption secrets for a QUIC connection.
- **Description**: Use this function to set the encryption secrets for a QUIC connection during the TLS handshake process. It updates the connection's cryptographic secrets and generates the necessary keys for both local and peer communication. This function must be called with valid encryption level information, and it assumes that the connection context and secret data are correctly initialized. It also handles key logging if a key logging callback is provided.
- **Inputs**:
    - `hs`: A pointer to `fd_quic_tls_hs_t`, representing the TLS handshake state. Must not be null.
    - `context`: A pointer to a context object, expected to be a `fd_quic_conn_t` type. Must not be null.
    - `secret`: A pointer to a constant `fd_quic_tls_secret_t` structure containing the encryption secrets. Must not be null and must have a valid encryption level.
- **Output**: None
- **See Also**: [`fd_quic_tls_cb_secret`](<fd_quic.c.md#fd_quic_tls_cb_secret>)  (Implementation)


---
### fd\_quic\_tls\_cb\_handshake\_complete<!-- {{#callable_declaration:fd_quic_tls_cb_handshake_complete}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L240>)

Handles the completion of a QUIC handshake.
- **Description**: Use this function to handle the completion of a QUIC handshake. It updates the connection state to indicate that the handshake is complete. This function should be called when the handshake process is finished. It checks the current state of the connection and only proceeds if the connection is in the handshake state and transport parameters are set. If the connection is in an invalid state, it logs a warning and takes no further action.
- **Inputs**:
    - `hs`: A pointer to `fd_quic_tls_hs_t`, representing the handshake state. The function does not use this parameter, and it can be null.
    - `context`: A pointer to a `fd_quic_conn_t` object, representing the connection context. Must not be null. The function uses this to update the connection state.
- **Output**: None
- **See Also**: [`fd_quic_tls_cb_handshake_complete`](<fd_quic.c.md#fd_quic_tls_cb_handshake_complete>)  (Implementation)


---
### fd\_quic\_tls\_cb\_peer\_params<!-- {{#callable_declaration:fd_quic_tls_cb_peer_params}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L244>)

Processes peer transport parameters during a QUIC handshake.
- **Description**: Use this function to process and apply the transport parameters received from a peer during a QUIC handshake. It decodes the provided transport parameters and applies them to the connection context. This function must be called with valid encoded transport parameters and a valid connection context. If the decoding of transport parameters fails, it logs an error and terminates the connection with a transport parameter error.
- **Inputs**:
    - `context`: A pointer to the connection context (`fd_quic_conn_t`). Must not be null. The function uses this context to apply the decoded transport parameters.
    - `peer_tp_enc`: A pointer to the encoded transport parameters received from the peer. Must not be null. The function decodes these parameters.
    - `peer_tp_enc_sz`: The size of the encoded transport parameters. Must be a valid size that corresponds to the data pointed to by `peer_tp_enc`.
- **Output**: None
- **See Also**: [`fd_quic_tls_cb_peer_params`](<fd_quic.c.md#fd_quic_tls_cb_peer_params>)  (Implementation)


---
### fd\_quic\_apply\_peer\_params<!-- {{#callable_declaration:fd_quic_apply_peer_params}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L249>)

Applies peer transport parameters to a QUIC connection.
- **Description**: Use this function to configure a QUIC connection with the transport parameters received from a peer. This function updates the connection's flow control, maximum datagram size, stream limits, idle timeout, and acknowledgment delay settings based on the peer's parameters. It must be called after receiving the peer's transport parameters and before the connection is used for data transmission. If the connection is not a server, it verifies the retry source connection ID. If verification fails, the function reports a transport parameter error and returns early. The function also ensures that the maximum datagram size is within a predefined range.
- **Inputs**:
    - `conn`: A pointer to an `fd_quic_conn_t` structure representing the QUIC connection. Must not be null. The function updates this structure with the peer's transport parameters.
    - `peer_tp`: A pointer to a constant `fd_quic_transport_params_t` structure containing the peer's transport parameters. Must not be null. The function reads from this structure to apply the parameters to the connection.
- **Output**: None
- **See Also**: [`fd_quic_apply_peer_params`](<fd_quic.c.md#fd_quic_apply_peer_params>)  (Implementation)


---
### fd\_quic\_reconstruct\_pkt\_num<!-- {{#callable_declaration:fd_quic_reconstruct_pkt_num}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L307>)

Reconstructs the full packet number from a truncated packet number.
- **Description**: Use this function to reconstruct the full packet number from a truncated packet number received in a QUIC packet. This is necessary because QUIC packets often contain only a truncated version of the packet number to save space. The function calculates the full packet number by considering the expected packet number and ensuring the reconstructed number is within a valid range. It is important to provide valid inputs to avoid incorrect packet number reconstruction.
- **Inputs**:
    - `pktnum_comp`: The truncated packet number component received in the QUIC packet. It must be a valid truncated packet number.
    - `pktnum_sz`: The size of the packet number in bytes. It determines the number of bits used for the packet number.
    - `exp_pkt_number`: The expected packet number, which is used as a reference to reconstruct the full packet number. It must be a valid packet number.
- **Output**: Returns the reconstructed full packet number as an unsigned long integer.
- **See Also**: [`fd_quic_reconstruct_pkt_num`](<fd_quic.c.md#fd_quic_reconstruct_pkt_num>)  (Implementation)


---
### fd\_quic\_pkt\_meta\_retry<!-- {{#callable_declaration:fd_quic_pkt_meta_retry}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L312>)

Retries packet metadata for a QUIC connection.
- **Description**: Use this function to manage packet metadata for a QUIC connection, particularly when retrying packets is necessary. It can be used to free packet metadata resources either by force or based on expiration. This function is useful in scenarios where packet retransmission is required, such as when acknowledgments are not received. It must be called with a valid QUIC connection and can operate on specific encryption levels or all levels if specified. Ensure that the QUIC connection is active and properly initialized before calling this function.
- **Inputs**:
    - `quic`: A pointer to an `fd_quic_t` structure representing the QUIC instance. Must not be null. The caller retains ownership.
    - `conn`: A pointer to an `fd_quic_conn_t` structure representing the connection for which packet metadata is being retried. Must not be null. The caller retains ownership.
    - `force`: An integer flag indicating whether to force the retry operation. A non-zero value forces the operation, while zero allows it to proceed based on expiration.
    - `arg_enc_level`: An unsigned integer specifying the encryption level to operate on. If set to `~0u`, the function will consider all encryption levels.
- **Output**: None
- **See Also**: [`fd_quic_pkt_meta_retry`](<fd_quic.c.md#fd_quic_pkt_meta_retry>)  (Implementation)


---
### fd\_quic\_reclaim\_pkt\_meta<!-- {{#callable_declaration:fd_quic_reclaim_pkt_meta}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L320>)

Reclaims resources associated with packet metadata after receiving acknowledgments.
- **Description**: Use this function to release resources related to packet metadata when acknowledgments are received. It processes different types of packet metadata, such as PING, handshake data, and stream data, and updates the connection state accordingly. This function must be called with valid connection and packet metadata pointers. It handles protocol violations by informing the peer and may adjust connection flags and stream states based on the acknowledgment details.
- **Inputs**:
    - `conn`: A pointer to a `fd_quic_conn_t` structure representing the connection. Must not be null. The function updates the connection state based on the packet metadata.
    - `pkt_meta`: A pointer to a `fd_quic_pkt_meta_t` structure containing the packet metadata to be reclaimed. Must not be null. The function processes this metadata to update the connection state.
    - `enc_level`: An unsigned integer representing the encryption level. It is used to index into connection-specific data structures for processing acknowledgments.
- **Output**: None
- **See Also**: [`fd_quic_reclaim_pkt_meta`](<fd_quic.c.md#fd_quic_reclaim_pkt_meta>)  (Implementation)


---
### fd\_quic\_process\_quic\_packet\_v1<!-- {{#callable_declaration:fd_quic_process_quic_packet_v1}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L325>)

Processes a QUIC packet and updates connection state.
- **Description**: Use this function to process a QUIC packet and update the associated connection state. It validates the packet size and determines the packet type based on the header form. The function handles both long and short header packets, updating metrics and scheduling timers as necessary. It must be called with a valid QUIC context and packet structure. The function returns the number of bytes consumed or an error code if the packet is invalid.
- **Inputs**:
    - `quic`: A pointer to an `fd_quic_t` structure representing the QUIC context. Must not be null.
    - `pkt`: A pointer to an `fd_quic_pkt_t` structure where packet metadata will be stored. Must not be null.
    - `cur_ptr`: A pointer to the current position in the packet data buffer. Must not be null.
    - `cur_sz`: The size of the packet data buffer. Must be between `FD_QUIC_SHORTEST_PKT` and 1500 bytes. Invalid sizes result in an error return.
- **Output**: Returns the number of bytes consumed from the packet buffer, or `FD_QUIC_PARSE_FAIL` if the packet is invalid.
- **See Also**: [`fd_quic_process_quic_packet_v1`](<fd_quic.c.md#fd_quic_process_quic_packet_v1>)  (Implementation)


---
### fd\_quic\_handle\_v1\_initial<!-- {{#callable_declaration:fd_quic_handle_v1_initial}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L331>)

Processes an initial QUIC packet.
- **Description**: Use this function to handle an initial QUIC packet during the connection setup phase. It processes the packet, verifies its validity, and manages connection state. This function must be called with a valid QUIC context and packet data. It handles both client and server roles, ensuring proper connection establishment and packet decryption. The function updates connection metrics and may create a new connection if necessary. It returns the number of bytes consumed or an error code if the packet is invalid.
- **Inputs**:
    - `quic`: A pointer to an `fd_quic_t` structure representing the QUIC context. Must not be null.
    - `p_conn`: A pointer to a pointer to an `fd_quic_conn_t` structure. It may point to an existing connection or be null if no connection exists. The function may update this to point to a new connection.
    - `pkt`: A pointer to an `fd_quic_pkt_t` structure representing the packet to process. Must not be null.
    - `dcid`: A pointer to a constant `fd_quic_conn_id_t` structure representing the destination connection ID. Must not be null.
    - `peer_scid`: A pointer to a constant `fd_quic_conn_id_t` structure representing the peer's source connection ID. Must not be null.
    - `cur_ptr`: A pointer to a buffer containing the packet data. Must not be null.
    - `cur_sz`: The size of the packet data buffer. Must be a valid size for the packet data.
- **Output**: Returns the number of bytes consumed from the packet data or an error code if the packet is invalid.
- **See Also**: [`fd_quic_handle_v1_initial`](<fd_quic.c.md#fd_quic_handle_v1_initial>)  (Implementation)


---
### fd\_quic\_handle\_v1\_handshake<!-- {{#callable_declaration:fd_quic_handle_v1_handshake}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L339>)

Processes a QUIC handshake packet.
- **Description**: Use this function to process a QUIC handshake packet for a given connection. It validates the connection and decryption keys, decodes the handshake, and processes the packet frames. This function must be called with a valid connection and packet. It returns the number of bytes consumed from the packet or an error code if the packet is invalid or processing fails. Ensure that the connection and packet are properly initialized before calling this function.
- **Inputs**:
    - `quic`: A pointer to an `fd_quic_t` structure representing the QUIC context. Must not be null.
    - `conn`: A pointer to an `fd_quic_conn_t` structure representing the connection. Must not be null and must be in a valid state with available keys for the handshake encryption level.
    - `pkt`: A pointer to an `fd_quic_pkt_t` structure representing the packet to process. Must not be null.
    - `cur_ptr`: A pointer to the current position in the packet data buffer. Must not be null.
    - `cur_sz`: The size of the data buffer pointed to by `cur_ptr`. Must be large enough to contain the packet data.
- **Output**: Returns the number of bytes consumed from the packet if successful, or `FD_QUIC_PARSE_FAIL` if the packet is invalid or processing fails.
- **See Also**: [`fd_quic_handle_v1_handshake`](<fd_quic.c.md#fd_quic_handle_v1_handshake>)  (Implementation)


---
### fd\_quic\_handle\_v1\_one\_rtt<!-- {{#callable_declaration:fd_quic_handle_v1_one_rtt}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L348>)

Processes a QUIC 1-RTT packet for a given connection.
- **Description**: Use this function to handle a QUIC 1-RTT packet for a specific connection. It processes the packet by decrypting it, handling its frames, and updating connection state. This function must be called with a valid connection and packet. It expects the packet to be at least a certain size to contain necessary headers. If the connection is invalid or keys are unavailable, or if decryption fails, the function returns an error code. Ensure that the QUIC context and connection are properly initialized before calling this function.
- **Inputs**:
    - `quic`: A pointer to the QUIC context (`fd_quic_t`). Must not be null. The caller retains ownership.
    - `conn`: A pointer to the QUIC connection (`fd_quic_conn_t`). Must not be null. The caller retains ownership. If the connection is invalid, the function returns an error code.
    - `pkt`: A pointer to the QUIC packet (`fd_quic_pkt_t`). Must not be null. The caller retains ownership.
    - `cur_ptr`: A pointer to the current position in the packet data. Must not be null. The caller retains ownership.
    - `tot_sz`: The total size of the packet data. Must be large enough to contain necessary headers and payload. If the size is too small, the function returns an error code.
- **Output**: Returns the total size of the packet data if successful, or an error code if processing fails.
- **See Also**: [`fd_quic_handle_v1_one_rtt`](<fd_quic.c.md#fd_quic_handle_v1_one_rtt>)  (Implementation)


---
### fd\_quic\_handle\_v1\_frame<!-- {{#callable_declaration:fd_quic_handle_v1_frame}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L365>)

Handles an incoming QUIC frame.
- **Description**: Use this function to process an incoming QUIC frame within a given context. It requires a valid QUIC connection and packet, and it expects the frame data to be provided in a buffer. The function checks the connection state and the validity of the frame type before processing. It returns a specific value based on the success or failure of the frame processing, including handling protocol violations.
- **Inputs**:
    - `quic`: A pointer to an `fd_quic_t` structure representing the QUIC context. Must not be null.
    - `conn`: A pointer to an `fd_quic_conn_t` structure representing the connection context. Must not be null and must not be in the `FD_QUIC_CONN_STATE_DEAD` state.
    - `pkt`: A pointer to an `fd_quic_pkt_t` structure representing the packet context. Must not be null.
    - `pkt_type`: An unsigned integer representing the packet type. Must be a valid packet type for the frame being processed.
    - `frame_ptr`: A pointer to a buffer containing the serialized QUIC frame. Must not be null and must point to a valid memory region of at least `frame_sz` bytes.
    - `frame_sz`: An unsigned long representing the size of the frame buffer. Must be greater than zero.
- **Output**: Returns a value in the range (0, frame_sz) if the frame is successfully processed. Returns `FD_QUIC_PARSE_FAIL` if the frame is malformed or if there is a protocol violation.
- **See Also**: [`fd_quic_handle_v1_frame`](<fd_quic.c.md#fd_quic_handle_v1_frame>)  (Implementation)


---
### fd\_quic\_lazy\_ack\_pkt<!-- {{#callable_declaration:fd_quic_lazy_ack_pkt}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L380>)

Enqueues a future acknowledgment for a given packet.
- **Description**: Use this function to schedule an acknowledgment for a packet to be sent at a later time during a service call. The function respects the acknowledgment flag in the packet, where `ACK_FLAG_RQD` triggers an immediate acknowledgment, and `ACK_FLAG_CANCEL` suppresses the acknowledgment entirely. The timing of the acknowledgment is influenced by the configuration settings for acknowledgment threshold and delay. This function is typically used in scenarios where acknowledgment timing needs to be managed efficiently.
- **Inputs**:
    - `quic`: A pointer to an `fd_quic_t` structure representing the QUIC instance. Must not be null.
    - `conn`: A pointer to an `fd_quic_conn_t` structure representing the connection. Must not be null.
    - `pkt`: A constant pointer to an `fd_quic_pkt_t` structure representing the packet to acknowledge. Must not be null. The `ack_flag` field in this structure determines the acknowledgment behavior.
- **Output**: Returns an integer status code indicating the result of the acknowledgment scheduling. If `ACK_FLAG_CANCEL` is set, it returns `FD_QUIC_ACK_TX_CANCEL`.
- **See Also**: [`fd_quic_lazy_ack_pkt`](<fd_quic.c.md#fd_quic_lazy_ack_pkt>)  (Implementation)


---
### fd\_quic\_gen\_stream\_frames<!-- {{#callable_declaration:fd_quic_gen_stream_frames}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L443>)

Generates QUIC stream frames for transmission.
- **Description**: Use this function to generate QUIC stream frames for a given connection. It processes streams with available data and appends frames to the payload buffer. Ensure that the connection is valid and that the payload buffer has sufficient space. The function updates packet metadata and tracks the frames generated. It must be called with a valid connection and appropriate packet metadata template and tracker.
- **Inputs**:
    - `conn`: A pointer to a `fd_quic_conn_t` structure representing the connection. Must not be null.
    - `payload_ptr`: A pointer to the start of the buffer where the stream frames will be written. Must not be null and should point to a valid memory region.
    - `payload_end`: A pointer to the end of the buffer. Must not be null and should be greater than or equal to `payload_ptr`.
    - `pkt_meta_tmpl`: A pointer to a `fd_quic_pkt_meta_t` structure used as a template for packet metadata. Must not be null.
    - `tracker`: A pointer to a `fd_quic_pkt_meta_tracker_t` structure used to track packet metadata. Must not be null.
- **Output**: Returns a pointer to the position in the buffer after the last written byte.
- **See Also**: [`fd_quic_gen_stream_frames`](<fd_quic.c.md#fd_quic_gen_stream_frames>)  (Implementation)


---
### fd\_quic\_process\_ack\_range<!-- {{#callable_declaration:fd_quic_process_ack_range}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_private.h#L450>)

Processes an acknowledgment range for a QUIC connection.
- **Description**: Use this function to process a range of acknowledged packets for a QUIC connection. It updates the connection's packet metadata based on the acknowledgment range provided. This function must be called with valid connection and context pointers, and it assumes that the acknowledgment range is valid and within the bounds of sent packet numbers. It also updates round-trip time (RTT) metrics if the largest acknowledged packet is the largest sent packet. Ensure that the connection and context are properly initialized before calling this function.
- **Inputs**:
    - `conn`: A pointer to an `fd_quic_conn_t` structure representing the QUIC connection. Must not be null.
    - `context`: A pointer to an `fd_quic_frame_ctx_t` structure providing the context for the frame. Must not be null.
    - `enc_level`: An unsigned integer representing the encryption level of the packets being acknowledged.
    - `largest_ack`: An unsigned long representing the largest packet number acknowledged by the peer.
    - `ack_range`: An unsigned long representing the range of packet numbers acknowledged, starting from `largest_ack` and going backwards.
    - `is_largest`: An integer flag indicating if the largest acknowledged packet is the largest sent packet. Non-zero if true.
    - `now`: A long integer representing the current timestamp in nanoseconds.
    - `ack_delay`: An unsigned long representing the acknowledgment delay in peer units.
- **Output**: None
- **See Also**: [`fd_quic_process_ack_range`](<fd_quic.c.md#fd_quic_process_ack_range>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)