<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Internal APIs for high-performance logging of events using a custom binary log format.

# Purpose
The `fd_quic_log_tx.h` file defines internal APIs for high-performance logging of events in a production environment. It is part of a logging system that is designed to handle millions of events per second without significantly impacting application performance. This file specifically provides the internal API for producing logs, while a separate file, `fd_quic_log_user.h`, is intended for reading logs. The logging system uses a custom binary log format, which is currently unstable but could be made compatible with the qlog format in the future.

The file defines a structure `fd_quic_log_buf` that acts as a Single Producer Multiple Consumer (SPMC) queue for log messages, suitable for use over shared memory. It includes functions for creating, deleting, and managing these log buffers. The `fd_quic_log_tx` structure describes a producer-side join to a `fd_quic_log_buf`, and the file provides functions for joining and leaving a log buffer as a producer, preparing and submitting log messages, and updating sequence numbers. The file also defines constants and macros related to the memory alignment and footprint of the log buffers. The internal API allows for changes to log producers without requiring recompilation of log consumers, thus separating the concerns of log production and consumption.
# Imports and Dependencies

---
- `fd_quic_log_user.h`
- `../../../tango/mcache/fd_mcache.h`
- `../../../tango/dcache/fd_dcache.h`


# Data Structures

---
### fd\_quic\_log\_buf
- **Type**: ``struct``
- **Members**:
    - ``abi``: A public ABI for consumers to interact with the log buffer.
    - ``magic``: A unique identifier to signal the layout of the shared memory region.
    - ``dcache_off``: An offset value used internally for data cache management.
    - ``chunk0``: An internal parameter related to chunk management.
    - ``wmark``: An internal watermark parameter for managing log buffer state.
- **Description**: The `fd_quic_log_buf` structure is a shared memory SPMC queue for log messages, allowing one producer and multiple consumers to interact with log data. It includes a public ABI for consumer access and private parameters for internal management of the log buffer's state and memory layout.


---
### fd\_quic\_log\_buf\_t
- **Type**: ``struct``
- **Members**:
    - ``abi``: Public ABI for consumers.
    - ``magic``: Magic number used to signal the layout of the shared memory region.
    - ``dcache_off``: Offset for the data cache.
    - ``chunk0``: Initial chunk index for log messages.
    - ``wmark``: Watermark for log message processing.
- **Description**: Represents the header of a `quic_log_buf` object, which is a single-producer, multiple-consumer (SPMC) queue for log messages suitable for use over shared memory. It allows one producer to join via `quic_log_tx` and multiple consumers to join via `quic_log_rx`, without requiring them to be in the same address space. The structure includes both public and private parameters to manage the logging process efficiently.


---
### fd\_quic\_log\_tx\_t
- **Type**: ``struct``
- **Members**:
    - ``mcache``: Pointer to `fd_frag_meta_t`, used for metadata caching.
    - ``mcache_seq``: Pointer to an `ulong`, used for sequence number caching.
    - ``base``: Pointer to the base address of the log buffer.
    - ``depth``: Unsigned long integer representing the depth of the log buffer.
    - ``seq``: Unsigned long integer representing the current sequence number.
    - ``chunk``: Unsigned integer representing the current chunk index.
    - ``chunk0``: Unsigned integer representing the initial chunk index.
    - ``wmark``: Unsigned integer representing the watermark for the buffer.
- **Description**: Facilitates the producer-side operations for logging events to a `fd_quic_log_buf` structure, allowing a single producer to join and manage log entries in a shared memory buffer, with fields for metadata, sequence management, and buffer indexing.


# Functions

---
### fd\_quic\_log\_tx\_seq\_update<!-- {{#callable:fd_quic_log_tx_seq_update}} -->
[View Source →](<../../../../../../src/waltz/quic/log/fd_quic_log_tx.h#L147>)

Updates the sequence number in the `fd_quic_log_tx_t` structure using the `fd_mcache_seq_update` function.
- **Inputs**:
    - `log`: A pointer to an `fd_quic_log_tx_t` structure, which contains the sequence number and other metadata for a QUIC log transmission.
- **Logic and Control Flow**:
    - Calls the `fd_mcache_seq_update` function with `log->mcache_seq` and `log->seq` as arguments.
    - The `fd_mcache_seq_update` function updates the sequence number in the memory cache.
- **Output**: No return value; the function operates directly on the data pointed to by the `log` argument.


---
### fd\_quic\_log\_tx\_prepare<!-- {{#callable:fd_quic_log_tx_prepare}} -->
[View Source →](<../../../../../../src/waltz/quic/log/fd_quic_log_tx.h#L157>)

Prepares a new log message write by returning a pointer to the log message buffer.
- **Inputs**:
    - `log`: A pointer to an `fd_quic_log_tx_t` structure representing the log producer context.
- **Logic and Control Flow**:
    - Calls `fd_chunk_to_laddr` with `log->base` and `log->chunk` as arguments.
    - Returns the result of `fd_chunk_to_laddr`, which is a pointer to the log message buffer.
- **Output**: A pointer to the log message buffer where up to `FD_QUIC_LOG_BUF_MTU` bytes can be written.


---
### fd\_quic\_log\_tx\_submit<!-- {{#callable:fd_quic_log_tx_submit}} -->
[View Source →](<../../../../../../src/waltz/quic/log/fd_quic_log_tx.h#L164>)

Submits an in-flight log message write to a shared memory log buffer and updates the sequence and chunk indices.
- **Inputs**:
    - ``tx``: A pointer to an `fd_quic_log_tx_t` structure representing the log transaction context.
    - ``sz``: The size of the log message in bytes, which must be in the range [0, FD_QUIC_LOG_BUF_MTU).
    - ``sig``: A signature or identifier for the log message, typically obtained from `fd_quic_log_sig()`.
    - ``ts``: A timestamp for the log message.
- **Logic and Control Flow**:
    - Retrieve the metadata cache (`mcache`), chunk index (`chunk`), depth (`depth`), sequence number (`seq`), control flags (`ctl`), timestamp component (`ts_comp`), initial chunk index (`chunk0`), and watermark (`wmark`) from the `tx` structure.
    - Determine the appropriate publish function (`fd_mcache_publish_sse` or `fd_mcache_publish`) based on the presence of SSE support.
    - Call the determined publish function with the metadata cache and other parameters to submit the log message.
    - Increment the sequence number in the `tx` structure using `fd_seq_inc()`.
    - Update the chunk index in the `tx` structure using `fd_dcache_compact_next()`.
- **Output**: No return value; the function updates the `tx` structure in place.


---
### fd\_quic\_log\_sig<!-- {{#callable:fd_quic_log_sig}} -->
[View Source →](<../../../../../../src/waltz/quic/log/fd_quic_log_tx.h#L190>)

Converts a `uint` event identifier to an `ulong` type.
- **Inputs**:
    - `event`: A `uint` representing the event identifier to convert.
- **Logic and Control Flow**:
    - Casts the `event` from `uint` to `ulong`.
- **Output**: Returns the `event` as an `ulong`.


# Function Declarations (Public API)

---
### fd\_quic\_log\_buf\_align<!-- {{#callable_declaration:fd_quic_log_buf_align}} -->
[View Source →](<../../../../../../src/waltz/quic/log/fd_quic_log_tx.h#L77>)

Returns the alignment requirement for a QUIC log buffer.
- **Description**: Use this function to obtain the alignment requirement for a QUIC log buffer, which is necessary when allocating memory for such buffers. This function is useful in scenarios where precise memory alignment is critical for performance or correctness. It is a constant function and does not depend on any input parameters, ensuring consistent output across calls.
- **Inputs**: None
- **Output**: The function returns an unsigned long integer representing the alignment requirement for a QUIC log buffer.
- **See Also**: [`fd_quic_log_buf_align`](<fd_quic_log.c.md#fd_quic_log_buf_align>)  (Implementation)


---
### fd\_quic\_log\_buf\_footprint<!-- {{#callable_declaration:fd_quic_log_buf_footprint}} -->
[View Source →](<../../../../../../src/waltz/quic/log/fd_quic_log_tx.h#L88>)

Calculates the required memory size for a log buffer.
- **Description**: Use this function to determine the memory footprint needed for a `quic_log_buf` based on the specified `depth`. It returns the size in bytes of the memory region required to back a `quic_log_buf`. If the `depth` is invalid, the function returns 0, which can also serve as a quick validity check for the `depth` parameter. This function is useful when setting up a log buffer to ensure that sufficient memory is allocated.
- **Inputs**:
    - `depth`: Specifies the depth of the log buffer. Must be a non-negative value and should not exceed `INT_MAX`. If `depth` is greater than `INT_MAX`, the function returns 0, indicating an invalid depth.
- **Output**: Returns the size in bytes of the memory region required for a `quic_log_buf`. Returns 0 if the `depth` is invalid.
- **See Also**: [`fd_quic_log_buf_footprint`](<fd_quic_log.c.md#fd_quic_log_buf_footprint>)  (Implementation)


---
### fd\_quic\_log\_buf\_new<!-- {{#callable_declaration:fd_quic_log_buf_new}} -->
[View Source →](<../../../../../../src/waltz/quic/log/fd_quic_log_tx.h#L96>)

Formats a memory region as a `quic_log_buf`.
- **Description**: Use this function to initialize a shared memory region for logging events in a high-performance environment. The function prepares the memory region for producer and consumer joins, allowing for efficient logging and reading of events. Ensure that the `shmlog` pointer is not null and is properly aligned. The `depth` parameter determines the size of the log buffer, and it must be valid to avoid a return of NULL. This function logs warnings if the input parameters are invalid.
- **Inputs**:
    - `shmlog`: Pointer to the memory region to format as a `quic_log_buf`. Must not be null and must be aligned to `FD_QUIC_LOG_BUF_ALIGN`. Caller retains ownership.
    - `depth`: Specifies the depth of the log buffer. Must be a valid value to ensure a non-zero footprint. Invalid values result in a return of NULL.
- **Output**: Returns the `shmlog` pointer if successful, or NULL if there is an error with the input parameters.
- **See Also**: [`fd_quic_log_buf_new`](<fd_quic_log.c.md#fd_quic_log_buf_new>)  (Implementation)


---
### fd\_quic\_log\_buf\_delete<!-- {{#callable_declaration:fd_quic_log_buf_delete}} -->
[View Source →](<../../../../../../src/waltz/quic/log/fd_quic_log_tx.h#L104>)

Releases the memory region backing a `quic_log_buf`.
- **Description**: Use this function to release the memory region of a `quic_log_buf` back to the caller. Ensure that there are no active joins to the `quic_log_buf` before calling this function. This function checks for a valid and aligned `shmlog` pointer and logs warnings if the pointer is null, misaligned, or if the magic number is incorrect. It also resets the magic numbers to zero to indicate that the buffer is no longer valid.
- **Inputs**:
    - `shmlog`: A pointer to the shared memory log buffer (`quic_log_buf`) to be deleted. Must not be null and must be aligned to `FD_QUIC_LOG_BUF_ALIGN`. The function logs a warning and returns null if the pointer is null or misaligned.
- **Output**: Returns the original `shmlog` pointer if successful, or null if the input is invalid.
- **See Also**: [`fd_quic_log_buf_delete`](<fd_quic_log.c.md#fd_quic_log_buf_delete>)  (Implementation)


---
### fd\_quic\_log\_tx\_leave<!-- {{#callable_declaration:fd_quic_log_tx_leave}} -->
[View Source →](<../../../../../../src/waltz/quic/log/fd_quic_log_tx.h#L141>)

Releases a producer from a QUIC log buffer.
- **Description**: Use this function to safely detach a producer from a QUIC log buffer when it is no longer needed. This function should be called when the producer is done with logging operations, even if consumers are still attached to the log buffer. It ensures that the log sequence is updated before clearing the log structure. The function handles null input by logging a warning and returning null.
- **Inputs**:
    - `log`: A pointer to an `fd_quic_log_tx_t` structure representing the producer's connection to a QUIC log buffer. Must not be null. If null, the function logs a warning and returns null.
- **Output**: Returns the input `log` pointer if successful, or null if the input was null.
- **See Also**: [`fd_quic_log_tx_leave`](<fd_quic_log.c.md#fd_quic_log_tx_leave>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)