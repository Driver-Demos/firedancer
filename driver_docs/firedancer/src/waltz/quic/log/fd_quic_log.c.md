<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for managing QUIC log buffers, including creation, deletion, and joining for transmission and reception.

# Purpose
The code provides an API for managing a QUIC (Quick UDP Internet Connections) logging buffer, which is used to handle memory allocation and deallocation for logging data in a shared memory environment. It includes functions to calculate the alignment and footprint of the logging buffer ([`fd_quic_log_buf_align`](<#fd_quic_log_buf_align>) and [`fd_quic_log_buf_footprint`](<#fd_quic_log_buf_footprint>)), create a new logging buffer ([`fd_quic_log_buf_new`](<#fd_quic_log_buf_new>)), and delete an existing logging buffer ([`fd_quic_log_buf_delete`](<#fd_quic_log_buf_delete>)). The code ensures that the memory is properly aligned and initialized, and it uses a combination of memory cache (`mcache`) and data cache (`dcache`) to manage the logging data efficiently.

Additionally, the code defines APIs for joining and leaving both transmission ([`fd_quic_log_tx_join`](<#fd_quic_log_tx_join>), [`fd_quic_log_tx_leave`](<#fd_quic_log_tx_leave>)) and reception ([`fd_quic_log_rx_join`](<#fd_quic_log_rx_join>), [`fd_quic_log_rx_leave`](<#fd_quic_log_rx_leave>)) contexts. These functions facilitate the interaction with the logging buffer by setting up the necessary structures and ensuring that the logging operations are synchronized and consistent. The code checks for alignment and validity of the shared memory log, and it uses magic numbers to verify the integrity of the logging buffer. This module is intended to be part of a larger system where it can be included and used to manage logging operations in a QUIC-based communication setup.
# Imports and Dependencies

---
- `fd_quic_log_tx.h`
- `../../../tango/dcache/fd_dcache.h`


# Functions

---
### fd\_quic\_log\_buf\_align<!-- {{#callable:fd_quic_log_buf_align}} -->
[View Source →](<../../../../../../src/waltz/quic/log/fd_quic_log.c#L6>)

Returns the alignment requirement for a QUIC log buffer.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the value of the macro `FD_QUIC_LOG_BUF_ALIGN`.
- **Output**: The alignment requirement for a QUIC log buffer as defined by `FD_QUIC_LOG_BUF_ALIGN`.


---
### fd\_quic\_log\_buf\_footprint<!-- {{#callable:fd_quic_log_buf_footprint}} -->
[View Source →](<../../../../../../src/waltz/quic/log/fd_quic_log.c#L11>)

Calculates the memory footprint required for a QUIC log buffer based on the specified depth.
- **Inputs**:
    - `depth`: The desired depth of the QUIC log buffer, which influences the size of the memory cache and data cache.
- **Logic and Control Flow**:
    - Check if `depth` is greater than `INT_MAX`; if true, return 0.
    - Set `depth` to the maximum of `depth` and `FD_MCACHE_BLOCK`.
    - Calculate `mcache_footprint` using `fd_mcache_footprint` with `depth` and 0 as arguments.
    - Calculate `req_data_sz` using `fd_dcache_req_data_sz` with `FD_QUIC_LOG_MTU`, `depth`, 1, and 1 as arguments.
    - Calculate `dcache_footprint` using `fd_dcache_footprint` with `req_data_sz` and 0UL as arguments.
    - Return 0 if any of `mcache_footprint`, `req_data_sz`, or `dcache_footprint` is 0.
    - Return 0 if `mcache_footprint` or `dcache_footprint` is greater than `INT_MAX`.
    - Initialize `l` with `FD_LAYOUT_INIT`.
    - Append `sizeof(fd_quic_log_buf_t)` to `l` with alignment `FD_QUIC_LOG_BUF_ALIGN`.
    - Append `mcache_footprint` to `l` with alignment `FD_MCACHE_ALIGN`.
    - Append `dcache_footprint` to `l` with alignment `FD_DCACHE_ALIGN`.
    - Finalize `l` with alignment `FD_QUIC_LOG_BUF_ALIGN` and return `l`.
- **Output**: Returns the calculated memory footprint as an unsigned long integer, or 0 if any constraints are violated.


---
### fd\_quic\_log\_buf\_new<!-- {{#callable:fd_quic_log_buf_new}} -->
[View Source →](<../../../../../../src/waltz/quic/log/fd_quic_log.c#L36>)

Initializes a QUIC log buffer in shared memory with specified depth and alignment.
- **Inputs**:
    - `shmlog`: Pointer to the shared memory location where the log buffer will be initialized.
    - `depth`: Desired depth of the log buffer, which will be adjusted to a minimum value if necessary.
- **Logic and Control Flow**:
    - Adjusts `depth` to be at least `FD_MCACHE_BLOCK`.
    - Checks if `shmlog` is NULL or misaligned and logs a warning if so, returning NULL.
    - Calculates the required size of the log buffer using [`fd_quic_log_buf_footprint`](<#fd_quic_log_buf_footprint>) and logs a warning if the size is invalid, returning NULL.
    - Initializes the memory at `shmlog` to zero using `fd_memset`.
    - Allocates memory for the log buffer, mcache, and dcache using `FD_SCRATCH_ALLOC_APPEND`.
    - Initializes mcache and dcache with `fd_mcache_new` and `fd_dcache_new`, joining them with `fd_mcache_join` and `fd_dcache_join`.
    - Checks if mcache or dcache initialization failed, returning NULL if so.
    - Sets initial sequence number in mcache.
    - Calculates chunk offsets and watermark for dcache using `fd_dcache_compact_chunk0`, `fd_dcache_compact_wmark`, and `fd_dcache_compact_chunk1`.
    - Populates the `fd_quic_log_buf_t` structure with calculated offsets and chunk information.
    - Sets magic numbers in the log buffer to indicate successful initialization.
- **Output**: Returns the pointer to the initialized shared memory log buffer, or NULL if initialization fails.
- **Functions Called**:
    - [`fd_quic_log_buf_footprint`](<#fd_quic_log_buf_footprint>)


---
### fd\_quic\_log\_buf\_delete<!-- {{#callable:fd_quic_log_buf_delete}} -->
[View Source →](<../../../../../../src/waltz/quic/log/fd_quic_log.c#L98>)

Deletes a QUIC log buffer by validating and clearing its memory and associated caches.
- **Inputs**:
    - `shmlog`: A pointer to the shared memory log buffer to delete.
- **Logic and Control Flow**:
    - Check if `shmlog` is NULL; if so, log a warning and return NULL.
    - Check if `shmlog` is aligned to `FD_QUIC_LOG_BUF_ALIGN`; if not, log a warning and return NULL.
    - Cast `shmlog` to `fd_quic_log_buf_t *` and check if its `magic` field matches `FD_QUIC_LOG_BUF_MAGIC`; if not, log a warning.
    - Calculate the memory addresses for `mcache_mem` and `dcache_mem` using offsets from the log structure.
    - Call `fd_mcache_delete` on `mcache_mem` to delete the memory cache.
    - Call `fd_dcache_delete` on `dcache_mem` to delete the data cache.
    - Set `log->abi.magic` and `log->magic` to 0 and use `FD_COMPILER_MFENCE` to ensure memory ordering.
    - Return the log buffer pointer.
- **Output**: Returns the pointer to the log buffer if successful, or NULL if an error occurs.


---
### fd\_quic\_log\_tx\_join<!-- {{#callable:fd_quic_log_tx_join}} -->
[View Source →](<../../../../../../src/waltz/quic/log/fd_quic_log.c#L129>)

Initializes and joins a QUIC log transmission context with a shared memory log.
- **Inputs**:
    - `tx`: A pointer to an `fd_quic_log_tx_t` structure that will be initialized.
    - `shmlog`: A pointer to the shared memory log to join.
- **Logic and Control Flow**:
    - Check if `shmlog` is NULL; if so, log a warning and return NULL.
    - Check if `shmlog` is aligned to `FD_QUIC_LOG_BUF_ALIGN`; if not, log a warning and return NULL.
    - Cast `shmlog` to `fd_quic_log_buf_t` and check if its `magic` field matches `FD_QUIC_LOG_BUF_MAGIC`; if not, log a warning and return NULL.
    - Join the memory cache (`mcache`) using the offset from `log->abi.mcache_off`; if joining fails, return NULL.
    - Join the data cache (`dcache`) using the offset from `log->dcache_off`; if joining fails, return NULL.
    - Get the sequence address from the memory cache.
    - Initialize the `tx` structure with the joined caches, sequence, and other log parameters.
    - Return the initialized `tx` pointer.
- **Output**: A pointer to the initialized `fd_quic_log_tx_t` structure, or NULL if an error occurs.


---
### fd\_quic\_log\_tx\_leave<!-- {{#callable:fd_quic_log_tx_leave}} -->
[View Source →](<../../../../../../src/waltz/quic/log/fd_quic_log.c#L168>)

Clears and resets a QUIC log transmission structure.
- **Inputs**:
    - `log`: A pointer to an `fd_quic_log_tx_t` structure that represents the QUIC log transmission to leave.
- **Logic and Control Flow**:
    - Check if `log` is NULL; if true, log a warning and return NULL.
    - Call [`fd_quic_log_tx_seq_update`](<fd_quic_log_tx.h.md#fd_quic_log_tx_seq_update>) to update the sequence number of the log.
    - Use `memset` to clear the memory of the `log` structure to zero.
    - Return the pointer to the cleared `log` structure.
- **Output**: Returns a pointer to the cleared `fd_quic_log_tx_t` structure, or NULL if the input was NULL.
- **Functions Called**:
    - [`fd_quic_log_tx_seq_update`](<fd_quic_log_tx.h.md#fd_quic_log_tx_seq_update>)


---
### fd\_quic\_log\_rx\_join<!-- {{#callable:fd_quic_log_rx_join}} -->
[View Source →](<../../../../../../src/waltz/quic/log/fd_quic_log.c#L181>)

Initializes and returns a `fd_quic_log_rx_t` structure from a shared memory log if valid.
- **Inputs**:
    - `rx`: A pointer to a `fd_quic_log_rx_t` structure to initialize.
    - `shmlog`: A pointer to the shared memory log to join.
- **Logic and Control Flow**:
    - Check if `shmlog` is NULL and log a warning if true, then return NULL.
    - Check if `shmlog` is aligned to `FD_QUIC_LOG_ALIGN` and log a warning if not, then return NULL.
    - Cast `shmlog` to `fd_quic_log_abi_t` and check if `magic` matches `FD_QUIC_LOG_MAGIC`; log a warning and return NULL if not.
    - Join the memory cache (`mcache`) using the offset from `abi` and return NULL if joining fails.
    - Get the sequence address from `mcache` and query the current sequence number.
    - Initialize the `fd_quic_log_rx_t` structure with the joined `mcache`, sequence address, base address, data low and high logical addresses, depth, and sequence number.
    - Return the initialized `rx` structure.
- **Output**: A pointer to the initialized `fd_quic_log_rx_t` structure, or NULL if any validation fails.


---
### fd\_quic\_log\_rx\_leave<!-- {{#callable:fd_quic_log_rx_leave}} -->
[View Source →](<../../../../../../src/waltz/quic/log/fd_quic_log.c#L219>)

Clears and returns a `fd_quic_log_rx_t` structure if it is not NULL.
- **Inputs**:
    - `log`: A pointer to a `fd_quic_log_rx_t` structure that will be cleared.
- **Logic and Control Flow**:
    - Check if `log` is NULL using `FD_UNLIKELY`.
    - If `log` is NULL, log a warning message 'NULL log' and return NULL.
    - If `log` is not NULL, clear the memory of `log` using `memset` with size `sizeof(fd_quic_log_rx_t)`.
    - Return the cleared `log` pointer.
- **Output**: Returns the cleared `fd_quic_log_rx_t` pointer if it is not NULL, otherwise returns NULL.



---
Made with ❤️ by [Driver](https://www.driver.ai/)