<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for creating, verifying, and handling QUIC retry packets with cryptographic integrity checks.

# Purpose
The code is a C module that implements functionality related to the QUIC (Quick UDP Internet Connections) protocol, specifically handling the creation, verification, and processing of QUIC Retry packets. The module includes functions to create a Retry packet ([`fd_quic_retry_create`](<#fd_quic_retry_create>)), verify a Retry packet on the server side ([`fd_quic_retry_server_verify`](<#fd_quic_retry_server_verify>)), and verify a Retry packet on the client side ([`fd_quic_retry_client_verify`](<#fd_quic_retry_client_verify>)). It also includes a utility function to construct a pseudo-header for integrity checks ([`fd_quic_retry_pseudo`](<#fd_quic_retry_pseudo>)). The module uses cryptographic operations, such as AES-GCM, to ensure the integrity and authenticity of the Retry packets.

The module includes several header files that provide necessary definitions and functions, such as `fd_quic_common.h` and `fd_quic_crypto_suites.h`. It defines constants and structures used in the Retry packet process, such as `fd_quic_retry_hdr_t` and `fd_quic_retry_token_t`. The code ensures that the Retry packets conform to the QUIC protocol specifications, including handling connection IDs, retry tokens, and integrity tags. The module is designed to be part of a larger QUIC implementation, providing specific functionality for managing Retry packets, which are used to mitigate denial-of-service attacks and validate client addresses in the QUIC protocol.
# Imports and Dependencies

---
- `fd_quic_common.h`
- `fd_quic_retry_private.h`
- `crypto/fd_quic_crypto_suites.h`
- `fd_quic_conn_id.h`
- `fd_quic_enum.h`
- `fd_quic_private.h`
- `../../ballet/aes/fd_aes_gcm.h`
- `assert.h`


# Functions

---
### fd\_quic\_retry\_pseudo<!-- {{#callable:fd_quic_retry_pseudo}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_retry.c#L16>)

Constructs a QUIC retry pseudo-packet by combining the original destination connection ID and a stripped retry packet.
- **Inputs**:
    - ``out``: An array of type `uchar` with a size of `FD_QUIC_RETRY_MAX_PSEUDO_SZ` to store the constructed pseudo-packet.
    - ``retry_pkt``: A pointer to the retry packet data.
    - ``retry_pkt_sz``: The size of the retry packet in bytes.
    - ``orig_dst_conn_id``: A pointer to a `fd_quic_conn_id_t` structure representing the original destination connection ID.
- **Logic and Control Flow**:
    - Check if `retry_pkt_sz` is less than or equal to `FD_QUIC_CRYPTO_TAG_SZ` or greater than `FD_QUIC_RETRY_MAX_SZ`; if so, return `FD_QUIC_PARSE_FAIL`.
    - Initialize a pointer `cur_ptr` to the start of the `out` array.
    - Set the first byte of `out` to the size of the original destination connection ID (`orig_dst_conn_id->sz`).
    - Copy the original destination connection ID (`orig_dst_conn_id->conn_id`) to `out`, starting from the second byte.
    - Calculate the size of the stripped retry packet by subtracting `FD_QUIC_CRYPTO_TAG_SZ` from `retry_pkt_sz`.
    - Copy the stripped retry packet data to `out`, following the original destination connection ID.
    - Return the total size of the constructed pseudo-packet by calculating the difference between the current pointer position and the start of `out`.
- **Output**: Returns the size of the constructed pseudo-packet as an `ulong`, or `FD_QUIC_PARSE_FAIL` if the input size is invalid.


---
### fd\_quic\_retry\_create<!-- {{#callable:fd_quic_retry_create}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_retry.c#L58>)

Creates a QUIC Retry packet with a header, token, and integrity tags.
- **Inputs**:
    - `retry`: An output buffer to store the created QUIC Retry packet.
    - `pkt`: A pointer to the original QUIC packet structure.
    - `rng`: A pointer to the random number generator used for token creation.
    - `retry_secret`: A secret key used for signing the retry token.
    - `retry_iv`: An initialization vector used for signing the retry token.
    - `orig_dst_conn_id`: A pointer to the original destination connection ID structure.
    - `src_conn_id`: A pointer to the source connection ID structure.
    - `new_conn_id`: A new connection ID to be used in the Retry packet.
    - `expire_at`: A timestamp indicating when the retry token should expire.
- **Logic and Control Flow**:
    - Initialize pointers and available space for the output buffer.
    - Create a new Retry packet header and encode it into the output buffer.
    - Create a new retry token and populate it with source IP, UDP port, and expiration data.
    - Sign the retry token with an inner integrity tag using AES-GCM.
    - If crypto is not disabled, create an outer integrity tag for the Retry packet.
    - Calculate the total size of the created Retry packet and return it.
- **Output**: The function returns the size of the created QUIC Retry packet as an unsigned long integer.
- **Functions Called**:
    - [`fd_quic_retry_data_set_ip4`](<fd_quic_retry.h.md#fd_quic_retry_data_set_ip4>)
    - [`fd_quic_retry_token_sign`](<fd_quic_retry.h.md#fd_quic_retry_token_sign>)
    - [`fd_quic_retry_pseudo`](<#fd_quic_retry_pseudo>)
    - [`fd_quic_retry_integrity_tag_sign`](<fd_quic_retry.h.md#fd_quic_retry_integrity_tag_sign>)


---
### fd\_quic\_retry\_server\_verify<!-- {{#callable:fd_quic_retry_server_verify}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_retry.c#L144>)

Verifies a QUIC retry token and checks if it matches the expected parameters.
- **Inputs**:
    - `pkt`: A pointer to the `fd_quic_pkt_t` structure representing the packet to verify.
    - `initial`: A pointer to the `fd_quic_initial_t` structure containing initial connection data.
    - `orig_dst_conn_id`: A pointer to `fd_quic_conn_id_t` where the original destination connection ID will be stored.
    - `retry_src_conn_id`: A pointer to an `ulong` where the retry source connection ID will be stored.
    - `retry_secret`: An array of `uchar` containing the retry secret used for verification.
    - `retry_iv`: An array of `uchar` containing the retry initialization vector used for verification.
    - `now`: A `long` representing the current time.
    - `ttl`: A `long` representing the time-to-live for the token.
- **Logic and Control Flow**:
    - Check if the destination connection ID length in `initial` is equal to `FD_QUIC_CONN_ID_SZ`; if not, return `FD_QUIC_FAILED`.
    - Check if the token length in `initial` is equal to the size of `fd_quic_retry_token_t`; if not, return `FD_QUIC_FAILED`.
    - Retrieve the retry token from `initial` and check if its original destination connection ID size is valid; if not, return `FD_QUIC_FAILED`.
    - Verify the retry token using [`fd_quic_retry_token_verify`](<fd_quic_retry.h.md#fd_quic_retry_token_verify>) and clear the AES-GCM context.
    - Extract IP and port information from the packet and retry token, and calculate expiration times.
    - Determine if the token matches expected parameters, including IP, port, and expiration times.
    - Log debug information based on the verification result.
    - Store the original destination connection ID and retry source connection ID from the retry token.
    - Return `FD_QUIC_SUCCESS` if the token matches, otherwise return `FD_QUIC_FAILED`.
- **Output**: Returns `FD_QUIC_SUCCESS` if the retry token is valid and matches expected parameters, otherwise returns `FD_QUIC_FAILED`.
- **Functions Called**:
    - [`fd_quic_retry_token_verify`](<fd_quic_retry.h.md#fd_quic_retry_token_verify>)


---
### fd\_quic\_retry\_client\_verify<!-- {{#callable:fd_quic_retry_client_verify}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_retry.c#L209>)

Verifies a QUIC Retry packet by decoding its header, validating its integrity tag, and extracting the source connection ID and token.
- **Inputs**:
    - `retry_ptr`: Pointer to the start of the Retry packet data.
    - `retry_sz`: Size of the Retry packet data.
    - `orig_dst_conn_id`: Pointer to the original destination connection ID structure.
    - `src_conn_id`: Pointer to the source connection ID structure to be filled (output).
    - `token`: Pointer to a location where the token pointer will be stored (output).
    - `token_sz`: Pointer to a location where the token size will be stored (output).
- **Logic and Control Flow**:
    - Initialize `cur_ptr` and `cur_sz` with `retry_ptr` and `retry_sz` respectively.
    - Decode the Retry header using `fd_quic_decode_retry_hdr` and check for parsing failure.
    - If the source connection ID length is zero, log a debug message and return failure.
    - Check if the remaining size is less than or equal to the crypto tag size, log a debug message, and return failure if true.
    - Extract the retry token and its size, and check if the token size exceeds the maximum allowed size, logging a debug message and returning failure if true.
    - Advance the pointer past the retry token and consume the retry integrity tag.
    - Construct a pseudo header for integrity tag validation using [`fd_quic_retry_pseudo`](<#fd_quic_retry_pseudo>).
    - If crypto is not disabled, validate the retry integrity tag using [`fd_quic_retry_integrity_tag_verify`](<fd_quic_retry.h.md#fd_quic_retry_integrity_tag_verify>) and return failure if validation fails.
    - Set the output parameters `src_conn_id`, `token`, and `token_sz` with the decoded values.
    - Return success.
- **Output**: Returns `FD_QUIC_SUCCESS` if the verification is successful, otherwise returns `FD_QUIC_FAILED`.
- **Functions Called**:
    - [`fd_quic_retry_pseudo`](<#fd_quic_retry_pseudo>)
    - [`fd_quic_retry_integrity_tag_verify`](<fd_quic_retry.h.md#fd_quic_retry_integrity_tag_verify>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)