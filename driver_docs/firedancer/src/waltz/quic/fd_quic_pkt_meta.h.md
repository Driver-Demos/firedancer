<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines data structures and functions for tracking QUIC packet metadata, including insertion, removal, and iteration.

# Purpose
The code is a C header file that defines data structures and functions for managing metadata related to QUIC (Quick UDP Internet Connections) packet transmission. It provides a mechanism to track metadata of packets sent to a peer, which is useful for handling acknowledgments when they arrive. The file defines several key data structures, including `fd_quic_pkt_meta`, `fd_quic_pkt_meta_list`, and `fd_quic_pkt_meta_tracker`, which are used to store and manage packet metadata. The `fd_quic_pkt_meta` structure includes fields for packet number, type, stream ID, encryption level, and transmission time, among others.

The file also includes functions for initializing, inserting, removing, and iterating over packet metadata within a data structure, which is implemented as a treap (a combination of a binary search tree and a heap). The functions provide operations such as comparing packet metadata, finding the minimum packet number, and clearing metadata for a specific encryption level. The header file is intended to be included in other C source files that require functionality for tracking and managing QUIC packet metadata, and it defines public APIs for interacting with these data structures.
# Imports and Dependencies

---
- `fd_quic_common.h`
- `../../util/tmpl/fd_pool.c`
- `../../util/tmpl/fd_treap.c`


# Data Structures

---
### fd\_quic\_pkt\_meta\_t
- **Type**: ``struct``
- **Members**:
    - ``key``: Stores metadata about what was sent in the identified packet.
    - ``val``: Holds either a scalar value or a range related to the packet.
    - ``enc_level``: Indicates the encryption level of the packet.
    - ``pn_space``: Represents the packet number space derived from the encryption level.
    - ``tx_time``: Records the time when the packet was transmitted.
    - ``expiry``: Specifies the time when the packet metadata expires, indicating when an acknowledgment is expected.
    - ``parent``: Treap field indicating the parent node in the data structure.
    - ``left``: Treap field indicating the left child node in the data structure.
    - ``right``: Treap field indicating the right child node in the data structure.
    - ``prio``: Treap field representing the priority of the node.
    - ``next``: Treap field pointing to the next node in the data structure.
    - ``prev``: Treap field pointing to the previous node in the data structure.
- **Description**: Tracks the metadata of data sent to a peer and is used to determine what is being acknowledged when acknowledgments arrive. It includes fields for packet metadata, encryption level, transmission time, and expiration time, as well as treap fields for managing the data structure's hierarchy.


---
### fd\_quic\_pkt\_meta\_list\_t
- **Type**: ``struct``
- **Members**:
    - ``sent_pkt_metas``: An array of `fd_quic_pkt_meta_ds_t` structures, each representing metadata for sent packets at different encryption levels.
    - ``pool``: A pointer to a pool of `fd_quic_pkt_meta_t` structures used for managing packet metadata.
- **Description**: `fd_quic_pkt_meta_tracker_t` is a structure that tracks metadata for QUIC packets sent at different encryption levels. It uses an array of `fd_quic_pkt_meta_ds_t` to store metadata for each encryption level and a pool of `fd_quic_pkt_meta_t` structures to manage the metadata efficiently. This structure helps in tracking and managing packet metadata, which is crucial for handling acknowledgments and retransmissions in the QUIC protocol.


---
### fd\_quic\_pkt\_meta\_tracker\_t
- **Type**: ``struct``
- **Members**:
    - `sent_pkt_metas`: An array of `fd_quic_pkt_meta_ds_t` structures, each representing metadata for sent packets at different encryption levels.
    - `pool`: A pointer to a pool of `fd_quic_pkt_meta_t` structures used for managing packet metadata.
- **Description**: Manages and tracks metadata for QUIC packets sent at different encryption levels, using a pool of packet metadata structures to efficiently handle packet metadata operations such as insertion, removal, and iteration.


---
### fd\_quic\_pkt\_meta\_key
- **Type**: `union`
- **Members**:
    - `type`: Records the frame type using a 4-bit unsigned character.
    - `pkt_num`: Stores the packet number using a 60-bit unsigned long.
    - `stream_id`: Holds the stream identifier as an unsigned long.
    - `b`: An array of two unsigned long integers used for alternative access to the data.
- **Description**: Facilitates the tracking of sent frames by storing metadata such as frame type, packet number, and stream identifier, with the ability to access this data in a structured or raw format.


---
### fd\_quic\_pkt\_meta\_key\_t
- **Type**: `union`
- **Members**:
    - `type`: Specifies the type of data for retransmission, using a 4-bit unsigned character.
    - `pkt_num`: Stores the packet number that carried the data, using 60 bits of an unsigned long.
    - `stream_id`: Holds the stream identifier if the type is stream-related, using an unsigned long.
    - `b`: An array of two unsigned long integers used for alternative access to the union's data.
- **Description**: `fd_quic_pkt_meta_key_t` is a union that serves as a key for tracking sent frames in a QUIC protocol implementation. It contains a structure with fields for the packet number, type of data, and stream ID, which are used to identify and manage retransmissions of data packets. The union also provides an array of unsigned long integers for alternative data access, ensuring efficient storage and retrieval of metadata associated with sent packets.


---
### fd\_quic\_pkt\_meta\_value
- **Type**: `union`
- **Members**:
    - `scalar`: Stores a single unsigned long integer value.
    - `range`: Stores a `fd_quic_range_t` structure.
- **Description**: Represents a union that can store either a scalar value or a range structure, providing flexibility in handling packet metadata values in QUIC protocol implementations.


---
### fd\_quic\_pkt\_meta\_value\_t
- **Type**: `union`
- **Members**:
    - `scalar`: A single unsigned long integer value.
    - `range`: A structure of type `fd_quic_range_t`.
- **Description**: `fd_quic_pkt_meta_value_t` is a union that can store either a single scalar value or a range structure, providing flexibility in representing packet metadata values.


---
### fd\_quic\_pkt\_meta
- **Type**: ``struct``
- **Members**:
    - `key`: Stores metadata about the packet using `fd_quic_pkt_meta_key_t`.
    - `val`: Holds additional metadata using `fd_quic_pkt_meta_value_t`.
    - `enc_level`: Indicates the encryption level with 2 bits.
    - `pn_space`: Represents the packet number space derived from `enc_level`.
    - `tx_time`: Records the transmit time of the packet.
    - `expiry`: Specifies the expiration time when an acknowledgment is expected.
    - `parent`: References the parent node in the treap structure.
    - `left`: References the left child node in the treap structure.
    - `right`: References the right child node in the treap structure.
    - `prio`: Stores the priority value for the treap node.
    - `next`: Points to the next node in the treap structure.
    - `prev`: Points to the previous node in the treap structure.
- **Description**: Tracks metadata of data sent to a peer, used to determine what is acknowledged when acknowledgments arrive. It includes fields for packet identification, encryption level, transmission and expiration times, and treap structure fields for organizing metadata in a binary search tree with heap properties.


---
### fd\_quic\_pkt\_meta\_tracker
- **Type**: ``struct``
- **Members**:
    - ``sent_pkt_metas``: An array of four `fd_quic_pkt_meta_ds_t` structures to track sent packet metadata.
    - ``pool``: A pointer to a pool of `fd_quic_pkt_meta_t` structures for managing packet metadata.
- **Description**: Manages and tracks metadata for QUIC packets, specifically for sent packets, using an array of metadata structures and a pool for dynamic allocation.


# Functions

---
### fd\_quic\_pkt\_meta\_cmp<!-- {{#callable:fd_quic_pkt_meta_cmp}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_pkt_meta.h#L90>)

Compares a packet metadata key with a packet metadata entry to determine their relative order.
- **Inputs**:
    - `q`: A `fd_quic_pkt_meta_key_t` structure representing the packet metadata key to compare.
    - `e`: A pointer to a `fd_quic_pkt_meta_t` structure representing the packet metadata entry to compare against.
- **Logic and Control Flow**:
    - Extracts the first element of the `b` array from both `q` and `e->key` into `q_b` and `e_b`, respectively.
    - Extracts the `stream_id` from both `q` and `e->key` into `q_s` and `e_s`, respectively.
    - Calculates `pkt_num_type_cmp` as -2 if `q_b` is less than `e_b`, 2 if `q_b` is greater than `e_b`, and 0 if they are equal.
    - Calculates `stream_id_cmp` as -1 if `q_s` is less than `e_s`, 1 if `q_s` is greater than `e_s`, and 0 if they are equal.
    - Returns the sum of `pkt_num_type_cmp` and `stream_id_cmp` as the comparison result.
- **Output**: An integer representing the comparison result: negative if `q` is less than `e`, positive if `q` is greater than `e`, and zero if they are equal.


---
### fd\_quic\_pkt\_meta\_lt<!-- {{#callable:fd_quic_pkt_meta_lt}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_pkt_meta.h#L108>)

Compares two `fd_quic_pkt_meta_t` structures to determine if the first is less than the second based on specific key fields.
- **Inputs**:
    - `e1`: Pointer to the first `fd_quic_pkt_meta_t` structure to compare.
    - `e2`: Pointer to the second `fd_quic_pkt_meta_t` structure to compare.
- **Logic and Control Flow**:
    - Retrieve the first element of the key (`b[0]`) from both `e1` and `e2`.
    - Compare `e1_b0` and `e2_b0`; if `e1_b0` is less than `e2_b0`, return true.
    - If `e1_b0` equals `e2_b0`, compare the `stream_id` fields of `e1` and `e2`.
    - Return true if `e1->key.stream_id` is less than `e2->key.stream_id`.
- **Output**: Returns a non-zero integer if `e1` is considered less than `e2`, otherwise returns zero.


---
### fd\_quic\_pkt\_meta\_ds\_fwd\_iter\_init<!-- {{#callable:fd_quic_pkt_meta_ds_fwd_iter_init}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_pkt_meta.h#L134>)

Initializes a forward iterator for a QUIC packet metadata data structure.
- **Inputs**:
    - `ds`: A pointer to the QUIC packet metadata data structure (`fd_quic_pkt_meta_ds_t`).
    - `pool`: A pointer to the backing pool of packet metadata (`fd_quic_pkt_meta_t`).
- **Logic and Control Flow**:
    - Calls `fd_quic_pkt_meta_treap_fwd_iter_init` with `ds` and `pool` as arguments.
    - Returns the result of `fd_quic_pkt_meta_treap_fwd_iter_init`.
- **Output**: A forward iterator for the QUIC packet metadata data structure (`fd_quic_pkt_meta_ds_fwd_iter_t`).


---
### fd\_quic\_pkt\_meta\_ds\_fwd\_iter\_ele<!-- {{#callable:fd_quic_pkt_meta_ds_fwd_iter_ele}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_pkt_meta.h#L146>)

Retrieves a packet metadata element from a forward iterator in a packet metadata pool.
- **Inputs**:
    - `iter`: A forward iterator of type `fd_quic_pkt_meta_ds_fwd_iter_t` that points to a specific position in the packet metadata data structure.
    - `pool`: A pointer to the packet metadata pool of type `fd_quic_pkt_meta_t` from which the metadata element is retrieved.
- **Logic and Control Flow**:
    - Calls the function `fd_quic_pkt_meta_treap_fwd_iter_ele` with the provided `iter` and `pool` arguments.
    - Returns the result of the `fd_quic_pkt_meta_treap_fwd_iter_ele` function call, which is a pointer to a packet metadata element.
- **Output**: A pointer to a `fd_quic_pkt_meta_t` structure, representing the packet metadata element at the current iterator position.


---
### fd\_quic\_pkt\_meta\_ds\_fwd\_iter\_next<!-- {{#callable:fd_quic_pkt_meta_ds_fwd_iter_next}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_pkt_meta.h#L158>)

Advances the forward iterator to the next element in the packet metadata data structure.
- **Inputs**:
    - `iter`: The current forward iterator of type `fd_quic_pkt_meta_ds_fwd_iter_t`.
    - `pool`: A pointer to the backing pool of type `fd_quic_pkt_meta_t`.
- **Logic and Control Flow**:
    - Calls the function `fd_quic_pkt_meta_treap_fwd_iter_next` with the current iterator and pool as arguments.
    - Returns the result of the `fd_quic_pkt_meta_treap_fwd_iter_next` function call.
- **Output**: The next forward iterator of type `fd_quic_pkt_meta_ds_fwd_iter_t`.


---
### fd\_quic\_pkt\_meta\_ds\_fwd\_iter\_done<!-- {{#callable:fd_quic_pkt_meta_ds_fwd_iter_done}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_pkt_meta.h#L169>)

Checks if a forward iterator has reached the end of a data structure.
- **Inputs**:
    - `iter`: A forward iterator of type `fd_quic_pkt_meta_ds_fwd_iter_t` that traverses the data structure.
- **Logic and Control Flow**:
    - Calls the function `fd_quic_pkt_meta_treap_fwd_iter_done` with the provided iterator `iter`.
- **Output**: Returns a non-zero value if the iterator has reached the end of the data structure, otherwise returns 0.


---
### fd\_quic\_pkt\_meta\_ds\_idx\_ge<!-- {{#callable:fd_quic_pkt_meta_ds_idx_ge}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_pkt_meta.h#L182>)

Returns an iterator pointing to the first packet metadata with a packet number greater than or equal to the specified packet number.
- **Inputs**:
    - ``ds``: A pointer to the data structure (`fd_quic_pkt_meta_ds_t`) containing packet metadata.
    - ``pkt_number``: The packet number to search for, which is masked with `FD_QUIC_PKT_META_PKT_NUM_MASK`.
    - ``pool``: A pointer to the backing pool of packet metadata (`fd_quic_pkt_meta_t`).
- **Logic and Control Flow**:
    - Masks the `pkt_number` with `FD_QUIC_PKT_META_PKT_NUM_MASK` to ensure it fits within the allowed range.
    - Creates a `fd_quic_pkt_meta_key_t` with the masked packet number, type set to 0, and stream_id set to 0.
    - Calls `fd_quic_pkt_meta_treap_idx_ge` with the data structure, the created key, and the pool to find the appropriate iterator.
- **Output**: An iterator (`fd_quic_pkt_meta_ds_fwd_iter_t`) pointing to the first packet metadata with a packet number greater than or equal to the specified `pkt_number`.


---
### fd\_quic\_pkt\_meta\_ds\_ele\_cnt<!-- {{#callable:fd_quic_pkt_meta_ds_ele_cnt}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_pkt_meta.h#L195>)

Returns the count of elements in a QUIC packet metadata data structure.
- **Inputs**:
    - `ds`: A pointer to the `fd_quic_pkt_meta_ds_t` data structure whose element count is to be determined.
- **Logic and Control Flow**:
    - Calls the function `fd_quic_pkt_meta_treap_ele_cnt` with the provided data structure `ds` as an argument.
    - Returns the result of the `fd_quic_pkt_meta_treap_ele_cnt` function call.
- **Output**: The function returns an `ulong` representing the number of elements in the specified data structure.


# Function Declarations (Public API)

---
### fd\_quic\_pkt\_meta\_ds\_init\_pool<!-- {{#callable_declaration:fd_quic_pkt_meta_ds_init_pool}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_pkt_meta.h#L213>)

Initializes a packet metadata pool for QUIC.
- **Description**: Use this function to perform any necessary setup on a pool of packet metadata structures for QUIC. This setup is essential for data structures that require specific initialization, such as treap randomness. Call this function before using the pool in any operations that involve packet metadata management.
- **Inputs**:
    - `pool`: Pointer to the packet metadata pool. Must not be null. The caller retains ownership.
    - `total_meta_cnt`: Total number of metadata entries in the pool. Must be a positive integer.
- **Output**: None
- **See Also**: [`fd_quic_pkt_meta_ds_init_pool`](<fd_quic_pkt_meta.c.md#fd_quic_pkt_meta_ds_init_pool>)  (Implementation)


---
### fd\_quic\_pkt\_meta\_tracker\_init<!-- {{#callable_declaration:fd_quic_pkt_meta_tracker_init}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_pkt_meta.h#L225>)

Initializes the metadata tracker for packet metadata management.
- **Description**: Use this function to initialize a packet metadata tracker for managing metadata across different encryption levels. This function sets up the tracker to handle a specified total number of packet metadata entries, shared across all encoding levels. It must be called before using the tracker for any metadata operations. If the initialization fails, the function returns `NULL`, indicating that the tracker is not ready for use.
- **Inputs**:
    - `tracker`: Pointer to an `fd_quic_pkt_meta_tracker_t` structure. Must not be null. The function initializes this tracker for managing packet metadata.
    - `total_meta_cnt`: Total number of maximum packet metadata entries that the tracker can handle, shared across all encoding levels. Must be a positive number.
    - `pool`: Pointer to a pool of `fd_quic_pkt_meta_t` structures. Must not be null. The function uses this pool for managing packet metadata.
- **Output**: Returns a pointer to the initialized tracker if successful, or `NULL` if initialization fails.
- **See Also**: [`fd_quic_pkt_meta_tracker_init`](<fd_quic_pkt_meta.c.md#fd_quic_pkt_meta_tracker_init>)  (Implementation)


---
### fd\_quic\_pkt\_meta\_insert<!-- {{#callable_declaration:fd_quic_pkt_meta_insert}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_pkt_meta.h#L236>)

Inserts a packet metadata entry into the data structure.
- **Description**: Use this function to add a packet metadata entry to the specified data structure. This function is typically used when tracking metadata for packets sent to a peer, allowing for efficient retrieval and management of packet information. Ensure that the packet metadata entry to be inserted is acquired from the provided pool before calling this function. The function does not handle null pointers, so all input pointers must be valid and non-null.
- **Inputs**:
    - `ds`: Pointer to the data structure where the packet metadata will be inserted. Must not be null.
    - `pkt_meta`: Pointer to the packet metadata to insert. This metadata should be acquired from the pool and must not be null.
    - `pool`: Pointer to the backing pool from which the packet metadata was acquired. Must not be null.
- **Output**: None
- **See Also**: [`fd_quic_pkt_meta_insert`](<fd_quic_pkt_meta.c.md#fd_quic_pkt_meta_insert>)  (Implementation)


---
### fd\_quic\_pkt\_meta\_remove\_range<!-- {{#callable_declaration:fd_quic_pkt_meta_remove_range}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_pkt_meta.h#L255>)

Removes packet metadata within a specified range from the data structure.
- **Description**: Use this function to remove all packet metadata entries within a specified range of packet numbers from the data structure and return them to the pool. This function is useful when you need to clear metadata for packets that are no longer needed, such as after they have been acknowledged. It skips any part of the range that is missing, ensuring that only existing entries are affected. Ensure that the data structure and pool are properly initialized before calling this function.
- **Inputs**:
    - `ds`: Pointer to the data structure from which packet metadata will be removed. Must be initialized and not null.
    - `pool`: Pointer to the backing pool where removed packet metadata will be returned. Must be initialized and not null.
    - `pkt_number_lo`: Lower bound of the packet number range. Must be less than or equal to `pkt_number_hi`.
    - `pkt_number_hi`: Upper bound of the packet number range. Must be greater than or equal to `pkt_number_lo`.
- **Output**: Returns the number of packet metadata entries removed from the data structure.
- **See Also**: [`fd_quic_pkt_meta_remove_range`](<fd_quic_pkt_meta.c.md#fd_quic_pkt_meta_remove_range>)  (Implementation)


---
### fd\_quic\_pkt\_meta\_remove<!-- {{#callable_declaration:fd_quic_pkt_meta_remove}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_pkt_meta.h#L266>)

Removes a packet metadata entry from the data structure and returns it to the pool.
- **Description**: Use this function to remove a specific packet metadata entry from the data structure and return it to the pool for reuse. This function is useful when a packet metadata entry is no longer needed, such as after processing an acknowledgment. Ensure that the `pkt_meta` parameter is not null before calling this function. The function does not handle null pointers and assumes that the provided `pkt_meta` is valid and currently part of the data structure.
- **Inputs**:
    - `ds`: Pointer to the data structure from which the packet metadata will be removed. Must not be null.
    - `pool`: Pointer to the pool from which the packet metadata was originally acquired. Must not be null.
    - `pkt_meta`: Pointer to the packet metadata to remove. Must not be null and should be a valid entry in the data structure.
- **Output**: None
- **See Also**: [`fd_quic_pkt_meta_remove`](<fd_quic_pkt_meta.c.md#fd_quic_pkt_meta_remove>)  (Implementation)


---
### fd\_quic\_pkt\_meta\_min<!-- {{#callable_declaration:fd_quic_pkt_meta_min}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_pkt_meta.h#L277>)

Finds the packet metadata with the smallest packet number.
- **Description**: Use this function to get a pointer to the packet metadata with the smallest packet number in the data structure. This function is useful when you need to process or inspect the packet with the lowest packet number. Ensure that the data structure and pool are properly initialized before calling this function. If the data structure is empty, the function returns NULL.
- **Inputs**:
    - `ds`: Pointer to the data structure (`fd_quic_pkt_meta_ds_t`) that contains the packet metadata. Must not be null.
    - `pool`: Pointer to the backing pool (`fd_quic_pkt_meta_t`). Must not be null.
- **Output**: Returns a pointer to the `fd_quic_pkt_meta_t` with the smallest packet number, or NULL if the data structure is empty.
- **See Also**: [`fd_quic_pkt_meta_min`](<fd_quic_pkt_meta.c.md#fd_quic_pkt_meta_min>)  (Implementation)


---
### fd\_quic\_pkt\_meta\_ds\_clear<!-- {{#callable_declaration:fd_quic_pkt_meta_ds_clear}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_pkt_meta.h#L285>)

Clears all packet metadata tracking for a specified encryption level.
- **Description**: Use this function to remove all packet metadata associated with a specific encryption level from the tracker. This is useful when you need to reset or reinitialize the metadata tracking for a particular encryption level. Ensure that the `tracker` is properly initialized before calling this function. The function does not return any value and does not handle invalid encryption levels explicitly, so ensure that `enc_level` is within the valid range of encryption levels used in the tracker.
- **Inputs**:
    - `tracker`: Pointer to the packet metadata tracker. Must not be null and should be properly initialized before use. Caller retains ownership.
    - `enc_level`: Unsigned integer representing the encryption level to clear. Must be within the valid range of encryption levels used in the tracker. Invalid values may lead to undefined behavior.
- **Output**: None
- **See Also**: [`fd_quic_pkt_meta_ds_clear`](<fd_quic_pkt_meta.c.md#fd_quic_pkt_meta_ds_clear>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)