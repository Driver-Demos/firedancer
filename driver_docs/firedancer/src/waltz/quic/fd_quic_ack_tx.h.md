<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

APIs for generating and managing delayed ACK packets in QUIC, including structures and functions for ACK frame creation and processing.

# Purpose
The `fd_quic_ack_tx.h` file provides APIs for generating ACK (Acknowledgment) packets in a QUIC (Quick UDP Internet Connections) protocol implementation. It defines structures and functions to manage the acknowledgment of received packets, including the generation of delayed ACKs. The file includes mechanisms to handle packet numbers, timestamps, and encryption levels, which are essential for building ACK frames. The `fd_quic_ack_t` structure is used to accumulate packet numbers that need acknowledgment, while the `fd_quic_ack_gen_t` structure manages a queue of ACK frames, ensuring that ACKs are generated only when necessary and according to specific conditions such as elicitation and instant acknowledgment requirements.

The file defines several functions and macros to facilitate the management of ACK frames. The `fd_quic_ack_gen_init` function initializes an `fd_quic_ack_gen_t` instance, while [`fd_quic_ack_pkt`](<#fd_quic_ack_pkt>) queues a processed packet for acknowledgment. The file also includes utility functions like `fd_quic_ack_queue_ele` to access elements in the ACK queue and [`fd_quic_ack_gen_abandon_enc_level`](<#fd_quic_ack_gen_abandon_enc_level>) to remove ACKs with certain encryption levels. The [`fd_quic_gen_ack_frames`](<#fd_quic_gen_ack_frames>) function writes ACK frames to a specified memory region. The file uses macros to control debugging and the number of disjoint ACK ranges, which can affect retransmission rates. Overall, this header file is part of a larger QUIC implementation, providing specific functionality for handling ACK packets.
# Imports and Dependencies

---
- `fd_quic_common.h`


# Data Structures

---
### fd\_quic\_ack
- **Type**: ``struct``
- **Members**:
    - `pkt_number`: Range of packet numbers being acknowledged.
    - `ts`: Timestamp of the highest packet number.
    - `enc_level`: Encryption level, with a value in the range [0,4).
    - `_pad`: Padding to align the structure to 32 bytes.
- **Description**: The `fd_quic_ack` structure is used to build an ACK frame in the QUIC protocol. It contains a range of packet numbers that are being acknowledged, a timestamp for the highest packet number, and an encryption level indicator. The structure is aligned to 16 bytes and includes padding to ensure a total size of 32 bytes.


---
### fd\_quic\_ack\_t
- **Type**: ``struct fd_quic_ack``
- **Members**:
    - ``pkt_number``: Range of packet numbers being acknowledged.
    - ``ts``: Timestamp of the highest packet number.
    - ``enc_level``: Encryption level in the range [0,4).
    - ``_pad``: Padding to align the structure to 32 bytes.
- **Description**: Used to build an ACK frame, `fd_quic_ack_t` contains a contiguous range of packet numbers to acknowledge. It accumulates packet numbers whenever an `fd_quic_t` instance successfully processes a packet.


---
### fd\_quic\_ack\_gen
- **Type**: ``struct``
- **Members**:
    - `queue`: An array of `fd_quic_ack_t` structures that stores ACK frames.
    - `head`: An unsigned integer that indicates the next unused sequence number in the queue.
    - `tail`: An unsigned integer that indicates the sequence number of the oldest unsent ACK frame.
    - `is_elicited`: An unsigned character that indicates if at least one ACK-eliciting frame was received.
- **Description**: Records processed packet numbers and builds ACK frames for QUIC protocol. The `queue` stores ACK frames, while `head` and `tail` manage the sequence numbers for the ACK frames in the queue. `is_elicited` determines if ACK frames should be generated based on received ACK-eliciting frames.


---
### fd\_quic\_ack\_gen\_t
- **Type**: ``struct``
- **Members**:
    - `queue`: An array of `fd_quic_ack_t` structures that stores ACK frames.
    - `head`: An unsigned integer representing the next unused sequence number in the ACK queue.
    - `tail`: An unsigned integer representing the sequence number of the oldest unsent ACK frame.
    - `is_elicited`: An unsigned character indicating if at least one ACK-eliciting frame was received.
- **Description**: Records processed packet numbers and builds ACK frames for the QUIC protocol. It maintains a queue of ACK frames, tracks the sequence numbers of the frames, and determines if an ACK frame should be generated based on whether an ACK-eliciting frame was received. The structure ensures that all elements in the ACK queue are initialized, even if they are not currently in use.


# Function Declarations (Public API)

---
### fd\_quic\_ack\_pkt<!-- {{#callable_declaration:fd_quic_ack_pkt}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_ack_tx.h#L85>)

Queues a processed packet for acknowledgement.
- **Description**: Use this function to queue a packet for acknowledgement after it has been processed. This function attempts to merge the packet number into the most recent ACK if possible, or starts a new ACK if merging is not feasible. It must be called with a valid packet number and encryption level. The function handles cases where the packet number is unused or when the ACK queue is full, returning specific status codes for these scenarios.
- **Inputs**:
    - `gen`: A pointer to an `fd_quic_ack_gen_t` structure that records processed packet numbers and builds ACK frames. Must not be null.
    - `pkt_number`: The packet number to be acknowledged. Must not be equal to `FD_QUIC_PKT_NUM_UNUSED`.
    - `enc_level`: The encryption level of the packet, which must be in the range [0, 4).
    - `now`: The current timestamp, used to update the timestamp of the highest packet number in the ACK.
- **Output**: Returns an integer status code indicating the result of the operation: `FD_QUIC_ACK_TX_NOOP` if the packet number is unused, `FD_QUIC_ACK_TX_MERGED` if the packet number was merged into an existing ACK, `FD_QUIC_ACK_TX_NEW` if a new ACK was started, or `FD_QUIC_ACK_TX_ENOSPC` if the ACK queue is full.
- **See Also**: [`fd_quic_ack_pkt`](<fd_quic_ack_tx.c.md#fd_quic_ack_pkt>)  (Implementation)


---
### fd\_quic\_ack\_gen\_abandon\_enc\_level<!-- {{#callable_declaration:fd_quic_ack_gen_abandon_enc_level}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_ack_tx.h#L110>)

Removes queued ACKs with an encryption level equal to or lower than a specified level.
- **Description**: Use this function to discard acknowledgment packets from the queue that have an encryption level less than or equal to the specified level. This is useful when you want to clear outdated or unnecessary ACKs from the queue. Ensure that the `fd_quic_ack_gen_t` instance is properly initialized before calling this function. The function iterates through the queue and updates the tail pointer to exclude the discarded ACKs.
- **Inputs**:
    - `gen`: A pointer to an `fd_quic_ack_gen_t` structure. This must not be null and should be initialized before use. The function modifies the internal state of this structure.
    - `enc_level`: An unsigned integer representing the encryption level. Valid values are typically in the range [0, 4). ACKs with an encryption level less than or equal to this value will be removed from the queue.
- **Output**: None
- **See Also**: [`fd_quic_ack_gen_abandon_enc_level`](<fd_quic_ack_tx.c.md#fd_quic_ack_gen_abandon_enc_level>)  (Implementation)


---
### fd\_quic\_gen\_ack\_frames<!-- {{#callable_declaration:fd_quic_gen_ack_frames}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_ack_tx.h#L118>)

Writes ACK frames to a specified memory region.
- **Description**: Use this function to generate and write acknowledgment (ACK) frames into a specified memory buffer. It is necessary to call this function when there are ACK-eliciting packets pending acknowledgment. The function will not generate any ACK frames if no such packets are pending, preventing unnecessary ACK loops. Ensure that the encryption level matches the ACKs to be generated. The function handles the writing of ACK frames up to the available buffer space and returns a pointer to the position after the last written byte.
- **Inputs**:
    - `gen`: A pointer to an `fd_quic_ack_gen_t` structure that contains the state and queue of ACKs to be processed. Must not be null.
    - `payload_ptr`: A pointer to the start of the memory region where ACK frames will be written. Must not be null and should point to a valid memory region.
    - `payload_end`: A pointer to the end of the memory region where ACK frames can be written. Must not be null and should be greater than or equal to `payload_ptr`.
    - `enc_level`: An unsigned integer representing the encryption level for the ACKs. Only ACKs with this encryption level will be processed.
    - `now`: A long integer representing the current time in nanoseconds, used to calculate the delay for the ACK frames.
- **Output**: Returns a pointer to the position in the buffer immediately after the last byte written. If no ACK frames are written, it returns the original `payload_ptr`.
- **See Also**: [`fd_quic_gen_ack_frames`](<fd_quic_ack_tx.c.md#fd_quic_gen_ack_frames>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)