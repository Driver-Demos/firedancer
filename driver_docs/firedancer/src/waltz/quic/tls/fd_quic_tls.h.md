<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines an API for managing QUIC-TLS handshakes, including configuration, creation, and data processing.

# Purpose
The code defines a C header file that provides an API for managing QUIC-TLS operations. It includes structures, function prototypes, and macros necessary for handling the TLS handshake process within the QUIC protocol. The file outlines the setup and management of QUIC-TLS configurations and objects, including the creation and deletion of handshake objects. It specifies callback functions for handling secrets, handshake completion, and peer parameters, which are essential for the TLS handshake process.

Key components include the `fd_quic_tls_cfg` structure for configuring QUIC-TLS settings, the `fd_quic_tls` structure for managing TLS operations, and the `fd_quic_tls_hs` structure for organizing handshake data. The file also defines several functions for creating and deleting QUIC-TLS and handshake objects, processing TLS handshake messages, and managing handshake data queues. The header file is intended to be included in other C source files to provide the necessary functionality for QUIC-TLS operations, making it a critical part of a larger system that implements the QUIC protocol with TLS security.
# Imports and Dependencies

---
- `../fd_quic_common.h`
- `../fd_quic_enum.h`
- `../../tls/fd_tls.h`
- `../templ/fd_quic_transport_params.h`


# Data Structures

---
### fd\_quic\_tls\_secret
- **Type**: ``struct``
- **Members**:
    - ``enc_level``: Stores the encryption level as an unsigned integer.
    - ``read_secret``: An array of unsigned characters that holds the read secret.
    - ``write_secret``: An array of unsigned characters that holds the write secret.
- **Description**: Defines a structure for managing TLS secrets in a QUIC protocol context, including encryption level and secrets for reading and writing.


---
### fd\_quic\_tls\_cfg
- **Type**: ``struct``
- **Members**:
    - `secret_cb`: Callback function for handling secrets during the TLS handshake.
    - `handshake_complete_cb`: Callback function called when the TLS handshake is complete.
    - `peer_params_cb`: Callback function for handling peer parameters.
    - `max_concur_handshakes`: Maximum number of concurrent handshakes that can be managed.
    - `signer`: Signing callback for TLS 1.3 CertificateVerify, with a context that must outlive the TLS object.
    - `cert_public_key`: Pointer to the Ed25519 public key.
- **Description**: Defines the configuration for QUIC-TLS, including callback functions for handling secrets, handshake completion, and peer parameters, as well as settings for managing concurrent handshakes and signing operations.


---
### fd\_quic\_tls\_hs\_data
- **Type**: ``struct``
- **Members**:
    - `data`: Pointer to the handshake data.
    - `data_sz`: Size of the handshake data.
    - `free_data_sz`: Size of the free data for internal use.
    - `offset`: Offset for the data.
    - `enc_level`: Encryption level of the data.
    - `next_idx`: Index of the next element in the linked list, `~0` indicates the end.
- **Description**: Organizes handshake data for QUIC-TLS operations, managing data pointers, sizes, offsets, encryption levels, and linked list indexing for efficient data handling during the TLS handshake process.


---
### fd\_quic\_tls
- **Type**: ``struct``
- **Members**:
    - `secret_cb`: Callback function for handling secrets during the TLS handshake.
    - `handshake_complete_cb`: Callback function that is called when the TLS handshake is complete.
    - `peer_params_cb`: Callback function for handling peer parameters.
    - `tls`: Holds the TLS context and state information.
- **Description**: Manages the TLS handshake process for QUIC connections, including handling secrets, handshake completion, and peer parameters through callback functions, while maintaining the necessary TLS state.


---
### fd\_quic\_tls\_hs
- **Type**: ``struct``
- **Members**:
    - `hs`: Contains TLS handshake handles for type punning between `fd_quic_tls_hs_t` and `fd_tls_estate_{srv,cli}_t`.
    - `quic_tls`: Pointer to the `fd_quic_tls_t` structure managing the handshake.
    - `is_server`: Indicates if the handshake is for a server (1) or client (0).
    - `is_hs_complete`: Indicates if the handshake is complete (1) or not (0).
    - `context`: User-defined context supplied in callbacks.
    - `next`: Index for the next element in the allocation pool/cache doubly linked list.
    - `prev`: Index for the previous element in the cache doubly linked list.
    - `birthtime`: Time of allocation, used for cache eviction sanity check.
    - `hs_data`: Array of `fd_quic_tls_hs_data_t` structures containing handshake data to be sent to the peer.
    - `hs_data_free_idx`: Index of the head of the free list for `hs_data`.
    - `hs_data_pend_idx`: Array of indices for the head of pending `hs_data` to be sent, one per encryption level.
    - `hs_data_pend_end_idx`: Array of indices for the tail of pending `hs_data` to be sent, one per encryption level.
    - `hs_data_buf`: Buffer for handshake data, shared between encryption levels.
    - `hs_data_buf_ptr`: Pointer to the first unused byte in `hs_data_buf`.
    - `hs_data_offset`: Array of offsets for each encoding level in `hs_data_buf`.
    - `rx_off`: Number of bytes processed by `fd_tls` in the receive buffer.
    - `rx_sz`: Number of contiguous bytes received from the peer in the receive buffer.
    - `rx_enc_level`: Encryption level of the messages in the receive buffer.
    - `rx_hs_buf`: Buffer for received handshake messages of one encryption level.
    - `alert`: TLS alert code.
    - `self_transport_params`: QUIC transport parameters for the local endpoint.
- **Description**: Manages the state and data for a QUIC-TLS handshake, including TLS handshake handles, pointers to the QUIC-TLS manager, server/client role indicators, user context, and various buffers and indices for managing handshake data and messages. It supports type punning for server and client handshake objects and maintains a list of handshake data to be sent, as well as buffers for received messages and transport parameters.


# Function Declarations (Public API)

---
### fd\_quic\_tls\_new<!-- {{#callable_declaration:fd_quic_tls_new}} -->
[View Source →](<../../../../../../src/waltz/quic/tls/fd_quic_tls.h#L181>)

Formats memory for use as a QUIC-TLS object.
- **Description**: Use this function to initialize a memory region as a `fd_quic_tls_t` object, which manages QUIC-TLS handshakes. Ensure that both `self` and `cfg` are not null before calling this function. The configuration must include valid callback functions for handling secrets, handshake completion, and peer parameters. This function must be called before using the `fd_quic_tls_t` object for any operations.
- **Inputs**:
    - `self`: A pointer to a memory region to format as a `fd_quic_tls_t` object. Must not be null. The caller retains ownership.
    - `cfg`: A pointer to a `fd_quic_tls_cfg_t` structure containing configuration settings and callback functions. Must not be null and must include valid callbacks for `secret_cb`, `handshake_complete_cb`, and `peer_params_cb`. The caller retains ownership.
- **Output**: Returns a pointer to the initialized `fd_quic_tls_t` object on success, or null if any input is invalid.
- **See Also**: [`fd_quic_tls_new`](<fd_quic_tls.c.md#fd_quic_tls_new>)  (Implementation)


---
### fd\_quic\_tls\_delete<!-- {{#callable_declaration:fd_quic_tls_delete}} -->
[View Source →](<../../../../../../src/waltz/quic/tls/fd_quic_tls.h#L189>)

Unformats a memory region used as a QUIC-TLS object.
- **Description**: Use this function to delete a QUIC-TLS object when it is no longer needed. It unformats the memory region used by the QUIC-TLS object and returns the pointer to the caller. This function must be called with a valid pointer to a `fd_quic_tls_t` object. If the input pointer is null, the function logs a warning and returns null. This function does not delete any associated resources beyond the QUIC-TLS object itself.
- **Inputs**:
    - `self`: A pointer to the `fd_quic_tls_t` object to delete. Must not be null. If null, the function logs a warning and returns null.
- **Output**: Returns the input pointer on success, or null if the input pointer is null.
- **See Also**: [`fd_quic_tls_delete`](<fd_quic_tls.c.md#fd_quic_tls_delete>)  (Implementation)


---
### fd\_quic\_tls\_hs\_new<!-- {{#callable_declaration:fd_quic_tls_hs_new}} -->
[View Source →](<../../../../../../src/waltz/quic/tls/fd_quic_tls.h#L192>)

Initializes a QUIC-TLS handshake object.
- **Description**: Use this function to initialize a QUIC-TLS handshake object for managing a new connection's TLS handshake. This function sets up the necessary properties and data structures for the handshake process. It must be called with a valid `fd_quic_tls_hs_t` object and a `fd_quic_tls_t` object. The function can configure the handshake as either a client or a server based on the `is_server` parameter. Ensure that the `self_transport_params` is correctly set to define the transport parameters for the handshake. The `now` parameter records the current time for internal use. This function returns the initialized handshake object or handles errors internally.
- **Inputs**:
    - `self`: A pointer to an `fd_quic_tls_hs_t` object to initialize. Must not be null.
    - `quic_tls`: A pointer to an `fd_quic_tls_t` object that manages the handshake. Must not be null.
    - `context`: A user-defined context pointer for use in callbacks. Can be null.
    - `is_server`: An integer indicating if the handshake is for a server (non-zero) or a client (zero).
    - `self_transport_params`: A pointer to a `fd_quic_transport_params_t` structure containing the transport parameters. Must not be null.
    - `now`: A long integer representing the current time, used for internal timing purposes.
- **Output**: Returns a pointer to the initialized `fd_quic_tls_hs_t` object.
- **See Also**: [`fd_quic_tls_hs_new`](<fd_quic_tls.c.md#fd_quic_tls_hs_new>)  (Implementation)


---
### fd\_quic\_tls\_hs\_delete<!-- {{#callable_declaration:fd_quic_tls_hs_delete}} -->
[View Source →](<../../../../../../src/waltz/quic/tls/fd_quic_tls.h#L200>)

Deletes a QUIC-TLS handshake object.
- **Description**: Use this function to delete a QUIC-TLS handshake object when it is no longer needed. This function safely handles null pointers, so it is safe to call with a null argument. It determines whether the handshake object is for a server or a client and deletes the appropriate resources accordingly. Ensure that the handshake object is not in use before calling this function to avoid undefined behavior.
- **Inputs**:
    - `hs`: A pointer to the `fd_quic_tls_hs_t` object to delete. It can be null, in which case the function does nothing. The caller retains ownership and must ensure the object is not in use elsewhere.
- **Output**: None
- **See Also**: [`fd_quic_tls_hs_delete`](<fd_quic_tls.c.md#fd_quic_tls_hs_delete>)  (Implementation)


---
### fd\_quic\_tls\_process<!-- {{#callable_declaration:fd_quic_tls_process}} -->
[View Source →](<../../../../../../src/waltz/quic/tls/fd_quic_tls.h#L209>)

Processes available TLS handshake messages.
- **Description**: Use this function to process any available TLS handshake messages from previously received CRYPTO frames. It should be called when there is a need to handle incoming handshake data. The function returns a success status if it processes any number of messages, including when there is insufficient data to process a message. It returns a failure status if the TLS handshake fails irrecoverably. Ensure that the handshake object is in a valid state before calling this function.
- **Inputs**:
    - `self`: A pointer to an `fd_quic_tls_hs_t` structure representing the handshake state. This parameter must not be null. The function expects the handshake object to be properly initialized and in a valid state for processing.
- **Output**: Returns `FD_QUIC_SUCCESS` if messages are processed successfully or if there is insufficient data to process a message. Returns `FD_QUIC_FAILED` if the TLS handshake fails irrecoverably.
- **See Also**: [`fd_quic_tls_process`](<fd_quic_tls.c.md#fd_quic_tls_process>)  (Implementation)


---
### fd\_quic\_tls\_get\_hs\_data<!-- {{#callable_declaration:fd_quic_tls_get_hs_data}} -->
[View Source →](<../../../../../../src/waltz/quic/tls/fd_quic_tls.h#L230>)

Retrieve the oldest queued handshake data for a given encryption level.
- **Description**: Use this function to get the oldest handshake data that is queued for sending to a peer at a specified encryption level. This function is useful when you need to process or send pending handshake data. It must be called with a valid handshake object. If the handshake object is null or there is no data available for the specified encryption level, the function returns null. The returned data becomes invalid if `fd_quic_tls_pop_hs_data` or `fd_quic_tls_hs_delete` is called.
- **Inputs**:
    - `self`: A pointer to the `fd_quic_tls_hs_t` handshake object. Must not be null to retrieve data.
    - `enc_level`: An unsigned integer representing the encryption level. Must be within the valid range of encryption levels used in the handshake process.
- **Output**: A pointer to the `fd_quic_tls_hs_data_t` structure containing the handshake data, or null if no data is available.
- **See Also**: [`fd_quic_tls_get_hs_data`](<fd_quic_tls.c.md#fd_quic_tls_get_hs_data>)  (Implementation)


---
### fd\_quic\_tls\_get\_next\_hs\_data<!-- {{#callable_declaration:fd_quic_tls_get_next_hs_data}} -->
[View Source →](<../../../../../../src/waltz/quic/tls/fd_quic_tls.h#L239>)

Retrieve the next unit of handshake data from the queue.
- **Description**: Use this function to obtain the next available handshake data unit from the queue associated with a given handshake object. This function is useful when iterating through queued handshake data. It returns a pointer to the next `fd_quic_tls_hs_data_t` structure or `NULL` if no more data is available. Ensure that the `hs` parameter is valid and represents a current handshake data unit.
- **Inputs**:
    - `self`: A pointer to an `fd_quic_tls_hs_t` structure representing the handshake. This parameter must not be null.
    - `hs`: A pointer to an `fd_quic_tls_hs_data_t` structure representing the current handshake data unit. This parameter must not be null and should point to a valid data unit in the queue.
- **Output**: Returns a pointer to the next `fd_quic_tls_hs_data_t` structure in the queue, or `NULL` if no more data is available.
- **See Also**: [`fd_quic_tls_get_next_hs_data`](<fd_quic_tls.c.md#fd_quic_tls_get_next_hs_data>)  (Implementation)


---
### fd\_quic\_tls\_pop\_hs\_data<!-- {{#callable_declaration:fd_quic_tls_pop_hs_data}} -->
[View Source →](<../../../../../../src/waltz/quic/tls/fd_quic_tls.h#L246>)

Remove handshake data from the head of the queue.
- **Description**: Use this function to remove the oldest handshake data from the queue for a specified encryption level. This function is typically called after processing or sending the handshake data to ensure that the queue remains up-to-date. It is important to ensure that the `self` parameter is not null and that the `enc_level` is within the valid range of encryption levels. If the queue is empty, the function does nothing.
- **Inputs**:
    - `self`: A pointer to the `fd_quic_tls_hs_t` structure representing the handshake. Must not be null.
    - `enc_level`: An unsigned integer representing the encryption level. Must be within the valid range of encryption levels.
- **Output**: None
- **See Also**: [`fd_quic_tls_pop_hs_data`](<fd_quic_tls.c.md#fd_quic_tls_pop_hs_data>)  (Implementation)


---
### fd\_quic\_tls\_clear\_hs\_data<!-- {{#callable_declaration:fd_quic_tls_clear_hs_data}} -->
[View Source →](<../../../../../../src/waltz/quic/tls/fd_quic_tls.h#L253>)

Clear all handshake data for a specified encryption level.
- **Description**: Use this function to reset the handshake data indices for a specific encryption level within a QUIC-TLS handshake object. This is typically necessary when you want to discard any pending handshake data associated with that encryption level. Ensure that the `self` parameter is a valid pointer to a `fd_quic_tls_hs_t` object and that `enc_level` is within the valid range of encryption levels supported by the system.
- **Inputs**:
    - `self`: A pointer to a `fd_quic_tls_hs_t` object representing the handshake state. Must not be null.
    - `enc_level`: An unsigned integer representing the encryption level. Must be within the valid range of encryption levels.
- **Output**: None
- **See Also**: [`fd_quic_tls_clear_hs_data`](<fd_quic_tls.c.md#fd_quic_tls_clear_hs_data>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)