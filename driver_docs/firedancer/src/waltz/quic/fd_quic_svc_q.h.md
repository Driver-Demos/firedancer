<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines data structures and functions for managing QUIC service queues and connection timers.

# Purpose
The code is a C header file that defines structures and functions for managing service queues and timers in a QUIC (Quick UDP Internet Connections) protocol implementation. It provides a mechanism to handle connection timeouts and scheduling within a QUIC service. The file defines several constants, types, and structures, such as `fd_quic_svc_queue_t`, `fd_quic_svc_timers_conn_meta_t`, and `fd_quic_svc_event_t`, which are used to manage and track the state of connections and their associated timers.

The header file also declares functions for initializing and managing these timers, such as [`fd_quic_svc_timers_init`](<#fd_quic_svc_timers_init>), [`fd_quic_svc_timers_schedule`](<#fd_quic_svc_timers_schedule>), and [`fd_quic_svc_timers_cancel`](<#fd_quic_svc_timers_cancel>). These functions allow for the scheduling, validation, and cancellation of connection timers, as well as querying the next event in the queue. The file is intended to be included in other C source files that require these functionalities, and it defines a public API for interacting with the service queue and timer system in a QUIC context.
# Imports and Dependencies

---
- `fd_quic_common.h`


# Data Structures

---
### fd\_quic\_svc\_queue
- **Type**: ``struct``
- **Members**:
    - `cnt`: Stores the count of elements in the queue.
    - `head`: Indicates the index of the first element in the queue.
    - `tail`: Indicates the index of the last element in the queue.
- **Description**: Manages a double-linked list (dlist) queue structure for service events, tracking the number of elements and the positions of the head and tail within the queue.


---
### fd\_quic\_svc\_queue\_t
- **Type**: ``struct``
- **Members**:
    - `cnt`: Stores the count of elements in the queue.
    - `head`: Stores the index of the first element in the queue.
    - `tail`: Stores the index of the last element in the queue.
- **Description**: A `fd_quic_svc_queue_t` is a doubly linked list (`dlist`) structure used to manage a queue of service elements. It maintains the count of elements and the indices of the head and tail of the queue, facilitating operations on the queue such as insertion and removal of elements.


---
### fd\_quic\_svc\_timers\_conn\_meta
- **Type**: ``struct``
- **Members**:
    - ``next_timeout``: Indicates the next timeout for the connection.
    - ``private``: Contains a union for managing connection indices and a service type identifier.
    - ``prq_idx``: Holds the index in the priority queue, valid only when not equal to `IDX_INVALID`.
    - ``dlist``: Contains indices for the next and previous connections in a doubly linked list.
    - ``svc_type``: Specifies the service type using `FD_QUIC_SVC_*` constants.
- **Description**: Manages metadata for connection timers in a QUIC service, including timeout scheduling and connection indexing for priority queues and doubly linked lists.


---
### fd\_quic\_svc\_timers\_conn\_meta\_t
- **Type**: ``struct``
- **Members**:
    - ``next_timeout``: Indicates the next timeout for the connection.
    - ``private.prq_idx``: Stores the index in the priority queue when not invalid.
    - ``private.dlist.next``: Points to the next connection in the doubly linked list.
    - ``private.dlist.prev``: Points to the previous connection in the doubly linked list.
    - ``private.svc_type``: Specifies the service type using `FD_QUIC_SVC_*` constants.
- **Description**: Manages metadata for connection timers, including the next timeout and service queue indices, to facilitate scheduling and management of connection events in a QUIC service.


---
### fd\_quic\_svc\_event
- **Type**: ``struct``
- **Members**:
    - `timeout`: Specifies the timeout value for the event.
    - `conn`: Points to a `fd_quic_conn_t` structure representing the connection associated with the event.
- **Description**: The `fd_quic_svc_event` structure is used to represent an event in the QUIC service queue, containing a timeout value and a pointer to the associated connection. It is part of the service queue mechanism for managing connection events in a QUIC implementation.


---
### fd\_quic\_svc\_event\_t
- **Type**: ``struct fd_quic_svc_event``
- **Members**:
    - `timeout`: Specifies the timeout value for the event.
    - `conn`: Points to a `fd_quic_conn_t` structure associated with the event.
- **Description**: Stores information about a QUIC service event, including a timeout value and a pointer to the associated connection.


---
### fd\_quic\_svc\_timers
- **Type**: ``struct``
- **Members**:
    - `prq`: Pointer to a priority queue for dynamic timers.
    - `instant`: Instant queue implemented as a doubly linked list (dlist).
    - `state`: Pointer to the state structure.
- **Description**: Manages service timers for QUIC connections, using a priority queue for dynamic timers and a doubly linked list for instant timers, while maintaining a reference to the current state.


---
### fd\_quic\_svc\_timers\_t
- **Type**: ``struct``
- **Members**:
    - `prq`: A pointer to a priority queue for DYNAMIC timers.
    - `instant`: A `fd_quic_svc_queue_t` structure representing the INSTANT queue (dlist).
    - `state`: A pointer to `fd_quic_state_t` representing the state.
- **Description**: Manages service timers for QUIC connections, organizing them into priority and instant queues, and maintaining a state reference.


# Function Declarations (Public API)

---
### fd\_quic\_svc\_timers\_footprint<!-- {{#callable_declaration:fd_quic_svc_timers_footprint}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_svc_q.h#L57>)

Calculates the memory footprint for service timers.
- **Description**: Use this function to determine the amount of memory required to store service timers for a given maximum number of connections. This is useful for allocating the correct amount of memory before initializing the service timers. Ensure that the `max_conn` parameter accurately reflects the maximum number of connections you plan to support, as this will directly affect the calculated footprint.
- **Inputs**:
    - `max_conn`: Specifies the maximum number of connections to support. Must be a positive integer. If an invalid value is provided, the behavior is undefined.
- **Output**: Returns the memory footprint in bytes required for the service timers.
- **See Also**: [`fd_quic_svc_timers_footprint`](<fd_quic_svc_q.c.md#fd_quic_svc_timers_footprint>)  (Implementation)


---
### fd\_quic\_svc\_timers\_align<!-- {{#callable_declaration:fd_quic_svc_timers_align}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_svc_q.h#L61>)

Returns the alignment requirement for service timers.
- **Description**: Use this function to obtain the alignment requirement for the `fd_quic_svc_timers_t` structure. This is necessary when allocating memory for service timers to ensure proper alignment. Call this function before initializing or using service timers to determine the correct alignment boundary.
- **Inputs**: None
- **Output**: The function returns an `ulong` representing the alignment requirement for the service timers.
- **See Also**: [`fd_quic_svc_timers_align`](<fd_quic_svc_q.c.md#fd_quic_svc_timers_align>)  (Implementation)


---
### fd\_quic\_svc\_timers\_init<!-- {{#callable_declaration:fd_quic_svc_timers_init}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_svc_q.h#L69>)

Initializes a service timer structure for QUIC connections.
- **Description**: Use this function to initialize a service timer structure that manages timers for QUIC connections. The function requires a memory block that is properly aligned and large enough to accommodate the timer structure. The maximum number of connections that the timers can support must be specified. The function also requires a pointer to a QUIC state structure, which it will retain a read interest in throughout its lifetime. Ensure that the memory block is aligned according to the alignment requirements of the timer structure. If the memory is null or misaligned, the function will return null and log an error.
- **Inputs**:
    - `mem`: A pointer to a memory block that must be aligned according to `fd_quic_svc_timers_align()`. The memory block must not be null. The caller retains ownership.
    - `max_conn`: The maximum number of connections the timers can support. Must be a positive integer.
    - `state`: A pointer to a `fd_quic_state_t` structure. The function retains a read interest in this state throughout the lifetime of the timers.
- **Output**: Returns a pointer to an initialized `fd_quic_svc_timers_t` structure, or null if initialization fails due to null or misaligned memory.
- **See Also**: [`fd_quic_svc_timers_init`](<fd_quic_svc_q.c.md#fd_quic_svc_timers_init>)  (Implementation)


---
### fd\_quic\_svc\_timers\_init\_conn<!-- {{#callable_declaration:fd_quic_svc_timers_init_conn}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_svc_q.h#L75>)

Initializes the connection metadata for service timers.
- **Description**: Use this function to set up the service timer metadata for a connection. It prepares the connection's metadata by setting the next timeout to the maximum possible value and marking the connection as not currently in any priority queue. This function must be called before scheduling any timers for the connection to ensure that the metadata is correctly initialized.
- **Inputs**:
    - `conn`: A pointer to an `fd_quic_conn_t` structure representing the connection. Must not be null. The function initializes the service timer metadata within this structure.
- **Output**: None
- **See Also**: [`fd_quic_svc_timers_init_conn`](<fd_quic_svc_q.c.md#fd_quic_svc_timers_init_conn>)  (Implementation)


---
### fd\_quic\_svc\_timers\_schedule<!-- {{#callable_declaration:fd_quic_svc_timers_schedule}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_svc_q.h#L86>)

Schedules a connection timer based on its next timeout.
- **Description**: Use this function to schedule a timer for a connection using its `next_timeout` value. The function must be called with a valid connection and a monotonic `now` value. If the connection is null or invalid, the function will not schedule a timer. A connection that is already scheduled can only be rescheduled for an earlier time, not later. The function retains a read interest in the connection until it is removed from the queue.
- **Inputs**:
    - `timers`: A pointer to an `fd_quic_svc_timers_t` structure that manages the service queues. Must not be null.
    - `conn`: A pointer to an `fd_quic_conn_t` structure representing the connection to schedule. Must not be null and must not be in an invalid state.
    - `now`: A long integer representing the current time. Must be monotonic across all service calls.
- **Output**: None
- **See Also**: [`fd_quic_svc_timers_schedule`](<fd_quic_svc_q.c.md#fd_quic_svc_timers_schedule>)  (Implementation)


---
### fd\_quic\_svc\_timers\_validate<!-- {{#callable_declaration:fd_quic_svc_timers_validate}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_svc_q.h#L94>)

Checks if events and connections are correctly linked.
- **Description**: Use this function to verify the integrity of the service timers by ensuring that events and connections are correctly linked to each other. This function is useful for debugging and validation purposes. It checks that connections in the dynamic queue have matching indices and types, ensures that connections are not duplicated in the queue, and verifies that connections not in any queue have an invalid index. Call this function when you need to confirm that the service timers are in a consistent state.
- **Inputs**:
    - `timers`: A pointer to an `fd_quic_svc_timers_t` structure. Must not be null. Represents the service timers to validate.
    - `quic`: A pointer to an `fd_quic_t` structure. Must not be null. Represents the QUIC state associated with the timers.
- **Output**: Returns 1 if the validation is successful, indicating that the events and connections are correctly linked. Returns 0 if any inconsistency is found.
- **See Also**: [`fd_quic_svc_timers_validate`](<fd_quic_svc_q.c.md#fd_quic_svc_timers_validate>)  (Implementation)


---
### fd\_quic\_svc\_timers\_cancel<!-- {{#callable_declaration:fd_quic_svc_timers_cancel}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_svc_q.h#L99>)

Removes a connection from the service queue.
- **Description**: Use this function to remove a connection from the service queue when it is no longer needed or when its timer should be canceled. This function must be called with a valid `fd_quic_svc_timers_t` and `fd_quic_conn_t` that have been properly initialized. It handles both instant and dynamic service types by removing the connection from the appropriate queue and reinitializing the connection's metadata. Ensure that the connection is part of the service queue before calling this function to avoid undefined behavior.
- **Inputs**:
    - `timers`: A pointer to an `fd_quic_svc_timers_t` structure. Must not be null and should be initialized before use. The caller retains ownership.
    - `conn`: A pointer to an `fd_quic_conn_t` structure representing the connection to be removed. Must not be null and should be part of the service queue. The caller retains ownership.
- **Output**: None
- **See Also**: [`fd_quic_svc_timers_cancel`](<fd_quic_svc_q.c.md#fd_quic_svc_timers_cancel>)  (Implementation)


---
### fd\_quic\_svc\_timers\_next<!-- {{#callable_declaration:fd_quic_svc_timers_next}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_svc_q.h#L110>)

Returns the next scheduled event from the service timers.
- **Description**: Use this function to retrieve the next event from the service timers, which can be either an INSTANT or DYNAMIC event. If the 'pop' parameter is true and the event is due, the function removes the event from the queue and resets its timeout. If the event is not due and 'pop' is true, the function returns an event with a NULL connection. The function assumes that the 'now' parameter is monotonic across all service timer calls.
- **Inputs**:
    - `timers`: A pointer to an `fd_quic_svc_timers_t` structure that holds the service timers. Must not be null.
    - `now`: A long integer representing the current time. Must be monotonic across all service timer calls.
    - `pop`: An integer flag indicating whether to remove the event from the queue if it is due. Non-zero values indicate true, and zero indicates false.
- **Output**: Returns an `fd_quic_svc_event_t` structure containing the next event. If no event is due or the queue is empty, the connection in the returned event is NULL.
- **See Also**: [`fd_quic_svc_timers_next`](<fd_quic_svc_q.c.md#fd_quic_svc_timers_next>)  (Implementation)


---
### fd\_quic\_svc\_timers\_get\_event<!-- {{#callable_declaration:fd_quic_svc_timers_get_event}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_svc_q.h#L118>)

Retrieves the service event for a specified connection.
- **Description**: Use this function to obtain the service event associated with a specific connection. It determines the event based on the service type of the connection, which can be either 'instant' or 'dynamic'. If the service type is 'instant', the event is set to occur immediately. If the service type is 'dynamic', the event is retrieved from a priority queue. If the connection does not match any known service type, the function returns an event with a null connection and a timeout set to the maximum possible value. Ensure that the 'now' parameter is monotonic across all calls to this function.
- **Inputs**:
    - `timers`: A pointer to an `fd_quic_svc_timers_t` structure. This must not be null and should be properly initialized before calling this function.
    - `conn`: A pointer to an `fd_quic_conn_t` structure representing the connection for which the event is to be retrieved. This must not be null.
    - `now`: A long integer representing the current time. This value should be monotonic across all service timer calls.
- **Output**: Returns an `fd_quic_svc_event_t` structure containing the event details for the specified connection. If the connection is not found or does not match a known service type, the returned event will have a null connection and a timeout set to `LONG_MAX`.
- **See Also**: [`fd_quic_svc_timers_get_event`](<fd_quic_svc_q.c.md#fd_quic_svc_timers_get_event>)  (Implementation)


---
### fd\_quic\_svc\_timers\_cnt\_events<!-- {{#callable_declaration:fd_quic_svc_timers_cnt_events}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic_svc_q.h#L126>)

Returns the number of connections with active timers.
- **Description**: Use this function to get the count of connections that currently have active timers in the service queue. This is primarily useful for testing and validation purposes. Ensure that the `timers` structure is properly initialized before calling this function.
- **Inputs**:
    - `timers`: A pointer to an `fd_quic_svc_timers_t` structure. This must be a valid and initialized pointer. The function does not modify the `timers` structure.
- **Output**: The function returns an `ulong` representing the number of connections with active timers.
- **See Also**: [`fd_quic_svc_timers_cnt_events`](<fd_quic_svc_q.c.md#fd_quic_svc_timers_cnt_events>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)