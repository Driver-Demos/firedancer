<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implementation of the QUIC protocol, including connection management, packet processing, and cryptographic operations.

# Purpose
The code is a C implementation of a QUIC (Quick UDP Internet Connections) protocol stack. It provides a comprehensive set of functionalities for managing QUIC connections, including connection setup, packet processing, encryption, and stream management. The code is structured to handle both client and server roles, supporting the full lifecycle of a QUIC connection from handshake to data transmission and connection teardown.

Key components include:
- **Connection Management**: Functions like [`fd_quic_connect`](<#fd_quic_connect>) and [`fd_quic_conn_create`](<#fd_quic_conn_create>) handle the creation and initialization of QUIC connections, setting up necessary parameters and state.
- **Packet Processing**: The code includes functions to process incoming QUIC packets ([`fd_quic_process_packet`](<#fd_quic_process_packet>)), handle different packet types (e.g., Initial, Handshake, 1-RTT), and manage retransmissions and acknowledgments.
- **Encryption and Security**: The code integrates TLS for secure key exchange and uses cryptographic functions to encrypt and decrypt QUIC packets.
- **Stream Management**: It manages data streams over QUIC connections, handling flow control and stream state transitions.
- **Service and Scheduling**: The code includes mechanisms for scheduling connection servicing and handling timeouts, ensuring efficient resource management and connection reliability.

Overall, the code is designed to be a complete implementation of the QUIC protocol, providing the necessary infrastructure for high-performance, secure, and reliable data transmission over UDP.
# Imports and Dependencies

---
- `fd_quic.h`
- `fd_quic_ack_tx.h`
- `fd_quic_common.h`
- `fd_quic_conn_id.h`
- `fd_quic_enum.h`
- `fd_quic_private.h`
- `fd_quic_conn.h`
- `fd_quic_conn_map.h`
- `fd_quic_proto.h`
- `fd_quic_proto.c`
- `fd_quic_retry.h`
- `fd_quic_svc_q.h`
- `templ/fd_quic_frame_handler_decl.h`
- `templ/fd_quic_frames_templ.h`
- `templ/fd_quic_undefs.h`
- `fd_quic_pretty_print.c`
- `crypto/fd_quic_crypto_suites.h`
- `templ/fd_quic_transport_params.h`
- `templ/fd_quic_parse_util.h`
- `tls/fd_quic_tls.h`
- `fcntl.h`
- `unistd.h`
- `../../ballet/hex/fd_hex.h`
- `../../tango/tempo/fd_tempo.h`
- `../../util/log/fd_dtrace.h`
- `../../disco/metrics/generated/fd_metrics_enums.h`
- `../../util/tmpl/fd_map_dynamic.c`
- `templ/fd_quic_frame.c`


# Global Variables

---
### fd\_quic\_handle\_padding\_frame
- **Type**: `ulong`
- **Description**: The `fd_quic_handle_padding_frame` function processes padding frames in a QUIC packet. Padding frames are used to increase the size of a packet without adding any additional data.
- **Use**: Processes padding frames in QUIC packets to handle them appropriately.


# Functions

---
### fd\_quic\_align<!-- {{#callable:fd_quic_align}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L56>)

Aligns memory for QUIC structures.
- **Inputs**: None
- **Logic and Control Flow**:
    - The function directly returns the value of the macro `FD_QUIC_ALIGN`.
- **Output**: Returns the alignment value defined by `FD_QUIC_ALIGN`.


---
### fd\_quic\_footprint\_ext<!-- {{#callable:fd_quic_footprint_ext}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L63>)

Calculates the memory footprint required for a QUIC connection layout based on specified limits.
- **Inputs**:
    - `limits`: Pointer to a `fd_quic_limits_t` structure that defines the limits for the QUIC connection.
    - `layout`: Pointer to a `fd_quic_layout_t` structure where the calculated layout offsets will be stored.
- **Logic and Control Flow**:
    - Initializes the `layout` structure to zero using `memset`.
    - Checks if `limits` is NULL; if so, returns 0.
    - Extracts various limit values from the `limits` structure.
    - Performs checks on the limits to ensure they are valid; returns 0 if any checks fail.
    - Calculates the memory offsets for various components of the QUIC connection layout.
    - Updates the `layout` structure with calculated offsets.
    - Returns the total calculated footprint size.
- **Output**: Returns the total size in bytes required for the QUIC connection layout, or 0 if an error occurs.
- **Functions Called**:
    - [`fd_quic_conn_align`](<fd_quic_conn.c.md#fd_quic_conn_align>)
    - [`fd_quic_conn_footprint`](<fd_quic_conn.c.md#fd_quic_conn_footprint>)
    - [`fd_quic_stream_pool_align`](<fd_quic_stream_pool.h.md#fd_quic_stream_pool_align>)
    - [`fd_quic_stream_pool_footprint`](<fd_quic_stream_pool.c.md#fd_quic_stream_pool_footprint>)
    - [`fd_quic_log_buf_align`](<log/fd_quic_log.c.md#fd_quic_log_buf_align>)
    - [`fd_quic_log_buf_footprint`](<log/fd_quic_log.c.md#fd_quic_log_buf_footprint>)
    - [`fd_quic_svc_timers_align`](<fd_quic_svc_q.c.md#fd_quic_svc_timers_align>)
    - [`fd_quic_svc_timers_footprint`](<fd_quic_svc_q.c.md#fd_quic_svc_timers_footprint>)


---
### fd\_quic\_footprint<!-- {{#callable:fd_quic_footprint}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L162>)

Calculates the memory footprint required for QUIC connections based on specified limits.
- **Inputs**:
    - `limits`: Pointer to a `fd_quic_limits_t` structure that defines the limits for QUIC connections.
- **Logic and Control Flow**:
    - Declares a local variable `layout` of type `fd_quic_layout_t`.
    - Calls [`fd_quic_footprint_ext`](<#fd_quic_footprint_ext>) with `limits` and the address of `layout` to compute the memory footprint.
    - Returns the result from [`fd_quic_footprint_ext`](<#fd_quic_footprint_ext>).
- **Output**: Returns the calculated memory footprint as an unsigned long integer.
- **Functions Called**:
    - [`fd_quic_footprint_ext`](<#fd_quic_footprint_ext>)


---
### fd\_quic\_new<!-- {{#callable:fd_quic_new}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L168>)

Creates a new `fd_quic_t` instance in the provided memory region with specified limits.
- **Inputs**:
    - `mem`: Pointer to a memory region where the `fd_quic_t` instance will be allocated.
    - `limits`: Pointer to a `fd_quic_limits_t` structure that defines the limits for the QUIC instance.
- **Logic and Control Flow**:
    - Check if `mem` is NULL; if so, log a warning and return NULL.
    - Check if `mem` is aligned according to the required alignment; if not, log a warning and return NULL.
    - Check if `limits` is NULL; if so, log a warning and return NULL.
    - Validate the values in `limits`; if any are invalid, log a warning and return NULL.
    - Calculate the footprint required for the `fd_quic_t` instance and its components using [`fd_quic_footprint_ext`](<#fd_quic_footprint_ext>).
    - If the footprint is invalid, log a warning and return NULL.
    - Clear the memory region for the `fd_quic_t` instance.
    - Set default configuration values for the `fd_quic_t` instance.
    - Copy the provided `limits` and calculated layout into the `fd_quic_t` instance.
    - Initialize the log buffer for the QUIC instance.
    - Set a magic number to validate the instance later.
    - Return a pointer to the newly created `fd_quic_t` instance.
- **Output**: Returns a pointer to the newly created `fd_quic_t` instance, or NULL if an error occurs.
- **Functions Called**:
    - [`fd_quic_align`](<#fd_quic_align>)
    - [`fd_quic_footprint_ext`](<#fd_quic_footprint_ext>)
    - [`fd_quic_log_buf_new`](<log/fd_quic_log.c.md#fd_quic_log_buf_new>)


---
### fd\_quic\_set\_aio\_net\_tx<!-- {{#callable:fd_quic_set_aio_net_tx}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L286>)

Sets the asynchronous input/output (AIO) transmission function for a QUIC connection.
- **Inputs**:
    - `quic`: A pointer to the `fd_quic_t` structure representing the QUIC connection.
    - `aio_tx`: A pointer to a constant `fd_aio_t` structure that contains the AIO transmission function.
- **Logic and Control Flow**:
    - Checks if the `aio_tx` pointer is not null.
    - If `aio_tx` is not null, it assigns the value pointed to by `aio_tx` to the `aio_tx` member of the `quic` structure.
    - If `aio_tx` is null, it clears the `aio_tx` member of the `quic` structure by setting it to zero.
- **Output**: The function does not return a value.


---
### fd\_quic\_stream\_init<!-- {{#callable:fd_quic_stream_init}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L298>)

Initializes a `fd_quic_stream_t` structure by setting its fields to default values.
- **Inputs**:
    - `stream`: A pointer to a `fd_quic_stream_t` structure that will be initialized.
- **Logic and Control Flow**:
    - Sets the `context` field of the `stream` to NULL.
    - Initializes the `tx_buf` head and tail to 0.
    - Sets the `tx_sent` field to 0.
    - Initializes the `stream_flags` field to 0.
    - Sets the `state` field to 0.
    - Initializes the `tx_max_stream_data`, `tx_tot_data`, and `rx_tot_data` fields to 0.
    - Sets the `upd_pkt_number` field to 0.
- **Output**: The function does not return a value. It initializes the fields of the provided `fd_quic_stream_t` structure.


---
### fd\_quic\_join<!-- {{#callable:fd_quic_join}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L319>)

Joins a QUIC connection by validating the provided shared QUIC structure.
- **Inputs**:
    - `shquic`: A pointer to a shared QUIC structure that is to be joined.
- **Logic and Control Flow**:
    - Check if `shquic` is NULL; if so, log a warning and return NULL.
    - Check if `shquic` is misaligned; if so, log a warning and return NULL.
    - Cast `shquic` to `fd_quic_t*` and check if the magic number is valid; if not, log a warning and return NULL.
    - Return the valid `fd_quic_t*` pointer.
- **Output**: Returns a pointer to a valid `fd_quic_t` structure if successful, otherwise returns NULL.


---
### fd\_quic\_leave<!-- {{#callable:fd_quic_leave}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L340>)

Returns the pointer to the `fd_quic_t` structure.
- **Inputs**:
    - `quic`: A pointer to the `fd_quic_t` structure.
- **Logic and Control Flow**:
    - The function takes a pointer to a `fd_quic_t` structure as input.
    - It directly returns the input pointer cast to a `void *` type.
- **Output**: Returns a pointer to the `fd_quic_t` structure as a `void *`.


---
### fd\_quic\_init<!-- {{#callable:fd_quic_init}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L345>)

Initializes a `fd_quic_t` structure for QUIC protocol operation.
- **Inputs**:
    - `quic`: Pointer to a `fd_quic_t` structure that holds the QUIC configuration and state.
- **Logic and Control Flow**:
    - Checks if the `role`, `idle_timeout`, `ack_delay`, and `retry_ttl` fields in the `config` are set; if not, logs a warning and returns NULL.
    - Validates the `identity_public_key` in the `config` to ensure it is set.
    - Determines the role of the connection (server or client) and logs a warning if the server role has unsupported keep-alive settings.
    - Sets the `ack_threshold` to a default value if it is not set.
    - Calculates the memory layout for the QUIC structure and checks for memory corruption.
    - Resets the state of the QUIC connection.
    - Initializes the packet metadata pool and connection ID map.
    - Sets up the service timers and checks the asynchronous I/O for transmission.
    - Initializes the TLS configuration and handshake pool.
    - Generates secure random numbers for retry token generation.
    - Sets up transport parameters based on the configuration.
- **Output**: Returns a pointer to the initialized `fd_quic_t` structure, or NULL if initialization fails.
- **Functions Called**:
    - [`fd_quic_footprint_ext`](<#fd_quic_footprint_ext>)
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_pkt_meta_ds_init_pool`](<fd_quic_pkt_meta.c.md#fd_quic_pkt_meta_ds_init_pool>)
    - [`fd_quic_conn_new`](<fd_quic_conn.c.md#fd_quic_conn_new>)
    - [`fd_quic_svc_timers_init`](<fd_quic_svc_q.c.md#fd_quic_svc_timers_init>)
    - [`fd_quic_tls_new`](<tls/fd_quic_tls.c.md#fd_quic_tls_new>)
    - [`fd_quic_stream_pool_new`](<fd_quic_stream_pool.c.md#fd_quic_stream_pool_new>)


---
### fd\_quic\_enc\_level\_to\_pn\_space<!-- {{#callable:fd_quic_enc_level_to_pn_space}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L561>)

Maps encryption levels to packet number spaces.
- **Inputs**:
    - `enc_level`: An unsigned integer representing the encryption level.
- **Logic and Control Flow**:
    - Checks if `enc_level` is greater than or equal to 4U and logs an error if true.
    - Returns the corresponding packet number space from the static mapping array `el2pn_map` based on `enc_level`.
- **Output**: Returns an unsigned integer representing the packet number space corresponding to the given encryption level.


---
### fd\_quic\_svc\_prep\_schedule<!-- {{#callable:fd_quic_svc_prep_schedule}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L608>)

Sets `conn->svc_meta.next_timeout` to the minimum of the current timeout and the provided expiry time.
- **Inputs**:
    - `conn`: Pointer to a `fd_quic_conn_t` structure representing the QUIC connection.
    - `expiry`: A long integer representing the expiry time to compare against the current timeout.
- **Logic and Control Flow**:
    - The function retrieves the current timeout from `conn->svc_meta.next_timeout`.
    - It then compares this value with the provided `expiry` argument.
    - The minimum of the two values is assigned back to `conn->svc_meta.next_timeout`.
- **Output**: The function does not return a value; it modifies the `next_timeout` field of the `svc_meta` structure within the `conn` object.


---
### fd\_quic\_svc\_prep\_schedule\_now<!-- {{#callable:fd_quic_svc_prep_schedule_now}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L616>)

Sets the connection's next timeout to the current time.
- **Inputs**:
    - `conn`: Pointer to a `fd_quic_conn_t` structure representing the QUIC connection.
- **Logic and Control Flow**:
    - Retrieve the current state of the QUIC connection using [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>).
    - Call [`fd_quic_svc_prep_schedule`](<#fd_quic_svc_prep_schedule>) with the current time to set the next timeout.
- **Output**: This function does not return a value.
- **Functions Called**:
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_svc_prep_schedule`](<#fd_quic_svc_prep_schedule>)


---
### fd\_quic\_svc\_schedule1<!-- {{#callable:fd_quic_svc_schedule1}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L623>)

Schedules service timers for a QUIC connection.
- **Inputs**:
    - `conn`: Pointer to a `fd_quic_conn_t` structure representing the QUIC connection.
- **Logic and Control Flow**:
    - Retrieve the state of the QUIC connection using [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>).
    - Call [`fd_quic_svc_timers_schedule`](<fd_quic_svc_q.c.md#fd_quic_svc_timers_schedule>) with the service timers, connection, and current time.
- **Output**: The function does not return a value; it schedules timers for the specified connection.
- **Functions Called**:
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_svc_timers_schedule`](<fd_quic_svc_q.c.md#fd_quic_svc_timers_schedule>)


---
### svc\_cnt\_eq\_alloc\_conn<!-- {{#callable:svc_cnt_eq_alloc_conn}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L630>)

Validates the number of connections allocated against the number of events in the timer.
- **Inputs**:
    - `timers`: Pointer to a `fd_quic_svc_timers_t` structure that holds the service timers.
    - `quic`: Pointer to a `fd_quic_t` structure that contains metrics related to the QUIC connection.
- **Logic and Control Flow**:
    - Calls [`fd_quic_svc_timers_cnt_events`](<fd_quic_svc_q.c.md#fd_quic_svc_timers_cnt_events>) to get the count of events in the timer.
    - Retrieves the connection allocation count from `quic->metrics.conn_alloc_cnt`.
    - Checks if the event count does not match the connection count.
    - If they do not match, logs a critical error message with the counts.
- **Output**: The function does not return a value; it logs a critical error if the counts do not match.
- **Functions Called**:
    - [`fd_quic_svc_timers_cnt_events`](<fd_quic_svc_q.c.md#fd_quic_svc_timers_cnt_events>)


---
### fd\_quic\_conn\_free\_validate<!-- {{#callable:fd_quic_conn_free_validate}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L640>)

Validates the free connection list in a QUIC state by checking the state of each connection in the free list and ensuring that invalid connections are marked as visited.
- **Inputs**:
    - `quic`: Pointer to a `fd_quic_t` structure representing the QUIC state.
- **Logic and Control Flow**:
    - Fetches the current state of the QUIC connection using [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>).
    - Initializes the visited state for connections using [`fd_quic_conn_validate_init`](<fd_quic_conn.c.md#fd_quic_conn_validate_init>).
    - Iterates through the free connection list, checking each connection's state and marking it as visited.
    - Validates that the number of visited connections does not exceed the total connection count.
    - Checks that each connection's index matches its expected value and that invalid connections are marked as visited.
- **Output**: No output is returned; the function performs validation checks and may trigger assertions if any checks fail.
- **Functions Called**:
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_conn_validate_init`](<fd_quic_conn.c.md#fd_quic_conn_validate_init>)
    - [`fd_quic_conn_at_idx`](<fd_quic_private.h.md#fd_quic_conn_at_idx>)


---
### fd\_quic\_state\_validate<!-- {{#callable:fd_quic_state_validate}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L670>)

Validates the state of a QUIC connection.
- **Inputs**:
    - `quic`: Pointer to a `fd_quic_t` structure representing the QUIC connection.
- **Logic and Control Flow**:
    - Retrieve the current state of the QUIC connection using [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>).
    - Initialize the visited state for connection validation using [`fd_quic_conn_validate_init`](<fd_quic_conn.c.md#fd_quic_conn_validate_init>).
    - Validate the service timers associated with the connection using [`fd_quic_svc_timers_validate`](<fd_quic_svc_q.c.md#fd_quic_svc_timers_validate>).
    - Validate the free connection list using [`fd_quic_conn_free_validate`](<#fd_quic_conn_free_validate>).
- **Output**: The function does not return a value but performs validation checks on the QUIC connection state.
- **Functions Called**:
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_conn_validate_init`](<fd_quic_conn.c.md#fd_quic_conn_validate_init>)
    - [`fd_quic_svc_timers_validate`](<fd_quic_svc_q.c.md#fd_quic_svc_timers_validate>)
    - [`fd_quic_conn_free_validate`](<#fd_quic_conn_free_validate>)


---
### fd\_quic\_log\_conn\_hdr<!-- {{#callable:fd_quic_log_conn_hdr}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L683>)

Creates a log header for a QUIC connection.
- **Inputs**:
    - `conn`: Pointer to a constant `fd_quic_conn_t` structure representing the QUIC connection.
- **Logic and Control Flow**:
    - Initializes a `fd_quic_log_hdr_t` structure named `hdr`.
    - Sets the `conn_id` field of `hdr` to the `our_conn_id` of the provided connection.
    - Sets the `flags` field of `hdr` to 0.
    - Returns the initialized `hdr` structure.
- **Output**: Returns a `fd_quic_log_hdr_t` structure containing the connection ID and flags.


---
### fd\_quic\_log\_full\_hdr<!-- {{#callable:fd_quic_log_full_hdr}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L692>)

Constructs a `fd_quic_log_hdr_t` structure with details from a QUIC connection and packet.
- **Inputs**:
    - `conn`: Pointer to a constant `fd_quic_conn_t` structure representing the QUIC connection.
    - `pkt`: Pointer to a constant `fd_quic_pkt_t` structure representing the QUIC packet.
- **Logic and Control Flow**:
    - Initializes a `fd_quic_log_hdr_t` structure named `hdr`.
    - Sets the `conn_id` field of `hdr` to the `our_conn_id` from the `conn` structure.
    - Sets the `pkt_num` field of `hdr` to the `pkt_number` from the `pkt` structure.
    - Sets the `ip4_saddr` field of `hdr` to the source address from the `ip4` field of `pkt`.
    - Sets the `udp_sport` field of `hdr` to the source port from the `udp` field of `pkt`.
    - Sets the `enc_level` field of `hdr` to the encryption level from the `pkt` structure.
    - Sets the `flags` field of `hdr` to 0.
    - Returns the constructed `hdr` structure.
- **Output**: Returns a `fd_quic_log_hdr_t` structure containing connection and packet information.


---
### fd\_quic\_set\_conn\_state<!-- {{#callable:fd_quic_set_conn_state}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L706>)

Sets the connection state for a QUIC connection and updates the metrics accordingly.
- **Inputs**:
    - `conn`: Pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
    - `state`: The new state to set for the connection, represented as a `uint`.
- **Logic and Control Flow**:
    - Calls `FD_COMPILER_MFENCE()` to ensure memory operations are completed before proceeding.
    - Stores the current state of the connection in `old_state`.
    - Decrements the count of the old state in `conn->quic->metrics.conn_state_cnt`.
    - Increments the count of the new state in `conn->quic->metrics.conn_state_cnt`.
    - Updates the connection's state to the new value.
    - Calls `FD_COMPILER_MFENCE()` again to ensure memory operations are completed after the state change.
- **Output**: The function does not return a value; it modifies the state of the connection and updates metrics.


---
### fd\_quic\_conn\_error1<!-- {{#callable:fd_quic_conn_error1}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L724>)

Sets the connection state to aborted and schedules it for servicing.
- **Inputs**:
    - `conn`: Pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
    - `reason`: An unsigned integer representing the reason for the connection error.
- **Logic and Control Flow**:
    - Checks if `conn` is NULL or if its state is `FD_QUIC_CONN_STATE_DEAD`. If either condition is true, the function returns immediately.
    - Calls [`fd_quic_set_conn_state`](<#fd_quic_set_conn_state>) to change the connection state to `FD_QUIC_CONN_STATE_ABORT`.
    - Sets the `reason` field of the connection to the provided `reason` argument.
    - Calls [`fd_quic_svc_prep_schedule_now`](<#fd_quic_svc_prep_schedule_now>) to prepare the connection for immediate servicing.
    - Calls [`fd_quic_svc_schedule1`](<#fd_quic_svc_schedule1>) to schedule the servicing of the connection.
- **Output**: The function does not return a value; it modifies the state of the connection and schedules it for servicing.
- **Functions Called**:
    - [`fd_quic_set_conn_state`](<#fd_quic_set_conn_state>)
    - [`fd_quic_svc_prep_schedule_now`](<#fd_quic_svc_prep_schedule_now>)
    - [`fd_quic_svc_schedule1`](<#fd_quic_svc_schedule1>)


---
### fd\_quic\_conn\_error<!-- {{#callable:fd_quic_conn_error}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L737>)

Sets the connection state to aborted and logs the error.
- **Inputs**:
    - `conn`: Pointer to the `fd_quic_conn_t` structure representing the connection.
    - `reason`: An unsigned integer representing the QUIC error code.
    - `error_line`: An unsigned integer indicating the line number in the source code where the error occurred.
- **Logic and Control Flow**:
    - Calls [`fd_quic_conn_error1`](<#fd_quic_conn_error1>) to set the connection state to aborted and prepare it for servicing.
    - Retrieves the current state of the QUIC connection using [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>).
    - Logs the error by preparing a log frame with the connection header, error code, source file, and line number.
    - Submits the log frame using [`fd_quic_log_tx_submit`](<log/fd_quic_log_tx.h.md#fd_quic_log_tx_submit>).
- **Output**: This function does not return a value.
- **Functions Called**:
    - [`fd_quic_conn_error1`](<#fd_quic_conn_error1>)
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_log_sig`](<log/fd_quic_log_tx.h.md#fd_quic_log_sig>)
    - [`fd_quic_log_tx_prepare`](<log/fd_quic_log_tx.h.md#fd_quic_log_tx_prepare>)
    - [`fd_quic_log_conn_hdr`](<#fd_quic_log_conn_hdr>)
    - [`fd_quic_log_tx_submit`](<log/fd_quic_log_tx.h.md#fd_quic_log_tx_submit>)


---
### fd\_quic\_frame\_error<!-- {{#callable:fd_quic_frame_error}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L756>)

Handles QUIC frame errors by logging the error and updating the connection state.
- **Inputs**:
    - `ctx`: Pointer to the context of the QUIC frame.
    - `reason`: Error reason code as defined in the QUIC protocol.
    - `error_line`: Line number in the source code where the error occurred.
- **Logic and Control Flow**:
    - Retrieve the QUIC connection and packet from the context.
    - Call [`fd_quic_conn_error1`](<#fd_quic_conn_error1>) to update the connection state to aborted with the provided reason.
    - Check if the connection has a TLS handshake state and retrieve the TLS reason if available.
    - Prepare a log entry for the error with details including the connection header, error codes, source file, and line number.
    - Submit the log entry to the logging system.
- **Output**: This function does not return a value; it performs logging and updates the connection state.
- **Functions Called**:
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_conn_error1`](<#fd_quic_conn_error1>)
    - [`fd_quic_log_sig`](<log/fd_quic_log_tx.h.md#fd_quic_log_sig>)
    - [`fd_quic_log_tx_prepare`](<log/fd_quic_log_tx.h.md#fd_quic_log_tx_prepare>)
    - [`fd_quic_log_full_hdr`](<#fd_quic_log_full_hdr>)
    - [`fd_quic_log_tx_submit`](<log/fd_quic_log_tx.h.md#fd_quic_log_tx_submit>)


---
### fd\_quic\_tx\_enc\_level<!-- {{#callable:fd_quic_tx_enc_level}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L783>)

Returns the encryption level to use for the next QUIC packet.
- **Inputs**:
    - `conn`: Pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
    - `acks`: Integer indicating whether to check for acknowledgments.
- **Logic and Control Flow**:
    - Initialize `enc_level` to an invalid value.
    - Determine the application packet number space using [`fd_quic_enc_level_to_pn_space`](<#fd_quic_enc_level_to_pn_space>).
    - Check the connection state using a switch statement.
    - If the connection is dead, return an invalid value.
    - If the connection is aborting or closing, check if the handshake is complete and return the appropriate encryption level.
    - If the connection is active, check for stream data to send.
    - If there are acknowledgments, return the encryption level of the oldest unacknowledged packet.
    - Check for handshake data to send and return the corresponding encryption level.
    - If no conditions are met, return an invalid value.
- **Output**: Returns the encryption level to use for the next packet, or ~0u if there is nothing to send.
- **Functions Called**:
    - [`fd_quic_enc_level_to_pn_space`](<#fd_quic_enc_level_to_pn_space>)
    - [`fd_quic_tls_get_hs_data`](<tls/fd_quic_tls.c.md#fd_quic_tls_get_hs_data>)
    - [`fd_quic_tls_get_next_hs_data`](<tls/fd_quic_tls.c.md#fd_quic_tls_get_next_hs_data>)


---
### fd\_quic\_handle\_v1\_frame<!-- {{#callable:fd_quic_handle_v1_frame}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L895>)

Processes a QUIC v1 frame.
- **Inputs**:
    - `quic`: Pointer to the `fd_quic_t` structure representing the QUIC instance.
    - `conn`: Pointer to the `fd_quic_conn_t` structure representing the connection.
    - `pkt`: Pointer to the `fd_quic_pkt_t` structure representing the packet.
    - `pkt_type`: An unsigned integer representing the type of the packet.
    - `buf`: Pointer to a buffer containing the frame data.
    - `buf_sz`: An unsigned long representing the size of the buffer.
- **Logic and Control Flow**:
    - Check if the connection state is `FD_QUIC_CONN_STATE_DEAD`, return `FD_QUIC_PARSE_FAIL` if true.
    - Check if the buffer size is less than 1, return `FD_QUIC_PARSE_FAIL` if true.
    - Extract the frame ID from the first byte of the buffer.
    - Probe for frame handling metrics.
    - Create a frame context with the provided `quic`, `conn`, and `pkt`.
    - Check if the frame type is allowed for the given packet type, log an error and return `FD_QUIC_PARSE_FAIL` if not.
    - Increment the frame reception count in metrics.
    - Set the acknowledgment flag in the packet based on the frame type.
    - Use a switch statement to handle the frame based on its ID, calling the appropriate frame interpretation function.
    - Handle unexpected frame types by logging an error and returning `FD_QUIC_PARSE_FAIL`.
- **Output**: Returns the number of bytes consumed from the buffer, or `FD_QUIC_PARSE_FAIL` on error.
- **Functions Called**:
    - [`fd_quic_frame_type_allowed`](<templ/fd_quic_frame.h.md#fd_quic_frame_type_allowed>)
    - [`fd_quic_frame_error`](<#fd_quic_frame_error>)


---
### fd\_quic\_fini<!-- {{#callable:fd_quic_fini}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L939>)

Cleans up and deallocates resources associated with a `fd_quic_t` instance.
- **Inputs**:
    - `quic`: Pointer to a `fd_quic_t` structure that represents the QUIC connection to be finalized.
- **Logic and Control Flow**:
    - Check if the `quic` pointer is NULL; if so, log a warning and return NULL.
    - Derive the memory layout of the QUIC instance using [`fd_quic_footprint_ext`](<#fd_quic_footprint_ext>).
    - Obtain the current state of the QUIC instance using [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>).
    - Iterate over the connections and free each connection if it is in a valid state.
    - Deinitialize the TLS resources associated with the QUIC instance.
    - Delete the connection ID map associated with the QUIC instance.
    - Clear the memory regions associated with the QUIC state.
- **Output**: Returns a pointer to the `fd_quic_t` instance that was finalized.
- **Functions Called**:
    - [`fd_quic_footprint_ext`](<#fd_quic_footprint_ext>)
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_conn_free`](<#fd_quic_conn_free>)
    - [`fd_quic_tls_delete`](<tls/fd_quic_tls.c.md#fd_quic_tls_delete>)


---
### fd\_quic\_delete<!-- {{#callable:fd_quic_delete}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L983>)

Deletes a `fd_quic_t` instance and cleans up associated resources.
- **Inputs**:
    - `quic`: A pointer to the `fd_quic_t` instance to be deleted.
- **Logic and Control Flow**:
    - Check if `quic` is NULL; if so, log a warning and return NULL.
    - Check if `quic` is misaligned; if so, log a warning and return NULL.
    - Check if the `magic` value of `quic` is valid; if not, log a warning and return NULL.
    - Calculate the address of the shared log buffer using `quic->layout.log_off`.
    - Attempt to delete the log buffer using [`fd_quic_log_buf_delete`](<log/fd_quic_log.c.md#fd_quic_log_buf_delete>); if it fails, log a warning and return NULL.
    - Use memory fences to ensure visibility of changes to `quic->magic`.
    - Set `quic->magic` to 0 to mark it as deleted.
    - Return the pointer to the deleted `quic` instance.
- **Output**: Returns a pointer to the deleted `fd_quic_t` instance, or NULL if an error occurred.
- **Functions Called**:
    - [`fd_quic_align`](<#fd_quic_align>)
    - [`fd_quic_log_buf_delete`](<log/fd_quic_log.c.md#fd_quic_log_buf_delete>)


---
### fd\_quic\_conn\_new\_stream<!-- {{#callable:fd_quic_conn_new_stream}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L1014>)

Creates a new QUIC stream for a given connection.
- **Inputs**:
    - `conn`: Pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
- **Logic and Control Flow**:
    - Check if the `stream_map` of the connection is NULL, indicating a receive-only configuration, and return NULL if true.
    - Retrieve the `quic` instance and its state from the connection.
    - Check if the `stream_pool` is NULL, returning NULL if it is.
    - Get the next stream ID from the connection.
    - Check if the connection is active and if the next stream ID exceeds the peer's stream ID limit, returning NULL if either condition fails.
    - Allocate a new stream from the `stream_pool`.
    - If allocation fails, return NULL.
    - Insert the new stream into the `stream_map` using the next stream ID.
    - If insertion fails, free the allocated stream and return NULL.
    - Initialize the stream and set its properties, including the connection reference and stream ID.
    - Update the connection's next stream ID.
    - Increment the metrics for opened and active streams.
    - Return the newly created stream.
- **Output**: Returns a pointer to the newly created `fd_quic_stream_t` structure, or NULL if the stream could not be created.
- **Functions Called**:
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_stream_pool_alloc`](<fd_quic_stream_pool.c.md#fd_quic_stream_pool_alloc>)
    - [`fd_quic_stream_pool_free`](<fd_quic_stream_pool.c.md#fd_quic_stream_pool_free>)
    - [`fd_quic_stream_init`](<#fd_quic_stream_init>)


---
### fd\_quic\_stream\_send<!-- {{#callable:fd_quic_stream_send}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L1095>)

Sends data over a QUIC stream.
- **Inputs**:
    - `stream`: Pointer to the `fd_quic_stream_t` structure representing the stream to send data on.
    - `data`: Pointer to the data to be sent.
    - `data_sz`: Size of the data to be sent in bytes.
    - `fin`: Flag indicating if this is the final data for the stream.
- **Logic and Control Flow**:
    - Check if the stream is already in a finished state; if so, return an error.
    - Retrieve the connection associated with the stream.
    - Check if the stream ID is valid for the connection; if not, return an error.
    - Verify that the connection is in an active state; if not, return an error.
    - Calculate the allowed data size for the stream and connection.
    - Check if there is enough space in the transmission buffer; if not, return an error.
    - Check if the data size exceeds the allowed limits; if so, return an error.
    - Store the data in the transmission buffer without moving the head offset.
    - Advance the head of the transmission buffer by the size of the data sent.
    - Update the total transmitted data size for the stream and connection.
    - Insert the stream into the send list if it is not already present.
    - Set the unsent flag for the stream and schedule the transmission.
    - If the fin flag is set, mark the stream as finished.
    - Schedule the send operation.
- **Output**: Returns `FD_QUIC_SUCCESS` on successful data transmission or an error code on failure.
- **Functions Called**:
    - [`fd_quic_buffer_store`](<fd_quic_stream.c.md#fd_quic_buffer_store>)
    - [`fd_quic_stream_fin`](<#fd_quic_stream_fin>)
    - [`fd_quic_svc_prep_schedule_now`](<#fd_quic_svc_prep_schedule_now>)
    - [`fd_quic_svc_schedule1`](<#fd_quic_svc_schedule1>)


---
### fd\_quic\_stream\_fin<!-- {{#callable:fd_quic_stream_fin}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L1171>)

Processes the finalization of a QUIC stream.
- **Inputs**:
    - `stream`: Pointer to the `fd_quic_stream_t` structure representing the QUIC stream to finalize.
- **Logic and Control Flow**:
    - Checks if the stream is already finalized by verifying the `FD_QUIC_STREAM_STATE_TX_FIN` flag in the stream's state.
    - If not finalized, retrieves the associated connection from the stream.
    - Inserts the stream into the send list if it is not already in action.
    - Updates the stream's flags and state to indicate that it has been finalized.
    - Sets the packet number to be sent in the next packet.
- **Output**: The function does not return a value.


---
### fd\_quic\_conn\_set\_rx\_max\_data<!-- {{#callable:fd_quic_conn_set_rx_max_data}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L1191>)

Sets the maximum amount of data that can be received by a QUIC connection.
- **Inputs**:
    - `conn`: Pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
    - `rx_max_data`: The new maximum amount of data that can be received, represented as an unsigned long.
- **Logic and Control Flow**:
    - Checks if the new `rx_max_data` is greater than the current maximum and less than the maximum allowed value.
    - If the conditions are met, updates the `rx_max_data` in the connection's state.
    - Sets a flag indicating that the maximum data has changed.
    - Updates the packet number to indicate a pending update.
    - Schedules the connection for immediate servicing.
- **Output**: The function does not return a value; it modifies the state of the connection.
- **Functions Called**:
    - [`fd_quic_svc_prep_schedule_now`](<#fd_quic_svc_prep_schedule_now>)
    - [`fd_quic_svc_schedule1`](<#fd_quic_svc_schedule1>)


---
### fd\_quic\_reclaim\_pkt\_meta\_level<!-- {{#callable:fd_quic_reclaim_pkt_meta_level}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L1245>)

Reclaims and frees all packet metadata associated with a specified encryption level.
- **Inputs**:
    - `conn`: Pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
    - `enc_level`: The encryption level as a `uint` indicating which packet metadata to reclaim.
- **Logic and Control Flow**:
    - Accesses the `pkt_meta_tracker` from the `conn` structure to get the `sent_pkt_metas` for the specified `enc_level`.
    - Iterates through the packet metadata using a forward iterator initialized with the `sent` metadata.
    - For each packet metadata element, calls [`fd_quic_reclaim_pkt_meta`](<#fd_quic_reclaim_pkt_meta>) to reclaim the metadata.
    - After processing all elements, calls [`fd_quic_conn_free_pkt_meta`](<#fd_quic_conn_free_pkt_meta>) to free the metadata associated with the specified `enc_level`.
- **Output**: Returns the number of packet metadata elements that were reclaimed and freed.
- **Functions Called**:
    - [`fd_quic_pkt_meta_ds_fwd_iter_init`](<fd_quic_pkt_meta.h.md#fd_quic_pkt_meta_ds_fwd_iter_init>)
    - [`fd_quic_pkt_meta_ds_fwd_iter_done`](<fd_quic_pkt_meta.h.md#fd_quic_pkt_meta_ds_fwd_iter_done>)
    - [`fd_quic_pkt_meta_ds_fwd_iter_next`](<fd_quic_pkt_meta.h.md#fd_quic_pkt_meta_ds_fwd_iter_next>)
    - [`fd_quic_pkt_meta_ds_fwd_iter_ele`](<fd_quic_pkt_meta.h.md#fd_quic_pkt_meta_ds_fwd_iter_ele>)
    - [`fd_quic_reclaim_pkt_meta`](<#fd_quic_reclaim_pkt_meta>)
    - [`fd_quic_conn_free_pkt_meta`](<#fd_quic_conn_free_pkt_meta>)


---
### fd\_quic\_abandon\_enc\_level<!-- {{#callable:fd_quic_abandon_enc_level}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L1266>)

Frees all resources associated with encryption levels less than or equal to the specified level.
- **Inputs**:
    - `conn`: Pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
    - `enc_level`: The encryption level to abandon, represented as a `uint`.
- **Logic and Control Flow**:
    - Checks if the specified encryption level is available in `conn->keys_avail` using `fd_uint_extract_bit`.
    - If the encryption level is not available, the function returns 0.
    - Logs a debug message indicating the abandonment of the specified encryption level.
    - Calls [`fd_quic_ack_gen_abandon_enc_level`](<fd_quic_ack_tx.c.md#fd_quic_ack_gen_abandon_enc_level>) to abandon the acknowledgment generation for the specified encryption level.
    - Iterates from 0 to the specified encryption level, clearing the corresponding bits in `conn->keys_avail` using `fd_uint_clear_bit`.
    - For each level, calls [`fd_quic_reclaim_pkt_meta_level`](<#fd_quic_reclaim_pkt_meta_level>) to reclaim packet metadata associated with that level.
    - Accumulates the total number of freed packet metadata and returns this count.
- **Output**: Returns the total number of freed packet metadata as a `ulong`.
- **Functions Called**:
    - [`fd_quic_ack_gen_abandon_enc_level`](<fd_quic_ack_tx.c.md#fd_quic_ack_gen_abandon_enc_level>)
    - [`fd_quic_reclaim_pkt_meta_level`](<#fd_quic_reclaim_pkt_meta_level>)


---
### fd\_quic\_gen\_initial\_secret\_and\_keys<!-- {{#callable:fd_quic_gen_initial_secret_and_keys}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L1284>)

Generates initial secrets and keys for a QUIC connection.
- **Inputs**:
    - `conn`: Pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
    - `dst_conn_id`: Pointer to the `fd_quic_conn_id_t` structure containing the destination connection ID.
    - `is_server`: Integer indicating if the connection is for a server (non-zero) or a client (zero).
- **Logic and Control Flow**:
    - Calls [`fd_quic_gen_initial_secrets`](<crypto/fd_quic_crypto_suites.c.md#fd_quic_gen_initial_secrets>) to generate initial secrets based on the destination connection ID and whether the connection is for a server.
    - Calls [`fd_quic_gen_keys`](<crypto/fd_quic_crypto_suites.c.md#fd_quic_gen_keys>) twice to generate two sets of keys using the generated secrets.
- **Output**: No return value; the function modifies the `conn` structure to store the generated secrets and keys.
- **Functions Called**:
    - [`fd_quic_gen_initial_secrets`](<crypto/fd_quic_crypto_suites.c.md#fd_quic_gen_initial_secrets>)
    - [`fd_quic_gen_keys`](<crypto/fd_quic_crypto_suites.c.md#fd_quic_gen_keys>)


---
### fd\_quic\_send\_retry<!-- {{#callable:fd_quic_send_retry}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L1304>)

Sends a QUIC retry packet to the client.
- **Inputs**:
    - `quic`: Pointer to the `fd_quic_t` structure representing the QUIC connection.
    - `pkt`: Pointer to the `fd_quic_pkt_t` structure representing the packet to be retried.
    - `odcid`: Pointer to the original destination connection ID (`fd_quic_conn_id_t`).
    - `scid`: Pointer to the source connection ID (`fd_quic_conn_id_t`).
    - `new_conn_id`: New connection ID to be used in the retry packet.
- **Logic and Control Flow**:
    - Retrieve the current state of the QUIC connection using [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>).
    - Calculate the expiration time for the retry packet using the current time and the retry TTL from the configuration.
    - Create a buffer for the retry packet and generate the retry packet using [`fd_quic_retry_create`](<fd_quic_retry.c.md#fd_quic_retry_create>).
    - Increment the retry transmission count in the metrics.
    - Prepare to send the retry packet by adjusting the transmission pointer.
    - Attempt to send the retry packet using [`fd_quic_tx_buffered_raw`](<#fd_quic_tx_buffered_raw>).
    - If sending fails, return a failure code; otherwise, return success.
- **Output**: Returns 0 on success or `FD_QUIC_PARSE_FAIL` on failure.
- **Functions Called**:
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_retry_create`](<fd_quic_retry.c.md#fd_quic_retry_create>)
    - [`fd_quic_tx_buffered_raw`](<#fd_quic_tx_buffered_raw>)


---
### fd\_quic\_tls\_hs\_cache\_evict<!-- {{#callable:fd_quic_tls_hs_cache_evict}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L1340>)

Evicts the oldest `tls_hs` from the cache if it has exceeded its time-to-live (TTL).
- **Inputs**:
    - `quic`: Pointer to the `fd_quic_t` structure representing the QUIC instance.
    - `state`: Pointer to the `fd_quic_state_t` structure representing the current state of the QUIC connection.
- **Logic and Control Flow**:
    - Retrieve the oldest `tls_hs` from the handshake cache using `fd_quic_tls_hs_cache_ele_peek_head`.
    - Check if the current time (`state->now`) is less than the sum of the `birthtime` of the oldest `tls_hs` and its TTL (`quic->config.tls_hs_ttl`).
    - If the oldest `tls_hs` is too young to evict, increment the error count and return 0.
    - If the oldest `tls_hs` can be evicted, free its context using [`fd_quic_conn_free`](<#fd_quic_conn_free>), increment the eviction count, and return 1.
- **Output**: Returns 1 if a `tls_hs` was successfully evicted, otherwise returns 0.
- **Functions Called**:
    - [`fd_quic_conn_free`](<#fd_quic_conn_free>)


---
### fd\_quic\_handle\_v1\_initial<!-- {{#callable:fd_quic_handle_v1_initial}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L1362>)

Handles an 'Initial'-type packet for establishing QUIC connections and managing the TLS handshake.
- **Inputs**:
    - `quic`: Pointer to the `fd_quic_t` structure representing the QUIC instance.
    - `p_conn`: Pointer to a pointer of `fd_quic_conn_t`, representing the connection object.
    - `pkt`: Pointer to the `fd_quic_pkt_t` structure representing the QUIC packet.
    - `dcid`: Pointer to the destination connection ID of type `fd_quic_conn_id_t`.
    - `peer_scid`: Pointer to the peer source connection ID of type `fd_quic_conn_id_t`.
    - `cur_ptr`: Pointer to the current position in the packet data.
    - `cur_sz`: Size of the current packet data.
- **Logic and Control Flow**:
    - Checks if the connection is invalid or if keys are unavailable, increments the packet no key count, and returns a failure code.
    - Retrieves the current state and metrics from the `quic` instance.
    - Decodes the initial packet and checks for parsing errors.
    - Validates the packet length and checks for the presence of a token in the initial packet, returning a failure if conditions are violated.
    - Handles the case where no connection object exists, generating a new connection ID or sending a retry if necessary.
    - Determines decryption keys and secrets based on whether a connection exists.
    - Decrypts the incoming packet and reconstructs the packet number.
    - Handles the creation of a new connection if necessary, setting up transport parameters and TLS handshake.
    - Processes frames within the packet and updates the connection's last activity and expected packet number.
    - Schedules the connection for servicing and returns the total number of bytes consumed.
- **Output**: Returns the total number of bytes consumed from the packet, or a failure code if an error occurs.
- **Functions Called**:
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_send_retry`](<#fd_quic_send_retry>)
    - [`fd_quic_retry_server_verify`](<fd_quic_retry.c.md#fd_quic_retry_server_verify>)
    - [`fd_quic_gen_initial_secrets`](<crypto/fd_quic_crypto_suites.c.md#fd_quic_gen_initial_secrets>)
    - [`fd_quic_gen_keys`](<crypto/fd_quic_crypto_suites.c.md#fd_quic_gen_keys>)
    - [`fd_quic_crypto_decrypt_hdr`](<crypto/fd_quic_crypto_suites.c.md#fd_quic_crypto_decrypt_hdr>)
    - [`fd_quic_h0_pkt_num_len`](<templ/fd_quic_parse_util.h.md#fd_quic_h0_pkt_num_len>)
    - [`fd_quic_pktnum_decode`](<templ/fd_quic_parse_util.h.md#fd_quic_pktnum_decode>)
    - [`fd_quic_reconstruct_pkt_num`](<#fd_quic_reconstruct_pkt_num>)
    - [`fd_quic_crypto_decrypt`](<crypto/fd_quic_crypto_suites.c.md#fd_quic_crypto_decrypt>)
    - [`fd_quic_tls_hs_cache_evict`](<#fd_quic_tls_hs_cache_evict>)
    - [`fd_quic_conn_create`](<#fd_quic_conn_create>)
    - [`fd_quic_tls_hs_new`](<tls/fd_quic_tls.c.md#fd_quic_tls_hs_new>)
    - [`fd_quic_handle_v1_frame`](<#fd_quic_handle_v1_frame>)
    - [`fd_quic_conn_error`](<#fd_quic_conn_error>)
    - [`fd_quic_svc_prep_schedule`](<#fd_quic_svc_prep_schedule>)


---
### fd\_quic\_handle\_v1\_handshake<!-- {{#callable:fd_quic_handle_v1_handshake}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L1781>)

Processes a QUIC v1 handshake packet.
- **Inputs**:
    - `quic`: Pointer to the QUIC state structure.
    - `conn`: Pointer to the QUIC connection structure.
    - `pkt`: Pointer to the QUIC packet structure.
    - `cur_ptr`: Pointer to the current position in the packet data.
    - `cur_sz`: Size of the current packet data.
- **Logic and Control Flow**:
    - Retrieve the current QUIC state using [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>).
    - Check if the connection pointer is NULL; if so, increment the no connection count and return failure.
    - Check if the connection state is invalid or if the handshake keys are not available; if so, increment the no key count and return failure.
    - Decode the handshake data from the packet using `fd_quic_decode_handshake`.
    - Verify the length of the handshake data is within the bounds of the current packet size.
    - Fetch the TLS handshake structure from the connection.
    - Decrypt the packet header and payload using the appropriate keys.
    - Update the expected packet number and handle the frames in the handshake packet.
    - Update the last activity timestamp and return the total size of the processed packet.
- **Output**: Returns the total number of bytes consumed from the packet.
- **Functions Called**:
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_crypto_decrypt_hdr`](<crypto/fd_quic_crypto_suites.c.md#fd_quic_crypto_decrypt_hdr>)
    - [`fd_quic_h0_pkt_num_len`](<templ/fd_quic_parse_util.h.md#fd_quic_h0_pkt_num_len>)
    - [`fd_quic_pktnum_decode`](<templ/fd_quic_parse_util.h.md#fd_quic_pktnum_decode>)
    - [`fd_quic_reconstruct_pkt_num`](<#fd_quic_reconstruct_pkt_num>)
    - [`fd_quic_crypto_decrypt`](<crypto/fd_quic_crypto_suites.c.md#fd_quic_crypto_decrypt>)
    - [`fd_quic_abandon_enc_level`](<#fd_quic_abandon_enc_level>)
    - [`fd_quic_handle_v1_frame`](<#fd_quic_handle_v1_frame>)
    - [`fd_quic_conn_error`](<#fd_quic_conn_error>)


---
### fd\_quic\_handle\_v1\_retry<!-- {{#callable:fd_quic_handle_v1_retry}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L1932>)

Handles the processing of a QUIC version 1 retry packet.
- **Inputs**:
    - `quic`: Pointer to the `fd_quic_t` structure representing the QUIC instance.
    - `conn`: Pointer to the `fd_quic_conn_t` structure representing the connection.
    - `pkt`: Pointer to the `fd_quic_pkt_t` structure representing the packet.
    - `cur_ptr`: Pointer to the current position in the packet data.
    - `cur_sz`: Size of the current packet data.
- **Logic and Control Flow**:
    - Checks if the QUIC role is server; if so, it handles a misbehaving client without a connection.
    - If there is no connection, it logs a probe and increments the no connection count.
    - Verifies the retry token from the packet and updates the connection's peer connection ID.
    - Regenerates the initial secrets and keys using the retry source connection ID.
    - Resets the handshake data and prepares to send an INITIAL packet.
- **Output**: Returns the size of the current packet data processed.
- **Functions Called**:
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_conn_error`](<#fd_quic_conn_error>)
    - [`fd_quic_retry_client_verify`](<fd_quic_retry.c.md#fd_quic_retry_client_verify>)
    - [`fd_quic_gen_initial_secret_and_keys`](<#fd_quic_gen_initial_secret_and_keys>)
    - [`fd_quic_svc_prep_schedule_now`](<#fd_quic_svc_prep_schedule_now>)


---
### fd\_quic\_handle\_v1\_zero\_rtt<!-- {{#callable:fd_quic_handle_v1_zero_rtt}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L1996>)

Handles the processing of a zero-Round Trip Time (0-RTT) QUIC packet.
- **Inputs**:
    - `quic`: Pointer to the `fd_quic_t` structure representing the QUIC instance.
    - `conn`: Pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
    - `pkt`: Pointer to the `fd_quic_pkt_t` structure representing the QUIC packet.
    - `cur_ptr`: Pointer to the current position in the packet data.
    - `cur_sz`: Size of the remaining data in the packet.
- **Logic and Control Flow**:
    - The function begins by ignoring the `pkt`, `quic`, `cur_ptr`, and `cur_sz` parameters.
    - It checks if the `conn` pointer is not null.
    - If `conn` is valid, it calls [`fd_quic_conn_error`](<#fd_quic_conn_error>) to report an internal error due to unsupported 0-RTT.
    - Finally, it returns `FD_QUIC_PARSE_FAIL` to indicate failure in processing the packet.
- **Output**: Returns `FD_QUIC_PARSE_FAIL` to indicate that the packet processing failed due to unsupported 0-RTT.
- **Functions Called**:
    - [`fd_quic_conn_error`](<#fd_quic_conn_error>)


---
### fd\_quic\_lazy\_ack\_pkt<!-- {{#callable:fd_quic_lazy_ack_pkt}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L2009>)

Processes QUIC acknowledgment packets.
- **Inputs**:
    - `quic`: Pointer to the QUIC state structure.
    - `conn`: Pointer to the QUIC connection structure.
    - `pkt`: Pointer to the QUIC packet structure containing acknowledgment information.
- **Logic and Control Flow**:
    - Checks if the `ACK_FLAG_CANCEL` is set in the packet's acknowledgment flags.
    - If the cancel flag is set, returns `FD_QUIC_ACK_TX_CANCEL`.
    - Retrieves the current state of the QUIC connection.
    - Calls [`fd_quic_ack_pkt`](<fd_quic_ack_tx.c.md#fd_quic_ack_pkt>) to process the acknowledgment for the packet number and encryption level.
    - Updates the acknowledgment generation state based on the acknowledgment flags.
    - Determines if an immediate acknowledgment should be sent based on the unacknowledged size and acknowledgment flags.
    - Schedules the acknowledgment service if conditions are met.
- **Output**: Returns the result of processing the acknowledgment packet, which indicates the success or failure of the acknowledgment operation.
- **Functions Called**:
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_ack_pkt`](<fd_quic_ack_tx.c.md#fd_quic_ack_pkt>)
    - [`fd_quic_svc_prep_schedule`](<#fd_quic_svc_prep_schedule>)


---
### fd\_quic\_key\_update\_derive1<!-- {{#callable:fd_quic_key_update_derive1}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L2039>)

Derives new keys from the connection's secrets.
- **Inputs**:
    - `conn`: Pointer to a `fd_quic_conn_t` structure representing the QUIC connection.
- **Logic and Control Flow**:
    - Calls [`fd_quic_key_update_derive`](<crypto/fd_quic_crypto_suites.c.md#fd_quic_key_update_derive>) with the connection's secrets and new keys.
    - The function is marked with `noinline` to prevent inlining, ensuring it has a distinct stack frame.
- **Output**: This function does not return a value.
- **Functions Called**:
    - [`fd_quic_key_update_derive`](<crypto/fd_quic_crypto_suites.c.md#fd_quic_key_update_derive>)


---
### fd\_quic\_key\_update\_complete<!-- {{#callable:fd_quic_key_update_complete}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L2044>)

Completes the key update process for a QUIC connection.
- **Inputs**:
    - `conn`: Pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
- **Logic and Control Flow**:
    - Sets the encryption level to `fd_quic_enc_level_appdata_id`.
    - Copies new packet keys and initialization vectors from `conn->new_keys` to `conn->keys`.
    - Copies new secrets from `conn->secrets.new_secret` to `conn->secrets.secret`.
    - Updates the key phase for the connection.
    - Calls [`fd_quic_key_update_derive1`](<#fd_quic_key_update_derive1>) to derive keys for the next phase.
    - Logs a debug message indicating the completion of the key update.
- **Output**: No return value; the function updates the state of the connection.
- **Functions Called**:
    - [`fd_quic_key_update_derive1`](<#fd_quic_key_update_derive1>)


---
### fd\_quic\_handle\_v1\_one\_rtt<!-- {{#callable:fd_quic_handle_v1_one_rtt}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L2069>)

Processes a QUIC 1-RTT packet.
- **Inputs**:
    - `quic`: Pointer to the QUIC state structure.
    - `conn`: Pointer to the QUIC connection structure.
    - `pkt`: Pointer to the QUIC packet structure.
    - `cur_ptr`: Pointer to the current position in the packet data.
    - `tot_sz`: Total size of the packet data.
- **Logic and Control Flow**:
    - Check if the connection is valid; if not, increment the no connection count and return failure.
    - Check if the connection state is invalid or if keys are not available; if so, increment the no key count and return failure.
    - Verify the total size of the packet is sufficient; if not, increment the decrypt fail count and return failure.
    - Decrypt the packet header and payload using the appropriate keys.
    - Reconstruct the packet number and check if it is in the current key phase.
    - If the key phase has changed, update the keys and decrypt the packet again.
    - Handle the frames contained in the packet, processing each frame until all frames are handled.
    - Update the last activity timestamp and expected packet number.
- **Output**: Returns the total size of the packet processed or a failure code.
- **Functions Called**:
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_crypto_decrypt_hdr`](<crypto/fd_quic_crypto_suites.c.md#fd_quic_crypto_decrypt_hdr>)
    - [`fd_quic_h0_pkt_num_len`](<templ/fd_quic_parse_util.h.md#fd_quic_h0_pkt_num_len>)
    - [`fd_quic_one_rtt_key_phase`](<templ/fd_quic_parse_util.h.md#fd_quic_one_rtt_key_phase>)
    - [`fd_quic_pktnum_decode`](<templ/fd_quic_parse_util.h.md#fd_quic_pktnum_decode>)
    - [`fd_quic_reconstruct_pkt_num`](<#fd_quic_reconstruct_pkt_num>)
    - [`fd_quic_crypto_decrypt`](<crypto/fd_quic_crypto_suites.c.md#fd_quic_crypto_decrypt>)
    - [`fd_quic_key_update_complete`](<#fd_quic_key_update_complete>)
    - [`fd_quic_handle_v1_frame`](<#fd_quic_handle_v1_frame>)
    - [`fd_quic_conn_error`](<#fd_quic_conn_error>)


---
### fd\_quic\_process\_quic\_packet\_v1<!-- {{#callable:fd_quic_process_quic_packet_v1}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L2192>)

Processes a QUIC packet of version 1.
- **Inputs**:
    - `quic`: Pointer to the `fd_quic_t` structure representing the QUIC connection.
    - `pkt`: Pointer to the `fd_quic_pkt_t` structure where the parsed packet data will be stored.
    - `cur_ptr`: Pointer to the current position in the packet data buffer.
    - `cur_sz`: Size of the packet data buffer.
- **Logic and Control Flow**:
    - Checks if the packet size is less than the minimum required size and increments the undersized packet count if true.
    - Checks if the packet size exceeds the maximum allowed size and increments the oversized packet count if true.
    - Determines if the packet has a long header or a short header based on the first byte.
    - If the packet has a long header, it decodes the long header and processes it based on the packet type (Initial, Handshake, Retry, or Zero RTT).
    - If the packet has a short header, it processes it as a one RTT packet.
    - Schedules timers for the connection after processing the packet.
    - Acknowledges the packet after all frames have been parsed.
- **Output**: Returns the number of bytes consumed from the packet data buffer, or a failure code if an error occurs.
- **Functions Called**:
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_h0_hdr_form`](<templ/fd_quic_parse_util.h.md#fd_quic_h0_hdr_form>)
    - [`fd_quic_conn_id_t::fd_quic_conn_id_new`](<fd_quic_conn_id.h.md#fd_quic_conn_id_tfd_quic_conn_id_new>)
    - [`fd_quic_conn_query`](<fd_quic_private.h.md#fd_quic_conn_query>)
    - [`fd_quic_h0_long_packet_type`](<templ/fd_quic_parse_util.h.md#fd_quic_h0_long_packet_type>)
    - [`fd_quic_handle_v1_initial`](<#fd_quic_handle_v1_initial>)
    - [`fd_quic_handle_v1_handshake`](<#fd_quic_handle_v1_handshake>)
    - [`fd_quic_handle_v1_retry`](<#fd_quic_handle_v1_retry>)
    - [`fd_quic_handle_v1_zero_rtt`](<#fd_quic_handle_v1_zero_rtt>)
    - [`fd_quic_svc_timers_schedule`](<fd_quic_svc_q.c.md#fd_quic_svc_timers_schedule>)
    - [`fd_quic_handle_v1_one_rtt`](<#fd_quic_handle_v1_one_rtt>)
    - [`fd_quic_lazy_ack_pkt`](<#fd_quic_lazy_ack_pkt>)
    - [`fd_quic_sample_rtt`](<fd_quic_private.h.md#fd_quic_sample_rtt>)


---
### is\_version\_invalid<!-- {{#callable:is_version_invalid}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L2313>)

Checks if the provided version is invalid for QUIC.
- **Inputs**:
    - `quic`: Pointer to a `fd_quic_t` structure representing the QUIC connection.
    - `version`: An unsigned integer representing the version to be checked.
- **Logic and Control Flow**:
    - If `version` is 0, increment the `pkt_verneg_cnt` in `quic->metrics`, log a debug message, and return 1.
    - If `version` matches the pattern `0x0a0a0a0a`, increment the `pkt_verneg_cnt`, log a debug message, and return 1.
    - If `version` is not equal to 1, increment the `pkt_verneg_cnt`, log a debug message, and return 1.
    - If none of the above conditions are met, return 0.
- **Output**: Returns 1 if the version is invalid, otherwise returns 0.


---
### fd\_quic\_process\_packet\_impl<!-- {{#callable:fd_quic_process_packet_impl}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L2341>)

Processes a QUIC packet by decoding its headers and updating the connection state.
- **Inputs**:
    - `quic`: Pointer to the `fd_quic_t` structure representing the QUIC connection.
    - `data`: Pointer to the raw packet data to be processed.
    - `data_sz`: Size of the packet data in bytes.
    - `now`: Current time in ticks used for timestamping.
- **Logic and Control Flow**:
    - Sets the current time in the QUIC state.
    - Increments the received byte and packet count metrics.
    - Checks if the packet size exceeds the maximum allowed size.
    - Decodes the IPv4 header from the packet data.
    - Validates the protocol and checks for packet truncation.
    - Decodes the UDP header and checks for valid lengths.
    - Determines if the packet is a long or short header based on the first byte.
    - Processes long header packets by handling different packet types (Initial, Handshake, Retry).
    - Processes short header packets as 1-RTT packets.
    - Handles the acknowledgment of received packets and updates the connection state accordingly.
- **Output**: The function does not return a value but updates the state of the QUIC connection and metrics based on the processed packet.
- **Functions Called**:
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`is_version_invalid`](<#is_version_invalid>)
    - [`fd_quic_process_quic_packet_v1`](<#fd_quic_process_quic_packet_v1>)
    - [`svc_cnt_eq_alloc_conn`](<#svc_cnt_eq_alloc_conn>)


---
### fd\_quic\_process\_packet<!-- {{#callable:fd_quic_process_packet}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L2515>)

Processes a QUIC packet by handling its contents and updating metrics.
- **Inputs**:
    - `quic`: Pointer to the `fd_quic_t` structure representing the QUIC connection.
    - `data`: Pointer to the data buffer containing the packet to be processed.
    - `data_sz`: Size of the data buffer in bytes.
    - `now`: Current time in ticks used for timing metrics.
- **Logic and Control Flow**:
    - Records the current time in ticks using `fd_tickcount()`.
    - Calls `fd_quic_process_packet_impl()` to handle the packet processing.
    - Calculates the time taken for processing by subtracting the recorded time from the current time.
    - Samples the duration of packet reception using `fd_histf_sample()`.
- **Output**: The function does not return a value; it updates internal metrics and processes the packet.
- **Functions Called**:
    - [`fd_quic_process_packet_impl`](<#fd_quic_process_packet_impl>)


---
### fd\_quic\_aio\_cb\_receive<!-- {{#callable:fd_quic_aio_cb_receive}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L2527>)

Processes received QUIC packets in an asynchronous I/O context.
- **Inputs**:
    - `context`: A pointer to the QUIC context, which holds the state and configuration.
    - `batch`: An array of packet information structures containing the received packets.
    - `batch_cnt`: The number of packets in the batch.
    - `opt_batch_idx`: An optional pointer to store the index of the last processed packet.
    - `flush`: An integer indicating whether to flush the output.
- **Logic and Control Flow**:
    - The function ignores the 'flush' parameter.
    - It retrieves the current time from the QUIC state.
    - It iterates over each packet in the 'batch' array.
    - For each packet, it calls 'fd_quic_process_packet' to handle the packet.
    - If 'opt_batch_idx' is provided, it sets it to the total number of processed packets.
- **Output**: Returns FD_AIO_SUCCESS to indicate successful processing of the packets.
- **Functions Called**:
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_process_packet`](<#fd_quic_process_packet>)


---
### fd\_quic\_tls\_cb\_alert<!-- {{#callable:fd_quic_tls_cb_alert}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L2555>)

Handles TLS alert callbacks for QUIC connections.
- **Inputs**:
    - `hs`: A pointer to the TLS handshake state structure.
    - `context`: A pointer to the connection context.
    - `alert`: An integer representing the TLS alert code.
- **Logic and Control Flow**:
    - The function casts the `context` pointer to a `fd_quic_conn_t` type to access the connection details.
    - It logs the server or client role based on the `conn->server` flag.
    - It logs the alert code and its string representation using `fd_tls_alert_cstr`.
    - There is a placeholder for future implementation to store the alert for replying to the peer.
- **Output**: The function does not return a value but logs debug information regarding the TLS alert.


---
### fd\_quic\_tls\_cb\_secret<!-- {{#callable:fd_quic_tls_cb_secret}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L2569>)

Processes QUIC TLS handshake secrets and updates cryptographic keys.
- **Inputs**:
    - `hs`: A pointer to the QUIC TLS handshake state structure.
    - `context`: A pointer to the connection context.
    - `secret`: A pointer to the QUIC TLS secret structure containing read and write secrets.
- **Logic and Control Flow**:
    - Checks if the encryption level in `secret` is valid.
    - Copies the read and write secrets into the connection's secret storage.
    - Updates the available keys for the connection based on the encryption level.
    - Generates local and peer keys using the updated secrets.
    - If the encryption level is for application data, derives new keys.
- **Output**: No return value; updates the connection's cryptographic state and may log keys.
- **Functions Called**:
    - [`fd_quic_gen_keys`](<crypto/fd_quic_crypto_suites.c.md#fd_quic_gen_keys>)
    - [`fd_quic_key_update_derive`](<crypto/fd_quic_crypto_suites.c.md#fd_quic_key_update_derive>)


---
### fd\_quic\_apply\_peer\_params<!-- {{#callable:fd_quic_apply_peer_params}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L2657>)

Applies transport parameters from a peer to a QUIC connection.
- **Inputs**:
    - `conn`: Pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
    - `peer_tp`: Pointer to the `fd_quic_transport_params_t` structure containing the transport parameters from the peer.
- **Logic and Control Flow**:
    - Sets flow control parameters such as `tx_max_data` and `tx_initial_max_stream_data_uni` from `peer_tp`.
    - If the connection is not a server, verifies the `retry_source_connection_id` against the peer's parameters.
    - Sets the maximum datagram size based on `peer_tp` and ensures it is at least `FD_QUIC_INITIAL_PAYLOAD_SZ_MAX`.
    - Determines the initial maximum streams based on whether the connection is a server or client.
    - Updates the `idle_timeout_ns` to the minimum of the current and peer's maximum idle timeout.
    - Sets the `peer_ack_delay_scale` based on the `ack_delay_exponent` from `peer_tp`.
    - Calculates and sets the `peer_max_ack_delay_ns` based on the `max_ack_delay` from `peer_tp`.
    - Marks the transport parameters as set.
- **Output**: The function does not return a value but modifies the state of the `conn` structure based on the provided peer transport parameters.
- **Functions Called**:
    - [`fd_quic_conn_error`](<#fd_quic_conn_error>)


---
### fd\_quic\_tls\_cb\_peer\_params<!-- {{#callable:fd_quic_tls_cb_peer_params}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L2728>)

Processes peer transport parameters received during a QUIC TLS handshake.
- **Inputs**:
    - `context`: A pointer to the connection context.
    - `peer_tp_enc`: A pointer to the encoded peer transport parameters.
    - `peer_tp_enc_sz`: The size of the encoded peer transport parameters.
- **Logic and Control Flow**:
    - Cast `context` to `fd_quic_conn_t*` to access the connection.
    - Decode the transport parameters from `peer_tp_enc` using [`fd_quic_decode_transport_params`](<templ/fd_quic_transport_params.c.md#fd_quic_decode_transport_params>).
    - If decoding fails, log a notice and call [`fd_quic_conn_error`](<#fd_quic_conn_error>) to signal a transport parameter error.
    - If decoding succeeds, apply the decoded parameters to the connection using [`fd_quic_apply_peer_params`](<#fd_quic_apply_peer_params>).
- **Output**: No return value; modifies the connection state based on the decoded transport parameters.
- **Functions Called**:
    - [`fd_quic_decode_transport_params`](<templ/fd_quic_transport_params.c.md#fd_quic_decode_transport_params>)
    - [`fd_quic_conn_error`](<#fd_quic_conn_error>)
    - [`fd_quic_apply_peer_params`](<#fd_quic_apply_peer_params>)


---
### fd\_quic\_tls\_cb\_handshake\_complete<!-- {{#callable:fd_quic_tls_cb_handshake_complete}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L2747>)

Handles the completion of a QUIC TLS handshake.
- **Inputs**:
    - `hs`: Pointer to the TLS handshake state.
    - `context`: Pointer to the connection context.
- **Logic and Control Flow**:
    - The function first casts the `context` pointer to a `fd_quic_conn_t` type.
    - It checks the state of the connection and handles different cases based on the state.
    - If the connection state is `FD_QUIC_CONN_STATE_HANDSHAKE`, it verifies if transport parameters are set.
    - If transport parameters are not set, it logs a warning and triggers an internal error.
    - If the handshake is complete, it updates the connection state to `FD_QUIC_CONN_STATE_HANDSHAKE_COMPLETE`.
- **Output**: The function does not return a value but modifies the state of the connection.
- **Functions Called**:
    - [`fd_quic_conn_error`](<#fd_quic_conn_error>)
    - [`fd_quic_set_conn_state`](<#fd_quic_set_conn_state>)


---
### fd\_quic\_handle\_crypto\_frame<!-- {{#callable:fd_quic_handle_crypto_frame}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L2776>)

Processes a QUIC crypto frame.
- **Inputs**:
    - `context`: Pointer to the QUIC frame context containing connection and packet information.
    - `crypto`: Pointer to the QUIC crypto frame structure containing offset and length.
    - `p`: Pointer to the data buffer containing the crypto frame data.
    - `p_sz`: Size of the data buffer.
- **Logic and Control Flow**:
    - Retrieve the connection and TLS handshake state from the context.
    - Calculate the expected offset and size of the received data.
    - Check if the received size exceeds the available data size; if so, report an error.
    - If the TLS handshake is complete, ignore the frame.
    - If the encryption level is lower than the current level, return the received size.
    - If the encryption level is higher, update the encryption level and reset the received data size.
    - If the received offset is greater than the current size, set a cancel flag and return the received size.
    - If the received data exceeds the maximum buffer size, report an error.
    - Copy the received data into the TLS handshake buffer.
    - Process the TLS handshake; if it fails, report an error and abort the connection.
- **Output**: Returns the size of the received data or an error code if processing fails.
- **Functions Called**:
    - [`fd_quic_frame_error`](<#fd_quic_frame_error>)
    - [`fd_quic_tls_process`](<tls/fd_quic_tls.c.md#fd_quic_tls_process>)


---
### fd\_quic\_svc\_poll<!-- {{#callable:fd_quic_svc_poll}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L2857>)

Processes QUIC service polling for a connection.
- **Inputs**:
    - `quic`: Pointer to the `fd_quic_t` structure representing the QUIC instance.
    - `conn`: Pointer to the `fd_quic_conn_t` structure representing the connection to be polled.
    - `now`: Current time in nanoseconds.
- **Logic and Control Flow**:
    - Retrieve the current state of the QUIC instance using [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>).
    - Check if the connection state is `FD_QUIC_CONN_STATE_INVALID`. If true, log a critical error and return 1.
    - Check if the current time exceeds half of the idle timeout since the last activity. If true, check if it exceeds the full idle timeout.
    - If the connection is still alive, set its state to `FD_QUIC_CONN_STATE_DEAD` and increment the timeout count.
    - If the connection is not dead, call [`fd_quic_conn_service`](<#fd_quic_conn_service>) to handle the connection's service logic.
    - Check the connection state again. If it is dead, call [`fd_quic_cb_conn_final`](<fd_quic_private.h.md#fd_quic_cb_conn_final>) and free the connection.
    - If the connection is still valid, determine whether to schedule for keep-alive or timeout based on the current time and last activity.
- **Output**: Returns 1 if the connection is processed successfully, otherwise returns 0.
- **Functions Called**:
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_set_conn_state`](<#fd_quic_set_conn_state>)
    - [`fd_quic_cb_conn_final`](<fd_quic_private.h.md#fd_quic_cb_conn_final>)
    - [`fd_quic_conn_free`](<#fd_quic_conn_free>)
    - [`fd_quic_conn_service`](<#fd_quic_conn_service>)
    - [`fd_quic_svc_prep_schedule`](<#fd_quic_svc_prep_schedule>)
    - [`fd_quic_svc_timers_schedule`](<fd_quic_svc_q.c.md#fd_quic_svc_timers_schedule>)


---
### fd\_quic\_service<!-- {{#callable:fd_quic_service}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L2932>)

Processes QUIC service events and manages connection state.
- **Inputs**:
    - `quic`: Pointer to a `fd_quic_t` structure representing the QUIC instance.
    - `now`: Current time in milliseconds since epoch.
- **Logic and Control Flow**:
    - Sets the current time in the QUIC state using `state->now = now`.
    - Calls [`svc_cnt_eq_alloc_conn`](<#svc_cnt_eq_alloc_conn>) to ensure the number of connections matches the expected count.
    - Retrieves the next scheduled event using [`fd_quic_svc_timers_next`](<fd_quic_svc_q.c.md#fd_quic_svc_timers_next>).
    - If no connection is scheduled, returns 0.
    - Calls [`fd_quic_svc_poll`](<#fd_quic_svc_poll>) to process the next connection event.
    - Records the time taken for processing and samples the service duration metric.
- **Output**: Returns the count of processed events or 0 if no events were processed.
- **Functions Called**:
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`svc_cnt_eq_alloc_conn`](<#svc_cnt_eq_alloc_conn>)
    - [`fd_quic_svc_timers_next`](<fd_quic_svc_q.c.md#fd_quic_svc_timers_next>)
    - [`fd_quic_svc_poll`](<#fd_quic_svc_poll>)


---
### fd\_quic\_conn\_tx\_buf\_remaining<!-- {{#callable:FD_FN_UNUSED::fd_quic_conn_tx_buf_remaining}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L2956>)

Returns the number of bytes remaining in the transmission buffer for a QUIC connection.
- **Inputs**:
    - `conn`: Pointer to a `fd_quic_conn_t` structure representing the QUIC connection.
- **Logic and Control Flow**:
    - Calculates the size of the transmission buffer by subtracting the current pointer position from the total buffer size.
    - Returns the calculated remaining size.
- **Output**: Returns the number of bytes remaining in the transmission buffer.


---
### fd\_quic\_tx\_buffered\_raw<!-- {{#callable:fd_quic_tx_buffered_raw}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L2968>)

Encodes and sends a QUIC packet with buffered data.
- **Inputs**:
    - `quic`: Pointer to the `fd_quic_t` structure representing the QUIC connection.
    - `tx_ptr_ptr`: Pointer to a pointer that points to the current position in the transmission buffer.
    - `tx_buf`: Pointer to the buffer where the data to be sent is stored.
    - `ipv4_id`: Pointer to a variable that holds the IPv4 identification number.
    - `dst_ipv4_addr`: Destination IPv4 address for the packet.
    - `dst_udp_port`: Destination UDP port for the packet.
    - `src_ipv4_addr`: Source IPv4 address for the packet.
    - `src_udp_port`: Source UDP port for the packet.
- **Logic and Control Flow**:
    - Calculate the size of the payload by subtracting the start of the buffer from the current position.
    - If the payload size is less than or equal to zero, return 0, indicating no data to send.
    - Prepare a `fd_quic_pkt_t` structure to hold the packet data.
    - Fill in the IPv4 header fields with appropriate values.
    - Encode the IPv4 header and check for buffer overrun errors.
    - Compute the checksum for the IPv4 header.
    - Encode the UDP header and check for buffer overrun errors.
    - Check if there is enough space in the buffer for the payload; if not, reset the transmission pointer and return failure.
    - Copy the payload data into the buffer.
    - Send the packet using asynchronous I/O and handle any errors that may occur.
    - Reset the transmission pointer after sending the packet.
- **Output**: Returns `FD_QUIC_SUCCESS` on successful transmission, `FD_QUIC_FAILED` on failure, or 0 if there is no data to send.
- **Functions Called**:
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_encode_ip4`](<fd_quic_proto.h.md#fd_quic_encode_ip4>)
    - [`fd_quic_encode_udp`](<fd_quic_proto.h.md#fd_quic_encode_udp>)


---
### fd\_quic\_tx\_buffered<!-- {{#callable:fd_quic_tx_buffered}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L3071>)

fd_quic_tx_buffered transmits buffered QUIC data for a connection.
- **Inputs**:
    - `quic`: Pointer to the `fd_quic_t` structure representing the QUIC instance.
    - `conn`: Pointer to the `fd_quic_conn_t` structure representing the connection.
- **Logic and Control Flow**:
    - Retrieve the peer endpoint from the `conn` structure.
    - Call [`fd_quic_tx_buffered_raw`](<#fd_quic_tx_buffered_raw>) with the QUIC instance, connection's transmission pointer, connection's transmission buffer, IPv4 ID, destination IP address, destination UDP port, source IP address, and source UDP port.
    - Return the result of the [`fd_quic_tx_buffered_raw`](<#fd_quic_tx_buffered_raw>) function.
- **Output**: Returns the result of the [`fd_quic_tx_buffered_raw`](<#fd_quic_tx_buffered_raw>) function, indicating the success or failure of the transmission.
- **Functions Called**:
    - [`fd_quic_tx_buffered_raw`](<#fd_quic_tx_buffered_raw>)


---
### fd\_quic\_conn\_can\_acquire\_pkt\_meta<!-- {{#callable:fd_quic_conn_can_acquire_pkt_meta}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L3086>)

Determines if a `fd_quic_conn_t` can acquire packet metadata.
- **Inputs**:
    - `conn`: Pointer to a `fd_quic_conn_t` structure representing the QUIC connection.
    - `tracker`: Pointer to a `fd_quic_pkt_meta_tracker_t` structure that tracks packet metadata.
- **Logic and Control Flow**:
    - Retrieve the current state of the QUIC connection using [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>).
    - Check the available space in the packet metadata pool using `fd_quic_pkt_meta_pool_free`.
    - If the pool is empty or the used packet metadata exceeds the maximum allowed, increment the failure count in metrics and return 0.
    - If there is available space, increment the success count in metrics and return 1.
- **Output**: Returns 1 if packet metadata can be acquired, otherwise returns 0.
- **Functions Called**:
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)


---
### fd\_quic\_gen\_frame\_store\_pkt\_meta<!-- {{#callable:fd_quic_gen_frame_store_pkt_meta}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L3111>)

fd_quic_gen_frame_store_pkt_meta stores a packet metadata structure into a tracker for a QUIC connection.
- **Inputs**:
    - `pkt_meta_tmpl`: A pointer to a template for the packet metadata.
    - `type`: An unsigned character representing the type of the packet.
    - `value`: A value associated with the packet metadata.
    - `tracker`: A pointer to the packet metadata tracker.
    - `conn`: A pointer to the QUIC connection.
- **Logic and Control Flow**:
    - Check if the connection can acquire packet metadata using [`fd_quic_conn_can_acquire_pkt_meta`](<#fd_quic_conn_can_acquire_pkt_meta>).
    - If the connection cannot acquire packet metadata, return 0.
    - Increment the used packet metadata count in the connection.
    - Acquire a packet metadata element from the pool using `fd_quic_pkt_meta_pool_ele_acquire`.
    - Copy the contents of `pkt_meta_tmpl` into the newly acquired packet metadata.
    - Set the type of the packet metadata using `FD_QUIC_PKT_META_SET_TYPE`.
    - Assign the value to the packet metadata.
    - Insert the packet metadata into the tracker using [`fd_quic_pkt_meta_insert`](<fd_quic_pkt_meta.c.md#fd_quic_pkt_meta_insert>).
    - Return 1 to indicate success.
- **Output**: Returns 1 if successful, 0 if not.
- **Functions Called**:
    - [`fd_quic_conn_can_acquire_pkt_meta`](<#fd_quic_conn_can_acquire_pkt_meta>)
    - [`fd_quic_pkt_meta_insert`](<fd_quic_pkt_meta.c.md#fd_quic_pkt_meta_insert>)


---
### fd\_quic\_gen\_close\_frame<!-- {{#callable:fd_quic_gen_close_frame}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L3128>)

Generates a QUIC connection close frame.
- **Inputs**:
    - `conn`: Pointer to the QUIC connection structure.
    - `payload_ptr`: Pointer to the start of the payload buffer.
    - `payload_end`: Pointer to the end of the payload buffer.
    - `pkt_meta_tmpl`: Pointer to the packet metadata template.
    - `tracker`: Pointer to the packet metadata tracker.
- **Logic and Control Flow**:
    - Checks if the close flag is already set in the connection structure.
    - Sets the close flag if it is not already set.
    - Determines the type of close frame to generate based on the connection's reason and state.
    - Encodes the close frame into the payload buffer.
    - Handles encoding failure by logging a warning and returning 0.
    - Stores packet metadata for the generated close frame.
    - Returns the size of the generated frame.
- **Output**: Returns the size of the generated close frame or 0 if an error occurs.
- **Functions Called**:
    - [`fd_quic_gen_frame_store_pkt_meta`](<#fd_quic_gen_frame_store_pkt_meta>)


---
### fd\_quic\_gen\_handshake\_frames<!-- {{#callable:fd_quic_gen_handshake_frames}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L3173>)

Generates QUIC handshake frames for transmission.
- **Inputs**:
    - `conn`: Pointer to the QUIC connection structure.
    - `payload_ptr`: Pointer to the start of the payload buffer.
    - `payload_end`: Pointer to the end of the payload buffer.
    - `pkt_meta_tmpl`: Pointer to the packet metadata template.
    - `tracker`: Pointer to the packet metadata tracker.
- **Logic and Control Flow**:
    - Retrieve the encryption level from the packet metadata template.
    - Get the handshake data for the specified encryption level.
    - Return early if no handshake data is available.
    - Check if there is space in the packet metadata tracker.
    - Initialize offsets for tracking sent and acknowledged bytes.
    - Iterate through the handshake data while there is data available.
    - Skip already sent handshake data.
    - Log a warning if there is a gap in the handshake data.
    - Encode the handshake data into the payload buffer.
    - Update the packet metadata with the new offsets.
    - Return the updated payload pointer.
- **Output**: Returns a pointer to the updated position in the payload buffer after generating the handshake frames.
- **Functions Called**:
    - [`fd_quic_tls_get_hs_data`](<tls/fd_quic_tls.c.md#fd_quic_tls_get_hs_data>)
    - [`fd_quic_conn_can_acquire_pkt_meta`](<#fd_quic_conn_can_acquire_pkt_meta>)
    - [`fd_quic_tls_get_next_hs_data`](<tls/fd_quic_tls.c.md#fd_quic_tls_get_next_hs_data>)
    - [`fd_quic_gen_frame_store_pkt_meta`](<#fd_quic_gen_frame_store_pkt_meta>)


---
### fd\_quic\_gen\_handshake\_done\_frame<!-- {{#callable:fd_quic_gen_handshake_done_frame}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L3260>)

Generates a QUIC handshake done frame.
- **Inputs**:
    - `conn`: Pointer to the QUIC connection structure.
    - `payload_ptr`: Pointer to the start of the payload buffer.
    - `payload_end`: Pointer to the end of the payload buffer.
    - `pkt_meta_tmpl`: Pointer to the packet metadata template.
    - `tracker`: Pointer to the packet metadata tracker.
- **Logic and Control Flow**:
    - Logs the generation of the handshake done frame using `FD_DTRACE_PROBE_1`.
    - Checks if the handshake done frame has already been sent; if so, returns 0.
    - Sets the `handshake_done_send` flag to 0 to indicate the frame is being sent.
    - Checks if the handshake done frame has already been acknowledged; if so, returns 0.
    - Checks if there is space in the payload buffer; if not, returns 0.
    - Writes the handshake done frame identifier (0x1E) to the payload buffer.
    - Attempts to store packet metadata for the handshake done frame; if it fails, returns 0.
    - Returns 1 to indicate the handshake done frame was successfully generated.
- **Output**: Returns the size of the generated handshake done frame, or 0 if it could not be generated.
- **Functions Called**:
    - [`fd_quic_gen_frame_store_pkt_meta`](<#fd_quic_gen_frame_store_pkt_meta>)


---
### fd\_quic\_gen\_max\_data\_frame<!-- {{#callable:fd_quic_gen_max_data_frame}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L3284>)

Generates a MAX_DATA frame for a QUIC connection.
- **Inputs**:
    - `conn`: Pointer to the QUIC connection structure.
    - `payload_ptr`: Pointer to the start of the payload buffer.
    - `payload_end`: Pointer to the end of the payload buffer.
    - `pkt_meta_tmpl`: Pointer to the packet metadata template.
    - `tracker`: Pointer to the packet metadata tracker.
- **Logic and Control Flow**:
    - Checks if the MAX_DATA flag is set in the connection flags.
    - Checks if the received maximum data is less than or equal to the acknowledged maximum data.
    - Creates a MAX_DATA frame with the current maximum data value.
    - Attempts to encode the MAX_DATA frame into the payload buffer.
    - If encoding fails, returns 0.
    - Stores the packet metadata for the generated frame.
    - Updates the packet number for the connection.
- **Output**: Returns the size of the generated MAX_DATA frame or 0 if no frame was generated.
- **Functions Called**:
    - [`fd_quic_gen_frame_store_pkt_meta`](<#fd_quic_gen_frame_store_pkt_meta>)


---
### fd\_quic\_gen\_max\_streams\_frame<!-- {{#callable:fd_quic_gen_max_streams_frame}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L3317>)

Generates a MAX_STREAMS frame for a QUIC connection.
- **Inputs**:
    - `conn`: Pointer to the QUIC connection structure.
    - `payload_ptr`: Pointer to the start of the payload buffer.
    - `payload_end`: Pointer to the end of the payload buffer.
    - `pkt_meta_tmpl`: Pointer to the packet metadata template.
    - `tracker`: Pointer to the packet metadata tracker.
- **Logic and Control Flow**:
    - Calculates the maximum number of unidirectional streams based on the connection's stream ID.
    - Checks if the MAX_STREAMS frame should be sent based on connection flags and acknowledged streams.
    - Encodes the MAX_STREAMS frame into the payload buffer.
    - Stores packet metadata for the generated frame.
    - Updates connection flags and packet number.
- **Output**: Returns the size of the generated frame or 0 if the frame could not be generated.
- **Functions Called**:
    - [`fd_quic_gen_frame_store_pkt_meta`](<#fd_quic_gen_frame_store_pkt_meta>)


---
### fd\_quic\_gen\_ping\_frame<!-- {{#callable:fd_quic_gen_ping_frame}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L3355>)

Generates a QUIC ping frame for a connection.
- **Inputs**:
    - `conn`: Pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
    - `payload_ptr`: Pointer to the start of the payload buffer where the frame will be encoded.
    - `payload_end`: Pointer to the end of the payload buffer.
    - `pkt_meta_tmpl`: Pointer to a template for packet metadata used in the frame.
    - `tracker`: Pointer to the `fd_quic_pkt_meta_tracker_t` structure for tracking packet metadata.
- **Logic and Control Flow**:
    - Checks if the connection is allowed to send a ping frame based on its flags.
    - If a ping frame has already been sent, the function returns 0.
    - Encodes a ping frame into the provided payload buffer.
    - If encoding fails, it returns 0.
    - Updates the connection flags to indicate a ping has been sent.
    - Records the packet metadata for potential retransmission.
- **Output**: Returns the size of the generated ping frame, or 0 if the frame could not be generated.
- **Functions Called**:
    - [`fd_quic_gen_frame_store_pkt_meta`](<#fd_quic_gen_frame_store_pkt_meta>)


---
### fd\_quic\_gen\_stream\_frames<!-- {{#callable:fd_quic_gen_stream_frames}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L3384>)

Generates QUIC stream frames for transmission.
- **Inputs**:
    - `conn`: Pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
    - `payload_ptr`: Pointer to the start of the payload buffer where stream frames will be written.
    - `payload_end`: Pointer to the end of the payload buffer to prevent overflow.
    - `pkt_meta_tmpl`: Pointer to a template for packet metadata used in frame generation.
    - `tracker`: Pointer to a tracker for managing packet metadata.
- **Logic and Control Flow**:
    - Initializes a loop to iterate through the streams in the connection.
    - Checks if the current stream has data to send and if it can be sent based on the packet number.
    - Calculates the available data and checks if there is space in the payload buffer.
    - Encodes the stream ID and optionally the offset into the payload.
    - Writes the stream data into the payload and updates the stream's metadata.
    - If all data from the stream has been sent, it updates the stream's state and moves it to the used streams list.
- **Output**: Returns a pointer to the updated position in the payload buffer after writing the stream frames.
- **Functions Called**:
    - [`fd_quic_conn_can_acquire_pkt_meta`](<#fd_quic_conn_can_acquire_pkt_meta>)
    - [`fd_quic_varint_encode`](<templ/fd_quic_parse_util.h.md#fd_quic_varint_encode>)
    - [`fd_quic_buffer_load`](<fd_quic_stream.c.md#fd_quic_buffer_load>)
    - [`fd_quic_gen_frame_store_pkt_meta`](<#fd_quic_gen_frame_store_pkt_meta>)


---
### fd\_quic\_gen\_frames<!-- {{#callable:fd_quic_gen_frames}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L3491>)

Generates QUIC frames for transmission based on the connection state.
- **Inputs**:
    - `conn`: Pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
    - `payload_ptr`: Pointer to the start of the payload buffer where frames will be generated.
    - `payload_end`: Pointer to the end of the payload buffer to prevent overflow.
    - `pkt_meta_tmpl`: Pointer to the `fd_quic_pkt_meta_t` structure that serves as a template for packet metadata.
    - `now`: Current time in nanoseconds used for scheduling.
- **Logic and Control Flow**:
    - Checks the connection state to determine if it is closing.
    - Generates ACK frames and updates the payload pointer.
    - If the connection is closing, generates a close frame.
    - If not closing, generates handshake frames and checks if the encryption level is application data.
    - If the encryption level is application data, generates handshake done, max data, max streams, and ping frames.
    - Generates stream frames if applicable.
    - Schedules the next service time based on the packet metadata expiry.
- **Output**: Returns a pointer to the updated position in the payload buffer after generating the frames.
- **Functions Called**:
    - [`fd_quic_gen_ack_frames`](<fd_quic_ack_tx.c.md#fd_quic_gen_ack_frames>)
    - [`fd_quic_gen_close_frame`](<#fd_quic_gen_close_frame>)
    - [`fd_quic_gen_handshake_frames`](<#fd_quic_gen_handshake_frames>)
    - [`fd_quic_gen_handshake_done_frame`](<#fd_quic_gen_handshake_done_frame>)
    - [`fd_quic_gen_max_data_frame`](<#fd_quic_gen_max_data_frame>)
    - [`fd_quic_gen_max_streams_frame`](<#fd_quic_gen_max_streams_frame>)
    - [`fd_quic_gen_ping_frame`](<#fd_quic_gen_ping_frame>)
    - [`fd_quic_gen_stream_frames`](<#fd_quic_gen_stream_frames>)
    - [`fd_quic_svc_prep_schedule`](<#fd_quic_svc_prep_schedule>)


---
### fd\_quic\_conn\_tx<!-- {{#callable:fd_quic_conn_tx}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L3541>)

Transmits QUIC connection data by encoding frames and managing packet transmission.
- **Inputs**:
    - `quic`: Pointer to the `fd_quic_t` structure representing the QUIC state.
    - `conn`: Pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
- **Logic and Control Flow**:
    - Check if the connection state is `FD_QUIC_CONN_STATE_DEAD`, and return if true.
    - Retrieve the current QUIC state using [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>).
    - Initialize variables for encoding frames and determining maximum packet size.
    - If there is data to transmit, call [`fd_quic_tx_buffered`](<#fd_quic_tx_buffered>) to handle buffered data.
    - Determine the encryption level for transmission using [`fd_quic_tx_enc_level`](<#fd_quic_tx_enc_level>).
    - If the encryption level is valid, proceed to encode the packet header and payload.
    - Handle the encoding of different packet types based on the encryption level.
    - Check if there is enough space for the new packet; if not, attempt to free space.
    - If the packet is successfully encoded, update the connection's packet number and prepare for transmission.
- **Output**: No return value; the function modifies the state of the connection and prepares data for transmission.
- **Functions Called**:
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_tx_buffered`](<#fd_quic_tx_buffered>)
    - [`fd_quic_svc_prep_schedule`](<#fd_quic_svc_prep_schedule>)
    - [`fd_quic_tx_enc_level`](<#fd_quic_tx_enc_level>)
    - [`fd_quic_abandon_enc_level`](<#fd_quic_abandon_enc_level>)
    - [`fd_quic_enc_level_to_pn_space`](<#fd_quic_enc_level_to_pn_space>)
    - [`fd_quic_initial_h0`](<templ/fd_quic_parse_util.h.md#fd_quic_initial_h0>)
    - [`fd_quic_handshake_h0`](<templ/fd_quic_parse_util.h.md#fd_quic_handshake_h0>)
    - [`fd_quic_one_rtt_h0`](<templ/fd_quic_parse_util.h.md#fd_quic_one_rtt_h0>)
    - [`fd_quic_gen_frames`](<#fd_quic_gen_frames>)
    - [`FD_FN_UNUSED::fd_quic_conn_tx_buf_remaining`](<#fd_fn_unusedfd_quic_conn_tx_buf_remaining>)
    - [`fd_quic_crypto_encrypt`](<crypto/fd_quic_crypto_suites.c.md#fd_quic_crypto_encrypt>)
    - [`fd_quic_set_conn_state`](<#fd_quic_set_conn_state>)
    - [`fd_quic_svc_prep_schedule_now`](<#fd_quic_svc_prep_schedule_now>)


---
### fd\_quic\_conn\_service<!-- {{#callable:fd_quic_conn_service}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L3870>)

Processes QUIC connection state and manages data transmission.
- **Inputs**:
    - `quic`: Pointer to the `fd_quic_t` structure representing the QUIC instance.
    - `conn`: Pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
    - `now`: Current time in nanoseconds used for timeout and scheduling.
- **Logic and Control Flow**:
    - Checks if a new RTT measurement probe should be sent based on the current time and last acknowledgment time.
    - If conditions are met, sets the PING flag and updates the packet number to be sent in the next packet.
    - Handles expiration of packet metadata.
    - Switches based on the current connection state to determine the appropriate actions.
    - In HANDSHAKE and HANDSHAKE_COMPLETE states, manages TLS handshake completion and data transmission.
    - In CLOSE_PENDING and PEER_CLOSE states, prepares to close the connection and transmit failure reasons.
    - In ACTIVE state, checks for data to transmit.
    - Logs an error for invalid or dead states.
- **Output**: The function does not return a value but modifies the state of the connection and may schedule further actions.
- **Functions Called**:
    - [`fd_quic_pkt_meta_retry`](<#fd_quic_pkt_meta_retry>)
    - [`fd_quic_set_conn_state`](<#fd_quic_set_conn_state>)
    - [`fd_quic_abandon_enc_level`](<#fd_quic_abandon_enc_level>)
    - [`fd_quic_cb_conn_new`](<fd_quic_private.h.md#fd_quic_cb_conn_new>)
    - [`fd_quic_tls_clear_hs_data`](<tls/fd_quic_tls.c.md#fd_quic_tls_clear_hs_data>)
    - [`fd_quic_conn_tx`](<#fd_quic_conn_tx>)


---
### fd\_quic\_conn\_free<!-- {{#callable:fd_quic_conn_free}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L3971>)

Frees resources associated with a QUIC connection.
- **Inputs**:
    - `quic`: Pointer to the `fd_quic_t` structure representing the QUIC instance.
    - `conn`: Pointer to the `fd_quic_conn_t` structure representing the connection to be freed.
- **Logic and Control Flow**:
    - Check if `conn` is NULL; if so, log a warning and return.
    - Check if the connection state is invalid; if so, log a critical error and return.
    - Set the connection state to invalid using [`fd_quic_set_conn_state`](<#fd_quic_set_conn_state>).
    - Free packet metadata associated with the connection for each encryption level.
    - Iterate through used streams and free each stream using [`fd_quic_tx_stream_free`](<#fd_quic_tx_stream_free>).
    - Iterate through send streams and free each stream using [`fd_quic_tx_stream_free`](<#fd_quic_tx_stream_free>).
    - Check if any stream map entries remain; if so, log a warning and attempt to remove them.
    - If the connection has a TLS handshake state, free it and remove it from the handshake cache.
    - Cancel any scheduled service timers for the connection.
    - Add the connection back to the free list.
    - Clear the connection's secrets and keys.
- **Output**: The function does not return a value; it performs cleanup operations on the connection.
- **Functions Called**:
    - [`fd_quic_set_conn_state`](<#fd_quic_set_conn_state>)
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_conn_free_pkt_meta`](<#fd_quic_conn_free_pkt_meta>)
    - [`fd_quic_tx_stream_free`](<#fd_quic_tx_stream_free>)
    - [`fd_quic_tls_hs_delete`](<tls/fd_quic_tls.c.md#fd_quic_tls_hs_delete>)
    - [`fd_quic_svc_timers_cancel`](<fd_quic_svc_q.c.md#fd_quic_svc_timers_cancel>)


---
### fd\_quic\_connect<!-- {{#callable:fd_quic_connect}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L4070>)

Establishes a QUIC connection with specified parameters.
- **Inputs**:
    - `quic`: Pointer to the `fd_quic_t` structure representing the QUIC instance.
    - `dst_ip_addr`: Destination IP address for the QUIC connection.
    - `dst_udp_port`: Destination UDP port for the QUIC connection.
    - `src_ip_addr`: Source IP address for the QUIC connection.
    - `src_udp_port`: Source UDP port for the QUIC connection.
    - `now`: Current time in milliseconds since epoch.
- **Logic and Control Flow**:
    - Retrieve the current state of the QUIC instance using [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>).
    - Set the current time in the state.
    - Check if the handshake pool is free; if not, attempt to evict the oldest handshake.
    - Generate connection IDs for the local and peer connections.
    - Create a new QUIC connection using [`fd_quic_conn_create`](<#fd_quic_conn_create>) with the generated IDs and provided addresses.
    - If connection creation fails, log the error and return NULL.
    - Prepare transport parameters for the QUIC-TLS handshake.
    - Clear the original destination connection ID and retry fields in the transport parameters.
    - Create a new TLS handshake using [`fd_quic_tls_hs_new`](<tls/fd_quic_tls.c.md#fd_quic_tls_hs_new>).
    - If the TLS handshake fails, free the connection and return NULL.
    - Cache the TLS handshake and increment the handshake creation count.
    - Generate initial secrets and keys for the connection.
    - Set a flag to indicate that the connection has been newly created.
    - Schedule the connection for service and return the connection pointer.
- **Output**: Returns a pointer to the newly created `fd_quic_conn_t` structure representing the established connection, or NULL if the connection could not be established.
- **Functions Called**:
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_tls_hs_cache_evict`](<#fd_quic_tls_hs_cache_evict>)
    - [`fd_quic_conn_id_rand`](<fd_quic_conn_id.h.md#fd_quic_conn_id_rand>)
    - [`fd_quic_conn_create`](<#fd_quic_conn_create>)
    - [`fd_quic_tls_hs_new`](<tls/fd_quic_tls.c.md#fd_quic_tls_hs_new>)
    - [`fd_quic_conn_free`](<#fd_quic_conn_free>)
    - [`fd_quic_gen_initial_secret_and_keys`](<#fd_quic_gen_initial_secret_and_keys>)
    - [`fd_quic_svc_prep_schedule`](<#fd_quic_svc_prep_schedule>)
    - [`fd_quic_svc_timers_schedule`](<fd_quic_svc_q.c.md#fd_quic_svc_timers_schedule>)


---
### fd\_quic\_conn\_create<!-- {{#callable:fd_quic_conn_create}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L4166>)

Creates a new QUIC connection.
- **Inputs**:
    - `quic`: Pointer to the `fd_quic_t` structure representing the QUIC instance.
    - `our_conn_id`: The connection ID for the local endpoint.
    - `peer_conn_id`: Pointer to the `fd_quic_conn_id_t` structure representing the peer's connection ID.
    - `peer_ip_addr`: The IP address of the peer.
    - `peer_udp_port`: The UDP port of the peer.
    - `self_ip_addr`: The local IP address.
    - `self_udp_port`: The local UDP port.
    - `server`: Integer indicating if this endpoint is a server (non-zero) or client (zero).
- **Logic and Control Flow**:
    - Checks if `our_conn_id` is zero; if so, returns NULL.
    - Fetches the top of the connection free list and checks for available slots.
    - Validates the connection index and checks if the connection state is invalid.
    - Prunes any previous connection map entry for the same connection ID.
    - Inserts the new connection into the connection map.
    - Removes the connection from the free list and initializes its members.
    - Initializes the packet meta tracker and stream lists.
    - Sets the connection state to HANDSHAKE and prepares for the connection.
- **Output**: Returns a pointer to the newly created `fd_quic_conn_t` structure or NULL if the creation fails.
- **Functions Called**:
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_conn_at_idx`](<fd_quic_private.h.md#fd_quic_conn_at_idx>)
    - [`fd_quic_conn_query1`](<fd_quic_private.h.md#fd_quic_conn_query1>)
    - [`fd_quic_conn_clear`](<fd_quic_conn.h.md#fd_quic_conn_clear>)
    - [`fd_quic_pkt_meta_tracker_init`](<fd_quic_pkt_meta.c.md#fd_quic_pkt_meta_tracker_init>)
    - [`fd_quic_set_conn_state`](<#fd_quic_set_conn_state>)
    - [`fd_quic_svc_timers_init_conn`](<fd_quic_svc_q.c.md#fd_quic_svc_timers_init_conn>)
    - [`fd_quic_svc_prep_schedule`](<#fd_quic_svc_prep_schedule>)


---
### fd\_quic\_get\_next\_wakeup<!-- {{#callable:fd_quic_get_next_wakeup}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L4322>)

Retrieves the next timeout value for QUIC service timers.
- **Inputs**:
    - `quic`: Pointer to a `fd_quic_t` structure representing the QUIC connection.
- **Logic and Control Flow**:
    - Calls [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>) to obtain the current state of the QUIC connection.
    - Retrieves the current time from the state.
    - Calls [`fd_quic_svc_timers_next`](<fd_quic_svc_q.c.md#fd_quic_svc_timers_next>) to get the next timer event based on the current time.
    - Returns the timeout value from the next timer event.
- **Output**: Returns a long integer representing the timeout value for the next wakeup event.
- **Functions Called**:
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_svc_timers_next`](<fd_quic_svc_q.c.md#fd_quic_svc_timers_next>)


---
### fd\_quic\_handle\_ping\_frame<!-- {{#callable:fd_quic_handle_ping_frame}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L4343>)

Handles the processing of a QUIC ping frame.
- **Inputs**:
    - `ctx`: Pointer to the context of the QUIC frame.
    - `data`: Pointer to the QUIC ping frame data.
    - `p0`: Pointer to the start of the payload.
    - `p_sz`: Size of the payload.
- **Logic and Control Flow**:
    - Logs the connection ID associated with the ping frame using `FD_DTRACE_PROBE_1`.
    - Initializes pointers to the start and end of the payload.
    - Iterates through the payload, skipping bytes that are either ping frames or padding.
    - Returns the number of bytes processed from the start of the payload to the end of the processed data.
- **Output**: Returns the number of bytes consumed from the payload.


---
### fd\_quic\_pkt\_meta\_retry<!-- {{#callable:fd_quic_pkt_meta_retry}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L4364>)

Reclaims packet metadata for retransmission in a QUIC connection.
- **Inputs**:
    - `quic`: Pointer to the `fd_quic_t` structure representing the QUIC instance.
    - `conn`: Pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
    - `force`: Integer flag indicating whether to force the reclamation of packet metadata.
    - `arg_enc_level`: Unsigned integer representing the encryption level for which to reclaim packet metadata.
- **Logic and Control Flow**:
    - Retrieve the current time from the QUIC state.
    - Determine the minimum number of packet metadata to be freed based on the `force` flag.
    - Initialize a loop to find the earliest expiring packet metadata across encryption levels.
    - If `arg_enc_level` is not specified, iterate through all encryption levels to find the earliest expiring packet.
    - If the minimum number of packet metadata has been freed or no packets have expired, prepare to schedule the next service.
    - For each packet metadata found, check if it can be reclaimed based on the encryption level and peer encryption level.
    - Update metrics for retransmissions and prepare the data for retransmission based on the type of packet metadata.
- **Output**: The function does not return a value but modifies the state of the QUIC connection by reclaiming packet metadata.
- **Functions Called**:
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_pkt_meta_min`](<fd_quic_pkt_meta.c.md#fd_quic_pkt_meta_min>)
    - [`fd_quic_svc_prep_schedule`](<#fd_quic_svc_prep_schedule>)
    - [`fd_quic_reclaim_pkt_meta_level`](<#fd_quic_reclaim_pkt_meta_level>)
    - [`fd_quic_tx_stream_free`](<#fd_quic_tx_stream_free>)
    - [`fd_quic_svc_prep_schedule_now`](<#fd_quic_svc_prep_schedule_now>)
    - [`fd_quic_pkt_meta_remove`](<fd_quic_pkt_meta.c.md#fd_quic_pkt_meta_remove>)


---
### fd\_quic\_reclaim\_pkt\_meta<!-- {{#callable:fd_quic_reclaim_pkt_meta}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L4568>)

Reclaims packet metadata for a QUIC connection based on the type of packet.
- **Inputs**:
    - `conn`: Pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
    - `pkt_meta`: Pointer to the `fd_quic_pkt_meta_t` structure containing metadata about the packet.
    - `enc_level`: An unsigned integer representing the encryption level of the packet.
- **Logic and Control Flow**:
    - Extracts the packet type from `pkt_meta->key.type`.
    - Uses a switch statement to handle different packet types.
    - For `FD_QUIC_PKT_META_TYPE_PING`, clears the ping flags.
    - For `FD_QUIC_PKT_META_TYPE_HS_DATA`, checks if the acknowledged bytes can be increased and updates the handshake data accordingly.
    - For `FD_QUIC_PKT_META_TYPE_HS_DONE`, marks the handshake as acknowledged and cleans up the handshake state.
    - For `FD_QUIC_PKT_META_TYPE_MAX_DATA`, checks for protocol violations and updates the maximum data acknowledged.
    - For `FD_QUIC_PKT_META_TYPE_MAX_STREAMS_UNIDIR`, updates the maximum unidirectional streams acknowledged.
    - For `FD_QUIC_PKT_META_TYPE_STREAM`, processes stream data and updates the stream's acknowledged bytes.
- **Output**: The function does not return a value but modifies the state of the connection and its associated packet metadata.
- **Functions Called**:
    - [`fd_quic_tls_get_hs_data`](<tls/fd_quic_tls.c.md#fd_quic_tls_get_hs_data>)
    - [`fd_quic_tls_pop_hs_data`](<tls/fd_quic_tls.c.md#fd_quic_tls_pop_hs_data>)
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_tls_hs_delete`](<tls/fd_quic_tls.c.md#fd_quic_tls_hs_delete>)
    - [`fd_quic_conn_error`](<#fd_quic_conn_error>)
    - [`fd_quic_svc_prep_schedule_now`](<#fd_quic_svc_prep_schedule_now>)
    - [`fd_quic_tx_stream_free`](<#fd_quic_tx_stream_free>)


---
### fd\_quic\_process\_lost<!-- {{#callable:fd_quic_process_lost}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L4806>)

Processes lost QUIC packets and triggers retries.
- **Inputs**:
    - `conn`: Pointer to the QUIC connection structure.
    - `enc_level`: The encryption level of the packets to process.
    - `cnt`: The number of packets to mark as lost.
- **Logic and Control Flow**:
    - Initializes a tracker from the connection's packet metadata.
    - Iterates through the sent packet metadata for the specified encryption level.
    - Marks the first 'cnt' packets as expired by setting their expiry to zero.
    - Calls the retry function to handle retransmission of the lost packets.
- **Output**: No return value; the function modifies the state of the connection and triggers retries.
- **Functions Called**:
    - [`fd_quic_pkt_meta_ds_fwd_iter_init`](<fd_quic_pkt_meta.h.md#fd_quic_pkt_meta_ds_fwd_iter_init>)
    - [`fd_quic_pkt_meta_ds_fwd_iter_done`](<fd_quic_pkt_meta.h.md#fd_quic_pkt_meta_ds_fwd_iter_done>)
    - [`fd_quic_pkt_meta_ds_fwd_iter_next`](<fd_quic_pkt_meta.h.md#fd_quic_pkt_meta_ds_fwd_iter_next>)
    - [`fd_quic_pkt_meta_ds_fwd_iter_ele`](<fd_quic_pkt_meta.h.md#fd_quic_pkt_meta_ds_fwd_iter_ele>)
    - [`fd_quic_pkt_meta_retry`](<#fd_quic_pkt_meta_retry>)


---
### fd\_quic\_process\_ack\_range<!-- {{#callable:fd_quic_process_ack_range}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L4832>)

Processes acknowledgment ranges for QUIC packets.
- **Inputs**:
    - `conn`: Pointer to the QUIC connection structure.
    - `context`: Pointer to the frame context structure.
    - `enc_level`: The encryption level of the packets.
    - `largest_ack`: The largest acknowledged packet number.
    - `ack_range`: The range of acknowledged packets.
    - `is_largest`: Flag indicating if this is the largest acknowledged packet.
    - `now`: The current time in nanoseconds.
    - `ack_delay`: The acknowledgment delay in peer units.
- **Logic and Control Flow**:
    - Calculates the inclusive range of acknowledged packets using `largest_ack` and `ack_range`.
    - Uses a forward iterator to traverse sent packet metadata starting from the oldest sent packet.
    - Checks if each packet number is within the acknowledged range and processes it accordingly.
    - Updates round-trip time (RTT) metrics if the largest acknowledged packet is received.
    - Reclaims packet metadata for acknowledged packets and updates the connection's used packet metadata count.
- **Output**: No return value; modifies the state of the connection and updates metrics.
- **Functions Called**:
    - [`fd_quic_pkt_meta_ds_idx_ge`](<fd_quic_pkt_meta.h.md#fd_quic_pkt_meta_ds_idx_ge>)
    - [`fd_quic_pkt_meta_ds_fwd_iter_done`](<fd_quic_pkt_meta.h.md#fd_quic_pkt_meta_ds_fwd_iter_done>)
    - [`fd_quic_pkt_meta_ds_fwd_iter_next`](<fd_quic_pkt_meta.h.md#fd_quic_pkt_meta_ds_fwd_iter_next>)
    - [`fd_quic_pkt_meta_ds_fwd_iter_ele`](<fd_quic_pkt_meta.h.md#fd_quic_pkt_meta_ds_fwd_iter_ele>)
    - [`fd_quic_reclaim_pkt_meta`](<#fd_quic_reclaim_pkt_meta>)
    - [`fd_quic_pkt_meta_remove_range`](<fd_quic_pkt_meta.c.md#fd_quic_pkt_meta_remove_range>)


---
### fd\_quic\_handle\_ack\_frame<!-- {{#callable:fd_quic_handle_ack_frame}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L4871>)

Processes an ACK frame in a QUIC connection.
- **Inputs**:
    - `context`: Pointer to the frame context containing connection information.
    - `data`: Pointer to the ACK frame data structure.
    - `p`: Pointer to the byte stream containing the frame data.
    - `p_sz`: Size of the byte stream.
- **Logic and Control Flow**:
    - Checks if the first ACK range is greater than the largest acknowledged packet, signaling a protocol violation.
    - Updates the connection's last acknowledged time.
    - Processes the ACK range for the largest acknowledged packet.
    - Iterates through additional ACK ranges, decoding each and processing them.
    - Tracks lost packets based on the lowest acknowledged packet number.
- **Output**: Returns the number of bytes consumed from the input stream.
- **Functions Called**:
    - [`fd_quic_frame_error`](<#fd_quic_frame_error>)
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_process_ack_range`](<#fd_quic_process_ack_range>)
    - [`fd_quic_pkt_meta_min`](<fd_quic_pkt_meta.c.md#fd_quic_pkt_meta_min>)
    - [`fd_quic_pkt_meta_ds_fwd_iter_init`](<fd_quic_pkt_meta.h.md#fd_quic_pkt_meta_ds_fwd_iter_init>)
    - [`fd_quic_pkt_meta_ds_fwd_iter_done`](<fd_quic_pkt_meta.h.md#fd_quic_pkt_meta_ds_fwd_iter_done>)
    - [`fd_quic_pkt_meta_ds_fwd_iter_next`](<fd_quic_pkt_meta.h.md#fd_quic_pkt_meta_ds_fwd_iter_next>)
    - [`fd_quic_pkt_meta_ds_fwd_iter_ele`](<fd_quic_pkt_meta.h.md#fd_quic_pkt_meta_ds_fwd_iter_ele>)
    - [`fd_quic_process_lost`](<#fd_quic_process_lost>)


---
### fd\_quic\_handle\_stop\_sending\_frame<!-- {{#callable:fd_quic_handle_stop_sending_frame}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L5029>)

Handles the `STOP_SENDING` frame in a QUIC connection.
- **Inputs**:
    - `context`: Pointer to the `fd_quic_frame_ctx_t` structure containing connection context.
    - `data`: Pointer to the `fd_quic_stop_sending_frame_t` structure containing frame data.
    - `p`: Pointer to the payload data, unused in this function.
    - `p_sz`: Size of the payload data, unused in this function.
- **Logic and Control Flow**:
    - Logs the handling of the `STOP_SENDING` frame using `FD_DTRACE_PROBE_3`.
    - The function does not perform any operations on the input data and returns 0.
- **Output**: Returns 0, indicating no bytes were consumed from the buffer.


---
### fd\_quic\_tx\_stream\_free<!-- {{#callable:fd_quic_tx_stream_free}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L5051>)

Frees resources associated with a QUIC transmission stream.
- **Inputs**:
    - `quic`: Pointer to the `fd_quic_t` structure representing the QUIC context.
    - `conn`: Pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
    - `stream`: Pointer to the `fd_quic_stream_t` structure representing the QUIC stream to be freed.
    - `code`: Integer representing the reason code for freeing the stream.
- **Logic and Control Flow**:
    - Checks if the `stream` state is not `FD_QUIC_STREAM_STATE_UNUSED`.
    - If the state is valid, calls [`fd_quic_cb_stream_notify`](<fd_quic_private.h.md#fd_quic_cb_stream_notify>) to notify about the stream's end.
    - Sets the stream's state to `FD_QUIC_STREAM_STATE_UNUSED`.
    - Retrieves the `stream_id` from the `stream` structure.
    - Queries the `stream_map` for the corresponding stream entry using `stream_id`.
    - If the stream entry is found, marks the stream as dead and removes it from the `stream_map`.
    - Removes the stream from the list of active streams.
    - Sets the stream's flags to indicate it is dead and resets its `stream_id`.
    - Frees the stream back to the stream pool.
- **Output**: The function does not return a value.
- **Functions Called**:
    - [`fd_quic_cb_stream_notify`](<fd_quic_private.h.md#fd_quic_cb_stream_notify>)
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_stream_pool_free`](<fd_quic_stream_pool.c.md#fd_quic_stream_pool_free>)


---
### fd\_quic\_handle\_stream\_frame<!-- {{#callable:fd_quic_handle_stream_frame}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L5087>)

Handles the processing of a QUIC stream frame.
- **Inputs**:
    - `context`: Pointer to the `fd_quic_frame_ctx_t` structure containing context for the QUIC frame.
    - `p`: Pointer to the data buffer containing the stream frame.
    - `p_sz`: Size of the data buffer.
    - `stream_id`: Identifier for the stream associated with the frame.
    - `offset`: Offset in the stream where the data begins.
    - `data_sz`: Size of the data being sent in the stream frame.
    - `fin`: Flag indicating if this is the final frame for the stream.
- **Logic and Control Flow**:
    - Logs the entry into the function with a DTrace probe.
    - Checks the type of the `stream_id` to ensure it matches the expected type for the connection role.
    - If the stream type is invalid, logs a debug message and calls [`fd_quic_frame_error`](<#fd_quic_frame_error>) to handle the error.
    - Checks if the `data_sz` exceeds the size of the provided buffer `p_sz`.
    - If the length check fails, logs a debug message and calls [`fd_quic_frame_error`](<#fd_quic_frame_error>).
    - Increments the `unacked_sz` of the connection by the size of the data.
    - Validates that the `stream_id` is within the allowed range.
    - If the stream ID is out of range, logs a debug message and calls [`fd_quic_frame_error`](<#fd_quic_frame_error>).
    - Checks if the data being sent exceeds the flow control limits.
    - If it does, logs a debug message and calls [`fd_quic_frame_error`](<#fd_quic_frame_error>).
    - Calls [`fd_quic_cb_stream_rx`](<fd_quic_private.h.md#fd_quic_cb_stream_rx>) to process the received stream data.
    - Updates the acknowledgment flag in the packet based on the result of the stream processing.
    - Returns the number of bytes consumed from the stream frame.
- **Output**: Returns the number of bytes consumed from the stream frame.
- **Functions Called**:
    - [`fd_quic_frame_error`](<#fd_quic_frame_error>)
    - [`fd_quic_cb_stream_rx`](<fd_quic_private.h.md#fd_quic_cb_stream_rx>)


---
### fd\_quic\_handle\_stream\_a\_frame<!-- {{#callable:fd_quic_handle_stream_a_frame}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L5151>)

Processes a QUIC stream frame.
- **Inputs**:
    - `context`: Pointer to the QUIC frame context containing connection and packet information.
    - `data`: Pointer to the `fd_quic_stream_a_frame_t` structure containing stream frame data.
    - `p`: Pointer to the data buffer containing the frame payload.
    - `p_sz`: Size of the data buffer.
- **Logic and Control Flow**:
    - Check if the stream ID type matches the expected type for the connection.
    - Validate the length of the data against the available buffer size.
    - Update the unacked size of the connection with the size of the stream data.
    - Call the stream receive callback to process the stream data.
    - Set the acknowledgment flag based on the result of the stream receive callback.
- **Output**: Returns the number of bytes consumed from the buffer.
- **Functions Called**:
    - [`fd_quic_handle_stream_frame`](<#fd_quic_handle_stream_frame>)


---
### fd\_quic\_handle\_stream\_e\_frame<!-- {{#callable:fd_quic_handle_stream_e_frame}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L5169>)

Handles the QUIC stream 'E' frame by processing its data and invoking the appropriate stream handling function.
- **Inputs**:
    - `context`: Pointer to the `fd_quic_frame_ctx_t` structure that contains the context for the QUIC frame.
    - `data`: Pointer to the `fd_quic_stream_e_frame_t` structure that contains the stream frame data.
    - `p`: Pointer to the byte array containing the frame payload.
    - `p_sz`: Size of the payload in bytes.
- **Logic and Control Flow**:
    - Checks the validity of the stream ID and its type against the expected type for the connection.
    - Validates the length of the data against the size of the payload.
    - Updates the unacked size of the connection with the size of the data being processed.
    - Calls the [`fd_quic_handle_stream_frame`](<#fd_quic_handle_stream_frame>) function to handle the actual processing of the stream frame.
- **Output**: Returns the number of bytes consumed from the payload.
- **Functions Called**:
    - [`fd_quic_handle_stream_frame`](<#fd_quic_handle_stream_frame>)


---
### fd\_quic\_handle\_max\_data\_frame<!-- {{#callable:fd_quic_handle_max_data_frame}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L5178>)

Handles the `MAX_DATA` frame in a QUIC connection.
- **Inputs**:
    - `context`: Pointer to the `fd_quic_frame_ctx_t` structure containing connection context.
    - `data`: Pointer to the `fd_quic_max_data_frame_t` structure containing the new maximum data value.
    - `p`: Pointer to the payload data, unused in this function.
    - `p_sz`: Size of the payload data, unused in this function.
- **Logic and Control Flow**:
    - Retrieve the connection object from the context.
    - Store the old maximum data value from the connection.
    - Store the new maximum data value from the frame.
    - Log the handling of the `MAX_DATA` frame.
    - Update the connection's maximum data value to the greater of the old and new values.
    - Return 0 to indicate no additional bytes were consumed from the buffer.
- **Output**: Returns 0, indicating that no additional bytes were consumed from the buffer.


---
### fd\_quic\_handle\_max\_stream\_data\_frame<!-- {{#callable:fd_quic_handle_max_stream_data_frame}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L5196>)

Handles the `MAX_STREAM_DATA` frame in QUIC.
- **Inputs**:
    - `context`: Pointer to the `fd_quic_frame_ctx_t` structure containing connection context.
    - `data`: Pointer to the `fd_quic_max_stream_data_frame_t` structure containing stream data information.
    - `p`: Pointer to the data buffer, unused in this function.
    - `p_sz`: Size of the data buffer, unused in this function.
- **Logic and Control Flow**:
    - The function starts by extracting the connection from the context.
    - It retrieves the current maximum stream data limit for the connection.
    - The new maximum stream data value is compared to the old value.
    - If the new value is greater than the old value, it updates the connection's maximum stream data limit.
    - The function does not return any additional bytes consumed from the buffer.
- **Output**: Returns 0, indicating no additional bytes were consumed from the buffer.


---
### fd\_quic\_handle\_max\_streams\_frame<!-- {{#callable:fd_quic_handle_max_streams_frame}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L5207>)

Handles the `MAX_STREAMS` frame in a QUIC connection.
- **Inputs**:
    - `context`: Pointer to the `fd_quic_frame_ctx_t` structure containing connection context.
    - `data`: Pointer to the `fd_quic_max_streams_frame_t` structure containing the frame data.
    - `p`: Pointer to the unused data buffer.
    - `p_sz`: Size of the unused data buffer.
- **Logic and Control Flow**:
    - Retrieves the connection from the `context` using `context->conn`.
    - Logs the handling of the `MAX_STREAMS` frame using `FD_DTRACE_PROBE_3`.
    - Checks if the `data->type` is equal to 0x13, indicating unidirectional streams.
    - Calculates the `peer_sup_stream_id` based on the `data->max_streams` and the connection's server status.
    - Updates the connection's `tx_sup_stream_id` to the maximum of the calculated `peer_sup_stream_id` and the current `tx_sup_stream_id`.
- **Output**: Returns 0, indicating no additional bytes were consumed from the buffer.


---
### fd\_quic\_handle\_data\_blocked\_frame<!-- {{#callable:fd_quic_handle_data_blocked_frame}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L5226>)

Handles the `DATA_BLOCKED` frame in QUIC protocol.
- **Inputs**:
    - `context`: Pointer to the `fd_quic_frame_ctx_t` structure containing connection context.
    - `data`: Pointer to the `fd_quic_data_blocked_frame_t` structure containing the frame data.
    - `p`: Pointer to the unused data buffer.
    - `p_sz`: Size of the unused data buffer.
- **Logic and Control Flow**:
    - Logs the `DATA_BLOCKED` event using `FD_DTRACE_PROBE_2`.
    - Returns 0 immediately since no runtime allocations are performed for `DATA_BLOCKED`.
- **Output**: Returns 0, indicating no additional bytes were consumed from the buffer.


---
### fd\_quic\_handle\_stream\_data\_blocked\_frame<!-- {{#callable:fd_quic_handle_stream_data_blocked_frame}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L5239>)

Handles the `STREAM_DATA_BLOCKED` frame in QUIC.
- **Inputs**:
    - `context`: Pointer to the `fd_quic_frame_ctx_t` structure containing connection context.
    - `data`: Pointer to the `fd_quic_stream_data_blocked_frame_t` structure containing stream data blocked information.
    - `p`: Pointer to the payload data, which is unused in this function.
    - `p_sz`: Size of the payload data, which is unused in this function.
- **Logic and Control Flow**:
    - Logs the handling of the `STREAM_DATA_BLOCKED` frame using `FD_DTRACE_PROBE_3`.
    - The function does not perform any memory allocation or state changes.
    - Returns 0 to indicate successful handling of the frame.
- **Output**: Returns 0, indicating successful processing of the frame.


---
### fd\_quic\_handle\_retire\_conn\_id\_frame<!-- {{#callable:fd_quic_handle_retire_conn_id_frame}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L5281>)

Handles the QUIC 'Retire Connection ID' frame.
- **Inputs**:
    - `context`: Pointer to the frame context containing connection and packet information.
    - `data`: Pointer to the 'Retire Connection ID' frame data.
    - `p`: Pointer to the payload data, which is unused in this function.
    - `p_sz`: Size of the payload data, which is unused in this function.
- **Logic and Control Flow**:
    - Logs a probe for the 'Retire Connection ID' frame with the connection ID.
    - The function does not perform any operations on the input data.
    - Returns 0 to indicate no bytes were consumed from the payload.
- **Output**: Returns 0, indicating that no bytes were consumed from the input payload.


---
### fd\_quic\_handle\_path\_response\_frame<!-- {{#callable:fd_quic_handle_path_response_frame}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L5306>)

Handles the `PATH_RESPONSE` frame in QUIC protocol.
- **Inputs**:
    - `context`: Pointer to the `fd_quic_frame_ctx_t` structure containing connection context.
    - `data`: Pointer to the `fd_quic_path_response_frame_t` structure containing the data of the path response.
    - `p`: Pointer to the unused payload data.
    - `p_sz`: Size of the payload data.
- **Logic and Control Flow**:
    - Logs a probe indicating the arrival of a `PATH_RESPONSE` frame.
    - The function does not process the frame further since `PATH_CHALLENGE` frames are not generated.
    - Returns 0 to indicate no bytes were consumed from the payload.
- **Output**: Returns 0, indicating that no bytes were consumed from the payload.


---
### fd\_quic\_handle\_conn\_close\_frame<!-- {{#callable:fd_quic_handle_conn_close_frame}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L5318>)

Handles the connection close frame in a QUIC connection.
- **Inputs**:
    - `conn`: Pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
- **Logic and Control Flow**:
    - Logs a debug message indicating that the peer has requested to close the connection.
    - Checks the current state of the connection.
    - If the state is `FD_QUIC_CONN_STATE_PEER_CLOSE`, `FD_QUIC_CONN_STATE_ABORT`, or `FD_QUIC_CONN_STATE_CLOSE_PENDING`, the function returns without making changes.
    - If the state is different, it sets the connection state to `FD_QUIC_CONN_STATE_PEER_CLOSE`.
    - Updates the packet number to indicate a pending update.
    - Schedules the connection for immediate servicing.
- **Output**: The function does not return a value; it modifies the state of the connection based on the close request.
- **Functions Called**:
    - [`fd_quic_set_conn_state`](<#fd_quic_set_conn_state>)
    - [`fd_quic_svc_prep_schedule_now`](<#fd_quic_svc_prep_schedule_now>)


---
### fd\_quic\_handle\_conn\_close\_0\_frame<!-- {{#callable:fd_quic_handle_conn_close_0_frame}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L5339>)

Handles the QUIC connection close frame of type 0.
- **Inputs**:
    - `context`: Pointer to the frame context containing connection information.
    - `data`: Pointer to the connection close frame data.
    - `p`: Pointer to the payload data.
    - `p_sz`: Size of the payload data.
- **Logic and Control Flow**:
    - Checks if the length of the reason phrase exceeds the size of the payload.
    - If the length is invalid, it calls [`fd_quic_frame_error`](<#fd_quic_frame_error>) to report a frame encoding error.
    - Logs the error details for debugging purposes.
    - Calls [`fd_quic_handle_conn_close_frame`](<#fd_quic_handle_conn_close_frame>) to handle the connection closure.
- **Output**: Returns the length of the reason phrase if successful, otherwise indicates a failure.
- **Functions Called**:
    - [`fd_quic_frame_error`](<#fd_quic_frame_error>)
    - [`fd_quic_handle_conn_close_frame`](<#fd_quic_handle_conn_close_frame>)


---
### fd\_quic\_handle\_conn\_close\_1\_frame<!-- {{#callable:fd_quic_handle_conn_close_1_frame}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L5378>)

Handles the QUIC connection close frame of version 1.
- **Inputs**:
    - `context`: Pointer to the QUIC frame context.
    - `data`: Pointer to the QUIC connection close frame data.
    - `p`: Pointer to the payload data.
    - `p_sz`: Size of the payload data.
- **Logic and Control Flow**:
    - Checks if the reason phrase length exceeds the size of the payload.
    - Logs a warning if the length check fails and returns a failure code.
    - Copies the reason phrase from the payload into a buffer for logging.
    - Calls the function to handle the connection close event.
    - Returns the length of the reason phrase.
- **Output**: Returns the length of the reason phrase if successful, or a failure code.
- **Functions Called**:
    - [`fd_quic_frame_error`](<#fd_quic_frame_error>)
    - [`fd_quic_handle_conn_close_frame`](<#fd_quic_handle_conn_close_frame>)


---
### fd\_quic\_handle\_handshake\_done\_frame<!-- {{#callable:fd_quic_handle_handshake_done_frame}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L5415>)

Handles the reception of a `HANDSHAKE_DONE` frame in a QUIC connection.
- **Inputs**:
    - `context`: Pointer to the `fd_quic_frame_ctx_t` structure containing connection context.
    - `data`: Pointer to the `fd_quic_handshake_done_frame_t` structure containing the handshake done frame data.
    - `p`: Pointer to the payload data, unused in this function.
    - `p_sz`: Size of the payload data, unused in this function.
- **Logic and Control Flow**:
    - Checks if the connection is a server; if so, it triggers a protocol violation error.
    - If the connection is still in the handshake state, it marks the packet as canceled due to potential reordering.
    - If the connection is not in the handshake complete state, it returns without processing further.
    - Acknowledges the first `HANDSHAKE_DONE` frame immediately.
    - Discards handshake keys as per RFC 9001 requirements.
    - Clears any remaining handshake data at the application level.
    - Sets the connection state to active.
    - Calls the user callback to indicate handshake completion.
    - Deallocates the TLS handshake state if it exists.
- **Output**: Returns 0 on success, or a failure code if an error occurs.
- **Functions Called**:
    - [`fd_quic_frame_error`](<#fd_quic_frame_error>)
    - [`fd_quic_svc_prep_schedule_now`](<#fd_quic_svc_prep_schedule_now>)
    - [`fd_quic_abandon_enc_level`](<#fd_quic_abandon_enc_level>)
    - [`fd_quic_tls_clear_hs_data`](<tls/fd_quic_tls.c.md#fd_quic_tls_clear_hs_data>)
    - [`fd_quic_set_conn_state`](<#fd_quic_set_conn_state>)
    - [`fd_quic_cb_conn_hs_complete`](<fd_quic_private.h.md#fd_quic_cb_conn_hs_complete>)
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_tls_hs_delete`](<tls/fd_quic_tls.c.md#fd_quic_tls_hs_delete>)


---
### fd\_quic\_conn\_close<!-- {{#callable:fd_quic_conn_close}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L5478>)

Closes a QUIC connection and schedules it for servicing.
- **Inputs**:
    - `conn`: Pointer to the `fd_quic_conn_t` structure representing the connection to be closed.
    - `app_reason`: Application-specific reason code for closing the connection.
- **Logic and Control Flow**:
    - Checks if `conn` is NULL; if so, the function returns immediately.
    - Switches on the state of the connection.
    - If the state is `FD_QUIC_CONN_STATE_INVALID`, `FD_QUIC_CONN_STATE_DEAD`, or `FD_QUIC_CONN_STATE_ABORT`, the function returns without action.
    - Sets the connection state to `FD_QUIC_CONN_STATE_CLOSE_PENDING` and assigns `app_reason` to the connection's reason.
    - Prepares the connection for immediate servicing by calling [`fd_quic_svc_prep_schedule_now`](<#fd_quic_svc_prep_schedule_now>) and schedules it with [`fd_quic_svc_schedule1`](<#fd_quic_svc_schedule1>).
- **Output**: The function does not return a value. It modifies the state of the connection and schedules it for servicing.
- **Functions Called**:
    - [`fd_quic_set_conn_state`](<#fd_quic_set_conn_state>)
    - [`fd_quic_svc_prep_schedule_now`](<#fd_quic_svc_prep_schedule_now>)
    - [`fd_quic_svc_schedule1`](<#fd_quic_svc_schedule1>)


---
### fd\_quic\_conn\_let\_die<!-- {{#callable:fd_quic_conn_let_die}} -->
[View Source →](<../../../../../src/waltz/quic/fd_quic.c#L5501>)

Schedules a QUIC connection for closure based on the keep-alive duration.
- **Inputs**:
    - `conn`: Pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
    - `keep_alive_duration`: The duration in nanoseconds for which the connection should remain alive.
    - `now`: The current time in nanoseconds.
- **Logic and Control Flow**:
    - Sets the current time in the QUIC state using `fd_quic_get_state(conn->quic)->now`.
    - Calculates the time when the connection should let die by adding `keep_alive_duration` to `now`.
    - Checks if the last activity plus half of the idle timeout is less than the current time.
    - If the condition is true, schedules the connection for immediate servicing.
- **Output**: The function does not return a value but schedules the connection for servicing if the keep-alive time has been missed.
- **Functions Called**:
    - [`fd_quic_get_state`](<fd_quic_private.h.md#fd_quic_get_state>)
    - [`fd_quic_svc_prep_schedule`](<#fd_quic_svc_prep_schedule>)
    - [`fd_quic_svc_schedule1`](<#fd_quic_svc_schedule1>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)