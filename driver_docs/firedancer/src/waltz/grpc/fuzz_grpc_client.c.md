<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Fuzz testing implementation for a gRPC client with mock connection setup and callback handling.

# Purpose
The code is a test suite designed for fuzz testing a gRPC client implementation. It includes functions to initialize and test the gRPC client using the LLVM fuzzer framework. The code begins by checking if the target environment supports hosted execution with the `FD_HAS_HOSTED` macro. It includes necessary headers for gRPC client functionality and utility functions. The code defines a memory buffer `client_mem` for the client and sets a maximum buffer size `buf_max`.

The code provides callback functions [`cb_rx_start`](<#cb_rx_start>), [`cb_rx_end`](<#cb_rx_end>), and [`cb_rx_timeout`](<#cb_rx_timeout>) for handling different stages of gRPC response processing. These callbacks are grouped into a `fd_grpc_client_callbacks_t` structure. The function [`test_grpc_client_mock_conn`](<#test_grpc_client_mock_conn>) simulates a successful connection by setting handshake flags. The [`LLVMFuzzerInitialize`](<#llvmfuzzerinitialize>) function sets up the environment for fuzz testing, while [`LLVMFuzzerTestOneInput`](<#llvmfuzzertestoneinput>) is the main fuzzing function that tests the gRPC client with various input data. It creates a new client, resets it, and simulates receiving headers to test the client's response to different states and inputs. The code ensures that the stream's state is consistent and deletes the client after testing.
# Imports and Dependencies

---
- `fd_grpc_client.h`
- `fd_grpc_client_private.h`
- `../../util/fd_util.h`


# Global Variables

---
### client\_mem
- **Type**: ``uchar[]``
- **Description**: An array of unsigned characters with a size of 2^18 bytes, aligned to a 128-byte boundary.
- **Use**: Used as a memory buffer for the gRPC client operations.


---
### buf\_max
- **Type**: ``ulong``
- **Description**: A constant unsigned long integer that represents the maximum buffer size.
- **Use**: Used to define the maximum allowable size for buffers in the application.


---
### callbacks
- **Type**: ``fd_grpc_client_callbacks_t``
- **Description**: The `callbacks` variable is an instance of the `fd_grpc_client_callbacks_t` structure. It is initialized with three function pointers: `cb_rx_start`, `cb_rx_end`, and `cb_rx_timeout`. These functions are used as callbacks for handling the start, end, and timeout of gRPC client operations.
- **Use**: Used to define callback functions for gRPC client operations.


# Functions

---
### cb\_rx\_start<!-- {{#callable:cb_rx_start}} -->
[View Source →](<../../../../../src/waltz/grpc/fuzz_grpc_client.c#L13>)

Does nothing with the provided arguments.
- **Inputs**:
    - ``app_ctx``: A pointer to application-specific context data, which is not used in this function.
    - ``request_ctx``: An unsigned long integer representing the request context, which is not used in this function.
- **Logic and Control Flow**:
    - Casts `app_ctx` to void to indicate it is unused.
    - Casts `request_ctx` to void to indicate it is unused.
- **Output**: No output is produced as the function body is empty.


---
### cb\_rx\_end<!-- {{#callable:cb_rx_end}} -->
[View Source →](<../../../../../src/waltz/grpc/fuzz_grpc_client.c#L20>)

Does nothing with the provided arguments and is likely a placeholder for a callback function.
- **Inputs**:
    - ``app_ctx``: A pointer to application-specific context data.
    - ``request_ctx``: An unsigned long integer representing the request context.
    - ``resp_hdrs``: A pointer to `fd_grpc_resp_hdrs_t` structure containing response headers.
- **Logic and Control Flow**:
    - The function takes three arguments: `app_ctx`, `request_ctx`, and `resp_hdrs`.
    - Each argument is cast to void, indicating that they are unused in the function body.
- **Output**: No output is produced as the function body is empty.


---
### cb\_rx\_timeout<!-- {{#callable:cb_rx_timeout}} -->
[View Source →](<../../../../../src/waltz/grpc/fuzz_grpc_client.c#L29>)

Handles a timeout event in a gRPC client callback without performing any operations.
- **Inputs**:
    - `app_ctx`: A pointer to the application context, which is not used in this function.
    - `request_ctx`: An unsigned long integer representing the request context, which is not used in this function.
    - `deadline_kind`: An integer indicating the type of deadline, which is not used in this function.
- **Logic and Control Flow**:
    - The function takes three parameters: `app_ctx`, `request_ctx`, and `deadline_kind`, but does not use them.
    - Each parameter is explicitly cast to void to indicate that they are intentionally unused.
- **Output**: There is no output or return value from this function.


---
### test\_grpc\_client\_mock\_conn<!-- {{#callable:test_grpc_client_mock_conn}} -->
[View Source →](<../../../../../src/waltz/grpc/fuzz_grpc_client.c#L44>)

Sets the handshake completion flags and connection flags for a gRPC client mock connection.
- **Inputs**:
    - `client`: A pointer to an `fd_grpc_client_t` structure representing the gRPC client.
- **Logic and Control Flow**:
    - Set the `ssl_hs_done` field of the `client` to 1, indicating that the SSL handshake is complete.
    - Set the `h2_hs_done` field of the `client` to 1, indicating that the HTTP/2 handshake is complete.
    - Set the `flags` field of the `conn` member of the `client` to 0, resetting the connection flags.
- **Output**: No return value.


---
### LLVMFuzzerInitialize<!-- {{#callable:LLVMFuzzerInitialize}} -->
[View Source →](<../../../../../src/waltz/grpc/fuzz_grpc_client.c#L51>)

Initializes the fuzzer environment by setting environment variables, booting the framework, and configuring logging and exit behavior.
- **Inputs**:
    - `argc`: A pointer to the argument count, typically from the command line.
    - `argv`: A pointer to the argument vector, typically from the command line.
- **Logic and Control Flow**:
    - Set the environment variable `FD_LOG_BACKTRACE` to `0` to disable backtraces in logs.
    - Call `fd_boot` with `argc` and `argv` to initialize the framework.
    - Register `fd_halt` to be called at program exit using `atexit`.
    - Set the core log level to `3` using `fd_log_level_core_set`, which causes the program to crash on warning logs.
    - Check if the footprint of the gRPC client is less than or equal to the size of `client_mem` using `FD_TEST`.
    - Return `0` to indicate successful initialization.
- **Output**: Returns `0` to indicate successful initialization.
- **Functions Called**:
    - [`fd_grpc_client_footprint`](<fd_grpc_client.c.md#fd_grpc_client_footprint>)


---
### LLVMFuzzerTestOneInput<!-- {{#callable:LLVMFuzzerTestOneInput}} -->
[View Source →](<../../../../../src/waltz/grpc/fuzz_grpc_client.c#L64>)

Tests a gRPC client by simulating input data and verifying client behavior.
- **Inputs**:
    - `data`: A pointer to an array of unsigned characters representing the input data for the test.
    - `size`: The size of the input data array.
- **Logic and Control Flow**:
    - Check if `size` is less than `PARAMS_SIZE` (3); if true, return -1.
    - Initialize `fd_grpc_client_metrics_t` and set `app_ctx` and `rng_seed`.
    - Create a new gRPC client using [`fd_grpc_client_new`](<fd_grpc_client.c.md#fd_grpc_client_new>) with initialized parameters.
    - Reset the client and mock a connection using [`test_grpc_client_mock_conn`](<#test_grpc_client_mock_conn>).
    - Acquire a stream from the client using [`fd_grpc_client_stream_acquire`](<fd_grpc_client.c.md#fd_grpc_client_stream_acquire>) and verify it is valid.
    - Set stream header fields `is_grpc_proto` and `h2_status` using the first two bytes of `data`, and set `flags` using the third byte.
    - Calculate `payload` and `payload_sz` from `data` and `size`.
    - Invoke [`fd_grpc_h2_cb_headers`](<fd_grpc_client.c.md#fd_grpc_h2_cb_headers>) with the client connection, stream, payload, payload size, and flags.
    - Check if the stream is still valid using [`fd_grpc_client_stream_acquire_is_safe`](<fd_grpc_client.c.md#fd_grpc_client_stream_acquire_is_safe>) and verify invariants on `hdrs_received` and `msg_buf_used`.
    - Delete the client using [`fd_grpc_client_delete`](<fd_grpc_client.c.md#fd_grpc_client_delete>).
- **Output**: Returns 0 if the test completes successfully, or -1 if the input size is insufficient.
- **Functions Called**:
    - [`fd_grpc_client_new`](<fd_grpc_client.c.md#fd_grpc_client_new>)
    - [`fd_grpc_client_reset`](<fd_grpc_client.c.md#fd_grpc_client_reset>)
    - [`test_grpc_client_mock_conn`](<#test_grpc_client_mock_conn>)
    - [`fd_grpc_client_stream_acquire`](<fd_grpc_client.c.md#fd_grpc_client_stream_acquire>)
    - [`fd_grpc_h2_cb_headers`](<fd_grpc_client.c.md#fd_grpc_h2_cb_headers>)
    - [`fd_grpc_client_stream_acquire_is_safe`](<fd_grpc_client.c.md#fd_grpc_client_stream_acquire_is_safe>)
    - [`fd_grpc_client_delete`](<fd_grpc_client.c.md#fd_grpc_client_delete>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)