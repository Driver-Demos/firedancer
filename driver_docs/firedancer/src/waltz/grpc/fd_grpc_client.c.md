<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implementation of a gRPC client with support for HTTP/2 communication, stream management, and optional OpenSSL integration.

# Purpose
The code is a C implementation of a gRPC client that communicates over HTTP/2. It provides functionality to manage gRPC client connections, handle streams, and process incoming and outgoing data. The code includes functions to initialize and configure a gRPC client, manage memory allocation for client resources, and handle stream operations such as acquiring, releasing, and resetting streams. It also includes mechanisms for handling deadlines and timeouts for streams, as well as sending and receiving data frames.

The code defines several key components, including the `fd_grpc_client_t` structure, which represents the gRPC client and holds various configuration and state information. The code also includes functions for creating and deleting gRPC client instances, setting client version and authority, and managing stream lifecycles. Additionally, the code provides functions for handling network communication, including reading and writing data over sockets or using OpenSSL for secure connections. The code defines a set of callbacks for handling HTTP/2 events, such as connection establishment, data reception, and stream resets, which are used to integrate the gRPC client with the underlying HTTP/2 protocol.
# Imports and Dependencies

---
- `fd_grpc_client.h`
- `fd_grpc_client_private.h`
- `../../ballet/nanopb/pb_encode.h`
- `sys/socket.h`
- `../h2/fd_h2_rbuf_sock.h`
- `fd_grpc_codec.h`
- `../openssl/fd_openssl.h`
- `openssl/ssl.h`
- `openssl/err.h`
- `../h2/fd_h2_rbuf_ossl.h`


# Global Variables

---
### fd\_grpc\_client\_h2\_callbacks
- **Type**: ``fd_h2_callbacks_t``
- **Description**: Defines a set of callback functions for handling HTTP/2 events in a gRPC client context. These callbacks include functions for stream creation, querying, connection establishment, and handling headers, data, and stream resets.
- **Use**: Used to manage HTTP/2 interactions within a gRPC client by providing specific callback implementations for various protocol events.


# Functions

---
### fd\_grpc\_client\_align<!-- {{#callable:fd_grpc_client_align}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L14>)

Calculates the maximum alignment requirement between `fd_grpc_client_t` and the alignment of the gRPC HTTP/2 stream pool.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `fd_ulong_max` to determine the maximum alignment requirement.
    - Uses `alignof(fd_grpc_client_t)` to get the alignment of the `fd_grpc_client_t` type.
    - Calls `fd_grpc_h2_stream_pool_align()` to get the alignment requirement of the gRPC HTTP/2 stream pool.
    - Returns the maximum of the two alignment values.
- **Output**: Returns an `ulong` representing the maximum alignment requirement.


---
### fd\_grpc\_client\_footprint<!-- {{#callable:fd_grpc_client_footprint}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L19>)

Calculates the memory footprint required for a gRPC client with a specified buffer size.
- **Inputs**:
    - `buf_max`: The maximum buffer size for various components of the gRPC client.
- **Logic and Control Flow**:
    - Initialize `l` with `FD_LAYOUT_INIT` to start the layout calculation.
    - Append the size and alignment of `fd_grpc_client_t` to `l` using `FD_LAYOUT_APPEND`.
    - Append buffer sizes for `nanopb_tx`, `frame_scratch`, `frame_rx_buf`, and `frame_tx_buf` to `l` using `FD_LAYOUT_APPEND`, each with alignment of 1 and size `buf_max`.
    - Append the alignment and footprint of the stream pool to `l` using `FD_LAYOUT_APPEND`, calculated with `fd_grpc_h2_stream_pool_align()` and `fd_grpc_h2_stream_pool_footprint(FD_GRPC_CLIENT_MAX_STREAMS)`.
    - Append the buffer size for stream buffers to `l` using `FD_LAYOUT_APPEND`, with alignment of 1 and size `buf_max * FD_GRPC_CLIENT_MAX_STREAMS`.
    - Finalize the layout calculation with `FD_LAYOUT_FINI` and return the result.
- **Output**: Returns the total memory footprint as an unsigned long integer.
- **Functions Called**:
    - [`fd_grpc_client_align`](<#fd_grpc_client_align>)


---
### fd\_grpc\_h2\_stream\_reset<!-- {{#callable:fd_grpc_h2_stream_reset}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L32>)

Resets the state of a gRPC HTTP/2 stream to its initial values.
- **Inputs**:
    - `stream`: A pointer to an `fd_grpc_h2_stream_t` structure that represents the gRPC HTTP/2 stream to reset.
- **Logic and Control Flow**:
    - Set all bytes of `stream->s` to zero using `memset` with the size of `fd_h2_stream_t`.
    - Set `stream->request_ctx` to zero.
    - Set all bytes of `stream->hdrs` to zero using `memset` with the size of `fd_grpc_resp_hdrs_t`.
    - Set `stream->hdrs.grpc_status` to `FD_GRPC_STATUS_UNKNOWN`.
    - Set `stream->hdrs_received` to zero.
    - Set `stream->msg_buf_used` to zero.
    - Set `stream->msg_sz` to zero.
    - Set `stream->has_header_deadline` to zero.
    - Set `stream->has_rx_end_deadline` to zero.
- **Output**: No return value; the function modifies the `stream` structure in place.


---
### fd\_grpc\_client\_new<!-- {{#callable:fd_grpc_client_new}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L45>)

Initializes a new gRPC client with specified memory, callbacks, metrics, application context, buffer size, and random seed.
- **Inputs**:
    - `mem`: Pointer to memory allocated for the client.
    - `callbacks`: Pointer to a structure containing callback functions for the client.
    - `metrics`: Pointer to a structure for storing client metrics.
    - `app_ctx`: Pointer to application-specific context data.
    - `buf_max`: Maximum buffer size for various client operations.
    - `rng_seed`: Seed for random number generation used in header matching.
- **Logic and Control Flow**:
    - Check if `mem` is NULL and return NULL if true.
    - Check if `buf_max` is less than 4096 and return NULL if true.
    - Check if `mem` is properly aligned and return NULL if not.
    - Initialize scratch memory allocation with `FD_SCRATCH_ALLOC_INIT`.
    - Allocate memory for client structure and various buffers using `FD_SCRATCH_ALLOC_APPEND`.
    - Finalize memory allocation with `FD_SCRATCH_ALLOC_FINI` and verify footprint.
    - Create and join a stream pool using `fd_grpc_h2_stream_pool_new` and `fd_grpc_h2_stream_pool_join`.
    - Initialize the client structure with provided parameters and allocated memory.
    - Initialize header matcher with `fd_h2_hdr_matcher_init` and insert literals for gRPC status and message headers.
    - Set client version to "0.0.0".
    - Initialize each stream in the stream pool with buffer pointers and sizes.
    - Reset the client state with [`fd_grpc_client_reset`](<#fd_grpc_client_reset>).
- **Output**: Returns a pointer to the newly created `fd_grpc_client_t` structure, or NULL if initialization fails.
- **Functions Called**:
    - [`fd_grpc_client_align`](<#fd_grpc_client_align>)
    - [`fd_grpc_client_footprint`](<#fd_grpc_client_footprint>)
    - [`fd_grpc_client_reset`](<#fd_grpc_client_reset>)


---
### fd\_grpc\_client\_delete<!-- {{#callable:fd_grpc_client_delete}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L117>)

Returns the `fd_grpc_client_t` pointer passed to it without modification.
- **Inputs**:
    - `client`: A pointer to an `fd_grpc_client_t` structure.
- **Logic and Control Flow**:
    - The function takes a single argument, `client`, which is a pointer to an `fd_grpc_client_t` structure.
    - It returns the same `client` pointer without performing any operations on it.
- **Output**: Returns the same `fd_grpc_client_t` pointer that was passed as input.


---
### fd\_grpc\_client\_set\_version<!-- {{#callable:fd_grpc_client_set_version}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L122>)

Sets the version string for a gRPC client, ensuring it does not exceed a maximum length.
- **Inputs**:
    - `client`: A pointer to an `fd_grpc_client_t` structure representing the gRPC client.
    - `version`: A constant character pointer to the version string to set.
    - `version_len`: An unsigned long integer representing the length of the version string.
- **Logic and Control Flow**:
    - Checks if `version_len` exceeds `FD_GRPC_CLIENT_VERSION_LEN_MAX` and logs a warning if true, then returns without setting the version.
    - If `version_len` is within the allowed limit, sets `client->version_len` to `version_len` cast to `uchar`.
    - Copies the `version` string into `client->version` using `memcpy`.
- **Output**: No output is returned; the function modifies the `client` structure in place.


---
### fd\_grpc\_client\_set\_authority<!-- {{#callable:fd_grpc_client_set_authority}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L134>)

Sets the authority of a gRPC client by configuring its host and port.
- **Inputs**:
    - `client`: A pointer to an `fd_grpc_client_t` structure representing the gRPC client.
    - `host`: A constant character pointer to the host name.
    - `host_len`: An unsigned long integer representing the length of the host name.
    - `port`: An unsigned short integer representing the port number.
- **Logic and Control Flow**:
    - Calculate the minimum of `host_len` and the size of `client->host` minus one, and assign it to `host_len`.
    - Initialize the `client->host` string, append the `host` text up to `host_len`, and finalize the string.
    - Set `client->host_len` to the value of `host_len` cast to an unsigned char.
    - Set `client->port` to the value of `port`.
- **Output**: No return value; the function modifies the `client` structure in place.


---
### fd\_grpc\_client\_stream\_acquire\_is\_safe<!-- {{#callable:fd_grpc_client_stream_acquire_is_safe}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L145>)

Checks if it is safe to acquire a new gRPC client stream based on current stream quotas and availability.
- **Inputs**:
    - `client`: A pointer to an `fd_grpc_client_t` structure representing the gRPC client.
- **Logic and Control Flow**:
    - Checks if the current active stream count plus one exceeds the maximum concurrent streams allowed by the peer settings.
    - Checks if there is a free stream object available in the stream pool using `fd_grpc_h2_stream_pool_free`.
    - Checks if the current stream count is less than the maximum allowed streams (`FD_GRPC_CLIENT_MAX_STREAMS`).
    - Returns 0 if any of the above conditions are not met, otherwise returns 1.
- **Output**: Returns 1 if it is safe to acquire a new stream, otherwise returns 0.


---
### fd\_grpc\_client\_stream\_acquire<!-- {{#callable:fd_grpc_client_stream_acquire}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L163>)

Acquires a new gRPC client stream and initializes it for use.
- **Inputs**:
    - ``client``: A pointer to an `fd_grpc_client_t` structure representing the gRPC client.
    - ``request_ctx``: An unsigned long integer representing the request context to associate with the new stream.
- **Logic and Control Flow**:
    - Checks if the current stream count has reached the maximum allowed (`FD_GRPC_CLIENT_MAX_STREAMS`); logs a critical error if true.
    - Retrieves the connection from the client and assigns the next available stream ID, incrementing the stream ID counter by 2.
    - Acquires a stream from the client's stream pool and resets it using [`fd_grpc_h2_stream_reset`](<#fd_grpc_h2_stream_reset>).
    - Sets the `request_ctx` of the stream to the provided `request_ctx` value.
    - Initializes and opens the stream using `fd_h2_stream_open` with the connection and stream ID.
    - Updates the client's `request_stream`, `stream_ids`, and `streams` arrays with the new stream and increments the stream count.
    - Returns the newly acquired and initialized stream.
- **Output**: Returns a pointer to the newly acquired and initialized `fd_grpc_h2_stream_t` structure.
- **Functions Called**:
    - [`fd_grpc_h2_stream_reset`](<#fd_grpc_h2_stream_reset>)


---
### fd\_grpc\_client\_stream\_release<!-- {{#callable:fd_grpc_client_stream_release}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L187>)

Releases a gRPC client stream and updates the client's stream map and pool.
- **Inputs**:
    - ``client``: A pointer to the `fd_grpc_client_t` structure representing the gRPC client.
    - ``stream``: A pointer to the `fd_grpc_h2_stream_t` structure representing the stream to release.
- **Logic and Control Flow**:
    - Checks if the client's stream count is zero and logs a critical error if true, indicating a corrupt stream map.
    - If the stream to release is the client's request stream, sets the request stream to NULL and resets the request transaction operation.
    - Searches for the stream in the client's stream map by comparing stream IDs and logs a critical error if the stream is not found, indicating a corrupt stream map.
    - If the stream is found, removes it from the stream map by replacing it with the last stream in the map and decrements the stream count.
    - Releases the stream back to the stream pool using `fd_grpc_h2_stream_pool_ele_release`.
- **Output**: No return value; the function operates by side effects on the `client` and `stream`.


---
### fd\_grpc\_client\_reset<!-- {{#callable:fd_grpc_client_reset}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L215>)

Resets the state of a gRPC client by reinitializing buffers, connection settings, and releasing all active streams.
- **Inputs**:
    - `client`: A pointer to an `fd_grpc_client_t` structure representing the gRPC client to reset.
- **Logic and Control Flow**:
    - Initialize the receive buffer `frame_rx` and transmit buffer `frame_tx` using `fd_h2_rbuf_init` with the client's respective buffer and maximum buffer size.
    - Initialize the client's connection using `fd_h2_conn_init_client` and set the connection context to the client.
    - Set the client's handshake completion flags `h2_hs_done` and `ssl_hs_done` to 0, indicating that handshakes are not done.
    - Set the client's `request_stream` to `NULL` and reset the `request_tx_op` operation to an empty `fd_h2_tx_op_t` structure.
    - Disable receive flow control by setting the connection's `initial_window_size`, `rx_wnd_max`, and `rx_wnd_wmark` to maximum values.
    - Release all active streams by iterating over `client->streams` and calling [`fd_grpc_client_stream_release`](<#fd_grpc_client_stream_release>) for each stream.
- **Output**: No return value; the function operates directly on the `client` structure to reset its state.
- **Functions Called**:
    - [`fd_grpc_client_stream_release`](<#fd_grpc_client_stream_release>)


---
### fd\_grpc\_client\_send\_stream\_quota<!-- {{#callable:fd_grpc_client_send_stream_quota}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L241>)

Updates the stream's receive window and sends a WINDOW_UPDATE frame to allow the peer to send more data.
- **Inputs**:
    - ``rbuf_tx``: A pointer to the `fd_h2_rbuf_t` structure representing the transmission buffer where the WINDOW_UPDATE frame will be pushed.
    - ``stream``: A pointer to the `fd_grpc_h2_stream_t` structure representing the stream whose receive window is being updated.
    - ``bump``: An unsigned integer representing the amount by which to increase the stream's receive window.
- **Logic and Control Flow**:
    - Create a `fd_h2_window_update_t` structure named `window_update` to represent the WINDOW_UPDATE frame.
    - Set the `typlen` field of `window_update.hdr` using `fd_h2_frame_typlen` with the frame type `FD_H2_FRAME_TYPE_WINDOW_UPDATE` and a length of 4 bytes.
    - Set the `r_stream_id` field of `window_update.hdr` by byte-swapping the stream ID from the `stream` parameter.
    - Set the `increment` field of `window_update` by byte-swapping the `bump` parameter.
    - Push the `window_update` structure into the `rbuf_tx` buffer using `fd_h2_rbuf_push`.
    - Increase the `rx_wnd` field of the `stream` structure by the `bump` value.
- **Output**: None (the function does not return a value).


---
### fd\_grpc\_client\_send\_timeout<!-- {{#callable:fd_grpc_client_send_timeout}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L260>)

Handles a stream timeout by invoking a callback, sending a reset stream frame, and releasing the stream.
- **Inputs**:
    - ``rbuf_tx``: A pointer to the `fd_h2_rbuf_t` structure used for transmitting data.
    - ``client``: A pointer to the `fd_grpc_client_t` structure representing the gRPC client.
    - ``stream``: A pointer to the `fd_grpc_h2_stream_t` structure representing the stream that has timed out.
    - ``deadline_kind``: An integer indicating the type of deadline that triggered the timeout.
- **Logic and Control Flow**:
    - Calls the `rx_timeout` callback function from the client's callbacks with the client's context, the stream's request context, and the deadline kind.
    - Sends a `RST_STREAM` frame with the error code `FD_H2_ERR_CANCEL` using the `fd_h2_tx_rst_stream` function.
    - Releases the stream by calling [`fd_grpc_client_stream_release`](<#fd_grpc_client_stream_release>) with the client and stream as arguments.
- **Output**: No return value (void function).
- **Functions Called**:
    - [`fd_grpc_client_stream_release`](<#fd_grpc_client_stream_release>)


---
### fd\_grpc\_client\_service\_streams<!-- {{#callable:fd_grpc_client_service_streams}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L270>)

Manages gRPC client streams by checking deadlines and adjusting flow control.
- **Inputs**:
    - ``client``: A pointer to an `fd_grpc_client_t` structure representing the gRPC client.
    - ``ts_nanos``: A long integer representing the current timestamp in nanoseconds.
- **Logic and Control Flow**:
    - Calculate `meta_frame_max` as the maximum size of `fd_h2_window_update_t` and `fd_h2_rst_stream_t`.
    - Retrieve the connection and transmission buffer from the `client`.
    - Return immediately if the connection has any flags set.
    - Calculate `wnd_max` and `wnd_thres` from the connection's initial window size.
    - Iterate over each stream in the `client`'s stream list.
    - Check if the transmission buffer has enough space for a meta frame; break the loop if not.
    - For each stream, check if the header deadline has passed; if so, send a timeout and remove the stream.
    - Check if the receive end deadline has passed; if so, send a timeout and remove the stream.
    - If the stream's receive window is below the threshold, send a stream quota update.
- **Output**: No return value; the function operates on the `client` and its streams directly.
- **Functions Called**:
    - [`fd_grpc_client_send_timeout`](<#fd_grpc_client_send_timeout>)
    - [`fd_grpc_client_send_stream_quota`](<#fd_grpc_client_send_stream_quota>)


---
### fd\_ossl\_log\_error<!-- {{#callable:fd_ossl_log_error}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L307>)

Logs an OpenSSL error message after removing a trailing newline character if present.
- **Inputs**:
    - ``str``: A pointer to a constant character string containing the error message to log.
    - ``len``: The length of the error message string.
    - ``ctx``: A pointer to a context, which is not used in this function.
- **Logic and Control Flow**:
    - Ignores the `ctx` parameter as it is not used.
    - Checks if the length of the string `len` is greater than 0 and if the last character is a newline character ('\n').
    - If the last character is a newline, decrements `len` by 1 to exclude it from the log.
    - Logs the error message using `FD_LOG_INFO`, formatting the string to the specified length `len`.
    - Returns 0 to indicate successful execution.
- **Output**: Returns 0 to indicate successful execution.


---
### fd\_grpc\_client\_rxtx\_ossl<!-- {{#callable:fd_grpc_client_rxtx_ossl}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L317>)

Handles gRPC client communication over SSL, including handshake, reading, writing, and managing connection state.
- **Inputs**:
    - `client`: A pointer to an `fd_grpc_client_t` structure representing the gRPC client.
    - `ssl`: A pointer to an `SSL` structure representing the SSL connection.
    - `charge_busy`: A pointer to an integer that indicates if the function performed any read or write operations.
- **Logic and Control Flow**:
    - Check if the SSL handshake is complete; if not, attempt to complete it using `SSL_do_handshake`.
    - If the handshake fails with `SSL_ERROR_WANT_READ` or `SSL_ERROR_WANT_WRITE`, return 1 to indicate the operation should be retried.
    - Log errors and return 0 if the handshake fails for other reasons, including certificate verification failure.
    - If the handshake is successful, mark it as done in the client structure.
    - Read data from the SSL connection into the client's receive buffer using `fd_h2_rbuf_ssl_read` and handle any SSL errors.
    - If the connection flags indicate a need for control frame transmission, call `fd_h2_tx_control`.
    - Process received data and manage streams using `fd_h2_rx` and [`fd_grpc_client_service_streams`](<#fd_grpc_client_service_streams>).
    - Write data from the client's transmit buffer to the SSL connection using `fd_h2_rbuf_ssl_write`.
    - Set `charge_busy` to 1 if any data was read or written.
    - Return 1 to indicate successful processing.
- **Output**: Returns 1 if the operation is successful or should be retried, and 0 if there is an error that cannot be retried.
- **Functions Called**:
    - [`fd_grpc_client_service_streams`](<#fd_grpc_client_service_streams>)


---
### fd\_grpc\_client\_rxtx\_socket<!-- {{#callable:fd_grpc_client_rxtx_socket}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L363>)

Handles the transmission and reception of data over a socket for a gRPC client, updating the busy charge status if data is sent or received.
- **Inputs**:
    - ``client``: A pointer to an `fd_grpc_client_t` structure representing the gRPC client.
    - ``sock_fd``: An integer representing the socket file descriptor used for communication.
    - ``charge_busy``: A pointer to an integer that will be set to 1 if data is sent or received, indicating the client is busy.
- **Logic and Control Flow**:
    - Retrieve the connection and initial frame offsets from the `client` structure.
    - Attempt to receive data from the socket using `fd_h2_rbuf_recvmsg` with non-blocking flags.
    - If receiving data fails, log the error and return 0 to indicate disconnection.
    - If the connection has flags set, call `fd_h2_tx_control` to handle control frames.
    - Process received data using `fd_h2_rx` and service streams with [`fd_grpc_client_service_streams`](<#fd_grpc_client_service_streams>).
    - Attempt to send data over the socket using `fd_h2_rbuf_sendmsg` with non-blocking flags.
    - If sending data fails, log the warning and return 0.
    - Retrieve the new frame offsets after transmission and reception.
    - If any frame offsets have changed, set `*charge_busy` to 1 to indicate activity.
    - Return 1 to indicate successful operation.
- **Output**: Returns 1 if the operation is successful, or 0 if there is a disconnection or send error.
- **Functions Called**:
    - [`fd_grpc_client_service_streams`](<#fd_grpc_client_service_streams>)


---
### fd\_grpc\_client\_request\_continue1<!-- {{#callable:fd_grpc_client_request_continue1}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L407>)

Attempts to continue sending a gRPC request by copying data to the transmission buffer and checking if the request is complete.
- **Inputs**:
    - ``client``: A pointer to an `fd_grpc_client_t` structure representing the gRPC client.
- **Logic and Control Flow**:
    - Retrieve the current request stream from the `client` structure.
    - Copy the transmission operation from the client to the HTTP/2 stream using `fd_h2_tx_op_copy`.
    - Check if the `chunk_sz` of the `request_tx_op` is non-zero; if so, return 0 indicating the request is not complete.
    - Check if the HTTP/2 stream state is not `FD_H2_STREAM_STATE_CLOSING_TX`; if so, return 0 indicating the request is not complete.
    - Increment the `stream_chunks_tx_cnt` metric in the client's metrics.
    - Set the `request_stream` of the client to `NULL`, indicating the request is finished.
    - Invoke the `tx_complete` callback with the client's context and the stream's request context.
    - Return 1 to indicate the request has been successfully completed.
- **Output**: Returns an integer: 1 if the request is complete and 0 if it is not.


---
### fd\_grpc\_client\_request\_continue<!-- {{#callable:fd_grpc_client_request_continue}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L421>)

Attempts to continue a gRPC client request by checking connection and request conditions, and then delegating to another function if conditions are met.
- **Inputs**:
    - ``client``: A pointer to an `fd_grpc_client_t` structure representing the gRPC client.
- **Logic and Control Flow**:
    - Check if the connection is dead by evaluating `client->conn->flags & FD_H2_CONN_FLAGS_DEAD`; if true, return 0.
    - Check if `client->request_stream` is NULL; if true, return 0.
    - Check if `client->request_tx_op->chunk_sz` is zero; if true, return 0.
    - Call `fd_grpc_client_request_continue1(client)` and return its result.
- **Output**: Returns an integer indicating whether the request can continue (1) or not (0).
- **Functions Called**:
    - [`fd_grpc_client_request_continue1`](<#fd_grpc_client_request_continue1>)


---
### fd\_grpc\_client\_is\_connected<!-- {{#callable:fd_grpc_client_is_connected}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L429>)

Checks if a gRPC client is connected by verifying the client pointer, connection status, and handshake completion.
- **Inputs**:
    - ``client``: A pointer to an `fd_grpc_client_t` structure representing the gRPC client to check for connection status.
- **Logic and Control Flow**:
    - If the `client` pointer is `NULL`, return 0 indicating not connected.
    - If the connection flags indicate the connection is dead (`FD_H2_CONN_FLAGS_DEAD`), return 0 indicating not connected.
    - If the HTTP/2 handshake (`h2_hs_done`) is not complete, return 0 indicating not connected.
    - If none of the above conditions are met, return 1 indicating the client is connected.
- **Output**: Returns an integer: 1 if the client is connected, otherwise 0.


---
### fd\_grpc\_client\_request\_is\_blocked<!-- {{#callable:fd_grpc_client_request_is_blocked}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L437>)

Checks if a gRPC client request is blocked due to various conditions.
- **Inputs**:
    - `client`: A pointer to an `fd_grpc_client_t` structure representing the gRPC client.
- **Logic and Control Flow**:
    - Return 1 if `client` is NULL.
    - Return 1 if the connection flags indicate the connection is dead (`FD_H2_CONN_FLAGS_DEAD`).
    - Return 1 if the HTTP/2 handshake is not complete (`h2_hs_done` is false).
    - Return 1 if the transmission buffer (`frame_tx`) is not empty.
    - Return 1 if acquiring a new stream is not safe ([`fd_grpc_client_stream_acquire_is_safe`](<#fd_grpc_client_stream_acquire_is_safe>) returns false).
    - Return 0 if none of the above conditions are met, indicating the request is not blocked.
- **Output**: Returns an integer: 1 if the request is blocked, 0 otherwise.
- **Functions Called**:
    - [`fd_grpc_client_stream_acquire_is_safe`](<#fd_grpc_client_stream_acquire_is_safe>)


---
### fd\_grpc\_client\_request\_start<!-- {{#callable:fd_grpc_client_request_start}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L447>)

Initiates a gRPC client request by encoding a Protobuf message, preparing HTTP/2 headers, and queuing the request for transmission.
- **Inputs**:
    - `client`: Pointer to the `fd_grpc_client_t` structure representing the gRPC client.
    - `path`: Pointer to a constant character string representing the request path.
    - `path_len`: Length of the request path.
    - `request_ctx`: Context identifier for the request.
    - `fields`: Pointer to the `pb_msgdesc_t` structure describing the Protobuf message fields.
    - `message`: Pointer to the Protobuf message to be encoded and sent.
    - `auth_token`: Pointer to a constant character string representing the authentication token.
    - `auth_token_sz`: Size of the authentication token.
- **Logic and Control Flow**:
    - Check if the client request is blocked using [`fd_grpc_client_request_is_blocked`](<#fd_grpc_client_request_is_blocked>); return `NULL` if blocked.
    - Encode the Protobuf message into a buffer, logging a warning and returning `NULL` if encoding fails.
    - Create a gRPC length prefix and copy it to the transmission buffer.
    - Acquire a stream descriptor using [`fd_grpc_client_stream_acquire`](<#fd_grpc_client_stream_acquire>).
    - Prepare HTTP/2 request headers and commit them to the transmission buffer.
    - Queue the request payload for sending, potentially fragmenting it into multiple HTTP/2 DATA frames.
    - Increment the client's metrics for requests sent and active streams.
    - Log the request details for debugging purposes.
    - Return the acquired stream descriptor.
- **Output**: Returns a pointer to the `fd_grpc_h2_stream_t` structure representing the stream descriptor, or `NULL` if the request cannot be started.
- **Functions Called**:
    - [`fd_grpc_client_request_is_blocked`](<#fd_grpc_client_request_is_blocked>)
    - [`fd_grpc_client_stream_acquire`](<#fd_grpc_client_stream_acquire>)
    - [`fd_grpc_h2_gen_request_hdrs`](<fd_grpc_codec.c.md#fd_grpc_h2_gen_request_hdrs>)
    - [`fd_grpc_client_request_continue1`](<#fd_grpc_client_request_continue1>)


---
### fd\_grpc\_client\_deadline\_set<!-- {{#callable:fd_grpc_client_deadline_set}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L519>)

Sets a deadline for a gRPC stream based on the specified deadline kind and timestamp in nanoseconds.
- **Inputs**:
    - `stream`: A pointer to an `fd_grpc_h2_stream_t` structure representing the gRPC stream for which the deadline is being set.
    - `deadline_kind`: An integer indicating the type of deadline to set, either `FD_GRPC_DEADLINE_HEADER` or `FD_GRPC_DEADLINE_RX_END`.
    - `ts_nanos`: A long integer representing the deadline timestamp in nanoseconds.
- **Logic and Control Flow**:
    - Checks the value of `deadline_kind` to determine which deadline to set.
    - If `deadline_kind` is `FD_GRPC_DEADLINE_HEADER`, sets `stream->header_deadline_nanos` to `ts_nanos` and `stream->has_header_deadline` to 1.
    - If `deadline_kind` is `FD_GRPC_DEADLINE_RX_END`, sets `stream->rx_end_deadline_nanos` to `ts_nanos` and `stream->has_rx_end_deadline` to 1.
- **Output**: No return value; the function modifies the `stream` structure in place.


---
### fd\_grpc\_h2\_stream\_query<!-- {{#callable:fd_grpc_h2_stream_query}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L537>)

Searches for a stream with a given `stream_id` in a connection's client context and returns the corresponding HTTP/2 stream object.
- **Inputs**:
    - ``conn``: A pointer to an `fd_h2_conn_t` structure representing the connection context.
    - ``stream_id``: An unsigned integer representing the ID of the stream to search for.
- **Logic and Control Flow**:
    - Retrieve the `fd_grpc_client_t` client context from the `conn` parameter.
    - Iterate over the `stream_ids` array in the client context to find a match for the `stream_id`.
    - If a match is found, return the corresponding `fd_h2_stream_t` object from the `streams` array.
    - If no match is found after iterating through all streams, return `NULL`.
- **Output**: A pointer to the `fd_h2_stream_t` object if the stream is found, or `NULL` if not found.


---
### fd\_grpc\_h2\_conn\_established<!-- {{#callable:fd_grpc_h2_conn_established}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L549>)

Marks the gRPC/HTTP2 connection as established and triggers the connection established callback.
- **Inputs**:
    - ``conn``: A pointer to an `fd_h2_conn_t` structure representing the HTTP/2 connection.
- **Logic and Control Flow**:
    - Retrieve the `fd_grpc_client_t` context from the `conn` structure.
    - Set the `h2_hs_done` flag of the client to 1, indicating that the HTTP/2 handshake is complete.
    - Invoke the `conn_established` callback function from the client's callbacks, passing the client's context.
- **Output**: No return value (void function).


---
### fd\_grpc\_h2\_conn\_final<!-- {{#callable:fd_grpc_h2_conn_final}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L556>)

Notifies the client that a gRPC/HTTP2 connection has ended due to an error or closure by a party.
- **Inputs**:
    - ``conn``: A pointer to the `fd_h2_conn_t` structure representing the HTTP2 connection.
    - ``h2_err``: An unsigned integer representing the HTTP2 error code that caused the connection to end.
    - ``closed_by``: An integer indicating which party closed the connection (e.g., client or server).
- **Logic and Control Flow**:
    - Retrieve the `fd_grpc_client_t` context from the `conn` structure.
    - Invoke the `conn_dead` callback function from the client's callbacks, passing the context, error code, and closure indicator.
- **Output**: No return value (void function).


---
### fd\_grpc\_h2\_cb\_headers<!-- {{#callable:fd_grpc_h2_cb_headers}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L566>)

Processes HTTP/2 headers for a gRPC stream and manages stream state based on header parsing results.
- **Inputs**:
    - `conn`: A pointer to the `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - `h2_stream`: A pointer to the `fd_h2_stream_t` structure representing the HTTP/2 stream.
    - `data`: A pointer to the data containing the HTTP/2 headers.
    - `data_sz`: The size of the data containing the HTTP/2 headers.
    - `flags`: Flags indicating the state of the headers, such as `FD_H2_FLAG_END_HEADERS` and `FD_H2_FLAG_END_STREAM`.
- **Logic and Control Flow**:
    - Upcasts `h2_stream` to `fd_grpc_h2_stream_t` and retrieves the client context from `conn`.
    - Reads and parses the HTTP/2 response headers using [`fd_grpc_h2_read_response_hdrs`](<fd_grpc_codec.c.md#fd_grpc_h2_read_response_hdrs>).
    - If header parsing fails, calls `fd_h2_stream_error`, invokes the `rx_end` callback, and releases the stream.
    - Checks if initial response headers are received and if they indicate a valid gRPC protocol with status 200, then invokes the `rx_start` callback.
    - If both `FD_H2_FLAG_END_HEADERS` and `FD_H2_FLAG_END_STREAM` flags are set, invokes the `rx_end` callback and releases the stream.
- **Output**: No return value; the function operates through side effects on the connection and stream objects.
- **Functions Called**:
    - [`fd_grpc_h2_stream_upcast`](<fd_grpc_client_private.h.md#fd_grpc_h2_stream_upcast>)
    - [`fd_grpc_h2_read_response_hdrs`](<fd_grpc_codec.c.md#fd_grpc_h2_read_response_hdrs>)
    - [`fd_grpc_client_stream_release`](<#fd_grpc_client_stream_release>)


---
### fd\_grpc\_h2\_cb\_data<!-- {{#callable:fd_grpc_h2_cb_data}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L604>)

Processes incoming gRPC data frames for a specific HTTP/2 stream, handling message assembly and completion.
- **Inputs**:
    - ``conn``: Pointer to the HTTP/2 connection object.
    - ``h2_stream``: Pointer to the HTTP/2 stream object.
    - ``data``: Pointer to the incoming data buffer.
    - ``data_sz``: Size of the incoming data buffer.
    - ``flags``: Flags indicating the state of the data frame, such as end of stream.
- **Logic and Control Flow**:
    - Check if the HTTP/2 status is not 200 or if the protocol is not gRPC, and return if true.
    - Enter a loop to process the incoming data until `data_sz` is zero.
    - If the message buffer has not yet received a complete header, copy header bytes from the data buffer to the message buffer.
    - If the header is complete, calculate the message size and check if it exceeds the buffer's maximum size; log a warning and terminate the stream if it does.
    - Copy payload bytes from the data buffer to the message buffer until the message is complete or the data buffer is exhausted.
    - Update metrics for received chunks and bytes.
    - If the message is complete, call the callback to process the message and reset the message buffer.
    - If the `FD_H2_FLAG_END_STREAM` flag is set, check for incomplete messages, log a warning if necessary, and call the callback to end the stream.
- **Output**: No return value; the function operates through side effects on the connection and stream objects, and by invoking callbacks.
- **Functions Called**:
    - [`fd_grpc_h2_stream_upcast`](<fd_grpc_client_private.h.md#fd_grpc_h2_stream_upcast>)
    - [`fd_grpc_client_stream_release`](<#fd_grpc_client_stream_release>)


---
### fd\_grpc\_h2\_rst\_stream<!-- {{#callable:fd_grpc_h2_rst_stream}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L674>)

Handles the termination of a gRPC HTTP/2 stream by logging the event, invoking a callback, and releasing the stream resources.
- **Inputs**:
    - ``conn``: A pointer to the `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - ``h2_stream``: A pointer to the `fd_h2_stream_t` structure representing the HTTP/2 stream to be reset.
    - ``error_code``: An unsigned integer representing the error code for the stream reset.
    - ``closed_by``: An integer indicating who closed the stream (1 for server, 0 for other reasons).
- **Logic and Control Flow**:
    - Check if `closed_by` is 1; if true, log a warning that the server terminated the request, otherwise log that the stream failed.
    - Retrieve the `fd_grpc_client_t` client context from the connection's context.
    - Upcast the `h2_stream` to `fd_grpc_h2_stream_t`.
    - Invoke the `rx_end` callback with the client context, request context, and headers, which invalidates the headers.
    - Release the stream resources using [`fd_grpc_client_stream_release`](<#fd_grpc_client_stream_release>).
- **Output**: No return value; the function performs logging, callback invocation, and resource cleanup.
- **Functions Called**:
    - [`fd_grpc_h2_stream_upcast`](<fd_grpc_client_private.h.md#fd_grpc_h2_stream_upcast>)
    - [`fd_grpc_client_stream_release`](<#fd_grpc_client_stream_release>)


---
### fd\_grpc\_h2\_window\_update<!-- {{#callable:fd_grpc_h2_window_update}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L694>)

Triggers the continuation of a gRPC client request when a window update occurs.
- **Inputs**:
    - ``conn``: A pointer to an `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - ``increment``: An unsigned integer representing the window size increment, which is not used in this function.
- **Logic and Control Flow**:
    - The function takes two parameters: a connection object `conn` and an `increment` value.
    - The `increment` parameter is explicitly ignored using `(void)increment;`.
    - Calls the [`fd_grpc_client_request_continue`](<#fd_grpc_client_request_continue>) function with the context of the connection `conn->ctx`.
- **Output**: No output is returned as the function has a `void` return type.
- **Functions Called**:
    - [`fd_grpc_client_request_continue`](<#fd_grpc_client_request_continue>)


---
### fd\_grpc\_h2\_stream\_window\_update<!-- {{#callable:fd_grpc_h2_stream_window_update}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L701>)

Triggers the continuation of a gRPC client request by calling [`fd_grpc_client_request_continue`](<#fd_grpc_client_request_continue>) with the connection context.
- **Inputs**:
    - ``conn``: A pointer to an `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - ``stream``: A pointer to an `fd_h2_stream_t` structure representing the HTTP/2 stream (unused in this function).
    - ``increment``: An unsigned integer representing the window size increment (unused in this function).
- **Logic and Control Flow**:
    - Ignores the `stream` and `increment` parameters by casting them to void.
    - Calls the function [`fd_grpc_client_request_continue`](<#fd_grpc_client_request_continue>) with the context of the connection (`conn->ctx`).
- **Output**: No return value (void function).
- **Functions Called**:
    - [`fd_grpc_client_request_continue`](<#fd_grpc_client_request_continue>)


---
### fd\_grpc\_h2\_ping\_ack<!-- {{#callable:fd_grpc_h2_ping_ack}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L709>)

Acknowledges a gRPC HTTP/2 ping by invoking the `ping_ack` callback on the client context.
- **Inputs**:
    - ``conn``: A pointer to an `fd_h2_conn_t` structure representing the HTTP/2 connection.
- **Logic and Control Flow**:
    - Retrieve the `fd_grpc_client_t` client from the connection's context.
    - Invoke the `ping_ack` callback function on the client's callbacks, passing the client's context as an argument.
- **Output**: No return value.


---
### fd\_grpc\_client\_rbuf\_tx<!-- {{#callable:fd_grpc_client_rbuf_tx}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L715>)

Returns the transmit buffer for a gRPC client's frame.
- **Inputs**:
    - `client`: A pointer to an `fd_grpc_client_t` structure representing the gRPC client.
- **Logic and Control Flow**:
    - Accesses the `frame_tx` member of the `fd_grpc_client_t` structure pointed to by `client`.
    - Returns the `frame_tx` member, which is a pointer to an `fd_h2_rbuf_t` structure.
- **Output**: A pointer to an `fd_h2_rbuf_t` structure representing the transmit buffer for the client's frame.


---
### fd\_grpc\_client\_rbuf\_rx<!-- {{#callable:fd_grpc_client_rbuf_rx}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L720>)

Returns the receive buffer for a gRPC client's frame.
- **Inputs**:
    - `client`: A pointer to an `fd_grpc_client_t` structure representing the gRPC client.
- **Logic and Control Flow**:
    - Accesses the `frame_rx` member of the `client` structure.
    - Returns the `frame_rx` buffer.
- **Output**: A pointer to an `fd_h2_rbuf_t` structure representing the receive buffer of the client's frame.


---
### fd\_grpc\_client\_h2\_conn<!-- {{#callable:fd_grpc_client_h2_conn}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client.c#L725>)

Returns the HTTP/2 connection associated with a gRPC client.
- **Inputs**:
    - `client`: A pointer to an `fd_grpc_client_t` structure representing the gRPC client.
- **Logic and Control Flow**:
    - Accesses the `conn` member of the `fd_grpc_client_t` structure pointed to by `client`.
    - Returns the `conn` member, which is a pointer to an `fd_h2_conn_t` structure.
- **Output**: A pointer to an `fd_h2_conn_t` structure representing the HTTP/2 connection.



---
Made with ❤️ by [Driver](https://www.driver.ai/)