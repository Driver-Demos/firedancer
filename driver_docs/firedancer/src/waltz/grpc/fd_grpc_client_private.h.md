<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines internal structures and functions for managing gRPC client streams and connections.

# Purpose
The code is a C header file that defines private structures and functions for managing a gRPC client using HTTP/2. It includes the definition of the `fd_grpc_h2_stream` structure, which holds the state of a gRPC request, including buffers for response headers and incoming messages, as well as deadlines for receiving headers and stream signals. The file also defines a pool of stream objects, which allows the client to manage multiple concurrent gRPC requests and responses. The pool is implemented using macros that include a template file for pool management.

The `fd_grpc_client_private` structure encapsulates the internal state of the gRPC client, including the HTTP/2 connection, TLS connection, and a pool of stream objects. It maintains a single gRPC connection and manages the lifecycle of stream objects through various states such as IDLE, OPEN, and CLOSE_TX. The file declares several functions for acquiring and releasing stream objects, servicing streams for timeouts, and handling HTTP/2 headers. These functions are intended for internal use within the gRPC client implementation, as indicated by the use of the `FD_PROTOTYPES_BEGIN` and `FD_PROTOTYPES_END` macros to delineate the function prototypes.
# Imports and Dependencies

---
- `fd_grpc_client.h`
- `../grpc/fd_grpc_codec.h`
- `../h2/fd_h2.h`
- `../../util/tmpl/fd_pool.c`
- `../../waltz/h2/fd_h2_rbuf_ossl.h`


# Data Structures

---
### fd\_grpc\_h2\_stream
- **Type**: ``struct``
- **Members**:
    - ``s``: Inherits from `fd_h2_stream_t` to represent the HTTP/2 stream state.
    - ``request_ctx``: Stores the context identifier for the request.
    - ``next``: Holds the index of the next stream in a sequence.
    - ``hdrs``: Buffers the response headers for the gRPC message.
    - ``msg_buf``: Points to the buffer for an incoming gRPC message.
    - ``msg_buf_max``: Specifies the maximum size of the message buffer.
    - ``hdrs_received``: Indicates if the headers have been received.
    - ``msg_buf_used``: Tracks the amount of the message buffer used, including the header.
    - ``msg_sz``: Specifies the size of the next message to be processed.
    - ``header_deadline_nanos``: Sets the deadline for receiving the first response header bit.
    - ``rx_end_deadline_nanos``: Sets the deadline for receiving the end of stream signal.
    - ``has_header_deadline``: Indicates if there is a deadline for the header.
    - ``has_rx_end_deadline``: Indicates if there is a deadline for the end of the stream.
- **Description**: Manages the state of a gRPC request over an HTTP/2 connection, including buffering response headers and incoming messages, tracking deadlines for headers and stream completion, and maintaining context and sequence information for the request.


---
### fd\_grpc\_client\_private
- **Type**: ``struct``
- **Members**:
    - `callbacks`: Pointer to constant `fd_grpc_client_callbacks_t` for client callbacks.
    - `ctx`: Pointer to a context for the client.
    - `matcher`: Array of `fd_h2_hdr_matcher_t` for HTTP/2 header matching.
    - `conn`: Array of `fd_h2_conn_t` representing the HTTP/2 connection.
    - `frame_rx`: Array of `fd_h2_rbuf_t` for unencrypted HTTP/2 RX frame buffer.
    - `frame_tx`: Array of `fd_h2_rbuf_t` for unencrypted HTTP/2 TX frame buffer.
    - `host`: Character array for storing the HTTP/2 authority host.
    - `port`: Unsigned short for the HTTP/2 authority port, maximum value 65535.
    - `host_len`: Unsigned char for the length of the host, maximum value 255.
    - `ssl_hs_done`: Unsigned int bit field indicating if SSL handshake is done.
    - `h2_hs_done`: Unsigned int bit field indicating if HTTP/2 handshake is done.
    - `request_stream`: Pointer to `fd_grpc_h2_stream_t` for the inflight request stream.
    - `request_tx_op`: Array of `fd_h2_tx_op_t` for the request transmission operation.
    - `stream_pool`: Pointer to `fd_grpc_h2_stream_t` for the stream pool.
    - `stream_bufs`: Pointer to unsigned char for stream buffers.
    - `stream_ids`: Array of unsigned int for stream IDs, size `FD_GRPC_CLIENT_MAX_STREAMS`.
    - `streams`: Array of pointers to `fd_grpc_h2_stream_t` for streams, size `FD_GRPC_CLIENT_MAX_STREAMS`.
    - `stream_cnt`: Unsigned long for the count of streams.
    - `nanopb_tx`: Pointer to unsigned char for nanopb transmission buffer.
    - `nanopb_tx_max`: Unsigned long for the maximum size of the nanopb transmission buffer.
    - `frame_scratch`: Pointer to unsigned char for frame scratch buffer.
    - `frame_scratch_max`: Unsigned long for the maximum size of the frame scratch buffer.
    - `frame_rx_buf`: Pointer to unsigned char for frame RX buffer.
    - `frame_rx_buf_max`: Unsigned long for the maximum size of the frame RX buffer.
    - `frame_tx_buf`: Pointer to unsigned char for frame TX buffer.
    - `frame_tx_buf_max`: Unsigned long for the maximum size of the frame TX buffer.
    - `version_len`: Unsigned char for the length of the version string.
    - `version`: Character array for storing the version string, maximum length `FD_GRPC_CLIENT_VERSION_LEN_MAX`.
    - `metrics`: Pointer to `fd_grpc_client_metrics_t` for client metrics.
- **Description**: Manages the internal state of a gRPC client, including HTTP/2 and TLS connections, stream management, and data buffers. It maintains a single gRPC connection with associated resources like a TCP socket, SSL handle, and HTTP/2 connection. The structure also handles stream objects, which can be in different states (IDLE, OPEN, CLOSE_TX) and manages transitions between these states. It includes buffers for nanopb transmission, frame operations, and versioning, as well as metrics for performance tracking.


# Functions

---
### fd\_grpc\_h2\_stream\_upcast<!-- {{#callable:fd_grpc_h2_stream_upcast}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client_private.h#L42>)

Converts a pointer of type `fd_h2_stream_t` to a pointer of type `fd_grpc_h2_stream_t` by adjusting the memory offset.
- **Inputs**:
    - `stream`: A pointer to an `fd_h2_stream_t` object that needs to be upcasted to `fd_grpc_h2_stream_t`.
- **Logic and Control Flow**:
    - Calculate the memory offset of the `fd_h2_stream_t` member `s` within the `fd_grpc_h2_stream_t` structure using `offsetof(fd_grpc_h2_stream_t, s)`.
    - Subtract this offset from the address of the `stream` to get the base address of the `fd_grpc_h2_stream_t` structure.
    - Cast the calculated base address to a pointer of type `fd_grpc_h2_stream_t` and return it.
- **Output**: A pointer to the `fd_grpc_h2_stream_t` structure that contains the given `fd_h2_stream_t` object.


# Function Declarations (Public API)

---
### fd\_grpc\_client\_stream\_acquire\_is\_safe<!-- {{#callable_declaration:fd_grpc_client_stream_acquire_is_safe}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client_private.h#L149>)

Checks if acquiring a new gRPC client stream is possible.
- **Description**: Use this function to determine if a new gRPC client stream can be acquired safely. It checks if there is sufficient quota to start a new stream, if a free stream object is available, and if the maximum number of streams has not been exceeded. This function is useful before attempting to acquire a new stream to ensure that the operation will not exceed resource limits or constraints.
- **Inputs**:
    - `client`: A pointer to an `fd_grpc_client_t` structure representing the gRPC client. Must not be null. The function uses this to check the current state of the client's connection and stream pool.
- **Output**: Returns 1 if a new stream can be acquired safely, otherwise returns 0.
- **See Also**: [`fd_grpc_client_stream_acquire_is_safe`](<fd_grpc_client.c.md#fd_grpc_client_stream_acquire_is_safe>)  (Implementation)


---
### fd\_grpc\_client\_stream\_acquire<!-- {{#callable_declaration:fd_grpc_client_stream_acquire}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client_private.h#L158>)

Acquire a new stream ID and stream object for a gRPC client.
- **Description**: Use this function to obtain a new stream ID and stream object for a gRPC client when initiating a new request. This function must be called when the client is ready to send a new request and there is capacity in the stream pool. It is important to ensure that the client has not exceeded the maximum number of streams allowed, as this function will log a critical error if the stream pool is exhausted. The function assigns a new stream ID, initializes the stream, and updates the client's internal state to reflect the new stream acquisition.
- **Inputs**:
    - `client`: A pointer to an `fd_grpc_client_t` structure representing the gRPC client. Must not be null. The client must have available capacity in its stream pool.
    - `request_ctx`: An unsigned long integer representing the request context. This value is stored in the stream object and can be used to track the request.
- **Output**: Returns a pointer to an `fd_grpc_h2_stream_t` structure representing the acquired stream. The caller is responsible for managing the lifecycle of this stream.
- **See Also**: [`fd_grpc_client_stream_acquire`](<fd_grpc_client.c.md#fd_grpc_client_stream_acquire>)  (Implementation)


---
### fd\_grpc\_client\_stream\_release<!-- {{#callable_declaration:fd_grpc_client_stream_release}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client_private.h#L162>)

Releases a gRPC client stream.
- **Description**: Use this function to release a gRPC client stream when it is no longer needed. This function must be called to properly manage resources and maintain the integrity of the stream map. It is important to ensure that the stream is valid and currently managed by the client before calling this function. The function will handle the deallocation of the stream and update the client's internal stream map accordingly.
- **Inputs**:
    - `client`: A pointer to an `fd_grpc_client_t` structure. This must not be null and must point to a valid gRPC client instance that manages the stream.
    - `stream`: A pointer to an `fd_grpc_h2_stream_t` structure. This must not be null and must point to a valid stream that is currently managed by the client. The function will handle invalid streams by logging a critical error.
- **Output**: None
- **See Also**: [`fd_grpc_client_stream_release`](<fd_grpc_client.c.md#fd_grpc_client_stream_release>)  (Implementation)


---
### fd\_grpc\_client\_service\_streams<!-- {{#callable_declaration:fd_grpc_client_service_streams}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client_private.h#L171>)

Checks streams for timeouts and updates receive windows.
- **Description**: Use this function to monitor and manage active gRPC streams for timeouts and to update their receive windows as needed. It should be called periodically to ensure that streams do not exceed their deadlines and to maintain efficient data flow by adjusting receive windows. This function does not perform any actions if the connection has active flags, indicating that it is not in a suitable state for processing streams.
- **Inputs**:
    - `client`: A pointer to an `fd_grpc_client_t` structure representing the gRPC client. Must not be null. The client must be properly initialized and connected.
    - `ts_nanos`: A timestamp in nanoseconds representing the current time. Used to compare against stream deadlines to determine if timeouts have occurred.
- **Output**: None
- **See Also**: [`fd_grpc_client_service_streams`](<fd_grpc_client.c.md#fd_grpc_client_service_streams>)  (Implementation)


---
### fd\_grpc\_h2\_cb\_headers<!-- {{#callable_declaration:fd_grpc_h2_cb_headers}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_client_private.h#L175>)

Processes HTTP/2 headers for a gRPC stream.
- **Description**: Use this function to handle incoming HTTP/2 headers for a gRPC stream. It processes the headers and determines the appropriate actions based on the header content and flags. This function must be called when headers are received for a stream. It manages the state of the stream and invokes callbacks for the start and end of a response. Ensure that the connection and stream are valid and properly initialized before calling this function.
- **Inputs**:
    - `conn`: A pointer to an `fd_h2_conn_t` structure representing the HTTP/2 connection. Must not be null.
    - `h2_stream`: A pointer to an `fd_h2_stream_t` structure representing the HTTP/2 stream. Must not be null.
    - `data`: A pointer to a buffer containing the header data. Must not be null.
    - `data_sz`: The size of the data buffer in bytes. Must be a valid size for the provided data.
    - `flags`: A set of flags indicating the state of the headers, such as `FD_H2_FLAG_END_HEADERS` and `FD_H2_FLAG_END_STREAM`. Must be a valid combination of flags.
- **Output**: None
- **See Also**: [`fd_grpc_h2_cb_headers`](<fd_grpc_client.c.md#fd_grpc_h2_cb_headers>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)