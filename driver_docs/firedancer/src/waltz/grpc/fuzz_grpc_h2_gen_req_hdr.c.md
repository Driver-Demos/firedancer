<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Fuzz testing for generating and validating gRPC HTTP/2 request headers.

# Purpose
The code is a fuzz testing module designed for use with LLVM's libFuzzer. It initializes a test environment and processes input data to simulate HTTP/2 gRPC request header generation and validation. The [`LLVMFuzzerInitialize`](<#llvmfuzzerinitialize>) function sets up the environment by configuring logging and registering cleanup functions. The main function, [`LLVMFuzzerTestOneInput`](<#llvmfuzzertestoneinput>), takes a byte array as input, interprets it as various components of an HTTP/2 request, and constructs a gRPC request header. It then verifies the correctness of the generated headers using a series of tests.

The module includes functions to parse input data into components such as host, path, bearer authentication, and version. It constructs a request header using these components and validates the header fields against expected values. The code uses helper functions from included libraries, such as `fd_grpc_codec.h` and `fd_h2_rbuf.h`, to handle gRPC and HTTP/2 specific operations. The purpose of this module is to ensure the robustness of the gRPC request header generation and parsing logic by subjecting it to a wide range of input scenarios through fuzz testing.
# Imports and Dependencies

---
- `stdlib.h`
- `stddef.h`
- `string.h`
- `stdio.h`
- `fd_grpc_codec.h`
- `../h2/fd_h2_rbuf.h`


# Functions

---
### LLVMFuzzerInitialize<!-- {{#callable:LLVMFuzzerInitialize}} -->
[View Source →](<../../../../../src/waltz/grpc/fuzz_grpc_h2_gen_req_hdr.c#L13>)

Initializes the fuzzer environment by setting environment variables, booting the system, registering an exit function, and setting the log level.
- **Inputs**:
    - `argc`: A pointer to the argument count, typically passed to the main function.
    - `argv`: A pointer to the argument vector, typically passed to the main function.
- **Logic and Control Flow**:
    - Set the environment variable `FD_LOG_BACKTRACE` to `0` to disable backtraces in logs.
    - Call `fd_boot` with `argc` and `argv` to initialize the system.
    - Register the `fd_halt` function to be called at program exit using `atexit`.
    - Set the core log level to `1` using `fd_log_level_core_set`, which causes the program to crash on an info log.
- **Output**: Returns `0` to indicate successful initialization.


---
### expect\_hdr<!-- {{#callable:expect_hdr}} -->
[View Source →](<../../../../../src/waltz/grpc/fuzz_grpc_h2_gen_req_hdr.c#L24>)

Validates that the current header in the HPACK reader matches the expected name and value.
- **Inputs**:
    - `hpack_rd`: A pointer to an `fd_hpack_rd_t` structure representing the HPACK reader.
    - `hdr`: A pointer to an `fd_h2_hdr_t` structure where the header data will be stored.
    - `scratch`: A pointer to a `uchar` pointer used as a scratch space for processing.
    - `expected_name`: A constant character pointer representing the expected header name.
    - `expected_value`: A constant character pointer representing the expected header value.
- **Logic and Control Flow**:
    - Check that the HPACK reader is not done using `fd_hpack_rd_done` function.
    - Retrieve the next header from the HPACK reader using `fd_hpack_rd_next` function.
    - Calculate the length of `expected_name` and `expected_value` using `strlen`.
    - Verify that the length of the header's name matches `expected_name` length.
    - Check that the header's name matches `expected_name` using `fd_memeq`.
    - Verify that the length of the header's value matches `expected_value` length.
    - Check that the header's value matches `expected_value` using `fd_memeq`.
- **Output**: No return value; the function performs validation checks and may trigger assertions if expectations are not met.


---
### LLVMFuzzerTestOneInput<!-- {{#callable:LLVMFuzzerTestOneInput}} -->
[View Source →](<../../../../../src/waltz/grpc/fuzz_grpc_h2_gen_req_hdr.c#L37>)

Parses input data to construct and validate gRPC request headers for fuzz testing.
- **Inputs**:
    - `data`: A pointer to an array of unsigned characters representing the input data.
    - `size`: The size of the input data array.
- **Logic and Control Flow**:
    - Check if the input size is less than the minimum required length and return -1 if true.
    - Calculate the remaining size after accounting for the minimum length.
    - Extract lengths for host, path, bearer authentication, and version from the input data.
    - Extract the HTTPS flag and port number from the input data.
    - Check if the sum of extracted lengths exceeds the remaining size and return -1 if true.
    - Copy and null-terminate the host, path, bearer authentication, and version strings from the input data.
    - Recalculate the lengths of the strings to handle any null bytes and return -1 if any length is zero.
    - Format the host and port into a string and store it in `host_port`.
    - Format the user agent string using the version and store it in `user_agent`.
    - Initialize a gRPC request headers structure with the extracted data.
    - Initialize a buffer and a read buffer for HTTP/2 headers.
    - Generate HTTP/2 request headers and validate the operation.
    - Initialize an HPACK reader and validate the expected headers using [`expect_hdr`](<#expect_hdr>).
    - Perform a series of tests to ensure the headers are correctly parsed and match expected values.
    - Return 0 to indicate successful processing.
- **Output**: Returns 0 if the input data is successfully processed and validated, otherwise returns -1 if any validation fails.
- **Functions Called**:
    - [`fd_grpc_h2_gen_request_hdrs`](<fd_grpc_codec.c.md#fd_grpc_h2_gen_request_hdrs>)
    - [`expect_hdr`](<#expect_hdr>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)