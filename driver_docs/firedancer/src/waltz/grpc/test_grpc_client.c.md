<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Unit tests for a gRPC client, including tests for connection state, deadlines, stream quotas, and headers.

# Purpose
The code is a test suite for a gRPC client implementation. It is designed to verify the functionality of a gRPC client by simulating various scenarios and checking the client's behavior. The code includes several test functions that assess different aspects of the gRPC client's operation, such as connection handling, stream management, deadline handling, and header processing. The tests are executed only if the `FD_HAS_HOSTED` macro is defined, indicating that the environment supports hosted execution.

The main components of the code include functions like [`test_grpc_client_mock_conn`](<#test_grpc_client_mock_conn>), which injects a mock connection state into the client, and several callback functions ([`cb_rx_start`](<#cb_rx_start>), [`cb_rx_end`](<#cb_rx_end>), [`cb_rx_timeout`](<#cb_rx_timeout>)) that track the state of received data and timeouts. The test functions ([`test_header_deadline`](<#test_header_deadline>), [`test_rx_end_deadline`](<#test_rx_end_deadline>), [`test_rx_stream_quota`](<#test_rx_stream_quota>), [`test_stream_release`](<#test_stream_release>), [`test_rx_headers`](<#test_rx_headers>)) each focus on specific client behaviors, such as handling deadlines, managing stream quotas, and processing headers. The [`main`](<#main>) function initializes the client, sets up the test environment, executes the tests, and then cleans up the client resources.
# Imports and Dependencies

---
- `../../util/fd_util.h`
- `fd_grpc_client_private.h`


# Global Variables

---
### g\_cb\_app\_ctx
- **Type**: `void *`
- **Description**: Stores a pointer to the application context used in callback functions.
- **Use**: Used to store and update the application context in the `cb_rx_start`, `cb_rx_end`, and `cb_rx_timeout` callback functions.


---
### g\_cb\_request\_ctx
- **Type**: ``ulong``
- **Description**: Stores the context of a request in the form of an unsigned long integer. This variable is used to keep track of the request context during the execution of callback functions.
- **Use**: Used to store and update the request context in callback functions such as `cb_rx_start`, `cb_rx_end`, and `cb_rx_timeout`.


---
### g\_rx\_start\_cnt
- **Type**: `ulong`
- **Description**: `g_rx_start_cnt` is a static global variable of type `ulong` that counts the number of times the `cb_rx_start` callback function is called.
- **Use**: Tracks the number of received start events in the gRPC client.


---
### g\_rx\_end\_cnt
- **Type**: ``ulong``
- **Description**: Counts the number of times the `cb_rx_end` callback function is called. This variable is incremented each time a gRPC response ends.
- **Use**: Tracks the number of completed gRPC response receptions.


---
### g\_cb\_resp\_hdrs
- **Type**: ``fd_grpc_resp_hdrs_t``
- **Description**: Stores the response headers received from a gRPC server. It is used to hold the headers data after a gRPC call is completed.
- **Use**: Used in the `cb_rx_end` callback function to store the response headers from a gRPC call.


---
### g\_timeout\_cnt
- **Type**: `ulong`
- **Description**: `g_timeout_cnt` is a static global variable of type `ulong` that counts the number of times a timeout occurs in the gRPC client operations.
- **Use**: Tracks the number of timeout events during gRPC client operations.


---
### g\_timeout\_details
- **Type**: ``struct``
- **Description**: Contains a single integer field `deadline_kind` that represents the type of deadline associated with a gRPC operation.
- **Use**: Stores the kind of deadline for timeout handling in gRPC client operations.


# Functions

---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/waltz/grpc/test_grpc_client.c#L220>)

Initializes and tests a gRPC client using various test functions.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Defines a static memory buffer `client_mem` for the gRPC client, aligned to 128 bytes.
    - Sets `buf_max` to 4096 and checks if the client footprint fits in `client_mem`.
    - Initializes `fd_grpc_client_callbacks_t` with callback functions `cb_rx_start`, `cb_rx_end`, and `cb_rx_timeout`.
    - Initializes `fd_grpc_client_metrics_t` to zero.
    - Sets `app_ctx` to a specific memory address and `rng_seed` to 1.
    - Creates a new gRPC client using [`fd_grpc_client_new`](<fd_grpc_client.c.md#fd_grpc_client_new>) with the defined parameters and checks its validity.
    - Executes a series of test functions: [`test_header_deadline`](<#test_header_deadline>), [`test_rx_end_deadline`](<#test_rx_end_deadline>), [`test_rx_stream_quota`](<#test_rx_stream_quota>), [`test_stream_release`](<#test_stream_release>), and [`test_rx_headers`](<#test_rx_headers>).
    - Deletes the gRPC client using [`fd_grpc_client_delete`](<fd_grpc_client.c.md#fd_grpc_client_delete>).
    - Logs a notice indicating the tests passed and calls `fd_halt` to terminate the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`fd_grpc_client_footprint`](<fd_grpc_client.c.md#fd_grpc_client_footprint>)
    - [`fd_grpc_client_new`](<fd_grpc_client.c.md#fd_grpc_client_new>)
    - [`test_header_deadline`](<#test_header_deadline>)
    - [`test_rx_end_deadline`](<#test_rx_end_deadline>)
    - [`test_rx_stream_quota`](<#test_rx_stream_quota>)
    - [`test_stream_release`](<#test_stream_release>)
    - [`test_rx_headers`](<#test_rx_headers>)
    - [`fd_grpc_client_delete`](<fd_grpc_client.c.md#fd_grpc_client_delete>)


---
### test\_grpc\_client\_mock\_conn<!-- {{#callable:test_grpc_client_mock_conn}} -->
[View Source →](<../../../../../src/waltz/grpc/test_grpc_client.c#L21>)

Sets the gRPC client's SSL and HTTP/2 handshake states to done and resets connection flags.
- **Inputs**:
    - `client`: A pointer to an `fd_grpc_client_t` structure representing the gRPC client whose connection state is to be modified.
- **Logic and Control Flow**:
    - Set the `ssl_hs_done` field of the `client` to 1, indicating that the SSL handshake is complete.
    - Set the `h2_hs_done` field of the `client` to 1, indicating that the HTTP/2 handshake is complete.
    - Set the `flags` field of the `client->conn` to 0, resetting any connection flags.
- **Output**: No return value; the function modifies the state of the `client` object in place.


---
### cb\_rx\_start<!-- {{#callable:cb_rx_start}} -->
[View Source →](<../../../../../src/waltz/grpc/test_grpc_client.c#L34>)

Assigns the provided application context and request context to global variables and increments a counter.
- **Inputs**:
    - ``app_ctx``: A pointer to the application context to be stored globally.
    - ``request_ctx``: An unsigned long integer representing the request context to be stored globally.
- **Logic and Control Flow**:
    - Assigns the value of `app_ctx` to the global variable `g_cb_app_ctx`.
    - Assigns the value of `request_ctx` to the global variable `g_cb_request_ctx`.
    - Increments the global counter `g_rx_start_cnt` by one.
- **Output**: No return value; the function operates by modifying global state.


---
### cb\_rx\_end<!-- {{#callable:cb_rx_end}} -->
[View Source →](<../../../../../src/waltz/grpc/test_grpc_client.c#L45>)

Updates global variables with the application context, request context, and response headers, and increments a counter.
- **Inputs**:
    - ``app_ctx``: A pointer to the application context.
    - ``request_ctx``: An unsigned long integer representing the request context.
    - ``resp_hdrs``: A pointer to a `fd_grpc_resp_hdrs_t` structure containing the response headers.
- **Logic and Control Flow**:
    - Assigns the value of `app_ctx` to the global variable `g_cb_app_ctx`.
    - Assigns the value of `request_ctx` to the global variable `g_cb_request_ctx`.
    - Copies the contents of the structure pointed to by `resp_hdrs` into the global variable `g_cb_resp_hdrs`.
    - Increments the global counter `g_rx_end_cnt` by 1.
- **Output**: No return value (void function).


---
### cb\_rx\_timeout<!-- {{#callable:cb_rx_timeout}} -->
[View Source →](<../../../../../src/waltz/grpc/test_grpc_client.c#L61>)

Updates global variables with context and deadline information when a receive timeout occurs.
- **Inputs**:
    - ``app_ctx``: A pointer to the application context, which is stored in the global variable `g_cb_app_ctx`.
    - ``request_ctx``: An unsigned long integer representing the request context, which is stored in the global variable `g_cb_request_ctx`.
    - ``deadline_kind``: An integer indicating the type of deadline, which is stored in the `deadline_kind` field of the global `g_timeout_details` structure.
- **Logic and Control Flow**:
    - Assigns the value of `app_ctx` to the global variable `g_cb_app_ctx`.
    - Assigns the value of `request_ctx` to the global variable `g_cb_request_ctx`.
    - Assigns the value of `deadline_kind` to the `deadline_kind` field of the global `g_timeout_details` structure.
    - Increments the global variable `g_timeout_cnt` by 1.
- **Output**: No return value; the function updates global state variables.


---
### test\_header\_deadline<!-- {{#callable:test_header_deadline}} -->
[View Source →](<../../../../../src/waltz/grpc/test_grpc_client.c#L71>)

Tests the behavior of gRPC client stream deadlines, ensuring they do not fire prematurely and handle header reception correctly.
- **Inputs**:
    - `client`: A pointer to an `fd_grpc_client_t` structure representing the gRPC client to test.
- **Logic and Control Flow**:
    - Reset the gRPC client state using [`fd_grpc_client_reset`](<fd_grpc_client.c.md#fd_grpc_client_reset>) and mock a connection with [`test_grpc_client_mock_conn`](<#test_grpc_client_mock_conn>).
    - Check that acquiring a stream is safe with [`fd_grpc_client_stream_acquire_is_safe`](<fd_grpc_client.c.md#fd_grpc_client_stream_acquire_is_safe>).
    - Acquire a new stream using [`fd_grpc_client_stream_acquire`](<fd_grpc_client.c.md#fd_grpc_client_stream_acquire>) and set a deadline with [`fd_grpc_client_deadline_set`](<fd_grpc_client.c.md#fd_grpc_client_deadline_set>).
    - Service the streams with [`fd_grpc_client_service_streams`](<fd_grpc_client.c.md#fd_grpc_client_service_streams>) before the deadline and verify the stream count remains 1.
    - Simulate header reception with [`fd_grpc_h2_cb_headers`](<fd_grpc_client.c.md#fd_grpc_h2_cb_headers>) and service streams after the deadline, ensuring the stream count remains 1.
    - Release the stream with [`fd_grpc_client_stream_release`](<fd_grpc_client.c.md#fd_grpc_client_stream_release>) and verify the stream count is 0.
    - Test deadline firing by acquiring a new stream, setting a deadline, servicing streams after the deadline, and verifying the stream count is 0.
    - Check that a reset stream frame is sent by verifying the size of the used buffer and the contents of the reset stream frame.
- **Output**: No direct output is returned, but the function performs tests and assertions to validate the behavior of stream deadlines in the gRPC client.
- **Functions Called**:
    - [`fd_grpc_client_reset`](<fd_grpc_client.c.md#fd_grpc_client_reset>)
    - [`test_grpc_client_mock_conn`](<#test_grpc_client_mock_conn>)
    - [`fd_grpc_client_stream_acquire_is_safe`](<fd_grpc_client.c.md#fd_grpc_client_stream_acquire_is_safe>)
    - [`fd_grpc_client_stream_acquire`](<fd_grpc_client.c.md#fd_grpc_client_stream_acquire>)
    - [`fd_grpc_client_deadline_set`](<fd_grpc_client.c.md#fd_grpc_client_deadline_set>)
    - [`fd_grpc_client_service_streams`](<fd_grpc_client.c.md#fd_grpc_client_service_streams>)
    - [`fd_grpc_h2_cb_headers`](<fd_grpc_client.c.md#fd_grpc_h2_cb_headers>)
    - [`fd_grpc_client_stream_release`](<fd_grpc_client.c.md#fd_grpc_client_stream_release>)


---
### test\_rx\_end\_deadline<!-- {{#callable:test_rx_end_deadline}} -->
[View Source →](<../../../../../src/waltz/grpc/test_grpc_client.c#L110>)

Tests the behavior of a gRPC client when a receive-end deadline is set and verifies that the deadline fires correctly after headers are received.
- **Inputs**:
    - `client`: A pointer to an `fd_grpc_client_t` structure representing the gRPC client to test.
- **Logic and Control Flow**:
    - Resets the gRPC client state using [`fd_grpc_client_reset`](<fd_grpc_client.c.md#fd_grpc_client_reset>) and injects a mock connection state with [`test_grpc_client_mock_conn`](<#test_grpc_client_mock_conn>).
    - Checks if acquiring a stream is safe with [`fd_grpc_client_stream_acquire_is_safe`](<fd_grpc_client.c.md#fd_grpc_client_stream_acquire_is_safe>) and acquires a stream using [`fd_grpc_client_stream_acquire`](<fd_grpc_client.c.md#fd_grpc_client_stream_acquire>).
    - Sets a receive-end deadline on the acquired stream using [`fd_grpc_client_deadline_set`](<fd_grpc_client.c.md#fd_grpc_client_deadline_set>).
    - Services the streams with a time just before the deadline using [`fd_grpc_client_service_streams`](<fd_grpc_client.c.md#fd_grpc_client_service_streams>) and verifies that the stream count is still 1, indicating the deadline has not fired.
    - Simulates the reception of headers with [`fd_grpc_h2_cb_headers`](<fd_grpc_client.c.md#fd_grpc_h2_cb_headers>).
    - Services the streams with a time just after the deadline and verifies that the stream count is 0, indicating the deadline has fired.
- **Output**: No direct output is returned, but the function uses assertions (`FD_TEST`) to verify the expected behavior of the gRPC client in response to the deadline.
- **Functions Called**:
    - [`fd_grpc_client_reset`](<fd_grpc_client.c.md#fd_grpc_client_reset>)
    - [`test_grpc_client_mock_conn`](<#test_grpc_client_mock_conn>)
    - [`fd_grpc_client_stream_acquire_is_safe`](<fd_grpc_client.c.md#fd_grpc_client_stream_acquire_is_safe>)
    - [`fd_grpc_client_stream_acquire`](<fd_grpc_client.c.md#fd_grpc_client_stream_acquire>)
    - [`fd_grpc_client_deadline_set`](<fd_grpc_client.c.md#fd_grpc_client_deadline_set>)
    - [`fd_grpc_client_service_streams`](<fd_grpc_client.c.md#fd_grpc_client_service_streams>)
    - [`fd_grpc_h2_cb_headers`](<fd_grpc_client.c.md#fd_grpc_h2_cb_headers>)


---
### test\_rx\_stream\_quota<!-- {{#callable:test_rx_stream_quota}} -->
[View Source →](<../../../../../src/waltz/grpc/test_grpc_client.c#L129>)

Tests the gRPC client's ability to replenish the receive quota for a stream.
- **Inputs**:
    - ``client``: A pointer to an `fd_grpc_client_t` structure representing the gRPC client.
- **Logic and Control Flow**:
    - Resets the gRPC client state using [`fd_grpc_client_reset`](<fd_grpc_client.c.md#fd_grpc_client_reset>) and injects a mock connection state with [`test_grpc_client_mock_conn`](<#test_grpc_client_mock_conn>).
    - Checks if it is safe to acquire a stream using [`fd_grpc_client_stream_acquire_is_safe`](<fd_grpc_client.c.md#fd_grpc_client_stream_acquire_is_safe>).
    - Acquires a new stream with [`fd_grpc_client_stream_acquire`](<fd_grpc_client.c.md#fd_grpc_client_stream_acquire>) and sets its receive window size to half of the initial window size minus one.
    - Calls [`fd_grpc_client_service_streams`](<fd_grpc_client.c.md#fd_grpc_client_service_streams>) to process the stream and potentially send a WINDOW_UPDATE frame.
    - Verifies that the size of the used buffer in `client->frame_tx` matches the size of a `fd_h2_window_update_t` structure.
    - Copies the WINDOW_UPDATE frame from the buffer and checks its type, flags, stream ID, and increment value to ensure they are correct.
- **Output**: No direct output is returned, but the function performs several tests to ensure the receive quota is replenished correctly.
- **Functions Called**:
    - [`fd_grpc_client_reset`](<fd_grpc_client.c.md#fd_grpc_client_reset>)
    - [`test_grpc_client_mock_conn`](<#test_grpc_client_mock_conn>)
    - [`fd_grpc_client_stream_acquire_is_safe`](<fd_grpc_client.c.md#fd_grpc_client_stream_acquire_is_safe>)
    - [`fd_grpc_client_stream_acquire`](<fd_grpc_client.c.md#fd_grpc_client_stream_acquire>)
    - [`fd_grpc_client_service_streams`](<fd_grpc_client.c.md#fd_grpc_client_service_streams>)


---
### test\_stream\_release<!-- {{#callable:test_stream_release}} -->
[View Source →](<../../../../../src/waltz/grpc/test_grpc_client.c#L149>)

Tests the release of gRPC streams and verifies the stream count and order after each release.
- **Inputs**:
    - `client`: A pointer to an `fd_grpc_client_t` structure representing the gRPC client.
- **Logic and Control Flow**:
    - Resets the gRPC client using [`fd_grpc_client_reset`](<fd_grpc_client.c.md#fd_grpc_client_reset>) and injects a mock connection state with [`test_grpc_client_mock_conn`](<#test_grpc_client_mock_conn>).
    - Acquires four streams (`stream0`, `stream1`, `stream2`, `stream3`) using [`fd_grpc_client_stream_acquire`](<fd_grpc_client.c.md#fd_grpc_client_stream_acquire>) with stream IDs 0, 1, 2, and 3 respectively.
    - Verifies that the stream count is 4 using `FD_TEST`.
    - Releases `stream1` and verifies the stream count is 3, checking the order of remaining stream IDs.
    - Releases `stream2` and verifies the stream count is 2, checking the order of remaining stream IDs.
    - Releases `stream0` and verifies the stream count is 1, checking the order of remaining stream IDs.
    - Releases `stream3` and verifies the stream count is 0.
- **Output**: No return value; the function performs tests and assertions on the gRPC client's stream management.
- **Functions Called**:
    - [`fd_grpc_client_reset`](<fd_grpc_client.c.md#fd_grpc_client_reset>)
    - [`test_grpc_client_mock_conn`](<#test_grpc_client_mock_conn>)
    - [`fd_grpc_client_stream_acquire`](<fd_grpc_client.c.md#fd_grpc_client_stream_acquire>)
    - [`fd_grpc_client_stream_release`](<fd_grpc_client.c.md#fd_grpc_client_stream_release>)


---
### test\_rx\_headers<!-- {{#callable:test_rx_headers}} -->
[View Source →](<../../../../../src/waltz/grpc/test_grpc_client.c#L174>)

Tests the reception and processing of gRPC headers in various scenarios.
- **Inputs**:
    - ``client``: A pointer to an `fd_grpc_client_t` structure representing the gRPC client.
- **Logic and Control Flow**:
    - Resets the gRPC client and sets up a mock connection.
    - Acquires a stream and checks if headers have been received.
    - Sets the stream's headers to indicate a gRPC protocol with a status of 200.
    - Calls [`fd_grpc_h2_cb_headers`](<fd_grpc_client.c.md#fd_grpc_h2_cb_headers>) to simulate receiving headers and checks if headers are marked as received.
    - Verifies that the global counters `g_rx_start_cnt` and `g_rx_end_cnt` are incremented correctly and that the client's stream count is zero.
    - Tests an incomplete header fragment by acquiring a stream, simulating header reception without end flags, and verifying that headers are not marked as received.
    - Tests complete headers with pending data by acquiring a stream, setting headers, simulating header reception with end headers flag, and verifying the correct increment of `g_rx_start_cnt`.
    - Tests corrupt headers by acquiring a stream, setting headers, simulating reception of corrupt headers, and verifying the correct increment of `g_rx_end_cnt`.
- **Output**: No return value; the function performs tests and uses assertions to validate behavior.
- **Functions Called**:
    - [`fd_grpc_client_reset`](<fd_grpc_client.c.md#fd_grpc_client_reset>)
    - [`test_grpc_client_mock_conn`](<#test_grpc_client_mock_conn>)
    - [`fd_grpc_client_stream_acquire`](<fd_grpc_client.c.md#fd_grpc_client_stream_acquire>)
    - [`fd_grpc_h2_cb_headers`](<fd_grpc_client.c.md#fd_grpc_h2_cb_headers>)
    - [`fd_grpc_client_stream_release`](<fd_grpc_client.c.md#fd_grpc_client_stream_release>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)