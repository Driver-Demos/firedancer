<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements gRPC codec functions for generating and parsing HTTP/2 headers in the Firedancer project.

# Purpose
The code provides functionality for handling gRPC over HTTP/2 communication. It includes functions to generate and parse HTTP/2 headers for gRPC requests and responses. The function [`fd_grpc_h2_gen_request_hdrs`](<#fd_grpc_h2_gen_request_hdrs>) constructs HTTP/2 headers for a gRPC request, including method, scheme, path, authority, and content type. It also adds a user agent and optional bearer authentication. The function [`fd_grpc_h2_read_response_hdrs`](<#fd_grpc_h2_read_response_hdrs>) parses HTTP/2 headers from a gRPC response, extracting status codes and content type, and checks if the content type is gRPC-related. It also handles gRPC-specific headers like status and message.

The code also includes utility functions such as [`fd_grpc_h2_parse_num`](<#fd_grpc_h2_parse_num>), which parses a numeric value from a string, and [`fd_grpc_status_cstr`](<#fd_grpc_status_cstr>), which converts gRPC status codes to human-readable strings. The code relies on external components for HTTP/2 header encoding and decoding, as indicated by the inclusion of headers like `fd_hpack.h` and `fd_hpack_wr.h`. This code is intended to be part of a larger system that manages gRPC communication, providing specific functions for encoding and decoding headers in the context of HTTP/2.
# Imports and Dependencies

---
- `fd_grpc_codec.h`
- `../h2/fd_hpack.h`
- `../h2/fd_hpack_wr.h`


# Functions

---
### fd\_hpack\_wr\_content\_type\_grpc<!-- {{#callable:fd_hpack_wr_content_type_grpc}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_codec.c#L5>)

Writes the gRPC content type header to the provided buffer if there is enough space.
- **Inputs**:
    - ``rbuf_tx``: A pointer to an `fd_h2_rbuf_t` structure representing the buffer where the content type header will be written.
- **Logic and Control Flow**:
    - Define a static character array `code` containing the gRPC content type header value.
    - Check if the free space in `rbuf_tx` is less than the size of `code` minus one using `fd_h2_rbuf_free_sz`.
    - If there is not enough space, return 0 to indicate failure.
    - If there is enough space, push the `code` into `rbuf_tx` using `fd_h2_rbuf_push`.
    - Return 1 to indicate success.
- **Output**: Returns 1 if the content type header is successfully written to the buffer, otherwise returns 0.


---
### fd\_grpc\_h2\_gen\_request\_hdrs<!-- {{#callable:fd_grpc_h2_gen_request_hdrs}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_codec.c#L14>)

Generates gRPC HTTP/2 request headers and writes them to a buffer.
- **Inputs**:
    - `req`: A pointer to a `fd_grpc_req_hdrs_t` structure containing request header information such as path, host, and bearer authentication.
    - `rbuf_tx`: A pointer to a `fd_h2_rbuf_t` buffer where the generated headers will be written.
    - `version`: A pointer to a character array containing the version string to be included in the user-agent header.
    - `version_len`: The length of the version string.
- **Logic and Control Flow**:
    - Checks if writing the HTTP method 'POST' to the buffer is successful; returns 0 if not.
    - Writes the scheme to the buffer and returns 0 if unsuccessful.
    - Writes the request path to the buffer and returns 0 if unsuccessful.
    - If the host length is non-zero, writes the authority (host and port) to the buffer and returns 0 if unsuccessful.
    - Writes the trailers to the buffer and returns 0 if unsuccessful.
    - Writes the content type 'application/grpc+proto' to the buffer and returns 0 if unsuccessful.
    - Calculates the user-agent length and writes the user-agent to the buffer; returns 0 if unsuccessful.
    - Pushes the user-agent and version strings to the buffer.
    - If bearer authentication is present, writes the bearer token to the buffer and returns 0 if unsuccessful.
    - Returns 1 to indicate successful header generation.
- **Output**: Returns 1 if all headers are successfully written to the buffer, otherwise returns 0.
- **Functions Called**:
    - [`fd_hpack_wr_content_type_grpc`](<#fd_hpack_wr_content_type_grpc>)


---
### fd\_grpc\_h2\_parse\_num<!-- {{#callable:fd_grpc_h2_parse_num}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_codec.c#L42>)

Parses a string representation of a decimal number and converts it to an unsigned integer.
- **Inputs**:
    - ``num``: A pointer to a character array that contains the string representation of the number to parse.
    - ``num_len``: The length of the string to parse, which is limited to a maximum of 10 characters.
- **Logic and Control Flow**:
    - Limit `num_len` to a maximum of 10 using `fd_ulong_min` function.
    - Initialize a character array `num_cstr` with a size of 11 to store the number string.
    - Use `fd_cstr_init` to initialize `num_cstr` and `fd_cstr_append_text` to append the number string from `num` to `num_cstr`.
    - Finalize the C-string with `fd_cstr_fini`.
    - Convert the finalized C-string to an unsigned integer using `fd_cstr_to_uint`.
- **Output**: Returns the unsigned integer representation of the parsed number.


---
### fd\_grpc\_h2\_read\_response\_hdrs<!-- {{#callable:fd_grpc_h2_read_response_hdrs}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_codec.c#L51>)

Parses gRPC response headers from a payload and populates a response header structure.
- **Inputs**:
    - `resp`: A pointer to an `fd_grpc_resp_hdrs_t` structure where the parsed response headers will be stored.
    - `matcher`: A constant pointer to an `fd_h2_hdr_matcher_t` used to match header names.
    - `payload`: A constant pointer to an unsigned character array containing the payload data to parse.
    - `payload_sz`: An unsigned long integer representing the size of the payload data.
- **Logic and Control Flow**:
    - Initialize an `fd_hpack_rd_t` structure with the given payload and its size.
    - Enter a loop that continues until all headers are read from the payload.
    - Within the loop, use a static buffer `scratch_buf` to temporarily store header data.
    - Call `fd_hpack_rd_next` to read the next header from the payload into an `fd_h2_hdr_t` structure.
    - If an error occurs during header reading, log a warning and return `FD_H2_ERR_PROTOCOL`.
    - Use `fd_h2_hdr_match` to determine the index of the current header based on the matcher.
    - Depending on the header index, update the `resp` structure with the appropriate header information:
    - - For `FD_H2_HDR_STATUS`, parse and store the HTTP/2 status code.
    - - For `FD_H2_HDR_CONTENT_TYPE`, check if the content type is gRPC and update the flag.
    - - For `FD_GRPC_HDR_STATUS`, parse and store the gRPC status code.
    - - For `FD_GRPC_HDR_MESSAGE`, copy the message content to `resp->grpc_msg` and update its length.
    - Return `FD_H2_SUCCESS` after successfully parsing all headers.
- **Output**: Returns an integer status code, `FD_H2_SUCCESS` on success or `FD_H2_ERR_PROTOCOL` on failure.
- **Functions Called**:
    - [`fd_grpc_h2_parse_num`](<#fd_grpc_h2_parse_num>)


---
### fd\_grpc\_status\_cstr<!-- {{#callable:fd_grpc_status_cstr}} -->
[View Source →](<../../../../../src/waltz/grpc/fd_grpc_codec.c#L92>)

Maps a gRPC status code to its corresponding string representation.
- **Inputs**:
    - `status`: An unsigned integer representing the gRPC status code to be converted to a string.
- **Logic and Control Flow**:
    - Use a switch statement to match the input `status` with predefined gRPC status codes.
    - For each case, return the corresponding string representation of the gRPC status code.
    - If the `status` does not match any predefined case, return "unknown".
- **Output**: A constant character pointer to the string representation of the gRPC status code.



---
Made with ❤️ by [Driver](https://www.driver.ai/)