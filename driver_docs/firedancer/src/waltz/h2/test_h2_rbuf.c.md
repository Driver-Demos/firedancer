<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests the functionality of a ring buffer with random push and pop operations.

# Purpose
The code is a test suite for a ring buffer implementation, specifically for a component named `fd_h2_rbuf`. It includes the header file `fd_h2_rbuf_sock.h` and a random number generator utility from `fd_rng.h`. The function [`test_h2_rbuf`](<#test_h2_rbuf>) initializes a ring buffer and performs a series of operations to validate its behavior. The operations include pushing and popping data to and from the buffer, using both direct copying and scatter-gather techniques. The test checks the integrity of the buffer by comparing the expected and actual sizes of free and used space, ensuring that the buffer's internal pointers and offsets are correctly managed.

The test function uses a loop to simulate a large number of iterations, where it randomly decides whether to push or pop data. It uses a shadow buffer to track the expected state of the ring buffer, allowing for verification of the buffer's operations. The function employs assertions (`FD_TEST`) to ensure that the buffer's state remains consistent with the expected behavior throughout the test. This code is intended to be part of a larger test framework, verifying the correctness and reliability of the ring buffer implementation.
# Imports and Dependencies

---
- `fd_h2_rbuf_sock.h`
- `../../util/rng/fd_rng.h`


# Functions

---
### test\_h2\_rbuf<!-- {{#callable:test_h2_rbuf}} -->
[View Source →](<../../../../../src/waltz/h2/test_h2_rbuf.c#L4>)

Tests the functionality of a ring buffer by performing random push and pop operations and verifying the buffer's integrity.
- **Inputs**:
    - `rng`: A pointer to a random number generator of type `fd_rng_t` used to generate random actions and sizes for push and pop operations.
- **Logic and Control Flow**:
    - Initialize a `scratch` array with characters 'A' to 'Z'.
    - Initialize a ring buffer `rbuf` with a buffer `buf` of size 64 and verify its initial state.
    - Create a `shadow` array to simulate the ring buffer operations for verification purposes.
    - Iterate 10,000,000 times, performing random actions based on a random number `action`.
    - If `action` is odd, perform a push operation with a random size `push_sz` and update the `shadow` array accordingly.
    - If `action` is even, perform a pop operation with a random size `pop_sz` and verify the data against the `shadow` array.
    - For push operations, either copy data directly or use a scatter list based on the `action` value.
    - For pop operations, either gather data or pop directly based on the `action` value.
    - After each operation, verify the free and used sizes of the ring buffer against expected values.
    - Ensure the ring buffer's internal pointers and offsets remain within valid bounds.
- **Output**: No return value; the function performs tests and assertions to verify the ring buffer's behavior.
- **Functions Called**:
    - [`fd_h2_rbuf_free_sz`](<fd_h2_rbuf.h.md#fd_h2_rbuf_free_sz>)
    - [`fd_h2_rbuf_used_sz`](<fd_h2_rbuf.h.md#fd_h2_rbuf_used_sz>)
    - [`fd_h2_rbuf_push`](<fd_h2_rbuf.h.md#fd_h2_rbuf_push>)
    - [`fd_h2_rbuf_prepare_recvmsg`](<fd_h2_rbuf_sock.h.md#fd_h2_rbuf_prepare_recvmsg>)
    - [`fd_h2_rbuf_commit_recvmsg`](<fd_h2_rbuf_sock.h.md#fd_h2_rbuf_commit_recvmsg>)
    - [`fd_h2_rbuf_peek_used`](<fd_h2_rbuf.h.md#fd_h2_rbuf_peek_used>)
    - [`fd_h2_rbuf_skip`](<fd_h2_rbuf.h.md#fd_h2_rbuf_skip>)
    - [`fd_h2_rbuf_pop`](<fd_h2_rbuf.h.md#fd_h2_rbuf_pop>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)