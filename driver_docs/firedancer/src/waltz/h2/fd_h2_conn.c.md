<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements HTTP/2 connection management, including initialization, frame handling, and flow control.

# Purpose
The code is a C module that implements parts of the HTTP/2 protocol, focusing on connection management and frame processing. It includes functions for initializing HTTP/2 connections for both clients and servers, handling various types of HTTP/2 frames, and managing flow control. The module defines several static functions to process incoming frames such as [`fd_h2_rx_data`](<#fd_h2_rx_data>), [`fd_h2_rx_headers`](<#fd_h2_rx_headers>), and [`fd_h2_rx_settings`](<#fd_h2_rx_settings>), which handle specific frame types like DATA, HEADERS, and SETTINGS, respectively. These functions ensure that frames are processed according to the HTTP/2 protocol specifications, including error handling and flow control.

The module also includes functions for sending control frames, such as PING and GOAWAY, and managing connection settings. It uses several data structures, such as `fd_h2_conn_t` for connection state and `fd_h2_rbuf_t` for buffer management, to maintain the state of the connection and the data being transmitted. The code is designed to be part of a larger HTTP/2 implementation, as it relies on callback functions and external data structures defined elsewhere, such as `fd_h2_callbacks_t`. The module does not define a public API directly but provides essential functionality for handling HTTP/2 connections and frames within a broader system.
# Imports and Dependencies

---
- `fd_h2_conn.h`
- `fd_h2_callback.h`
- `fd_h2_proto.h`
- `fd_h2_rbuf.h`
- `fd_h2_stream.h`
- `float.h`


# Global Variables

---
### fd\_h2\_client\_preface
- **Type**: ``char const[24]``
- **Description**: Contains the HTTP/2 client connection preface string, which is a specific sequence of bytes that a client sends at the start of an HTTP/2 connection to indicate the use of the HTTP/2 protocol.
- **Use**: Used to initialize the HTTP/2 connection by sending the preface string to the server.


---
### fd\_h2\_settings\_initial
- **Type**: ``fd_h2_settings_t``
- **Description**: Defines the initial settings for an HTTP/2 connection. It specifies the maximum number of concurrent streams, the initial window size, the maximum frame size, and the maximum header list size.
- **Use**: Used to initialize the settings for both client and server connections in HTTP/2.


# Functions

---
### fd\_h2\_conn\_init\_window<!-- {{#callable:fd_h2_conn_init_window}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_conn.c#L21>)

Initializes the receive and transmit window sizes for an HTTP/2 connection.
- **Inputs**:
    - ``conn``: A pointer to an `fd_h2_conn_t` structure representing the HTTP/2 connection.
- **Logic and Control Flow**:
    - Set `conn->rx_wnd_max` to 65535U, which is the maximum receive window size.
    - Set `conn->rx_wnd` to the value of `conn->rx_wnd_max`, initializing the current receive window size.
    - Calculate `conn->rx_wnd_wmark` as 70% of `conn->rx_wnd_max` and store it as an unsigned integer.
    - Set `conn->tx_wnd` to 65535U, initializing the transmit window size.
- **Output**: No return value; modifies the `conn` structure in place.


---
### fd\_h2\_conn\_init\_client<!-- {{#callable:fd_h2_conn_init_client}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_conn.c#L29>)

Initializes an HTTP/2 client connection structure with default settings and prepares it for use.
- **Inputs**:
    - ``conn``: A pointer to an `fd_h2_conn_t` structure that represents the connection to initialize.
- **Logic and Control Flow**:
    - Assigns initial settings to the `self_settings` and `peer_settings` fields of the `conn` structure using `fd_h2_settings_initial`.
    - Sets the `flags` field of `conn` to `FD_H2_CONN_FLAGS_CLIENT_INITIAL` to indicate a client connection.
    - Initializes the `tx_stream_next` field to `1U` and the `rx_stream_next` field to `2U` to set the initial stream identifiers for transmission and reception.
    - Calls [`fd_h2_conn_init_window`](<#fd_h2_conn_init_window>) to initialize the connection's window settings.
    - Returns the initialized `conn` pointer.
- **Output**: Returns a pointer to the initialized `fd_h2_conn_t` structure.
- **Functions Called**:
    - [`fd_h2_conn_init_window`](<#fd_h2_conn_init_window>)


---
### fd\_h2\_conn\_init\_server<!-- {{#callable:fd_h2_conn_init_server}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_conn.c#L42>)

Initializes an HTTP/2 server connection with default settings and prepares the connection window.
- **Inputs**:
    - ``conn``: A pointer to an `fd_h2_conn_t` structure that represents the connection to initialize.
- **Logic and Control Flow**:
    - Assigns initial settings to the `conn` structure, including `self_settings`, `peer_settings`, `flags`, `tx_stream_next`, and `rx_stream_next`.
    - Calls [`fd_h2_conn_init_window`](<#fd_h2_conn_init_window>) to initialize the connection's window settings.
    - Returns the initialized `conn` pointer.
- **Output**: Returns a pointer to the initialized `fd_h2_conn_t` structure.
- **Functions Called**:
    - [`fd_h2_conn_init_window`](<#fd_h2_conn_init_window>)


---
### fd\_h2\_setting\_encode<!-- {{#callable:fd_h2_setting_encode}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_conn.c#L55>)

Encodes an HTTP/2 setting by storing the byte-swapped setting ID and value into a buffer.
- **Inputs**:
    - ``buf``: A pointer to a buffer where the encoded setting will be stored.
    - ``setting_id``: The ID of the HTTP/2 setting to encode, represented as an unsigned short.
    - ``setting_value``: The value of the HTTP/2 setting to encode, represented as an unsigned int.
- **Logic and Control Flow**:
    - Byte-swaps the `setting_id` using [`fd_ushort_bswap`](<../../util/bits/fd_bits.h.md#fd_ushort_bswap>) and stores it in the buffer at the starting position using `FD_STORE` macro.
    - Byte-swaps the `setting_value` using [`fd_uint_bswap`](<../../util/bits/fd_bits.h.md#fd_uint_bswap>) and stores it in the buffer at an offset of 2 bytes using `FD_STORE` macro.
- **Output**: The function does not return a value; it modifies the buffer pointed to by `buf` to contain the encoded setting.
- **Functions Called**:
    - [`fd_ushort_bswap`](<../../util/bits/fd_bits.h.md#fd_ushort_bswap>)
    - [`fd_uint_bswap`](<../../util/bits/fd_bits.h.md#fd_uint_bswap>)


---
### fd\_h2\_gen\_settings<!-- {{#callable:fd_h2_gen_settings}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_conn.c#L65>)

Generates an HTTP/2 SETTINGS frame with specified settings and encodes it into a buffer.
- **Inputs**:
    - `settings`: A pointer to a `fd_h2_settings_t` structure containing the HTTP/2 settings to encode.
    - `buf`: A buffer of size `FD_H2_OUR_SETTINGS_ENCODED_SZ` where the encoded SETTINGS frame will be stored.
- **Logic and Control Flow**:
    - Initialize a `fd_h2_frame_hdr_t` structure with the type and length for a SETTINGS frame.
    - Copy the frame header into the buffer using `fd_memcpy`.
    - Encode each setting using [`fd_h2_setting_encode`](<#fd_h2_setting_encode>) and store them sequentially in the buffer starting from the 9th byte.
    - The settings encoded include `FD_H2_SETTINGS_HEADER_TABLE_SIZE`, `FD_H2_SETTINGS_ENABLE_PUSH`, `FD_H2_SETTINGS_MAX_CONCURRENT_STREAMS`, `FD_H2_SETTINGS_INITIAL_WINDOW_SIZE`, `FD_H2_SETTINGS_MAX_FRAME_SIZE`, and `FD_H2_SETTINGS_MAX_HEADER_LIST_SIZE`.
- **Output**: The function does not return a value; it populates the provided buffer with the encoded SETTINGS frame.
- **Functions Called**:
    - [`fd_h2_frame_typlen`](<fd_h2_proto.h.md#fd_h2_frame_typlen>)
    - [`fd_h2_setting_encode`](<#fd_h2_setting_encode>)


---
### fd\_h2\_rx\_data<!-- {{#callable:fd_h2_rx_data}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_conn.c#L83>)

Processes a partial HTTP/2 DATA frame, handling flow control and invoking callbacks for data reception.
- **Inputs**:
    - ``conn``: A pointer to the `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - ``rbuf_rx``: A pointer to the `fd_h2_rbuf_t` structure representing the receive buffer.
    - ``rbuf_tx``: A pointer to the `fd_h2_rbuf_t` structure representing the transmit buffer.
    - ``cb``: A pointer to the `fd_h2_callbacks_t` structure containing callback functions for stream operations.
- **Logic and Control Flow**:
    - Check if the transmit buffer has enough space for two `WINDOW_UPDATE` frames; if not, return immediately.
    - Calculate the size of the data chunk to process based on the remaining frame size and available buffer size.
    - Determine the `fin_flag` based on the frame flags and buffer availability.
    - Query the stream using the callback function `stream_query`; if the stream is not open or closing, send a `RST_STREAM` frame and skip processing the frame.
    - Check if the chunk size exceeds the connection's receive window; if so, report a flow control error and return.
    - Decrease the connection's receive window by the chunk size.
    - Check if the chunk size exceeds the stream's receive window; if so, send a `RST_STREAM` frame and skip processing the frame.
    - Decrease the stream's receive window by the chunk size.
    - Invoke [`fd_h2_stream_rx_data`](<fd_h2_stream.h.md#fd_h2_stream_rx_data>) to process the received data; if the stream state becomes illegal, report a protocol error and return.
    - Peek into the receive buffer to get the data chunk and invoke the `data` callback function with the data chunk and `fin_flag`.
    - Update the remaining frame size and skip the processed data in the receive buffer.
    - If the connection's receive window is below the watermark, set the `WINDOW_UPDATE` flag in the connection's flags.
- **Output**: No direct output; modifies the state of the connection and buffers, and invokes callback functions for data processing.
- **Functions Called**:
    - [`fd_h2_rbuf_free_sz`](<fd_h2_rbuf.h.md#fd_h2_rbuf_free_sz>)
    - [`fd_h2_rbuf_used_sz`](<fd_h2_rbuf.h.md#fd_h2_rbuf_used_sz>)
    - [`fd_h2_tx_rst_stream`](<fd_h2_conn.h.md#fd_h2_tx_rst_stream>)
    - [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>)
    - [`fd_h2_stream_rx_data`](<fd_h2_stream.h.md#fd_h2_stream_rx_data>)
    - [`fd_h2_rbuf_peek_used`](<fd_h2_rbuf.h.md#fd_h2_rbuf_peek_used>)
    - [`fd_h2_rbuf_skip`](<fd_h2_rbuf.h.md#fd_h2_rbuf_skip>)


---
### fd\_h2\_rx\_headers<!-- {{#callable:fd_h2_rx_headers}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_conn.c#L147>)

Processes incoming HTTP/2 HEADERS frames, handling stream creation, priority, and header continuation.
- **Inputs**:
    - ``conn``: A pointer to the `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - ``rbuf_tx``: A pointer to the `fd_h2_rbuf_t` structure used for transmitting data.
    - ``payload``: A pointer to the payload data of the HEADERS frame.
    - ``payload_sz``: The size of the payload data.
    - ``cb``: A pointer to the `fd_h2_callbacks_t` structure containing callback functions.
    - ``frame_flags``: Flags associated with the HEADERS frame, indicating properties like priority and end of headers.
    - ``stream_id``: The identifier of the stream to which the HEADERS frame belongs.
- **Logic and Control Flow**:
    - Check if `stream_id` is zero; if so, report a protocol error and return 0.
    - Query the stream using `cb->stream_query`; if the stream does not exist, check if the stream ID is valid and if the maximum concurrent streams limit is reached.
    - If the stream does not exist and conditions are met, create a new stream using `cb->stream_create` and open it with [`fd_h2_stream_open`](<fd_h2_stream.h.md#fd_h2_stream_open>).
    - Set the connection's `rx_stream_id` to the current `stream_id`.
    - If the PRIORITY flag is set, adjust the payload pointer and size accordingly.
    - If the END_HEADERS flag is not set, mark the connection for continuation with `FD_H2_CONN_FLAGS_CONTINUATION`.
    - Process the headers for the stream using [`fd_h2_stream_rx_headers`](<fd_h2_stream.h.md#fd_h2_stream_rx_headers>) and check for illegal stream state.
    - Invoke the `headers` callback with the connection, stream, payload, payload size, and frame flags.
    - Return 1 to indicate successful processing.
- **Output**: Returns 1 on successful processing of the HEADERS frame, or 0 if a protocol error occurs.
- **Functions Called**:
    - [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>)
    - [`fd_h2_tx_rst_stream`](<fd_h2_conn.h.md#fd_h2_tx_rst_stream>)
    - [`fd_h2_stream_open`](<fd_h2_stream.h.md#fd_h2_stream_open>)
    - [`fd_h2_stream_rx_headers`](<fd_h2_stream.h.md#fd_h2_stream_rx_headers>)


---
### fd\_h2\_rx\_priority<!-- {{#callable:fd_h2_rx_priority}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_conn.c#L211>)

Validates the size of the payload and the stream ID for an HTTP/2 PRIORITY frame.
- **Inputs**:
    - ``conn``: A pointer to an `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - ``payload_sz``: An unsigned long integer representing the size of the payload.
    - ``stream_id``: An unsigned integer representing the stream identifier.
- **Logic and Control Flow**:
    - Check if `payload_sz` is not equal to 5; if true, call [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>) with `FD_H2_ERR_FRAME_SIZE` and return 0.
    - Check if `stream_id` is zero; if true, call [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>) with `FD_H2_ERR_PROTOCOL` and return 0.
    - If both checks pass, return 1.
- **Output**: Returns 1 if the payload size is 5 and the stream ID is non-zero; otherwise, returns 0 after logging an error.
- **Functions Called**:
    - [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>)


---
### fd\_h2\_rx\_continuation<!-- {{#callable:fd_h2_rx_continuation}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_conn.c#L226>)

Processes HTTP/2 CONTINUATION frames by validating stream ID and flags, updating stream state, and invoking header callbacks.
- **Inputs**:
    - ``conn``: A pointer to the `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - ``rbuf_tx``: A pointer to the `fd_h2_rbuf_t` structure used for transmitting data.
    - ``payload``: A pointer to the payload data of the CONTINUATION frame.
    - ``payload_sz``: The size of the payload data.
    - ``cb``: A pointer to the `fd_h2_callbacks_t` structure containing callback functions.
    - ``frame_flags``: Flags associated with the CONTINUATION frame.
    - ``stream_id``: The identifier of the stream to which the CONTINUATION frame belongs.
- **Logic and Control Flow**:
    - Check if the `stream_id` matches `conn->rx_stream_id`, if the connection is in a continuation state, and if `stream_id` is non-zero; if not, call [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>) with `FD_H2_ERR_PROTOCOL` and return 0.
    - If the `FD_H2_FLAG_END_HEADERS` flag is set in `frame_flags`, clear the continuation flag in `conn->flags`.
    - Query the stream using `cb->stream_query` with `conn` and `stream_id`; if the stream is not found, call [`fd_h2_tx_rst_stream`](<fd_h2_conn.h.md#fd_h2_tx_rst_stream>) with `FD_H2_ERR_INTERNAL` and return 1.
    - Call [`fd_h2_stream_rx_headers`](<fd_h2_stream.h.md#fd_h2_stream_rx_headers>) to process the headers for the stream; if the stream state is illegal, call [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>) with `FD_H2_ERR_PROTOCOL` and return 0.
    - Invoke the `headers` callback from `cb` with the connection, stream, payload, payload size, and frame flags.
    - Return 1 to indicate successful processing.
- **Output**: Returns 1 on successful processing of the CONTINUATION frame, or 0 if a protocol error occurs.
- **Functions Called**:
    - [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>)
    - [`fd_h2_tx_rst_stream`](<fd_h2_conn.h.md#fd_h2_tx_rst_stream>)
    - [`fd_h2_stream_rx_headers`](<fd_h2_stream.h.md#fd_h2_stream_rx_headers>)


---
### fd\_h2\_rx\_rst\_stream<!-- {{#callable:fd_h2_rx_rst_stream}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_conn.c#L263>)

Handles the reception of an HTTP/2 RST_STREAM frame and processes it according to the HTTP/2 protocol.
- **Inputs**:
    - ``conn``: A pointer to the `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - ``payload``: A pointer to the payload data of the RST_STREAM frame.
    - ``payload_sz``: The size of the payload data, expected to be 4 bytes.
    - ``cb``: A pointer to the `fd_h2_callbacks_t` structure containing callback functions for stream operations.
    - ``stream_id``: The identifier of the stream to reset.
- **Logic and Control Flow**:
    - Check if `payload_sz` is not equal to 4; if true, call [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>) with `FD_H2_ERR_FRAME_SIZE` and return 0.
    - Check if `stream_id` is zero; if true, call [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>) with `FD_H2_ERR_PROTOCOL` and return 0.
    - Check if `stream_id` is greater than or equal to the maximum of `conn->rx_stream_next` and `conn->tx_stream_next`; if true, call [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>) with `FD_H2_ERR_PROTOCOL` and return 0.
    - Query the stream using `cb->stream_query`; if the stream exists, proceed to reset it.
    - Convert the error code from network byte order to host byte order using [`fd_uint_bswap`](<../../util/bits/fd_bits.h.md#fd_uint_bswap>).
    - Call [`fd_h2_stream_reset`](<fd_h2_stream.h.md#fd_h2_stream_reset>) to reset the stream.
    - Invoke the `cb->rst_stream` callback with the connection, stream, error code, and a flag indicating the stream is remote.
    - Return 1 to indicate successful processing.
- **Output**: Returns 1 if the RST_STREAM frame is processed successfully, otherwise returns 0 if an error occurs.
- **Functions Called**:
    - [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>)
    - [`fd_uint_bswap`](<../../util/bits/fd_bits.h.md#fd_uint_bswap>)
    - [`fd_h2_stream_reset`](<fd_h2_stream.h.md#fd_h2_stream_reset>)


---
### fd\_h2\_rx\_settings<!-- {{#callable:fd_h2_rx_settings}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_conn.c#L291>)

Processes HTTP/2 SETTINGS frames, updating connection settings and handling protocol errors.
- **Inputs**:
    - ``conn``: A pointer to the `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - ``rbuf_tx``: A pointer to the `fd_h2_rbuf_t` structure used for transmitting data.
    - ``payload``: A constant pointer to the payload data of the SETTINGS frame.
    - ``payload_sz``: The size of the payload data in bytes.
    - ``cb``: A constant pointer to the `fd_h2_callbacks_t` structure containing callback functions.
    - ``frame_flags``: Flags associated with the SETTINGS frame, such as `FD_H2_FLAG_ACK`.
    - ``stream_id``: The stream identifier, which must be zero for SETTINGS frames.
- **Logic and Control Flow**:
    - Check if `stream_id` is non-zero and return a protocol error if true.
    - Verify if the connection is in the server initial state and return if true.
    - Handle the ACK flag: check payload size, update settings transmission state, and call `conn_established` if necessary.
    - Validate payload size is a multiple of 6, returning a frame size error if not.
    - Iterate over the payload to process each setting, updating connection settings and checking for protocol errors.
    - Prepare and send a SETTINGS ACK frame if there is enough space in the transmit buffer.
    - Clear the WAIT_SETTINGS_0 flag and call `conn_established` if the connection is not handshaking.
- **Output**: Returns 1 on successful processing of the SETTINGS frame, or 0 if a protocol error occurs.
- **Functions Called**:
    - [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>)
    - [`fd_ushort_bswap`](<../../util/bits/fd_bits.h.md#fd_ushort_bswap>)
    - [`fd_uint_bswap`](<../../util/bits/fd_bits.h.md#fd_uint_bswap>)
    - [`fd_h2_frame_typlen`](<fd_h2_proto.h.md#fd_h2_frame_typlen>)
    - [`fd_h2_rbuf_free_sz`](<fd_h2_rbuf.h.md#fd_h2_rbuf_free_sz>)
    - [`fd_h2_rbuf_push`](<fd_h2_rbuf.h.md#fd_h2_rbuf_push>)


---
### fd\_h2\_rx\_push\_promise<!-- {{#callable:fd_h2_rx_push_promise}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_conn.c#L392>)

Handles a received PUSH_PROMISE frame by reporting a protocol error.
- **Inputs**:
    - ``conn``: A pointer to an `fd_h2_conn_t` structure representing the HTTP/2 connection.
- **Logic and Control Flow**:
    - Calls [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>) with the `FD_H2_ERR_PROTOCOL` error code to indicate a protocol error.
    - Returns 0 to indicate the function has completed its operation.
- **Output**: Returns 0, indicating the function has completed its operation.
- **Functions Called**:
    - [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>)


---
### fd\_h2\_rx\_ping<!-- {{#callable:fd_h2_rx_ping}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_conn.c#L398>)

Processes an HTTP/2 PING frame, handling both PING and PONG scenarios, and manages connection errors.
- **Inputs**:
    - ``conn``: A pointer to the `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - ``rbuf_tx``: A pointer to the `fd_h2_rbuf_t` structure used for transmitting data.
    - ``payload``: A constant pointer to an unsigned character array containing the PING frame payload.
    - ``payload_sz``: An unsigned long representing the size of the payload, expected to be 8 bytes.
    - ``cb``: A constant pointer to the `fd_h2_callbacks_t` structure containing callback functions.
    - ``frame_flags``: An unsigned integer representing the flags associated with the PING frame.
    - ``stream_id``: An unsigned integer representing the stream identifier, expected to be zero for PING frames.
- **Logic and Control Flow**:
    - Check if `payload_sz` is not equal to 8; if true, call [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>) with `FD_H2_ERR_FRAME_SIZE` and return 0.
    - Check if `stream_id` is not zero; if true, call [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>) with `FD_H2_ERR_PROTOCOL` and return 0.
    - If `frame_flags` has `FD_H2_FLAG_ACK`, check if `conn->ping_tx` is zero; if true, return 1. Otherwise, call `cb->ping_ack`, decrement `conn->ping_tx`, and return 1.
    - If `frame_flags` does not have `FD_H2_FLAG_ACK`, create a `fd_h2_ping_t` structure for a PONG response, check if there is enough space in `rbuf_tx`; if not, call [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>) with `FD_H2_ERR_INTERNAL` and return 0.
    - Push the PONG response to `rbuf_tx` and return 1.
- **Output**: Returns 1 on successful processing of the PING frame, or 0 if a connection error occurs.
- **Functions Called**:
    - [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>)
    - [`fd_h2_frame_typlen`](<fd_h2_proto.h.md#fd_h2_frame_typlen>)
    - [`fd_h2_rbuf_free_sz`](<fd_h2_rbuf.h.md#fd_h2_rbuf_free_sz>)
    - [`fd_h2_rbuf_push`](<fd_h2_rbuf.h.md#fd_h2_rbuf_push>)


---
### fd\_h2\_tx\_ping<!-- {{#callable:fd_h2_tx_ping}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_conn.c#L448>)

Transmits a PING frame over an HTTP/2 connection if conditions allow.
- **Inputs**:
    - ``conn``: A pointer to an `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - ``rbuf_tx``: A pointer to an `fd_h2_rbuf_t` structure representing the transmission buffer.
- **Logic and Control Flow**:
    - Retrieve the current number of transmitted PING frames from `conn->ping_tx`.
    - Check if the transmission buffer `rbuf_tx` has enough space for a PING frame and if the number of transmitted PING frames is less than `UCHAR_MAX`.
    - If either condition is not met, return 0 to indicate the operation is blocked.
    - Create a PING frame with a header and payload initialized to zero.
    - Push the PING frame into the transmission buffer `rbuf_tx`.
    - Increment the `ping_tx` counter in the `conn` structure.
    - Return 1 to indicate successful transmission of the PING frame.
- **Output**: Returns 1 if the PING frame is successfully transmitted, otherwise returns 0 if blocked.
- **Functions Called**:
    - [`fd_h2_rbuf_free_sz`](<fd_h2_rbuf.h.md#fd_h2_rbuf_free_sz>)
    - [`fd_h2_frame_typlen`](<fd_h2_proto.h.md#fd_h2_frame_typlen>)
    - [`fd_h2_rbuf_push`](<fd_h2_rbuf.h.md#fd_h2_rbuf_push>)


---
### fd\_h2\_rx\_goaway<!-- {{#callable:fd_h2_rx_goaway}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_conn.c#L470>)

Processes a GOAWAY frame in an HTTP/2 connection, setting the connection to a dead state and invoking a callback with the error code.
- **Inputs**:
    - ``conn``: A pointer to the `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - ``cb``: A pointer to the `fd_h2_callbacks_t` structure containing callback functions for connection events.
    - ``payload``: A pointer to the payload data of the GOAWAY frame.
    - ``payload_sz``: The size of the payload data.
    - ``stream_id``: The stream identifier, which must be zero for a GOAWAY frame.
- **Logic and Control Flow**:
    - Check if `stream_id` is non-zero; if true, call [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>) with `FD_H2_ERR_PROTOCOL` and return 0.
    - Check if `payload_sz` is less than 8; if true, call [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>) with `FD_H2_ERR_FRAME_SIZE` and return 0.
    - Extract the error code from the payload using [`fd_uint_bswap`](<../../util/bits/fd_bits.h.md#fd_uint_bswap>) and `FD_LOAD`.
    - Set the connection's flags to `FD_H2_CONN_FLAGS_DEAD`.
    - Invoke the `conn_final` callback with the connection, error code, and a peer indicator set to 1.
    - Return 1 to indicate successful processing.
- **Output**: Returns 1 on successful processing of the GOAWAY frame, or 0 if an error occurs.
- **Functions Called**:
    - [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>)
    - [`fd_uint_bswap`](<../../util/bits/fd_bits.h.md#fd_uint_bswap>)


---
### fd\_h2\_rx\_window\_update<!-- {{#callable:fd_h2_rx_window_update}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_conn.c#L493>)

Updates the receive window size for a connection or stream in an HTTP/2 context based on the provided payload.
- **Inputs**:
    - ``conn``: A pointer to the `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - ``rbuf_tx``: A pointer to the `fd_h2_rbuf_t` structure used for transmitting data.
    - ``cb``: A pointer to a constant `fd_h2_callbacks_t` structure containing callback functions.
    - ``payload``: A pointer to an unsigned character array containing the payload data.
    - ``payload_sz``: An unsigned long integer representing the size of the payload.
    - ``stream_id``: An unsigned integer representing the stream identifier.
- **Logic and Control Flow**:
    - Checks if `payload_sz` is not equal to 4; if true, calls [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>) with `FD_H2_ERR_FRAME_SIZE` and returns 0.
    - Swaps the byte order of the payload to get the `increment` value and masks it with `0x7fffffff`.
    - If `stream_id` is 0, performs a connection-level window update; otherwise, performs a stream-level window update.
    - For connection-level updates, checks if `increment` is zero or if adding `increment` to `conn->tx_wnd` overflows; if true, calls [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>) with appropriate error codes and returns 0.
    - For stream-level updates, checks if `stream_id` is invalid or if `increment` is zero; if true, calls [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>) or [`fd_h2_tx_rst_stream`](<fd_h2_conn.h.md#fd_h2_tx_rst_stream>) with appropriate error codes and returns 1.
    - Queries the stream using `cb->stream_query`; if the stream is not found, calls [`fd_h2_tx_rst_stream`](<fd_h2_conn.h.md#fd_h2_tx_rst_stream>) with `FD_H2_ERR_STREAM_CLOSED` and returns 1.
    - Checks for overflow when adding `increment` to `stream->tx_wnd`; if true, calls [`fd_h2_stream_error`](<fd_h2_stream.h.md#fd_h2_stream_error>) and `cb->rst_stream` with `FD_H2_ERR_FLOW_CONTROL` and returns 1.
    - Updates the window size and calls the appropriate callback function for window updates.
- **Output**: Returns 1 on success, or 0/1 on error depending on the error type and context.
- **Functions Called**:
    - [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>)
    - [`fd_uint_bswap`](<../../util/bits/fd_bits.h.md#fd_uint_bswap>)
    - [`fd_h2_tx_rst_stream`](<fd_h2_conn.h.md#fd_h2_tx_rst_stream>)
    - [`fd_h2_stream_error`](<fd_h2_stream.h.md#fd_h2_stream_error>)


---
### fd\_h2\_rx\_frame<!-- {{#callable:fd_h2_rx_frame}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_conn.c#L559>)

Processes a complete HTTP/2 frame based on its type and delegates handling to specific functions.
- **Inputs**:
    - ``conn``: A pointer to the `fd_h2_conn_t` structure representing the connection context.
    - ``rbuf_tx``: A pointer to the `fd_h2_rbuf_t` structure used for transmitting data.
    - ``payload``: A pointer to the payload data of the frame.
    - ``payload_sz``: The size of the payload data.
    - ``cb``: A pointer to the `fd_h2_callbacks_t` structure containing callback functions for various events.
    - ``frame_type``: An unsigned integer representing the type of the frame.
    - ``frame_flags``: An unsigned integer representing the flags associated with the frame.
    - ``stream_id``: An unsigned integer representing the stream identifier for the frame.
- **Logic and Control Flow**:
    - Checks the `frame_type` to determine the specific handling function to call.
    - For `FD_H2_FRAME_TYPE_HEADERS`, calls [`fd_h2_rx_headers`](<#fd_h2_rx_headers>).
    - For `FD_H2_FRAME_TYPE_PRIORITY`, calls [`fd_h2_rx_priority`](<#fd_h2_rx_priority>).
    - For `FD_H2_FRAME_TYPE_RST_STREAM`, calls [`fd_h2_rx_rst_stream`](<#fd_h2_rx_rst_stream>).
    - For `FD_H2_FRAME_TYPE_SETTINGS`, calls [`fd_h2_rx_settings`](<#fd_h2_rx_settings>).
    - For `FD_H2_FRAME_TYPE_PUSH_PROMISE`, calls [`fd_h2_rx_push_promise`](<#fd_h2_rx_push_promise>).
    - For `FD_H2_FRAME_TYPE_CONTINUATION`, calls [`fd_h2_rx_continuation`](<#fd_h2_rx_continuation>).
    - For `FD_H2_FRAME_TYPE_PING`, calls [`fd_h2_rx_ping`](<#fd_h2_rx_ping>).
    - For `FD_H2_FRAME_TYPE_GOAWAY`, calls [`fd_h2_rx_goaway`](<#fd_h2_rx_goaway>).
    - For `FD_H2_FRAME_TYPE_WINDOW_UPDATE`, calls [`fd_h2_rx_window_update`](<#fd_h2_rx_window_update>).
    - Returns 1 for unrecognized frame types.
- **Output**: Returns 1 on successful processing of the frame, or 0 if a connection error occurs.
- **Functions Called**:
    - [`fd_h2_rx_headers`](<#fd_h2_rx_headers>)
    - [`fd_h2_rx_priority`](<#fd_h2_rx_priority>)
    - [`fd_h2_rx_rst_stream`](<#fd_h2_rx_rst_stream>)
    - [`fd_h2_rx_settings`](<#fd_h2_rx_settings>)
    - [`fd_h2_rx_push_promise`](<#fd_h2_rx_push_promise>)
    - [`fd_h2_rx_continuation`](<#fd_h2_rx_continuation>)
    - [`fd_h2_rx_ping`](<#fd_h2_rx_ping>)
    - [`fd_h2_rx_goaway`](<#fd_h2_rx_goaway>)
    - [`fd_h2_rx_window_update`](<#fd_h2_rx_window_update>)


---
### fd\_h2\_rx1<!-- {{#callable:fd_h2_rx1}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_conn.c#L594>)

Processes a single HTTP/2 frame from the receive buffer, handling different frame types and managing connection state.
- **Inputs**:
    - ``conn``: A pointer to the `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - ``rbuf_rx``: A pointer to the `fd_h2_rbuf_t` structure representing the receive buffer.
    - ``rbuf_tx``: A pointer to the `fd_h2_rbuf_t` structure representing the transmit buffer.
    - ``scratch``: A pointer to a scratch buffer used for temporary storage during frame processing.
    - ``scratch_sz``: The size of the scratch buffer.
    - ``cb``: A pointer to the `fd_h2_callbacks_t` structure containing callback functions for handling various events.
- **Logic and Control Flow**:
    - If `conn->rx_frame_rem` is non-zero, call [`fd_h2_rx_data`](<#fd_h2_rx_data>) to process a DATA frame and return.
    - If `conn->rx_pad_rem` is non-zero, skip the padding bytes in `rbuf_rx` and update `conn->rx_pad_rem`, then return.
    - Check if there is enough data in `rbuf_rx` to read a frame header; if not, set `conn->rx_suppress` and return.
    - Peek the frame header from `rbuf_rx` and determine the frame type and size.
    - If the frame size exceeds `conn->self_settings.max_frame_size`, call [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>) with `FD_H2_ERR_FRAME_SIZE` and return.
    - If a continuation frame is expected but the current frame is not a continuation, call [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>) with `FD_H2_ERR_PROTOCOL` and return.
    - If the frame is padded, read the padding size and adjust `rem_sz`; if padding size is invalid, call [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>) with `FD_H2_ERR_PROTOCOL` and return.
    - If the frame is a DATA frame, set `conn->rx_frame_rem`, `conn->rx_frame_flags`, `conn->rx_stream_id`, and `conn->rx_pad_rem`, then call [`fd_h2_rx_data`](<#fd_h2_rx_data>) and return.
    - Calculate the total frame size including the header; if there is not enough data in `rbuf_rx`, set `conn->rx_suppress` and return.
    - Check if the scratch buffer is large enough for the frame payload; if not, log a warning and call [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>) with `FD_H2_ERR_INTERNAL` or `FD_H2_ERR_FRAME_SIZE` as appropriate, then return.
    - Pop the frame payload into the scratch buffer and call [`fd_h2_rx_frame`](<#fd_h2_rx_frame>) to process the frame.
    - Skip the padding bytes in `rbuf_rx`.
- **Output**: No direct output; modifies the state of the connection and buffers, and may invoke callbacks or log errors.
- **Functions Called**:
    - [`fd_h2_rx_data`](<#fd_h2_rx_data>)
    - [`fd_h2_rbuf_used_sz`](<fd_h2_rbuf.h.md#fd_h2_rbuf_used_sz>)
    - [`fd_h2_rbuf_skip`](<fd_h2_rbuf.h.md#fd_h2_rbuf_skip>)
    - [`fd_h2_rbuf_pop_copy`](<fd_h2_rbuf.h.md#fd_h2_rbuf_pop_copy>)
    - [`fd_h2_frame_type`](<fd_h2_proto.h.md#fd_h2_frame_type>)
    - [`fd_h2_frame_length`](<fd_h2_proto.h.md#fd_h2_frame_length>)
    - [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>)
    - [`fd_h2_frame_stream_id`](<fd_h2_proto.h.md#fd_h2_frame_stream_id>)
    - [`fd_h2_rbuf_pop`](<fd_h2_rbuf.h.md#fd_h2_rbuf_pop>)
    - [`fd_h2_rx_frame`](<#fd_h2_rx_frame>)


---
### fd\_h2\_rx<!-- {{#callable:fd_h2_rx}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_conn.c#L699>)

Processes incoming HTTP/2 frames for a connection, handling errors and frame-specific logic.
- **Inputs**:
    - ``conn``: A pointer to an `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - ``rbuf_rx``: A pointer to an `fd_h2_rbuf_t` structure representing the receive buffer.
    - ``rbuf_tx``: A pointer to an `fd_h2_rbuf_t` structure representing the transmit buffer.
    - ``scratch``: A pointer to a scratch buffer used for temporary storage during processing.
    - ``scratch_sz``: The size of the scratch buffer.
    - ``cb``: A pointer to an `fd_h2_callbacks_t` structure containing callback functions for handling various events.
- **Logic and Control Flow**:
    - Checks if the connection is dead by examining the `conn->flags` and returns immediately if true.
    - Checks if there is new data in the receive buffer `rbuf_rx` and returns if none is available.
    - Implements a Slowloris defense by checking if the receive buffer's high offset is less than `conn->rx_suppress` and returns if true.
    - Enters a loop to process frames using [`fd_h2_rx1`](<#fd_h2_rx1>) until no more data is available, no progress is made, or the connection is marked as dead or requires sending a GOAWAY frame.
    - Within the loop, captures the current low offset of `rbuf_rx`, calls [`fd_h2_rx1`](<#fd_h2_rx1>) to process a frame, and checks if the low offset has changed to determine if progress was made.
- **Output**: No output is returned; the function processes frames and updates the connection state and buffers as needed.
- **Functions Called**:
    - [`fd_h2_rbuf_used_sz`](<fd_h2_rbuf.h.md#fd_h2_rbuf_used_sz>)
    - [`fd_h2_rx1`](<#fd_h2_rx1>)


---
### fd\_h2\_tx\_control<!-- {{#callable:fd_h2_tx_control}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_conn.c#L736>)

Manages the transmission control logic for an HTTP/2 connection based on the connection's state flags.
- **Inputs**:
    - ``conn``: A pointer to an `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - ``rbuf_tx``: A pointer to an `fd_h2_rbuf_t` structure used for the transmission buffer.
    - ``cb``: A pointer to a constant `fd_h2_callbacks_t` structure containing callback functions for connection events.
- **Logic and Control Flow**:
    - Checks if the free size of `rbuf_tx` is less than 128; if so, returns immediately.
    - Uses `fd_uint_find_lsb` to determine the least significant bit set in the connection's flags combined with `0x10000u`.
    - If the flag `FD_H2_CONN_FLAGS_LG_CLIENT_INITIAL` is set, pushes the client preface to `rbuf_tx` and falls through to the next case.
    - If the flag `FD_H2_CONN_FLAGS_LG_SERVER_INITIAL` is set, generates and pushes the connection's settings to `rbuf_tx`, increments `setting_tx`, and updates the connection's flags to wait for settings acknowledgment.
    - If the flag `FD_H2_CONN_FLAGS_LG_SEND_GOAWAY` is set, constructs a GOAWAY frame, sets the connection's flags to dead, pushes the frame to `rbuf_tx`, and calls the `conn_final` callback with the connection error.
    - If the flag `FD_H2_CONN_FLAGS_LG_WINDOW_UPDATE` is set, calculates the window increment, checks for overflow, constructs a WINDOW_UPDATE frame, pushes it to `rbuf_tx`, resets the receive window, and clears the window update flag.
    - If none of the specific flags are set, the function does nothing and exits.
- **Output**: No return value; the function modifies the state of the connection and the transmission buffer.
- **Functions Called**:
    - [`fd_h2_rbuf_free_sz`](<fd_h2_rbuf.h.md#fd_h2_rbuf_free_sz>)
    - [`fd_h2_rbuf_push`](<fd_h2_rbuf.h.md#fd_h2_rbuf_push>)
    - [`fd_h2_gen_settings`](<#fd_h2_gen_settings>)
    - [`fd_h2_frame_typlen`](<fd_h2_proto.h.md#fd_h2_frame_typlen>)
    - [`fd_uint_bswap`](<../../util/bits/fd_bits.h.md#fd_uint_bswap>)
    - [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)