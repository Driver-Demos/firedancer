<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for preparing, committing, and executing socket send and receive operations using ring buffers.

# Purpose
The code is a C header file that provides functionality for handling socket communication using a ring buffer. It defines several inline functions to prepare, commit, and execute message reception and transmission over sockets. The functions [`fd_h2_rbuf_prepare_recvmsg`](<#fd_h2_rbuf_prepare_recvmsg>) and [`fd_h2_rbuf_prepare_sendmsg`](<#fd_h2_rbuf_prepare_sendmsg>) set up the `iovec` structures for receiving and sending messages, respectively. These functions calculate the available space or used space in the ring buffer and configure the `iovec` structures accordingly. The [`fd_h2_rbuf_commit_recvmsg`](<#fd_h2_rbuf_commit_recvmsg>) and [`fd_h2_rbuf_commit_sendmsg`](<#fd_h2_rbuf_commit_sendmsg>) functions update the buffer pointers after a message is received or sent, ensuring the ring buffer's state is correctly maintained.

The file includes conditional compilation directives to ensure that the socket-related functions are only compiled if the `FD_H2_HAS_SOCKETS` macro is defined. This allows the code to be used in environments where socket functionality is optional. The header file also includes necessary system headers like `<errno.h>` and `<sys/socket.h>`, which are required for socket operations. The functions [`fd_h2_rbuf_recvmsg`](<#fd_h2_rbuf_recvmsg>) and [`fd_h2_rbuf_sendmsg`](<#fd_h2_rbuf_sendmsg>) are responsible for performing the actual message reception and transmission using the `recvmsg` and `sendmsg` system calls, handling errors, and updating the ring buffer state. This header file is intended to be included in other C source files that require efficient socket communication using a ring buffer mechanism.
# Imports and Dependencies

---
- `fd_h2_rbuf.h`
- `errno.h`
- `sys/socket.h`


# Functions

---
### fd\_h2\_rbuf\_prepare\_recvmsg<!-- {{#callable:fd_h2_rbuf_prepare_recvmsg}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_rbuf_sock.h#L11>)

Prepares a receive message by setting up the `iovec` structures for available buffer space in a ring buffer.
- **Inputs**:
    - `rbuf`: A pointer to an `fd_h2_rbuf_t` structure representing the ring buffer.
    - `iov`: An array of two `struct iovec` elements to be filled with buffer pointers and lengths.
- **Logic and Control Flow**:
    - Retrieve buffer pointers `buf0`, `buf1`, `lo`, and `hi` from `rbuf`.
    - Calculate the free size in the buffer using [`fd_h2_rbuf_free_sz`](<fd_h2_rbuf.h.md#fd_h2_rbuf_free_sz>).
    - If there is no free space (`free_sz` is zero), return 0.
    - If `lo` is less than or equal to `hi`, set `iov[0]` to point to `hi` with a length of the minimum of the space from `hi` to `buf1` and `free_sz`.
    - Subtract the length of `iov[0]` from `free_sz` and set `iov[1]` to point to `buf0` with a length of the minimum of the space from `buf0` to `lo` and `free_sz`.
    - Return 2, indicating two `iovec` structures are used.
    - If `lo` is greater than `hi`, set `iov[0]` to point to `hi` with a length of `free_sz`, and set `iov[1]` to have a base of `NULL` and a length of 0.
    - Return 1, indicating only one `iovec` structure is used.
- **Output**: Returns the number of `iovec` structures used, either 1 or 2.
- **Functions Called**:
    - [`fd_h2_rbuf_free_sz`](<fd_h2_rbuf.h.md#fd_h2_rbuf_free_sz>)


---
### fd\_h2\_rbuf\_commit\_recvmsg<!-- {{#callable:fd_h2_rbuf_commit_recvmsg}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_rbuf_sock.h#L41>)

Updates the high watermark of a ring buffer after receiving a message.
- **Inputs**:
    - `rbuf`: A pointer to the `fd_h2_rbuf_t` structure representing the ring buffer.
    - `iovec`: An array of two `struct iovec` elements representing the buffer segments used in the message reception.
    - `sz`: The size of the data received, in bytes.
- **Logic and Control Flow**:
    - Initialize `buf0` and `buf1` to point to the start and end of the ring buffer, respectively.
    - Copy the first and second elements of `iovec` into `iov0` and `iov1`.
    - Increment the `hi_off` field of `rbuf` by `sz` to update the offset of the high watermark.
    - Check if `sz` is greater than the length of `iov0`.
    - If true, set `rbuf->hi` to the base of `iov1` plus the excess size beyond `iov0`'s length.
    - If false, set `rbuf->hi` to the base of `iov0` plus `sz`.
    - If `rbuf->hi` equals `buf1`, wrap around by setting `rbuf->hi` to `buf0`.
- **Output**: None (the function modifies the `rbuf` structure in place).


---
### fd\_h2\_rbuf\_recvmsg<!-- {{#callable:fd_h2_rbuf_recvmsg}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_rbuf_sock.h#L58>)

Receives a message from a socket and updates the receive buffer state.
- **Inputs**:
    - `rbuf`: A pointer to the `fd_h2_rbuf_t` structure, which represents the receive buffer.
    - `sock`: An integer representing the socket file descriptor from which to receive the message.
    - `flags`: An integer representing the flags to pass to the `recvmsg` function.
- **Logic and Control Flow**:
    - Prepare the `iovec` structures by calling [`fd_h2_rbuf_prepare_recvmsg`](<#fd_h2_rbuf_prepare_recvmsg>) with the receive buffer `rbuf` and the `iovec` array `iov`.
    - Check if `iov_cnt` is zero, indicating no space is available in the buffer, and return 0 if true.
    - Initialize a `msghdr` structure `msg` with the `iovec` array and its count.
    - Call `recvmsg` with the socket `sock`, the `msghdr` structure `msg`, and the `flags`.
    - If `recvmsg` returns a negative value, check if `errno` is `EAGAIN` and return 0 if true, otherwise return the error number.
    - If `recvmsg` returns zero, indicating the connection is closed, return `EPIPE`.
    - Commit the received message to the buffer by calling [`fd_h2_rbuf_commit_recvmsg`](<#fd_h2_rbuf_commit_recvmsg>) with the buffer `rbuf`, the `iovec` array, and the size `sz`.
    - Return 0 to indicate successful reception and buffer update.
- **Output**: Returns 0 on success, `EPIPE` if the connection is closed, or an error number if `recvmsg` fails with an error other than `EAGAIN`.
- **Functions Called**:
    - [`fd_h2_rbuf_prepare_recvmsg`](<#fd_h2_rbuf_prepare_recvmsg>)
    - [`fd_h2_rbuf_commit_recvmsg`](<#fd_h2_rbuf_commit_recvmsg>)


---
### fd\_h2\_rbuf\_prepare\_sendmsg<!-- {{#callable:fd_h2_rbuf_prepare_sendmsg}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_rbuf_sock.h#L82>)

Prepares a ring buffer for sending a message by setting up the `iovec` structures with the appropriate data segments.
- **Inputs**:
    - `rbuf`: A pointer to the `fd_h2_rbuf_t` structure representing the ring buffer.
    - `iov`: An array of two `iovec` structures to be filled with data segments from the ring buffer.
- **Logic and Control Flow**:
    - Retrieve pointers to the buffer segments `buf0`, `buf1`, `lo`, and `hi` from the `rbuf` structure.
    - Calculate the used size of the buffer using [`fd_h2_rbuf_used_sz`](<fd_h2_rbuf.h.md#fd_h2_rbuf_used_sz>) function.
    - If the used size is zero, return 0.
    - If `hi` is less than or equal to `lo`, fill `iov[0]` with data from `lo` to `buf1` and `iov[1]` with data from `buf0` to `hi`, then return 2.
    - If `hi` is greater than `lo`, fill `iov[0]` with data from `lo` to `hi`, set `iov[1]` to zero length, and return 1.
- **Output**: Returns the number of `iovec` structures filled, either 1 or 2, depending on the buffer state.
- **Functions Called**:
    - [`fd_h2_rbuf_used_sz`](<fd_h2_rbuf.h.md#fd_h2_rbuf_used_sz>)


---
### fd\_h2\_rbuf\_commit\_sendmsg<!-- {{#callable:fd_h2_rbuf_commit_sendmsg}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_rbuf_sock.h#L112>)

Updates the read buffer's low offset and pointer after sending a message.
- **Inputs**:
    - `rbuf`: A pointer to the `fd_h2_rbuf_t` structure representing the read buffer.
    - `iovec`: An array of two `struct iovec` elements representing the data segments involved in the send operation.
    - `sz`: The size in bytes of the data that was sent.
- **Logic and Control Flow**:
    - Retrieve pointers `buf0` and `buf1` from the `rbuf` structure.
    - Extract the first and second `iovec` elements into `iov0` and `iov1`.
    - Increment the `lo_off` field of `rbuf` by `sz`.
    - If `sz` is greater than `iov0.iov_len`, set `rbuf->lo` to the base of `iov1` plus the difference between `sz` and `iov0.iov_len`.
    - Otherwise, set `rbuf->lo` to the base of `iov0` plus `sz`.
    - If `rbuf->lo` equals `buf1`, reset `rbuf->lo` to `buf0`.
- **Output**: No return value; the function modifies the `rbuf` structure in place.


---
### fd\_h2\_rbuf\_sendmsg<!-- {{#callable:fd_h2_rbuf_sendmsg}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_rbuf_sock.h#L129>)

Sends data from a ring buffer to a socket using the `sendmsg` system call.
- **Inputs**:
    - `rbuf`: A pointer to a `fd_h2_rbuf_t` structure representing the ring buffer containing the data to send.
    - `sock`: An integer representing the socket file descriptor to which the data will be sent.
    - `flags`: An integer representing flags that modify the behavior of the `sendmsg` system call.
- **Logic and Control Flow**:
    - Prepare the `iovec` array by calling [`fd_h2_rbuf_prepare_sendmsg`](<#fd_h2_rbuf_prepare_sendmsg>) with `rbuf` and `iov` as arguments.
    - Check if `iov_cnt` is zero, indicating no data to send, and return 0 if true.
    - Initialize a `msghdr` structure with the `iovec` array and its count.
    - Call `sendmsg` with the socket, `msghdr`, and flags, storing the result in `sz`.
    - If `sz` is negative, return the error number `errno`.
    - Commit the sent data by calling [`fd_h2_rbuf_commit_sendmsg`](<#fd_h2_rbuf_commit_sendmsg>) with `rbuf`, `iov`, and the number of bytes sent `sz`.
    - Return 0 to indicate success.
- **Output**: Returns 0 on success or an error number if `sendmsg` fails.
- **Functions Called**:
    - [`fd_h2_rbuf_prepare_sendmsg`](<#fd_h2_rbuf_prepare_sendmsg>)
    - [`fd_h2_rbuf_commit_sendmsg`](<#fd_h2_rbuf_commit_sendmsg>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)