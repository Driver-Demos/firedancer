<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Fuzz testing for `fd_h2` connection-level APIs to find crashes, spinloops, and other bugs.

# Purpose
The code in `fuzz_h2.c` is a fuzz testing suite for the `fd_h2` connection-level APIs. It is designed to identify potential issues such as crashes, spin loops, and other bugs in the HTTP/2 connection handling logic. The code initializes a testing context with structures for connection, stream, and transmission operations, and it uses a set of callback functions to simulate various HTTP/2 events and states. These callbacks handle stream creation, querying, connection establishment, finalization, headers processing, data reception, stream resets, and window updates.

The [`LLVMFuzzerTestOneInput`](<#llvmfuzzertestoneinput>) function is the main entry point for the fuzzing process. It initializes the testing context, sets up random number generation, and simulates HTTP/2 client or server connections based on a seed value. The function processes input data in chunks, simulating the reception and transmission of HTTP/2 frames. It uses the `fd_h2` API to manage the connection state and invoke the appropriate callbacks. The function checks for conditions that indicate a successful test, such as ensuring that all streams are closed and the connection is finalized correctly. The code is intended to be used with a fuzzing framework like LLVM's libFuzzer to automate the testing process and uncover edge cases in the HTTP/2 implementation.
# Imports and Dependencies

---
- `assert.h`
- `stdlib.h`
- `fd_h2.h`
- `../../util/fd_util.h`


# Global Variables

---
### fuzz\_h2\_ctx\_t
- **Type**: `static FD_TL fuzz_h2_ctx_t`
- **Description**: Represents a global context structure for handling HTTP/2 connections and streams in the fuzzing process. It contains buffers, connection, stream, and transmission operation structures necessary for managing HTTP/2 communication.
- **Use**: Used to maintain and manipulate the state of HTTP/2 connections and streams during fuzz testing.


---
### fd\_rng\_t
- **Type**: ``fd_rng_t``
- **Description**: Represents a random number generator instance used in the fuzzing process. It is defined as a static array of one element, `g_rng`, which is initialized and used to generate random numbers during the execution of the fuzzing tests.
- **Use**: Used to initialize and manage a random number generator for generating random values in the fuzzing tests.


---
### g\_stream\_cnt
- **Type**: ``long``
- **Description**: Counts the number of active streams in the HTTP/2 connection context. It is used to detect unbalanced callbacks, which can indicate a stream leak.
- **Use**: Increments when a new stream is created and decrements when a stream is closed or reset.


---
### g\_conn\_final\_cnt
- **Type**: ``long``
- **Description**: Counts the number of times a connection has reached its final state in the HTTP/2 fuzz testing context. It is incremented in the `cb_conn_final` callback function when a connection is finalized.
- **Use**: Tracks the number of finalized connections to ensure proper connection lifecycle management during fuzz testing.


---
### fuzz\_h2\_cb
- **Type**: ``fd_h2_callbacks_t``
- **Description**: Defines a set of callback functions for handling HTTP/2 connection and stream events. These callbacks include functions for stream creation, querying, connection establishment, finalization, handling headers and data, resetting streams, and updating window sizes.
- **Use**: Used to provide specific implementations for handling various HTTP/2 protocol events during fuzz testing.


# Data Structures

---
### fuzz\_h2\_ctx
- **Type**: ``struct``
- **Members**:
    - `rbuf_tx`: An array of one `fd_h2_rbuf_t` structure for transmit buffer management.
    - `conn`: An array of one `fd_h2_conn_t` structure for managing HTTP/2 connection state.
    - `stream`: An array of one `fd_h2_stream_t` structure for managing HTTP/2 stream state.
    - `tx_op`: An array of one `fd_h2_tx_op_t` structure for managing transmit operations.
- **Description**: Contains arrays of structures that manage the state and operations of an HTTP/2 connection, including transmit buffers, connection state, stream state, and transmit operations.


---
### fuzz\_h2\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``rbuf_tx``: An array of one `fd_h2_rbuf_t` structure for transmission buffer management.
    - ``conn``: An array of one `fd_h2_conn_t` structure representing the connection.
    - ``stream``: An array of one `fd_h2_stream_t` structure representing the stream.
    - ``tx_op``: An array of one `fd_h2_tx_op_t` structure for transmission operations.
- **Description**: Defines a context structure for fuzz testing HTTP/2 connections, containing buffers, connection, stream, and transmission operation structures to manage and test the connection-level APIs for potential issues.


# Functions

---
### test\_response\_continue<!-- {{#callable:test_response_continue}} -->
[View Source →](<../../../../../src/waltz/h2/fuzz_h2.c#L33>)

Checks if the current stream has a valid ID, copies a transmission operation, and cleans up resources if the stream is closed.
- **Inputs**: None
- **Logic and Control Flow**:
    - Checks if `g_ctx.stream->stream_id` is zero; if true, exits the function.
    - Calls [`fd_h2_tx_op_copy`](<fd_h2_tx.c.md#fd_h2_tx_op_copy>) to copy the transmission operation from `g_ctx.conn`, `g_ctx.stream`, and `g_ctx.rbuf_tx` to `g_ctx.tx_op`.
    - Checks if `g_ctx.stream->state` is `FD_H2_STREAM_STATE_CLOSED`; if true, decrements `g_stream_cnt`, and clears `g_ctx.tx_op` and `g_ctx.stream` using `memset`.
- **Output**: No output is returned.
- **Functions Called**:
    - [`fd_h2_tx_op_copy`](<fd_h2_tx.c.md#fd_h2_tx_op_copy>)


---
### test\_response\_init<!-- {{#callable:test_response_init}} -->
[View Source →](<../../../../../src/waltz/h2/fuzz_h2.c#L44>)

Initializes an HTTP/2 response by sending a headers frame and preparing a transmission operation.
- **Inputs**:
    - `conn`: A pointer to an `fd_h2_conn_t` structure representing the HTTP/2 connection. It is not used in the function.
    - `stream`: A pointer to an `fd_h2_stream_t` structure representing the HTTP/2 stream for which the response is initialized.
- **Logic and Control Flow**:
    - Ignore the `conn` parameter as it is not used in the function.
    - Retrieve the `stream_id` from the `stream` parameter.
    - Access the global transmission buffer `rbuf_tx` from `g_ctx`.
    - Define an HPACK-encoded header array `hpack` with a status code of 200.
    - Call [`fd_h2_tx`](<fd_h2_conn.h.md#fd_h2_tx>) to send a headers frame with the `hpack` data, setting the `FD_H2_FLAG_END_HEADERS` flag and using the `stream_id`.
    - Access the global transmission operation `tx_op` from `g_ctx`.
    - Initialize `tx_op` with the message "Ok", a length of 2, and the `FD_H2_FLAG_END_STREAM` flag using `fd_h2_tx_op_init`.
    - Call [`test_response_continue`](<#test_response_continue>) to proceed with the response handling.
- **Output**: No direct output is returned from the function.
- **Functions Called**:
    - [`fd_h2_tx`](<fd_h2_conn.h.md#fd_h2_tx>)
    - [`test_response_continue`](<#test_response_continue>)


---
### cb\_stream\_create<!-- {{#callable:cb_stream_create}} -->
[View Source →](<../../../../../src/waltz/h2/fuzz_h2.c#L59>)

Creates a new HTTP/2 stream if no stream currently exists in the global context.
- **Inputs**:
    - `conn`: A pointer to an `fd_h2_conn_t` structure representing the connection.
    - `stream_id`: An unsigned integer representing the stream identifier.
- **Logic and Control Flow**:
    - Check if `g_ctx.stream->stream_id` is non-zero, indicating an existing stream; if so, return `NULL`.
    - Initialize the stream using `fd_h2_stream_init` with `g_ctx.stream`.
    - Increment the global stream count `g_stream_cnt`.
    - Return the pointer to the newly initialized stream `g_ctx.stream`.
- **Output**: Returns a pointer to the newly created `fd_h2_stream_t` if successful, or `NULL` if a stream already exists.


---
### cb\_stream\_query<!-- {{#callable:cb_stream_query}} -->
[View Source →](<../../../../../src/waltz/h2/fuzz_h2.c#L71>)

Queries the current stream in the global context to check if it matches the given stream ID.
- **Inputs**:
    - `conn`: A pointer to an `fd_h2_conn_t` structure representing the connection.
    - `stream_id`: An unsigned integer representing the stream ID to query.
- **Logic and Control Flow**:
    - Assert that the `conn` parameter is equal to the global context connection `g_ctx.conn`.
    - Check if the stream ID of the global context stream `g_ctx.stream` is not equal to the provided `stream_id`.
    - If the stream IDs do not match, return `NULL`.
    - If the stream IDs match, return the global context stream `g_ctx.stream`.
- **Output**: Returns a pointer to the `fd_h2_stream_t` structure if the stream ID matches, otherwise returns `NULL`.


---
### cb\_conn\_established<!-- {{#callable:cb_conn_established}} -->
[View Source →](<../../../../../src/waltz/h2/fuzz_h2.c#L79>)

Verifies that the connection pointer `conn` matches the global context connection `g_ctx.conn`.
- **Inputs**:
    - `conn`: A pointer to an `fd_h2_conn_t` structure representing the connection to be verified.
- **Logic and Control Flow**:
    - Use the `assert` function to check if the `conn` pointer is equal to `g_ctx.conn`.
    - Return from the function after the assertion.
- **Output**: No output is produced; the function performs an assertion check and returns void.


---
### cb\_conn\_final<!-- {{#callable:cb_conn_final}} -->
[View Source →](<../../../../../src/waltz/h2/fuzz_h2.c#L85>)

Handles the finalization of an HTTP/2 connection by resetting stream count and incrementing a finalization counter.
- **Inputs**:
    - `conn`: A pointer to an `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - `h2_err`: An unsigned integer representing the HTTP/2 error code, which is not used in this function.
    - `closed_by`: An integer indicating who closed the connection, expected to be either 0 or 1.
- **Logic and Control Flow**:
    - Asserts that the `conn` pointer is equal to `g_ctx.conn` to ensure the correct connection context.
    - Asserts that `closed_by` is either 0 or 1 to validate the input.
    - Ignores the `h2_err` parameter as it is not used in the function.
    - Sets the global stream count `g_stream_cnt` to 0, indicating no active streams.
    - Increments the global connection finalization counter `g_conn_final_cnt` by 1.
- **Output**: No output is returned as the function's return type is `void`.


---
### cb\_headers<!-- {{#callable:cb_headers}} -->
[View Source →](<../../../../../src/waltz/h2/fuzz_h2.c#L97>)

Processes HTTP/2 headers from a data stream and handles errors or stream completion.
- **Inputs**:
    - `conn`: A pointer to the `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - `stream`: A pointer to the `fd_h2_stream_t` structure representing the HTTP/2 stream.
    - `data`: A pointer to the data buffer containing the headers to be processed.
    - `data_sz`: The size of the data buffer in bytes.
    - `flags`: Flags indicating specific conditions or states, such as `FD_H2_FLAG_END_STREAM`.
- **Logic and Control Flow**:
    - Initialize an HPACK reader with the provided data and size using `fd_hpack_rd_init`.
    - Enter a loop that continues until [`fd_hpack_rd_done`](<fd_hpack.h.md#fd_hpack_rd_done>) returns true, indicating all headers are processed.
    - Within the loop, allocate a static buffer `scratch_buf` for temporary storage and set `scratch` to point to it.
    - Attempt to read the next header using [`fd_hpack_rd_next`](<fd_hpack.c.md#fd_hpack_rd_next>), passing the HPACK reader, a header structure, and the scratch buffer.
    - If an error occurs during header reading (`err` is non-zero), call [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>) with the connection and error code, then return.
    - After processing all headers, check if the `FD_H2_FLAG_END_STREAM` flag is set in `flags`.
    - If the flag is set, call [`test_response_init`](<#test_response_init>) to initialize a response for the stream.
- **Output**: No direct output is returned, but the function may modify the connection or stream state and initiate a response if the end of the stream is reached.
- **Functions Called**:
    - [`fd_hpack_rd_done`](<fd_hpack.h.md#fd_hpack_rd_done>)
    - [`fd_hpack_rd_next`](<fd_hpack.c.md#fd_hpack_rd_next>)
    - [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>)
    - [`test_response_init`](<#test_response_init>)


---
### cb\_data<!-- {{#callable:cb_data}} -->
[View Source →](<../../../../../src/waltz/h2/fuzz_h2.c#L121>)

Handles data callback for an HTTP/2 connection and initiates a response if the end of the stream is flagged.
- **Inputs**:
    - `conn`: A pointer to the `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - `stream`: A pointer to the `fd_h2_stream_t` structure representing the HTTP/2 stream.
    - `data`: A pointer to the data received, though it is not used in this function.
    - `data_sz`: The size of the data received, though it is not used in this function.
    - `flags`: Flags associated with the data, used to check if the end of the stream is reached.
- **Logic and Control Flow**:
    - Asserts that the `conn` pointer is equal to the global connection context `g_ctx.conn`.
    - Ignores the `stream`, `data`, `data_sz`, and `flags` parameters using `(void)` casting.
    - Checks if the `flags` parameter has the `FD_H2_FLAG_END_STREAM` flag set.
    - If the end of the stream flag is set, calls [`test_response_init`](<#test_response_init>) with `conn` and `stream` as arguments.
- **Output**: No output is returned from this function.
- **Functions Called**:
    - [`test_response_init`](<#test_response_init>)


---
### cb\_rst\_stream<!-- {{#callable:cb_rst_stream}} -->
[View Source →](<../../../../../src/waltz/h2/fuzz_h2.c#L135>)

Resets the HTTP/2 stream context and decrements the stream count when a stream reset occurs.
- **Inputs**:
    - `conn`: A pointer to the `fd_h2_conn_t` connection object, which must match the global context connection.
    - `stream`: A pointer to the `fd_h2_stream_t` stream object, which is not used in the function.
    - `error_code`: An unsigned integer representing the error code, which is not used in the function.
    - `closed_by`: An integer indicating who closed the stream, expected to be 0 or 1.
- **Logic and Control Flow**:
    - Ignore `stream` and `error_code` parameters as they are not used in the function.
    - Assert that the `conn` parameter matches the global context connection `g_ctx.conn`.
    - Assert that `closed_by` is either 0 or 1.
    - Reset the global context stream `g_ctx.stream` by setting its memory to zero.
    - Decrement the global stream count `g_stream_cnt`.
- **Output**: No output is returned from this function.


---
### cb\_window\_update<!-- {{#callable:cb_window_update}} -->
[View Source →](<../../../../../src/waltz/h2/fuzz_h2.c#L148>)

Does nothing and returns immediately.
- **Inputs**:
    - `conn`: A pointer to an `fd_h2_conn_t` structure, representing the connection.
    - `increment`: An unsigned integer representing the increment value for the window update.
- **Logic and Control Flow**:
    - The function takes two parameters: `conn` and `increment`, but does not use them.
    - The function body contains only a return statement, indicating no operations are performed.
- **Output**: No output is produced as the function returns immediately without performing any operations.


---
### cb\_stream\_window\_update<!-- {{#callable:cb_stream_window_update}} -->
[View Source →](<../../../../../src/waltz/h2/fuzz_h2.c#L155>)

Does nothing and returns immediately.
- **Inputs**:
    - `conn`: A pointer to an `fd_h2_conn_t` structure representing the connection.
    - `stream`: A pointer to an `fd_h2_stream_t` structure representing the stream.
    - `increment`: An unsigned integer representing the increment value for the window update.
- **Logic and Control Flow**:
    - The function takes three parameters: `conn`, `stream`, and `increment`, but does not use them.
    - The function immediately returns without performing any operations.
- **Output**: No output is produced as the function returns immediately without performing any operations.


---
### LLVMFuzzerInitialize<!-- {{#callable:LLVMFuzzerInitialize}} -->
[View Source →](<../../../../../src/waltz/h2/fuzz_h2.c#L175>)

Initializes the fuzzer environment by setting up the shell, disabling signal handlers, and configuring logging.
- **Inputs**:
    - `argc`: A pointer to the argument count, typically passed from the command line.
    - `argv`: A pointer to the argument vector, typically passed from the command line.
- **Logic and Control Flow**:
    - Sets the environment variable `FD_LOG_BACKTRACE` to `0` to disable backtrace logging.
    - Calls `fd_boot` with `argc` and `argv` to initialize the environment.
    - Registers `fd_halt` to be called at program exit using `atexit`.
    - Sets the core log level to `1` using `fd_log_level_core_set`, which causes the program to crash on an info log.
- **Output**: Returns `0` to indicate successful initialization.


---
### LLVMFuzzerTestOneInput<!-- {{#callable:LLVMFuzzerTestOneInput}} -->
[View Source →](<../../../../../src/waltz/h2/fuzz_h2.c#L186>)

Tests HTTP/2 connection-level APIs by simulating data transmission and reception, checking for errors and state consistency.
- **Inputs**:
    - `data`: A pointer to the input data buffer, which contains the data to be processed.
    - `size`: The size of the input data buffer in bytes.
- **Logic and Control Flow**:
    - Initialize the global context `g_ctx` to zero.
    - Check if `size` is less than 4; if true, return -1.
    - Load a 4-byte seed from `data`, adjust `data` and `size` accordingly.
    - Create and join a new random number generator `rng` using the seed.
    - Initialize receive and transmit buffers `rbuf_rx` and `rbuf_tx`.
    - Initialize the connection as a client or server based on the seed value.
    - Set the maximum frame size for the connection to 256 bytes.
    - Reset global counters `g_stream_cnt` and `g_conn_final_cnt`.
    - Enter a loop that continues while `size` is greater than zero.
    - Transmit control frames using [`fd_h2_tx_control`](<fd_h2_conn.c.md#fd_h2_tx_control>) and update `rbuf_tx` offsets.
    - Check if the connection is dead; if true, assert conditions and break the loop.
    - Determine the chunk size for data processing and check buffer space; break if insufficient.
    - Push data into the receive buffer `rbuf_rx` and adjust `data` and `size`.
    - Receive data using [`fd_h2_rx`](<fd_h2_conn.c.md#fd_h2_rx>) and process it with callbacks.
    - Transmit final control frames after the loop.
    - Assert conditions on stream and connection counters and states.
    - Delete the random number generator `rng`.
- **Output**: Returns 0 after processing the input data and simulating the HTTP/2 connection.
- **Functions Called**:
    - [`fd_h2_conn_init_server`](<fd_h2_conn.c.md#fd_h2_conn_init_server>)
    - [`fd_h2_tx_control`](<fd_h2_conn.c.md#fd_h2_tx_control>)
    - [`fd_h2_rbuf_used_sz`](<fd_h2_rbuf.h.md#fd_h2_rbuf_used_sz>)
    - [`fd_h2_rbuf_push`](<fd_h2_rbuf.h.md#fd_h2_rbuf_push>)
    - [`fd_h2_rx`](<fd_h2_conn.c.md#fd_h2_rx>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)