<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

HTTP/2 connection state machine and utilities for multiplexing frames, including connection initialization and frame handling functions.

# Purpose
The `fd_h2_conn.h` file defines the structures and functions necessary for managing HTTP/2 connections. It provides a state machine and utilities for handling the multiplexing of frames in an HTTP/2 connection, adhering to the mandatory behaviors outlined in RFC 9113. The file includes definitions for connection settings, such as `fd_h2_settings_t`, which holds parameters like `initial_window_size` and `max_frame_size`. It also defines the `fd_h2_conn` structure, which represents a connection handle and includes fields for managing connection state, such as transmit and receive windows, stream IDs, and various flags indicating the connection's lifecycle state.

The file provides several functions for initializing and managing HTTP/2 connections. Functions like `fd_h2_conn_init_client` and [`fd_h2_conn_init_server`](<#fd_h2_conn_init_server>) are used to set up connections for client and server roles, respectively. The file also includes functions for handling data transmission and reception, such as [`fd_h2_rx`](<#fd_h2_rx>) for processing incoming data and [`fd_h2_tx_control`](<#fd_h2_tx_control>) for sending control messages. Additionally, it defines inline functions for preparing and committing frames for transmission, as well as handling specific frame types like PING and RST_STREAM. The file establishes a framework for managing HTTP/2 connections, focusing on frame handling and connection state management.
# Imports and Dependencies

---
- `fd_h2_rbuf.h`
- `fd_h2_proto.h`


# Global Variables

---
### fd\_h2\_client\_preface
- **Type**: ``char const[24]``
- **Description**: A constant character array that represents the HTTP/2 client connection preface. This preface is a 24-byte string that is used to initiate a connection in the HTTP/2 protocol.
- **Use**: Used to verify the client preface during the initialization of an HTTP/2 server connection.


# Data Structures

---
### fd\_h2\_settings
- **Type**: ``struct``
- **Members**:
    - ``initial_window_size``: Specifies the initial size of the HTTP/2 flow control window.
    - ``max_frame_size``: Defines the maximum size of a frame that can be sent or received.
    - ``max_header_list_size``: Indicates the maximum size of the header list that the sender is prepared to accept.
    - ``max_concurrent_streams``: Specifies the maximum number of concurrent streams that can be open at one time.
- **Description**: Contains configuration settings for an HTTP/2 connection, including parameters for flow control, frame size, header list size, and concurrency limits.


---
### fd\_h2\_settings\_t
- **Type**: ``struct``
- **Members**:
    - ``initial_window_size``: Specifies the initial size of the HTTP/2 flow control window.
    - ``max_frame_size``: Defines the maximum size of a frame that can be sent or received.
    - ``max_header_list_size``: Indicates the maximum size of the header list that the sender is prepared to accept.
    - ``max_concurrent_streams``: Limits the maximum number of concurrent streams that can be opened.
- **Description**: Contains configuration settings for an HTTP/2 connection, including flow control window size, frame size limits, header list size, and the number of concurrent streams.


---
### fd\_h2\_conn
- **Type**: ``struct``
- **Members**:
    - ``ctx``: Pointer to an arbitrary value for use by the caller.
    - ``memo``: Arbitrary value for use by the caller, stored as an unsigned long.
    - ``self_settings``: HTTP/2 settings for the local connection.
    - ``peer_settings``: HTTP/2 settings for the peer connection.
    - ``tx_frame_p``: Pointer to the first byte of the in-progress frame in the receive buffer.
    - ``tx_payload_off``: Cumulative sent byte count before the payload in the in-progress frame.
    - ``rx_suppress``: Offset to skip frame handlers until this receive offset.
    - ``rx_frame_rem``: Remaining payload bytes in the current receive frame.
    - ``rx_stream_id``: Stream ID of the current receive frame.
    - ``rx_stream_next``: Next unused receive stream ID.
    - ``rx_wnd_wmark``: Threshold for refilling the receive window.
    - ``rx_wnd_max``: Maximum size of the receive window.
    - ``rx_wnd``: Remaining bytes in the receive window.
    - ``tx_stream_next``: Next unused transmit stream ID.
    - ``tx_wnd``: Available transmit quota.
    - ``stream_active_cnt``: Count of currently active receive and transmit streams.
    - ``flags``: Bit set of connection lifecycle flags.
    - ``conn_error``: Connection error code.
    - ``setting_tx``: Number of sent SETTINGS frames pending acknowledgment.
    - ``rx_frame_flags``: Flags of the current receive frame.
    - ``rx_pad_rem``: Remaining pad bytes in the current receive frame.
    - ``ping_tx``: Number of sent PING frames pending acknowledgment.
- **Description**: Handles the state of an HTTP/2 connection, implementing mandatory behaviors such as negotiating connection settings with a peer. It maintains various settings and state information for both the local and peer connections, including frame transmission and reception details, stream management, and error handling. The structure supports the multiplexing of frames and manages the connection's lifecycle through a set of flags.


# Functions

---
### fd\_h2\_tx\_check\_sz<!-- {{#callable:fd_h2_tx_check_sz}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_conn.h#L153>)

Checks if the transmit buffer has enough space to accommodate a frame of a specified maximum size.
- **Inputs**:
    - `rbuf_tx`: A pointer to a constant `fd_h2_rbuf_t` structure representing the transmit buffer.
    - `frame_max`: An unsigned long integer representing the maximum size of the frame to check for.
- **Logic and Control Flow**:
    - Calculate the total size of the frame by adding 9 to `frame_max` to account for the frame header.
    - Add 64 to the total size to reserve space for control frames, resulting in the required size.
    - Check if the free size in `rbuf_tx` is greater than or equal to the required size.
    - Return 1 if there is enough space, otherwise return 0.
- **Output**: Returns 1 if the transmit buffer has enough space to hold the frame, otherwise returns 0.
- **Functions Called**:
    - [`fd_h2_rbuf_free_sz`](<fd_h2_rbuf.h.md#fd_h2_rbuf_free_sz>)


---
### fd\_h2\_tx\_prepare<!-- {{#callable:fd_h2_tx_prepare}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_conn.h#L167>)

Prepares a partial HTTP/2 frame header for transmission by appending it to the transmit buffer.
- **Inputs**:
    - ``conn``: A pointer to an `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - ``rbuf_tx``: A pointer to an `fd_h2_rbuf_t` structure representing the transmit buffer.
    - ``frame_type``: An unsigned integer specifying the type of the HTTP/2 frame.
    - ``flags``: An unsigned integer representing the flags for the frame.
    - ``stream_id``: An unsigned integer indicating the stream identifier for the frame.
- **Logic and Control Flow**:
    - Checks if `conn->tx_frame_p` is not NULL, logs a critical error if true, indicating a mismatched call.
    - Sets `conn->tx_frame_p` to the current high watermark of `rbuf_tx`.
    - Calculates the payload offset by adding 9 to `rbuf_tx->hi_off` and assigns it to `conn->tx_payload_off`.
    - Initializes a `fd_h2_frame_hdr_t` structure with the frame type, flags, and byte-swapped stream ID.
    - Pushes the frame header into `rbuf_tx` using [`fd_h2_rbuf_push`](<fd_h2_rbuf.h.md#fd_h2_rbuf_push>).
- **Output**: No return value; modifies the `conn` and `rbuf_tx` structures to prepare for frame transmission.
- **Functions Called**:
    - [`fd_h2_frame_typlen`](<fd_h2_proto.h.md#fd_h2_frame_typlen>)
    - [`fd_h2_rbuf_push`](<fd_h2_rbuf.h.md#fd_h2_rbuf_push>)


---
### fd\_h2\_tx\_commit<!-- {{#callable:fd_h2_tx_commit}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_conn.h#L190>)

Finalizes the transmission of an HTTP/2 frame by updating the frame size and resetting connection state.
- **Inputs**:
    - ``conn``: A pointer to an `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - ``rbuf_tx``: A pointer to a constant `fd_h2_rbuf_t` structure representing the transmission buffer.
- **Logic and Control Flow**:
    - Calculate the offset difference between `rbuf_tx->hi_off` and `conn->tx_payload_off` to determine the frame size.
    - Adjust pointers `sz1` and `sz2` if they exceed the buffer boundary `buf1`.
    - Check if the frame pointer `frame` is within the valid range of the buffer (`buf0` to `buf1`).
    - Log a critical error if the frame pointer is out of range.
    - Store the calculated frame size into the first three bytes of the frame header (`sz0`, `sz1`, `sz2`).
    - Reset `conn->tx_frame_p` to `NULL` and `conn->tx_payload_off` to `0UL` to indicate the frame is complete.
- **Output**: No return value; the function modifies the `conn` structure and the frame header in the buffer.


---
### fd\_h2\_tx<!-- {{#callable:fd_h2_tx}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_conn.h#L223>)

Transmits an HTTP/2 frame by preparing and pushing its header and payload into a ring buffer.
- **Inputs**:
    - ``rbuf_tx``: A pointer to the `fd_h2_rbuf_t` structure representing the transmission ring buffer where the frame will be pushed.
    - ``payload``: A pointer to the payload data to be included in the frame.
    - ``payload_sz``: The size of the payload data in bytes.
    - ``frame_type``: The type of the HTTP/2 frame to be transmitted.
    - ``flags``: Flags associated with the frame, cast to an unsigned character.
    - ``stream_id``: The identifier of the stream to which the frame belongs, which will be byte-swapped before use.
- **Logic and Control Flow**:
    - Create a `fd_h2_frame_hdr_t` structure `hdr` and initialize its fields: `typlen` is set using [`fd_h2_frame_typlen`](<fd_h2_proto.h.md#fd_h2_frame_typlen>) with `frame_type` and `payload_sz`, `flags` is set to the provided `flags`, and `r_stream_id` is set to the byte-swapped `stream_id`.
    - Push the `hdr` structure into the `rbuf_tx` ring buffer using [`fd_h2_rbuf_push`](<fd_h2_rbuf.h.md#fd_h2_rbuf_push>).
    - Push the `payload` data into the `rbuf_tx` ring buffer using [`fd_h2_rbuf_push`](<fd_h2_rbuf.h.md#fd_h2_rbuf_push>).
- **Output**: No return value; the function operates by side effect, modifying the `rbuf_tx` ring buffer to include the new frame.
- **Functions Called**:
    - [`fd_h2_frame_typlen`](<fd_h2_proto.h.md#fd_h2_frame_typlen>)
    - [`fd_h2_rbuf_push`](<fd_h2_rbuf.h.md#fd_h2_rbuf_push>)


---
### fd\_h2\_conn\_error<!-- {{#callable:fd_h2_conn_error}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_conn.h#L249>)

Sets the connection flags to send a GOAWAY frame and records the connection error code.
- **Inputs**:
    - ``conn``: A pointer to an `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - ``err_code``: An unsigned integer representing the error code to set for the connection.
- **Logic and Control Flow**:
    - Set the `flags` field of the `conn` structure to `FD_H2_CONN_FLAGS_SEND_GOAWAY`, indicating that a GOAWAY frame should be sent.
    - Assign the `err_code` to the `conn_error` field of the `conn` structure, casting it to an unsigned character.
- **Output**: No return value; the function modifies the `conn` structure in place.


---
### fd\_h2\_tx\_rst\_stream<!-- {{#callable:fd_h2_tx_rst_stream}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_conn.h#L261>)

Writes a RST_STREAM frame to the transmission buffer to reset a specific HTTP/2 stream with an error code.
- **Inputs**:
    - ``rbuf_tx``: A pointer to the `fd_h2_rbuf_t` buffer where the RST_STREAM frame will be written.
    - ``stream_id``: The identifier of the stream to reset, provided as an unsigned integer.
    - ``h2_err``: The HTTP/2 error code indicating the reason for the stream reset, provided as an unsigned integer.
- **Logic and Control Flow**:
    - Create a `fd_h2_rst_stream_t` structure named `rst_stream` to represent the RST_STREAM frame.
    - Initialize the `hdr` field of `rst_stream` with a type-length value for a RST_STREAM frame, zero flags, and a byte-swapped stream ID.
    - Set the `error_code` field of `rst_stream` to the byte-swapped value of `h2_err`.
    - Push the `rst_stream` structure into the `rbuf_tx` buffer using [`fd_h2_rbuf_push`](<fd_h2_rbuf.h.md#fd_h2_rbuf_push>).
- **Output**: No return value; the function writes the RST_STREAM frame directly to the provided buffer.
- **Functions Called**:
    - [`fd_h2_frame_typlen`](<fd_h2_proto.h.md#fd_h2_frame_typlen>)
    - [`fd_h2_rbuf_push`](<fd_h2_rbuf.h.md#fd_h2_rbuf_push>)


# Function Declarations (Public API)

---
### fd\_h2\_conn\_init\_server<!-- {{#callable_declaration:fd_h2_conn_init_server}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_conn.h#L108>)

Initializes a server-side HTTP/2 connection.
- **Description**: Use this function to set up a server-side HTTP/2 connection. It initializes the connection object with default settings and prepares it for communication. This function assumes that the client preface has already been received. It is important to call this function before using the connection for any HTTP/2 operations. The function is designed to be infallible, but it is recommended to check the return value for future compatibility.
- **Inputs**:
    - `conn`: A pointer to an `fd_h2_conn_t` structure that represents the connection. Must not be null. The caller retains ownership of the memory.
- **Output**: Returns the initialized `fd_h2_conn_t` pointer on success. The function is currently infallible, so it does not return null.
- **See Also**: [`fd_h2_conn_init_server`](<fd_h2_conn.c.md#fd_h2_conn_init_server>)  (Implementation)


---
### fd\_h2\_rx<!-- {{#callable_declaration:fd_h2_rx}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_conn.h#L125>)

Consumes incoming bytes from a receive buffer for HTTP/2 processing.
- **Description**: Use this function to process incoming HTTP/2 frames from a receive buffer. It reads as much data as possible from the receive buffer and may write control messages to the transmit buffer. The function stops processing if the transmit buffer is full, no more data is available in the receive buffer, or a connection error occurs. Ensure that the scratch buffer size is at least as large as the maximum frame size specified in the connection's settings. This function should be called when new data is available in the receive buffer.
- **Inputs**:
    - `conn`: A pointer to an `fd_h2_conn_t` structure representing the HTTP/2 connection. Must not be null. The connection must be properly initialized before calling this function.
    - `rbuf_rx`: A pointer to an `fd_h2_rbuf_t` structure representing the receive buffer. Must not be null. The buffer should contain incoming data to be processed.
    - `rbuf_tx`: A pointer to an `fd_h2_rbuf_t` structure representing the transmit buffer. Must not be null. The buffer may receive control messages as a result of processing.
    - `scratch`: A pointer to a scratch buffer used for reassembly. Must not be null. The buffer size must be at least `scratch_sz`.
    - `scratch_sz`: The size of the scratch buffer. Must be greater than or equal to the maximum frame size specified in the connection's settings.
    - `cb`: A pointer to an `fd_h2_callbacks_t` structure containing callback functions. Must not be null. These callbacks are used during the processing of frames.
- **Output**: None
- **See Also**: [`fd_h2_rx`](<fd_h2_conn.c.md#fd_h2_rx>)  (Implementation)


---
### fd\_h2\_tx\_control<!-- {{#callable_declaration:fd_h2_tx_control}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_conn.h#L137>)

Writes control messages to the transmission buffer.
- **Description**: Use this function to write control messages to the transmission buffer when creating a connection or when a timer expires. It checks if there is enough space in the transmission buffer before proceeding. The function handles different connection states by examining the connection flags and writes appropriate control frames to the buffer. It also updates the connection state and may invoke a callback if a connection is finalized. Ensure that the transmission buffer has at least 128 bytes of free space before calling this function.
- **Inputs**:
    - `conn`: A pointer to an `fd_h2_conn_t` structure representing the HTTP/2 connection. Must not be null. The function uses this to determine the current state and update the connection flags.
    - `rbuf_tx`: A pointer to an `fd_h2_rbuf_t` structure representing the transmission buffer. Must not be null and must have at least 128 bytes of free space. The function writes control frames to this buffer.
    - `cb`: A pointer to a constant `fd_h2_callbacks_t` structure containing callback functions. Must not be null. The function may call `conn_final` from this structure if the connection is finalized.
- **Output**: None
- **See Also**: [`fd_h2_tx_control`](<fd_h2_conn.c.md#fd_h2_tx_control>)  (Implementation)


---
### fd\_h2\_tx\_ping<!-- {{#callable_declaration:fd_h2_tx_ping}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_conn.h#L242>)

Attempts to enqueue a PING frame for transmission.
- **Description**: Use this function to enqueue a PING frame for sending over an HTTP/2 connection. It is typically called within the context of connection management to maintain or check the connection's health. Ensure that the transmit buffer has enough space to accommodate the PING frame and that the number of unacknowledged PING frames does not exceed the maximum allowed. If the buffer is full or the limit is reached, the function will not enqueue the frame and will return 0.
- **Inputs**:
    - `conn`: A pointer to an `fd_h2_conn_t` structure representing the HTTP/2 connection. The connection must be valid and properly initialized. The function will update the `ping_tx` field of this structure.
    - `rbuf_tx`: A pointer to an `fd_h2_rbuf_t` structure representing the transmit buffer. The buffer must have enough free space to accommodate a PING frame. If the buffer is full, the function will return 0.
- **Output**: Returns 1 if the PING frame is successfully enqueued, or 0 if the buffer is full or the maximum number of unacknowledged PING frames is reached.
- **See Also**: [`fd_h2_tx_ping`](<fd_h2_conn.c.md#fd_h2_tx_ping>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)