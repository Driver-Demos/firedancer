<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for HPACK encoding and decoding, including header field representation and variable-length integer encoding.

# Purpose
The code is a test suite for validating the functionality of HPACK, which is a compression format used in HTTP/2 to efficiently encode HTTP headers. The file includes several static arrays of binary data (`rfc7541_c31_bin`, `rfc7541_c32_bin`, etc.) and their corresponding decoded header representations (`rfc7541_c31_dec`, `rfc7541_c32_dec`, etc.). These arrays are used to test the reading and decoding of HPACK-encoded headers. The function [`test_hpack_rd`](<#test_hpack_rd>) is responsible for initializing a reader, iterating over expected header fields, and verifying that the decoded headers match the expected values using assertions.

Additionally, the code defines a structure `test_hpack_case_t` to represent test cases for variable-length integer encoding and decoding, which is a part of the HPACK specification. The functions [`test_hpack_rd_varint`](<#test_hpack_rd_varint>) and [`test_hpack_wr_varint`](<#test_hpack_wr_varint>) test the reading and writing of these variable-length integers, respectively. The [`test_hpack`](<#test_hpack>) function orchestrates the execution of all these tests, ensuring that the HPACK implementation correctly handles both header field encoding/decoding and variable-length integer operations.
# Imports and Dependencies

---
- `fd_hpack_private.h`
- `fd_hpack_wr.h`
- `../../util/log/fd_log.h`


# Global Variables

---
### rfc7541\_c31\_bin
- **Type**: ``uchar[]``
- **Description**: An array of unsigned characters that contains a binary representation of a specific HTTP/2 header set as defined by RFC 7541, section C.3.1. The array includes hexadecimal values that encode the header fields for a request to 'www.example.com'.
- **Use**: Used in the `test_hpack_rd` function to test the decoding of HTTP/2 headers from a binary format.


---
### rfc7541\_c31\_dec
- **Type**: ``fd_h2_hdr_t const[]``
- **Description**: An array of `fd_h2_hdr_t` structures that represent HTTP/2 headers as defined in RFC 7541, section C.3.1. Each element in the array contains a header name, its length, a hint for indexing, a header value, and its length. The array is terminated by a zero-initialized structure.
- **Use**: Used to decode and represent a set of predefined HTTP/2 headers for testing HPACK decoding functionality.


---
### rfc7541\_c32\_bin
- **Type**: ``uchar[]``
- **Description**: An array of unsigned characters that represents a binary encoding of HTTP/2 headers as per RFC 7541. The array contains specific byte values that correspond to encoded header fields.
- **Use**: Used in the `test_hpack_rd` function to test the decoding of HTTP/2 headers.


---
### rfc7541\_c32\_dec
- **Type**: ``fd_h2_hdr_t const[]``
- **Description**: An array of `fd_h2_hdr_t` structures that represent HTTP/2 headers as defined by RFC 7541. Each element in the array contains a header name, its length, a hint for indexing, a header value, and its length.
- **Use**: Used to decode HTTP/2 headers from binary format as part of the HPACK compression mechanism.


---
### rfc7541\_c33\_bin
- **Type**: ``uchar[]``
- **Description**: An array of unsigned characters that represents a binary encoding of HTTP/2 headers as per RFC 7541, section C.3.3. The array contains a sequence of bytes that encode specific header fields and values.
- **Use**: Used to test the decoding of HTTP/2 headers in the `test_hpack_rd` function.


---
### rfc7541\_c33\_dec
- **Type**: ``fd_h2_hdr_t const[]``
- **Description**: An array of `fd_h2_hdr_t` structures that represent HTTP/2 headers as defined in RFC 7541, section C.3.3. Each element in the array contains a header name, its length, a hint for indexing, a header value, and its length. The array is terminated by an element with a `name` field set to `0`.
- **Use**: Used to decode HTTP/2 headers for a specific test case in the HPACK encoding/decoding process.


---
### rfc7541\_c41\_bin
- **Type**: ``uchar[]``
- **Description**: An array of unsigned characters that contains a sequence of bytes. These bytes are likely used for encoding or decoding operations related to the HPACK compression format as specified in RFC 7541.
- **Use**: Used in the `test_hpack_rd` function to test HPACK decoding.


---
### rfc7541\_c42\_bin
- **Type**: ``uchar[]``
- **Description**: An array of unsigned characters that represents a binary encoding related to RFC 7541, which is the HPACK compression format for HTTP/2 headers.
- **Use**: Used in the `test_hpack_rd` function to test the decoding of HPACK encoded headers.


---
### rfc7541\_c43\_bin
- **Type**: ``uchar[]``
- **Description**: An array of unsigned characters that represents a binary encoding of HTTP/2 headers as per RFC 7541. The array contains a sequence of hexadecimal values that encode specific header fields and values.
- **Use**: Used in the `test_hpack_rd` function to test the decoding of HTTP/2 headers.


---
### rfc7541\_c51\_bin
- **Type**: ``uchar[]``
- **Description**: An array of unsigned characters that contains binary data representing HTTP/2 headers as per RFC 7541, section C.5.1. This data is used for testing HPACK encoding and decoding.
- **Use**: Used in the `test_hpack_rd` function to verify the correct decoding of HTTP/2 headers.


---
### rfc7541\_c51\_dec
- **Type**: ``fd_h2_hdr_t const[]``
- **Description**: An array of `fd_h2_hdr_t` structures that represent HTTP/2 headers as defined in RFC 7541, section C.5.1. Each element in the array contains a header name, its length, a hint for indexing, a header value, and its length. The array is terminated by an element with a null name.
- **Use**: Used to decode and represent a set of HTTP/2 headers for a specific test case in the HPACK encoding/decoding process.


---
### rfc7541\_c61\_bin
- **Type**: ``uchar const[]``
- **Description**: An array of unsigned characters that contains a sequence of bytes. These bytes are likely used for encoding or decoding operations related to the HPACK compression format as specified in RFC 7541.
- **Use**: Used as input data for HPACK decoding functions to test the decoding process.


---
### test\_hpack\_cases
- **Type**: ``test_hpack_case_t const[]``
- **Description**: An array of `test_hpack_case_t` structures, each containing fields for `bits`, `prefix`, `len`, `res`, and optionally `enc`. These fields represent test cases for HPACK encoding and decoding, specifically for variable-length integer encoding.
- **Use**: Used to test the reading and writing of HPACK variable-length integers in the `test_hpack_rd_varint` and `test_hpack_wr_varint` functions.


# Data Structures

---
### test\_hpack\_case
- **Type**: ``struct``
- **Members**:
    - `res`: Stores the result as an unsigned long integer.
    - `enc`: An array of 8 unsigned characters used for encoding.
    - `bits`: Stores the number of bits as an unsigned character.
    - `prefix`: Stores the prefix value as an unsigned character.
    - `len`: Stores the length as an unsigned character.
- **Description**: Represents a test case for HPACK encoding and decoding, containing fields for the result, encoding data, bit count, prefix, and length.


---
### test\_hpack\_case\_t
- **Type**: ``struct``
- **Members**:
    - `res`: Stores the result as an unsigned long integer.
    - `enc`: Holds an array of 8 unsigned characters for encoding.
    - `bits`: Represents the number of bits used in the encoding.
    - `prefix`: Stores the prefix value used in the encoding.
    - `len`: Indicates the length of the encoded data.
- **Description**: Defines a structure used for testing HPACK encoding and decoding cases, with fields for storing the result, encoding data, bit count, prefix, and length of the encoded data.


# Functions

---
### test\_hpack\_rd<!-- {{#callable:test_hpack_rd}} -->
[View Source →](<../../../../../src/waltz/h2/test_hpack.c#L116>)

Validates the decoding of HPACK-encoded headers against expected header values.
- **Inputs**:
    - ``bin``: A pointer to the binary data representing HPACK-encoded headers.
    - ``binsz``: The size of the binary data in bytes.
    - ``dec``: A pointer to an array of `fd_h2_hdr_t` structures representing the expected decoded headers.
- **Logic and Control Flow**:
    - Initialize an `fd_hpack_rd_t` structure with the binary data and its size.
    - Iterate over the expected headers until a header with a null name is encountered.
    - For each expected header, verify that the reader has not finished reading the data.
    - Decode the next header from the binary data into an `fd_h2_hdr_t` structure.
    - Ensure the buffer pointer remains within the buffer limits after decoding.
    - Compare the decoded header's name length, value length, name, value, and hint with the expected header's values.
    - After processing all expected headers, verify that the reader has finished reading the data.
- **Output**: No output is returned; the function uses assertions to validate the decoding process.
- **Functions Called**:
    - [`fd_hpack_rd_done`](<fd_hpack.h.md#fd_hpack_rd_done>)
    - [`fd_hpack_rd_next`](<fd_hpack.c.md#fd_hpack_rd_next>)


---
### test\_hpack\_rd\_varint<!-- {{#callable:test_hpack_rd_varint}} -->
[View Source →](<../../../../../src/waltz/h2/test_hpack.c#L164>)

Tests the reading of HPACK variable-length integers against predefined test cases.
- **Inputs**: None
- **Logic and Control Flow**:
    - Iterates over each test case in `test_hpack_cases` where `c->bits` is non-zero.
    - For each test case, iterates over `len` from 0 to 8 inclusive.
    - Initializes `fd_hpack_rd_t` structure `rd` with `src` set to `c->enc` and `src_end` set to `c->enc + len`.
    - Calls [`fd_hpack_rd_varint`](<fd_hpack_private.h.md#fd_hpack_rd_varint>) with `rd`, `c->prefix`, and `(1U<<(c->bits))-1U` to read a variable-length integer.
    - If `len` is less than `c->len`, checks that the result is `ULONG_MAX` using `FD_TEST`.
    - Otherwise, checks that the result matches `c->res` using `FD_TEST`.
- **Output**: No output is returned; the function uses assertions to validate behavior.
- **Functions Called**:
    - [`fd_hpack_rd_varint`](<fd_hpack_private.h.md#fd_hpack_rd_varint>)


---
### test\_hpack\_wr\_varint<!-- {{#callable:test_hpack_wr_varint}} -->
[View Source →](<../../../../../src/waltz/h2/test_hpack.c#L179>)

Tests the [`fd_hpack_wr_varint`](<fd_hpack_wr.h.md#fd_hpack_wr_varint>) function by encoding a series of test cases and verifying the results.
- **Inputs**: None
- **Logic and Control Flow**:
    - Iterates over each test case in `test_hpack_cases`.
    - For each test case, initializes a buffer `buf` of size 16.
    - Calculates `addend` as `(1U << c->bits) - 1U`.
    - Calculates `prefix` by masking `c->prefix` with the bitwise NOT of `addend`.
    - Calls [`fd_hpack_wr_varint`](<fd_hpack_wr.h.md#fd_hpack_wr_varint>) with `buf`, `prefix`, `addend`, and `c->res` to encode the integer.
    - Verifies that the length returned by [`fd_hpack_wr_varint`](<fd_hpack_wr.h.md#fd_hpack_wr_varint>) is equal to `c->len + 1`.
    - Checks that the first byte of `buf` matches `c->prefix`.
    - Verifies that the encoded bytes in `buf` match `c->enc` for `c->len` bytes.
- **Output**: No direct output; uses `FD_TEST` to assert conditions.
- **Functions Called**:
    - [`fd_hpack_wr_varint`](<fd_hpack_wr.h.md#fd_hpack_wr_varint>)


---
### test\_hpack<!-- {{#callable:test_hpack}} -->
[View Source →](<../../../../../src/waltz/h2/test_hpack.c#L192>)

Executes a series of tests for HPACK encoding and decoding using predefined binary and header data.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls [`test_hpack_rd`](<#test_hpack_rd>) with various binary data and expected header data to test HPACK decoding.
    - Invokes [`test_hpack_rd_varint`](<#test_hpack_rd_varint>) to test the reading of variable-length integers in HPACK.
    - Calls [`test_hpack_wr_varint`](<#test_hpack_wr_varint>) to test the writing of variable-length integers in HPACK.
- **Output**: No output is returned as the function is void and primarily used for testing purposes.
- **Functions Called**:
    - [`test_hpack_rd`](<#test_hpack_rd>)
    - [`test_hpack_rd_varint`](<#test_hpack_rd_varint>)
    - [`test_hpack_wr_varint`](<#test_hpack_wr_varint>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)