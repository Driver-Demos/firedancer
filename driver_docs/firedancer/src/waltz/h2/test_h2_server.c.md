<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

A dummy HTTP/2 server for testing GET and POST requests using single-threaded blocking sockets.

# Purpose
The code is an implementation of a simple HTTP/2 server designed for testing purposes. It handles HTTP/2 connections using single-threaded blocking sockets without timeouts. The server responds to GET and POST requests with a status code of 200. The main components of the code include the initialization and management of HTTP/2 connections and streams, handling of incoming requests, and sending of responses. The server uses a set of callback functions to manage the lifecycle of HTTP/2 streams and connections, including stream creation, query, connection establishment, and closure.

The code defines a [`main`](<#main>) function that sets up a TCP server socket, listens for incoming connections, and processes each connection either in the current process or by forking a new process, depending on the specified mode. The server reads the HTTP/2 client preface to establish a connection and uses a series of callback functions to handle HTTP/2 frames such as headers and data. The server is configured to handle one concurrent stream per connection and logs various events and errors for debugging purposes. The code is structured to be a standalone executable, with the main logic encapsulated in the [`main`](<#main>) function and supporting functions for handling connections and HTTP/2 protocol operations.
# Imports and Dependencies

---
- `fd_h2.h`
- `fd_h2_rbuf_sock.h`
- `../../util/fd_util.h`
- `../../util/net/fd_ip4.h`
- `errno.h`
- `stdlib.h`
- `unistd.h`
- `netinet/in.h`
- `sys/socket.h`


# Global Variables

---
### g\_app
- **Type**: ``test_h2_app_t *``
- **Description**: A pointer to a `test_h2_app_t` structure, which contains elements for managing HTTP/2 application logic, including receive buffers, connection, stream, and transmission operations.
- **Use**: Used to access and manipulate the HTTP/2 application state and operations throughout the server's execution.


---
### test\_h2\_callbacks
- **Type**: `fd_h2_callbacks_t`
- **Description**: `test_h2_callbacks` is a static variable of type `fd_h2_callbacks_t` that holds callback functions for handling various HTTP/2 events. These events include stream creation, connection establishment, header processing, and data reception.
- **Use**: Used to define and manage the behavior of the HTTP/2 server by assigning specific functions to handle different protocol events.


# Data Structures

---
### test\_h2\_app
- **Type**: ``struct``
- **Members**:
    - `rbuf_tx`: An array of `fd_h2_rbuf_t` used for transmission buffering.
    - `conn`: An array of `fd_h2_conn_t` representing the HTTP/2 connection.
    - `stream`: An array of `fd_h2_stream_t` representing the HTTP/2 stream.
    - `tx_op`: An array of `fd_h2_tx_op_t` used for transmission operations.
- **Description**: The `test_h2_app` structure is used in a dummy HTTP/2 server for testing purposes, encapsulating the necessary components for handling HTTP/2 connections, streams, and transmission operations.


---
### test\_h2\_app\_t
- **Type**: ``struct``
- **Members**:
    - ``rbuf_tx``: An array of `fd_h2_rbuf_t` used for transmission buffering.
    - ``conn``: An array of `fd_h2_conn_t` representing the HTTP/2 connection.
    - ``stream``: An array of `fd_h2_stream_t` representing the HTTP/2 stream.
    - ``tx_op``: An array of `fd_h2_tx_op_t` used for transmission operations.
- **Description**: Defines the structure for a test HTTP/2 application, encapsulating the necessary components for managing HTTP/2 connections and streams, including buffers for transmission, connection state, stream state, and transmission operations.


# Functions

---
### test\_response\_continue<!-- {{#callable:test_response_continue}} -->
[View Source →](<../../../../../src/waltz/h2/test_h2_server.c#L31>)

Handles the continuation of an HTTP/2 response by copying transmission operations and cleaning up if the stream is closed.
- **Inputs**: None
- **Logic and Control Flow**:
    - Retrieve the current stream from the global application context `g_app`.
    - Check if the `stream_id` of the stream is zero; if so, exit the function.
    - Call [`fd_h2_tx_op_copy`](<fd_h2_tx.c.md#fd_h2_tx_op_copy>) to copy the transmission operation from the connection, stream, and transmission buffer to the transmission operation object.
    - Check if the stream's state is `FD_H2_STREAM_STATE_CLOSED`.
    - If the stream is closed, log a notice that the response is complete.
    - Clear the memory of the transmission operation and stream objects using `memset`.
- **Output**: No output is returned from this function.
- **Functions Called**:
    - [`fd_h2_tx_op_copy`](<fd_h2_tx.c.md#fd_h2_tx_op_copy>)


---
### test\_response\_init<!-- {{#callable:test_response_init}} -->
[View Source →](<../../../../../src/waltz/h2/test_h2_server.c#L43>)

Initializes the response for an HTTP/2 stream by sending a status header and preparing the response body.
- **Inputs**:
    - `conn`: A pointer to the `fd_h2_conn_t` connection object, which is not used in this function.
    - `stream`: A pointer to the `fd_h2_stream_t` stream object, which contains the stream ID and state.
- **Logic and Control Flow**:
    - Log the completion of reading the request and the start of sending a response using the stream ID.
    - Prepare a buffer `hpack` with the HTTP/2 status code 200 and send it as a header frame using [`fd_h2_tx`](<fd_h2_conn.h.md#fd_h2_tx>).
    - Initialize a transmission operation `tx_op` with the message 'Ok' and set the end-of-stream flag using `fd_h2_tx_op_init`.
    - Call [`test_response_continue`](<#test_response_continue>) to continue the response process.
    - Check if the stream state is not closed; if so, log that the response is blocked and indicate the number of bytes written.
    - If the stream state is closed, log that the response is complete.
- **Output**: No return value; the function performs operations on the provided stream and logs the process.
- **Functions Called**:
    - [`fd_h2_tx`](<fd_h2_conn.h.md#fd_h2_tx>)
    - [`test_response_continue`](<#test_response_continue>)


---
### test\_cb\_stream\_create<!-- {{#callable:test_cb_stream_create}} -->
[View Source →](<../../../../../src/waltz/h2/test_h2_server.c#L66>)

Creates a new HTTP/2 stream if the current stream is not already in use.
- **Inputs**:
    - ``conn``: A pointer to an `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - ``stream_id``: An unsigned integer representing the ID of the stream to be created.
- **Logic and Control Flow**:
    - Ignore the `conn` parameter as it is not used in the function body.
    - Assign the global application's stream (`g_app->stream`) to the local variable `stream`.
    - Check if the `stream_id` of the current stream is non-zero using `FD_UNLIKELY`. If true, return `NULL` indicating the stream is already in use.
    - Initialize the stream using `fd_h2_stream_init` and open it with [`fd_h2_stream_open`](<fd_h2_stream.h.md#fd_h2_stream_open>), passing the connection and stream ID.
    - Return the newly created stream.
- **Output**: Returns a pointer to the newly created `fd_h2_stream_t` structure, or `NULL` if the stream is already in use.
- **Functions Called**:
    - [`fd_h2_stream_open`](<fd_h2_stream.h.md#fd_h2_stream_open>)


---
### test\_cb\_stream\_query<!-- {{#callable:test_cb_stream_query}} -->
[View Source →](<../../../../../src/waltz/h2/test_h2_server.c#L76>)

Queries the global HTTP/2 stream for a match with the given stream ID and returns it if found.
- **Inputs**:
    - ``conn``: A pointer to an `fd_h2_conn_t` structure representing the HTTP/2 connection. It is not used in this function.
    - ``stream_id``: An unsigned integer representing the ID of the stream to query.
- **Logic and Control Flow**:
    - Ignore the `conn` parameter as it is not used in the function.
    - Retrieve the global stream from `g_app->stream`.
    - Check if the `stream_id` of the global stream matches the provided `stream_id`.
    - If the IDs match, return the global stream; otherwise, return `NULL`.
- **Output**: Returns a pointer to the `fd_h2_stream_t` structure if the stream ID matches; otherwise, returns `NULL`.


---
### test\_cb\_conn\_established<!-- {{#callable:test_cb_conn_established}} -->
[View Source →](<../../../../../src/waltz/h2/test_h2_server.c#L85>)

Logs a notice that an HTTP/2 connection has been established.
- **Inputs**:
    - `conn`: A pointer to an `fd_h2_conn_t` structure representing the HTTP/2 connection.
- **Logic and Control Flow**:
    - The function takes a single argument `conn`, which is a pointer to an `fd_h2_conn_t` structure.
    - The function does not use the `conn` argument, as indicated by the `(void)conn;` statement, which is used to suppress unused parameter warnings.
    - Logs a notice message 'HTTP/2 conn established' using the `FD_LOG_NOTICE` macro.
- **Output**: No output is returned from this function.


---
### test\_cb\_conn\_final<!-- {{#callable:test_cb_conn_final}} -->
[View Source →](<../../../../../src/waltz/h2/test_h2_server.c#L91>)

Logs the closure of an HTTP/2 connection with an error code and its description.
- **Inputs**:
    - ``conn``: A pointer to the `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - ``h2_err``: An unsigned integer representing the HTTP/2 error code.
    - ``closed_by``: An integer indicating who closed the connection.
- **Logic and Control Flow**:
    - Ignores the `conn` and `closed_by` parameters by casting them to void.
    - Logs a notice message indicating the HTTP/2 connection has closed, including the error code and its string representation obtained from [`fd_h2_strerror`](<fd_h2_proto.c.md#fd_h2_strerror>).
- **Output**: No return value; the function performs logging as a side effect.
- **Functions Called**:
    - [`fd_h2_strerror`](<fd_h2_proto.c.md#fd_h2_strerror>)


---
### test\_cb\_rst\_stream<!-- {{#callable:test_cb_rst_stream}} -->
[View Source →](<../../../../../src/waltz/h2/test_h2_server.c#L99>)

Logs a reset stream event and clears the transmission operation buffer.
- **Inputs**:
    - ``conn``: A pointer to the `fd_h2_conn_t` connection object, which is not used in this function.
    - ``stream``: A pointer to the `fd_h2_stream_t` stream object, used to access the stream ID.
    - ``error_code``: An unsigned integer representing the error code associated with the RST_STREAM event.
    - ``closed_by``: An integer indicating whether the stream was closed by the peer (non-zero) or by the local endpoint (zero).
- **Logic and Control Flow**:
    - Ignores the `conn` parameter by casting it to void.
    - Logs a notice message indicating the stream ID, whether the RST_STREAM was received or sent, and the error code with its string representation.
    - Clears the `g_app->tx_op` buffer by setting all its bytes to zero using `memset`.
- **Output**: No return value; the function performs logging and buffer clearing as side effects.
- **Functions Called**:
    - [`fd_h2_strerror`](<fd_h2_proto.c.md#fd_h2_strerror>)


---
### test\_cb\_window\_update<!-- {{#callable:test_cb_window_update}} -->
[View Source →](<../../../../../src/waltz/h2/test_h2_server.c#L112>)

Triggers the continuation of a response in an HTTP/2 connection.
- **Inputs**:
    - ``conn``: A pointer to an `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - ``delta``: An unsigned integer representing the window size increment, which is not used in this function.
- **Logic and Control Flow**:
    - Ignores the `conn` and `delta` parameters by casting them to void.
    - Calls the [`test_response_continue`](<#test_response_continue>) function to proceed with the response handling.
- **Output**: No output is returned as the function has a `void` return type.
- **Functions Called**:
    - [`test_response_continue`](<#test_response_continue>)


---
### test\_cb\_stream\_window\_update<!-- {{#callable:test_cb_stream_window_update}} -->
[View Source →](<../../../../../src/waltz/h2/test_h2_server.c#L119>)

Triggers the [`test_response_continue`](<#test_response_continue>) function when a stream window update occurs.
- **Inputs**:
    - ``conn``: A pointer to an `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - ``stream``: A pointer to an `fd_h2_stream_t` structure representing the HTTP/2 stream.
    - ``delta``: An unsigned integer representing the change in the window size.
- **Logic and Control Flow**:
    - Ignores the input parameters `conn`, `stream`, and `delta` by casting them to void.
    - Calls the [`test_response_continue`](<#test_response_continue>) function.
- **Output**: No output is returned as the function has a `void` return type.
- **Functions Called**:
    - [`test_response_continue`](<#test_response_continue>)


---
### test\_cb\_headers<!-- {{#callable:test_cb_headers}} -->
[View Source →](<../../../../../src/waltz/h2/test_h2_server.c#L127>)

Processes HTTP/2 header blocks, logs header fields, and initiates a response if necessary.
- **Inputs**:
    - ``conn``: A pointer to the `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - ``stream``: A pointer to the `fd_h2_stream_t` structure representing the HTTP/2 stream.
    - ``data``: A pointer to the header block data to be processed.
    - ``data_sz``: The size of the header block data.
    - ``flags``: Flags indicating the end of headers or stream, such as `FD_H2_FLAG_END_HEADERS` and `FD_H2_FLAG_END_STREAM`.
- **Logic and Control Flow**:
    - Logs the header field block in a debug hexdump format.
    - Initializes an HPACK reader with the provided header block data.
    - Iterates over the header fields using the HPACK reader until all fields are processed.
    - For each header field, attempts to read the next header and logs it; if an error occurs, logs a warning and signals a connection error, then returns.
    - Checks if the `FD_H2_FLAG_END_HEADERS` flag is set and logs that headers are complete for the stream.
    - Checks if the `FD_H2_FLAG_END_STREAM` flag is set and calls [`test_response_init`](<#test_response_init>) to initiate a response.
- **Output**: No direct output is returned, but the function logs header information and may initiate a response or signal a connection error.
- **Functions Called**:
    - [`fd_hpack_rd_done`](<fd_hpack.h.md#fd_hpack_rd_done>)
    - [`fd_hpack_rd_next`](<fd_hpack.c.md#fd_hpack_rd_next>)
    - [`fd_h2_strerror`](<fd_h2_proto.c.md#fd_h2_strerror>)
    - [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>)
    - [`test_response_init`](<#test_response_init>)


---
### test\_cb\_data<!-- {{#callable:test_cb_data}} -->
[View Source →](<../../../../../src/waltz/h2/test_h2_server.c#L161>)

Handles incoming data for an HTTP/2 stream, checks for illegal stream state, logs data, and initiates a response if the stream ends.
- **Inputs**:
    - `conn`: A pointer to the `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - `stream`: A pointer to the `fd_h2_stream_t` structure representing the HTTP/2 stream.
    - `data`: A pointer to the data received for the stream.
    - `data_sz`: The size of the data received.
    - `flags`: Flags indicating the state of the data, such as whether it is the end of the stream.
- **Logic and Control Flow**:
    - Check if the stream state is illegal using `stream->state==FD_H2_STREAM_STATE_ILLEGAL`.
    - If the stream state is illegal, call [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>) with `FD_H2_ERR_PROTOCOL` and return.
    - Log the received data using `FD_LOG_HEXDUMP_DEBUG`.
    - Check if the `flags` indicate the end of the stream using `flags & FD_H2_FLAG_END_STREAM`.
    - If the end of the stream is indicated, call [`test_response_init`](<#test_response_init>) to initiate a response.
- **Output**: No return value; the function performs actions based on the stream state and data flags.
- **Functions Called**:
    - [`fd_h2_conn_error`](<fd_h2_conn.h.md#fd_h2_conn_error>)
    - [`test_response_init`](<#test_response_init>)


---
### read\_preface<!-- {{#callable:read_preface}} -->
[View Source →](<../../../../../src/waltz/h2/test_h2_server.c#L179>)

Reads and validates the HTTP/2 client preface from a TCP socket.
- **Inputs**:
    - `tcp_sock`: A file descriptor for the TCP socket from which to read the client preface.
- **Logic and Control Flow**:
    - Initialize `preface_sz` to 0 and `preface` array to hold 24 bytes.
    - Enter a loop that continues until `preface_sz` is less than 24.
    - Read data from `tcp_sock` into `preface` starting at `preface_sz` and up to the remaining space in `preface`.
    - If the read result `res` is less than 0, log a warning and return 0.
    - If `res` is 0, log a warning that the client closed the connection and return 0.
    - If the read data does not match the expected HTTP/2 client preface, log a warning and return 0.
    - Increment `preface_sz` by the number of bytes read (`res`).
    - Once `preface_sz` reaches 24, exit the loop and return 1.
- **Output**: Returns 1 if the client preface is successfully read and validated, otherwise returns 0.


---
### handle\_conn<!-- {{#callable:handle_conn}} -->
[View Source →](<../../../../../src/waltz/h2/test_h2_server.c#L204>)

Manages an HTTP/2 connection over a TCP socket, handling data transmission and reception in a loop until the connection is closed or an error occurs.
- **Inputs**:
    - `tcp_sock`: A TCP socket file descriptor for the connection to handle.
- **Logic and Control Flow**:
    - Initialize a `test_h2_app_t` structure and static buffers for scratch, receive, and transmit operations.
    - Check if the client preface is read successfully; if not, return immediately.
    - Set the global application pointer `g_app` to the initialized `app` structure.
    - Initialize the HTTP/2 connection and set the maximum concurrent streams to 1.
    - Initialize receive and transmit ring buffers with the respective static buffers.
    - Enter an infinite loop to handle the connection.
    - Transmit control frames using [`fd_h2_tx_control`](<fd_h2_conn.c.md#fd_h2_tx_control>) and the transmit buffer `rbuf_tx`.
    - While there is data in the transmit buffer, send it over the TCP socket using [`fd_h2_rbuf_sendmsg`](<fd_h2_rbuf_sock.h.md#fd_h2_rbuf_sendmsg>). If sending fails, log a warning and return.
    - Check if the connection is marked as dead; if so, log a notice and return.
    - Receive data from the TCP socket into the receive buffer using [`fd_h2_rbuf_recvmsg`](<fd_h2_rbuf_sock.h.md#fd_h2_rbuf_recvmsg>). If receiving fails, log a warning and return.
    - Process received data using [`fd_h2_rx`](<fd_h2_conn.c.md#fd_h2_rx>), passing the connection, receive buffer, transmit buffer, scratch buffer, and callbacks.
- **Output**: No explicit return value; the function manages the connection until it is closed or an error occurs.
- **Functions Called**:
    - [`read_preface`](<#read_preface>)
    - [`fd_h2_conn_init_server`](<fd_h2_conn.c.md#fd_h2_conn_init_server>)
    - [`fd_h2_tx_control`](<fd_h2_conn.c.md#fd_h2_tx_control>)
    - [`fd_h2_rbuf_used_sz`](<fd_h2_rbuf.h.md#fd_h2_rbuf_used_sz>)
    - [`fd_h2_rbuf_sendmsg`](<fd_h2_rbuf_sock.h.md#fd_h2_rbuf_sendmsg>)
    - [`fd_h2_rbuf_recvmsg`](<fd_h2_rbuf_sock.h.md#fd_h2_rbuf_recvmsg>)
    - [`fd_h2_rx`](<fd_h2_conn.c.md#fd_h2_rx>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/waltz/h2/test_h2_server.c#L253>)

Initializes and runs a simple HTTP/2 server that listens for incoming connections and handles them based on the specified mode.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Initializes HTTP/2 callbacks using [`fd_h2_callbacks_init`](<fd_h2_callback.c.md#fd_h2_callbacks_init>) and assigns specific callback functions for stream and connection events.
    - Parses command-line arguments to determine the bind address, port, and mode of operation (simple or fork).
    - Creates a TCP socket using `socket` and checks for errors.
    - Configures the socket address structure and binds the socket to the specified address and port, logging errors if any occur.
    - Sets the socket to listen for incoming connections with a backlog of 2.
    - Enters an infinite loop to accept incoming TCP connections using `accept`.
    - Logs the acceptance of a new connection and checks the mode to decide whether to fork a new process for handling the connection.
    - If in fork mode, calls `fork` to create a child process to handle the connection; otherwise, handles the connection in the current process using [`handle_conn`](<#handle_conn>).
    - Closes the TCP socket after handling the connection and logs any errors.
    - Closes the listening socket and calls `fd_halt` to clean up before exiting.
- **Output**: Returns 0 upon successful execution, indicating normal termination.
- **Functions Called**:
    - [`fd_h2_callbacks_init`](<fd_h2_callback.c.md#fd_h2_callbacks_init>)
    - [`handle_conn`](<#handle_conn>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)