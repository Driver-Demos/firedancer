<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for HTTP/2 connection client-side handshake and ping transmission logic.

# Purpose
The code is a C test suite designed to validate the functionality of HTTP/2 client-side connection handling, specifically focusing on handshake and ping operations. It includes tests for client-side handshake sequences and ping transmission and acknowledgment. The code uses structures and functions from the HTTP/2 protocol implementation, such as `fd_h2_conn_t` for connection management and `fd_h2_callbacks_t` for handling connection events. The test suite verifies the correct sequence of HTTP/2 frames during the handshake process and ensures that the client correctly handles server responses, including SETTINGS and SETTINGS ACK frames.

The code defines several static functions to test specific aspects of the HTTP/2 client behavior. The [`test_h2_client_handshake`](<#test_h2_client_handshake>) function simulates different handshake scenarios, checking the client's ability to initiate and respond to server settings. The [`test_h2_ping_tx`](<#test_h2_ping_tx>) function tests the client's ability to send and acknowledge ping frames, ensuring that the client correctly manages ping transmission limits and buffer space. The test suite uses assertions (`FD_TEST`) to validate expected outcomes, such as frame contents and connection state flags. The code is intended to be part of a larger test framework, as indicated by the inclusion of header files and the use of utility functions for buffer management and memory comparison.
# Imports and Dependencies

---
- `fd_h2_callback.h`
- `fd_h2_conn.h`
- `../../util/sanitize/fd_asan.h`
- `fd_h2_proto.h`


# Global Variables

---
### cb\_rec
- **Type**: ``test_h2_callback_rec_t``
- **Description**: Represents a structure that contains a counter for the number of times a connection is established in the HTTP/2 protocol test. The `cb_rec` variable is an instance of this structure and is used to track the number of established connections during testing.
- **Use**: Tracks the count of established connections by incrementing the `cb_established_cnt` field each time a connection is successfully established.


---
### test\_h2\_ping\_tx\_ack\_cnt
- **Type**: ``ulong``
- **Description**: `test_h2_ping_tx_ack_cnt` is a static global variable of type `ulong` initialized to 0. It counts the number of ping acknowledgments transmitted in the HTTP/2 connection tests.
- **Use**: Used to track the number of ping acknowledgments sent during the execution of the `test_h2_ping_tx` function.


# Data Structures

---
### test\_h2\_callback\_rec
- **Type**: ``struct``
- **Members**:
    - ``cb_established_cnt``: Counts the number of times a connection is established.
- **Description**: Tracks the number of established connections in an HTTP/2 context by maintaining a counter `cb_established_cnt` that increments each time a connection is successfully established.


---
### test\_h2\_callback\_rec\_t
- **Type**: ``struct``
- **Members**:
    - ``cb_established_cnt``: Counts the number of times a connection is established.
- **Description**: Holds a counter for the number of established connections, which is incremented each time a connection is successfully established through the `test_cb_conn_established` function.


# Functions

---
### test\_cb\_conn\_established<!-- {{#callable:test_cb_conn_established}} -->
[View Source →](<../../../../../src/waltz/h2/test_h2_conn.c#L14>)

Increments the `cb_established_cnt` counter in the `cb_rec` structure when a connection is established.
- **Inputs**:
    - ``conn``: A pointer to an `fd_h2_conn_t` structure representing the connection; it is not used in the function.
- **Logic and Control Flow**:
    - The function takes a single argument, `conn`, which is a pointer to an `fd_h2_conn_t` structure.
    - The function explicitly casts `conn` to void to indicate that it is unused.
    - The function increments the `cb_established_cnt` field of the `cb_rec` structure by 1.
- **Output**: No output is returned from this function.


---
### test\_h2\_client\_handshake<!-- {{#callable:test_h2_client_handshake}} -->
[View Source →](<../../../../../src/waltz/h2/test_h2_conn.c#L36>)

Tests the client-side HTTP/2 handshake process by simulating different handshake sequences and verifying the expected behavior.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize buffers `scratch`, `rbuf_rx_b`, and `rbuf_tx_b` for data handling.
    - Create and initialize an HTTP/2 connection object `conn` with specific settings for window size, frame size, header list size, and concurrent streams.
    - Initialize callback structure `cb` and set the `conn_established` callback to `test_cb_conn_established`.
    - Verify that the client initiates the connection with the `FD_H2_CONN_FLAGS_CLIENT_INITIAL` flag.
    - Initialize a transmit buffer `rbuf_tx` and send a control frame using [`fd_h2_tx_control`](<fd_h2_conn.c.md#fd_h2_tx_control>), then verify the buffer size and content against expected HTTP/2 preface and settings frame.
    - Check the connection flags for waiting settings and settings acknowledgment, and ensure the transmit buffer is empty after control frame transmission.
    - Simulate server sending SETTINGS and SETTINGS ACK frames, push them to receive buffer `rbuf_rx`, and process them with [`fd_h2_rx`](<fd_h2_conn.c.md#fd_h2_rx>).
    - Verify the acknowledgment frame content and update connection flags accordingly.
    - Repeat the handshake scenario with a different sequence where the server sends SETTINGS ACK before SETTINGS, and verify the connection establishment.
- **Output**: No output is returned; the function uses assertions (`FD_TEST`) to verify expected states and behaviors during the handshake process.
- **Functions Called**:
    - [`fd_h2_callbacks_init`](<fd_h2_callback.c.md#fd_h2_callbacks_init>)
    - [`fd_h2_tx_control`](<fd_h2_conn.c.md#fd_h2_tx_control>)
    - [`fd_h2_rbuf_used_sz`](<fd_h2_rbuf.h.md#fd_h2_rbuf_used_sz>)
    - [`fd_h2_rbuf_pop`](<fd_h2_rbuf.h.md#fd_h2_rbuf_pop>)
    - [`fd_h2_rbuf_push`](<fd_h2_rbuf.h.md#fd_h2_rbuf_push>)
    - [`fd_h2_rx`](<fd_h2_conn.c.md#fd_h2_rx>)


---
### test\_h2\_ping\_ack<!-- {{#callable:test_h2_ping_ack}} -->
[View Source →](<../../../../../src/waltz/h2/test_h2_conn.c#L182>)

Increments the `test_h2_ping_tx_ack_cnt` counter when a PING ACK is received.
- **Inputs**:
    - ``conn``: A pointer to an `fd_h2_conn_t` structure, representing the HTTP/2 connection. It is not used in the function body.
- **Logic and Control Flow**:
    - The function takes a single argument, `conn`, which is not used in the function body.
    - The function increments the global variable `test_h2_ping_tx_ack_cnt` by one.
- **Output**: No output is returned from this function.


---
### test\_h2\_ping\_tx<!-- {{#callable:test_h2_ping_tx}} -->
[View Source →](<../../../../../src/waltz/h2/test_h2_conn.c#L188>)

Tests the transmission and acknowledgment of HTTP/2 PING frames in a client connection.
- **Inputs**:
    - `void`: No input parameters.
- **Logic and Control Flow**:
    - Initialize a client HTTP/2 connection and set the maximum frame size.
    - Initialize callback structure and set the `ping_ack` callback to `test_h2_ping_ack`.
    - Initialize a transmission buffer `rbuf_tx` with a size of 128 bytes.
    - Test the scenario where there are too many pending pings by setting `conn->ping_tx` to `UCHAR_MAX` and verify that [`fd_h2_tx_ping`](<fd_h2_conn.c.md#fd_h2_tx_ping>) returns 0.
    - Test the scenario where the transmission buffer is full and verify that [`fd_h2_tx_ping`](<fd_h2_conn.c.md#fd_h2_tx_ping>) returns 0.
    - Test the scenario where there is exactly enough space for a ping in the buffer and verify that [`fd_h2_tx_ping`](<fd_h2_conn.c.md#fd_h2_tx_ping>) returns 1.
    - Parse the ping from the buffer and verify its header and payload values.
    - Create a PING ACK frame and push it to a reception buffer `rbuf_rx`.
    - Verify that the PING ACK callback is triggered by calling [`fd_h2_rx`](<fd_h2_conn.c.md#fd_h2_rx>) and checking the `test_h2_ping_tx_ack_cnt`.
    - Test that unsolicited PING ACKs are ignored by pushing another PING ACK to `rbuf_rx` and verifying that `test_h2_ping_tx_ack_cnt` does not increase.
- **Output**: No return value.
- **Functions Called**:
    - [`fd_h2_callbacks_init`](<fd_h2_callback.c.md#fd_h2_callbacks_init>)
    - [`fd_h2_tx_ping`](<fd_h2_conn.c.md#fd_h2_tx_ping>)
    - [`fd_h2_rbuf_push`](<fd_h2_rbuf.h.md#fd_h2_rbuf_push>)
    - [`fd_h2_rbuf_skip`](<fd_h2_rbuf.h.md#fd_h2_rbuf_skip>)
    - [`fd_h2_rbuf_pop_copy`](<fd_h2_rbuf.h.md#fd_h2_rbuf_pop_copy>)
    - [`fd_h2_frame_typlen`](<fd_h2_proto.h.md#fd_h2_frame_typlen>)
    - [`fd_h2_rx`](<fd_h2_conn.c.md#fd_h2_rx>)


---
### test\_h2\_conn<!-- {{#callable:test_h2_conn}} -->
[View Source →](<../../../../../src/waltz/h2/test_h2_conn.c#L254>)

Executes tests for HTTP/2 client handshake and ping transmission.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls [`test_h2_client_handshake`](<#test_h2_client_handshake>) to test various client-side handshake state logic, including different sequences of SETTINGS and SETTINGS ACK frames between client and server.
    - Calls [`test_h2_ping_tx`](<#test_h2_ping_tx>) to test the transmission of PING frames, handling of buffer space, and acknowledgment of PING frames.
- **Output**: No output is returned as the function is `void` and primarily used for testing purposes.
- **Functions Called**:
    - [`test_h2_client_handshake`](<#test_h2_client_handshake>)
    - [`test_h2_ping_tx`](<#test_h2_ping_tx>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)