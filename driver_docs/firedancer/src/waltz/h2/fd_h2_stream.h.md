<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

HTTP/2 stream state machine implementation with functions for stream lifecycle management.

# Purpose
The `fd_h2_stream.h` file defines the HTTP/2 stream state machine for managing the lifecycle and state transitions of HTTP/2 streams. It includes the definition of the `fd_h2_stream_t` structure, which holds the state information for a stream, such as `stream_id`, `tx_wnd` (transmit window), `rx_wnd` (receive window), and `state`. The file also defines several constants representing the possible states of a stream, such as `FD_H2_STREAM_STATE_IDLE`, `FD_H2_STREAM_STATE_OPEN`, and `FD_H2_STREAM_STATE_CLOSED`.

The file provides inline functions to manage stream state transitions, such as `fd_h2_stream_init`, [`fd_h2_stream_open`](<#fd_h2_stream_open>), [`fd_h2_stream_close_rx`](<#fd_h2_stream_close_rx>), and [`fd_h2_stream_close_tx`](<#fd_h2_stream_close_tx>). These functions handle the initialization, opening, and closing of streams, as well as error handling through functions like [`fd_h2_stream_error`](<#fd_h2_stream_error>) and [`fd_h2_rst_stream`](<#fd_h2_rst_stream>). The file also includes logic for handling received headers and data frames, updating the stream state accordingly. The header file is intended to be included in other parts of the HTTP/2 implementation, providing a consistent interface for stream management.
# Imports and Dependencies

---
- `fd_h2_base.h`
- `fd_h2_proto.h`
- `fd_h2_conn.h`


# Data Structures

---
### fd\_h2\_stream
- **Type**: ``struct``
- **Members**:
    - `stream_id`: Unique identifier for the stream.
    - `tx_wnd`: Transmit quota available for the stream.
    - `rx_wnd`: Receive window bytes remaining for the stream.
    - `state`: Current state of the stream.
    - `hdrs_seq`: Sequence number for headers received.
- **Description**: Manages the state of an HTTP/2 stream, including its unique identifier, transmit and receive window sizes, current state, and header sequence number. It is part of the HTTP/2 stream state machine, which handles transitions between different stream states such as 'IDLE', 'OPEN', 'CLOSING_TX', 'CLOSING_RX', and 'CLOSED'.


# Functions

---
### fd\_h2\_stream\_open<!-- {{#callable:fd_h2_stream_open}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_stream.h#L44>)

Transitions a stream from 'IDLE' to 'OPEN' state and initializes its parameters.
- **Inputs**:
    - `stream`: A pointer to an `fd_h2_stream_t` structure that represents the stream to open.
    - `conn`: A pointer to an `fd_h2_conn_t` structure that represents the connection associated with the stream.
    - `stream_id`: An unsigned integer representing the unique identifier for the stream.
- **Logic and Control Flow**:
    - Assigns the `stream_id` to the `stream` structure.
    - Sets the `state` of the `stream` to `FD_H2_STREAM_STATE_OPEN`.
    - Initializes the `tx_wnd` (transmit window) of the `stream` using the `initial_window_size` from `conn->peer_settings`.
    - Initializes the `rx_wnd` (receive window) of the `stream` using the `initial_window_size` from `conn->self_settings`.
    - Sets the `hdrs_seq` (headers sequence) of the `stream` to 0.
    - Increments the `stream_active_cnt` for the connection based on the parity of `stream_id` and `conn->rx_stream_id`.
- **Output**: Returns a pointer to the initialized `fd_h2_stream_t` structure.


---
### fd\_h2\_stream\_error<!-- {{#callable:fd_h2_stream_error}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_stream.h#L59>)

Handles an HTTP/2 stream error by sending a reset stream frame and transitioning the stream state to closed.
- **Inputs**:
    - ``stream``: A pointer to an `fd_h2_stream_t` structure representing the HTTP/2 stream that encountered an error.
    - ``rbuf_tx``: A pointer to an `fd_h2_rbuf_t` structure used for transmitting the reset stream frame.
    - ``h2_err``: An unsigned integer representing the HTTP/2 error code to be sent in the reset stream frame.
- **Logic and Control Flow**:
    - Calls the [`fd_h2_tx_rst_stream`](<fd_h2_conn.h.md#fd_h2_tx_rst_stream>) function with `rbuf_tx`, `stream->stream_id`, and `h2_err` to send a reset stream frame.
    - Sets the `state` of the `stream` to `FD_H2_STREAM_STATE_CLOSED`.
- **Output**: No return value; the function modifies the state of the `stream` and sends a reset stream frame.
- **Functions Called**:
    - [`fd_h2_tx_rst_stream`](<fd_h2_conn.h.md#fd_h2_tx_rst_stream>)


---
### fd\_h2\_stream\_private\_deactivate<!-- {{#callable:fd_h2_stream_private_deactivate}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_stream.h#L77>)

Decrements the active stream count for a specific stream type in the connection.
- **Inputs**:
    - `stream`: A pointer to an `fd_h2_stream_t` structure representing the HTTP/2 stream.
    - `conn`: A pointer to an `fd_h2_conn_t` structure representing the HTTP/2 connection.
- **Logic and Control Flow**:
    - Calculate the index for the `stream_active_cnt` array using the expression `(stream->stream_id&1) ^ (conn->rx_stream_id&1)`.
    - Decrement the value at the calculated index in the `conn->stream_active_cnt` array by 1.
- **Output**: No return value; the function modifies the `conn->stream_active_cnt` array in place.


---
### fd\_h2\_stream\_close\_rx<!-- {{#callable:fd_h2_stream_close_rx}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_stream.h#L83>)

Transitions the state of an HTTP/2 stream to handle the closure of the receive side.
- **Inputs**:
    - ``stream``: A pointer to an `fd_h2_stream_t` structure representing the HTTP/2 stream whose receive side is to be closed.
    - ``conn``: A pointer to an `fd_h2_conn_t` structure representing the connection associated with the stream.
- **Logic and Control Flow**:
    - Checks the current state of the stream using a switch statement.
    - If the stream is in the `FD_H2_STREAM_STATE_OPEN` state, changes the state to `FD_H2_STREAM_STATE_CLOSING_RX`.
    - If the stream is in the `FD_H2_STREAM_STATE_CLOSING_TX` state, changes the state to `FD_H2_STREAM_STATE_CLOSED` and calls [`fd_h2_stream_private_deactivate`](<#fd_h2_stream_private_deactivate>) to update the connection's active stream count.
    - For any other state, sets the stream state to `FD_H2_STREAM_STATE_ILLEGAL`.
- **Output**: No return value; the function modifies the state of the `stream` in place.
- **Functions Called**:
    - [`fd_h2_stream_private_deactivate`](<#fd_h2_stream_private_deactivate>)


---
### fd\_h2\_stream\_close\_tx<!-- {{#callable:fd_h2_stream_close_tx}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_stream.h#L100>)

Transitions the state of an HTTP/2 stream to closing or closed based on its current state.
- **Inputs**:
    - `stream`: A pointer to an `fd_h2_stream_t` structure representing the HTTP/2 stream whose state is to be modified.
    - `conn`: A pointer to an `fd_h2_conn_t` structure representing the connection associated with the stream.
- **Logic and Control Flow**:
    - Check the current state of the stream using a switch statement.
    - If the stream state is `FD_H2_STREAM_STATE_OPEN`, set the state to `FD_H2_STREAM_STATE_CLOSING_TX`.
    - If the stream state is `FD_H2_STREAM_STATE_CLOSING_RX`, set the state to `FD_H2_STREAM_STATE_CLOSED` and call [`fd_h2_stream_private_deactivate`](<#fd_h2_stream_private_deactivate>) to update the connection's active stream count.
    - For any other state, set the stream state to `FD_H2_STREAM_STATE_ILLEGAL`.
- **Output**: No return value; the function modifies the state of the `stream` in place.
- **Functions Called**:
    - [`fd_h2_stream_private_deactivate`](<#fd_h2_stream_private_deactivate>)


---
### fd\_h2\_stream\_reset<!-- {{#callable:fd_h2_stream_reset}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_stream.h#L117>)

Transitions the state of an HTTP/2 stream to 'CLOSED' or 'ILLEGAL' based on its current state.
- **Inputs**:
    - `stream`: A pointer to an `fd_h2_stream_t` structure representing the HTTP/2 stream to reset.
    - `conn`: A pointer to an `fd_h2_conn_t` structure representing the connection associated with the stream.
- **Logic and Control Flow**:
    - Check the current state of the stream using a switch statement.
    - If the stream is in `FD_H2_STREAM_STATE_OPEN`, `FD_H2_STREAM_STATE_CLOSING_TX`, or `FD_H2_STREAM_STATE_CLOSING_RX`, set the stream's state to `FD_H2_STREAM_STATE_CLOSED`.
    - Call [`fd_h2_stream_private_deactivate`](<#fd_h2_stream_private_deactivate>) to update the connection's active stream count.
    - If the stream is in any other state, set the stream's state to `FD_H2_STREAM_STATE_ILLEGAL`.
- **Output**: The function does not return a value; it modifies the state of the `stream` in place.
- **Functions Called**:
    - [`fd_h2_stream_private_deactivate`](<#fd_h2_stream_private_deactivate>)


---
### fd\_h2\_stream\_rx\_headers<!-- {{#callable:fd_h2_stream_rx_headers}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_stream.h#L133>)

Handles the reception of HTTP/2 headers for a stream and updates the stream state and header sequence accordingly.
- **Inputs**:
    - `stream`: A pointer to an `fd_h2_stream_t` structure representing the HTTP/2 stream.
    - `conn`: A pointer to an `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - `flags`: An unsigned long integer representing flags that indicate the end of stream or headers.
- **Logic and Control Flow**:
    - If the stream state is `FD_H2_STREAM_STATE_IDLE`, set the stream state to `FD_H2_STREAM_STATE_OPEN`.
    - If the `FD_H2_FLAG_END_STREAM` flag is set, call [`fd_h2_stream_close_rx`](<#fd_h2_stream_close_rx>) to close the receive side of the stream.
    - If the `FD_H2_FLAG_END_HEADERS` flag is set, increment the `hdrs_seq` field of the stream.
- **Output**: No return value; the function modifies the state of the `stream` and potentially the `conn`.
- **Functions Called**:
    - [`fd_h2_stream_close_rx`](<#fd_h2_stream_close_rx>)


---
### fd\_h2\_stream\_rx\_data<!-- {{#callable:fd_h2_stream_rx_data}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_stream.h#L149>)

Handles the reception of data frames for an HTTP/2 stream and closes the receive side if the END_STREAM flag is set.
- **Inputs**:
    - `stream`: A pointer to an `fd_h2_stream_t` structure representing the HTTP/2 stream.
    - `conn`: A pointer to an `fd_h2_conn_t` structure representing the HTTP/2 connection.
    - `flags`: An unsigned long integer representing flags associated with the data frame, such as `FD_H2_FLAG_END_STREAM`.
- **Logic and Control Flow**:
    - Checks if the `flags` parameter has the `FD_H2_FLAG_END_STREAM` bit set.
    - If the `FD_H2_FLAG_END_STREAM` bit is set, calls [`fd_h2_stream_close_rx`](<#fd_h2_stream_close_rx>) to close the receive side of the stream.
- **Output**: No direct output; modifies the state of the `stream` object if the END_STREAM flag is set.
- **Functions Called**:
    - [`fd_h2_stream_close_rx`](<#fd_h2_stream_close_rx>)


# Function Declarations (Public API)

---
### fd\_h2\_rst\_stream<!-- {{#callable_declaration:fd_h2_rst_stream}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_stream.h#L72>)

Generates a RST_STREAM frame and closes the stream.
- **Description**: Use this function to send a RST_STREAM frame on a specified HTTP/2 stream, transitioning the stream to the CLOSED state. This function should be called when an error occurs, or when it is necessary to terminate a stream prematurely. After calling this function, the stream object and its map entry can be discarded, and the active stream count in the connection is decremented. Ensure that the stream is valid and associated with the given connection before calling this function.
- **Inputs**:
    - `conn`: A pointer to an `fd_h2_conn_t` object representing the connection associated with the stream. Must not be null.
    - `rbuf_tx`: A pointer to an `fd_h2_rbuf_t` object used for transmitting the RST_STREAM frame. Must not be null.
    - `stream`: A pointer to an `fd_h2_stream_t` object representing the stream to reset. Must not be null and should be in a valid state for resetting.
- **Output**: None
- **See Also**: [`fd_h2_rst_stream`](<fd_h2_proto.h.md#fd_h2_rst_stream>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)