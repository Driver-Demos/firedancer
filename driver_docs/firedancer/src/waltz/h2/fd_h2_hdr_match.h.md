<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Utilities for building lookup tables for HTTP header names, including functions for initialization, insertion, and querying.

# Purpose
The `fd_h2_hdr_match.h` file provides utilities for creating and managing lookup tables for HTTP header names. It is a C header file that defines structures and functions to facilitate the mapping of HTTP/2 header names to unique identifiers. The primary purpose of this code is to enable efficient lookup and matching of HTTP header names using a hash table. This is particularly useful in scenarios where headers are frequently accessed or modified, such as in HTTP/2 implementations where headers can be referred to by table indices to save space.

The file defines several key components, including the `fd_h2_hdr_match_key` and `fd_h2_hdr_match_entry` structures, which represent the keys and entries in the hash table, respectively. The `fd_h2_hdr_matcher` structure is used to build and manage the hash table, allowing users to initialize, insert, and query header names. The code also includes predefined constants for common HTTP headers, which are used to initialize the matcher with standard header names. The functions [`fd_h2_hdr_matcher_init`](<#fd_h2_hdr_matcher_init>), [`fd_h2_hdr_matcher_fini`](<#fd_h2_hdr_matcher_fini>), and [`fd_h2_hdr_matcher_insert`](<#fd_h2_hdr_matcher_insert>) provide the main interface for interacting with the matcher, allowing users to set up the hash table, add custom headers, and perform lookups.
# Imports and Dependencies

---
- `../../ballet/siphash13/fd_siphash13.h`
- `fd_hpack.h`
- `../../util/tmpl/fd_map.c`


# Global Variables

---
### fd\_h2\_hdr\_match\_entry\_null
- **Type**: ``fd_h2_hdr_match_entry_t const``
- **Description**: Represents a constant entry in the HTTP/2 header match table with default or null values. It is used as a placeholder or sentinel value in the hash table operations.
- **Use**: Used as a default or null entry in the header match table to indicate an empty or uninitialized slot.


---
### fd\_h2\_hdr\_match\_seed
- **Type**: ``ulong``
- **Description**: `fd_h2_hdr_match_seed` is an external global variable of type `ulong` used as a seed for hash functions in the HTTP/2 header matching process. It is part of the utilities for building lookup tables for HTTP header names.
- **Use**: Used to permute the hash function for header name strings in the `fd_h2_hdr_match` function.


---
### fd\_h2\_hpack\_matcher
- **Type**: `schar const`
- **Description**: Maps HPACK static table indices to common header IDs. HTTP/2 uses HPACK to refer to common header names by table indices instead of literal strings to save space.
- **Use**: Used to map predefined HPACK indices in the range [1,61] to corresponding header IDs.


# Data Structures

---
### fd\_h2\_hdr\_match\_key
- **Type**: ``struct``
- **Members**:
    - `hdr`: Pointer to a constant character string representing the header name.
    - `hdr_len`: Unsigned short integer representing the length of the header name.
- **Description**: Defines a packed structure used as a key in a hash table for matching HTTP/2 header names to their corresponding IDs. The structure contains a pointer to the header name and its length, facilitating efficient comparison and lookup operations.


---
### fd\_h2\_hdr\_match\_key\_t
- **Type**: ``struct``
- **Members**:
    - ``hdr``: Pointer to a constant character string representing the header name.
    - ``hdr_len``: Unsigned short integer representing the length of the header name.
- **Description**: Defines a key for matching HTTP/2 header names in a hash table, consisting of a pointer to the header name and its length.


---
### fd\_h2\_hdr\_match\_entry
- **Type**: ``struct``
- **Members**:
    - `key`: Stores the header name and its length.
    - `id`: Represents a short integer identifier for the header.
    - `hash`: Contains a hash value for the header.
- **Description**: Defines an entry in a hash table used for matching HTTP/2 header names to their corresponding identifiers. The `key` member holds the header name and its length, the `id` is a short integer that serves as an identifier, and the `hash` is a computed hash value for efficient lookup.


---
### fd\_h2\_hdr\_match\_entry\_t
- **Type**: ``struct``
- **Members**:
    - `key`: Contains the header name and its length.
    - `id`: Stores an identifier for the header.
    - `hash`: Holds the hash value of the header name.
- **Description**: Defines an entry in a hash table that maps HTTP header names to arbitrary IDs. Each entry consists of a key, which includes the header name and its length, an ID that represents the header, and a hash value for efficient lookup.


---
### fd\_h2\_hdr\_matcher
- **Type**: ``struct``
- **Members**:
    - `entry`: An array of `fd_h2_hdr_match_entry_t` used to store header entries in the hash table.
    - `seed`: A 64-bit value used to permute the hash function for the matcher.
    - `entry_cnt`: The count of entries in the matcher, excluding HPACK entries.
- **Description**: Facilitates the creation of a hash table for HTTP header names, allowing for efficient lookup and mapping of header names to user-defined IDs. It is designed for use with static lists of headers and should not be used for arbitrary entries. The structure includes an array for storing header entries, a seed for hash function permutation, and a count of entries excluding HPACK entries.


---
### fd\_h2\_hdr\_matcher\_t
- **Type**: ``struct``
- **Members**:
    - `entry`: An array of `fd_h2_hdr_match_entry_t` used to store header entries in the hash table.
    - `seed`: A 64-bit value used to permute the hash function.
    - `entry_cnt`: The count of entries in the hash table, excluding HPACK entries.
- **Description**: Facilitates the creation of a hash table for HTTP header names, allowing for efficient lookup and mapping of header names to user-defined IDs. It is designed for static lists of headers and should not be used for arbitrary entries. The structure includes an array for storing header entries, a seed for hash function permutation, and a count of entries excluding HPACK entries.


# Functions

---
### fd\_h2\_hdr\_match\_key\_eq<!-- {{#callable:fd_h2_hdr_match_key_eq}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_hdr_match.h#L37>)

Compares two HTTP/2 header match keys for equality based on their length and content.
- **Inputs**:
    - `k1`: The first header match key to compare, containing a pointer to the header string and its length.
    - `k2`: The second header match key to compare, containing a pointer to the header string and its length.
- **Logic and Control Flow**:
    - Check if the `hdr_len` of `k1` is equal to the `hdr_len` of `k2`.
    - If the lengths are equal, use `fd_memeq` to compare the header strings `hdr` of `k1` and `k2` for equality over the length `hdr_len`.
    - Return the result of the logical AND operation between the length comparison and the string comparison.
- **Output**: Returns an integer that is non-zero if both the length and content of the headers are equal, otherwise returns zero.


---
### fd\_h2\_hdr\_match<!-- {{#callable:fd_h2_hdr_match}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_hdr_match.h#L151>)

Matches an HTTP/2 header name against a predefined set of headers and returns the corresponding ID.
- **Inputs**:
    - `matcher`: A pointer to an `fd_h2_hdr_matcher_t` structure containing the header map and seed.
    - `name`: A pointer to a character array representing the header name to match.
    - `name_len`: The length of the header name.
    - `hpack_hint`: A hint value that may contain an index for HPACK static table lookup.
- **Logic and Control Flow**:
    - Check if `hpack_hint` indicates a name indexed in the HPACK static table.
    - If indexed, extract the index and return the corresponding ID from `fd_h2_hpack_matcher` if the index is valid (1 to 61).
    - If `name_len` is zero, return 0 indicating an unknown header.
    - Set `fd_h2_hdr_match_seed` to the matcher's seed value.
    - Create a `fd_h2_hdr_match_key_t` with the header name and length.
    - Query the header map using `fd_h2_hdr_map_query_const` with the key and return the ID from the resulting entry.
- **Output**: An integer representing the header ID: zero for unknown headers, negative for HTTP/2 built-in names, or positive for custom headers.


# Function Declarations (Public API)

---
### fd\_h2\_hdr\_matcher\_init<!-- {{#callable_declaration:fd_h2_hdr_matcher_init}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_hdr_match.h#L107>)

Initializes a matcher object for HTTP header names.
- **Description**: Use this function to initialize a matcher object that maps HTTP header names to IDs. The function requires a memory region that is properly aligned and sized for `fd_h2_hdr_matcher_t`. The `seed` parameter is used to permute the hash function, typically set using a secure random number generator at application startup. The matcher is pre-populated with common HTTP headers, which have negative IDs. Ensure that the memory region is not null and is correctly aligned before calling this function.
- **Inputs**:
    - `mem`: A pointer to a memory region that must be aligned to `alignof(fd_h2_hdr_matcher_t)` and have a size of `sizeof(fd_h2_hdr_matcher_t)`. Must not be null. If null or misaligned, the function returns null.
    - `seed`: An arbitrary 64-bit value used to permute the hash function. Typically chosen using a secure random number generator.
- **Output**: Returns a pointer to the initialized `fd_h2_hdr_matcher_t` object, or null if the memory is null or misaligned.
- **See Also**: [`fd_h2_hdr_matcher_init`](<fd_h2_hdr_match.c.md#fd_h2_hdr_matcher_init>)  (Implementation)


---
### fd\_h2\_hdr\_matcher\_fini<!-- {{#callable_declaration:fd_h2_hdr_matcher_fini}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_hdr_match.h#L114>)

Releases resources associated with a matcher object.
- **Description**: Use this function to finalize a matcher object and release any resources it uses. This function should be called when the matcher is no longer needed, and it returns the underlying buffer back to the caller. Ensure that the matcher object is valid and initialized before calling this function to avoid undefined behavior.
- **Inputs**:
    - `matcher`: A pointer to a `fd_h2_hdr_matcher_t` object. The matcher must be valid and initialized. The function does not perform any checks on the validity of the pointer, so passing a null or invalid pointer results in undefined behavior.
- **Output**: Returns the underlying buffer associated with the matcher object back to the caller.
- **See Also**: [`fd_h2_hdr_matcher_fini`](<fd_h2_hdr_match.c.md#fd_h2_hdr_matcher_fini>)  (Implementation)


---
### fd\_h2\_hdr\_matcher\_insert<!-- {{#callable_declaration:fd_h2_hdr_matcher_insert}} -->
[View Source →](<../../../../../src/waltz/h2/fd_h2_hdr_match.h#L130>)

Adds a custom header name to the matcher.
- **Description**: Use this function to add a custom header name to a matcher object, allowing subsequent queries with the same name to return the specified ID. Ensure that the `id` is within the range [1, 32767] and that the `name_len` is within [1, 65535]. The function will abort the application with an error log if these constraints are violated or if the matcher already contains the maximum number of entries. The `name` must have a static lifetime and be in lowercase.
- **Inputs**:
    - `matcher`: A pointer to an `fd_h2_hdr_matcher_t` object. The caller must ensure this is a valid, initialized matcher.
    - `id`: An integer representing the ID to associate with the header name. Must be in the range [1, 32767]. The function aborts if the value is out of bounds.
    - `name`: A pointer to a character array representing the header name. The name must have a static lifetime and be in lowercase. The function does not check for null termination.
    - `name_len`: An unsigned long indicating the length of the header name. Must be in the range [1, 65535]. The function aborts if the value is out of bounds.
- **Output**: None
- **See Also**: [`fd_h2_hdr_matcher_insert`](<fd_h2_hdr_match.c.md#fd_h2_hdr_matcher_insert>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)