<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines a token bucket structure and a function to consume tokens based on elapsed time and rate.

# Purpose
The code defines a C header file for a token bucket rate-limiting mechanism. It provides a data structure and a function to manage and consume tokens from a token bucket. The `fd_token_bucket` structure contains fields for tracking the timestamp (`ts`), the rate at which tokens are added (`rate`), the maximum number of tokens that can be accumulated (`burst`), and the current number of tokens available (`balance`). The [`fd_token_bucket_consume`](<#fd_token_bucket_consume>) function is an inline function that refills the token bucket based on the elapsed time and attempts to consume a specified number of tokens (`delta`). If there are enough tokens available, it deducts the tokens and updates the bucket's state.

This header file is intended to be included in other C source files that require token bucket rate-limiting functionality. It does not define a public API or external interface but provides a static inline function for internal use. The use of `FD_PROTOTYPES_BEGIN` and `FD_PROTOTYPES_END` suggests a macro-based approach to manage function prototypes, which is common in C projects to ensure compatibility and maintainability. The inclusion of `fd_util_base.h` and `<math.h>` indicates dependencies on utility functions and mathematical operations, respectively.
# Imports and Dependencies

---
- `../util/fd_util_base.h`
- `math.h`


# Data Structures

---
### fd\_token\_bucket
- **Type**: ``struct``
- **Members**:
    - ``ts``: Stores the timestamp of the last token bucket update.
    - ``rate``: Defines the rate at which tokens are added to the bucket.
    - ``burst``: Specifies the maximum number of tokens the bucket can hold.
    - ``balance``: Holds the current number of tokens available in the bucket.
- **Description**: Manages a token bucket for rate limiting, where tokens are added over time at a specified rate and can be consumed up to a burst limit.


---
### fd\_token\_bucket\_t
- **Type**: ``struct``
- **Members**:
    - ``ts``: Stores the timestamp of the last token bucket update.
    - ``rate``: Defines the rate at which tokens are added to the bucket.
    - ``burst``: Specifies the maximum number of tokens the bucket can hold.
    - ``balance``: Holds the current number of tokens available in the bucket.
- **Description**: Manages a token bucket for rate limiting, with fields for tracking the last update time, token refill rate, maximum token capacity, and current token balance.


# Functions

---
### fd\_token\_bucket\_consume<!-- {{#callable:fd_token_bucket_consume}} -->
[View Source →](<../../../../src/waltz/fd_token_bucket.h#L16>)

Consumes tokens from a token bucket if sufficient balance is available, updating the bucket's state.
- **Inputs**:
    - ``bucket``: A pointer to an `fd_token_bucket_t` structure representing the token bucket to consume tokens from.
    - ``delta``: A `float` representing the number of tokens to consume.
    - ``ts``: A `long` integer representing the current timestamp.
- **Logic and Control Flow**:
    - Calculate the elapsed time since the last update by subtracting `bucket->ts` from `ts`.
    - Refill the token bucket by adding the product of `elapsed` and `bucket->rate` to `bucket->balance`.
    - Limit the `balance` to a maximum of `bucket->burst` using `fminf`.
    - Check if `delta` tokens can be consumed by comparing `delta` to `balance`.
    - If `delta` is less than or equal to `balance`, subtract `delta` from `balance`.
    - Update `bucket->balance` and `bucket->ts` with the new `balance` and `ts`, respectively.
    - Return `1` if tokens were successfully consumed, otherwise return `0`.
- **Output**: Returns an `int` indicating whether the token consumption was successful (`1` for success, `0` for failure).



---
Made with ❤️ by [Driver](https://www.driver.ai/)