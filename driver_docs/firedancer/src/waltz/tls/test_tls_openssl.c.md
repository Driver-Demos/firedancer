<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests the handshake between an OpenSSL client and an fd_tls server using various cryptographic operations and callbacks.

# Purpose
The code is a C program designed to test the interoperability between an OpenSSL client and an `fd_tls` server, as well as an `fd_tls` client and an OpenSSL server. It uses OpenSSL for handling TLS (Transport Layer Security) operations and includes several components to facilitate the handshake process between the client and server. The program includes functions to set up and manage TLS handshakes, handle encryption levels, and manage transport parameters for QUIC (Quick UDP Internet Connections) protocol. The code is structured to perform tests by simulating both client and server roles, ensuring that the handshake process completes successfully in both directions.

The program includes several key components: it defines mappings between OpenSSL and `fd_tls` encryption levels, manages secrets for encryption, and handles the sending and receiving of cryptographic records. It also sets up Ed25519 keys and certificates for secure communication. The main function initializes the OpenSSL context, configures TLS settings, and runs tests for both server and client scenarios. The code uses various OpenSSL callbacks to handle events during the TLS handshake process, such as logging information and handling alerts. The program is intended to be executed as a standalone application, as indicated by the presence of the [`main`](<#main>) function, which orchestrates the setup and execution of the tests.
# Imports and Dependencies

---
- `fd_tls.h`
- `fd_tls_proto.h`
- `../../ballet/ed25519/fd_ed25519.h`
- `../../ballet/ed25519/fd_x25519.h`
- `../../ballet/x509/fd_x509_mock.h`
- `../quic/fd_quic_common.h`
- `../quic/templ/fd_quic_transport_params.h`
- `openssl/ssl.h`
- `openssl/evp.h`
- `openssl/err.h`
- `openssl/tls1.h`
- `openssl/core_dispatch.h`
- `test_tls_helper.h`


# Global Variables

---
### \_is\_ossl\_to\_fd
- **Type**: ``uchar``
- **Description**: The `_is_ossl_to_fd` variable is a static unsigned character (`uchar`) initialized to 0. It is used to indicate the direction of data flow between OpenSSL and fd_tls.
- **Use**: Used to track whether the data flow is from OpenSSL to fd_tls or vice versa.


---
### \_ossl\_level\_to\_fdtls
- **Type**: ``uint const[]``
- **Description**: Maps OpenSSL record protection levels to corresponding fd_tls encryption levels. The array uses OpenSSL protection level constants as indices to retrieve the corresponding fd_tls level.
- **Use**: Used to convert OpenSSL encryption levels to fd_tls levels during the TLS handshake process.


---
### tp\_buf
- **Type**: ``uchar const[]``
- **Description**: A constant array of unsigned characters initialized with the values `{ 0x01, 0x02, 0x47, 0xd0 }`. This array is used to store hardcoded QUIC transport parameters.
- **Use**: Used to verify and set QUIC transport parameters in the TLS handshake process.


---
### secret
- **Type**: ``static uchar``
- **Description**: The `secret` variable is a static array of unsigned characters with dimensions `[32UL][2][4][2]`, initialized to zero. It is used to store cryptographic secrets during the TLS handshake process.
- **Use**: Stores cryptographic secrets for different encryption levels and directions during the TLS handshake.


---
### \_ossl\_send\_level
- **Type**: ``uint``
- **Description**: Tracks the current OpenSSL encryption level for sending data. It is initialized to `FD_TLS_LEVEL_INITIAL` and updated during the handshake process when a write secret is received.
- **Use**: Used to determine the encryption level for sending data in the `_ossl_crypto_send` function.


---
### \_ossl\_out
- **Type**: ``test_record_buf_t``
- **Description**: The `_ossl_out` variable is a static instance of the `test_record_buf_t` structure, initialized to zero. It is used to store and manage outgoing data records in the context of OpenSSL operations.
- **Use**: Tracks outgoing data records for OpenSSL operations.


---
### \_fdtls\_out
- **Type**: ``test_record_buf_t``
- **Description**: The `_fdtls_out` variable is a static instance of the `test_record_buf_t` structure, initialized to zero. It is used to store and manage records for the fd_tls protocol during testing.
- **Use**: Stores records for the fd_tls protocol to facilitate testing of the OpenSSL client to fd_tls server handshake.


---
### quic\_method
- **Type**: ``OSSL_DISPATCH[]``
- **Description**: An array of `OSSL_DISPATCH` structures that define a set of function pointers for handling QUIC TLS operations. Each entry in the array associates a specific QUIC TLS function identifier with a corresponding function implementation.
- **Use**: Used to set up QUIC TLS callbacks in OpenSSL for handling various QUIC-related operations such as sending and receiving crypto frames, yielding secrets, and handling alerts.


# Functions

---
### \_ossl\_yield\_secret<!-- {{#callable:_ossl_yield_secret}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_openssl.c#L48>)

Stores a 32-byte secret at a specified encryption level and direction, and updates the current send encryption level if the direction is write.
- **Inputs**:
    - `ssl`: A pointer to an `SSL` structure, which is not used in this function.
    - `enc_level`: A `uint32_t` representing the encryption level, used to index into `_ossl_level_to_fdtls` to get the corresponding level.
    - `direction`: An integer indicating the direction of the secret (0 for read, 1 for write).
    - `secret_data`: A pointer to a constant unsigned character array containing the secret data to be stored.
    - `secret_len`: An unsigned long representing the length of the secret data, expected to be 32.
    - `arg`: A pointer to a void type, which is not used in this function.
- **Logic and Control Flow**:
    - The function first checks if `secret_len` is 32 using `FD_TEST` macro.
    - It maps the `enc_level` to a corresponding level using the `_ossl_level_to_fdtls` array.
    - Copies the `secret_data` into the `secret` array at the position determined by `level` and `direction`.
    - If `direction` is 1 (write), it updates `_ossl_send_level` to the current `level`.
    - Returns 1 to indicate success.
- **Output**: Returns an integer value 1, indicating successful execution.


---
### \_fdtls\_secrets<!-- {{#callable:_fdtls_secrets}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_openssl.c#L69>)

Stores the received and sent secrets for a given encryption level in a static array.
- **Inputs**:
    - `handshake`: A pointer to the handshake data, which is not used in this function.
    - `recv_secret`: A pointer to the received secret data, expected to be 32 bytes long.
    - `send_secret`: A pointer to the sent secret data, expected to be 32 bytes long.
    - `encryption_level`: An unsigned integer representing the encryption level at which the secrets are stored.
- **Logic and Control Flow**:
    - The function casts the `handshake` parameter to void to indicate it is unused.
    - Copies 32 bytes from `recv_secret` to the `secret` array at the index corresponding to the given `encryption_level` and direction 0 (receive).
    - Copies 32 bytes from `send_secret` to the `secret` array at the index corresponding to the given `encryption_level` and direction 1 (send).
- **Output**: No return value; the function operates by side effect, modifying the `secret` array.


---
### \_ossl\_crypto\_send<!-- {{#callable:_ossl_crypto_send}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_openssl.c#L84>)

Sends CRYPTO frame data using OpenSSL and tracks the current encryption level.
- **Inputs**:
    - ``ssl``: A pointer to an `SSL` structure, which is not used in this function.
    - ``buf``: A pointer to the buffer containing the data to send.
    - ``buf_len``: The length of the data in the buffer.
    - ``consumed``: A pointer to a `ulong` where the function will store the number of bytes consumed, which is set to `buf_len`.
    - ``arg``: A pointer to additional arguments, which is not used in this function.
- **Logic and Control Flow**:
    - Logs the CRYPTO frame data using [`test_record_log`](<test_tls_helper.h.md#test_record_log>) with the buffer, its length, and a direction flag.
    - Sends the CRYPTO frame data using [`test_record_send`](<test_tls_helper.h.md#test_record_send>) with the output buffer, current encryption level, buffer, and its length.
    - Sets the `consumed` value to the length of the buffer (`buf_len`).
    - Returns 1 to indicate success.
- **Output**: Returns an integer value of 1 to indicate successful execution.
- **Functions Called**:
    - [`test_record_log`](<test_tls_helper.h.md#test_record_log>)
    - [`test_record_send`](<test_tls_helper.h.md#test_record_send>)


---
### \_ossl\_crypto\_recv\_rcd<!-- {{#callable:_ossl_crypto_recv_rcd}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_openssl.c#L99>)

Receives a record from the `_fdtls_out` buffer and updates the buffer pointer and bytes read.
- **Inputs**:
    - `ssl`: A pointer to an `SSL` structure, which is not used in this function.
    - `buf`: A pointer to a pointer to an `uchar` where the function will store the address of the received data buffer.
    - `bytes_read`: A pointer to an `ulong` where the function will store the number of bytes read.
    - `arg`: A pointer to a generic argument, which is not used in this function.
- **Logic and Control Flow**:
    - Calls `test_record_recv` with `_fdtls_out` to receive a record.
    - Checks if the received record is `NULL`.
    - If the record is `NULL`, sets `*buf` to `NULL`, `*bytes_read` to 0, and returns 1 to indicate no data is available and a retry is needed.
    - If a record is received, logs the first byte of the record buffer for debugging.
    - Sets `*buf` to point to the record's buffer and `*bytes_read` to the current size of the record.
    - Returns 1 to indicate success and that data is available.
- **Output**: Returns 1 to indicate success, with `*bytes_read` set to 0 if no data is available, or greater than 0 if data is available.


---
### \_ossl\_crypto\_release\_rcd<!-- {{#callable:_ossl_crypto_release_rcd}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_openssl.c#L118>)

Acknowledges the read operation in a test environment.
- **Inputs**:
    - ``ssl``: A pointer to an `SSL` structure, representing the SSL connection.
    - ``bytes_read``: An unsigned long integer representing the number of bytes read.
    - ``arg``: A pointer to additional arguments, not used in this function.
- **Logic and Control Flow**:
    - The function takes three parameters: `ssl`, `bytes_read`, and `arg`, but does not use them.
    - The function acknowledges the read operation by returning 1.
- **Output**: Returns an integer value of 1, indicating success or acknowledgment of the read operation.


---
### \_ossl\_got\_transport\_params<!-- {{#callable:_ossl_got_transport_params}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_openssl.c#L127>)

Validates that the provided transport parameters match a predefined buffer.
- **Inputs**:
    - ``ssl``: A pointer to an `SSL` structure, which is not used in this function.
    - ``params``: A pointer to an array of unsigned characters representing the transport parameters to validate.
    - ``params_len``: An unsigned long integer representing the length of the `params` array.
    - ``arg``: A pointer to additional arguments, which is not used in this function.
- **Logic and Control Flow**:
    - Ignore the `ssl` and `arg` parameters by casting them to void.
    - Check if `params_len` is equal to 4 using `FD_TEST`.
    - Compare the first 4 bytes of `params` with the predefined buffer `tp_buf` using `memcmp`.
    - Return 1 if both checks pass.
- **Output**: Returns 1 if the length of `params` is 4 and its content matches `tp_buf`; otherwise, the function does not return a different value.


---
### \_ossl\_alert<!-- {{#callable:_ossl_alert}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_openssl.c#L138>)

Logs an alert message with the given alert code and prints any OpenSSL errors to standard error.
- **Inputs**:
    - ``ssl``: A pointer to an `SSL` structure, which is not used in this function.
    - ``alert_code``: An unsigned character representing the alert code to log.
    - ``arg``: A pointer to additional arguments, which is not used in this function.
- **Logic and Control Flow**:
    - Ignores the `ssl` and `arg` parameters by casting them to void.
    - Calls `ERR_print_errors_fp` to print any OpenSSL errors to `stderr`.
    - Logs an error message using `FD_LOG_ERR`, which includes the alert code and its string representations from `SSL_alert_desc_string` and `SSL_alert_desc_string_long`.
    - Returns 1 to indicate successful execution.
- **Output**: Returns an integer value of 1, indicating successful execution.


---
### \_fdtls\_sendmsg<!-- {{#callable:_fdtls_sendmsg}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_openssl.c#L153>)

Sends a TLS record with a specified encryption level and logs the record.
- **Inputs**:
    - `handshake`: A pointer to the handshake data, which is not used in this function.
    - `record`: A pointer to the TLS record data to be sent.
    - `record_sz`: The size of the TLS record data in bytes.
    - `encryption_level`: The encryption level to use when sending the record.
    - `flush`: An integer indicating whether to flush, which is not used in this function.
- **Logic and Control Flow**:
    - Ignores the `handshake` and `flush` parameters as they are not used.
    - Logs the TLS record using [`test_record_log`](<test_tls_helper.h.md#test_record_log>) with the given `record` and `record_sz`, and a direction flag based on `_is_ossl_to_fd`.
    - Sends the TLS record using [`test_record_send`](<test_tls_helper.h.md#test_record_send>) with the `_fdtls_out` buffer, the specified `encryption_level`, and the `record` and `record_sz`.
    - Returns 1 to indicate success.
- **Output**: Returns 1 to indicate successful execution.
- **Functions Called**:
    - [`test_record_log`](<test_tls_helper.h.md#test_record_log>)
    - [`test_record_send`](<test_tls_helper.h.md#test_record_send>)


---
### \_fd\_client\_respond<!-- {{#callable:_fd_client_respond}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_openssl.c#L165>)

Processes incoming TLS handshake records for a client and handles errors if the handshake fails.
- **Inputs**:
    - ``client``: A pointer to an `fd_tls_t` structure representing the TLS client.
    - ``hs``: A pointer to an `fd_tls_estate_cli_t` structure representing the client's handshake state.
- **Logic and Control Flow**:
    - Initialize a `test_record_t` pointer `rec` to receive records.
    - Enter a loop to receive records using `test_record_recv` from `_ossl_out`.
    - For each received record, call [`fd_tls_client_handshake`](<fd_tls.c.md#fd_tls_client_handshake>) with the client, handshake state, and record details.
    - Check if the result of [`fd_tls_client_handshake`](<fd_tls.c.md#fd_tls_client_handshake>) is less than 0, indicating an error.
    - If an error occurs, log the error details using `FD_LOG_ERR` and halt execution with `fd_halt`.
- **Output**: No return value; the function processes records and handles errors internally.
- **Functions Called**:
    - [`fd_tls_client_handshake`](<fd_tls.c.md#fd_tls_client_handshake>)
    - [`fd_tls_alert_cstr`](<fd_tls.c.md#fd_tls_alert_cstr>)
    - [`fd_tls_reason_cstr`](<fd_tls.c.md#fd_tls_reason_cstr>)


---
### \_fd\_server\_respond<!-- {{#callable:_fd_server_respond}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_openssl.c#L180>)

Handles incoming TLS handshake records for a server and processes them using the [`fd_tls_server_handshake`](<fd_tls.c.md#fd_tls_server_handshake>) function.
- **Inputs**:
    - ``server``: A pointer to an `fd_tls_t` structure representing the server instance.
    - ``hs``: A pointer to an `fd_tls_estate_srv_t` structure representing the server handshake state.
- **Logic and Control Flow**:
    - Retrieve records from the `_ossl_out` buffer using `test_record_recv` in a loop.
    - For each record, call [`fd_tls_server_handshake`](<fd_tls.c.md#fd_tls_server_handshake>) with the server, handshake state, and record details.
    - If [`fd_tls_server_handshake`](<fd_tls.c.md#fd_tls_server_handshake>) returns a negative result, log an error message with details about the alert and reason, then halt the program.
- **Output**: No return value; the function processes records and may halt the program on error.
- **Functions Called**:
    - [`fd_tls_server_handshake`](<fd_tls.c.md#fd_tls_server_handshake>)
    - [`fd_tls_alert_cstr`](<fd_tls.c.md#fd_tls_alert_cstr>)
    - [`fd_tls_reason_cstr`](<fd_tls.c.md#fd_tls_reason_cstr>)


---
### \_ossl\_respond<!-- {{#callable:_ossl_respond}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_openssl.c#L195>)

Performs an SSL handshake and checks for errors during the process.
- **Inputs**:
    - `ssl`: A pointer to an `SSL` structure representing the SSL connection.
- **Logic and Control Flow**:
    - Call `SSL_do_handshake` with the `ssl` parameter to perform the handshake.
    - Check if the result of `SSL_do_handshake` is not equal to 1, indicating an error occurred.
    - If an error occurred, call `SSL_get_error` to retrieve the error code and verify it is either 0, `SSL_ERROR_WANT_READ`, or `SSL_ERROR_WANT_WRITE`.
    - Use `FD_TEST` to assert that the error code is one of the expected values.
    - Call `ERR_get_error` to check for any additional errors and assert that it returns 0 using `FD_TEST`.
- **Output**: No return value; the function performs operations and checks for errors, asserting conditions using `FD_TEST`.


---
### \_fdtls\_quic\_tp\_self<!-- {{#callable:_fdtls_quic_tp_self}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_openssl.c#L205>)

Copies a predefined QUIC transport parameter buffer to a provided buffer and returns its size.
- **Inputs**:
    - `handshake`: A pointer to a handshake object, which is not used in this function.
    - `quic_tp`: A pointer to a buffer where the QUIC transport parameters will be copied.
    - `quic_tp_bufsz`: The size of the buffer pointed to by `quic_tp`.
- **Logic and Control Flow**:
    - Ignores the `handshake` parameter as it is not used in the function.
    - Checks if `quic_tp_bufsz` is greater than or equal to the size of `tp_buf` using `FD_TEST`.
    - Copies the contents of `tp_buf` to the buffer pointed to by `quic_tp` using `fd_memcpy`.
    - Returns the constant value `4UL`, which is the size of `tp_buf`.
- **Output**: Returns the size of the QUIC transport parameter buffer, which is `4UL`.


---
### \_fdtls\_quic\_tp\_peer<!-- {{#callable:_fdtls_quic_tp_peer}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_openssl.c#L215>)

Validates that the provided QUIC transport parameters match expected values.
- **Inputs**:
    - `handshake`: A pointer to a handshake context, which is not used in this function.
    - `quic_tp`: A pointer to the QUIC transport parameters to be validated.
    - `quic_tp_sz`: The size of the QUIC transport parameters, expected to be 4 bytes.
- **Logic and Control Flow**:
    - Ignores the `handshake` parameter as it is not used in the function.
    - Checks if `quic_tp_sz` is equal to 4 using `FD_TEST`.
    - Compares the first 4 bytes of `quic_tp` with `tp_buf` using `memcmp` and validates the result with `FD_TEST`.
- **Output**: No output is returned; the function performs validation checks and relies on `FD_TEST` for assertions.


---
### \_ossl\_info<!-- {{#callable:_ossl_info}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_openssl.c#L226>)

Logs OpenSSL information and state during SSL operations.
- **Inputs**:
    - `ssl`: A pointer to an `SSL` structure representing the SSL connection.
    - `type`: An integer representing the type of callback event.
    - `val`: An integer representing a value associated with the callback event.
- **Logic and Control Flow**:
    - Logs a debug message with the type and value of the OpenSSL event.
    - Checks if the `type` indicates an SSL loop event using a bitwise AND operation with `SSL_CB_LOOP`.
    - If the loop event is detected, logs an informational message with the current OpenSSL state using `SSL_state_string_long`.
- **Output**: No return value; the function performs logging operations.


---
### \_ossl\_keylog<!-- {{#callable:_ossl_keylog}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_openssl.c#L236>)

Logs a debug message with the provided line using OpenSSL.
- **Inputs**:
    - ``ssl``: A pointer to an `SSL` structure, which is not used in the function.
    - ``line``: A constant character pointer representing the line to log.
- **Logic and Control Flow**:
    - The function takes two parameters: `ssl` and `line`.
    - The `ssl` parameter is not used in the function body.
    - The function logs a debug message using the `FD_LOG_DEBUG` macro, formatting the message with the string "OpenSSL: %s" and the `line` parameter.
- **Output**: No return value; the function performs logging as a side effect.


---
### \_ossl\_verify\_callback<!-- {{#callable:_ossl_verify_callback}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_openssl.c#L243>)

Always returns 1, effectively bypassing the verification process.
- **Inputs**:
    - `preverify_ok`: An integer indicating if the pre-verification was successful.
    - `ctx`: A pointer to an `X509_STORE_CTX` structure, which contains the context for the certificate verification.
- **Logic and Control Flow**:
    - Ignores the `preverify_ok` and `ctx` parameters by casting them to void.
    - Returns 1, indicating success regardless of the input values.
- **Output**: An integer value of 1, indicating successful verification.


---
### \_ossl\_alpn\_select<!-- {{#callable:_ossl_alpn_select}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_openssl.c#L250>)

Selects the next protocol for ALPN negotiation using OpenSSL's `SSL_select_next_proto` function.
- **Inputs**:
    - ``ssl``: A pointer to an `SSL` structure, which is not used in this function.
    - ``out``: A pointer to a pointer to an unsigned char, where the selected protocol will be stored.
    - ``outlen``: A pointer to an unsigned char, where the length of the selected protocol will be stored.
    - ``in``: A pointer to an array of unsigned chars representing the list of protocols offered by the client.
    - ``inlen``: An unsigned integer representing the length of the `in` array.
    - ``arg``: A pointer to additional arguments, which is not used in this function.
- **Logic and Control Flow**:
    - Ignore the `ssl` and `arg` parameters as they are not used.
    - Call `SSL_select_next_proto` with the provided `in` and `inlen` to select the next protocol, using the hardcoded protocol `"\xasolana-tpu"` with a length of 11.
    - Check if the result of `SSL_select_next_proto` is `OPENSSL_NPN_NEGOTIATED`.
    - If the negotiation is successful, return `SSL_TLSEXT_ERR_OK`.
    - If the negotiation fails, log an error message indicating ALPN negotiation failure.
- **Output**: Returns `SSL_TLSEXT_ERR_OK` if the ALPN negotiation is successful, otherwise logs an error and does not return a specific value.


---
### \_reset\_test\_state<!-- {{#callable:_reset_test_state}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_openssl.c#L280>)

Resets the test state by setting the direction of data flow, initializing the OpenSSL send level, and resetting test record buffers.
- **Inputs**:
    - ``is_ossl_to_fd``: A `uchar` value indicating the direction of data flow; if non-zero, data flows from OpenSSL to fd_tls.
- **Logic and Control Flow**:
    - Set the global variable `_is_ossl_to_fd` to the value of `is_ossl_to_fd` to determine the data flow direction.
    - Initialize the global variable `_ossl_send_level` to `FD_TLS_LEVEL_INITIAL` to set the initial encryption level for sending data.
    - Call [`test_record_reset`](<test_tls_helper.h.md#test_record_reset>) on `_ossl_out` to reset the OpenSSL output test record buffer.
    - Call [`test_record_reset`](<test_tls_helper.h.md#test_record_reset>) on `_fdtls_out` to reset the fd_tls output test record buffer.
- **Output**: No return value; the function modifies global state variables and buffers.
- **Functions Called**:
    - [`test_record_reset`](<test_tls_helper.h.md#test_record_reset>)


---
### \_setup\_ssl\_cert\_and\_quic<!-- {{#callable:_setup_ssl_cert_and_quic}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_openssl.c#L289>)

Sets up an SSL connection with an Ed25519 certificate and QUIC callbacks.
- **Inputs**:
    - `ssl`: A pointer to an `SSL` structure that represents the SSL connection.
    - `rng`: A pointer to an `fd_rng_t` structure used for random number generation.
    - `sha`: A pointer to an `fd_sha512_t` structure used for SHA-512 hashing.
    - `public_key_out`: A pointer to an array of 32 bytes where the generated public key will be stored.
- **Logic and Control Flow**:
    - Generates a 32-byte Ed25519 private key using the random number generator `rng`.
    - Derives the corresponding public key from the private key and stores it in `public_key_out` using the `fd_ed25519_public_from_private` function.
    - Creates a new `EVP_PKEY` structure for the private key and assigns it to the SSL connection using `SSL_use_PrivateKey`.
    - Frees the `EVP_PKEY` structure after use.
    - Generates a mock X.509 certificate using the public key and assigns it to the SSL connection using `SSL_use_certificate_ASN1`.
    - Sets up QUIC callbacks and transport parameters for the SSL connection using `SSL_set_quic_tls_cbs` and `SSL_set_quic_tls_transport_params`.
- **Output**: No return value; the function modifies the `ssl` structure and outputs the public key to `public_key_out`.


---
### \_fd\_tls\_t<!-- {{#callable:_fd_tls_t}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_openssl.c#L316>)

Initializes and returns a `fd_tls_t` structure with specific function pointers and parameters for TLS operations.
- **Inputs**:
    - `sign_ctx`: A pointer to the signing context used for TLS operations.
    - `rng`: A pointer to a random number generator used for generating random values in TLS operations.
- **Logic and Control Flow**:
    - Calls [`fd_tls_test_rand`](<test_tls_helper.h.md#fd_tls_rand_tfd_tls_test_rand>) with `rng` to initialize the `rand` field of the `fd_tls_t` structure.
    - Sets the `secrets_fn` field to the `_fdtls_secrets` function.
    - Sets the `sendmsg_fn` field to the `_fdtls_sendmsg` function.
    - Sets the `quic` field to 1, indicating QUIC support.
    - Sets the `quic_tp_peer_fn` field to the `_fdtls_quic_tp_peer` function.
    - Sets the `quic_tp_self_fn` field to the `_fdtls_quic_tp_self` function.
    - Calls [`fd_tls_test_sign`](<test_tls_helper.h.md#fd_tls_sign_tfd_tls_test_sign>) with `sign_ctx` to initialize the `sign` field of the `fd_tls_t` structure.
    - Sets the `alpn` field to the string `"\xasolana-tpu"`.
    - Sets the `alpn_sz` field to 11UL, indicating the size of the ALPN string.
- **Output**: Returns a `fd_tls_t` structure initialized with specific function pointers and parameters for TLS operations.
- **Functions Called**:
    - [`fd_tls_rand_t::fd_tls_test_rand`](<test_tls_helper.h.md#fd_tls_rand_tfd_tls_test_rand>)
    - [`fd_tls_sign_t::fd_tls_test_sign`](<test_tls_helper.h.md#fd_tls_sign_tfd_tls_test_sign>)


---
### test\_server<!-- {{#callable:test_server}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_openssl.c#L337>)

Tests the handshake process between an OpenSSL client and an `fd_tls` server.
- **Inputs**:
    - `ctx`: A pointer to an `SSL_CTX` structure, which is the context for the OpenSSL connection.
- **Logic and Control Flow**:
    - Logs the start of the test with `FD_LOG_INFO`.
    - Resets the test state using [`_reset_test_state`](<#_reset_test_state>) with a parameter of 1.
    - Initializes a SHA-512 context using `fd_sha512_new` and `fd_sha512_join`.
    - Creates a random number generator (`fd_rng_t`) and joins it using `fd_rng_new` and `fd_rng_join`.
    - Creates an `fd_tls` server instance and initializes it with [`_fd_tls_t`](<#_fd_tls_t>).
    - Sets up the server's ECDH key by generating a private key and computing the public key using `fd_x25519_public`.
    - Copies the server's public key from the signing context to the server's certificate public key.
    - Mocks a server certificate using `fd_x509_mock_cert` and sets its size.
    - Initializes an OpenSSL `SSL` object and sets it to connect state using `SSL_set_connect_state`.
    - Sets up the client certificate and QUIC parameters using [`_setup_ssl_cert_and_quic`](<#_setup_ssl_cert_and_quic>).
    - Initiates the handshake process by calling `SSL_do_handshake`.
    - Processes handshake messages in a loop until the server's state is `FD_TLS_HS_CONNECTED`.
    - Verifies that both the OpenSSL client and the `fd_tls` server have completed the handshake successfully.
    - Cleans up by deleting and freeing all allocated resources.
- **Output**: No return value; the function performs a test and logs results.
- **Functions Called**:
    - [`_reset_test_state`](<#_reset_test_state>)
    - [`fd_tls_join`](<fd_tls.c.md#fd_tls_join>)
    - [`fd_tls_new`](<fd_tls.c.md#fd_tls_new>)
    - [`_fd_tls_t`](<#_fd_tls_t>)
    - [`_setup_ssl_cert_and_quic`](<#_setup_ssl_cert_and_quic>)
    - [`_fd_server_respond`](<#_fd_server_respond>)
    - [`_ossl_respond`](<#_ossl_respond>)
    - [`fd_tls_estate_srv_delete`](<fd_tls_estate.h.md#fd_tls_estate_srv_delete>)
    - [`fd_tls_delete`](<fd_tls.c.md#fd_tls_delete>)
    - [`fd_tls_leave`](<fd_tls.c.md#fd_tls_leave>)


---
### test\_client<!-- {{#callable:test_client}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_openssl.c#L412>)

Establishes a TLS handshake between an fd_tls client and an OpenSSL server, verifying successful connection and cleaning up resources.
- **Inputs**:
    - `ctx`: A pointer to an `SSL_CTX` structure, which holds the context for the SSL/TLS connection.
- **Logic and Control Flow**:
    - Logs the start of the test and resets the test state.
    - Initializes SHA-512 and random number generator contexts.
    - Creates a new SSL object from the provided context and sets it to accept state.
    - Sets up the server certificate and QUIC parameters using [`_setup_ssl_cert_and_quic`](<#_setup_ssl_cert_and_quic>).
    - Creates and initializes an `fd_tls` client instance and its associated signing context.
    - Generates and sets up ECDH and Ed25519 keys for the client.
    - Mocks a client certificate using `fd_x509_mock_cert`.
    - Initiates the TLS handshake by sending a ClientHello message from the fd_tls client.
    - Processes handshake messages between the fd_tls client and the OpenSSL server until the connection is established.
    - Handles potential NewSessionTicket messages from the OpenSSL server after the handshake.
    - Verifies that both the fd_tls client and the OpenSSL server have completed the handshake successfully.
    - Cleans up all allocated resources, including SSL, RNG, and SHA-512 contexts.
- **Output**: No return value; the function performs its operations and cleans up resources without returning data.
- **Functions Called**:
    - [`_reset_test_state`](<#_reset_test_state>)
    - [`_setup_ssl_cert_and_quic`](<#_setup_ssl_cert_and_quic>)
    - [`fd_tls_join`](<fd_tls.c.md#fd_tls_join>)
    - [`fd_tls_new`](<fd_tls.c.md#fd_tls_new>)
    - [`_fd_tls_t`](<#_fd_tls_t>)
    - [`fd_tls_client_handshake`](<fd_tls.c.md#fd_tls_client_handshake>)
    - [`_ossl_respond`](<#_ossl_respond>)
    - [`_fd_client_respond`](<#_fd_client_respond>)
    - [`fd_tls_estate_cli_delete`](<fd_tls_estate.h.md#fd_tls_estate_cli_delete>)
    - [`fd_tls_delete`](<fd_tls.c.md#fd_tls_delete>)
    - [`fd_tls_leave`](<fd_tls.c.md#fd_tls_leave>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_openssl.c#L490>)

Initializes OpenSSL, configures SSL context, and tests TLS server and client connections.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Initializes OpenSSL by obtaining a method using `TLS_method` and creating a new SSL context with `SSL_CTX_new`.
    - Sets the SSL context to not verify peer certificates using `SSL_CTX_set_verify`.
    - Configures the SSL context to use TLS 1.3 as the minimum and maximum protocol version.
    - Sets the cipher suites for the SSL context to `TLS_AES_128_GCM_SHA256`.
    - Registers callbacks for SSL information and key logging using `SSL_CTX_set_info_callback` and `SSL_CTX_set_keylog_callback`.
    - Sets ALPN protocols and selection callback for the SSL context.
    - Tests the server connection with and without `RetryHelloRequest` by setting different groups list and calling [`test_server`](<#test_server>).
    - Tests the client connection with and without certificate verification by setting verification mode and calling [`test_client`](<#test_client>).
    - Frees the SSL context and logs a notice message before halting the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`test_server`](<#test_server>)
    - [`test_client`](<#test_client>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)