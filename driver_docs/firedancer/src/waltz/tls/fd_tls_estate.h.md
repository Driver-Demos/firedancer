<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines structures and functions for managing TLS handshake state for both server and client sides.

# Purpose
The code defines a C header file for managing TLS (Transport Layer Security) handshake states in both server and client contexts. It provides structures and functions to handle the state of TLS handshakes, optimizing for memory usage and security. The file includes definitions for `fd_tls_estate_base_t`, `fd_tls_estate_srv_t`, and `fd_tls_estate_cli_t`, which represent the base, server, and client handshake states, respectively. The `fd_tls_estate_base_t` structure contains common elements such as the state, server/client indicator, and a reason code. The `fd_tls_transcript_t` structure is used to maintain a running hash of handshake messages, ensuring message integrity.

The server-side structure, `fd_tls_estate_srv_t`, is optimized for minimal memory usage to handle high volumes of incoming connections securely. It includes fields for managing server-specific handshake details and security features. The client-side structure, `fd_tls_estate_cli_t`, is more complex due to the nature of client-side operations but is not optimized for memory use as clients are less vulnerable to handshake floods. The file also provides functions to initialize and delete these structures, facilitating the management of TLS handshake states. The union `fd_tls_estate_t` allows for flexible handling of both server and client states within a single type.
# Imports and Dependencies

---
- `../fd_waltz_base.h`
- `../../ballet/sha256/fd_sha256.h`


# Data Structures

---
### fd\_tls\_estate\_base
- **Type**: ``struct``
- **Members**:
    - ``state``: Holds the current state of the TLS handshake.
    - ``server``: Indicates if the entity is a server (1) or a client (0).
    - ``reason``: Stores the reason code, defined by `FD_TLS_REASON_{...}`.
    - ``client_random``: Contains a 32-byte random value used in the SSL key logging process.
- **Description**: Defines the base structure for TLS handshake state, shared between server and client implementations, and includes fields for state management, role identification, reason codes, and a random value for SSL key logging.


---
### fd\_tls\_estate\_base\_t
- **Type**: ``struct``
- **Members**:
    - ``state``: Holds the current state of the TLS handshake.
    - ``server``: Indicates if the entity is a server (1) or a client (0).
    - ``reason``: Stores the reason code for the current state, using `FD_TLS_REASON_{...}`.
    - ``client_random``: Contains a 32-byte random value used in the SSLKEYLOGFILE process.
- **Description**: Represents the shared header for TLS estate objects, used in both server and client contexts, to manage the state and configuration of a TLS handshake.


---
### fd\_tls\_transcript
- **Type**: ``struct``
- **Members**:
    - ``buf``: An array of 64 unsigned characters that stores the pending SHA block.
    - ``sha``: An array of 8 unsigned integers that holds the current internal SHA state.
    - ``len``: An unsigned integer that represents the total number of bytes compressed into the SHA state plus the number of bytes pending in `buf`.
- **Description**: Maintains a running hash over all handshake messages in a TLS session, with fields to store the pending SHA block, the current SHA state, and the total length of data processed.


---
### fd\_tls\_transcript\_t
- **Type**: ``struct``
- **Members**:
    - `buf`: Pending SHA block of 64 bytes.
    - `sha`: Current internal SHA state represented as an array of 8 unsigned integers.
    - `len`: Number of bytes compressed into SHA state plus bytes pending in `buf`.
- **Description**: Maintains a running hash over all handshake messages in a TLS session, with the hash state depending on the current handshake progression. The structure includes a buffer for pending SHA blocks, the current SHA state, and a length field to track the number of bytes processed.


---
### fd\_tls\_estate\_srv\_t
- **Type**: ``struct``
- **Members**:
    - ``base``: Contains shared TLS handshake state information.
    - ``server_cert_rpk``: Indicates if the server uses a raw public key (1) or X.509 (0) for its certificate.
    - ``client_cert``: Indicates if client authentication is required (1) or not (0).
    - ``client_cert_rpk``: Indicates if the client uses a raw public key (1) or X.509 (0) for its certificate.
    - ``hello_retry``: Indicates if a HelloRetryRequest was sent (1) or not (0).
    - ``transcript``: Stores the running hash of all handshake messages.
    - ``client_hs_secret``: Stores the client's handshake secret used for deriving verify data.
    - ``client_pubkey``: Stores the client's public key.
- **Description**: Represents the compressed TLS server handshake state while waiting for a client message, optimized for small memory use. It includes a base structure for shared TLS state, flags for server and client certificate types, a transcript for handshake message hashing, and secrets for client handshake verification. The structure is designed to handle handshake requests from untrusted clients securely, minimizing memory usage to prevent exhaustion attacks.


---
### fd\_tls\_estate\_cli\_t
- **Type**: ``struct``
- **Members**:
    - `base`: Contains the shared header information for TLS handshake state.
    - `server_pubkey`: Stores the server's public key in a 32-byte array.
    - `server_hs_secret`: Holds the server handshake secret in a 32-byte array.
    - `client_hs_secret`: Contains the client handshake secret in a 32-byte array.
    - `master_secret`: Stores the master secret in a 32-byte array.
    - `client_cert`: Indicates if client authentication is used (0=anonymous, 1=client auth).
    - `server_cert_rpk`: Indicates if the server certificate is a raw public key (1) or X.509 (0).
    - `client_cert_nox509`: Indicates if the client certificate is not X.509 (1).
    - `client_cert_rpk`: Indicates if the client certificate is a raw public key (1) or X.509 (0).
    - `server_pubkey_pin`: Indicates if the server certificate must match the server public key (1).
    - `transcript`: Holds the SHA-256 hash state of the handshake messages.
- **Description**: Represents the TLS client handshake state while waiting for the server to send a message. It includes various fields to manage the handshake process, such as public keys, handshake secrets, and a transcript of the handshake messages. The structure is designed to handle the complexity of the client-side handshake, which is more intricate than the server-side, and thus requires more memory. It is not optimized for memory use as clients are not susceptible to handshake packet floods.


---
### fd\_tls\_estate\_t
- **Type**: ``union``
- **Members**:
    - ``base``: Represents the shared base structure for both server and client TLS handshake states.
    - ``srv``: Represents the server-side TLS handshake state structure.
    - ``cli``: Represents the client-side TLS handshake state structure.
- **Description**: The `fd_tls_estate_t` union is a data structure that encapsulates the TLS handshake state for both server and client contexts. It includes a shared base structure (`fd_tls_estate_base_t`) and specific structures for server (`fd_tls_estate_srv_t`) and client (`fd_tls_estate_cli_t`) handshake states. This union allows for efficient memory usage and type punning between different TLS handshake states, facilitating the management of TLS connections in a secure and memory-optimized manner.


# Functions

---
### fd\_tls\_transcript\_store<!-- {{#callable:fd_tls_transcript_store}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls_estate.h#L53>)

Stores the SHA-256 hash state and buffer into a TLS transcript structure.
- **Inputs**:
    - `script`: A pointer to an `fd_tls_transcript_t` structure where the SHA-256 hash state and buffer will be stored.
    - `sha`: A pointer to a constant `fd_sha256_t` structure containing the SHA-256 hash state and buffer to be stored.
- **Logic and Control Flow**:
    - Copy 64 bytes from the `sha->buf` to `script->buf` using `memcpy`.
    - Copy 32 bytes from the `sha->state` to `script->sha` using `memcpy`.
    - Calculate the length of the data in bytes by dividing `sha->bit_cnt` by 8 and store it in `script->len`.
- **Output**: No return value; the function modifies the `fd_tls_transcript_t` structure pointed to by `script`.


---
### fd\_tls\_transcript\_load<!-- {{#callable:fd_tls_transcript_load}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls_estate.h#L63>)

Loads the SHA-256 state from a TLS transcript into a SHA-256 context.
- **Inputs**:
    - ``script``: A pointer to a constant `fd_tls_transcript_t` structure containing the TLS transcript data to load.
    - ``sha``: A pointer to an `fd_sha256_t` structure where the SHA-256 state will be loaded.
- **Logic and Control Flow**:
    - Copy 64 bytes from `script->buf` to `sha->buf` using `memcpy`.
    - Copy 32 bytes from `script->sha` to `sha->state` using `memcpy`.
    - Calculate `sha->bit_cnt` as the product of `script->len` and 8, casting the result to `ulong`.
    - Calculate `sha->buf_used` as the remainder of `script->len` divided by 64, casting the result to `uint`.
- **Output**: No return value; the function modifies the `sha` structure in place.


---
### fd\_tls\_estate\_srv\_delete<!-- {{#callable:fd_tls_estate_srv_delete}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls_estate.h#L164>)

Returns the pointer to the `fd_tls_estate_srv_t` object without performing any deletion operations.
- **Inputs**:
    - `estate`: A pointer to a `fd_tls_estate_srv_t` object that represents the TLS server handshake state.
- **Logic and Control Flow**:
    - Casts the `estate` pointer to a `void *` type.
    - Returns the casted pointer.
- **Output**: A `void *` pointer to the `fd_tls_estate_srv_t` object passed as input.


---
### fd\_tls\_estate\_cli\_delete<!-- {{#callable:fd_tls_estate_cli_delete}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls_estate.h#L216>)

Returns the pointer to the `fd_tls_estate_cli_t` object without performing any deletion operations.
- **Inputs**:
    - `estate`: A pointer to an `fd_tls_estate_cli_t` object, representing the TLS client handshake state.
- **Logic and Control Flow**:
    - Casts the `estate` pointer to a `void *` type.
    - Returns the casted pointer.
- **Output**: A `void *` pointer to the `fd_tls_estate_cli_t` object passed as input.



---
Made with ❤️ by [Driver](https://www.driver.ai/)