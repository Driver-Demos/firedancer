<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Common routines and structures for unit testing fd_tls, including deterministic RNG and test record transport.

# Purpose
The code is a C header file that provides utility functions and structures for testing Transport Layer Security (TLS) implementations. It includes functions for generating deterministic random numbers and signing data, which are used in unit tests for TLS. The [`fd_tls_test_rand`](<#fd_tls_rand_tfd_tls_test_rand>) function creates a random number generator that is deliberately insecure and deterministic, intended for testing purposes. The [`fd_tls_test_sign`](<#fd_tls_sign_tfd_tls_test_sign>) function provides a signing mechanism using the Ed25519 algorithm, with a context structure that holds the necessary keys and a SHA-512 hash instance.

Additionally, the code defines structures and functions for handling test records, which simulate the transport of TLS messages. The `test_record_buf_t` structure manages a buffer of test records, and functions like [`test_record_send`](<#test_record_send>) and `test_record_recv` handle the sending and receiving of these records. The [`test_record_log`](<#test_record_log>) function logs TLS messages, identifying them by type and origin (server or client). This header file is intended to be included in other test files to facilitate the testing of TLS functionalities by providing common routines and data structures.
# Imports and Dependencies

---
- `fd_tls.h`
- `fd_tls_proto.h`
- `../../ballet/sha512/fd_sha512.h`
- `../../ballet/ed25519/fd_ed25519.h`


# Data Structures

---
### fd\_tls\_test\_sign\_ctx
- **Type**: ``struct``
- **Members**:
    - ``sha512``: An array of one `fd_sha512_t` object used for SHA-512 hashing.
    - ``public_key``: An array of 32 unsigned characters representing the public key.
    - ``private_key``: An array of 32 unsigned characters representing the private key.
- **Description**: Facilitates the signing process in TLS unit tests by holding SHA-512 hashing context and Ed25519 public and private keys.


---
### fd\_tls\_test\_sign\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``sha512``: An array of one `fd_sha512_t` used for SHA-512 hashing operations.
    - ``public_key``: A 32-byte array that stores the public key.
    - ``private_key``: A 32-byte array that stores the private key.
- **Description**: Contains fields necessary for signing operations in TLS tests, including SHA-512 hashing context and Ed25519 public and private keys.


---
### test\_record
- **Type**: ``struct``
- **Members**:
    - ``level``: Stores the level of the test record as an unsigned integer.
    - ``buf``: An array of unsigned characters with a size defined by `TEST_RECORD_BUFSZ` to hold the record data.
    - ``cur``: Stores the current size of the data in the buffer as an unsigned long integer.
- **Description**: Holds information about a test record, including its level, data buffer, and the current size of the data in the buffer.


---
### test\_record\_t
- **Type**: ``struct``
- **Members**:
    - ``level``: Stores the level of the test record as an unsigned integer.
    - ``buf``: An array of unsigned characters with a size defined by `TEST_RECORD_BUFSZ` to hold the record data.
    - ``cur``: Stores the current size of the record as an unsigned long integer.
- **Description**: Defines a structure to represent a test record with a specific level, a buffer to store the record data, and a variable to track the current size of the record.


---
### test\_record\_buf
- **Type**: ``struct``
- **Members**:
    - `records`: An array of `test_record_t` structures with a size defined by `TEST_RECORD_BUF_CNT`.
    - `recv`: A `ulong` that tracks the number of records received.
    - `send`: A `ulong` that tracks the number of records sent.
- **Description**: Stores an array of `test_record_t` structures and manages the sending and receiving of records by maintaining counters for sent and received records.


---
### test\_record\_buf\_t
- **Type**: ``struct``
- **Members**:
    - `records`: An array of `test_record_t` structures with a fixed size of `TEST_RECORD_BUF_CNT`.
    - `recv`: An `ulong` that tracks the index of the next record to receive.
    - `send`: An `ulong` that tracks the index of the next record to send.
- **Description**: Manages a buffer of test records for transport, allowing for sending and receiving operations with a fixed-size array of records.


# Functions

---
### fd\_tls\_test\_rand\_read<!-- {{#callable:fd_tls_test_rand_read}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_helper.h#L14>)

Generates random bytes using a deterministic random number generator for testing purposes.
- **Inputs**:
    - `ctx`: A pointer to a context, specifically an `fd_rng_t` object, which is a random number generator.
    - `buf`: A pointer to a buffer where the function will store the generated random bytes.
    - `bufsz`: The number of random bytes to generate and store in the buffer.
- **Logic and Control Flow**:
    - Check if `ctx` is NULL; if it is, return NULL immediately.
    - Cast `ctx` to an `fd_rng_t` pointer and `buf` to an `uchar` pointer.
    - Iterate over the range from 0 to `bufsz`, generating a random byte for each position in the buffer using `fd_rng_uchar` and store it in `buf_`.
    - Return the buffer `buf_` after filling it with random bytes.
- **Output**: Returns the pointer to the buffer `buf_` filled with random bytes, or NULL if `ctx` is NULL.


---
### fd\_tls\_test\_rand<!-- {{#callable:fd_tls_rand_t::fd_tls_test_rand}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_helper.h#L28>)

Creates an `fd_tls_rand_t` structure using a given random number generator context.
- **Inputs**:
    - `rng`: A pointer to an `fd_rng_t` structure, which is the random number generator context.
- **Logic and Control Flow**:
    - Creates and returns an `fd_tls_rand_t` structure.
    - Sets the `ctx` field of the `fd_tls_rand_t` structure to the provided `rng`.
    - Sets the `rand_fn` field of the `fd_tls_rand_t` structure to the function `fd_tls_test_rand_read`.
- **Output**: An `fd_tls_rand_t` structure initialized with the provided random number generator context and a function pointer to `fd_tls_test_rand_read`.
- **See also**: [`fd_tls_rand_t`](<fd_tls.h.md#fd_tls_rand_t>)  (Data Structure)


---
### fd\_tls\_test\_sign\_sign<!-- {{#callable:fd_tls_test_sign_sign}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_helper.h#L44>)

Signs a payload using the Ed25519 signature scheme with a given context.
- **Inputs**:
    - `_ctx`: A pointer to the `fd_tls_test_sign_ctx_t` structure containing the signing context, including the public and private keys and SHA-512 state.
    - `signature`: A pointer to a buffer where the generated signature will be stored.
    - `payload`: A pointer to the data that will be signed.
- **Logic and Control Flow**:
    - Cast `_ctx` to a `fd_tls_test_sign_ctx_t` pointer to access the signing context.
    - Call `fd_ed25519_sign` with the provided `signature`, `payload`, a fixed payload length of 130 bytes, and the public and private keys and SHA-512 state from the context.
- **Output**: The function does not return a value; it outputs the signature directly to the `signature` buffer.


---
### fd\_tls\_test\_sign\_ctx<!-- {{#callable:fd_tls_test_sign_ctx}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_helper.h#L52>)

Initializes a signing context by setting up SHA-512 and generating an Ed25519 key pair.
- **Inputs**:
    - `ctx`: A pointer to an `fd_tls_test_sign_ctx_t` structure that will hold the SHA-512 context and the Ed25519 key pair.
    - `rng`: A pointer to an `fd_rng_t` structure used to generate random bytes for the private key.
- **Logic and Control Flow**:
    - Calls `fd_sha512_new` to initialize the SHA-512 context in `ctx->sha512` and joins it with `fd_sha512_join` to ensure it is ready for use.
    - Generates 32 random bytes using `fd_rng_uchar` from the `rng` and stores them in `ctx->private_key`.
    - Derives the public key from the private key and SHA-512 context using `fd_ed25519_public_from_private` and stores it in `ctx->public_key`.
- **Output**: No output is returned as the function is of type `void`.


---
### fd\_tls\_test\_sign<!-- {{#callable:fd_tls_sign_t::fd_tls_test_sign}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_helper.h#L61>)

Creates a `fd_tls_sign_t` structure with a context and a signing function.
- **Inputs**:
    - `ctx`: A pointer to a context that will be used by the signing function.
- **Logic and Control Flow**:
    - Returns a `fd_tls_sign_t` structure.
    - Sets the `ctx` field of the structure to the provided `ctx` argument.
    - Sets the `sign_fn` field of the structure to the `fd_tls_test_sign_sign` function.
- **Output**: A `fd_tls_sign_t` structure initialized with the provided context and a predefined signing function.
- **See also**: [`fd_tls_sign_t`](<fd_tls.h.md#fd_tls_sign_t>)  (Data Structure)


---
### test\_record\_reset<!-- {{#callable:test_record_reset}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_helper.h#L89>)

Resets the `recv` and `send` counters of a `test_record_buf_t` structure to zero.
- **Inputs**:
    - `buf`: A pointer to a `test_record_buf_t` structure whose `recv` and `send` counters will be reset.
- **Logic and Control Flow**:
    - Set the `recv` member of the `buf` structure to 0UL.
    - Set the `send` member of the `buf` structure to 0UL.
- **Output**: No output is returned as the function operates directly on the input structure.


---
### test\_record\_send<!-- {{#callable:test_record_send}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_helper.h#L94>)

Stores a record in a circular buffer and updates the buffer's send index.
- **Inputs**:
    - ``buf``: A pointer to a `test_record_buf_t` structure where the record will be stored.
    - ``level``: An unsigned integer representing the level of the record.
    - ``record``: A pointer to an array of unsigned characters representing the record data to be stored.
    - ``record_sz``: An unsigned long integer representing the size of the record data.
- **Logic and Control Flow**:
    - Calculate the index in the `records` array where the new record will be stored using the current `send` index modulo `TEST_RECORD_BUF_CNT`.
    - Increment the `send` index of the buffer.
    - Assign the `level` to the `level` field of the selected `test_record_t` structure.
    - Assign the `record_sz` to the `cur` field of the selected `test_record_t` structure.
    - Check if `record_sz` is less than or equal to `TEST_RECORD_BUFSZ` using `FD_TEST`.
    - Copy the data from `record` to the `buf` field of the selected `test_record_t` structure using `fd_memcpy`.
- **Output**: No return value; the function modifies the `test_record_buf_t` structure pointed to by `buf`.


---
### test\_record\_log<!-- {{#callable:test_record_log}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls_helper.h#L112>)

Logs a TLS record with a prefix indicating the source and the type of TLS message.
- **Inputs**:
    - `record`: A pointer to the TLS record to log.
    - `record_sz`: The size of the TLS record, which must be at least 4 bytes.
    - `from_server`: An integer indicating if the record is from the server (non-zero) or client (zero).
- **Logic and Control Flow**:
    - Check if `record_sz` is at least 4 bytes; if not, the function will not proceed.
    - Initialize a buffer `buf` of 512 bytes and a string `str` using `fd_cstr_init`.
    - Determine the prefix based on `from_server` and append it to `str`.
    - Determine the type of TLS message from the first byte of `record` using a switch statement.
    - If the message type is unknown, log an error and exit the function.
    - Append the determined message type to `str`.
    - Finalize the string `str` using `fd_cstr_fini`.
    - Log the information using `FD_LOG_HEXDUMP_INFO`, which includes the buffer, record, and its size.
- **Output**: Logs the TLS record information with a prefix and message type to the logging system.



---
Made with ❤️ by [Driver](https://www.driver.ai/)