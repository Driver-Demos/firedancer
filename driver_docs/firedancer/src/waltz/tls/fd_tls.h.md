<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a subset of the TLS v1.3 handshake protocol for securing peer-to-peer QUIC connections in Solana.

# Purpose
The `fd_tls.h` file defines a subset of the TLS v1.3 handshake protocol specifically tailored for securing peer-to-peer QUIC connections within the Solana network protocol. It is not a general-purpose TLS library and does not support older TLS versions like TLS v1.2. The file includes definitions for peer authentication using Ed25519 with the TLS v1.3 raw public key extension, and it provides minimal support for X.509 certificates. Key exchange is facilitated through the X25519 Elliptic Curve Diffie-Hellman scheme, and the library supports the TLS_AES_128_GCM_SHA256 cipher suite for data confidentiality and integrity.

The file defines several callback function types and structures that are used during the TLS handshake process, such as `fd_tls_secrets_fn_t`, `fd_tls_sendmsg_fn_t`, and `fd_tls_rand_fn_t`. These callbacks handle tasks like generating encryption secrets, sending TLS messages, and retrieving secure pseudorandom values. The `fd_tls` structure encapsulates the local TLS configuration, including cryptographic keys and callback functions. The file also provides public APIs for managing TLS handshakes, such as [`fd_tls_server_handshake`](<#fd_tls_server_handshake>) and [`fd_tls_client_handshake`](<#fd_tls_client_handshake>), and includes constants for handshake state identifiers and TLS encryption levels. Additionally, it defines specific error codes to aid in debugging TLS alerts.
# Imports and Dependencies

---
- `fd_tls_estate.h`


# Global Variables

---
### fd\_tls13\_cli\_sign\_prefix
- **Type**: ``char const[98]``
- **Description**: A constant character array of size 98 that is used in the TLS 1.3 protocol implementation.
- **Use**: Used as a prefix for client-side signing operations in the TLS 1.3 handshake process.


# Data Structures

---
### fd\_tls\_rand\_vt
- **Type**: ``struct``
- **Members**:
    - ``ctx``: An arbitrary pointer used as a callback argument.
    - ``rand_fn``: A function pointer to `fd_tls_rand_fn_t` for generating cryptographically secure random values.
- **Description**: Provides an abstraction for retrieving secure pseudorandom values, where `ctx` is used as a context for the random function `rand_fn`, which fills a buffer with secure random data.


---
### fd\_tls\_rand\_t
- **Type**: ``struct``
- **Members**:
    - ``ctx``: An arbitrary pointer provided as a callback argument.
    - ``rand_fn``: A function pointer to generate cryptographically secure random values.
- **Description**: `fd_tls_rand_t` is a structure that abstracts the retrieval of secure pseudorandom values. It contains a context pointer `ctx` and a function pointer `rand_fn` that fills a buffer with cryptographically secure random data. The function must not block and should handle buffer sizes typically around 32 bytes, returning the buffer on success or NULL on failure.


---
### fd\_tls\_sign\_vt
- **Type**: ``struct``
- **Members**:
    - ``ctx``: A pointer to an arbitrary context used as a callback argument.
    - ``sign_fn``: A function pointer to `fd_tls_sign_fn_t`, which is used to sign a TLS 1.3 certificate verify payload.
- **Description**: Defines a structure for handling the signing of TLS 1.3 certificate verify payloads using Ed25519. The `ctx` member provides a context for the callback, while `sign_fn` is a function pointer that performs the signing operation. This structure is used in the context of TLS handshakes to verify the authenticity of the server or client.


---
### fd\_tls\_sign\_t
- **Type**: ``struct``
- **Members**:
    - ``ctx``: An arbitrary pointer provided as a callback argument.
    - ``sign_fn``: A function pointer to the signing function for TLS 1.3 certificate verify payloads.
- **Description**: Defines a structure for handling the signing of TLS 1.3 certificate verify payloads using Ed25519. The `ctx` member is used to pass context information to the `sign_fn` function, which is responsible for generating the signature of a given payload. This structure is used in the context of TLS handshakes to prove possession of a private key.


---
### fd\_tls
- **Type**: ``struct``
- **Members**:
    - ``rand``: Holds a random value generator for secure pseudorandom values.
    - ``secrets_fn``: Callback function for handling new encryption secrets.
    - ``sendmsg_fn``: Callback function for sending TLS messages to peers.
    - ``quic_tp_self_fn``: Callback function for providing QUIC transport parameters to peers.
    - ``quic_tp_peer_fn``: Callback function for receiving QUIC transport parameters from peers.
    - ``kex_private_key``: 32-byte X25519 private key for symmetric encryption key establishment.
    - ``kex_public_key``: 32-byte X25519 public key derived from the private key.
    - ``sign``: Holds the Ed25519 signing function for server identification.
    - ``cert_public_key``: 32-byte Ed25519 public key for server identification.
    - ``cert_x509``: Buffer for the optional X.509 certificate to present to peers.
    - ``cert_x509_sz``: Size of the X.509 certificate in bytes.
    - ``alpn``: Buffer for the ALPN protocol identifier.
    - ``alpn_sz``: Size of the ALPN protocol identifier in bytes.
    - ``quic``: Flag indicating if QUIC-specific callbacks are enabled.
    - ``_flags_reserved``: Reserved flags for future use.
- **Description**: The `fd_tls` structure defines the configuration and state for a TLS connection, specifically tailored for securing peer-to-peer QUIC connections in the Solana network protocol. It includes fields for random number generation, encryption secret management, message sending, and QUIC transport parameter handling. The structure also manages key pairs for encryption and signing, as well as optional X.509 certificates and ALPN protocol identifiers. The `quic` flag determines if QUIC-specific callbacks are active, while `_flags_reserved` is reserved for future use.


---
### fd\_tls\_t
- **Type**: ``struct``
- **Members**:
    - ``rand``: Holds a random value generator for cryptographic operations.
    - ``secrets_fn``: Callback function for handling new encryption secrets.
    - ``sendmsg_fn``: Callback function for sending TLS messages to peers.
    - ``quic_tp_self_fn``: Callback function for providing QUIC transport parameters to peers.
    - ``quic_tp_peer_fn``: Callback function for receiving QUIC transport parameters from peers.
    - ``kex_private_key``: Stores a 32-byte X25519 private key for key exchange.
    - ``kex_public_key``: Stores a 32-byte X25519 public key derived from the private key.
    - ``sign``: Holds the signing function and context for Ed25519 signatures.
    - ``cert_public_key``: Stores the Ed25519 public key for server identification.
    - ``cert_x509``: Holds the X.509 certificate to present to peers.
    - ``cert_x509_sz``: Size of the X.509 certificate.
    - ``alpn``: Stores the ALPN protocol identifier.
    - ``alpn_sz``: Size of the ALPN protocol identifier.
    - ``quic``: Flag indicating if QUIC-specific callbacks are enabled.
    - ``_flags_reserved``: Reserved flags for future use.
- **Description**: Contains the local TLS configuration and is shared across multiple TLS handshakes. It includes cryptographic keys, callback functions for handling encryption secrets, message transmission, and QUIC transport parameters, as well as storage for certificates and protocol identifiers. The structure is designed to support the TLS 1.3 protocol for securing peer-to-peer QUIC connections, specifically within the Solana network protocol.


# Functions

---
### fd\_tls\_rand<!-- {{#callable:fd_tls_rand}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.h#L156>)

Calls a function to fill a buffer with cryptographically secure random data.
- **Inputs**:
    - ``rand``: A pointer to a `fd_tls_rand_t` structure containing the context and function pointer for generating random data.
    - ``buf``: A pointer to a buffer where the random data will be stored.
    - ``bufsz``: The size of the buffer in bytes.
- **Logic and Control Flow**:
    - Calls the `rand_fn` function from the `rand` structure, passing `rand->ctx`, `buf`, and `bufsz` as arguments.
    - Returns the result of the `rand_fn` function call.
- **Output**: Returns a pointer to the buffer filled with random data on success, or `NULL` on failure.


---
### fd\_tls\_sign<!-- {{#callable:fd_tls_sign}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.h#L186>)

Executes the signing function to generate an Ed25519 signature for a given TLS 1.3 CertificateVerify payload.
- **Inputs**:
    - ``sign``: A pointer to a `fd_tls_sign_t` structure containing the context and the signing function to use.
    - ``sig``: A 64-byte buffer where the function will store the generated Ed25519 signature.
    - ``payload``: A 130-byte buffer containing the TLS 1.3 CertificateVerify payload to be signed.
- **Logic and Control Flow**:
    - Calls the `sign_fn` function from the `sign` structure, passing the context, signature buffer, and payload buffer as arguments.
- **Output**: The function does not return a value; it outputs the signature directly into the `sig` buffer.


---
### fd\_tls\_handshake<!-- {{#callable:fd_tls_handshake}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.h#L405>)

Determines whether to perform a server or client TLS handshake based on the handshake state.
- **Inputs**:
    - `tls`: A pointer to a `fd_tls_t` structure containing the local TLS configuration.
    - `handshake`: A pointer to a `fd_tls_estate_t` structure representing the handshake state.
    - `record`: A pointer to the TLS message record to process.
    - `record_sz`: The size of the TLS message record in bytes.
    - `encryption_level`: An unsigned integer indicating the encryption level to use.
- **Logic and Control Flow**:
    - Checks if the `handshake->base.server` flag is set to determine if the handshake is for a server.
    - If the server flag is set, calls [`fd_tls_server_handshake`](<fd_tls.c.md#fd_tls_server_handshake>) with the server-specific handshake state.
    - If the server flag is not set, calls [`fd_tls_client_handshake`](<fd_tls.c.md#fd_tls_client_handshake>) with the client-specific handshake state.
- **Output**: Returns the number of bytes read on success or a negated TLS alert code on failure.
- **Functions Called**:
    - [`fd_tls_server_handshake`](<fd_tls.c.md#fd_tls_server_handshake>)
    - [`fd_tls_client_handshake`](<fd_tls.c.md#fd_tls_client_handshake>)


# Function Declarations (Public API)

---
### fd\_tls\_align<!-- {{#callable_declaration:fd_tls_align}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.h#L353>)

Returns the alignment requirement of the `fd_tls_t` type.
- **Description**: Use this function to obtain the alignment requirement for the `fd_tls_t` type, which is necessary when allocating memory for instances of this type. This function is useful in scenarios where precise memory alignment is required for performance or compatibility reasons. It does not require any parameters and can be called at any time.
- **Inputs**: None
- **Output**: The function returns an unsigned long integer representing the alignment requirement of the `fd_tls_t` type.
- **See Also**: [`fd_tls_align`](<fd_tls.c.md#fd_tls_align>)  (Implementation)


---
### fd\_tls\_footprint<!-- {{#callable_declaration:fd_tls_footprint}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.h#L358>)

Returns the memory footprint of the TLS configuration structure.
- **Description**: Use this function to determine the size, in bytes, of the `fd_tls_t` structure. This is useful for memory allocation purposes when working with TLS configurations. The function does not require any parameters and can be called at any time to retrieve the size of the TLS configuration structure.
- **Inputs**: None
- **Output**: The function returns an unsigned long integer representing the size of the `fd_tls_t` structure in bytes.
- **See Also**: [`fd_tls_footprint`](<fd_tls.c.md#fd_tls_footprint>)  (Implementation)


---
### fd\_tls\_new<!-- {{#callable_declaration:fd_tls_new}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.h#L363>)

Initializes a memory region for TLS operations.
- **Description**: Use this function to prepare a memory region for TLS operations. The memory region must be aligned according to the alignment requirements of the TLS implementation. This function clears the memory region to zero and returns a pointer to it. If the memory region is not aligned or is null, the function logs a warning and returns null. Ensure that the memory region is properly aligned and non-null before calling this function.
- **Inputs**:
    - `mem`: A pointer to a memory region to initialize. Must not be null and must be aligned according to `fd_tls_align()`. If null or unaligned, the function logs a warning and returns null.
- **Output**: Returns a pointer to the initialized memory region, or null if the input is invalid.
- **See Also**: [`fd_tls_new`](<fd_tls.c.md#fd_tls_new>)  (Implementation)


---
### fd\_tls\_join<!-- {{#callable_declaration:fd_tls_join}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.h#L366>)

Casts a memory pointer to a `fd_tls_t` pointer.
- **Description**: Use this function to convert a generic memory pointer to a `fd_tls_t` pointer. This is typically done after allocating or obtaining a memory block intended to be used as a `fd_tls_t` structure. Ensure that the memory pointed to by `mem` is correctly aligned and sized for a `fd_tls_t` structure before calling this function. This function does not perform any validation or initialization of the memory content.
- **Inputs**:
    - `mem`: A pointer to a memory block that is expected to be a `fd_tls_t` structure. The caller must ensure that this memory is properly allocated and aligned. Passing a null pointer or an incorrectly sized or aligned memory block can lead to undefined behavior.
- **Output**: Returns a pointer to `fd_tls_t` that points to the same memory location as `mem`.
- **See Also**: [`fd_tls_join`](<fd_tls.c.md#fd_tls_join>)  (Implementation)


---
### fd\_tls\_leave<!-- {{#callable_declaration:fd_tls_leave}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.h#L369>)

Returns a pointer to the given TLS server structure.
- **Description**: Use this function to obtain a pointer to the `fd_tls_t` server structure. This can be useful when you need to access or manipulate the server's TLS configuration or state. Ensure that the `server` parameter is a valid pointer to an `fd_tls_t` structure before calling this function.
- **Inputs**:
    - `server`: A pointer to an `fd_tls_t` structure representing the TLS server. Must not be null and should point to a valid TLS server configuration.
- **Output**: Returns a pointer to the `fd_tls_t` server structure provided as input.
- **See Also**: [`fd_tls_leave`](<fd_tls.c.md#fd_tls_leave>)  (Implementation)


---
### fd\_tls\_delete<!-- {{#callable_declaration:fd_tls_delete}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.h#L372>)

Returns the input memory pointer.
- **Description**: Use this function to release resources associated with a TLS object. It is typically called when the TLS object is no longer needed. Ensure that the memory pointed to by the input parameter is valid and was previously allocated for a TLS object. This function does not perform any deallocation or cleanup beyond returning the pointer.
- **Inputs**:
    - `mem`: A pointer to the memory associated with a TLS object. The pointer must be valid and previously allocated. The function does not check for null or invalid pointers.
- **Output**: Returns the same pointer that was passed as input.
- **See Also**: [`fd_tls_delete`](<fd_tls.c.md#fd_tls_delete>)  (Implementation)


---
### fd\_tls\_alert\_cstr<!-- {{#callable_declaration:fd_tls_alert_cstr}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.h#L375>)

Returns a string representation of a TLS alert code.
- **Description**: Use this function to obtain a human-readable string that describes a given TLS alert code. This is useful for logging or debugging purposes when you need to understand the nature of a TLS alert. The function handles a predefined set of alert codes and returns "unknown alert" for any code not explicitly recognized. It is important to ensure that the alert code provided is valid and within the expected range of TLS alert codes.
- **Inputs**:
    - `alert`: An unsigned integer representing the TLS alert code. The function expects this to be a valid TLS alert code. If the code is not recognized, the function returns "unknown alert".
- **Output**: A constant character pointer to a string describing the TLS alert. If the alert code is not recognized, the string "unknown alert" is returned.
- **See Also**: [`fd_tls_alert_cstr`](<fd_tls.c.md#fd_tls_alert_cstr>)  (Implementation)


---
### fd\_tls\_reason\_cstr<!-- {{#callable_declaration:fd_tls_reason_cstr}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.h#L378>)

Returns a string description for a given TLS reason code.
- **Description**: Use this function to obtain a human-readable string that describes a specific TLS reason code. This is useful for debugging and logging purposes, as it provides insight into why a particular TLS operation failed or behaved unexpectedly. The function handles a wide range of predefined reason codes, each corresponding to a specific error or state in the TLS handshake process. If the provided reason code does not match any known code, the function returns a generic 'unknown reason' message. This function does not modify any input parameters and does not have side effects.
- **Inputs**:
    - `reason`: An unsigned integer representing a TLS reason code. Valid values are predefined constants that correspond to specific TLS errors or states. If the value does not match any known reason code, the function returns a generic message.
- **Output**: A constant character pointer to a string describing the TLS reason code. The string provides a human-readable explanation of the reason code.
- **See Also**: [`fd_tls_reason_cstr`](<fd_tls.c.md#fd_tls_reason_cstr>)  (Implementation)


---
### fd\_tls\_server\_handshake<!-- {{#callable_declaration:fd_tls_server_handshake}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.h#L387>)

Processes a TLS message from a client during a server handshake.
- **Description**: Use this function to process a TLS message received from a client during a server-side handshake. It synchronously processes the message and expects the record to be complete, as it does not handle defragmentation. This function is part of a TLS 1.3 handshake implementation and is specific to securing peer-to-peer QUIC connections. It returns the number of bytes read on success or a negated TLS alert code on failure. Ensure that the handshake state is valid before calling this function.
- **Inputs**:
    - `server`: A pointer to a constant `fd_tls_t` structure representing the server's TLS configuration. Must not be null.
    - `handshake`: A pointer to an `fd_tls_estate_srv_t` structure representing the server's handshake state. Must not be null.
    - `msg`: A pointer to the message buffer containing the TLS message from the client. Must not be null.
    - `msg_sz`: The size of the message buffer in bytes. Must be a valid size for the message.
    - `encryption_level`: An unsigned integer indicating the encryption level to use. Must be one of the defined TLS encryption levels.
- **Output**: Returns the number of bytes read on success or a negated TLS alert code on failure.
- **See Also**: [`fd_tls_server_handshake`](<fd_tls.c.md#fd_tls_server_handshake>)  (Implementation)


---
### fd\_tls\_client\_handshake<!-- {{#callable_declaration:fd_tls_client_handshake}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.h#L398>)

Processes a TLS handshake message for a client.
- **Description**: Use this function to process a TLS handshake message on the client side. It handles different stages of the TLS handshake based on the current state of the handshake. This function must not be called with messages sent after the handshake is completed, such as NewSessionTicket messages. It returns the number of bytes read on success or a negated TLS alert code on failure.
- **Inputs**:
    - `client`: A pointer to a `fd_tls_t` structure containing the local TLS configuration. Must not be null. The caller retains ownership.
    - `handshake`: A pointer to a `fd_tls_estate_cli_t` structure representing the current state of the client-side handshake. Must not be null. The caller retains ownership.
    - `record`: A pointer to the buffer containing the TLS message to process. The content must be complete and not fragmented. The caller retains ownership.
    - `record_sz`: The size of the `record` buffer in bytes. Must accurately represent the size of the data in `record`.
    - `encryption_level`: An unsigned integer indicating the encryption level to use. Valid values are defined by the TLS protocol, such as `FD_TLS_LEVEL_HANDSHAKE` or `FD_TLS_LEVEL_APPLICATION`.
- **Output**: Returns the number of bytes read on success or a negated TLS alert code on failure.
- **See Also**: [`fd_tls_client_handshake`](<fd_tls.c.md#fd_tls_client_handshake>)  (Implementation)


---
### fd\_tls\_hkdf\_expand\_label<!-- {{#callable_declaration:fd_tls_hkdf_expand_label}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.h#L434>)

Performs the TLS 1.3 HKDF-Expand function with SHA-256.
- **Description**: Use this function to derive a cryptographic key from a given secret, label, and context as specified in TLS 1.3. It is important to ensure that the output buffer is large enough to hold the derived key, and that the label and context sizes do not exceed their maximum allowed lengths. This function is typically used in the context of establishing secure communications in a TLS handshake.
- **Inputs**:
    - `out`: A pointer to a buffer where the derived key will be written. Must not be null and should have a size of at least `out_sz` bytes.
    - `out_sz`: The size of the output key in bytes. Must be between 1 and 32, inclusive.
    - `secret`: A 32-byte array containing the secret value used in the key derivation. Must not be null.
    - `label`: A pointer to a string containing the label used in the key derivation. Can be null if `label_sz` is 0.
    - `label_sz`: The size of the label in bytes. Must be between 0 and 64, inclusive.
    - `context`: A pointer to a byte array containing the context used in the key derivation. Can be null if `context_sz` is 0.
    - `context_sz`: The size of the context in bytes. Must be between 0 and 64, inclusive.
- **Output**: Returns a pointer to the output buffer `out` containing the derived key.
- **See Also**: [`fd_tls_hkdf_expand_label`](<fd_tls.c.md#fd_tls_hkdf_expand_label>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)