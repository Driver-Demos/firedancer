<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements TLS 1.3 handshake and cryptographic operations, including client and server state management.

# Purpose
The code is a C implementation of a Transport Layer Security (TLS) 1.3 protocol, focusing on the handshake process between a client and a server. It includes functions for both server-side and client-side operations, such as [`fd_tls_server_handshake`](<#fd_tls_server_handshake>) and [`fd_tls_client_handshake`](<#fd_tls_client_handshake>), which manage the sequence of messages exchanged during the TLS handshake. The code handles various stages of the handshake, including the generation and verification of cryptographic keys, the exchange of certificates, and the negotiation of cryptographic parameters. It also includes functions for encoding and decoding TLS messages, managing cryptographic secrets, and handling alerts and errors.

The code defines several structures and functions to support the TLS handshake process, including `fd_tls_t`, `fd_tls_estate_srv_t`, and `fd_tls_estate_cli_t` for managing server and client states. It uses cryptographic functions such as `fd_hmac_sha256` and `fd_x25519_exchange` to perform key derivation and exchange. The code also includes utility functions like [`fd_tls_alert`](<#fd_tls_alert>) and [`fd_tls_reason_cstr`](<#fd_tls_reason_cstr>) to handle and describe TLS alerts and errors. The implementation is designed to be integrated into a larger system, as indicated by the use of callback functions for sending messages and handling secrets.
# Imports and Dependencies

---
- `fd_tls.h`
- `fd_tls_proto.h`
- `../../ballet/ed25519/fd_ed25519.h`
- `../../ballet/ed25519/fd_x25519.h`
- `../../ballet/hmac/fd_hmac.h`
- `assert.h`


# Global Variables

---
### fd\_tls13\_cli\_sign\_prefix
- **Type**: `char const`
- **Description**: Contains a 98-character string used as a prefix for the client CertificateVerify message in the TLS 1.3 protocol. The string consists of 64 spaces followed by the text 'TLS 1.3, client CertificateVerify'.
- **Use**: Used in the TLS 1.3 handshake process to create a message that the client signs for verification.


---
### fd\_tls13\_srv\_sign\_prefix
- **Type**: ``char const[98]``
- **Description**: Contains a constant character array of 98 characters, which includes 64 spaces followed by the string 'TLS 1.3, server CertificateVerify'. This array is used in the context of TLS 1.3 server-side operations.
- **Use**: Used as a prefix in the creation of a message to be signed during the TLS 1.3 handshake process, specifically for server CertificateVerify messages.


---
### empty\_hash
- **Type**: ``uchar const[32]``
- **Description**: Represents a constant array of 32 unsigned characters that contains the SHA-256 hash of an empty input.
- **Use**: Used as a default or initial hash value in cryptographic operations.


---
### handshake\_derived
- **Type**: ``uchar const[32]``
- **Description**: A static constant array of 32 unsigned characters, representing a pre-generated key derived during the TLS handshake process.
- **Use**: Used as a salt in the HMAC-SHA256 function to derive the main handshake secret.


# Functions

---
### fd\_tls\_align<!-- {{#callable:fd_tls_align}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L53>)

Returns the alignment requirement of the `fd_tls_t` type.
- **Inputs**: None
- **Logic and Control Flow**:
    - Uses the `alignof` operator to determine the alignment requirement of the `fd_tls_t` type.
    - Returns the alignment value as an unsigned long integer.
- **Output**: An unsigned long integer representing the alignment requirement of the `fd_tls_t` type.


---
### fd\_tls\_footprint<!-- {{#callable:fd_tls_footprint}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L58>)

Returns the size of the `fd_tls_t` structure in bytes.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calculate the size of the `fd_tls_t` structure using the `sizeof` operator.
    - Return the calculated size.
- **Output**: The function returns an `ulong` representing the size of the `fd_tls_t` structure.


---
### fd\_tls\_new<!-- {{#callable:fd_tls_new}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L63>)

Initializes a memory block for a TLS structure if the memory is non-null and properly aligned.
- **Inputs**:
    - `mem`: A pointer to a memory block intended for TLS structure initialization.
- **Logic and Control Flow**:
    - Check if `mem` is NULL; if true, log a warning and return NULL.
    - Check if `mem` is aligned according to `fd_tls_align()`; if not, log a warning and return NULL.
    - Calculate the footprint size using `fd_tls_footprint()`.
    - Set the memory block to zero using `memset()`.
    - Return the pointer to the initialized memory block.
- **Output**: Returns the pointer to the initialized memory block or NULL if the input is invalid.
- **Functions Called**:
    - [`fd_tls_align`](<#fd_tls_align>)
    - [`fd_tls_footprint`](<#fd_tls_footprint>)


---
### fd\_tls\_join<!-- {{#callable:fd_tls_join}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L81>)

Casts a `void` pointer to a `fd_tls_t` pointer.
- **Inputs**:
    - `mem`: A pointer to memory that is expected to be of type `fd_tls_t`.
- **Logic and Control Flow**:
    - Casts the input `mem` to a `fd_tls_t` pointer.
    - Returns the casted pointer.
- **Output**: A pointer of type `fd_tls_t`.


---
### fd\_tls\_leave<!-- {{#callable:fd_tls_leave}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L86>)

Returns the input `fd_tls_t` pointer cast to a `void` pointer.
- **Inputs**:
    - `server`: A pointer to an `fd_tls_t` structure.
- **Logic and Control Flow**:
    - Casts the `server` pointer to a `void` pointer.
    - Returns the casted pointer.
- **Output**: A `void` pointer that is the same as the input `server` pointer.


---
### fd\_tls\_delete<!-- {{#callable:fd_tls_delete}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L91>)

Returns the input pointer `mem` without modification.
- **Inputs**:
    - `mem`: A pointer to a memory location, which is returned as is.
- **Logic and Control Flow**:
    - The function takes a single input, `mem`, which is a pointer.
    - It returns the same pointer `mem` without any changes.
- **Output**: The function returns the same pointer `mem` that it receives as input.


---
### fd\_tls\_estate\_srv\_new<!-- {{#callable:fd_tls_estate_srv_new}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L99>)

Initializes a new `fd_tls_estate_srv_t` structure for a TLS server handshake state.
- **Inputs**:
    - `mem`: A pointer to a memory block where the `fd_tls_estate_srv_t` structure will be initialized.
- **Logic and Control Flow**:
    - Cast the `mem` pointer to a `fd_tls_estate_srv_t` pointer and assign it to `hs`.
    - Use `memset` to zero out the memory for the `fd_tls_estate_srv_t` structure.
    - Set the `state` field of the `base` structure within `hs` to `FD_TLS_HS_START`.
    - Set the `server` field of the `base` structure within `hs` to 1, indicating a server role.
    - Return the pointer `hs`.
- **Output**: Returns a pointer to the initialized `fd_tls_estate_srv_t` structure.


---
### fd\_tls\_estate\_cli\_new<!-- {{#callable:fd_tls_estate_cli_new}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L111>)

Initializes a new client-side TLS handshake state structure with default values.
- **Inputs**:
    - `mem`: A pointer to a memory block where the new `fd_tls_estate_cli_t` structure will be initialized.
- **Logic and Control Flow**:
    - Cast the `mem` pointer to a `fd_tls_estate_cli_t` pointer and assign it to `hs`.
    - Use `memset` to zero out the memory for the `fd_tls_estate_cli_t` structure.
    - Set the `state` field of the `base` member of `hs` to `FD_TLS_HS_START`.
    - Return the pointer `hs`.
- **Output**: Returns a pointer to the initialized `fd_tls_estate_cli_t` structure.


---
### fd\_tls\_hkdf\_expand\_label<!-- {{#callable:fd_tls_hkdf_expand_label}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L122>)

Expands a TLS 1.3 HKDF label to derive a key using HMAC-SHA256.
- **Inputs**:
    - `out`: A pointer to the output buffer where the derived key will be stored.
    - `out_sz`: The size of the output buffer in bytes.
    - `secret`: A 32-byte secret key used as input to the HMAC function.
    - `label`: A pointer to a string representing the label used in the HKDF expansion.
    - `label_sz`: The size of the label string in bytes.
    - `context`: A pointer to the context data used in the HKDF expansion.
    - `context_sz`: The size of the context data in bytes.
- **Logic and Control Flow**:
    - Check that `label_sz`, `context_sz`, and `out_sz` do not exceed their respective limits.
    - Initialize an `info` buffer to store the HKDF info structure.
    - Set the first two bytes of `info` to the output size.
    - Add the label length and the label prefixed with 'tls13 ' to `info`.
    - Add the context length and the context to `info`.
    - Append a suffix byte `0x01` to `info`.
    - Compute the HMAC-SHA256 of `info` using `secret` and store the result in `hash`.
    - Copy the first `out_sz` bytes of `hash` to `out`.
- **Output**: Returns a pointer to the output buffer `out` containing the derived key.


---
### fd\_tls\_has\_alpn<!-- {{#callable:fd_tls_has_alpn}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L174>)

Checks if a target ALPN protocol is present in a list of ALPN protocols.
- **Inputs**:
    - `list`: A pointer to the list of ALPN protocols.
    - `list_sz`: The size of the ALPN protocol list.
    - `target`: A pointer to the target ALPN protocol to search for.
    - `target_sz`: The size of the target ALPN protocol.
- **Logic and Control Flow**:
    - If `target_sz` is less than or equal to 1, return 0.
    - Calculate the end of the list using `list` and `list_sz`.
    - Iterate over the list while `list` is less than `list_end`.
    - For each element, get its size `ele_sz` from the first byte and increment `list` by 1.
    - Check if `ele_sz` is greater than the remaining list size; if so, return -1.
    - Increment `list` by `ele_sz` to move to the next element.
    - If `ele_sz` matches `target_sz - 1` and the memory comparison of the element and `target` (offset by 1) is zero, return 1.
    - If no match is found, return 0.
- **Output**: Returns 1 if the target ALPN protocol is found, 0 if not found, and -1 if there is an error in the list format.


---
### fd\_tls\_alert<!-- {{#callable:fd_tls_alert}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L199>)

Sets a handshake failure alert and reason code in the TLS handshake state.
- **Inputs**:
    - ``hs``: A pointer to a `fd_tls_estate_base_t` structure representing the TLS handshake state.
    - ``alert``: An unsigned integer representing the alert code to be set.
    - ``reason``: An unsigned short representing the reason code to be set.
- **Logic and Control Flow**:
    - Assigns the `reason` value to the `reason` field of the `hs` structure.
    - Returns the negative value of the `alert` argument cast to a long.
- **Output**: Returns a negative long integer representing the alert code.


---
### fd\_tls\_send\_cert\_verify<!-- {{#callable:fd_tls_send_cert_verify}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L215>)

Generates and sends a CertificateVerify message during a TLS handshake.
- **Inputs**:
    - ``this``: A pointer to the `fd_tls_t` structure representing the local client or server object.
    - ``hs``: A pointer to the `fd_tls_estate_base_t` structure representing the local handshake state.
    - ``transcript``: A pointer to the `fd_sha256_t` structure representing the SHA-256 state of the transcript hasher.
    - ``is_client``: An integer indicating if the local role is a client (1) or a server (0).
- **Logic and Control Flow**:
    - Copy the appropriate TLS 1.3 prefix (client or server) into `sign_msg` based on `is_client`.
    - Clone the `transcript` and finalize it to append the hash to `sign_msg`.
    - Sign the `sign_msg` using the [`fd_tls_sign`](<fd_tls.h.md#fd_tls_sign>) function and store the signature in `cert_verify_sig`.
    - Prepare a buffer `msg_buf` for the CertificateVerify message and leave space for the message header.
    - Construct a `fd_tls_cert_verify_t` structure with the signature algorithm and signature, then encode it into `msg_buf`.
    - Check if encoding fails, and if so, return a TLS alert with the appropriate reason.
    - Encode the message header and calculate the total size of the CertificateVerify message.
    - Send the CertificateVerify message using the `sendmsg_fn` callback function.
    - If sending fails, return a TLS alert indicating an internal error.
    - Append the CertificateVerify message to the `transcript` hash.
- **Output**: Returns 0L on success or a negated TLS alert number on failure.
- **Functions Called**:
    - [`fd_tls_sign`](<fd_tls.h.md#fd_tls_sign>)
    - [`fd_tls_encode_cert_verify`](<fd_tls_proto.c.md#fd_tls_encode_cert_verify>)
    - [`fd_tls_alert`](<#fd_tls_alert>)
    - [`fd_uint_to_tls_u24`](<fd_tls_proto.h.md#fd_uint_to_tls_u24>)


---
### fd\_tls\_server\_handshake<!-- {{#callable:fd_tls_server_handshake}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L293>)

Handles the server-side TLS handshake process by delegating to specific functions based on the current handshake state.
- **Inputs**:
    - `server`: A pointer to a constant `fd_tls_t` structure representing the server.
    - `handshake`: A pointer to an `fd_tls_estate_srv_t` structure representing the handshake state.
    - `msg`: A pointer to a constant void representing the message data.
    - `msg_sz`: An unsigned long representing the size of the message data.
    - `encryption_level`: An unsigned integer representing the encryption level.
- **Logic and Control Flow**:
    - Checks the current state of the handshake using a switch statement on `handshake->base.state`.
    - If the state is `FD_TLS_HS_START`, calls [`fd_tls_server_hs_start`](<#fd_tls_server_hs_start>) with the provided arguments and returns its result.
    - If the state is `FD_TLS_HS_WAIT_FINISHED`, calls [`fd_tls_server_hs_wait_finished`](<#fd_tls_server_hs_wait_finished>) with the provided arguments and returns its result.
    - For any other state, calls [`fd_tls_alert`](<#fd_tls_alert>) to return an internal error alert with an illegal state reason.
- **Output**: Returns a long integer which is the result of the called function or an alert code in case of an error.
- **Functions Called**:
    - [`fd_tls_server_hs_start`](<#fd_tls_server_hs_start>)
    - [`fd_tls_server_hs_wait_finished`](<#fd_tls_server_hs_wait_finished>)
    - [`fd_tls_alert`](<#fd_tls_alert>)


---
### fd\_tls\_server\_hs\_retry<!-- {{#callable:fd_tls_server_hs_retry}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L309>)

Handles a TLS server handshake retry by creating and sending a HelloRetryRequest message if necessary.
- **Inputs**:
    - ``server``: A pointer to a `fd_tls_t` structure representing the server.
    - ``handshake``: A pointer to a `fd_tls_estate_srv_t` structure representing the server's handshake state.
    - ``ch``: A pointer to a `fd_tls_client_hello_t` structure representing the client's hello message.
    - ``ch1_hash``: A 32-byte array containing the hash of the client's initial hello message.
- **Logic and Control Flow**:
    - Check if a retry has already occurred by examining `handshake->hello_retry`; if true, return an alert indicating an illegal parameter.
    - Set `handshake->hello_retry` to 1 to indicate a retry is in progress.
    - Initialize a message buffer `msg_buf` of size 512 bytes to construct the HelloRetryRequest message.
    - Initialize a SHA-256 transcript hasher and append a prefix and the `ch1_hash` to it.
    - Construct a `fd_tls_server_hello_t` structure with predefined cipher suite and key share, and copy the server's public key into it.
    - Encode the HelloRetryRequest message using [`fd_tls_encode_hello_retry_request`](<fd_tls_proto.c.md#fd_tls_encode_hello_retry_request>) and check for encoding errors; if an error occurs, return an alert with the error code.
    - Send the HelloRetryRequest message using the server's `sendmsg_fn` function and check for sending errors; if an error occurs, return an alert indicating an internal error.
    - Append the HelloRetryRequest message to the transcript hash.
    - Store the transcript hash state in `handshake->transcript`.
    - Set `handshake->base.state` to `FD_TLS_HS_START` to indicate the handshake process is restarting.
- **Output**: Returns 0 on success or a negative TLS alert number on failure.
- **Functions Called**:
    - [`fd_tls_alert`](<#fd_tls_alert>)
    - [`fd_tls_encode_hello_retry_request`](<fd_tls_proto.c.md#fd_tls_encode_hello_retry_request>)
    - [`fd_uint_to_tls_u24`](<fd_tls_proto.h.md#fd_uint_to_tls_u24>)
    - [`fd_tls_transcript_store`](<fd_tls_estate.h.md#fd_tls_transcript_store>)


---
### fd\_tls\_server\_hs\_start<!-- {{#callable:fd_tls_server_hs_start}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L400>)

Initiates the TLS handshake process for a server by processing the client's initial message and responding with necessary handshake messages.
- **Inputs**:
    - `server`: A pointer to a constant `fd_tls_t` structure representing the server's TLS context.
    - `handshake`: A pointer to a `fd_tls_estate_srv_t` structure representing the server's handshake state.
    - `record`: A pointer to a constant unsigned character array containing the client's initial message.
    - `record_sz`: An unsigned long integer representing the size of the client's initial message.
    - `encryption_level`: An unsigned integer indicating the encryption level of the message, expected to be `FD_TLS_LEVEL_INITIAL`.
- **Logic and Control Flow**:
    - Check if QUIC transport parameters are needed and retrieve them if necessary.
    - Verify that the encryption level is `FD_TLS_LEVEL_INITIAL`.
    - Initialize or load the transcript hasher based on whether a hello retry is needed.
    - Decode the client's message header and ensure it is a ClientHello message.
    - Check the client's cryptographic compatibility with TLS 1.3, X25519, Ed25519, and AES-128-GCM.
    - Store the client's random value for SSLKEYLOGFILE purposes.
    - If in QUIC mode, ensure the client provided QUIC transport parameters and inform the user of them.
    - Verify that the client advertised ALPN if required by the server.
    - Record the ClientHello message in the transcript hash.
    - If the client's key share is missing, initiate a retry process.
    - Generate a server random value and construct a ServerHello message.
    - Send the ServerHello message and record it in the transcript hash.
    - Derive handshake secrets using ECDH and HKDF operations.
    - Send EncryptedExtensions, Certificate, CertificateVerify, and Finished messages, recording each in the transcript hash.
    - Derive application secrets and store the transcript hash state.
    - Set the handshake state to `FD_TLS_HS_WAIT_FINISHED`.
- **Output**: Returns a long integer representing the size of the processed client message or a negative value indicating an error with a specific TLS alert.
- **Functions Called**:
    - [`fd_tls_alert`](<#fd_tls_alert>)
    - [`fd_tls_transcript_load`](<fd_tls_estate.h.md#fd_tls_transcript_load>)
    - [`fd_tls_decode_client_hello`](<fd_tls_proto.c.md#fd_tls_decode_client_hello>)
    - [`fd_tls_has_alpn`](<#fd_tls_has_alpn>)
    - [`fd_tls_server_hs_retry`](<#fd_tls_server_hs_retry>)
    - [`fd_tls_rand`](<fd_tls.h.md#fd_tls_rand>)
    - [`fd_tls_encode_server_hello`](<fd_tls_proto.c.md#fd_tls_encode_server_hello>)
    - [`fd_uint_to_tls_u24`](<fd_tls_proto.h.md#fd_uint_to_tls_u24>)
    - [`fd_tls_hkdf_expand_label`](<#fd_tls_hkdf_expand_label>)
    - [`fd_tls_encode_enc_ext`](<fd_tls_proto.c.md#fd_tls_encode_enc_ext>)
    - [`fd_tls_encode_raw_public_key`](<fd_tls_proto.c.md#fd_tls_encode_raw_public_key>)
    - [`fd_tls_encode_cert_x509`](<fd_tls_proto.c.md#fd_tls_encode_cert_x509>)
    - [`fd_tls_send_cert_verify`](<#fd_tls_send_cert_verify>)
    - [`fd_tls_msg_hdr_bswap`](<fd_tls_proto.h.md#fd_tls_msg_hdr_bswap>)
    - [`fd_tls_transcript_store`](<fd_tls_estate.h.md#fd_tls_transcript_store>)


---
### fd\_tls\_handle\_cert\_chain<!-- {{#callable:fd_tls_handle_cert_chain}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L821>)

Processes a certificate chain to extract and verify the public key, handling errors and returning the size of the certificate chain if successful.
- **Inputs**:
    - ``base``: A pointer to `fd_tls_estate_base_t`, representing the TLS handshake state.
    - ``cert_chain``: A pointer to the certificate chain data.
    - ``cert_chain_sz``: The size of the certificate chain in bytes.
    - ``expected_pubkey``: A pointer to the expected public key for verification, or `NULL` if not used.
    - ``out_pubkey``: A pointer to store the extracted public key, or `NULL` if not used.
    - ``is_rpk``: An integer indicating if the certificate is a raw public key (1) or X.509 (0).
- **Logic and Control Flow**:
    - Calls [`fd_tls_extract_cert_pubkey`](<fd_tls_proto.c.md#fd_tls_extract_cert_pubkey>) to extract the public key from the certificate chain.
    - Checks if the extraction was successful; if not, calls [`fd_tls_alert`](<#fd_tls_alert>) with the alert and reason from the extraction result.
    - If `expected_pubkey` is provided, compares it with the extracted public key; if they do not match, calls [`fd_tls_alert`](<#fd_tls_alert>) with a handshake failure alert.
    - If `out_pubkey` is provided, copies the extracted public key to `out_pubkey`.
    - Skips processing of extensions and remaining certificate chain.
    - Returns the size of the certificate chain as a long integer.
- **Output**: Returns the size of the certificate chain as a long integer, or a negative value indicating an alert if an error occurs.
- **Functions Called**:
    - [`fd_tls_extract_cert_pubkey`](<fd_tls_proto.c.md#fd_tls_extract_cert_pubkey>)
    - [`fd_tls_alert`](<#fd_tls_alert>)


---
### fd\_tls\_handle\_cert\_verify<!-- {{#callable:fd_tls_handle_cert_verify}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L847>)

Handles the verification of a TLS CertificateVerify message by decoding it, checking the signature algorithm, and verifying the signature using the provided public key.
- **Inputs**:
    - ``hs``: A pointer to the handshake state structure (`fd_tls_estate_base_t`).
    - ``transcript``: A constant pointer to the SHA-256 state of the transcript hash.
    - ``record``: A constant pointer to the byte array containing the CertificateVerify message.
    - ``record_sz``: The size of the `record` in bytes.
    - ``pubkey``: A constant array of 32 bytes representing the public key used for signature verification.
    - ``is_client``: An integer indicating if the local role is a client (1) or not (0).
- **Logic and Control Flow**:
    - Initialize a `fd_tls_cert_verify_t` structure to store the decoded CertificateVerify message.
    - Decode the message header from the `record` and check if the message type is `FD_TLS_MSG_CERT_VERIFY` and the size is 0x44 bytes.
    - If the message type or size is incorrect, return a decode error alert.
    - Decode the CertificateVerify message into the `vfy` structure.
    - Check if the signature algorithm is `FD_TLS_SIGNATURE_ED25519`; if not, return a handshake failure alert.
    - Prepare the message to be signed by copying the appropriate prefix (`fd_tls13_cli_sign_prefix` or `fd_tls13_srv_sign_prefix`) and appending the transcript hash.
    - Verify the signature using `fd_ed25519_verify` with the prepared message, the signature from `vfy`, and the provided `pubkey`.
    - If the signature verification fails, return a decrypt error alert.
    - Return the number of bytes read from the `record`.
- **Output**: Returns a `long` indicating the number of bytes read from the `record` on success, or a negative value representing a TLS alert code on failure.
- **Functions Called**:
    - [`fd_tls_u24_to_uint`](<fd_tls_proto.h.md#fd_tls_u24_to_uint>)
    - [`fd_tls_alert`](<#fd_tls_alert>)
    - [`fd_tls_decode_cert_verify`](<fd_tls_proto.c.md#fd_tls_decode_cert_verify>)


---
### fd\_tls\_server\_hs\_wait\_finished<!-- {{#callable:fd_tls_server_hs_wait_finished}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L914>)

Processes the client's 'Finished' message during a TLS handshake and verifies the integrity of the handshake process.
- **Inputs**:
    - ``server``: A pointer to a `fd_tls_t` structure representing the server, which is not used in this function.
    - ``handshake``: A pointer to a `fd_tls_estate_srv_t` structure representing the server's handshake state.
    - ``record``: A pointer to the incoming record data containing the client's 'Finished' message.
    - ``record_sz``: The size of the incoming record data.
    - ``encryption_level``: The encryption level of the incoming message, expected to be `FD_TLS_LEVEL_HANDSHAKE`.
- **Logic and Control Flow**:
    - Check if the `encryption_level` is `FD_TLS_LEVEL_HANDSHAKE`; if not, return an alert for wrong encryption level.
    - Load the current transcript state from `handshake->transcript`.
    - Decode the incoming message header and verify it is a 'Finished' message; if not, return an alert for unexpected message type.
    - Decode the 'Finished' message and calculate the size of the data read.
    - Export the current transcript hash and derive the 'Finished' key using the client's handshake secret.
    - Derive the expected 'Finished' verify data using HMAC-SHA256 with the transcript hash and the derived 'Finished' key.
    - Compare the received 'Finished' verify data with the expected data; if they do not match, return an alert for decrypt error.
    - If verification is successful, update the handshake state to `FD_TLS_HS_CONNECTED`.
- **Output**: Returns the size of the data read from the record if successful, or a negative value indicating an alert if an error occurs.
- **Functions Called**:
    - [`fd_tls_alert`](<#fd_tls_alert>)
    - [`fd_tls_transcript_load`](<fd_tls_estate.h.md#fd_tls_transcript_load>)
    - [`fd_tls_hkdf_expand_label`](<#fd_tls_hkdf_expand_label>)


---
### fd\_tls\_client\_handshake<!-- {{#callable:fd_tls_client_handshake}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L1005>)

Manages the TLS client handshake process by handling different handshake states and invoking appropriate functions based on the current state.
- **Inputs**:
    - ``client``: A pointer to a constant `fd_tls_t` structure representing the TLS client.
    - ``handshake``: A pointer to an `fd_tls_estate_cli_t` structure representing the client's handshake state.
    - ``record``: A pointer to a constant void representing the incoming record data.
    - ``record_sz``: An unsigned long representing the size of the incoming record data.
    - ``encryption_level``: An unsigned integer representing the encryption level of the incoming record.
- **Logic and Control Flow**:
    - Checks the current state of the handshake using a switch statement on `handshake->base.state`.
    - If the state is `FD_TLS_HS_START`, ignores the `record`, `record_sz`, and `encryption_level` arguments and calls [`fd_tls_client_hs_start`](<#fd_tls_client_hs_start>).
    - If the state is `FD_TLS_HS_WAIT_SH`, calls [`fd_tls_client_hs_wait_sh`](<#fd_tls_client_hs_wait_sh>) to handle the incoming ServerHello message.
    - If the state is `FD_TLS_HS_WAIT_EE`, calls [`fd_tls_client_hs_wait_ee`](<#fd_tls_client_hs_wait_ee>) to handle the incoming EncryptedExtensions message.
    - If the state is `FD_TLS_HS_WAIT_CERT_CR`, calls [`fd_tls_client_hs_wait_cert_cr`](<#fd_tls_client_hs_wait_cert_cr>) to handle the incoming CertificateRequest or Certificate message.
    - If the state is `FD_TLS_HS_WAIT_CERT`, calls [`fd_tls_client_hs_wait_cert`](<#fd_tls_client_hs_wait_cert>) to handle the incoming Certificate message.
    - If the state is `FD_TLS_HS_WAIT_CV`, calls [`fd_tls_client_hs_wait_cert_verify`](<#fd_tls_client_hs_wait_cert_verify>) to handle the incoming CertificateVerify message.
    - If the state is `FD_TLS_HS_WAIT_FINISHED`, calls [`fd_tls_client_hs_wait_finished`](<#fd_tls_client_hs_wait_finished>) to handle the incoming Server Finished message.
    - If the state is not recognized, returns a handshake failure alert using [`fd_tls_alert`](<#fd_tls_alert>).
- **Output**: Returns a long integer indicating the result of the handshake process, which can be a success or a negated TLS alert number on failure.
- **Functions Called**:
    - [`fd_tls_client_hs_start`](<#fd_tls_client_hs_start>)
    - [`fd_tls_client_hs_wait_sh`](<#fd_tls_client_hs_wait_sh>)
    - [`fd_tls_client_hs_wait_ee`](<#fd_tls_client_hs_wait_ee>)
    - [`fd_tls_client_hs_wait_cert_cr`](<#fd_tls_client_hs_wait_cert_cr>)
    - [`fd_tls_client_hs_wait_cert`](<#fd_tls_client_hs_wait_cert>)
    - [`fd_tls_client_hs_wait_cert_verify`](<#fd_tls_client_hs_wait_cert_verify>)
    - [`fd_tls_client_hs_wait_finished`](<#fd_tls_client_hs_wait_finished>)
    - [`fd_tls_alert`](<#fd_tls_alert>)


---
### fd\_tls\_client\_hs\_start<!-- {{#callable:fd_tls_client_hs_start}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L1039>)

Initiates a TLS client handshake by constructing and sending a ClientHello message, handling QUIC transport parameters, and updating the handshake state.
- **Inputs**:
    - `client`: A pointer to a constant `fd_tls_t` structure representing the TLS client.
    - `handshake`: A pointer to a `fd_tls_estate_cli_t` structure representing the client's handshake state.
- **Logic and Control Flow**:
    - Initialize a buffer for QUIC transport parameters and set its size to -1.
    - If the client supports QUIC, call `client->quic_tp_self_fn` to populate the QUIC transport parameters and update the size.
    - Check if the size of QUIC transport parameters exceeds the maximum allowed size and return an alert if it does.
    - Initialize a message buffer and a SHA-256 hasher for the handshake transcript.
    - Generate a random value for the client and store it in `client_random`.
    - Copy the `client_random` to the handshake's base structure for SSLKEYLOGFILE purposes.
    - Construct a `fd_tls_client_hello_t` structure with supported versions, groups, algorithms, cipher suites, key shares, QUIC transport parameters, and ALPN.
    - Encode the ClientHello message into the message buffer and handle encoding errors by returning an alert.
    - Send the ClientHello message using the `client->sendmsg_fn` callback and handle sending errors by returning an alert.
    - Append the ClientHello message to the handshake transcript hash.
    - Update the handshake state to `FD_TLS_HS_WAIT_SH`.
- **Output**: Returns 0 on success or a negative TLS alert number on failure.
- **Functions Called**:
    - [`fd_tls_alert`](<#fd_tls_alert>)
    - [`fd_tls_rand`](<fd_tls.h.md#fd_tls_rand>)
    - [`fd_tls_encode_client_hello`](<fd_tls_proto.c.md#fd_tls_encode_client_hello>)
    - [`fd_uint_to_tls_u24`](<fd_tls_proto.h.md#fd_uint_to_tls_u24>)


---
### fd\_tls\_client\_hs\_wait\_sh<!-- {{#callable:fd_tls_client_hs_wait_sh}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L1136>)

Processes the ServerHello message during a TLS handshake, derives cryptographic secrets, and updates the handshake state.
- **Inputs**:
    - ``client``: A pointer to a `fd_tls_t` structure representing the client.
    - ``handshake``: A pointer to a `fd_tls_estate_cli_t` structure representing the client's handshake state.
    - ``record``: A pointer to a buffer containing the TLS record data.
    - ``record_sz``: The size of the TLS record data in bytes.
    - ``encryption_level``: The current encryption level of the handshake, expected to be `FD_TLS_LEVEL_INITIAL`.
- **Logic and Control Flow**:
    - Checks if the `encryption_level` is `FD_TLS_LEVEL_INITIAL`; if not, returns an internal error alert.
    - Decodes the message header from the `record` and checks if it is a ServerHello message; if not, returns an unexpected message alert.
    - Decodes the ServerHello message and updates the `wire` pointer; if decoding fails, returns a decode error alert.
    - Appends the ServerHello message to the handshake transcript hash.
    - Derives the handshake secrets using ECDH key exchange and HMAC-SHA256 operations.
    - Calls the client's `secrets_fn` callback with the derived handshake secrets.
    - Derives the master secret using HMAC-SHA256.
    - Updates the handshake state to `FD_TLS_HS_WAIT_EE`.
- **Output**: Returns the number of bytes read from the `record` on success, or a negative value indicating an alert on failure.
- **Functions Called**:
    - [`fd_tls_alert`](<#fd_tls_alert>)
    - [`fd_tls_decode_server_hello`](<fd_tls_proto.c.md#fd_tls_decode_server_hello>)
    - [`fd_tls_hkdf_expand_label`](<#fd_tls_hkdf_expand_label>)


---
### fd\_tls\_client\_hs\_wait\_ee<!-- {{#callable:fd_tls_client_hs_wait_ee}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L1248>)

Processes the EncryptedExtensions message during a TLS handshake and updates the handshake state accordingly.
- **Inputs**:
    - ``client``: A pointer to a constant `fd_tls_t` structure representing the client.
    - ``handshake``: A pointer to a `fd_tls_estate_cli_t` structure representing the client's handshake state.
    - ``record``: A pointer to a constant unsigned character array containing the TLS record data.
    - ``record_sz``: An unsigned long integer representing the size of the `record`.
    - ``encryption_level``: An unsigned integer representing the encryption level of the message.
- **Logic and Control Flow**:
    - Checks if the `encryption_level` is `FD_TLS_LEVEL_HANDSHAKE`; if not, returns an internal error alert.
    - Initializes an `fd_tls_enc_ext_t` structure to store the decoded EncryptedExtensions message.
    - Decodes the message header and checks if it is of type `FD_TLS_MSG_ENCRYPTED_EXT`; if not, returns an unexpected message alert.
    - Decodes the EncryptedExtensions message and updates the `wire` pointer; if decoding fails, returns a decode error alert.
    - Appends the EncryptedExtensions message to the transcript hash.
    - Checks the server certificate type and updates the handshake state accordingly; if unsupported, returns an unsupported certificate alert.
    - Checks the client certificate type and updates the handshake state accordingly; if unsupported, returns an unsupported certificate alert.
    - In QUIC mode, checks for QUIC transport parameters and informs the user of the peer's parameters; if missing, returns a missing extension alert.
    - Checks the ALPN extension and compares it with the client's ALPN; if missing or mismatched, returns a missing extension or handshake failure alert.
    - Checks if the server requested an X.509 client certificate but only a raw public key is available; if so, returns an unsupported certificate alert.
    - Updates the handshake state to `FD_TLS_HS_WAIT_CERT_CR`.
- **Output**: Returns a long integer representing the number of bytes read from the `record` or a negative value indicating an alert.
- **Functions Called**:
    - [`fd_tls_alert`](<#fd_tls_alert>)
    - [`fd_tls_decode_enc_ext`](<fd_tls_proto.c.md#fd_tls_decode_enc_ext>)


---
### fd\_tls\_client\_handle\_cert\_req<!-- {{#callable:fd_tls_client_handle_cert_req}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L1351>)

Handles a certificate request during a TLS handshake by setting the client certificate flag and updating the handshake state.
- **Inputs**:
    - ``handshake``: A pointer to the `fd_tls_estate_cli_t` structure representing the client's handshake state.
    - ``req``: A pointer to the certificate request data, which is currently ignored.
    - ``req_sz``: The size of the certificate request data.
- **Logic and Control Flow**:
    - Ignore the content of the certificate request by casting `req` to void.
    - Set the `client_cert` flag in the `handshake` structure to 1, indicating that a client certificate is expected.
    - Update the `state` of the `handshake` to `FD_TLS_HS_WAIT_CERT`, indicating the next expected message is a certificate.
    - Return the size of the certificate request data as a long integer.
- **Output**: Returns the size of the certificate request data as a long integer.


---
### fd\_tls\_client\_handle\_cert\_chain<!-- {{#callable:fd_tls_client_handle_cert_chain}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L1366>)

Handles the certificate chain during a TLS handshake by verifying or updating the public key based on the server's public key pinning status.
- **Inputs**:
    - ``hs``: A pointer to the `fd_tls_estate_cli_t` structure representing the client's handshake state.
    - ``cert_chain``: A pointer to the certificate chain data.
    - ``cert_chain_sz``: The size of the certificate chain data in bytes.
- **Logic and Control Flow**:
    - Check if public key pinning is enabled by evaluating `hs->server_pubkey_pin`.
    - If pinning is enabled, set `expected_pubkey` to `hs->server_pubkey`; otherwise, set `out_pubkey` to `hs->server_pubkey`.
    - Call [`fd_tls_handle_cert_chain`](<#fd_tls_handle_cert_chain>) with the base handshake state, certificate chain, its size, the expected public key, the output public key, and the server certificate raw public key flag.
- **Output**: Returns a `long` indicating the result of handling the certificate chain, which may include success or an error code.
- **Functions Called**:
    - [`fd_tls_handle_cert_chain`](<#fd_tls_handle_cert_chain>)


---
### fd\_tls\_client\_hs\_wait\_cert\_cr<!-- {{#callable:fd_tls_client_hs_wait_cert_cr}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L1378>)

Processes a TLS handshake message to handle either a CertificateRequest or Certificate message, updating the handshake state accordingly.
- **Inputs**:
    - ``client``: A pointer to a constant `fd_tls_t` structure representing the TLS client.
    - ``handshake``: A pointer to an `fd_tls_estate_cli_t` structure representing the client's handshake state.
    - ``record``: A pointer to a constant unsigned character array containing the TLS record data.
    - ``record_sz``: An unsigned long integer representing the size of the TLS record data.
    - ``encryption_level``: An unsigned integer representing the encryption level of the message.
- **Logic and Control Flow**:
    - Check if `encryption_level` is not equal to `FD_TLS_LEVEL_HANDSHAKE`; if true, return an internal error alert.
    - Initialize `next_state` and `read_sz` variables.
    - Enter a loop to process the TLS record data.
    - Decode the message header using `fd_tls_decode_msg_hdr` and check for errors; if any, return a decode error alert.
    - Calculate the message size from the header and check if it exceeds the remaining data; if true, return a decode error alert.
    - Switch on the message type: if `FD_TLS_MSG_CERT_REQ`, handle the certificate request and set `next_state` to `FD_TLS_HS_WAIT_CERT`; if `FD_TLS_MSG_CERT`, handle the certificate chain and set `next_state` to `FD_TLS_HS_WAIT_CV`; otherwise, return an unexpected message alert.
    - Check for errors in handling the message; if any, return a parse error alert.
    - Update `wire` pointer and calculate `read_sz`.
    - Append the processed record data to the handshake transcript using `fd_sha256_append`.
    - Update the handshake state to `next_state`.
- **Output**: Returns the number of bytes read from the record as a long integer, or a negative value indicating an alert in case of an error.
- **Functions Called**:
    - [`fd_tls_alert`](<#fd_tls_alert>)
    - [`fd_tls_u24_to_uint`](<fd_tls_proto.h.md#fd_tls_u24_to_uint>)
    - [`fd_tls_client_handle_cert_req`](<#fd_tls_client_handle_cert_req>)
    - [`fd_tls_client_handle_cert_chain`](<#fd_tls_client_handle_cert_chain>)


---
### fd\_tls\_client\_hs\_wait\_cert<!-- {{#callable:fd_tls_client_hs_wait_cert}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L1439>)

Processes a TLS handshake message to verify and handle a certificate from the server.
- **Inputs**:
    - ``client``: A pointer to a constant `fd_tls_t` structure representing the TLS client.
    - ``handshake``: A pointer to an `fd_tls_estate_cli_t` structure representing the client's handshake state.
    - ``record``: A pointer to a constant unsigned character array containing the TLS record data.
    - ``record_sz``: An unsigned long integer representing the size of the TLS record data.
    - ``encryption_level``: An unsigned integer representing the encryption level of the TLS message.
- **Logic and Control Flow**:
    - Checks if the `encryption_level` is `FD_TLS_LEVEL_HANDSHAKE`; if not, returns an internal error alert.
    - Initializes a loop to process the TLS record data.
    - Decodes the message header from the `record` and checks for errors; if any, returns a decode error alert.
    - Verifies that the message type is `FD_TLS_MSG_CERT`; if not, returns an unexpected message alert.
    - Calculates the message size and checks if it exceeds the available data; if so, returns a decode error alert.
    - Calls [`fd_tls_client_handle_cert_chain`](<#fd_tls_client_handle_cert_chain>) to process the certificate chain; if it fails, returns an alert with the error code.
    - Updates the `wire` pointer by the size of the processed data.
    - Appends the processed data to the handshake transcript using `fd_sha256_append`.
    - Sets the handshake state to `FD_TLS_HS_WAIT_CV`.
- **Output**: Returns the number of bytes read from the `record` as a long integer.
- **Functions Called**:
    - [`fd_tls_alert`](<#fd_tls_alert>)
    - [`fd_tls_u24_to_uint`](<fd_tls_proto.h.md#fd_tls_u24_to_uint>)
    - [`fd_tls_client_handle_cert_chain`](<#fd_tls_client_handle_cert_chain>)


---
### fd\_tls\_client\_hs\_wait\_cert\_verify<!-- {{#callable:fd_tls_client_hs_wait_cert_verify}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L1491>)

Processes the server's CertificateVerify message during a TLS handshake and updates the handshake state.
- **Inputs**:
    - ``client``: A pointer to a constant `fd_tls_t` structure representing the TLS client.
    - ``hs``: A pointer to a `fd_tls_estate_cli_t` structure representing the client's handshake state.
    - ``record``: A pointer to an unsigned character array containing the CertificateVerify message from the server.
    - ``record_sz``: An unsigned long integer representing the size of the `record`.
    - ``encryption_level``: An unsigned integer representing the current encryption level, expected to be `FD_TLS_LEVEL_HANDSHAKE`.
- **Logic and Control Flow**:
    - Ignores the `client` parameter as it is not used in the function.
    - Checks if the `encryption_level` is `FD_TLS_LEVEL_HANDSHAKE`; if not, returns an internal error alert.
    - Calls [`fd_tls_handle_cert_verify`](<#fd_tls_handle_cert_verify>) to process the CertificateVerify message and verify the server's signature.
    - If [`fd_tls_handle_cert_verify`](<#fd_tls_handle_cert_verify>) returns a negative result, the function returns this result as an error.
    - Appends the processed CertificateVerify message to the handshake transcript using `fd_sha256_append`.
    - Updates the handshake state to `FD_TLS_HS_WAIT_FINISHED`.
- **Output**: Returns a long integer, which is the result of processing the CertificateVerify message. If successful, it is the size of the processed message; otherwise, it is a negative error code.
- **Functions Called**:
    - [`fd_tls_alert`](<#fd_tls_alert>)
    - [`fd_tls_handle_cert_verify`](<#fd_tls_handle_cert_verify>)


---
### fd\_tls\_client\_hs\_wait\_finished<!-- {{#callable:fd_tls_client_hs_wait_finished}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L1516>)

Processes the TLS handshake 'Finished' message from the server, verifies it, and derives application secrets.
- **Inputs**:
    - `client`: A pointer to a constant `fd_tls_t` structure representing the client.
    - `hs`: A pointer to a `fd_tls_estate_cli_t` structure representing the client's handshake state.
    - `record`: A pointer to a constant unsigned character array containing the TLS record data.
    - `record_sz`: An unsigned long integer representing the size of the TLS record data.
    - `encryption_level`: An unsigned integer representing the encryption level of the TLS record.
- **Logic and Control Flow**:
    - Checks if the `encryption_level` is `FD_TLS_LEVEL_HANDSHAKE`; if not, returns an alert with `FD_TLS_ALERT_INTERNAL_ERROR` and `FD_TLS_REASON_WRONG_ENC_LVL`.
    - Exports the transcript hash from `ClientHello` to `CertificateVerify` using `fd_sha256_fini`.
    - Derives the 'Finished' key using [`fd_tls_hkdf_expand_label`](<#fd_tls_hkdf_expand_label>) with the server handshake secret.
    - Derives the expected 'Finished' verify data using `fd_hmac_sha256`.
    - Decodes the incoming 'Finished' message from the server using `fd_tls_decode_msg_hdr` and `fd_tls_decode_finished`.
    - Records the 'Finished' message in the transcript hash using `fd_sha256_append`.
    - Verifies the 'Finished' verify data by comparing it with the expected data; if they do not match, returns an alert with `FD_TLS_ALERT_DECRYPT_ERROR` and `FD_TLS_REASON_FINI_FAIL`.
    - Exports the transcript hash from `ClientHello` to `ServerFinished`.
    - Derives client and server application secrets using [`fd_tls_hkdf_expand_label`](<#fd_tls_hkdf_expand_label>).
    - Calls the client's `secrets_fn` callback with the derived application secrets.
    - If `hs->client_cert` is set, sends the client's certificate and `CertificateVerify` message, and records them in the transcript hash.
    - Sends the client's 'Finished' message, updates the handshake state to `FD_TLS_HS_CONNECTED`, and returns the size of the read data.
- **Output**: Returns a long integer representing the size of the read data or a negative value indicating an alert error.
- **Functions Called**:
    - [`fd_tls_alert`](<#fd_tls_alert>)
    - [`fd_tls_hkdf_expand_label`](<#fd_tls_hkdf_expand_label>)
    - [`fd_tls_encode_raw_public_key`](<fd_tls_proto.c.md#fd_tls_encode_raw_public_key>)
    - [`fd_tls_encode_cert_x509`](<fd_tls_proto.c.md#fd_tls_encode_cert_x509>)
    - [`fd_tls_send_cert_verify`](<#fd_tls_send_cert_verify>)
    - [`fd_uint_to_tls_u24`](<fd_tls_proto.h.md#fd_uint_to_tls_u24>)
    - [`fd_tls_msg_hdr_bswap`](<fd_tls_proto.h.md#fd_tls_msg_hdr_bswap>)


---
### fd\_tls\_alert\_cstr<!-- {{#callable:fd_tls_alert_cstr}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L1720>)

Maps a TLS alert code to its corresponding string description.
- **Inputs**:
    - ``alert``: An unsigned integer representing the TLS alert code.
- **Logic and Control Flow**:
    - Uses a `switch` statement to match the `alert` code with predefined cases.
    - Returns a string description for each known alert code.
    - Logs a warning and returns "unknown alert" if the `alert` code does not match any predefined case.
- **Output**: A constant character pointer to the string description of the alert.


---
### fd\_tls\_reason\_cstr<!-- {{#callable:fd_tls_reason_cstr}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L1782>)

Maps a TLS reason code to a human-readable string description.
- **Inputs**:
    - ``reason``: An unsigned integer representing the TLS reason code.
- **Logic and Control Flow**:
    - Uses a `switch` statement to match the `reason` code to predefined cases.
    - For each case, returns a specific string that describes the reason code.
    - If the `reason` code does not match any predefined case, logs a warning and falls through to return "unknown reason".
- **Output**: A constant character pointer to a string describing the TLS reason.


# Function Declarations (Public API)

---
### fd\_tls\_server\_hs\_start<!-- {{#callable_declaration:fd_tls_server_hs_start}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L290>)

Initiates a TLS server handshake process.
- **Description**: Use this function to start the TLS handshake process on the server side. It processes the initial ClientHello message and responds with necessary handshake messages, including ServerHello, EncryptedExtensions, and Finished. This function must be called with the correct encryption level and a valid handshake state. It handles various handshake errors and alerts the client if any issues occur, such as unsupported TLS versions or missing extensions. Ensure that the server and handshake structures are properly initialized before calling this function.
- **Inputs**:
    - `server`: A pointer to a constant `fd_tls_t` structure representing the server. Must not be null and should be properly initialized.
    - `handshake`: A pointer to an `fd_tls_estate_srv_t` structure representing the handshake state. Must not be null and should be in the correct initial state.
    - `record`: A pointer to a constant unsigned character array containing the ClientHello message. Must not be null.
    - `record_sz`: An unsigned long representing the size of the `record` array. Must be greater than zero.
    - `encryption_level`: An unsigned integer representing the encryption level. Must be `FD_TLS_LEVEL_INITIAL` for the initial handshake.
- **Output**: Returns a long integer indicating the number of bytes processed from the ClientHello message, or a negative value representing a TLS alert code in case of an error.
- **See Also**: [`fd_tls_server_hs_start`](<#fd_tls_server_hs_start>)  (Implementation)


---
### fd\_tls\_server\_hs\_wait\_finished<!-- {{#callable_declaration:fd_tls_server_hs_wait_finished}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L291>)

Waits for and processes the client's Finished message during a TLS handshake.
- **Description**: Use this function during a TLS handshake to process the client's Finished message. It must be called when the handshake state is FD_TLS_HS_WAIT_FINISHED and the encryption level is FD_TLS_LEVEL_HANDSHAKE. The function verifies the Finished message against the expected verify data derived from the handshake transcript. If the verification fails, it returns an error alert. On success, it updates the handshake state to FD_TLS_HS_CONNECTED.
- **Inputs**:
    - `server`: A pointer to a constant `fd_tls_t` structure representing the server. This parameter is not used in the function.
    - `handshake`: A pointer to an `fd_tls_estate_srv_t` structure representing the server's handshake state. Must not be null.
    - `record`: A pointer to a buffer containing the client's Finished message. Must not be null.
    - `record_sz`: The size of the `record` buffer in bytes. Must be large enough to contain a valid Finished message.
    - `encryption_level`: The encryption level of the message. Must be `FD_TLS_LEVEL_HANDSHAKE` for the function to proceed.
- **Output**: Returns the number of bytes read from the `record` on success, or a negative value representing a TLS alert code on failure.
- **See Also**: [`fd_tls_server_hs_wait_finished`](<#fd_tls_server_hs_wait_finished>)  (Implementation)


---
### fd\_tls\_client\_hs\_start<!-- {{#callable_declaration:fd_tls_client_hs_start}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L997>)

Initiates a TLS client handshake process.
- **Description**: Use this function to start the TLS handshake process for a client. It prepares and sends the initial ClientHello message, which is the first step in establishing a secure connection. This function must be called when the handshake state is set to start. It handles the generation of necessary cryptographic parameters and manages the handshake state transition. Ensure that the `client` and `handshake` structures are properly initialized before calling this function.
- **Inputs**:
    - `client`: A pointer to a constant `fd_tls_t` structure representing the TLS client. This must be properly initialized and must not be null.
    - `handshake`: A pointer to an `fd_tls_estate_cli_t` structure representing the client's handshake state. This must be properly initialized and must not be null.
- **Output**: Returns a long integer indicating success or failure. A return value of 0 indicates success, while a negative value indicates an error with a specific alert code.
- **See Also**: [`fd_tls_client_hs_start`](<#fd_tls_client_hs_start>)  (Implementation)


---
### fd\_tls\_client\_hs\_wait\_sh<!-- {{#callable_declaration:fd_tls_client_hs_wait_sh}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L998>)

Processes a TLS ServerHello message during a client handshake.
- **Description**: Use this function to process a ServerHello message received from a server during a TLS handshake. It must be called when the client is in the `FD_TLS_HS_WAIT_SH` state and the encryption level is `FD_TLS_LEVEL_INITIAL`. The function reads the ServerHello message, updates the handshake transcript, derives handshake secrets, and transitions the handshake state to `FD_TLS_HS_WAIT_EE`. If the encryption level is incorrect or if there are errors in decoding the message, the function returns a negative value indicating a TLS alert.
- **Inputs**:
    - `client`: A pointer to a `fd_tls_t` structure representing the client. Must not be null.
    - `handshake`: A pointer to a `fd_tls_estate_cli_t` structure representing the client's handshake state. Must not be null.
    - `record`: A pointer to a buffer containing the ServerHello message. Must not be null.
    - `record_sz`: The size of the `record` buffer in bytes. Must be a valid size for a ServerHello message.
    - `encryption_level`: The encryption level of the message. Must be `FD_TLS_LEVEL_INITIAL`.
- **Output**: Returns the number of bytes read from the `record` on success, or a negative value indicating a TLS alert on failure.
- **See Also**: [`fd_tls_client_hs_wait_sh`](<#fd_tls_client_hs_wait_sh>)  (Implementation)


---
### fd\_tls\_client\_hs\_wait\_ee<!-- {{#callable_declaration:fd_tls_client_hs_wait_ee}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L999>)

Processes the EncryptedExtensions message during a TLS handshake.
- **Description**: Use this function to process the EncryptedExtensions message received from the server during a TLS handshake. It must be called when the handshake state is set to expect this message, and the encryption level is set to handshake. The function validates the message type, updates the handshake transcript, and checks for required extensions such as QUIC transport parameters and ALPN. It also verifies the server and client certificate types. If any validation fails, it returns an appropriate TLS alert code.
- **Inputs**:
    - `client`: A pointer to a constant `fd_tls_t` structure representing the client. Must not be null.
    - `handshake`: A pointer to a `fd_tls_estate_cli_t` structure representing the client's handshake state. Must not be null.
    - `record`: A pointer to a buffer containing the received TLS record. Must not be null.
    - `record_sz`: The size of the `record` buffer in bytes. Must be a valid size for a TLS record.
    - `encryption_level`: An unsigned integer representing the encryption level. Must be `FD_TLS_LEVEL_HANDSHAKE` for this function to proceed.
- **Output**: Returns the number of bytes read from the record on success, or a negative TLS alert code on failure.
- **See Also**: [`fd_tls_client_hs_wait_ee`](<#fd_tls_client_hs_wait_ee>)  (Implementation)


---
### fd\_tls\_client\_hs\_wait\_cert\_cr<!-- {{#callable_declaration:fd_tls_client_hs_wait_cert_cr}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L1000>)

Processes a TLS handshake message during the client handshake phase.
- **Description**: Use this function to process a TLS handshake message when the client is in the state of waiting for a Certificate or CertificateRequest message. It must be called with the correct encryption level, specifically `FD_TLS_LEVEL_HANDSHAKE`. The function updates the handshake state based on the type of message received, either transitioning to wait for a Certificate or CertificateVerify message. It also appends the processed message to the handshake transcript for integrity verification. Ensure that the `handshake` object is properly initialized and that the `record` contains a valid TLS message.
- **Inputs**:
    - `client`: A pointer to a constant `fd_tls_t` structure representing the TLS client. The function does not use this parameter, so it can be null.
    - `handshake`: A pointer to an `fd_tls_estate_cli_t` structure representing the client's handshake state. Must not be null and should be properly initialized.
    - `record`: A pointer to a buffer containing the TLS handshake message to process. Must not be null and should point to a valid message.
    - `record_sz`: The size of the `record` buffer in bytes. Must be greater than zero and should match the actual size of the message.
    - `encryption_level`: An unsigned integer representing the encryption level of the message. Must be `FD_TLS_LEVEL_HANDSHAKE` for the function to proceed without error.
- **Output**: Returns the number of bytes processed from the `record` on success, or a negative TLS alert number on failure.
- **See Also**: [`fd_tls_client_hs_wait_cert_cr`](<#fd_tls_client_hs_wait_cert_cr>)  (Implementation)


---
### fd\_tls\_client\_hs\_wait\_cert<!-- {{#callable_declaration:fd_tls_client_hs_wait_cert}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L1001>)

Processes a TLS handshake certificate message.
- **Description**: Use this function to process a certificate message during a TLS handshake. It expects the encryption level to be set to handshake. If the encryption level is incorrect, the function returns an internal error alert. The function reads and decodes the certificate message, updates the handshake transcript, and transitions the handshake state. Ensure that the `record` contains a valid certificate message and that the `handshake` is in the correct state before calling this function.
- **Inputs**:
    - `client`: A pointer to a constant `fd_tls_t` structure representing the TLS client. The function does not use this parameter.
    - `handshake`: A pointer to an `fd_tls_estate_cli_t` structure representing the client's handshake state. Must not be null and should be properly initialized.
    - `record`: A pointer to a buffer containing the certificate message. Must not be null and should point to a valid TLS record.
    - `record_sz`: The size of the `record` buffer in bytes. Must accurately reflect the size of the data in the buffer.
    - `encryption_level`: An unsigned integer representing the encryption level. Must be set to `FD_TLS_LEVEL_HANDSHAKE`. If not, the function returns an internal error alert.
- **Output**: Returns the number of bytes read from the `record` on success, or a negative value indicating a TLS alert on failure.
- **See Also**: [`fd_tls_client_hs_wait_cert`](<#fd_tls_client_hs_wait_cert>)  (Implementation)


---
### fd\_tls\_client\_hs\_wait\_cert\_verify<!-- {{#callable_declaration:fd_tls_client_hs_wait_cert_verify}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L1002>)

Processes a server's CertificateVerify message during a TLS handshake.
- **Description**: Use this function to handle the CertificateVerify message from a server during a TLS handshake. It must be called when the handshake state is expecting a CertificateVerify message, and the encryption level is set to handshake. The function verifies the server's signature using the provided public key and updates the handshake transcript. If the encryption level is incorrect, it returns an internal error alert. If the verification fails, it returns a negative value indicating the specific error.
- **Inputs**:
    - `client`: A pointer to a constant `fd_tls_t` structure representing the client. The function does not use this parameter, so it can be null.
    - `hs`: A pointer to a `fd_tls_estate_cli_t` structure representing the client's handshake state. Must not be null.
    - `record`: A pointer to a buffer containing the server's CertificateVerify message. Must not be null.
    - `record_sz`: The size of the `record` buffer in bytes. Must be a valid size for a CertificateVerify message.
    - `encryption_level`: An unsigned integer representing the encryption level. Must be `FD_TLS_LEVEL_HANDSHAKE` for the function to proceed without error.
- **Output**: Returns a non-negative value indicating the number of bytes processed if successful, or a negative value indicating a specific TLS alert if an error occurs.
- **See Also**: [`fd_tls_client_hs_wait_cert_verify`](<#fd_tls_client_hs_wait_cert_verify>)  (Implementation)


---
### fd\_tls\_client\_hs\_wait\_finished<!-- {{#callable_declaration:fd_tls_client_hs_wait_finished}} -->
[View Source →](<../../../../../src/waltz/tls/fd_tls.c#L1003>)

Waits for the server to send the Finished message during a TLS handshake.
- **Description**: Use this function during a TLS handshake to process the server's Finished message. It must be called when the handshake state is FD_TLS_HS_WAIT_FINISHED and the encryption level is FD_TLS_LEVEL_HANDSHAKE. The function verifies the server's Finished message against the expected transcript hash and derives application secrets if the verification is successful. If the encryption level is incorrect or the verification fails, the function returns an alert indicating the error.
- **Inputs**:
    - `client`: A pointer to a constant `fd_tls_t` structure representing the client. Must not be null.
    - `hs`: A pointer to an `fd_tls_estate_cli_t` structure representing the client's handshake state. Must not be null.
    - `record`: A pointer to a constant unsigned char array containing the server's Finished message. Must not be null.
    - `record_sz`: The size of the `record` array in bytes. Must be a valid size for a TLS record.
    - `encryption_level`: An unsigned integer representing the encryption level. Must be FD_TLS_LEVEL_HANDSHAKE for the function to proceed without error.
- **Output**: Returns the number of bytes read from the `record` if successful, or a negative value indicating a TLS alert code if an error occurs.
- **See Also**: [`fd_tls_client_hs_wait_finished`](<#fd_tls_client_hs_wait_finished>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)