<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for TLS protocol functionality, including client-server handshake and cipher suite validation.

# Purpose
The code is a C test suite for verifying the functionality of a TLS (Transport Layer Security) protocol implementation. It includes tests for both client and server operations, focusing on the handshake process of the TLS protocol. The code imports binary data representing captured TLS messages, such as `ClientHello` and `ServerHello`, to test the encoding and decoding functions of these messages. The test suite includes functions like [`test_client_hello_decode`](<#test_client_hello_decode>) and [`test_server_hello_encode`](<#test_server_hello_encode>) to validate the correctness of the TLS message processing.

The code also includes integration tests for client-server interactions, such as [`test_tls_pair`](<#test_tls_pair>), which sets up a TLS client and server, performs a handshake, and checks if the connection is successfully established. Additionally, the code tests error handling by simulating scenarios with incorrect cipher suites, as seen in [`test_tls_client_wrong_ciphersuite`](<#test_tls_client_wrong_ciphersuite>) and [`test_tls_server_wrong_ciphersuite`](<#test_tls_server_wrong_ciphersuite>). The main function initializes the test environment, executes the tests, and logs the results. The code is structured to ensure that the TLS protocol implementation adheres to expected behaviors and handles various edge cases correctly.
# Imports and Dependencies

---
- `fd_tls_proto.h`
- `../../ballet/x509/fd_x509_mock.h`
- `fd_tls.h`
- `test_tls_helper.h`
- `../../ballet/ed25519/fd_ed25519.h`
- `../../ballet/ed25519/fd_x25519.h`


# Global Variables

---
### test\_server\_out
- **Type**: ``test_record_buf_t``
- **Description**: `test_server_out` is a static variable of type `test_record_buf_t` initialized to zero. It is used to store outgoing test records from the server during TLS handshake simulations.
- **Use**: Used to log and send server-side test records in TLS handshake tests.


---
### test\_client\_out
- **Type**: ``test_record_buf_t``
- **Description**: `test_client_out` is a static global variable of type `test_record_buf_t`. It is initialized to zero and is used to store outgoing TLS records from the client during testing.
- **Use**: Used to buffer and manage outgoing TLS records from the client in the test environment.


---
### test\_server\_hs
- **Type**: ``void const *``
- **Description**: A pointer to a constant void type, initialized to `NULL`. It is used to store a reference to a server handshake object during TLS operations.
- **Use**: Used to identify if a message is from the server in the `test_tls_sendmsg` function.


# Functions

---
### test\_client\_hello\_decode<!-- {{#callable:test_client_hello_decode}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls.c#L21>)

Decodes a TLS ClientHello message and verifies it against an expected structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize a `fd_tls_client_hello_t` structure `client_hello` to zero.
    - Call [`fd_tls_decode_client_hello`](<fd_tls_proto.c.md#fd_tls_decode_client_hello>) to decode the `test_client_hello` binary data into `client_hello` and store the size in `sz`.
    - Log the result of the decoding process using `FD_LOG_DEBUG`.
    - Verify that the decoded size `sz` matches the expected size `test_client_hello_sz` using `FD_TEST`.
    - Define an expected `fd_tls_client_hello_t` structure `client_hello_expected` with predefined values for various fields.
    - Clear out QUIC transport parameters, ALPN, and session ID in `client_hello` to prepare for comparison.
    - Compare `client_hello` with `client_hello_expected` using `memcmp` and verify the result with `FD_TEST`.
- **Output**: No output is returned; the function performs internal tests and logs results.
- **Functions Called**:
    - [`fd_tls_decode_client_hello`](<fd_tls_proto.c.md#fd_tls_decode_client_hello>)


---
### test\_server\_hello\_encode<!-- {{#callable:test_server_hello_encode}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls.c#L57>)

Encodes a `fd_tls_server_hello_t` structure into a buffer and logs the result.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initializes a `fd_tls_server_hello_t` structure with predefined random values, cipher suite, and key share.
    - Declares a buffer `server_hello_buf` with a size of 1280 bytes to store the encoded data.
    - Calls [`fd_tls_encode_server_hello`](<fd_tls_proto.c.md#fd_tls_encode_server_hello>) to encode the `server_hello` structure into `server_hello_buf` and stores the size of the encoded data in `sz`.
    - Checks if the encoding was successful by verifying that `sz` is non-negative using `FD_TEST`.
    - Logs the encoded data in hexadecimal format using `FD_LOG_HEXDUMP_DEBUG`.
- **Output**: No output is returned; the function logs the encoded server hello message.
- **Functions Called**:
    - [`fd_tls_encode_server_hello`](<fd_tls_proto.c.md#fd_tls_encode_server_hello>)


---
### test\_server\_hello\_decode<!-- {{#callable:test_server_hello_decode}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls.c#L80>)

Decodes a TLS ServerHello message and verifies the decoding process.
- **Inputs**:
    - `server_hello`: A pointer to an `fd_tls_server_hello_t` structure where the decoded ServerHello message will be stored.
    - `test_server_hello`: A pointer to the binary data of the ServerHello message, offset by 4 bytes.
    - `test_server_hello_sz`: The size of the ServerHello message data, reduced by 4 bytes.
- **Logic and Control Flow**:
    - Initialize the `server_hello` structure to zero.
    - Call [`fd_tls_decode_server_hello`](<fd_tls_proto.c.md#fd_tls_decode_server_hello>) to decode the ServerHello message from `test_server_hello+4` with size `test_server_hello_sz-4` into `server_hello`.
    - Store the result of the decoding in `sz`.
    - Use `FD_TEST` to verify that `sz` is non-negative, indicating successful decoding.
- **Output**: No explicit output is returned, but the function verifies the successful decoding of a ServerHello message.
- **Functions Called**:
    - [`fd_tls_decode_server_hello`](<fd_tls_proto.c.md#fd_tls_decode_server_hello>)


---
### test\_server\_finished\_decode<!-- {{#callable:test_server_finished_decode}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls.c#L87>)

Decodes a TLS 'Finished' message from a server and verifies the decoding size.
- **Inputs**:
    - `finished`: An array of `fd_tls_finished_t` structures to store the decoded 'Finished' message.
    - `test_server_finished`: A binary array containing the server's 'Finished' message data.
    - `test_server_finished_sz`: The size of the `test_server_finished` data.
- **Logic and Control Flow**:
    - Initialize an `fd_tls_finished_t` array named `finished` with zero values.
    - Call `fd_tls_decode_finished` to decode the server's 'Finished' message, starting from the fifth byte of `test_server_finished` and using the size `test_server_finished_sz` minus 4.
    - Store the result of the decoding in the variable `sz`.
    - Use `FD_TEST` to check if the decoding size `sz` is non-negative, indicating successful decoding.
- **Output**: No direct output is returned, but the function verifies the successful decoding of the server's 'Finished' message.


---
### test\_tls\_proto<!-- {{#callable:test_tls_proto}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls.c#L94>)

Executes a series of tests for TLS protocol message encoding and decoding.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls [`test_client_hello_decode`](<#test_client_hello_decode>) to test decoding of a TLS ClientHello message.
    - Calls [`test_server_hello_encode`](<#test_server_hello_encode>) to test encoding of a TLS ServerHello message.
    - Calls [`test_server_hello_decode`](<#test_server_hello_decode>) to test decoding of a TLS ServerHello message.
    - Calls [`test_server_finished_decode`](<#test_server_finished_decode>) to test decoding of a TLS ServerFinished message.
- **Output**: No output is returned; the function performs tests and logs results.
- **Functions Called**:
    - [`test_client_hello_decode`](<#test_client_hello_decode>)
    - [`test_server_hello_encode`](<#test_server_hello_encode>)
    - [`test_server_hello_decode`](<#test_server_hello_decode>)
    - [`test_server_finished_decode`](<#test_server_finished_decode>)


---
### test\_tls\_sendmsg<!-- {{#callable:test_tls_sendmsg}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls.c#L117>)

Logs and sends a TLS record from either the server or client perspective based on the handshake context.
- **Inputs**:
    - `hs`: A pointer to the handshake context, used to determine if the message is from the server.
    - `record`: A pointer to the TLS record to be logged and sent.
    - `record_sz`: The size of the TLS record in bytes.
    - `encryption_level`: The encryption level used for sending the record.
    - `flush`: An integer indicating whether to flush the message, though it is not used in this function.
- **Logic and Control Flow**:
    - Ignore the `flush` parameter as it is not used.
    - Determine if the message is from the server by comparing `hs` with `test_server_hs`.
    - Log the record using [`test_record_log`](<test_tls_helper.h.md#test_record_log>), passing the record, its size, and the `from_server` flag.
    - Send the record using [`test_record_send`](<test_tls_helper.h.md#test_record_send>), choosing the output buffer based on the `from_server` flag, and passing the encryption level, record, and its size.
    - Return 1 to indicate successful execution.
- **Output**: Returns 1 to indicate successful execution.
- **Functions Called**:
    - [`test_record_log`](<test_tls_helper.h.md#test_record_log>)
    - [`test_record_send`](<test_tls_helper.h.md#test_record_send>)


---
### test\_tls\_client\_respond<!-- {{#callable:test_tls_client_respond}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls.c#L131>)

Handles the TLS client handshake process by receiving records from the server and processing them.
- **Inputs**:
    - ``client``: A pointer to an `fd_tls_t` structure representing the TLS client.
    - ``hs``: A pointer to an `fd_tls_estate_cli_t` structure representing the client's handshake state.
- **Logic and Control Flow**:
    - Receive records from the server using `test_record_recv` and store them in `rec`.
    - While there are records to process, call [`fd_tls_client_handshake`](<fd_tls.c.md#fd_tls_client_handshake>) with the client, handshake state, and record details.
    - If [`fd_tls_client_handshake`](<fd_tls.c.md#fd_tls_client_handshake>) returns a negative result, indicating an error, call `fd_halt` and log the error using `FD_LOG_ERR`.
- **Output**: No explicit output is returned; the function processes records and handles errors internally.
- **Functions Called**:
    - [`fd_tls_client_handshake`](<fd_tls.c.md#fd_tls_client_handshake>)
    - [`fd_tls_alert_cstr`](<fd_tls.c.md#fd_tls_alert_cstr>)
    - [`fd_tls_reason_cstr`](<fd_tls.c.md#fd_tls_reason_cstr>)


---
### test\_tls\_server\_respond<!-- {{#callable:test_tls_server_respond}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls.c#L146>)

Handles incoming TLS records from a client and performs the server-side handshake process.
- **Inputs**:
    - ``server``: A pointer to an `fd_tls_t` structure representing the server's TLS context.
    - ``hs``: A pointer to an `fd_tls_estate_srv_t` structure representing the server's handshake state.
- **Logic and Control Flow**:
    - Receives TLS records from the client using `test_record_recv` on `test_client_out` buffer.
    - Enters a loop to process each received record.
    - For each record, calls [`fd_tls_server_handshake`](<fd_tls.c.md#fd_tls_server_handshake>) to process the handshake with the server's TLS context and handshake state.
    - Checks the result of [`fd_tls_server_handshake`](<fd_tls.c.md#fd_tls_server_handshake>); if the result is negative, logs an error message with the alert and reason details.
- **Output**: No explicit output is returned; the function processes records and logs errors if the handshake fails.
- **Functions Called**:
    - [`fd_tls_server_handshake`](<fd_tls.c.md#fd_tls_server_handshake>)
    - [`fd_tls_alert_cstr`](<fd_tls.c.md#fd_tls_alert_cstr>)
    - [`fd_tls_reason_cstr`](<fd_tls.c.md#fd_tls_reason_cstr>)


---
### test\_tls\_secrets<!-- {{#callable:test_tls_secrets}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls.c#L160>)

Does nothing with the provided TLS handshake and secret parameters.
- **Inputs**:
    - ``handshake``: A pointer to the handshake data, marked as unused.
    - ``recv_secret``: A pointer to the received secret data, marked as unused.
    - ``send_secret``: A pointer to the sent secret data, marked as unused.
    - ``encryption_level``: An unsigned integer representing the encryption level, marked as unused.
- **Logic and Control Flow**:
    - The function is defined as static and does not perform any operations.
    - All input parameters are marked with `FD_FN_UNUSED`, indicating they are not used within the function body.
- **Output**: No output is produced as the function body is empty.


---
### prepare\_tls\_pair<!-- {{#callable:prepare_tls_pair}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls.c#L166>)

Initializes and configures a pair of TLS client and server objects with random keys and mock certificates.
- **Inputs**:
    - `rng`: A pointer to a `fd_rng_t` object used for random number generation.
    - `client`: A pointer to a `fd_tls_t` object that will be configured as a TLS client.
    - `server`: A pointer to a `fd_tls_t` object that will be configured as a TLS server.
- **Logic and Control Flow**:
    - Initialize static signing contexts for client and server using [`fd_tls_test_sign_ctx`](<test_tls_helper.h.md#fd_tls_test_sign_ctx>) with the provided random number generator `rng`.
    - Configure the `client` and `server` objects with random values, signing functions, and predefined secret and message sending functions.
    - Generate 32-byte private keys for both `client` and `server` using `fd_rng_uchar` and store them in their respective `kex_private_key` fields.
    - Copy the public keys from the signing contexts to the `cert_public_key` fields of both `client` and `server`.
    - Create mock X.509 certificates for both `client` and `server` using `fd_x509_mock_cert` and set their sizes to `FD_X509_MOCK_CERT_SZ`.
    - Compute the public keys for key exchange using `fd_x25519_public` for both `client` and `server`.
- **Output**: The function does not return a value; it modifies the `client` and `server` objects in place.
- **Functions Called**:
    - [`fd_tls_test_sign_ctx`](<test_tls_helper.h.md#fd_tls_test_sign_ctx>)
    - [`fd_tls_rand_t::fd_tls_test_rand`](<test_tls_helper.h.md#fd_tls_rand_tfd_tls_test_rand>)
    - [`fd_tls_sign_t::fd_tls_test_sign`](<test_tls_helper.h.md#fd_tls_sign_tfd_tls_test_sign>)


---
### test\_tls\_pair<!-- {{#callable:test_tls_pair}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls.c#L204>)

Tests a TLS handshake between a client and server using a random number generator.
- **Inputs**:
    - `rng`: A pointer to a `fd_rng_t` structure used for random number generation.
- **Logic and Control Flow**:
    - Initialize client and server TLS objects using [`fd_tls_join`](<fd_tls.c.md#fd_tls_join>) and [`fd_tls_new`](<fd_tls.c.md#fd_tls_new>).
    - Call [`prepare_tls_pair`](<#prepare_tls_pair>) to set up the client and server with necessary cryptographic parameters.
    - Create server and client handshake objects using `fd_tls_estate_srv_new` and `fd_tls_estate_cli_new`.
    - Copy the server's public key to the client's handshake structure.
    - Perform the TLS handshake sequence: `ClientHello`, `ServerHello`, `EncryptedExtensions`, `Certificate`, `CertificateVerify`, and `Finished` messages using [`fd_tls_client_handshake`](<fd_tls.c.md#fd_tls_client_handshake>), [`test_tls_server_respond`](<#test_tls_server_respond>), and [`test_tls_client_respond`](<#test_tls_client_respond>).
    - Verify that both client and server handshake states are `FD_TLS_HS_CONNECTED`.
    - Clean up by deleting handshake objects and TLS objects.
- **Output**: No return value; the function performs tests and asserts conditions internally.
- **Functions Called**:
    - [`fd_tls_join`](<fd_tls.c.md#fd_tls_join>)
    - [`fd_tls_new`](<fd_tls.c.md#fd_tls_new>)
    - [`prepare_tls_pair`](<#prepare_tls_pair>)
    - [`fd_tls_client_handshake`](<fd_tls.c.md#fd_tls_client_handshake>)
    - [`test_tls_server_respond`](<#test_tls_server_respond>)
    - [`test_tls_client_respond`](<#test_tls_client_respond>)
    - [`fd_tls_estate_srv_delete`](<fd_tls_estate.h.md#fd_tls_estate_srv_delete>)
    - [`fd_tls_estate_cli_delete`](<fd_tls_estate.h.md#fd_tls_estate_cli_delete>)
    - [`fd_tls_delete`](<fd_tls.c.md#fd_tls_delete>)
    - [`fd_tls_leave`](<fd_tls.c.md#fd_tls_leave>)


---
### test\_tls\_client\_wrong\_ciphersuite<!-- {{#callable:test_tls_client_wrong_ciphersuite}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls.c#L244>)

Tests the TLS handshake process when a client sends a ClientHello message with unsupported cipher suites, expecting a handshake failure.
- **Inputs**:
    - ``rng``: A pointer to a random number generator object used for cryptographic operations.
- **Logic and Control Flow**:
    - Initialize client and server TLS objects using [`fd_tls_join`](<fd_tls.c.md#fd_tls_join>) and [`fd_tls_new`](<fd_tls.c.md#fd_tls_new>).
    - Prepare the TLS pair by setting up cryptographic keys and certificates using [`prepare_tls_pair`](<#prepare_tls_pair>).
    - Create server and client handshake objects using `fd_tls_estate_srv_new` and `fd_tls_estate_cli_new`.
    - Copy the server's public key to the client's handshake object.
    - Send a `ClientHello` message with unsupported cipher suites to the server.
    - Perform the server-side handshake using [`fd_tls_server_handshake`](<fd_tls.c.md#fd_tls_server_handshake>) with the `ClientHello` message.
    - Check if the handshake fails with the expected alert `FD_TLS_ALERT_HANDSHAKE_FAILURE` and reason `FD_TLS_REASON_CH_NEG_CIPHER`.
    - Clean up by deleting the handshake objects and TLS objects.
- **Output**: No return value; the function performs tests and asserts conditions using `FD_TEST`.
- **Functions Called**:
    - [`fd_tls_join`](<fd_tls.c.md#fd_tls_join>)
    - [`fd_tls_new`](<fd_tls.c.md#fd_tls_new>)
    - [`prepare_tls_pair`](<#prepare_tls_pair>)
    - [`fd_tls_server_handshake`](<fd_tls.c.md#fd_tls_server_handshake>)
    - [`fd_tls_estate_srv_delete`](<fd_tls_estate.h.md#fd_tls_estate_srv_delete>)
    - [`fd_tls_estate_cli_delete`](<fd_tls_estate.h.md#fd_tls_estate_cli_delete>)
    - [`fd_tls_delete`](<fd_tls.c.md#fd_tls_delete>)
    - [`fd_tls_leave`](<fd_tls.c.md#fd_tls_leave>)


---
### test\_tls\_server\_wrong\_ciphersuite<!-- {{#callable:test_tls_server_wrong_ciphersuite}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls.c#L289>)

Tests the TLS handshake process when the server sends a cipher suite not offered by the client, expecting an illegal parameter alert.
- **Inputs**:
    - ``rng``: A pointer to a random number generator object used for cryptographic operations.
- **Logic and Control Flow**:
    - Initialize client and server TLS objects using [`fd_tls_join`](<fd_tls.c.md#fd_tls_join>) and [`fd_tls_new`](<fd_tls.c.md#fd_tls_new>).
    - Prepare the TLS pair with [`prepare_tls_pair`](<#prepare_tls_pair>), setting up cryptographic keys and certificates.
    - Create server and client handshake objects using `fd_tls_estate_srv_new` and `fd_tls_estate_cli_new`.
    - Copy the server's public key to the client's handshake object.
    - Perform a client handshake with [`fd_tls_client_handshake`](<fd_tls.c.md#fd_tls_client_handshake>), sending a `ClientHello` message.
    - Send a `ServerHello` message with a cipher suite not offered by the client.
    - Invoke [`fd_tls_client_handshake`](<fd_tls.c.md#fd_tls_client_handshake>) to process the `ServerHello` and expect an illegal parameter alert.
    - Verify the alert and reason using `FD_TEST`.
    - Clean up by deleting handshake objects and TLS objects.
- **Output**: No return value; the function performs tests and uses assertions to validate expected behavior.
- **Functions Called**:
    - [`fd_tls_join`](<fd_tls.c.md#fd_tls_join>)
    - [`fd_tls_new`](<fd_tls.c.md#fd_tls_new>)
    - [`prepare_tls_pair`](<#prepare_tls_pair>)
    - [`fd_tls_client_handshake`](<fd_tls.c.md#fd_tls_client_handshake>)
    - [`fd_tls_estate_srv_delete`](<fd_tls_estate.h.md#fd_tls_estate_srv_delete>)
    - [`fd_tls_estate_cli_delete`](<fd_tls_estate.h.md#fd_tls_estate_cli_delete>)
    - [`fd_tls_delete`](<fd_tls.c.md#fd_tls_delete>)
    - [`fd_tls_leave`](<fd_tls.c.md#fd_tls_leave>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/waltz/tls/test_tls.c#L330>)

Initializes the environment, runs a series of TLS protocol tests, and then cleans up resources before exiting.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Creates a random number generator `rng` using `fd_rng_new` and `fd_rng_join`.
    - Executes [`test_tls_proto`](<#test_tls_proto>) to run protocol-related tests.
    - Executes [`test_tls_pair`](<#test_tls_pair>) to test client-server TLS handshake using `rng`.
    - Executes [`test_tls_client_wrong_ciphersuite`](<#test_tls_client_wrong_ciphersuite>) to test client behavior with unsupported cipher suites using `rng`.
    - Executes [`test_tls_server_wrong_ciphersuite`](<#test_tls_server_wrong_ciphersuite>) to test server behavior with unsupported cipher suites using `rng`.
    - Deletes the random number generator using `fd_rng_delete` and `fd_rng_leave`.
    - Logs a notice message indicating the tests passed.
    - Calls `fd_halt` to terminate the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`test_tls_proto`](<#test_tls_proto>)
    - [`test_tls_pair`](<#test_tls_pair>)
    - [`test_tls_client_wrong_ciphersuite`](<#test_tls_client_wrong_ciphersuite>)
    - [`test_tls_server_wrong_ciphersuite`](<#test_tls_server_wrong_ciphersuite>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)