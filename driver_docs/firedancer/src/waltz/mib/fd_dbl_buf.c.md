<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for managing a double buffer, including creation, joining, leaving, deletion, insertion, and reading.

# Purpose
The code defines a set of functions for managing a double buffer structure, which is used for efficient data handling in shared memory. The primary components include functions to create, join, leave, and delete a double buffer, as well as to insert and read data from it. The functions [`fd_dbl_buf_new`](<#fd_dbl_buf_new>), [`fd_dbl_buf_join`](<#fd_dbl_buf_join>), [`fd_dbl_buf_leave`](<#fd_dbl_buf_leave>), and [`fd_dbl_buf_delete`](<#fd_dbl_buf_delete>) manage the lifecycle of the double buffer, ensuring proper alignment and initialization. The [`fd_dbl_buf_insert`](<#fd_dbl_buf_insert>) and [`fd_dbl_buf_read`](<#fd_dbl_buf_read>) functions handle data operations, allowing for the insertion of messages into the buffer and reading from it, respectively.

The code includes conditional compilation for SSE (Streaming SIMD Extensions) to optimize certain operations if the hardware supports it. The functions use logging to warn about potential issues such as null pointers or misaligned memory. The code relies on several macros and utility functions, such as `FD_DBL_BUF_ALIGN`, `FD_DBL_BUF_FOOTPRINT`, and `fd_ulong_is_aligned`, which are likely defined in the included headers. The double buffer is designed to work with a maximum transmission unit (MTU) size, and the code ensures that memory allocations are aligned to this size. The use of memory fences (`FD_COMPILER_MFENCE`) ensures memory consistency across different operations.
# Imports and Dependencies

---
- `fd_dbl_buf.h`
- `../../util/log/fd_log.h`
- `../../tango/fd_tango_base.h`
- `../../util/simd/fd_sse.h`


# Functions

---
### fd\_dbl\_buf\_align<!-- {{#callable:fd_dbl_buf_align}} -->
[View Source →](<../../../../../src/waltz/mib/fd_dbl_buf.c#L9>)

Returns the alignment requirement for a double buffer.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the value of the macro `FD_DBL_BUF_ALIGN`.
- **Output**: The alignment requirement for a double buffer as defined by `FD_DBL_BUF_ALIGN`.


---
### fd\_dbl\_buf\_footprint<!-- {{#callable:fd_dbl_buf_footprint}} -->
[View Source →](<../../../../../src/waltz/mib/fd_dbl_buf.c#L14>)

Calculates the memory footprint required for a double buffer with a given maximum transmission unit (MTU).
- **Inputs**:
    - `mtu`: The maximum transmission unit size for which the footprint is calculated.
- **Logic and Control Flow**:
    - Calls the macro `FD_DBL_BUF_FOOTPRINT` with the input `mtu` to compute the required memory footprint.
    - Returns the result of the macro call.
- **Output**: Returns an unsigned long integer representing the memory footprint size for the specified MTU.


---
### fd\_dbl\_buf\_new<!-- {{#callable:fd_dbl_buf_new}} -->
[View Source →](<../../../../../src/waltz/mib/fd_dbl_buf.c#L19>)

Allocates and initializes a new double buffer structure in shared memory.
- **Inputs**:
    - ``shmem``: Pointer to the shared memory where the double buffer will be allocated.
    - ``mtu``: Maximum transmission unit size for the buffer.
    - ``seq0``: Initial sequence number for the buffer.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL; if so, log a warning and return NULL.
    - Check if `shmem` is aligned to `FD_DBL_BUF_ALIGN`; if not, log a warning and return NULL.
    - Align `mtu` to `FD_DBL_BUF_ALIGN` using `fd_ulong_align_up`.
    - Initialize scratch allocation with `FD_SCRATCH_ALLOC_INIT`.
    - Allocate memory for `fd_dbl_buf_t`, `buf0`, and `buf1` using `FD_SCRATCH_ALLOC_APPEND`.
    - Finalize scratch allocation with `FD_SCRATCH_ALLOC_FINI`.
    - Initialize the `fd_dbl_buf_t` structure with provided and calculated values.
    - Use memory fences (`FD_COMPILER_MFENCE`) to ensure memory operations are completed in order.
    - Set the `magic` field of the buffer to `FD_DBL_BUF_MAGIC` to indicate successful initialization.
    - Return the pointer to the newly created `fd_dbl_buf_t` structure.
- **Output**: Pointer to the initialized `fd_dbl_buf_t` structure, or NULL if an error occurs.


---
### fd\_dbl\_buf\_join<!-- {{#callable:fd_dbl_buf_join}} -->
[View Source →](<../../../../../src/waltz/mib/fd_dbl_buf.c#L57>)

Validates and returns a pointer to a double buffer structure if the input shared buffer is non-null, aligned, and has the correct magic number.
- **Inputs**:
    - `shbuf`: A pointer to a shared buffer that is expected to contain a double buffer structure.
- **Logic and Control Flow**:
    - Check if `shbuf` is NULL; if true, log a warning and return NULL.
    - Check if `shbuf` is aligned to `FD_DBL_BUF_ALIGN`; if not, log a warning and return NULL.
    - Cast `shbuf` to a `fd_dbl_buf_t` pointer and check if its `magic` field equals `FD_DBL_BUF_MAGIC`; if not, log a warning and return NULL.
    - Return the `fd_dbl_buf_t` pointer.
- **Output**: A pointer to `fd_dbl_buf_t` if all checks pass, otherwise NULL.


---
### fd\_dbl\_buf\_leave<!-- {{#callable:fd_dbl_buf_leave}} -->
[View Source →](<../../../../../src/waltz/mib/fd_dbl_buf.c#L79>)

Returns the pointer to the double buffer structure.
- **Inputs**:
    - ``buf``: A pointer to a `fd_dbl_buf_t` structure representing the double buffer.
- **Logic and Control Flow**:
    - Return the input `buf` without any modification.
- **Output**: A pointer to the `fd_dbl_buf_t` structure that was passed as input.


---
### fd\_dbl\_buf\_delete<!-- {{#callable:fd_dbl_buf_delete}} -->
[View Source →](<../../../../../src/waltz/mib/fd_dbl_buf.c#L84>)

Deletes a double buffer by resetting its magic number to zero and returns the buffer.
- **Inputs**:
    - `shbuf`: A pointer to the shared buffer to delete.
- **Logic and Control Flow**:
    - Check if `shbuf` is NULL; if true, log a warning and return NULL.
    - Check if `shbuf` is not aligned to `FD_DBL_BUF_ALIGN`; if true, log a warning and return NULL.
    - Cast `shbuf` to a `fd_dbl_buf_t` pointer named `dbl_buf`.
    - Use a memory fence to ensure memory operations are completed before setting `dbl_buf->magic` to zero.
    - Return the `dbl_buf` pointer.
- **Output**: Returns a pointer to the deleted double buffer, or NULL if the input is invalid.


---
### fd\_dbl\_buf\_insert<!-- {{#callable:fd_dbl_buf_insert}} -->
[View Source →](<../../../../../src/waltz/mib/fd_dbl_buf.c#L104>)

Inserts a message into a double buffer, updating the sequence number and size, with optional use of SSE for atomic operations.
- **Inputs**:
    - ``buf``: A pointer to the `fd_dbl_buf_t` structure representing the double buffer.
    - ``msg``: A constant pointer to the message data to insert into the buffer.
    - ``sz``: The size of the message to insert, in bytes.
- **Logic and Control Flow**:
    - Limit `sz` to the minimum of the provided size and the buffer's maximum transmission unit (`mtu`).
    - Increment the buffer's sequence number by 1 using `fd_seq_inc`.
    - Determine the destination slot in the buffer using [`fd_dbl_buf_slot`](<fd_dbl_buf.h.md#fd_dbl_buf_slot>) with the updated sequence number.
    - Copy the message data from `msg` to the determined destination slot using `fd_memcpy`.
    - If SSE is available (`FD_HAS_SSE` is defined), use memory fences and store the sequence and size atomically using `_mm_store_si128`.
    - If SSE is not available, update the buffer's size and sequence number separately with memory fences to ensure memory consistency.
- **Output**: No return value; the function modifies the buffer in place.
- **Functions Called**:
    - [`fd_dbl_buf_slot`](<fd_dbl_buf.h.md#fd_dbl_buf_slot>)


---
### fd\_dbl\_buf\_read<!-- {{#callable:fd_dbl_buf_read}} -->
[View Source →](<../../../../../src/waltz/mib/fd_dbl_buf.c#L127>)

Attempts to read data from a double buffer until successful, returning the size of the data read.
- **Inputs**:
    - ``buf``: A pointer to the `fd_dbl_buf_t` structure representing the double buffer to read from.
    - ``buf_sz``: The maximum size of the buffer to read into, specified as an unsigned long integer.
    - ``obj``: A pointer to the memory location where the read data will be stored.
    - ``opt_seqp``: An optional pointer to an unsigned long integer where the sequence number will be stored; if NULL, a local variable is used.
- **Logic and Control Flow**:
    - Initialize a local sequence array `_seq` to store the sequence number if `opt_seqp` is NULL.
    - Assign `seqp` to point to `opt_seqp` if it is not NULL, otherwise point to `_seq`.
    - Enter a loop that continues to call [`fd_dbl_buf_try_read`](<fd_dbl_buf.h.md#fd_dbl_buf_try_read>) until it returns a value not equal to `ULONG_MAX`.
    - Return the size of the data read from the buffer.
- **Output**: Returns the size of the data read from the buffer as an unsigned long integer.
- **Functions Called**:
    - [`fd_dbl_buf_try_read`](<fd_dbl_buf.h.md#fd_dbl_buf_try_read>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)