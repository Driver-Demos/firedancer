<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Unit tests for eBPF XDP programs using BPF_PROG_TEST_RUN mode on Linux.

# Purpose
The code is a C program designed to perform unit tests on an eBPF (extended Berkeley Packet Filter) program using the XDP (eXpress Data Path) framework on a Linux system. It requires the Linux operating system with XDP support and uses the `bpf(2)` syscall in `BPF_PROG_TEST_RUN` mode to test the functionality of the `ebpf_xdp_flow`. The program includes several components, such as functions to load eBPF programs, clear BPF maps, and run tests on network packets. It uses various network packet fixtures to simulate different network scenarios and verify the expected behavior of the eBPF program.

The program defines several test cases to validate the behavior of the eBPF program under different conditions, such as different destination ports, IP protocols, and Ethernet types. It uses macros and utility functions to manage BPF maps and sockets, and it logs the results of each test case. The program also includes functionality to create and manage AF_XDP sockets and BPF maps, which are essential for the XDP framework. The main function orchestrates the setup, execution, and cleanup of the tests, ensuring that the eBPF program behaves as expected in various network scenarios.
# Imports and Dependencies

---
- `errno.h`
- `stdio.h`
- `stdlib.h`
- `unistd.h`
- `sys/socket.h`
- `../../util/fd_util.h`
- `../../util/net/fd_eth.h`
- `../../util/net/fd_ip4.h`
- `../../util/net/fd_udp.h`
- `../../util/net/fd_gre.h`
- `../ebpf/fd_linux_bpf.h`
- `fd_xdp1.h`


# Global Variables

---
### prog\_fd
- **Type**: `int`
- **Description**: Holds the file descriptor for a loaded BPF program.
- **Use**: Used to store the result of loading a BPF program via the `bpf` syscall.


---
### xsks\_fd
- **Type**: `int`
- **Description**: The `xsks_fd` variable is an integer that represents a file descriptor for a BPF map of type `XSKMAP`. This map is used to associate AF_XDP sockets with specific queues for packet processing.
- **Use**: Used to store the file descriptor of the `XSKMAP` created for managing queue-to-XSK associations.


---
### xsk\_fd
- **Type**: `int`
- **Description**: An integer variable that represents a file descriptor for an AF_XDP socket.
- **Use**: Used to create and manage an AF_XDP socket for testing BPF programs.


# Functions

---
### fd\_bpf\_map\_clear<!-- {{#callable:fd_bpf_map_clear}} -->
[View Source →](<../../../../../src/waltz/xdp/test_xdp_ebpf.c#L31>)

Clears all elements from a BPF map by iterating through its keys and deleting each element.
- **Inputs**:
    - `map_fd`: A file descriptor for the BPF map to clear.
- **Logic and Control Flow**:
    - Initialize `key` to 0.
    - Enter an infinite loop to iterate over the map keys.
    - Call `fd_bpf_map_get_next_key` to get the next key in the map.
    - If `fd_bpf_map_get_next_key` returns an error, check if `errno` is `ENOENT` to break the loop, indicating no more keys.
    - Log an error if `fd_bpf_map_get_next_key` fails for reasons other than `ENOENT`.
    - Call `fd_bpf_map_delete_elem` to delete the element associated with `next_key`.
    - Log an error if `fd_bpf_map_delete_elem` fails.
    - Set `key` to `next_key` to continue the iteration.
- **Output**: Returns 0 after successfully clearing the map.


---
### load\_prog<!-- {{#callable:load_prog}} -->
[View Source →](<../../../../../src/waltz/xdp/test_xdp_ebpf.c#L52>)

Loads an eBPF program into the kernel using the `bpf` system call with specified attributes.
- **Inputs**:
    - ``code_buf``: A pointer to an array of unsigned long integers representing the eBPF program instructions.
    - ``code_cnt``: An unsigned long integer representing the number of instructions in the eBPF program.
- **Logic and Control Flow**:
    - Initialize a static character array `ebpf_kern_log` to store the eBPF verifier log.
    - Set the first character of `ebpf_kern_log` to 0 to clear any previous log data.
    - Define a `union bpf_attr` structure `attr` with specific attributes for loading the eBPF program, including program type, instruction count, instruction buffer, license, program name, log level, log size, and log buffer.
    - Call the `bpf` system call with `BPF_PROG_LOAD` command, passing the `attr` structure to load the eBPF program into the kernel.
    - Check if the file descriptor `prog_fd` returned by `bpf` is negative, indicating an error.
    - If `errno` is `EPERM`, log a warning about insufficient permissions, halt the program, and exit.
    - If any other error occurs, log the eBPF verifier log and the error message, then terminate the program.
- **Output**: Returns the file descriptor `prog_fd` of the loaded eBPF program, or terminates the program if loading fails.


---
### prog\_test<!-- {{#callable:prog_test}} -->
[View Source →](<../../../../../src/waltz/xdp/test_xdp_ebpf.c#L81>)

Executes a BPF program test run with a given packet and checks if the returned action matches the expected action.
- **Inputs**:
    - `pkt`: Pointer to the packet data to be tested.
    - `pkt_sz`: Size of the packet data in bytes.
    - `name`: Name of the test for logging purposes.
    - `expected_action`: Expected action result from the BPF program test run.
- **Logic and Control Flow**:
    - Clears the XSK map by calling [`fd_bpf_map_clear`](<#fd_bpf_map_clear>) with `xsks_fd`.
    - Defines a macro `FD_XDP_TEST` to log an error if a condition is not met.
    - Initializes `rx_queue` to 0 and updates the XSK map with `fd_bpf_map_update_elem`.
    - Sets up a `bpf_attr` structure with the program file descriptor, packet data, and packet size.
    - Runs the BPF program test using `bpf` with `BPF_PROG_TEST_RUN` and checks the return value.
    - Logs the result of the BPF test, including the test name, returned value, and expected action.
    - If the returned action does not match the expected action, logs additional information including packet size and a hexdump of the packet.
    - Uses `FD_XDP_TEST` to assert that the returned action matches the expected action.
- **Output**: No return value; logs information and errors as side effects.
- **Functions Called**:
    - [`fd_bpf_map_clear`](<#fd_bpf_map_clear>)


---
### run\_tests<!-- {{#callable:run_tests}} -->
[View Source →](<../../../../../src/waltz/xdp/test_xdp_ebpf.c#L143>)

Executes a series of tests on network packets using different configurations and expected outcomes.
- **Inputs**:
    - `dst_ip`: The destination IP address used in the tests.
- **Logic and Control Flow**:
    - Initialize packet structures for UDP and GRE encapsulated UDP packets with the given destination IP.
    - Iterate over all possible destination ports (0 to 65535) and test each port for both GRE and UDP packets, expecting a redirect for specific ports (`PORT0` and `PORT1`).
    - Test the IPv4 protocol field by setting it to different values and checking the expected action (redirect or pass).
    - Test the destination IP by modifying it and checking the expected action based on whether `dst_ip` is non-zero.
    - Iterate over all possible Ethertype values and test each for both GRE and UDP packets, expecting a redirect for the IP Ethertype.
    - Test the Internet Header Length (IHL) by creating packets with different IHL values and checking the expected action.
    - Run predefined test fixtures for various packet types and check the expected action (pass or redirect).
- **Output**: No return value; the function performs tests and logs results.
- **Functions Called**:
    - [`prog_test`](<#prog_test>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/waltz/xdp/test_xdp_ebpf.c#L335>)

Initializes and tests an eBPF XDP program using AF_XDP sockets and BPF maps.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Defines a `bpf_attr` structure to create a BPF map of type `BPF_MAP_TYPE_XSKMAP`.
    - Attempts to create the BPF map using the `bpf` syscall; logs a warning and halts if permissions are insufficient.
    - Creates an AF_XDP socket using `socket` and checks for successful creation.
    - Generates eBPF program code with [`fd_xdp_gen_program`](<fd_xdp1.c.md#fd_xdp_gen_program>) for a specific IP address and ports, then loads it using [`load_prog`](<#load_prog>).
    - Runs tests on the loaded program using [`run_tests`](<#run_tests>) with a specified IP address.
    - Repeats the program generation, loading, and testing for a different IP address.
    - Closes the AF_XDP socket and logs a notice of successful completion.
    - Calls `fd_halt` to terminate the program.
- **Output**: Returns 0 on successful completion or -1 if there is an error in creating the BPF map.
- **Functions Called**:
    - [`fd_xdp_gen_program`](<fd_xdp1.c.md#fd_xdp_gen_program>)
    - [`load_prog`](<#load_prog>)
    - [`run_tests`](<#run_tests>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)