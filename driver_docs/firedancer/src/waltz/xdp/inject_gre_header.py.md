<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Injects GRE and inner IPv4 headers into packet data and processes multiple packet files.

# Purpose
The code is a Python script designed to process network packet files by injecting a GRE (Generic Routing Encapsulation) header and an inner IPv4 header into each packet. It provides functions to parse Ethernet and IPv4 headers, calculate IPv4 checksums, and create GRE and IPv4 headers. The script reads packet data from files matching a specified pattern, modifies the packets by adding the GRE and inner IPv4 headers, and writes the modified packets to an output directory. The script uses command-line arguments to specify the input file pattern and output directory.

The main technical components include functions for parsing and creating network headers, such as [`parse_ethernet_header`](<#parse_ethernet_header>), [`parse_ipv4_header`](<#parse_ipv4_header>), [`create_gre_header`](<#create_gre_header>), and [`create_inner_ipv4_header`](<#create_inner_ipv4_header>). The [`inject_gre_and_inner_ip`](<#inject_gre_and_inner_ip>) function is responsible for modifying the packet data by adding the necessary headers. The [`process_packet_files`](<#process_packet_files>) function handles reading from and writing to files, iterating over all files that match the input pattern. The script is intended to be executed as a standalone program, as indicated by the presence of the [`main`](<#main>) function and the `if __name__ == "__main__":` block, which parses command-line arguments and initiates the packet processing.
# Imports and Dependencies

---
- `struct`
- `socket`
- `os`
- `glob`
- `argparse`


# Functions

---
### calculate\_ipv4\_checksum<!-- {{#callable:firedancer/src/waltz/xdp/inject_gre_header.calculate_ipv4_checksum}} -->
[View Source →](<../../../../../src/waltz/xdp/inject_gre_header.py#L9>)

Calculates the checksum for an IPv4 header by setting the checksum field to zero, summing the header words, and applying one's complement.
- **Inputs**:
    - `header`: A byte sequence representing the IPv4 header for which the checksum is calculated.
- **Logic and Control Flow**:
    - Set the checksum field in the header to zero by replacing bytes 10 and 11 with zero bytes.
    - Initialize a variable `checksum` to zero to accumulate the sum of the header words.
    - Iterate over the header in 2-byte increments, convert each pair of bytes to a 16-bit word, and add it to `checksum`.
    - While there are carry bits in `checksum` (i.e., `checksum` is greater than 16 bits), add the carry bits to the lower 16 bits of `checksum`.
    - Apply one's complement to `checksum` by inverting all bits and masking with `0xFFFF` to ensure it is 16 bits.
    - Return the calculated checksum.
- **Output**: A 16-bit integer representing the calculated checksum for the IPv4 header.


---
### parse\_ethernet\_header<!-- {{#callable:firedancer/src/waltz/xdp/inject_gre_header.parse_ethernet_header}} -->
[View Source →](<../../../../../src/waltz/xdp/inject_gre_header.py#L29>)

Parses an Ethernet header from a given data packet.
- **Inputs**:
    - `data`: A byte sequence representing the Ethernet frame, expected to be at least 14 bytes long.
- **Logic and Control Flow**:
    - Check if the length of `data` is less than 14 bytes; if true, raise a `ValueError` indicating the packet is too short for an Ethernet header.
    - Extract the destination MAC address from the first 6 bytes of `data`.
    - Extract the source MAC address from bytes 6 to 12 of `data`.
    - Extract the EtherType from bytes 12 to 14 of `data` using `struct.unpack` to interpret it as an unsigned short in network byte order.
    - Return a tuple containing the destination MAC address, source MAC address, EtherType, and the remaining data after the Ethernet header.
- **Output**: A tuple containing the destination MAC address, source MAC address, EtherType, and the remaining data after the Ethernet header.


---
### parse\_ipv4\_header<!-- {{#callable:firedancer/src/waltz/xdp/inject_gre_header.parse_ipv4_header}} -->
[View Source →](<../../../../../src/waltz/xdp/inject_gre_header.py#L41>)

Parses an IPv4 header from a given data packet and extracts its components.
- **Inputs**:
    - `data`: A byte sequence representing the data packet to parse.
- **Logic and Control Flow**:
    - Check if the length of `data` is less than 20 bytes; if true, raise a `ValueError` indicating the packet is too short for an IPv4 header.
    - Extract the `version` and `ihl` (Internet Header Length) from the first byte of `data`.
    - Calculate the `header_length` by multiplying `ihl` by 4.
    - Check if the `version` is not 4; if true, raise a `ValueError` indicating it is not an IPv4 packet.
    - Check if the length of `data` is less than `header_length`; if true, raise a `ValueError` indicating the packet is too short for an IPv4 header with options.
    - Extract various fields from the `data` such as `tos`, `total_length`, `identification`, `flags_fragoff`, `ttl`, `protocol`, `checksum`, `src_ip`, `dst_ip`, and `options`.
    - Separate the `header` and `payload` from the `data` based on `header_length`.
- **Output**: A dictionary containing the parsed IPv4 header fields and the payload.


---
### create\_gre\_header<!-- {{#callable:firedancer/src/waltz/xdp/inject_gre_header.create_gre_header}} -->
[View Source →](<../../../../../src/waltz/xdp/inject_gre_header.py#L91>)

Creates a basic GRE header with specified protocol type.
- **Inputs**:
    - `protocol_type`: An integer representing the protocol type, defaulting to 0x0800 for IPv4.
- **Logic and Control Flow**:
    - Set the `flags` variable to 0x0000, indicating no checksum, no key, and no sequence number.
    - Use `struct.pack` to pack the `flags` and `protocol_type` into a 4-byte GRE header.
- **Output**: A 4-byte packed binary string representing the GRE header.


---
### create\_inner\_ipv4\_header<!-- {{#callable:firedancer/src/waltz/xdp/inject_gre_header.create_inner_ipv4_header}} -->
[View Source →](<../../../../../src/waltz/xdp/inject_gre_header.py#L99>)

Creates an inner IPv4 header with specified parameters and calculates its checksum.
- **Inputs**:
    - `src_ip`: The source IP address for the IPv4 header, in bytes.
    - `dst_ip`: The destination IP address for the IPv4 header, in bytes.
    - `payload_length`: The length of the payload that the IPv4 header will encapsulate.
    - `protocol`: The protocol number for the IPv4 header, default is 1.
    - `ttl`: The time-to-live value for the IPv4 header, default is 64.
- **Logic and Control Flow**:
    - Set the IPv4 version to 4 and the Internet Header Length (IHL) to 5, indicating a 20-byte header with no options.
    - Set the Type of Service (TOS) to 0 and calculate the total length of the packet by adding the header length to the payload length.
    - Set the identification field to a fixed value (0x1234) and the flags and fragment offset field to indicate 'Don't Fragment'.
    - Initialize the header checksum to 0, as it will be calculated later.
    - Pack the header fields into a binary format using `struct.pack`, excluding the checksum.
    - Calculate the checksum of the header using the [`calculate_ipv4_checksum`](<#calculate_ipv4_checksum>) function.
    - Insert the calculated checksum into the header at the appropriate position.
    - Return the complete header with the checksum included.
- **Output**: A binary string representing the complete inner IPv4 header with the calculated checksum.
- **Functions Called**:
    - [`firedancer/src/waltz/xdp/inject_gre_header.calculate_ipv4_checksum`](<#calculate_ipv4_checksum>)


---
### inject\_gre\_and\_inner\_ip<!-- {{#callable:firedancer/src/waltz/xdp/inject_gre_header.inject_gre_and_inner_ip}} -->
[View Source →](<../../../../../src/waltz/xdp/inject_gre_header.py#L131>)

Injects a GRE header and an inner IPv4 header into a given packet.
- **Inputs**:
    - `packet_data`: The raw packet data to modify by injecting GRE and inner IPv4 headers.
- **Logic and Control Flow**:
    - Parse the Ethernet header from the input `packet_data` to extract destination MAC, source MAC, EtherType, and IP data.
    - Check if the EtherType is 0x0800 (IPv4); if not, raise a `ValueError`.
    - Parse the outer IPv4 header to extract source and destination IP addresses and other header information.
    - Print the inner source and destination IP addresses for debugging purposes.
    - Create a GRE header using the [`create_gre_header`](<#create_gre_header>) function.
    - Convert the inner source and destination IP addresses to bytes if they are strings.
    - Create an inner IPv4 header using the [`create_inner_ipv4_header`](<#create_inner_ipv4_header>) function with the extracted IP addresses and payload length.
    - Calculate the new total length for the outer IPv4 header, including the GRE and inner IPv4 headers.
    - Create a new outer IPv4 header with the updated length and protocol set to GRE (47).
    - Add any options present in the original IPv4 header to the new outer header.
    - Calculate the checksum for the new outer IPv4 header and insert it into the header.
    - Reassemble the packet by concatenating the Ethernet header, new outer IPv4 header, GRE header, inner IPv4 header, and the original payload.
    - Return the newly assembled packet.
- **Output**: The modified packet data with the injected GRE and inner IPv4 headers.
- **Functions Called**:
    - [`firedancer/src/waltz/xdp/inject_gre_header.parse_ethernet_header`](<#parse_ethernet_header>)
    - [`firedancer/src/waltz/xdp/inject_gre_header.parse_ipv4_header`](<#parse_ipv4_header>)
    - [`firedancer/src/waltz/xdp/inject_gre_header.create_gre_header`](<#create_gre_header>)
    - [`firedancer/src/waltz/xdp/inject_gre_header.create_inner_ipv4_header`](<#create_inner_ipv4_header>)
    - [`firedancer/src/waltz/xdp/inject_gre_header.calculate_ipv4_checksum`](<#calculate_ipv4_checksum>)


---
### process\_packet\_files<!-- {{#callable:firedancer/src/waltz/xdp/inject_gre_header.process_packet_files}} -->
[View Source →](<../../../../../src/waltz/xdp/inject_gre_header.py#L215>)

Processes multiple packet files by injecting GRE and inner IPv4 headers and saving the modified packets to an output directory.
- **Inputs**:
    - `input_pattern`: A string pattern to match input packet files.
    - `output_dir`: The directory where modified packet files will be saved.
    - `inner_src_ip`: The source IP address for the inner IPv4 header, defaulting to '10.0.0.1'.
    - `inner_dst_ip`: The destination IP address for the inner IPv4 header, defaulting to '10.0.0.2'.
- **Logic and Control Flow**:
    - Check if the output directory exists; if not, create it.
    - Use the `glob` module to find files matching the `input_pattern`.
    - If no files match the pattern, print a message and return.
    - Iterate over each file found by the pattern.
    - For each file, read the packet data from the file.
    - Call [`inject_gre_and_inner_ip`](<#inject_gre_and_inner_ip>) to process the packet data by injecting GRE and inner IPv4 headers.
    - Determine the output file name by appending '_gre' to the original file name and save it in the `output_dir`.
    - Write the modified packet data to the output file.
    - Print a message indicating the creation of the output file and the size change of the packet.
    - Handle exceptions by printing an error message for any file that cannot be processed.
- **Output**: None. The function performs file operations and prints messages to the console.
- **Functions Called**:
    - [`firedancer/src/waltz/xdp/inject_gre_header.inject_gre_and_inner_ip`](<#inject_gre_and_inner_ip>)


---
### main<!-- {{#callable:firedancer/src/waltz/xdp/inject_gre_header.main}} -->
[View Source →](<../../../../../src/waltz/xdp/inject_gre_header.py#L255>)

Parses command-line arguments and processes packet files to inject GRE and inner IPv4 headers.
- **Inputs**: None
- **Logic and Control Flow**:
    - Imports the `argparse` module to handle command-line arguments.
    - Creates an `ArgumentParser` object with a description of the program's functionality.
    - Adds a positional argument `input_pattern` to specify the input file pattern.
    - Adds an optional argument `-o` or `--output-dir` to specify the output directory, defaulting to 'output'.
    - Parses the command-line arguments using `parse_args()`.
    - Calls the [`process_packet_files`](<#process_packet_files>) function with the parsed `input_pattern` and `output_dir` arguments.
- **Output**: No return value; the function executes the packet processing based on command-line input.
- **Functions Called**:
    - [`firedancer/src/waltz/xdp/inject_gre_header.process_packet_files`](<#process_packet_files>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)