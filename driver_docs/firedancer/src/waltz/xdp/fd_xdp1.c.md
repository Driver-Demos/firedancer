<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements an eBPF program for packet classification in an XDP context, including installation and management of BPF maps and programs.

# Purpose
The code defines a C module that generates and installs an eBPF (extended Berkeley Packet Filter) program for packet classification in an XDP (eXpress Data Path) context. The primary function, [`fd_xdp_gen_program`](<#fd_xdp_gen_program>), dynamically creates eBPF bytecode to classify incoming network packets based on their protocol and header values. The classification process involves checking the packet's path, such as Ethernet to IPv4 to UDP for non-GRE packets, and Ethernet to IPv4 to GRE to Inner IPv4 to UDP for GRE packets. Depending on the packet's characteristics, the function decides whether to redirect the packet to a specific software component (`LBL_REDIRECT`) or pass it to the kernel (`LBL_PASS`).

The module also includes the [`fd_xdp_install`](<#fd_xdp_install>) function, which installs the generated eBPF program onto a specified network interface. This function creates an XSK (AF_XDP socket) map, loads the eBPF program into the kernel, and attaches it to the network interface using the BPF_LINK_CREATE syscall. The installation process involves setting up the necessary attributes and handling potential errors related to kernel support and network device compatibility. The code ensures compatibility with older kernel headers by defining certain constants if they are not already available.
# Imports and Dependencies

---
- `fd_xdp1.h`
- `fd_xdp_license.h`
- `../ebpf/fd_linux_bpf.h`
- `../ebpf/fd_ebpf_asm.h`
- `errno.h`
- `unistd.h`
- `net/if.h`
- `sys/syscall.h`
- `linux/bpf.h`
- `linux/if_link.h`


# Data Structures

---
### bpf\_link\_create
- **Type**: ``struct``
- **Members**:
    - `prog_fd`: File descriptor for the BPF program.
    - `target_ifindex`: Index of the target network interface.
    - `attach_type`: Type of attachment for the BPF program.
    - `flags`: Flags for additional options during link creation.
- **Description**: Defines the parameters needed to create a BPF link, including the program file descriptor, target interface index, attachment type, and any additional flags.


# Functions

---
### fd\_xdp\_gen\_program<!-- {{#callable:fd_xdp_gen_program}} -->
[View Source →](<../../../../../src/waltz/xdp/fd_xdp1.c#L75>)

Generates an eBPF bytecode program to classify and process incoming network packets in an XDP context.
- **Inputs**:
    - `code_buf`: A buffer to store the generated eBPF bytecode, with a size of 512 `ulong` elements.
    - `xsks_fd`: A file descriptor for the XSK map used for packet redirection.
    - `listen_ip4_addr`: The IPv4 address to listen for incoming packets.
    - `ports`: An array of UDP ports to check against the destination port of incoming packets.
    - `ports_cnt`: The number of ports in the `ports` array.
    - `allowed_gre`: A flag indicating whether GRE packets are allowed (1 for allowed, 0 for not allowed).
- **Logic and Control Flow**:
    - Check if `ports_cnt` exceeds 16 and log an error if true.
    - Initialize pointers for the eBPF code buffer and set up initial registers for packet data and bounds.
    - Perform a bounds check on the Ethernet and IPv4 headers, passing the packet to the kernel if the check fails.
    - Check if the Ethernet header indicates an IPv4 packet, passing the packet to the kernel if not.
    - Advance the pointer to the start of the IPv4 header and calculate the start of the next header.
    - Check the protocol of the IPv4 header to determine if it is UDP or GRE, and jump to the appropriate label.
    - If GRE is allowed, perform additional checks on the GRE header and inner IPv4 header, passing the packet to the kernel if checks fail.
    - For UDP packets, check the destination IPv4 address if specified, and perform bounds checks on the UDP header.
    - Loop through the `ports` array to find a match with the destination port, redirecting the packet if a match is found.
    - Fill in jump labels for the eBPF program and log the generated bytecode.
    - Return the count of generated eBPF instructions.
- **Output**: The function returns the number of eBPF instructions generated and stored in `code_buf`.


---
### fd\_xdp\_install<!-- {{#callable:fd_xdp_install}} -->
[View Source →](<../../../../../src/waltz/xdp/fd_xdp1.c#L244>)

Installs an eBPF program for XDP on a specified network interface to listen on given UDP ports.
- **Inputs**:
    - `if_idx`: The index of the network interface where the XDP program will be installed.
    - `listen_ip4_addr`: The IPv4 address to listen for incoming packets.
    - `ports_cnt`: The number of UDP ports to listen on.
    - `ports`: An array of UDP ports to listen on.
    - `xdp_mode`: The XDP mode to use, which can be 'skb', 'drv', 'hw', or 'generic'.
- **Logic and Control Flow**:
    - Check the validity of the `xdp_mode` and convert it to the corresponding flag.
    - Count the number of non-zero ports in the `ports` array and log an error if none are found.
    - Create an XSK map using `bpf` system call with `BPF_MAP_CREATE`.
    - Generate eBPF bytecode using [`fd_xdp_gen_program`](<#fd_xdp_gen_program>) to classify incoming packets based on the provided parameters.
    - Load the generated eBPF program into the kernel using `bpf` system call with `BPF_PROG_LOAD`.
    - Create a BPF link to attach the program to the specified network interface using `bpf` system call with `BPF_LINK_CREATE`.
    - Log errors if any of the BPF operations fail, providing specific messages based on the error codes.
    - Close the program file descriptor after linking the program to the interface.
- **Output**: Returns a `fd_xdp_fds_t` structure containing file descriptors for the XSK map and the program link.
- **Functions Called**:
    - [`fd_xdp_gen_program`](<#fd_xdp_gen_program>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)