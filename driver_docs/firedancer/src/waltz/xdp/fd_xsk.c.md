<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for managing XDP socket (XSK) operations, including initialization, memory mapping, and cleanup.

# Purpose
The code is a C source file that provides functionality for managing AF_XDP sockets, which are used for high-performance packet processing in Linux environments with XDP (eXpress Data Path) support. The file includes functions to initialize, configure, and clean up AF_XDP sockets, which are specialized sockets that allow user-space applications to interact directly with network interface cards (NICs) for efficient packet processing. The code is intended to be used on Linux systems, as indicated by the preprocessor directive that checks for the Linux operating system.

Key components of the code include functions for mapping and unmapping XSK rings into the local address space ([`fd_xsk_mmap_ring`](<#fd_xsk_mmap_ring>) and [`fd_xsk_munmap_ring`](<#fd_xsk_munmap_ring>)), setting up UMEM (user memory) regions for packet buffers ([`fd_xsk_setup_umem`](<#fd_xsk_setup_umem>)), and initializing and finalizing the XSK socket ([`fd_xsk_init`](<#fd_xsk_init>) and [`fd_xsk_fini`](<#fd_xsk_fini>)). The code uses system calls such as `mmap`, `setsockopt`, and `bind` to configure the socket and manage memory mappings. It also includes error handling and logging to provide feedback on the success or failure of operations. The file is part of a larger system that likely involves other components for complete packet processing workflows.
# Imports and Dependencies

---
- `errno.h`
- `stdio.h`
- `unistd.h`
- `sys/mman.h`
- `sys/types.h`
- `sys/socket.h`
- `../../util/log/fd_log.h`
- `fd_xsk.h`


# Functions

---
### fd\_xsk\_mmap\_offset\_cstr<!-- {{#callable:fd_xsk_mmap_offset_cstr}} -->
[View Source →](<../../../../../src/waltz/xdp/fd_xsk.c#L20>)

Returns a string description of a given memory map offset for an XSK file descriptor.
- **Inputs**:
    - `mmap_off`: A long integer representing the memory map offset to describe.
- **Logic and Control Flow**:
    - Check the value of `mmap_off` using a switch statement.
    - If `mmap_off` matches `XDP_PGOFF_RX_RING`, return the string "XDP_PGOFF_RX_RING".
    - If `mmap_off` matches `XDP_PGOFF_TX_RING`, return the string "XDP_PGOFF_TX_RING".
    - If `mmap_off` matches `XDP_UMEM_PGOFF_FILL_RING`, return the string "XDP_UMEM_PGOFF_FILL_RING".
    - If `mmap_off` matches `XDP_UMEM_PGOFF_COMPLETION_RING`, return the string "XDP_UMEM_PGOFF_COMPLETION_RING".
    - If `mmap_off` does not match any of the above cases, format `mmap_off` as a hexadecimal string and return it.
- **Output**: A constant character pointer to a string describing the memory map offset, valid until the next call to this function.


---
### fd\_xsk\_mmap\_ring<!-- {{#callable:fd_xsk_mmap_ring}} -->
[View Source →](<../../../../../src/waltz/xdp/fd_xsk.c#L38>)

Maps an XSK ring into the local address space and initializes the `fd_xdp_ring_t` structure.
- **Inputs**:
    - ``ring``: A pointer to an `fd_xdp_ring_t` structure that will be initialized with the mapped memory details.
    - ``xsk_fd``: The file descriptor for the XSK socket.
    - ``map_off``: The offset for the memory mapping, indicating which ring to map.
    - ``elem_sz``: The size of each element in the ring.
    - ``depth``: The number of elements in the ring.
    - ``ring_offset``: A pointer to a `struct xdp_ring_offset` containing offsets for various ring components.
- **Logic and Control Flow**:
    - Checks if `depth` exceeds `UINT_MAX` and returns -1 if true.
    - Calculates the total size of the memory to map as `ring_offset->desc + depth * elem_sz`.
    - Attempts to map the memory using `mmap` with `PROT_READ|PROT_WRITE` and `MAP_SHARED` flags.
    - Logs a warning and returns -1 if `mmap` fails.
    - Initializes the `ring` structure to zero using `fd_memset`.
    - Sets the `mem`, `map_sz`, `depth`, `ptr`, `flags`, `prod`, and `cons` fields of the `ring` structure based on the mapped memory and offsets.
    - Returns 0 on successful mapping and initialization.
- **Output**: Returns 0 on success, or -1 if an error occurs during the mapping process.
- **Functions Called**:
    - [`fd_xsk_mmap_offset_cstr`](<#fd_xsk_mmap_offset_cstr>)


---
### fd\_xsk\_munmap\_ring<!-- {{#callable:fd_xsk_munmap_ring}} -->
[View Source →](<../../../../../src/waltz/xdp/fd_xsk.c#L80>)

Unmaps a previously mapped XSK ring from the local address space and resets the ring descriptor.
- **Inputs**:
    - ``ring``: A pointer to the `fd_xdp_ring_t` structure representing the XSK ring to unmap.
    - ``map_off``: A long integer representing the offset used in the mapping process, which is used for logging purposes.
- **Logic and Control Flow**:
    - Check if the `mem` field of the `ring` structure is NULL; if it is, return immediately.
    - Store the `mem` and `map_sz` fields of the `ring` structure in local variables `mem` and `sz`, respectively.
    - Reset the `ring` structure to zero using `fd_memset`.
    - Attempt to unmap the memory region pointed to by `mem` with size `sz` using `munmap`.
    - If `munmap` fails, log a warning message with details about the failure, including the memory address, size, ring type, and error information.
- **Output**: No return value; the function performs its operations directly on the input `ring` structure and logs a warning if unmapping fails.
- **Functions Called**:
    - [`fd_xsk_mmap_offset_cstr`](<#fd_xsk_mmap_offset_cstr>)


---
### fd\_xsk\_fini<!-- {{#callable:fd_xsk_fini}} -->
[View Source →](<../../../../../src/waltz/xdp/fd_xsk.c#L99>)

Releases resources associated with an XDP socket by unmapping memory rings and closing the socket file descriptor.
- **Inputs**:
    - `xsk`: A pointer to an `fd_xsk_t` structure representing the XDP socket to be finalized.
- **Logic and Control Flow**:
    - Call [`fd_xsk_munmap_ring`](<#fd_xsk_munmap_ring>) to unmap the receive ring (`ring_rx`) using `XDP_PGOFF_RX_RING` as the offset.
    - Call [`fd_xsk_munmap_ring`](<#fd_xsk_munmap_ring>) to unmap the transmit ring (`ring_tx`) using `XDP_PGOFF_TX_RING` as the offset.
    - Call [`fd_xsk_munmap_ring`](<#fd_xsk_munmap_ring>) to unmap the fill ring (`ring_fr`) using `XDP_UMEM_PGOFF_FILL_RING` as the offset.
    - Call [`fd_xsk_munmap_ring`](<#fd_xsk_munmap_ring>) to unmap the completion ring (`ring_cr`) using `XDP_UMEM_PGOFF_COMPLETION_RING` as the offset.
    - Check if the file descriptor `xsk_fd` is valid (greater than or equal to 0).
    - If valid, clear the `offsets` structure using `fd_memset` and close the file descriptor using `close`.
    - Set `xsk_fd` to -1 to indicate that the socket is no longer valid.
    - Return the `xsk` pointer.
- **Output**: Returns the pointer to the `fd_xsk_t` structure that was passed in.
- **Functions Called**:
    - [`fd_xsk_munmap_ring`](<#fd_xsk_munmap_ring>)


---
### fd\_xsk\_setup\_umem<!-- {{#callable:fd_xsk_setup_umem}} -->
[View Source →](<../../../../../src/waltz/xdp/fd_xsk.c#L124>)

Initializes and configures the UMEM region for an XDP socket using `setsockopt` and retrieves ring offsets using `getsockopt`.
- **Inputs**:
    - `xsk`: A pointer to an `fd_xsk_t` structure representing the XDP socket.
    - `params`: A pointer to a constant `fd_xsk_params_t` structure containing parameters for UMEM setup, such as address, size, and ring depths.
- **Logic and Control Flow**:
    - Initialize a `struct xdp_umem_reg` with the UMEM address, size, and frame size from `params`.
    - Call `setsockopt` to register the UMEM region with the XDP socket using `SOL_XDP` and `XDP_UMEM_REG`.
    - If `setsockopt` fails, log a warning and return -1.
    - Define a macro `FD_SET_XSK_RING_DEPTH` to set the depth of various XDP rings using `setsockopt`.
    - Use the macro to set the depths for `XDP_UMEM_FILL_RING`, `XDP_RX_RING`, `XDP_TX_RING`, and `XDP_UMEM_COMPLETION_RING` using values from `params`.
    - If any `setsockopt` call fails within the macro, log a warning and return -1.
    - Call `getsockopt` to retrieve the ring offsets into `xsk->offsets` using `SOL_XDP` and `XDP_MMAP_OFFSETS`.
    - If `getsockopt` fails, log a warning and return -1.
    - Return 0 to indicate successful setup.
- **Output**: Returns 0 on success or -1 on failure.


---
### fd\_xsk\_init<!-- {{#callable:fd_xsk_init}} -->
[View Source →](<../../../../../src/waltz/xdp/fd_xsk.c#L179>)

Initializes and configures an XDP socket (XSK) for packet processing using specified parameters.
- **Inputs**:
    - `xsk`: A pointer to an `fd_xsk_t` structure that will be initialized.
    - `params`: A pointer to a constant `fd_xsk_params_t` structure containing configuration parameters for the XSK.
- **Logic and Control Flow**:
    - Check if `xsk` is NULL and return NULL if true, logging a warning.
    - Initialize the `xsk` structure to zero using `memset`.
    - Validate `params` fields such as `if_idx`, `fr_depth`, `rx_depth`, `tx_depth`, `cr_depth`, `umem_addr`, and `frame_sz`, returning NULL and logging warnings if any are invalid.
    - Set `xsk->if_idx` and `xsk->if_queue_id` from `params`.
    - Create an XDP socket using `socket(AF_XDP, SOCK_RAW, 0)` and check for errors, returning NULL if socket creation fails.
    - Call [`fd_xsk_setup_umem`](<#fd_xsk_setup_umem>) to associate the UMEM region with the XSK using `setsockopt`, and handle failure by jumping to the `fail` label.
    - Map XSK rings into local address space using [`fd_xsk_mmap_ring`](<#fd_xsk_mmap_ring>) for RX, TX, fill, and completion rings, handling failures by jumping to the `fail` label.
    - Bind the XSK to a network interface queue using `bind` with a `sockaddr_xdp` structure, handling failure by jumping to the `fail` label.
    - Attempt a `sendto` call to detect potential NIC driver issues, logging errors if detected.
    - Log successful initialization of the XSK and return the `xsk` pointer.
    - On failure, call [`fd_xsk_fini`](<#fd_xsk_fini>) to clean up and return NULL.
- **Output**: Returns a pointer to the initialized `fd_xsk_t` structure on success, or NULL on failure.
- **Functions Called**:
    - [`fd_xsk_setup_umem`](<#fd_xsk_setup_umem>)
    - [`fd_xsk_mmap_ring`](<#fd_xsk_mmap_ring>)
    - [`fd_xsk_fini`](<#fd_xsk_fini>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)