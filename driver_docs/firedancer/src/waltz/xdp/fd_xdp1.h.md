<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Header file for installing and managing BPF programs to filter UDP traffic on specified ports.

# Purpose
This C header file defines structures and functions for managing eXpress Data Path (XDP) programs in a network application. It includes the `fd_util.h` utility header and defines a structure `fd_xdp_fds` to hold file descriptors for an XSK map and a BPF program link. The typedef `fd_xdp_fds_t` is an alias for this structure. The function [`fd_xdp_gen_program`](<#fd_xdp_gen_program>) generates a BPF program code buffer for handling network traffic, while [`fd_xdp_install`](<#fd_xdp_install>) installs a BPF program on a specified network interface. The installed program filters and forwards UDP traffic on specified ports to XSK sockets, optionally filtering by a given IPv4 address. The function ensures that the BPF program remains active by maintaining the BPF link file descriptor until the process exits.
# Imports and Dependencies

---
- `../../util/fd_util.h`


# Data Structures

---
### fd\_xdp\_fds
- **Type**: ``struct``
- **Members**:
    - `xsk_map_fd`: File descriptor for the XSK map.
    - `prog_link_fd`: File descriptor for the BPF program link.
- **Description**: Holds file descriptors related to XDP (eXpress Data Path) operations, specifically for managing an XSK map and a BPF program link. The `xsk_map_fd` is used to manage socket file descriptors in the XSK map, while `prog_link_fd` is used to maintain the link to the BPF program, ensuring it remains installed on the network interface.


---
### fd\_xdp\_fds\_t
- **Type**: ``struct``
- **Members**:
    - `xsk_map_fd`: File descriptor for the XSK map.
    - `prog_link_fd`: File descriptor for the BPF program link.
- **Description**: Contains file descriptors related to XDP (eXpress Data Path) operations, specifically for managing an XSK map and a BPF program link. The `xsk_map_fd` is used to manage socket file descriptors in an XSK map, while the `prog_link_fd` is used to maintain the link to a BPF program, ensuring it remains installed on a network interface.


# Function Declarations (Public API)

---
### fd\_xdp\_gen\_program<!-- {{#callable_declaration:fd_xdp_gen_program}} -->
[View Source →](<../../../../../src/waltz/xdp/fd_xdp1.h#L13>)

Generates an XDP program for packet filtering and redirection.
- **Description**: Use this function to create an eBPF program that filters and redirects network packets based on specified criteria. The function writes the generated program into the provided buffer. It supports filtering by destination IPv4 address and UDP ports, and optionally checks for GRE encapsulation. Ensure the `ports_cnt` does not exceed 16, as the function will terminate the process if this limit is exceeded. The function returns the number of instructions written to the buffer.
- **Inputs**:
    - `code_buf`: A buffer with a size of 512 `ulong` elements where the generated eBPF program will be stored. The caller must provide this buffer.
    - `xsks_fd`: A file descriptor for the XSK map, used for packet redirection.
    - `listen_ip4_addr`: An IPv4 address in network byte order to filter packets by destination address. Use 0 to disable this filter.
    - `ports`: A pointer to an array of UDP ports to filter. The array must contain `ports_cnt` elements.
    - `ports_cnt`: The number of UDP ports in the `ports` array. Must not exceed 16, or the function will terminate the process.
    - `allowed_gre`: A flag indicating whether to allow GRE encapsulated packets. Use 1 to allow, 0 to disallow.
- **Output**: Returns the number of instructions written to the `code_buf`.
- **See Also**: [`fd_xdp_gen_program`](<fd_xdp1.c.md#fd_xdp_gen_program>)  (Implementation)


---
### fd\_xdp\_install<!-- {{#callable_declaration:fd_xdp_install}} -->
[View Source →](<../../../../../src/waltz/xdp/fd_xdp1.h#L37>)

Installs a BPF program on a network interface for UDP traffic filtering.
- **Description**: Use this function to install a BPF program on a specified network interface to filter and pass UDP traffic through specified ports to an XSK map. The function requires a valid network interface index and a list of UDP ports. If a non-zero IPv4 address is provided, the program will filter traffic based on this address. The function returns a structure containing file descriptors for the XSK map and the BPF link. Do not close the BPF link file descriptor, as this will uninstall the XDP program and stop packet reception. The function will terminate the process with an error message if it fails.
- **Inputs**:
    - `if_idx`: The index of the network interface on which to install the BPF program. Must be a valid interface index.
    - `listen_ip4_addr`: An IPv4 address in network byte order to filter destination addresses. Use zero to disable address filtering.
    - `ports_cnt`: The number of UDP ports in the `ports` array. Must be greater than zero.
    - `ports`: An array of UDP port numbers to filter. Must not be null and must contain at least one non-zero port number.
    - `xdp_mode`: A string specifying the XDP mode. Valid values are "skb", "drv", "hw", and "generic". An invalid value will cause the function to terminate the process with an error.
- **Output**: Returns a `fd_xdp_fds_t` structure containing file descriptors for the XSK map and the BPF link.
- **See Also**: [`fd_xdp_install`](<fd_xdp1.c.md#fd_xdp_install>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)