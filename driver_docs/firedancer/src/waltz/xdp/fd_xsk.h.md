<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Manages an XSK file descriptor for AF_XDP sockets, providing RX/TX buffers and memory management.

# Purpose
The code defines a C header file that provides an interface for managing AF_XDP sockets, also known as XSKs, on Linux systems. AF_XDP is a Linux API that allows for kernel-bypass networking using shared memory ring buffers accessible from userspace. This header file includes structures and functions to manage the lifecycle of an XSK, including initialization, memory management, and communication with the kernel. The code is designed to facilitate high-performance packet processing by allowing userspace applications to directly interact with network interface cards (NICs) through the XDP (eXpress Data Path) framework.

Key components of the code include the `fd_xdp_ring_t` and `fd_xsk_t` structures, which describe the descriptor rings and the XSK itself, respectively. The [`fd_xsk_init`](<#fd_xsk_init>) function initializes an XSK, registers the UMEM (user memory), maps the necessary rings, and binds the socket to a specified network interface queue. The code also provides inline functions [`fd_xsk_rx_need_wakeup`](<#fd_xsk_rx_need_wakeup>) and [`fd_xsk_tx_need_wakeup`](<#fd_xsk_tx_need_wakeup>) to determine if a wakeup is required for receive and transmit operations. The header file is intended to be included in other C source files that require direct interaction with AF_XDP sockets for efficient packet processing.
# Imports and Dependencies

---
- `linux/if_link.h`
- `linux/if_xdp.h`
- `net/if.h`
- `../../util/fd_util_base.h`


# Data Structures

---
### fd\_xdp\_ring
- **Type**: ``struct``
- **Members**:
    - ``mem``: Points to the start of the shared descriptor ring mmap region.
    - ``map_sz``: Size of the shared descriptor ring mmap region.
    - ``_pad_0x10``: Padding for alignment purposes.
    - ``_pad_0x18``: Padding for alignment purposes.
    - ``ptr``: Opaque pointer to the XSK ring structure.
    - ``packet_ring``: Pointer for RX and TX rings.
    - ``frame_ring``: Pointer for FILL and COMPLETION rings.
    - ``flags``: Points to flags in the shared descriptor ring.
    - ``prod``: Points to the producer sequence in the shared descriptor ring.
    - ``cons``: Points to the consumer sequence in the shared descriptor ring.
    - ``depth``: Capacity of the ring in number of entries.
    - ``cached_prod``: Cached value of the producer sequence.
    - ``cached_cons``: Cached value of the consumer sequence.
- **Description**: Describes an XSK descriptor ring in the thread group's local address space, with pointers to kernel-managed XSK descriptor buffers. The structure includes memory mapping parameters, pointers to opaque XSK ring structures, and synchronization fields for producer and consumer sequences. The ring's capacity and cached sequence values are also managed within this structure.


---
### fd\_xdp\_ring\_t
- **Type**: ``struct``
- **Members**:
    - ``mem``: Points to the start of the shared descriptor ring mmap region.
    - ``map_sz``: Size of the shared descriptor ring mmap region.
    - ``_pad_0x10``: Padding for alignment purposes.
    - ``_pad_0x18``: Padding for alignment purposes.
    - ``ptr``: Opaque pointer to the XSK ring structure.
    - ``packet_ring``: Pointer to the packet ring for RX and TX rings.
    - ``frame_ring``: Pointer to the frame ring for FILL and COMPLETION rings.
    - ``flags``: Points to flags in the shared descriptor ring.
    - ``prod``: Points to the producer sequence number in the shared descriptor ring.
    - ``cons``: Points to the consumer sequence number in the shared descriptor ring.
    - ``depth``: Capacity of the ring in number of entries.
    - ``cached_prod``: Cached value of the producer sequence number.
    - ``cached_cons``: Cached value of the consumer sequence number.
- **Description**: Describes an XSK descriptor ring in the thread group's local address space, with pointers to kernel-managed XSK descriptor buffers. The structure includes memory mapping parameters, pointers to opaque XSK ring structures, and synchronization fields for producer and consumer sequence numbers. The ring is managed by `fd_xsk_t` and is aligned to 64 bytes for performance.


---
### fd\_xsk\_params
- **Type**: ``struct``
- **Members**:
    - ``fr_depth``: Number of frames allocated for the Fill XSK ring.
    - ``rx_depth``: Number of frames allocated for the RX XSK ring.
    - ``tx_depth``: Number of frames allocated for the TX XSK ring.
    - ``cr_depth``: Number of frames allocated for the Completion XSK ring.
    - ``umem_addr``: Pointer to UMEM in local address space.
    - ``frame_sz``: Controls the frame size used in the UMEM ring buffers.
    - ``umem_sz``: Total size of XSK ring shared memory area, aligned by `FD_XSK_ALIGN`.
    - ``if_idx``: Linux interface index.
    - ``if_queue_id``: Interface queue index.
    - ``bind_flags``: Additional parameters for `sockaddr_xdp.sxdp_flags`, e.g., `XDP_ZEROCOPY`.
- **Description**: Defines parameters for configuring an XSK (AF_XDP socket) including memory layout, frame allocation depths for various XSK rings, and network interface details.


---
### fd\_xsk\_params\_t
- **Type**: ``struct``
- **Members**:
    - ``fr_depth``: Number of frames allocated for the Fill XSK ring.
    - ``rx_depth``: Number of frames allocated for the RX XSK ring.
    - ``tx_depth``: Number of frames allocated for the TX XSK ring.
    - ``cr_depth``: Number of frames allocated for the Completion XSK ring.
    - ``umem_addr``: Pointer to UMEM in local address space.
    - ``frame_sz``: Controls the frame size used in the UMEM ring buffers.
    - ``umem_sz``: Total size of XSK ring shared memory area, aligned by `FD_XSK_ALIGN`.
    - ``if_idx``: Linux interface index.
    - ``if_queue_id``: Interface queue index.
    - ``bind_flags``: Additional parameters for `sockaddr_xdp.sxdp_flags`, e.g., `XDP_ZEROCOPY`.
- **Description**: Defines memory layout parameters for an XSK, including depths for various XSK rings, UMEM address and size, frame size, and network interface indices and flags.


---
### fd\_xsk
- **Type**: ``struct fd_xsk``
- **Members**:
    - ``if_idx``: Index of the network device.
    - ``if_queue_id``: Combined queue index of the network device.
    - ``log_suppress_until_ns``: Suppresses log messages until the specified time.
    - ``offsets``: Kernel descriptor of XSK rings in local address space.
    - ``xsk_fd``: File descriptor for the AF_XDP socket.
    - ``ring_rx``: Descriptor for the RX XSK ring.
    - ``ring_tx``: Descriptor for the TX XSK ring.
    - ``ring_fr``: Descriptor for the FILL XSK ring.
    - ``ring_cr``: Descriptor for the COMPLETION XSK ring.
- **Description**: Manages an AF_XDP socket file descriptor and provides descriptors for RX, TX, FILL, and COMPLETION rings, facilitating kernel-bypass networking through shared memory ring buffers accessible from userspace.


---
### fd\_xsk\_t
- **Type**: ``struct``
- **Members**:
    - ``if_idx``: Index of the network device.
    - ``if_queue_id``: Combined queue index of the network device.
    - ``log_suppress_until_ns``: Time until which log messages are suppressed.
    - ``offsets``: Kernel descriptor of XSK rings in local address space.
    - ``xsk_fd``: File descriptor for the AF_XDP socket.
    - ``ring_rx``: Descriptor for the RX ring.
    - ``ring_tx``: Descriptor for the TX ring.
    - ``ring_fr``: Descriptor for the Fill ring.
    - ``ring_cr``: Descriptor for the Completion ring.
- **Description**: Manages an XSK file descriptor and provides RX/TX buffers for kernel-bypass networking using AF_XDP, allowing userspace applications to interact with network packets directly through shared memory ring buffers.


# Functions

---
### fd\_xsk\_rx\_need\_wakeup<!-- {{#callable:fd_xsk_rx_need_wakeup}} -->
[View Source →](<../../../../../src/waltz/xdp/fd_xsk.h#L245>)

Checks if a wakeup is needed to complete a receive operation on an XSK.
- **Inputs**:
    - `xsk`: A pointer to an `fd_xsk_t` structure representing the XSK (AF_XDP socket) to check.
- **Logic and Control Flow**:
    - Accesses the `flags` field of the `ring_fr` member of the `fd_xsk_t` structure pointed to by `xsk`.
    - Performs a bitwise AND operation between the value pointed to by `xsk->ring_fr.flags` and the constant `XDP_RING_NEED_WAKEUP`.
    - Converts the result of the bitwise operation to a boolean value using the double negation `!!` operator.
    - Returns the boolean result indicating if a wakeup is needed.
- **Output**: An integer value, either 0 or 1, indicating whether a wakeup is required (1) or not (0) for the receive operation.


---
### fd\_xsk\_tx\_need\_wakeup<!-- {{#callable:fd_xsk_tx_need_wakeup}} -->
[View Source →](<../../../../../src/waltz/xdp/fd_xsk.h#L253>)

Checks if a wakeup is needed to complete a transmission operation on an XSK.
- **Inputs**:
    - `xsk`: A pointer to an `fd_xsk_t` structure representing the XSK (AF_XDP socket) for which the wakeup status is checked.
- **Logic and Control Flow**:
    - Access the `flags` field of the `ring_tx` member of the `fd_xsk_t` structure pointed to by `xsk`.
    - Perform a bitwise AND operation between the value pointed to by `xsk->ring_tx.flags` and the constant `XDP_RING_NEED_WAKEUP`.
    - Convert the result of the bitwise operation to a boolean value using the double negation `!!` operator.
    - Return the boolean result indicating whether a wakeup is needed.
- **Output**: Returns an integer value (0 or 1) indicating whether a wakeup is required for the transmission operation.


# Function Declarations (Public API)

---
### fd\_xsk\_init<!-- {{#callable_declaration:fd_xsk_init}} -->
[View Source →](<../../../../../src/waltz/xdp/fd_xsk.h#L212>)

Initializes an XSK with specified parameters.
- **Description**: Use this function to create and configure an XSK (AF_XDP socket) for network packet processing. It registers the UMEM, maps the necessary rings, and binds the socket to a specified network interface queue. This function requires administrative privileges (CAP_SYS_ADMIN) and may perform several system calls, including socket creation, setting options, and memory mapping. Ensure that the `xsk` pointer is valid and that the `params` structure contains valid configuration values before calling. The function returns a pointer to the initialized `fd_xsk_t` structure or `NULL` if initialization fails.
- **Inputs**:
    - `xsk`: A pointer to an `fd_xsk_t` structure that will be initialized. Must not be null. The caller retains ownership.
    - `params`: A pointer to a constant `fd_xsk_params_t` structure containing configuration parameters. Must not be null. The `if_idx` must be non-zero, and `fr_depth`, `rx_depth`, `tx_depth`, and `cr_depth` must be non-zero. `umem_addr` must be non-null and aligned to 4096 bytes. `frame_sz` must be a non-zero power of two.
- **Output**: Returns a pointer to the initialized `fd_xsk_t` structure on success, or `NULL` on failure.
- **See Also**: [`fd_xsk_init`](<fd_xsk.c.md#fd_xsk_init>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)