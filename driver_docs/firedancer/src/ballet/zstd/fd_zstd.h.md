<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

APIs for Zstandard compressed streams, including streaming decompression and memory management.

# Purpose
The code is a C header file that defines an API for handling Zstandard compressed streams, specifically `.zst` files. It provides functionality for streaming decompression of Zstandard frames using the `libzstd` library in static mode. The header file includes definitions for data structures and function prototypes necessary for managing decompression streams (`fd_zstd_dstream_t`) and peeking into frame headers (`fd_zstd_peek_t`). The API is designed to operate without dynamic memory allocation or system calls, requiring the caller to manage memory allocation for the decompression objects.

The file defines several functions for creating, deleting, resetting, and reading from decompression streams. The [`fd_zstd_dstream_new`](<#fd_zstd_dstream_new>) function initializes a new decompression stream, while [`fd_zstd_dstream_delete`](<#fd_zstd_dstream_delete>) releases the memory back to the caller. The [`fd_zstd_dstream_read`](<#fd_zstd_dstream_read>) function is used to decompress data from a stream, updating pointers to indicate progress. The header also includes constants for alignment and header size, and it provides a mechanism to peek into frame headers to determine window size and other frame properties. The code does not currently support dictionary or prefix dependencies, and it does not include compression logic, which is noted as a future improvement.
# Imports and Dependencies

---
- `../fd_ballet_base.h`


# Data Structures

---
### fd\_zstd\_dstream\_t
- **Type**: ``struct``
- **Description**: Provides streaming decompression for Zstandard frames, handling one frame at a time.


---
### fd\_zstd\_peek
- **Type**: ``struct``
- **Members**:
    - `window_sz`: Specifies the window size required for decompression.
    - `frame_content_sz`: Indicates the size of the frame content, or `ULONG_MAX` if unknown.
    - `frame_is_skippable`: Indicates if the frame can be skipped during processing.
- **Description**: The `fd_zstd_peek` structure holds metadata about a Zstandard compressed frame, including the window size needed for decompression, the size of the frame content, and whether the frame is skippable. This structure is used to decode and interpret the header of a Zstandard frame, facilitating the management of compressed data streams.


---
### fd\_zstd\_peek\_t
- **Type**: ``struct``
- **Members**:
    - `window_sz`: Stores the window size required for decompression of a Zstandard frame.
    - `frame_content_sz`: Indicates the size of the frame content, set to `ULONG_MAX` if unknown.
    - `frame_is_skippable`: Indicates whether the frame is skippable.
- **Description**: The `fd_zstd_peek_t` structure is used to store metadata about a Zstandard frame, including the window size needed for decompression, the size of the frame content, and whether the frame is skippable. This structure is populated by the `fd_zstd_peek` function, which decodes the frame header from a buffer.


# Function Declarations (Public API)

---
### fd\_zstd\_dstream\_align<!-- {{#callable_declaration:fd_zstd_dstream_align}} -->
[View Source →](<../../../../../src/ballet/zstd/fd_zstd.h#L95>)

Returns the alignment requirement for a Zstandard decompression stream.
- **Description**: Use this function to obtain the alignment requirement for memory regions that back a `fd_zstd_dstream_t` object. This is necessary when allocating memory for a decompression stream to ensure proper alignment. The function does not require any parameters and can be called at any time to retrieve the alignment value.
- **Inputs**: None
- **Output**: Returns an unsigned long integer representing the alignment requirement in bytes for a `fd_zstd_dstream_t` object.
- **See Also**: [`fd_zstd_dstream_align`](<fd_zstd.c.md#fd_zstd_dstream_align>)  (Implementation)


---
### fd\_zstd\_dstream\_footprint<!-- {{#callable_declaration:fd_zstd_dstream_footprint}} -->
[View Source →](<../../../../../src/ballet/zstd/fd_zstd.h#L98>)

Calculates the memory footprint for a decompression stream.
- **Description**: Use this function to determine the memory size required to back a `fd_zstd_dstream_t` object for streaming decompression of Zstandard frames. This is necessary to allocate the correct amount of memory before creating a decompression stream. The function requires the maximum window size that the stream will handle, which relates to the compression level of the data. Ensure that the provided window size is accurate to avoid memory allocation issues.
- **Inputs**:
    - `max_window_sz`: Specifies the largest window size that the decompression stream can handle. This value must be a valid window size for the data to be decompressed. If the window size is too small, decompression may fail.
- **Output**: Returns the size in bytes of the memory region required to back a `fd_zstd_dstream_t` object for the specified maximum window size.
- **See Also**: [`fd_zstd_dstream_footprint`](<fd_zstd.c.md#fd_zstd_dstream_footprint>)  (Implementation)


---
### fd\_zstd\_dstream\_new<!-- {{#callable_declaration:fd_zstd_dstream_new}} -->
[View Source →](<../../../../../src/ballet/zstd/fd_zstd.h#L107>)

Creates a new Zstandard decompression stream object.
- **Description**: Use this function to initialize a new decompression stream for Zstandard frames. The function requires a memory region provided by the caller, which must meet alignment and footprint requirements based on the specified maximum window size. This function does not perform dynamic memory allocation. On success, it returns a handle to the newly created decompression stream, which is ready to process a new frame. If the initialization fails, it returns NULL. Ensure that the memory region is not shared across address spaces and is not relocated after creation.
- **Inputs**:
    - `mem`: A pointer to a memory region that backs the decompression stream. This memory must meet alignment and footprint requirements for the specified maximum window size. The caller retains ownership and must ensure the memory is valid for the lifetime of the stream.
    - `max_window_sz`: The maximum window size that the decompression stream can handle. This value determines the memory footprint of the stream. It must be a valid size that the stream can support.
- **Output**: Returns a pointer to the newly created `fd_zstd_dstream_t` object on success, or NULL on failure.
- **See Also**: [`fd_zstd_dstream_new`](<fd_zstd.c.md#fd_zstd_dstream_new>)  (Implementation)


---
### fd\_zstd\_dstream\_delete<!-- {{#callable_declaration:fd_zstd_dstream_delete}} -->
[View Source →](<../../../../../src/ballet/zstd/fd_zstd.h#L116>)

Destroys a Zstandard decompression stream object.
- **Description**: Use this function to destroy a Zstandard decompression stream object and release its associated memory back to the caller. It is safe to call this function with a null pointer, in which case it performs no operation. This function should be called when the decompression stream is no longer needed, ensuring that resources are properly released. The function checks for memory corruption by verifying a magic number and logs a critical error if corruption is detected.
- **Inputs**:
    - `dstream`: A pointer to the `fd_zstd_dstream_t` object to be destroyed. Must not be null unless the caller intends to perform a no-op. The function checks for memory corruption by verifying a magic number and logs a critical error if the magic number is invalid.
- **Output**: Returns a pointer to the memory region originally provided to create the `dstream` object, or NULL if `dstream` is null.
- **See Also**: [`fd_zstd_dstream_delete`](<fd_zstd.c.md#fd_zstd_dstream_delete>)  (Implementation)


---
### fd\_zstd\_dstream\_reset<!-- {{#callable_declaration:fd_zstd_dstream_reset}} -->
[View Source →](<../../../../../src/ballet/zstd/fd_zstd.h#L122>)

Resets the state of a decompression stream object.
- **Description**: Use this function to reset a decompression stream object so that it is ready to process a new frame. This is useful when you want to reuse the same decompression stream object for multiple frames without creating a new object each time. Ensure that the decompression stream object is valid and initialized before calling this function.
- **Inputs**:
    - `dstream`: A pointer to a valid and initialized `fd_zstd_dstream_t` object. Must not be null. The function does not handle null pointers and expects the object to be in a valid state.
- **Output**: None
- **See Also**: [`fd_zstd_dstream_reset`](<fd_zstd.c.md#fd_zstd_dstream_reset>)  (Implementation)


---
### fd\_zstd\_dstream\_read<!-- {{#callable_declaration:fd_zstd_dstream_read}} -->
[View Source →](<../../../../../src/ballet/zstd/fd_zstd.h#L149>)

Decompresses a fragment of Zstandard compressed stream data.
- **Description**: Use this function to decompress a portion of a Zstandard compressed stream. It updates the input and output pointers to reflect the progress of decompression. Ensure that the input and output pointers are correctly initialized to point to the start of the data and buffer, respectively. The function returns specific codes to indicate the status of decompression, such as completion of a frame or an error. If an error occurs, and `opt_errcode` is not null, it will contain the error code. Reset the decompression stream if an error is encountered.
- **Inputs**:
    - `dstream`: A pointer to a `fd_zstd_dstream_t` object that manages the decompression state. Must not be null.
    - `in_p`: A pointer to a pointer to the next byte of compressed data. Must not be null. The function updates this to point to the next byte not yet decompressed.
    - `in_end`: A pointer to one byte past the end of the compressed data fragment. Must not be null.
    - `out_p`: A pointer to a pointer to the next free byte in the destination buffer. Must not be null. The function updates this to point to the next free byte after decompression.
    - `out_end`: A pointer to one byte past the end of the destination buffer. Must not be null.
    - `opt_errcode`: An optional pointer to a `ulong` where the function stores an error code if an error occurs. Can be null.
- **Output**: Returns 0 if decompression is ongoing and more data is expected, -1 if the current frame is fully decompressed, or an error code if an error occurs. Updates `*in_p` and `*out_p` to reflect the progress of decompression.
- **See Also**: [`fd_zstd_dstream_read`](<fd_zstd.c.md#fd_zstd_dstream_read>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)