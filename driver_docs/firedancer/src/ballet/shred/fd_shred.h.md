<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Header file defining the structure and functions for handling Solana shreds, including types, sizes, and error correction.

# Purpose
The code defines a C header file for handling "shreds," which are data structures used in the Solana blockchain to represent block data optimized for transmission over unreliable networks. Shreds are designed to fit within a single UDP packet, adhering to the IPv6 MTU constraints. The file provides definitions and functions for parsing, validating, and manipulating these shreds, which can be of different types, including legacy data, legacy code, Merkle data, and Merkle code. Each type of shred has specific characteristics, such as the inclusion of Merkle proofs or Reed-Solomon error correction codes, to ensure data integrity and error correction.

The header file includes constants, type definitions, and inline functions to facilitate the handling of shreds. It defines the structure of a shred, including its headers and payload, and provides functions to parse shreds, determine their type, and access their payloads and Merkle proofs. The file also includes error codes specific to the Firedancer implementation, which are not part of the Solana protocol. The functions and macros in this file are intended to be used by other parts of the Firedancer codebase to manage the creation, transmission, and validation of shreds within the Solana network.
# Imports and Dependencies

---
- `../bmtree/fd_bmtree.h`
- `../fd_ballet.h`


# Data Structures

---
### fd\_shred
- **Type**: ``struct fd_shred``
- **Members**:
    - ``signature``: Ed25519 signature over the shred, signing either the content past this field or the first node of the inclusion proof.
    - ``variant``: Shred variant specifier consisting of two four-bit fields indicating shred type and additional properties.
    - ``slot``: Slot number that this shred is part of.
    - ``idx``: Index of this shred within the slot.
    - ``version``: Hash of the genesis version and historical hard forks of the current chain.
    - ``fec_set_idx``: Index into the vector of FEC sets for this slot.
    - ``data``: Common data shred header containing parent block offset, flags, and shred size.
    - ``code``: Common coding shred header containing data and coding shred counts and index within the FEC set.
- **Description**: Represents a packed data structure for Solana block data shreds, optimized for transmission over unreliable networks. It includes fields for signature, variant, slot, index, version, and FEC set index, with a union for data or coding shred headers. The structure supports legacy and Merkle shreds, with additional properties for chained and resigned variants, facilitating error correction and inclusion proofs.


---
### fd\_shred\_t
- **Type**: ``struct``
- **Members**:
    - ``signature``: Ed25519 signature over the shred.
    - ``variant``: Shred variant specifier indicating type and Merkle proof length.
    - ``slot``: Slot number that this shred is part of.
    - ``idx``: Index of this shred within the slot.
    - ``version``: Hash of the genesis version and historical hard forks of the current chain.
    - ``fec_set_idx``: Index into the vector of FEC sets for this slot.
    - ``data``: Common data shred header containing parent offset, flags, and size.
    - ``code``: Common coding shred header containing data count, code count, and index.
- **Description**: Represents the primary data structure for shreds in the Solana blockchain, optimized for transmission over unreliable networks. It includes fields for signature, variant, slot, index, version, and FEC set index, with a union for data and coding shred headers. The structure supports different shred types, including legacy and Merkle variants, and implements features like forward error correction and Merkle inclusion proofs.


# Functions

---
### fd\_shred\_type<!-- {{#callable:fd_shred_type}} -->
[View Source →](<../../../../../src/ballet/shred/fd_shred.h#L281>)

Extracts the type of a shred from its variant by masking the lower four bits.
- **Inputs**:
    - `variant`: An unsigned character representing the variant of a shred, which includes both type and additional information.
- **Logic and Control Flow**:
    - Perform a bitwise AND operation between `variant` and `0xf0` to mask out the lower four bits.
    - Return the result of the bitwise operation, which represents the type of the shred.
- **Output**: An unsigned character representing the type of the shred, extracted from the high four bits of the `variant`.


---
### fd\_shred\_variant<!-- {{#callable:fd_shred_variant}} -->
[View Source →](<../../../../../src/ballet/shred/fd_shred.h#L288>)

Encodes the variant field of a shred by combining the shred type with a specific merkle proof length.
- **Inputs**:
    - `type`: The type of the shred, which can be one of several predefined constants such as `FD_SHRED_TYPE_LEGACY_DATA` or `FD_SHRED_TYPE_LEGACY_CODE`.
    - `merkle_cnt`: The number of non-root nodes in the merkle inclusion proof, which is modified based on the shred type.
- **Logic and Control Flow**:
    - Check if `type` is `FD_SHRED_TYPE_LEGACY_DATA`; if true, set `merkle_cnt` to 0x05.
    - Check if `type` is `FD_SHRED_TYPE_LEGACY_CODE`; if true, set `merkle_cnt` to 0x0a.
    - Return the result of a bitwise OR operation between `type` and `merkle_cnt`.
- **Output**: Returns an `uchar` representing the encoded variant field of the shred.


---
### fd\_shred\_sz<!-- {{#callable:fd_shred_sz}} -->
[View Source →](<../../../../../src/ballet/shred/fd_shred.h#L298>)

Determines the size of a shred based on its type and variant.
- **Inputs**:
    - `shred`: A pointer to a `fd_shred_t` structure representing the shred whose size is to be determined.
- **Logic and Control Flow**:
    - Retrieve the shred type using [`fd_shred_type`](<#fd_shred_type>) function on the `variant` field of the `shred`.
    - Check if the shred type is a code type by performing a bitwise AND with `FD_SHRED_TYPEMASK_CODE`.
    - If the shred is a code type, return `FD_SHRED_MAX_SZ`.
    - If the shred type is `FD_SHRED_TYPE_LEGACY_DATA`, return the `size` field from the `data` union of the `shred`.
    - If none of the above conditions are met, return `FD_SHRED_MIN_SZ`.
- **Output**: Returns the size of the shred as an `ulong`.
- **Functions Called**:
    - [`fd_shred_type`](<#fd_shred_type>)


---
### fd\_shred\_header\_sz<!-- {{#callable:fd_shred_header_sz}} -->
[View Source →](<../../../../../src/ballet/shred/fd_shred.h#L312>)

Determines the header size of a shred based on its variant type.
- **Inputs**:
    - `variant`: An unsigned character representing the variant of the shred, which encodes the type and other properties of the shred.
- **Logic and Control Flow**:
    - Call [`fd_shred_type`](<#fd_shred_type>) to extract the type from the `variant` by masking the high four bits.
    - Check if the type matches a data shred using `FD_SHRED_TYPEMASK_DATA`; if true, return `FD_SHRED_DATA_HEADER_SZ`.
    - Check if the type matches a code shred using `FD_SHRED_TYPEMASK_CODE`; if true, return `FD_SHRED_CODE_HEADER_SZ`.
    - If neither condition is met, return 0, indicating an invalid or unrecognized shred type.
- **Output**: Returns the size of the header for the given shred type as an unsigned long integer, or 0 if the type is invalid.
- **Functions Called**:
    - [`fd_shred_type`](<#fd_shred_type>)


---
### fd\_shred\_merkle\_cnt<!-- {{#callable:fd_shred_merkle_cnt}} -->
[View Source →](<../../../../../src/ballet/shred/fd_shred.h#L325>)

Determines the number of nodes in the Merkle inclusion proof for a given shred variant, excluding the root node.
- **Inputs**:
    - `variant`: An unsigned character representing the shred variant, which encodes the type of shred and the number of non-root nodes in the Merkle inclusion proof.
- **Logic and Control Flow**:
    - Extracts the shred type from the `variant` using the [`fd_shred_type`](<#fd_shred_type>) function.
    - Checks if the shred type is either `FD_SHRED_TYPE_LEGACY_DATA` or `FD_SHRED_TYPE_LEGACY_CODE`.
    - If the shred type is legacy, returns 0 as there are no Merkle nodes.
    - If the shred type is not legacy, returns the lower four bits of the `variant`, which represent the number of non-root Merkle nodes.
- **Output**: Returns an unsigned integer representing the number of non-root nodes in the Merkle inclusion proof, or 0 if the shred is a legacy variant.
- **Functions Called**:
    - [`fd_shred_type`](<#fd_shred_type>)


---
### fd\_shred\_merkle\_sz<!-- {{#callable:fd_shred_merkle_sz}} -->
[View Source →](<../../../../../src/ballet/shred/fd_shred.h#L335>)

Calculates the size in bytes of the Merkle inclusion proof for a given shred variant.
- **Inputs**:
    - `variant`: An unsigned character representing the shred variant, which indicates the type and Merkle proof length of the shred.
- **Logic and Control Flow**:
    - Calls [`fd_shred_merkle_cnt`](<#fd_shred_merkle_cnt>) with `variant` to get the number of nodes in the Merkle inclusion proof, excluding the root.
    - Multiplies the result by `FD_SHRED_MERKLE_NODE_SZ` to calculate the total size in bytes of the Merkle inclusion proof.
- **Output**: Returns an unsigned long integer representing the size in bytes of the Merkle inclusion proof. Returns zero if the shred is not a Merkle variant.
- **Functions Called**:
    - [`fd_shred_merkle_cnt`](<#fd_shred_merkle_cnt>)


---
### fd\_shred\_is\_chained<!-- {{#callable:fd_shred_is_chained}} -->
[View Source →](<../../../../../src/ballet/shred/fd_shred.h#L342>)

Determines if a shred type is a chained Merkle data or code shred, including resigned variants.
- **Inputs**:
    - `type`: An unsigned long integer representing the shred type to check.
- **Logic and Control Flow**:
    - Checks if `type` is equal to `FD_SHRED_TYPE_MERKLE_DATA_CHAINED`, `FD_SHRED_TYPE_MERKLE_CODE_CHAINED`, `FD_SHRED_TYPE_MERKLE_DATA_CHAINED_RESIGNED`, or `FD_SHRED_TYPE_MERKLE_CODE_CHAINED_RESIGNED`.
    - Performs a bitwise OR operation on the results of these comparisons.
    - Casts the result to an `uchar` and returns it.
- **Output**: Returns an `uchar` value of 1 if the shred type is a chained Merkle data or code shred, including resigned variants, otherwise returns 0.


---
### fd\_shred\_is\_resigned<!-- {{#callable:fd_shred_is_resigned}} -->
[View Source →](<../../../../../src/ballet/shred/fd_shred.h#L352>)

Determines if a shred type is a resigned Merkle data or code shred.
- **Inputs**:
    - `type`: An unsigned long integer representing the shred type to check.
- **Logic and Control Flow**:
    - Checks if `type` is equal to `FD_SHRED_TYPE_MERKLE_DATA_CHAINED_RESIGNED` or `FD_SHRED_TYPE_MERKLE_CODE_CHAINED_RESIGNED`.
    - Returns the result of the logical OR operation between the two comparisons.
- **Output**: Returns a `uchar` value of 1 if the shred type is resigned, otherwise 0.


---
### fd\_shred\_is\_data<!-- {{#callable:fd_shred_is_data}} -->
[View Source →](<../../../../../src/ballet/shred/fd_shred.h#L364>)

Determines if a given shred type is a data shred by checking specific bits in the type value.
- **Inputs**:
    - `type`: An unsigned long integer representing the shred type to be checked.
- **Logic and Control Flow**:
    - Perform a bitwise AND operation between `type` and `0xC0UL` to isolate the relevant bits.
    - Compare the result to `0x80UL` to determine if the shred is a data shred.
    - Return 1 if the comparison is true, indicating a data shred; otherwise, return 0.
- **Output**: Returns an unsigned char (1 or 0) indicating whether the shred type is a data shred.


---
### fd\_shred\_is\_code<!-- {{#callable:fd_shred_is_code}} -->
[View Source →](<../../../../../src/ballet/shred/fd_shred.h#L365>)

Determines if a given shred type is a Merkle code shred.
- **Inputs**:
    - `type`: An unsigned long integer representing the shred type to check.
- **Logic and Control Flow**:
    - Perform a bitwise AND operation between `type` and `0xC0UL`.
    - Check if the result is equal to `0x40UL`.
    - Return 1 if the result is equal to `0x40UL`, otherwise return 0.
- **Output**: Returns 1 if the shred type is a Merkle code shred, otherwise returns 0.


---
### fd\_shred\_swap\_type<!-- {{#callable:fd_shred_swap_type}} -->
[View Source →](<../../../../../src/ballet/shred/fd_shred.h#L371>)

Swaps specific bits in the input `type` to change data shreds to code shreds or vice versa without altering other attributes.
- **Inputs**:
    - `type`: An unsigned long integer representing the shred type, where specific bits indicate the type of shred.
- **Logic and Control Flow**:
    - Extracts bits 4 and 5 from `type` using a bitwise AND with `0x50UL` and shifts them left by one position.
    - Extracts bits 6 and 7 from `type` using a bitwise AND with `0xA0UL` and shifts them right by one position.
    - Combines the results of the two operations using a bitwise OR to produce the final result.
- **Output**: Returns an unsigned char with bits 4 and 5 swapped with bits 6 and 7 from the input `type`.


---
### fd\_shred\_payload\_sz<!-- {{#callable:fd_shred_payload_sz}} -->
[View Source →](<../../../../../src/ballet/shred/fd_shred.h#L379>)

Calculates the payload size of a given shred based on its type and variant.
- **Inputs**:
    - `shred`: A pointer to a `fd_shred_t` structure representing the shred whose payload size is to be calculated.
- **Logic and Control Flow**:
    - Retrieve the shred type using [`fd_shred_type`](<#fd_shred_type>) on the `variant` field of the shred.
    - Check if the shred type is a data type using a bitwise AND with `FD_SHRED_TYPEMASK_DATA`.
    - If the shred is a data type, return the payload size by subtracting `FD_SHRED_DATA_HEADER_SZ` from `shred->data.size`.
    - If the shred is not a data type, calculate the payload size by subtracting the sizes of various headers and optional components (Merkle root and signature) from the total shred size.
    - Use [`fd_shred_sz`](<#fd_shred_sz>) to get the total size of the shred.
    - Subtract `FD_SHRED_CODE_HEADER_SZ`, the size of the Merkle inclusion proof ([`fd_shred_merkle_sz`](<#fd_shred_merkle_sz>)), and conditionally subtract `FD_SHRED_MERKLE_ROOT_SZ` and `FD_SHRED_SIGNATURE_SZ` based on whether the shred is chained or resigned.
- **Output**: The function returns an `ulong` representing the payload size of the shred.
- **Functions Called**:
    - [`fd_shred_type`](<#fd_shred_type>)
    - [`fd_shred_sz`](<#fd_shred_sz>)
    - [`fd_shred_merkle_sz`](<#fd_shred_merkle_sz>)
    - [`fd_shred_is_chained`](<#fd_shred_is_chained>)
    - [`fd_shred_is_resigned`](<#fd_shred_is_resigned>)


---
### fd\_shred\_merkle\_off<!-- {{#callable:fd_shred_merkle_off}} -->
[View Source →](<../../../../../src/ballet/shred/fd_shred.h#L395>)

Calculates the byte offset of the Merkle inclusion proof within a given shred.
- **Inputs**:
    - `shred`: A pointer to a `fd_shred_t` structure representing the shred to analyze.
- **Logic and Control Flow**:
    - Retrieve the shred type using [`fd_shred_type`](<#fd_shred_type>) with the `variant` field of the shred.
    - Calculate the total size of the shred using [`fd_shred_sz`](<#fd_shred_sz>).
    - Determine the size of the Merkle inclusion proof using [`fd_shred_merkle_sz`](<#fd_shred_merkle_sz>).
    - Check if the shred is resigned using [`fd_shred_is_resigned`](<#fd_shred_is_resigned>).
    - Subtract the Merkle inclusion proof size and, if resigned, the signature size from the total shred size to get the offset.
- **Output**: Returns the byte offset as an `ulong` where the Merkle inclusion proof starts within the shred.
- **Functions Called**:
    - [`fd_shred_type`](<#fd_shred_type>)
    - [`fd_shred_sz`](<#fd_shred_sz>)
    - [`fd_shred_merkle_sz`](<#fd_shred_merkle_sz>)
    - [`fd_shred_is_resigned`](<#fd_shred_is_resigned>)


---
### fd\_shred\_merkle\_nodes<!-- {{#callable:fd_shred_merkle_nodes}} -->
[View Source →](<../../../../../src/ballet/shred/fd_shred.h#L406>)

Returns a pointer to the Merkle proof data within a given shred.
- **Inputs**:
    - `shred`: A pointer to a `fd_shred_t` structure representing the shred from which to extract the Merkle proof data.
- **Logic and Control Flow**:
    - Cast the input `shred` to a `uchar` pointer and store it in `ptr`.
    - Calculate the offset of the Merkle proof data within the shred using [`fd_shred_merkle_off`](<#fd_shred_merkle_off>) and add this offset to `ptr`.
    - Return the adjusted pointer cast to a `fd_shred_merkle_t` pointer.
- **Output**: A pointer to the Merkle proof data within the shred, cast as a `fd_shred_merkle_t` constant pointer.
- **Functions Called**:
    - [`fd_shred_merkle_off`](<#fd_shred_merkle_off>)


---
### fd\_shred\_data\_payload<!-- {{#callable:fd_shred_data_payload}} -->
[View Source →](<../../../../../src/ballet/shred/fd_shred.h#L426>)

Returns a pointer to the payload of a data shred by offsetting the shred pointer by the size of the data header.
- **Inputs**:
    - `shred`: A pointer to a `fd_shred_t` structure representing the data shred.
- **Logic and Control Flow**:
    - Calculate the pointer to the payload by adding `FD_SHRED_DATA_HEADER_SZ` to the `shred` pointer.
    - Return the calculated pointer as a `uchar const *`.
- **Output**: A pointer to the payload of the data shred as a `uchar const *`.


---
### fd\_shred\_code\_payload<!-- {{#callable:fd_shred_code_payload}} -->
[View Source →](<../../../../../src/ballet/shred/fd_shred.h#L436>)

Returns a pointer to the payload of a coding shred by offsetting the shred pointer by the size of the coding header.
- **Inputs**:
    - `shred`: A pointer to a `fd_shred_t` structure representing the shred from which to extract the coding payload.
- **Logic and Control Flow**:
    - Calculate the address of the coding payload by adding the constant `FD_SHRED_CODE_HEADER_SZ` to the `shred` pointer.
    - Return the calculated address as a pointer to `uchar`.
- **Output**: A pointer to the coding payload within the shred, represented as `uchar const *`.


---
### fd\_shred\_chain\_off<!-- {{#callable:fd_shred_chain_off}} -->
[View Source →](<../../../../../src/ballet/shred/fd_shred.h#L445>)

Calculates the byte offset from the start of a shred to the start of the chained Merkle root for a given variant.
- **Inputs**:
    - `variant`: An unsigned character representing the shred variant, which determines the type and properties of the shred.
- **Logic and Control Flow**:
    - Determine the shred type by calling [`fd_shred_type`](<#fd_shred_type>) with `variant` as the argument.
    - Use `fd_ulong_if` to select either `FD_SHRED_MAX_SZ` or `FD_SHRED_MIN_SZ` based on whether the type is a code shred (`type & FD_SHRED_TYPEMASK_CODE`).
    - Subtract `FD_SHRED_MERKLE_ROOT_SZ` from the result.
    - Subtract the size of the Merkle inclusion proof, obtained by calling [`fd_shred_merkle_sz`](<#fd_shred_merkle_sz>) with `variant`, from the result.
    - Subtract `FD_SHRED_SIGNATURE_SZ` if the shred is resigned, determined by calling [`fd_shred_is_resigned`](<#fd_shred_is_resigned>) with `type`.
- **Output**: Returns an unsigned long integer representing the calculated offset in bytes.
- **Functions Called**:
    - [`fd_shred_type`](<#fd_shred_type>)
    - [`fd_shred_merkle_sz`](<#fd_shred_merkle_sz>)
    - [`fd_shred_is_resigned`](<#fd_shred_is_resigned>)


---
### fd\_shred\_retransmitter\_sig\_off<!-- {{#callable:fd_shred_retransmitter_sig_off}} -->
[View Source →](<../../../../../src/ballet/shred/fd_shred.h#L458>)

Calculates the byte offset to the retransmitter signature in a resigned shred.
- **Inputs**:
    - `shred`: A pointer to a `fd_shred_t` structure representing the shred.
- **Logic and Control Flow**:
    - Calls [`fd_shred_sz`](<#fd_shred_sz>) to get the total size of the shred.
    - Subtracts `FD_SHRED_SIGNATURE_SZ` from the total size to find the offset of the retransmitter signature.
- **Output**: Returns the offset as an `ulong` from the start of the shred to the retransmitter signature.
- **Functions Called**:
    - [`fd_shred_sz`](<#fd_shred_sz>)


# Function Declarations (Public API)

---
### fd\_shred\_parse<!-- {{#callable_declaration:fd_shred_parse}} -->
[View Source →](<../../../../../src/ballet/shred/fd_shred.h#L267>)

Parses and validates a shred from a byte buffer.
- **Description**: Use this function to parse and validate a shred from a given byte buffer. The buffer must contain at least `FD_SHRED_MIN_SZ` bytes. The function checks the shred's type and ensures it adheres to the expected format and constraints. If the shred is valid, the function returns a pointer to the shred structure; otherwise, it returns `NULL`. This function is useful for processing shreds received over a network or from storage, ensuring they are correctly formatted before further processing.
- **Inputs**:
    - `buf`: A pointer to the byte buffer containing the shred data. The buffer must not be null and should contain at least `FD_SHRED_MIN_SZ` bytes. The caller retains ownership of the buffer.
    - `sz`: The size of the buffer in bytes. It must be at least `FD_SHRED_MIN_SZ` to ensure the buffer contains a complete shred.
- **Output**: Returns a pointer to the parsed `fd_shred_t` structure if the shred is valid, or `NULL` if the shred is malformed or violates any constraints.
- **See Also**: [`fd_shred_parse`](<fd_shred.c.md#fd_shred_parse>)  (Implementation)


---
### fd\_shred\_merkle\_root<!-- {{#callable_declaration:fd_shred_merkle_root}} -->
[View Source →](<../../../../../src/ballet/shred/fd_shred.h#L418>)

Reconstructs the Merkle root from a shred.
- **Description**: Use this function to reconstruct the Merkle root from a given shred, assuming the shred is a Merkle variant. This function requires a valid `fd_shred_t` structure and a memory buffer for the binary Merkle tree. The function populates the Merkle root in the provided output parameter. It returns 1 on success and 0 on failure. The output value is undefined if the function returns failure. Ensure the shred is a Merkle variant before calling this function.
- **Inputs**:
    - `shred`: A pointer to a `fd_shred_t` structure representing the shred. It must be a valid Merkle variant shred. The caller retains ownership and must ensure it is not null.
    - `bmtree_mem`: A pointer to a memory buffer used for the binary Merkle tree. The caller retains ownership and must ensure it is not null.
    - `root_out`: A pointer to an `fd_bmtree_node_t` where the function will store the reconstructed Merkle root. The caller retains ownership and must ensure it is not null.
- **Output**: Returns 1 on success and 0 on failure. The output value in `root_out` is undefined if the function returns 0.
- **See Also**: [`fd_shred_merkle_root`](<fd_shred.c.md#fd_shred_merkle_root>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)