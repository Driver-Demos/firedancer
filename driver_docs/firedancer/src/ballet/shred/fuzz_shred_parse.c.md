<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Fuzz testing for parsing and validating different types of shreds with boundary checks.

# Purpose
The code is a fuzz testing module designed for use with LLVM's libFuzzer. It initializes a fuzzing environment and tests the parsing and validation of data structures referred to as "shreds." The [`LLVMFuzzerInitialize`](<#llvmfuzzerinitialize>) function sets up the environment by configuring logging and registering cleanup functions. The [`LLVMFuzzerTestOneInput`](<#llvmfuzzertestoneinput>) function is the core of the fuzzing process, where it receives input data, attempts to parse it into a `fd_shred_t` structure, and performs various checks to ensure the integrity and validity of the parsed data.

The module includes several assertions and boundary checks to verify that the parsed shreds conform to expected formats and sizes. It handles different types of shreds, such as legacy code, legacy data, and various Merkle-based shreds, including chained and resigned variants. Each type undergoes specific validation checks, such as payload size verification and Merkle node boundary checks. The code uses macros to simplify boundary checking logic and ensures that all possible shred types are covered during fuzz testing. If an unknown shred variant is encountered, the program will abort, indicating an unexpected input scenario.
# Imports and Dependencies

---
- `assert.h`
- `stdio.h`
- `stdlib.h`
- `../../util/sanitize/fd_fuzz.h`
- `../../util/fd_util.h`
- `fd_shred.h`


# Functions

---
### LLVMFuzzerInitialize<!-- {{#callable:LLVMFuzzerInitialize}} -->
[View Source →](<../../../../../src/ballet/shred/fuzz_shred_parse.c#L13>)

Initializes the fuzzer environment by setting environment variables, booting the system, registering an exit function, and setting the log level.
- **Inputs**:
    - `argc`: A pointer to the argument count, typically passed to the main function.
    - `argv`: A pointer to the argument vector, typically passed to the main function.
- **Logic and Control Flow**:
    - Set the environment variable `FD_LOG_BACKTRACE` to `0` to disable backtraces in logs.
    - Call `fd_boot` with `argc` and `argv` to initialize the system.
    - Register `fd_halt` to be called on program exit using `atexit`.
    - Set the core log level to `3` using `fd_log_level_core_set`, which will cause the program to crash on warning logs.
    - Return `0` to indicate successful initialization.
- **Output**: Returns `0` to indicate successful initialization.


---
### LLVMFuzzerTestOneInput<!-- {{#callable:LLVMFuzzerTestOneInput}} -->
[View Source →](<../../../../../src/ballet/shred/fuzz_shred_parse.c#L24>)

Processes input data to parse and validate a `fd_shred_t` structure based on its type and variant, performing bounds checks and assertions.
- **Inputs**:
    - `data`: A pointer to the input data to be parsed.
    - `size`: The size of the input data in bytes.
- **Logic and Control Flow**:
    - Parse the input data using [`fd_shred_parse`](<fd_shred.c.md#fd_shred_parse>) to obtain a `fd_shred_t` structure.
    - If parsing fails (returns `NULL`), return 0 immediately.
    - Define macros `BOUNDS_CHECK` and `BOUNDS_CHECK_OFF` for performing bounds checks on pointers and offsets.
    - Retrieve the `variant` and `type` from the parsed `shred`.
    - Perform assertions to ensure the sizes of the shred, header, payload, and Merkle nodes do not exceed the input size.
    - Use a `switch` statement to handle different `type` cases of the shred.
    - For each case, perform specific assertions and bounds checks based on the shred type and variant.
    - If the type is unknown, call `abort()` to terminate the program.
    - Undefine the macros `BOUNDS_CHECK` and `BOUNDS_CHECK_OFF` after use.
    - Return 0 at the end of the function.
- **Output**: Returns 0 after processing the input data, regardless of the outcome.
- **Functions Called**:
    - [`fd_shred_parse`](<fd_shred.c.md#fd_shred_parse>)
    - [`fd_shred_type`](<fd_shred.h.md#fd_shred_type>)
    - [`fd_shred_sz`](<fd_shred.h.md#fd_shred_sz>)
    - [`fd_shred_header_sz`](<fd_shred.h.md#fd_shred_header_sz>)
    - [`fd_shred_payload_sz`](<fd_shred.h.md#fd_shred_payload_sz>)
    - [`fd_shred_merkle_sz`](<fd_shred.h.md#fd_shred_merkle_sz>)
    - [`fd_shred_is_code`](<fd_shred.h.md#fd_shred_is_code>)
    - [`fd_shred_is_data`](<fd_shred.h.md#fd_shred_is_data>)
    - [`fd_shred_merkle_cnt`](<fd_shred.h.md#fd_shred_merkle_cnt>)
    - [`fd_shred_is_chained`](<fd_shred.h.md#fd_shred_is_chained>)
    - [`fd_shred_is_resigned`](<fd_shred.h.md#fd_shred_is_resigned>)
    - [`fd_shred_code_payload`](<fd_shred.h.md#fd_shred_code_payload>)
    - [`fd_shred_data_payload`](<fd_shred.h.md#fd_shred_data_payload>)
    - [`fd_shred_merkle_nodes`](<fd_shred.h.md#fd_shred_merkle_nodes>)
    - [`fd_shred_chain_off`](<fd_shred.h.md#fd_shred_chain_off>)
    - [`fd_shred_retransmitter_sig_off`](<fd_shred.h.md#fd_shred_retransmitter_sig_off>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)