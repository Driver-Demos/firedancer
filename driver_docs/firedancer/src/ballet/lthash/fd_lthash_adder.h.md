<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Optimized streaming LtHash adder using SIMD parallelism for high-throughput BLAKE3 hashing.

# Purpose
The `fd_lthash_adder.h` file is a C header file that defines an optimized streaming LtHash adder. It uses SIMD parallelism to enhance the throughput of LtHash updates, specifically through multi-block and multi-message BLAKE3 hashing. The file includes function prototypes and data structures necessary for initializing, using, and destroying an LtHash adder. The primary structure defined is `fd_lthash_adder_t`, which is used to manage batches of data for hashing. The file also includes functions such as `fd_lthash_adder_new`, [`fd_lthash_adder_delete`](<#fd_lthash_adder_delete>), [`fd_lthash_adder_push`](<#fd_lthash_adder_push>), and [`fd_lthash_adder_flush`](<#fd_lthash_adder_flush>), which handle the lifecycle and operations of the LtHash adder.

The header file provides a specialized function, [`fd_lthash_adder_push_solana_account`](<#fd_lthash_adder_push_solana_account>), which is tailored for processing Solana account inputs. This function wraps the [`fd_lthash_adder_push`](<#fd_lthash_adder_push>) function to handle specific data structures associated with Solana accounts, such as public keys, data, lamports, and ownership information. The file includes necessary headers for BLAKE3 and LtHash operations and defines constants for alignment and parallelism. The code is designed to be included in other C files, providing a public API for efficient LtHash operations.
# Imports and Dependencies

---
- `../blake3/fd_blake3.h`
- `../lthash/fd_lthash.h`


# Data Structures

---
### fd\_lthash\_adder
- **Type**: ``struct``
- **Members**:
    - ``batch_cnt``: Stores the count of batches currently in the adder.
    - ``batch_data``: Holds the data for each batch, aligned to 64 bytes.
    - ``batch_ptrs``: Contains pointers to the start of each batch, aligned to 64 bytes.
    - ``batch_sz``: Stores the size of each batch.
- **Description**: The `fd_lthash_adder` structure is an optimized streaming LtHash adder that uses SIMD parallelism to accelerate LtHash update throughput. It maintains a count of batches (`batch_cnt`), and, if parallelism is enabled, it stores batch data (`batch_data`), pointers to batch data (`batch_ptrs`), and the size of each batch (`batch_sz`). The structure is aligned to 64 bytes to optimize memory access and performance.


---
### fd\_lthash\_adder\_t
- **Type**: ``struct``
- **Members**:
    - ``batch_cnt``: Stores the count of batches currently in the adder.
    - ``batch_data``: Holds the data for each batch, aligned to 64 bytes.
    - ``batch_ptrs``: Contains pointers to the data for each batch, aligned to 64 bytes.
    - ``batch_sz``: Stores the size of each batch.
- **Description**: The `fd_lthash_adder_t` structure is an optimized streaming LtHash adder that uses SIMD parallelism to accelerate LtHash update throughput. It maintains a count of batches, data for each batch, pointers to the data, and the size of each batch. This structure is designed to handle multiple blocks and messages efficiently, leveraging BLAKE3 hashing to achieve high update rates.


# Functions

---
### fd\_lthash\_adder\_push<!-- {{#callable:fd_lthash_adder_push}} -->
[View Source →](<../../../../../src/ballet/lthash/fd_lthash_adder.h#L61>)

Enqueues input data for hashing and updates the hash sum if necessary.
- **Inputs**:
    - `adder`: A pointer to an `fd_lthash_adder_t` structure that manages the batching of input data.
    - `sum`: A pointer to an `fd_lthash_value_t` structure where the hash sum is stored.
    - `input`: A pointer to the input data to be hashed.
    - `input_sz`: The size of the input data in bytes.
- **Logic and Control Flow**:
    - Define a constant `batch_threshold` with a value of 512.
    - Declare a local `fd_lthash_value_t` array `value` with one element.
    - Check if `input_sz` is greater than `batch_threshold`.
    - If true, initialize a `fd_blake3_t` structure, append the input data to it, finalize the hash into `value->bytes`, and add the result to `sum`.
    - If false, increment `adder->batch_cnt` and copy the input data to the appropriate batch slot.
    - Store the size of the input data in `adder->batch_sz` at the current batch index.
    - Check if the batch index plus one is greater than or equal to `FD_BLAKE3_PARA_MAX`.
    - If true, process the batch using either `fd_blake3_lthash_batch16` or `fd_blake3_lthash_batch8` depending on available AVX support, reset `adder->batch_cnt`, and add the result to `sum`.
- **Output**: Updates the `sum` with the hash of the input data if the batch is processed or if the input size exceeds the threshold.


---
### fd\_lthash\_adder\_flush<!-- {{#callable:fd_lthash_adder_flush}} -->
[View Source →](<../../../../../src/ballet/lthash/fd_lthash_adder.h#L96>)

Commits all enqueued hash additions to the provided sum and resets the batch count.
- **Inputs**:
    - `adder`: A pointer to an `fd_lthash_adder_t` structure that contains the batch of data to be processed.
    - `sum`: A pointer to an `fd_lthash_value_t` structure where the final hash sum will be stored.
- **Logic and Control Flow**:
    - Retrieve the current batch count from the `adder` structure.
    - Iterate over each batch entry up to the batch count.
    - For each entry, initialize a BLAKE3 hash context.
    - Append the data from the current batch entry to the BLAKE3 hash context.
    - Finalize the BLAKE3 hash to produce a 2048-bit hash value.
    - Add the resulting hash value to the `sum`.
    - Reset the batch count in the `adder` structure to zero.
- **Output**: There is no return value, but the `sum` is updated with the hash of all enqueued data.


---
### fd\_lthash\_adder\_push\_solana\_account<!-- {{#callable:fd_lthash_adder_push_solana_account}} -->
[View Source →](<../../../../../src/ballet/lthash/fd_lthash_adder.h#L114>)

Processes Solana account data for hashing and updates the LtHash sum accordingly.
- **Inputs**:
    - `adder`: A pointer to an `fd_lthash_adder_t` structure that manages the batching and hashing process.
    - `sum`: A pointer to an `fd_lthash_value_t` structure where the hash sum is stored.
    - `pubkey`: A pointer to the public key associated with the Solana account.
    - `data`: A pointer to the account data to be hashed.
    - `data_sz`: The size of the account data in bytes.
    - `lamports`: The number of lamports (Solana's smallest currency unit) associated with the account.
    - `executable`: A flag indicating if the account is executable (non-zero if true, zero if false).
    - `owner`: A pointer to the owner of the account.
- **Logic and Control Flow**:
    - Initialize a local `fd_lthash_value_t` array to store hash values.
    - Check if `data_sz` exceeds the `batch_threshold` minus a static size or if `FD_BLAKE3_PARA_MAX` is zero.
    - If true, initialize a `fd_blake3_t` structure, append `lamports`, `data`, and a footer containing `executable`, `owner`, and `pubkey` to the hash, finalize the hash, and add it to `sum`.
    - If false, increment the batch count, store `lamports`, `data`, `executable`, `owner`, and `pubkey` in a batch slot, and update the batch size.
    - If the batch count reaches `FD_BLAKE3_PARA_MAX`, process the batch using SIMD parallelism, reset the batch count, and add the result to `sum`.
- **Output**: Updates the `sum` with the hash of the processed Solana account data.


# Function Declarations (Public API)

---
### fd\_lthash\_adder\_delete<!-- {{#callable_declaration:fd_lthash_adder_delete}} -->
[View Source →](<../../../../../src/ballet/lthash/fd_lthash_adder.h#L55>)

Destroys an `fd_lthash_adder_t` instance.
- **Description**: Use this function to clean up and release resources associated with an `fd_lthash_adder_t` instance after it is no longer needed. This function should be called after all operations with the adder are complete, and it is safe to discard the adder. Ensure that the adder is properly initialized before calling this function. The function does not perform any operations on the adder and always returns `NULL`.
- **Inputs**:
    - `adder`: A pointer to an `fd_lthash_adder_t` instance. The adder must be initialized before calling this function. The function does not modify the adder or check its state.
- **Output**: Always returns `NULL`. The function does not modify the input or produce any other output.
- **See Also**: [`fd_lthash_adder_delete`](<fd_lthash_adder.c.md#fd_lthash_adder_delete>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)