<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements AVX-512 optimized functions for refilling ChaCha RNG buffers.

# Purpose
The code is a C implementation of a random number generator using the ChaCha algorithm, optimized for AVX-512 SIMD instructions. It defines functions to refill a buffer with random numbers generated by the ChaCha algorithm. The primary function, [`fd_chacha_rng_refill_avx512`](<#fd_chacha_rng_refill_avx512>), is responsible for generating random numbers and filling a buffer when it is empty. It uses AVX-512 instructions to perform operations on wide vectors, which enhances performance by processing multiple data points in parallel. The function ensures that the buffer is synchronized before refilling and updates the buffer and its descriptor after generating the random numbers.

The code includes two public functions, [`fd_chacha8_rng_refill_avx512`](<#fd_chacha8_rng_refill_avx512>) and [`fd_chacha20_rng_refill_avx512`](<#fd_chacha20_rng_refill_avx512>), which call the main refill function with different parameters to generate random numbers using 8 and 20 rounds of the ChaCha algorithm, respectively. These functions provide an interface for external code to use the random number generator with varying levels of security and performance, depending on the number of rounds specified. The code also defines several helper macros and inline functions to facilitate the bitwise operations and rotations required by the ChaCha algorithm.
# Imports and Dependencies

---
- `fd_chacha_rng.h`
- `../../util/simd/fd_avx512.h`
- `assert.h`


# Functions

---
### wwu\_rol8<!-- {{#callable:wwu_rol8}} -->
[View Source →](<../../../../../src/ballet/chacha/fd_chacha_rng_avx512.c#L9>)

Performs an 8-byte rotation on a 512-bit vector using a predefined shuffle mask.
- **Inputs**:
    - `x`: A 512-bit vector of type `wwu_t` to be rotated.
- **Logic and Control Flow**:
    - Define a constant shuffle mask `mask` using `wwb_bcast_hex` with a specific byte order.
    - Use `_mm512_shuffle_epi8` to shuffle the bytes of `x` according to `mask`.
- **Output**: A 512-bit vector of type `wwu_t` with its bytes rotated according to the shuffle mask.


---
### fd\_chacha\_rng\_refill\_avx512<!-- {{#callable:fd_chacha_rng_refill_avx512}} -->
[View Source →](<../../../../../src/ballet/chacha/fd_chacha_rng_avx512.c#L16>)

Refills the ChaCha random number generator buffer using AVX-512 instructions.
- **Inputs**:
    - `rng`: A pointer to the `fd_chacha_rng_t` structure, which contains the state of the random number generator.
    - `rnd2_cnt`: The number of double rounds to perform, which determines how many times the ChaCha quarter round function is applied.
- **Logic and Control Flow**:
    - Checks if the buffer is empty by comparing `rng->buf_off` and `rng->buf_fill`; logs a critical error if they are not equal.
    - Initializes constants `iv0`, `iv1`, `iv2`, `iv3`, and `zero` for the ChaCha algorithm.
    - Loads and broadcasts the key from `rng->key` into AVX-512 registers `key_lo` and `key_hi`, then shuffles them into `k0` to `k7`.
    - Calculates the block index `idx` and creates a vector `idxs` for indexing.
    - Initializes state variables `c0` to `cF` with constants, key parts, and index values.
    - Performs `rnd2_cnt` iterations of the ChaCha quarter round function using the `QUARTER_ROUND` macro.
    - Finalizes the state by adding the initial constants and key parts back to the state variables.
    - Transposes the 16x16 matrix of state variables to prepare for output.
    - Stores the transposed state into the `rng->buf` as output.
    - Updates the `rng->buf_fill` to reflect the new buffer fill level.
- **Output**: The function updates the `rng->buf` with new random data and increments `rng->buf_fill` by `16*FD_CHACHA_BLOCK_SZ`.


---
### fd\_chacha8\_rng\_refill\_avx512<!-- {{#callable:fd_chacha8_rng_refill_avx512}} -->
[View Source →](<../../../../../src/ballet/chacha/fd_chacha_rng_avx512.c#L126>)

Calls [`fd_chacha_rng_refill_avx512`](<#fd_chacha_rng_refill_avx512>) with a fixed round count of 4 to refill the random number generator buffer.
- **Inputs**:
    - ``rng``: A pointer to an `fd_chacha_rng_t` structure representing the random number generator state.
- **Logic and Control Flow**:
    - Calls the [`fd_chacha_rng_refill_avx512`](<#fd_chacha_rng_refill_avx512>) function with the `rng` parameter and a fixed `rnd2_cnt` value of 4.
- **Output**: No direct output; modifies the state of the `rng` structure by refilling its buffer.
- **Functions Called**:
    - [`fd_chacha_rng_refill_avx512`](<#fd_chacha_rng_refill_avx512>)


---
### fd\_chacha20\_rng\_refill\_avx512<!-- {{#callable:fd_chacha20_rng_refill_avx512}} -->
[View Source →](<../../../../../src/ballet/chacha/fd_chacha_rng_avx512.c#L131>)

Calls [`fd_chacha_rng_refill_avx512`](<#fd_chacha_rng_refill_avx512>) with a fixed round count of 10 to refill the random number generator buffer.
- **Inputs**:
    - ``rng``: A pointer to an `fd_chacha_rng_t` structure representing the random number generator state.
- **Logic and Control Flow**:
    - Calls the [`fd_chacha_rng_refill_avx512`](<#fd_chacha_rng_refill_avx512>) function with the `rng` pointer and a round count of 10.
- **Output**: No return value; the function operates on the `rng` structure to refill its buffer.
- **Functions Called**:
    - [`fd_chacha_rng_refill_avx512`](<#fd_chacha_rng_refill_avx512>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)