<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements AVX-optimized functions for refilling ChaCha RNG buffers in the Firedancer codebase.

# Purpose
The code is a C implementation of a random number generator using the ChaCha algorithm, specifically optimized for AVX (Advanced Vector Extensions) instructions. It defines functions to refill a random number generator buffer using the ChaCha8 and ChaCha20 variants. The main function, [`fd_chacha_rng_refill_avx`](<#fd_chacha_rng_refill_avx>), performs the core operations of the ChaCha algorithm, including key setup, block index derivation, and the execution of the ChaCha quarter-round function. The code uses AVX intrinsics to perform operations on 256-bit wide vectors, which allows for parallel processing of multiple data elements, enhancing performance.

The file includes several macros and inline functions to facilitate bitwise rotations and data shuffling, which are essential operations in the ChaCha algorithm. The [`fd_chacha8_rng_refill_avx`](<#fd_chacha8_rng_refill_avx>) and [`fd_chacha20_rng_refill_avx`](<#fd_chacha20_rng_refill_avx>) functions are public interfaces that call the main refill function with different round counts, corresponding to the ChaCha8 and ChaCha20 algorithms. The code is intended to be part of a larger library, as indicated by the inclusion of headers and the use of specific data types like `fd_chacha_rng_t`. The implementation focuses on efficiently updating a ring buffer with new random data generated by the ChaCha algorithm.
# Imports and Dependencies

---
- `fd_chacha_rng.h`
- `../../util/simd/fd_avx.h`
- `assert.h`


# Functions

---
### wu\_rol8<!-- {{#callable:wu_rol8}} -->
[View Source →](<../../../../../src/ballet/chacha/fd_chacha_rng_avx.c#L9>)

Performs an 8-byte rotation on a 256-bit vector using a predefined shuffle mask.
- **Inputs**:
    - ``x``: A 256-bit vector of type `wu_t` to be rotated.
- **Logic and Control Flow**:
    - Defines a constant shuffle mask `mask` using `wb_bcast_hex` to specify the byte order for rotation.
    - Applies the shuffle operation `_mm256_shuffle_epi8` on the input vector `x` using the `mask` to achieve the rotation.
- **Output**: Returns a 256-bit vector of type `wu_t` with the bytes rotated according to the shuffle mask.


---
### fd\_chacha\_rng\_refill\_avx<!-- {{#callable:fd_chacha_rng_refill_avx}} -->
[View Source →](<../../../../../src/ballet/chacha/fd_chacha_rng_avx.c#L16>)

Refills the ChaCha random number generator buffer using AVX instructions.
- **Inputs**:
    - `rng`: A pointer to the `fd_chacha_rng_t` structure representing the random number generator state.
    - `rnd2_cnt`: The number of double rounds to perform, determining the amount of random data to generate.
- **Logic and Control Flow**:
    - Initialize constants and load the key from the `rng` structure.
    - Unpack the key into separate variables for processing.
    - Calculate the block index based on the current buffer fill level.
    - Initialize state variables with constants, key parts, and indices.
    - Perform the ChaCha quarter-round operations `rnd2_cnt` times using a loop.
    - Add the initial state values to the final state values to complete the ChaCha block processing.
    - Transpose the state matrix to prepare the output vector.
    - Store the generated random data into the `rng` buffer at the appropriate position.
    - Update the buffer fill level in the `rng` structure.
- **Output**: No direct output; the function updates the `rng` buffer with new random data.


---
### fd\_chacha8\_rng\_refill\_avx<!-- {{#callable:fd_chacha8_rng_refill_avx}} -->
[View Source →](<../../../../../src/ballet/chacha/fd_chacha_rng_avx.c#L121>)

Calls [`fd_chacha_rng_refill_avx`](<#fd_chacha_rng_refill_avx>) with a fixed round count of 4 to refill the ChaCha8 random number generator buffer.
- **Inputs**:
    - ``rng``: A pointer to an `fd_chacha_rng_t` structure representing the ChaCha random number generator state.
- **Logic and Control Flow**:
    - Calls the [`fd_chacha_rng_refill_avx`](<#fd_chacha_rng_refill_avx>) function with the `rng` parameter and a fixed `rnd2_cnt` value of 4.
    - The [`fd_chacha_rng_refill_avx`](<#fd_chacha_rng_refill_avx>) function processes the ChaCha8 algorithm to refill the random number generator buffer.
- **Output**: No direct output; modifies the state of the `rng` structure by refilling its buffer.
- **Functions Called**:
    - [`fd_chacha_rng_refill_avx`](<#fd_chacha_rng_refill_avx>)


---
### fd\_chacha20\_rng\_refill\_avx<!-- {{#callable:fd_chacha20_rng_refill_avx}} -->
[View Source →](<../../../../../src/ballet/chacha/fd_chacha_rng_avx.c#L126>)

Refills the ChaCha20 random number generator buffer using AVX instructions with a specified number of rounds.
- **Inputs**:
    - ``rng``: A pointer to an `fd_chacha_rng_t` structure representing the ChaCha20 random number generator state.
- **Logic and Control Flow**:
    - Calls the [`fd_chacha_rng_refill_avx`](<#fd_chacha_rng_refill_avx>) function with the `rng` pointer and a fixed round count of 10.
    - The [`fd_chacha_rng_refill_avx`](<#fd_chacha_rng_refill_avx>) function performs the ChaCha20 block function using AVX instructions to generate random data.
    - Initializes constants and key from the `rng` structure.
    - Calculates the block index based on the current buffer fill level.
    - Executes the ChaCha20 quarter-round operations for the specified number of rounds (10 in this case).
    - Finalizes the state by adding the initial constants and key back to the state variables.
    - Transposes the state matrix to prepare the output vector.
    - Updates the ring buffer with the newly generated random data.
    - Increments the buffer fill level by the size of the generated data.
- **Output**: The function does not return a value; it updates the `rng` structure's buffer with new random data.
- **Functions Called**:
    - [`fd_chacha_rng_refill_avx`](<#fd_chacha_rng_refill_avx>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)