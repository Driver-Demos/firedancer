<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

APIs for a ChaCha-based random number generator used in the Solana protocol, with different modes and initialization functions.

# Purpose
The code defines a C header file for a ChaCha-based random number generator (RNG) used in the Solana protocol. It provides an API for generating random numbers using the ChaCha20 stream cipher. The file includes definitions for managing memory alignment and footprint for the RNG, as well as functions to initialize, join, leave, and delete RNG objects. The RNG is designed to be used in specific cases where the `fd_rng` is not suitable, and it supports different modes for generating unbiased integers, such as `FD_CHACHA_RNG_MODE_MOD` and `FD_CHACHA_RNG_MODE_SHIFT`.

The file also defines a private structure, `fd_chacha_rng_private`, which holds the ChaCha20 encryption key and a buffer for pre-generated random data. The buffer is managed with offsets to track consumed and produced bytes. The code includes functions for refilling the buffer using different instruction sets (AVX512, AVX, or sequential) and provides inline functions to read 64-bit integers from the RNG stream. Additionally, it includes a function to generate uniform random numbers within a specified range using a rejection-sampling approach. The header file is intended to be included in other C source files that require ChaCha-based random number generation functionality.
# Imports and Dependencies

---
- `fd_chacha.h`
- `../../util/bits/fd_uwide.h`


# Data Structures

---
### fd\_chacha\_rng\_private
- **Type**: ``struct fd_chacha_rng_private``
- **Members**:
    - ``key``: An array of 32 unsigned characters used as the ChaCha20 encryption key.
    - ``buf``: A ring buffer of pre-generated ChaCha20 random number generator data.
    - ``buf_off``: A counter for the total number of bytes consumed from the buffer.
    - ``buf_fill``: A counter for the total number of bytes produced, always aligned by `FD_CHACHA_BLOCK_SZ`.
    - ``mode``: An integer indicating the mode of operation for the random number generator.
- **Description**: The `fd_chacha_rng_private` structure is used to manage the state of a ChaCha20-based random number generator. It includes a key for encryption, a buffer for storing pre-generated random data, and counters to track the consumption and production of data within the buffer. The `mode` field specifies the operational mode of the generator, which affects how random numbers are generated and consumed.


---
### fd\_chacha\_rng\_t
- **Type**: ``struct``
- **Members**:
    - ``key``: ChaCha20 encryption key stored as an array of 32 unsigned characters.
    - ``buf``: Ring buffer for pre-generated ChaCha20 RNG data, aligned to the block size.
    - ``buf_off``: Total number of bytes consumed from the buffer.
    - ``buf_fill``: Total number of bytes produced in the buffer, aligned by the block size.
    - ``mode``: Mode of operation for the RNG, determining the method of mapping a ulong to an unbiased integer.
- **Description**: Defines a private structure for a ChaCha-based random number generator (RNG) used in the Solana protocol. It includes a key for encryption, a buffer for storing pre-generated random data, and fields to track the buffer's consumption and production. The `mode` field specifies the method for generating random numbers, either using modulus or shift operations. This structure is aligned to 32 bytes for performance optimization.


# Functions

---
### fd\_chacha\_rng\_avail<!-- {{#callable:fd_chacha_rng_avail}} -->
[View Source →](<../../../../../src/ballet/chacha/fd_chacha_rng.h#L153>)

Calculates the number of available bytes in the ChaCha RNG buffer.
- **Inputs**:
    - `rng`: A pointer to a constant `fd_chacha_rng_t` structure representing the ChaCha RNG state.
- **Logic and Control Flow**:
    - Subtracts `rng->buf_off` from `rng->buf_fill` to determine the number of available bytes in the buffer.
- **Output**: Returns an `ulong` representing the number of available bytes in the buffer.


---
### fd\_chacha8\_rng\_ulong<!-- {{#callable:fd_chacha8_rng_ulong}} -->
[View Source →](<../../../../../src/ballet/chacha/fd_chacha_rng.h#L161>)

Generates a 64-bit unsigned long integer from a ChaCha8-based random number generator.
- **Inputs**:
    - `rng`: A pointer to an `fd_chacha_rng_t` structure, which holds the state of the ChaCha8 RNG.
- **Logic and Control Flow**:
    - Check if the available bytes in the RNG buffer are less than the size of an unsigned long integer using [`fd_chacha_rng_avail`](<#fd_chacha_rng_avail>) function.
    - If the buffer has insufficient bytes, call `fd_chacha8_rng_private_refill` to refill the buffer.
    - Load a 64-bit unsigned long integer from the buffer at the position `rng->buf_off % FD_CHACHA_RNG_BUFSZ` using `FD_LOAD`.
    - Increment the buffer offset `rng->buf_off` by 8 bytes.
- **Output**: Returns a 64-bit unsigned long integer generated from the RNG buffer.
- **Functions Called**:
    - [`fd_chacha_rng_avail`](<#fd_chacha_rng_avail>)


---
### fd\_chacha20\_rng\_ulong<!-- {{#callable:fd_chacha20_rng_ulong}} -->
[View Source →](<../../../../../src/ballet/chacha/fd_chacha_rng.h#L170>)

Generates a 64-bit unsigned long integer from a ChaCha20-based random number generator.
- **Inputs**:
    - `rng`: A pointer to an `fd_chacha_rng_t` structure, which holds the state of the ChaCha20 random number generator.
- **Logic and Control Flow**:
    - Check if the available bytes in the buffer ([`fd_chacha_rng_avail`](<#fd_chacha_rng_avail>)) are less than the size of an `ulong` (8 bytes).
    - If the buffer has insufficient bytes, call `fd_chacha20_rng_private_refill` to refill the buffer.
    - Load an `ulong` value from the buffer at the position `rng->buf_off % FD_CHACHA_RNG_BUFSZ`.
    - Increment `rng->buf_off` by 8 to account for the consumed bytes.
    - Return the loaded `ulong` value.
- **Output**: Returns a 64-bit unsigned long integer (`ulong`) from the random number generator.
- **Functions Called**:
    - [`fd_chacha_rng_avail`](<#fd_chacha_rng_avail>)


---
### fd\_chacha20\_rng\_ulong\_roll<!-- {{#callable:fd_chacha20_rng_ulong_roll}} -->
[View Source →](<../../../../../src/ballet/chacha/fd_chacha_rng.h#L188>)

Generates a uniformly distributed random number in the range [0, n) using rejection sampling.
- **Inputs**:
    - `rng`: A pointer to an `fd_chacha_rng_t` structure, which represents the ChaCha20 random number generator state.
    - `n`: An unsigned long integer representing the upper bound of the range (exclusive) for the random number.
- **Logic and Control Flow**:
    - Calculate the `zone` value based on the mode of the RNG (`FD_CHACHA_RNG_MODE_MOD` or `FD_CHACHA_RNG_MODE_SHIFT`).
    - Enter an infinite loop to generate random numbers until a valid one is found.
    - Generate a random number `v` using [`fd_chacha20_rng_ulong`](<#fd_chacha20_rng_ulong>).
    - If `FD_HAS_INT128` is defined, multiply `v` by `n` using 128-bit arithmetic to get `hi` and `lo`. Otherwise, use `fd_uwide_mul` to perform the multiplication.
    - If `FD_CHACHA_RNG_DEBUG` is enabled, log the attempt details for debugging purposes.
    - Check if `lo` is less than or equal to `zone`. If true, return `hi` as the result.
- **Output**: Returns a uniformly distributed random unsigned long integer in the range [0, n).
- **Functions Called**:
    - [`fd_chacha20_rng_ulong`](<#fd_chacha20_rng_ulong>)


# Function Declarations (Public API)

---
### fd\_chacha\_rng\_align<!-- {{#callable_declaration:fd_chacha_rng_align}} -->
[View Source →](<../../../../../src/ballet/chacha/fd_chacha_rng.h#L55>)

Returns the alignment requirement for a ChaCha-based RNG.
- **Description**: Use this function to determine the memory alignment requirement for a ChaCha-based random number generator (RNG). This is necessary when allocating memory for an RNG to ensure proper alignment, which can affect performance and correctness. This function does not require any prior initialization and can be called at any time.
- **Inputs**: None
- **Output**: The function returns an unsigned long integer representing the alignment requirement in bytes.
- **See Also**: [`fd_chacha_rng_align`](<fd_chacha_rng.c.md#fd_chacha_rng_align>)  (Implementation)


---
### fd\_chacha\_rng\_footprint<!-- {{#callable_declaration:fd_chacha_rng_footprint}} -->
[View Source →](<../../../../../src/ballet/chacha/fd_chacha_rng.h#L91>)

Returns the memory footprint required for a ChaCha20-based RNG.
- **Description**: Use this function to determine the size of memory needed to store a ChaCha20-based random number generator (RNG) object. This is useful when allocating memory for the RNG. Ensure that the memory region allocated is at least this size to avoid memory-related issues.
- **Inputs**: None
- **Output**: The function returns an unsigned long integer representing the size in bytes required to store a `fd_chacha_rng_t` object.
- **See Also**: [`fd_chacha_rng_footprint`](<fd_chacha_rng.c.md#fd_chacha_rng_footprint>)  (Implementation)


---
### fd\_chacha\_rng\_new<!-- {{#callable_declaration:fd_chacha_rng_new}} -->
[View Source →](<../../../../../src/ballet/chacha/fd_chacha_rng.h#L94>)

Formats a memory region for a ChaCha-based RNG.
- **Description**: Use this function to initialize a memory region for a ChaCha-based random number generator. The memory region must be properly aligned and owned by the caller. The function requires a valid mode, which must be one of the predefined constants `FD_CHACHA_RNG_MODE_MOD` or `FD_CHACHA_RNG_MODE_SHIFT`. If the memory region is null, misaligned, or if the mode is invalid, the function logs a warning and returns null. On success, the function returns the pointer to the initialized memory region, which is then owned by the RNG object.
- **Inputs**:
    - `shmem`: Pointer to the memory region to format. Must not be null and must be aligned to `alignof(fd_chacha_rng_t)`. Caller retains ownership unless the function returns successfully.
    - `mode`: Integer specifying the mode of the RNG. Must be either `FD_CHACHA_RNG_MODE_MOD` or `FD_CHACHA_RNG_MODE_SHIFT`. Invalid values result in a null return and a warning log.
- **Output**: Returns the pointer to the initialized memory region on success, or null on failure.
- **See Also**: [`fd_chacha_rng_new`](<fd_chacha_rng.c.md#fd_chacha_rng_new>)  (Implementation)


---
### fd\_chacha\_rng\_join<!-- {{#callable_declaration:fd_chacha_rng_join}} -->
[View Source →](<../../../../../src/ballet/chacha/fd_chacha_rng.h#L97>)

Joins a caller to a ChaCha20 RNG object.
- **Description**: Use this function to obtain a local handle to a ChaCha20 RNG object. It requires a pointer to the memory region where the RNG object is stored. This function is typically called after the memory region has been properly formatted and initialized. If the input pointer is null, the function logs a warning and returns null, indicating failure. Ensure that the memory region is correctly set up before calling this function.
- **Inputs**:
    - `shrng`: A pointer to the first byte of the memory region holding the ChaCha20 RNG object. Must not be null. If null, the function logs a warning and returns null.
- **Output**: Returns a local handle to the ChaCha20 RNG object on success, or null on failure.
- **See Also**: [`fd_chacha_rng_join`](<fd_chacha_rng.c.md#fd_chacha_rng_join>)  (Implementation)


---
### fd\_chacha\_rng\_leave<!-- {{#callable_declaration:fd_chacha_rng_leave}} -->
[View Source →](<../../../../../src/ballet/chacha/fd_chacha_rng.h#L100>)

Leaves a local join to a ChaCha20 RNG object.
- **Description**: Use this function to leave a local join to a ChaCha20 RNG object. It returns a pointer to the memory region holding the RNG object on success. Ensure that the `rng` parameter is not null before calling this function. If `rng` is null, the function logs a warning and returns null. This function does not join the caller on return.
- **Inputs**:
    - `rng`: A pointer to a `fd_chacha_rng_t` object representing the current local join to a ChaCha20 RNG. Must not be null. If null, the function logs a warning and returns null.
- **Output**: Returns a pointer to the memory region holding the RNG object on success, or null if the input is invalid.
- **See Also**: [`fd_chacha_rng_leave`](<fd_chacha_rng.c.md#fd_chacha_rng_leave>)  (Implementation)


---
### fd\_chacha\_rng\_delete<!-- {{#callable_declaration:fd_chacha_rng_delete}} -->
[View Source →](<../../../../../src/ballet/chacha/fd_chacha_rng.h#L103>)

Unformats a memory region holding a ChaCha20 RNG object.
- **Description**: Use this function to safely delete a ChaCha20 RNG object from memory. It must be called when the object is no longer needed and no other operations are joined to it. This function clears the memory region to prevent data leakage and returns the pointer to the memory region. If the input is null, it logs a warning and returns null.
- **Inputs**:
    - `shrng`: Pointer to the memory region holding the ChaCha20 RNG object. Must not be null. If null, the function logs a warning and returns null. The caller retains ownership of the memory region.
- **Output**: Returns the pointer to the memory region on success, or null if the input is null.
- **See Also**: [`fd_chacha_rng_delete`](<fd_chacha_rng.c.md#fd_chacha_rng_delete>)  (Implementation)


---
### fd\_chacha20\_rng\_init<!-- {{#callable_declaration:fd_chacha20_rng_init}} -->
[View Source →](<../../../../../src/ballet/chacha/fd_chacha_rng.h#L121>)

Initializes a ChaCha20 random number generator.
- **Description**: Use this function to start a new ChaCha20 random number generator (RNG) stream. It requires a valid `fd_chacha_rng_t` object that is already joined to a ChaCha20 RNG object. The function sets the RNG state using a provided 32-byte key, discarding any previous state. This function must not be called concurrently with other operations that modify the RNG state.
- **Inputs**:
    - `rng`: A pointer to an `fd_chacha_rng_t` object. This must be a valid, joined RNG object. The caller retains ownership and must ensure it is not null.
    - `key`: A pointer to a 32-byte key used to initialize the RNG. The key must not be null, and the caller retains ownership.
- **Output**: Returns a pointer to the initialized `fd_chacha_rng_t` object, which now has the state of a new in-progress calculation.
- **See Also**: [`fd_chacha20_rng_init`](<fd_chacha_rng.c.md#fd_chacha20_rng_init>)  (Implementation)


---
### fd\_chacha8\_rng\_refill\_avx512<!-- {{#callable_declaration:fd_chacha8_rng_refill_avx512}} -->
[View Source →](<../../../../../src/ballet/chacha/fd_chacha_rng.h#L128>)

Refills the ChaCha8 RNG buffer using AVX512 instructions.
- **Description**: Use this function to refill the buffer of a ChaCha8 random number generator when the buffer is depleted. This function is specifically optimized for systems that support AVX512 instructions. It is important to ensure that the `rng` parameter is a valid pointer to a `fd_chacha_rng_t` structure that has been properly initialized and joined. This function does not return a value and does not handle invalid input; ensure that the `rng` is not null before calling.
- **Inputs**:
    - `rng`: A pointer to a `fd_chacha_rng_t` structure representing the ChaCha8 RNG. Must not be null and must point to a valid, initialized RNG object. The caller retains ownership.
- **Output**: None
- **See Also**: [`fd_chacha8_rng_refill_avx512`](<fd_chacha_rng_avx512.c.md#fd_chacha8_rng_refill_avx512>)  (Implementation)


---
### fd\_chacha20\_rng\_refill\_avx512<!-- {{#callable_declaration:fd_chacha20_rng_refill_avx512}} -->
[View Source →](<../../../../../src/ballet/chacha/fd_chacha_rng.h#L129>)

Refills the ChaCha20 RNG buffer using AVX512 instructions.
- **Description**: Use this function to refill the buffer of a ChaCha20 random number generator when the available random data is insufficient. This function is specifically optimized for systems with AVX512 support. It is important to ensure that the `rng` parameter is a valid and properly initialized ChaCha20 RNG object before calling this function. This function does not return a value and does not handle invalid input explicitly, so the caller must ensure the validity of the input.
- **Inputs**:
    - `rng`: A pointer to a `fd_chacha_rng_t` structure representing the ChaCha20 RNG. The pointer must not be null and must point to a valid, initialized RNG object. The caller retains ownership of the memory.
- **Output**: None
- **See Also**: [`fd_chacha20_rng_refill_avx512`](<fd_chacha_rng_avx512.c.md#fd_chacha20_rng_refill_avx512>)  (Implementation)


---
### fd\_chacha8\_rng\_refill\_avx<!-- {{#callable_declaration:fd_chacha8_rng_refill_avx}} -->
[View Source →](<../../../../../src/ballet/chacha/fd_chacha_rng.h#L133>)

Refills the ChaCha8 RNG buffer using AVX instructions.
- **Description**: Use this function to refill the buffer of a ChaCha8 random number generator when it is empty or near empty. This function is intended for use in environments that support AVX instructions, providing efficient buffer refilling. Ensure that the `rng` parameter is a valid pointer to an initialized `fd_chacha_rng_t` structure before calling this function. This function is typically used internally and not intended for direct use in application code.
- **Inputs**:
    - `rng`: A pointer to an `fd_chacha_rng_t` structure representing the ChaCha8 RNG state. Must not be null and must point to a valid, initialized RNG structure. The function assumes the caller has exclusive access to this structure during the call.
- **Output**: None
- **See Also**: [`fd_chacha8_rng_refill_avx`](<fd_chacha_rng_avx.c.md#fd_chacha8_rng_refill_avx>)  (Implementation)


---
### fd\_chacha20\_rng\_refill\_avx<!-- {{#callable_declaration:fd_chacha20_rng_refill_avx}} -->
[View Source →](<../../../../../src/ballet/chacha/fd_chacha_rng.h#L134>)

Refills the ChaCha20 RNG buffer using AVX instructions.
- **Description**: Use this function to refill the buffer of a ChaCha20 random number generator when it is low on pre-generated random data. This function is specifically optimized for systems with AVX support. It is important to ensure that the `rng` parameter is a valid and properly initialized ChaCha20 RNG object before calling this function. This function does not return a value and does not handle invalid input explicitly, so the caller must ensure the validity of the input.
- **Inputs**:
    - `rng`: A pointer to a `fd_chacha_rng_t` structure representing the ChaCha20 RNG. Must not be null and must point to a valid, initialized RNG object. The caller retains ownership.
- **Output**: None
- **See Also**: [`fd_chacha20_rng_refill_avx`](<fd_chacha_rng_avx.c.md#fd_chacha20_rng_refill_avx>)  (Implementation)


---
### fd\_chacha8\_rng\_refill\_seq<!-- {{#callable_declaration:fd_chacha8_rng_refill_seq}} -->
[View Source →](<../../../../../src/ballet/chacha/fd_chacha_rng.h#L137>)

Refills the ChaCha8 RNG buffer sequentially.
- **Description**: Use this function to refill the buffer of a ChaCha8 random number generator when the available random data is insufficient. This function is intended for use in environments where AVX or AVX512 instructions are not available, as it performs the refill operation sequentially. Ensure that the `rng` parameter is a valid pointer to a `fd_chacha_rng_t` structure that has been properly initialized and joined. This function does not handle concurrent modifications to the RNG state.
- **Inputs**:
    - `rng`: A pointer to a `fd_chacha_rng_t` structure representing the ChaCha8 RNG. Must not be null and must point to a valid, initialized RNG object. The caller retains ownership of the memory.
- **Output**: None
- **See Also**: [`fd_chacha8_rng_refill_seq`](<fd_chacha_rng.c.md#fd_chacha8_rng_refill_seq>)  (Implementation)


---
### fd\_chacha20\_rng\_refill\_seq<!-- {{#callable_declaration:fd_chacha20_rng_refill_seq}} -->
[View Source →](<../../../../../src/ballet/chacha/fd_chacha_rng.h#L138>)

Refills the ChaCha20 RNG buffer sequentially.
- **Description**: Use this function to refill the buffer of a ChaCha20 random number generator when the available random data is insufficient. This function is intended for sequential execution and should be used in environments where AVX or AVX512 optimizations are not available. Ensure that the RNG object is properly initialized and joined before calling this function to avoid undefined behavior.
- **Inputs**:
    - `rng`: A pointer to an `fd_chacha_rng_t` object representing the ChaCha20 RNG. Must not be null and should be a valid, initialized RNG object. The caller retains ownership.
- **Output**: None
- **See Also**: [`fd_chacha20_rng_refill_seq`](<fd_chacha_rng.c.md#fd_chacha20_rng_refill_seq>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)