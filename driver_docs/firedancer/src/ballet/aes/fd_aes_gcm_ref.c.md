<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Reference implementation of AES-GCM encryption and decryption functions, adapted from OpenSSL.

# Purpose
The code in `fd_aes_ref.c` is a C implementation of AES-GCM (Galois/Counter Mode) encryption and decryption functions. It is a reference implementation that was imported from the OpenSSL project. The file includes functions for initializing the AES-GCM context, processing additional authenticated data (AAD), encrypting and decrypting data, and finalizing the encryption or decryption process to produce or verify an authentication tag. The code defines several static functions for internal operations, such as [`fd_gcm128_aad`](<#fd_gcm128_aad>), [`fd_gcm128_encrypt`](<#fd_gcm128_encrypt>), [`fd_gcm128_decrypt`](<#fd_gcm128_decrypt>), and [`fd_gcm128_finish`](<#fd_gcm128_finish>), which handle the core logic of AES-GCM operations.

The file provides a narrow functionality focused on AES-GCM encryption and decryption, which is a mode of operation for symmetric key cryptographic block ciphers. The main public functions, [`fd_aes_128_gcm_init_ref`](<#fd_aes_128_gcm_init_ref>), [`fd_aes_gcm_encrypt_ref`](<#fd_aes_gcm_encrypt_ref>), and [`fd_aes_gcm_decrypt_ref`](<#fd_aes_gcm_decrypt_ref>), are used to initialize the encryption context, encrypt data, and decrypt data, respectively. These functions rely on internal helper functions to perform tasks such as setting the initialization vector, handling AAD, and managing the encryption and decryption process. The code is intended to be used as part of a larger cryptographic library, providing a specific implementation of AES-GCM for secure data encryption and authentication.
# Imports and Dependencies

---
- `fd_aes_gcm.h`
- `assert.h`


# Functions

---
### fd\_aes\_gcm\_setiv<!-- {{#callable:fd_aes_gcm_setiv}} -->
[View Source →](<../../../../../src/ballet/aes/fd_aes_gcm_ref.c#L12>)

Initializes the GCM context with a given initialization vector (IV) and prepares it for encryption or decryption.
- **Inputs**:
    - `gcm`: A pointer to the `fd_aes_gcm_ref_t` structure that holds the GCM context.
    - `iv`: A 12-byte array representing the initialization vector for the GCM operation.
- **Logic and Control Flow**:
    - Set the additional authenticated data (AAD) length and message length in the GCM context to zero.
    - Initialize the `ares` and `mres` fields of the GCM context to zero.
    - Copy the 12-byte IV into the first 12 bytes of the `Yi.c` array in the GCM context.
    - Set the 13th, 14th, and 15th bytes of `Yi.c` to zero and the 16th byte to one, initializing the counter to one.
    - Set the `Xi.u` array in the GCM context to zero.
    - Encrypt the `Yi.c` array using the AES key stored in the GCM context, storing the result in `EK0.c`.
    - Increment the counter and store its byte-swapped value in the fourth element of the `Yi.d` array.
- **Output**: The function does not return a value; it modifies the `gcm` context in place.
- **Functions Called**:
    - [`fd_aes_encrypt`](<fd_aes_base.h.md#fd_aes_encrypt>)


---
### fd\_aes\_128\_gcm\_init\_ref<!-- {{#callable:fd_aes_128_gcm_init_ref}} -->
[View Source →](<../../../../../src/ballet/aes/fd_aes_gcm_ref.c#L38>)

Initializes an AES-128 GCM context with a given key and initialization vector (IV).
- **Inputs**:
    - `gcm`: A pointer to an `fd_aes_gcm_ref_t` structure that will be initialized.
    - `key`: A 16-byte array representing the AES encryption key.
    - `iv`: A 12-byte array representing the initialization vector.
- **Logic and Control Flow**:
    - Set all bytes of the `gcm` structure to zero using `memset`.
    - Create a pointer `ks` to the `key` field of the `gcm` structure.
    - Call [`fd_aes_set_encrypt_key`](<fd_aes_base.h.md#fd_aes_set_encrypt_key>) to set the encryption key in `ks` using the provided `key`.
    - Encrypt the `H.c` field of `gcm` using [`fd_aes_encrypt`](<fd_aes_base.h.md#fd_aes_encrypt>) and the key schedule `ks`.
    - Swap the byte order of `gcm->H.u[0]` and `gcm->H.u[1]` using `fd_ulong_bswap`.
    - Initialize the `Htable` field of `gcm` using `fd_gcm_init` with the swapped `H.u` values.
    - Set the initialization vector in `gcm` using [`fd_aes_gcm_setiv`](<#fd_aes_gcm_setiv>) with the provided `iv`.
- **Output**: No return value; the function initializes the `gcm` structure in place.
- **Functions Called**:
    - [`fd_aes_set_encrypt_key`](<fd_aes_base.h.md#fd_aes_set_encrypt_key>)
    - [`fd_aes_encrypt`](<fd_aes_base.h.md#fd_aes_encrypt>)
    - [`fd_aes_gcm_setiv`](<#fd_aes_gcm_setiv>)


---
### fd\_gcm128\_aad<!-- {{#callable:fd_gcm128_aad}} -->
[View Source →](<../../../../../src/ballet/aes/fd_aes_gcm_ref.c#L58>)

Processes additional authenticated data (AAD) for AES-GCM encryption or decryption.
- **Inputs**:
    - `aes_gcm`: A pointer to an `fd_aes_gcm_ref_t` structure that holds the AES-GCM context.
    - `aad`: A pointer to the additional authenticated data to process.
    - `aad_sz`: The size of the additional authenticated data in bytes.
- **Logic and Control Flow**:
    - Initialize `alen` with the current AAD length from `aes_gcm->len.u[0]`.
    - Check if `aes_gcm->len.u[1]` is non-zero, indicating an error, and return -2 if true.
    - Add `aad_sz` to `alen` and check if it exceeds the maximum allowed size or if there is an overflow; return -1 if either condition is true.
    - Update `aes_gcm->len.u[0]` with the new `alen`.
    - If `aes_gcm->ares` is non-zero, process the remaining bytes in `aes_gcm->Xi.c` with the new AAD data, updating `aes_gcm->ares` and returning 0 if not fully processed.
    - If `n` becomes zero, call `fd_gcm_gmult` to multiply `aes_gcm->Xi.u` with `aes_gcm->Htable`.
    - Process blocks of 16 bytes from `aad` using `fd_gcm_ghash` and update `aad` and `aad_sz` accordingly.
    - If there are remaining bytes in `aad_sz`, XOR them with `aes_gcm->Xi.c`.
    - Update `aes_gcm->ares` with the number of remaining bytes and return 0.
- **Output**: Returns 0 on success, -1 if the AAD size is invalid, or -2 if there is an error with the message length.


---
### fd\_gcm128\_encrypt<!-- {{#callable:fd_gcm128_encrypt}} -->
[View Source →](<../../../../../src/ballet/aes/fd_aes_gcm_ref.c#L105>)

Encrypts data using AES-GCM mode, updating the context and output buffer.
- **Inputs**:
    - `ctx`: A pointer to the `fd_aes_gcm_ref_t` structure that holds the encryption context.
    - `in`: A pointer to the input data buffer to encrypt.
    - `out`: A pointer to the output buffer where encrypted data will be stored.
    - `len`: The length of the input data to encrypt.
- **Logic and Control Flow**:
    - Calculate the new message length by adding `len` to `ctx->len.u[1]` and check for overflow conditions.
    - If the new message length is invalid, return -1.
    - If `ctx->ares` is non-zero, finalize the GHASH of the AAD and reset `ctx->ares`.
    - Initialize the counter `ctr` by byte-swapping `ctx->Yi.d[3]`.
    - Iterate over each byte of the input data, encrypting it using AES and XOR operations, and store the result in the output buffer.
    - If the buffer `ctx->Xn` is full, call `fd_gcm_ghash` to process it and reset `mres`.
    - Update `ctx->mres` with the current value of `mres`.
    - Return 0 to indicate successful encryption.
- **Output**: Returns 0 on successful encryption, or -1 if the message length is invalid.
- **Functions Called**:
    - [`fd_aes_encrypt`](<fd_aes_base.h.md#fd_aes_encrypt>)


---
### fd\_gcm128\_decrypt<!-- {{#callable:fd_gcm128_decrypt}} -->
[View Source →](<../../../../../src/ballet/aes/fd_aes_gcm_ref.c#L158>)

Decrypts data using AES-GCM mode and updates the context state.
- **Inputs**:
    - `ctx`: A pointer to the `fd_aes_gcm_ref_t` structure that holds the AES-GCM context.
    - `in`: A pointer to the input data (ciphertext) to decrypt.
    - `out`: A pointer to the output buffer where the decrypted data (plaintext) will be stored.
    - `len`: The length of the input data to decrypt.
- **Logic and Control Flow**:
    - Initialize local variables `n`, `ctr`, `mres`, `i`, and `mlen` from the context.
    - Update `mlen` with the length of the input data and check for overflow conditions; return -1 if overflow is detected.
    - Update the message length in the context with `mlen`.
    - Check if additional authenticated data (AAD) is present (`ctx->ares` is non-zero).
    - If AAD is present and `len` is zero, finalize the GHASH for AAD and return 0.
    - If AAD is present, copy `ctx->Xi` to `ctx->Xn`, reset `ctx->Xi`, set `mres` to the size of `ctx->Xi`, and clear `ctx->ares`.
    - Swap the byte order of the counter `ctx->Yi.d[3]` and store it in `ctr`.
    - Iterate over each byte of the input data, performing decryption using AES encryption and XOR operations.
    - Update the counter and GHASH as necessary, resetting `mres` when it reaches the size of `ctx->Xn`.
    - Store the final `mres` value back in the context.
- **Output**: Returns 0 on successful decryption or -1 if an overflow condition is detected.
- **Functions Called**:
    - [`fd_aes_encrypt`](<fd_aes_base.h.md#fd_aes_encrypt>)


---
### fd\_gcm128\_finish<!-- {{#callable:fd_gcm128_finish}} -->
[View Source →](<../../../../../src/ballet/aes/fd_aes_gcm_ref.c#L212>)

Finalizes the GCM (Galois/Counter Mode) encryption or decryption process by processing any remaining data and computing the authentication tag.
- **Inputs**:
    - `ctx`: A pointer to the `fd_aes_gcm_ref_t` structure, which holds the context for the GCM operation, including lengths, intermediate values, and keys.
- **Logic and Control Flow**:
    - Calculate the bit lengths of the additional authenticated data (AAD) and ciphertext by left-shifting the respective lengths stored in `ctx->len.u[0]` and `ctx->len.u[1]` by 3 bits.
    - Check if there is any remaining message data (`mres`). If so, calculate the number of blocks needed to pad the data to a multiple of 16 bytes, and zero out the padding space in `ctx->Xn`.
    - If the padded message length equals the size of `ctx->Xn`, call `fd_gcm_ghash` to process the data and reset `mres` to 0.
    - If there is no remaining message data but there is remaining AAD (`ctx->ares`), call `fd_gcm_gmult` to process the AAD.
    - Swap the byte order of the calculated bit lengths for AAD and ciphertext using `fd_ulong_bswap`.
    - Store the swapped bit lengths in a `bitlen` structure and copy it to `ctx->Xn` at the current `mres` position, then update `mres`.
    - Call `fd_gcm_ghash` to process the final block of data, which includes the bit lengths.
    - XOR the final hash value in `ctx->Xi.u` with the pre-computed encryption key `ctx->EK0.u` to produce the authentication tag.
- **Output**: No direct output is returned, but the function updates the `ctx` structure, specifically `ctx->Xi.u`, which contains the final authentication tag after the XOR operation.


---
### fd\_aes\_gcm\_encrypt\_ref<!-- {{#callable:fd_aes_gcm_encrypt_ref}} -->
[View Source →](<../../../../../src/ballet/aes/fd_aes_gcm_ref.c#L250>)

Encrypts plaintext using AES-GCM and generates an authentication tag.
- **Inputs**:
    - `aes_gcm`: A pointer to an `fd_aes_gcm_ref_t` structure that holds the AES-GCM context.
    - `c`: A pointer to the output buffer where the ciphertext will be stored.
    - `p`: A pointer to the input buffer containing the plaintext to encrypt.
    - `sz`: The size of the plaintext in bytes.
    - `aad`: A pointer to the additional authenticated data (AAD) buffer.
    - `aad_sz`: The size of the AAD in bytes.
    - `tag`: A buffer to store the generated authentication tag, which is 16 bytes long.
- **Logic and Control Flow**:
    - Calls [`fd_gcm128_aad`](<#fd_gcm128_aad>) to process the additional authenticated data (AAD).
    - Initializes `bulk` to 0 and calls [`fd_gcm128_encrypt`](<#fd_gcm128_encrypt>) to encrypt the plaintext `p` into ciphertext `c`.
    - Asserts that the encryption operation returns 0, indicating success.
    - Calls [`fd_gcm128_finish`](<#fd_gcm128_finish>) to finalize the encryption and generate the authentication tag.
    - Copies the generated tag from `aes_gcm->Xi.c` to the `tag` buffer.
- **Output**: No return value; the function outputs the ciphertext in `c` and the authentication tag in `tag`.
- **Functions Called**:
    - [`fd_gcm128_aad`](<#fd_gcm128_aad>)
    - [`fd_gcm128_encrypt`](<#fd_gcm128_encrypt>)
    - [`fd_gcm128_finish`](<#fd_gcm128_finish>)


---
### fd\_aes\_gcm\_decrypt\_ref<!-- {{#callable:fd_aes_gcm_decrypt_ref}} -->
[View Source →](<../../../../../src/ballet/aes/fd_aes_gcm_ref.c#L269>)

Decrypts data using AES-GCM and verifies the integrity of the decrypted data against a provided tag.
- **Inputs**:
    - ``aes_gcm``: A pointer to an `fd_aes_gcm_ref_t` structure that holds the AES-GCM context.
    - ``c``: A pointer to the ciphertext data to decrypt.
    - ``p``: A pointer to the buffer where the plaintext output will be stored.
    - ``sz``: The size of the ciphertext data in bytes.
    - ``aad``: A pointer to the additional authenticated data (AAD) used in the decryption process.
    - ``aad_sz``: The size of the additional authenticated data in bytes.
    - ``tag``: A 16-byte array containing the authentication tag to verify the integrity of the decrypted data.
- **Logic and Control Flow**:
    - Calls [`fd_gcm128_aad`](<#fd_gcm128_aad>) to process the additional authenticated data (AAD) with the AES-GCM context.
    - Initializes a variable `bulk` to 0, which is used to track the offset in the data.
    - Asserts that the decryption of the ciphertext using [`fd_gcm128_decrypt`](<#fd_gcm128_decrypt>) is successful, processing the data from the offset `bulk` to the end of the ciphertext.
    - Calls [`fd_gcm128_finish`](<#fd_gcm128_finish>) to finalize the GCM operation and compute the authentication tag.
    - Compares the computed tag with the provided tag using `memcmp` to verify the integrity of the decrypted data.
- **Output**: Returns an integer indicating whether the computed tag matches the provided tag (1 for match, 0 for mismatch).
- **Functions Called**:
    - [`fd_gcm128_aad`](<#fd_gcm128_aad>)
    - [`fd_gcm128_decrypt`](<#fd_gcm128_decrypt>)
    - [`fd_gcm128_finish`](<#fd_gcm128_finish>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)