<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for AES key expansion, AES-128-ECB, and AES-128-GCM encryption and decryption functionalities.

# Purpose
The code is a C program designed to test the functionality of AES (Advanced Encryption Standard) encryption and decryption, specifically focusing on AES-128 in ECB (Electronic Codebook) and GCM (Galois/Counter Mode) modes. It includes test cases for key expansion, encryption, and decryption processes, using both reference and API implementations. The program uses predefined test vectors from NIST to verify the correctness of the AES-128-ECB implementation. It also tests the AES-128-GCM implementation for encryption, decryption, and authentication, ensuring that the operations are performed correctly and securely.

The program is structured to run various tests, including key expansion tests, AES-128-ECB tests, and AES-128-GCM tests. It uses conditional compilation to include platform-specific headers and configurations, such as memory mapping on Linux systems. The code defines several static data structures and functions to perform the tests, and it logs the results using macros like `FD_LOG_INFO` and `FD_LOG_ERR`. The main function initializes the test environment, executes the tests, and reports the results. The program is intended to be run as an executable, and it uses a random number generator for certain tests, ensuring that the AES-GCM implementation handles out-of-bounds memory accesses correctly.
# Imports and Dependencies

---
- `sys/mman.h`
- `fd_aes_base.h`
- `fd_aes_gcm.h`


# Global Variables

---
### fixture\_key\_expansion\_128\_zeros
- **Type**: ``uchar` array`
- **Description**: Contains a precomputed key expansion for AES-128 with an initial key of all zeros. The array is 176 bytes long and is aligned to a 16-byte boundary.
- **Use**: Used in AES key expansion tests to verify the correctness of the key expansion process.


---
### fd\_aes\_128\_ecb\_test\_vec
- **Type**: ``fd_aes_128_ecb_fixture_t const``
- **Description**: An array of test vectors for AES-128 ECB mode encryption. Each element in the array is a structure containing a 128-bit key (`k`), a 128-bit plaintext (`p`), and the corresponding 128-bit ciphertext (`c`).
- **Use**: Used to validate the correctness of AES-128 ECB encryption and decryption implementations by comparing expected and actual results.


# Data Structures

---
### fd\_aes\_128\_ecb\_fixture
- **Type**: ``struct``
- **Members**:
    - ``k``: An array of 16 unsigned characters representing the encryption key.
    - ``p``: An array of 16 unsigned characters representing the plaintext.
    - ``c``: An array of 16 unsigned characters representing the ciphertext.
- **Description**: Defines a structure used for AES-128 ECB encryption tests, containing fields for the encryption key, plaintext, and expected ciphertext, each represented as a 16-byte array.


---
### fd\_aes\_128\_ecb\_fixture\_t
- **Type**: ``struct``
- **Members**:
    - ``k``: An array of 16 `uchar` elements representing the encryption key.
    - ``p``: An array of 16 `uchar` elements representing the plaintext.
    - ``c``: An array of 16 `uchar` elements representing the ciphertext.
- **Description**: Defines a structure used for AES-128 ECB encryption and decryption tests, containing fields for the key, plaintext, and ciphertext, each represented as a 16-byte array of unsigned characters.


# Functions

---
### test\_key\_expansion\_zeros<!-- {{#callable:test_key_expansion_zeros}} -->
[View Source →](<../../../../../src/ballet/aes/test_aes.c#L30>)

Tests AES key expansion for a zeroed key against expected results.
- **Inputs**:
    - ``bit_cnt``: The number of bits in the key, which determines the size of the expanded key.
    - ``expected``: A pointer to the expected expanded key data for comparison.
    - ``expected_round_cnt``: The expected number of rounds for the AES encryption process.
- **Logic and Control Flow**:
    - Calculate `expanded_key_sz` based on `bit_cnt` to determine the size of the expanded key.
    - Initialize a static zeroed key array `key` of size 32 bytes.
    - Declare an `fd_aes_key_t` array `expanded` to store the expanded key.
    - Clear the `expanded` array using `fd_memset`.
    - Set the encryption key using [`fd_aes_ref_set_encrypt_key`](<fd_aes_base_ref.c.md#fd_aes_ref_set_encrypt_key>) with the zeroed key and `bit_cnt`.
    - Compare the `expanded` key with `expected` using `memcmp` and assert equality with `FD_TEST`.
    - Check that the number of rounds in `expanded` matches `expected_round_cnt` using `FD_TEST`.
    - Log a success message with `FD_LOG_INFO` if all tests pass.
- **Output**: No return value; the function logs success or failure of the tests.
- **Functions Called**:
    - [`fd_aes_ref_set_encrypt_key`](<fd_aes_base_ref.c.md#fd_aes_ref_set_encrypt_key>)


---
### test\_aes\_128\_ecb\_<!-- {{#callable:test_aes_128_ecb_}} -->
[View Source →](<../../../../../src/ballet/aes/test_aes.c#L194>)

Tests AES-128 ECB encryption and decryption using a given fixture.
- **Inputs**:
    - ``ecb``: A pointer to a `fd_aes_128_ecb_fixture_t` structure containing the key (`k`), plaintext (`p`), and expected ciphertext (`c`).
- **Logic and Control Flow**:
    - Initialize an AES key using [`fd_aes_ref_set_encrypt_key`](<fd_aes_base_ref.c.md#fd_aes_ref_set_encrypt_key>) with the key from `ecb` and a key size of 128 bits.
    - Encrypt the plaintext from `ecb` using [`fd_aes_ref_encrypt_core`](<fd_aes_base_ref.c.md#fd_aes_ref_encrypt_core>) and store the result in `c`.
    - Compare the encrypted result `c` with the expected ciphertext `ecb->c` using `memcmp` and assert they are equal with `FD_TEST`.
    - Initialize an AES key for decryption using [`fd_aes_ref_set_decrypt_key`](<fd_aes_base_ref.c.md#fd_aes_ref_set_decrypt_key>) with the key from `ecb` and a key size of 128 bits.
    - Decrypt the ciphertext from `ecb` using [`fd_aes_ref_decrypt_core`](<fd_aes_base_ref.c.md#fd_aes_ref_decrypt_core>) and store the result in `p`.
    - Compare the decrypted result `p` with the expected plaintext `ecb->p` using `memcmp` and assert they are equal with `FD_TEST`.
- **Output**: No return value; the function performs assertions to verify encryption and decryption correctness.
- **Functions Called**:
    - [`fd_aes_ref_set_encrypt_key`](<fd_aes_base_ref.c.md#fd_aes_ref_set_encrypt_key>)
    - [`fd_aes_ref_encrypt_core`](<fd_aes_base_ref.c.md#fd_aes_ref_encrypt_core>)
    - [`fd_aes_ref_set_decrypt_key`](<fd_aes_base_ref.c.md#fd_aes_ref_set_decrypt_key>)
    - [`fd_aes_ref_decrypt_core`](<fd_aes_base_ref.c.md#fd_aes_ref_decrypt_core>)


---
### test\_aes\_128\_ecb\_api<!-- {{#callable:test_aes_128_ecb_api}} -->
[View Source →](<../../../../../src/ballet/aes/test_aes.c#L211>)

Tests the AES-128 ECB encryption and decryption using a given fixture.
- **Inputs**:
    - ``ecb``: A pointer to a `fd_aes_128_ecb_fixture_t` structure containing the key, plaintext, and expected ciphertext for the test.
- **Logic and Control Flow**:
    - Initialize an AES key using the provided key from `ecb` for encryption.
    - Encrypt the plaintext from `ecb` using the initialized key and store the result in `c`.
    - Compare the encrypted result `c` with the expected ciphertext from `ecb` and assert they are equal.
    - Reinitialize the AES key using the provided key from `ecb` for decryption.
    - Decrypt the ciphertext from `ecb` using the initialized key and store the result in `p`.
    - Compare the decrypted result `p` with the expected plaintext from `ecb` and assert they are equal.
- **Output**: No return value; the function performs assertions to validate encryption and decryption.
- **Functions Called**:
    - [`fd_aes_set_encrypt_key`](<fd_aes_base.h.md#fd_aes_set_encrypt_key>)
    - [`fd_aes_encrypt`](<fd_aes_base.h.md#fd_aes_encrypt>)
    - [`fd_aes_set_decrypt_key`](<fd_aes_base.h.md#fd_aes_set_decrypt_key>)
    - [`fd_aes_decrypt`](<fd_aes_base.h.md#fd_aes_decrypt>)


---
### test\_aes\_128\_ecb<!-- {{#callable:test_aes_128_ecb}} -->
[View Source →](<../../../../../src/ballet/aes/test_aes.c#L228>)

Executes AES-128-ECB encryption and decryption tests using predefined test vectors.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize pointers `v` and `v1` to the start and end of the `fd_aes_128_ecb_test_vec` array, respectively.
    - Iterate over the test vectors from `v` to `v1`.
    - For each test vector, call [`test_aes_128_ecb_`](<#test_aes_128_ecb_>) to perform encryption and decryption using reference functions.
    - Call [`test_aes_128_ecb_api`](<#test_aes_128_ecb_api>) to perform encryption and decryption using API functions.
    - Log a success message if all tests pass.
- **Output**: No return value; logs success message if tests pass.
- **Functions Called**:
    - [`test_aes_128_ecb_`](<#test_aes_128_ecb_>)
    - [`test_aes_128_ecb_api`](<#test_aes_128_ecb_api>)


---
### test\_aes\_128\_gcm\_bounds<!-- {{#callable:test_aes_128_gcm_bounds}} -->
[View Source →](<../../../../../src/ballet/aes/test_aes.c#L243>)

Tests AES-128-GCM encryption and decryption operations near memory boundaries to detect out-of-bounds memory accesses.
- **Inputs**:
    - ``rng``: A pointer to a `fd_rng_t` structure used for random number generation.
- **Logic and Control Flow**:
    - Checks if the platform is Linux before executing the function.
    - Allocates three large memory regions using `mmap` and checks for successful allocation.
    - Defines the end of each memory region and unmaps the memory beyond a normal page size to create a boundary.
    - Initializes the memory regions to zero using `fd_memset`.
    - Casts a portion of the state memory to an `fd_aes_gcm_t` structure and checks alignment.
    - Defines zeroed AES key and IV arrays.
    - Iterates over sizes from 0 to `FD_SHMEM_NORMAL_PAGE_SZ`, adjusting pointers to test encryption and decryption at different offsets.
    - Writes random data to the state memory to detect uninitialized reads.
    - Initializes the AES-GCM state and performs encryption and decryption operations, checking for successful decryption.
    - Verifies that the original memory region remains zeroed after operations.
    - Unmaps the allocated memory regions.
- **Output**: No return value; the function performs tests and asserts conditions internally.


---
### test\_aes\_128\_gcm<!-- {{#callable:test_aes_128_gcm}} -->
[View Source →](<../../../../../src/ballet/aes/test_aes.c#L305>)

Tests the AES-128-GCM encryption and decryption process, including checking for malleability by corrupting the tag, ciphertext, and associated data.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize the `iv`, `key`, `aad`, `plaintext`, `tag`, and `ciphertext` arrays with predefined values.
    - Declare static arrays `actual_ciphertext` and `actual_tag` to store the results of encryption.
    - Initialize the `fd_aes_gcm_t` structure `gcm` with the `key` and `iv`.
    - Encrypt the `plaintext` using `fd_aes_gcm_encrypt` and store the result in `actual_ciphertext` and `actual_tag`.
    - Verify the encryption by comparing `actual_ciphertext` and `actual_tag` with the expected `ciphertext` and `tag` using `FD_TEST`.
    - Log success message for encryption if tests pass.
    - Initialize `actual_plaintext` array to store the result of decryption.
    - Reinitialize `gcm` and decrypt `actual_ciphertext` using `fd_aes_gcm_decrypt`, storing the result in `actual_plaintext`.
    - Verify the decryption by checking the return value and comparing `actual_plaintext` with `plaintext` using `FD_TEST`.
    - Log success message for decryption if tests pass.
    - Test AEAD malleability by corrupting the `actual_tag`, `actual_ciphertext`, and `aad` using the `BITFLIP` macro and verifying that decryption fails with `FD_TEST`.
    - Log success message for AEAD authentication if tests pass.
- **Output**: No output is returned; the function logs success messages and performs internal tests.


---
### test\_aes\_128\_gcm\_unroll<!-- {{#callable:test_aes_128_gcm_unroll}} -->
[View Source →](<../../../../../src/ballet/aes/test_aes.c#L482>)

Tests the AES-128-GCM encryption and decryption process with unrolled loops for buffer overrun detection and correctness.
- **Inputs**: None
- **Logic and Control Flow**:
    - Defines static constants for `key`, `iv`, `plaintext`, and `aad` used in the encryption and decryption process.
    - Initializes a `canary` value to detect buffer overruns.
    - Iterates over the `plaintext` array from index 1 to its size, performing encryption and decryption for each size `j`.
    - For each iteration, initializes a `result` buffer and a `tag` buffer, storing the `canary` value at `result+j`.
    - Initializes the AES-GCM context with `fd_aes_128_gcm_init` using the `key` and `iv`.
    - Encrypts the `plaintext` of size `j` into `result` using `fd_aes_gcm_encrypt`, with `aad` and `tag`.
    - Checks if the `canary` value at `result+j` is unchanged to detect buffer overruns.
    - Compares the `result` with `fixture_aes_128_gcm_unroll` to verify encryption correctness.
    - Re-initializes the AES-GCM context and decrypts `fixture_aes_128_gcm_unroll` into `result` using `fd_aes_gcm_decrypt`.
    - Checks again for buffer overruns and verifies the decrypted `result` matches the original `plaintext`.
- **Output**: No output is returned; the function logs errors if tests fail.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/ballet/aes/test_aes.c#L532>)

Initializes the environment, selects AES implementations, runs various AES tests, and then cleans up resources.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Creates a random number generator `rng` using `fd_rng_new` and `fd_rng_join`.
    - Logs the AES-ECB implementation being used based on the `FD_AES_IMPL` macro.
    - Logs the AES-GCM implementation being used based on the `FD_AES_GCM_IMPL` macro.
    - Runs the [`test_key_expansion_zeros`](<#test_key_expansion_zeros>) function to test AES key expansion with zeroed keys.
    - Runs the [`test_aes_128_ecb`](<#test_aes_128_ecb>) function to test AES-128 ECB encryption and decryption.
    - Runs the [`test_aes_128_gcm_bounds`](<#test_aes_128_gcm_bounds>) function to test AES-128 GCM encryption and decryption with boundary checks.
    - Runs the [`test_aes_128_gcm`](<#test_aes_128_gcm>) function to test AES-128 GCM encryption and decryption.
    - Runs the [`test_aes_128_gcm_unroll`](<#test_aes_128_gcm_unroll>) function to test AES-128 GCM encryption and decryption with unrolled loops.
    - Deletes the random number generator using `fd_rng_delete` and `fd_rng_leave`.
    - Logs a 'pass' message indicating successful completion of tests.
    - Calls `fd_halt` to terminate the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`test_key_expansion_zeros`](<#test_key_expansion_zeros>)
    - [`test_aes_128_ecb`](<#test_aes_128_ecb>)
    - [`test_aes_128_gcm_bounds`](<#test_aes_128_gcm_bounds>)
    - [`test_aes_128_gcm`](<#test_aes_128_gcm>)
    - [`test_aes_128_gcm_unroll`](<#test_aes_128_gcm_unroll>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)