<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Wrappers and AES key expansion for AES-GCM implementations using AESNI, AVX, and AVX512 instructions.

# Purpose
The `fd_aes_gcm_x86.c` file provides functionality for AES-GCM encryption and decryption using various x86 SIMD instruction sets, including AES-NI, AVX, and AVX-512. The file includes functions for key expansion, encryption, and decryption, specifically optimized for different hardware capabilities. The code defines several functions that initialize AES-GCM contexts, perform encryption and decryption updates, and finalize the encryption and decryption processes. These functions are designed to work with different instruction sets, as indicated by the conditional compilation directives (`FD_HAS_AESNI`, `FD_HAS_AVX`, `FD_HAS_AVX512`, etc.), allowing the code to leverage hardware acceleration for cryptographic operations when available.

The file includes both static and external functions. The static function [`expand_aes_key`](<#expand_aes_key>) is responsible for expanding the AES key for encryption and deriving the decryption key. The external functions, such as [`aes_gcm_precompute_aesni`](<#aes_gcm_precompute_aesni>), [`aes_gcm_aad_update_aesni`](<#aes_gcm_aad_update_aesni>), and others, are declared with the `sysv_abi` attribute, indicating their use of the System V ABI calling convention. These functions handle the precomputation of key material, updating of additional authenticated data (AAD), and the encryption and decryption of data blocks. The file also provides functions like [`fd_aes_gcm_encrypt_aesni`](<#fd_aes_gcm_encrypt_aesni>) and [`fd_aes_gcm_decrypt_aesni`](<#fd_aes_gcm_decrypt_aesni>) that serve as the main interfaces for performing AES-GCM encryption and decryption operations. The code is structured to support different levels of SIMD optimizations, ensuring compatibility and performance across various x86 architectures.
# Imports and Dependencies

---
- `fd_aes_gcm.h`
- `../../util/simd/fd_sse.h`


# Functions

---
### expand\_aes\_key<!-- {{#callable:expand_aes_key}} -->
[View Source →](<../../../../../src/ballet/aes/fd_aes_gcm_x86.c#L9>)

Expands a 128-bit AES key for encryption and decryption using AES-NI instructions.
- **Inputs**:
    - `out`: A pointer to `fd_aes_gcm_aesni_key_t` where the expanded key will be stored.
    - `keyp`: A pointer to a 128-bit AES key represented as an array of unsigned characters.
- **Logic and Control Flow**:
    - Load the 128-bit AES key from `keyp` into `v0`.
    - Initialize `v1` to zero.
    - Use a loop with the `ASSIST` macro to generate 10 additional round keys for encryption, storing them in the `enc` array.
    - Store the expanded encryption keys from `enc` into `out->key_enc` at intervals of 16 bytes.
    - Derive the decryption keys by applying `_mm_aesimc_si128` to the encryption keys in reverse order and store them in `out->key_dec`.
    - Set `out->key_sz` to 16, indicating the key size.
- **Output**: The function does not return a value but populates the `out` structure with expanded encryption and decryption keys.


---
### fd\_aes\_128\_gcm\_init\_aesni<!-- {{#callable:fd_aes_128_gcm_init_aesni}} -->
[View Source →](<../../../../../src/ballet/aes/fd_aes_gcm_x86.c#L113>)

Initializes an AES-GCM context using AES-NI instructions with a given key and IV.
- **Inputs**:
    - ``aes_gcm``: A pointer to an `fd_aes_gcm_aesni_t` structure that will be initialized.
    - ``key``: A 16-byte array representing the AES key.
    - ``iv``: A 12-byte array representing the initialization vector (IV).
- **Logic and Control Flow**:
    - Calls [`expand_aes_key`](<#expand_aes_key>) to expand the provided AES key and store it in the `key` field of the `aes_gcm` structure.
    - Calls `aes_gcm_precompute_aesni` to precompute necessary values for AES-GCM operations using the expanded key.
    - Copies the provided IV into the `iv` field of the `aes_gcm` structure using `memcpy`.
- **Output**: No return value; the function initializes the `aes_gcm` structure in place.
- **Functions Called**:
    - [`expand_aes_key`](<#expand_aes_key>)


---
### load\_le\_ctr<!-- {{#callable:load_le_ctr}} -->
[View Source →](<../../../../../src/ballet/aes/fd_aes_gcm_x86.c#L122>)

Initializes a 4-element little-endian counter array from a 12-byte initialization vector.
- **Inputs**:
    - ``le_ctr``: A 4-element array of unsigned integers that will be initialized as a little-endian counter.
    - ``iv``: A 12-byte array representing the initialization vector used to set up the counter.
- **Logic and Control Flow**:
    - Set `le_ctr[0]` to 2.
    - Load 4 bytes from `iv+8`, swap byte order, and store in `le_ctr[1]`.
    - Load 4 bytes from `iv+4`, swap byte order, and store in `le_ctr[2]`.
    - Load 4 bytes from `iv`, swap byte order, and store in `le_ctr[3]`.
- **Output**: The function does not return a value; it modifies the `le_ctr` array in place.


---
### fd\_aes\_gcm\_encrypt\_aesni<!-- {{#callable:fd_aes_gcm_encrypt_aesni}} -->
[View Source →](<../../../../../src/ballet/aes/fd_aes_gcm_x86.c#L131>)

Encrypts plaintext using AES-GCM with AES-NI instructions and generates an authentication tag.
- **Inputs**:
    - `aes_gcm`: A pointer to an `fd_aes_gcm_aesni_t` structure containing the AES-GCM context.
    - `c`: A pointer to the output buffer where the ciphertext will be stored.
    - `p`: A pointer to the input buffer containing the plaintext to be encrypted.
    - `sz`: The size of the plaintext in bytes.
    - `aad`: A pointer to the additional authenticated data (AAD) buffer.
    - `aad_sz`: The size of the AAD in bytes.
    - `tag`: A buffer to store the 16-byte authentication tag.
- **Logic and Control Flow**:
    - Initialize a 4-element array `le_ctr` and load it with the little-endian counter derived from the initialization vector (IV) in `aes_gcm`.
    - Initialize a 16-byte buffer `ghash_acc` to zero, which will accumulate the GHASH value.
    - Call `aes_gcm_aad_update_aesni` to update the GHASH accumulator with the AAD.
    - Call `aes_gcm_enc_update_aesni` to encrypt the plaintext `p` into ciphertext `c` and update the GHASH accumulator.
    - Call `aes_gcm_enc_final_aesni` to finalize the encryption process and update the GHASH accumulator with the total AAD and plaintext sizes.
    - Copy the final GHASH accumulator value into the `tag` buffer.
- **Output**: The function does not return a value but outputs the ciphertext in `c` and the authentication tag in `tag`.
- **Functions Called**:
    - [`load_le_ctr`](<#load_le_ctr>)


---
### fd\_aes\_gcm\_decrypt\_aesni<!-- {{#callable:fd_aes_gcm_decrypt_aesni}} -->
[View Source →](<../../../../../src/ballet/aes/fd_aes_gcm_x86.c#L147>)

Decrypts data using AES-GCM with AES-NI instructions.
- **Inputs**:
    - `aes_gcm`: A pointer to an `fd_aes_gcm_aesni_t` structure containing the AES-GCM context.
    - `c`: A pointer to the ciphertext data to decrypt.
    - `p`: A pointer to the buffer where the decrypted plaintext will be stored.
    - `sz`: The size of the ciphertext data in bytes.
    - `aad`: A pointer to the additional authenticated data (AAD) used in the decryption process.
    - `aad_sz`: The size of the additional authenticated data in bytes.
    - `tag`: A 16-byte array containing the authentication tag to verify the integrity of the data.
- **Logic and Control Flow**:
    - Initialize a local counter `le_ctr` using the [`load_le_ctr`](<#load_le_ctr>) function with the initialization vector from `aes_gcm`.
    - Initialize a `ghash_acc` array to zero, which will accumulate the GHASH value.
    - Call `aes_gcm_aad_update_aesni` to update the GHASH accumulator with the additional authenticated data (AAD).
    - Call `aes_gcm_dec_update_aesni` to decrypt the ciphertext `c` into plaintext `p` while updating the GHASH accumulator.
    - Call `aes_gcm_dec_final_aesni` to finalize the decryption process and verify the authentication tag.
- **Output**: Returns an integer indicating the success or failure of the decryption and authentication process.
- **Functions Called**:
    - [`load_le_ctr`](<#load_le_ctr>)


---
### fd\_aes\_128\_gcm\_init\_avx2<!-- {{#callable:fd_aes_128_gcm_init_avx2}} -->
[View Source →](<../../../../../src/ballet/aes/fd_aes_gcm_x86.c#L207>)

Initializes an AES-GCM context using AVX2 instructions with a given key and IV.
- **Inputs**:
    - `aes_gcm`: A pointer to an `fd_aes_gcm_aesni_t` structure that will be initialized.
    - `key`: A 16-byte array representing the AES key.
    - `iv`: A 12-byte array representing the initialization vector (IV).
- **Logic and Control Flow**:
    - Calls [`expand_aes_key`](<#expand_aes_key>) to expand the provided AES key and store it in the `aes_gcm` structure.
    - Calls `aes_gcm_precompute_aesni_avx` to precompute necessary values for AES-GCM operations using AVX2 instructions.
    - Copies the provided IV into the `iv` field of the `aes_gcm` structure.
- **Output**: No return value; the function initializes the `aes_gcm` structure in place.
- **Functions Called**:
    - [`expand_aes_key`](<#expand_aes_key>)


---
### fd\_aes\_gcm\_encrypt\_avx2<!-- {{#callable:fd_aes_gcm_encrypt_avx2}} -->
[View Source →](<../../../../../src/ballet/aes/fd_aes_gcm_x86.c#L216>)

Encrypts data using AES-GCM with AVX2 optimizations.
- **Inputs**:
    - `aes_gcm`: A pointer to an `fd_aes_gcm_aesni_t` structure that contains the AES-GCM context.
    - `c`: A pointer to the output buffer where the encrypted data will be stored.
    - `p`: A pointer to the input buffer containing the plaintext data to encrypt.
    - `sz`: The size of the plaintext data in bytes.
    - `aad`: A pointer to the additional authenticated data (AAD) buffer.
    - `aad_sz`: The size of the AAD in bytes.
    - `tag`: A buffer to store the 16-byte authentication tag.
- **Logic and Control Flow**:
    - Initialize a local counter `le_ctr` using the [`load_le_ctr`](<#load_le_ctr>) function with the initialization vector from `aes_gcm`.
    - Initialize a `ghash_acc` array to zero, which will accumulate the GHASH value.
    - Update the GHASH with the AAD using `aes_gcm_aad_update_aesni_avx`.
    - Encrypt the plaintext and update the GHASH with `aes_gcm_enc_update_aesni_avx`, storing the result in the output buffer `c`.
    - Finalize the encryption and GHASH computation with `aes_gcm_enc_final_aesni_avx`.
    - Copy the final GHASH value to the `tag` buffer.
- **Output**: The function does not return a value but outputs the encrypted data in `c` and the authentication tag in `tag`.
- **Functions Called**:
    - [`load_le_ctr`](<#load_le_ctr>)


---
### fd\_aes\_gcm\_decrypt\_avx2<!-- {{#callable:fd_aes_gcm_decrypt_avx2}} -->
[View Source →](<../../../../../src/ballet/aes/fd_aes_gcm_x86.c#L232>)

Decrypts data using AES-GCM with AVX2 optimizations.
- **Inputs**:
    - `aes_gcm`: A pointer to an `fd_aes_gcm_aesni_t` structure containing the AES-GCM context.
    - `c`: A pointer to the ciphertext data to decrypt.
    - `p`: A pointer to the buffer where the plaintext output will be stored.
    - `sz`: The size of the ciphertext data in bytes.
    - `aad`: A pointer to the additional authenticated data (AAD) used in the decryption process.
    - `aad_sz`: The size of the AAD in bytes.
    - `tag`: A 16-byte array containing the authentication tag to verify the integrity of the data.
- **Logic and Control Flow**:
    - Initialize a local counter `le_ctr` using the initialization vector from `aes_gcm`.
    - Initialize a local GHASH accumulator `ghash_acc` to zero.
    - Update the GHASH accumulator with the AAD using `aes_gcm_aad_update_aesni_avx`.
    - Decrypt the ciphertext `c` into plaintext `p` while updating the GHASH accumulator using `aes_gcm_dec_update_aesni_avx`.
    - Finalize the decryption and verify the authentication tag using `aes_gcm_dec_final_aesni_avx`.
- **Output**: Returns an integer indicating the success or failure of the decryption and authentication process.
- **Functions Called**:
    - [`load_le_ctr`](<#load_le_ctr>)


---
### fd\_aes\_128\_gcm\_init\_avx10<!-- {{#callable:fd_aes_128_gcm_init_avx10}} -->
[View Source →](<../../../../../src/ballet/aes/fd_aes_gcm_x86.c#L292>)

Initializes an AES-GCM context for 128-bit encryption using AVX-512 instructions.
- **Inputs**:
    - ``aes_gcm``: A pointer to an `fd_aes_gcm_avx10_t` structure that will be initialized.
    - ``key``: A 16-byte array containing the AES encryption key.
    - ``iv``: A 12-byte array containing the initialization vector.
- **Logic and Control Flow**:
    - Calls [`expand_aes_key`](<#expand_aes_key>) to expand the provided AES key and store it in the `key` field of the `aes_gcm` structure.
    - Calls `aes_gcm_precompute_vaes_avx10_512` to precompute necessary values for AES-GCM encryption using AVX-512 instructions.
    - Copies the 12-byte initialization vector `iv` into the `iv` field of the `aes_gcm` structure.
- **Output**: No return value; the function initializes the `aes_gcm` structure in place.
- **Functions Called**:
    - [`expand_aes_key`](<#expand_aes_key>)


---
### fd\_aes\_128\_gcm\_init\_avx10\_512<!-- {{#callable:fd_aes_128_gcm_init_avx10_512}} -->
[View Source →](<../../../../../src/ballet/aes/fd_aes_gcm_x86.c#L301>)

Initializes an AES-GCM context for 128-bit encryption using AVX-512 instructions.
- **Inputs**:
    - ``aes_gcm``: A pointer to an `fd_aes_gcm_avx10_t` structure that will be initialized.
    - ``key``: A 16-byte array representing the AES encryption key.
    - ``iv``: A 12-byte array representing the initialization vector.
- **Logic and Control Flow**:
    - Calls [`expand_aes_key`](<#expand_aes_key>) to expand the provided AES key and store it in the `key` field of the `aes_gcm` structure.
    - Calls `aes_gcm_precompute_vaes_avx10_512` to precompute necessary data for AES-GCM encryption using AVX-512 instructions.
    - Copies the 12-byte initialization vector into the `iv` field of the `aes_gcm` structure.
- **Output**: No return value; the function initializes the `aes_gcm` structure in place.
- **Functions Called**:
    - [`expand_aes_key`](<#expand_aes_key>)


---
### fd\_aes\_gcm\_encrypt\_avx10\_512<!-- {{#callable:fd_aes_gcm_encrypt_avx10_512}} -->
[View Source →](<../../../../../src/ballet/aes/fd_aes_gcm_x86.c#L310>)

Encrypts data using AES-GCM with AVX-512 instructions and updates the authentication tag.
- **Inputs**:
    - `aes_gcm`: A pointer to an `fd_aes_gcm_avx10_t` structure containing the AES-GCM context.
    - `c`: A pointer to the output buffer where the encrypted data will be stored.
    - `p`: A pointer to the input buffer containing the plaintext data to be encrypted.
    - `sz`: The size of the plaintext data in bytes.
    - `aad`: A pointer to the additional authenticated data (AAD) buffer.
    - `aad_sz`: The size of the AAD in bytes.
    - `tag`: A buffer of 16 bytes where the authentication tag will be stored.
- **Logic and Control Flow**:
    - Initialize a local counter `le_ctr` using the [`load_le_ctr`](<#load_le_ctr>) function with the initialization vector from `aes_gcm`.
    - Initialize a local `ghash_acc` array to zero, which will accumulate the GHASH value.
    - Call `aes_gcm_aad_update_vaes_avx10` to update the GHASH accumulator with the AAD.
    - Call `aes_gcm_enc_update_vaes_avx10_512` to encrypt the plaintext `p` into ciphertext `c` and update the GHASH accumulator.
    - Call `aes_gcm_enc_final_vaes_avx10` to finalize the encryption process and update the GHASH accumulator with the total sizes of AAD and plaintext.
    - Copy the final GHASH accumulator value into the `tag` buffer.
- **Output**: The function does not return a value but outputs the encrypted data in `c` and the authentication tag in `tag`.
- **Functions Called**:
    - [`load_le_ctr`](<#load_le_ctr>)


---
### fd\_aes\_gcm\_decrypt\_avx10\_512<!-- {{#callable:fd_aes_gcm_decrypt_avx10_512}} -->
[View Source →](<../../../../../src/ballet/aes/fd_aes_gcm_x86.c#L326>)

Decrypts data using AES-GCM with AVX-512 instructions and verifies the authentication tag.
- **Inputs**:
    - `aes_gcm`: A pointer to an `fd_aes_gcm_avx10_t` structure that contains the AES-GCM context.
    - `c`: A pointer to the ciphertext data to decrypt.
    - `p`: A pointer to the buffer where the plaintext output will be stored.
    - `sz`: The size of the ciphertext data in bytes.
    - `aad`: A pointer to the additional authenticated data (AAD) used in the decryption process.
    - `aad_sz`: The size of the AAD in bytes.
    - `tag`: A 16-byte array containing the authentication tag to verify.
- **Logic and Control Flow**:
    - Initialize a local counter `le_ctr` using the [`load_le_ctr`](<#load_le_ctr>) function with the initialization vector from `aes_gcm`.
    - Initialize a `ghash_acc` array to zero, which will accumulate the GHASH value.
    - Update the GHASH accumulator with the AAD using `aes_gcm_aad_update_vaes_avx10`.
    - Decrypt the ciphertext `c` into plaintext `p` and update the GHASH accumulator using `aes_gcm_dec_update_vaes_avx10_512`.
    - Finalize the decryption and verify the authentication tag using `aes_gcm_dec_final_vaes_avx10`.
- **Output**: Returns an integer indicating the success of the decryption and tag verification; typically 0 for success and non-zero for failure.
- **Functions Called**:
    - [`load_le_ctr`](<#load_le_ctr>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)