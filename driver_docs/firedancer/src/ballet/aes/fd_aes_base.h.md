<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines AES encryption and decryption functions with support for AES-NI and portable implementations.

# Purpose
The code is a C header file that provides functionality for AES (Advanced Encryption Standard) encryption and decryption. It defines both reference and AES-NI (Advanced Encryption Standard New Instructions) based implementations for setting encryption and decryption keys, as well as performing the encryption and decryption operations. The file includes conditional compilation to select between the reference implementation and the AES-NI implementation based on the availability of AES-NI instructions on the target platform.

The file defines a structure `fd_aes_key_ref_t` to store AES key information, including the round keys and the number of rounds. It provides functions such as [`fd_aes_ref_set_encrypt_key`](<#fd_aes_ref_set_encrypt_key>), [`fd_aes_ref_set_decrypt_key`](<#fd_aes_ref_set_decrypt_key>), [`fd_aes_ref_encrypt_core`](<#fd_aes_ref_encrypt_core>), and [`fd_aes_ref_decrypt_core`](<#fd_aes_ref_decrypt_core>) for the reference implementation. For the AES-NI implementation, it provides functions like [`fd_aesni_set_encrypt_key`](<#fd_aesni_set_encrypt_key>), [`fd_aesni_set_decrypt_key`](<#fd_aesni_set_decrypt_key>), [`fd_aesni_encrypt`](<#fd_aesni_encrypt>), and [`fd_aesni_decrypt`](<#fd_aesni_decrypt>). The file also includes inline functions [`fd_aes_set_encrypt_key`](<#fd_aes_set_encrypt_key>), [`fd_aes_set_decrypt_key`](<#fd_aes_set_decrypt_key>), [`fd_aes_encrypt`](<#fd_aes_encrypt>), and [`fd_aes_decrypt`](<#fd_aes_decrypt>) that abstract the underlying implementation details and perform memory sanitization checks using `fd_msan_check` and `fd_msan_unpoison`.
# Imports and Dependencies

---
- `../fd_ballet_base.h`
- `../../util/sanitize/fd_msan.h`


# Data Structures

---
### fd\_aes\_key\_ref
- **Type**: ``struct``
- **Members**:
    - `rd_key`: An array of 60 unsigned integers used to store the round keys for AES encryption or decryption.
    - `rounds`: An integer that specifies the number of rounds in the AES encryption or decryption process.
- **Description**: Stores the round keys and the number of rounds needed for AES encryption or decryption operations. The `rd_key` array holds the expanded key schedule, while `rounds` indicates how many transformation rounds are required based on the key size.


---
### fd\_aes\_key\_ref\_t
- **Type**: ``struct``
- **Members**:
    - ``rd_key``: An array of 60 unsigned integers used to store the round keys for AES encryption or decryption.
    - ``rounds``: An integer that specifies the number of rounds in the AES encryption or decryption process.
- **Description**: Defines a structure for storing AES encryption and decryption keys, including the round keys and the number of rounds required for the AES algorithm.


# Functions

---
### fd\_aes\_set\_encrypt\_key<!-- {{#callable:fd_aes_set_encrypt_key}} -->
[View Source →](<../../../../../src/ballet/aes/fd_aes_base.h#L98>)

Sets the encryption key for AES operations after performing memory checks and unpoisoning.
- **Inputs**:
    - ``user_key``: A pointer to the user-provided encryption key, which is an array of unsigned characters.
    - ``bits``: The size of the encryption key in bits.
    - ``key``: A pointer to an `fd_aes_key_t` structure where the processed encryption key will be stored.
- **Logic and Control Flow**:
    - Calls `fd_msan_check` to verify the memory safety of the `user_key` by checking its size in bytes (`bits/8`).
    - Calls `fd_msan_unpoison` to mark the memory region pointed to by `key` as initialized and safe to use, with a size of `sizeof(fd_aes_key_t)`.
    - Invokes `fd_aes_private_set_encrypt_key` to set the encryption key using the provided `user_key`, `bits`, and `key`.
- **Output**: No return value; the function modifies the `key` structure in place.


---
### fd\_aes\_set\_decrypt\_key<!-- {{#callable:fd_aes_set_decrypt_key}} -->
[View Source →](<../../../../../src/ballet/aes/fd_aes_base.h#L107>)

Initializes an AES decryption key from a user-provided key.
- **Inputs**:
    - `user_key`: A pointer to the user-provided key, which is an array of unsigned characters.
    - `bits`: The length of the key in bits.
    - `key`: A pointer to an `fd_aes_key_t` structure where the decryption key will be stored.
- **Logic and Control Flow**:
    - Calls `fd_msan_check` to verify the memory safety of the `user_key` by checking its size against `bits/8`.
    - Calls `fd_msan_unpoison` to mark the memory region pointed to by `key` as initialized and safe to use.
    - Invokes `fd_aes_private_set_decrypt_key` to set the decryption key using the provided `user_key`, `bits`, and `key`.
- **Output**: No return value; the function modifies the `key` structure in place.


---
### fd\_aes\_encrypt<!-- {{#callable:fd_aes_encrypt}} -->
[View Source →](<../../../../../src/ballet/aes/fd_aes_base.h#L116>)

Encrypts a 16-byte block of data using the provided AES key.
- **Inputs**:
    - `in`: A pointer to the 16-byte input data block to encrypt.
    - `out`: A pointer to the 16-byte output buffer where the encrypted data will be stored.
    - `key`: A pointer to the AES key structure used for encryption.
- **Logic and Control Flow**:
    - Checks the memory safety of the `key` by verifying its size using `fd_msan_check`.
    - Checks the memory safety of the `in` data block by verifying its size using `fd_msan_check`.
    - Unpoisons the `out` buffer to ensure it is safe for writing using `fd_msan_unpoison`.
    - Calls `fd_aes_private_encrypt` to perform the actual encryption of the input data block using the provided key.
- **Output**: The function does not return a value; it writes the encrypted data to the `out` buffer.


---
### fd\_aes\_decrypt<!-- {{#callable:fd_aes_decrypt}} -->
[View Source →](<../../../../../src/ballet/aes/fd_aes_base.h#L126>)

Decrypts a 16-byte block of data using the specified AES key.
- **Inputs**:
    - ``in``: Pointer to the input data block to decrypt, which must be 16 bytes long.
    - ``out``: Pointer to the output buffer where the decrypted data will be stored, which must be 16 bytes long.
    - ``key``: Pointer to the AES key structure used for decryption.
- **Logic and Control Flow**:
    - Checks the memory safety of the `key` by verifying its size using `fd_msan_check`.
    - Checks the memory safety of the input data `in` by verifying it is 16 bytes long using `fd_msan_check`.
    - Unpoisons the output buffer `out` to ensure it is safe to write 16 bytes using `fd_msan_unpoison`.
    - Calls `fd_aes_private_decrypt` to perform the actual decryption of the input data `in` into the output buffer `out` using the provided `key`.
- **Output**: The function does not return a value; it writes the decrypted data to the `out` buffer.


# Function Declarations (Public API)

---
### fd\_aes\_ref\_set\_encrypt\_key<!-- {{#callable_declaration:fd_aes_ref_set_encrypt_key}} -->
[View Source →](<../../../../../src/ballet/aes/fd_aes_base.h#L18>)

Sets the encryption key for AES operations.
- **Description**: Use this function to initialize an AES encryption key with a specified key size. The function requires a valid user key and a key structure to store the expanded key. It supports key sizes of 128, 192, or 256 bits. The function must be called before performing encryption operations. If the provided key size is not supported or if any input pointers are null, the function returns an error code.
- **Inputs**:
    - `user_key`: A pointer to the user-provided key. Must not be null. The key size must match the specified number of bits divided by 8.
    - `bits`: The size of the key in bits. Valid values are 128, 192, or 256. If an invalid size is provided, the function returns an error.
    - `key`: A pointer to an `fd_aes_key_ref_t` structure where the expanded key will be stored. Must not be null. The caller retains ownership.
- **Output**: Returns 0 on success. Returns -1 if `user_key` or `key` is null. Returns -2 if `bits` is not 128, 192, or 256.
- **See Also**: [`fd_aes_ref_set_encrypt_key`](<fd_aes_base_ref.c.md#fd_aes_ref_set_encrypt_key>)  (Implementation)


---
### fd\_aes\_ref\_set\_decrypt\_key<!-- {{#callable_declaration:fd_aes_ref_set_decrypt_key}} -->
[View Source →](<../../../../../src/ballet/aes/fd_aes_base.h#L25>)

Sets the decryption key for AES operations.
- **Description**: Use this function to configure the decryption key for AES operations. It must be called before any decryption operation to ensure the key is correctly set. The function requires a valid user key and key size in bits. The key size must be appropriate for AES, typically 128, 192, or 256 bits. The function modifies the `key` structure to store the decryption key information.
- **Inputs**:
    - `user_key`: A pointer to the user-provided key. It must not be null and should point to a valid memory location with a size corresponding to the specified number of bits divided by 8.
    - `bits`: The size of the key in bits. Valid values are typically 128, 192, or 256. The function does not handle invalid key sizes.
    - `key`: A pointer to an `fd_aes_key_ref_t` structure where the decryption key will be stored. It must not be null and should point to a valid memory location.
- **Output**: Returns an integer status code. A return value of 0 indicates success.
- **See Also**: [`fd_aes_ref_set_decrypt_key`](<fd_aes_base_ref.c.md#fd_aes_ref_set_decrypt_key>)  (Implementation)


---
### fd\_aes\_ref\_encrypt\_core<!-- {{#callable_declaration:fd_aes_ref_encrypt_core}} -->
[View Source →](<../../../../../src/ballet/aes/fd_aes_base.h#L30>)

Encrypts a 16-byte block of data using the provided AES key.
- **Description**: Use this function to encrypt a 16-byte block of data with a pre-initialized AES key. Ensure that the key has been set up correctly using the appropriate key setup function before calling this function. The input and output buffers must not overlap, and the function requires valid pointers for all parameters. This function does not handle invalid input and assumes that all inputs are correctly initialized and non-null.
- **Inputs**:
    - `in`: Pointer to a 16-byte block of data to encrypt. Must not be null.
    - `out`: Pointer to a buffer where the encrypted data will be stored. Must not be null and must have space for at least 16 bytes.
    - `key`: Pointer to a pre-initialized `fd_aes_key_ref_t` structure containing the encryption key. Must not be null.
- **Output**: None
- **See Also**: [`fd_aes_ref_encrypt_core`](<fd_aes_base_ref.c.md#fd_aes_ref_encrypt_core>)  (Implementation)


---
### fd\_aes\_ref\_decrypt\_core<!-- {{#callable_declaration:fd_aes_ref_decrypt_core}} -->
[View Source →](<../../../../../src/ballet/aes/fd_aes_base.h#L35>)

Decrypts a 16-byte block of data using a specified AES key.
- **Description**: Use this function to decrypt a 16-byte block of data with a given AES decryption key. Ensure that the input data, output buffer, and key are all valid and non-null before calling this function. The function does not perform any internal validation of the input parameters, so it is the caller's responsibility to ensure that the inputs are correct. The decryption process will write the decrypted data to the specified output buffer.
- **Inputs**:
    - `in`: Pointer to a 16-byte block of data to decrypt. Must not be null.
    - `out`: Pointer to a buffer where the decrypted data will be written. Must not be null and must have space for at least 16 bytes.
    - `key`: Pointer to a constant `fd_aes_key_ref_t` structure containing the AES decryption key. Must not be null.
- **Output**: None
- **See Also**: [`fd_aes_ref_decrypt_core`](<fd_aes_base_ref.c.md#fd_aes_ref_decrypt_core>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)