<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines methods for computing weighted random samples using ChaCha20, as used by Solana for leader scheduling and Turbine trees.

# Purpose
The code is a C header file that defines a set of functions and macros for creating and managing a weighted random sampling system. This system is specifically designed to generate random samples based on weights, which is used by Solana for computing leader schedules and the Turbine tree. The sampling process involves seeding a ChaCha20 random number generator with a 32-byte seed and using the generated random stream to select an index based on cumulative stake weights.

The header file provides several key functionalities, including the initialization and finalization of a memory region to be used as a weighted sampler, adding weights to this region, and sampling with or without replacement. It also includes functions for managing the state of the sampler, such as removing and restoring elements. The file defines constants and macros to assist with memory alignment and footprint calculations, as well as hints for optimizing the sampling process based on the distribution of weights. The interface allows for flexible configuration, including options for enabling or disabling restoration of removed elements and specifying the distribution pattern of weights.
# Imports and Dependencies

---
- `../fd_ballet_base.h`
- `../chacha/fd_chacha_rng.h`


# Data Structures

---
### fd\_wsample\_t
- **Type**: ``struct``
- **Members**:
    - ``fd_wsample_private``: An opaque structure used internally to represent the weighted sampler.
- **Description**: `fd_wsample_t` is a typedef for an opaque structure `fd_wsample_private`, which is used to implement a weighted sampling mechanism. This structure is part of a system that generates weighted random samples, specifically designed for use cases like Solana's leader schedule and Turbine tree. The structure is aligned and has a footprint that depends on the number of elements and whether restoration is enabled. It interacts with a ChaCha20 random number generator to produce random samples based on stake weights.


# Function Declarations (Public API)

---
### fd\_wsample\_align<!-- {{#callable_declaration:fd_wsample_align}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.h#L52>)

Returns the required memory alignment for a weighted sampler.
- **Description**: Use this function to obtain the memory alignment requirement for creating a weighted sampler. This alignment is necessary to ensure that the memory region used for the sampler is correctly aligned, which is important for performance and correctness on many systems. This function does not require any parameters and can be called at any time to retrieve the alignment value.
- **Inputs**: None
- **Output**: Returns an unsigned long integer representing the alignment requirement, which is 64 bytes.
- **See Also**: [`fd_wsample_align`](<fd_wsample.c.md#fd_wsample_align>)  (Implementation)


---
### fd\_wsample\_footprint<!-- {{#callable_declaration:fd_wsample_footprint}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.h#L53>)

Calculates the memory footprint required for a weighted sampler.
- **Description**: Use this function to determine the memory size needed to create a weighted sampler with a specified number of elements. The function considers whether restoration of removed elements is enabled, which affects the footprint size. It is important to ensure that the element count is within the valid range of [0, UINT_MAX-2). If the function encounters an error during computation, it returns 0, indicating an invalid footprint.
- **Inputs**:
    - `ele_cnt`: Specifies the number of elements for the sampler. Must be in the range [0, UINT_MAX-2).
    - `restore_enabled`: Indicates if the sampler should support restoration of removed elements. A non-zero value enables restoration, increasing the footprint size.
- **Output**: Returns the calculated memory footprint in bytes. If an error occurs, returns 0.
- **See Also**: [`fd_wsample_footprint`](<fd_wsample.c.md#fd_wsample_footprint>)  (Implementation)


---
### fd\_wsample\_join<!-- {{#callable_declaration:fd_wsample_join}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.h#L54>)

Joins a memory region formatted as a weighted sampler.
- **Description**: Use this function to join a memory region that has been formatted as a weighted sampler. The function requires the memory region to be properly aligned according to the alignment requirements of the weighted sampler. It is important to ensure that the memory region is not null and is correctly aligned before calling this function. If the memory region is null or misaligned, the function will return null and log a warning. This function is typically used after initializing and formatting the memory region with the appropriate functions.
- **Inputs**:
    - `shmem`: A pointer to the memory region to join. Must not be null and must be aligned according to `fd_wsample_align()`. If null or misaligned, the function returns null and logs a warning. Caller retains ownership.
- **Output**: Returns a pointer to the joined `fd_wsample_t` structure if successful, or null if the input is invalid.
- **See Also**: [`fd_wsample_join`](<fd_wsample.c.md#fd_wsample_join>)  (Implementation)


---
### fd\_wsample\_leave<!-- {{#callable_declaration:fd_wsample_leave}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.h#L55>)

Leaves a memory region formatted as a weighted sampler.
- **Description**: Use this function to leave a memory region that is formatted as a weighted sampler. This function is a simple cast operation and should be called when you no longer need to interact with the sampler. Ensure that the `sampler` parameter is not null before calling this function, as passing a null pointer will result in a warning and a null return value.
- **Inputs**:
    - `sampler`: A pointer to a `fd_wsample_t` object representing the weighted sampler. Must not be null. If null, the function logs a warning and returns null.
- **Output**: Returns a void pointer to the sampler if successful, or null if the input is null.
- **See Also**: [`fd_wsample_leave`](<fd_wsample.c.md#fd_wsample_leave>)  (Implementation)


---
### fd\_wsample\_delete<!-- {{#callable_declaration:fd_wsample_delete}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.h#L56>)

Unformats a memory region used as a weighted sampler.
- **Description**: Use this function to release interest in a memory region previously formatted as a weighted sampler. It checks if the provided memory pointer is non-null and properly aligned according to the required alignment for a weighted sampler. If the pointer is null or misaligned, the function logs a warning and returns null. This function is typically called when the memory region is no longer needed as a weighted sampler.
- **Inputs**:
    - `shmem`: A pointer to the memory region to unformat. Must not be null and must be aligned according to `fd_wsample_align()`. If null or misaligned, the function logs a warning and returns null. The caller retains ownership of the memory.
- **Output**: Returns the input pointer `shmem` if it is valid; otherwise, returns null.
- **See Also**: [`fd_wsample_delete`](<fd_wsample.c.md#fd_wsample_delete>)  (Implementation)


---
### fd\_wsample\_new\_init<!-- {{#callable_declaration:fd_wsample_new_init}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.h#L127>)

Initializes a memory region for a weighted sampler.
- **Description**: Use this function to start the process of formatting a memory region to be used as a weighted sampler. The memory region must be aligned according to `fd_wsample_align` and have a footprint as specified by `fd_wsample_footprint`. The `rng` parameter must be a local join of a ChaCha20 RNG struct, which the sampler will use to generate random numbers. The `ele_cnt` parameter specifies the number of elements that can be sampled and must be less than `UINT_MAX`. If `restore_enabled` is set to 0, the `fd_wsample_restore_all` function will not work, but the required footprint will be smaller. The `opt_hint` parameter provides a hint about the weight distribution and query style, affecting performance but not correctness. The function returns the `shmem` pointer on success or `NULL` on failure.
- **Inputs**:
    - `shmem`: A pointer to the first byte of the memory region to use. Must not be null and must be aligned according to `fd_wsample_align`. If null or misaligned, the function returns `NULL`.
    - `rng`: A pointer to a local join of a ChaCha20 RNG struct. The sampler will use this RNG to generate random numbers. The caller retains ownership.
    - `ele_cnt`: Specifies the number of elements that can be sampled. Must be less than `UINT_MAX`. If invalid, the function returns `NULL`.
    - `restore_enabled`: An integer flag indicating if the `fd_wsample_restore_all` function should be enabled. If set to 0, the function will not work, but the required footprint will be smaller.
    - `opt_hint`: An integer hint about the weight distribution and query style. Must be one of the `FD_WSAMPLE_HINT_*` values. This affects performance but not correctness.
- **Output**: Returns the `shmem` pointer on success or `NULL` on failure.
- **See Also**: [`fd_wsample_new_init`](<fd_wsample.c.md#fd_wsample_new_init>)  (Implementation)


---
### fd\_wsample\_new\_add<!-- {{#callable_declaration:fd_wsample_new_add}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.h#L132>)

Adds a weight to a partially formatted memory region for weighted sampling.
- **Description**: Use this function to add a weight to a memory region that is being formatted for weighted sampling. The memory region must be partially constructed, as returned by `fd_wsample_new_init` or a previous call to this function. The weight must be strictly positive, and the cumulative sum of this weight and all other weights must not exceed `ULONG_MAX`. This function returns the memory region on success or `NULL` if the operation fails, such as when the weight is zero or the cumulative weight exceeds the limit.
- **Inputs**:
    - `shmem`: A pointer to a partially constructed memory region for weighted sampling. Must not be null. Caller retains ownership.
    - `weight`: A strictly positive unsigned long integer representing the weight to add. Must not cause the cumulative weight to exceed `ULONG_MAX`.
- **Output**: Returns the `shmem` pointer on success, or `NULL` on failure.
- **See Also**: [`fd_wsample_new_add`](<fd_wsample.c.md#fd_wsample_new_add>)  (Implementation)


---
### fd\_wsample\_new\_fini<!-- {{#callable_declaration:fd_wsample_new_fini}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.h#L133>)

Finalizes the formatting of a weighted sampler memory region.
- **Description**: Use this function to complete the setup of a memory region for use as a weighted sampler after adding all necessary weights. It must be called after `fd_wsample_new_add_weight` or `fd_wsample_new_init` if no weights are added. The function ensures that the memory region is ready for sampling operations. If `poisoned_weight` is non-zero, it adds a poisoned region to the sampler, which can be useful for managing indeterminate elements. The sum of all weights and `poisoned_weight` must not exceed `ULONG_MAX`. The function returns the memory region on success or `NULL` if an error occurs, such as a null `shmem` pointer or an overflow caused by `poisoned_weight`.
- **Inputs**:
    - `shmem`: A pointer to a partially constructed memory region, as returned by `fd_wsample_new_add_weight` or `fd_wsample_new_init`. Must not be null.
    - `poisoned_weight`: An unsigned long representing the weight of a poisoned region. Can be zero. The sum of all weights and this value must not exceed `ULONG_MAX`.
- **Output**: Returns a pointer to the memory region on success, or `NULL` on failure.
- **See Also**: [`fd_wsample_new_fini`](<fd_wsample.c.md#fd_wsample_new_fini>)  (Implementation)


---
### fd\_wsample\_get\_rng<!-- {{#callable_declaration:fd_wsample_get_rng}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.h#L136>)

Returns the RNG associated with a sampler.
- **Description**: Use this function to obtain the random number generator (RNG) that was provided during the initialization of a weighted sampler. This is useful when you need to access or modify the RNG used for generating random samples. Ensure that the sampler is properly initialized before calling this function.
- **Inputs**:
    - `sampler`: A pointer to an `fd_wsample_t` structure. This must not be null and should point to a valid, initialized sampler. If the sampler is not properly initialized, the behavior is undefined.
- **Output**: A pointer to an `fd_chacha_rng_t` structure, which is the RNG associated with the given sampler.
- **See Also**: [`fd_wsample_get_rng`](<fd_wsample.c.md#fd_wsample_get_rng>)  (Implementation)


---
### fd\_wsample\_seed\_rng<!-- {{#callable_declaration:fd_wsample_seed_rng}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.h#L141>)

Seeds a ChaCha20 random number generator with a 32-byte seed.
- **Description**: Use this function to initialize a ChaCha20 random number generator with a specific 32-byte seed. This is necessary before generating random samples using the generator. Ensure that the `rng` parameter points to a valid ChaCha20 RNG structure and that the `seed` array contains exactly 32 bytes. This function is compatible with Solana's ChaChaRng::from_seed.
- **Inputs**:
    - `rng`: A pointer to a `fd_chacha_rng_t` structure. Must not be null. The caller retains ownership.
    - `seed`: An array of 32 unsigned characters. Must contain exactly 32 bytes. The caller retains ownership.
- **Output**: None
- **See Also**: [`fd_wsample_seed_rng`](<fd_wsample.c.md#fd_wsample_seed_rng>)  (Implementation)


---
### fd\_wsample\_sample<!-- {{#callable_declaration:fd_wsample_sample}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.h#L172>)

Produces a weighted random sample from the sampler.
- **Description**: Use this function to obtain a weighted random sample from a sampler that has been properly initialized and seeded. The function returns a sample index based on the weights of unremoved elements. If there are no unremoved elements, it returns a special value indicating emptiness. If the sample falls within a poisoned region, it returns a special value indicating indeterminacy. Ensure the sampler's RNG is seeded before calling this function.
- **Inputs**:
    - `sampler`: A pointer to an `fd_wsample_t` structure representing the weighted sampler. Must not be null. The sampler must be initialized and have a seeded RNG. If the sampler has no unremoved elements or is in a poisoned mode, special return values are provided.
- **Output**: Returns an `ulong` representing the sampled index. If no unremoved elements are available, returns `FD_WSAMPLE_EMPTY`. If the sample falls in a poisoned region, returns `FD_WSAMPLE_INDETERMINATE`.
- **See Also**: [`fd_wsample_sample`](<fd_wsample.c.md#fd_wsample_sample>)  (Implementation)


---
### fd\_wsample\_sample\_and\_remove<!-- {{#callable_declaration:fd_wsample_sample_and_remove}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.h#L173>)

Samples and removes a weighted random element from the sampler.
- **Description**: Use this function to obtain a weighted random sample from the sampler and remove it from future sampling operations. This function is suitable for scenarios where sampling without replacement is required. Ensure that the sampler has been properly initialized and contains unremoved elements before calling this function. If the sampler is empty or in a poisoned state, the function will return special values indicating these conditions. The function modifies the state of the sampler by removing the sampled element.
- **Inputs**:
    - `sampler`: A pointer to an `fd_wsample_t` structure representing the weighted sampler. Must not be null. The sampler must be initialized and contain unremoved elements. If the sampler is empty or in a poisoned state, the function will handle these cases by returning special values.
- **Output**: Returns the index of the sampled element. If the sampler is empty, returns `FD_WSAMPLE_EMPTY`. If the sampler is in a poisoned state, returns `FD_WSAMPLE_INDETERMINATE`. The function also updates the sampler's state by removing the sampled element.
- **See Also**: [`fd_wsample_sample_and_remove`](<fd_wsample.c.md#fd_wsample_sample_and_remove>)  (Implementation)


---
### fd\_wsample\_sample\_many<!-- {{#callable_declaration:fd_wsample_sample_many}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.h#L174>)

Generates multiple weighted random samples from a sampler.
- **Description**: Use this function to obtain multiple weighted random samples from a given sampler. It stores the sampled indices in the provided array. Ensure that the sampler's random number generator is seeded before calling this function. The function does not modify the sampler, allowing for sampling with replacement. If the sampler has no unremoved elements, the function stores `FD_WSAMPLE_EMPTY` in the indices array. If the random sample lands in a poisoned region, it stores `FD_WSAMPLE_INDETERMINATE`. This function is useful when you need to sample multiple indices at once.
- **Inputs**:
    - `sampler`: A pointer to an `fd_wsample_t` structure representing the weighted sampler. Must not be null and should be properly initialized and seeded before use.
    - `idxs`: A pointer to an array of `ulong` where the sampled indices will be stored. The array must have at least `cnt` elements. The caller retains ownership.
    - `cnt`: The number of samples to generate. Must be a non-negative value.
- **Output**: None
- **See Also**: [`fd_wsample_sample_many`](<fd_wsample.c.md#fd_wsample_sample_many>)  (Implementation)


---
### fd\_wsample\_sample\_and\_remove\_many<!-- {{#callable_declaration:fd_wsample_sample_and_remove_many}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.h#L175>)

Generates and removes multiple weighted random samples from a sampler.
- **Description**: Use this function to obtain multiple weighted random samples from a sampler and remove them from future sampling. This function is useful when you need to sample without replacement. Ensure that the sampler's RNG is seeded before calling this function. If the sampler has no unremoved elements, the function will store `FD_WSAMPLE_EMPTY` in the output array. If a sample lands in the poisoned region, `FD_WSAMPLE_INDETERMINATE` is stored, and subsequent calls will also return indeterminate results until `fd_wsample_restore_all` is called.
- **Inputs**:
    - `sampler`: A pointer to an `fd_wsample_t` structure representing the weighted sampler. Must not be null and must be properly initialized and seeded before use.
    - `idxs`: A pointer to an array of `ulong` where the sampled indices will be stored. The array must have at least `cnt` elements.
    - `cnt`: The number of samples to generate and remove. Must be a non-negative value.
- **Output**: The function stores the sampled indices in the `idxs` array. If no unremoved elements are available, `FD_WSAMPLE_EMPTY` is stored. If a sample lands in the poisoned region, `FD_WSAMPLE_INDETERMINATE` is stored.
- **See Also**: [`fd_wsample_sample_and_remove_many`](<fd_wsample.c.md#fd_wsample_sample_and_remove_many>)  (Implementation)


---
### fd\_wsample\_remove\_idx<!-- {{#callable_declaration:fd_wsample_remove_idx}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.h#L183>)

Removes an element from the sampler by index.
- **Description**: Use this function to remove an element from the weighted sampler by its index, as if it had been selected for sampling without replacement. This operation ensures that the specified index will not be returned by any subsequent sampling methods unless all elements are restored. It is important to note that removing an element that has already been removed will have no effect. This function should be used when you need to exclude specific elements from future sampling operations.
- **Inputs**:
    - `sampler`: A pointer to an `fd_wsample_t` structure representing the weighted sampler. Must not be null.
    - `idx`: The index of the element to remove. Must be within the range [0, ele_cnt), where ele_cnt is the number of elements in the sampler.
- **Output**: None
- **See Also**: [`fd_wsample_remove_idx`](<fd_wsample.c.md#fd_wsample_remove_idx>)  (Implementation)


---
### fd\_wsample\_restore\_all<!-- {{#callable_declaration:fd_wsample_restore_all}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.h#L192>)

Restores all previously removed elements in the sampler.
- **Description**: Use this function to restore all elements that were removed from the sampler using sampling functions that remove elements. This function is useful when you want to reset the sampler to its original state without reconstructing it. It must be called only if the sampler was initialized with `restore_enabled` set to a non-zero value. If `restore_enabled` is zero, the function will return `NULL` and no elements will be restored.
- **Inputs**:
    - `sampler`: A pointer to an `fd_wsample_t` structure representing the weighted sampler. The sampler must have been initialized with `restore_enabled` set to a non-zero value. The pointer must not be null.
- **Output**: Returns a pointer to the `fd_wsample_t` structure on success, or `NULL` if `restore_enabled` was set to zero during initialization.
- **See Also**: [`fd_wsample_restore_all`](<fd_wsample.c.md#fd_wsample_restore_all>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)