<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a weighted sampling algorithm using a radix-9 tree structure for efficient sampling and removal operations.

# Purpose
The code implements a weighted sampling algorithm using a tree structure, which is similar to a B-tree with elements of a binary heap. The primary purpose of this code is to efficiently sample elements based on their weights, allowing for both sampling with and without replacement. The tree is stored in a flat array, and each node contains cumulative weights of its subtrees, facilitating quick traversal and sampling. The implementation uses a radix-9 tree, where each node can have up to 9 children, and the leaves are all at the same level, optimizing for minimal branch mispredictions during traversal.

The code defines a structure `fd_wsample_t` to manage the sampling process, including the total count and weight of elements, and the internal tree structure. It provides functions to initialize the sampler, add elements with specific weights, finalize the setup, and perform sampling operations. The sampling functions utilize SIMD instructions for performance optimization when available, specifically targeting AVX-512 instructions. The code also includes mechanisms to handle cases where elements are removed from the sample set, updating the tree structure accordingly. Additionally, the code supports restoring the sampler to its initial state if needed.
# Imports and Dependencies

---
- `fd_wsample.h`
- `math.h`
- `../../util/simd/fd_avx512.h`


# Data Structures

---
### tree\_ele
- **Type**: ``struct``
- **Members**:
    - ``left_sum``: Stores the cumulative weight of the subtrees at this node.
- **Description**: Represents a node in a tree structure used for sampling, where each node stores cumulative weights of its subtrees in the `left_sum` array. This structure is aligned to optimize memory access and is part of a larger sampling algorithm that uses a tree-like structure to efficiently manage and query weights for sampling purposes.


---
### tree\_ele\_t
- **Type**: ``struct``
- **Members**:
    - ``left_sum``: Stores the cumulative weight of the subtrees at this node.
- **Description**: The `tree_ele_t` structure is used to represent a node in a radix tree, where each node stores cumulative weights of its subtrees in the `left_sum` array. This structure is part of a larger implementation that uses a tree-like data structure to efficiently manage and sample elements based on their weights. The `left_sum` array helps in determining which subtree a query value falls into, facilitating quick and branchless searches within the tree.


---
### fd\_wsample\_private
- **Type**: ``struct``
- **Members**:
    - ``total_cnt``: Stores the total count of elements.
    - ``total_weight``: Stores the total weight of all elements.
    - ``unremoved_cnt``: Stores the count of elements that have not been removed.
    - ``unremoved_weight``: Stores the weight of elements that have not been removed.
    - ``internal_node_cnt``: Stores the count of internal nodes in the tree.
    - ``poisoned_weight``: Stores the weight used when the structure is in poisoned mode.
    - ``height``: Stores the height of the tree.
    - ``restore_enabled``: Indicates if restore functionality is enabled.
    - ``poisoned_mode``: Indicates if the structure is in poisoned mode.
    - ``rng``: Pointer to a random number generator.
    - ``dummy``: A dummy tree element used for boundary safety.
    - ``tree``: An array of tree elements representing the tree structure.
- **Description**: The `fd_wsample_private` structure is a data structure used to manage a weighted sampling tree. It maintains counts and weights of elements, both total and unremoved, and includes fields for managing the tree's internal nodes and height. The structure supports a poisoned mode, which affects sampling behavior, and can optionally enable a restore feature to revert the tree to its initial state. The tree is represented as an array of `tree_ele_t` elements, with additional dummy elements for safe boundary operations. A random number generator is associated with the structure to facilitate sampling operations.


---
### fd\_wsample\_t
- **Type**: ``struct``
- **Members**:
    - ``total_cnt``: Stores the total number of elements in the sample.
    - ``total_weight``: Stores the total weight of all elements in the sample.
    - ``unremoved_cnt``: Stores the count of elements that have not been removed.
    - ``unremoved_weight``: Stores the total weight of elements that have not been removed.
    - ``internal_node_cnt``: Stores the count of internal nodes in the tree structure.
    - ``poisoned_weight``: Stores the weight used when the sample is in poisoned mode.
    - ``height``: Stores the height of the tree structure.
    - ``restore_enabled``: Indicates if the restore feature is enabled.
    - ``poisoned_mode``: Indicates if the sample is in poisoned mode.
    - ``rng``: Pointer to a random number generator used for sampling.
    - ``dummy``: A dummy tree element used for safe out-of-bounds reads.
    - ``tree``: Array of tree elements representing the sampling tree.
- **Description**: `fd_wsample_t` is a data structure that implements a weighted sampling mechanism using a tree-like structure. It maintains information about the total and unremoved counts and weights of elements, as well as the internal node count and tree height. The structure supports operations for sampling and removing elements, with features for restoring the tree to its initial state and handling poisoned modes. The tree is stored in a flat array with a radix-based indexing scheme, allowing efficient sampling and updates.


---
### idxw\_pair\_t
- **Type**: ``struct``
- **Members**:
    - ``idx``: Stores an index value as an unsigned long integer.
    - ``weight``: Stores a weight value as an unsigned long integer.
- **Description**: Represents a pair of an index and a weight, where `idx` is an index within a specified range and `weight` is the associated weight of that index. This structure is used to manage and manipulate index-weight pairs, particularly in sampling algorithms where each index has a corresponding weight.


# Functions

---
### fd\_wsample\_align<!-- {{#callable:fd_wsample_align}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.c#L155>)

Returns the alignment requirement for `fd_wsample_t` structures.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the constant value `64UL`.
- **Output**: The function returns an unsigned long integer (`ulong`) with the value `64UL`, indicating the alignment requirement.


---
### compute\_height<!-- {{#callable:compute_height}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.c#L161>)

Calculates the height and internal node count of a tree based on the number of leaves.
- **Inputs**:
    - ``leaf_cnt``: The number of leaves in the tree.
    - ``out_height``: A pointer to store the calculated height of the tree.
    - ``out_internal_cnt``: A pointer to store the calculated number of internal nodes in the tree.
- **Logic and Control Flow**:
    - Check if `leaf_cnt` is greater than or equal to `UINT_MAX-2UL`; if true, return -1.
    - Initialize `height`, `internal`, and `powRh` to 0, 0, and 1 respectively.
    - Enter a loop that continues while `leaf_cnt` is greater than `powRh`.
    - In each iteration, add `powRh` to `internal`, multiply `powRh` by `R`, and increment `height`.
    - After the loop, store `height` in `*out_height` and `internal` in `*out_internal_cnt`.
    - Return 0 to indicate successful computation.
- **Output**: Returns 0 on success, or -1 if `leaf_cnt` is too large.


---
### fd\_wsample\_footprint<!-- {{#callable:fd_wsample_footprint}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.c#L184>)

Calculates the memory footprint required for a weighted sampling structure based on the number of elements and whether restoration is enabled.
- **Inputs**:
    - `ele_cnt`: The number of elements in the sampling structure.
    - `restore_enabled`: A flag indicating if restoration of the sampling structure is enabled (non-zero) or not (zero).
- **Logic and Control Flow**:
    - Declare variables `height` and `internal_cnt` to store the height of the tree and the count of internal nodes, respectively.
    - Call [`compute_height`](<#compute_height>) with `ele_cnt` to calculate `height` and `internal_cnt`; if it returns a non-zero value, return 0UL indicating failure.
    - Calculate the memory footprint using the size of `fd_wsample_t` and the size of `tree_ele_t`, adjusted by `internal_cnt` and `restore_enabled`.
- **Output**: Returns the calculated memory footprint as an unsigned long integer.
- **Functions Called**:
    - [`compute_height`](<#compute_height>)


---
### fd\_wsample\_join<!-- {{#callable:fd_wsample_join}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.c#L197>)

Validates and aligns a shared memory pointer for use as an `fd_wsample_t` structure.
- **Inputs**:
    - `shmem`: A pointer to shared memory that is intended to be used as an `fd_wsample_t` structure.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL; if true, log a warning and return NULL.
    - Check if `shmem` is aligned according to `fd_wsample_align()`; if not, log a warning and return NULL.
    - If both checks pass, cast `shmem` to `fd_wsample_t *` and return it.
- **Output**: Returns a pointer to `fd_wsample_t` if `shmem` is valid and aligned, otherwise returns NULL.
- **Functions Called**:
    - [`fd_wsample_align`](<#fd_wsample_align>)


---
### seed\_recursive<!-- {{#callable:seed_recursive}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.c#L256>)

Recursively assigns priorities to elements in a treap data structure based on a modified binary search rule using geometric mean.
- **Inputs**:
    - ``pool``: A pointer to an array of `treap_ele_t` structures where priorities will be assigned.
    - ``lo``: The lower bound index for the current recursive call.
    - ``hi``: The upper bound index for the current recursive call.
    - ``prio``: The priority value to assign to the current element.
- **Logic and Control Flow**:
    - Calculate the midpoint `mid` using the geometric mean of `lo` and `hi`.
    - Check if `mid` is strictly between `lo` and `hi`.
    - If true, assign the priority `prio` to the element at `mid-1` in the `pool`.
    - Recursively call `seed_recursive` for the left subrange `[lo, mid)` with a decremented priority.
    - Recursively call `seed_recursive` for the right subrange `[mid, hi)` with a decremented priority.
- **Output**: No return value; modifies the `pool` array in place by setting priorities.


---
### fd\_wsample\_new\_init<!-- {{#callable:fd_wsample_new_init}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.c#L272>)

Initializes a weighted sampling structure in shared memory with specified parameters.
- **Inputs**:
    - ``shmem``: Pointer to the shared memory where the sampling structure will be initialized.
    - ``rng``: Pointer to a random number generator of type `fd_chacha_rng_t`.
    - ``ele_cnt``: Number of elements to be managed by the sampling structure.
    - ``restore_enabled``: Flag indicating if the restore feature is enabled (non-zero value) or not (zero value).
    - ``opt_hint``: Optional hint for future use, currently not utilized in the function.
- **Logic and Control Flow**:
    - Checks if `shmem` is NULL and logs a warning if true, returning NULL.
    - Verifies if `shmem` is aligned according to `fd_wsample_align()` and logs a warning if misaligned, returning NULL.
    - Calls [`compute_height`](<#compute_height>) to determine the height and internal node count based on `ele_cnt`; logs a warning and returns NULL if it fails.
    - Initializes the `fd_wsample_t` structure at `shmem` with default values and parameters provided.
    - Sets the `tree` array in the structure to zero using `fd_memset`.
    - Ignores `opt_hint` as it is not used in the current implementation.
    - Returns the `shmem` pointer after successful initialization.
- **Output**: Returns a pointer to the initialized shared memory (`shmem`) or NULL if an error occurs.
- **Functions Called**:
    - [`fd_wsample_align`](<#fd_wsample_align>)
    - [`compute_height`](<#compute_height>)


---
### fd\_wsample\_new\_add<!-- {{#callable:fd_wsample_new_add}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.c#L314>)

Adds a new weighted entry to a weighted sampling structure and updates the internal tree structure accordingly.
- **Inputs**:
    - ``shmem``: A pointer to shared memory where the weighted sampling structure (`fd_wsample_t`) is stored.
    - ``weight``: The weight of the new entry to add to the sampling structure.
- **Logic and Control Flow**:
    - Cast `shmem` to a `fd_wsample_t` pointer named `sampler`.
    - Check if `sampler` is NULL; if so, return NULL.
    - Check if `weight` is zero; if so, log a warning and return NULL.
    - Check if adding `weight` to `sampler->total_weight` would cause an overflow; if so, log a warning and return NULL.
    - Calculate the index `i` as the sum of `sampler->internal_node_cnt` and `sampler->unremoved_cnt`.
    - Iterate over the height of the tree (`sampler->height`):
    -   - Calculate the `parent` index and `child_idx` for the current node.
    -   - Update the `left_sum` values of the parent node's children by adding `weight` to each relevant position.
    -   - Update `i` to the `parent` index for the next iteration.
    - Increment `sampler->unremoved_cnt`, `sampler->total_cnt`, `sampler->unremoved_weight`, and `sampler->total_weight` by `weight`.
    - Return the `shmem` pointer.
- **Output**: Returns the `shmem` pointer if successful, or NULL if an error occurs.


---
### fd\_wsample\_new\_fini<!-- {{#callable:fd_wsample_new_fini}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.c#L347>)

Finalizes the initialization of a weighted sampler by setting a poisoned weight and optionally copying the tree structure for fast restoration.
- **Inputs**:
    - ``shmem``: A pointer to shared memory where the sampler is stored.
    - ``poisoned_weight``: An unsigned long integer representing the weight to be added to the sampler as poisoned weight.
- **Logic and Control Flow**:
    - Cast `shmem` to a `fd_wsample_t` pointer named `sampler`.
    - Check if `sampler` is NULL; if so, return NULL.
    - Check if adding `poisoned_weight` to `sampler->total_weight` causes an overflow; if so, log a warning and return NULL.
    - Set `sampler->poisoned_weight` to `poisoned_weight`.
    - If `sampler->restore_enabled` is true, copy the tree structure to facilitate fast restoration.
    - Return the `sampler` pointer.
- **Output**: Returns a pointer to the `fd_wsample_t` structure if successful, or NULL if an error occurs.


---
### fd\_wsample\_leave<!-- {{#callable:fd_wsample_leave}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.c#L368>)

Returns the `sampler` pointer if it is not NULL, otherwise logs a warning and returns NULL.
- **Inputs**:
    - ``sampler``: A pointer to an `fd_wsample_t` structure, which represents a weighted sampling data structure.
- **Logic and Control Flow**:
    - Check if `sampler` is NULL using `FD_UNLIKELY`.
    - If `sampler` is NULL, log a warning message 'NULL sampler' using `FD_LOG_WARNING` and return NULL.
    - If `sampler` is not NULL, cast it to a `void *` and return it.
- **Output**: A `void *` pointer to the `sampler` if it is not NULL, otherwise NULL.


---
### fd\_wsample\_delete<!-- {{#callable:fd_wsample_delete}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.c#L378>)

Validates and returns a pointer to shared memory if it is non-null and properly aligned.
- **Inputs**:
    - ``shmem``: A pointer to shared memory that the function will validate.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL using `FD_UNLIKELY`; if true, log a warning and return NULL.
    - Check if `shmem` is aligned using `fd_ulong_is_aligned` and [`fd_wsample_align`](<#fd_wsample_align>); if not aligned, log a warning and return NULL.
    - Return the `shmem` pointer if all checks pass.
- **Output**: Returns the `shmem` pointer if it is valid and aligned, otherwise returns NULL.
- **Functions Called**:
    - [`fd_wsample_align`](<#fd_wsample_align>)


---
### fd\_wsample\_get\_rng<!-- {{#callable:fd_wsample_get_rng}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.c#L394>)

Retrieves the random number generator (`rng`) associated with a given `fd_wsample_t` sampler.
- **Inputs**:
    - `sampler`: A pointer to an `fd_wsample_t` structure from which the random number generator is to be retrieved.
- **Logic and Control Flow**:
    - Accesses the `rng` member of the `fd_wsample_t` structure pointed to by `sampler`.
    - Returns the value of the `rng` member.
- **Output**: A pointer to an `fd_chacha_rng_t` structure, which is the random number generator associated with the given sampler.


---
### fd\_wsample\_seed\_rng<!-- {{#callable:fd_wsample_seed_rng}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.c#L398>)

Initializes a ChaCha20 random number generator with a given seed.
- **Inputs**:
    - `rng`: A pointer to an `fd_chacha_rng_t` structure that represents the random number generator to initialize.
    - `seed`: An array of 32 unsigned characters that provides the seed for the random number generator.
- **Logic and Control Flow**:
    - Calls the `fd_chacha20_rng_init` function with `rng` and `seed` as arguments to initialize the random number generator.
- **Output**: No output is returned as the function is of type `void`.


---
### fd\_wsample\_restore\_all<!-- {{#callable:fd_wsample_restore_all}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.c#L405>)

Restores all elements in the `fd_wsample_t` sampler to their initial state if restoration is enabled.
- **Inputs**:
    - `sampler`: A pointer to an `fd_wsample_t` structure representing the sampler to restore.
- **Logic and Control Flow**:
    - Check if `restore_enabled` is false; if so, return `NULL`.
    - Set `unremoved_weight` to `total_weight` and `unremoved_cnt` to `total_cnt`.
    - Set `poisoned_mode` to 0.
    - Copy the initial state of the tree from the backup location to the active location using `fd_memcpy`.
    - Return the `sampler` pointer.
- **Output**: Returns the pointer to the restored `fd_wsample_t` sampler, or `NULL` if restoration is not enabled.


---
### fd\_wsample\_map\_sample\_i<!-- {{#callable:fd_wsample_map_sample_i}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.c#L433>)

Selects a sample from a weighted tree structure based on a query value and returns the index and weight of the selected sample.
- **Inputs**:
    - `sampler`: A pointer to a `fd_wsample_t` structure representing the weighted sample tree.
    - `query`: An unsigned long integer representing the query value, which should be in the range [0, unremoved_weight).
- **Logic and Control Flow**:
    - Initialize `cursor` to 0 and `S` to the total unremoved weight from the sampler.
    - Iterate over the height of the tree, using the current `cursor` to access the current node in the tree.
    - For each node, determine the child index by comparing the query value against the cumulative left sums of the node's children.
    - Adjust the query value by subtracting the cumulative sum of the children to the left of the chosen child.
    - Update `S` to the weight of the chosen subtree and update `cursor` to point to the chosen child node.
    - After traversing the tree, calculate the index of the selected sample by subtracting the number of internal nodes from `cursor`.
    - Return an `idxw_pair_t` structure containing the index and weight of the selected sample.
- **Output**: An `idxw_pair_t` structure containing the index and weight of the selected sample.


---
### fd\_wsample\_map\_sample<!-- {{#callable:fd_wsample_map_sample}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.c#L480>)

Returns the index of a sampled element from a weighted sample map.
- **Inputs**:
    - `sampler`: A pointer to an `fd_wsample_t` structure representing the weighted sample map.
    - `query`: An unsigned long integer representing the query value used to sample from the map.
- **Logic and Control Flow**:
    - Calls the function [`fd_wsample_map_sample_i`](<#fd_wsample_map_sample_i>) with `sampler` and `query` as arguments.
    - Accesses the `idx` field of the returned `idxw_pair_t` structure from [`fd_wsample_map_sample_i`](<#fd_wsample_map_sample_i>).
    - Returns the `idx` value.
- **Output**: An unsigned long integer representing the index of the sampled element.
- **Functions Called**:
    - [`fd_wsample_map_sample_i`](<#fd_wsample_map_sample_i>)


---
### fd\_wsample\_remove<!-- {{#callable:fd_wsample_remove}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.c#L489>)

Removes a specified element from a weighted sampling tree and updates the tree structure accordingly.
- **Inputs**:
    - ``sampler``: A pointer to an `fd_wsample_t` structure representing the weighted sampling tree.
    - ``to_remove``: An `idxw_pair_t` structure containing the index and weight of the element to remove.
- **Logic and Control Flow**:
    - Calculate the initial `cursor` position by adding `to_remove.idx` to `sampler->internal_node_cnt`.
    - Access the `tree` array from the `sampler` structure.
    - Iterate over the height of the tree using a loop.
    - In each iteration, calculate the `parent` node index and `child_idx` within the parent node.
    - Depending on the compilation flags and conditions, update the `left_sum` array of the `parent` node to subtract the weight of the `to_remove` element from the appropriate positions.
    - Update the `cursor` to the `parent` node index for the next iteration.
    - After the loop, decrement `sampler->unremoved_cnt` and subtract `to_remove.weight` from `sampler->unremoved_weight`.
- **Output**: No return value; the function modifies the `sampler` structure in place.


---
### fd\_wsample\_find\_weight<!-- {{#callable:fd_wsample_find_weight}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.c#L525>)

Finds the weight of a specific element in a weighted sampling tree without explicitly storing the weights.
- **Inputs**:
    - ``sampler``: A pointer to a `fd_wsample_t` structure representing the weighted sampling tree.
    - ``idx``: An unsigned long integer representing the index of the element whose weight is to be found, within the range [0, total_cnt).
- **Logic and Control Flow**:
    - Initialize `tree` to point to the `tree` array in the `sampler` structure.
    - Set `cursor` to `idx` plus the number of internal nodes in the tree (`sampler->internal_node_cnt`).
    - Initialize `lm1` to 0 and `li` to the total unremoved weight (`sampler->unremoved_weight`).
    - Iterate over the height of the tree (`sampler->height`):
    - Calculate `parent` as the integer division of `cursor-1` by `R`.
    - Calculate `child_idx` as `cursor-1` minus `R` times `parent`.
    - Add the left sum of the current child to `lm1` if `child_idx` is greater than 0.
    - If `child_idx` is less than `R-1`, set `li` to the left sum of the current child and break the loop.
    - Update `cursor` to `parent` to continue traversing up the tree if necessary.
    - Return the difference between `li` and `lm1` as the weight of the element.
- **Output**: Returns the weight of the element at the specified index as an unsigned long integer.


---
### fd\_wsample\_remove\_idx<!-- {{#callable:fd_wsample_remove_idx}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.c#L556>)

Removes an element from a weighted sample at a specified index.
- **Inputs**:
    - ``sampler``: A pointer to an `fd_wsample_t` structure representing the weighted sample from which an element will be removed.
    - ``idx``: An unsigned long integer representing the index of the element to remove from the weighted sample.
- **Logic and Control Flow**:
    - Finds the weight of the element at the specified index using [`fd_wsample_find_weight`](<#fd_wsample_find_weight>).
    - Creates an `idxw_pair_t` structure `r` with the index and weight of the element to remove.
    - Calls [`fd_wsample_remove`](<#fd_wsample_remove>) with the `sampler` and `r` to remove the element from the weighted sample.
- **Output**: This function does not return a value; it modifies the `sampler` in place by removing the specified element.
- **Functions Called**:
    - [`fd_wsample_find_weight`](<#fd_wsample_find_weight>)
    - [`fd_wsample_remove`](<#fd_wsample_remove>)


---
### fd\_wsample\_sample\_many<!-- {{#callable:fd_wsample_sample_many}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.c#L719>)

Samples multiple indices from a weighted sampler and stores them in an array.
- **Inputs**:
    - ``sampler``: A pointer to an `fd_wsample_t` structure, which represents the weighted sampler from which indices are sampled.
    - ``idxs``: A pointer to an array of `ulong` where the sampled indices will be stored.
    - ``cnt``: The number of indices to sample and store in the `idxs` array.
- **Logic and Control Flow**:
    - Iterates over a loop `cnt` times.
    - In each iteration, calls [`fd_wsample_sample`](<#fd_wsample_sample>) with `sampler` to get a sampled index.
    - Stores the sampled index in the `idxs` array at the current loop index.
- **Output**: The function does not return a value; it modifies the `idxs` array in place to store the sampled indices.
- **Functions Called**:
    - [`fd_wsample_sample`](<#fd_wsample_sample>)


---
### fd\_wsample\_sample\_and\_remove\_many<!-- {{#callable:fd_wsample_sample_and_remove_many}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.c#L726>)

Samples and removes multiple elements from a weighted sampler, updating the provided indices array with the results.
- **Inputs**:
    - ``sampler``: A pointer to an `fd_wsample_t` structure representing the weighted sampler from which elements are sampled and removed.
    - ``idxs``: A pointer to an array of `ulong` where the function will store the indices of the sampled elements.
    - ``cnt``: The number of elements to sample and remove from the sampler.
- **Logic and Control Flow**:
    - Iterates over the range from 0 to `cnt` to sample and remove elements.
    - Checks if `sampler->unremoved_weight` is zero, setting `idxs[i]` to `FD_WSAMPLE_EMPTY` and continuing if true.
    - Checks if `sampler->poisoned_mode` is active, setting `idxs[i]` to `FD_WSAMPLE_INDETERMINATE` and continuing if true.
    - Generates a random number `unif` using `fd_chacha20_rng_ulong_roll` with the sum of `unremoved_weight` and `poisoned_weight`.
    - If `unif` is greater than or equal to `unremoved_weight`, sets `idxs[i]` to `FD_WSAMPLE_INDETERMINATE`, activates `poisoned_mode`, and continues.
    - If `FD_WSAMPLE_IMPLEMENTATION` is greater than 0 and `sampler->height` is 4, performs a series of operations to traverse and propagate through the sampler's tree structure, finalizing the index and updating `idxs[i]`.
    - If the above condition is not met, calls [`fd_wsample_map_sample_i`](<#fd_wsample_map_sample_i>) to map the sample index and [`fd_wsample_remove`](<#fd_wsample_remove>) to remove the sampled element, updating `idxs[i]` with the index.
- **Output**: The function does not return a value; it updates the `idxs` array with the indices of the sampled elements.
- **Functions Called**:
    - [`fd_wsample_map_sample_i`](<#fd_wsample_map_sample_i>)
    - [`fd_wsample_remove`](<#fd_wsample_remove>)


---
### fd\_wsample\_sample<!-- {{#callable:fd_wsample_sample}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.c#L770>)

Selects a sample from a weighted sampler, considering unremoved and poisoned weights, and returns the index of the selected sample.
- **Inputs**:
    - `sampler`: A pointer to an `fd_wsample_t` structure representing the weighted sampler from which to draw a sample.
- **Logic and Control Flow**:
    - Check if `sampler->unremoved_weight` is zero; if true, return `FD_WSAMPLE_EMPTY`.
    - Check if `sampler->poisoned_mode` is true; if true, return `FD_WSAMPLE_INDETERMINATE`.
    - Generate a random number `unif` using `fd_chacha20_rng_ulong_roll` with the range of `sampler->unremoved_weight + sampler->poisoned_weight`.
    - Check if `unif` is greater than or equal to `sampler->unremoved_weight`; if true, return `FD_WSAMPLE_INDETERMINATE`.
    - Call [`fd_wsample_map_sample`](<#fd_wsample_map_sample>) with `sampler` and `unif` to get the index of the selected sample and return it.
- **Output**: Returns an `ulong` representing the index of the selected sample, or special values `FD_WSAMPLE_EMPTY` or `FD_WSAMPLE_INDETERMINATE` under certain conditions.
- **Functions Called**:
    - [`fd_wsample_map_sample`](<#fd_wsample_map_sample>)


---
### fd\_wsample\_sample\_and\_remove<!-- {{#callable:fd_wsample_sample_and_remove}} -->
[View Source →](<../../../../../src/ballet/wsample/fd_wsample.c#L779>)

Samples and removes an element from a weighted sample structure, updating the structure accordingly.
- **Inputs**:
    - ``sampler``: A pointer to an `fd_wsample_t` structure, which contains the weighted sample data and state.
- **Logic and Control Flow**:
    - Check if `sampler->unremoved_weight` is zero; if true, return `FD_WSAMPLE_EMPTY`.
    - Check if `sampler->poisoned_mode` is set; if true, return `FD_WSAMPLE_INDETERMINATE`.
    - Generate a random number `unif` using `fd_chacha20_rng_ulong_roll` with the sum of `sampler->unremoved_weight` and `sampler->poisoned_weight`.
    - If `unif` is greater than or equal to `sampler->unremoved_weight`, set `sampler->poisoned_mode` to 1 and return `FD_WSAMPLE_INDETERMINATE`.
    - If `FD_WSAMPLE_IMPLEMENTATION` is greater than 0 and `sampler->height` is 4, perform a series of operations using macros `PREPARE`, `TRAVERSE_LEVEL`, `PROPAGATE_LEVEL`, and `FINALIZE` to sample and remove an element efficiently.
    - If the above condition is not met, use [`fd_wsample_map_sample_i`](<#fd_wsample_map_sample_i>) to map the sample index and weight, then call [`fd_wsample_remove`](<#fd_wsample_remove>) to remove the sampled element.
    - Return the index of the sampled element.
- **Output**: Returns the index of the sampled and removed element, or a special value (`FD_WSAMPLE_EMPTY` or `FD_WSAMPLE_INDETERMINATE`) if the operation cannot be completed.
- **Functions Called**:
    - [`fd_wsample_map_sample_i`](<#fd_wsample_map_sample_i>)
    - [`fd_wsample_remove`](<#fd_wsample_remove>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)