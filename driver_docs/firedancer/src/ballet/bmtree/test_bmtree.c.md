<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for the construction and verification of binary Merkle trees using 20-byte and 32-byte nodes.

# Purpose
The code is a C program designed to test the functionality of a binary Merkle tree implementation. It includes functions to construct and verify Merkle trees, specifically focusing on 20-byte and 32-byte hash trees. The program uses the `fd_bmtree_commit` and `fd_bmtree_commitp` functions to build trees and verify their roots against expected values. It also tests the inclusion proofs, ensuring that the proofs can be generated and verified correctly. The code imports binary data for reference proofs and uses them to validate the correctness of the tree operations.

The main function initializes the testing environment and performs a series of tests on the Merkle tree implementation. It checks the alignment and footprint of the tree, iterates over different leaf counts to test tree depth and node count calculations, and verifies the construction of trees with specific sizes. The program also benchmarks the performance of the tree construction process. Additionally, it includes a test for a 32-byte tree using predefined leaf data and compares the computed root against an expected SHA-256 hash. The program logs the results of the tests and halts execution upon completion.
# Imports and Dependencies

---
- `../fd_ballet.h`
- `../sha256/fd_sha256.h`


# Global Variables

---
### memory
- **Type**: `uchar array`
- **Description**: An array of unsigned characters with a size defined by `MEMORY_SZ`, which is 70 megabytes. The array is aligned according to `FD_BMTREE_COMMIT_ALIGN`.
- **Use**: Used as a memory buffer for operations related to binary merkle tree (bmtree) commits.


---
### inc\_proof
- **Type**: `uchar`
- **Description**: An array of unsigned characters with a size of 2016 bytes, calculated as 63 multiplied by 32.
- **Use**: Stores inclusion proofs for a binary Merkle tree.


# Functions

---
### test\_bmtree20\_commit<!-- {{#callable:test_bmtree20_commit}} -->
[View Source →](<../../../../../src/ballet/bmtree/test_bmtree.c#L15>)

Tests the construction and validation of a 20-byte Merkle tree with a specified number of leaves and compares the computed root with an expected root.
- **Inputs**:
    - `leaf_cnt`: The number of leaves to include in the Merkle tree.
    - `expected_root`: A pointer to the expected root hash of the Merkle tree for comparison.
- **Logic and Control Flow**:
    - Initialize a Merkle tree with a depth of 20, a single leaf per node, and no additional options.
    - Set the hash of a leaf node to zero and iterate over the number of leaves specified by `leaf_cnt`.
    - For each leaf, verify the current leaf count, store the leaf index in the leaf's hash, and append the leaf to the tree.
    - After all leaves are appended, verify the final leaf count matches `leaf_cnt`.
    - Finalize the tree to compute the root hash and verify it is not null.
    - Compare the computed root hash with the `expected_root` and log an error if they do not match.
- **Output**: No return value; the function logs errors if the computed root does not match the expected root.


---
### test\_bmtree20\_commitp<!-- {{#callable:test_bmtree20_commitp}} -->
[View Source →](<../../../../../src/ballet/bmtree/test_bmtree.c#L43>)

Tests the insertion of leaves into a binary Merkle tree and verifies the computed root against an expected root.
- **Inputs**:
    - ``leaf_cnt``: The number of leaves to insert into the binary Merkle tree.
    - ``expected_root``: A pointer to the expected root hash of the binary Merkle tree after all leaves are inserted.
- **Logic and Control Flow**:
    - Check if the memory footprint for the tree is within the allowed size using `fd_bmtree_commit_footprint` and `fd_bmtree_depth`.
    - Initialize a binary Merkle tree with `fd_bmtree_commit_init` using the specified depth derived from `leaf_cnt`.
    - Log the number of leaves (`leaf_cnt`).
    - Iterate over even indices from 0 to `leaf_cnt`, set the hash of the leaf node to the index, and insert it into the tree using `fd_bmtree_commitp_insert_with_proof`.
    - Iterate over odd indices from 1 to `leaf_cnt`, set the hash of the leaf node to the index, and insert it into the tree using `fd_bmtree_commitp_insert_with_proof`.
    - Finalize the tree with `fd_bmtree_commitp_fini` to compute the root hash.
    - Verify that the computed root hash matches the `expected_root` using `fd_memeq`.
- **Output**: No explicit return value; the function uses assertions (`FD_TEST`) to validate operations and will log errors if any checks fail.


---
### hash\_leaf<!-- {{#callable:hash_leaf}} -->
[View Source →](<../../../../../src/ballet/bmtree/test_bmtree.c#L71>)

Validates that the `fd_bmtree_hash_leaf` function correctly hashes a leaf node using a given string.
- **Inputs**:
    - ``leaf``: A pointer to an `fd_bmtree_node_t` structure where the hash result will be stored.
    - ``leaf_cstr``: A constant character pointer to the string that will be hashed.
- **Logic and Control Flow**:
    - Calls the `fd_bmtree_hash_leaf` function with the `leaf`, `leaf_cstr`, the length of `leaf_cstr`, and a constant value `1UL` as arguments.
    - Uses `FD_TEST` to assert that the result of `fd_bmtree_hash_leaf` is equal to the `leaf` pointer, ensuring the hash operation was successful.
- **Output**: No direct output; the function performs an assertion to validate the hash operation.


---
### test\_inclusion<!-- {{#callable:test_inclusion}} -->
[View Source →](<../../../../../src/ballet/bmtree/test_bmtree.c#L78>)

Verifies the inclusion of leaves in a binary Merkle tree by constructing proofs and checking their validity.
- **Inputs**:
    - `leaf_cnt`: The number of leaves in the binary Merkle tree to test.
- **Logic and Control Flow**:
    - Initialize constants and memory for the tree and proof structures.
    - Check that the tree depth does not exceed 9 for the given number of leaves.
    - Initialize two binary Merkle trees, `tree` and `ptree`, with the specified parameters.
    - Iterate over each leaf index from 0 to `leaf_cnt - 1`.
    - For each leaf, append it to the `tree` and verify the leaf count matches the index.
    - Finalize the `tree` to obtain the root hash.
    - For each leaf, generate a proof and verify it against the root hash.
    - Insert the leaf into `ptree` using the proof and verify the resulting root hash matches the original root hash.
    - Corrupt the proof, root, and leaf in various ways to test the robustness of the proof verification process.
    - Finalize the `ptree` and verify the final root hash matches the original root hash.
    - Attempt to generate a proof for a non-existent leaf index and verify it fails.
- **Output**: No return value; the function uses assertions to verify the correctness of the tree inclusion proofs.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/ballet/bmtree/test_bmtree.c#L136>)

Executes a series of tests and benchmarks on binary Merkle tree operations, including depth and node count calculations, tree construction, and proof verification.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Performs internal checks on `fd_bmtree_commit_align` and `fd_bmtree_commit_footprint`.
    - Tests `fd_bmtree_depth` and `fd_bmtree_node_cnt` functions against a naive division algorithm for various leaf counts.
    - Constructs and tests 20-byte trees using [`test_bmtree20_commit`](<#test_bmtree20_commit>) and [`test_bmtree20_commitp`](<#test_bmtree20_commitp>) for different leaf counts and expected roots.
    - Benchmarks the [`test_bmtree20_commit`](<#test_bmtree20_commit>) function with a large number of leaves and logs the performance.
    - Constructs a 32-byte tree, hashes a set of strings into leaves, and verifies the tree's root against an expected value.
    - Initializes another tree, appends leaves, and verifies proofs against reference data.
    - Logs a success message and calls `fd_halt` to terminate the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`test_inclusion`](<#test_inclusion>)
    - [`test_bmtree20_commit`](<#test_bmtree20_commit>)
    - [`test_bmtree20_commitp`](<#test_bmtree20_commitp>)
    - [`hash_leaf`](<#hash_leaf>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)