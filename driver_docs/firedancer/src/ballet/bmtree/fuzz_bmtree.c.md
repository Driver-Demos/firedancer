<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Fuzz testing implementation for binary Merkle trees with memory management and proof verification.

# Purpose
The code is a fuzz testing suite for a binary Merkle tree implementation. It is designed to test the integrity and correctness of the `fd_bmtree` functions by simulating various scenarios, including normal operations and error conditions. The code initializes a fuzzing environment using [`LLVMFuzzerInitialize`](<#llvmfuzzerinitialize>), which sets up the necessary environment variables and logging configurations. The main fuzzing function, [`LLVMFuzzerTestOneInput`](<#llvmfuzzertestoneinput>), processes input data to create a test structure that includes a count of leaf nodes and their hashes. It then calls the [`fuzz_bmtree`](<#fuzz_bmtree>) function to perform operations on the Merkle tree, such as appending leaf nodes, committing to the tree, and verifying proofs.

The [`fuzz_bmtree`](<#fuzz_bmtree>) function is responsible for creating and manipulating two Merkle trees using the provided leaf nodes. It checks memory constraints and ensures that the operations do not exceed predefined limits. The function verifies the correctness of the tree operations by comparing the computed roots and proofs. It also intentionally corrupts data to test the tree's ability to detect and handle errors. The code uses assertions to validate the expected outcomes of each operation, ensuring that the tree behaves as intended under various conditions. This fuzz testing suite is crucial for identifying potential vulnerabilities and ensuring the robustness of the Merkle tree implementation.
# Imports and Dependencies

---
- `assert.h`
- `stdio.h`
- `stdlib.h`
- `../../util/fd_util.h`
- `../../util/sanitize/fd_fuzz.h`
- `fd_bmtree.h`


# Global Variables

---
### memory1
- **Type**: ``uchar[]``
- **Description**: An array of unsigned characters with a size defined by the `MEMORY_SZ` macro, which is set to 70 megabytes. This array is used to store data related to the first binary Merkle tree in the `fuzz_bmtree` function.
- **Use**: Used as a memory buffer to initialize and manage the first binary Merkle tree during the fuzz testing process.


---
### memory2
- **Type**: ``uchar[]``
- **Description**: An array of unsigned characters with a size defined by the `MEMORY_SZ` macro, which is set to 70 megabytes. This array is used to store data related to the second binary Merkle tree in the `fuzz_bmtree` function.
- **Use**: Stores memory for the second binary Merkle tree during the fuzz testing process.


---
### inc\_proof
- **Type**: ``uchar` array`
- **Description**: An array of unsigned characters with a size of 32 times the maximum depth minus one. The array is used to store incremental proofs for binary Merkle tree operations.
- **Use**: Used to store incremental proofs during the construction and verification of binary Merkle trees in the `fuzz_bmtree` function.


# Data Structures

---
### bmtree\_test
- **Type**: ``struct``
- **Members**:
    - ``leaf_cnt``: Stores the number of leaves in the tree.
    - ``leaf_hashes``: An array of hashes for the leaves.
- **Description**: Defines a structure for testing binary Merkle trees, containing a count of leaves and an array for storing their hashes.


---
### bmtree\_test\_t
- **Type**: ``struct``
- **Members**:
    - ``leaf_cnt``: Stores the number of leaves in the binary Merkle tree.
    - ``leaf_hashes``: An array of hashes for the leaves in the binary Merkle tree.
- **Description**: Defines a structure for testing binary Merkle trees, containing a count of leaves and an array of leaf hashes.


# Functions

---
### LLVMFuzzerInitialize<!-- {{#callable:LLVMFuzzerInitialize}} -->
[View Source →](<../../../../../src/ballet/bmtree/fuzz_bmtree.c#L21>)

Initializes the fuzzer environment by setting environment variables, booting the system, registering an exit function, and setting the log level.
- **Inputs**:
    - `pargc`: A pointer to an integer representing the argument count.
    - `pargv`: A pointer to an array of strings representing the argument values.
- **Logic and Control Flow**:
    - Set the environment variable `FD_LOG_BACKTRACE` to `0` to disable backtraces in logs.
    - Call `fd_boot` with `pargc` and `pargv` to initialize the system.
    - Register `fd_halt` to be called on program exit using `atexit`.
    - Set the core log level to `3` using `fd_log_level_core_set`, which causes the program to crash on warning logs.
    - Return `0` to indicate successful initialization.
- **Output**: Returns `0` to indicate successful initialization.


---
### fuzz\_bmtree<!-- {{#callable:fuzz_bmtree}} -->
[View Source →](<../../../../../src/ballet/bmtree/fuzz_bmtree.c#L32>)

Validates the integrity of a binary Merkle tree by constructing two trees and comparing their roots.
- **Inputs**:
    - ``leafs``: Pointer to an array of `fd_bmtree_node_t` structures representing the leaf nodes of the tree.
    - ``leaf_cnt``: Number of leaf nodes in the tree.
    - ``hash_sz``: Size of the hash used in the tree.
    - ``prefix_sz``: Size of the prefix used in the tree.
- **Logic and Control Flow**:
    - Calculate the depth of the tree using [`fd_bmtree_depth`](<fd_bmtree.c.md#fd_bmtree_depth>) and check if it exceeds `MAX_DEPTH`; return -1 if it does.
    - Calculate the memory footprint required for the tree using [`fd_bmtree_commit_footprint`](<fd_bmtree.c.md#fd_bmtree_commit_footprint>) and check for memory overflows.
    - Initialize the first tree using [`fd_bmtree_commit_init`](<fd_bmtree.c.md#fd_bmtree_commit_init>) and append all leaf nodes to it using [`fd_bmtree_commit_append`](<fd_bmtree.c.md#fd_bmtree_commit_append>).
    - Finalize the first tree with [`fd_bmtree_commit_fini`](<fd_bmtree.c.md#fd_bmtree_commit_fini>) to get the root hash `root_1`.
    - Initialize the second tree using [`fd_bmtree_commit_init`](<fd_bmtree.c.md#fd_bmtree_commit_init>) with the calculated depth.
    - For each leaf, retrieve the proof using [`fd_bmtree_get_proof`](<fd_bmtree.c.md#fd_bmtree_get_proof>) and verify it using [`fd_bmtree_from_proof`](<fd_bmtree.c.md#fd_bmtree_from_proof>).
    - Insert the leaf into the second tree with [`fd_bmtree_commitp_insert_with_proof`](<fd_bmtree.c.md#fd_bmtree_commitp_insert_with_proof>) and verify the root hash matches `root_1`.
    - Introduce errors in the proof, root, and leaf to test the integrity checks and ensure they fail as expected.
    - Finalize the second tree with [`fd_bmtree_commitp_fini`](<fd_bmtree.c.md#fd_bmtree_commitp_fini>) and verify that its root matches `root_1`.
- **Output**: Returns 0 if the trees are consistent and -1 if any error occurs during the process.
- **Functions Called**:
    - [`fd_bmtree_depth`](<fd_bmtree.c.md#fd_bmtree_depth>)
    - [`fd_bmtree_commit_footprint`](<fd_bmtree.c.md#fd_bmtree_commit_footprint>)
    - [`fd_bmtree_commit_init`](<fd_bmtree.c.md#fd_bmtree_commit_init>)
    - [`fd_bmtree_commit_leaf_cnt`](<fd_bmtree.h.md#fd_bmtree_commit_leaf_cnt>)
    - [`fd_bmtree_commit_append`](<fd_bmtree.c.md#fd_bmtree_commit_append>)
    - [`fd_bmtree_commit_fini`](<fd_bmtree.c.md#fd_bmtree_commit_fini>)
    - [`fd_bmtree_get_proof`](<fd_bmtree.c.md#fd_bmtree_get_proof>)
    - [`fd_bmtree_from_proof`](<fd_bmtree.c.md#fd_bmtree_from_proof>)
    - [`fd_bmtree_commitp_insert_with_proof`](<fd_bmtree.c.md#fd_bmtree_commitp_insert_with_proof>)
    - [`fd_bmtree_commitp_fini`](<fd_bmtree.c.md#fd_bmtree_commitp_fini>)


---
### LLVMFuzzerTestOneInput<!-- {{#callable:LLVMFuzzerTestOneInput}} -->
[View Source →](<../../../../../src/ballet/bmtree/fuzz_bmtree.c#L156>)

Tests a binary Merkle tree implementation using fuzzing techniques with given input data.
- **Inputs**:
    - `data`: A pointer to the input data, expected to be a `bmtree_test_t` structure.
    - `size`: The size of the input data in bytes.
- **Logic and Control Flow**:
    - Check if `size` is less than the size of `bmtree_test_t`; if true, return -1.
    - Cast `data` to a `bmtree_test_t` pointer and calculate `leaf_cnt` as the modulo of `test->leaf_cnt` with `MAX_LEAF_CNT` plus 1.
    - Check if `size` is less than the combined size of `bmtree_test_t` and the calculated number of leaf nodes; if true, return -1.
    - Cast `test->leaf_hashes` to a pointer to `fd_bmtree_node_t` for the leaf nodes.
    - Call [`fuzz_bmtree`](<#fuzz_bmtree>) with the leaf nodes, `leaf_cnt`, a hash size of 32, and `FD_BMTREE_SHORT_PREFIX_SZ`; if the result is not 0, return the result.
    - Call [`fuzz_bmtree`](<#fuzz_bmtree>) again with the same leaf nodes and `leaf_cnt`, but with a hash size of 20 and `FD_BMTREE_LONG_PREFIX_SZ`.
    - Return the result of the second [`fuzz_bmtree`](<#fuzz_bmtree>) call.
- **Output**: Returns 0 if the fuzzing tests pass without errors, or a non-zero error code if a test fails.
- **Functions Called**:
    - [`fuzz_bmtree`](<#fuzz_bmtree>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)