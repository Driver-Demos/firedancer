<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

APIs for BLAKE3 hashing with SIMD parallelism, supporting variable output sizes and batch processing.

# Purpose
The `fd_blake3.h` file is a C header file that provides an interface for the BLAKE3 cryptographic hash function. It defines the necessary data structures, constants, and function prototypes to perform BLAKE3 hashing operations. The file includes support for both simple and batched hashing modes, allowing for efficient processing of input data using SIMD parallelism when available. The header file specifies the use of different hash backends (SSE, AVX2, AVX512) to optimize performance based on the hardware capabilities.

The file defines several constants related to the BLAKE3 protocol, such as block size, chunk size, and output chaining value size. It also includes implementation-specific constants to manage memory alignment and buffer sizes. The main data structures include `fd_blake3_t`, which represents the state of a BLAKE3 hash calculation, and `fd_blake3_pos_t` and `fd_blake3_buf_t`, which manage the internal state and intermediate results of the hash tree construction. The file provides function prototypes for initializing, appending data to, and finalizing a BLAKE3 hash calculation, as well as for creating and managing hash state objects. Additionally, it includes functions for performing batched hash operations and reducing outputs using LtHash group-add arithmetic.
# Imports and Dependencies

---
- `../fd_ballet_base.h`
- `../../util/simd/fd_avx.h`


# Data Structures

---
### fd\_blake3\_pos
- **Type**: ``struct``
- **Members**:
    - ``tail``: Tracks the number of nodes already hashed into the next layer.
    - ``head``: Tracks the number of nodes buffered for each tree layer.
    - ``leaf_idx``: Counts the number of leaf chunks processed so far.
    - ``live_cnt``: Counts the number of nodes with buffered output chaining values awaiting processing.
    - ``next_tick``: Tracks relative time for scheduling batch operation completion.
    - ``layer``: Indicates the tree layer the scheduler will work on next.
    - ``_pad``: Padding to align the structure.
    - ``input``: Pointer to the user-provided memory region containing the hash input.
    - ``input_sz``: Size of the input memory region.
    - ``magic``: Magic number for debugging and detecting memory corruption.
- **Description**: The `fd_blake3_pos` structure is a hash state machine used in the BLAKE3 hashing process. It tracks the progress of hash calculations across different tree layers, manages the scheduling of operations, and prepares inputs for compression function calls. The structure includes fields for tracking the number of processed leaf chunks, buffered nodes, and scheduling information, as well as pointers to the input data and its size. A magic number is included for debugging purposes.


---
### fd\_blake3\_pos\_t
- **Type**: ``struct``
- **Members**:
    - ``tail``: Tracks the number of nodes already hashed into the next layer.
    - ``head``: Tracks the number of nodes buffered for each tree layer.
    - ``leaf_idx``: Counts the number of leaf chunks processed so far.
    - ``live_cnt``: Counts the number of nodes with buffered output chaining values awaiting further processing.
    - ``next_tick``: Tracks relative time to inform scheduling when a batch of operations will complete.
    - ``layer``: Indicates the tree layer that the scheduler will work on next.
    - ``input``: Points to the user-provided memory region containing the hash input.
    - ``input_sz``: Specifies the size of the input data.
    - ``magic``: Holds a constant value for debugging and detecting memory corruption.
- **Description**: Prepares inputs for compression function calls and tracks dependencies between them. It is aligned to 128 bytes and includes fields for tracking the progress of hash calculations, such as `tail`, `head`, `leaf_idx`, `live_cnt`, `next_tick`, and `layer`. The `input` and `input_sz` fields manage the user-provided memory region for hash input, while `magic` is used for debugging purposes.


---
### fd\_blake3\_buf
- **Type**: `union`
- **Members**:
    - ``slots``: A 3D array of unsigned characters with dimensions defined by `FD_BLAKE3_ROW_CNT`, `FD_BLAKE3_COL_CNT`, and `FD_BLAKE3_OUTCHAIN_SZ`.
    - ``rows``: A 2D array of unsigned characters with dimensions defined by `FD_BLAKE3_ROW_CNT` and the product of `FD_BLAKE3_COL_CNT` and `FD_BLAKE3_OUTCHAIN_SZ`.
- **Description**: The `fd_blake3_buf` union is used to store intermediate results during the construction of a BLAKE3 hash tree. It contains two different views of the same memory: `slots`, which organizes the data in a three-dimensional array, and `rows`, which organizes the data in a two-dimensional array. This structure is aligned according to `FD_BLAKE3_ALIGN` to optimize memory access patterns during hash computations.


---
### fd\_blake3\_buf\_t
- **Type**: `union`
- **Members**:
    - ``slots``: Contains a table of output chaining values for nodes at specific tree layers, organized by row and column.
    - ``rows``: Stores a contiguous window of output chaining values for nodes at a specific tree layer, organized by row and column.
- **Description**: `fd_blake3_buf_t` is a union that holds intermediate results during the construction of a BLAKE3 hash tree. It contains two arrays, `slots` and `rows`, which store output chaining values for nodes at various tree layers. These arrays are used to manage the hash tree's structure and facilitate the parallel processing of hash operations.


---
### fd\_blake3
- **Type**: ``struct``
- **Members**:
    - ``buf``: Stores intermediate results of the hash tree construction.
    - ``block``: Holds a buffer for input data blocks up to `FD_BLAKE3_PRIVATE_BUF_MAX` size.
    - ``pos``: Tracks the state of the hash calculation, including progress and dependencies.
    - ``block_sz``: Indicates the size of the current data block being processed.
- **Description**: The `fd_blake3` structure is used to manage the state of a BLAKE3 hash calculation. It contains a buffer for intermediate hash results, a block buffer for input data, a position tracker for the hash state, and a size indicator for the current data block. This structure is essential for performing BLAKE3 hashing operations, allowing for efficient processing of input data and management of the hash calculation state.


---
### fd\_blake3\_t
- **Type**: ``struct``
- **Members**:
    - ``buf``: Contains intermediate results of hash tree construction.
    - ``block``: Stores a buffer for input data up to a maximum size.
    - ``pos``: Tracks the progress of hash calculations and prepares operations.
    - ``block_sz``: Indicates the size of the current block of data being processed.
- **Description**: `fd_blake3_t` is a structure used to manage the state of a BLAKE3 hash calculation. It includes a buffer for intermediate hash results, a block for input data, a position tracker for hash operations, and a size indicator for the current data block. This structure is designed to facilitate the hashing process by organizing and managing the necessary components for efficient computation.


# Function Declarations (Public API)

---
### fd\_blake3\_align<!-- {{#callable_declaration:fd_blake3_align}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.h#L296>)

Returns the required memory alignment for a BLAKE3 hash state.
- **Description**: Use this function to determine the memory alignment needed for a BLAKE3 hash state. This is important when allocating memory for BLAKE3 operations to ensure proper alignment and avoid potential performance issues or errors. The alignment value is a constant and does not change between calls.
- **Inputs**: None
- **Output**: Returns an unsigned long integer representing the alignment requirement in bytes.
- **See Also**: [`fd_blake3_align`](<fd_blake3.c.md#fd_blake3_align>)  (Implementation)


---
### fd\_blake3\_footprint<!-- {{#callable_declaration:fd_blake3_footprint}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.h#L304>)

Returns the memory footprint required for a BLAKE3 hash state.
- **Description**: Use this function to determine the size of memory needed to store a BLAKE3 hash state. This is useful for allocating memory when setting up a BLAKE3 hashing operation. The function does not require any initialization or prior setup and can be called at any time.
- **Inputs**: None
- **Output**: Returns an unsigned long integer representing the size in bytes of the memory footprint required for a BLAKE3 hash state.
- **See Also**: [`fd_blake3_footprint`](<fd_blake3.c.md#fd_blake3_footprint>)  (Implementation)


---
### fd\_blake3\_new<!-- {{#callable_declaration:fd_blake3_new}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.h#L307>)

Allocates and initializes a new BLAKE3 hashing state in shared memory.
- **Description**: Use this function to create a new BLAKE3 hashing state in a specified shared memory region. The shared memory must be properly aligned and have sufficient space to hold the hashing state. This function checks for null pointers and misalignment, logging warnings and returning null in such cases. It initializes the memory region for use with BLAKE3 hashing, setting up necessary state information.
- **Inputs**:
    - `shmem`: A pointer to a shared memory region where the BLAKE3 hashing state will be initialized. Must not be null and must be aligned according to `fd_blake3_align()`. If these conditions are not met, the function logs a warning and returns null.
- **Output**: Returns a pointer to the initialized BLAKE3 hashing state on success, or null if the input is invalid.
- **See Also**: [`fd_blake3_new`](<fd_blake3.c.md#fd_blake3_new>)  (Implementation)


---
### fd\_blake3\_join<!-- {{#callable_declaration:fd_blake3_join}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.h#L310>)

Joins a shared BLAKE3 state for hashing.
- **Description**: Use this function to join a shared memory region that represents a BLAKE3 hashing state. This function checks if the provided memory region is non-null, properly aligned, and contains a valid BLAKE3 state. If any of these conditions are not met, the function returns null. This function is typically used after creating a new BLAKE3 state with `fd_blake3_new` and before performing hashing operations.
- **Inputs**:
    - `shsha`: A pointer to a shared memory region that should represent a BLAKE3 hashing state. It must not be null, must be aligned according to `fd_blake3_align()`, and must contain a valid BLAKE3 state with the correct magic number. If these conditions are not met, the function returns null.
- **Output**: Returns a pointer to the BLAKE3 state if successful, or null if the input is invalid.
- **See Also**: [`fd_blake3_join`](<fd_blake3.c.md#fd_blake3_join>)  (Implementation)


---
### fd\_blake3\_leave<!-- {{#callable_declaration:fd_blake3_leave}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.h#L313>)

Releases a BLAKE3 calculation state.
- **Description**: Use this function to release a BLAKE3 calculation state after completing hash operations. It is important to ensure that the `sha` parameter is not null before calling this function, as passing a null pointer will result in a warning and a null return value. This function is typically called after finishing hash calculations to clean up resources associated with the BLAKE3 state.
- **Inputs**:
    - `sha`: A pointer to a `fd_blake3_t` structure representing the BLAKE3 calculation state. Must not be null. If null, the function logs a warning and returns null.
- **Output**: Returns a void pointer to the `fd_blake3_t` structure if successful, or null if the input is invalid.
- **See Also**: [`fd_blake3_leave`](<fd_blake3.c.md#fd_blake3_leave>)  (Implementation)


---
### fd\_blake3\_delete<!-- {{#callable_declaration:fd_blake3_delete}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.h#L316>)

Deletes a BLAKE3 hash state object.
- **Description**: Use this function to safely delete a BLAKE3 hash state object. Ensure that the pointer to the hash state is not null and is properly aligned according to the alignment requirements of the BLAKE3 implementation. The function checks the integrity of the hash state by verifying a magic number. If any of these conditions are not met, the function logs a warning and returns null. This function should be called when the hash state is no longer needed to release resources.
- **Inputs**:
    - `shsha`: A pointer to the BLAKE3 hash state object to delete. Must not be null and must be aligned according to `fd_blake3_align()`. The hash state must have a valid magic number. If these conditions are not met, the function logs a warning and returns null.
- **Output**: Returns the pointer to the deleted hash state object if successful, or null if the input is invalid.
- **See Also**: [`fd_blake3_delete`](<fd_blake3.c.md#fd_blake3_delete>)  (Implementation)


---
### fd\_blake3\_init<!-- {{#callable_declaration:fd_blake3_init}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.h#L326>)

Initializes a BLAKE3 hashing state.
- **Description**: Use this function to start a new BLAKE3 hash calculation. It prepares the provided `fd_blake3_t` structure for hashing by resetting its state. Ensure that the `sha` parameter is a valid pointer to a `fd_blake3_t` structure that is not being modified concurrently by other operations. This function discards any preexisting state, making the structure ready for a new hash calculation.
- **Inputs**:
    - `sha`: A pointer to an `fd_blake3_t` structure. It must be a valid, non-null pointer to a BLAKE3 calculation state that is not being modified by other concurrent operations. The caller retains ownership of the memory.
- **Output**: Returns the same `fd_blake3_t` pointer provided in the `sha` parameter, now initialized for a new hash calculation.
- **See Also**: [`fd_blake3_init`](<fd_blake3.c.md#fd_blake3_init>)  (Implementation)


---
### fd\_blake3\_append<!-- {{#callable_declaration:fd_blake3_append}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.h#L345>)

Appends data to an ongoing BLAKE3 hash calculation.
- **Description**: Use this function to add data to an ongoing BLAKE3 hash calculation. It is important to ensure that the `sha` parameter is a valid and current local join to a BLAKE3 calculation state, with no concurrent operations that could modify the state during execution. The `data` parameter can be null if `sz` is zero, and the function will handle this case gracefully. For optimal performance, append as many bytes as possible at once, and try to make `sz` a multiple of 64 for all but the last append, which should ideally be less than 56 bytes.
- **Inputs**:
    - `sha`: A pointer to a `fd_blake3_t` structure representing the current state of the BLAKE3 hash calculation. Must be a valid and current local join with no concurrent modifications.
    - `data`: A pointer to the data to append. Can be null if `sz` is zero. The data will not be modified, and no reference is retained after the function returns.
    - `sz`: The size in bytes of the data to append. Must be valid and can be zero, in which case the function does nothing.
- **Output**: Returns the updated `fd_blake3_t` structure with the new state of the hash calculation.
- **See Also**: [`fd_blake3_append`](<fd_blake3.c.md#fd_blake3_append>)  (Implementation)


---
### fd\_blake3\_fini<!-- {{#callable_declaration:fd_blake3_fini}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.h#L360>)

Completes a BLAKE3 hash calculation and stores the result.
- **Description**: Use this function to finalize a BLAKE3 hash calculation after appending all input data. It must be called after `fd_blake3_init` and any necessary `fd_blake3_append` calls. The function writes the 32-byte hash result to the specified memory location. Ensure that no other operations modify the hash state during execution.
- **Inputs**:
    - `sha`: A pointer to an `fd_blake3_t` structure representing the hash state. It must be a valid local join to a BLAKE3 calculation state with no concurrent modifications.
    - `hash`: A pointer to a 32-byte memory region where the hash result will be stored. The caller must ensure this memory is valid and writable.
- **Output**: Returns the `hash` pointer, with the 32-byte hash result written to the memory it points to.
- **See Also**: [`fd_blake3_fini`](<fd_blake3.c.md#fd_blake3_fini>)  (Implementation)


---
### fd\_blake3\_fini\_2048<!-- {{#callable_declaration:fd_blake3_fini_2048}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.h#L364>)

Generates a 2048-byte hash from a BLAKE3 state.
- **Description**: Use this function to finalize a BLAKE3 hashing operation and produce a 2048-byte hash output. It must be called after initializing and appending data to the BLAKE3 state. The function processes the remaining data in the state and writes the expanded hash to the specified memory location. Ensure that the `sha` parameter is a valid and active BLAKE3 state and that `hash` points to a memory region large enough to store 2048 bytes. The function returns a pointer to the hash output.
- **Inputs**:
    - `sha`: A pointer to an `fd_blake3_t` structure representing the BLAKE3 state. It must be a valid and active state with no concurrent modifications.
    - `hash`: A pointer to a memory region where the 2048-byte hash result will be stored. The memory must be allocated by the caller and must be large enough to hold 2048 bytes.
- **Output**: Returns a pointer to the `hash` memory region containing the 2048-byte hash result.
- **See Also**: [`fd_blake3_fini_2048`](<fd_blake3.c.md#fd_blake3_fini_2048>)  (Implementation)


---
### fd\_blake3\_hash<!-- {{#callable_declaration:fd_blake3_hash}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.h#L368>)

Computes the BLAKE3 hash of the input data.
- **Description**: Use this function to compute a BLAKE3 hash for a given input data buffer. It is suitable for hashing messages of any size, leveraging SIMD parallelism for larger inputs if the hardware supports it. The function requires a buffer to store the resulting 32-byte hash. Ensure that the input data and the hash buffer are valid and properly allocated before calling this function.
- **Inputs**:
    - `data`: Pointer to the input data to hash. Must not be null if sz is greater than zero. The caller retains ownership and the data is not modified.
    - `sz`: Size of the input data in bytes. Can be zero, in which case data can be null.
    - `hash`: Pointer to a buffer where the 32-byte hash result will be stored. Must not be null and must have at least 32 bytes allocated.
- **Output**: Returns a pointer to the hash buffer containing the 32-byte hash result.
- **See Also**: [`fd_blake3_hash`](<fd_blake3.c.md#fd_blake3_hash>)  (Implementation)


---
### fd\_blake3\_lthash\_batch8<!-- {{#callable_declaration:fd_blake3_lthash_batch8}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.h#L388>)

Calculates a batch of 8 independent BLAKE3 hash operations and reduces the outputs to a single value.
- **Description**: Use this function to perform BLAKE3 hashing on a batch of 8 independent input messages, each with a size up to 1024 bytes. The function requires that the input data pointers, size array, and output buffer are all 32-byte aligned. It processes the inputs in parallel and combines the results into a single output using 'LtHash' group-add arithmetic. Ensure that the alignment requirements are met to avoid errors.
- **Inputs**:
    - `batch_data`: An array of 8 pointers, each pointing to an input message. The array itself must be 32-byte aligned, but individual pointers do not need to be aligned. Each message can be up to 1024 bytes in size.
    - `batch_sz`: An array of 8 unsigned integers, each representing the size of the corresponding input message in 'batch_data'. The array must be 32-byte aligned, and each size must be within the range [0, 1024].
    - `out_lthash`: A pointer to a memory region where the 2048-byte output will be stored. This pointer must be 32-byte aligned.
- **Output**: None
- **See Also**: [`fd_blake3_lthash_batch8`](<fd_blake3.c.md#fd_blake3_lthash_batch8>)  (Implementation)


---
### fd\_blake3\_lthash\_batch16<!-- {{#callable_declaration:fd_blake3_lthash_batch16}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.h#L399>)

Calculates a batch of 16 independent BLAKE3 hash operations and reduces them to a single output.
- **Description**: Use this function to perform 16 independent BLAKE3 hash operations in parallel, each with an input size up to 1024 bytes, and combine the results into a single output using 'LtHash' group-add arithmetic. Ensure that `batch_data`, `batch_sz`, and `out_lthash` are all 64-byte aligned before calling this function. The function writes 2048 bytes of output to `out_lthash`, and its execution time is determined by the largest input size in `batch_sz`.
- **Inputs**:
    - `batch_data`: An array of 16 pointers, each pointing to the input message for a hash operation. The array itself must be 64-byte aligned, but individual pointers do not need to be aligned. The caller retains ownership.
    - `batch_sz`: An array of 16 unsigned integers specifying the size of each input message in `batch_data`. Each size must be in the range [0, 1024]. The array must be 64-byte aligned. The caller retains ownership.
    - `out_lthash`: A pointer to a memory region where the 2048-byte output will be written. This pointer must be 64-byte aligned. The caller retains ownership.
- **Output**: None
- **See Also**: [`fd_blake3_lthash_batch16`](<fd_blake3.c.md#fd_blake3_lthash_batch16>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)