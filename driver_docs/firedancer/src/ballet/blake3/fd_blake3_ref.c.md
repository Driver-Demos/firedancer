<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Reference implementation of the BLAKE3 compression function with support for chaining values.

# Purpose
The code implements a part of the BLAKE3 cryptographic hash function, specifically focusing on the compression function. The primary components include the [`g`](<#g>) function, which performs the mixing of state variables, and the [`round_fn`](<#round_fn>) function, which applies the [`g`](<#g>) function to the state in a series of rounds. The [`compress_pre`](<#compress_pre>) function initializes the state with input chaining values, a block of data, and other parameters before performing multiple rounds of the compression function. The [`compress_block`](<#compress_block>) function updates the chaining values by applying the compression function to a block of data, and it optionally handles a high chaining value for extended output functionality.

The [`fd_blake3_ref_compress1`](<#fd_blake3_ref_compress1>) function is the main entry point for compressing a message block. It manages the chaining values and flags, processes the message in blocks, and handles special cases such as the start and end of chunks. The function also supports an extended output format (XOF) by capturing the output chaining value before processing the last block. The code is designed to be part of a larger library, as indicated by the use of static inline functions and the inclusion of a private header file. It does not define public APIs directly but provides internal functionality for the BLAKE3 hash algorithm.
# Imports and Dependencies

---
- `fd_blake3_private.h`


# Functions

---
### g<!-- {{#callable:g}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3_ref.c#L3>)

Performs a series of operations on a state array using specified indices and values, including addition and bitwise rotation.
- **Inputs**:
    - `state`: A pointer to an array of unsigned integers that represents the state to be modified.
    - `a`: An unsigned long integer representing the index in the state array for the first operation.
    - `b`: An unsigned long integer representing the index in the state array for the second operation.
    - `c`: An unsigned long integer representing the index in the state array for the third operation.
    - `d`: An unsigned long integer representing the index in the state array for the fourth operation.
    - `x`: An unsigned integer used as an additive constant in the first operation.
    - `y`: An unsigned integer used as an additive constant in the fifth operation.
- **Logic and Control Flow**:
    - Add the value at index `b` of `state` and `x` to the value at index `a` of `state`.
    - Perform a bitwise XOR between the value at index `d` of `state` and the updated value at index `a`, then rotate the result right by 16 bits and store it back in `state[d]`.
    - Add the value at index `d` of `state` to the value at index `c` of `state`.
    - Perform a bitwise XOR between the value at index `b` of `state` and the updated value at index `c`, then rotate the result right by 12 bits and store it back in `state[b]`.
    - Add the value at index `b` of `state` and `y` to the updated value at index `a` of `state`.
    - Perform a bitwise XOR between the value at index `d` of `state` and the updated value at index `a`, then rotate the result right by 8 bits and store it back in `state[d]`.
    - Add the value at index `d` of `state` to the updated value at index `c` of `state`.
    - Perform a bitwise XOR between the value at index `b` of `state` and the updated value at index `c`, then rotate the result right by 7 bits and store it back in `state[b]`.
- **Output**: The function modifies the `state` array in place, with no return value.


---
### round\_fn<!-- {{#callable:round_fn}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3_ref.c#L23>)

Performs a single round of the BLAKE3 hash function by mixing columns and rows of the state array using a message schedule.
- **Inputs**:
    - `state`: An array of 16 unsigned integers representing the current state of the hash function.
    - `msg`: A pointer to an array of unsigned integers representing the message block to be processed.
    - `round`: An unsigned long integer indicating the current round number, used to select the message schedule.
- **Logic and Control Flow**:
    - Selects the message schedule for the current round from `FD_BLAKE3_MSG_SCHEDULE` using the `round` index.
    - Mixes the columns of the `state` array by calling the [`g`](<#g>) function four times with different indices and message values from the schedule.
    - Mixes the rows of the `state` array by calling the [`g`](<#g>) function four more times with different indices and message values from the schedule.
- **Output**: The function modifies the `state` array in place, updating it with the mixed values.
- **Functions Called**:
    - [`g`](<#g>)


---
### compress\_pre<!-- {{#callable:compress_pre}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3_ref.c#L43>)

Initializes the state array for the BLAKE3 compression function using the provided chaining value, block, block length, counter, and flags.
- **Inputs**:
    - `state`: An array of 16 unsigned integers that will be initialized for the compression function.
    - `cv`: A constant array of 8 unsigned integers representing the chaining value.
    - `block`: A constant array of unsigned characters representing the input block to be processed.
    - `block_len`: An unsigned integer representing the length of the block.
    - `counter`: An unsigned long integer used as a counter for the compression function.
    - `flags`: An unsigned integer representing flags that modify the behavior of the compression function.
- **Logic and Control Flow**:
    - Copies the input block into a local array `block_words` of 16 unsigned integers.
    - Splits the `counter` into two 32-bit parts: `ctr_lo` and `ctr_hi`.
    - Initializes the `state` array with values from `cv`, a predefined initialization vector `FD_BLAKE3_IV`, `ctr_lo`, `ctr_hi`, `block_len`, and `flags`.
    - Calls the [`round_fn`](<#round_fn>) function seven times with the `state` and `block_words` to perform the compression rounds.
- **Output**: The function does not return a value; it modifies the `state` array in place.
- **Functions Called**:
    - [`round_fn`](<#round_fn>)


---
### compress\_block<!-- {{#callable:compress_block}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3_ref.c#L75>)

Performs a compression operation on a block of data using the BLAKE3 hash function.
- **Inputs**:
    - `cv`: An array of 8 unsigned integers representing the chaining value.
    - `block`: A constant array of unsigned characters representing the data block to compress, with size `FD_BLAKE3_BLOCK_SZ`.
    - `block_len`: An unsigned integer representing the length of the block.
    - `counter`: An unsigned long integer used as a counter in the compression process.
    - `flags`: An unsigned integer representing flags that modify the compression behavior.
    - `cv_hi`: An optional array of 8 unsigned integers used to store the high part of the chaining value if provided.
- **Logic and Control Flow**:
    - Checks if the `flags` include `FD_BLAKE3_FLAG_ROOT` and logs a trace message if true.
    - Initializes a `state` array of 16 unsigned integers.
    - Copies the current chaining value `cv` to `cv_hi` if `cv_hi` is not NULL.
    - Calls [`compress_pre`](<#compress_pre>) to prepare the `state` array for compression using the provided inputs.
    - Updates the `cv` array by XORing the first 8 elements of `state` with the last 8 elements.
    - If `cv_hi` is not NULL, updates `cv_hi` by XORing its elements with the last 8 elements of `state`.
- **Output**: The function does not return a value but modifies the `cv` and optionally `cv_hi` arrays in place.
- **Functions Called**:
    - [`compress_pre`](<#compress_pre>)


---
### fd\_blake3\_ref\_compress1<!-- {{#callable:fd_blake3_ref_compress1}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3_ref.c#L106>)

Compresses a message using the BLAKE3 hash function, handling chaining values and flags for different modes.
- **Inputs**:
    - `out`: A pointer to the output buffer where the hash result will be stored.
    - `msg`: A pointer to the input message to be compressed.
    - `msg_sz`: The size of the input message in bytes.
    - `counter`: A counter value used in the compression process.
    - `flags`: Flags that modify the behavior of the compression, such as indicating the start or end of a chunk.
    - `out_chain`: A pointer to the output buffer for the chaining value, used in XOF mode.
    - `in_chain`: A pointer to the input chaining value, if any, used to initialize the compression state.
- **Logic and Control Flow**:
    - Initialize the chaining value `cv` with the BLAKE3 initialization vector or the provided `in_chain` if available.
    - Set `cv_hi` to point to the second half of the output buffer if `in_chain` is provided.
    - Determine `block_flags` based on `flags` and whether `in_chain` is provided.
    - Iterate over the message in blocks of size `FD_BLAKE3_BLOCK_SZ`, compressing each block with [`compress_block`](<#compress_block>) and updating `block_flags`.
    - Copy the remaining message bytes into a zero-padded block and adjust `block_flags` for the final block.
    - If `out_chain` is provided, copy the block and chaining value to `out` and `out_chain`, then return.
    - Compress the final block and store the result in `out`.
- **Output**: The function outputs the compressed hash value in the `out` buffer and optionally the chaining value in `out_chain`.
- **Functions Called**:
    - [`compress_block`](<#compress_block>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)