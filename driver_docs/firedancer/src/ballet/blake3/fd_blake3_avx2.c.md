<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Optimized BLAKE3 hash function implementation using AVX2 for parallel processing of data batches.

# Purpose
The code is part of the BLAKE3 cryptographic hash function implementation, specifically optimized for AVX (Advanced Vector Extensions) instructions. It provides functions to compress data blocks using the BLAKE3 algorithm in parallel, leveraging AVX to process multiple data lanes simultaneously. The primary function, [`fd_blake3_avx_compress8`](<#fd_blake3_avx_compress8>), handles the compression of up to eight data blocks in parallel, using AVX instructions to optimize performance. It includes logic to handle different batch sizes and conditions, such as when the batch count is less than or equal to eight, and it manages the processing of message blocks and tail blocks.

The code also includes utility functions like [`wu_rot12`](<#wu_rot12>), [`wu_rot8`](<#wu_rot8>), and [`wu_rot7`](<#wu_rot7>) for bitwise rotations, which are essential operations in the BLAKE3 compression function. The [`round_fn8`](<#round_fn8>) function is a core component that performs the rounds of the BLAKE3 compression function, applying a series of additions, XORs, and rotations to the input data. Additionally, the [`fd_blake3_avx_compress8_fast`](<#fd_blake3_avx_compress8_fast>) function provides a streamlined version of the compression process for specific use cases, focusing on speed and efficiency. The code is designed to be part of a larger library, as indicated by the inclusion of headers like `fd_blake3.h` and `fd_blake3_private.h`, and it is intended to be used in environments where AVX is available to enhance the performance of cryptographic operations.
# Imports and Dependencies

---
- `fd_blake3.h`
- `fd_blake3_private.h`
- `../../util/simd/fd_avx.h`
- `assert.h`


# Functions

---
### wu\_rot12<!-- {{#callable:wu_rot12}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3_avx2.c#L12>)

Performs a 12-bit right rotation on the input value `x`.
- **Inputs**:
    - `x`: The input value of type `wu_t` to be rotated.
- **Logic and Control Flow**:
    - Calls the function `wu_ror` with `x` and the constant `12` as arguments.
    - Returns the result of the `wu_ror` function call.
- **Output**: The result of rotating the input `x` by 12 bits to the right.


---
### wu\_rot8<!-- {{#callable:wu_rot8}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3_avx2.c#L17>)

Performs an 8-byte rotation on a 256-bit vector using a predefined shuffle mask.
- **Inputs**:
    - ``x``: A 256-bit vector of type `wu_t` to be rotated.
- **Logic and Control Flow**:
    - Defines a constant shuffle mask `mask` using the `wb` macro, which specifies the byte positions for the shuffle operation.
    - Applies the `_mm256_shuffle_epi8` intrinsic to shuffle the bytes of the input vector `x` according to the `mask`.
- **Output**: Returns a 256-bit vector of type `wu_t` with its bytes shuffled according to the predefined mask.


---
### wu\_rot7<!-- {{#callable:wu_rot7}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3_avx2.c#L25>)

Performs a right rotation of 7 bits on the input value `x`.
- **Inputs**:
    - `x`: An input of type `wu_t` to be rotated.
- **Logic and Control Flow**:
    - Calls the `wu_ror` function with `x` and the constant 7 as arguments.
    - Returns the result of the `wu_ror` function call.
- **Output**: The rotated value of type `wu_t` after performing a right rotation by 7 bits on `x`.


---
### round\_fn8<!-- {{#callable:round_fn8}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3_avx2.c#L30>)

Performs a round of the BLAKE3 compression function using vectorized operations on 16-element arrays.
- **Inputs**:
    - `v`: An array of 16 `wu_t` elements representing the current state vector.
    - `m`: An array of 16 `wu_t` elements representing the message block to be processed.
    - `r`: An `ulong` index used to select the message schedule for the current round.
- **Logic and Control Flow**:
    - Add elements from `m` to `v` using indices from `FD_BLAKE3_MSG_SCHEDULE` based on `r`.
    - Perform addition and XOR operations on elements of `v` to mix the state.
    - Apply rotation operations (`wu_rot16`, [`wu_rot12`](<#wu_rot12>), [`wu_rot8`](<#wu_rot8>), [`wu_rot7`](<#wu_rot7>)) to specific elements of `v`.
    - Repeat the process for different segments of the `v` array to complete the round.
- **Output**: The function modifies the `v` array in place, updating its elements to reflect the result of the round.
- **Functions Called**:
    - [`wu_rot12`](<#wu_rot12>)
    - [`wu_rot8`](<#wu_rot8>)
    - [`wu_rot7`](<#wu_rot7>)


---
### fd\_blake3\_avx\_compress8<!-- {{#callable:fd_blake3_avx_compress8}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3_avx2.c#L149>)

Processes up to 8 BLAKE3 hash computations in parallel using AVX instructions.
- **Inputs**:
    - `batch_cnt`: The number of hash computations to process, must be between 1 and 8.
    - `_batch_data`: Pointer to the input data for each hash computation.
    - `batch_sz`: Array of sizes for each input data block.
    - `ctr_vec`: Array of counter values for each hash computation.
    - `batch_flags`: Array of flags for each hash computation.
    - `_batch_hash`: Array of pointers to store the resulting hash for each computation.
    - `lthash`: Pointer to store the LtHash output, if applicable.
    - `out_sz`: The size of the output hash, either 32 or 64 bytes.
    - `batch_cv`: Pointer to custom chaining values, if applicable.
- **Logic and Control Flow**:
    - Checks if `batch_cnt` is valid (1 to 8) and logs an error if not.
    - If `batch_cnt` is 1, calls [`fd_blake3_sse_compress1`](<fd_blake3_sse41.c.md#fd_blake3_sse_compress1>) for single computation and returns.
    - Initializes variables and prepares data for AVX processing, including handling tail blocks for non-multiple of 64-byte data sizes.
    - Sets up initial hash state using BLAKE3 IVs and custom chaining values if provided.
    - Processes each block of data in parallel using AVX instructions, updating the hash state for each lane.
    - Handles special LtHash mode if `lthash` is provided, performing additional processing and storing results.
    - Stores the final hash results in the provided `_batch_hash` pointers, handling both 32-byte and 64-byte output sizes.
- **Output**: Stores the computed hash values in the provided `_batch_hash` pointers, with optional LtHash output in `lthash`.
- **Functions Called**:
    - [`fd_blake3_sse_compress1`](<fd_blake3_sse41.c.md#fd_blake3_sse_compress1>)
    - [`round_fn8`](<#round_fn8>)


---
### fd\_blake3\_avx\_compress8\_fast<!-- {{#callable:fd_blake3_avx_compress8_fast}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3_avx2.c#L599>)

Performs a fast compression of 8 BLAKE3 message blocks using AVX instructions.
- **Inputs**:
    - `msg`: Pointer to the input message data to compress.
    - `_out`: Pointer to the output buffer where the compressed data will be stored.
    - `counter`: Counter value used in the compression process.
    - `flags`: Flags that modify the behavior of the compression, such as indicating if the node is a parent.
- **Logic and Control Flow**:
    - Aligns the output buffer to 32 bytes for optimal performance.
    - Determines if the current node is a parent and calculates the size of the data to process based on this.
    - Initializes the counter values for the compression process, adjusting them based on whether the node is a parent.
    - Loads the BLAKE3 initialization vector into local variables for use in the compression rounds.
    - Iterates over the message data in blocks of `FD_BLAKE3_BLOCK_SZ`, updating the offset after each block.
    - For each block, calculates chunk flags and combines them with the input flags.
    - Loads and transposes 8x8 blocks of message data for processing.
    - Initializes the state vector `v` with the current hash state, initialization vector, counter, size, and flags.
    - Performs 7 rounds of the BLAKE3 compression function using the [`round_fn8`](<#round_fn8>) function.
    - Updates the hash state by XORing the current state with the initialization vector.
    - Continues processing until all blocks are processed.
    - Transposes the final hash state and stores the result in the output buffer.
- **Output**: The function does not return a value but writes the compressed hash output to the buffer pointed to by `_out`.
- **Functions Called**:
    - [`round_fn8`](<#round_fn8>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)