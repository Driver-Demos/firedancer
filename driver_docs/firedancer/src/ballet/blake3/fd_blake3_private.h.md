<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Private header for BLAKE3 hash function implementation with tracing, protocol constants, and compression functions.

# Purpose
The code is a C header file that defines private components for the BLAKE3 cryptographic hash function implementation. It includes protocol constants, data structures, and function prototypes necessary for the internal workings of the BLAKE3 algorithm. The file is not intended to be used directly by external code, as indicated by its naming convention and the use of the `#ifndef` and `#define` preprocessor directives to prevent multiple inclusions.

Key components include the definition of message schedules and initialization vectors (`FD_BLAKE3_MSG_SCHEDULE` and `FD_BLAKE3_IV`), which are essential for the BLAKE3 compression function. The file also defines flags used to indicate the state of data blocks during processing. It provides function prototypes for different compression functions optimized for various CPU instruction sets, such as SSE, AVX, and AVX512, which enhance performance by leveraging specific hardware capabilities. The `fd_blake3_op` union is defined to encapsulate the operation parameters for the BLAKE3 function, ensuring proper alignment and efficient data handling.
# Imports and Dependencies

---
- `fd_blake3.h`


# Global Variables

---
### FD\_BLAKE3\_MSG\_SCHEDULE
- **Type**: ``static const uchar[7][16]``
- **Description**: Defines a 7x16 matrix of unsigned characters that represents the message schedule for the BLAKE3 cryptographic hash function. Each row in the matrix corresponds to a permutation of message indices used during the compression function of BLAKE3.
- **Use**: Used to determine the order of message words during the BLAKE3 compression process.


---
### FD\_BLAKE3\_IV
- **Type**: ``uint[8]``
- **Description**: An array of 8 unsigned integers that represents the initial vector (IV) constants used in the BLAKE3 cryptographic hash function. These constants are derived from the fractional parts of the square roots of the first 8 prime numbers.
- **Use**: Used as the default initial chaining value in the BLAKE3 compression function.


# Data Structures

---
### fd\_blake3\_op
- **Type**: ``union``
- **Members**:
    - ``msg``: Pointer to the input message.
    - ``out``: Pointer to the output buffer.
    - ``counter``: Counter for the operation.
    - ``off``: Offset within the message.
    - ``sz``: Size of the message segment.
    - ``off_sz``: Combined offset and size as a single `uint`.
    - ``flags``: Flags indicating the state or type of operation.
- **Description**: The `fd_blake3_op` union is a data structure used in the BLAKE3 hashing algorithm to represent an operation with aligned memory. It contains a nested structure with pointers to the input message and output buffer, a counter for tracking the operation, and a union for managing offset and size information either separately as `ushort` values or combined as a `uint`. The `flags` field is used to specify the state or type of the operation, such as whether it is the start or end of a chunk.


---
### fd\_blake3\_op\_t
- **Type**: `union`
- **Members**:
    - `msg`: Pointer to the input message.
    - `out`: Pointer to the output buffer.
    - `counter`: Counter value for the operation.
    - `off`: Offset within the message.
    - `sz`: Size of the message segment.
    - `off_sz`: Combined offset and size as a single integer.
    - `flags`: Flags indicating the state or type of operation.
- **Description**: Defines a union `fd_blake3_op` that represents an operation in the BLAKE3 hashing process, containing pointers to message and output buffers, a counter, and flags for operation control.


# Function Declarations (Public API)

---
### fd\_blake3\_fini\_xof\_compress<!-- {{#callable_declaration:fd_blake3_fini_xof_compress}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3_private.h#L73>)

Finalizes the BLAKE3 hash computation and compresses the output.
- **Description**: Use this function to complete the BLAKE3 hashing process and obtain the compressed output. It must be called after all input data has been processed by the hashing function. This function handles both leaf and branch node cases, ensuring the correct finalization of the hash. It is important to ensure that the `sha` parameter is properly initialized and that the function is not called multiple times on the same state, as this can lead to errors.
- **Inputs**:
    - `sha`: A pointer to an `fd_blake3_t` structure representing the current state of the BLAKE3 hash. Must not be null and must be properly initialized before calling this function.
    - `root_msg`: A pointer to a buffer where the final compressed message will be stored. Must not be null and should have sufficient space to store the output.
    - `root_cv_pre`: A pointer to a buffer where the pre-computed chaining value will be stored. Must not be null and should have sufficient space to store the output.
- **Output**: None
- **See Also**: [`fd_blake3_fini_xof_compress`](<fd_blake3.c.md#fd_blake3_fini_xof_compress>)  (Implementation)


---
### fd\_blake3\_ref\_compress1<!-- {{#callable_declaration:fd_blake3_ref_compress1}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3_private.h#L80>)

Compresses a message block using the BLAKE3 hash function.
- **Description**: Use this function to compress a message block with the BLAKE3 hash function. It processes the input message and produces a 32-byte hash output. The function can handle optional chaining values for input and output, which are useful for extended output functions (XOF) or when processing multiple blocks in a sequence. Ensure that the input message size does not exceed 64 bytes, as this is the maximum block size the function can process in one call. The function does not return a value but writes the hash result to the specified output buffer.
- **Inputs**:
    - `out`: A pointer to a buffer where the 32-byte hash output will be written. Must not be null and should have at least 32 bytes of space.
    - `msg`: A pointer to the message block to be compressed. Must not be null and should point to a buffer of up to 64 bytes.
    - `msg_sz`: The size of the message block in bytes. Must be less than or equal to 64.
    - `counter`: A counter value used in the compression process. It is typically incremented for each block in a sequence.
    - `flags`: Flags that modify the behavior of the compression. These can include indicators for chunk start, chunk end, parent node, and root node.
    - `out_chain`: An optional pointer to a buffer where a 16-byte output chaining value will be written. Can be null if not used.
    - `in_chain`: An optional pointer to a 16-byte input chaining value. If null, a default initialization vector is used.
- **Output**: None
- **See Also**: [`fd_blake3_ref_compress1`](<fd_blake3_ref.c.md#fd_blake3_ref_compress1>)  (Implementation)


---
### fd\_blake3\_sse\_compress1<!-- {{#callable_declaration:fd_blake3_sse_compress1}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3_private.h#L91>)

Compresses a BLAKE3 message block using SSE instructions.
- **Description**: Use this function to compress a single block of a BLAKE3 message with SSE optimizations. It processes a message block of up to 64 bytes, using a counter and flags to control the compression behavior. The function can optionally use input and output chaining values to support tree hashing. Ensure the message size does not exceed 64 bytes before calling this function.
- **Inputs**:
    - `out`: A pointer to a 32-byte buffer where the compressed output will be stored. Must not be null.
    - `msg`: A pointer to the message block to compress. Must not be null and should be at most 64 bytes in size.
    - `msg_sz`: The size of the message block in bytes. Must be less than or equal to 64.
    - `counter`: A counter value used in the compression process. It is a 64-bit unsigned integer.
    - `flags`: A set of flags controlling the compression. Valid flags include `FD_BLAKE3_FLAG_CHUNK_START`, `FD_BLAKE3_FLAG_CHUNK_END`, `FD_BLAKE3_FLAG_PARENT`, and `FD_BLAKE3_FLAG_ROOT`.
    - `out_chain`: An optional pointer to a 16-byte buffer where the output chaining value will be stored if the function is in XOF mode. Can be null if not used.
    - `in_chain`: An optional pointer to a 16-byte input chaining value. If null, the default IV is used.
- **Output**: None
- **See Also**: [`fd_blake3_sse_compress1`](<fd_blake3_sse41.c.md#fd_blake3_sse_compress1>)  (Implementation)


---
### fd\_blake3\_avx\_compress8<!-- {{#callable_declaration:fd_blake3_avx_compress8}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3_private.h#L135>)

Compresses up to eight BLAKE3 nodes using AVX instructions.
- **Description**: Use this function to compress one to eight BLAKE3 nodes in parallel using AVX instructions. It supports different output modes, including simple output and LtHash mode. The function requires specific alignment and size constraints for its inputs, and it will log errors if these constraints are not met. It is important to ensure that `batch_cnt` is between 1 and 8, and that `out_sz` is either 32 or 64. The function does not support lane masking in LtHash mode.
- **Inputs**:
    - `batch_cnt`: The number of nodes to process, must be between 1 and 8 inclusive. If the value is outside this range, the function logs an error.
    - `_batch_data`: Pointer to the input data for the nodes, must be aligned to 32 bytes. The length should be between 1 and 8.
    - `batch_sz`: Array of input byte counts for each node, with a length between 1 and 8.
    - `ctr_vec`: Array of counter values for each node, must have a length of 8.
    - `batch_flags`: Array of flag values for each node, must be aligned to 32 bytes and have a length of 8.
    - `_batch_hash`: Array of pointers to where the output hashes will be stored, must be aligned to 32 bytes and have a length between 1 and 8.
    - `lthash`: Optional pointer for LtHash mode output, must be aligned to 32 bytes and have a size of 2048 bytes. If provided, `batch_cnt` must be 8.
    - `out_sz`: Specifies the size of the output hash, must be either 32 or 64. If an invalid size is provided, the function logs an error.
    - `batch_cv`: Optional pointer to an array of chaining values for the first block of each node, must be aligned to 8 bytes and have a length of 8.
- **Output**: None
- **See Also**: [`fd_blake3_avx_compress8`](<fd_blake3_avx2.c.md#fd_blake3_avx_compress8>)  (Implementation)


---
### fd\_blake3\_avx\_compress8\_fast<!-- {{#callable_declaration:fd_blake3_avx_compress8_fast}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3_private.h#L146>)

Compresses eight BLAKE3 nodes using AVX instructions.
- **Description**: Use this function to compress eight BLAKE3 nodes in parallel with AVX instructions for improved performance. It requires aligned input and output buffers and processes data in blocks, updating the output buffer with the compressed result. Ensure that the input data and output buffer are properly aligned to 32-byte boundaries. The function uses a counter and flags to manage the compression state and behavior.
- **Inputs**:
    - `batch_data`: Pointer to the input data for the nodes, aligned to 32 bytes. The length must be exactly 8*64 bytes. The caller retains ownership and must ensure the data is valid and aligned.
    - `batch_hash`: Pointer to the output buffer where the compressed hash will be stored, aligned to 32 bytes. The length must be exactly 8*32 bytes. The caller retains ownership and must ensure the buffer is valid and aligned.
    - `counter`: Unsigned long integer representing the counter value for the compression. It is used to manage the state of the compression process.
    - `flags`: Unsigned char representing the flags that control the compression behavior. Valid flags are defined in the header and include options for chunk start, chunk end, parent, and root nodes.
- **Output**: None
- **See Also**: [`fd_blake3_avx_compress8_fast`](<fd_blake3_avx2.c.md#fd_blake3_avx_compress8_fast>)  (Implementation)


---
### fd\_blake3\_avx512\_compress16<!-- {{#callable_declaration:fd_blake3_avx512_compress16}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3_private.h#L160>)

Compresses up to 16 BLAKE3 nodes using AVX-512.
- **Description**: Use this function to compress up to 16 BLAKE3 nodes in parallel using AVX-512 instructions. It requires specific alignment and size constraints for the input data, sizes, counters, flags, and output hash buffers. The function supports two output modes: a simple mode that outputs a 32-byte hash for each node, and an LtHash mode that expands each node's output to 2048 bytes. Ensure that `batch_cnt` is between 1 and 16, and that `out_sz` is either 32 or 64. The function will log an error if `batch_cnt` is not within the valid range or if `out_sz` is invalid.
- **Inputs**:
    - `batch_cnt`: The number of nodes to process, must be between 1 and 16 inclusive. An invalid value will cause an error log.
    - `_batch_data`: Pointer to the input data for the nodes, must be aligned to 64 bytes and have a length of 16 elements.
    - `batch_sz`: Pointer to an array of sizes for each node, must have a length of 16 elements.
    - `ctr_vec`: Pointer to an array of counters for each node, must have a length of 16 elements.
    - `batch_flags`: Pointer to an array of flags for each node, must have a length of 16 elements.
    - `_batch_hash`: Pointer to an array of pointers for the output hash of each node, must be aligned to 64 bytes and have a length of 16 elements.
    - `lthash`: Pointer to a buffer for the LtHash output, must be aligned to 32 bytes and have a size of 2048 bytes. Can be null if not used.
    - `out_sz`: The size of the output hash, must be either 32 or 64. An invalid value will cause an error log.
    - `batch_cv`: Optional pointer to an array of chaining values for each node, must be aligned to 8 bytes and have a length of 16 elements if used.
- **Output**: None
- **See Also**: [`fd_blake3_avx512_compress16`](<fd_blake3_avx512.c.md#fd_blake3_avx512_compress16>)  (Implementation)


---
### fd\_blake3\_avx512\_compress16\_fast<!-- {{#callable_declaration:fd_blake3_avx512_compress16_fast}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3_private.h#L171>)

Compresses 16 BLAKE3 nodes using AVX-512 instructions.
- **Description**: Use this function to perform fast compression of 16 BLAKE3 nodes in parallel using AVX-512 instructions. It is designed for high-performance scenarios where data alignment and size constraints are met. Ensure that the input data and output buffers are properly aligned and sized according to the function's requirements. This function is suitable for processing large data sets efficiently by leveraging SIMD capabilities.
- **Inputs**:
    - `msg`: Pointer to the input message data. Must be aligned to 32 bytes and have a length of 16*64 bytes. The caller retains ownership and must ensure the data is valid and accessible.
    - `out`: Pointer to the output buffer where the compressed hash will be stored. Must be aligned to 32 bytes and have a length of 16*32 bytes. The caller retains ownership and must ensure the buffer is valid and writable.
    - `counter`: Unsigned long integer representing the counter value for the compression. It is used to differentiate between different chunks of data.
    - `flags`: Unsigned char representing the flags for the compression operation. It can include specific BLAKE3 flags such as `FD_BLAKE3_FLAG_PARENT` to indicate the type of node being processed.
- **Output**: None
- **See Also**: [`fd_blake3_avx512_compress16_fast`](<fd_blake3_avx512.c.md#fd_blake3_avx512_compress16_fast>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)