<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements the BLAKE3 cryptographic hash function with support for parallel processing and various optimizations.

# Purpose
The code is a C implementation of the BLAKE3 cryptographic hash function. It provides functions to initialize, update, and finalize a BLAKE3 hash computation. The code includes both single and parallel processing capabilities, utilizing SIMD instructions for performance optimization on platforms that support AVX or AVX512. The main components include functions for preparing and processing data blocks ([`fd_blake3_prepare`](<#fd_blake3_prepare>), [`fd_blake3_prepare_fast`](<#fd_blake3_prepare_fast>)), managing the hash state (`fd_blake3_pos_init`, [`fd_blake3_advance`](<#fd_blake3_advance>)), and finalizing the hash ([`fd_blake3_fini`](<#fd_blake3_fini>), [`fd_blake3_fini_2048`](<#fd_blake3_fini_2048>)). The code also provides a simple API for creating and managing hash state objects ([`fd_blake3_new`](<#fd_blake3_new>), [`fd_blake3_join`](<#fd_blake3_join>), [`fd_blake3_delete`](<#fd_blake3_delete>)).

The code is structured to handle both leaf and branch nodes in the BLAKE3 hash tree, with specific functions for each type of node ([`fd_blake3_prepare_leaf`](<#fd_blake3_prepare_leaf>), [`fd_blake3_prepare_branch`](<#fd_blake3_prepare_branch>)). It also includes batch processing functions for hashing multiple data inputs simultaneously ([`fd_blake3_lthash_batch8`](<#fd_blake3_lthash_batch8>), [`fd_blake3_lthash_batch16`](<#fd_blake3_lthash_batch16>)). The code defines public APIs for external use, allowing integration into other software systems. It is designed to be used as a library, with functions that can be called to perform hashing operations on data provided by the user.
# Imports and Dependencies

---
- `fd_blake3.h`
- `fd_blake3_private.h`
- `assert.h`


# Functions

---
### fd\_blake3\_l0\_complete<!-- {{#callable:fd_blake3_l0_complete}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.c#L22>)

Checks if all leaf nodes in the BLAKE3 hash state have been processed.
- **Inputs**:
    - ``s``: A pointer to a `fd_blake3_pos_t` structure representing the current state of the BLAKE3 hash process.
- **Logic and Control Flow**:
    - Shift the `leaf_idx` field of `s` left by `FD_BLAKE3_CHUNK_LG_SZ` bits.
    - Compare the result to the maximum of `s->input_sz` and 64 using `fd_ulong_max`.
    - Return 1 if the shifted `leaf_idx` is greater than or equal to the maximum value, indicating all leaf nodes are processed; otherwise, return 0.
- **Output**: Returns 1 if all leaf nodes have been hashed, otherwise returns 0.


---
### fd\_blake3\_is\_finished<!-- {{#callable:fd_blake3_is_finished}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.c#L27>)

Checks if the BLAKE3 hashing process is complete based on the state and current tick.
- **Inputs**:
    - ``s``: A pointer to a `fd_blake3_pos_t` structure representing the current state of the BLAKE3 hashing process.
    - ``tick``: An unsigned long integer representing the current tick or time step in the hashing process.
- **Logic and Control Flow**:
    - Calls [`fd_blake3_l0_complete`](<#fd_blake3_l0_complete>) to check if all leaf nodes have been hashed, storing the result in `l0_complete`.
    - Checks if the live count in the state `s` is equal to 1, storing the result in `ln_complete`.
    - Checks if the current `tick` is greater than or equal to `s->next_tick`, storing the result in `idle`.
    - Returns the logical AND of `l0_complete`, `ln_complete`, and `idle` to determine if the hashing process is finished.
- **Output**: Returns an integer that is non-zero if the hashing process is finished, otherwise returns zero.
- **Functions Called**:
    - [`fd_blake3_l0_complete`](<#fd_blake3_l0_complete>)


---
### fd\_blake3\_prepare\_leaf<!-- {{#callable:fd_blake3_prepare_leaf}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.c#L36>)

Prepares a BLAKE3 leaf node operation by setting up the message, output buffer, counter, size, and flags for hashing.
- **Inputs**:
    - ``s``: A pointer to a `fd_blake3_pos_t` structure that holds the current state of the BLAKE3 hash operation.
    - ``buf``: A pointer to a `fd_blake3_buf_t` structure that provides buffer slots for storing intermediate hash values.
    - ``op``: A pointer to a `fd_blake3_op_t` structure where the prepared operation details will be stored.
    - ``tick``: An unsigned long integer representing the current tick or step in the hashing process.
- **Logic and Control Flow**:
    - Calculate `msg_off` as the offset for the current leaf index shifted by `FD_BLAKE3_CHUNK_LG_SZ`.
    - Determine `msg_sz` as the minimum of the remaining input size and 1024 bytes.
    - Set `msg` to point to the input data starting at `msg_off`.
    - Set `out` to point to the appropriate buffer slot for the current layer and head index.
    - Determine `flags` based on whether the input size is less than or equal to `FD_BLAKE3_CHUNK_SZ`.
    - Initialize the `op` structure with the message, output buffer, counter, size, and flags.
    - Increment the head index for layer 0, the leaf index, and the live count.
    - Set `s->next_tick` to `tick + 1`.
    - Return the pointer to the `op` structure.
- **Output**: Returns a pointer to the `fd_blake3_op_t` structure containing the prepared operation details.


---
### fd\_blake3\_seek\_branch<!-- {{#callable:fd_blake3_seek_branch}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.c#L66>)

Determines if a branch merge is possible in the BLAKE3 hash state and updates the state accordingly.
- **Inputs**:
    - `s`: A pointer to `fd_blake3_pos_t`, representing the current position and state of the BLAKE3 hash.
    - `buf`: A pointer to `fd_blake3_buf_t`, representing the buffer used for storing intermediate hash values.
    - `tick`: An unsigned long integer representing the current tick or time step in the hashing process.
- **Logic and Control Flow**:
    - Check if `s->live_cnt` is 1, return 0 if true, indicating no merge is needed.
    - Check if the level 0 nodes are complete using `fd_blake3_l0_complete(s)`, return a comparison result if false.
    - If AVX is available, calculate the difference between `s->head.wb` and `s->tail.wb` using `wb_sub`.
    - Determine mergeable layers using `_mm256_movemask_epi8` and find the least significant bit with `fd_uint_find_lsb_w_default`.
    - If a mergeable layer is found, check if it is valid to merge based on `s->layer` and `tick`, update `s->layer` and return 1 if valid.
    - Determine single layers using `_mm256_movemask_epi8` and find the lowest and highest single layers with `fd_uint_find_lsb`.
    - Load and store nodes between `buf->slots` for the single layers identified.
    - If AVX is not available, calculate the difference between `s->head.uc` and `s->tail.uc` for each byte.
    - Find the first layer with a difference greater than 1, update `s->layer` and return 1 if valid to merge.
    - Find the lowest and highest single layers with a difference of 1, copy data between `buf->slots` for these layers.
    - Update `s->head.uc` and `s->layer` based on the single layers identified.
    - Return 1 to indicate a successful branch merge.
- **Output**: Returns an integer, 0 if no merge is possible or needed, and 1 if a branch merge is successfully performed.
- **Functions Called**:
    - [`fd_blake3_l0_complete`](<#fd_blake3_l0_complete>)


---
### fd\_blake3\_prepare\_branch<!-- {{#callable:fd_blake3_prepare_branch}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.c#L154>)

Prepares a BLAKE3 operation for a branch node by setting up the message, output, and operation flags based on the current state and tick.
- **Inputs**:
    - ``s``: A pointer to a `fd_blake3_pos_t` structure representing the current position in the BLAKE3 hash state.
    - ``buf``: A pointer to a `fd_blake3_buf_t` structure used to store intermediate hash data.
    - ``op``: A pointer to a `fd_blake3_op_t` structure where the prepared operation will be stored.
    - ``tick``: An unsigned long integer representing the current tick or time step in the hashing process.
- **Logic and Control Flow**:
    - Calls [`fd_blake3_seek_branch`](<#fd_blake3_seek_branch>) to determine if a branch operation can proceed; if not, returns `NULL`.
    - Asserts that the current layer is less than `FD_BLAKE3_ROW_CNT`.
    - Retrieves the message from the previous layer and the output location from the current layer in the buffer.
    - Updates the head and tail indices for the current and previous layers, respectively, and decrements the live count.
    - Sets the next tick to `tick + 1`.
    - Determines the operation flags, setting `FD_BLAKE3_FLAG_PARENT` and optionally `FD_BLAKE3_FLAG_ROOT` if this is the last live operation.
    - Initializes the `op` structure with the message, output, counter, size, and flags.
    - Returns the pointer to the `op` structure.
- **Output**: A pointer to the prepared `fd_blake3_op_t` structure, or `NULL` if the branch cannot be prepared.
- **Functions Called**:
    - [`fd_blake3_seek_branch`](<#fd_blake3_seek_branch>)


---
### fd\_blake3\_advance<!-- {{#callable:fd_blake3_advance}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.c#L187>)

Updates the position state in the BLAKE3 hash algorithm by adjusting the `tail` and `head` pointers and modifying the `layer` based on certain conditions.
- **Inputs**:
    - `s`: A pointer to an `fd_blake3_pos_t` structure that represents the current position state in the BLAKE3 hash algorithm.
- **Logic and Control Flow**:
    - If `FD_HAS_AVX` is defined, use AVX instructions to create a mask where `tail.wb` equals `head.wb`, and clear these positions in both `tail.wb` and `head.wb`.
    - If `FD_HAS_AVX` is not defined, iterate over 32 elements and set positions to zero where `tail.uc[j]` equals `head.uc[j]`.
    - Check if `head.uc[layer]` equals `FD_BLAKE3_COL_CNT`; if true, increment `layer`.
    - If `layer` is greater than 0 and `tail.uc[layer-1]` is less than `head.uc[layer-1]`, do nothing.
    - If `fd_blake3_l0_complete(s)` returns true, increment `layer`.
    - If none of the above conditions are met and `layer` is greater than 0, set `layer` to 0.
- **Output**: No return value; the function modifies the state of the `fd_blake3_pos_t` structure pointed to by `s`.
- **Functions Called**:
    - [`fd_blake3_l0_complete`](<#fd_blake3_l0_complete>)


---
### fd\_blake3\_prepare<!-- {{#callable:fd_blake3_prepare}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.c#L223>)

Prepares a BLAKE3 operation based on the current state and tick, determining whether to process a leaf or branch node.
- **Inputs**:
    - ``s``: A pointer to a `fd_blake3_pos_t` structure representing the current state of the BLAKE3 hash operation.
    - ``buf``: A pointer to a `fd_blake3_buf_t` structure used as a buffer for the hash operation.
    - ``op``: A pointer to a `fd_blake3_op_t` structure where the prepared operation will be stored.
    - ``tick``: An unsigned long integer representing the current tick or time step in the hash operation.
- **Logic and Control Flow**:
    - Assert that the current layer in `s` is less than `FD_BLAKE3_ROW_CNT`.
    - Check if the hash operation is finished using [`fd_blake3_is_finished`](<#fd_blake3_is_finished>); if so, return `NULL`.
    - If `tick` is greater than or equal to `s->next_tick`, call [`fd_blake3_advance`](<#fd_blake3_advance>) to update the state.
    - If the current layer is not zero, call [`fd_blake3_prepare_branch`](<#fd_blake3_prepare_branch>) to prepare a branch operation and return its result.
    - Check if the head of the current layer has reached `FD_BLAKE3_COL_CNT` or if all leaf nodes are complete using [`fd_blake3_l0_complete`](<#fd_blake3_l0_complete>); if so, return `NULL`.
    - Call [`fd_blake3_prepare_leaf`](<#fd_blake3_prepare_leaf>) to prepare a leaf operation and return its result.
- **Output**: Returns a pointer to a `fd_blake3_op_t` structure representing the prepared operation, or `NULL` if no operation is prepared.
- **Functions Called**:
    - [`fd_blake3_is_finished`](<#fd_blake3_is_finished>)
    - [`fd_blake3_advance`](<#fd_blake3_advance>)
    - [`fd_blake3_prepare_branch`](<#fd_blake3_prepare_branch>)
    - [`fd_blake3_l0_complete`](<#fd_blake3_l0_complete>)
    - [`fd_blake3_prepare_leaf`](<#fd_blake3_prepare_leaf>)


---
### fd\_blake3\_prepare\_fast<!-- {{#callable:fd_blake3_prepare_fast}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.c#L254>)

Prepares a BLAKE3 operation for fast hashing of full chunks or branches.
- **Inputs**:
    - `s`: A pointer to a `fd_blake3_pos_t` structure representing the current state of the hash operation.
    - `buf`: A pointer to a `fd_blake3_buf_t` structure used for storing intermediate hash data.
    - `op`: A pointer to a `fd_blake3_op_t` structure where the prepared operation will be stored.
    - `n`: The number of chunks to process.
    - `min`: The minimum number of chunks required to use the fast hashing method.
- **Logic and Control Flow**:
    - Checks if the current layer is a branch and fully hashed; if so, prepares the operation for a parent node and updates the state.
    - Calculates the position and available chunks based on the current leaf index and input size.
    - Determines the number of chunks to process by taking the minimum of `n` and available chunks.
    - Returns `NULL` if the number of chunks is less than `min`.
    - Prepares the operation for a leaf node if the branch condition is not met and updates the state accordingly.
- **Output**: Returns a pointer to the prepared `fd_blake3_op_t` operation or `NULL` if conditions are not met.


---
### fd\_blake3\_batch\_hash<!-- {{#callable:fd_blake3_batch_hash}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.c#L299>)

Processes a batch of BLAKE3 hash operations using AVX or AVX512 instructions.
- **Inputs**:
    - `ops`: An array of `fd_blake3_op_t` structures, each containing the message, output buffer, size, counter, and flags for a hash operation.
    - `op_cnt`: The number of operations in the `ops` array to process.
- **Logic and Control Flow**:
    - Initialize arrays `batch_data`, `batch_data_sz`, `batch_hash`, `batch_ctr`, and `batch_flags` to store data for each operation in the batch.
    - Iterate over each operation in `ops` and populate the arrays with the corresponding message, output buffer, size, counter, and flags.
    - Check if AVX512 instructions are available (`FD_HAS_AVX512`), and if so, call [`fd_blake3_avx512_compress16`](<fd_blake3_avx512.c.md#fd_blake3_avx512_compress16>) to process the batch.
    - If AVX512 is not available but AVX is (`FD_HAS_AVX`), call [`fd_blake3_avx_compress8`](<fd_blake3_avx2.c.md#fd_blake3_avx_compress8>) to process the batch.
    - If neither AVX512 nor AVX is available, trigger a compilation error.
- **Output**: There is no return value; the function writes the hash results directly to the output buffers specified in the `ops` array.
- **Functions Called**:
    - [`fd_blake3_avx512_compress16`](<fd_blake3_avx512.c.md#fd_blake3_avx512_compress16>)
    - [`fd_blake3_avx_compress8`](<fd_blake3_avx2.c.md#fd_blake3_avx_compress8>)


---
### fd\_blake3\_align<!-- {{#callable:fd_blake3_align}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.c#L327>)

Returns the alignment requirement for BLAKE3 data structures.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the value of the macro `FD_BLAKE3_ALIGN`.
- **Output**: An unsigned long integer representing the alignment requirement.


---
### fd\_blake3\_footprint<!-- {{#callable:fd_blake3_footprint}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.c#L332>)

Returns the constant `FD_BLAKE3_FOOTPRINT`.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the value of the constant `FD_BLAKE3_FOOTPRINT`.
- **Output**: The function returns an unsigned long integer representing the footprint size of the BLAKE3 hash state.


---
### fd\_blake3\_new<!-- {{#callable:fd_blake3_new}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.c#L337>)

Initializes a new BLAKE3 hash state in shared memory.
- **Inputs**:
    - `shmem`: A pointer to shared memory where the BLAKE3 hash state will be initialized.
- **Logic and Control Flow**:
    - Cast `shmem` to a `fd_blake3_t` pointer named `sha`.
    - Check if `shmem` is NULL; if so, log a warning and return NULL.
    - Check if `shmem` is aligned according to `fd_blake3_align()`; if not, log a warning and return NULL.
    - Get the footprint size using `fd_blake3_footprint()`.
    - Set the memory at `sha` to zero using `fd_memset`.
    - Use memory fences (`FD_COMPILER_MFENCE`) to ensure memory operations are completed.
    - Set the `magic` field of `sha->pos` to `FD_BLAKE3_MAGIC` using a volatile store.
    - Return the pointer `sha` cast to `void *`.
- **Output**: Returns a pointer to the initialized BLAKE3 hash state, or NULL if initialization fails.
- **Functions Called**:
    - [`fd_blake3_align`](<#fd_blake3_align>)
    - [`fd_blake3_footprint`](<#fd_blake3_footprint>)


---
### fd\_blake3\_join<!-- {{#callable:fd_blake3_join}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.c#L362>)

Validates and returns a pointer to a `fd_blake3_t` structure if the input is correctly aligned and initialized.
- **Inputs**:
    - `shsha`: A pointer to a memory location that is expected to contain a `fd_blake3_t` structure.
- **Logic and Control Flow**:
    - Check if `shsha` is NULL; if true, log a warning and return NULL.
    - Check if `shsha` is aligned according to `fd_blake3_align()`; if not, log a warning and return NULL.
    - Cast `shsha` to a `fd_blake3_t` pointer and store it in `sha`.
    - Check if `sha->pos.magic` equals `FD_BLAKE3_MAGIC`; if not, log a warning and return NULL.
    - Return the `sha` pointer.
- **Output**: A pointer to a `fd_blake3_t` structure if all checks pass, otherwise NULL.
- **Functions Called**:
    - [`fd_blake3_align`](<#fd_blake3_align>)


---
### fd\_blake3\_leave<!-- {{#callable:fd_blake3_leave}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.c#L385>)

Returns the input `sha` pointer if it is not NULL, otherwise logs a warning and returns NULL.
- **Inputs**:
    - `sha`: A pointer to an `fd_blake3_t` structure, representing the BLAKE3 hash state.
- **Logic and Control Flow**:
    - Check if `sha` is NULL using `FD_UNLIKELY` macro.
    - If `sha` is NULL, log a warning message 'NULL sha' and return NULL.
    - If `sha` is not NULL, cast `sha` to a `void *` and return it.
- **Output**: A `void *` pointer to the `sha` if it is not NULL, otherwise NULL.


---
### fd\_blake3\_delete<!-- {{#callable:fd_blake3_delete}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.c#L396>)

Validates and deletes a BLAKE3 hash state object if it is correctly aligned and initialized.
- **Inputs**:
    - `shsha`: A pointer to the BLAKE3 hash state object to delete.
- **Logic and Control Flow**:
    - Check if `shsha` is NULL and log a warning if true, then return NULL.
    - Check if `shsha` is aligned according to `fd_blake3_align()` and log a warning if not, then return NULL.
    - Cast `shsha` to a `fd_blake3_t` pointer named `sha`.
    - Check if `sha->pos.magic` equals `FD_BLAKE3_MAGIC` and log a warning if not, then return NULL.
    - Use memory fences to set `sha->pos.magic` to 0, ensuring memory operations are completed before and after this change.
    - Return the `sha` pointer cast back to a `void *`.
- **Output**: Returns a pointer to the deleted BLAKE3 hash state object if successful, or NULL if any validation fails.
- **Functions Called**:
    - [`fd_blake3_align`](<#fd_blake3_align>)


---
### fd\_blake3\_init<!-- {{#callable:fd_blake3_init}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.c#L424>)

Initializes a BLAKE3 hash state by setting the position and block size to default values.
- **Inputs**:
    - `sha`: A pointer to an `fd_blake3_t` structure that represents the BLAKE3 hash state to initialize.
- **Logic and Control Flow**:
    - Logs the initialization call with the provided `sha` pointer.
    - Calls `fd_blake3_pos_init` to initialize the position within the `sha` structure with default values (NULL data and size 0).
    - Sets the `block_sz` field of `sha` to 0.
    - Returns the initialized `sha` pointer.
- **Output**: Returns the initialized `fd_blake3_t` pointer.


---
### fd\_blake3\_append\_blocks<!-- {{#callable:fd_blake3_append_blocks}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.c#L458>)

Processes a series of data blocks for the BLAKE3 hash function, preparing and compressing them as needed.
- **Inputs**:
    - ``s``: A pointer to a `fd_blake3_pos_t` structure representing the current state of the hash operation.
    - ``tbl``: A pointer to a `fd_blake3_buf_t` structure used as a buffer for intermediate hash values.
    - ``data``: A pointer to the input data to be processed.
    - ``buf_cnt``: An unsigned long integer representing the number of blocks to process.
- **Logic and Control Flow**:
    - Initialize the input pointer in the state `s` by adjusting the `data` pointer based on the current leaf index.
    - Enter a loop that continues while `buf_cnt` is non-zero.
    - Within the loop, call [`fd_blake3_prepare`](<#fd_blake3_prepare>) to prepare the next operation; if no operation is prepared, exit the loop.
    - Check if the operation is a parent node by examining the `flags` field; if so, compress the output chaining values using [`fd_blake3_ref_compress1`](<fd_blake3_ref.c.md#fd_blake3_ref_compress1>).
    - If the operation is not a parent node, compress the leaf chunks and decrement `buf_cnt`.
    - Increment the `next_tick` field in the state `s` after each operation.
- **Output**: No direct output is returned; the function modifies the state `s` and buffer `tbl` to reflect the processed data.
- **Functions Called**:
    - [`fd_blake3_prepare`](<#fd_blake3_prepare>)
    - [`fd_blake3_ref_compress1`](<fd_blake3_ref.c.md#fd_blake3_ref_compress1>)


---
### fd\_blake3\_append<!-- {{#callable:fd_blake3_append}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.c#L485>)

Appends data to a BLAKE3 hash state, handling buffered data and processing complete blocks.
- **Inputs**:
    - `sha`: A pointer to the BLAKE3 hash state structure (`fd_blake3_t`).
    - `_data`: A pointer to the data to append to the hash.
    - `sz`: The size of the data to append, in bytes.
- **Logic and Control Flow**:
    - If `sz` is zero, return `sha` immediately as there is no data to append.
    - Log the function call with the input parameters for debugging purposes.
    - Unpack the hash state structure to access the position, buffer, and block size.
    - Update the total input size in the hash state by adding `sz`.
    - Check for an edge case where the input size reaches 1024 bytes and handle it by copying data to the buffer without hashing.
    - If there are buffered bytes from previous appends, check if the new data can complete the current block.
    - If the new data is insufficient to complete the block, buffer it and return.
    - If the block can be completed, copy enough data to complete the block, update the hash, and continue processing remaining data.
    - Process the bulk of the data by appending complete blocks using `fd_blake3_append_blocks`.
    - Buffer any leftover bytes that do not form a complete block.
    - Log the completion of the append operation and return the updated hash state.
- **Output**: Returns a pointer to the updated BLAKE3 hash state (`fd_blake3_t *`).


---
### fd\_blake3\_single\_hash<!-- {{#callable:fd_blake3_single_hash}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.c#L560>)

Computes a BLAKE3 hash for a given input state and buffer, handling both single and parallel processing modes.
- **Inputs**:
    - ``s``: A pointer to `fd_blake3_pos_t`, representing the current state of the hash computation.
    - ``tbl``: A pointer to `fd_blake3_buf_t`, representing the buffer used for storing intermediate hash values.
- **Logic and Control Flow**:
    - If `FD_BLAKE3_PARA_MAX` is greater than 1, initialize `tick` to 0 and enter a loop that continues until [`fd_blake3_is_finished`](<#fd_blake3_is_finished>) returns true for the current state and `tick`.
    - Within the loop, initialize an array `ops` of `fd_blake3_op_t` with size `FD_BLAKE3_PARA_MAX` and set `op_cnt` to 0.
    - While `op_cnt` is less than `FD_BLAKE3_PARA_MAX`, prepare operations using [`fd_blake3_prepare`](<#fd_blake3_prepare>). If preparation fails, break the loop; otherwise, increment `op_cnt`.
    - Call [`fd_blake3_batch_hash`](<#fd_blake3_batch_hash>) with the prepared operations and increment `tick`.
    - If `FD_BLAKE3_PARA_MAX` is not greater than 1, enter a loop that continues until [`fd_blake3_is_finished`](<#fd_blake3_is_finished>) returns true for the current state and `s->next_tick`.
    - Within the loop, prepare a single operation using [`fd_blake3_prepare`](<#fd_blake3_prepare>). If preparation fails, break the loop; otherwise, increment `s->next_tick`.
    - Log the compression details using `FD_BLAKE3_TRACE` and perform compression using either [`fd_blake3_sse_compress1`](<fd_blake3_sse41.c.md#fd_blake3_sse_compress1>) or [`fd_blake3_ref_compress1`](<fd_blake3_ref.c.md#fd_blake3_ref_compress1>) based on the availability of SSE support.
- **Output**: Returns a pointer to the first slot of the buffer at the current layer of the state.
- **Functions Called**:
    - [`fd_blake3_is_finished`](<#fd_blake3_is_finished>)
    - [`fd_blake3_prepare`](<#fd_blake3_prepare>)
    - [`fd_blake3_batch_hash`](<#fd_blake3_batch_hash>)
    - [`fd_blake3_sse_compress1`](<fd_blake3_sse41.c.md#fd_blake3_sse_compress1>)
    - [`fd_blake3_ref_compress1`](<fd_blake3_ref.c.md#fd_blake3_ref_compress1>)


---
### fd\_blake3\_fini<!-- {{#callable:fd_blake3_fini}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.c#L596>)

Finalizes the BLAKE3 hash computation and writes the hash result to the provided buffer.
- **Inputs**:
    - ``sha``: A pointer to the `fd_blake3_t` structure representing the current state of the BLAKE3 hash computation.
    - ``hash``: A pointer to a buffer where the final hash result will be stored.
- **Logic and Control Flow**:
    - Unpacks the inputs by extracting the position and buffer from the `sha` structure.
    - Calculates the total input size by combining the current buffer usage and the processed leaf index.
    - Calls [`fd_blake3_single_hash`](<#fd_blake3_single_hash>) to compute the hash of the current state.
    - Copies the computed hash (32 bytes) into the provided `hash` buffer.
    - Returns the `hash` pointer.
- **Output**: Returns a pointer to the `hash` buffer containing the final 32-byte hash result.
- **Functions Called**:
    - [`fd_blake3_single_hash`](<#fd_blake3_single_hash>)


---
### fd\_blake3\_fini\_xof\_compress<!-- {{#callable:fd_blake3_fini_xof_compress}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.c#L627>)

Performs BLAKE3 compression for all blocks in the hash tree except the root block, returning the root block's message and chaining value.
- **Inputs**:
    - ``sha``: A pointer to the `fd_blake3_t` structure representing the BLAKE3 hash state.
    - ``root_msg``: A pointer to a buffer where the padded message input for the root block will be stored.
    - ``root_cv_pre``: A pointer to a buffer where the output chaining value of the previous block will be stored.
- **Logic and Control Flow**:
    - Initialize local variables `s`, `tbl`, `buf`, and `buf_used` from the `sha` structure.
    - Calculate `s->input` and `s->input_sz` based on the current buffer and leaf index.
    - If the input size is less than or equal to `FD_BLAKE3_CHUNK_SZ`, prepare a leaf operation and perform compression using either SSE or reference implementation.
    - If the input size is greater than `FD_BLAKE3_CHUNK_SZ`, enter a loop to process branch nodes until only two blocks remain.
    - Within the loop, prepare operations for parallel or single compression based on `FD_BLAKE3_PARA_MAX`, and perform batch or single compression accordingly.
    - Increment the tick counter after each iteration of the loop.
- **Output**: The function does not return a value, but it modifies `root_msg` and `root_cv_pre` to contain the root block's message and chaining value, respectively.
- **Functions Called**:
    - [`fd_blake3_prepare_leaf`](<#fd_blake3_prepare_leaf>)
    - [`fd_blake3_sse_compress1`](<fd_blake3_sse41.c.md#fd_blake3_sse_compress1>)
    - [`fd_blake3_ref_compress1`](<fd_blake3_ref.c.md#fd_blake3_ref_compress1>)
    - [`fd_blake3_l0_complete`](<#fd_blake3_l0_complete>)
    - [`fd_blake3_prepare`](<#fd_blake3_prepare>)
    - [`fd_blake3_batch_hash`](<#fd_blake3_batch_hash>)


---
### fd\_blake3\_fini\_2048<!-- {{#callable:fd_blake3_fini_2048}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.c#L690>)

Generates a 2048-byte hash using the BLAKE3 algorithm with SIMD parallel processing for performance.
- **Inputs**:
    - `sha`: A pointer to an `fd_blake3_t` structure representing the BLAKE3 hash state.
    - `hash`: A pointer to a memory location where the resulting 2048-byte hash will be stored.
- **Logic and Control Flow**:
    - Compresses input data until only the BLAKE3 root block remains, using [`fd_blake3_fini_xof_compress`](<#fd_blake3_fini_xof_compress>) to handle non-root blocks.
    - Restores details of the root block, including size, flags, and counter, based on the input size and alignment.
    - Uses SIMD instructions (AVX512, AVX, or SSE) to repeatedly compress the root block, expanding the hash output to 2048 bytes.
    - Handles different SIMD instruction sets by checking for AVX512, AVX, or SSE support and calling the appropriate compression function.
    - Returns the pointer to the `hash` location after processing is complete.
- **Output**: A pointer to the `hash` location containing the 2048-byte hash result.
- **Functions Called**:
    - [`fd_blake3_fini_xof_compress`](<#fd_blake3_fini_xof_compress>)
    - [`fd_blake3_prepare`](<#fd_blake3_prepare>)
    - [`fd_blake3_avx512_compress16`](<fd_blake3_avx512.c.md#fd_blake3_avx512_compress16>)
    - [`fd_blake3_avx_compress8`](<fd_blake3_avx2.c.md#fd_blake3_avx_compress8>)
    - [`fd_blake3_sse_compress1`](<fd_blake3_sse41.c.md#fd_blake3_sse_compress1>)
    - [`fd_blake3_ref_compress1`](<fd_blake3_ref.c.md#fd_blake3_ref_compress1>)


---
### fd\_blake3\_hash<!-- {{#callable:fd_blake3_hash}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.c#L759>)

Computes the BLAKE3 hash of the given data and stores the result in the provided hash buffer.
- **Inputs**:
    - `data`: A pointer to the input data to hash.
    - `sz`: The size of the input data in bytes.
    - `hash`: A pointer to the buffer where the resulting hash will be stored.
- **Logic and Control Flow**:
    - Initialize the BLAKE3 position state `s` with the input data and size using `fd_blake3_pos_init`.
    - If `FD_BLAKE3_PARA_MAX` is greater than 1, enter a loop to prepare and compress data in parallel using [`fd_blake3_prepare_fast`](<#fd_blake3_prepare_fast>).
    - Depending on the available instruction set (AVX512 or AVX), use the appropriate fast compression function ([`fd_blake3_avx512_compress16_fast`](<fd_blake3_avx512.c.md#fd_blake3_avx512_compress16_fast>) or [`fd_blake3_avx_compress8_fast`](<fd_blake3_avx2.c.md#fd_blake3_avx_compress8_fast>)).
    - Exit the loop when no more operations can be prepared for fast processing.
    - Call [`fd_blake3_single_hash`](<#fd_blake3_single_hash>) to finalize the hash computation and obtain the hash value.
    - Copy the computed hash value to the provided `hash` buffer using `memcpy`.
    - Return the `hash` pointer.
- **Output**: A pointer to the buffer containing the computed hash.
- **Functions Called**:
    - [`fd_blake3_prepare_fast`](<#fd_blake3_prepare_fast>)
    - [`fd_blake3_avx512_compress16_fast`](<fd_blake3_avx512.c.md#fd_blake3_avx512_compress16_fast>)
    - [`fd_blake3_avx_compress8_fast`](<fd_blake3_avx2.c.md#fd_blake3_avx_compress8_fast>)
    - [`fd_blake3_single_hash`](<#fd_blake3_single_hash>)


---
### fd\_blake3\_lthash\_batch8<!-- {{#callable:fd_blake3_lthash_batch8}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.c#L790>)

Processes a batch of 8 data inputs using the BLAKE3 hash function and outputs the hash results.
- **Inputs**:
    - `batch_data`: An array of 8 pointers to data blocks, each aligned to 32 bytes.
    - `batch_sz`: An array of 8 unsigned integers representing the size of each data block, aligned to 32 bytes.
    - `out_lthash`: A pointer to the output buffer where the hash results will be stored, aligned to 32 bytes.
- **Logic and Control Flow**:
    - Checks if `batch_data`, `batch_sz`, and `out_lthash` are aligned to 32 bytes; logs an error if not.
    - Initializes `batch_ctr` array with zeros and `batch_flags` array with `FD_BLAKE3_FLAG_ROOT` for each element.
    - Calls [`fd_blake3_avx_compress8`](<fd_blake3_avx2.c.md#fd_blake3_avx_compress8>) to perform the BLAKE3 hash compression on the batch of data.
- **Output**: The function does not return a value; it writes the hash results to the `out_lthash` buffer.
- **Functions Called**:
    - [`fd_blake3_avx_compress8`](<fd_blake3_avx2.c.md#fd_blake3_avx_compress8>)


---
### fd\_blake3\_lthash\_batch16<!-- {{#callable:fd_blake3_lthash_batch16}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3.c#L815>)

Processes a batch of 16 data inputs using the BLAKE3 hash function and outputs the hash results.
- **Inputs**:
    - `batch_data`: An array of 16 pointers to data blocks to be hashed, each aligned to 32 bytes.
    - `batch_sz`: An array of 16 unsigned integers representing the size of each data block, aligned to 32 bytes.
    - `out_lthash`: A pointer to the output buffer where the hash results will be stored, aligned to 32 bytes.
- **Logic and Control Flow**:
    - Checks if `batch_data`, `batch_sz`, and `out_lthash` are aligned to 64 bytes; logs an error if not.
    - Initializes `batch_ctr` array with zeros and `batch_flags` array with `FD_BLAKE3_FLAG_ROOT` for each element.
    - Calls [`fd_blake3_avx512_compress16`](<fd_blake3_avx512.c.md#fd_blake3_avx512_compress16>) to perform the hash computation on the batch of data.
- **Output**: Stores the computed hash results in the `out_lthash` buffer.
- **Functions Called**:
    - [`fd_blake3_avx512_compress16`](<fd_blake3_avx512.c.md#fd_blake3_avx512_compress16>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)