<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Optimized SSE4.1 implementation of the BLAKE3 hash function compression routine.

# Purpose
The code is part of the BLAKE3 cryptographic hash function implementation, specifically optimized for SSE (Streaming SIMD Extensions) instructions. It defines several static inline functions and a primary function, [`fd_blake3_sse_compress1`](<#fd_blake3_sse_compress1>), which performs the compression step of the BLAKE3 hash algorithm. The compression function processes input message blocks and updates the chaining values using a series of bitwise operations, rotations, and permutations. The code uses SIMD operations to enhance performance by processing multiple data elements in parallel.

The [`fd_blake3_sse_compress1`](<#fd_blake3_sse_compress1>) function takes several parameters, including pointers to the output buffer, input message, message size, a counter, flags, and optional chaining values. It ensures that the message size does not exceed the defined chunk size and processes the message in blocks. The function uses helper functions like [`g1`](<#g1>), [`g2`](<#g2>), [`diagonalize`](<#diagonalize>), and [`undiagonalize`](<#undiagonalize>) to perform the necessary transformations on the data. The code also includes logic to handle different flag conditions and manage the transition between compression and expansion phases. The use of macros and inline functions helps to maintain efficiency and readability in the implementation.
# Imports and Dependencies

---
- `fd_blake3.h`
- `fd_blake3_private.h`
- `../../util/simd/fd_sse.h`
- `assert.h`


# Functions

---
### vu\_rot12<!-- {{#callable:vu_rot12}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3_sse41.c#L16>)

Performs a bitwise rotation of a 128-bit vector `x` by 12 bits to the right.
- **Inputs**:
    - `x`: A 128-bit vector of type `vu_t` to rotate.
- **Logic and Control Flow**:
    - Shifts the vector `x` right by 12 bits using `vu_shr` function.
    - Shifts the vector `x` left by 20 bits (32-12) using `vu_shl` function.
    - Combines the results of the two shifts using a bitwise XOR operation with `vu_xor`.
- **Output**: A 128-bit vector of type `vu_t` that is the result of rotating `x` by 12 bits to the right.


---
### vu\_rot8<!-- {{#callable:vu_rot8}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3_sse41.c#L21>)

Performs an 8-byte rotation on a 128-bit vector using a predefined shuffle mask.
- **Inputs**:
    - ``x``: A 128-bit vector of type `vu_t` to be rotated.
- **Logic and Control Flow**:
    - Defines a constant shuffle mask `vb_t const mask` with the pattern `vb(1,2,3,0, 5,6,7,4, 9,10,11,8, 13,14,15,12)` to rearrange bytes.
    - Uses the `_mm_shuffle_epi8` intrinsic to apply the shuffle mask to the input vector `x`, effectively rotating its bytes.
- **Output**: Returns a 128-bit vector of type `vu_t` with its bytes rotated according to the shuffle mask.


---
### vu\_rot7<!-- {{#callable:vu_rot7}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3_sse41.c#L27>)

Performs a 7-bit rotation on a vector by combining right and left shifts with a bitwise XOR operation.
- **Inputs**:
    - `x`: A vector of type `vu_t` to rotate.
- **Logic and Control Flow**:
    - Shifts the input vector `x` to the right by 7 bits using `vu_shr(x, 7)`.
    - Shifts the input vector `x` to the left by 25 bits (32-7) using `vu_shl(x, 32-7)`.
    - Combines the results of the right and left shifts using a bitwise XOR operation with `vu_xor`.
- **Output**: Returns a vector of type `vu_t` that is the result of the 7-bit rotation.


---
### g1<!-- {{#callable:g1}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3_sse41.c#L32>)

Performs a series of vector operations on four input vectors and a scalar to modify the vectors in place.
- **Inputs**:
    - ``row0``: A pointer to a `vu_t` vector that will be modified in place.
    - ``row1``: A pointer to a `vu_t` vector that will be modified in place.
    - ``row2``: A pointer to a `vu_t` vector that will be modified in place.
    - ``row3``: A pointer to a `vu_t` vector that will be modified in place.
    - ``m``: A `vu_t` vector used in the computation to modify the input vectors.
- **Logic and Control Flow**:
    - Add `m` to `*row0` and then add `*row1` to the result, storing it back in `*row0`.
    - Perform a bitwise XOR between `*row3` and `*row0`, storing the result in `*row3`.
    - Rotate the bits of `*row3` by 16 positions using `vu_rot16` and store the result back in `*row3`.
    - Add `*row3` to `*row2` and store the result back in `*row2`.
    - Perform a bitwise XOR between `*row1` and `*row2`, storing the result in `*row1`.
    - Rotate the bits of `*row1` by 12 positions using [`vu_rot12`](<#vu_rot12>) and store the result back in `*row1`.
- **Output**: The function does not return a value; it modifies the input vectors in place.
- **Functions Called**:
    - [`vu_rot12`](<#vu_rot12>)


---
### g2<!-- {{#callable:g2}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3_sse41.c#L46>)

Performs a series of vector operations on four input vectors and a scalar to modify the vectors in place.
- **Inputs**:
    - `row0`: A pointer to a `vu_t` vector that will be modified in place.
    - `row1`: A pointer to a `vu_t` vector that will be modified in place.
    - `row2`: A pointer to a `vu_t` vector that will be modified in place.
    - `row3`: A pointer to a `vu_t` vector that will be modified in place.
    - `m`: A `vu_t` vector used as a scalar in the operations.
- **Logic and Control Flow**:
    - Add `m` to `*row0` and then add `*row1` to the result, storing it back in `*row0`.
    - XOR `*row3` with `*row0` and store the result in `*row3`.
    - Rotate `*row3` by 8 bits and store the result back in `*row3`.
    - Add `*row3` to `*row2` and store the result in `*row2`.
    - XOR `*row1` with `*row2` and store the result in `*row1`.
    - Rotate `*row1` by 7 bits and store the result back in `*row1`.
- **Output**: The function does not return a value; it modifies the input vectors in place.
- **Functions Called**:
    - [`vu_rot8`](<#vu_rot8>)
    - [`vu_rot7`](<#vu_rot7>)


---
### diagonalize<!-- {{#callable:diagonalize}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3_sse41.c#L63>)

Reorders the elements of three 128-bit vectors using specific shuffle patterns.
- **Inputs**:
    - `row0`: A pointer to a 128-bit vector (`vu_t`) that will be shuffled with the pattern `_MM_SHUFFLE(2, 1, 0, 3)`.
    - `row2`: A pointer to a 128-bit vector (`vu_t`) that will be shuffled with the pattern `_MM_SHUFFLE(0, 3, 2, 1)`.
    - `row3`: A pointer to a 128-bit vector (`vu_t`) that will be shuffled with the pattern `_MM_SHUFFLE(1, 0, 3, 2)`.
- **Logic and Control Flow**:
    - Shuffle the elements of `*row0` using the pattern `_MM_SHUFFLE(2, 1, 0, 3)` and store the result back in `*row0`.
    - Shuffle the elements of `*row3` using the pattern `_MM_SHUFFLE(1, 0, 3, 2)` and store the result back in `*row3`.
    - Shuffle the elements of `*row2` using the pattern `_MM_SHUFFLE(0, 3, 2, 1)` and store the result back in `*row2`.
- **Output**: No return value; the function modifies the input vectors in place.


---
### undiagonalize<!-- {{#callable:undiagonalize}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3_sse41.c#L70>)

Reorders the elements of three 128-bit vectors to reverse a previous diagonalization operation.
- **Inputs**:
    - `row0`: A pointer to a 128-bit vector (`vu_t`) that represents the first row to be undiagonalized.
    - `row2`: A pointer to a 128-bit vector (`vu_t`) that represents the second row to be undiagonalized.
    - `row3`: A pointer to a 128-bit vector (`vu_t`) that represents the third row to be undiagonalized.
- **Logic and Control Flow**:
    - Reorders the elements of `row0` using `_mm_shuffle_epi32` with the shuffle mask `_MM_SHUFFLE(0, 3, 2, 1)`.
    - Reorders the elements of `row3` using `_mm_shuffle_epi32` with the shuffle mask `_MM_SHUFFLE(1, 0, 3, 2)`.
    - Reorders the elements of `row2` using `_mm_shuffle_epi32` with the shuffle mask `_MM_SHUFFLE(2, 1, 0, 3)`.
- **Output**: No return value; the function modifies the input vectors in place.


---
### compress\_pre<!-- {{#callable:compress_pre}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3_sse41.c#L77>)

Initializes and processes the state for the BLAKE3 compression function using SIMD operations.
- **Inputs**:
    - ``rows``: An array of 4 `vu_t` vectors that will hold the state of the compression function.
    - ``cv``: A constant array of 8 unsigned integers representing the chaining value.
    - ``block``: A constant array of unsigned characters representing the input block to be compressed.
    - ``block_len``: An unsigned integer representing the length of the block.
    - ``ctr``: An unsigned long integer representing the counter value.
    - ``flags``: An unsigned integer representing the flags for the compression function.
- **Logic and Control Flow**:
    - Load the first two `rows` with the chaining value `cv` using `vu_ld` function.
    - Initialize the third `row` with the BLAKE3 initialization vector `FD_BLAKE3_IV`.
    - Set the fourth `row` with the counter, block length, and flags.
    - Load the message block into four `vu_t` vectors `m0`, `m1`, `m2`, and `m3` using `vb_ldu`.
    - Perform 7 rounds of the BLAKE3 compression function, each consisting of permutations and mixing operations using [`g1`](<#g1>) and [`g2`](<#g2>) functions.
    - In each round, shuffle and blend the message vectors, apply the [`g1`](<#g1>) and [`g2`](<#g2>) functions, and diagonalize and undiagonalize the `rows`.
    - Update the message vectors `m0`, `m1`, `m2`, and `m3` after each round.
- **Output**: The function modifies the `rows` array in place to reflect the updated state after processing the input block.
- **Functions Called**:
    - [`g1`](<#g1>)
    - [`g2`](<#g2>)
    - [`diagonalize`](<#diagonalize>)
    - [`undiagonalize`](<#undiagonalize>)


---
### fd\_blake3\_sse\_compress1<!-- {{#callable:fd_blake3_sse_compress1}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3_sse41.c#L250>)

Compresses a message block using the BLAKE3 hash function with SSE optimizations.
- **Inputs**:
    - `out`: A pointer to the output buffer where the compressed result will be stored.
    - `msg`: A pointer to the input message to be compressed.
    - `msg_sz`: The size of the input message in bytes.
    - `counter`: A counter value used in the compression process.
    - `flags`: Flags that modify the behavior of the compression, such as indicating the start or end of a chunk.
    - `out_chain`: A pointer to the output chaining value buffer, used if the function is in XOF mode.
    - `in_chain`: A pointer to the input chaining value buffer, used to initialize the compression state.
- **Logic and Control Flow**:
    - Initialize the chaining value `cv` with the BLAKE3 initialization vector or `in_chain` if provided.
    - Set up `flag_mask` to modify flags based on whether the current block is a parent node.
    - Determine `block_flags` by combining `flags` with `flag_mask` and adjust based on `in_chain` and chunk start conditions.
    - Enter a loop to process the message in blocks of size `FD_BLAKE3_BLOCK_SZ`.
    - For each block, determine if it is the last block and adjust `block_flags` accordingly.
    - If the message size is less than `FD_BLAKE3_BLOCK_SZ`, pad the block with zeros.
    - If `out_chain` is provided and the block is the end of a chunk, copy the block and chaining value to `out` and `out_chain`, then return.
    - Call [`compress_pre`](<#compress_pre>) to perform the compression on the current block.
    - Update the chaining value `cv` with the result of the compression.
    - Continue processing until all message blocks are processed.
    - Store the final chaining value in `out`.
- **Output**: The function outputs the compressed result in the `out` buffer and optionally updates the `out_chain` buffer with the chaining value if in XOF mode.
- **Functions Called**:
    - [`compress_pre`](<#compress_pre>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)