<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Optimized BLAKE3 hash function implementation using AVX-512 instructions for batch processing.

# Purpose
The code is part of an implementation of the BLAKE3 cryptographic hash function, specifically optimized for AVX512 SIMD instructions. It includes functions to perform the BLAKE3 compression operation on multiple data blocks in parallel, leveraging the AVX512 instruction set for improved performance on compatible hardware. The primary function, [`fd_blake3_avx512_compress16`](<#fd_blake3_avx512_compress16>), processes up to 16 blocks of data simultaneously, using a series of vectorized operations to compute the hash values efficiently. The function handles various input parameters, such as batch size, data, and flags, and it manages the processing of message blocks, including handling tail blocks when the data size is not a multiple of the block size.

The code also includes a helper function, [`round_fn16`](<#round_fn16>), which performs the core BLAKE3 round transformations on the input vectors. This function is called multiple times within the compression function to iteratively update the state vectors. Additionally, the code provides a fast compression function, [`fd_blake3_avx512_compress16_fast`](<#fd_blake3_avx512_compress16_fast>), which is a streamlined version for specific use cases where the input size and flags are known in advance. The code is designed to be part of a larger library, as indicated by the inclusion of private headers and utility functions, and it is intended to be used as a backend for hashing operations that require high throughput and efficiency.
# Imports and Dependencies

---
- `fd_blake3_private.h`
- `../../util/simd/fd_avx512.h`
- `../../util/simd/fd_avx.h`


# Functions

---
### round\_fn16<!-- {{#callable:round_fn16}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3_avx512.c#L9>)

Performs a round of the BLAKE3 compression function on 16-word vectors using a message schedule and a round index.
- **Inputs**:
    - ``v``: An array of 16 `wwu_t` elements representing the state vector to be transformed.
    - ``m``: An array of 16 `wwu_t` elements representing the message block to be used in the transformation.
    - ``r``: An unsigned long integer representing the round index used to select message schedule indices.
- **Logic and Control Flow**:
    - Add elements from `m` to `v` using indices from `FD_BLAKE3_MSG_SCHEDULE` based on `r`.
    - Add elements from `v[0x4]` to `v[0x7]` to `v[0x0]` to `v[0x3]`.
    - XOR elements `v[0x0]` to `v[0x3]` with `v[0xc]` to `v[0xf]`.
    - Rotate right `v[0xc]` to `v[0xf]` by 16 bits.
    - Add `v[0xc]` to `v[0xf]` to `v[0x8]` to `v[0xb]`.
    - XOR `v[0x8]` to `v[0xb]` with `v[0x4]` to `v[0x7]`.
    - Rotate right `v[0x4]` to `v[0x7]` by 12 bits.
    - Repeat similar operations with different indices and rotations (8 and 7 bits) for the remaining steps.
- **Output**: The function modifies the `v` array in place, updating its elements based on the BLAKE3 compression function logic.


---
### fd\_blake3\_avx512\_compress16<!-- {{#callable:fd_blake3_avx512_compress16}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3_avx512.c#L128>)

Processes up to 16 BLAKE3 hash computations in parallel using AVX-512 instructions.
- **Inputs**:
    - `batch_cnt`: The number of hash computations to process, must be between 1 and 16.
    - `_batch_data`: Pointer to the input data for each hash computation.
    - `batch_sz`: Array of sizes for each input data block.
    - `ctr_vec`: Array of counter values for each hash computation.
    - `batch_flags`: Array of flags for each hash computation.
    - `_batch_hash`: Array of pointers to store the resulting hash for each computation.
    - `lthash`: Pointer to store the LtHash output, if applicable.
    - `out_sz`: The size of the output hash, either 32 or 64 bytes.
    - `batch_cv`: Pointer to custom chaining values, if applicable.
- **Logic and Control Flow**:
    - Checks if `batch_cnt` is valid and logs an error if not.
    - Processes a single hash computation using [`fd_blake3_sse_compress1`](<fd_blake3_sse41.c.md#fd_blake3_sse_compress1>) if `batch_cnt` is 1.
    - Initializes variables and prepares tail blocks for each message.
    - Loads and processes data blocks in 64-byte segments, handling tail blocks as needed.
    - Uses AVX-512 instructions to perform the BLAKE3 compression function in parallel for up to 16 lanes.
    - Handles special cases for LtHash mode and custom chaining values.
    - Stores the resulting hashes in the provided output pointers.
- **Output**: Stores the resulting hashes in the provided `_batch_hash` pointers, with optional LtHash output in `lthash`.
- **Functions Called**:
    - [`fd_blake3_sse_compress1`](<fd_blake3_sse41.c.md#fd_blake3_sse_compress1>)
    - [`round_fn16`](<#round_fn16>)


---
### fd\_blake3\_avx512\_compress16\_fast<!-- {{#callable:fd_blake3_avx512_compress16_fast}} -->
[View Source →](<../../../../../src/ballet/blake3/fd_blake3_avx512.c#L627>)

Performs a fast compression of 16 BLAKE3 blocks using AVX-512 instructions.
- **Inputs**:
    - `msg`: Pointer to the input message data to compress.
    - `out`: Pointer to the output buffer where the compressed data will be stored.
    - `counter`: Counter value used in the compression process.
    - `flags`: Flags that modify the behavior of the compression, such as indicating if the node is a parent.
- **Logic and Control Flow**:
    - Initialize variables and constants, including the initial hash values and the size of the data to process.
    - Determine if the current node is a parent and set the size of the data block accordingly.
    - Calculate the low and high parts of the counter, adjusting for carry if necessary.
    - Iterate over the message data in blocks of `FD_BLAKE3_BLOCK_SZ`, updating the offset each time.
    - For each block, load the message data into a 16-element array and transpose it for processing.
    - Initialize the state vector with the current hash values, IVs, counter, size, and flags.
    - Perform 7 rounds of the BLAKE3 compression function using the [`round_fn16`](<#round_fn16>) function.
    - Update the hash values by XORing the current state with the initial state.
    - Continue processing until all data blocks are processed.
    - Transpose the final hash values and store them in the output buffer.
- **Output**: The function outputs the compressed data into the buffer pointed to by `out`.
- **Functions Called**:
    - [`round_fn16`](<#round_fn16>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)