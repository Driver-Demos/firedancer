<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for the SBPF loader, focusing on duplicate entry points and zero text count scenarios.

# Purpose
The code is a C program that tests the loading and handling of eBPF (extended Berkeley Packet Filter) programs using the `fd_sbpf_loader` library. It includes two main test functions: [`test_duplicate_entrypoint_entry`](<#test_duplicate_entrypoint_entry>) and [`test_zero_text_cnt`](<#test_zero_text_cnt>). These functions test specific properties of ELF (Executable and Linkable Format) files related to eBPF programs. The [`test_duplicate_entrypoint_entry`](<#test_duplicate_entrypoint_entry>) function checks the handling of ELF files with duplicate entry points, ensuring that only the correct entry point is registered. The [`test_zero_text_cnt`](<#test_zero_text_cnt>) function verifies the behavior when the text section count is zero, ensuring that the program's call destinations and entry point are correctly set to null or zero.

The program uses a set of predefined syscalls, stored in the `_syscalls` array, which are inserted into the eBPF program's syscall table. The [`main`](<#main>) function initializes the environment, allocates memory for testing, and calls the test functions. It uses the `fd_scratch` memory management system to allocate and manage memory during the tests. The program concludes by detaching the scratch memory and halting the execution. The code is structured to be executed as a standalone program, with the [`main`](<#main>) function serving as the entry point.
# Imports and Dependencies

---
- `fd_sbpf_loader.h`
- `../../util/fd_util.h`


# Global Variables

---
### \_syscalls
- **Type**: ``uint const[]``
- **Description**: An array of constant unsigned integers that represents syscall identifiers. Each element in the array is a hexadecimal value corresponding to a specific syscall.
- **Use**: Used to insert syscall identifiers into an `fd_sbpf_syscalls_t` structure for program loading.


# Functions

---
### test\_duplicate\_entrypoint\_entry<!-- {{#callable:test_duplicate_entrypoint_entry}} -->
[View Source →](<../../../../../src/ballet/sbpf/test_sbpf_loader.c#L41>)

Tests the loading and validation of an ELF file with duplicate entry points using the sBPF loader.
- **Inputs**: None
- **Logic and Control Flow**:
    - Pushes the current state onto the scratch memory stack using `fd_scratch_push()`.
    - Initializes an `fd_sbpf_loader_config_t` structure with specific configuration values for ELF deployment checks and sBPF version range.
    - Calls `fd_sbpf_elf_peek()` to retrieve ELF information into `info` using the `duplicate_entrypoint_entry_elf` data and the configuration.
    - Allocates read-only data memory using `fd_scratch_alloc()` based on the binary size from `info`.
    - Creates a new sBPF program using `fd_sbpf_program_new()` with allocated memory and ELF information.
    - Initializes a new sBPF syscalls structure using `fd_sbpf_syscalls_new()` and allocates necessary memory.
    - Inserts predefined syscalls from `_syscalls` array into the syscalls structure using `fd_sbpf_syscalls_insert()`.
    - Allocates scratch memory for loading the program using `fd_scratch_alloc()`.
    - Loads the sBPF program using `fd_sbpf_program_load()` with the ELF data, syscalls, configuration, and scratch memory.
    - Asserts that the program loading result `res` is zero using `FD_TEST()`.
    - Tests that the call destinations do not include the bad entry point at PC 595 using `fd_sbpf_calldests_test()` and `FD_TEST()`.
    - Tests that the call destinations include the correct entry point at PC 3920 using `fd_sbpf_calldests_test()` and `FD_TEST()`.
    - Asserts that the program's entry point is set to 3920 using `FD_TEST()`.
- **Output**: No output is returned; the function uses assertions to validate conditions.
- **Functions Called**:
    - [`fd_sbpf_elf_peek`](<fd_sbpf_loader.c.md#fd_sbpf_elf_peek>)
    - [`fd_sbpf_program_new`](<fd_sbpf_loader.c.md#fd_sbpf_program_new>)
    - [`fd_sbpf_program_align`](<fd_sbpf_loader.c.md#fd_sbpf_program_align>)
    - [`fd_sbpf_program_footprint`](<fd_sbpf_loader.c.md#fd_sbpf_program_footprint>)
    - [`fd_sbpf_program_load`](<fd_sbpf_loader.c.md#fd_sbpf_program_load>)


---
### test\_zero\_text\_cnt<!-- {{#callable:test_zero_text_cnt}} -->
[View Source →](<../../../../../src/ballet/sbpf/test_sbpf_loader.c#L71>)

Tests the loading of an ELF file with zero text count and verifies the program's properties.
- **Inputs**: None
- **Logic and Control Flow**:
    - Pushes the current state onto the scratch memory stack using `fd_scratch_push`.
    - Initializes an `fd_sbpf_elf_info_t` structure named `info`.
    - Configures `fd_sbpf_loader_config_t` with `elf_deploy_checks` set to 0, `sbpf_min_version` set to `FD_SBPF_V0`, and `sbpf_max_version` set to `FD_SBPF_V3`.
    - Calls [`fd_sbpf_elf_peek`](<fd_sbpf_loader.c.md#fd_sbpf_elf_peek>) to populate `info` with details from `zero_text_cnt_elf`.
    - Allocates read-only data memory using `fd_scratch_alloc` and checks its success with `FD_TEST`.
    - Creates a new SBPF program using [`fd_sbpf_program_new`](<fd_sbpf_loader.c.md#fd_sbpf_program_new>) with allocated memory and `info`.
    - Creates a new SBPF syscalls object using `fd_sbpf_syscalls_new` and allocates memory for it.
    - Inserts predefined syscalls from `_syscalls` into the `syscalls` object using `fd_sbpf_syscalls_insert`.
    - Allocates scratch memory for loading the program using `fd_scratch_alloc`.
    - Loads the SBPF program using [`fd_sbpf_program_load`](<fd_sbpf_loader.c.md#fd_sbpf_program_load>) and checks the result with `FD_TEST`.
    - Verifies that `prog->calldests` is `NULL` and `prog->entry_pc` is `0UL` using `FD_TEST`.
- **Output**: No output is returned; the function performs tests and uses assertions to validate conditions.
- **Functions Called**:
    - [`fd_sbpf_elf_peek`](<fd_sbpf_loader.c.md#fd_sbpf_elf_peek>)
    - [`fd_sbpf_program_new`](<fd_sbpf_loader.c.md#fd_sbpf_program_new>)
    - [`fd_sbpf_program_align`](<fd_sbpf_loader.c.md#fd_sbpf_program_align>)
    - [`fd_sbpf_program_footprint`](<fd_sbpf_loader.c.md#fd_sbpf_program_footprint>)
    - [`fd_sbpf_program_load`](<fd_sbpf_loader.c.md#fd_sbpf_program_load>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/ballet/sbpf/test_sbpf_loader.c#L101>)

Initializes the environment, runs tests on ELF files, and then cleans up before exiting.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of strings representing the command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Allocates a static memory buffer `scratch_mem` of 32MB and a static aligned memory buffer `scratch_fmem`.
    - Attaches the scratch memory using `fd_scratch_attach`.
    - Executes the [`test_duplicate_entrypoint_entry`](<#test_duplicate_entrypoint_entry>) function to test properties of the `duplicate_entrypoint_entry.elf` file.
    - Executes the [`test_zero_text_cnt`](<#test_zero_text_cnt>) function to test properties of the `zero_text_cnt.elf` file.
    - Detaches the scratch memory using `fd_scratch_detach`.
    - Calls `fd_halt` to perform any necessary cleanup before exiting.
    - Returns 0 to indicate successful execution.
- **Output**: Returns an integer value 0, indicating successful execution.
- **Functions Called**:
    - [`test_duplicate_entrypoint_entry`](<#test_duplicate_entrypoint_entry>)
    - [`test_zero_text_cnt`](<#test_zero_text_cnt>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)