<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements an ELF loader for the sBPF virtual machine, including functions for parsing, validating, and relocating ELF files.

# Purpose
The code is a C implementation of an ELF (Executable and Linkable Format) loader for the sBPF (Solana Berkeley Packet Filter) virtual machine. It is designed to parse, validate, and load ELF files, which are used to store executable programs and libraries. The loader handles various aspects of ELF files, such as reading headers, sections, and program headers, and applying relocations necessary for execution in the sBPF VM. The code includes functions for parsing ELF headers, validating ELF structures, and handling dynamic relocations, which are essential for executing position-independent code in the sBPF environment.

Key components of the code include structures and functions for managing ELF headers (`fd_elf64_ehdr`), program headers (`fd_elf64_phdr`), and section headers (`fd_elf64_shdr`). The code also defines functions for handling specific relocation types, such as `R_BPF_64_64`, `R_BPF_64_RELATIVE`, and `R_BPF_64_32`, which adjust addresses and offsets within the ELF file to align with the sBPF VM's memory map. Additionally, the code provides mechanisms for registering functions and syscalls, managing program entry points, and ensuring that the loaded program adheres to the sBPF VM's constraints. The loader is designed to be robust against malformed ELF files, with extensive error checking and handling to ensure that only valid ELF files are loaded and executed.
# Imports and Dependencies

---
- `fd_sbpf_loader.h`
- `fd_sbpf_instr.h`
- `fd_sbpf_opcodes.h`
- `../../util/fd_util.h`
- `../../util/bits/fd_sat.h`
- `../murmur3/fd_murmur3.h`
- `assert.h`
- `stdio.h`


# Global Variables

---
### 
- **Type**: `union fd_sbpf_elf`
- **Description**: Represents a union that provides access to the ELF file header and its binary content. The union contains two members: `fd_elf64_ehdr` for the ELF header and `uchar bin[0]` for the binary content of the ELF file.
- **Use**: Used to access and manipulate the ELF file header and its binary content in memory.


# Data Structures

---
### fd\_sbpf\_elf
- **Type**: ``union``
- **Members**:
    - ``ehdr``: An instance of `fd_elf64_ehdr` representing the ELF file header.
    - ``bin``: A flexible array member of type `uchar` for accessing the ELF binary content.
- **Description**: Provides a convenient way to access both the ELF file header and the binary content of an ELF file. The `union` allows for accessing the ELF header through the `ehdr` member or the binary content through the `bin` member, which is useful for operations that require direct manipulation or inspection of ELF files.


---
### fd\_sbpf\_elf\_t
- **Type**: ``union``
- **Members**:
    - ``ehdr``: Represents the ELF file header of type `fd_elf64_ehdr`.
    - ``bin``: An array of unsigned characters representing the ELF binary content starting from the first byte.
- **Description**: The `fd_sbpf_elf_t` union provides convenient access to the ELF file header and its binary content. It allows the user to interpret the beginning of the ELF file as either a file header (`ehdr`) or as raw binary data (`bin`). This is useful for operations that require direct manipulation or inspection of the ELF file's structure and content.


---
### fd\_sbpf\_range
- **Type**: ``struct``
- **Members**:
    - ``lo``: The lower bound of the range, inclusive.
    - ``hi``: The upper bound of the range, exclusive.
- **Description**: Defines a range with a lower bound `lo` and an upper bound `hi`, both of type `ulong`. This structure is used to represent a range of values, where `lo` is inclusive and `hi` is exclusive, allowing for operations such as checking if a value falls within the specified range.


---
### fd\_sbpf\_range\_t
- **Type**: ``struct``
- **Members**:
    - ``lo``: The lower bound of the range, inclusive.
    - ``hi``: The upper bound of the range, exclusive.
- **Description**: Defines a range with a lower bound `lo` and an upper bound `hi`, where `lo` is inclusive and `hi` is exclusive. This structure is used to represent a range of unsigned long integers, typically for memory or address ranges in the context of ELF file parsing and validation.


---
### fd\_sbpf\_loader
- **Type**: ``struct``
- **Members**:
    - ``calldests``: Pointer to an array of unsigned long integers, owned by the program, and is NULL if `text_cnt` is 0 or SBPF version is 3 or higher.
    - ``syscalls``: Pointer to `fd_sbpf_syscalls_t`, owned by the caller.
- **Description**: Contains temporary state during the loading of an sBPF program, specifically managing external objects such as call destinations and syscalls.


---
### fd\_sbpf\_loader\_t
- **Type**: ``struct``
- **Members**:
    - ``calldests``: Pointer to an array of unsigned long integers, owned by the program, which is NULL if `text_cnt` is 0 or SBPF version is 3 or higher.
    - ``syscalls``: Pointer to a `fd_sbpf_syscalls_t` structure, owned by the caller, which contains system call information.
- **Description**: `fd_sbpf_loader_t` is a structure that holds temporary state information during the loading of an sBPF program. It includes pointers to external objects such as `calldests`, which is used for function call destinations, and `syscalls`, which provides access to system call information. This structure is essential for managing the loading process and ensuring that the program has the necessary context and resources to execute correctly.


# Functions

---
### fd\_sbpf\_range\_contains<!-- {{#callable:fd_sbpf_range_contains}} -->
[View Source →](<../../../../../src/ballet/sbpf/fd_sbpf_loader.c#L63>)

Checks if a given value `x` is within the specified range `[range->lo, range->hi)`.
- **Inputs**:
    - ``range``: A pointer to a `fd_sbpf_range_t` structure that defines the range with `lo` as the lower bound and `hi` as the upper bound (exclusive).
    - ``x``: An unsigned long integer value to check against the specified range.
- **Logic and Control Flow**:
    - Evaluates if `range->lo` is less than or equal to `x`.
    - Evaluates if `x` is less than `range->hi`.
    - Performs a bitwise AND operation on the results of the two evaluations.
    - Converts the result of the bitwise AND operation to a boolean value using double negation (`!!`).
    - Returns the boolean result indicating if `x` is within the range.
- **Output**: Returns 1 if `x` is within the range `[range->lo, range->hi)`, otherwise returns 0.


---
### fd\_shdr\_get\_file\_range<!-- {{#callable:fd_shdr_get_file_range}} -->
[View Source →](<../../../../../src/ballet/sbpf/fd_sbpf_loader.c#L76>)

Determines the file range of an ELF section header and updates the range structure accordingly.
- **Inputs**:
    - `shdr`: A pointer to a constant `fd_elf64_shdr` structure representing the ELF section header.
    - `range`: A pointer to an `fd_sbpf_range_t` structure where the function will store the calculated file range.
- **Logic and Control Flow**:
    - Check if the section header type `sh_type` is `FD_ELF_SHT_NOBITS`.
    - If `sh_type` is `FD_ELF_SHT_NOBITS`, set `range->lo` and `range->hi` to 0 and return `NULL`.
    - Otherwise, set `range->lo` to `shdr->sh_offset` and `range->hi` to the sum of `shdr->sh_offset` and `shdr->sh_size` using `fd_ulong_sat_add`.
    - Return the `range` pointer.
- **Output**: Returns a pointer to the `range` if the section type is not `FD_ELF_SHT_NOBITS`, otherwise returns `NULL`.


---
### fd\_sbpf\_elf\_parser\_err\_to\_elf\_err<!-- {{#callable:fd_sbpf_elf_parser_err_to_elf_err}} -->
[View Source →](<../../../../../src/ballet/sbpf/fd_sbpf_loader.c#L90>)

Converts an `ElfParserError` code to an `ElfError` code based on the input error code.
- **Inputs**:
    - `err`: An integer representing the `ElfParserError` code to convert.
- **Logic and Control Flow**:
    - Check the value of `err` using a switch statement.
    - If `err` is `FD_SBPF_ELF_SUCCESS`, return `err` as is.
    - If `err` is `FD_SBPF_ELF_PARSER_ERR_OUT_OF_BOUNDS`, return `FD_SBPF_ELF_ERR_VALUE_OUT_OF_BOUNDS`.
    - If `err` is `FD_SBPF_ELF_PARSER_ERR_INVALID_PROGRAM_HEADER`, return `FD_SBPF_ELF_ERR_INVALID_PROGRAM_HEADER`.
    - For any other value of `err`, return `FD_SBPF_ELF_ERR_FAILED_TO_PARSE`.
- **Output**: An integer representing the corresponding `ElfError` code.


---
### fd\_sbpf\_program\_align<!-- {{#callable:fd_sbpf_program_align}} -->
[View Source →](<../../../../../src/ballet/sbpf/fd_sbpf_loader.c#L125>)

Returns the alignment requirement of the `fd_sbpf_program_t` type.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls the `alignof` operator on `fd_sbpf_program_t` to determine its alignment requirement.
    - Returns the result of the `alignof` operation.
- **Output**: An unsigned long integer representing the alignment requirement of `fd_sbpf_program_t`.


---
### fd\_sbpf\_program\_footprint<!-- {{#callable:fd_sbpf_program_footprint}} -->
[View Source →](<../../../../../src/ballet/sbpf/fd_sbpf_loader.c#L130>)

Calculates the memory footprint required for an sBPF program based on ELF information.
- **Inputs**:
    - `info`: A pointer to a constant `fd_sbpf_elf_info_t` structure containing ELF information about the sBPF program.
- **Logic and Control Flow**:
    - Marks the `info` pointer as unpredictable to hint at potential future dependencies on its contents.
    - Checks if stricter ELF headers are enabled for the given sBPF version using [`fd_sbpf_enable_stricter_elf_headers_enabled`](<fd_sbpf_loader.h.md#fd_sbpf_enable_stricter_elf_headers_enabled>).
    - If stricter headers are enabled, calculates the footprint without the calldests bitmap using `FD_LAYOUT_FINI` and `FD_LAYOUT_APPEND`.
    - If stricter headers are not enabled, calculates the footprint including the calldests bitmap using `FD_LAYOUT_FINI` and `FD_LAYOUT_APPEND` with additional alignment and footprint for calldests.
- **Output**: Returns an unsigned long integer representing the calculated memory footprint for the sBPF program.
- **Functions Called**:
    - [`fd_sbpf_enable_stricter_elf_headers_enabled`](<fd_sbpf_loader.h.md#fd_sbpf_enable_stricter_elf_headers_enabled>)


---
### fd\_sbpf\_program\_new<!-- {{#callable:fd_sbpf_program_new}} -->
[View Source →](<../../../../../src/ballet/sbpf/fd_sbpf_loader.c#L145>)

Initializes a new `fd_sbpf_program_t` structure using provided memory, ELF information, and read-only data, while performing necessary validations and allocations.
- **Inputs**:
    - `prog_mem`: A pointer to the memory where the program structure will be allocated.
    - `elf_info`: A pointer to a constant `fd_sbpf_elf_info_t` structure containing ELF file information.
    - `rodata`: A pointer to the read-only data section of the program.
- **Logic and Control Flow**:
    - Check if `prog_mem` is NULL and log a warning if true, then return NULL.
    - Check if `elf_info` is NULL and log a warning if true, then return NULL.
    - Check if `elf_info->bin_sz` is greater than 0 and `rodata` is NULL, log a warning if true, then return NULL.
    - Check if `rodata` is not aligned to 8 bytes, log a warning if true, then return NULL.
    - Initialize a scratch memory allocator with `prog_mem`.
    - Allocate memory for `fd_sbpf_program_t` structure using the scratch allocator.
    - Initialize the `fd_sbpf_program_t` structure with provided `elf_info` and `rodata`, setting `rodata_sz` to 0 and `entry_pc` to `ULONG_MAX`.
    - Determine if a calldests map is needed based on `elf_info->text_cnt` and `sbpf_version`.
    - If a calldests map is needed, allocate and initialize it using the scratch allocator.
    - Return the initialized `fd_sbpf_program_t` structure.
- **Output**: A pointer to the newly initialized `fd_sbpf_program_t` structure, or NULL if any validation fails.
- **Functions Called**:
    - [`fd_sbpf_enable_stricter_elf_headers_enabled`](<fd_sbpf_loader.h.md#fd_sbpf_enable_stricter_elf_headers_enabled>)


---
### fd\_sbpf\_program\_delete<!-- {{#callable:fd_sbpf_program_delete}} -->
[View Source →](<../../../../../src/ballet/sbpf/fd_sbpf_loader.c#L203>)

Deletes an `fd_sbpf_program_t` object and resets its memory.
- **Inputs**:
    - `mem`: A pointer to an `fd_sbpf_program_t` object to delete.
- **Logic and Control Flow**:
    - Checks if `mem->calldests` is not NULL using `FD_LIKELY` macro.
    - If `mem->calldests` is not NULL, calls `fd_sbpf_calldests_leave` to leave the calldests and then `fd_sbpf_calldests_delete` to delete it.
    - Resets the memory of `mem` to zero using `fd_memset`.
    - Returns the pointer `mem` cast to `void *`.
- **Output**: Returns a void pointer to the reset `fd_sbpf_program_t` object.


---
### fd\_sbpf\_slice\_cstr\_eq<!-- {{#callable:fd_sbpf_slice_cstr_eq}} -->
[View Source →](<../../../../../src/ballet/sbpf/fd_sbpf_loader.c#L228>)

Checks if a memory slice is equal to a null-terminated C-string, excluding the null-terminator.
- **Inputs**:
    - ``slice``: A pointer to the memory slice to compare.
    - ``slice_len``: The length of the memory slice.
    - ``cstr``: A pointer to the null-terminated C-string to compare against.
- **Logic and Control Flow**:
    - Calculate the length of `cstr` using `strlen` and compare it to `slice_len`.
    - If the lengths are equal, use `fd_memeq` to compare the memory slice and `cstr` for `slice_len` bytes.
    - Return 1 if both the length and memory content are equal, otherwise return 0.
- **Output**: Returns 1 if the memory slice and C-string are equal for the specified length, otherwise returns 0.


---
### fd\_sbpf\_slice\_cstr\_start\_with<!-- {{#callable:fd_sbpf_slice_cstr_start_with}} -->
[View Source →](<../../../../../src/ballet/sbpf/fd_sbpf_loader.c#L239>)

Checks if a null-terminated C-string is a prefix of a memory slice.
- **Inputs**:
    - `slice`: A pointer to the memory slice to check against.
    - `slice_len`: The length of the memory slice.
    - `cstr`: A pointer to the null-terminated C-string to check as a prefix.
- **Logic and Control Flow**:
    - Calculate the length of the C-string using `strlen` and store it in `cstr_len`.
    - Check if `slice_len` is greater than or equal to `cstr_len`.
    - Use `fd_memeq` to compare the first `cstr_len` bytes of `slice` with `cstr`.
    - Return 1 if both conditions are true, otherwise return 0.
- **Output**: Returns 1 if the C-string is a prefix of the slice, otherwise returns 0.


---
### fd\_sbpf\_lenient\_get\_string\_in\_section<!-- {{#callable:fd_sbpf_lenient_get_string_in_section}} -->
[View Source →](<../../../../../src/ballet/sbpf/fd_sbpf_loader.c#L256>)

Retrieves a null-terminated string from a specified section in an ELF file, ensuring it is within bounds and not exceeding a maximum length.
- **Inputs**:
    - `elf_bytes`: Pointer to the ELF file data.
    - `elf_bytes_len`: Length of the ELF file data.
    - `section_header`: Pointer to the section header of the ELF file.
    - `offset_in_section`: Offset within the section to start reading the string.
    - `maximum_length`: Maximum length of the string to read.
    - `out_slice`: Pointer to store the address of the string slice.
    - `out_slice_len`: Pointer to store the length of the string slice.
- **Logic and Control Flow**:
    - Check if the section type is `FD_ELF_SHT_STRTAB`; return error if not.
    - Calculate the file offset using `section_header->sh_offset` and `offset_in_section`; return error if overflow occurs.
    - Determine the string range within the file and check if it is within bounds; return error if out of bounds.
    - Ensure the string range is valid (end is not before start); return error if invalid.
    - Search for a null terminator within the string range; return error if not found.
    - Set `out_slice` to the start of the string and `out_slice_len` to the length of the string excluding the null terminator.
    - Return success code.
- **Output**: Returns an integer status code indicating success or specific error conditions.


---
### fd\_sbpf\_register\_function\_hashed\_legacy<!-- {{#callable:fd_sbpf_register_function_hashed_legacy}} -->
[View Source →](<../../../../../src/ballet/sbpf/fd_sbpf_loader.c#L326>)

Registers a target program counter (PC) in the function registry, handling entry points and potential hash collisions.
- **Inputs**:
    - `loader`: A pointer to `fd_sbpf_loader_t`, which contains the syscall registry and calldests.
    - `prog`: A pointer to `fd_sbpf_program_t`, which represents the program being loaded.
    - `name`: A pointer to a constant unsigned character array representing the function name.
    - `name_len`: The length of the function name.
    - `target_pc`: The target program counter to register.
    - `opt_out_pc_hash`: An optional pointer to store the computed hash of the program counter.
- **Logic and Control Flow**:
    - Check if the function name is 'entrypoint' or if the `target_pc` is the entry point constant.
    - If it is an entry point, verify if the entry point is already registered with a different `target_pc`; if so, return a hash collision error.
    - Set the program's entry point to `target_pc` and use a predefined hash for entry points.
    - If not an entry point, compute the hash of `target_pc` using `fd_pchash`.
    - Check if the `target_pc` hash is already in the syscall registry; if so, return a hash collision error.
    - If not an entry point and the `target_pc` is valid, insert it into the calldests set.
    - If `opt_out_pc_hash` is provided, store the computed hash in it.
    - Return success.
- **Output**: Returns `FD_SBPF_ELF_SUCCESS` on success or `FD_SBPF_ELF_ERR_SYMBOL_HASH_COLLISION` on failure due to hash collision.
- **Functions Called**:
    - [`fd_sbpf_slice_cstr_eq`](<#fd_sbpf_slice_cstr_eq>)


---
### fd\_sbpf\_r\_bpf\_64\_64<!-- {{#callable:fd_sbpf_r_bpf_64_64}} -->
[View Source →](<../../../../../src/ballet/sbpf/fd_sbpf_loader.c#L437>)

Relocates an absolute address into the extended immediate field of an `lddw`-form instruction in an ELF file.
- **Inputs**:
    - `elf`: A pointer to a `fd_sbpf_elf_t` structure representing the ELF file.
    - `elf_sz`: The size of the ELF file in bytes.
    - `rodata`: A pointer to the read-only data section where the relocation will be applied.
    - `info`: A pointer to a `fd_sbpf_elf_info_t` structure containing information about the ELF file.
    - `dt_rel`: A pointer to a `fd_elf64_rel` structure representing the dynamic relocation entry.
    - `r_offset`: The offset in the ELF file where the relocation should be applied.
- **Logic and Control Flow**:
    - Calculate the immediate offset by adding 4 to `r_offset`.
    - Check if the immediate offset plus 4 exceeds `elf_sz`; if so, return `FD_SBPF_ELF_ERR_VALUE_OUT_OF_BOUNDS`.
    - Retrieve the symbol entry from the dynamic symbol table using `info->shndx_dynsymtab` and `dt_rel->r_info`.
    - Calculate the relocated address by adding the symbol's value to the referenced address loaded from `rodata` at the immediate offset.
    - Normalize the address to the VM's memory space if it is less than `FD_SBPF_MM_PROGRAM_ADDR`.
    - Calculate the low and high offsets for the immediate field in the `lddw` instruction.
    - Check bounds and write the low 32 bits of the address to `rodata` at the low offset.
    - Check bounds and write the high 32 bits of the address to `rodata` at the high offset.
    - Return `FD_SBPF_ELF_SUCCESS` on successful relocation.
- **Output**: Returns `FD_SBPF_ELF_SUCCESS` on success or an error code if a bounds check fails or the symbol is unknown.


---
### fd\_sbpf\_r\_bpf\_64\_relative<!-- {{#callable:fd_sbpf_r_bpf_64_relative}} -->
[View Source →](<../../../../../src/ballet/sbpf/fd_sbpf_loader.c#L536>)

Relocates a 64-bit relative address in an ELF file for sBPF programs, handling both text and non-text sections.
- **Inputs**:
    - `elf`: A pointer to a `fd_sbpf_elf_t` structure representing the ELF file.
    - `elf_sz`: The size of the ELF file in bytes.
    - `rodata`: A pointer to the read-only data section of the ELF file.
    - `info`: A pointer to a `fd_sbpf_elf_info_t` structure containing information about the ELF file.
    - `r_offset`: The offset in the ELF file where the relocation should occur.
- **Logic and Control Flow**:
    - Calculate `imm_offset` by adding 4 to `r_offset`.
    - Retrieve the text section header and check if `r_offset` is within the text section range.
    - If `r_offset` is within the text section, handle a `lddw` instruction by reading and combining the low and high parts of the address, checking bounds, and normalizing the address.
    - If the address is not normalized, adjust it by adding `FD_SBPF_MM_PROGRAM_ADDR`.
    - Write back the low and high parts of the normalized address to `rodata`, checking bounds before each write.
    - If `r_offset` is not within the text section, read the address from `rodata`, normalize it, and write it back to `rodata` at `r_offset`.
- **Output**: Returns `FD_SBPF_ELF_SUCCESS` on success, or an error code if a bounds check fails or if the address is invalid.
- **Functions Called**:
    - [`fd_shdr_get_file_range`](<#fd_shdr_get_file_range>)
    - [`fd_sbpf_range_contains`](<#fd_sbpf_range_contains>)


---
### fd\_sbpf\_r\_bpf\_64\_32<!-- {{#callable:fd_sbpf_r_bpf_64_32}} -->
[View Source →](<../../../../../src/ballet/sbpf/fd_sbpf_loader.c#L629>)

Processes a 32-bit immediate field relocation for a BPF call instruction in an ELF file.
- **Inputs**:
    - `loader`: A pointer to `fd_sbpf_loader_t`, which contains temporary state during loading.
    - `prog`: A pointer to `fd_sbpf_program_t`, representing the program being loaded.
    - `elf`: A constant pointer to `fd_sbpf_elf_t`, representing the ELF file being processed.
    - `elf_sz`: The size of the ELF file in bytes.
    - `rodata`: A pointer to the read-only data section where the relocation will be applied.
    - `info`: A constant pointer to `fd_sbpf_elf_info_t`, containing metadata about the ELF file.
    - `dt_rel`: A constant pointer to `fd_elf64_rel`, representing the relocation entry.
    - `r_offset`: The offset in the ELF file where the relocation should be applied.
    - `config`: A constant pointer to `fd_sbpf_loader_config_t`, containing configuration options for the loader.
- **Logic and Control Flow**:
    - Calculate the immediate offset by adding 4 to `r_offset`.
    - Check if the dynamic symbol table exists; if not, return `FD_SBPF_ELF_ERR_UNKNOWN_SYMBOL`.
    - Retrieve the dynamic symbol table and verify the symbol index from `r_info`; if out of bounds, return `FD_SBPF_ELF_ERR_UNKNOWN_SYMBOL`.
    - Get the symbol name from the dynamic section name string table; if retrieval fails, return `FD_SBPF_ELF_ERR_UNKNOWN_SYMBOL`.
    - Determine if the symbol is a function or a syscall.
    - If a function, check if the symbol value is within the text section range; if not, return `FD_SBPF_ELF_ERR_VALUE_OUT_OF_BOUNDS`.
    - Register the function using [`fd_sbpf_register_function_hashed_legacy`](<#fd_sbpf_register_function_hashed_legacy>); if registration fails, return the error code.
    - If a syscall, compute the key using `fd_murmur3_32` and check if it can be resolved; if not, return `FD_SBPF_ELF_ERR_UNRESOLVED_SYMBOL`.
    - Check if the immediate offset plus 4 exceeds `elf_sz`; if so, return `FD_SBPF_ELF_ERR_VALUE_OUT_OF_BOUNDS`.
    - Store the computed key at the immediate offset in `rodata`.
- **Output**: Returns `FD_SBPF_ELF_SUCCESS` on successful relocation, or an error code if a failure occurs during processing.
- **Functions Called**:
    - [`fd_sbpf_lenient_get_string_in_section`](<#fd_sbpf_lenient_get_string_in_section>)
    - [`fd_sbpf_range_contains`](<#fd_sbpf_range_contains>)
    - [`fd_sbpf_register_function_hashed_legacy`](<#fd_sbpf_register_function_hashed_legacy>)


---
### fd\_sbpf\_elf\_peek\_strict<!-- {{#callable:fd_sbpf_elf_peek_strict}} -->
[View Source →](<../../../../../src/ballet/sbpf/fd_sbpf_loader.c#L720>)

Validates and extracts information from an ELF binary for sBPF execution, ensuring strict compliance with expected ELF header and program header formats.
- **Inputs**:
    - `info`: A pointer to `fd_sbpf_elf_info_t` where the function will store extracted ELF information.
    - `bin`: A pointer to the ELF binary data to be parsed.
    - `bin_sz`: The size of the ELF binary data in bytes.
- **Logic and Control Flow**:
    - Check if `bin_sz` is smaller than the size of `fd_elf64_ehdr`; if true, return `FD_SBPF_ELF_PARSER_ERR_OUT_OF_BOUNDS`.
    - Load the ELF header from the binary data using `FD_LOAD`.
    - Calculate the end of the program header table using `fd_ulong_sat_add` and `fd_ulong_sat_mul`.
    - Perform a series of checks on the ELF header fields to ensure they match expected values; if any check fails, return `FD_SBPF_ELF_PARSER_ERR_INVALID_FILE_HEADER`.
    - Check if the program header table size is valid and within bounds; if not, return `FD_SBPF_ELF_PARSER_ERR_INVALID_SIZE` or `FD_SBPF_ELF_PARSER_ERR_OUT_OF_BOUNDS`.
    - Iterate over the expected program headers, loading each and checking its fields against expected values; if any check fails, return `FD_SBPF_ELF_PARSER_ERR_INVALID_PROGRAM_HEADER`.
    - Calculate the virtual memory range and check if the entry point is within this range and properly aligned; if not, return `FD_SBPF_ELF_PARSER_ERR_INVALID_FILE_HEADER`.
    - Load the instruction at the entry point and verify it is a valid function start; if not, return `FD_SBPF_ELF_PARSER_ERR_INVALID_FILE_HEADER`.
    - Store the binary size, text offset, text size, and text count in the `info` structure.
    - Return `FD_SBPF_ELF_SUCCESS` if all checks pass.
- **Output**: Returns an integer status code indicating success (`FD_SBPF_ELF_SUCCESS`) or a specific error code if validation fails.
- **Functions Called**:
    - [`fd_sbpf_is_function_start`](<fd_sbpf_instr.h.md#fd_sbpf_is_function_start>)


---
### fd\_sbpf\_check\_overlap<!-- {{#callable:fd_sbpf_check_overlap}} -->
[View Source →](<../../../../../src/ballet/sbpf/fd_sbpf_loader.c#L841>)

Checks if two ranges [a_start, a_end) and [b_start, b_end) overlap.
- **Inputs**:
    - `a_start`: The start of the first range.
    - `a_end`: The end of the first range.
    - `b_start`: The start of the second range.
    - `b_end`: The end of the second range.
- **Logic and Control Flow**:
    - Evaluates the condition `(a_end <= b_start || b_end <= a_start)` to check if the ranges do not overlap.
    - Returns the negation of the condition, which is `1` if the ranges overlap and `0` if they do not.
- **Output**: Returns `1` if the ranges overlap, otherwise returns `0`.


---
### fd\_sbpf\_lenient\_elf\_parse<!-- {{#callable:fd_sbpf_lenient_elf_parse}} -->
[View Source →](<../../../../../src/ballet/sbpf/fd_sbpf_loader.c#L849>)

Parses an ELF binary in a lenient manner, setting various fields in the `fd_sbpf_elf_info_t` structure and performing validation checks.
- **Inputs**:
    - `info`: A pointer to an `fd_sbpf_elf_info_t` structure where the function will store parsed ELF information.
    - `bin`: A pointer to the ELF binary data to be parsed.
    - `bin_sz`: The size of the ELF binary data in bytes.
- **Logic and Control Flow**:
    - Initialize fields in the `info` structure to default values.
    - Check if the binary size is smaller than the size of an ELF header; return an error if true.
    - Load the ELF header from the binary data.
    - Validate the ELF header fields against expected values; return an error if validation fails.
    - Calculate the start and end positions of the program header table and validate its size and alignment.
    - Check for overlaps between the ELF header and program header table; return an error if overlaps are found.
    - Calculate the start and end positions of the section header table and validate its size and alignment.
    - Check for overlaps between the ELF header, program header table, and section header table; return an error if overlaps are found.
    - Iterate over program headers to find the first PT_DYNAMIC header and validate each header's fields.
    - Iterate over section headers to find the first SHT_DYNAMIC header and validate each header's fields.
    - Use the section name string table to identify well-known sections and store their indices in the `info` structure.
    - Attempt to parse the dynamic section using PT_DYNAMIC first, then fall back to SHT_DYNAMIC if necessary.
    - If a dynamic section is found, parse its entries and store relevant information in the `info` structure.
    - Return success if parsing completes without errors.
- **Output**: Returns 0 on success, or an error code if parsing fails at any validation step.
- **Functions Called**:
    - [`fd_sbpf_check_overlap`](<#fd_sbpf_check_overlap>)
    - [`fd_sbpf_lenient_get_string_in_section`](<#fd_sbpf_lenient_get_string_in_section>)
    - [`fd_sbpf_slice_cstr_eq`](<#fd_sbpf_slice_cstr_eq>)


---
### fd\_sbpf\_lenient\_elf\_validate<!-- {{#callable:fd_sbpf_lenient_elf_validate}} -->
[View Source →](<../../../../../src/ballet/sbpf/fd_sbpf_loader.c#L1301>)

Validates an ELF file for specific sBPF requirements and updates ELF information.
- **Inputs**:
    - `info`: A pointer to `fd_sbpf_elf_info_t` structure to store ELF information.
    - `bin`: A pointer to the ELF binary data.
    - `bin_sz`: The size of the ELF binary data.
    - `text_shdr`: A pointer to `fd_elf64_shdr` to store the text section header.
- **Logic and Control Flow**:
    - Load the ELF header from the binary data.
    - Check if the ELF class is 64-bit; return an error if not.
    - Check if the ELF data encoding is little-endian; return an error if not.
    - Check if the ELF OS ABI is none; return an error if not.
    - Check if the ELF machine type is BPF or sBPF; return an error if not.
    - Check if the ELF type is dynamic; return an error if not.
    - Iterate over the section headers to find the text section and check for errors.
    - If a writable section is found, set a writable error flag.
    - Check for out-of-bounds errors in section headers.
    - If no text section is found, return an error.
    - If writable error flag is set, return an error.
    - If out-of-bounds error flag is set, return an error.
    - Check if the entry point is within the text section; return an error if not.
    - Calculate the text section file range and update ELF information.
- **Output**: Returns 0 on success or an error code on failure.
- **Functions Called**:
    - [`fd_sbpf_lenient_get_string_in_section`](<#fd_sbpf_lenient_get_string_in_section>)
    - [`fd_sbpf_elf_parser_err_to_elf_err`](<#fd_sbpf_elf_parser_err_to_elf_err>)
    - [`fd_sbpf_slice_cstr_eq`](<#fd_sbpf_slice_cstr_eq>)
    - [`fd_sbpf_slice_cstr_start_with`](<#fd_sbpf_slice_cstr_start_with>)
    - [`fd_shdr_get_file_range`](<#fd_shdr_get_file_range>)


---
### fd\_sbpf\_elf\_peek\_lenient<!-- {{#callable:fd_sbpf_elf_peek_lenient}} -->
[View Source →](<../../../../../src/ballet/sbpf/fd_sbpf_loader.c#L1418>)

Parses and validates an ELF binary in a lenient manner, checking for errors and ensuring the ELF structure is correct.
- **Inputs**:
    - ``info``: A pointer to `fd_sbpf_elf_info_t` where the function stores parsed ELF information.
    - ``bin``: A pointer to the ELF binary data to be parsed.
    - ``bin_sz``: The size of the ELF binary data in bytes.
    - ``config``: A pointer to `fd_sbpf_loader_config_t` containing configuration options for the loader.
- **Logic and Control Flow**:
    - Calls [`fd_sbpf_lenient_elf_parse`](<#fd_sbpf_lenient_elf_parse>) to parse the ELF binary and store information in `info`.
    - Checks if the parsing result is negative, indicating an error, and converts the error code using [`fd_sbpf_elf_parser_err_to_elf_err`](<#fd_sbpf_elf_parser_err_to_elf_err>).
    - Initializes a `fd_elf64_shdr` structure to store the text section header.
    - Calls [`fd_sbpf_lenient_elf_validate`](<#fd_sbpf_lenient_elf_validate>) to validate the ELF binary and store the text section header.
    - Checks if the validation result is negative, indicating an error, and returns the error code.
    - Calculates the virtual address of the text section by adding `FD_SBPF_MM_RODATA_ADDR` to the text section's address.
    - Checks if the configuration requires rejecting broken ELFs and if the text section's address does not match its offset, or if the virtual address end exceeds `FD_SBPF_MM_STACK_ADDR`, returning an out-of-bounds error if true.
    - Returns `FD_SBPF_ELF_SUCCESS` if all checks pass.
- **Output**: Returns an integer indicating success (`FD_SBPF_ELF_SUCCESS`) or an error code if parsing or validation fails.
- **Functions Called**:
    - [`fd_sbpf_lenient_elf_parse`](<#fd_sbpf_lenient_elf_parse>)
    - [`fd_sbpf_elf_parser_err_to_elf_err`](<#fd_sbpf_elf_parser_err_to_elf_err>)
    - [`fd_sbpf_lenient_elf_validate`](<#fd_sbpf_lenient_elf_validate>)


---
### fd\_sbpf\_program\_get\_sbpf\_version\_or\_err<!-- {{#callable:fd_sbpf_program_get_sbpf_version_or_err}} -->
[View Source →](<../../../../../src/ballet/sbpf/fd_sbpf_loader.c#L1456>)

Determines the sBPF version from an ELF binary or returns an error if the version is unsupported or out of bounds.
- **Inputs**:
    - `bin`: A pointer to the ELF binary data.
    - `bin_sz`: The size of the ELF binary data in bytes.
    - `config`: A pointer to the `fd_sbpf_loader_config_t` structure containing configuration settings, including minimum and maximum supported sBPF versions.
- **Logic and Control Flow**:
    - Defines a constant `E_FLAGS_OFFSET` set to 48, which is the offset to the e_flags field in the ELF header.
    - Checks if `bin_sz` is less than `E_FLAGS_OFFSET` plus the size of a `uint`. If true, returns `FD_SBPF_ELF_ERR_VALUE_OUT_OF_BOUNDS`.
    - Loads the `e_flags` value from the binary at the `E_FLAGS_OFFSET`.
    - Initializes `sbpf_version` to 0.
    - Checks if `config->sbpf_max_version` is `FD_SBPF_V0`. If true, sets `sbpf_version` to `FD_SBPF_RESERVED` if `e_flags` equals `E_FLAGS_SBPF_V2`, otherwise sets it to `FD_SBPF_V0`.
    - If `config->sbpf_max_version` is not `FD_SBPF_V0`, sets `sbpf_version` to `e_flags` if `e_flags` is less than `FD_SBPF_VERSION_COUNT`, otherwise sets it to `FD_SBPF_RESERVED`.
    - Checks if `sbpf_version` is within the range defined by `config->sbpf_min_version` and `config->sbpf_max_version`. If not, returns `FD_SBPF_ELF_ERR_UNSUPPORTED_SBPF_VERSION`.
    - Returns `sbpf_version` cast to an `int`.
- **Output**: Returns the sBPF version as an `int` if successful, or an error code if the version is unsupported or out of bounds.


---
### fd\_sbpf\_elf\_peek<!-- {{#callable:fd_sbpf_elf_peek}} -->
[View Source →](<../../../../../src/ballet/sbpf/fd_sbpf_loader.c#L1486>)

Analyzes an ELF binary to extract sBPF version and initializes ELF information structure, using either a strict or lenient parser based on the sBPF version.
- **Inputs**:
    - `info`: A pointer to an `fd_sbpf_elf_info_t` structure where the function will store extracted ELF information.
    - `bin`: A pointer to the ELF binary data to be analyzed.
    - `bin_sz`: The size of the ELF binary data in bytes.
    - `config`: A pointer to an `fd_sbpf_loader_config_t` structure containing configuration settings for the loader.
- **Logic and Control Flow**:
    - Call [`fd_sbpf_program_get_sbpf_version_or_err`](<#fd_sbpf_program_get_sbpf_version_or_err>) to extract the sBPF version from the ELF binary.
    - If the sBPF version extraction fails (returns a negative value), return the error code.
    - Initialize the `info` structure with default values and the extracted sBPF version.
    - Check if stricter ELF headers are enabled for the extracted sBPF version using [`fd_sbpf_enable_stricter_elf_headers_enabled`](<fd_sbpf_loader.h.md#fd_sbpf_enable_stricter_elf_headers_enabled>).
    - If stricter ELF headers are enabled, call [`fd_sbpf_elf_peek_strict`](<#fd_sbpf_elf_peek_strict>) and map its error code using [`fd_sbpf_elf_parser_err_to_elf_err`](<#fd_sbpf_elf_parser_err_to_elf_err>).
    - If stricter ELF headers are not enabled, call [`fd_sbpf_elf_peek_lenient`](<#fd_sbpf_elf_peek_lenient>).
    - Return the result of the parsing function (either strict or lenient).
- **Output**: Returns 0 on success or an error code if the ELF parsing fails.
- **Functions Called**:
    - [`fd_sbpf_program_get_sbpf_version_or_err`](<#fd_sbpf_program_get_sbpf_version_or_err>)
    - [`fd_sbpf_enable_stricter_elf_headers_enabled`](<fd_sbpf_loader.h.md#fd_sbpf_enable_stricter_elf_headers_enabled>)
    - [`fd_sbpf_elf_parser_err_to_elf_err`](<#fd_sbpf_elf_parser_err_to_elf_err>)
    - [`fd_sbpf_elf_peek_strict`](<#fd_sbpf_elf_peek_strict>)
    - [`fd_sbpf_elf_peek_lenient`](<#fd_sbpf_elf_peek_lenient>)


---
### fd\_sbpf\_parse\_ro\_sections<!-- {{#callable:fd_sbpf_parse_ro_sections}} -->
[View Source →](<../../../../../src/ballet/sbpf/fd_sbpf_loader.c#L1537>)

Parses and concatenates the read-only data sections from an ELF binary into a program structure, ensuring proper alignment and handling of section offsets.
- **Inputs**:
    - `prog`: A pointer to the `fd_sbpf_program_t` structure where the parsed read-only data sections will be stored.
    - `bin`: A pointer to the ELF binary data to be parsed.
    - `bin_sz`: The size of the ELF binary data in bytes.
    - `config`: A pointer to the `fd_sbpf_loader_config_t` structure containing configuration options for the loader.
    - `scratch`: A pointer to a scratch memory area used for temporary storage during parsing.
    - `scratch_sz`: The size of the scratch memory area in bytes.
- **Logic and Control Flow**:
    - Initialize pointers to ELF headers and section headers from the binary data.
    - Set initial values for tracking the lowest and highest section addresses, total read-only data length, and invalid offsets flag.
    - Iterate over each section header in the ELF binary.
    - For each section, retrieve the section name and check if it matches any of the read-only section names (e.g., '.text', '.rodata').
    - Check and handle section header offsets, marking invalid offsets if necessary.
    - Calculate the virtual address end for each section and check for out-of-bounds errors.
    - Store indices of read-only sections and update lowest/highest addresses and total length.
    - Check for overlapping read-only sections and return an error if detected.
    - Allocate a buffer in the scratch area, zero it, and copy read-only sections into it at their respective offsets.
    - Copy the concatenated read-only data back into the program structure's `rodata` field and update its size.
- **Output**: Returns 0 on success, or an error code if any validation or processing step fails.
- **Functions Called**:
    - [`fd_sbpf_lenient_get_string_in_section`](<#fd_sbpf_lenient_get_string_in_section>)
    - [`fd_sbpf_slice_cstr_eq`](<#fd_sbpf_slice_cstr_eq>)
    - [`fd_shdr_get_file_range`](<#fd_shdr_get_file_range>)


---
### fd\_sbpf\_program\_relocate<!-- {{#callable:fd_sbpf_program_relocate}} -->
[View Source →](<../../../../../src/ballet/sbpf/fd_sbpf_loader.c#L1689>)

Relocates an sBPF program by copying the read-only data segment and fixing up program counter relative call instructions and dynamic relocations.
- **Inputs**:
    - `prog`: A pointer to an `fd_sbpf_program_t` structure representing the sBPF program to relocate.
    - `bin`: A pointer to the binary data of the ELF file.
    - `bin_sz`: The size of the binary data in bytes.
    - `config`: A pointer to an `fd_sbpf_loader_config_t` structure containing configuration settings for the loader.
    - `loader`: A pointer to an `fd_sbpf_loader_t` structure used for temporary state during loading.
- **Logic and Control Flow**:
    - Copy the read-only data segment from the ELF binary to the program's `rodata` field.
    - Validate the byte range of the text section and calculate the number of instructions.
    - Iterate over each instruction in the text section to check for call instructions and calculate the target program counter (PC).
    - Register the target PC in the calldests function registry and store the PC hash in the text section.
    - Iterate over each relocation entry in the dynamic relocation table and apply the appropriate relocation based on the relocation type.
    - Return an error code if any validation or relocation step fails.
- **Output**: Returns `FD_SBPF_ELF_SUCCESS` on successful relocation or an error code if relocation fails.
- **Functions Called**:
    - [`fd_shdr_get_file_range`](<#fd_shdr_get_file_range>)
    - [`fd_sbpf_register_function_hashed_legacy`](<#fd_sbpf_register_function_hashed_legacy>)
    - [`fd_sbpf_r_bpf_64_64`](<#fd_sbpf_r_bpf_64_64>)
    - [`fd_sbpf_r_bpf_64_relative`](<#fd_sbpf_r_bpf_64_relative>)
    - [`fd_sbpf_r_bpf_64_32`](<#fd_sbpf_r_bpf_64_32>)


---
### fd\_sbpf\_program\_load\_lenient<!-- {{#callable:fd_sbpf_program_load_lenient}} -->
[View Source →](<../../../../../src/ballet/sbpf/fd_sbpf_loader.c#L1809>)

Loads and processes an sBPF program from a binary, applying relocations, registering entry points, and parsing read-only sections.
- **Inputs**:
    - ``prog``: A pointer to an `fd_sbpf_program_t` structure where the program information will be stored.
    - ``bin``: A pointer to the binary data of the sBPF program to be loaded.
    - ``bin_sz``: The size of the binary data in bytes.
    - ``loader``: A pointer to an `fd_sbpf_loader_t` structure used for temporary state during loading.
    - ``config``: A pointer to an `fd_sbpf_loader_config_t` structure containing configuration options for loading.
    - ``scratch``: A pointer to a scratch memory area used for temporary storage during loading.
    - ``scratch_sz``: The size of the scratch memory area in bytes.
- **Logic and Control Flow**:
    - Cast the binary data to an `fd_sbpf_elf_t` pointer and initialize ELF-related structures.
    - Call [`fd_sbpf_program_relocate`](<#fd_sbpf_program_relocate>) to apply relocations to the program.
    - Calculate the offset of the entry point and check its alignment; return an error if misaligned.
    - Unregister the entry point from the call destinations and register it using [`fd_sbpf_register_function_hashed_legacy`](<#fd_sbpf_register_function_hashed_legacy>).
    - Parse the read-only sections using [`fd_sbpf_parse_ro_sections`](<#fd_sbpf_parse_ro_sections>) and return an error if parsing fails.
    - Return `FD_SBPF_ELF_SUCCESS` if all operations complete successfully.
- **Output**: Returns 0 (`FD_SBPF_ELF_SUCCESS`) on success or an error code on failure.
- **Functions Called**:
    - [`fd_sbpf_program_relocate`](<#fd_sbpf_program_relocate>)
    - [`fd_sbpf_register_function_hashed_legacy`](<#fd_sbpf_register_function_hashed_legacy>)
    - [`fd_sbpf_parse_ro_sections`](<#fd_sbpf_parse_ro_sections>)


---
### fd\_sbpf\_program\_load<!-- {{#callable:fd_sbpf_program_load}} -->
[View Source →](<../../../../../src/ballet/sbpf/fd_sbpf_loader.c#L1873>)

Loads an sBPF program from a binary, handling both strict and lenient ELF header parsing, and sets up the program's entry point and read-only data size.
- **Inputs**:
    - `prog`: A pointer to an `fd_sbpf_program_t` structure where the program information will be stored.
    - `bin`: A pointer to the binary data of the program to be loaded.
    - `bin_sz`: The size of the binary data in bytes.
    - `syscalls`: A pointer to an `fd_sbpf_syscalls_t` structure containing syscall information.
    - `config`: A pointer to an `fd_sbpf_loader_config_t` structure containing configuration settings for the loader.
    - `scratch`: A pointer to a scratch memory area used during loading.
    - `scratch_sz`: The size of the scratch memory area in bytes.
- **Logic and Control Flow**:
    - Initialize a `fd_sbpf_loader_t` structure with `prog->calldests` and `syscalls`.
    - Check if stricter ELF headers are enabled using [`fd_sbpf_enable_stricter_elf_headers_enabled`](<fd_sbpf_loader.h.md#fd_sbpf_enable_stricter_elf_headers_enabled>) with `prog->info.sbpf_version`.
    - If strict headers are enabled, load the ELF header and program headers, update `prog->rodata_sz` and `prog->entry_pc`, and return success.
    - If strict headers are not enabled, call [`fd_sbpf_program_load_lenient`](<#fd_sbpf_program_load_lenient>) to load the program using lenient parsing.
    - Return the result of the lenient loading process.
- **Output**: Returns `FD_SBPF_ELF_SUCCESS` on successful loading, or an error code if loading fails.
- **Functions Called**:
    - [`fd_sbpf_enable_stricter_elf_headers_enabled`](<fd_sbpf_loader.h.md#fd_sbpf_enable_stricter_elf_headers_enabled>)
    - [`fd_sbpf_program_load_lenient`](<#fd_sbpf_program_load_lenient>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)