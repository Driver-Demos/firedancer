<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Common support functions for Protocol Buffers encoding and decoding, including field iteration and UTF-8 validation.

# Purpose
The `pb_common.c` file provides common support functions for protocol buffer encoding and decoding, specifically for use with `pb_encode.c` and `pb_decode.c`. It defines functions that facilitate the iteration over fields in a protocol buffer message descriptor, allowing for the retrieval and manipulation of field metadata. The file includes functions such as [`pb_field_iter_begin`](<#pb_field_iter_begin>), [`pb_field_iter_next`](<#pb_field_iter_next>), and [`pb_field_iter_find`](<#pb_field_iter_find>), which initialize, advance, and search through field iterators, respectively. These functions are essential for navigating the structure of protocol buffer messages and handling fields based on their descriptors.

The file also includes utility functions like [`pb_const_cast`](<#pb_const_cast>) to manage const-correctness when iterating over fields, and [`pb_default_field_callback`](<#pb_default_field_callback>) to handle default field operations during encoding and decoding. Additionally, if the `PB_VALIDATE_UTF8` macro is defined, the file provides a function [`pb_validate_utf8`](<#pb_validate_utf8>) to check the validity of UTF-8 encoded strings. This function ensures that strings conform to the UTF-8 standard, preventing issues with invalid character sequences. Overall, `pb_common.c` serves as a foundational component for managing protocol buffer field descriptors and iterators, supporting both encoding and decoding processes.
# Imports and Dependencies

---
- `pb_common.h`


# Functions

---
### load\_descriptor\_values<!-- {{#callable:load_descriptor_values}} -->
[View Source →](<../../../../../src/ballet/nanopb/pb_common.c#L8>)

Loads field descriptor values into the iterator based on the current field index and descriptor format.
- **Inputs**:
    - ``iter``: A pointer to a `pb_field_iter_t` structure that contains the current state of the field iteration.
- **Logic and Control Flow**:
    - Check if the current field index is beyond the field count; if so, return `false`.
    - Read the first word of the field descriptor using `PB_PROGMEM_READU32` and extract the field type.
    - Use a switch statement to handle different descriptor formats (1-word, 2-word, 4-word, and 8-word) and extract relevant field information such as `array_size`, `tag`, `size_offset`, `data_offset`, and `data_size`.
    - If `iter->message` is `NULL`, set `iter->pField` and `iter->pSize` to `NULL`.
    - If `iter->message` is not `NULL`, calculate `iter->pField` and `iter->pSize` based on `data_offset` and `size_offset`.
    - Determine `iter->pData` based on the field type and whether `iter->pField` is `NULL`.
    - Set `iter->submsg_desc` if the field type indicates a submessage; otherwise, set it to `NULL`.
    - Return `true` to indicate successful loading of descriptor values.
- **Output**: Returns `true` if the descriptor values are successfully loaded; otherwise, returns `false` if the field index is out of bounds.


---
### advance\_iterator<!-- {{#callable:advance_iterator}} -->
[View Source →](<../../../../../src/ballet/nanopb/pb_common.c#L122>)

Advances the iterator to the next field in the descriptor, resetting or updating indices as needed.
- **Inputs**:
    - `iter`: A pointer to a `pb_field_iter_t` structure that holds the current state of the field iteration.
- **Logic and Control Flow**:
    - Increment `iter->index` by 1.
    - Check if `iter->index` is greater than or equal to `iter->descriptor->field_count`.
    - If true, reset `iter->index`, `iter->field_info_index`, `iter->submessage_index`, and `iter->required_field_index` to 0.
    - If false, read the previous field descriptor using `PB_PROGMEM_READU32` and calculate `prev_type` and `descriptor_len`.
    - Update `iter->field_info_index` by adding `descriptor_len`.
    - Update `iter->required_field_index` based on whether the previous field type is required.
    - Update `iter->submessage_index` based on whether the previous field type is a submessage.
- **Output**: No return value; updates the `iter` structure in place.


---
### pb\_field\_iter\_begin<!-- {{#callable:pb_field_iter_begin}} -->
[View Source →](<../../../../../src/ballet/nanopb/pb_common.c#L156>)

Initializes a field iterator for a given message descriptor and message, and loads descriptor values.
- **Inputs**:
    - ``iter``: A pointer to a `pb_field_iter_t` structure that will be initialized.
    - ``desc``: A pointer to a `pb_msgdesc_t` structure that describes the message fields.
    - ``message``: A pointer to the message data to be iterated over.
- **Logic and Control Flow**:
    - Set all bytes of `iter` to zero using `memset` to initialize it.
    - Assign `desc` to `iter->descriptor` and `message` to `iter->message`.
    - Call `load_descriptor_values(iter)` to load the initial field descriptor values.
    - Return the result of `load_descriptor_values(iter)`, which indicates if the initialization was successful.
- **Output**: Returns a boolean value indicating whether the initialization and loading of descriptor values were successful.
- **Functions Called**:
    - [`load_descriptor_values`](<#load_descriptor_values>)


---
### pb\_field\_iter\_begin\_extension<!-- {{#callable:pb_field_iter_begin_extension}} -->
[View Source →](<../../../../../src/ballet/nanopb/pb_common.c#L166>)

Initializes a field iterator for a protocol buffer extension.
- **Inputs**:
    - ``iter``: A pointer to a `pb_field_iter_t` structure that will be initialized.
    - ``extension``: A pointer to a `pb_extension_t` structure that contains the extension data.
- **Logic and Control Flow**:
    - Retrieve the message descriptor from the `extension` structure.
    - Read the first field information word from the message descriptor.
    - Check if the field type is a pointer using `PB_ATYPE`.
    - If the field type is a pointer, call [`pb_field_iter_begin`](<#pb_field_iter_begin>) with the address of `extension->dest`.
    - If the field type is not a pointer, call [`pb_field_iter_begin`](<#pb_field_iter_begin>) with `extension->dest`.
    - Set `iter->pSize` to point to `extension->found`.
    - Return the status from [`pb_field_iter_begin`](<#pb_field_iter_begin>).
- **Output**: Returns a boolean indicating the success of initializing the iterator.
- **Functions Called**:
    - [`pb_field_iter_begin`](<#pb_field_iter_begin>)


---
### pb\_field\_iter\_next<!-- {{#callable:pb_field_iter_next}} -->
[View Source →](<../../../../../src/ballet/nanopb/pb_common.c#L188>)

Advances the field iterator to the next field and updates its descriptor values.
- **Inputs**:
    - `iter`: A pointer to a `pb_field_iter_t` structure that represents the current state of the field iterator.
- **Logic and Control Flow**:
    - Calls [`advance_iterator`](<#advance_iterator>) to move the iterator to the next field.
    - Calls [`load_descriptor_values`](<#load_descriptor_values>) to update the iterator's descriptor values based on the new field position.
    - Returns `true` if the iterator's index is not zero, indicating that the iterator has not wrapped around to the start.
- **Output**: A boolean value indicating whether the iterator has wrapped around to the start (returns `false` if it has, `true` otherwise).
- **Functions Called**:
    - [`advance_iterator`](<#advance_iterator>)
    - [`load_descriptor_values`](<#load_descriptor_values>)


---
### pb\_field\_iter\_find<!-- {{#callable:pb_field_iter_find}} -->
[View Source →](<../../../../../src/ballet/nanopb/pb_common.c#L195>)

Searches for a field with a specific tag in a protocol buffer field iterator.
- **Inputs**:
    - ``iter``: A pointer to a `pb_field_iter_t` structure that represents the current position in the field descriptor.
    - ``tag``: A `uint32_t` value representing the tag number of the field to find.
- **Logic and Control Flow**:
    - Check if the current field's tag matches the input `tag`; if so, return `true`.
    - If the input `tag` is greater than the largest tag in the descriptor, return `false`.
    - If the input `tag` is less than the current field's tag, set the iterator's index to the end to restart the search from the beginning.
    - Enter a loop to advance the iterator and check each field's tag against the input `tag`.
    - If a potential match is found, load the descriptor values and verify the tag and type; if they match, return `true`.
    - Continue the loop until the iterator returns to the starting position without finding a match, then return `false`.
- **Output**: Returns `true` if the field with the specified tag is found and `false` otherwise.
- **Functions Called**:
    - [`advance_iterator`](<#advance_iterator>)
    - [`load_descriptor_values`](<#load_descriptor_values>)


---
### pb\_field\_iter\_find\_extension<!-- {{#callable:pb_field_iter_find_extension}} -->
[View Source →](<../../../../../src/ballet/nanopb/pb_common.c#L246>)

Searches for an extension field in a protocol buffer field iterator.
- **Inputs**:
    - `iter`: A pointer to a `pb_field_iter_t` structure that represents the current position in the field descriptor.
- **Logic and Control Flow**:
    - Check if the current field type is an extension using `PB_LTYPE` macro.
    - If it is an extension, return `true`.
    - If not, store the current index in `start` and enter a loop to iterate over fields.
    - In each iteration, call [`advance_iterator`](<#advance_iterator>) to move to the next field without loading values.
    - Read the field information using `PB_PROGMEM_READU32` and check if the field type is an extension.
    - If an extension is found, call [`load_descriptor_values`](<#load_descriptor_values>) and return its result.
    - Continue the loop until the iterator returns to the starting index.
    - If no extension is found after a full loop, call [`load_descriptor_values`](<#load_descriptor_values>) and return `false`.
- **Output**: Returns `true` if an extension field is found, otherwise returns `false`.
- **Functions Called**:
    - [`advance_iterator`](<#advance_iterator>)
    - [`load_descriptor_values`](<#load_descriptor_values>)


---
### pb\_const\_cast<!-- {{#callable:pb_const_cast}} -->
[View Source →](<../../../../../src/ballet/nanopb/pb_common.c#L277>)

Casts away the `const` qualifier from a pointer using a union to avoid compiler warnings.
- **Inputs**:
    - `p`: A pointer to a constant object that needs to have its `const` qualifier removed.
- **Logic and Control Flow**:
    - Declare a union `t` with two members: `void *p1` and `const void *p2`.
    - Assign the input pointer `p` to the union member `t.p2`.
    - Return the union member `t.p1`, which is the non-const version of the input pointer.
- **Output**: A pointer to the same object as `p`, but without the `const` qualifier.


---
### pb\_field\_iter\_begin\_const<!-- {{#callable:pb_field_iter_begin_const}} -->
[View Source →](<../../../../../src/ballet/nanopb/pb_common.c#L290>)

Initializes a field iterator for a constant message descriptor by casting away the const qualifier.
- **Inputs**:
    - ``iter``: A pointer to a `pb_field_iter_t` structure that will be initialized.
    - ``desc``: A pointer to a constant `pb_msgdesc_t` structure that describes the message.
    - ``message``: A pointer to a constant message data structure to iterate over.
- **Logic and Control Flow**:
    - Calls [`pb_const_cast`](<#pb_const_cast>) to cast away the const qualifier from the `message` pointer.
    - Calls [`pb_field_iter_begin`](<#pb_field_iter_begin>) with the `iter`, `desc`, and the casted `message` to initialize the iterator.
- **Output**: Returns a boolean indicating whether the iterator was successfully initialized.
- **Functions Called**:
    - [`pb_field_iter_begin`](<#pb_field_iter_begin>)
    - [`pb_const_cast`](<#pb_const_cast>)


---
### pb\_field\_iter\_begin\_extension\_const<!-- {{#callable:pb_field_iter_begin_extension_const}} -->
[View Source →](<../../../../../src/ballet/nanopb/pb_common.c#L295>)

Initializes a field iterator for a constant extension by casting away the const qualifier and calling another function.
- **Inputs**:
    - ``iter``: A pointer to a `pb_field_iter_t` structure that will be initialized.
    - ``extension``: A pointer to a constant `pb_extension_t` structure representing the extension to iterate over.
- **Logic and Control Flow**:
    - Casts away the const qualifier from the `extension` using [`pb_const_cast`](<#pb_const_cast>) to allow modification.
    - Calls [`pb_field_iter_begin_extension`](<#pb_field_iter_begin_extension>) with the `iter` and the casted `extension` to initialize the iterator.
- **Output**: Returns a boolean value indicating the success of initializing the iterator.
- **Functions Called**:
    - [`pb_field_iter_begin_extension`](<#pb_field_iter_begin_extension>)
    - [`pb_const_cast`](<#pb_const_cast>)


---
### pb\_default\_field\_callback<!-- {{#callable:pb_default_field_callback}} -->
[View Source →](<../../../../../src/ballet/nanopb/pb_common.c#L300>)

Handles field callbacks for encoding or decoding operations based on the provided stream and field data.
- **Inputs**:
    - ``istream``: Pointer to the input stream for decoding operations; can be `NULL` if not used.
    - ``ostream``: Pointer to the output stream for encoding operations; can be `NULL` if not used.
    - ``field``: Pointer to the field descriptor containing data and callback information.
- **Logic and Control Flow**:
    - Check if the `field`'s `data_size` matches the size of `pb_callback_t`.
    - Cast `field->pData` to `pb_callback_t*` and store it in `pCallback`.
    - If `pCallback` is not `NULL`, check if `istream` is not `NULL` and `pCallback->funcs.decode` is not `NULL`.
    - If both conditions are true, call `pCallback->funcs.decode` with `istream`, `field`, and `pCallback->arg` and return its result.
    - If `ostream` is not `NULL` and `pCallback->funcs.encode` is not `NULL`, call `pCallback->funcs.encode` with `ostream`, `field`, and `pCallback->arg` and return its result.
    - If no conditions are met for decoding or encoding, return `true` indicating success without action.
- **Output**: Returns `true` if the callback is successfully executed or if no action is needed; otherwise, returns the result of the decode or encode function.


---
### pb\_validate\_utf8<!-- {{#callable:pb_validate_utf8}} -->
[View Source →](<../../../../../src/ballet/nanopb/pb_common.c#L334>)

Validates if a given string is correctly encoded in UTF-8 format.
- **Inputs**:
    - `str`: A pointer to a null-terminated string that needs UTF-8 validation.
- **Logic and Control Flow**:
    - Initialize a pointer `s` to iterate over the string `str` as `pb_byte_t` type.
    - Loop through each byte of the string until a null character is encountered.
    - Check if the byte is a single-byte UTF-8 character (0xxxxxxx) and move to the next byte if true.
    - For a two-byte UTF-8 character (110XXXXx 10xxxxxx), validate the second byte and check for overlong encoding; move to the next character if valid.
    - For a three-byte UTF-8 character (1110XXXX 10Xxxxxx 10xxxxxx), validate the second and third bytes, check for overlong encoding, surrogate pairs, and invalid code points; move to the next character if valid.
    - For a four-byte UTF-8 character (11110XXX 10XXxxxx 10xxxxxx 10xxxxxx), validate the second, third, and fourth bytes, check for overlong encoding and code points beyond U+10FFFF; move to the next character if valid.
    - Return false if any invalid UTF-8 sequence is detected.
    - Return true if the entire string is validated without errors.
- **Output**: Returns `true` if the string is valid UTF-8, otherwise returns `false`.



---
Made with ❤️ by [Driver](https://www.driver.ai/)