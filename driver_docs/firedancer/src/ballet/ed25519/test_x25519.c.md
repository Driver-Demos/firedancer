<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests and benchmarks for X25519 key exchange and public key derivation using predefined test vectors.

# Purpose
The code is a C program designed to test and benchmark the X25519 elliptic curve Diffie-Hellman (ECDH) key exchange algorithm. It includes test vectors and functions to verify the correctness of the X25519 implementation against known test cases, such as those from RFC 7748 and Wycheproof. The program defines a structure `fd_x25519_test_vector` to hold test vectors, which include private keys (`self`), peer public keys (`peer`), and expected shared secrets (`secret`). The [`simulate_ecdh`](<#simulate_ecdh>) function generates random private keys, computes corresponding public keys, and performs key exchanges to verify that the shared secrets match.

The [`main`](<#main>) function initializes a random number generator and runs a series of tests using predefined test vectors and Wycheproof test cases. It also simulates multiple ECDH exchanges to ensure the implementation's reliability. Additionally, the program benchmarks the performance of the `fd_x25519_exchange` and `fd_x25519_public` functions by measuring the time taken to perform a large number of key exchanges and public key derivations. The results are logged to provide insights into the algorithm's efficiency. The program is structured to be executed as a standalone application, with the main function orchestrating the testing and benchmarking processes.
# Imports and Dependencies

---
- `fd_x25519.h`
- `../hex/fd_hex.h`
- `test_x25519_wycheproof.c`


# Global Variables

---
### test\_x25519\_vector
- **Type**: ``fd_x25519_test_vector_t[]``
- **Description**: An array of `fd_x25519_test_vector_t` structures, each containing three 32-byte arrays: `self`, `peer`, and `secret`. These arrays represent test vectors for X25519 key exchange, with `self` and `peer` being the private and public keys, respectively, and `secret` being the expected shared secret.
- **Use**: Used to verify the correctness of the X25519 key exchange implementation by comparing the computed shared secret with the expected `secret` value.


# Data Structures

---
### fd\_x25519\_test\_vector
- **Type**: ``struct``
- **Members**:
    - ``self``: An array of 32 unsigned characters representing the private key of the entity.
    - ``peer``: An array of 32 unsigned characters representing the public key of the peer entity.
    - ``secret``: An array of 32 unsigned characters representing the shared secret derived from the key exchange.
- **Description**: Defines a structure used to store test vectors for the X25519 key exchange algorithm, including the private key (`self`), the peer's public key (`peer`), and the resulting shared secret (`secret`).


---
### fd\_x25519\_test\_vector\_t
- **Type**: ``struct``
- **Members**:
    - ``self``: An array of 32 unsigned characters representing the private key of the entity.
    - ``peer``: An array of 32 unsigned characters representing the public key of the peer entity.
    - ``secret``: An array of 32 unsigned characters representing the shared secret derived from the key exchange.
- **Description**: Defines a structure used to store test vectors for the X25519 key exchange algorithm, including the private key (`self`), the peer's public key (`peer`), and the resulting shared secret (`secret`).


# Functions

---
### simulate\_ecdh<!-- {{#callable:simulate_ecdh}} -->
[View Source →](<../../../../../src/ballet/ed25519/test_x25519.c#L43>)

Simulates an Elliptic Curve Diffie-Hellman (ECDH) key exchange using random secrets and verifies the shared secret consistency.
- **Inputs**:
    - `rng`: A pointer to a random number generator of type `fd_rng_t` used to generate random secret keys.
- **Logic and Control Flow**:
    - Generate two random 32-byte secret keys `secret0` and `secret1` using the random number generator `rng`.
    - Derive the corresponding public keys `pubkey0` and `pubkey1` from `secret0` and `secret1` using the `fd_x25519_public` function.
    - Compute the shared secrets `_shared0` and `_shared1` using the `fd_x25519_exchange` function with the secret and public keys swapped between the two parties.
    - Check if either of the shared secrets is `NULL`, indicating a failure in the key exchange, and log an error if so.
    - Compare the two shared secrets for equality using `memcmp`; if they differ, log an error indicating a failure in the key exchange.
- **Output**: No output is returned; the function logs errors if the key exchange fails or if the shared secrets do not match.


---
### log\_bench<!-- {{#callable:log_bench}} -->
[View Source →](<../../../../../src/ballet/ed25519/test_x25519.c#L89>)

Logs the performance metrics of a benchmark, including operations per second and time per call.
- **Inputs**:
    - ``descr``: A constant character pointer to a description of the benchmark.
    - ``iter``: An unsigned long integer representing the number of iterations performed in the benchmark.
    - ``dt``: A long integer representing the total time taken for the benchmark in some time unit.
- **Logic and Control Flow**:
    - Calculate `khz` as the number of iterations per second per core, scaled to kilohertz, using the formula `1e6f * (float)iter / (float)dt`.
    - Calculate `tau` as the average time per call in nanoseconds, using the formula `(float)dt / (float)iter`.
    - Log the description, `khz`, and `tau` using the `FD_LOG_NOTICE` macro with a formatted string.
- **Output**: No return value; the function logs the benchmark results using the `FD_LOG_NOTICE` macro.


---
### test\_wycheproofs<!-- {{#callable:test_wycheproofs}} -->
[View Source →](<../../../../../src/ballet/ed25519/test_x25519.c#L98>)

Validates X25519 key exchange operations against predefined test vectors from Wycheproof.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize a character array `cstr` with a size of 128 to store formatted strings.
    - Initialize an unsigned character array `shared` with a size of 32 to store the shared secret.
    - Iterate over the `x25519_verify_wycheproofs` array of test vectors until a test vector with a null `comment` is found.
    - For each test vector, call `fd_x25519_exchange` with the private and public keys from the test vector and store the result in `shared`.
    - Check if the result of `fd_x25519_exchange` is not null and store the result in `actual`.
    - Use `FD_TEST_CUSTOM` to verify if `actual` matches the expected result (`proof->ok`) and log the test case ID if it does not match.
    - If the test vector expects a successful exchange (`proof->ok` is true), use `FD_TEST_CUSTOM` to verify if the computed shared secret matches the expected shared secret (`proof->shared`) and log the test case ID if it does not match.
    - Log a notice message indicating that the Wycheproof tests for `fd_x25519_exchange` passed.
- **Output**: No output is returned; the function logs test results and notices.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/ballet/ed25519/test_x25519.c#L117>)

Initializes the environment, tests X25519 key exchange vectors, simulates ECDH exchanges, and benchmarks key exchange and public key derivation.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Initializes a random number generator `rng`.
    - Calls [`test_wycheproofs`](<#test_wycheproofs>) to verify X25519 key exchange using predefined test vectors.
    - Iterates over `test_x25519_vector` to perform X25519 key exchanges and checks results against expected secrets.
    - Simulates 10,000 ECDH exchanges using [`simulate_ecdh`](<#simulate_ecdh>) and logs the result.
    - Prepares random secret keys `secret0` and `secret1` for benchmarking.
    - Derives public keys `pubkey0` and `pubkey1` from `secret0` and `secret1` respectively.
    - Benchmarks the `fd_x25519_exchange` function by performing 10,000 key exchanges and logs the performance.
    - Benchmarks the `fd_x25519_public` function by deriving public keys from modified secrets and logs the performance.
    - Cleans up the random number generator and logs a success message.
    - Calls `fd_halt` to terminate the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`test_wycheproofs`](<#test_wycheproofs>)
    - [`simulate_ecdh`](<#simulate_ecdh>)
    - [`log_bench`](<#log_bench>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)