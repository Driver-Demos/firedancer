<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

SHA-512 and SHA-384 hash function implementations, including initialization, appending, and finalization.

# Purpose
The code implements the SHA-512 and SHA-384 cryptographic hash functions. It provides functions to initialize, update, and finalize the hash computation, as well as functions to compute the hash in a single step. The code includes memory alignment checks and uses a reference implementation derived from OpenSSL's SHA-512 implementation. The [`fd_sha512_core_ref`](<#fd_sha512_core_ref>) function is the core of the SHA-512 algorithm, processing data blocks and updating the hash state. The code supports both incremental hashing, where data is appended in chunks, and one-shot hashing, where the entire data is processed at once.

The file defines several functions for managing SHA-512 contexts, such as [`fd_sha512_new`](<#fd_sha512_new>), [`fd_sha512_join`](<#fd_sha512_join>), [`fd_sha512_leave`](<#fd_sha512_leave>), and [`fd_sha512_delete`](<#fd_sha512_delete>), which handle memory allocation and deallocation for SHA-512 structures. The [`fd_sha512_init`](<#fd_sha512_init>), [`fd_sha512_append`](<#fd_sha512_append>), and [`fd_sha512_fini`](<#fd_sha512_fini>) functions manage the lifecycle of a hash computation, while [`fd_sha512_hash`](<#fd_sha512_hash>) and [`fd_sha384_hash`](<#fd_sha384_hash>) provide streamlined interfaces for computing hashes directly. The code also includes conditional compilation to select between a reference implementation and an AVX2-optimized implementation, depending on the availability of AVX instructions.
# Imports and Dependencies

---
- `fd_sha512.h`


# Functions

---
### fd\_sha512\_align<!-- {{#callable:fd_sha512_align}} -->
[View Source →](<../../../../../src/ballet/sha512/fd_sha512.c#L3>)

Returns the alignment requirement for SHA-512 operations.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the value of the macro `FD_SHA512_ALIGN`.
- **Output**: The alignment requirement for SHA-512 operations as defined by `FD_SHA512_ALIGN`.


---
### fd\_sha512\_footprint<!-- {{#callable:fd_sha512_footprint}} -->
[View Source →](<../../../../../src/ballet/sha512/fd_sha512.c#L8>)

Returns the constant `FD_SHA512_FOOTPRINT`.
- **Inputs**: None
- **Logic and Control Flow**:
    - Return the value of `FD_SHA512_FOOTPRINT`.
- **Output**: The function returns an `ulong` value which is the constant `FD_SHA512_FOOTPRINT`.


---
### fd\_sha512\_new<!-- {{#callable:fd_sha512_new}} -->
[View Source →](<../../../../../src/ballet/sha512/fd_sha512.c#L13>)

Initializes a new SHA-512 context in shared memory, ensuring alignment and setting a magic number for validation.
- **Inputs**:
    - `shmem`: A pointer to the shared memory where the SHA-512 context will be initialized.
- **Logic and Control Flow**:
    - Cast `shmem` to a `fd_sha512_t` pointer named `sha`.
    - Check if `shmem` is NULL; if true, log a warning and return NULL.
    - Check if `shmem` is aligned according to `fd_sha512_align()`; if not, log a warning and return NULL.
    - Get the footprint size using `fd_sha512_footprint()`.
    - Clear the memory at `sha` using `fd_memset` with the footprint size.
    - Use memory fences (`FD_COMPILER_MFENCE`) to ensure memory operations are completed.
    - Set the `magic` field of `sha` to `FD_SHA512_MAGIC` using a volatile write.
    - Return the pointer to the initialized `sha`.
- **Output**: A pointer to the initialized `fd_sha512_t` structure, or NULL if initialization fails.
- **Functions Called**:
    - [`fd_sha512_align`](<#fd_sha512_align>)
    - [`fd_sha512_footprint`](<#fd_sha512_footprint>)


---
### fd\_sha512\_join<!-- {{#callable:fd_sha512_join}} -->
[View Source →](<../../../../../src/ballet/sha512/fd_sha512.c#L38>)

Validates and returns a pointer to a `fd_sha512_t` structure if the input is non-null, properly aligned, and has the correct magic number.
- **Inputs**:
    - `shsha`: A pointer to a memory location that is expected to be a `fd_sha512_t` structure.
- **Logic and Control Flow**:
    - Check if `shsha` is NULL; if true, log a warning and return NULL.
    - Check if `shsha` is aligned according to `fd_sha512_align()`; if not, log a warning and return NULL.
    - Cast `shsha` to a `fd_sha512_t` pointer and store it in `sha`.
    - Check if `sha->magic` equals `FD_SHA512_MAGIC`; if not, log a warning and return NULL.
    - Return the `sha` pointer.
- **Output**: A pointer to a `fd_sha512_t` structure if all checks pass, otherwise NULL.
- **Functions Called**:
    - [`fd_sha512_align`](<#fd_sha512_align>)


---
### fd\_sha512\_leave<!-- {{#callable:fd_sha512_leave}} -->
[View Source →](<../../../../../src/ballet/sha512/fd_sha512.c#L61>)

Returns the input `fd_sha512_t` pointer if it is not NULL, otherwise logs a warning and returns NULL.
- **Inputs**:
    - `sha`: A pointer to an `fd_sha512_t` structure, which represents the SHA-512 state.
- **Logic and Control Flow**:
    - Check if the `sha` pointer is NULL using `FD_UNLIKELY`.
    - If `sha` is NULL, log a warning message 'NULL sha' and return NULL.
    - If `sha` is not NULL, return the `sha` pointer cast to a `void *`.
- **Output**: A `void *` pointer to the `fd_sha512_t` structure if `sha` is not NULL, otherwise NULL.


---
### fd\_sha512\_delete<!-- {{#callable:fd_sha512_delete}} -->
[View Source →](<../../../../../src/ballet/sha512/fd_sha512.c#L72>)

Validates and deletes a SHA-512 context by checking its alignment and magic number, then clears the magic number.
- **Inputs**:
    - `shsha`: A pointer to the SHA-512 context to delete.
- **Logic and Control Flow**:
    - Check if `shsha` is NULL; if true, log a warning and return NULL.
    - Check if `shsha` is aligned according to [`fd_sha512_align`](<#fd_sha512_align>); if not, log a warning and return NULL.
    - Cast `shsha` to `fd_sha512_t *` and store in `sha`.
    - Check if `sha->magic` equals `FD_SHA512_MAGIC`; if not, log a warning and return NULL.
    - Use memory fence operations to ensure memory ordering, then set `sha->magic` to 0.
    - Return the pointer `sha` cast to `void *`.
- **Output**: Returns a pointer to the deleted SHA-512 context if successful, or NULL if any validation fails.
- **Functions Called**:
    - [`fd_sha512_align`](<#fd_sha512_align>)


---
### fd\_sha512\_core\_ref<!-- {{#callable:fd_sha512_core_ref}} -->
[View Source →](<../../../../../src/ballet/sha512/fd_sha512.c#L128>)

Processes SHA-512 hash computation on a given block of data, updating the hash state.
- **Inputs**:
    - `state`: A pointer to an array of 8 `ulong` values representing the current hash state, which must be 64-byte aligned.
    - `block`: A pointer to the input data block, ideally 128-byte aligned, with a size of 128 bytes multiplied by `block_cnt`.
    - `block_cnt`: A positive `ulong` value indicating the number of 128-byte blocks to process.
- **Logic and Control Flow**:
    - Initialize working variables `a` to `h` with the current state values.
    - Iterate over the first 16 blocks, performing byte swap on each block and computing temporary values `T1` and `T2` using SHA-512 specific functions and constants.
    - Update the working variables `a` to `h` using `T1` and `T2`.
    - For the remaining 64 iterations, compute `s0` and `s1` using the `sigma0` and `sigma1` functions, update the `X` array, and compute `T1` and `T2` again.
    - Update the working variables `a` to `h` using `T1` and `T2`.
    - Add the working variables back to the state array to update the hash state.
    - Advance the block pointer by 16 and repeat the process for each block until `block_cnt` is exhausted.
- **Output**: The function updates the `state` array with the new hash state after processing the input blocks.


---
### fd\_sha384\_init<!-- {{#callable:fd_sha384_init}} -->
[View Source →](<../../../../../src/ballet/sha512/fd_sha512.c#L247>)

Initializes a `fd_sha512_t` structure for SHA-384 hashing by setting its state to predefined constants and resetting counters.
- **Inputs**:
    - `sha`: A pointer to a `fd_sha512_t` structure that will be initialized for SHA-384 hashing.
- **Logic and Control Flow**:
    - Set `sha->state[0]` to `0xcbbb9d5dc1059ed8UL`.
    - Set `sha->state[1]` to `0x629a292a367cd507UL`.
    - Set `sha->state[2]` to `0x9159015a3070dd17UL`.
    - Set `sha->state[3]` to `0x152fecd8f70e5939UL`.
    - Set `sha->state[4]` to `0x67332667ffc00b31UL`.
    - Set `sha->state[5]` to `0x8eb44a8768581511UL`.
    - Set `sha->state[6]` to `0xdb0c2e0d64f98fa7UL`.
    - Set `sha->state[7]` to `0x47b5481dbefa4fa4UL`.
    - Set `sha->buf_used` to `0U`.
    - Set `sha->bit_cnt_lo` to `0UL`.
    - Set `sha->bit_cnt_hi` to `0UL`.
    - Return the pointer `sha`.
- **Output**: Returns the initialized `fd_sha512_t` pointer.


---
### fd\_sha512\_init<!-- {{#callable:fd_sha512_init}} -->
[View Source →](<../../../../../src/ballet/sha512/fd_sha512.c#L264>)

Initializes a `fd_sha512_t` structure with the SHA-512 initial hash values and resets its buffer and bit counters.
- **Inputs**:
    - `sha`: A pointer to a `fd_sha512_t` structure that will be initialized.
- **Logic and Control Flow**:
    - Sets the `state` array of the `sha` structure to the initial hash values for SHA-512.
    - Resets `buf_used` to 0, indicating no data is currently buffered.
    - Resets `bit_cnt_lo` and `bit_cnt_hi` to 0, indicating no bits have been processed yet.
    - Returns the pointer to the initialized `fd_sha512_t` structure.
- **Output**: A pointer to the initialized `fd_sha512_t` structure.


---
### fd\_sha512\_append<!-- {{#callable:fd_sha512_append}} -->
[View Source →](<../../../../../src/ballet/sha512/fd_sha512.c#L281>)

Appends data to a SHA-512 hash computation, updating the internal state and buffer as needed.
- **Inputs**:
    - `sha`: A pointer to an `fd_sha512_t` structure representing the current state of the SHA-512 hash computation.
    - `_data`: A pointer to the data to append to the hash computation.
    - `sz`: The size in bytes of the data to append.
- **Logic and Control Flow**:
    - Check if `sz` is zero; if so, return `sha` immediately.
    - Unpack the internal state, buffer, and bit counters from `sha`.
    - Update the bit counters to reflect the new data size.
    - If there are buffered bytes from previous appends, check if the new data can complete the current block.
    - If the new data is insufficient to complete the block, buffer it and update `buf_used`, then return `sha`.
    - If the block can be completed, copy enough data to complete the block, update the hash using `fd_sha512_core`, and reset `buf_used`.
    - Process the bulk of the data in blocks using `fd_sha512_core`.
    - Buffer any remaining bytes that do not form a complete block and update `buf_used`.
    - Return the updated `sha` structure.
- **Output**: Returns a pointer to the updated `fd_sha512_t` structure.


---
### fd\_sha512\_fini<!-- {{#callable:fd_sha512_fini}} -->
[View Source →](<../../../../../src/ballet/sha512/fd_sha512.c#L351>)

Finalizes the SHA-512 hash computation and stores the result in the provided buffer.
- **Inputs**:
    - `sha`: A pointer to an `fd_sha512_t` structure that holds the current state of the SHA-512 computation.
    - `_hash`: A pointer to a buffer where the final hash value will be stored.
- **Logic and Control Flow**:
    - Unpack the state, buffer, buffer usage, and bit count from the `sha` structure.
    - Append the terminating message byte `0x80` to the buffer and increment the buffer usage.
    - Check if there is enough space in the buffer to append the message length; if not, clear the buffer, update the hash, and start a new block.
    - Clear the buffer up to the last 128 bits, append the message size in bits to the last 128 bits, and update the hash to finalize it.
    - Unpack the final hash value from the state into the `_hash` buffer, performing byte swaps as necessary.
- **Output**: Returns a pointer to the buffer where the final hash value is stored.


---
### fd\_sha384\_fini<!-- {{#callable:fd_sha384_fini}} -->
[View Source →](<../../../../../src/ballet/sha512/fd_sha512.c#L401>)

Finalizes the SHA-384 hash computation and stores the result in the provided buffer.
- **Inputs**:
    - `sha`: A pointer to an `fd_sha512_t` structure that holds the SHA-512 state.
    - `_hash`: A pointer to a buffer where the SHA-384 hash result will be stored.
- **Logic and Control Flow**:
    - Declare a local buffer `hash` with size `FD_SHA512_HASH_SZ` and align it to 64 bytes.
    - Call [`fd_sha512_fini`](<#fd_sha512_fini>) to finalize the SHA-512 hash computation and store the result in the local `hash` buffer.
    - Copy the first `FD_SHA384_HASH_SZ` bytes from the local `hash` buffer to the `_hash` buffer.
    - Return the `_hash` pointer.
- **Output**: Returns a pointer to the buffer where the SHA-384 hash result is stored.
- **Functions Called**:
    - [`fd_sha512_fini`](<#fd_sha512_fini>)


---
### fd\_sha512\_hash<!-- {{#callable:fd_sha512_hash}} -->
[View Source →](<../../../../../src/ballet/sha512/fd_sha512.c#L410>)

Computes the SHA-512 hash of the given data.
- **Inputs**:
    - `_data`: Pointer to the input data to hash.
    - `sz`: Size of the input data in bytes.
    - `_hash`: Pointer to the buffer where the computed hash will be stored.
- **Logic and Control Flow**:
    - Initialize the SHA-512 state with predefined constants.
    - Calculate the number of complete blocks in the input data and process them using `fd_sha512_core`.
    - Copy any remaining data into a buffer and append the padding byte `0x80`.
    - If the buffer is too full to append the message length, process the buffer and reset it.
    - Calculate the message length in bits and append it to the buffer.
    - Process the final block with `fd_sha512_core`.
    - Store the final hash value in the output buffer, converting each state value with `fd_ulong_bswap`.
- **Output**: Returns a pointer to the buffer containing the computed SHA-512 hash.


---
### fd\_sha384\_hash<!-- {{#callable:fd_sha384_hash}} -->
[View Source →](<../../../../../src/ballet/sha512/fd_sha512.c#L464>)

Computes the SHA-384 hash of the given data.
- **Inputs**:
    - `_data`: Pointer to the input data to hash.
    - `sz`: Size of the input data in bytes.
    - `_hash`: Pointer to the buffer where the computed hash will be stored.
- **Logic and Control Flow**:
    - Initialize the SHA-384 state with predefined constants.
    - Calculate the number of complete blocks in the input data and process them using `fd_sha512_core`.
    - Copy any remaining data into a buffer and append the padding byte `0x80`.
    - If the buffer is too full to append the message length, process the buffer and reset it.
    - Append the message length in bits to the buffer and process it.
    - Store the final hash value in the provided `_hash` buffer after byte-swapping the state values.
- **Output**: Returns a pointer to the buffer containing the computed SHA-384 hash.



---
Made with ❤️ by [Driver](https://www.driver.ai/)