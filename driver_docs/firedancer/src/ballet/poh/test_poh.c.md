<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for Proof of History (PoH) functions, including append, mixin, and performance benchmarking.

# Purpose
The code is a C program designed to test and benchmark the Proof of History (PoH) functionality, specifically focusing on the `fd_poh_append` and `fd_poh_mixin` functions. It includes several test functions such as [`test_poh_append_nop`](<#test_poh_append_nop>), [`test_poh_append_one`](<#test_poh_append_one>), and [`test_poh_mixin`](<#test_poh_mixin>), which verify the correctness of these functions by comparing their outputs to expected results using the SHA-256 hashing algorithm. The program also defines data structures `fd_poh_test_step_t` and `fd_poh_test_vector_t` to represent test steps and vectors, which are used in the [`test_poh_vector`](<#test_poh_vector>) function to validate the PoH implementation against predefined test cases, including those from the Solana mainnet.

Additionally, the program includes a benchmarking function, [`bench_poh_sequential`](<#bench_poh_sequential>), which measures the performance of the `fd_poh_append` function by executing it in a loop and calculating the throughput in millions of hashes per second (MH/s). The [`main`](<#main>) function orchestrates the execution of these tests and benchmarks, ensuring that the PoH implementation is both correct and efficient. The program uses logging to report the results of the tests and benchmarks, and it initializes and finalizes the environment with `fd_boot` and `fd_halt` functions, respectively.
# Imports and Dependencies

---
- `fd_poh.h`
- `../sha256/fd_sha256.h`


# Global Variables

---
### solana\_mainnet\_block\_0\_steps
- **Type**: ``fd_poh_test_step_t const[]``
- **Description**: An array of `fd_poh_test_step_t` structures that define the steps for processing the Solana mainnet block 0. Each element in the array specifies the number of iterations for the `fd_poh_append` function or indicates the end of the list with a value of -1.
- **Use**: Used to define the sequence of operations for processing Solana mainnet block 0 in the `test_poh_vector` function.


---
### solana\_mainnet\_block\_1\_steps
- **Type**: ``fd_poh_test_step_t const``
- **Description**: An array of `fd_poh_test_step_t` structures that define a sequence of steps for processing a Solana mainnet block. Each step can either specify a number of iterations for the `fd_poh_append` function or a mixin value for the `fd_poh_mixin` function.
- **Use**: Used to define the sequence of operations for processing Solana mainnet block 1 in the `test_poh_vector` function.


---
### poh\_test\_vectors
- **Type**: ``fd_poh_test_vector_t const[]``
- **Description**: An array of test vectors for the Proof of History (PoH) implementation. Each element in the array is a `fd_poh_test_vector_t` structure that contains a name, pre-computed hash values (`pre` and `post`), and a sequence of steps (`steps`) to test the PoH process.
- **Use**: Used to validate the correctness of the PoH implementation by comparing the computed hash results against expected values for specific test cases.


# Data Structures

---
### fd\_poh\_test\_step
- **Type**: ``struct``
- **Members**:
    - ``mixin``: Array of unsigned characters used as a value to pass to `fd_poh_mixin`.
    - ``n``: Integer indicating the number of iterations for `fd_poh_append`, or special values to call `fd_poh_mixin` or mark the end of the list.
- **Description**: Defines a step in a proof of history (PoH) test sequence, where each step can either append a number of iterations to a PoH state or mix in a specific value, with special handling for zero iterations and end-of-list indication.


---
### fd\_poh\_test\_step\_t
- **Type**: ``struct``
- **Members**:
    - ``mixin``: Array of unsigned characters used as a value to pass to `fd_poh_mixin`.
    - ``n``: Integer indicating the number of iterations for `fd_poh_append`, or a special value to call `fd_poh_mixin` or indicate the end of the list.
- **Description**: Defines a step in a Proof of History (PoH) test sequence, where each step can either append a number of iterations to the PoH state or mix in a specific value, with special handling for zero iterations and end-of-list indication.


---
### fd\_poh\_test\_vector
- **Type**: ``struct``
- **Members**:
    - ``pre``: An array of 32 unsigned characters, aligned to 32 bytes, representing the initial state before processing.
    - ``post``: An array of 32 unsigned characters, aligned to 32 bytes, representing the expected state after processing.
    - ``name``: A constant character pointer to the name of the test vector.
    - ``steps``: A constant pointer to an array of `fd_poh_test_step_t` structures, defining the sequence of steps to execute.
- **Description**: Defines a test vector for Proof of History (PoH) operations, containing initial and expected states, a name identifier, and a sequence of steps to execute during testing.


---
### fd\_poh\_test\_vector\_t
- **Type**: ``struct``
- **Members**:
    - ``pre``: An array of 32 `uchar` values, aligned to 32 bytes, representing the initial state before processing.
    - ``post``: An array of 32 `uchar` values, aligned to 32 bytes, representing the expected state after processing.
    - ``name``: A pointer to a constant character string that holds the name of the test vector.
    - ``steps``: A pointer to a constant array of `fd_poh_test_step_t` structures that define the sequence of operations to perform.
- **Description**: Defines a test vector for Proof of History (PoH) operations, including initial and expected states, a name for identification, and a sequence of steps to execute.


# Functions

---
### test\_poh\_append\_nop<!-- {{#callable:test_poh_append_nop}} -->
[View Source →](<../../../../../src/ballet/poh/test_poh.c#L5>)

Tests that calling `fd_poh_append` with zero iterations does not alter the PoH state.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize an array `poh` with zeros, sized to `FD_SHA256_HASH_SZ`.
    - Create a pattern `want` by filling it with values starting from 0x40 to 0x40 + `FD_SHA256_HASH_SZ`.
    - Copy the pattern `want` into `poh` using `fd_memcpy`.
    - Call `fd_poh_append` with `poh` and zero iterations.
    - Verify that `poh` remains unchanged by comparing it to `want` using `FD_TEST` and `memcmp`.
- **Output**: No output is returned; the function performs a test and uses `FD_TEST` to assert the result.


---
### test\_poh\_append\_one<!-- {{#callable:test_poh_append_one}} -->
[View Source →](<../../../../../src/ballet/poh/test_poh.c#L22>)

Validates that a single round of `fd_poh_append` produces the same result as the SHA-256 hashing API.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize an array `pre` with a pattern of bytes starting from 0x40.
    - Copy `pre` into a new array `poh` and perform one round of `fd_poh_append` on `poh`.
    - Initialize a SHA-256 context `sha`, append `pre` to it, and finalize the hash into `expected`.
    - Compare the contents of `poh` and `expected` using `memcmp`.
    - If they differ, log an error message with the expected and actual values.
- **Output**: No output is returned; the function logs an error if the test fails.


---
### test\_poh\_mixin<!-- {{#callable:test_poh_mixin}} -->
[View Source →](<../../../../../src/ballet/poh/test_poh.c#L52>)

Validates that the `fd_poh_mixin` function produces the same hash result as the SHA-256 simple API when given specific input patterns.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize an array `pre` with a pattern of bytes starting from 0x40 to 0x40 + `FD_SHA256_HASH_SZ`.
    - Initialize an array `mixin` with a pattern of bytes starting from 0x60 to 0x60 + `FD_SHA256_HASH_SZ`.
    - Copy the `pre` array into the `poh` array and apply the `fd_poh_mixin` function with `mixin` as the argument.
    - Initialize a SHA-256 context `sha`, append `pre` and `mixin` to it, and finalize the hash into `expected`.
    - Compare the `poh` array with the `expected` array; if they differ, log an error with the differing values.
- **Output**: No output is returned; the function logs an error if the `poh` and `expected` arrays do not match.


---
### test\_poh\_vector<!-- {{#callable:test_poh_vector}} -->
[View Source →](<../../../../../src/ballet/poh/test_poh.c#L106>)

Executes a series of PoH (Proof of History) operations on a test vector and verifies the result against an expected hash.
- **Inputs**:
    - `t`: A pointer to a `fd_poh_test_vector_t` structure containing the initial hash (`pre`), expected final hash (`post`), test name, and a sequence of steps (`steps`) to execute.
- **Logic and Control Flow**:
    - Initialize a 32-byte array `poh` with the `pre` value from the test vector `t`.
    - Iterate over each step in the `steps` array of the test vector `t` until a step with `n` less than 0 is encountered.
    - For each step, if `n` is 0, call `fd_poh_mixin` with `poh` and the step's `mixin` value; otherwise, call `fd_poh_append` with `poh` and the step's `n` value.
    - After processing all steps, compare the resulting `poh` with the `post` value from the test vector `t`.
    - If the `poh` does not match the `post`, log an error message with the test name and the mismatched values; otherwise, log a success message with the test name.
- **Output**: No return value; logs success or failure of the test based on the comparison of the computed and expected hash values.


---
### bench\_poh\_sequential<!-- {{#callable:bench_poh_sequential}} -->
[View Source →](<../../../../../src/ballet/poh/test_poh.c#L170>)

Measures the performance of the `fd_poh_append` function by executing it sequentially with a warmup and a main test phase, and logs the throughput in million hashes per second.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize a zeroed array `poh` of size `FD_SHA256_HASH_SZ` to store the hash state.
    - Set `batch_sz` to 1024, which determines the number of iterations for each `fd_poh_append` call.
    - Perform a warmup phase by calling `fd_poh_append` 1000 times with `batch_sz` iterations, measuring the elapsed time using `fd_log_wallclock`.
    - Execute the main test phase by calling `fd_poh_append` 100,000 times with `batch_sz` iterations, again measuring the elapsed time.
    - Calculate the total number of hashes processed as `iter * batch_sz`.
    - Convert the elapsed time from nanoseconds to seconds.
    - Log the throughput in million hashes per second using `FD_LOG_NOTICE`.
- **Output**: Logs the throughput of the `fd_poh_append` function in million hashes per second.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/ballet/poh/test_poh.c#L193>)

Initializes the environment, runs a series of tests and benchmarks for Proof of History (PoH) functions, and then terminates the program.
- **Inputs**:
    - `argc`: The number of command-line arguments passed to the program.
    - `argv`: An array of strings representing the command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Executes [`test_poh_append_nop`](<#test_poh_append_nop>) to verify that `fd_poh_append` with zero iterations is a no-operation.
    - Executes [`test_poh_append_one`](<#test_poh_append_one>) to ensure one round of `fd_poh_append` matches the simple hashing API.
    - Executes [`test_poh_mixin`](<#test_poh_mixin>) to verify that `fd_poh_mixin` matches the simple hashing API.
    - Iterates over `poh_test_vectors` and calls [`test_poh_vector`](<#test_poh_vector>) for each test vector to validate PoH operations against expected results.
    - Runs [`bench_poh_sequential`](<#bench_poh_sequential>) to benchmark the sequential performance of `fd_poh_append`.
    - Logs a notice indicating the tests passed with `FD_LOG_NOTICE`.
    - Calls `fd_halt` to terminate the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`test_poh_append_nop`](<#test_poh_append_nop>)
    - [`test_poh_append_one`](<#test_poh_append_one>)
    - [`test_poh_mixin`](<#test_poh_mixin>)
    - [`test_poh_vector`](<#test_poh_vector>)
    - [`bench_poh_sequential`](<#bench_poh_sequential>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)