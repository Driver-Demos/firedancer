<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements the Poseidon hash function for the BN254 curve, including initialization, appending data, and finalizing the hash.

# Purpose
The code implements the Poseidon cryptographic hash function, which is designed for use in zero-knowledge proofs and other cryptographic applications. It provides both internal and external interfaces for the Poseidon hash function. The internal functions include [`fd_poseidon_apply_ark`](<#fd_poseidon_apply_ark>), [`fd_poseidon_apply_sbox_full`](<#fd_poseidon_apply_sbox_full>), [`fd_poseidon_apply_sbox_partial`](<#fd_poseidon_apply_sbox_partial>), and [`fd_poseidon_apply_mds`](<#fd_poseidon_apply_mds>), which perform specific operations on the state of the hash function, such as adding round constants, applying the S-box transformation, and performing matrix multiplications. These operations are essential for the cryptographic security of the Poseidon hash function.

The external interface consists of functions like [`fd_poseidon_init`](<#fd_poseidon_init>), [`fd_poseidon_append`](<#fd_poseidon_append>), and [`fd_poseidon_fini`](<#fd_poseidon_fini>), which manage the lifecycle of a Poseidon hash computation. [`fd_poseidon_init`](<#fd_poseidon_init>) initializes the hash state, [`fd_poseidon_append`](<#fd_poseidon_append>) processes input data, and [`fd_poseidon_fini`](<#fd_poseidon_fini>) finalizes the hash computation and produces the hash output. The code also includes a mechanism to handle different endianness and validates input data to ensure it is within the expected field. The [`fd_poseidon_get_params`](<#fd_poseidon_get_params>) function retrieves the necessary parameters for the Poseidon function based on the input width, ensuring the correct application of the cryptographic transformations.
# Imports and Dependencies

---
- `./fd_poseidon.h`
- `fd_poseidon_params.c`


# Functions

---
### fd\_poseidon\_apply\_ark<!-- {{#callable:fd_poseidon_apply_ark}} -->
[View Source →](<../../../../../src/ballet/bn254/fd_poseidon.c#L6>)

Adds round constants to each element of the state array for a given round in the Poseidon hash function.
- **Inputs**:
    - `state`: An array of `fd_bn254_scalar_t` representing the current state of the Poseidon hash function.
    - `width`: An unsigned long integer representing the number of elements in the state array.
    - `params`: A pointer to a `fd_poseidon_par_t` structure containing the Poseidon parameters, including the round constants.
    - `round`: An unsigned long integer representing the current round number for which the round constants are applied.
- **Logic and Control Flow**:
    - Iterates over each element in the `state` array up to the specified `width`.
    - For each element, adds the corresponding round constant from `params->ark` to the current state element using `fd_bn254_scalar_add`.
    - The round constant is accessed using the formula `params->ark[round * width + i]`, where `i` is the current index in the loop.
- **Output**: The function does not return a value; it modifies the `state` array in place by adding the round constants.


---
### fd\_poseidon\_apply\_sbox\_full<!-- {{#callable:fd_poseidon_apply_sbox_full}} -->
[View Source →](<../../../../../src/ballet/bn254/fd_poseidon.c#L16>)

Raises each element of the `state` array to the power of 5.
- **Inputs**:
    - `state`: An array of `fd_bn254_scalar_t` elements representing the state to be transformed.
    - `width`: An unsigned long integer representing the number of elements in the `state` array.
- **Logic and Control Flow**:
    - Iterates over each element in the `state` array up to the specified `width`.
    - For each element, computes the square of the element and stores it in a temporary variable `t`.
    - Squares the temporary variable `t` again to get the fourth power of the original element.
    - Multiplies the original element by the fourth power stored in `t` to get the fifth power, updating the element in the `state` array.
- **Output**: The function modifies the `state` array in place, with each element raised to the power of 5.


---
### fd\_poseidon\_apply\_sbox\_partial<!-- {{#callable:fd_poseidon_apply_sbox_partial}} -->
[View Source →](<../../../../../src/ballet/bn254/fd_poseidon.c#L28>)

Computes the fifth power of the first element in the `state` array.
- **Inputs**:
    - `state`: An array of `fd_bn254_scalar_t` elements representing the state to be transformed.
- **Logic and Control Flow**:
    - Calls [`fd_poseidon_apply_sbox_full`](<#fd_poseidon_apply_sbox_full>) with `state` and a width of 1 to compute the fifth power of the first element in the `state` array.
- **Output**: No output is returned as the function operates directly on the input `state` array.
- **Functions Called**:
    - [`fd_poseidon_apply_sbox_full`](<#fd_poseidon_apply_sbox_full>)


---
### fd\_poseidon\_apply\_mds<!-- {{#callable:fd_poseidon_apply_mds}} -->
[View Source →](<../../../../../src/ballet/bn254/fd_poseidon.c#L34>)

Performs a vector-matrix multiplication of the `state` vector with the MDS matrix from `params` and updates the `state` vector with the result.
- **Inputs**:
    - `state`: An array of `fd_bn254_scalar_t` representing the state vector to be transformed.
    - `width`: An unsigned long integer representing the width of the state vector and MDS matrix.
    - `params`: A pointer to `fd_poseidon_par_t` containing the MDS matrix used for the transformation.
- **Logic and Control Flow**:
    - Initialize a temporary array `x` to store intermediate results, with all elements set to zero.
    - Iterate over each element `i` of the `state` vector up to `width`.
    - For each `i`, iterate over each element `j` of the `state` vector up to `width`.
    - Multiply the `j`-th element of `state` with the corresponding element of the MDS matrix from `params` and store the result in a temporary variable `t`.
    - Add the value of `t` to the `i`-th element of `x`.
    - After completing the nested loops, copy the values from `x` back to `state`.
- **Output**: The function does not return a value; it updates the `state` array in place.


---
### fd\_poseidon\_get\_params<!-- {{#callable:fd_poseidon_get_params}} -->
[View Source →](<../../../../../src/ballet/bn254/fd_poseidon.c#L52>)

Assigns the appropriate Poseidon parameters for a given width to the `params` structure.
- **Inputs**:
    - ``params``: A pointer to an `fd_poseidon_par_t` structure where the function will store the Poseidon parameters.
    - ``width``: An unsigned long integer that specifies the width for which the Poseidon parameters are needed.
- **Logic and Control Flow**:
    - Defines a macro `FD_POSEIDON_GET_PARAMS` to simplify the assignment of `ark` and `mds` parameters based on the width.
    - Uses a `switch` statement to select the appropriate case based on the `width` value.
    - For each case, assigns the `ark` and `mds` fields of the `params` structure to point to pre-defined arrays corresponding to the specified width.
    - The macro `FD_POSEIDON_GET_PARAMS` is undefined after its use to prevent any unintended reuse.
- **Output**: The function does not return a value; it modifies the `params` structure in place.


---
### fd\_poseidon\_init<!-- {{#callable:fd_poseidon_init}} -->
[View Source →](<../../../../../src/ballet/bn254/fd_poseidon.c#L79>)

Initializes a `fd_poseidon_t` structure with specified endianness and resets its state.
- **Inputs**:
    - `pos`: A pointer to a `fd_poseidon_t` structure to initialize.
    - `big_endian`: An integer indicating if the data should be treated as big-endian (non-zero) or little-endian (zero).
- **Logic and Control Flow**:
    - Check if `pos` is `NULL`; if true, return `NULL`.
    - Set the `big_endian` field of `pos` to the provided `big_endian` value.
    - Set the `cnt` field of `pos` to `0UL`.
    - Reset the `state` array of `pos` to zero using `fd_memset`.
    - Return the pointer `pos`.
- **Output**: Returns the initialized `fd_poseidon_t` pointer, or `NULL` if the input pointer `pos` is `NULL`.


---
### fd\_poseidon\_append<!-- {{#callable:fd_poseidon_append}} -->
[View Source →](<../../../../../src/ballet/bn254/fd_poseidon.c#L91>)

Appends data to a Poseidon state, handling endianness and validating the input.
- **Inputs**:
    - ``pos``: A pointer to a `fd_poseidon_t` structure representing the current Poseidon state.
    - ``data``: A pointer to an array of unsigned characters representing the data to append.
    - ``sz``: An unsigned long integer representing the size of the data to append.
- **Logic and Control Flow**:
    - Check if `pos` is `NULL` and return `NULL` if true.
    - Check if the current count in `pos` is greater than or equal to `FD_POSEIDON_MAX_WIDTH` and return `NULL` if true.
    - Check if `sz` is 0 or greater than 32 and return `NULL` if true.
    - Initialize a `fd_bn254_scalar_t` array `cur` with zero.
    - Copy `sz` bytes from `data` to `cur->buf`, adjusting for endianness if necessary.
    - If `pos->big_endian` is true, swap the byte order of `cur`.
    - Validate `cur` using `fd_bn254_scalar_validate` and return `NULL` if validation fails.
    - Increment the count in `pos`.
    - Convert `cur` to Montgomery form and store it in `pos->state` at the current count index.
    - Return the updated `pos`.
- **Output**: Returns a pointer to the updated `fd_poseidon_t` structure, or `NULL` if an error occurs.


---
### fd\_poseidon\_fini<!-- {{#callable:fd_poseidon_fini}} -->
[View Source →](<../../../../../src/ballet/bn254/fd_poseidon.c#L122>)

Finalizes the Poseidon hash computation and returns the hash value.
- **Inputs**:
    - ``pos``: A pointer to an `fd_poseidon_t` structure that holds the state of the Poseidon hash computation.
    - ``hash``: An array of unsigned characters where the computed hash will be stored. It must be `FD_UINT256_ALIGNED`.
- **Logic and Control Flow**:
    - Check if `pos` is `NULL` or if `pos->cnt` is zero; return `NULL` if either is true.
    - Calculate `width` as `pos->cnt + 1` and initialize `params` with Poseidon parameters for the given `width`.
    - Check if `params->ark` or `params->mds` is `NULL`; return `NULL` if either is true.
    - Determine the number of `partial_rounds` using the `PARTIAL_ROUNDS` array based on `pos->cnt`.
    - Set `full_rounds` to 8, calculate `half_rounds` as `full_rounds / 2`, and `all_rounds` as `full_rounds + partial_rounds`.
    - Perform `half_rounds` of full S-box transformations, followed by `partial_rounds` of partial S-box transformations, and finally `half_rounds` of full S-box transformations again, applying the Ark and MDS transformations in each round.
    - Convert the first element of `pos->state` from Montgomery form to a scalar and store it in `scalar_hash`.
    - If `pos->big_endian` is true, swap the byte order of `scalar_hash`.
    - Copy `scalar_hash` to `hash` and return `hash`.
- **Output**: Returns a pointer to the `hash` array containing the computed Poseidon hash, or `NULL` if an error occurs.
- **Functions Called**:
    - [`fd_poseidon_get_params`](<#fd_poseidon_get_params>)
    - [`fd_poseidon_apply_ark`](<#fd_poseidon_apply_ark>)
    - [`fd_poseidon_apply_sbox_full`](<#fd_poseidon_apply_sbox_full>)
    - [`fd_poseidon_apply_mds`](<#fd_poseidon_apply_mds>)
    - [`fd_poseidon_apply_sbox_partial`](<#fd_poseidon_apply_sbox_partial>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)