<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines data structures and functions for managing and publishing fragments in a distributed system.

# Purpose
The code is a C header file that defines structures and functions for managing and interacting with a data streaming context, specifically within a framework that appears to handle fragments of data, possibly in a distributed or parallel processing environment. The file defines a structure `fd_stem_context_t` that holds metadata caches, sequence numbers, and flow control information for managing data streams. It also defines another structure, `fd_stem_tile_in_t`, which represents an input tile in the data stream, including its cache, sequence number, and diagnostic accumulators.

The header file provides inline functions [`fd_stem_publish`](<#fd_stem_publish>) and [`fd_stem_advance`](<#fd_stem_advance>) to manage the publication and advancement of data fragments within the context. These functions update sequence numbers and manage flow control credits, ensuring that data fragments are processed in the correct order and that resources are efficiently utilized. The file includes necessary alignment and type definitions to ensure proper memory management and performance optimization. The header is intended to be included in other C source files that require these data streaming functionalities, and it relies on external definitions such as `fd_frag_meta_t` and functions like `fd_mcache_publish` and `fd_seq_inc` to operate.
# Imports and Dependencies

---
- `../fd_disco_base.h`


# Data Structures

---
### fd\_stem\_context
- **Type**: ``struct``
- **Members**:
    - `mcaches`: Pointer to an array of `fd_frag_meta_t` pointers, representing metadata caches.
    - `seqs`: Pointer to an array of unsigned long integers, representing sequence numbers.
    - `depths`: Pointer to an array of unsigned long integers, representing cache depths.
    - `cr_avail`: Pointer to an array of unsigned long integers, representing available credits.
    - `min_cr_avail`: Pointer to an unsigned long integer, representing the minimum available credits.
    - `cr_decrement_amount`: Unsigned long integer, representing the amount to decrement credits by.
- **Description**: Manages metadata caches, sequence numbers, and credit availability for a set of operations, providing mechanisms to publish and advance sequence numbers while managing flow control credits.


---
### fd\_stem\_context\_t
- **Type**: ``struct``
- **Members**:
    - `mcaches`: Pointer to an array of `fd_frag_meta_t` pointers, representing metadata caches.
    - `seqs`: Pointer to an array of unsigned long integers, representing sequence numbers.
    - `depths`: Pointer to an array of unsigned long integers, representing cache depths.
    - `cr_avail`: Pointer to an array of unsigned long integers, representing available credits.
    - `min_cr_avail`: Pointer to an unsigned long integer, representing the minimum available credits.
    - `cr_decrement_amount`: Unsigned long integer, representing the amount to decrement credits by.
- **Description**: Manages metadata caches, sequence numbers, and credit availability for a set of operations, providing mechanisms to publish and advance sequence numbers while managing flow control through credit availability.


---
### fd\_stem\_tile\_in
- **Type**: ``struct``
- **Members**:
    - `mcache`: Pointer to the local join of this input's metadata cache.
    - `depth`: Depth of this input's cache, equivalent to `fd_mcache_depth(mcache)`.
    - `idx`: Index of this input in the list of providers, ranging from 0 to `in_cnt`.
    - `seq`: Sequence number of the next fragment expected from the upstream producer, updated when a fragment is published.
    - `mline`: Location to poll next, calculated as `mcache + fd_mcache_line_idx(seq, depth)`.
    - `fseq`: Pointer to the local join of the flow sequence used to return flow control credits to the input.
    - `accum`: Array of six local diagnostic accumulators, drained during input housekeeping.
- **Description**: The `fd_stem_tile_in` structure is aligned to 64 bytes and is used to manage input data in a system. It includes pointers to metadata caches and flow sequences, as well as diagnostic accumulators for monitoring purposes. The structure tracks the sequence number of expected fragments and provides mechanisms for flow control and diagnostics.


---
### fd\_stem\_tile\_in\_t
- **Type**: ``struct``
- **Members**:
    - `mcache`: Local join to this input's mcache.
    - `depth`: Depth of this input's cache, equal to `fd_mcache_depth(mcache)`.
    - `idx`: Index of this input in the list of providers, ranging from 0 to `in_cnt`.
    - `seq`: Sequence number of the next fragment expected from the upstream producer, updated when a fragment from this input is published.
    - `mline`: Location to poll next, calculated as `mcache + fd_mcache_line_idx(seq, depth)`.
    - `fseq`: Local join to the fseq used to return flow control credits to the input.
    - `accum`: Local diagnostic accumulators drained during input housekeeping, assuming specific diagnostic indices.
- **Description**: Represents an input tile in a system, managing cache and sequence information for data fragments, and includes diagnostic accumulators for housekeeping.


# Functions

---
### fd\_stem\_publish<!-- {{#callable:fd_stem_publish}} -->
[View Source →](<../../../../../src/disco/stem/fd_stem.h#L34>)

Publishes a fragment to a specified output index in the stem context and updates related control variables.
- **Inputs**:
    - `stem`: A pointer to the `fd_stem_context_t` structure, which contains metadata and control variables for the stem.
    - `out_idx`: An unsigned long integer representing the output index in the stem context where the fragment will be published.
    - `sig`: An unsigned long integer representing the signature of the fragment to be published.
    - `chunk`: An unsigned long integer representing the chunk identifier of the fragment.
    - `sz`: An unsigned long integer representing the size of the fragment.
    - `ctl`: An unsigned long integer representing control information for the fragment.
    - `tsorig`: An unsigned long integer representing the original timestamp of the fragment.
    - `tspub`: An unsigned long integer representing the publication timestamp of the fragment.
- **Logic and Control Flow**:
    - Retrieve the sequence number pointer for the specified output index from the `stem` context.
    - Store the current sequence number in a local variable `seq`.
    - Call `fd_mcache_publish` with the specified parameters to publish the fragment to the memory cache associated with the output index.
    - Decrement the available credits for the specified output index by the `cr_decrement_amount` from the `stem` context.
    - Update the minimum available credits in the `stem` context to the lesser of the current minimum and the available credits for the specified output index.
    - Increment the sequence number for the specified output index by 1 using `fd_seq_inc`.
- **Output**: No return value; the function updates the state of the `fd_stem_context_t` structure and publishes a fragment.


---
### fd\_stem\_advance<!-- {{#callable:fd_stem_advance}} -->
[View Source →](<../../../../../src/disco/stem/fd_stem.h#L51>)

Advances the sequence number for a given output index and updates credit availability.
- **Inputs**:
    - `stem`: A pointer to an `fd_stem_context_t` structure that contains the context for the operation.
    - `out_idx`: An unsigned long integer representing the index of the output to advance.
- **Logic and Control Flow**:
    - Retrieve the sequence pointer for the given `out_idx` from the `seqs` array in the `stem` context.
    - Store the current sequence value in a local variable `seq`.
    - Decrease the credit available for the given `out_idx` by the `cr_decrement_amount`.
    - Update the minimum credit available by comparing the current credit available for `out_idx` with the existing minimum credit available.
    - Increment the sequence number by 1 using the `fd_seq_inc` function and update the sequence pointer.
    - Return the original sequence number before incrementing.
- **Output**: Returns the original sequence number before it was incremented.



---
Made with ❤️ by [Driver](https://www.driver.ai/)