<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Verifies cryptographic signatures of transactions, filtering out those with invalid signatures.

# Purpose
The code is a C header file that defines functionality for verifying cryptographic signatures of incoming transactions. It is part of a system that processes transaction data streams, ensuring that only transactions with valid signatures are allowed to proceed. Invalid transactions are filtered out. The file includes definitions for constants, data structures, and a function that performs the verification process.

The main components include the `fd_verify_ctx_t` structure, which holds the context for the verification process, including memory pointers, signature handling, and metrics for tracking verification failures. The [`fd_txn_verify`](<#fd_txn_verify>) function is responsible for checking the validity of transaction signatures using the Ed25519 algorithm. It also handles deduplication of transactions by using a hash-based mechanism to identify and filter out duplicate transactions. The file defines several constants for the verification results, such as `FD_TXN_VERIFY_SUCCESS`, `FD_TXN_VERIFY_FAILED`, and `FD_TXN_VERIFY_DEDUP`, which indicate the outcome of the verification process. The header file is intended to be included in other parts of the system where transaction verification is required.
# Imports and Dependencies

---
- `../topo/fd_topo.h`


# Global Variables

---
### fd\_tile\_verify
- **Type**: ``fd_topo_run_tile_t``
- **Description**: Represents a tile in the topology that is responsible for verifying cryptographic signatures of incoming transactions. It ensures that only transactions with valid signatures are processed further.
- **Use**: Used to filter out transactions with invalid signatures from the fragment stream.


# Data Structures

---
### fd\_verify\_in\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``mem``: A pointer to an `fd_wksp_t` structure, representing a memory workspace.
    - ``chunk0``: An unsigned long integer representing the starting chunk index.
    - ``wmark``: An unsigned long integer representing a watermark or threshold value.
- **Description**: `fd_verify_in_ctx_t` is a structure used as a context object for each producer memory cache connected to the verify tile. It contains a pointer to a memory workspace, a starting chunk index, and a watermark value to manage and track the state of the memory cache.


---
### fd\_verify\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``sha``: An array of pointers to `fd_sha512_t` used for cryptographic operations.
    - ``bundle_failed``: An integer indicating if the bundle verification failed.
    - ``bundle_id``: An unsigned long representing the bundle identifier.
    - ``round_robin_idx``: An unsigned long for the current index in round-robin processing.
    - ``round_robin_cnt``: An unsigned long for the count of round-robin operations.
    - ``tcache_depth``: An unsigned long indicating the depth of the transaction cache.
    - ``tcache_map_cnt``: An unsigned long for the count of entries in the transaction cache map.
    - ``tcache_sync``: A pointer to an unsigned long used for transaction cache synchronization.
    - ``tcache_ring``: A pointer to an unsigned long representing the transaction cache ring buffer.
    - ``tcache_map``: A pointer to an unsigned long for the transaction cache map.
    - ``in_kind``: An array of unsigned longs indicating the kind of input transactions.
    - ``in``: An array of `fd_verify_in_ctx_t` structures for input context management.
    - ``out_mem``: A pointer to `fd_wksp_t` for output memory workspace.
    - ``out_chunk0``: An unsigned long for the initial output chunk.
    - ``out_wmark``: An unsigned long for the watermark of the output.
    - ``out_chunk``: An unsigned long for the current output chunk.
    - ``hashmap_seed``: An unsigned long used as a seed for hash map operations.
    - ``metrics``: A structure containing counters for various failure metrics.
- **Description**: `fd_verify_ctx_t` is a structure used in the verification process of cryptographic signatures for transactions. It contains various fields for managing the state and context of the verification process, including cryptographic resources, transaction cache management, input and output contexts, and metrics for tracking verification failures. The structure supports operations such as round-robin processing, transaction deduplication, and signature verification.


# Functions

---
### fd\_txn\_verify<!-- {{#callable:fd_txn_verify}} -->
[View Source →](<../../../../../src/disco/verify/fd_verify_tile.h#L59>)

Verifies the cryptographic signatures of a transaction and checks for duplicate transactions using a deduplication mechanism.
- **Inputs**:
    - `ctx`: A pointer to `fd_verify_ctx_t`, which contains context information for the verification process, including hash map and tcache details.
    - `udp_payload`: A pointer to the UDP payload containing the transaction data.
    - `payload_sz`: The size of the UDP payload in bytes.
    - `txn`: A pointer to `fd_txn_t`, which contains metadata about the transaction, such as signature count and offsets.
    - `dedup`: An integer flag indicating whether deduplication should be performed (non-zero value) or not (zero value).
    - `opt_sig`: A pointer to an `ulong` where the function will store the deduplication tag if deduplication is enabled.
- **Logic and Control Flow**:
    - Extracts signature count, signature offset, account address offset, and message offset from the `txn` structure.
    - Calculates pointers to the signatures, public keys, and message within the `udp_payload` using the extracted offsets.
    - Calculates the message size by subtracting the message offset from the payload size.
    - Computes a deduplication tag using the first signature and the hash map seed from the context.
    - If deduplication is enabled, checks if the deduplication tag is already present in the tcache map; if so, returns `FD_TXN_VERIFY_DEDUP`.
    - Verifies the signatures using `fd_ed25519_verify_batch_single_msg` with the message, signatures, public keys, and SHA context; if verification fails, returns `FD_TXN_VERIFY_FAILED`.
    - If deduplication is enabled, inserts the deduplication tag into the tcache; if the tag is already present, returns `FD_TXN_VERIFY_DEDUP`.
    - Stores the deduplication tag in `opt_sig` and returns `FD_TXN_VERIFY_SUCCESS`.
- **Output**: Returns `FD_TXN_VERIFY_SUCCESS` if the transaction is verified successfully, `FD_TXN_VERIFY_FAILED` if signature verification fails, or `FD_TXN_VERIFY_DEDUP` if the transaction is a duplicate.



---
Made with ❤️ by [Driver](https://www.driver.ai/)