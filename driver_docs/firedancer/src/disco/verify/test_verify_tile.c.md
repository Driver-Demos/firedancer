<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for the verify tile using mock inputs and custom memory allocation for sanitization checks.

# Purpose
The `test_verify_tile.c` file is a test suite designed to validate the functionality of a verification tile within a larger system. It uses mock inputs to simulate various scenarios and tests the behavior of the verification tile. The file includes the `fd_verify_tile.c` module, which contains the core verification logic, and it uses standard C library functions for memory allocation to ensure accurate memory sanitization checks. The test suite is structured to evaluate different aspects of the verification tile, such as security compliance through [`test_seccomp`](<#test_seccomp>), memory allocation and deallocation with [`test_malloc`](<#test_malloc>) and [`test_free_all`](<#test_free_all>), and load balancing behavior with [`test_load_balance`](<#test_load_balance>).

The code defines several static functions to create mock topologies and links, which are used to simulate the environment in which the verification tile operates. The [`mock_topo_create`](<#mock_topo_create>) function sets up a mock topology with various links, and the [`test_load_balance`](<#test_load_balance>) function tests the tile's ability to handle and distribute incoming traffic. The main function initializes the test environment, runs the tests, and logs the results. The file is intended to be executed as a standalone program to verify the correct operation of the verification tile in different scenarios, ensuring that it meets the expected performance and security requirements.
# Imports and Dependencies

---
- `fd_verify_tile.c`
- `../topo/fd_topob.h`
- `../quic/fd_tpu.h`
- `stdlib.h`
- `unistd.h`


# Global Variables

---
### test\_allocs
- **Type**: `void *`
- **Description**: An array of pointers to void, with a maximum size defined by `TEST_ALLOC_MAX`. It stores pointers to memory blocks allocated during the test process.
- **Use**: Used to keep track of memory allocations made by the `test_malloc` function, allowing for their subsequent deallocation by `test_free_all`.


---
### test\_alloc\_cnt
- **Type**: ``ulong``
- **Description**: Counts the number of memory allocations made by the `test_malloc` function. It is a static variable, meaning it is limited to the file scope and retains its value between function calls.
- **Use**: Tracks the number of allocations to ensure they do not exceed `TEST_ALLOC_MAX`.


# Functions

---
### test\_seccomp<!-- {{#callable:test_seccomp}} -->
[View Source →](<../../../../../src/disco/verify/test_verify_tile.c#L14>)

Tests the file descriptor and seccomp filter setup for a process.
- **Inputs**: None
- **Logic and Control Flow**:
    - Declare an integer array `out_fds` with two elements to store file descriptors.
    - Call [`populate_allowed_fds`](<fd_verify_tile.c.md#populate_allowed_fds>) with `NULL` arguments and a size of 2 to populate `out_fds` and store the number of file descriptors in `nfds`.
    - Verify that `nfds` is between 1 and 2 using `FD_TEST`.
    - Check that the first file descriptor in `out_fds` is equal to `STDERR_FILENO` using `FD_TEST`.
    - If `nfds` is 2, verify that the second file descriptor in `out_fds` is equal to the result of `fd_log_private_logfile_fd()` using `FD_TEST`.
    - Declare a `sock_filter` array `filter` with 32 elements.
    - Call [`populate_allowed_seccomp`](<fd_verify_tile.c.md#populate_allowed_seccomp>) with `NULL` arguments and a size of 32 to populate `filter`.
- **Output**: No output is returned as the function is of type `void`.
- **Functions Called**:
    - [`populate_allowed_fds`](<fd_verify_tile.c.md#populate_allowed_fds>)
    - [`populate_allowed_seccomp`](<fd_verify_tile.c.md#populate_allowed_seccomp>)


---
### test\_malloc<!-- {{#callable:test_malloc}} -->
[View Source →](<../../../../../src/disco/verify/test_verify_tile.c#L30>)

Allocates aligned memory and tracks allocations for testing purposes.
- **Inputs**:
    - `align`: The alignment requirement for the memory allocation.
    - `sz`: The size of the memory block to allocate.
- **Logic and Control Flow**:
    - Checks if the current allocation count is less than `TEST_ALLOC_MAX` using `FD_TEST` macro.
    - Calls `aligned_alloc` to allocate memory with the specified alignment and size.
    - Verifies the allocation was successful using `FD_TEST` macro.
    - Stores the pointer to the allocated memory in the `test_allocs` array at the current allocation count index.
    - Increments the `test_alloc_cnt` to track the number of allocations.
    - Returns the pointer to the allocated memory.
- **Output**: A pointer to the allocated memory block.


---
### test\_free\_all<!-- {{#callable:test_free_all}} -->
[View Source →](<../../../../../src/disco/verify/test_verify_tile.c#L40>)

Frees all allocated memory stored in the `test_allocs` array.
- **Inputs**: None
- **Logic and Control Flow**:
    - While `test_alloc_cnt` is greater than zero, decrement `test_alloc_cnt` and free the memory at the current index of `test_allocs`.
- **Output**: No output; the function performs memory deallocation.


---
### mock\_link\_create<!-- {{#callable:mock_link_create}} -->
[View Source →](<../../../../../src/disco/verify/test_verify_tile.c#L45>)

Creates a mock link in a topology with specified memory cache and data cache configurations.
- **Inputs**:
    - ``topo``: A pointer to an `fd_topo_t` structure representing the topology where the link will be created.
    - ``name``: A constant character pointer representing the name of the link to be created.
- **Logic and Control Flow**:
    - Defines a constant `LINK_DEPTH` with a value of 16.
    - Calls `fd_topob_link` to create a link in the topology with the specified name and `LINK_DEPTH`.
    - Calculates the data size required for the data cache using `fd_dcache_req_data_sz` with parameters `FD_TPU_REASM_MTU`, `LINK_DEPTH`, and others.
    - Allocates memory for the memory cache using [`test_malloc`](<#test_malloc>) and initializes it with `fd_mcache_new`, then joins it to the link using `fd_mcache_join`.
    - Allocates memory for the data cache using [`test_malloc`](<#test_malloc>) and initializes it with `fd_dcache_new`, then joins it to the link using `fd_dcache_join`.
- **Output**: No return value; the function modifies the `topo` structure by adding a new link with configured caches.
- **Functions Called**:
    - [`test_malloc`](<#test_malloc>)


---
### mock\_topo\_create<!-- {{#callable:mock_topo_create}} -->
[View Source →](<../../../../../src/disco/verify/test_verify_tile.c#L55>)

Creates and initializes a mock topology for testing purposes.
- **Inputs**: None
- **Logic and Control Flow**:
    - Allocate memory for a new `fd_topo_t` structure using [`test_malloc`](<#test_malloc>) and initialize it with `fd_topob_new`.
    - Create a workspace `wksp` within the topology and set its `wksp` pointer to `NULL`.
    - Create a tile `verify` within the topology, set its `tcache_depth` to `TCACHE_DEPTH`, and allocate memory for its context using [`test_malloc`](<#test_malloc>).
    - Store the context's memory offset in the topology's object array at the index corresponding to the tile's object ID.
    - Create four mock links named `quic_verify`, `bundle_verif`, `gossip_out`, and `send_txns` using [`mock_link_create`](<#mock_link_create>).
    - Declare link inputs for the `verify` tile in a specific order to prevent index confusion, using `fd_topob_tile_in`.
    - Return the initialized topology.
- **Output**: A pointer to the newly created and initialized `fd_topo_t` structure.
- **Functions Called**:
    - [`test_malloc`](<#test_malloc>)
    - [`scratch_align`](<fd_verify_tile.c.md#scratch_align>)
    - [`scratch_footprint`](<fd_verify_tile.c.md#scratch_footprint>)
    - [`mock_link_create`](<#mock_link_create>)


---
### test\_load\_balance<!-- {{#callable:test_load_balance}} -->
[View Source →](<../../../../../src/disco/verify/test_verify_tile.c#L87>)

Tests the load balancing behavior of a tile in a network topology by simulating traffic and verifying expected outcomes.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls [`test_free_all`](<#test_free_all>) to release any previously allocated resources.
    - Creates a mock topology using [`mock_topo_create`](<#mock_topo_create>).
    - Finds and initializes the 'verify' tile in the topology.
    - Initializes the tile with [`privileged_init`](<fd_verify_tile.c.md#privileged_init>) and [`unprivileged_init`](<fd_verify_tile.c.md#unprivileged_init>).
    - Retrieves the verification context for the tile using `fd_topo_obj_laddr`.
    - Sets `round_robin_idx` to 0 and `round_robin_cnt` to 1, then tests that the tile accepts all traffic types using `FD_TEST` and [`before_frag`](<fd_verify_tile.c.md#before_frag>).
    - Sets `round_robin_cnt` to 4 and tests that the tile accepts all bundle traffic.
    - Tests load balancing behavior by checking that the tile accepts some traffic and rejects others based on the round-robin index.
- **Output**: No direct output; the function uses assertions (`FD_TEST`) to verify expected behavior.
- **Functions Called**:
    - [`test_free_all`](<#test_free_all>)
    - [`mock_topo_create`](<#mock_topo_create>)
    - [`privileged_init`](<fd_verify_tile.c.md#privileged_init>)
    - [`unprivileged_init`](<fd_verify_tile.c.md#unprivileged_init>)
    - [`before_frag`](<fd_verify_tile.c.md#before_frag>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/disco/verify/test_verify_tile.c#L121>)

Initializes the environment, runs a series of tests, logs a success message, and then halts the program.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of strings representing the command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Executes [`test_seccomp`](<#test_seccomp>) to perform security compliance tests.
    - Executes [`test_load_balance`](<#test_load_balance>) to test load balancing functionality.
    - Executes [`test_free_all`](<#test_free_all>) to free all allocated memory.
    - Logs a notice message indicating the tests passed using `FD_LOG_NOTICE`.
    - Calls `fd_halt` to halt the program.
    - Returns 0 to indicate successful execution.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`test_seccomp`](<#test_seccomp>)
    - [`test_load_balance`](<#test_load_balance>)
    - [`test_free_all`](<#test_free_all>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)