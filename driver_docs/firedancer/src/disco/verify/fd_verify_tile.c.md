<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a verification tile for processing and verifying transactions, including handling different input kinds and managing metrics.

# Purpose
The code is a C source file that implements a verification module for processing and verifying transactions in a networked system. It is part of a larger framework, as indicated by the inclusion of multiple header files and the use of specific data structures and functions. The module defines several constants and functions that handle different types of input data, such as QUIC, bundles, gossip, and send transactions. The primary purpose of the module is to verify transactions, manage metrics related to transaction processing, and handle the initialization and execution of verification tasks.

Key components of the code include functions for aligning and calculating memory footprints ([`scratch_align`](<#scratch_align>), [`scratch_footprint`](<#scratch_footprint>)), writing metrics ([`metrics_write`](<#metrics_write>)), and processing transaction fragments ([`before_frag`](<#before_frag>), [`during_frag`](<#during_frag>), [`after_frag`](<#after_frag>)). The module also includes initialization functions ([`privileged_init`](<#privileged_init>), [`unprivileged_init`](<#unprivileged_init>)) that set up the necessary context and resources for transaction verification. The code uses a round-robin mechanism to distribute transaction processing across multiple verification tiles and includes error handling for various transaction verification failures. The module is designed to be integrated into a larger system, as indicated by the use of external interfaces and the inclusion of a `fd_topo_run_tile_t` structure that defines the module's entry points and configuration.
# Imports and Dependencies

---
- `fd_verify_tile.h`
- `../fd_txn_m.h`
- `../metrics/fd_metrics.h`
- `generated/fd_verify_tile_seccomp.h`
- `../../flamenco/gossip/fd_gossip_types.h`
- `../stem/fd_stem.c`


# Global Variables

---
### fd\_tile\_verify
- **Type**: ``fd_topo_run_tile_t``
- **Description**: Defines a tile configuration for the 'verify' process in a topology. It includes function pointers for initialization, security policy population, and execution.
- **Use**: Used to configure and manage the execution of a verification tile in a distributed system.


# Functions

---
### scratch\_align<!-- {{#callable:scratch_align}} -->
[View Source →](<../../../../../src/disco/verify/fd_verify_tile.c#L12>)

Returns the alignment value for scratch memory allocation.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the constant `FD_TCACHE_ALIGN`.
- **Output**: The function returns an `ulong` representing the alignment value for scratch memory.


---
### scratch\_footprint<!-- {{#callable:scratch_footprint}} -->
[View Source →](<../../../../../src/disco/verify/fd_verify_tile.c#L17>)

Calculates the memory footprint required for a scratch space based on the given tile's configuration.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure that contains configuration details for the tile, including `verify.tcache_depth`.
- **Logic and Control Flow**:
    - Initialize `l` with `FD_LAYOUT_INIT` to start the layout calculation.
    - Append the alignment and size of `fd_verify_ctx_t` to `l` using `FD_LAYOUT_APPEND`.
    - Append the alignment and footprint of the transaction cache (`tcache`) to `l` using `FD_LAYOUT_APPEND`, with parameters from `tile->verify.tcache_depth`.
    - Iterate over `FD_TXN_ACTUAL_SIG_MAX` to append the alignment and footprint of `fd_sha512_t` to `l` for each iteration using `FD_LAYOUT_APPEND`.
    - Finalize the layout calculation with `FD_LAYOUT_FINI`, using `scratch_align()` to determine the final alignment.
- **Output**: Returns an `ulong` representing the total memory footprint required for the scratch space.
- **Functions Called**:
    - [`scratch_align`](<#scratch_align>)


---
### metrics\_write<!-- {{#callable:metrics_write}} -->
[View Source →](<../../../../../src/disco/verify/fd_verify_tile.c#L28>)

Updates the metrics counters in the `fd_verify_ctx_t` context for various transaction failure types.
- **Inputs**:
    - `ctx`: A pointer to an `fd_verify_ctx_t` structure that contains the metrics to update.
- **Logic and Control Flow**:
    - Set the `TRANSACTION_BUNDLE_PEER_FAILURE` metric using `ctx->metrics.bundle_peer_fail_cnt`.
    - Set the `TRANSACTION_PARSE_FAILURE` metric using `ctx->metrics.parse_fail_cnt`.
    - Set the `TRANSACTION_DEDUP_FAILURE` metric using `ctx->metrics.dedup_fail_cnt`.
    - Set the `TRANSACTION_VERIFY_FAILURE` metric using `ctx->metrics.verify_fail_cnt`.
- **Output**: No return value; the function updates the metrics in the provided context.


---
### before\_frag<!-- {{#callable:before_frag}} -->
[View Source →](<../../../../../src/disco/verify/fd_verify_tile.c#L36>)

Determines if a fragment should be processed based on its type and sequence information.
- **Inputs**:
    - `ctx`: A pointer to the `fd_verify_ctx_t` structure containing context information for verification.
    - `in_idx`: An index indicating the input source type within the `ctx->in_kind` array.
    - `seq`: The sequence number of the fragment.
    - `sig`: The signature or tag associated with the fragment, used to determine its type.
- **Logic and Control Flow**:
    - Check if the fragment is a bundle packet by evaluating if `ctx->in_kind[in_idx]` is `IN_KIND_BUNDLE` and `sig` is zero.
    - If the fragment is a bundle packet or of type `IN_KIND_QUIC`, return true if the sequence number modulo `ctx->round_robin_cnt` is not equal to `ctx->round_robin_idx`.
    - If the fragment is of type `IN_KIND_BUNDLE`, return true if `ctx->round_robin_idx` is not zero.
    - If the fragment is of type `IN_KIND_GOSSIP`, return true if the sequence number modulo `ctx->round_robin_cnt` is not equal to `ctx->round_robin_idx` or if `sig` is not `FD_GOSSIP_UPDATE_TAG_VOTE`.
    - Return false if none of the above conditions are met.
- **Output**: Returns an integer indicating whether the fragment should be processed (non-zero) or not (zero).


---
### during\_frag<!-- {{#callable:during_frag}} -->
[View Source →](<../../../../../src/disco/verify/fd_verify_tile.c#L63>)

Processes incoming data fragments based on their type and performs memory operations and error checks.
- **Inputs**:
    - `ctx`: A pointer to the `fd_verify_ctx_t` context structure containing input and output memory and metadata.
    - `in_idx`: An index indicating which input source to process from the `ctx->in_kind` array.
    - `seq`: A sequence number, marked as unused in this function.
    - `sig`: A signature, marked as unused in this function.
    - `chunk`: The chunk index within the input memory to process.
    - `sz`: The size of the data to process.
    - `ctl`: A control parameter, marked as unused in this function.
- **Logic and Control Flow**:
    - Retrieve the input kind from `ctx->in_kind` using `in_idx`.
    - If the input kind is `IN_KIND_BUNDLE`, `IN_KIND_QUIC`, or `IN_KIND_SEND`, check if `chunk` is within the valid range and `sz` does not exceed `FD_TPU_RAW_MTU`.
    - Log an error if the chunk is out of range or size is too large.
    - Copy data from the source chunk to the destination chunk using `fd_memcpy`.
    - Check if the transaction payload size exceeds `FD_TPU_MTU` and log an error if it does.
    - If the input kind is `IN_KIND_GOSSIP`, check if `chunk` is within the valid range and `sz` does not exceed 2048 bytes.
    - Log an error if the chunk is out of range or size is too large.
    - Copy the transaction data from the gossip message to the destination transaction structure.
- **Output**: No return value; performs operations and logs errors as needed.


---
### after\_frag<!-- {{#callable:after_frag}} -->
[View Source →](<../../../../../src/disco/verify/fd_verify_tile.c#L99>)

Processes a transaction fragment, verifies it, and updates the context and metrics based on the verification result.
- **Inputs**:
    - `ctx`: A pointer to the `fd_verify_ctx_t` structure that holds the verification context and metrics.
    - `in_idx`: An unsigned long integer representing the input index, which is not used in the function.
    - `seq`: An unsigned long integer representing the sequence number, which is not used in the function.
    - `sig`: An unsigned long integer representing the signature, which is not used in the function.
    - `sz`: An unsigned long integer representing the size, which is not used in the function.
    - `tsorig`: An unsigned long integer representing the original timestamp of the transaction.
    - `_tspub`: An unsigned long integer representing the publication timestamp, which is not used in the function.
    - `stem`: A pointer to the `fd_stem_context_t` structure used for publishing the transaction.
- **Logic and Control Flow**:
    - Convert the output memory chunk to a local address and parse the transaction payload to determine its size.
    - Check if the transaction is part of a bundle and update the context's bundle ID if it is a new bundle.
    - If the bundle has previously failed, increment the bundle peer failure count and return.
    - If the transaction size is zero, mark the bundle as failed if applicable, increment the parse failure count, and return.
    - Verify the transaction, exempting bundles from normal deduplication checks, and handle verification results by updating the appropriate failure counts and returning if verification fails.
    - Calculate the realized size of the transaction, compute the publication timestamp, and publish the transaction using `fd_stem_publish`.
    - Update the output chunk to the next compacted position.
- **Output**: No direct output is returned, but the function updates the verification context and metrics, and publishes the transaction if verification is successful.
- **Functions Called**:
    - [`fd_txn_verify`](<fd_verify_tile.h.md#fd_txn_verify>)


---
### privileged\_init<!-- {{#callable:privileged_init}} -->
[View Source →](<../../../../../src/disco/verify/fd_verify_tile.c#L159>)

Initializes a privileged context for a tile by allocating scratch memory and setting a secure random seed for the context's hashmap.
- **Inputs**:
    - `topo`: A pointer to an `fd_topo_t` structure representing the topology configuration.
    - `tile`: A pointer to an `fd_topo_tile_t` structure representing the tile configuration.
- **Logic and Control Flow**:
    - Call `fd_topo_obj_laddr` to get the local address of the tile object using `topo` and `tile->tile_obj_id`.
    - Initialize scratch memory allocation with `FD_SCRATCH_ALLOC_INIT` using the obtained scratch address.
    - Allocate memory for `fd_verify_ctx_t` within the scratch space using `FD_SCRATCH_ALLOC_APPEND`.
    - Generate a secure random seed for `ctx->hashmap_seed` using `fd_rng_secure`.
- **Output**: No return value; the function initializes the context in the provided scratch memory.


---
### unprivileged\_init<!-- {{#callable:unprivileged_init}} -->
[View Source →](<../../../../../src/disco/verify/fd_verify_tile.c#L169>)

Initializes an unprivileged context for a tile in a topology, setting up memory allocations, caches, and input/output configurations.
- **Inputs**:
    - `topo`: A pointer to a `fd_topo_t` structure representing the topology.
    - `tile`: A pointer to a `fd_topo_tile_t` structure representing the tile to initialize.
- **Logic and Control Flow**:
    - Allocate scratch memory using `fd_topo_obj_laddr` for the tile's object ID.
    - Initialize a scratch allocator with `FD_SCRATCH_ALLOC_INIT`.
    - Allocate and append a `fd_verify_ctx_t` context structure to the scratch memory.
    - Create and join a transaction cache (`fd_tcache_t`) with `fd_tcache_new` and `fd_tcache_join`.
    - Set up round-robin counters using `fd_topo_tile_name_cnt` and `tile->kind_id`.
    - For each signature index up to `FD_TXN_ACTUAL_SIG_MAX`, allocate and join a SHA-512 context (`fd_sha512_t`).
    - Initialize context fields such as `bundle_failed`, `bundle_id`, and `metrics`.
    - Configure transaction cache parameters like depth, map count, sync, ring, and map addresses.
    - For each input link, configure memory, chunk, watermark, and kind based on link names.
    - Set up output memory, chunk, and watermark using the first output link.
    - Finalize the scratch allocation and check for overflow with `FD_SCRATCH_ALLOC_FINI`.
- **Output**: No return value; the function initializes the context and modifies the input structures.
- **Functions Called**:
    - [`scratch_footprint`](<#scratch_footprint>)


---
### populate\_allowed\_seccomp<!-- {{#callable:populate_allowed_seccomp}} -->
[View Source →](<../../../../../src/disco/verify/fd_verify_tile.c#L224>)

Populates a `sock_filter` array with a security policy for a tile and returns the instruction count.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, which is not used in this function.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure, which is not used in this function.
    - ``out_cnt``: An unsigned long integer representing the number of elements in the `out` array.
    - ``out``: A pointer to an array of `sock_filter` structures where the security policy will be populated.
- **Logic and Control Flow**:
    - Ignores the `topo` and `tile` inputs as they are not used in the function.
    - Calls [`populate_sock_filter_policy_fd_verify_tile`](<generated/fd_verify_tile_seccomp.h.md#populate_sock_filter_policy_fd_verify_tile>) with `out_cnt`, `out`, and the file descriptor from `fd_log_private_logfile_fd()`.
    - Returns the value of `sock_filter_policy_fd_verify_tile_instr_cnt`.
- **Output**: Returns an unsigned long integer representing the number of instructions in the security policy.
- **Functions Called**:
    - [`populate_sock_filter_policy_fd_verify_tile`](<generated/fd_verify_tile_seccomp.h.md#populate_sock_filter_policy_fd_verify_tile>)


---
### populate\_allowed\_fds<!-- {{#callable:populate_allowed_fds}} -->
[View Source →](<../../../../../src/disco/verify/fd_verify_tile.c#L236>)

Populates an array with file descriptors for `stderr` and a log file, if available.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, which is not used in this function.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure, which is not used in this function.
    - ``out_fds_cnt``: The maximum number of file descriptors that can be stored in the `out_fds` array.
    - ``out_fds``: An array where the function will store the allowed file descriptors.
- **Logic and Control Flow**:
    - Ignores the `topo` and `tile` inputs as they are not used in the function.
    - Checks if `out_fds_cnt` is less than 2; if so, logs an error and terminates.
    - Initializes `out_cnt` to 0 and assigns the file descriptor for `stderr` (2) to `out_fds[0]`.
    - Checks if the log file descriptor is valid (not -1); if valid, assigns it to `out_fds[1]` and increments `out_cnt`.
- **Output**: Returns the number of file descriptors added to the `out_fds` array.



---
Made with ❤️ by [Driver](https://www.driver.ai/)