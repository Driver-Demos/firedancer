<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for transaction verification functions, including scenarios with valid and invalid signatures.

# Purpose
The code is a C test suite designed to verify the functionality of a transaction verification system. It includes several static arrays of hexadecimal strings representing different types of transactions, both valid and invalid. These transactions are used to test the verification logic implemented in the functions. The main components of the code include functions for loading test transactions, setting up and freeing verification contexts, and executing various test cases to ensure the transaction verification system behaves as expected. The test cases cover scenarios such as verifying transactions with valid and invalid signatures, handling deduplication of transactions, and testing for potential signature collisions.

The code imports several headers, including `fd_verify_tile.h` and `fd_hex.h`, which likely provide necessary functions and data structures for transaction verification and hexadecimal decoding. The [`load_test_txn`](<#load_test_txn>) function converts hexadecimal transaction data into a format suitable for processing. The [`setup_verify_ctx`](<#setup_verify_ctx>) and [`free_verify_ctx`](<#free_verify_ctx>) functions manage the memory and context required for verification. The test functions, such as [`test_verify_success`](<#test_verify_success>) and [`test_verify_invalid_sigs_success`](<#test_verify_invalid_sigs_success>), execute specific verification scenarios and use assertions to check the outcomes. The [`main`](<#main>) function initializes the test environment, runs the test cases, and logs the results. This code is intended to be compiled and executed as a standalone program to validate the transaction verification logic.
# Imports and Dependencies

---
- `fd_verify_tile.h`
- `../../ballet/hex/fd_hex.h`
- `stdlib.h`


# Global Variables

---
### valid\_txn\_1sig
- **Type**: `char *`
- **Description**: Contains a list of hexadecimal strings that represent a valid transaction with a single signature.
- **Use**: Used to load and verify a valid transaction with one signature in the test functions.


---
### invalid\_txn\_same\_1sig
- **Type**: `char *[]`
- **Description**: An array of strings that represents an invalid transaction with a single signature. The transaction data includes a series of hexadecimal strings, where all account fields are zeroed, making the signature invalid.
- **Use**: Used to test the verification of transactions with invalid signatures in the context of deduplication and signature validation.


---
### invalid\_txn\_1sig\_same\_64bit
- **Type**: ``char *` array`
- **Description**: Contains a series of hexadecimal strings that represent an invalid transaction with a single signature. The transaction data includes various fields such as transaction ID, signature, and other related data.
- **Use**: Used to test transaction verification processes by providing an example of an invalid transaction with a specific signature pattern.


---
### valid\_txn\_2sigs
- **Type**: ``char *` array`
- **Description**: Contains a list of hexadecimal strings that represent a valid transaction with two signatures. Each string in the array corresponds to a part of the transaction data, such as signatures, public keys, or other transaction-related information.
- **Use**: Used to load and verify a transaction with two signatures in the `test_verify_success` function.


---
### invalid\_txn\_2sigs
- **Type**: `char *[]`
- **Description**: An array of strings that represents an invalid transaction with two signatures. The second signature in the array is invalid, as indicated by a sequence of zeros followed by a sequence of 'f' characters.
- **Use**: Used to test the verification of transactions with invalid signatures.


# Functions

---
### load\_test\_txn<!-- {{#callable:load_test_txn}} -->
[View Source →](<../../../../../src/disco/verify/test_verify.c#L108>)

Converts an array of hexadecimal strings into a byte array and calculates the transaction length.
- **Inputs**:
    - `hex`: An array of strings, each representing a hexadecimal value.
    - `hex_sz`: The size of the `hex` array in bytes.
    - `tx_len`: A pointer to an unsigned long where the function will store the length of the transaction in bytes.
- **Logic and Control Flow**:
    - Initialize `hex_len` to 0 to store the total length of all hexadecimal strings.
    - Iterate over each string in the `hex` array, calculate its length using `strlen`, and accumulate the total length in `hex_len`.
    - Divide `hex_len` by 2 to get the transaction length in bytes and store it in `tx_len`.
    - Allocate memory for the transaction byte array `tx` with a size of `hex_len / 2`.
    - Reset `hex_len` to 0 and iterate over each string in the `hex` array again.
    - For each string, calculate its length, decode the hexadecimal string into bytes using `fd_hex_decode`, and store the result in the `tx` array.
    - Return the pointer to the `tx` byte array.
- **Output**: A pointer to a dynamically allocated byte array containing the decoded transaction data.


---
### setup\_verify\_ctx<!-- {{#callable:setup_verify_ctx}} -->
[View Source →](<../../../../../src/disco/verify/test_verify.c#L127>)

Initializes a verification context by setting up a transaction cache and SHA-512 contexts for signature verification.
- **Inputs**:
    - `ctx`: A pointer to an `fd_verify_ctx_t` structure that will be initialized.
    - `mem`: A pointer to a memory location where the function will store the allocated memory for the transaction cache.
- **Logic and Control Flow**:
    - Set the memory of `ctx` to zero using `fd_memset`.
    - Define `depth`, `map_cnt`, `align`, and calculate `footprint` for the transaction cache.
    - Check if `footprint` is valid; if not, log an error.
    - Allocate aligned memory for the transaction cache and check if allocation is successful.
    - Create and join a new transaction cache using `fd_tcache_new` and `fd_tcache_join`; log an error if joining fails.
    - Initialize `ctx` fields with transaction cache properties using `fd_tcache_*` functions.
    - Reset the transaction cache using `fd_tcache_reset`.
    - Allocate aligned memory for SHA-512 contexts and initialize each context using `fd_sha512_new` and `fd_sha512_join`; log an error if joining fails.
- **Output**: No return value; the function initializes the `ctx` structure and allocates memory for the transaction cache and SHA-512 contexts.


---
### free\_verify\_ctx<!-- {{#callable:free_verify_ctx}} -->
[View Source →](<../../../../../src/disco/verify/test_verify.c#L155>)

Releases memory allocated for a verification context and its associated SHA resources.
- **Inputs**:
    - `ctx`: A pointer to the `fd_verify_ctx_t` structure that holds the verification context to be freed.
    - `mem`: A pointer to the memory block that was allocated for the verification context.
- **Logic and Control Flow**:
    - Call `free` on the `mem` pointer to release the memory allocated for the verification context.
    - Call `free` on the first element of the `ctx->sha` array to release the memory allocated for SHA resources, as all SHA resources were allocated in a single block.
- **Output**: No return value.


---
### test\_verify\_success<!-- {{#callable:test_verify_success}} -->
[View Source →](<../../../../../src/disco/verify/test_verify.c#L161>)

Tests the verification of transactions with valid signatures and checks for deduplication.
- **Inputs**:
    - `ctx`: A pointer to an array of `fd_verify_ctx_t` structures used for verification context.
    - `mem`: A pointer to memory allocated for the verification context.
    - `out_buf`: A buffer to store the parsed transaction data.
    - `txn`: A pointer to a `fd_txn_t` structure representing the transaction.
    - `opt_sig`: An unsigned long used to store optional signature information.
    - `payload`: A pointer to the transaction payload data.
    - `payload_sz`: An unsigned long representing the size of the transaction payload.
    - `res`: An integer to store the result of the transaction verification.
- **Logic and Control Flow**:
    - Logs the start of the test with `FD_LOG_NOTICE`.
    - Initializes the verification context by calling [`setup_verify_ctx`](<#setup_verify_ctx>).
    - Loads a valid transaction with two signatures using [`load_test_txn`](<#load_test_txn>) and parses it with `fd_txn_parse`.
    - Verifies the transaction with [`fd_txn_verify`](<fd_verify_tile.h.md#fd_txn_verify>) and checks if the result is `FD_TXN_VERIFY_SUCCESS`.
    - Verifies the same transaction again to check for deduplication, expecting `FD_TXN_VERIFY_DEDUP`.
    - Repeats the deduplication check twice more.
    - Verifies the transaction with deduplication disabled, expecting `FD_TXN_VERIFY_SUCCESS`.
    - Frees the payload memory and loads a valid transaction with one signature.
    - Parses and verifies the transaction, expecting `FD_TXN_VERIFY_SUCCESS`.
    - Checks for deduplication twice, expecting `FD_TXN_VERIFY_DEDUP`.
    - Frees the payload memory and releases the verification context with [`free_verify_ctx`](<#free_verify_ctx>).
- **Output**: No direct output; the function performs tests and logs results.
- **Functions Called**:
    - [`setup_verify_ctx`](<#setup_verify_ctx>)
    - [`load_test_txn`](<#load_test_txn>)
    - [`fd_txn_verify`](<fd_verify_tile.h.md#fd_txn_verify>)
    - [`free_verify_ctx`](<#free_verify_ctx>)


---
### test\_verify\_invalid\_sigs\_success<!-- {{#callable:test_verify_invalid_sigs_success}} -->
[View Source →](<../../../../../src/disco/verify/test_verify.c#L210>)

Tests the verification of transactions with invalid signatures to ensure they fail as expected.
- **Inputs**: None
- **Logic and Control Flow**:
    - Logs the start of the test with `FD_LOG_NOTICE`.
    - Initializes the verification context using [`setup_verify_ctx`](<#setup_verify_ctx>).
    - Loads an invalid transaction with two signatures using [`load_test_txn`](<#load_test_txn>).
    - Parses the transaction payload with `fd_txn_parse`.
    - Verifies the transaction using [`fd_txn_verify`](<fd_verify_tile.h.md#fd_txn_verify>) and checks that the result is `FD_TXN_VERIFY_FAILED`.
    - Repeats the verification to confirm that failed transactions are not deduplicated, expecting the same failure result.
    - Frees the allocated payload memory and verification context.
- **Output**: No output is returned; the function uses assertions to validate behavior.
- **Functions Called**:
    - [`setup_verify_ctx`](<#setup_verify_ctx>)
    - [`load_test_txn`](<#load_test_txn>)
    - [`fd_txn_verify`](<fd_verify_tile.h.md#fd_txn_verify>)
    - [`free_verify_ctx`](<#free_verify_ctx>)


---
### test\_verify\_invalid\_dedup\_success<!-- {{#callable:test_verify_invalid_dedup_success}} -->
[View Source →](<../../../../../src/disco/verify/test_verify.c#L239>)

Tests the verification and deduplication of transactions with invalid signatures against valid ones.
- **Inputs**: None
- **Logic and Control Flow**:
    - Logs the start of the test with `FD_LOG_NOTICE`.
    - Initializes the verification context using [`setup_verify_ctx`](<#setup_verify_ctx>).
    - Loads an invalid transaction with the same signature as a valid one using [`load_test_txn`](<#load_test_txn>) and parses it with `fd_txn_parse`.
    - Verifies the invalid transaction with [`fd_txn_verify`](<fd_verify_tile.h.md#fd_txn_verify>) and checks that the result is `FD_TXN_VERIFY_FAILED`.
    - Frees the payload and loads a valid transaction with one signature, parses it, and verifies it, expecting `FD_TXN_VERIFY_SUCCESS`.
    - Resets the transaction cache with `fd_tcache_reset` and verifies the valid transaction again, expecting `FD_TXN_VERIFY_SUCCESS`.
    - Frees the payload, loads the invalid transaction again, parses it, and verifies it, expecting `FD_TXN_VERIFY_DEDUP`.
    - Resets the transaction cache again, loads the valid transaction, parses it, and verifies it with deduplication disabled, expecting `FD_TXN_VERIFY_SUCCESS`.
    - Frees the payload, loads the invalid transaction again, parses it, and verifies it twice, expecting `FD_TXN_VERIFY_FAILED` both times.
    - Frees the payload and the verification context.
- **Output**: No output is returned; the function performs tests and uses assertions to validate behavior.
- **Functions Called**:
    - [`setup_verify_ctx`](<#setup_verify_ctx>)
    - [`load_test_txn`](<#load_test_txn>)
    - [`fd_txn_verify`](<fd_verify_tile.h.md#fd_txn_verify>)
    - [`free_verify_ctx`](<#free_verify_ctx>)


---
### test\_verify\_invalid\_dedup\_with\_collision\_success<!-- {{#callable:test_verify_invalid_dedup_with_collision_success}} -->
[View Source →](<../../../../../src/disco/verify/test_verify.c#L313>)

Tests the verification of transactions with signature collisions, ensuring invalid transactions are not deduplicated and fail verification.
- **Inputs**:
    - `ctx`: A pointer to an `fd_verify_ctx_t` structure used for transaction verification context.
    - `mem`: A pointer to memory allocated for the verification context.
    - `out_buf`: A buffer to store the parsed transaction data.
    - `txn`: A pointer to an `fd_txn_t` structure representing the transaction.
    - `opt_sig`: An unsigned long used to store optional signature data.
    - `payload`: A pointer to the transaction payload data.
    - `payload_sz`: The size of the transaction payload.
    - `res`: An integer to store the result of the transaction verification.
- **Logic and Control Flow**:
    - Logs the start of the test with `FD_LOG_NOTICE`.
    - Initializes the verification context by calling [`setup_verify_ctx`](<#setup_verify_ctx>).
    - Loads a valid transaction with one signature using [`load_test_txn`](<#load_test_txn>) and parses it with `fd_txn_parse`.
    - Verifies the valid transaction using [`fd_txn_verify`](<fd_verify_tile.h.md#fd_txn_verify>) and checks if the result is `FD_TXN_VERIFY_SUCCESS`.
    - Frees the payload memory.
    - Loads an invalid transaction with the same low 64-bit signature as the valid one, parses it, and verifies it.
    - Checks that the invalid transaction fails verification with `FD_TXN_VERIFY_FAILED`.
    - Frees the payload memory and the verification context.
- **Output**: No direct output is returned, but the function logs the results of the verification tests and ensures that invalid transactions with signature collisions are not deduplicated and fail verification.
- **Functions Called**:
    - [`setup_verify_ctx`](<#setup_verify_ctx>)
    - [`load_test_txn`](<#load_test_txn>)
    - [`fd_txn_verify`](<fd_verify_tile.h.md#fd_txn_verify>)
    - [`free_verify_ctx`](<#free_verify_ctx>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/disco/verify/test_verify.c#L349>)

Initializes the system, runs a series of transaction verification tests, logs the results, and then halts the system.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of strings representing the command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the system with command-line arguments.
    - Executes [`test_verify_success`](<#test_verify_success>) to test successful transaction verification.
    - Executes [`test_verify_invalid_sigs_success`](<#test_verify_invalid_sigs_success>) to test transaction verification with invalid signatures.
    - Executes [`test_verify_invalid_dedup_success`](<#test_verify_invalid_dedup_success>) to test transaction verification with invalid deduplication scenarios.
    - Executes [`test_verify_invalid_dedup_with_collision_success`](<#test_verify_invalid_dedup_with_collision_success>) to test transaction verification with deduplication and collision scenarios.
    - Logs a notice message 'pass' using `FD_LOG_NOTICE`.
    - Calls `fd_halt` to halt the system.
    - Returns 0 to indicate successful execution.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`test_verify_success`](<#test_verify_success>)
    - [`test_verify_invalid_sigs_success`](<#test_verify_invalid_sigs_success>)
    - [`test_verify_invalid_dedup_success`](<#test_verify_invalid_dedup_success>)
    - [`test_verify_invalid_dedup_with_collision_success`](<#test_verify_invalid_dedup_with_collision_success>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)