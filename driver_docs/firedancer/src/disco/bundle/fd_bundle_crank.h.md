<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines structures and functions for managing and generating crank transactions for tip distribution.

# Purpose
The code is a C header file that defines structures and functions for managing "crank transactions" related to a tip distribution system. It provides functionality to initialize, generate, and apply these transactions, which are used to manage the creation and updating of a tip distribution account. The header file includes several dependencies and defines constants, structures, and function prototypes necessary for handling these transactions.

The primary components include the `fd_bundle_crank_gen_t` structure, which is used to initialize a bundle crank generator, and functions such as [`fd_bundle_crank_gen_init`](<#fd_bundle_crank_gen_init>), [`fd_bundle_crank_get_addresses`](<#fd_bundle_crank_get_addresses>), [`fd_bundle_crank_generate`](<#fd_bundle_crank_generate>), and [`fd_bundle_crank_apply`](<#fd_bundle_crank_apply>). These functions facilitate the setup and execution of transactions that manage tip distribution accounts, including creating and updating accounts, and handling the necessary cryptographic operations. The header also defines the layout of the tip payment configuration account and the structure of the transactions, ensuring that the transactions are correctly formatted for submission to the blockchain.
# Imports and Dependencies

---
- `../fd_disco_base.h`
- `../../ballet/txn/fd_txn.h`
- `../../flamenco/runtime/fd_system_ids_pp.h`
- `fd_bundle_crank_constants.h`


# Data Structures

---
### fd\_bundle\_crank\_gen\_t
- **Type**: ``struct``
- **Members**:
    - `crank3`: An array of one `fd_bundle_crank_3_t` structure, representing a type of transaction.
    - `crank2`: An array of one `fd_bundle_crank_2_t` structure, representing another type of transaction.
    - `txn3`: A byte array for storing transaction data, aligned to the size of `fd_txn_t`.
    - `txn2`: A byte array for storing transaction data, aligned to the size of `fd_txn_t`.
    - `configured_epoch`: An unsigned long integer representing the epoch for which the generator is configured.
    - `map`: An array of 32 `fd_bundle_crank_gen_pidx_t` structures, used for mapping purposes.
- **Description**: `fd_bundle_crank_gen_t` is a structure that encapsulates data and configurations necessary for generating and managing bundle crank transactions. It includes arrays for two types of transactions (`crank3` and `crank2`), byte arrays for transaction data (`txn3` and `txn2`), a configured epoch value, and a mapping array (`map`) for internal indexing or lookup purposes. This structure is used in the context of managing and executing transactions related to tip distribution and block building in a distributed system.


---
### fd\_bundle\_crank\_tip\_payment\_config
- **Type**: ``struct``
- **Members**:
    - `discriminator`: A unique identifier for the structure, set to `0x82ccfa1ee0aa0c9b`.
    - `tip_receiver`: An array containing the address of the tip receiver account.
    - `block_builder`: An array containing the address of the block builder account.
    - `commission_pct`: The commission percentage for the tip payment.
    - `bumps`: An array of 9 unsigned characters used for internal configuration or state tracking.
- **Description**: Defines the layout of the tip payment configuration account on-chain, including fields for identifying the account, specifying the tip receiver and block builder addresses, setting the commission percentage, and storing additional configuration data in the form of bumps.


---
### fd\_bundle\_crank\_tip\_payment\_config\_t
- **Type**: ``struct``
- **Members**:
    - `discriminator`: A unique identifier for the structure, set to `0x82ccfa1ee0aa0c9b`.
    - `tip_receiver`: An array containing the account address of the tip receiver.
    - `block_builder`: An array containing the account address of the block builder.
    - `commission_pct`: The commission percentage for the validator.
    - `bumps`: An array of 9 bytes used for internal configuration or state.
- **Description**: Defines the layout of the tip payment configuration account on-chain, including fields for identifying the account, specifying the tip receiver and block builder addresses, setting the commission percentage, and storing additional configuration data in the form of bumps.


---
### fd\_bundle\_crank\_3\_t
- **Type**: ``struct``
- **Members**:
    - `sig_cnt`: Number of signatures, set to 1.
    - `signature`: Array of 64 bytes representing the signature.
    - `_sig_cnt`: Duplicate of `sig_cnt`, set to 1.
    - `ro_signed_cnt`: Number of read-only signed accounts, set to 0.
    - `ro_unsigned_cnt`: Number of read-only unsigned accounts, set to 6.
    - `acct_addr_cnt`: Total number of account addresses, set to 21.
    - `authorized_voter`: 32-byte array for the authorized voter's address.
    - `tip_payment_accounts`: Array of 8 arrays, each 32 bytes, for tip payment accounts.
    - `tip_distribution_program_config`: 32-byte array for the tip distribution program configuration.
    - `tip_payment_program_config`: 32-byte array for the tip payment program configuration.
    - `old_tip_receiver`: 32-byte array for the old tip receiver's address.
    - `old_block_builder`: 32-byte array for the old block builder's address.
    - `new_tip_receiver`: 32-byte array for the new tip receiver's address.
    - `new_block_builder`: 32-byte array for the new block builder's address.
    - `compute_budget_program`: 32-byte array for the compute budget program.
    - `tip_payment_program`: 32-byte array for the tip payment program.
    - `validator_vote_account`: 32-byte array for the validator vote account.
    - `system_program`: 32-byte array for the system program.
    - `tip_distribution_program`: 32-byte array for the tip distribution program.
    - `memo_program`: 32-byte array for the memo program.
    - `recent_blockhash`: 32-byte array for the recent blockhash.
    - `instr_cnt`: Number of instructions, set to 5.
    - `compute_budget_instruction`: Structure for the compute budget instruction.
    - `init_tip_distribution_acct`: Structure for initializing the tip distribution account.
    - `change_tip_receiver`: Structure for changing the tip receiver.
    - `change_block_builder`: Structure for changing the block builder.
    - `memo`: Structure for the memo instruction.
- **Description**: `fd_bundle_crank_3_t` is a packed structure that represents a fixed-size transaction payload for initializing and updating tip distribution accounts. It includes fields for managing account addresses, signatures, and instructions necessary for executing transactions related to tip distribution and block building. The structure contains several nested structures for specific instructions, such as computing budget, initializing tip distribution accounts, changing tip receivers, and changing block builders, along with a memo field. The structure is designed to facilitate the creation and management of transactions in a blockchain environment.


---
### fd\_bundle\_crank\_2\_t
- **Type**: ``struct``
- **Members**:
    - `sig_cnt`: Number of signatures, set to 1.
    - `signature`: Array of 64 bytes representing the signature.
    - `_sig_cnt`: Duplicate of `sig_cnt`, set to 1.
    - `ro_signed_cnt`: Count of read-only signed accounts, set to 0.
    - `ro_unsigned_cnt`: Count of read-only unsigned accounts, set to 3.
    - `acct_addr_cnt`: Total number of account addresses, set to 18.
    - `authorized_voter`: 32-byte array for the writable signer account.
    - `tip_payment_accounts`: Array of 8 writable non-signer accounts, each 32 bytes.
    - `tip_distribution_program_config`: 32-byte array for the tip distribution program configuration.
    - `tip_payment_program_config`: 32-byte array for the tip payment program configuration.
    - `old_tip_receiver`: 32-byte array for the old tip receiver account.
    - `old_block_builder`: 32-byte array for the old block builder account.
    - `new_tip_receiver`: 32-byte array for the new tip receiver account.
    - `new_block_builder`: 32-byte array for the new block builder account.
    - `compute_budget_program`: 32-byte array for the compute budget program.
    - `tip_payment_program`: 32-byte array for the tip payment program.
    - `memo_program`: 32-byte array for the memo program.
    - `recent_blockhash`: 32-byte array for the recent blockhash.
    - `instr_cnt`: Number of instructions, set to 4.
    - `compute_budget_instruction`: Structure for the compute budget instruction.
    - `change_tip_receiver`: Structure for the change tip receiver instruction.
    - `change_block_builder`: Structure for the change block builder instruction.
    - `memo`: Structure for the memo instruction.
- **Description**: `fd_bundle_crank_2_t` is a packed structure that defines a transaction for updating accounts related to tip payments and block building in a blockchain system. It includes fields for managing signatures, account addresses, and instructions necessary for executing the transaction. The structure is designed to handle the update of tip receivers and block builders without creating new accounts, and it includes specific fields for transaction metadata such as recent blockhash and instruction count.


---
### fd\_bundle\_crank\_3
- **Type**: ``struct``
- **Members**:
    - ``sig_cnt``: Stores the count of signatures, initialized to 1.
    - ``signature``: Holds a 64-byte signature.
    - ``_sig_cnt``: Stores a duplicate count of signatures, initialized to 1.
    - ``ro_signed_cnt``: Indicates the count of readonly signed accounts, initialized to 0.
    - ``ro_unsigned_cnt``: Indicates the count of readonly unsigned accounts, initialized to 6.
    - ``acct_addr_cnt``: Stores the count of account addresses, initialized to 21.
    - ``authorized_voter``: Holds a 32-byte writable signer account for the authorized voter.
    - ``tip_payment_accounts``: Contains an array of 8 writable non-signer accounts, each 32 bytes, for tip payments.
    - ``tip_distribution_program_config``: Holds a 32-byte writable non-signer account for the tip distribution program configuration.
    - ``tip_payment_program_config``: Holds a 32-byte writable non-signer account for the tip payment program configuration.
    - ``old_tip_receiver``: Holds a 32-byte writable non-signer account for the old tip receiver.
    - ``old_block_builder``: Holds a 32-byte writable non-signer account for the old block builder.
    - ``new_tip_receiver``: Holds a 32-byte writable non-signer account for the new tip receiver.
    - ``new_block_builder``: Holds a 32-byte writable non-signer account for the new block builder.
    - ``compute_budget_program``: Holds a 32-byte readonly non-signer account for the compute budget program.
    - ``tip_payment_program``: Holds a 32-byte readonly non-signer account for the tip payment program.
    - ``validator_vote_account``: Holds a 32-byte readonly non-signer account for the validator vote account.
    - ``system_program``: Holds a 32-byte readonly non-signer account for the system program.
    - ``tip_distribution_program``: Holds a 32-byte readonly non-signer account for the tip distribution program.
    - ``memo_program``: Holds a 32-byte readonly non-signer account for the memo program.
    - ``recent_blockhash``: Stores a 32-byte recent blockhash.
    - ``instr_cnt``: Stores the count of instructions, initialized to 5.
    - ``compute_budget_instruction``: Nested struct for compute budget instruction with program ID, account count, data size, CU limit, and CU count.
    - ``init_tip_distribution_acct``: Nested struct for initializing tip distribution account with program ID, account count, account indices, data size, discriminator, authority, commission, and bump.
    - ``change_tip_receiver``: Nested struct for changing tip receiver with program ID, account count, account indices, data size, and discriminator.
    - ``change_block_builder``: Nested struct for changing block builder with program ID, account count, account indices, data size, discriminator, and commission percentage.
    - ``memo``: Nested struct for memo with program ID, account count, data size, and memo content.
- **Description**: Defines a packed structure for managing crank transactions, including signature counts, account addresses, and various nested instructions for operations like initializing tip distribution accounts, changing tip receivers, and modifying block builders. It includes writable and readonly accounts, both signers and non-signers, and handles transaction details such as recent blockhash and instruction count. The structure is used in the context of managing tip distribution and payment configurations in a blockchain environment.


---
### fd\_bundle\_crank\_2
- **Type**: ``struct``
- **Members**:
    - `sig_cnt`: Stores the count of signatures, initialized to 1.
    - `signature`: Holds a 64-byte signature.
    - `_sig_cnt`: Stores a duplicate count of signatures, initialized to 1.
    - `ro_signed_cnt`: Stores the count of read-only signed accounts, initialized to 0.
    - `ro_unsigned_cnt`: Stores the count of read-only unsigned accounts, initialized to 3.
    - `acct_addr_cnt`: Stores the count of account addresses, initialized to 18.
    - `authorized_voter`: Holds a 32-byte writable signer account for the authorized voter.
    - `tip_payment_accounts`: Holds an array of eight 32-byte writable non-signer accounts for tip payments.
    - `tip_distribution_program_config`: Holds a 32-byte writable non-signer account for the tip distribution program configuration.
    - `tip_payment_program_config`: Holds a 32-byte writable non-signer account for the tip payment program configuration.
    - `old_tip_receiver`: Holds a 32-byte writable non-signer account for the old tip receiver.
    - `old_block_builder`: Holds a 32-byte writable non-signer account for the old block builder.
    - `new_tip_receiver`: Holds a 32-byte writable non-signer account for the new tip receiver.
    - `new_block_builder`: Holds a 32-byte writable non-signer account for the new block builder.
    - `compute_budget_program`: Holds a 32-byte read-only non-signer account for the compute budget program.
    - `tip_payment_program`: Holds a 32-byte read-only non-signer account for the tip payment program.
    - `memo_program`: Holds a 32-byte read-only non-signer account for the memo program.
    - `recent_blockhash`: Holds a 32-byte recent blockhash.
    - `instr_cnt`: Stores the count of instructions, initialized to 4.
    - `compute_budget_instruction`: Nested struct for compute budget instruction with program ID, account count, data size, CU limit, and CU count.
    - `change_tip_receiver`: Nested struct for changing the tip receiver with program ID, account count, account indices, data size, and instruction discriminator.
    - `change_block_builder`: Nested struct for changing the block builder with program ID, account count, account indices, data size, instruction discriminator, and block builder commission percentage.
    - `memo`: Nested struct for memo with program ID, account count, data size, and a 3-character memo.
- **Description**: Defines a packed structure for managing crank transactions related to tip distribution and block building in a blockchain system. It includes fields for signature management, account addresses, and specific instructions for computing budgets, changing tip receivers, and block builders. The structure is designed to handle writable and read-only accounts, with nested structures for detailed instruction handling.


---
### fd\_bundle\_crank\_gen\_pidx\_t
- **Type**: ``struct``
- **Members**:
    - ``key``: Holds an account address of type `fd_acct_addr_t`.
    - ``idx``: Stores an index as an unsigned long integer.
- **Description**: Defines a structure with two members: `key`, which is an account address, and `idx`, which is an index. This structure is likely used to map or associate an account address with a specific index, possibly for tracking or referencing purposes within a larger system or application.


---
### fd\_bundle\_crank\_gen\_private
- **Type**: ``struct``
- **Members**:
    - `crank3`: An array of one `fd_bundle_crank_3_t` structure, representing a type of crank transaction.
    - `crank2`: An array of one `fd_bundle_crank_2_t` structure, representing another type of crank transaction.
    - `txn3`: A byte array aligned to `fd_txn_t`, sized to hold a transaction with 5 instructions.
    - `txn2`: A byte array aligned to `fd_txn_t`, sized to hold a transaction with 4 instructions.
    - `configured_epoch`: An unsigned long integer representing the configured epoch.
    - `map`: An array of 32 `fd_bundle_crank_gen_pidx_t` structures, used for mapping purposes.
- **Description**: The `fd_bundle_crank_gen_private` structure is a private data structure used to manage and store information related to bundle crank transactions. It contains arrays for two types of crank transactions (`crank3` and `crank2`), byte arrays for storing transaction data (`txn3` and `txn2`), a field for the configured epoch, and a mapping array (`map`) for additional transaction management.


# Function Declarations (Public API)

---
### fd\_bundle\_crank\_gen\_init<!-- {{#callable_declaration:fd_bundle_crank_gen_init}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_crank.h#L58>)

Initializes a bundle crank generator for producing transactions.
- **Description**: Use this function to prepare a bundle crank generator for creating bundle crank transactions. It performs necessary precomputations, which are resource-intensive, so it is efficient to call this function once per epoch rather than per slot. Ensure that all pointer parameters are non-null and point to valid memory regions. The function returns the initialized memory region, ready for use in transaction generation.
- **Inputs**:
    - `mem`: Points to a memory region with suitable alignment and size for a `fd_bundle_crank_gen_t`. Caller retains ownership and must ensure it is valid.
    - `tip_distribution_program_addr`: Non-null pointer to the account address of the configured tip distribution program. Must point to a valid 32-byte region.
    - `tip_payment_program_addr`: Non-null pointer to the account address of the configured tip payment program. Must point to a valid 32-byte region.
    - `validator_vote_acct_addr`: Non-null pointer to the pubkey for the validator's vote account. Must point to a valid 32-byte region.
    - `merkle_root_authority_addr`: Non-null pointer to a pubkey for the Merkle root authority. Must point to a valid 32-byte region.
    - `scheduler_mode`: ASCII string describing the current schedule mode. Only the first 3 characters are used. Must not be null.
    - `commission_bps`: Validator's tip commission in basis points. Must be in the range [0, 10,000].
- **Output**: Returns the `mem` pointer, now initialized for use in transaction generation.
- **See Also**: [`fd_bundle_crank_gen_init`](<fd_bundle_crank.c.md#fd_bundle_crank_gen_init>)  (Implementation)


---
### fd\_bundle\_crank\_get\_addresses<!-- {{#callable_declaration:fd_bundle_crank_get_addresses}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_crank.h#L76>)

Retrieve account addresses for the current epoch.
- **Description**: Use this function to obtain the tip payment configuration account address and the validator's tip receiver account address for a specific epoch. Ensure that the generator is properly initialized before calling this function. This function updates the epoch if it differs from the configured epoch, ensuring the addresses are current.
- **Inputs**:
    - `gen`: A pointer to an initialized `fd_bundle_crank_gen_t` structure. Must not be null.
    - `epoch`: The epoch number for which the addresses are needed. If it differs from the generator's configured epoch, the function updates the epoch.
    - `out_tip_payment_config`: A pointer to a `fd_acct_addr_t` where the function will store the tip payment configuration account address. Must not be null.
    - `out_tip_receiver`: A pointer to a `fd_acct_addr_t` where the function will store the tip receiver account address. Must not be null.
- **Output**: None
- **See Also**: [`fd_bundle_crank_get_addresses`](<fd_bundle_crank.c.md#fd_bundle_crank_get_addresses>)  (Implementation)


---
### fd\_bundle\_crank\_generate<!-- {{#callable_declaration:fd_bundle_crank_generate}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_crank.h#L138>)

Produces necessary bundle crank transactions.
- **Description**: Use this function to generate bundle crank transactions when the configuration of the tip payment account needs updating. Ensure that the generator is properly initialized before calling this function. The function checks the validity of the old tip payment configuration and compares it with the new settings. If changes are necessary, it writes the transaction payload and transaction data to the provided memory regions. If no changes are needed, the function leaves the output regions unmodified. The function returns the size of the transaction payload if changes are made, or 0 if no changes are necessary. If an error occurs, it returns ULONG_MAX and logs a warning.
- **Inputs**:
    - `gen`: A pointer to an initialized `fd_bundle_crank_gen_t` structure. Must not be null.
    - `old_tip_payment_config`: A pointer to a `fd_bundle_crank_tip_payment_config_t` structure containing the current tip payment configuration. Must not be null.
    - `new_block_builder`: A pointer to a `fd_acct_addr_t` structure representing the desired block builder. Must not be null.
    - `identity`: A pointer to a `fd_acct_addr_t` structure representing the current validator's identity pubkey. Must not be null.
    - `tip_receiver_owner`: A pointer to a `fd_acct_addr_t` structure representing the pubkey of the tip receiver account owner. Must not be null.
    - `epoch`: An unsigned long representing the epoch number for the transaction submission.
    - `block_builder_commission`: An unsigned long representing the block builder's commission in percentage points.
    - `out_payload`: A pointer to a memory region where the transaction payload will be written if changes are necessary. Must have at least `sizeof(fd_bundle_crank_3_t)` bytes.
    - `out_txn`: A pointer to a memory region where the transaction data will be written if changes are necessary. Must have at least `FD_TXN_MAX_SZ` bytes.
- **Output**: Returns the size of the transaction payload written to `out_payload` if changes are necessary, 0 if no changes are needed, or ULONG_MAX if an error occurs.
- **See Also**: [`fd_bundle_crank_generate`](<fd_bundle_crank.c.md#fd_bundle_crank_generate>)  (Implementation)


---
### fd\_bundle\_crank\_apply<!-- {{#callable_declaration:fd_bundle_crank_apply}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_crank.h#L156>)

Updates the tip payment configuration and tip receiver owner.
- **Description**: Use this function to update the tip payment configuration and tip receiver owner based on the parameters provided. It should be called when you want to apply changes as if a transaction generated by `fd_bundle_crank_generate` executed successfully. Ensure that the `epoch` matches the configured epoch in `gen`; otherwise, the function will update the epoch configuration. This function modifies the `tip_payment_config` and `tip_receiver_owner` to reflect the new block builder and commission settings.
- **Inputs**:
    - `gen`: A pointer to a `fd_bundle_crank_gen_t` structure. It must be a valid and initialized bundle crank generator.
    - `tip_payment_config`: A pointer to a `fd_bundle_crank_tip_payment_config_t` structure. This will be updated with the new tip receiver and block builder addresses.
    - `new_block_builder`: A pointer to a `fd_acct_addr_t` structure representing the new block builder. Must not be null.
    - `tip_receiver_owner`: A pointer to a `fd_acct_addr_t` structure. This will be updated with the new tip receiver owner address.
    - `epoch`: An unsigned long integer representing the epoch number. If it does not match the configured epoch in `gen`, the function updates the epoch configuration.
    - `block_builder_commission`: An unsigned long integer representing the block builder's commission in percentage points.
- **Output**: None
- **See Also**: [`fd_bundle_crank_apply`](<fd_bundle_crank.c.md#fd_bundle_crank_apply>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)