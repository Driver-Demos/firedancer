<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Header file for acquiring authentication tokens for a bundle server using a challenge-response flow.

# Purpose
The `fd_bundle_auth.h` file defines the interface and structures necessary for acquiring an authentication token from a bundle server. It outlines the authentication flow, which involves a challenge-response mechanism. The client requests a challenge from the server, signs it using its identity key, and then requests an authentication token. The server responds with an authentication token and a refresh token. This process is encapsulated in the `fd_bundle_auther` structure, which maintains the state of the authentication process, including the public key, challenge, and access token.

The file includes function prototypes for initializing the authentication process (`fd_bundle_auther_init`), polling for request work ([`fd_bundle_auther_poll`](<#fd_bundle_auther_poll>)), and resetting the authentication state ([`fd_bundle_auther_reset`](<#fd_bundle_auther_reset>)). It also provides handlers for managing request failures and processing responses to challenges and token requests. The file includes necessary headers for gRPC and key management functionalities, indicating dependencies on external components for communication and security operations. The defined macros and state constants facilitate the management of the authentication process's various stages.
# Imports and Dependencies

---
- `../../waltz/grpc/fd_grpc_client.h`
- `../../disco/keyguard/fd_keyguard_client.h`


# Data Structures

---
### fd\_bundle\_auther
- **Type**: ``struct``
- **Members**:
    - `state`: Stores the current state of the authentication process.
    - `needs_poll`: Indicates if polling is required for the authentication process.
    - `pubkey`: Holds the public key of the client, with a fixed size of 32 bytes.
    - `challenge`: Contains a 9-byte challenge string for the authentication process.
    - `access_token`: Stores the access token received from the server, with a maximum size of 1024 bytes.
    - `access_token_sz`: Represents the size of the access token currently stored.
- **Description**: Manages the state and data required for the authentication process with a bundle server, including handling challenges and access tokens.


---
### fd\_bundle\_auther\_t
- **Type**: `struct`
- **Members**:
    - `state`: Stores the current state of the authentication process.
    - `needs_poll`: Indicates if polling is required for the authentication process.
    - `pubkey`: Holds the public key of the client, with a fixed size of 32 bytes.
    - `challenge`: Contains the 9-byte challenge string received from the server.
    - `access_token`: Stores the access token received from the server, with a maximum size of 1024 bytes.
    - `access_token_sz`: Represents the size of the access token currently stored.
- **Description**: Manages the authentication process for a bundle server by handling state transitions, storing necessary cryptographic keys and tokens, and managing the challenge-response flow between the client and server.


# Function Declarations (Public API)

---
### fd\_bundle\_auther\_poll<!-- {{#callable_declaration:fd_bundle_auther_poll}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_auth.h#L47>)

Performs authentication request work based on the current state.
- **Description**: Use this function to progress the authentication process for a bundle server. It should be called immediately if `auther->needs_poll` is set to true, indicating that the authentication process requires attention. Otherwise, it can be called at a lower frequency, approximately every 100 milliseconds. The function checks the current state of the `auther` and performs the appropriate action, either requesting a challenge or requesting tokens. Ensure that the `auther` is properly initialized before calling this function.
- **Inputs**:
    - `auther`: A pointer to an `fd_bundle_auther_t` structure that represents the current state of the authentication process. Must not be null and should be initialized before use.
    - `client`: A pointer to an `fd_grpc_client_t` structure used for gRPC communication. Must not be null.
    - `keyguard`: A pointer to an `fd_keyguard_client_t` structure used for key management. Must not be null.
- **Output**: None
- **See Also**: [`fd_bundle_auther_poll`](<fd_bundle_auth.c.md#fd_bundle_auther_poll>)  (Implementation)


---
### fd\_bundle\_auther\_reset<!-- {{#callable_declaration:fd_bundle_auther_reset}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_auth.h#L55>)

Restarts the authentication process.
- **Description**: Use this function to restart the authentication process for a bundle server when a request fails due to an authentication failure. This function resets the internal state of the `fd_bundle_auther_t` structure to request a new challenge and sets the `needs_poll` flag to indicate that polling is required. It is important to call this function in response to an authentication failure to ensure the client can attempt to acquire a new authentication token.
- **Inputs**:
    - `auther`: A pointer to an `fd_bundle_auther_t` structure. This parameter must not be null, and the caller retains ownership. The function modifies the state and `needs_poll` fields of this structure.
- **Output**: None
- **See Also**: [`fd_bundle_auther_reset`](<fd_bundle_auth.c.md#fd_bundle_auther_reset>)  (Implementation)


---
### fd\_bundle\_auther\_handle\_request\_fail<!-- {{#callable_declaration:fd_bundle_auther_handle_request_fail}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_auth.h#L60>)

Handles a failed authentication request.
- **Description**: Use this function to manage the state of an `fd_bundle_auther_t` object when an authentication request fails. It adjusts the internal state to retry the challenge request and sets the `needs_poll` flag to indicate that further processing is required. This function is typically called when a request for an authentication challenge or tokens does not succeed, ensuring that the authentication process can continue.
- **Inputs**:
    - `auther`: A pointer to an `fd_bundle_auther_t` structure. This must not be null. The function modifies the state and `needs_poll` fields of this structure to handle the failure.
- **Output**: None
- **See Also**: [`fd_bundle_auther_handle_request_fail`](<fd_bundle_auth.c.md#fd_bundle_auther_handle_request_fail>)  (Implementation)


---
### fd\_bundle\_auther\_handle\_challenge\_resp<!-- {{#callable_declaration:fd_bundle_auther_handle_challenge_resp}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_auth.h#L63>)

Handles the response to an authentication challenge.
- **Description**: Use this function to process the server's response to an authentication challenge during the authentication flow. It updates the state of the `auther` object based on the validity of the response. Call this function after receiving a challenge response from the server. The function expects the response to contain a 9-byte challenge. If the response is valid, it updates the `auther`'s state to request tokens; otherwise, it resets the state to request a new challenge.
- **Inputs**:
    - `auther`: A pointer to an `fd_bundle_auther_t` structure. Must not be null. The function updates this structure based on the response.
    - `data`: A pointer to the data buffer containing the challenge response. Must not be null.
    - `data_sz`: The size of the data buffer. Must be sufficient to contain a valid challenge response.
- **Output**: Returns 1 if the response is successfully processed and the state is updated to request tokens. Returns 0 if the response is invalid and the state is reset to request a new challenge.
- **See Also**: [`fd_bundle_auther_handle_challenge_resp`](<fd_bundle_auth.c.md#fd_bundle_auther_handle_challenge_resp>)  (Implementation)


---
### fd\_bundle\_auther\_handle\_tokens\_resp<!-- {{#callable_declaration:fd_bundle_auther_handle_tokens_resp}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_auth.h#L70>)

Processes a response containing authentication tokens.
- **Description**: Use this function to handle a server response that contains authentication tokens. It decodes the response and updates the `auther` structure with the access token if the response is valid. Call this function after receiving a response from the server to ensure the `auther` is updated with the latest authentication state. If the response is invalid or the access token is missing or too large, the function sets the `auther` state to request a new challenge and indicates that polling is needed.
- **Inputs**:
    - `auther`: A pointer to an `fd_bundle_auther_t` structure. Must not be null. The function updates this structure with the access token and state information.
    - `data`: A pointer to the response data buffer. Must not be null. The buffer should contain the server's response to be processed.
    - `data_sz`: The size of the data buffer in bytes. Must accurately represent the size of the data buffer.
- **Output**: Returns 1 if the response is successfully processed and the access token is valid. Returns 0 if the response is invalid or the access token is missing or too large.
- **See Also**: [`fd_bundle_auther_handle_tokens_resp`](<fd_bundle_auth.c.md#fd_bundle_auther_handle_tokens_resp>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)