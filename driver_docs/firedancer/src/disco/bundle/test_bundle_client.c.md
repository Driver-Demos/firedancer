<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for the Firedancer bundle client, including packet and bundle forwarding, stream handling, and client status.

# Purpose
The code is a C test suite designed to verify the functionality of a client that interacts with a gRPC server. It includes a series of test functions that simulate various scenarios to ensure the client correctly handles packet and bundle subscriptions, stream resets, timeouts, and other gRPC-related operations. The code imports several dependencies, including protocol buffer headers and base58 encoding utilities, indicating its reliance on external libraries for encoding and decoding messages.

The test suite is structured to create and destroy test environments, simulate gRPC message exchanges, and validate the client's behavior under different conditions. It uses macros like `FD_TEST` to assert expected outcomes and includes functions to test specific client behaviors, such as handling oversized messages, managing keepalive pings, and resetting the client state. The main function initializes the test environment, executes the test cases, and checks for memory leaks, ensuring the client operates as intended without resource leaks.
# Imports and Dependencies

---
- `test_bundle_common.c`
- `proto/block_engine.pb.h`
- `../../ballet/base58/fd_base58.h`
- `../../ballet/nanopb/pb_encode.h`


# Global Variables

---
### fdctl\_version\_string
- **Type**: ``char const[]``
- **Description**: A constant character array that holds the version string for the `fdctl` component. The version is initialized to "0.0.0".
- **Use**: Used to store and provide the version information of the `fdctl` component.


---
### g\_clock
- **Type**: ``long``
- **Description**: Represents a static global variable of type `long` initialized to 1L. It is used to track or represent a clock or time-related value in the program.
- **Use**: Used in the `fd_bundle_now` function to return the current value of the clock.


# Functions

---
### fd\_bundle\_now<!-- {{#callable:fd_bundle_now}} -->
[View Source →](<../../../../../src/disco/bundle/test_bundle_client.c#L12>)

Returns the current value of the global clock variable `g_clock`.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the value of the global variable `g_clock`.
- **Output**: A `long` integer representing the current value of `g_clock`.


---
### test\_bundle\_rx<!-- {{#callable:test_bundle_rx}} -->
[View Source →](<../../../../../src/disco/bundle/test_bundle_client.c#L20>)

Tests the reception and processing of packet and bundle messages in a Firedancer environment.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for managing memory and state during the test.
- **Logic and Control Flow**:
    - Create a test environment using [`test_bundle_env_create`](<test_bundle_common.c.md#test_bundle_env_create>) with the provided workspace.
    - Initialize a `SubscribePacketsResponse` message containing two packets and call [`fd_bundle_client_grpc_rx_msg`](<fd_bundle_client.c.md#fd_bundle_client_grpc_rx_msg>) to simulate receiving this message.
    - Clear timestamps in the `out_mcache` array for all entries up to `env->stem_depths[0]`.
    - Define expected metadata for the two packets and verify the `out_mcache` contents using `FD_TEST` and `fd_memeq`.
    - Set `state->builder_info_avail` to 1 to indicate builder information is available.
    - Call [`fd_bundle_client_grpc_rx_msg`](<fd_bundle_client.c.md#fd_bundle_client_grpc_rx_msg>) with a test bundle response to simulate receiving a bundle subscription message.
    - Destroy the test environment using [`test_bundle_env_destroy`](<test_bundle_common.c.md#test_bundle_env_destroy>).
- **Output**: No return value; the function performs tests and uses assertions to validate behavior.
- **Functions Called**:
    - [`test_bundle_env_create`](<test_bundle_common.c.md#test_bundle_env_create>)
    - [`fd_bundle_client_grpc_rx_msg`](<fd_bundle_client.c.md#fd_bundle_client_grpc_rx_msg>)
    - [`test_bundle_env_destroy`](<test_bundle_common.c.md#test_bundle_env_destroy>)


---
### test\_bundle\_rx\_too\_many\_txns<!-- {{#callable:test_bundle_rx_too_many_txns}} -->
[View Source →](<../../../../../src/disco/bundle/test_bundle_client.c#L70>)

Tests the behavior of the system when receiving bundles with too many transactions.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for managing memory and state.
- **Logic and Control Flow**:
    - Create a test environment using [`test_bundle_env_create`](<test_bundle_common.c.md#test_bundle_env_create>) with the provided workspace `wksp`.
    - Initialize a state pointer to the environment's state.
    - Define a static message `subscribe_bundles_msg_x5` representing a bundle with 5 transactions.
    - Wipe timestamps in the environment's output cache by setting `tsorig` and `tspub` to 0 for each entry.
    - Set `builder_info_avail` to 1 to indicate builder information is available.
    - Call [`fd_bundle_client_grpc_rx_msg`](<fd_bundle_client.c.md#fd_bundle_client_grpc_rx_msg>) to process the message with 5 transactions.
    - Count the number of published transactions by iterating over the output cache and checking `tspub` values.
    - Verify that the transaction count is 5 using `FD_TEST`.
    - Destroy the test environment using [`test_bundle_env_destroy`](<test_bundle_common.c.md#test_bundle_env_destroy>).
    - Recreate the test environment and reinitialize the state pointer.
    - Define a static message `subscribe_bundles_msg_x6` representing a bundle with 6 transactions.
    - Wipe timestamps again in the environment's output cache.
    - Set `builder_info_avail` to 1 again.
    - Call [`fd_bundle_client_grpc_rx_msg`](<fd_bundle_client.c.md#fd_bundle_client_grpc_rx_msg>) to process the message with 6 transactions.
    - Verify that the state's `bundle_txn_cnt` is 6 using `FD_TEST`.
    - Count the number of published transactions again and verify that it is 0 using `FD_TEST`.
    - Destroy the test environment again.
- **Output**: No return value; the function performs tests and uses assertions to verify expected behavior.
- **Functions Called**:
    - [`test_bundle_env_create`](<test_bundle_common.c.md#test_bundle_env_create>)
    - [`fd_bundle_client_grpc_rx_msg`](<fd_bundle_client.c.md#fd_bundle_client_grpc_rx_msg>)
    - [`test_bundle_env_destroy`](<test_bundle_common.c.md#test_bundle_env_destroy>)


---
### test\_bundle\_no\_builder\_fee\_info<!-- {{#callable:test_bundle_no_builder_fee_info}} -->
[View Source →](<../../../../../src/disco/bundle/test_bundle_client.c#L175>)

Tests the behavior of packet and bundle forwarding when builder fee information is unavailable.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for managing memory and resources.
- **Logic and Control Flow**:
    - Initialize the test environment by creating a `test_bundle_env_t` structure and associating it with the provided workspace `wksp`.
    - Set the `builder_info_avail` flag in the `state` to 0, indicating that builder fee information is not available.
    - Send a `SubscribePackets` message using [`fd_bundle_client_grpc_rx_msg`](<fd_bundle_client.c.md#fd_bundle_client_grpc_rx_msg>) and verify that packets are forwarded by checking the sequence number and packet received count.
    - Send a `SubscribeBundles` message and verify that bundles are not forwarded by checking the sequence number and bundle received count.
    - Check that the `missing_builder_info_fail_cnt` is incremented when bundles are not forwarded due to missing builder fee information.
    - Destroy the test environment by calling [`test_bundle_env_destroy`](<test_bundle_common.c.md#test_bundle_env_destroy>).
- **Output**: No return value; the function performs tests and uses assertions to validate behavior.
- **Functions Called**:
    - [`test_bundle_env_create`](<test_bundle_common.c.md#test_bundle_env_create>)
    - [`fd_bundle_client_grpc_rx_msg`](<fd_bundle_client.c.md#fd_bundle_client_grpc_rx_msg>)
    - [`test_bundle_env_destroy`](<test_bundle_common.c.md#test_bundle_env_destroy>)


---
### test\_bundle\_stream\_ended<!-- {{#callable:test_bundle_stream_ended}} -->
[View Source →](<../../../../../src/disco/bundle/test_bundle_client.c#L212>)

Ensures that the client reconnects with a new TCP socket if the server ends the stream.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for managing memory and resources.
- **Logic and Control Flow**:
    - Create a `test_bundle_env_t` environment and initialize it with [`test_bundle_env_create`](<test_bundle_common.c.md#test_bundle_env_create>) using the provided workspace `wksp`.
    - Mock a connection in the environment using [`test_bundle_env_mock_conn`](<test_bundle_common.c.md#test_bundle_env_mock_conn>).
    - Retrieve the `fd_bundle_tile_t` state from the environment.
    - Get the transmit buffer `rbuf_tx` from the gRPC client associated with the state.
    - Check that the `hi_off` of `rbuf_tx` is 0 using `FD_TEST`.
    - Initialize a `fd_grpc_resp_hdrs_t` structure with HTTP/2 status 200 and gRPC status `FD_GRPC_STATUS_OK`.
    - Verify that `state->defer_reset` is 0 using `FD_TEST`.
    - Call [`fd_bundle_client_grpc_rx_end`](<fd_bundle_client.c.md#fd_bundle_client_grpc_rx_end>) to simulate the end of a gRPC stream with the specified headers.
    - Check that `state->defer_reset` is now 1 using `FD_TEST`.
    - Destroy the environment using [`test_bundle_env_destroy`](<test_bundle_common.c.md#test_bundle_env_destroy>).
- **Output**: This function does not return a value; it performs tests and assertions to verify behavior.
- **Functions Called**:
    - [`test_bundle_env_create`](<test_bundle_common.c.md#test_bundle_env_create>)
    - [`test_bundle_env_mock_conn`](<test_bundle_common.c.md#test_bundle_env_mock_conn>)
    - [`fd_bundle_client_grpc_rx_end`](<fd_bundle_client.c.md#fd_bundle_client_grpc_rx_end>)
    - [`test_bundle_env_destroy`](<test_bundle_common.c.md#test_bundle_env_destroy>)


---
### test\_bundle\_stream\_reset<!-- {{#callable:test_bundle_stream_reset}} -->
[View Source →](<../../../../../src/disco/bundle/test_bundle_client.c#L234>)

Resets a gRPC stream and updates the defer reset state in the test environment.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used to manage memory and resources for the test environment.
- **Logic and Control Flow**:
    - Create a test environment `env` using [`test_bundle_env_create`](<test_bundle_common.c.md#test_bundle_env_create>) with the provided workspace `wksp`.
    - Mock a connection in the test environment using [`test_bundle_env_mock_conn`](<test_bundle_common.c.md#test_bundle_env_mock_conn>).
    - Acquire a gRPC stream from the client in the test environment using `fd_grpc_client_stream_acquire`.
    - Set the HTTP/2 status and gRPC protocol flag on the stream headers.
    - Verify that the `defer_reset` state is initially 0 using `FD_TEST`.
    - Reset the stream using `fd_grpc_client_h2_callbacks.rst_stream` and verify that the `defer_reset` state is updated to 1.
    - Destroy the test environment using [`test_bundle_env_destroy`](<test_bundle_common.c.md#test_bundle_env_destroy>).
- **Output**: No return value; the function operates on the test environment and updates its state.
- **Functions Called**:
    - [`test_bundle_env_create`](<test_bundle_common.c.md#test_bundle_env_create>)
    - [`test_bundle_env_mock_conn`](<test_bundle_common.c.md#test_bundle_env_mock_conn>)
    - [`test_bundle_env_destroy`](<test_bundle_common.c.md#test_bundle_env_destroy>)


---
### test\_bundle\_header\_timeout<!-- {{#callable:test_bundle_header_timeout}} -->
[View Source →](<../../../../../src/disco/bundle/test_bundle_client.c#L258>)

Tests if a gRPC stream header timeout triggers a deferred reset in the client state.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for managing memory and resources.
- **Logic and Control Flow**:
    - Create a `test_bundle_env_t` environment and initialize it with [`test_bundle_env_create`](<test_bundle_common.c.md#test_bundle_env_create>) using the provided workspace `wksp`.
    - Mock a connection in the environment using [`test_bundle_env_mock_conn`](<test_bundle_common.c.md#test_bundle_env_mock_conn>).
    - Acquire a gRPC stream from the client with `fd_grpc_client_stream_acquire` and set its header status to 200, indicating a successful HTTP response.
    - Set the stream's `is_grpc_proto` flag to 1, indicating it is a gRPC protocol, and enable the header deadline with `has_header_deadline` set to 1 and `header_deadline_nanos` set to 99 nanoseconds.
    - Call `fd_grpc_client_service_streams` with a timeout of 100 nanoseconds to process the stream.
    - Verify that the `defer_reset` flag in the client state is set to 1, indicating a deferred reset due to the timeout.
    - Destroy the environment with [`test_bundle_env_destroy`](<test_bundle_common.c.md#test_bundle_env_destroy>) to clean up resources.
- **Output**: No return value; the function performs tests and assertions to verify behavior.
- **Functions Called**:
    - [`test_bundle_env_create`](<test_bundle_common.c.md#test_bundle_env_create>)
    - [`test_bundle_env_mock_conn`](<test_bundle_common.c.md#test_bundle_env_mock_conn>)
    - [`test_bundle_env_destroy`](<test_bundle_common.c.md#test_bundle_env_destroy>)


---
### test\_bundle\_rx\_end\_timeout<!-- {{#callable:test_bundle_rx_end_timeout}} -->
[View Source →](<../../../../../src/disco/bundle/test_bundle_client.c#L284>)

Tests the behavior of a gRPC client when a response stream ends due to a timeout.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for managing memory and resources.
- **Logic and Control Flow**:
    - Create a `test_bundle_env_t` environment and initialize it with [`test_bundle_env_create`](<test_bundle_common.c.md#test_bundle_env_create>) using the provided workspace.
    - Mock a connection in the environment using [`test_bundle_env_mock_conn`](<test_bundle_common.c.md#test_bundle_env_mock_conn>).
    - Acquire a gRPC stream from the client with `fd_grpc_client_stream_acquire` for the `FD_BUNDLE_CLIENT_REQ_Bundle_SubscribeBundles` request.
    - Set the stream's HTTP/2 status to 200 and mark it as a gRPC protocol stream.
    - Set the stream's `has_rx_end_deadline` flag to 1 and `rx_end_deadline_nanos` to 99L, indicating a deadline for receiving the end of the stream.
    - Call `fd_grpc_client_service_streams` with a time of 100L to simulate the passage of time and service the stream.
    - Check that the `defer_reset` flag in the state is set to 1, indicating that a reset is deferred due to the timeout.
    - Destroy the environment with [`test_bundle_env_destroy`](<test_bundle_common.c.md#test_bundle_env_destroy>).
- **Output**: No return value; the function performs tests and assertions to verify the behavior of the client.
- **Functions Called**:
    - [`test_bundle_env_create`](<test_bundle_common.c.md#test_bundle_env_create>)
    - [`test_bundle_env_mock_conn`](<test_bundle_common.c.md#test_bundle_env_mock_conn>)
    - [`test_bundle_env_destroy`](<test_bundle_common.c.md#test_bundle_env_destroy>)


---
### test\_bundle\_ping<!-- {{#callable:test_bundle_ping}} -->
[View Source →](<../../../../../src/disco/bundle/test_bundle_client.c#L308>)

Tests the ping functionality of a gRPC client, including transmission, acknowledgment, and timeout handling.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for managing memory and resources.
- **Logic and Control Flow**:
    - Initialize the test environment and mock connection using [`test_bundle_env_create`](<test_bundle_common.c.md#test_bundle_env_create>) and [`test_bundle_env_mock_conn`](<test_bundle_common.c.md#test_bundle_env_mock_conn>).
    - Set up initial ping transmission with [`fd_keepalive_tx`](<fd_keepalive.h.md#fd_keepalive_tx>) and verify initial conditions using `FD_TEST`.
    - Simulate a PING ACK by advancing the clock, pushing a PING ACK frame to the receive buffer, and calling [`fd_bundle_client_step`](<fd_bundle_client.c.md#fd_bundle_client_step>).
    - Verify that the PING ACK updates the keepalive timers and metrics correctly.
    - Test the transmission of a new PING by advancing the clock to the next transmission time and calling [`fd_bundle_client_step`](<fd_bundle_client.c.md#fd_bundle_client_step>).
    - Verify that the new PING is transmitted and the state is updated correctly.
    - Simulate a timeout by advancing the clock past the deadline and verify that a timeout is detected.
    - Call [`fd_bundle_client_step`](<fd_bundle_client.c.md#fd_bundle_client_step>) to handle the timeout, which should trigger a reset.
    - Destroy the test environment using [`test_bundle_env_destroy`](<test_bundle_common.c.md#test_bundle_env_destroy>).
- **Output**: No direct output; the function performs tests and uses assertions (`FD_TEST`) to validate behavior.
- **Functions Called**:
    - [`test_bundle_env_create`](<test_bundle_common.c.md#test_bundle_env_create>)
    - [`test_bundle_env_mock_conn`](<test_bundle_common.c.md#test_bundle_env_mock_conn>)
    - [`fd_keepalive_tx`](<fd_keepalive.h.md#fd_keepalive_tx>)
    - [`fd_keepalive_is_timeout`](<fd_keepalive.h.md#fd_keepalive_is_timeout>)
    - [`fd_keepalive_should_tx`](<fd_keepalive.h.md#fd_keepalive_should_tx>)
    - [`fd_bundle_client_step`](<fd_bundle_client.c.md#fd_bundle_client_step>)
    - [`test_bundle_env_destroy`](<test_bundle_common.c.md#test_bundle_env_destroy>)


---
### test\_bundle\_msg\_oversized<!-- {{#callable:test_bundle_msg_oversized}} -->
[View Source →](<../../../../../src/disco/bundle/test_bundle_client.c#L388>)

Checks the client's behavior when an oversized message is received and ensures the client resets the connection.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for managing memory and resources.
- **Logic and Control Flow**:
    - Initialize a `test_bundle_env_t` environment and create it using [`test_bundle_env_create`](<test_bundle_common.c.md#test_bundle_env_create>) with the provided workspace.
    - Mock a connection in the environment using [`test_bundle_env_mock_conn`](<test_bundle_common.c.md#test_bundle_env_mock_conn>).
    - Acquire a gRPC stream from the client using `fd_grpc_client_stream_acquire` with the request type `FD_BUNDLE_CLIENT_REQ_Bundle_SubscribeBundles`.
    - Set the stream's HTTP/2 status to 200 and mark it as a gRPC protocol.
    - Create a gRPC header with a message size set to the maximum unsigned short value, indicating an oversized message.
    - Verify that the bundle subscription is live using `FD_TEST`.
    - Invoke the `fd_grpc_client_h2_callbacks.data` callback to simulate receiving the oversized message.
    - Check that the bundle subscription is no longer live and that a reset is deferred using `FD_TEST`.
    - Destroy the environment using [`test_bundle_env_destroy`](<test_bundle_common.c.md#test_bundle_env_destroy>).
- **Output**: No return value; the function performs tests and assertions to verify behavior.
- **Functions Called**:
    - [`test_bundle_env_create`](<test_bundle_common.c.md#test_bundle_env_create>)
    - [`test_bundle_env_mock_conn`](<test_bundle_common.c.md#test_bundle_env_mock_conn>)
    - [`test_bundle_env_destroy`](<test_bundle_common.c.md#test_bundle_env_destroy>)


---
### test\_bundle\_keyswitch<!-- {{#callable:test_bundle_keyswitch}} -->
[View Source →](<../../../../../src/disco/bundle/test_bundle_client.c#L418>)

Tests the key switching functionality in a bundle environment and ensures the client resets after switching keys.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for memory allocation and management.
- **Logic and Control Flow**:
    - Create a `test_bundle_env_t` environment and initialize it with [`test_bundle_env_create`](<test_bundle_common.c.md#test_bundle_env_create>) using the provided workspace `wksp`.
    - Mock a connection in the environment using [`test_bundle_env_mock_conn`](<test_bundle_common.c.md#test_bundle_env_mock_conn>).
    - Allocate memory for the keyswitch using `fd_wksp_alloc_laddr` and check if the allocation is successful with `FD_TEST`.
    - Initialize the keyswitch state to `FD_KEYSWITCH_STATE_UNLOCKED` and join it to the environment's state.
    - Set the public key in the environment's state to zero using `memset`.
    - Call [`fd_bundle_tile_housekeeping`](<fd_bundle_tile.c.md#fd_bundle_tile_housekeeping>) to perform housekeeping tasks and verify that no key switch occurs by checking `state->defer_reset`.
    - Change the keyswitch state to `FD_KEYSWITCH_STATE_SWITCH_PENDING` and modify the first byte of the keyswitch's bytes to `0x01`.
    - Call [`fd_bundle_tile_housekeeping`](<fd_bundle_tile.c.md#fd_bundle_tile_housekeeping>) again to trigger the key switch and verify that `state->defer_reset` is set and the first byte of the public key is `0x01`.
    - Destroy the environment using [`test_bundle_env_destroy`](<test_bundle_common.c.md#test_bundle_env_destroy>) and free the allocated keyswitch memory with `fd_wksp_free_laddr`.
- **Output**: No output is returned as the function is void, but it performs tests and assertions to verify the correct behavior of key switching in the environment.
- **Functions Called**:
    - [`test_bundle_env_create`](<test_bundle_common.c.md#test_bundle_env_create>)
    - [`test_bundle_env_mock_conn`](<test_bundle_common.c.md#test_bundle_env_mock_conn>)
    - [`fd_bundle_tile_housekeeping`](<fd_bundle_tile.c.md#fd_bundle_tile_housekeeping>)
    - [`test_bundle_env_destroy`](<test_bundle_common.c.md#test_bundle_env_destroy>)


---
### test\_bundle\_client\_status<!-- {{#callable:test_bundle_client_status}} -->
[View Source →](<../../../../../src/disco/bundle/test_bundle_client.c#L445>)

Verifies the status of a bundle client by testing various conditions and restoring the state after each test.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for testing.
- **Logic and Control Flow**:
    - Create a test environment using [`test_bundle_env_create`](<test_bundle_common.c.md#test_bundle_env_create>) and mock a connection with [`test_bundle_env_mock_conn`](<test_bundle_common.c.md#test_bundle_env_mock_conn>).
    - Backup the current state of `fd_bundle_tile_t` and `fd_grpc_client_t`.
    - Test the client status when the TCP socket is disconnected, expecting a status of 0.
    - Iterate over `conn_dead_flags` to test client status when connection flags indicate a dead connection, expecting a status of 0.
    - Iterate over `conn_prog_flags` to test client status when connection flags indicate progress, expecting a status of 1.
    - Test the client status for different authentication states, expecting a status of 1 when not in `FD_BUNDLE_AUTH_STATE_DONE_WAIT`.
    - Test the client status when `builder_info_avail` is 0, expecting a status of 1.
    - Test the client status when `packet_subscription_live` is 0, expecting a status of 1.
    - Test the client status when `bundle_subscription_live` is 0, expecting a status of 1.
    - Test the client status when `keepalive->inflight` is 1 and `ts_deadline` is past, expecting a status of 0.
    - Test the client status when `grpc_client->h2_hs_done` is 0, expecting a status of 1.
    - Restore the state after each test using the backups.
    - Destroy the test environment using [`test_bundle_env_destroy`](<test_bundle_common.c.md#test_bundle_env_destroy>).
- **Output**: No output is returned; the function performs tests and assertions to verify client status.
- **Functions Called**:
    - [`test_bundle_env_create`](<test_bundle_common.c.md#test_bundle_env_create>)
    - [`test_bundle_env_mock_conn`](<test_bundle_common.c.md#test_bundle_env_mock_conn>)
    - [`fd_bundle_client_status`](<fd_bundle_client.c.md#fd_bundle_client_status>)
    - [`test_bundle_env_destroy`](<test_bundle_common.c.md#test_bundle_env_destroy>)


---
### test\_bundle\_client\_reset<!-- {{#callable:test_bundle_client_reset}} -->
[View Source →](<../../../../../src/disco/bundle/test_bundle_client.c#L526>)

Tests the reset functionality of a bundle client by verifying the initial and post-reset states of various client parameters.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for managing memory and resources.
- **Logic and Control Flow**:
    - Create a `test_bundle_env_t` environment and initialize it with [`test_bundle_env_create`](<test_bundle_common.c.md#test_bundle_env_create>) using the provided workspace `wksp`.
    - Mock a connection in the environment using [`test_bundle_env_mock_conn`](<test_bundle_common.c.md#test_bundle_env_mock_conn>).
    - Retrieve the client state from the environment's `state` field.
    - Perform a series of assertions (`FD_TEST`) to verify the initial state of the client, checking parameters like `tcp_sock`, `tcp_sock_connected`, `defer_reset`, `builder_info_avail`, and others.
    - Call [`fd_bundle_client_reset`](<fd_bundle_client.c.md#fd_bundle_client_reset>) to reset the client state.
    - Perform another series of assertions to verify the state of the client after the reset, ensuring that parameters have been reset to expected values.
    - Destroy the environment using [`test_bundle_env_destroy`](<test_bundle_common.c.md#test_bundle_env_destroy>) to clean up resources.
- **Output**: No return value; the function performs assertions to validate the reset behavior of the client state.
- **Functions Called**:
    - [`test_bundle_env_create`](<test_bundle_common.c.md#test_bundle_env_create>)
    - [`test_bundle_env_mock_conn`](<test_bundle_common.c.md#test_bundle_env_mock_conn>)
    - [`fd_bundle_client_reset`](<fd_bundle_client.c.md#fd_bundle_client_reset>)
    - [`test_bundle_env_destroy`](<test_bundle_common.c.md#test_bundle_env_destroy>)


---
### expect\_h2\_hdr<!-- {{#callable:expect_h2_hdr}} -->
[View Source →](<../../../../../src/disco/bundle/test_bundle_client.c#L572>)

Validates and processes an HTTP/2 header frame from a buffer, ensuring it matches expected header names and values.
- **Inputs**:
    - ``rbuf``: A pointer to an `fd_h2_rbuf_t` structure representing the buffer from which the HTTP/2 frame is read.
    - ``stream_id``: An unsigned long integer representing the expected stream ID of the HTTP/2 frame.
    - ``pstr``: A pointer to a constant array of strings, where each pair of strings represents an expected header name and value.
- **Logic and Control Flow**:
    - Initialize a `fd_h2_frame_hdr_t` structure to store the frame header.
    - Check if the buffer has enough data for a frame header and copy the header from the buffer.
    - Verify the frame type is `FD_H2_FRAME_TYPE_HEADERS` and the stream ID matches the expected `stream_id`.
    - Ensure the frame has the `FD_H2_FLAG_END_HEADERS` flag set.
    - Calculate the frame body size and verify the buffer has enough data for the frame body.
    - Copy the frame body from the buffer into a local array.
    - Initialize an `fd_hpack_rd_t` structure for reading HPACK-encoded headers from the frame body.
    - Iterate over the expected header name-value pairs, reading each header from the frame body and verifying it matches the expected name and value.
    - Ensure all headers have been read from the frame body.
- **Output**: No explicit output; the function uses assertions to validate the headers and will terminate if any validation fails.


---
### test\_bundle\_client\_request\_builder\_fee\_info<!-- {{#callable:test_bundle_client_request_builder_fee_info}} -->
[View Source →](<../../../../../src/disco/bundle/test_bundle_client.c#L612>)

Tests the process of requesting and handling builder fee information in a gRPC client environment.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for managing memory and resources.
- **Logic and Control Flow**:
    - Initialize the test environment and mock a connection using [`test_bundle_env_create`](<test_bundle_common.c.md#test_bundle_env_create>) and [`test_bundle_env_mock_conn`](<test_bundle_common.c.md#test_bundle_env_mock_conn>).
    - Set `state->builder_info_avail` to 0 and verify `state->builder_info_wait` is 0, indicating no builder info is available and no wait is in progress.
    - Check if the gRPC client request is blocked due to stream count limits and adjust `max_concurrent_streams` to unblock it.
    - Call [`fd_bundle_client_step`](<fd_bundle_client.c.md#fd_bundle_client_step>) to process the client state and verify `state->builder_info_wait` is set to 1, indicating a request is in progress.
    - Verify the creation of a new stream and check the request context is set to `FD_BUNDLE_CLIENT_REQ_Bundle_GetBlockBuilderFeeInfo`.
    - Send a request header and body using [`expect_h2_hdr`](<#expect_h2_hdr>) and verify the request is correctly formatted and sent.
    - Inject a response and encode a Protobuf message using `pb_encode`, simulating different scenarios (invalid Base58, invalid commission, valid response).
    - Verify the state transitions based on the response, ensuring `state->builder_info_avail` and `state->builder_info_wait` are updated correctly.
    - End the stream with a successful gRPC response and verify `state->builder_info_wait` is reset to 0.
    - Destroy the test environment using [`test_bundle_env_destroy`](<test_bundle_common.c.md#test_bundle_env_destroy>).
- **Output**: No direct output; the function performs tests and assertions to verify correct behavior.
- **Functions Called**:
    - [`test_bundle_env_create`](<test_bundle_common.c.md#test_bundle_env_create>)
    - [`test_bundle_env_mock_conn`](<test_bundle_common.c.md#test_bundle_env_mock_conn>)
    - [`fd_bundle_client_step`](<fd_bundle_client.c.md#fd_bundle_client_step>)
    - [`expect_h2_hdr`](<#expect_h2_hdr>)
    - [`fd_bundle_client_grpc_rx_start`](<fd_bundle_client.c.md#fd_bundle_client_grpc_rx_start>)
    - [`fd_bundle_client_grpc_rx_msg`](<fd_bundle_client.c.md#fd_bundle_client_grpc_rx_msg>)
    - [`fd_bundle_client_grpc_rx_end`](<fd_bundle_client.c.md#fd_bundle_client_grpc_rx_end>)
    - [`test_bundle_env_destroy`](<test_bundle_common.c.md#test_bundle_env_destroy>)


---
### test\_bundle\_client\_subscribe\_packets<!-- {{#callable:test_bundle_client_subscribe_packets}} -->
[View Source →](<../../../../../src/disco/bundle/test_bundle_client.c#L724>)

Subscribes a gRPC client to packet streams by managing stream counts and sending appropriate HTTP/2 headers and data.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for managing memory and resources.
- **Logic and Control Flow**:
    - Initialize the test environment and mock connection using [`test_bundle_env_create`](<test_bundle_common.c.md#test_bundle_env_create>) and [`test_bundle_env_mock_conn`](<test_bundle_common.c.md#test_bundle_env_mock_conn>).
    - Set `packet_subscription_live` to 0 and verify `packet_subscription_wait` is 0.
    - Check if the gRPC client request is blocked due to stream count and set `max_concurrent_streams` to 2 to simulate blocking.
    - Call [`fd_bundle_client_step`](<fd_bundle_client.c.md#fd_bundle_client_step>) to process the client state and verify `packet_subscription_wait` remains 0.
    - Unblock the request by setting `max_concurrent_streams` to 3 and call [`fd_bundle_client_step`](<fd_bundle_client.c.md#fd_bundle_client_step>) again to verify `packet_subscription_wait` becomes 1.
    - Verify that a new stream is created and the request context is set to `FD_BUNDLE_CLIENT_REQ_Bundle_SubscribePackets`.
    - Send HTTP/2 headers and data for the subscription request using [`expect_h2_hdr`](<#expect_h2_hdr>) and verify the request body is correctly formatted.
    - Inject a response to simulate server interaction and verify `packet_subscription_wait` is reset to 0.
    - Destroy the test environment using [`test_bundle_env_destroy`](<test_bundle_common.c.md#test_bundle_env_destroy>).
- **Output**: No return value; the function operates on the state of the `fd_bundle_tile_t` and `fd_grpc_client_t` structures within the test environment.
- **Functions Called**:
    - [`test_bundle_env_create`](<test_bundle_common.c.md#test_bundle_env_create>)
    - [`test_bundle_env_mock_conn`](<test_bundle_common.c.md#test_bundle_env_mock_conn>)
    - [`fd_bundle_client_step`](<fd_bundle_client.c.md#fd_bundle_client_step>)
    - [`expect_h2_hdr`](<#expect_h2_hdr>)
    - [`fd_bundle_client_grpc_rx_start`](<fd_bundle_client.c.md#fd_bundle_client_grpc_rx_start>)
    - [`test_bundle_env_destroy`](<test_bundle_common.c.md#test_bundle_env_destroy>)


---
### test\_bundle\_client\_subscribe\_bundles<!-- {{#callable:test_bundle_client_subscribe_bundles}} -->
[View Source →](<../../../../../src/disco/bundle/test_bundle_client.c#L793>)

Subscribes to bundles by managing gRPC client streams and handling request and response headers.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for managing memory and resources.
- **Logic and Control Flow**:
    - Initialize a `test_bundle_env_t` environment and create a mock connection.
    - Set `bundle_subscription_live` to 0 and verify `bundle_subscription_wait` is 0.
    - Check if the gRPC client request is blocked due to stream count and verify the stream count is 2.
    - Set `max_concurrent_streams` to 2 and verify the request is blocked.
    - Call [`fd_bundle_client_step`](<fd_bundle_client.c.md#fd_bundle_client_step>) to process the client state and verify `bundle_subscription_wait` remains 0.
    - Increase `max_concurrent_streams` to 3 to unblock the request and call [`fd_bundle_client_step`](<fd_bundle_client.c.md#fd_bundle_client_step>) again, verifying `bundle_subscription_wait` is now 1.
    - Verify that a new stream is created and the request context is set to `FD_BUNDLE_CLIENT_REQ_Bundle_SubscribeBundles`.
    - Check the request header using [`expect_h2_hdr`](<#expect_h2_hdr>) to ensure it matches the expected gRPC headers.
    - Verify the request body is correctly formatted and sent with the appropriate flags.
    - Inject a response to simulate receiving a response from the server and verify `bundle_subscription_wait` is set to 0.
    - Destroy the `test_bundle_env_t` environment to clean up resources.
- **Output**: No return value; the function operates on the provided workspace and manages internal state.
- **Functions Called**:
    - [`test_bundle_env_create`](<test_bundle_common.c.md#test_bundle_env_create>)
    - [`test_bundle_env_mock_conn`](<test_bundle_common.c.md#test_bundle_env_mock_conn>)
    - [`fd_bundle_client_step`](<fd_bundle_client.c.md#fd_bundle_client_step>)
    - [`expect_h2_hdr`](<#expect_h2_hdr>)
    - [`fd_bundle_client_grpc_rx_start`](<fd_bundle_client.c.md#fd_bundle_client_grpc_rx_start>)
    - [`test_bundle_env_destroy`](<test_bundle_common.c.md#test_bundle_env_destroy>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/disco/bundle/test_bundle_client.c#L860>)

Initializes the environment, processes command-line arguments, runs a series of tests on a workspace, checks for memory leaks, and then cleans up.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of strings representing the command-line arguments.
- **Logic and Control Flow**:
    - Call `fd_boot` to initialize the environment with command-line arguments.
    - Determine the CPU index using `fd_tile_cpu_id` and `fd_tile_idx`, and adjust if it exceeds the shared memory CPU count.
    - Extract command-line arguments for page size, page count, and NUMA index using `fd_env_strip_cmdline_cstr` and `fd_env_strip_cmdline_ulong`.
    - Create a new anonymous workspace with `fd_wksp_new_anonymous` using the extracted parameters.
    - Verify the workspace creation with `FD_TEST`.
    - Execute a series of test functions ([`test_bundle_rx`](<#test_bundle_rx>), [`test_bundle_rx_too_many_txns`](<#test_bundle_rx_too_many_txns>), etc.) on the workspace.
    - Check for memory leaks by calling `fd_wksp_usage` and verify with `FD_TEST` that free and total counts match.
    - Delete the anonymous workspace with `fd_wksp_delete_anonymous`.
    - Log a notice message indicating success and call `fd_halt` to terminate the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`test_bundle_rx`](<#test_bundle_rx>)
    - [`test_bundle_rx_too_many_txns`](<#test_bundle_rx_too_many_txns>)
    - [`test_bundle_stream_ended`](<#test_bundle_stream_ended>)
    - [`test_bundle_stream_reset`](<#test_bundle_stream_reset>)
    - [`test_bundle_header_timeout`](<#test_bundle_header_timeout>)
    - [`test_bundle_rx_end_timeout`](<#test_bundle_rx_end_timeout>)
    - [`test_bundle_ping`](<#test_bundle_ping>)
    - [`test_bundle_msg_oversized`](<#test_bundle_msg_oversized>)
    - [`test_bundle_keyswitch`](<#test_bundle_keyswitch>)
    - [`test_bundle_client_status`](<#test_bundle_client_status>)
    - [`test_bundle_client_reset`](<#test_bundle_client_reset>)
    - [`test_bundle_no_builder_fee_info`](<#test_bundle_no_builder_fee_info>)
    - [`test_bundle_client_request_builder_fee_info`](<#test_bundle_client_request_builder_fee_info>)
    - [`test_bundle_client_subscribe_packets`](<#test_bundle_client_subscribe_packets>)
    - [`test_bundle_client_subscribe_bundles`](<#test_bundle_client_subscribe_bundles>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)