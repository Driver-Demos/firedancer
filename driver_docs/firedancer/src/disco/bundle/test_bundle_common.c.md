<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Utilities for creating and managing a mock bundle topology for testing purposes.

# Purpose
The code defines a test environment for a mock bundle topology, primarily used for testing purposes. It includes the definition of a structure `test_bundle_env_t` that encapsulates various components such as a fake stem context, memory caches, and a server socket. The function [`test_bundle_env_create`](<#test_bundle_env_create>) initializes this environment by setting up memory caches, a fake stem context, and a gRPC client. It also configures keepalive settings and initializes random number generation for the test environment. The code uses several utility functions to simulate different states and interactions within the test environment, such as establishing mock connections, handling gRPC streams, and managing builder information.

The code is structured to facilitate testing of bundle-related functionalities by simulating network connections and gRPC communications. It includes functions to create and destroy the test environment, as well as to simulate various states and conditions that might occur during the operation of a bundle system. The functions [`test_bundle_env_mock_conn_empty`](<#test_bundle_env_mock_conn_empty>), [`test_bundle_env_mock_h2_hs`](<#test_bundle_env_mock_h2_hs>), and others are used to simulate specific scenarios, such as establishing a connection or handling gRPC handshake completion. The code is intended to be part of a larger test suite, providing a controlled environment to verify the behavior of bundle-related components without requiring actual network interactions.
# Imports and Dependencies

---
- `../fd_txn_m.h`
- `fd_bundle_auth.h`
- `fd_bundle_tile_private.h`
- `../../waltz/grpc/fd_grpc_client_private.h`
- `sys/socket.h`
- `unistd.h`


# Data Structures

---
### test\_bundle\_env
- **Type**: ``struct``
- **Members**:
    - `stem`: An array of `fd_stem_context_t` representing the stem context.
    - `stem_seqs`: An array of `ulong` representing sequence numbers for the stem.
    - `stem_depths`: An array of `ulong` representing depths for the stem.
    - `stem_cr_avail`: An array of `ulong` representing available credits for the stem.
    - `stem_min_cr_avail`: An array of `ulong` representing minimum available credits for the stem.
    - `out_mcache`: A pointer to `fd_frag_meta_t` representing the output metadata cache.
    - `out_dcache`: A pointer to `uchar` representing the output data cache.
    - `server_sock`: An integer representing the server socket.
    - `state`: An array of `fd_bundle_tile_t` representing the state of the bundle tile.
- **Description**: The `test_bundle_env` structure is used to create a mock bundle topology, containing various fields for managing stem contexts, metadata and data caches, server socket, and bundle tile state. It is initialized and manipulated through functions to simulate network and data processing environments.


---
### test\_bundle\_env\_t
- **Type**: ``struct``
- **Members**:
    - ``stem``: An array of `fd_stem_context_t` structures, each representing a stem context.
    - ``stem_seqs``: An array of unsigned long integers representing sequence numbers for stems.
    - ``stem_depths``: An array of unsigned long integers representing the depth of each stem.
    - ``stem_cr_avail``: An array of unsigned long integers representing the available credit for each stem.
    - ``stem_min_cr_avail``: An array of unsigned long integers representing the minimum available credit for each stem.
    - ``out_mcache``: A pointer to `fd_frag_meta_t`, representing the output metadata cache.
    - ``out_dcache``: A pointer to an unsigned character array, representing the output data cache.
    - ``server_sock``: An integer representing the server socket file descriptor.
    - ``state``: An array of `fd_bundle_tile_t` structures, representing the state of the bundle tile.
- **Description**: The `test_bundle_env_t` structure is used to create a mock bundle topology for testing purposes. It contains various fields to manage stem contexts, sequence numbers, depths, and available credits. It also includes pointers to metadata and data caches, a server socket descriptor, and a state array for managing bundle tile states. This structure is essential for simulating and testing bundle environments in a controlled manner.


# Functions

---
### test\_bundle\_env\_create<!-- {{#callable:test_bundle_env_create}} -->
[View Source →](<../../../../../src/disco/bundle/test_bundle_common.c#L25>)

Initializes a `test_bundle_env_t` structure with mock data and resources for testing purposes.
- **Inputs**:
    - `env`: A pointer to a `test_bundle_env_t` structure to initialize.
    - `wksp`: A pointer to a `fd_wksp_t` workspace used for memory allocation.
- **Logic and Control Flow**:
    - Set all bytes in `env` to zero using `fd_memset`.
    - Define `mcache_depth` as 128 and allocate memory for `mcache` using `fd_mcache_new` and `fd_mcache_join`.
    - Check if `mcache` is successfully allocated using `FD_TEST`.
    - Define `mtu` and calculate `dcache_data_sz` using `fd_dcache_req_data_sz`.
    - Allocate memory for `dcache` using `fd_dcache_new` and `fd_dcache_join`.
    - Check if `dcache` is successfully allocated using `FD_TEST`.
    - Initialize `env` fields with mock data, including `out_mcache`, `out_dcache`, and `stem` context.
    - Set `server_sock` to -1.
    - Initialize `state` fields in `env`, including `verify_out`, `tcp_sock`, `grpc_buf_max`, and `grpc_client`.
    - Set `h2_conn` flags to 0.
    - Initialize random number generator `rng` in `state` using `fd_rng_new`.
    - Define `ka_interval` and `ka_timeout`, and get current time `now` using `fd_bundle_now`.
    - Initialize `keepalive` in `state` using [`fd_keepalive_init`](<fd_keepalive.h.md#fd_keepalive_init>) and check its `ts_next_tx` value.
    - Return the initialized `env` structure.
- **Output**: A pointer to the initialized `test_bundle_env_t` structure.
- **Functions Called**:
    - [`fd_keepalive_init`](<fd_keepalive.h.md#fd_keepalive_init>)


---
### test\_bundle\_env\_mock\_conn\_empty<!-- {{#callable:test_bundle_env_mock_conn_empty}} -->
[View Source →](<../../../../../src/disco/bundle/test_bundle_common.c#L87>)

Initializes a mock connection environment for testing by setting up random number generation, connection states, and socket pairs.
- **Inputs**:
    - `env`: A pointer to a `test_bundle_env_t` structure that holds the environment state for the test.
- **Logic and Control Flow**:
    - Retrieve the `fd_bundle_tile_t` context from the `env` structure.
    - Get the current timestamp using `fd_bundle_now()` and store it in `ts_start`.
    - Initialize the random number generator in the context with fixed seed values using `fd_rng_new()`.
    - Set the `tcp_sock_connected` flag to 1, indicating a connected state.
    - Set the `auther.state` to `FD_BUNDLE_AUTH_STATE_DONE_WAIT`.
    - Update the `keepalive` timestamps (`ts_last_tx` and `ts_last_rx`) to the current timestamp `ts_start`.
    - Reinitialize the random number generator with the same fixed seed values.
    - Check that the keepalive mechanism does not indicate a timeout or the need to transmit using `FD_TEST` assertions.
    - Create a UNIX domain socket pair using `socketpair()` and store the file descriptors in `sockpair`.
    - Assign the first socket in the pair to `env->server_sock` and the second to `ctx->tcp_sock`.
- **Output**: No return value; the function modifies the `env` structure in place.
- **Functions Called**:
    - [`fd_keepalive_is_timeout`](<fd_keepalive.h.md#fd_keepalive_is_timeout>)
    - [`fd_keepalive_should_tx`](<fd_keepalive.h.md#fd_keepalive_should_tx>)


---
### test\_bundle\_env\_mock\_h2\_hs<!-- {{#callable:test_bundle_env_mock_h2_hs}} -->
[View Source →](<../../../../../src/disco/bundle/test_bundle_common.c#L106>)

Sets the gRPC client's HTTP/2 handshake as done and verifies that the client is not blocked and the tile should not stall.
- **Inputs**:
    - `ctx`: A pointer to an `fd_bundle_tile_t` structure representing the context of the bundle tile.
- **Logic and Control Flow**:
    - Set the `h2_hs_done` flag of the gRPC client in `ctx` to 1, indicating the HTTP/2 handshake is complete.
    - Verify that the gRPC client request is not blocked using `FD_TEST` and `fd_grpc_client_request_is_blocked`.
    - Get the current timestamp using `fd_bundle_now` and store it in `ts_start`.
    - Verify that the bundle tile should not stall using `FD_TEST` and [`fd_bundle_tile_should_stall`](<fd_bundle_tile_private.h.md#fd_bundle_tile_should_stall>).
- **Output**: No output is returned.
- **Functions Called**:
    - [`fd_bundle_tile_should_stall`](<fd_bundle_tile_private.h.md#fd_bundle_tile_should_stall>)


---
### test\_bundle\_env\_mock\_builder\_info<!-- {{#callable:test_bundle_env_mock_builder_info}} -->
[View Source →](<../../../../../src/disco/bundle/test_bundle_common.c#L114>)

Sets the builder information availability and validity period in the context.
- **Inputs**:
    - `ctx`: A pointer to an `fd_bundle_tile_t` structure that holds the context for the bundle environment.
- **Logic and Control Flow**:
    - Set `ctx->builder_info_avail` to 1, indicating that builder information is available.
    - Set `ctx->builder_info_valid_until` to the current time plus 5 minutes, indicating the validity period of the builder information.
- **Output**: No return value; the function modifies the `ctx` structure in place.


---
### test\_bundle\_env\_mock\_builder\_info\_req<!-- {{#callable:test_bundle_env_mock_builder_info_req}} -->
[View Source →](<../../../../../src/disco/bundle/test_bundle_common.c#L121>)

Sets the builder information wait flag and initializes a gRPC stream for block builder fee information.
- **Inputs**:
    - `ctx`: A pointer to an `fd_bundle_tile_t` structure that holds the context for the bundle environment.
- **Logic and Control Flow**:
    - Set `ctx->builder_info_wait` to 1 to indicate that the builder information is being awaited.
    - Acquire a gRPC stream using `fd_grpc_client_stream_acquire` with the request type `FD_BUNDLE_CLIENT_REQ_Bundle_GetBlockBuilderFeeInfo`.
    - Verify that the stream acquisition is successful using `FD_TEST`.
    - Set the HTTP/2 status of the stream to 200, indicating success.
    - Set the `is_grpc_proto` flag of the stream headers to 1, indicating that the protocol is gRPC.
- **Output**: No return value; modifies the `ctx` structure in place.


---
### test\_bundle\_env\_mock\_bundle\_stream<!-- {{#callable:test_bundle_env_mock_bundle_stream}} -->
[View Source →](<../../../../../src/disco/bundle/test_bundle_common.c#L131>)

Sets up a mock gRPC stream for bundle subscription in the given context.
- **Inputs**:
    - `ctx`: A pointer to an `fd_bundle_tile_t` structure representing the context in which to set up the mock bundle stream.
- **Logic and Control Flow**:
    - Sets the `bundle_subscription_live` field of `ctx` to 1, indicating that the bundle subscription is active.
    - Acquires a gRPC stream using `fd_grpc_client_stream_acquire` with the request type `FD_BUNDLE_CLIENT_REQ_Bundle_SubscribeBundles`.
    - Checks if the stream acquisition was successful using `FD_TEST`.
    - Sets the `h2_status` of the stream headers to 200, indicating a successful HTTP/2 status.
    - Sets the `is_grpc_proto` field of the stream headers to 1, indicating that the stream uses the gRPC protocol.
- **Output**: No return value; the function modifies the `ctx` structure in place.


---
### test\_bundle\_env\_mock\_packet\_stream<!-- {{#callable:test_bundle_env_mock_packet_stream}} -->
[View Source →](<../../../../../src/disco/bundle/test_bundle_common.c#L141>)

Sets up a mock packet stream subscription in a gRPC client context.
- **Inputs**:
    - ``ctx``: A pointer to an `fd_bundle_tile_t` structure representing the context for the bundle tile.
- **Logic and Control Flow**:
    - Sets the `packet_subscription_live` field of the `ctx` structure to 1, indicating that the packet subscription is active.
    - Acquires a gRPC stream using `fd_grpc_client_stream_acquire` with the request type `FD_BUNDLE_CLIENT_REQ_Bundle_SubscribePackets`.
    - Checks if the stream acquisition was successful using `FD_TEST`.
    - Sets the `h2_status` of the stream headers to 200, indicating a successful HTTP/2 status.
    - Sets the `is_grpc_proto` field of the stream headers to 1, indicating that the protocol is gRPC.
- **Output**: No return value; the function modifies the `ctx` structure in place.


---
### test\_bundle\_env\_mock\_conn<!-- {{#callable:test_bundle_env_mock_conn}} -->
[View Source →](<../../../../../src/disco/bundle/test_bundle_common.c#L151>)

Initializes a mock connection environment for testing a bundle environment.
- **Inputs**:
    - ``env``: A pointer to a `test_bundle_env_t` structure representing the test environment to initialize.
- **Logic and Control Flow**:
    - Calls [`test_bundle_env_mock_conn_empty`](<#test_bundle_env_mock_conn_empty>) to initialize the environment with default values.
    - Retrieves the `state` from the `env` and assigns it to `ctx`.
    - Calls [`test_bundle_env_mock_h2_hs`](<#test_bundle_env_mock_h2_hs>) to simulate an HTTP/2 handshake.
    - Calls [`test_bundle_env_mock_builder_info`](<#test_bundle_env_mock_builder_info>) to set builder information.
    - Calls [`test_bundle_env_mock_bundle_stream`](<#test_bundle_env_mock_bundle_stream>) to simulate a bundle subscription stream.
    - Calls [`test_bundle_env_mock_packet_stream`](<#test_bundle_env_mock_packet_stream>) to simulate a packet subscription stream.
    - Asserts that the bundle client status is 2 using `FD_TEST`.
    - Asserts that the free size of the HTTP/2 buffer is at least 2048 bytes using `FD_TEST`.
- **Output**: No return value; the function modifies the `env` structure in place.
- **Functions Called**:
    - [`test_bundle_env_mock_conn_empty`](<#test_bundle_env_mock_conn_empty>)
    - [`test_bundle_env_mock_h2_hs`](<#test_bundle_env_mock_h2_hs>)
    - [`test_bundle_env_mock_builder_info`](<#test_bundle_env_mock_builder_info>)
    - [`test_bundle_env_mock_bundle_stream`](<#test_bundle_env_mock_bundle_stream>)
    - [`test_bundle_env_mock_packet_stream`](<#test_bundle_env_mock_packet_stream>)
    - [`fd_bundle_client_status`](<fd_bundle_client.c.md#fd_bundle_client_status>)


---
### test\_bundle\_env\_destroy<!-- {{#callable:test_bundle_env_destroy}} -->
[View Source →](<../../../../../src/disco/bundle/test_bundle_common.c#L165>)

Releases resources and resets the `test_bundle_env_t` environment structure.
- **Inputs**:
    - `env`: A pointer to a `test_bundle_env_t` structure that holds the environment to be destroyed.
- **Logic and Control Flow**:
    - Check if `env` is not NULL and `env->server_sock` is valid (>=0).
    - If valid, close `env->server_sock` and set it to -1.
    - Check if `env` is not NULL and `env->state->tcp_sock` is valid (>=0).
    - If valid, close `env->state->tcp_sock` and set it to -1.
    - Free the memory associated with `env->out_mcache` using `fd_mcache_leave` and `fd_mcache_delete`.
    - Free the memory associated with `env->out_dcache` using `fd_dcache_leave` and `fd_dcache_delete`.
    - Free the memory associated with `env->state->grpc_client_mem`.
    - Reset the memory of `env` to zero using `fd_memset`.
- **Output**: No return value; the function operates directly on the `env` structure to release resources and reset its state.



---
Made with ❤️ by [Driver](https://www.driver.ai/)