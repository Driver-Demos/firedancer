<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functionality for managing and monitoring bundle tiles, including metrics and network operations.

# Purpose
The code is a C source file that defines a module for managing a "bundle tile" in a distributed system. It includes various functionalities related to network communication, metrics collection, and security. The module interacts with several components, such as metrics, topology, keyguard, and plugins, which are included through header files. It also uses system libraries for networking and file operations.

The module defines several static functions for internal operations, such as [`scratch_align`](<#scratch_align>), [`scratch_footprint`](<#scratch_footprint>), and [`loose_footprint`](<#loose_footprint>), which calculate memory alignment and footprint requirements. It also includes functions for writing metrics, handling housekeeping tasks, and publishing updates to a block engine. The code manages network connections, including parsing URLs and handling SSL/TLS connections using OpenSSL. It initializes and configures various components, such as gRPC clients and keyguard clients, and sets up security policies using seccomp. The module is part of a larger system, as indicated by its integration with other components and its role in managing a specific type of tile within a topology.
# Imports and Dependencies

---
- `fd_bundle_tile_private.h`
- `../metrics/fd_metrics.h`
- `../topo/fd_topo.h`
- `../keyguard/fd_keyload.h`
- `../plugin/fd_plugin.h`
- `../../waltz/http/fd_url.h`
- `errno.h`
- `dirent.h`
- `stdio.h`
- `fcntl.h`
- `unistd.h`
- `sys/mman.h`
- `sys/uio.h`
- `netinet/in.h`
- `netinet/tcp.h`
- `../../waltz/resolv/fd_netdb.h`
- `generated/fd_bundle_tile_seccomp.h`
- `../stem/fd_stem.c`


# Global Variables

---
### fdctl\_version\_string
- **Type**: ``char const[]``
- **Description**: Contains the version string for the `fdctl` component of the software. This string is defined in the `version.c` file of the `fdctl/firedancer` module.
- **Use**: Used to set the version information in the gRPC client within the `unprivileged_init` function.


---
### fd\_quic\_ssl\_mem\_function\_ctx
- **Type**: ``fd_alloc_t *``
- **Description**: A thread-local pointer to a memory allocation context used for custom memory allocation functions in OpenSSL. It is initialized to `NULL` and is set to point to an `fd_alloc_t` instance during the initialization of OpenSSL-related components.
- **Use**: Used to store the memory allocation context for OpenSSL's custom memory allocation functions.


---
### fd\_tile\_bundle
- **Type**: ``fd_topo_run_tile_t``
- **Description**: Represents a configuration structure for a tile in a topology. It includes function pointers for initialization, security, and execution, as well as configuration parameters like resource limits and networking permissions.
- **Use**: Used to define and manage the behavior and resources of a tile within a topology.


# Functions

---
### scratch\_align<!-- {{#callable:scratch_align}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_tile.c#L25>)

Returns the alignment requirement of the `fd_bundle_tile_t` type.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls the `alignof` operator on `fd_bundle_tile_t` to determine its alignment requirement.
    - Returns the result of the `alignof` operation.
- **Output**: The function returns an `ulong` representing the alignment requirement of the `fd_bundle_tile_t` type.


---
### scratch\_footprint<!-- {{#callable:scratch_footprint}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_tile.c#L30>)

Calculates the memory footprint required for a tile's scratch space.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure representing the tile for which the scratch space footprint is calculated.
- **Logic and Control Flow**:
    - Initialize `l` with `FD_LAYOUT_INIT`.
    - Append the size and alignment of `fd_bundle_tile_t` to `l` using `FD_LAYOUT_APPEND`.
    - Append the alignment and footprint of a gRPC client, calculated with `fd_grpc_client_align()` and `fd_grpc_client_footprint(tile->bundle.buf_sz)`, to `l`.
    - Append the alignment and footprint of an allocator, calculated with `fd_alloc_align()` and `fd_alloc_footprint()`, to `l`.
    - Finalize the layout with `FD_LAYOUT_FINI(l, 32)` and return the result.
- **Output**: Returns an `ulong` representing the total memory footprint required for the tile's scratch space.


---
### loose\_footprint<!-- {{#callable:loose_footprint}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_tile.c#L40>)

Returns a constant value representing 64 MiB of space for OpenSSL allocations.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure, which is not used in the function.
- **Logic and Control Flow**:
    - The function takes a single argument `tile`, which is not used in the function body.
    - The function returns a constant value `1UL<<26`, which is equivalent to 64 MiB.
- **Output**: A constant unsigned long integer value representing 64 MiB.


---
### metrics\_write<!-- {{#callable:metrics_write}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_tile.c#L47>)

Updates various metrics and status information for a given context.
- **Inputs**:
    - `ctx`: A pointer to a `fd_bundle_tile_t` structure containing metrics and status information to update.
- **Logic and Control Flow**:
    - Sets multiple metrics counters using `FD_MCNT_SET` for transaction, bundle, packet, shredstream heartbeats, keepalives, and error counts from the `ctx->metrics` structure.
    - Sets round-trip time (RTT) metrics using `FD_MGAUGE_SET` for sample, smoothed, and variance RTT values from the `ctx->rtt` structure.
    - Copies message receive delay histogram data using `FD_MHIST_COPY`.
    - Retrieves the workspace containing the context using `fd_wksp_containing` and checks workspace usage with `fd_wksp_usage`.
    - Logs an error if `fd_wksp_usage` fails, though this is marked as unreachable.
    - Sets heap size and free bytes metrics using `FD_MGAUGE_SET` based on workspace usage data.
    - Determines the bundle client status using [`fd_bundle_client_status`](<fd_bundle_client.c.md#fd_bundle_client_status>) and sets the connected status metric accordingly.
    - Updates the `ctx->bundle_status_recent` with the current bundle status.
- **Output**: No return value; updates metrics and status information in the provided context.
- **Functions Called**:
    - [`fd_bundle_client_status`](<fd_bundle_client.c.md#fd_bundle_client_status>)


---
### fd\_bundle\_tile\_housekeeping<!-- {{#callable:fd_bundle_tile_housekeeping}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_tile.c#L78>)

Performs periodic checks and updates for a bundle tile context, including logging connection status and handling keyswitch state changes.
- **Inputs**:
    - `ctx`: A pointer to a `fd_bundle_tile_t` structure representing the bundle tile context.
- **Logic and Control Flow**:
    - Initialize `log_interval_ns` to 30 seconds in nanoseconds.
    - Retrieve the current status of the bundle client using [`fd_bundle_client_status`](<fd_bundle_client.c.md#fd_bundle_client_status>).
    - Calculate the next log time by adding `log_interval_ns` to `ctx->last_bundle_status_log_nanos`.
    - Get the current time in nanoseconds using `fd_log_wallclock`.
    - If the status is not `FD_PLUGIN_MSG_BLOCK_ENGINE_UPDATE_STATUS_CONNECTED` and the current time exceeds `log_next_ns`, log a warning about the lack of server connection and update `ctx->last_bundle_status_log_nanos`.
    - Check if the keyswitch state is `FD_KEYSWITCH_STATE_SWITCH_PENDING`.
    - If the keyswitch state is pending, copy the keyswitch bytes to `ctx->auther.pubkey`, set the keyswitch state to `FD_KEYSWITCH_STATE_COMPLETED`, and set `ctx->defer_reset` to 1.
- **Output**: No return value; the function modifies the `ctx` structure in place.
- **Functions Called**:
    - [`fd_bundle_client_status`](<fd_bundle_client.c.md#fd_bundle_client_status>)


---
### fd\_bundle\_tile\_publish\_block\_engine\_update<!-- {{#callable:fd_bundle_tile_publish_block_engine_update}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_tile.c#L96>)

Publishes a block engine update message with connection details and status to a specified stem context.
- **Inputs**:
    - ``ctx``: A pointer to `fd_bundle_tile_t` structure containing context information for the bundle tile.
    - ``stem``: A pointer to `fd_stem_context_t` structure representing the stem context where the update will be published.
- **Logic and Control Flow**:
    - Convert the memory chunk in `ctx->plugin_out` to a local address and assign it to `update`.
    - Clear the memory of `update` to zero using `memset`.
    - Copy the string "jito" into `update->name` using `strncpy`.
    - Format the URL string based on SSL status and server details, and store it in `update->url` using `snprintf`.
    - Format the IPv4 address string and store it in `update->ip_cstr` using `snprintf`.
    - Set `update->status` to the recent bundle status from `ctx->bundle_status_recent`.
    - Compute the current timestamp using `fd_bundle_now` and `fd_frag_meta_ts_comp`, and store it in `tspub`.
    - Publish the update message to the stem using `fd_stem_publish` with the computed timestamp `tspub`.
    - Update `ctx->plugin_out.chunk` to the next compact chunk using `fd_dcache_compact_next`.
- **Output**: No return value; the function operates by side effects on the provided context structures.


---
### after\_credit<!-- {{#callable:after_credit}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_tile.c#L135>)

Updates the context's stem and publishes a block engine update if necessary.
- **Inputs**:
    - ``ctx``: A pointer to a `fd_bundle_tile_t` structure representing the current context.
    - ``stem``: A pointer to a `fd_stem_context_t` structure representing the stem context.
    - ``opt_poll_in``: An optional pointer to an integer, which is not used in this function.
    - ``charge_busy``: A pointer to an integer that indicates if the function should set the busy charge flag.
- **Logic and Control Flow**:
    - Ignores the `opt_poll_in` parameter by casting it to void.
    - Checks if `ctx->stem` is not set and assigns `stem` to `ctx->stem` if true.
    - Calls [`fd_bundle_client_step`](<fd_bundle_client.c.md#fd_bundle_client_step>) with `ctx` and `charge_busy` to perform a client step operation.
    - Checks if `ctx->plugin_out.mem` is non-null, indicating that plugin output memory is available.
    - If `ctx->bundle_status_recent` is not equal to `ctx->bundle_status_plugin`, calls [`fd_bundle_tile_publish_block_engine_update`](<#fd_bundle_tile_publish_block_engine_update>) to publish an update and sets `ctx->bundle_status_plugin` to `ctx->bundle_status_recent`.
    - Sets `*charge_busy` to 1 if a block engine update was published.
- **Output**: No return value; the function operates by modifying the input context and charge_busy flag.
- **Functions Called**:
    - [`fd_bundle_client_step`](<fd_bundle_client.c.md#fd_bundle_client_step>)
    - [`fd_bundle_tile_publish_block_engine_update`](<#fd_bundle_tile_publish_block_engine_update>)


---
### parse\_url<!-- {{#callable:parse_url}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_tile.c#L153>)

Parses a URL string to extract its components, validate the scheme, determine if SSL is used, and resolve the port number.
- **Inputs**:
    - `url_`: A pointer to an `fd_url_t` structure where the parsed URL components will be stored.
    - `url_str`: A constant character pointer to the URL string to be parsed.
    - `url_str_len`: An unsigned long integer representing the length of the URL string.
    - `tcp_port`: A pointer to an unsigned short where the function will store the resolved TCP port number.
    - `is_ssl`: A pointer to a boolean where the function will store whether the URL uses SSL (HTTPS).
- **Logic and Control Flow**:
    - Call `fd_url_parse_cstr` to parse the URL string into the `fd_url_t` structure and check for errors.
    - If parsing fails, log an error based on the type of error encountered (invalid scheme or host oversize).
    - Check the URL scheme to determine if it is 'https://' or 'http://', and set `is_ssl` accordingly.
    - Set the default TCP port to 443, and if a port is specified in the URL, validate and convert it to an unsigned short.
    - If the port number is invalid, log an error.
    - Check the length of the host component and log a critical error if it exceeds 255 characters.
    - Copy the host component into a character array for further processing.
- **Output**: No direct output is returned, but the function modifies the `url_`, `tcp_port`, and `is_ssl` pointers to store the parsed URL components and settings.


---
### fd\_bundle\_tile\_parse\_endpoint<!-- {{#callable:fd_bundle_tile_parse_endpoint}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_tile.c#L214>)

Parses a URL from a tile and updates the context with server details, including handling SSL and SNI information.
- **Inputs**:
    - `ctx`: A pointer to `fd_bundle_tile_t` structure where the parsed endpoint details will be stored.
    - `tile`: A constant pointer to `fd_topo_tile_t` structure containing the URL and SNI information to be parsed.
- **Logic and Control Flow**:
    - Initialize a `fd_url_t` structure and a boolean `is_ssl` to store URL parsing results.
    - Call [`parse_url`](<#parse_url>) to parse the URL from `tile->bundle.url` and update `ctx->server_tcp_port` and `is_ssl`.
    - Check if `url->host_len` exceeds 255 and log a critical error if true.
    - Append the host from the parsed URL to `ctx->server_fqdn` and update `ctx->server_fqdn_len`.
    - If `tile->bundle.sni_len` is non-zero, append the SNI from the tile to `ctx->server_sni` and update `ctx->server_sni_len`; otherwise, use the host from the URL.
    - Set `ctx->is_ssl` based on the `is_ssl` flag.
    - If SSL is required but OpenSSL is not available, log an error message.
- **Output**: No return value; updates the `ctx` structure with parsed server details.
- **Functions Called**:
    - [`parse_url`](<#parse_url>)


---
### crypto\_malloc<!-- {{#callable:crypto_malloc}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_tile.c#L262>)

Allocates memory with a specified alignment and size, storing the size at the beginning of the allocated block.
- **Inputs**:
    - ``num``: The number of bytes to allocate.
    - ``file``: The name of the file where the allocation is requested, used for debugging purposes.
    - ``line``: The line number in the file where the allocation is requested, used for debugging purposes.
- **Logic and Control Flow**:
    - Ignore `file` and `line` parameters as they are not used in the function logic.
    - Call `fd_alloc_malloc` with a context, alignment of 16 bytes, and size `num + 8` bytes to allocate memory.
    - Check if the allocation result is `NULL`, indicating a failure, and increment the error counter `ERRORS_SSL_ALLOC` if so, then return `NULL`.
    - Store the requested size `num` at the beginning of the allocated memory block.
    - Return a pointer to the memory block, offset by 8 bytes to skip the stored size.
- **Output**: A pointer to the allocated memory block, or `NULL` if the allocation fails.


---
### crypto\_free<!-- {{#callable:crypto_free}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_tile.c#L276>)

Frees memory allocated for a given address, adjusting for an 8-byte offset.
- **Inputs**:
    - ``addr``: A pointer to the memory address to free.
    - ``file``: A string representing the file name where the function is called, used for debugging purposes.
    - ``line``: An integer representing the line number where the function is called, used for debugging purposes.
- **Logic and Control Flow**:
    - Ignores `file` and `line` parameters as they are not used in the function logic.
    - Checks if `addr` is NULL using `FD_UNLIKELY`; if true, the function returns immediately without doing anything.
    - If `addr` is not NULL, calls `fd_alloc_free` to free the memory, adjusting the address by subtracting 8 bytes from `addr`.
- **Output**: No output is returned; the function performs a memory deallocation operation.


---
### crypto\_realloc<!-- {{#callable:crypto_realloc}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_tile.c#L287>)

Reallocates memory for a given address, with additional context for debugging and memory management.
- **Inputs**:
    - `addr`: Pointer to the memory block to reallocate.
    - `num`: New size for the memory block in bytes.
    - `file`: Name of the source file for debugging purposes.
    - `line`: Line number in the source file for debugging purposes.
- **Logic and Control Flow**:
    - If `addr` is NULL, allocate new memory using [`crypto_malloc`](<#crypto_malloc>) with the specified `num`, `file`, and `line` parameters.
    - If `num` is zero, free the memory at `addr` using [`crypto_free`](<#crypto_free>) and return NULL.
    - Allocate new memory with `fd_alloc_malloc`, adding 8 bytes for storing the size, and check if allocation is successful.
    - Copy the minimum of the old and new sizes of the memory block from the old address to the new address using `fd_memcpy`.
    - Free the old memory block using `fd_alloc_free`.
    - Store the new size at the beginning of the new memory block and return a pointer to the new memory block, offset by 8 bytes.
- **Output**: Returns a pointer to the newly allocated memory block, or NULL if allocation fails or if `num` is zero.
- **Functions Called**:
    - [`crypto_malloc`](<#crypto_malloc>)
    - [`crypto_free`](<#crypto_free>)


---
### fd\_ossl\_keylog\_callback<!-- {{#callable:fd_ossl_keylog_callback}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_tile.c#L308>)

Logs SSL key information to a file for debugging purposes.
- **Inputs**:
    - `ssl`: A pointer to an `SSL` structure representing the SSL connection.
    - `line`: A constant character pointer to the line of key information to log.
- **Logic and Control Flow**:
    - Retrieve the SSL context from the `ssl` parameter using `SSL_get_SSL_CTX`.
    - Get the custom data associated with the SSL context using `SSL_CTX_get_ex_data`.
    - Calculate the length of the `line` string using `strlen`.
    - Prepare an array of `iovec` structures to hold the `line` and a newline character.
    - Use `writev` to write the `line` and newline to the file descriptor specified in the context.
    - If `writev` fails to write the expected number of bytes, log a warning message.
- **Output**: No return value; the function performs logging as a side effect.


---
### fd\_bundle\_tile\_load\_certs<!-- {{#callable:fd_bundle_tile_load_certs}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_tile.c#L323>)

Loads CA certificates from a default directory into an OpenSSL context.
- **Inputs**:
    - `ssl_ctx`: A pointer to an `SSL_CTX` structure where the loaded certificates will be stored.
- **Logic and Control Flow**:
    - Create a new X509 certificate store using `X509_STORE_new` and check for failure.
    - Open the default directory `/etc/ssl/certs/` using `opendir` and check for failure.
    - Iterate over each entry in the directory using `readdir`.
    - Skip entries named `.` and `..`.
    - Construct the full path for each certificate file using `fd_cstr_init`, `fd_cstr_append_text`, and `fd_cstr_append_cstr_safe`.
    - Attempt to load each certificate file into the certificate store using `X509_STORE_load_locations`. Ignore errors if a file is not a valid certificate.
    - Check for errors in reading the directory entries, ignoring `ENOENT`.
    - Retrieve all certificates from the store using `X509_STORE_get1_all_certs` and log the number of loaded certificates.
    - If logging is enabled, log each certificate's subject name using `X509_NAME_oneline`.
    - Free the list of certificates using `sk_X509_pop_free`.
    - Set the certificate store in the `SSL_CTX` using `SSL_CTX_set_cert_store`.
    - Close the directory using `closedir` and check for failure.
- **Output**: The function does not return a value; it modifies the `ssl_ctx` by setting its certificate store.


---
### fd\_bundle\_tile\_init\_openssl<!-- {{#callable:fd_bundle_tile_init_openssl}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_tile.c#L373>)

Initializes an OpenSSL context for a given `fd_bundle_tile_t` structure, setting up memory allocation, SSL context, and optional certificate verification.
- **Inputs**:
    - ``ctx``: A pointer to an `fd_bundle_tile_t` structure that will be initialized with OpenSSL context and related settings.
    - ``alloc_mem``: A pointer to memory used for custom memory allocation functions in OpenSSL.
    - ``tls_cert_verify``: An integer flag indicating whether to verify TLS certificates (non-zero to verify).
- **Logic and Control Flow**:
    - Join a new memory allocator using `fd_alloc_new` and `fd_alloc_join`, and assign it to `ctx->ssl_alloc` and `fd_quic_ssl_mem_function_ctx`.
    - Set custom memory functions for OpenSSL using `CRYPTO_set_mem_functions`.
    - Initialize OpenSSL with specific options using `OPENSSL_init_ssl`.
    - Create a new SSL context with `SSL_CTX_new` and assign it to `ctx->ssl_ctx`.
    - Set extra data for the SSL context using `SSL_CTX_set_ex_data`.
    - Configure SSL context modes with `SSL_CTX_set_mode`.
    - Set the minimum protocol version to TLS 1.3 using `SSL_CTX_set_min_proto_version`.
    - Set ALPN protocols to HTTP/2 using `SSL_CTX_set_alpn_protos`.
    - If `tls_cert_verify` is non-zero, load certificates using [`fd_bundle_tile_load_certs`](<#fd_bundle_tile_load_certs>) and set peer verification with `SSL_CTX_set_verify`.
    - If `ctx->keylog_fd` is valid, set a keylog callback using `SSL_CTX_set_keylog_callback`.
- **Output**: The function does not return a value; it initializes the `ctx` structure with OpenSSL settings.
- **Functions Called**:
    - [`fd_bundle_tile_load_certs`](<#fd_bundle_tile_load_certs>)


---
### privileged\_init<!-- {{#callable:privileged_init}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_tile.c#L430>)

Initializes a privileged context for a bundle tile, setting up memory allocations, security keys, and network configurations.
- **Inputs**:
    - ``topo``: A pointer to an `fd_topo_t` structure representing the topology configuration.
    - ``tile``: A pointer to an `fd_topo_tile_t` structure representing the specific tile configuration.
- **Logic and Control Flow**:
    - Allocate scratch memory using `fd_topo_obj_laddr` and initialize it with `FD_SCRATCH_ALLOC_INIT` and `FD_SCRATCH_ALLOC_APPEND` for various components like `fd_bundle_tile_t`, gRPC client memory, and allocator memory.
    - Check alignment and footprint of the scratch memory to ensure it is within expected limits, logging critical errors if not.
    - Initialize the `fd_bundle_tile_t` context by zeroing its memory and setting up gRPC client memory and buffer size.
    - Initialize the `fd_bundle_auther` and load the public key using `fd_keyload_load`, copying it into the context's `auther.pubkey`.
    - If OpenSSL is available and a key log path is specified, open the key log file and initialize OpenSSL with [`fd_bundle_tile_init_openssl`](<#fd_bundle_tile_init_openssl>).
    - Open network database file descriptors with `fd_netdb_open_fds`, logging an error if it fails.
    - Generate a secure random seed for the header hashmap and timing RNG using `fd_rng_secure`, logging critical errors if it fails.
    - Initialize a random number generator with `fd_rng_join`, logging a critical error if it fails.
- **Output**: No return value; the function operates by side effects on the provided `topo` and `tile` structures.
- **Functions Called**:
    - [`scratch_align`](<#scratch_align>)
    - [`scratch_footprint`](<#scratch_footprint>)
    - [`fd_bundle_tile_init_openssl`](<#fd_bundle_tile_init_openssl>)


---
### bundle\_out\_link<!-- {{#callable:bundle_out_link}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_tile.c#L496>)

Initializes and returns a `fd_bundle_out_ctx_t` structure for a given output link in a topology.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure representing the topology.
    - ``link``: A pointer to a `fd_topo_link_t` structure representing the link in the topology.
    - ``out_link_idx``: An unsigned long integer representing the index of the output link.
- **Logic and Control Flow**:
    - Initialize a `fd_bundle_out_ctx_t` structure `out` with default values.
    - Set `out.idx` to `out_link_idx`.
    - Retrieve the workspace memory from `topo` using the `link->dcache_obj_id` and set it to `out.mem`.
    - Calculate the compact chunk start using `fd_dcache_compact_chunk0` and assign it to `out.chunk0`.
    - Calculate the watermark using `fd_dcache_compact_wmark` and assign it to `out.wmark`.
    - Set `out.chunk` to `out.chunk0`.
    - Return the initialized `fd_bundle_out_ctx_t` structure `out`.
- **Output**: A `fd_bundle_out_ctx_t` structure initialized with the specified output link context.


---
### unprivileged\_init<!-- {{#callable:unprivileged_init}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_tile.c#L509>)

Initializes an unprivileged bundle tile by setting up keyguard clients, keyswitch, and various network and plugin configurations.
- **Inputs**:
    - ``topo``: A pointer to the `fd_topo_t` structure representing the topology.
    - ``tile``: A pointer to the `fd_topo_tile_t` structure representing the tile to initialize.
- **Logic and Control Flow**:
    - Retrieve the local address of the tile object using `fd_topo_obj_laddr` and store it in `ctx`.
    - Check if `tile->kind_id` is not equal to 0 and log an error if true.
    - Find the input link index for 'sign_bundle' using `fd_topo_find_tile_in_link` and log an error if not found.
    - Find the output link index for 'bundle_sign' using `fd_topo_find_tile_out_link` and log an error if not found.
    - Create and join a keyguard client using `fd_keyguard_client_new` and `fd_keyguard_client_join`, logging an error if joining fails.
    - Join the keyswitch object using `fd_keyswitch_join` and verify its success with `FD_TEST`.
    - Find the output link index for 'bundle_verif' and set `ctx->verify_out` using [`bundle_out_link`](<#bundle_out_link>), logging an error if not found.
    - Find the output link index for 'bundle_plugi' and set `ctx->plugin_out` using [`bundle_out_link`](<#bundle_out_link>), or set it to a default value if not found.
    - Set the socket receive buffer size from `tile->bundle.buf_sz` and log an error if it is out of valid range.
    - Set the idle ping timer using `tile->bundle.keepalive_interval_nanos`.
    - Initialize various status and log time variables in `ctx`.
    - Parse the endpoint using [`fd_bundle_tile_parse_endpoint`](<#fd_bundle_tile_parse_endpoint>).
    - Create a new gRPC client using `fd_grpc_client_new` and set its version and authority, logging a critical error if creation fails.
    - Initialize a histogram for message receive delay using `fd_histf_new`.
- **Output**: No return value; the function initializes the state of the bundle tile in the provided context.
- **Functions Called**:
    - [`bundle_out_link`](<#bundle_out_link>)
    - [`fd_bundle_tile_parse_endpoint`](<#fd_bundle_tile_parse_endpoint>)


---
### populate\_allowed\_seccomp<!-- {{#callable:populate_allowed_seccomp}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_tile.c#L577>)

Populates a seccomp filter with allowed system calls for a specific tile in a topology.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure representing the topology.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure representing the tile within the topology.
    - ``out_cnt``: An unsigned long integer representing the count of output filters.
    - ``out``: A pointer to a `struct sock_filter` array where the function will store the allowed seccomp filters.
- **Logic and Control Flow**:
    - Retrieve the local address of the tile object using `fd_topo_obj_laddr` with `topo` and `tile->tile_obj_id`.
    - Call [`populate_sock_filter_policy_fd_bundle_tile`](<generated/fd_bundle_tile_seccomp.h.md#populate_sock_filter_policy_fd_bundle_tile>) with `out_cnt`, `out`, and file descriptors for logging and network database files.
    - Return the constant `sock_filter_policy_fd_bundle_tile_instr_cnt`.
- **Output**: Returns an unsigned long integer representing the count of instructions in the seccomp filter policy.
- **Functions Called**:
    - [`populate_sock_filter_policy_fd_bundle_tile`](<generated/fd_bundle_tile_seccomp.h.md#populate_sock_filter_policy_fd_bundle_tile>)


---
### populate\_allowed\_fds<!-- {{#callable:populate_allowed_fds}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_tile.c#L594>)

Populates an array with file descriptors that are allowed for a specific tile in a topology.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure representing the topology.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure representing the tile within the topology.
    - ``out_fds_cnt``: An unsigned long integer specifying the maximum number of file descriptors that can be stored in `out_fds`.
    - ``out_fds``: A pointer to an integer array where the allowed file descriptors will be stored.
- **Logic and Control Flow**:
    - Retrieve the local address of the tile object using `fd_topo_obj_laddr` and store it in `ctx`.
    - Check if `out_fds_cnt` is less than 5; if true, log an error and terminate.
    - Initialize `out_cnt` to 0 and add the file descriptor for `stderr` to `out_fds`.
    - If the log file descriptor is valid, add it to `out_fds`.
    - If the `etc_hosts` file descriptor is valid, add it to `out_fds`.
    - Add the `etc_resolv_conf` file descriptor to `out_fds`.
    - If the `keylog_fd` is valid, add it to `out_fds`.
    - Return the count of file descriptors added to `out_fds`.
- **Output**: Returns the number of file descriptors added to the `out_fds` array as an unsigned long integer.



---
Made with ❤️ by [Driver](https://www.driver.ai/)