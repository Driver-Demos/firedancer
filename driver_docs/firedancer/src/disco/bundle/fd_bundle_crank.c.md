<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for initializing, updating, and applying configurations for bundle crank operations.

# Purpose
The code defines a C module that manages the configuration and operation of a system for handling tip payments and block building in a blockchain environment. It includes structures and functions to initialize, update, and apply configurations related to tip distribution and payment programs. The module uses data structures such as `fd_bundle_crank_3_t` and `fd_bundle_crank_2_t` to store configuration details, including program IDs, account addresses, and instructions for managing transactions. The code also includes functions to generate and apply changes to these configurations based on the current state and input parameters.

The module provides functionality to initialize a `fd_bundle_crank_gen_t` structure with specific program addresses and configuration settings. It includes logic to handle the generation of new configurations and transactions, ensuring that the system's state is updated correctly based on the current epoch and other parameters. The code uses SIMD instructions for certain operations if available, and it includes a map implementation to manage account addresses efficiently. The module is designed to be integrated into a larger system, providing specific functionality related to blockchain transaction management and configuration.
# Imports and Dependencies

---
- `fd_bundle_crank.h`
- `../../flamenco/runtime/fd_pubkey_utils.h`
- `../../util/simd/fd_avx.h`
- `../../util/tmpl/fd_map.c`


# Global Variables

---
### fd\_bundle\_crank\_3\_base
- **Type**: ``fd_bundle_crank_3_t``
- **Description**: Defines a constant array of type `fd_bundle_crank_3_t` with a single element. This structure contains various fields related to program and account configurations, including instruction counts, program IDs, account indices, and data sizes. It also includes fields that depend on network and validator configurations, as well as fields that vary with each execution.
- **Use**: Used to initialize and configure the `fd_bundle_crank_gen_t` structure with predefined settings for crank operations.


---
### fd\_bundle\_crank\_2\_base
- **Type**: ``fd_bundle_crank_2_t``
- **Description**: Defines a constant array of type `fd_bundle_crank_2_t` with a single element. This structure contains configuration and state information for a specific crank operation, including program IDs, instruction counts, and account addresses.
- **Use**: Used to initialize and configure crank operations in the `fd_bundle_crank_gen_init` function.


---
### null\_addr
- **Type**: ``fd_acct_addr_t``
- **Description**: Represents a constant address of type `fd_acct_addr_t` initialized to zero. This variable is used as a null or invalid address placeholder.
- **Use**: Used to represent an invalid or uninitialized account address in the program.


# Functions

---
### fd\_bundle\_crank\_gen\_init<!-- {{#callable:fd_bundle_crank_gen_init}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_crank.c#L174>)

Initializes a `fd_bundle_crank_gen_t` structure with specified parameters and configurations for tip distribution and payment programs.
- **Inputs**:
    - `mem`: A pointer to memory where the `fd_bundle_crank_gen_t` structure will be initialized.
    - `tip_distribution_program_addr`: A constant pointer to the address of the tip distribution program.
    - `tip_payment_program_addr`: A constant pointer to the address of the tip payment program.
    - `validator_vote_acct_addr`: A constant pointer to the address of the validator vote account.
    - `merkle_root_authority_addr`: A constant pointer to the address of the Merkle root authority.
    - `scheduler_mode`: A constant pointer to a string representing the scheduler mode.
    - `commission_bps`: An unsigned long representing the commission basis points.
- **Logic and Control Flow**:
    - Cast `mem` to a `fd_bundle_crank_gen_t` pointer and assign it to `g`.
    - Copy base configurations from `fd_bundle_crank_3_base` and `fd_bundle_crank_2_base` to `g->crank3` and `g->crank2` respectively.
    - Set `commission_bps` in `g->crank3->init_tip_distribution_acct`.
    - Copy the provided addresses to the corresponding fields in `g->crank3`.
    - Manually copy up to three characters from `scheduler_mode` to `g->crank3->memo.memo`, handling potential unterminated strings.
    - Generate and assign program addresses for `tip_payment_accounts` and `tip_payment_program_config` using seeds and `fd_pubkey_find_program_address`.
    - Copy data from `g->crank3` to `g->crank2` for various fields.
    - Parse transactions for `g->crank3` and `g->crank2` using `fd_txn_parse`.
    - Initialize a new map `g->map` and insert various account addresses with specific indices.
    - Set `g->configured_epoch` to `ULONG_MAX`.
- **Output**: Returns a pointer to the initialized `fd_bundle_crank_gen_t` structure.


---
### fd\_bundle\_crank\_update\_epoch<!-- {{#callable:fd_bundle_crank_update_epoch}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_crank.c#L260>)

Updates the epoch and new tip receiver for a given `fd_bundle_crank_gen_t` structure.
- **Inputs**:
    - `g`: A pointer to an `fd_bundle_crank_gen_t` structure that contains crank configuration data.
    - `epoch`: An unsigned long integer representing the new epoch to set.
- **Logic and Control Flow**:
    - Define a packed structure `seeds` with fields `tip_distr_acct`, `vote_pubkey`, and `epoch` initialized with specific values.
    - Assert that the size of `seeds` is 64 bytes using `FD_STATIC_ASSERT`.
    - Set `seed_len` to the size of `seeds`.
    - Define `_seeds` as an array containing a pointer to `seeds`.
    - Call `fd_pubkey_find_program_address` to find a program address using the `tip_distribution_program`, `_seeds`, and `seed_len`, and store the result in `new_tip_receiver` and `init_tip_distribution_acct.bump`.
    - Copy `new_tip_receiver` from `crank3` to `crank2`.
    - Set `configured_epoch` in `g` to the new `epoch`.
- **Output**: No return value; the function updates the state of the `fd_bundle_crank_gen_t` structure pointed to by `g`.


---
### fd\_bundle\_crank\_get\_addresses<!-- {{#callable:fd_bundle_crank_get_addresses}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_crank.c#L287>)

Retrieves and updates the tip payment configuration and receiver addresses for a given epoch.
- **Inputs**:
    - ``gen``: A pointer to an `fd_bundle_crank_gen_t` structure, which contains the current configuration and state of the crank.
    - ``epoch``: An unsigned long integer representing the current epoch to check against the configured epoch.
    - ``out_tip_payment_config``: A pointer to an `fd_acct_addr_t` where the function will store the tip payment program configuration address.
    - ``out_tip_receiver``: A pointer to an `fd_acct_addr_t` where the function will store the new tip receiver address.
- **Logic and Control Flow**:
    - Check if the provided `epoch` is different from the `configured_epoch` in `gen`.
    - If the epochs differ, call [`fd_bundle_crank_update_epoch`](<#fd_bundle_crank_update_epoch>) to update the epoch and the new tip receiver address.
    - Copy the `tip_payment_program_config` from `gen->crank3` to `out_tip_payment_config`.
    - Copy the `new_tip_receiver` from `gen->crank3` to `out_tip_receiver`.
- **Output**: No return value; the function outputs the addresses through the pointers `out_tip_payment_config` and `out_tip_receiver`.
- **Functions Called**:
    - [`fd_bundle_crank_update_epoch`](<#fd_bundle_crank_update_epoch>)


---
### fd\_bundle\_crank\_generate<!-- {{#callable:fd_bundle_crank_generate}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_crank.c#L297>)

Generates a transaction payload and updates the crank configuration based on the provided tip payment configuration and block builder details.
- **Inputs**:
    - `gen`: A pointer to `fd_bundle_crank_gen_t`, which holds the crank generator state.
    - `old_tip_payment_config`: A pointer to a constant `fd_bundle_crank_tip_payment_config_t`, representing the old tip payment configuration.
    - `new_block_builder`: A pointer to a constant `fd_acct_addr_t`, representing the new block builder's account address.
    - `identity`: A pointer to a constant `fd_acct_addr_t`, representing the identity account address.
    - `tip_receiver_owner`: A pointer to a constant `fd_acct_addr_t`, representing the tip receiver owner's account address.
    - `epoch`: An unsigned long integer representing the current epoch.
    - `block_builder_commission`: An unsigned long integer representing the commission percentage for the block builder.
    - `out_payload`: A pointer to an unsigned char array where the generated payload will be stored.
    - `out_txn`: A pointer to `fd_txn_t` where the generated transaction will be stored.
- **Logic and Control Flow**:
    - Check if the current epoch is different from the configured epoch in `gen`; if so, update the epoch.
    - Verify the discriminator of `old_tip_payment_config`; if it is unexpected, log a warning and return `ULONG_MAX`.
    - Determine if a swap is needed by comparing `tip_receiver_owner` with `gen->crank3->tip_distribution_program`.
    - Check if the old tip payment configuration matches the expected values; if so, return 0.
    - If a swap is needed, update `gen->crank3` with the new configuration; otherwise, update `gen->crank2`.
    - Insert `identity`, `new_tip_receiver`, and `new_block_builder` into the map and check for duplicates; if any are found, log a warning and return `ULONG_MAX`.
    - Query and possibly insert `old_tip_receiver` and `old_block_builder` into the map, handling duplicates by perturbing the keys.
    - Update account indices in `gen->crank3` and `gen->crank2` based on the map indices.
    - Remove inserted entries from the map.
    - Copy the appropriate crank configuration to `out_payload` and `out_txn` based on whether a swap was needed, and return the size of the copied configuration.
- **Output**: Returns the size of the generated crank configuration if successful, or `ULONG_MAX` if an error occurs.
- **Functions Called**:
    - [`fd_bundle_crank_update_epoch`](<#fd_bundle_crank_update_epoch>)


---
### fd\_bundle\_crank\_apply<!-- {{#callable:fd_bundle_crank_apply}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_crank.c#L431>)

Updates the tip payment configuration and tip receiver owner based on the new block builder and commission percentage.
- **Inputs**:
    - ``gen``: A pointer to a `fd_bundle_crank_gen_t` structure that contains the current configuration and state.
    - ``tip_payment_config``: A pointer to a `fd_bundle_crank_tip_payment_config_t` structure that will be updated with the new tip receiver and block builder information.
    - ``new_block_builder``: A constant pointer to a `fd_acct_addr_t` structure representing the new block builder's address.
    - ``tip_receiver_owner``: A pointer to a `fd_acct_addr_t` structure that will be updated with the tip distribution program address.
    - ``epoch``: An unsigned long integer representing the current epoch.
    - ``block_builder_commission``: An unsigned long integer representing the commission percentage for the block builder.
- **Logic and Control Flow**:
    - Check if the `epoch` is different from `gen->configured_epoch`; if so, call [`fd_bundle_crank_update_epoch`](<#fd_bundle_crank_update_epoch>) to update the epoch.
    - Copy the `tip_distribution_program` from `gen->crank3` to `tip_receiver_owner`.
    - Copy the `new_tip_receiver` from `gen->crank3` to `tip_payment_config->tip_receiver`.
    - Copy the `new_block_builder` to `tip_payment_config->block_builder`.
    - Set `tip_payment_config->commission_pct` to `block_builder_commission`.
- **Output**: No return value; the function updates the provided structures in place.
- **Functions Called**:
    - [`fd_bundle_crank_update_epoch`](<#fd_bundle_crank_update_epoch>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)