<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

API for generating and managing periodic keepalive events with configurable intervals and timeouts.

# Purpose
The `fd_keepalive.h` file defines an API for managing keepalive events in a system. It provides functionality to configure and monitor keepalive intervals and timeouts, which are essential for maintaining active connections in networked applications. The API allows users to set a target interval and timeout for keepalive messages, check if a keepalive message should be sent, and determine if a keepalive message has timed out. It also provides mechanisms to notify the system when a keepalive message is sent or acknowledged.

The file includes the definition of the `fd_keepalive` structure, which holds timestamps and configuration parameters necessary for keepalive operations. Functions such as [`fd_keepalive_init`](<#fd_keepalive_init>), [`fd_keepalive_should_tx`](<#fd_keepalive_should_tx>), [`fd_keepalive_tx`](<#fd_keepalive_tx>), [`fd_keepalive_is_timeout`](<#fd_keepalive_is_timeout>), and [`fd_keepalive_rx`](<#fd_keepalive_rx>) are provided to initialize the keepalive structure, determine if a keepalive message should be transmitted, handle the transmission of keepalive messages, check for timeouts, and process received acknowledgments, respectively. The API uses a random number generator, `fd_rng_t`, to introduce variability in the keepalive intervals, enhancing the robustness of the keepalive mechanism.
# Imports and Dependencies

---
- `../../util/rng/fd_rng.h`


# Data Structures

---
### fd\_keepalive
- **Type**: ``struct``
- **Members**:
    - `ts_next_tx`: Timestamp when to send the next ping.
    - `ts_deadline`: Timestamp by which the ping acknowledgment is expected.
    - `interval`: Interval between keepalive pings.
    - `timeout`: Timeout duration for receiving a ping acknowledgment.
    - `ts_last_tx`: Timestamp of the last ping sent.
    - `ts_last_rx`: Timestamp of the last ping acknowledgment received.
    - `inflight`: Flag indicating if a ping is currently in flight.
- **Description**: Manages keepalive events by tracking timestamps for sending pings and receiving acknowledgments, as well as handling intervals and timeouts for these events.


---
### fd\_keepalive\_t
- **Type**: ``struct``
- **Members**:
    - `ts_next_tx`: Timestamp when to send next ping.
    - `ts_deadline`: Timestamp by which ping ACK is expected to be received.
    - `interval`: Configured interval for sending keepalive pings.
    - `timeout`: Configured timeout for receiving ping ACKs.
    - `ts_last_tx`: Timestamp of last ping sent.
    - `ts_last_rx`: Timestamp of last ping ACK received.
    - `inflight`: Flag indicating if a ping is currently awaiting an ACK.
- **Description**: Manages keepalive events by tracking timestamps for sending pings and receiving acknowledgments, with configurable intervals and timeouts.


# Functions

---
### fd\_keepalive\_interval\_reload<!-- {{#callable:fd_keepalive_interval_reload}} -->
[View Source →](<../../../../../src/disco/bundle/fd_keepalive.h#L28>)

Calculates a new keepalive interval by adding a random value to half of the given interval.
- **Inputs**:
    - ``rng``: A pointer to a random number generator of type `fd_rng_t`.
    - ``interval``: A long integer representing the original keepalive interval.
- **Logic and Control Flow**:
    - Calculate `i2` as half of the `interval` by right-shifting `interval` by one bit.
    - Generate a random number between 0 and `i2` using `fd_rng_ulong_roll`.
    - Add the random number to `i2` to get the new interval.
- **Output**: Returns a long integer representing the new keepalive interval.


---
### fd\_keepalive\_init<!-- {{#callable:fd_keepalive_init}} -->
[View Source →](<../../../../../src/disco/bundle/fd_keepalive.h#L37>)

Initializes a `fd_keepalive_t` structure with specified interval, timeout, and current time, and calculates the next transmission timestamp.
- **Inputs**:
    - `ka`: A pointer to a `fd_keepalive_t` structure to initialize.
    - `rng`: A pointer to a `fd_rng_t` structure used for random number generation.
    - `interval`: The desired interval between keepalive events.
    - `timeout`: The maximum time to wait for a keepalive acknowledgment.
    - `now`: The current timestamp used to calculate the next transmission time.
- **Logic and Control Flow**:
    - Set all fields of the `fd_keepalive_t` structure pointed to by `ka` to zero using `memset`.
    - Check if `interval` is less than 2 or `timeout` is zero; if so, return `NULL`.
    - Set the `interval` and `timeout` fields of `ka` to the provided values.
    - Calculate the next transmission timestamp by adding the current time `now` to a random interval generated by [`fd_keepalive_interval_reload`](<#fd_keepalive_interval_reload>), and store it in `ka->ts_next_tx`.
    - Return the pointer `ka`.
- **Output**: Returns a pointer to the initialized `fd_keepalive_t` structure, or `NULL` if the interval is less than 2 or the timeout is zero.
- **Functions Called**:
    - [`fd_keepalive_interval_reload`](<#fd_keepalive_interval_reload>)


---
### fd\_keepalive\_should\_tx<!-- {{#callable:fd_keepalive_should_tx}} -->
[View Source →](<../../../../../src/disco/bundle/fd_keepalive.h#L55>)

Determines if a new keepalive probe should be sent based on the current time and keepalive state.
- **Inputs**:
    - ``ka``: A pointer to a `fd_keepalive_t` structure that contains the keepalive state and configuration.
    - ``now``: A long integer representing the current time.
- **Logic and Control Flow**:
    - Check if `ka->interval` is non-zero to ensure keepalive is active.
    - Verify if `ka->ts_next_tx` is less than or equal to `now` to determine if the scheduled time for the next transmission has arrived.
    - Ensure `ka->inflight` is zero, indicating no keepalive probe is currently in progress.
- **Output**: Returns 1 if a new keepalive probe should be sent; otherwise, returns 0.


---
### fd\_keepalive\_tx<!-- {{#callable:fd_keepalive_tx}} -->
[View Source →](<../../../../../src/disco/bundle/fd_keepalive.h#L61>)

Updates the keepalive transmission timestamps and inflight status based on the current time and a random delay.
- **Inputs**:
    - ``ka``: A pointer to an `fd_keepalive_t` structure that holds the keepalive state.
    - ``rng``: A pointer to an `fd_rng_t` structure used to generate random numbers for interval calculation.
    - ``now``: The current timestamp as a long integer.
- **Logic and Control Flow**:
    - Calculate a random delay using [`fd_keepalive_interval_reload`](<#fd_keepalive_interval_reload>) with `rng` and `ka->interval`.
    - Set `ka->ts_last_tx` to `now`.
    - Add the calculated delay to `ka->ts_next_tx`.
    - If `ka->ts_next_tx` is less than `now`, set `ka->ts_next_tx` to `now` plus the delay.
    - Set `ka->ts_deadline` to `ka->ts_last_tx` plus `ka->timeout`.
    - Set `ka->inflight` to 1.
- **Output**: No return value; updates the `fd_keepalive_t` structure in place.
- **Functions Called**:
    - [`fd_keepalive_interval_reload`](<#fd_keepalive_interval_reload>)


---
### fd\_keepalive\_is\_timeout<!-- {{#callable:fd_keepalive_is_timeout}} -->
[View Source →](<../../../../../src/disco/bundle/fd_keepalive.h#L75>)

Checks if a keepalive operation has timed out based on the current time and the keepalive's deadline.
- **Inputs**:
    - ``ka``: A pointer to a `fd_keepalive_t` structure that contains the keepalive state and timing information.
    - ``now``: A long integer representing the current time against which the timeout is checked.
- **Logic and Control Flow**:
    - Check if the `inflight` flag in the `fd_keepalive_t` structure is set to true (non-zero).
    - Compare the `ts_deadline` in the `fd_keepalive_t` structure with the `now` parameter to determine if the deadline has passed.
    - Return the result of a bitwise AND operation between the `inflight` check and the deadline comparison, indicating if a timeout has occurred.
- **Output**: Returns an integer that is non-zero if the keepalive operation has timed out, otherwise returns zero.


---
### fd\_keepalive\_rx<!-- {{#callable:fd_keepalive_rx}} -->
[View Source →](<../../../../../src/disco/bundle/fd_keepalive.h#L81>)

Updates the keepalive structure upon receiving a keepalive acknowledgment and calculates the round-trip time.
- **Inputs**:
    - ``ka``: A pointer to an `fd_keepalive_t` structure representing the keepalive state.
    - ``now``: A long integer representing the current timestamp.
- **Logic and Control Flow**:
    - Calculate the round-trip time (`rtt`) as the difference between `now` and `ka->ts_last_tx`.
    - If `ka->inflight` is not set, set `rtt` to 0.
    - Set `ka->ts_deadline` to 0.
    - Update `ka->ts_last_rx` to `now`.
    - Set `ka->inflight` to 0.
    - Return the calculated `rtt`.
- **Output**: Returns the calculated round-trip time as a long integer.



---
Made with ❤️ by [Driver](https://www.driver.ai/)