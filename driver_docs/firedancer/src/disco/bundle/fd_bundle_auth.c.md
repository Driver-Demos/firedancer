<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Generates and manages authentication tokens using gRPC and protobuf for communication.

# Purpose
The code is a C module that manages the generation and refreshing of authentication tokens using a structure named `fd_bundle_auther_t`. It interacts with a gRPC service to request authentication challenges and tokens. The module includes functions to initialize the `fd_bundle_auther_t` structure, handle request failures, and process responses for both authentication challenges and tokens. The module uses the Protocol Buffers library for encoding and decoding messages and the Base58 encoding for handling public keys.

The module defines several functions to manage the state of the authentication process. The [`fd_bundle_auther_init`](<#fd_bundle_auther_init>) function initializes the `fd_bundle_auther_t` structure. The [`fd_bundle_auther_handle_request_fail`](<#fd_bundle_auther_handle_request_fail>) function manages state transitions when requests fail. The [`fd_bundle_auther_req_challenge`](<#fd_bundle_auther_req_challenge>) and [`fd_bundle_auther_req_tokens`](<#fd_bundle_auther_req_tokens>) functions send requests to the gRPC service for challenges and tokens, respectively. The [`fd_bundle_auther_handle_challenge_resp`](<#fd_bundle_auther_handle_challenge_resp>) and [`fd_bundle_auther_handle_tokens_resp`](<#fd_bundle_auther_handle_tokens_resp>) functions process the responses from these requests. The [`fd_bundle_auther_poll`](<#fd_bundle_auther_poll>) function is used to poll the current state and trigger the appropriate request function. The [`fd_bundle_auther_reset`](<#fd_bundle_auther_reset>) function resets the state to request a new challenge. The module relies on external libraries for gRPC communication, key management, and message encoding/decoding.
# Imports and Dependencies

---
- `fd_bundle_auth.h`
- `proto/auth.pb.h`
- `../../ballet/base58/fd_base58.h`
- `../../ballet/nanopb/pb_decode.h`
- `../../disco/keyguard/fd_keyguard.h`
- `../../disco/keyguard/fd_keyguard_client.h`


# Functions

---
### fd\_bundle\_auther\_init<!-- {{#callable:fd_bundle_auther_init}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_auth.c#L14>)

Initializes an `fd_bundle_auther_t` structure with default values for state and polling requirements.
- **Inputs**:
    - `auther`: A pointer to an `fd_bundle_auther_t` structure that will be initialized.
- **Logic and Control Flow**:
    - Assigns the `state` field of the `auther` structure to `FD_BUNDLE_AUTH_STATE_REQ_CHALLENGE`.
    - Sets the `needs_poll` field of the `auther` structure to 1.
    - Returns the pointer to the initialized `auther` structure.
- **Output**: Returns a pointer to the initialized `fd_bundle_auther_t` structure.


---
### fd\_bundle\_auther\_handle\_request\_fail<!-- {{#callable:fd_bundle_auther_handle_request_fail}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_auth.c#L23>)

Handles failures in authentication requests by resetting the state to request a new challenge.
- **Inputs**:
    - `auther`: A pointer to an `fd_bundle_auther_t` structure that manages authentication state and tokens.
- **Logic and Control Flow**:
    - Check the current state of `auther` using a switch statement.
    - If the state is `FD_BUNDLE_AUTH_STATE_WAIT_CHALLENGE`, log a debug message indicating a failed request for an authentication challenge, set the state to `FD_BUNDLE_AUTH_STATE_REQ_CHALLENGE`, and set `needs_poll` to 1.
    - If the state is `FD_BUNDLE_AUTH_STATE_WAIT_TOKENS`, log a debug message indicating a failed request for authentication tokens, set the state to `FD_BUNDLE_AUTH_STATE_REQ_CHALLENGE`, and set `needs_poll` to 1.
- **Output**: No return value; modifies the state and `needs_poll` fields of the `auther` structure.


---
### fd\_bundle\_auther\_req\_challenge<!-- {{#callable:fd_bundle_auther_req_challenge}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_auth.c#L39>)

Initiates an authentication challenge request to a gRPC server for a given client.
- **Inputs**:
    - `auther`: A pointer to an `fd_bundle_auther_t` structure that manages authentication state and data.
    - `client`: A pointer to an `fd_grpc_client_t` structure representing the gRPC client used to send the request.
- **Logic and Control Flow**:
    - Check if the gRPC client request is blocked using `fd_grpc_client_request_is_blocked`; if blocked, return immediately.
    - Initialize an `auth_GenerateAuthChallengeRequest` structure with the role set to `auth_Role_VALIDATOR` and copy the public key from `auther` into the request structure.
    - Define the gRPC path for the authentication challenge as `/auth.AuthService/GenerateAuthChallenge`.
    - Start a gRPC request using `fd_grpc_client_request_start` with the defined path and request data; if the request fails to start, return immediately.
    - Set the `auther` state to `FD_BUNDLE_AUTH_STATE_WAIT_CHALLENGE` and `needs_poll` to 0.
    - Set a deadline for the gRPC request using `fd_grpc_client_deadline_set` with a timeout of 5 seconds.
    - Encode the public key to a Base58 string and log an informational message about the request.
- **Output**: No output is returned from this function as it is a `void` function.


---
### fd\_bundle\_auther\_handle\_challenge\_resp<!-- {{#callable:fd_bundle_auther_handle_challenge_resp}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_auth.c#L71>)

Handles the response to an authentication challenge by decoding the response and updating the state of the `auther` object.
- **Inputs**:
    - `auther`: A pointer to an `fd_bundle_auther_t` structure that manages authentication state and data.
    - `data`: A pointer to the buffer containing the response data to decode.
    - `data_sz`: The size of the response data buffer.
- **Logic and Control Flow**:
    - Sets `auther->needs_poll` to 1 to indicate that polling is needed.
    - Initializes a protobuf input stream from the `data` buffer with size `data_sz`.
    - Decodes the protobuf message into an `auth_GenerateAuthChallengeResponse` structure.
    - If decoding fails, logs a warning and sets the `auther` state to `FD_BUNDLE_AUTH_STATE_REQ_CHALLENGE`, then returns 0.
    - Checks if the decoded challenge size is 9 bytes; if not, logs a warning, sets the state to `FD_BUNDLE_AUTH_STATE_REQ_CHALLENGE`, and returns 0.
    - Copies the 9-byte challenge from the decoded response to `auther->challenge`.
    - Sets the `auther` state to `FD_BUNDLE_AUTH_STATE_REQ_TOKENS` and logs a debug message indicating a successful challenge receipt.
    - Returns 1 to indicate success.
- **Output**: Returns 1 if the challenge response is successfully handled and decoded; otherwise, returns 0 if there is a failure.


---
### fd\_bundle\_auther\_req\_tokens<!-- {{#callable:fd_bundle_auther_req_tokens}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_auth.c#L101>)

Requests authentication tokens by formatting a challenge and sending it to a gRPC service.
- **Inputs**:
    - ``auther``: A pointer to an `fd_bundle_auther_t` structure that holds the state and public key for the authentication process.
    - ``client``: A pointer to an `fd_grpc_client_t` structure used to communicate with the gRPC service.
    - ``keyguard``: A pointer to an `fd_keyguard_client_t` structure used to sign the challenge.
- **Logic and Control Flow**:
    - Check if the gRPC client request is blocked; if so, return immediately.
    - Initialize an `auth_GenerateAuthTokensRequest` structure to zero.
    - Format the challenge string by encoding the public key in base58, appending a hyphen, and then appending the challenge text.
    - Set the size of the challenge in the request structure.
    - Copy the public key into the request structure and set its size.
    - Sign the challenge using the keyguard client and store the result in the request structure, setting the signed challenge size.
    - Define the gRPC service path for generating auth tokens.
    - Start a gRPC request with the client, using the defined path and request structure; if the request fails, return immediately.
    - Update the `auther` state to `FD_BUNDLE_AUTH_STATE_WAIT_TOKENS` and set `needs_poll` to 0.
    - Set a deadline for the gRPC request using the current wall clock time plus a timeout value.
    - Log a debug message indicating that the request for auth tokens is being made.
- **Output**: No direct output is returned from the function; it modifies the state of the `auther` and initiates a gRPC request.


---
### fd\_bundle\_auther\_handle\_tokens\_resp<!-- {{#callable:fd_bundle_auther_handle_tokens_resp}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_auth.c#L144>)

Processes the response for generating authentication tokens and updates the state of the `fd_bundle_auther_t` object accordingly.
- **Inputs**:
    - `auther`: A pointer to an `fd_bundle_auther_t` structure that holds the state and access token information.
    - `data`: A pointer to the data buffer containing the response to decode.
    - `data_sz`: The size of the data buffer in bytes.
- **Logic and Control Flow**:
    - Initialize a Protobuf input stream from the provided data buffer.
    - Decode the Protobuf message into an `auth_GenerateAuthTokensResponse` structure.
    - Check if the decoding was successful; if not, log a warning and go to the `fail` label.
    - Verify that the response contains a valid access token; if not, log a warning and go to the `fail` label.
    - Check if the access token size is within the allowed limit; if not, log a warning and go to the `fail` label.
    - Copy the access token from the response to the `auther` structure and update the token size.
    - Set the `auther` state to `FD_BUNDLE_AUTH_STATE_DONE_WAIT` and log a debug message.
    - Return 1 to indicate success.
    - In the `fail` label, set the `auther` state to `FD_BUNDLE_AUTH_STATE_REQ_CHALLENGE`, set `needs_poll` to 1, and return 0.
- **Output**: Returns 1 if the response is successfully processed and the access token is valid; otherwise, returns 0.


---
### fd\_bundle\_auther\_poll<!-- {{#callable:fd_bundle_auther_poll}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_auth.c#L178>)

Manages the state transitions for requesting authentication challenges and tokens based on the current state of the `fd_bundle_auther_t` object.
- **Inputs**:
    - `auther`: A pointer to an `fd_bundle_auther_t` object that maintains the state of the authentication process.
    - `client`: A pointer to an `fd_grpc_client_t` object used to make gRPC requests.
    - `keyguard`: A pointer to an `fd_keyguard_client_t` object used for signing challenges.
- **Logic and Control Flow**:
    - Checks the current state of the `auther` object.
    - If the state is `FD_BUNDLE_AUTH_STATE_REQ_CHALLENGE`, calls [`fd_bundle_auther_req_challenge`](<#fd_bundle_auther_req_challenge>) to request an authentication challenge.
    - If the state is `FD_BUNDLE_AUTH_STATE_REQ_TOKENS`, calls [`fd_bundle_auther_req_tokens`](<#fd_bundle_auther_req_tokens>) to request authentication tokens.
    - If the state is neither, does nothing.
- **Output**: No return value; the function modifies the state of the `auther` object as a side effect.
- **Functions Called**:
    - [`fd_bundle_auther_req_challenge`](<#fd_bundle_auther_req_challenge>)
    - [`fd_bundle_auther_req_tokens`](<#fd_bundle_auther_req_tokens>)


---
### fd\_bundle\_auther\_reset<!-- {{#callable:fd_bundle_auther_reset}} -->
[View Source →](<../../../../../src/disco/bundle/fd_bundle_auth.c#L194>)

Resets the state of the `fd_bundle_auther_t` object to request a new authentication challenge.
- **Inputs**:
    - `auther`: A pointer to an `fd_bundle_auther_t` object that needs to be reset.
- **Logic and Control Flow**:
    - Set the `state` of `auther` to `FD_BUNDLE_AUTH_STATE_REQ_CHALLENGE`.
    - Set the `needs_poll` flag of `auther` to 1.
- **Output**: No return value; the function modifies the `auther` object in place.



---
Made with ❤️ by [Driver](https://www.driver.ai/)