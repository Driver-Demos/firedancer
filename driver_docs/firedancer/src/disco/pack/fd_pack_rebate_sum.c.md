<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for managing and processing rebate sums in transaction packs, including adding transactions, reporting, and clearing data.

# Purpose
The code defines a module for managing and calculating rebates associated with transactions in a financial system. It includes functions to initialize, update, report, and clear rebate summaries. The module uses a hash map (`rmap`) to track rebate entries, which are associated with account addresses. The [`fd_pack_rebate_sum_new`](<#fd_pack_rebate_sum_new>) function initializes a rebate summary structure, setting initial values and creating a new map for rebate entries. The [`fd_pack_rebate_sum_add_txn`](<#fd_pack_rebate_sum_add_txn>) function processes a list of transactions, updating the rebate summary with costs and counts based on transaction flags and conditions. It also manages the insertion of account addresses into the map, ensuring that rebates are correctly attributed.

The [`fd_pack_rebate_sum_report`](<#fd_pack_rebate_sum_report>) function generates a report of the current rebate summary, transferring data to an output structure and resetting the summary's internal counters. It also manages the removal of entries from the map. The [`fd_pack_rebate_sum_clear`](<#fd_pack_rebate_sum_clear>) function resets the rebate summary, clearing all accumulated data and removing entries from the map. The module uses conditional compilation to optimize for systems with AVX support, enhancing performance for specific operations. The code is intended to be part of a larger system, likely imported and used by other components to manage transaction rebates efficiently.
# Imports and Dependencies

---
- `fd_pack_rebate_sum.h`
- `fd_pack.h`
- `../../util/simd/fd_avx.h`
- `../../util/tmpl/fd_map.c`


# Global Variables

---
### null\_addr
- **Type**: ``fd_acct_addr_t``
- **Description**: A static constant variable of type `fd_acct_addr_t` initialized to zero. It represents an address with all fields set to zero.
- **Use**: Used as a null or invalid key in the map operations to signify an empty or uninitialized address.


# Functions

---
### fd\_pack\_rebate\_sum\_new<!-- {{#callable:fd_pack_rebate_sum_new}} -->
[View Source →](<../../../../../src/disco/pack/fd_pack_rebate_sum.c#L28>)

Initializes a `fd_pack_rebate_sum_t` structure with default values and sets up a new rebate map.
- **Inputs**:
    - `mem`: A pointer to a memory block where the `fd_pack_rebate_sum_t` structure will be initialized.
- **Logic and Control Flow**:
    - Cast the `mem` pointer to a `fd_pack_rebate_sum_t` pointer `s`.
    - Set `s->total_cost_rebate`, `s->vote_cost_rebate`, `s->data_bytes_rebate`, and `s->microblock_cnt_rebate` to 0UL.
    - Set `s->ib_result` to 0 and `s->writer_cnt` to 0U.
    - Call `rmap_new` to initialize the rebate map `s->map`.
    - Perform a test to ensure the footprint of `rmap` matches the size of `s->map`.
    - Return the original `mem` pointer.
- **Output**: Returns the original `mem` pointer after initializing the `fd_pack_rebate_sum_t` structure.


---
### fd\_pack\_rebate\_sum\_add\_txn<!-- {{#callable:fd_pack_rebate_sum_add_txn}} -->
[View Source →](<../../../../../src/disco/pack/fd_pack_rebate_sum.c#L49>)

Processes a set of transactions to update rebate sums and account mappings, and returns a value related to writer capacity.
- **Inputs**:
    - `s`: A pointer to an `fd_pack_rebate_sum_t` structure that holds rebate sum data and account mappings.
    - `txns`: A pointer to an array of `fd_txn_p_t` structures representing the transactions to process.
    - `adtl_writable`: A pointer to an array of pointers to `fd_acct_addr_t` structures representing additional writable account addresses for each transaction.
    - `txn_cnt`: The number of transactions in the `txns` array.
- **Logic and Control Flow**:
    - If `txn_cnt` is zero, return a calculated value based on `s->writer_cnt` and `HEADROOM`.
    - Initialize variables `is_initializer_bundle`, `ib_success`, and `any_in_block` to track transaction bundle status and success.
    - Iterate over each transaction in `txns`, updating `s->total_cost_rebate`, `s->vote_cost_rebate`, and `s->data_bytes_rebate` based on transaction flags and success.
    - For each transaction, update account mappings in `s->map` with rebated customer units (`rebated_cus`).
    - If a transaction is marked as `FD_TXN_P_FLAGS_SANITIZE_SUCCESS`, update additional writable account mappings.
    - Ensure `s->writer_cnt` does not exceed `FD_PACK_REBATE_SUM_CAPACITY`.
    - Calculate `microblock_cnt_rebate` based on transaction block status and update `s->microblock_cnt_rebate` and `s->data_bytes_rebate`.
    - If the transaction bundle is an initializer and `s->ib_result` is not -1, update `s->ib_result` based on `ib_success`.
    - Return a calculated value based on `s->writer_cnt` and `HEADROOM`.
- **Output**: Returns an `ulong` value calculated from `s->writer_cnt` and `HEADROOM`, indicating the number of times to call report to ensure capacity.


---
### fd\_pack\_rebate\_sum\_report<!-- {{#callable:fd_pack_rebate_sum_report}} -->
[View Source →](<../../../../../src/disco/pack/fd_pack_rebate_sum.c#L128>)

Transfers rebate summary data from `fd_pack_rebate_sum_t` to `fd_pack_rebate_t` and resets the source structure.
- **Inputs**:
    - `s`: A pointer to `fd_pack_rebate_sum_t`, which contains the rebate summary data to be transferred.
    - `out`: A pointer to `fd_pack_rebate_t`, which will receive the rebate summary data from `s`.
- **Logic and Control Flow**:
    - Check if `s->ib_result`, `s->total_cost_rebate`, and `s->writer_cnt` are all zero; if so, return 0UL immediately.
    - Transfer and reset `total_cost_rebate`, `vote_cost_rebate`, `data_bytes_rebate`, `microblock_cnt_rebate`, and `ib_result` from `s` to `out`.
    - Set `out->writer_cnt` to 0U.
    - Determine the minimum of `s->writer_cnt` and 1637UL, and iterate over this range.
    - For each iteration, decrement `s->writer_cnt`, transfer the corresponding `fd_pack_rebate_entry_t` from `s->inserted` to `out->writer_rebates`, and remove the entry from `s->map`.
    - Return the size of `out` minus the size of one `fd_pack_rebate_entry_t`, plus the size of `out->writer_cnt` times the size of `fd_pack_rebate_entry_t`.
- **Output**: Returns the size of the `out` structure adjusted for the number of writer rebates transferred.


---
### fd\_pack\_rebate\_sum\_clear<!-- {{#callable:fd_pack_rebate_sum_clear}} -->
[View Source →](<../../../../../src/disco/pack/fd_pack_rebate_sum.c#L149>)

Resets all rebate-related fields in the `fd_pack_rebate_sum_t` structure to zero and removes all entries from the map.
- **Inputs**:
    - `s`: A pointer to an `fd_pack_rebate_sum_t` structure whose fields and map entries will be cleared.
- **Logic and Control Flow**:
    - Set `total_cost_rebate`, `vote_cost_rebate`, `data_bytes_rebate`, `microblock_cnt_rebate`, and `ib_result` fields of `s` to zero.
    - Store the current value of `writer_cnt` in a local variable `writer_cnt`.
    - Iterate over the range from 0 to `writer_cnt`, decrementing `writer_cnt` each time.
    - In each iteration, retrieve the last inserted entry from `s->inserted` and remove it from the map using `rmap_remove`.
- **Output**: No return value; the function modifies the `fd_pack_rebate_sum_t` structure in place.



---
Made with ❤️ by [Driver](https://www.driver.ai/)