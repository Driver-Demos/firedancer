<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines structures and functions for pacing CU consumption in transaction packing.

# Purpose
The code is a C header file that defines a structure and functions for managing the pacing of compute unit (CU) consumption in a block-based processing system. The primary purpose of this code is to ensure that the consumption of CUs is paced appropriately to optimize the packing of transactions within a block. This is important because without proper pacing, blocks may be filled with non-ideal transactions, and lucrative transactions arriving later may be delayed to the next block. The code defines a structure `fd_pack_pacing_t` that holds information about the start and end times of a block, the maximum number of CUs, and the pacing parameters.

The file provides three main functions: [`fd_pack_pacing_init`](<#fd_pack_pacing_init>), [`fd_pack_pacing_update_consumed_cus`](<#fd_pack_pacing_update_consumed_cus>), and [`fd_pack_pacing_enabled_bank_cnt`](<#fd_pack_pacing_enabled_bank_cnt>). The [`fd_pack_pacing_init`](<#fd_pack_pacing_init>) function initializes the pacing parameters for a block, setting the start and end times, and calculating the maximum CUs and ticks per CU. The [`fd_pack_pacing_update_consumed_cus`](<#fd_pack_pacing_update_consumed_cus>) function updates the remaining CUs based on the consumed CUs, ensuring that the value does not exceed the maximum. The [`fd_pack_pacing_enabled_bank_cnt`](<#fd_pack_pacing_enabled_bank_cnt>) function calculates the number of banks that should be active at a given time, based on the current pacing parameters and the time elapsed. This function helps determine the optimal number of banks to use to fill the block within a specified time frame, minimizing conflicts with active transactions.
# Imports and Dependencies

---
- `../../util/bits/fd_bits.h`
- `math.h`


# Data Structures

---
### fd\_pack\_pacing\_private
- **Type**: ``struct``
- **Members**:
    - `t_start`: Start time of the block in ticks.
    - `t_end`: End time of the block in ticks.
    - `max_cus`: Maximum number of CUs in the block.
    - `ticks_per_cu`: Number of ticks per CU.
    - `remaining_cus`: Number of CUs remaining in the block.
- **Description**: Manages the pacing of CU consumption within a block, using start and end times in ticks, and tracks the maximum and remaining CUs, as well as the ticks per CU.


---
### fd\_pack\_pacing\_t
- **Type**: ``struct``
- **Members**:
    - ``t_start``: Start time of the block in ticks.
    - ``t_end``: End time of the block in ticks.
    - ``max_cus``: Maximum number of Compute Units (CUs) in the block.
    - ``ticks_per_cu``: Number of ticks per Compute Unit.
    - ``remaining_cus``: Number of remaining Compute Units.
- **Description**: Manages the pacing of Compute Unit (CU) consumption within a block, ensuring that transactions are optimally packed by controlling the timing and number of CUs used. It tracks the start and end times of a block, the maximum CUs allowed, and calculates the ticks per CU to determine the remaining CUs available for use.


# Functions

---
### fd\_pack\_pacing\_init<!-- {{#callable:fd_pack_pacing_init}} -->
[View Source →](<../../../../../src/disco/pack/fd_pack_pacing.h#L34>)

Initializes the pacing parameters for a given time slot and maximum compute units (CUs).
- **Inputs**:
    - `pacer`: A pointer to an `fd_pack_pacing_t` structure that will store the pacing parameters.
    - `t_start`: The start time of the block in ticks.
    - `t_end`: The end time of the block in ticks.
    - `ticks_per_ns`: The number of ticks per nanosecond, used to calculate ticks per CU.
    - `max_cus`: The maximum number of compute units (CUs) for the block.
- **Logic and Control Flow**:
    - Assigns `t_start` and `t_end` to the `pacer` structure.
    - Calculates `ticks_per_cu` as 9.0 times `ticks_per_ns` and assigns it to the `pacer` structure.
    - Adjusts `max_cus` to end 5% before `t_end` and assigns it to the `pacer` structure.
    - Sets `remaining_cus` to the adjusted `max_cus`.
- **Output**: No return value; modifies the `pacer` structure in place.


---
### fd\_pack\_pacing\_update\_consumed\_cus<!-- {{#callable:fd_pack_pacing_update_consumed_cus}} -->
[View Source →](<../../../../../src/disco/pack/fd_pack_pacing.h#L62>)

Updates the remaining compute units (CUs) in the pacer by subtracting the consumed CUs from the maximum CUs, ensuring the result is not negative.
- **Inputs**:
    - ``pacer``: A pointer to an `fd_pack_pacing_t` structure that holds pacing information, including maximum and remaining CUs.
    - ``consumed_cus``: An unsigned long integer representing the number of CUs that have been consumed.
    - ``now``: A long integer representing the current time in `fd_tickcount` space, although it is not used in the function.
- **Logic and Control Flow**:
    - The function does not use the `now` parameter, as indicated by the `(void)now;` statement.
    - Calculates the remaining CUs by subtracting `consumed_cus` from `pacer->max_cus`.
    - Uses the `fmaxf` function to ensure that the remaining CUs do not fall below 0, clamping the value at 0 if necessary.
    - Updates `pacer->remaining_cus` with the calculated value.
- **Output**: No return value; the function updates the `remaining_cus` field of the `pacer` structure in place.


---
### fd\_pack\_pacing\_enabled\_bank\_cnt<!-- {{#callable:fd_pack_pacing_enabled_bank_cnt}} -->
[View Source →](<../../../../../src/disco/pack/fd_pack_pacing.h#L81>)

Calculates the number of bank tiles to activate based on the current time and remaining compute units (CUs).
- **Inputs**:
    - `pacer`: A pointer to a `fd_pack_pacing_t` structure containing pacing information such as remaining CUs and timing details.
    - `now`: The current time in the same time unit as `t_end` in the `fd_pack_pacing_t` structure.
- **Logic and Control Flow**:
    - Calculate the time difference between `pacer->t_end` and `now`, ensuring the denominator is at least 1 to avoid division by zero.
    - Compute the number of banks to activate by dividing `pacer->remaining_cus` by the time difference and multiplying by `pacer->ticks_per_cu`.
    - Return the result as an unsigned long integer, representing the number of banks to activate.
- **Output**: An unsigned long integer indicating the number of bank tiles to activate, which may be zero or exceed the number of available banks.



---
Made with ❤️ by [Driver](https://www.driver.ai/)