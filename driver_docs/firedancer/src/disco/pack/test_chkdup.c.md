<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for false positive rates, null checks, and duplicate detection in the `fd_chkdup` component.

# Purpose
The code is a C program designed to test and evaluate the performance and accuracy of a duplicate checking mechanism, likely implemented in the `fd_chkdup` library. It includes several test functions such as [`test_false_positive_rate`](<#test_false_positive_rate>), [`test_null`](<#test_null>), and [`test_duplicates`](<#test_duplicates>), which assess the false positive rate, null handling, and duplicate detection capabilities of different checking functions (`fd_chkdup_check`, `fd_chkdup_check_slow`, and `fd_chkdup_check_fast`). The program uses a random number generator (`fd_rng_t`) to create test data and measure the effectiveness of the duplicate checking functions under various conditions.

The [`populate_unique`](<#populate_unique>) function is a key component that fills a memory region with unique values, ensuring no aligned 4-byte sequence is repeated. The [`main`](<#main>) function orchestrates the execution of the tests, using predefined false positive rates stored in the `FALSE_POSITIVE_RATE` array to validate the results. It also measures the performance of the checking functions by calculating the time taken per transaction. The program logs the results of the tests and performance measurements, providing insights into the efficiency and reliability of the duplicate checking implementations.
# Imports and Dependencies

---
- `fd_chkdup.h`
- `math.h`


# Global Variables

---
### FALSE\_POSITIVE\_RATE
- **Type**: ``const float[3][129]``
- **Description**: Stores a 3x129 matrix of floating-point values representing false positive rates. Each row in the matrix corresponds to a different configuration or scenario, and each column represents a specific test or condition.
- **Use**: Used to access predefined false positive rates for different configurations in the program.


# Functions

---
### populate\_unique<!-- {{#callable:populate_unique}} -->
[View Source →](<../../../../../src/disco/pack/test_chkdup.c#L17>)

Populates a memory region with unique 4-byte sequences derived from a seed value.
- **Inputs**:
    - ``seed``: An unsigned long integer used as the initial value for generating unique sequences.
    - ``mem``: A pointer to the memory region where the unique sequences will be stored.
    - ``sz``: The size of the memory region in bytes, which must be a multiple of 4.
- **Logic and Control Flow**:
    - Checks that `sz` is a multiple of the size of `uint` (4 bytes).
    - Iterates over the memory region in steps of 4 bytes.
    - For each 4-byte block, computes a hash of the current `seed` and stores it in the memory region.
    - Updates the `seed` using a linear congruential generator formula with a multiplier of `2208550410UL` and modulus `P`.
    - Returns the updated `seed` value.
- **Output**: Returns the updated seed value as an unsigned long integer.


---
### test\_false\_positive\_rate<!-- {{#callable:test_false_positive_rate}} -->
[View Source →](<../../../../../src/disco/pack/test_chkdup.c#L30>)

Evaluates the false positive rate of a checker function against expected values using a statistical approximation.
- **Inputs**:
    - `expected`: The expected false positive rate as a float.
    - `f`: A function pointer to the checker function to test.
    - `rng`: A pointer to a random number generator state.
    - `l0_cnt`: The number of elements in the first list to check.
    - `l1_cnt`: The number of elements in the second list to check.
- **Logic and Control Flow**:
    - Initialize `iters` to 100,000 and `false_positives` to 0.
    - Create arrays `l0` and `l1` to hold addresses, and initialize a `chkdup` structure for duplicate checking.
    - Iterate `iters` times, generating a unique base using `fd_rng_uint_roll` and populating `l0` and `l1` with unique addresses using [`populate_unique`](<#populate_unique>).
    - Call the checker function `f` with `chkdup`, `l0`, `l0_cnt`, `l1`, and `l1_cnt`, and accumulate the result in `false_positives`.
    - Calculate `acceptable_false_positives` using a normal approximation to the binomial distribution with the given `expected` rate.
    - Log the results and return whether `false_positives` is less than or equal to `acceptable_false_positives`.
- **Output**: Returns an integer indicating whether the observed false positive rate is within acceptable limits.
- **Functions Called**:
    - [`fd_chkdup_join`](<fd_chkdup.h.md#fd_chkdup_join>)
    - [`fd_chkdup_new`](<fd_chkdup.h.md#fd_chkdup_new>)
    - [`populate_unique`](<#populate_unique>)
    - [`fd_chkdup_delete`](<fd_chkdup.h.md#fd_chkdup_delete>)
    - [`fd_chkdup_leave`](<fd_chkdup.h.md#fd_chkdup_leave>)


---
### test\_null<!-- {{#callable:test_null}} -->
[View Source →](<../../../../../src/disco/pack/test_chkdup.c#L69>)

Tests for false positives in a sequence of addresses by replacing elements with zero and checking the results using a provided checker function.
- **Inputs**:
    - `f`: A function pointer to a checker function that tests for duplicates in address sequences.
    - `rng`: A pointer to a random number generator state used for generating random values.
- **Logic and Control Flow**:
    - Initialize an array `l0` with 128 unique addresses using [`populate_unique`](<#populate_unique>).
    - Create a `chkdup` object for duplicate checking using [`fd_chkdup_new`](<fd_chkdup.h.md#fd_chkdup_new>) and [`fd_chkdup_join`](<fd_chkdup.h.md#fd_chkdup_join>).
    - Iterate over each element in `l0`, replace it with zero, and use the checker function `f` to test for false positives in the surrounding 8 elements.
    - Restore the original element in `l0` after each check.
    - Iterate over all 8-bit numbers, replace elements in `l0` with zero based on the bit pattern, and use the checker function `f` to test for false positives.
    - Log the number of false positives found out of 136 possible cases.
    - Delete the `chkdup` object using [`fd_chkdup_leave`](<fd_chkdup.h.md#fd_chkdup_leave>) and [`fd_chkdup_delete`](<fd_chkdup.h.md#fd_chkdup_delete>).
- **Output**: Returns 1 if the test completes without finding unexpected results, otherwise returns 0 if a test fails.
- **Functions Called**:
    - [`fd_chkdup_join`](<fd_chkdup.h.md#fd_chkdup_join>)
    - [`fd_chkdup_new`](<fd_chkdup.h.md#fd_chkdup_new>)
    - [`populate_unique`](<#populate_unique>)
    - [`fd_chkdup_delete`](<fd_chkdup.h.md#fd_chkdup_delete>)
    - [`fd_chkdup_leave`](<fd_chkdup.h.md#fd_chkdup_leave>)


---
### test\_duplicates<!-- {{#callable:test_duplicates}} -->
[View Source →](<../../../../../src/disco/pack/test_chkdup.c#L110>)

Checks for duplicate entries in a list by modifying and testing combinations of list elements.
- **Inputs**:
    - `f`: A function pointer of type `checker` that checks for duplicates.
    - `rng`: A pointer to a random number generator of type `fd_rng_t`.
- **Logic and Control Flow**:
    - Initialize an array `l0` of type `fd_acct_addr_t` with 128 elements.
    - Create a `fd_chkdup_t` object using [`fd_chkdup_new`](<fd_chkdup.h.md#fd_chkdup_new>) and join it with [`fd_chkdup_join`](<fd_chkdup.h.md#fd_chkdup_join>).
    - Generate a random base value using `fd_rng_uint_roll` and populate `l0` with unique values using [`populate_unique`](<#populate_unique>).
    - Iterate over each pair of indices `i` and `j` in the range [0, 128), skipping when `i` equals `j`.
    - Temporarily set `l0[j]` to `l0[i]` to create a duplicate.
    - Calculate `l0_cnt` and `l1_cnt` to determine the number of elements to check for duplicates.
    - Call the function `f` with the current configuration of `l0`, `l0_cnt`, and `l1_cnt`.
    - If `f` returns 0, indicating a duplicate was found, return 0.
    - Restore the original value of `l0[j]` after the check.
    - Delete the `fd_chkdup_t` object using [`fd_chkdup_delete`](<fd_chkdup.h.md#fd_chkdup_delete>) and [`fd_chkdup_leave`](<fd_chkdup.h.md#fd_chkdup_leave>).
- **Output**: Returns 1 if no duplicates are found, otherwise returns 0 if a duplicate is detected.
- **Functions Called**:
    - [`fd_chkdup_join`](<fd_chkdup.h.md#fd_chkdup_join>)
    - [`fd_chkdup_new`](<fd_chkdup.h.md#fd_chkdup_new>)
    - [`populate_unique`](<#populate_unique>)
    - [`fd_chkdup_delete`](<fd_chkdup.h.md#fd_chkdup_delete>)
    - [`fd_chkdup_leave`](<fd_chkdup.h.md#fd_chkdup_leave>)


---
### performance\_test<!-- {{#callable:performance_test}} -->
[View Source →](<../../../../../src/disco/pack/test_chkdup.c#L146>)

Measures the performance of different `fd_chkdup` check functions by calculating the average time per transaction over a fixed number of iterations.
- **Inputs**:
    - ``rng``: A pointer to a random number generator of type `fd_rng_t` used for generating random numbers.
    - ``which``: An integer that specifies which `fd_chkdup` check function to use: 0 for [`fd_chkdup_check`](<fd_chkdup.h.md#fd_chkdup_check>), 1 for [`fd_chkdup_check_slow`](<fd_chkdup.h.md#fd_chkdup_check_slow>), and 2 for `fd_chkdup_check_fast`.
- **Logic and Control Flow**:
    - Initialize an array `l0` of type `fd_acct_addr_t` with 32 elements.
    - Create a `fd_chkdup_t` object using [`fd_chkdup_new`](<fd_chkdup.h.md#fd_chkdup_new>) and join it with [`fd_chkdup_join`](<fd_chkdup.h.md#fd_chkdup_join>).
    - Generate a random base using `fd_rng_uint_roll` and populate `l0` with unique values using [`populate_unique`](<#populate_unique>).
    - Initialize `false_positives` to 0 and set `iters` to 100,000.
    - Start a timer by subtracting the current wall clock time from `time`.
    - Loop over `iters` iterations, and for each iteration, loop over 10 sub-iterations.
    - In each sub-iteration, set `l0_cnt` based on the value of `k` using a switch statement.
    - Use another switch statement to call the appropriate `fd_chkdup` check function based on `which`, and accumulate the result in `false_positives`.
    - Use `FD_COMPILER_FORGET` to prevent compiler optimizations on `false_positives`.
    - After the loops, add the current wall clock time to `time` to calculate the elapsed time.
    - Delete the `fd_chkdup_t` object using [`fd_chkdup_delete`](<fd_chkdup.h.md#fd_chkdup_delete>) and [`fd_chkdup_leave`](<fd_chkdup.h.md#fd_chkdup_leave>).
    - Return the average time per transaction by dividing `time` by the total number of transactions (`iters * 10`).
- **Output**: Returns the average time per transaction as an `ulong`, calculated by dividing the total elapsed time by the number of iterations and sub-iterations.
- **Functions Called**:
    - [`fd_chkdup_join`](<fd_chkdup.h.md#fd_chkdup_join>)
    - [`fd_chkdup_new`](<fd_chkdup.h.md#fd_chkdup_new>)
    - [`populate_unique`](<#populate_unique>)
    - [`fd_chkdup_check`](<fd_chkdup.h.md#fd_chkdup_check>)
    - [`fd_chkdup_check_slow`](<fd_chkdup.h.md#fd_chkdup_check_slow>)
    - [`fd_chkdup_delete`](<fd_chkdup.h.md#fd_chkdup_delete>)
    - [`fd_chkdup_leave`](<fd_chkdup.h.md#fd_chkdup_leave>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/disco/pack/test_chkdup.c#L193>)

Executes a series of tests to evaluate false positive rates, performance, and duplicate detection using different checking functions.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Retrieves the `--test-interval` value from the command line using `fd_env_strip_cmdline_ulong`, defaulting to 4 if not provided.
    - Initializes a random number generator `rng` with a seed using `fd_rng_new` and `fd_rng_join`.
    - Retrieves a pointer to the false positive rate array for the current implementation using `FALSE_POSITIVE_RATE[FD_CHKDUP_IMPL]`.
    - Iterates over a range of values to test false positive rates using [`test_false_positive_rate`](<#test_false_positive_rate>) with different checking functions (`fd_chkdup_check`, `fd_chkdup_check_slow`, `fd_chkdup_check_fast`).
    - Logs performance metrics for each checking function using [`performance_test`](<#performance_test>).
    - Tests for null and duplicate cases using [`test_null`](<#test_null>) and [`test_duplicates`](<#test_duplicates>) with each checking function.
    - Logs a 'pass' message if all tests succeed.
    - Calls `fd_halt` to terminate the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`test_false_positive_rate`](<#test_false_positive_rate>)
    - [`performance_test`](<#performance_test>)
    - [`test_null`](<#test_null>)
    - [`test_duplicates`](<#test_duplicates>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)