<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functionality for arranging verified transactions into microblocks for serial execution, with potential parallel execution if transactions do not write to the same accounts.

# Purpose
The code is a C source file that implements a module for managing and scheduling transactions into microblocks for execution in a distributed system. The primary functionality of this module is to take verified transactions and arrange them into groups called "microblocks," which can be executed serially or in parallel, depending on whether they write to the same accounts. The module is part of a larger system that handles transaction processing, likely in a blockchain or distributed ledger context.

Key components of the code include the `fd_pack_ctx_t` structure, which maintains the state and configuration for the transaction packing process, and several functions that manage the lifecycle of transactions and microblocks. The code defines constants and macros for configuration, such as `MICROBLOCK_DURATION_NS` and `TRANSACTION_LIFETIME_SLOTS`, which control the pacing and lifetime of transactions. The module interfaces with other components through various input and output links, and it uses a strategy pattern to determine how transactions are scheduled. The code also includes mechanisms for handling leader transitions, transaction expiration, and metrics collection to monitor performance.
# Imports and Dependencies

---
- `../tiles.h`
- `generated/fd_pack_tile_seccomp.h`
- `../../util/pod/fd_pod_format.h`
- `../../discof/replay/fd_replay_tile.h`
- `../fd_txn_m.h`
- `../keyguard/fd_keyload.h`
- `../keyguard/fd_keyswitch.h`
- `../keyguard/fd_keyguard.h`
- `../metrics/fd_metrics.h`
- `../pack/fd_pack.h`
- `../pack/fd_pack_cost.h`
- `../pack/fd_pack_pacing.h`
- `linux/unistd.h`
- `string.h`
- `../../../../util/tmpl/fd_deque.c`
- `../stem/fd_stem.c`


# Global Variables

---
### CUS\_PER\_MICROBLOCK
- **Type**: ``const ulong``
- **Description**: Defines the number of cost units (CUs) allocated per microblock, set to 1,600,000. This value is used to determine the maximum computational resources that can be consumed by transactions within a single microblock.
- **Use**: Used to limit the computational resources for transactions in a microblock.


---
### VOTE\_FRACTION
- **Type**: ``float``
- **Description**: A constant floating-point variable that represents a fraction of votes to be scheduled in a microblock. The value is set to `0.75f` by default, indicating that 75% of available votes should be scheduled.
- **Use**: Used to determine the proportion of votes to schedule in a microblock during transaction packing.


---
### schedule\_strategy\_strings
- **Type**: ``char const * const[3]``
- **Description**: An array of constant character pointers that represent different scheduling strategies. The array contains three strings: "PRF", "BAL", and "BUN".
- **Use**: Used to map scheduling strategy identifiers to their string representations.


# Data Structures

---
### block\_builder\_info\_t
- **Type**: ``struct``
- **Members**:
    - ``commission_pubkey``: An array of `fd_acct_addr_t` with a single element, representing the commission public key.
    - ``commission``: An `ulong` representing the commission value.
- **Description**: `block_builder_info_t` is a structure that holds information about a block builder, specifically the commission public key and the commission value. The `commission_pubkey` is an array with one element of type `fd_acct_addr_t`, which stores the public key associated with the commission. The `commission` is an unsigned long integer that represents the commission amount. This structure is used to configure block building parameters in the context of transaction processing.


---
### fd\_pack\_in\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``mem``: Pointer to a `fd_wksp_t` workspace.
    - ``chunk0``: Unsigned long integer representing the initial chunk.
    - ``wmark``: Unsigned long integer representing the watermark.
- **Description**: `fd_pack_in_ctx_t` is a structure that holds context information for input data in a packing process. It includes a pointer to a workspace (`mem`), and two unsigned long integers (`chunk0` and `wmark`) that likely represent the starting chunk and a watermark for managing data chunks.


---
### fd\_pack\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``pack``: Pointer to an `fd_pack_t` structure.
    - ``cur_spot``: Pointer to an `fd_txn_e_t` structure indicating the current transaction spot.
    - ``is_bundle``: Integer flag indicating if the current transaction is a bundle.
    - ``executed_txn_sig``: Array of 64 unsigned characters storing the signature of the executed transaction.
    - ``strategy``: Integer representing the packing strategy, one of the `FD_PACK_STRATEGY_*` values.
    - ``max_pending_transactions``: Unsigned long indicating the maximum number of pending transactions.
    - ``leader_slot``: Unsigned long representing the leader slot being packed for, or `ULONG_MAX` if not the leader.
    - ``leader_bank``: Pointer to a constant void representing the leader bank.
    - ``leader_bank_idx``: Unsigned long indicating the index of the leader bank.
    - ``_became_leader``: Array of one `fd_became_leader_t` structure used internally.
    - ``slot_microblock_cnt``: Unsigned long tracking the number of microblocks packed for the current leader slot.
    - ``pack_idx``: Unsigned integer counter incremented when packing for a slot is finished.
    - ``pack_txn_cnt``: Unsigned long tracking the total number of transactions packed since startup.
    - ``slot_max_microblocks``: Unsigned long indicating the maximum number of microblocks that can be packed in the current slot.
    - ``slot_max_data``: Unsigned long representing the cap in bytes of transaction data produced in each block.
    - ``larger_shred_limits_per_block``: Integer flag for larger shred limits per block.
    - ``limits``: Structure containing consensus critical slot cost limits.
    - ``drain_banks``: Integer flag indicating if banks must be idle before scheduling more microblocks.
    - ``approx_wallclock_ns``: Long representing the approximate wallclock time in nanoseconds.
    - ``approx_tickcount``: Long representing the approximate tick count.
    - ``rng``: Pointer to an `fd_rng_t` structure for random number generation.
    - ``slot_end_ns``: Long representing the end wallclock time of the leader slot being packed for.
    - ``pacer``: Array of one `fd_pack_pacing_t` structure used for pacing CUs through the slot.
    - ``ticks_per_ns``: Double representing the cached value of ticks per nanosecond.
    - ``last_successful_insert``: Long storing the tick count of the last successful transaction insert.
    - ``highest_observed_slot``: Unsigned long storing the highest slot number observed from any transaction.
    - ``microblock_duration_ticks``: Unsigned long representing the duration of a microblock in ticks.
    - ``wait_duration_ticks``: Array of unsigned longs representing wait durations scaled to ticks.
    - ``extra_txn_deq``: Pointer to an `fd_txn_e_t` structure for extra transaction deque (if `FD_PACK_USE_EXTRA_STORAGE` is defined).
    - ``insert_to_extra``: Integer flag indicating if the last insert was into the pack or the extra deque.
    - ``in``: Array of 32 `fd_pack_in_ctx_t` structures for input contexts.
    - ``in_kind``: Array of 32 integers indicating the kind of input.
    - ``bank_cnt``: Unsigned long representing the number of banks.
    - ``bank_idle_bitset``: Unsigned long bitset indicating idle banks.
    - ``poll_cursor``: Integer indicating the next bank to poll.
    - ``use_consumed_cus``: Integer flag indicating if consumed CUs are used.
    - ``skip_cnt``: Long counter for skipping.
    - ``bank_current``: Array of pointers to unsigned longs representing current bank states.
    - ``bank_expect``: Array of unsigned longs representing expected bank states.
    - ``bank_ready_at``: Array of longs indicating when banks are ready.
    - ``bank_out_mem``: Pointer to an `fd_wksp_t` structure for bank output memory.
    - ``bank_out_chunk0``: Unsigned long representing the initial chunk of bank output.
    - ``bank_out_wmark``: Unsigned long representing the watermark of bank output.
    - ``bank_out_chunk``: Unsigned long representing the current chunk of bank output.
    - ``poh_out_mem``: Pointer to an `fd_wksp_t` structure for PoH output memory.
    - ``poh_out_chunk0``: Unsigned long representing the initial chunk of PoH output.
    - ``poh_out_wmark``: Unsigned long representing the watermark of PoH output.
    - ``poh_out_chunk``: Unsigned long representing the current chunk of PoH output.
    - ``insert_result``: Array of unsigned longs storing results of transaction inserts.
    - ``schedule_duration``: Array of one `fd_histf_t` structure for scheduling duration metrics.
    - ``no_sched_duration``: Array of one `fd_histf_t` structure for no scheduling duration metrics.
    - ``insert_duration``: Array of one `fd_histf_t` structure for insert duration metrics.
    - ``complete_duration``: Array of one `fd_histf_t` structure for complete duration metrics.
    - ``metric_state``: Unsigned integer representing the current metric state.
    - ``metric_state_begin``: Long representing the beginning of the metric state.
    - ``metric_timing``: Array of 16 longs for metric timing.
    - ``last_sched_metrics``: Array of one structure storing the last scheduled metrics.
    - ``current_bundle``: Array of one structure storing the current bundle information.
    - ``blk_engine_cfg``: Array of one `block_builder_info_t` structure for block engine configuration.
    - ``crank``: Array of one structure for crank-related data.
    - ``pending_rebate_sz``: Unsigned long representing the size of pending rebates.
    - ``rebate``: Union containing an array of one `fd_pack_rebate_t` structure or a footprint array.
- **Description**: `fd_pack_ctx_t` is a complex data structure used in a transaction packing system. It manages the state and configuration for packing transactions into microblocks, handling leader transitions, and maintaining metrics. The structure includes pointers to various transaction and bank-related contexts, configuration parameters for transaction limits, pacing, and strategies, as well as metrics and state tracking for transaction processing. It supports additional storage for transactions when the main pack is full and includes mechanisms for handling leader transitions and scheduling microblocks efficiently.


# Functions

---
### update\_metric\_state<!-- {{#callable:update_metric_state}} -->
[View Source →](<../../../../../src/disco/pack/fd_pack_tile.c#L320>)

Updates the metric state in the context and records timing if the state changes.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_pack_ctx_t` structure that holds the current metric state and timing information.
    - ``effective_as_of``: A long integer representing the current time or timestamp when the metric state is updated.
    - ``type``: An integer representing the type of metric state to update.
    - ``status``: An integer representing the new status to set for the specified metric type.
- **Logic and Control Flow**:
    - Calculate the `current_state` by inserting the `status` bit at the `type` position in `ctx->metric_state` using `fd_uint_insert_bit` function.
    - Check if `current_state` is different from `ctx->metric_state`.
    - If the state has changed, update the timing for the previous state by adding the time difference (`effective_as_of - ctx->metric_state_begin`) to `ctx->metric_timing` for the previous state.
    - Set `ctx->metric_state_begin` to `effective_as_of` to mark the start of the new state.
    - Update `ctx->metric_state` to `current_state`.
- **Output**: No return value; the function updates the state and timing in the provided context.


---
### remove\_ib<!-- {{#callable:remove_ib}} -->
[View Source →](<../../../../../src/disco/pack/fd_pack_tile.c#L333>)

Attempts to delete an initializer bundle if it is enabled and marked as inserted, and then resets the insertion flag.
- **Inputs**:
    - ``ctx``: A pointer to a `fd_pack_ctx_t` structure that contains the context for the pack operation, including the state of the crank and pack.
- **Logic and Control Flow**:
    - Checks if the `enabled` and `ib_inserted` flags in `ctx->crank` are set using a bitwise AND operation.
    - If the condition is true, calls `fd_pack_delete_transaction` to attempt to delete the transaction associated with the last signature stored in `ctx->crank->last_sig`.
    - Increments the transaction deleted metric using `FD_MCNT_INC`.
    - Resets the `ib_inserted` flag in `ctx->crank` to 0.
- **Output**: No return value; the function operates by modifying the state of the `ctx` structure.


---
### scratch\_align<!-- {{#callable:scratch_align}} -->
[View Source →](<../../../../../src/disco/pack/fd_pack_tile.c#L345>)

Returns a constant alignment value of 4096.
- **Inputs**: None
- **Logic and Control Flow**:
    - The function is defined as `static inline`, indicating it is intended for use within the same translation unit and suggests inlining for performance.
    - The function returns a constant value of `4096UL`, which is an unsigned long integer.
- **Output**: An unsigned long integer with the value 4096.


---
### scratch\_footprint<!-- {{#callable:scratch_footprint}} -->
[View Source →](<../../../../../src/disco/pack/fd_pack_tile.c#L350>)

Calculates the memory footprint required for a scratch space based on the configuration of a given tile.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure that contains configuration details for the tile, including packing limits and transaction settings.
- **Logic and Control Flow**:
    - Initialize a `fd_pack_limits_t` structure with limits based on the `tile` configuration, using either larger or default values for maximum cost and data bytes per block.
    - Initialize a variable `l` with `FD_LAYOUT_INIT` to start the layout calculation.
    - Append the size and alignment of `fd_pack_ctx_t` to `l` using `FD_LAYOUT_APPEND`.
    - Append the alignment and footprint of a random number generator using `FD_LAYOUT_APPEND`.
    - Append the alignment and footprint of a pack context using `FD_LAYOUT_APPEND`, with parameters from the `tile` and the initialized limits.
    - If `FD_PACK_USE_EXTRA_STORAGE` is defined, append the alignment and footprint of extra transaction deque storage using `FD_LAYOUT_APPEND`.
    - Finalize the layout calculation with `FD_LAYOUT_FINI` using `l` and the alignment from `scratch_align()`.
- **Output**: Returns an `ulong` representing the total memory footprint required for the scratch space.
- **Functions Called**:
    - [`scratch_align`](<#scratch_align>)


---
### log\_end\_block\_metrics<!-- {{#callable:log_end_block_metrics}} -->
[View Source →](<../../../../../src/disco/pack/fd_pack_tile.c#L374>)

Logs the end-of-block metrics for a transaction scheduling context.
- **Inputs**:
    - ``ctx``: A pointer to a `fd_pack_ctx_t` structure representing the transaction scheduling context.
    - ``now``: A long integer representing the current time in ticks.
    - ``reason``: A constant character pointer representing the reason for ending the block.
- **Logic and Control Flow**:
    - Defines macros `DELTA` and `AVAIL` to calculate differences in transaction schedule metrics and available transactions, respectively.
    - Logs detailed information about the end of a block, including slot number, reason, bank idle bitset, time since last schedule, various transaction metrics, and available transactions.
    - Uses the `FD_LOG_INFO` macro to output the formatted log message.
    - Undefines the `DELTA` and `AVAIL` macros after use.
- **Output**: No return value; outputs a log message with block metrics.


---
### metrics\_write<!-- {{#callable:metrics_write}} -->
[View Source →](<../../../../../src/disco/pack/fd_pack_tile.c#L392>)

Copies various metrics from the `fd_pack_ctx_t` context to the appropriate metric counters and histograms, and writes them using `fd_pack_metrics_write`.
- **Inputs**:
    - `ctx`: A pointer to an `fd_pack_ctx_t` structure containing the context and metrics to be written.
- **Logic and Control Flow**:
    - Copies the `insert_result` from `ctx` to the `TRANSACTION_INSERTED` metric using `FD_MCNT_ENUM_COPY`.
    - Copies the `metric_timing` from `ctx` to the `METRIC_TIMING` metric using `FD_MCNT_ENUM_COPY`.
    - Copies the `metrics` from `ctx->crank` to the `BUNDLE_CRANK_STATUS` metric using `FD_MCNT_ENUM_COPY`.
    - Copies the `schedule_duration` from `ctx` to the `SCHEDULE_MICROBLOCK_DURATION_SECONDS` histogram using `FD_MHIST_COPY`.
    - Copies the `no_sched_duration` from `ctx` to the `NO_SCHED_MICROBLOCK_DURATION_SECONDS` histogram using `FD_MHIST_COPY`.
    - Copies the `insert_duration` from `ctx` to the `INSERT_TRANSACTION_DURATION_SECONDS` histogram using `FD_MHIST_COPY`.
    - Copies the `complete_duration` from `ctx` to the `COMPLETE_MICROBLOCK_DURATION_SECONDS` histogram using `FD_MHIST_COPY`.
    - Calls `fd_pack_metrics_write` with `ctx->pack` to write the metrics.
- **Output**: This function does not return a value; it performs operations for side effects on the metrics.


---
### during\_housekeeping<!-- {{#callable:during_housekeeping}} -->
[View Source →](<../../../../../src/disco/pack/fd_pack_tile.c#L405>)

Updates the approximate wallclock and tick count in the context and handles a keyswitch state transition if needed.
- **Inputs**:
    - ``ctx``: A pointer to a `fd_pack_ctx_t` structure that holds the context for the function, including timing and keyswitch state information.
- **Logic and Control Flow**:
    - Set `ctx->approx_wallclock_ns` to the current wallclock time using `fd_log_wallclock()`.
    - Set `ctx->approx_tickcount` to the current tick count using `fd_tickcount()`.
    - Check if `ctx->crank->enabled` is true and the keyswitch state is `FD_KEYSWITCH_STATE_SWITCH_PENDING`.
    - If the keyswitch state is pending, copy the keyswitch bytes to `ctx->crank->identity_pubkey` and set the keyswitch state to `FD_KEYSWITCH_STATE_COMPLETED`.
- **Output**: No return value; the function updates the context structure in place.


---
### before\_credit<!-- {{#callable:before_credit}} -->
[View Source →](<../../../../../src/disco/pack/fd_pack_tile.c#L416>)

Checks if the current transaction spot is not part of a bundle and cleans up if necessary.
- **Inputs**:
    - ``ctx``: A pointer to a `fd_pack_ctx_t` structure that holds the context for the current packing operation.
    - ``stem``: A pointer to a `fd_stem_context_t` structure, which is not used in this function.
    - ``charge_busy``: A pointer to an integer that indicates if the function has performed a busy operation.
- **Logic and Control Flow**:
    - Ignores the `stem` parameter as it is not used in the function.
    - Checks if `ctx->cur_spot` is not `NULL` and `ctx->is_bundle` is false using `FD_UNLIKELY`.
    - If the condition is true, sets `*charge_busy` to 1, indicating a busy operation.
    - If `FD_PACK_USE_EXTRA_STORAGE` is defined, checks if `ctx->insert_to_extra` is false using `FD_LIKELY`.
    - If `ctx->insert_to_extra` is false, calls `fd_pack_insert_txn_cancel` to cancel the transaction at `ctx->cur_spot`.
    - If `ctx->insert_to_extra` is true, calls `extra_txn_deq_remove_tail` to remove the transaction from the extra transaction deque.
    - If `FD_PACK_USE_EXTRA_STORAGE` is not defined, directly calls `fd_pack_insert_txn_cancel`.
    - Sets `ctx->cur_spot` to `NULL` to indicate that the current spot is cleaned up.
- **Output**: No return value; the function modifies the `charge_busy` and `ctx->cur_spot` variables.


---
### insert\_from\_extra<!-- {{#callable:insert_from_extra}} -->
[View Source →](<../../../../../src/disco/pack/fd_pack_tile.c#L447>)

Transfers a transaction from the extra transaction deque to the main pack context for processing.
- **Inputs**:
    - ``ctx``: A pointer to a `fd_pack_ctx_t` structure that contains the context for the pack operation, including the extra transaction deque and the pack where the transaction will be inserted.
- **Logic and Control Flow**:
    - Initialize a transaction spot in the pack using `fd_pack_insert_txn_init` with `ctx->pack`.
    - Peek at the head of the extra transaction deque using `extra_txn_deq_peek_head` to get the transaction to insert.
    - Copy the transaction payload, transaction data, and alternate accounts from the dequeued transaction to the initialized spot in the pack using `fd_memcpy`.
    - Set various metadata fields in the transaction spot, such as `payload_sz`, `source_tpu`, `source_ipv4`, and `scheduler_arrival_time_nanos`, from the dequeued transaction.
    - Remove the transaction from the head of the extra transaction deque using `extra_txn_deq_remove_head`.
    - Calculate the blockhash slot from the dequeued transaction's metadata.
    - Record the start time for the insertion duration measurement using `fd_tickcount`.
    - Finalize the transaction insertion into the pack using `fd_pack_insert_txn_fini`, passing the blockhash slot and a pointer to a `deleted` counter.
    - Calculate the insertion duration by subtracting the start time from the current time using `fd_tickcount`.
    - Increment the transaction deleted metric by the number of deleted transactions.
    - Update the insertion result count in `ctx->insert_result` based on the result of the insertion.
    - Record the insertion duration in a histogram using `fd_histf_sample`.
    - Increment the transaction inserted from extra metric by 1.
- **Output**: Returns an integer result from `fd_pack_insert_txn_fini`, indicating the success or failure of the transaction insertion.


---
### after\_credit<!-- {{#callable:after_credit}} -->
[View Source →](<../../../../../src/disco/pack/fd_pack_tile.c#L476>)

Manages the scheduling and completion of microblocks in a transaction processing system, handling various states and conditions to optimize performance.
- **Inputs**:
    - ``ctx``: A pointer to a `fd_pack_ctx_t` structure that holds the context for the transaction processing system.
    - ``stem``: A pointer to a `fd_stem_context_t` structure used for publishing and managing transaction data.
    - ``opt_poll_in``: An optional pointer to an integer, which is not used in the function.
    - ``charge_busy``: A pointer to an integer that indicates if the system is busy processing transactions.
- **Logic and Control Flow**:
    - Decrements the `skip_cnt` in `ctx` and returns if it is greater than zero.
    - Retrieves the current tick count and calculates the number of enabled pacing banks.
    - Checks if any banks are busy and polls one of them to see if it is still busy, updating the `charge_busy` flag and bank status if necessary.
    - If the current slot has timed out, it stops being the leader, updates metrics, and ends the block.
    - If not the leader, attempts to insert a transaction from extra storage if available and returns.
    - If in drain mode, checks if it can exit and updates the bank status accordingly.
    - Checks if the maximum allowed microblocks have been sent and returns if so.
    - Verifies if there are enough transactions or if sufficient time has passed to proceed with scheduling.
    - If the crank is enabled, processes bundles and updates the crank metrics accordingly.
    - Attempts to schedule the next microblock if banks are idle, updating metrics and state as needed.
    - Updates the metric state based on the current transaction availability and system state.
    - Handles extra storage transactions if enabled, inserting them into the pack if space is available.
    - Ends the slot if the maximum allowed microblocks have been sent, updating metrics and state.
- **Output**: No return value; the function modifies the state of the `ctx` and updates the `charge_busy` flag.
- **Functions Called**:
    - [`log_end_block_metrics`](<#log_end_block_metrics>)
    - [`remove_ib`](<#remove_ib>)
    - [`update_metric_state`](<#update_metric_state>)
    - [`insert_from_extra`](<#insert_from_extra>)


---
### during\_frag<!-- {{#callable:during_frag}} -->
[View Source →](<../../../../../src/disco/pack/fd_pack_tile.c#L802>)

Processes incoming fragments based on their type and updates the context accordingly.
- **Inputs**:
    - `ctx`: Pointer to the `fd_pack_ctx_t` structure that holds the context for processing.
    - `in_idx`: Index of the input source in the context's input array.
    - `seq`: Sequence number of the fragment (unused in this function).
    - `sig`: Signature or identifier of the fragment.
    - `chunk`: Chunk index within the input memory.
    - `sz`: Size of the fragment data.
    - `ctl`: Control parameter (unused in this function).
- **Logic and Control Flow**:
    - Convert the chunk index to a memory address using `fd_chunk_to_laddr_const`.
    - Switch based on the type of input (`ctx->in_kind[in_idx]`).
    - For `IN_KIND_REPLAY`, check if the signature is `REPLAY_SIG_BECAME_LEADER` and handle leader transition by copying data to `_became_leader`.
    - For `IN_KIND_POH`, check if the packet type is `POH_PKT_TYPE_BECAME_LEADER` and handle leader transition similarly.
    - For `IN_KIND_BANK`, verify the signature matches the leader slot and handle rebate data by copying it to `rebate`.
    - For `IN_KIND_RESOLV`, verify the chunk is within range and handle transaction data, updating the highest observed slot if necessary, and manage bundles or individual transactions.
    - For `IN_KIND_EXECUTED_TXN`, verify the size is 64 bytes and copy the transaction signature to `executed_txn_sig`.
- **Output**: No direct output; the function updates the context (`ctx`) based on the input fragment.


---
### after\_frag<!-- {{#callable:after_frag}} -->
[View Source →](<../../../../../src/disco/pack/fd_pack_tile.c#L954>)

Handles the completion of a transaction fragment by updating the leader slot, managing transaction expiration, and setting block limits.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_pack_ctx_t` structure, which holds the context for the packing process.
    - ``in_idx``: An index indicating the input source of the fragment.
    - ``seq``: The sequence number of the fragment, which is unused in this function.
    - ``sig``: A signature or identifier for the fragment, used to determine the type of input.
    - ``sz``: The size of the fragment, which is unused in this function.
    - ``tsorig``: The original timestamp of the fragment, which is unused in this function.
    - ``tspub``: The publication timestamp of the fragment, which is unused in this function.
    - ``stem``: A pointer to the `fd_stem_context_t` structure, which is unused in this function.
- **Logic and Control Flow**:
    - Initialize `now` with the current tick count.
    - Determine the `leader_slot` based on the input kind and signature.
    - If the input kind is `IN_KIND_REPLAY` or `IN_KIND_POH`, check if the current leader slot is valid and handle the transition by publishing the current state and resetting the leader slot.
    - Update the leader slot and related parameters such as bank, bank index, and slot limits.
    - Initialize pacing for the new slot using the current tick count and calculated end ticks.
    - If the input kind is `IN_KIND_BANK`, verify the signature and update consumed cost units using the rebate information.
    - If the input kind is `IN_KIND_RESOLV`, handle the insertion of transactions or bundles into the pack, updating metrics and results accordingly.
    - If the input kind is `IN_KIND_EXECUTED_TXN`, delete the transaction from the pack using the executed transaction signature.
    - Update the metric state based on the availability of transactions in the pack.
- **Output**: No direct output; the function modifies the state of the `ctx` structure and updates metrics.
- **Functions Called**:
    - [`log_end_block_metrics`](<#log_end_block_metrics>)
    - [`remove_ib`](<#remove_ib>)
    - [`update_metric_state`](<#update_metric_state>)
    - [`scratch_footprint`](<#scratch_footprint>)
    - [`populate_sock_filter_policy_fd_pack_tile`](<generated/fd_pack_tile_seccomp.h.md#populate_sock_filter_policy_fd_pack_tile>)


---
### privileged\_init<!-- {{#callable:after_frag::privileged_init}} -->
[View Source →](<../../../../../src/disco/pack/fd_pack_tile.c#L1112>)

Initializes a privileged context for a tile in a topology if the bundle is enabled and valid paths are provided.
- **Inputs**:
    - ``topo``: A pointer to an `fd_topo_t` structure representing the topology.
    - ``tile``: A pointer to an `fd_topo_tile_t` structure representing the tile to initialize.
- **Logic and Control Flow**:
    - Check if the bundle is enabled in `tile->pack.bundle.enabled`; if not, return immediately.
    - Check if `tile->pack.bundle.vote_account_path` is empty; if so, log a warning and return.
    - Get a scratch memory location using `fd_topo_obj_laddr` with `topo` and `tile->tile_obj_id`.
    - Initialize a scratch allocator with `FD_SCRATCH_ALLOC_INIT`.
    - Allocate memory for `fd_pack_ctx_t` using `FD_SCRATCH_ALLOC_APPEND`.
    - Check if `tile->pack.bundle.identity_key_path` is empty; if so, log an error and exit.
    - Load the identity key using `fd_keyload_load` and copy it to `ctx->crank->identity_pubkey->b`.
    - Attempt to decode `tile->pack.bundle.vote_account_path` using `fd_base58_decode_32`; if it fails, load the vote key using `fd_keyload_load` and copy it to `ctx->crank->vote_pubkey->b`.
- **Output**: No return value; the function initializes the context for a tile.


---
### unprivileged\_init<!-- {{#callable:after_frag::unprivileged_init}} -->
[View Source →](<../../../../../src/disco/pack/fd_pack_tile.c#L1138>)

Initializes an unprivileged pack tile with configuration and resources for transaction processing.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure representing the topology of the system.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure representing the specific tile to initialize.
- **Logic and Control Flow**:
    - Allocate scratch memory using `fd_topo_obj_laddr` for the tile object ID.
    - Check if `max_pending_transactions` exceeds a threshold and log an error if it does.
    - Define upper and lower limits for transaction processing based on tile configuration.
    - Calculate the footprint for the pack using `fd_pack_footprint`.
    - Initialize scratch allocation and allocate memory for `fd_pack_ctx_t` and random number generator (`fd_rng_t`).
    - Join the random number generator and log an error if it fails.
    - Create a new pack context using `fd_pack_new` and join it with `fd_pack_join`, logging an error if it fails.
    - Check the number of input links and log an error if it exceeds 32.
    - Initialize input link kinds based on their names using a series of conditional checks.
    - Count the number of bank tiles connected to the pack tile and log an error if it exceeds the maximum allowed.
    - Set the scheduling strategy and initialize the crank if the bundle is enabled.
    - Initialize various context fields such as `cur_spot`, `strategy`, `max_pending_transactions`, and others.
    - Initialize metrics storage and log information about the configuration.
    - Finalize scratch allocation and check for overflow, logging an error if it occurs.
- **Output**: No return value; the function initializes the pack tile in place.
- **Functions Called**:
    - [`scratch_footprint`](<#scratch_footprint>)


---
### populate\_allowed\_seccomp<!-- {{#callable:after_frag::populate_allowed_seccomp}} -->
[View Source →](<../../../../../src/disco/pack/fd_pack_tile.c#L1349>)

Populates a seccomp filter policy for a specific tile with a given count of filters.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, representing the topology configuration.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure, representing the tile configuration.
    - ``out_cnt``: An unsigned long integer representing the number of filters to populate.
    - ``out``: A pointer to an array of `sock_filter` structures where the function will store the populated filters.
- **Logic and Control Flow**:
    - Casts `topo` and `tile` to void to indicate they are unused in this function.
    - Calls [`populate_sock_filter_policy_fd_pack_tile`](<generated/fd_pack_tile_seccomp.h.md#populate_sock_filter_policy_fd_pack_tile>) with `out_cnt`, `out`, and the file descriptor from `fd_log_private_logfile_fd()`.
    - Returns `sock_filter_policy_fd_pack_tile_instr_cnt`, which is presumably a constant representing the number of instructions in the filter policy.
- **Output**: Returns an unsigned long integer representing the number of instructions in the seccomp filter policy.
- **Functions Called**:
    - [`populate_sock_filter_policy_fd_pack_tile`](<generated/fd_pack_tile_seccomp.h.md#populate_sock_filter_policy_fd_pack_tile>)


---
### populate\_allowed\_fds<!-- {{#callable:after_frag::populate_allowed_fds}} -->
[View Source →](<../../../../../src/disco/pack/fd_pack_tile.c#L1361>)

Populates an array with file descriptors for `stderr` and optionally a log file, returning the count of populated descriptors.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, which is not used in this function.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure, which is not used in this function.
    - ``out_fds_cnt``: The maximum number of file descriptors that can be stored in the `out_fds` array.
    - ``out_fds``: An array of integers where the function will store the file descriptors.
- **Logic and Control Flow**:
    - Ignore the `topo` and `tile` parameters as they are not used.
    - Check if `out_fds_cnt` is less than 2; if so, log an error and terminate the program.
    - Initialize `out_cnt` to 0 to keep track of the number of file descriptors added.
    - Add the file descriptor for `stderr` (which is 2) to the `out_fds` array and increment `out_cnt`.
    - Check if the log file descriptor is valid (not -1); if valid, add it to the `out_fds` array and increment `out_cnt`.
    - Return the value of `out_cnt`, which is the number of file descriptors added to `out_fds`.
- **Output**: Returns the number of file descriptors added to the `out_fds` array as an `ulong`.



---
Made with ❤️ by [Driver](https://www.driver.ai/)