<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for high-performance duplicate detection in account address lists, with AVX optimizations.

# Purpose
The code is a C header file that defines a set of functions for detecting duplicate account addresses in a list, optimized for high-performance computing (HPC) environments. The primary purpose of this code is to ensure that transactions with duplicate account addresses are identified quickly, as such transactions fail to sanitize and are not charged a fee. The code is designed to be used in environments where performance is critical, and it includes optimizations for platforms with AVX and AVX512 instruction sets.

The file defines several functions, such as [`fd_chkdup_new`](<#fd_chkdup_new>), [`fd_chkdup_join`](<#fd_chkdup_join>), [`fd_chkdup_leave`](<#fd_chkdup_leave>), and [`fd_chkdup_delete`](<#fd_chkdup_delete>), which manage memory for duplicate detection. It also includes functions like [`fd_chkdup_check`](<#fd_chkdup_check>), [`fd_chkdup_check_slow`](<#fd_chkdup_check_slow>), and [`fd_chkdup_check_fast`](<#fd_chkdup_check_fast>) to perform the actual duplicate checking. The fast check uses a Bloom filter-like approach with AVX registers to quickly identify potential duplicates, while the slow check uses a hash table for precise detection. The code is structured to allow inlining of functions for performance reasons and includes detailed implementation notes on the algorithms used for duplicate detection.
# Imports and Dependencies

---
- `../../ballet/fd_ballet_base.h`
- `../../ballet/txn/fd_txn.h`
- `../../util/simd/fd_avx.h`
- `../../util/tmpl/fd_map.c`
- `../../util/simd/fd_avx512.h`


# Global Variables

---
### chkdup\_null\_addr
- **Type**: ``fd_acct_addr_t``
- **Description**: A constant variable of type `fd_acct_addr_t` initialized with zero values. It is used to represent a null or invalid account address in the context of duplicate checking for account addresses.
- **Use**: Used as a sentinel value to identify null or invalid account addresses in the duplicate checking process.


# Data Structures

---
### fd\_chkdup\_t
- **Type**: ``struct``
- **Members**:
    - ``entropy``: An array used for storing entropy values for hash functions.
    - ``hashmap``: A hash map used for storing account addresses to check for duplicates.
- **Description**: `fd_chkdup_t` is a data structure used for high-performance checking of duplicate account addresses in a list. It is designed to be efficient, especially in environments with AVX support, where it uses a fast initial check that may produce false positives, followed by a precise check if needed. The structure includes an entropy array for hash functions and a hash map for storing account addresses. The implementation supports different configurations based on the availability of AVX or AVX512, optimizing for speed and minimizing false positives.


---
### fd\_chkdup\_waddr
- **Type**: ``struct``
- **Members**:
    - ``key``: Holds an account address of type `fd_acct_addr_t`.
- **Description**: Defines a structure with a single member `key`, which stores an account address. This structure is used in the context of checking for duplicate account addresses in a list, as part of a high-performance computing solution for transaction processing.


---
### fd\_chkdup\_waddr\_t
- **Type**: ``struct``
- **Members**:
    - ``key``: Holds an account address.
- **Description**: The `fd_chkdup_waddr_t` structure is used to store an account address for duplicate checking purposes. It contains a single member, `key`, which is of type `fd_acct_addr_t` and represents the account address to be checked for duplicates. This structure is part of a larger system designed to efficiently detect duplicate account addresses in a list, which is critical for transaction validation.


---
### fd\_chkdup\_private
- **Type**: ``struct``
- **Members**:
    - ``entropy``: An array of unsigned characters used for entropy, with a size dependent on `FD_CHKDUP_IMPL`.
    - ``hashmap``: An array of `fd_chkdup_waddr_t` used as a hash map with a fixed size of 256 elements.
- **Description**: The `fd_chkdup_private` structure is used in the context of high-performance computing to check for duplicate account addresses in a list. It contains an optional `entropy` array for randomness, which is included if `FD_CHKDUP_IMPL` is greater than or equal to 1, and a `hashmap` array that serves as a hash table for storing account addresses. The structure is aligned according to the `FD_CHKDUP_ALIGN` macro, which varies based on the implementation level of `FD_CHKDUP_IMPL`.


# Functions

---
### fd\_chkdup\_footprint<!-- {{#callable:fd_chkdup_footprint}} -->
[View Source →](<../../../../../src/disco/pack/fd_chkdup.h#L61>)

Returns the footprint size of the scratch memory needed for duplicate detection.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the value of the macro `FD_CHKDUP_FOOTPRINT`.
- **Output**: The function returns an `ulong` representing the footprint size of the scratch memory required for duplicate detection.


---
### fd\_chkdup\_align<!-- {{#callable:fd_chkdup_align}} -->
[View Source →](<../../../../../src/disco/pack/fd_chkdup.h#L65>)

Returns the alignment requirement for the `fd_chkdup` data structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the value of the macro `FD_CHKDUP_ALIGN`.
- **Output**: An unsigned long integer representing the alignment requirement.


---
### fd\_chkdup\_new<!-- {{#callable:fd_chkdup_new}} -->
[View Source →](<../../../../../src/disco/pack/fd_chkdup.h#L332>)

Formats a memory region for duplicate address detection and initializes it with random entropy if applicable.
- **Inputs**:
    - ``shmem``: A pointer to the first byte of a memory region with the required alignment and footprint for duplicate address detection.
    - ``rng``: A pointer to a local join of a random number generator (RNG) used to fill entropy if `FD_CHKDUP_IMPL` is greater than or equal to 1.
- **Logic and Control Flow**:
    - Cast `shmem` to a `fd_chkdup_t` pointer and assign it to `chkdup`.
    - If `FD_CHKDUP_IMPL` is greater than or equal to 1, fill the `chkdup->entropy` array with random bytes from `rng`.
    - If `FD_CHKDUP_IMPL` is less than 1, ignore `rng`.
    - Verify that the footprint of `chkdup->hashmap` matches the expected size using `FD_TEST`.
    - Initialize the `chkdup->hashmap` using `fd_chkdup_pmap_new`.
    - Return the `chkdup` pointer.
- **Output**: Returns a pointer to the initialized `fd_chkdup_t` structure on success.


---
### fd\_chkdup\_join<!-- {{#callable:fd_chkdup_join}} -->
[View Source →](<../../../../../src/disco/pack/fd_chkdup.h#L347>)

Converts a pointer to shared memory into a pointer to a `fd_chkdup_t` structure.
- **Inputs**:
    - `shmem`: A pointer to a shared memory region that is formatted for use with `fd_chkdup_t`.
- **Logic and Control Flow**:
    - Casts the `shmem` pointer to a `fd_chkdup_t` pointer.
    - Returns the casted pointer.
- **Output**: A pointer to a `fd_chkdup_t` structure, which is the same as the input `shmem` pointer cast to the appropriate type.


---
### fd\_chkdup\_leave<!-- {{#callable:fd_chkdup_leave}} -->
[View Source →](<../../../../../src/disco/pack/fd_chkdup.h#L349>)

Returns the pointer to the `fd_chkdup_t` object passed to it, effectively unjoining the caller from the `chkdup` object.
- **Inputs**:
    - `chkdup`: A pointer to a `fd_chkdup_t` object that the caller wants to unjoin from.
- **Logic and Control Flow**:
    - Casts the `chkdup` pointer to a `void *` type.
    - Returns the casted pointer.
- **Output**: A `void *` pointer to the `chkdup` object that was passed in.


---
### fd\_chkdup\_delete<!-- {{#callable:fd_chkdup_delete}} -->
[View Source →](<../../../../../src/disco/pack/fd_chkdup.h#L350>)

Returns the input pointer `shmem` without modification.
- **Inputs**:
    - ``shmem``: A pointer to a memory region that is to be unformatted.
- **Logic and Control Flow**:
    - The function takes a single input, `shmem`, which is a pointer to a memory region.
    - It returns the same pointer `shmem` without performing any operations on it.
- **Output**: A pointer to the unformatted memory region, which is the same as the input `shmem`.


---
### fd\_chkdup\_check<!-- {{#callable:fd_chkdup_check}} -->
[View Source →](<../../../../../src/disco/pack/fd_chkdup.h#L353>)

Checks if a list of account addresses contains duplicates using a fast initial check followed by a slow precise check if needed.
- **Inputs**:
    - `chkdup`: A pointer to a valid local join of a `fd_chkdup_t` object.
    - `list0`: A pointer to the first account address of the first sublist.
    - `list0_cnt`: The number of account addresses in the first sublist.
    - `list1`: A pointer to the first account address of the second sublist.
    - `list1_cnt`: The number of account addresses in the second sublist.
- **Logic and Control Flow**:
    - Calls `fd_chkdup_check_fast` with the provided lists and checks if it returns 0, indicating no duplicates were found in the fast check.
    - If the fast check returns 0, the function returns 0, indicating no duplicates.
    - If the fast check does not return 0, calls [`fd_chkdup_check_slow`](<#fd_chkdup_check_slow>) to perform a precise check for duplicates.
    - Returns the result of [`fd_chkdup_check_slow`](<#fd_chkdup_check_slow>), which is 1 if duplicates are found and 0 otherwise.
- **Output**: Returns 0 if no duplicates are found, or 1 if duplicates are detected.
- **Functions Called**:
    - [`fd_chkdup_check_slow`](<#fd_chkdup_check_slow>)


---
### fd\_chkdup\_check\_slow<!-- {{#callable:fd_chkdup_check_slow}} -->
[View Source →](<../../../../../src/disco/pack/fd_chkdup.h#L361>)

Checks two lists of account addresses for duplicates using a hash map.
- **Inputs**:
    - ``chkdup``: A pointer to a valid local join of a `fd_chkdup_t` object, which contains the hash map used for duplicate detection.
    - ``list0``: A pointer to the first account address of the first sublist to check for duplicates.
    - ``list0_cnt``: The number of account addresses in `list0`.
    - ``list1``: A pointer to the first account address of the second sublist to check for duplicates.
    - ``list1_cnt``: The number of account addresses in `list1`.
- **Logic and Control Flow**:
    - Join the hash map from `chkdup` for use in duplicate detection.
    - Initialize an array `inserted` to keep track of inserted addresses and a counter `inserted_cnt` to zero.
    - Initialize `any_duplicates` and `skipped_inval` to zero to track duplicate status and invalid keys.
    - Iterate over `list0` and check each address for validity using `fd_chkdup_pmap_key_inval`.
    - If an address is invalid, set `any_duplicates` if `skipped_inval` is already set, then set `skipped_inval` to 1 and continue.
    - Insert valid addresses into the hash map using `fd_chkdup_pmap_insert`, update `inserted` and `inserted_cnt`, and set `any_duplicates` if insertion fails.
    - Repeat the same process for `list1`.
    - Remove all inserted addresses from the hash map in reverse order of insertion to maintain map integrity.
    - Leave the hash map.
- **Output**: Returns 1 if there are duplicate addresses in the combined lists, otherwise returns 0.


---
### fd\_chkdup\_check\_fast<!-- {{#callable:fd_chkdup_check_fast}} -->
[View Source →](<../../../../../src/disco/pack/fd_chkdup.h#L583>)

Always returns 1, indicating the presence of duplicate account addresses, without performing any checks.
- **Inputs**:
    - ``chkdup``: A pointer to a `fd_chkdup_t` structure, which is not used in this function.
    - ``list0``: A pointer to the first account address in the first sublist, which is not used in this function.
    - ``list0_cnt``: The number of account addresses in the first sublist, which is not used in this function.
    - ``list1``: A pointer to the first account address in the second sublist, which is not used in this function.
    - ``list1_cnt``: The number of account addresses in the second sublist, which is not used in this function.
- **Logic and Control Flow**:
    - The function takes five parameters but does not use any of them.
    - It casts all input parameters to void to avoid compiler warnings about unused variables.
    - The function returns 1, indicating that duplicates are present, without performing any actual checks.
- **Output**: An integer value of 1, indicating the presence of duplicate account addresses.


# Function Declarations (Public API)

---
### fd\_chkdup\_new<!-- {{#callable_declaration:fd_chkdup_new}} -->
[View Source →](<../../../../../src/disco/pack/fd_chkdup.h#L82>)

Formats memory for duplicate address detection.
- **Description**: Use this function to prepare a memory region for detecting duplicate account addresses. Ensure that `shmem` points to a memory region with the correct alignment and footprint. The `rng` parameter is used to initialize entropy, but the function does not retain any interest in the RNG after execution. The function returns the `shmem` pointer on success or `NULL` if `shmem` is `NULL` or improperly aligned.
- **Inputs**:
    - `shmem`: A pointer to the first byte of a memory region with the required alignment and footprint. Must not be NULL.
    - `rng`: A pointer to a local join of an RNG. Some slots of the RNG will be consumed, but the function does not retain any interest in the RNG after execution.
- **Output**: Returns the `shmem` pointer on success or `NULL` on failure.
- **See Also**: [`fd_chkdup_new`](<#fd_chkdup_new>)  (Implementation)


---
### fd\_chkdup\_join<!-- {{#callable_declaration:fd_chkdup_join}} -->
[View Source →](<../../../../../src/disco/pack/fd_chkdup.h#L83>)

Joins the caller to a formatted memory region for duplicate detection.
- **Description**: Use this function to associate the caller with a pre-formatted memory region intended for duplicate address detection. This function is typically called after the memory has been formatted using `fd_chkdup_new`. It is important that the memory region pointed to by `shmem` is correctly formatted and aligned before calling this function. The function returns a pointer to the `fd_chkdup_t` structure, which represents the joined memory region.
- **Inputs**:
    - `shmem`: A pointer to the first byte of a formatted memory region. The memory must be correctly aligned and formatted for duplicate detection. The caller retains ownership of the memory.
- **Output**: Returns a pointer to the `fd_chkdup_t` structure representing the joined memory region.
- **See Also**: [`fd_chkdup_join`](<#fd_chkdup_join>)  (Implementation)


---
### fd\_chkdup\_leave<!-- {{#callable_declaration:fd_chkdup_leave}} -->
[View Source →](<../../../../../src/disco/pack/fd_chkdup.h#L84>)

Unjoins the caller from a `chkdup` object.
- **Description**: Use this function to unjoin from a `chkdup` object when it is no longer needed. This function is typically called after operations requiring the `chkdup` object are complete. It is important to ensure that the `chkdup` object is valid and currently joined before calling this function. The function returns the `chkdup` object, allowing for further operations if necessary.
- **Inputs**:
    - `chkdup`: A pointer to a `fd_chkdup_t` object. It must be a valid and currently joined `chkdup` object. The function does not perform any validation on this parameter.
- **Output**: Returns the `chkdup` object as a `void *`, allowing for further operations if necessary.
- **See Also**: [`fd_chkdup_leave`](<#fd_chkdup_leave>)  (Implementation)


---
### fd\_chkdup\_delete<!-- {{#callable_declaration:fd_chkdup_delete}} -->
[View Source →](<../../../../../src/disco/pack/fd_chkdup.h#L85>)

Unformats a memory region used for duplicate address detection.
- **Description**: Use this function to unformat a previously formatted memory region that was used for duplicate address detection. This function is typically called when the memory region is no longer needed for duplicate checking, allowing the memory to be reused or deallocated. Ensure that the memory region was previously formatted using the appropriate function before calling this function.
- **Inputs**:
    - `shmem`: A pointer to the start of the memory region to unformat. Must not be null and should point to a region that was previously formatted for duplicate address detection.
- **Output**: Returns a pointer to the unformatted memory region, which is the same as the input pointer.
- **See Also**: [`fd_chkdup_delete`](<#fd_chkdup_delete>)  (Implementation)


---
### fd\_chkdup\_check<!-- {{#callable_declaration:fd_chkdup_check}} -->
[View Source →](<../../../../../src/disco/pack/fd_chkdup.h#L126>)

Checks for duplicate account addresses in two lists.
- **Description**: Use this function to verify if any account addresses appear more than once across two lists. It is important to ensure that the `chkdup` object is a valid local join before calling this function. The function is optimized for performance and uses a fast initial check that may produce false positives, followed by a precise check if needed. The lists do not need to be sorted, but they must not overlap, and their combined count must not exceed 128 addresses.
- **Inputs**:
    - `chkdup`: A pointer to a valid local join of a `fd_chkdup_t` object. Must not be null.
    - `list0`: A pointer to the first account address in the first sublist. Can be null if `list0_cnt` is zero.
    - `list0_cnt`: The number of account addresses in the first sublist. Must be non-negative and, when combined with `list1_cnt`, must not exceed 128.
    - `list1`: A pointer to the first account address in the second sublist. Can be null if `list1_cnt` is zero.
    - `list1_cnt`: The number of account addresses in the second sublist. Must be non-negative and, when combined with `list0_cnt`, must not exceed 128.
- **Output**: Returns 1 if there is at least one duplicate account address across the lists, and 0 if all addresses are unique.
- **See Also**: [`fd_chkdup_check`](<#fd_chkdup_check>)  (Implementation)


---
### fd\_chkdup\_check\_slow<!-- {{#callable_declaration:fd_chkdup_check_slow}} -->
[View Source →](<../../../../../src/disco/pack/fd_chkdup.h#L130>)

Checks for duplicate account addresses in two lists.
- **Description**: Use this function to determine if there are any duplicate account addresses in two provided lists. It is important to ensure that the `chkdup` pointer is a valid local join of a `chkdup` object before calling this function. The lists `list0` and `list1` are logically concatenated for the check, and they must not overlap. The function requires that the total number of addresses in both lists does not exceed 128. If a duplicate is found, the function returns 1; otherwise, it returns 0. This function is precise and does not produce false positives.
- **Inputs**:
    - `chkdup`: A pointer to a valid local join of a `chkdup` object. Must not be null.
    - `list0`: A pointer to the first account address of the first sublist. Can be null if `list0_cnt` is 0.
    - `list0_cnt`: The number of account addresses in `list0`. Must be non-negative and, when combined with `list1_cnt`, must not exceed 128.
    - `list1`: A pointer to the first account address of the second sublist. Can be null if `list1_cnt` is 0.
    - `list1_cnt`: The number of account addresses in `list1`. Must be non-negative and, when combined with `list0_cnt`, must not exceed 128.
- **Output**: Returns 1 if there is at least one duplicate account address; otherwise, returns 0.
- **See Also**: [`fd_chkdup_check_slow`](<#fd_chkdup_check_slow>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)