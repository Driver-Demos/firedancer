<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for deduplication and validation of transactions using sorting, hashing, and AVX operations.

# Purpose
The code is an executable C program that performs various validation checks on transaction data using different methods. It includes functions to parse transaction payloads, sort account addresses, and check for unique account addresses using hash maps and AVX (Advanced Vector Extensions) operations. The program imports binary transaction data and uses it to test the performance and correctness of these validation methods. The main function executes these checks in a loop, measuring the time taken for each validation method and logging the results. The program uses SIMD (Single Instruction, Multiple Data) operations to optimize certain checks, and it includes custom sorting and hashing implementations to handle transaction account addresses.

The code defines several key components, including [`check_sort`](<#check_sort>), [`check_hash`](<#check_hash>), [`check_hash64`](<#check_hash64>), and [`check_avx`](<#check_avx>) functions, each implementing a different validation strategy. It uses macros to define sorting and hashing behaviors, and it includes binary data for sample transactions. The program is structured to measure the performance of these validation methods by running them repeatedly and calculating the average time taken. The use of `fd_txn_parse` and related functions indicates that the program is part of a larger framework for handling financial transactions, likely involving account address management and validation.
# Imports and Dependencies

---
- `../fd_ballet.h`
- `fd_pack.h`
- `fd_compute_budget_program.h`
- `../txn/fd_txn.h`
- `../../util/simd/fd_avx.h`
- `../../util/tmpl/fd_sort.c`
- `../../util/tmpl/fd_map.c`


# Global Variables

---
### \_txn
- **Type**: `uchar array`
- **Description**: An array of unsigned characters with a size defined by the macro `FD_TXN_MAX_SZ`. This array is used to store transaction data after parsing.
- **Use**: Used to hold parsed transaction data for further processing in various functions.


---
### scratch1
- **Type**: ``fd_acct_addr_t` array`
- **Description**: An array named `scratch1` of type `fd_acct_addr_t` with a size defined by `FD_TXN_ACCT_ADDR_MAX`. The array is aligned to a 32-byte boundary using the `__attribute__((aligned(32)))` directive.
- **Use**: Used to temporarily store account addresses during transaction processing, particularly in sorting operations.


---
### scratch2
- **Type**: ``fd_acct_addr_t` array`
- **Description**: An array named `scratch2` of type `fd_acct_addr_t` with a size defined by `FD_TXN_ACCT_ADDR_MAX`. The array is aligned to a 32-byte boundary using the `__attribute__((aligned(32)))` directive.
- **Use**: Used as a temporary storage buffer for account addresses during transaction processing, particularly in sorting operations.


---
### null\_addr
- **Type**: ``fd_acct_addr_t``
- **Description**: Defines a constant account address with a specific value of `{{ 1, 0 }}`. This structure is used to represent a null or invalid account address in the context of the program.
- **Use**: Used as a sentinel value to indicate a null or invalid key in hash map operations.


---
### \_map
- **Type**: ``uchar[]``
- **Description**: An array of unsigned characters (`uchar`) that is used to store data for a hash map. The size of the array is determined by the size of `fd_pack_addr_use_t` multiplied by 512 (2^9), and it is aligned to a 32-byte boundary for performance optimization.
- **Use**: Used as a memory buffer for hash map operations involving account addresses.


# Data Structures

---
### fd\_pack\_private\_addr\_use\_record
- **Type**: ``struct``
- **Members**:
    - `key`: Stores an account address of type `fd_acct_addr_t`.
- **Description**: Defines a structure that holds a single member `key`, which is an account address. This structure is used to represent the usage record of a private address in the context of the application. The `typedef` creates an alias `fd_pack_addr_use_t` for this structure, simplifying its usage in the code.


---
### fd\_pack\_addr\_use\_t
- **Type**: ``struct``
- **Members**:
    - `key`: Stores the account address as an `fd_acct_addr_t` type.
- **Description**: Defines a structure that holds a single account address, represented by the `key` member. This structure is used in hash map operations to manage and query account addresses efficiently.


---
### wrap\_ul
- **Type**: ``struct``
- **Members**:
    - `key`: Stores an unsigned long integer value.
- **Description**: Encapsulates a single unsigned long integer (`ulong`) in a structure, providing a type definition `wrap_ul_t` for ease of use in applications that require a simple wrapper around an unsigned long integer.


---
### wrap\_ul\_t
- **Type**: ``struct``
- **Members**:
    - `key`: Stores an unsigned long integer value.
- **Description**: Represents a structure that contains a single member, `key`, which is an unsigned long integer. This structure is used in the context of hash maps, as indicated by its use in the `hash_ul` map implementation, where it serves as the type for the map's elements.


# Functions

---
### check\_sort<!-- {{#callable:check_sort}} -->
[View Source →](<../../../../../src/disco/pack/test_deduplication.c#L21>)

Checks if the account addresses in a transaction payload are sorted and unique.
- **Inputs**:
    - `payload`: A pointer to the transaction payload data.
    - `sz`: The size of the transaction payload data.
- **Logic and Control Flow**:
    - Parse the transaction from the `payload` using `fd_txn_parse` and store it in `_txn`.
    - Retrieve the transaction object `txn` from `_txn`.
    - Get the count of immediate account addresses in the transaction using `fd_txn_account_cnt`.
    - Copy the account addresses from the transaction into `scratch1` using `memcpy`.
    - Sort the account addresses in `scratch1` using `sort_pubkeys_stable_fast`, storing the result in `sorted`.
    - Iterate over the sorted account addresses starting from the second address.
    - Compare each address with the previous one using `memcmp` to check for duplicates.
    - If a duplicate is found, return 0 indicating the addresses are not unique.
    - If no duplicates are found, return 1 indicating the addresses are sorted and unique.
- **Output**: Returns 1 if the account addresses are sorted and unique, otherwise returns 0.


---
### check\_hash<!-- {{#callable:check_hash}} -->
[View Source →](<../../../../../src/disco/pack/test_deduplication.c#L70>)

Checks if any account addresses in a transaction payload have been previously used by querying and updating a hash map.
- **Inputs**:
    - `payload`: A pointer to the transaction payload data.
    - `sz`: The size of the transaction payload data.
- **Logic and Control Flow**:
    - Parse the transaction from the `payload` using `fd_txn_parse` and store it in `_txn`.
    - Retrieve the transaction object `txn` from `_txn`.
    - Get the count of immediate account addresses in the transaction using `fd_txn_account_cnt`.
    - Retrieve the account addresses from the transaction using `fd_txn_get_acct_addrs`.
    - Join the hash map using `hash_pubkeys_join` to get a pointer to the map.
    - Initialize `retval` to 1, indicating no duplicate addresses found initially.
    - Iterate over each account address and check if it is already in the map using `hash_pubkeys_query`.
    - If a duplicate address is found, set `retval` to 0 and break the loop.
    - Insert each account address into the map using `hash_pubkeys_insert`.
    - After checking, remove each account address from the map using `hash_pubkeys_remove`.
    - Return `retval`, which indicates whether any duplicate addresses were found.
- **Output**: Returns an integer `retval`, which is 1 if no duplicate account addresses are found, and 0 if duplicates are detected.


---
### dummy<!-- {{#callable:dummy}} -->
[View Source →](<../../../../../src/disco/pack/test_deduplication.c#L93>)

Parses a transaction payload, retrieves account addresses, and accesses the first byte of each address.
- **Inputs**:
    - `payload`: A pointer to the transaction payload data.
    - `sz`: The size of the transaction payload in bytes.
- **Logic and Control Flow**:
    - Call `fd_txn_parse` to parse the transaction payload and store the result in `_txn`.
    - Cast `_txn` to a `fd_txn_t` pointer and assign it to `txn`.
    - Retrieve the count of immediate category accounts using `fd_txn_account_cnt`.
    - Get the account addresses from the transaction using `fd_txn_get_acct_addrs`.
    - Iterate over each account address, accessing the first byte of each address and storing it in the volatile variable `d`.
- **Output**: Always returns 1.


---
### check\_hash64<!-- {{#callable:check_hash64}} -->
[View Source →](<../../../../../src/disco/pack/test_deduplication.c#L109>)

Validates that no duplicate 64-bit hash keys exist in the transaction account addresses.
- **Inputs**:
    - `payload`: A pointer to the transaction data to parse and check.
    - `sz`: The size of the transaction data in bytes.
- **Logic and Control Flow**:
    - Parse the transaction from the `payload` using `fd_txn_parse` and store it in `_txn`.
    - Retrieve the transaction account count using `fd_txn_account_cnt`.
    - Get the account addresses from the transaction using `fd_txn_get_acct_addrs`.
    - Join the hash map using `hash_ul_join` to prepare for key operations.
    - Initialize `retval` to 1, indicating no duplicates found initially.
    - Iterate over each account address, compute a 64-bit key from the address, and check for duplicates using `hash_ul_query`.
    - If a duplicate is found, set `retval` to 0 and break the loop.
    - If no duplicate is found, insert the key into the hash map using `hash_ul_insert`.
    - After checking, remove all keys from the hash map using `hash_ul_remove`.
    - Return `retval`, which indicates whether duplicates were found.
- **Output**: Returns 1 if no duplicate keys are found, otherwise returns 0.


---
### check\_avx<!-- {{#callable:check_avx}} -->
[View Source →](<../../../../../src/disco/pack/test_deduplication.c#L133>)

Validates account addresses in a transaction payload using AVX instructions to ensure no duplicate addresses exist.
- **Inputs**:
    - `payload`: A pointer to the transaction payload data.
    - `sz`: The size of the transaction payload.
- **Logic and Control Flow**:
    - Parse the transaction from the `payload` using `fd_txn_parse` and store it in `_txn`.
    - Retrieve the transaction object `txn` from `_txn`.
    - Get the count of accounts in the transaction using `fd_txn_account_cnt`.
    - Retrieve the account addresses from the transaction using `fd_txn_get_acct_addrs`.
    - Initialize several `wu_t` bit vectors to zero for tracking address uniqueness.
    - Define a macro `CHECK_AND_UPDATE` to check and update bit vectors for each address byte.
    - Iterate over each account address, applying the `CHECK_AND_UPDATE` macro to specific bytes (8, 9, 14, 17, 21, 26, 28, 31) and summing the results.
    - Sum all results and check if the sum equals -24, indicating a duplicate address, and return 0 if true.
    - Return 1 if no duplicates are found after checking all addresses.
- **Output**: Returns 1 if all account addresses are unique; otherwise, returns 0 if a duplicate is detected.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/disco/pack/test_deduplication.c#L179>)

Executes performance tests on various transaction validation methods and logs the results.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Initializes `sum` to 0 and `dummyt` to the negative value of the current wall clock time.
    - Runs a loop 1,000,000 times to call the [`dummy`](<#dummy>) function on four different transaction samples and updates `sum` with the results.
    - Calculates the elapsed time for the [`dummy`](<#dummy>) function calls and logs the mean time per validation.
    - Runs a loop 1,000,000 times to call the [`check_sort`](<#check_sort>) function on four different transaction samples and updates `sum` with the results.
    - Calculates the elapsed time for the [`check_sort`](<#check_sort>) function calls and logs the mean time per validation, excluding overhead.
    - Initializes a hash map with `hash_pubkeys_new` and runs a loop 1,000,000 times to call the [`check_hash`](<#check_hash>) function on four different transaction samples, updating `sum` with the results.
    - Calculates the elapsed time for the [`check_hash`](<#check_hash>) function calls and logs the mean time per validation, excluding overhead, then deletes the hash map with `hash_pubkeys_delete`.
    - Runs a loop 1,000,000 times to call the [`check_avx`](<#check_avx>) function on four different transaction samples and updates `sum` with the results.
    - Calculates the elapsed time for the [`check_avx`](<#check_avx>) function calls and logs the mean time per validation, excluding overhead.
    - Initializes a hash map with `hash_ul_new` and runs a loop 1,000,000 times to call the [`check_hash64`](<#check_hash64>) function on four different transaction samples, updating `sum` with the results.
    - Calculates the elapsed time for the [`check_hash64`](<#check_hash64>) function calls and logs the mean time per validation, excluding overhead, then deletes the hash map with `hash_ul_delete`.
    - Calls `fd_halt` to clean up and terminate the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`dummy`](<#dummy>)
    - [`check_sort`](<#check_sort>)
    - [`check_hash`](<#check_hash>)
    - [`check_avx`](<#check_avx>)
    - [`check_hash64`](<#check_hash64>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)