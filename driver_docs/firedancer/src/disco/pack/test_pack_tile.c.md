<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for the pack tile functionality, including transaction and bundle I/O, overrun scenarios, and stress tests.

# Purpose
The code is a C test suite for a software module that appears to be part of a larger system, likely related to transaction processing or blockchain technology. The primary focus of the code is to test the functionality of a "pack tile," which is a component responsible for handling transactions, bundles, and their associated metadata. The code includes various test scenarios, such as normal transaction input/output, bundle input/output, leader slot transitions, and stress testing for transaction throughput.

Key components of the code include the definition of data structures like `txn_ref_t` and `fd_tile_test_locals`, which are used to manage transaction references and local test state, respectively. The code also defines several macros and includes multiple source and header files, indicating that it is part of a larger codebase. The test suite uses a series of callback functions to simulate different transaction and bundle processing scenarios, verifying the correct behavior of the pack tile under various conditions. The code is structured to allow for modular testing of different aspects of the pack tile's functionality, including handling of overrun conditions and stress testing for high transaction volumes.
# Imports and Dependencies

---
- `fd_pack_tile.c`
- `fd_pack.c`
- `fd_pack.h`
- `fd_pack_cost.h`
- `fd_microblock.h`
- `fd_pack_rebate_sum.h`
- `math.h`
- `../../util/tmpl/fd_pool.c`
- `../../util/tmpl/fd_treap.c`
- `../../app/shared/fd_tile_unit_test.h`
- `../../app/shared/fd_tile_unit_test_tmpl.c`
- `../../app/fdctl/topology.c`
- `../../app/firedancer/topology.c`


# Global Variables

---
### config
- **Type**: `config_t[1]`
- **Description**: The `config` variable is a global array of type `config_t` with a single element. It is used to store configuration settings for the application.
- **Use**: Stores global configuration settings for the application.


---
### metrics\_scratch
- **Type**: ``uchar[]``
- **Description**: An array of unsigned characters used as a scratch space for metrics data. The size of the array is determined by the `FD_METRICS_FOOTPRINT` macro with parameters `10, 10`, and it is aligned according to `FD_METRICS_ALIGN`.
- **Use**: Used to store temporary metrics data during the execution of the program.


---
### txn\_scratch
- **Type**: `fd_txn_p_t`
- **Description**: An array of `fd_txn_p_t` structures, each initialized to zero, with a size defined by `MAX_TEST_TXNS`. This array is used to store transaction data during testing.
- **Use**: Stores transaction data for up to `MAX_TEST_TXNS` transactions during testing.


---
### txnp\_sz
- **Type**: ``ulong``
- **Description**: An array of unsigned long integers with a size defined by `MAX_TEST_TXNS`. Each element is initialized to zero.
- **Use**: Stores the payload size of transactions in the `txn_scratch` array.


---
### txnt\_sz
- **Type**: ``ulong``
- **Description**: An array of unsigned long integers with a size defined by `MAX_TEST_TXNS`. Each element is initialized to 0.
- **Use**: Stores the size of transactions for testing purposes.


---
### txn\_prio
- **Type**: `float[]`
- **Description**: An array of floating-point numbers with a size defined by `MAX_TEST_TXNS`. Each element in the array is initialized to 0.0.
- **Use**: Stores the priority values for transactions in the test configuration.


---
### crank\_scratch
- **Type**: ``uchar[]``
- **Description**: An array of unsigned characters with a size defined by `CRANK_WKSP_SIZE`, which is 2MB. The array is aligned to the size of a normal shared memory page (`FD_SHMEM_NORMAL_PAGE_SZ`).
- **Use**: Used as a scratch space for operations related to the crank workspace in the program.


---
### txn\_ref\_pool\_scratch
- **Type**: ``uchar[]``
- **Description**: An array of unsigned characters used as a scratch space for transaction references. The size of the array is determined by `TXN_REF_SCRATCH_SZ` plus an additional 256 bytes to account for header overhead. The array is aligned to 128 bytes and initialized to zero.
- **Use**: Used as a temporary storage area for transaction references during processing.


---
### accs
- **Type**: `const char *`
- **Description**: An array of constant character pointers that holds single-character strings representing the uppercase letters of the English alphabet.
- **Use**: Used to store and access a predefined set of account identifiers for testing purposes.


---
### SIGNATURE\_SUFFIX
- **Type**: `const char`
- **Description**: A constant character array that holds a string used as a suffix for transaction signatures.
- **Use**: Used to append a specific message to transaction signatures, indicating a fake signature for a transaction number.


---
### WORK\_PROGRAM\_ID
- **Type**: ``char``
- **Description**: A static constant character array that holds a string with a size defined by `FD_TXN_ACCT_ADDR_SZ`. The string is initialized with the value "Work Program Id Consumes 1<<j C".
- **Use**: Used to store a specific identifier string for a work program, likely for transaction processing.


---
### signer
- **Type**: `ulong`
- **Description**: A static global variable of type `ulong` initialized to 0.
- **Use**: Used to store a unique identifier for a signer in transaction processing.


---
### tip\_distribution\_program\_addr
- **Type**: ``fd_acct_addr_t *``
- **Description**: A pointer to a constant `fd_acct_addr_t` type, initialized with the string "The_tip_distribution_prgrm_addr". This variable is used to store the address of the tip distribution program.
- **Use**: Used to reference the address of the tip distribution program in the application.


---
### tip\_payment\_program\_addr
- **Type**: ``fd_acct_addr_t *``
- **Description**: A pointer to a constant `fd_acct_addr_t` type, initialized with a string representing the address of the tip payment program.
- **Use**: Used to store the address of the tip payment program in the system.


---
### validator\_vote\_acct\_addr
- **Type**: ``fd_acct_addr_t *``
- **Description**: A pointer to a constant `fd_acct_addr_t` type, initialized with a string representing the validator vote account address.
- **Use**: Used to store the address of the validator vote account in the system.


---
### merkle\_root\_authority\_addr
- **Type**: ``fd_acct_addr_t *``
- **Description**: Points to a constant string representing the address of the Merkle root authority. This address is used in the context of a program or system that involves account addresses, likely in a blockchain or distributed ledger environment.
- **Use**: Used to reference the Merkle root authority address in the program.


---
### validator\_identity\_pk
- **Type**: ``fd_acct_addr_t *``
- **Description**: A pointer to a constant `fd_acct_addr_t` type, which is a data structure representing an account address. The variable is initialized with a string literal that represents the validator's identity public key.
- **Use**: Used to store the public key of the validator's identity in the system.


---
### block\_engine\_commission\_pk
- **Type**: ``const char *``
- **Description**: A constant character pointer that holds a string value representing a public key for block engine commission.
- **Use**: Used to store the public key for block engine commission in the system.


---
### block\_engine\_commission\_pct
- **Type**: ``uchar``
- **Description**: Represents the commission percentage for the block engine. It is a constant value set to 2.
- **Use**: Used to define the commission percentage for transactions processed by the block engine.


---
### max\_priority
- **Type**: ``float``
- **Description**: A static constant floating-point variable with a value of 13.5.
- **Use**: Defines the maximum priority value for transactions.


---
### epoch
- **Type**: `ulong`
- **Description**: `epoch` is a static global variable of type `ulong` initialized to 0.
- **Use**: Tracks the current epoch in the system.


---
### leader\_slot
- **Type**: `ulong`
- **Description**: The `leader_slot` variable is a static global variable of type `ulong` initialized to 1.
- **Use**: It is used to track the current leader slot in the context of the pack tile test configuration.


---
### populate\_test\_vectors
- **Type**: `function`
- **Description**: Initializes test vectors for transactions by creating transactions with decreasing priority values and storing them in the `txn_scratch` array.
- **Use**: Used to set up test transactions with specific priorities for testing purposes.


# Data Structures

---
### txn\_ref
- **Type**: ``struct``
- **Members**:
    - ``prio``: A `float` representing the priority of the transaction.
    - ``txn_i``: An `int` representing the transaction index.
    - ``parent_cidx``: A `ushort` representing the index of the parent node in a treap.
    - ``left_cidx``: A `ushort` representing the index of the left child node in a treap.
    - ``right_cidx``: A `ushort` representing the index of the right child node in a treap.
    - ``prio_cidx``: A `ushort` representing the index used for priority comparison in a treap.
    - ``prev_cidx``: A `ushort` representing the index of the previous node in a treap.
    - ``next_cidx``: A `ushort` representing the index of the next node in a treap.
- **Description**: The `txn_ref` structure is used to represent a transaction reference with associated priority and indexing information for use in a treap data structure. It includes fields for transaction priority and index, as well as several indices for managing the node's position and relationships within a treap, which is a type of binary search tree that maintains a heap property.


---
### txn\_ref\_t
- **Type**: ``struct``
- **Members**:
    - ``prio``: A `float` representing the priority of the transaction.
    - ``txn_i``: An `int` representing the transaction index.
    - ``parent_cidx``: A `ushort` representing the index of the parent node in a treap.
    - ``left_cidx``: A `ushort` representing the index of the left child node in a treap.
    - ``right_cidx``: A `ushort` representing the index of the right child node in a treap.
    - ``prio_cidx``: A `ushort` representing the index of the node with the highest priority in a treap.
    - ``prev_cidx``: A `ushort` representing the index of the previous node in a treap.
    - ``next_cidx``: A `ushort` representing the index of the next node in a treap.
- **Description**: The `txn_ref_t` structure is used to represent a transaction reference in a treap data structure. It includes fields for transaction priority and index, as well as indices for navigating the treap, such as parent, left, right, priority, previous, and next child indices. This structure is essential for managing transaction ordering and priority in a transactional system.


---
### fd\_tile\_test\_locals
- **Type**: ``struct``
- **Members**:
    - `txn_in_pack`: Number of transactions currently stored in the pack, including bundle transactions.
    - `txn_i`: Current transaction being published.
    - `txn_ref_i`: Current transaction to check against.
    - `txn_cnt`: Expected number of transactions in the pack-bank link.
    - `in_sig`: Minimum blockhash from the resolve_pack link.
    - `bundle_id`: Current bundle ID.
    - `bundle_txn_rcvd`: Number of transactions received in the current bundle.
    - `txn_per_bundle`: Total number of transactions in the current bundle.
    - `last_successful_insert`: Updated every time in after_frag_check.
    - `wrap_around`: Wrap around when `txn_i` hits MAX.
    - `is_stress_test`: Indicates if a stress test is active.
    - `stress_test_published`: Number of stress test transactions published.
    - `stress_test_target`: Target number of transactions for the stress test.
    - `_treap`: Array for internal treap structure.
    - `txn_ref_treap`: Pointer for tracking correct ordering of transactions in stress test.
    - `txn_ref_pool`: Pointer to the transaction reference pool.
    - `become_leader_ref`: Reference to the leader status in the poh_pack link.
    - `curr_leader_slot`: Current leader slot number.
    - `crank_enabled`: Indicates if the crank is enabled.
    - `rebate_ref`: Reference to the rebate in the bank_pack link.
    - `rebate_checked`: Indicates if the rebate has been checked.
    - `microblocks_in_slot`: Number of microblocks packed in the current leader slot.
    - `microblocks_in_prev_slot`: Number of microblocks packed in the previous leader slot.
- **Description**: Manages the state and operations related to transaction processing, stress testing, and leader slot management in a tile test environment. It includes fields for tracking transaction counts, bundle information, stress test parameters, and leader slot details. The structure is used to coordinate various aspects of transaction handling and testing within a distributed system.


# Functions

---
### make\_transaction<!-- {{#callable:make_transaction}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L169>)

Creates a transaction with specified parameters, calculates its cost, and returns the optimal fee.
- **Inputs**:
    - ``txnp``: Pointer to a `fd_txn_p_t` structure where the transaction will be stored.
    - ``i``: Unique identifier for the transaction.
    - ``compute``: Amount of compute units requested for the transaction.
    - ``loaded_data_sz``: Size of the data to be loaded for the transaction.
    - ``priority``: Priority level of the transaction, influencing the fee.
    - ``writes``: String representing writable accounts involved in the transaction.
    - ``reads``: String representing readonly accounts involved in the transaction.
- **Logic and Control Flow**:
    - Initialize pointers `p` and `p_base` to the payload of `txnp` and a transaction structure `t` from `txnp`.
    - Set the first byte of the payload to 1 and copy the transaction identifier `i` and a signature suffix into the payload.
    - Copy the `compute` value into the payload and update the pointer `p` to the end of the signature section.
    - Set various fields in the transaction structure `t`, including version, signature count, and account address offsets.
    - Add the signer, writable accounts, compute budget, work program, and readonly accounts to the payload, updating `p` accordingly.
    - Set instruction counts and offsets in `t` and write instruction data for compute, rewards per compute unit, and loaded data size.
    - Calculate the transaction cost using [`fd_pack_compute_cost`](<fd_pack_cost.h.md#fd_pack_compute_cost>) and store the result in `cost`.
    - Return the optimal fee `opt_fee` calculated from the transaction cost.
- **Output**: Returns the optimal fee for the transaction as an `ulong`.
- **Functions Called**:
    - [`fd_pack_compute_cost`](<fd_pack_cost.h.md#fd_pack_compute_cost>)


---
### print\_txn\_treap<!-- {{#callable:print_txn_treap}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L260>)

Logs the details of transactions and bundles in a treap structure from the given context.
- **Inputs**:
    - `ctx`: A pointer to an `fd_pack_ctx_t` structure that contains the context with transaction and bundle treaps to be logged.
- **Logic and Control Flow**:
    - Logs the start of the transaction treap printing process.
    - Logs the maximum depth of the transaction treap using `ctx->pack->pack_depth`.
    - Initializes a reverse iterator for the transaction treap and iterates over it.
    - For each transaction in the treap, logs the writable signer and read-only account from the transaction's payload.
    - Logs the start of the bundle treap printing process.
    - Initializes a reverse iterator for the bundle treap and iterates over it.
    - For each transaction in the bundle treap, logs the writable signer and read-only account from the transaction's payload.
    - Logs the end of the transaction treap printing process.
- **Output**: No return value; the function performs logging operations.


---
### print\_txn\_ref\_treap<!-- {{#callable:print_txn_ref_treap}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L287>)

Iterates over a transaction reference treap in reverse order and logs the priority and index of each transaction.
- **Inputs**:
    - ``treap``: A pointer to a `txn_ref_treap_t` structure representing the transaction reference treap to iterate over.
    - ``pool``: A pointer to a `txn_ref_t` structure representing the pool of transaction references.
- **Logic and Control Flow**:
    - Logs the start of the treap iteration with a notice message.
    - Initializes a reverse iterator `prev` to a null index using `txn_ref_treap_idx_null()`.
    - Starts a loop with a reverse iterator `_cur` initialized by `txn_ref_treap_rev_iter_init(treap, pool)`.
    - Checks if the iteration is done using `txn_ref_treap_rev_iter_done(_cur)`.
    - Inside the loop, updates `prev` to the next element using `txn_ref_treap_rev_iter_next(_cur, pool)`.
    - Retrieves the current transaction reference `cur` using `txn_ref_treap_rev_iter_ele(_cur, pool)`.
    - Logs the priority and index of the current transaction reference `cur` with a notice message.
    - Ends the loop when all elements have been iterated over.
    - Logs the end of the treap iteration with a notice message.
- **Output**: No return value; the function outputs log messages to the notice log.


---
### txn\_select\_in\_link<!-- {{#callable:txn_select_in_link}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L303>)

Selects the appropriate input link for a transaction based on the current transaction index and leader slot status.
- **Inputs**:
    - ``test_links``: An array of pointers to `fd_tile_test_link_t` structures representing the available test links.
    - ``test_ctx``: A pointer to an `fd_tile_test_ctx_t` structure representing the test context, which includes local transaction information.
    - ``ctx``: A pointer to an `fd_pack_ctx_t` structure representing the pack context, which includes the leader slot information.
- **Logic and Control Flow**:
    - Check if the current transaction index (`txn_i`) in `test_ctx->locals` is less than `MAX_TEST_TXNS`.
    - If true, set `test_ctx->in_link` to `test_links[TEST_LINK_RESOLV_PACK]`.
    - If false, check if `ctx->leader_slot` is equal to `ULONG_MAX`.
    - If true, set `test_ctx->in_link` to `test_links[TEST_LINK_POH_PACK]`.
    - If neither condition is met, set `test_ctx->in_link` to `NULL`.
- **Output**: The function does not return a value; it modifies `test_ctx->in_link` to point to the selected input link or `NULL`.


---
### txn\_select\_out\_links<!-- {{#callable:txn_select_out_links}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L316>)

Checks if the current leader slot is valid and if there are transactions in the pack, then triggers an output check callback.
- **Inputs**:
    - ``test_links``: An array of pointers to `fd_tile_test_link_t` structures representing the test links.
    - ``test_ctx``: A pointer to an `fd_tile_test_ctx_t` structure representing the test context.
    - ``ctx``: A pointer to an `fd_pack_ctx_t` structure, which is unused in this function.
- **Logic and Control Flow**:
    - Check if `test_ctx->locals->curr_leader_slot` is not equal to `ULONG_MAX` and `test_ctx->locals->txn_in_pack` is true.
    - If both conditions are true, call `fd_tile_test_check_output` with `FD_TILE_TEST_CALLBACK_AFTER_CREDIT` and `test_links[TEST_LINK_PACK_BANK]`.
- **Output**: No return value (void function).


---
### bundle\_select\_in\_link<!-- {{#callable:bundle_select_in_link}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L325>)

Selects the appropriate input link for a test context based on the state of local variables.
- **Inputs**:
    - ``test_links``: An array of pointers to `fd_tile_test_link_t` structures representing the available test links.
    - ``test_ctx``: A pointer to an `fd_tile_test_ctx_t` structure representing the test context.
    - ``ctx``: A pointer to an `fd_pack_ctx_t` structure, which is unused in this function.
- **Logic and Control Flow**:
    - Retrieve the `locals` pointer from `test_ctx->locals`.
    - Check if `locals->bundle_txn_rcvd` is less than `locals->txn_per_bundle`. If true, set `test_ctx->in_link` to `test_links[TEST_LINK_RESOLV_PACK]`.
    - If the previous condition is false, check if `locals->curr_leader_slot` is equal to `ULONG_MAX`. If true, set `test_ctx->in_link` to `test_links[TEST_LINK_POH_PACK]`.
    - If the previous condition is false, check if `locals->rebate_ref.ib_result` is equal to `INT_MAX`. If true, set `test_ctx->in_link` to `test_links[TEST_LINK_BANK_PACK]`.
    - If none of the above conditions are true, set `test_ctx->in_link` to `NULL`.
- **Output**: The function does not return a value; it modifies `test_ctx->in_link` directly.


---
### bundle\_select\_out\_links<!-- {{#callable:bundle_select_out_links}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L341>)

Selects the appropriate output link for a bundle based on specific conditions in the test context.
- **Inputs**:
    - ``test_links``: An array of pointers to `fd_tile_test_link_t` structures representing the available test links.
    - ``test_ctx``: A pointer to an `fd_tile_test_ctx_t` structure containing the test context, including local variables and state information.
    - ``ctx``: A pointer to an `fd_pack_ctx_t` structure, which is unused in this function.
- **Logic and Control Flow**:
    - Retrieve the `locals` structure from `test_ctx` to access local variables.
    - Check if `bundle_txn_rcvd` equals `txn_per_bundle`, `curr_leader_slot` is not `ULONG_MAX`, and `rebate_ref.ib_result` is not `INT_MAX`.
    - If all conditions are true, call `fd_tile_test_check_output` with `FD_TILE_TEST_CALLBACK_AFTER_CREDIT` and the `test_links[TEST_LINK_PACK_BANK]` link.
- **Output**: No return value; the function modifies the state of the test context and potentially triggers an output check.


---
### leader\_select\_in\_link<!-- {{#callable:leader_select_in_link}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L353>)

Selects the appropriate input link for a test context based on transaction index, leader slot, and transaction pack conditions.
- **Inputs**:
    - ``test_links``: An array of pointers to `fd_tile_test_link_t` structures representing the available test links.
    - ``test_ctx``: A pointer to an `fd_tile_test_ctx_t` structure representing the test context, which includes local state information.
    - ``ctx``: A pointer to an `fd_pack_ctx_t` structure representing the pack context, which includes the leader slot information.
- **Logic and Control Flow**:
    - Retrieve the local state from `test_ctx` using `locals = test_ctx->locals`.
    - Check if `locals->txn_i` is less than 4; if true, set `test_ctx->in_link` to `test_links[TEST_LINK_RESOLV_PACK]`.
    - If the above condition is false, check if `ctx->leader_slot` is equal to `ULONG_MAX`; if true, set `test_ctx->in_link` to `test_links[TEST_LINK_POH_PACK]`.
    - If the above condition is false, check if `locals->txn_in_pack` is 2 and `locals->curr_leader_slot` is equal to `ctx->leader_slot`; if true, set `test_ctx->in_link` to `test_links[TEST_LINK_POH_PACK]`.
    - If none of the above conditions are met, set `test_ctx->in_link` to `NULL`.
- **Output**: The function does not return a value; it modifies the `in_link` field of the `test_ctx` structure.


---
### leader\_select\_out\_links<!-- {{#callable:leader_select_out_links}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L369>)

Selects output links for a leader based on the current context and transaction state.
- **Inputs**:
    - ``test_links``: An array of pointers to `fd_tile_test_link_t` structures representing the test links available for selection.
    - ``test_ctx``: A pointer to an `fd_tile_test_ctx_t` structure containing the test context, including local state information.
    - ``ctx``: A pointer to an `fd_pack_ctx_t` structure representing the current pack context, including leader slot information.
- **Logic and Control Flow**:
    - Retrieve the `locals` pointer from `test_ctx` to access local state information.
    - Check if `ctx->leader_slot` is not equal to `ULONG_MAX` and `locals->txn_in_pack` is true.
    - If both conditions are true, call `fd_tile_test_check_output` with `FD_TILE_TEST_CALLBACK_AFTER_CREDIT` and `test_links[TEST_LINK_PACK_BANK]`.
    - Check if `ctx->leader_slot` is not equal to `ULONG_MAX` and `locals->curr_leader_slot` is not equal to `ctx->leader_slot`.
    - If both conditions are true, call `fd_tile_test_check_output` with `FD_TILE_TEST_CALLBACK_AFTER_FRAG` and `test_links[TEST_LINK_PACK_POH]`.
- **Output**: No return value; the function modifies the state of the test links based on the conditions.


---
### stress\_txn\_select\_in\_link<!-- {{#callable:stress_txn_select_in_link}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L382>)

Selects the appropriate input link for a stress test based on the current state of the test context and pack context.
- **Inputs**:
    - ``test_links``: An array of pointers to `fd_tile_test_link_t` structures representing the available test links.
    - ``test_ctx``: A pointer to an `fd_tile_test_ctx_t` structure representing the current test context.
    - ``ctx``: A pointer to an `fd_pack_ctx_t` structure representing the current pack context.
- **Logic and Control Flow**:
    - Retrieve the `locals` pointer from `test_ctx` to access local test variables.
    - Check if `locals->stress_test_published` is less than `locals->stress_test_target`.
    - If true, set `test_ctx->in_link` to `test_links[TEST_LINK_RESOLV_PACK]`.
    - If false, check if `ctx->leader_slot` is `ULONG_MAX` and `locals->txn_in_pack` is true.
    - If both conditions are true, set `test_ctx->in_link` to `test_links[TEST_LINK_POH_PACK]`.
    - If none of the above conditions are met, set `test_ctx->in_link` to `NULL`.
- **Output**: The function does not return a value; it modifies `test_ctx->in_link` to point to the selected input link or `NULL`.


---
### stress\_txn\_select\_out\_links<!-- {{#callable:stress_txn_select_out_links}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L396>)

Checks if certain conditions are met to trigger an output link callback during a stress test.
- **Inputs**:
    - ``test_links``: An array of pointers to `fd_tile_test_link_t` structures representing the test links.
    - ``test_ctx``: A pointer to an `fd_tile_test_ctx_t` structure representing the test context.
    - ``ctx``: A pointer to an `fd_pack_ctx_t` structure representing the pack context.
- **Logic and Control Flow**:
    - Retrieve the `locals` pointer from `test_ctx->locals`.
    - Check if `locals->stress_test_published` is greater than or equal to `locals->stress_test_target`.
    - Check if `ctx->leader_slot` is not equal to `ULONG_MAX`.
    - Check if `locals->txn_in_pack` is true.
    - If all conditions are met, call `fd_tile_test_check_output` with `FD_TILE_TEST_CALLBACK_AFTER_CREDIT` and `test_links[TEST_LINK_PACK_BANK]`.
- **Output**: No return value; the function performs an action based on conditions.


---
### overrun\_txn\_select\_in\_link<!-- {{#callable:overrun_txn_select_in_link}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L407>)

Selects the appropriate input link for a transaction based on the state of the `test_links`, `test_ctx`, and `ctx`.
- **Inputs**:
    - ``test_links``: An array of pointers to `fd_tile_test_link_t` structures representing the available test links.
    - ``test_ctx``: A pointer to an `fd_tile_test_ctx_t` structure representing the test context, which includes the current state and configuration of the test.
    - ``ctx``: A pointer to an `fd_pack_ctx_t` structure representing the pack context, which includes the current state and configuration of the pack.
- **Logic and Control Flow**:
    - Check if the consumer sequence of `test_links[TEST_LINK_RESOLV_PACK]` is `ULONG_MAX` or if `test_ctx->is_overrun` is true.
    - If either condition is true, set `test_ctx->in_link` to `test_links[TEST_LINK_RESOLV_PACK]`.
    - If the above condition is false, check if `ctx->leader_slot` is `ULONG_MAX`.
    - If `ctx->leader_slot` is `ULONG_MAX`, set `test_ctx->in_link` to `test_links[TEST_LINK_POH_PACK]`.
    - If none of the above conditions are met, set `test_ctx->in_link` to `NULL`.
- **Output**: The function does not return a value; it modifies `test_ctx->in_link` to point to the selected input link or `NULL`.


---
### overrun\_txn\_select\_out\_links<!-- {{#callable:overrun_txn_select_out_links}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L421>)

Selects the appropriate output link for a transaction based on the current leader slot and transaction pack status.
- **Inputs**:
    - ``test_links``: An array of pointers to `fd_tile_test_link_t` structures representing the test links available for selection.
    - ``test_ctx``: A pointer to an `fd_tile_test_ctx_t` structure containing the test context, including local transaction information.
    - ``ctx``: A pointer to an `fd_pack_ctx_t` structure containing the pack context, including the current leader slot information.
- **Logic and Control Flow**:
    - Check if `ctx->leader_slot` is not equal to `ULONG_MAX` and `test_ctx->locals->txn_in_pack` is true.
    - If both conditions are true, call `fd_tile_test_check_output` with `FD_TILE_TEST_CALLBACK_AFTER_CREDIT` and the test link at index `TEST_LINK_PACK_BANK`.
- **Output**: No return value; the function modifies the state of the test context and potentially triggers an output check.


---
### overrun\_bundle\_select\_in\_link<!-- {{#callable:overrun_bundle_select_in_link}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L431>)

Selects the appropriate input link for a test context based on transaction and bundle conditions.
- **Inputs**:
    - ``test_links``: An array of pointers to `fd_tile_test_link_t` structures representing the available test links.
    - ``test_ctx``: A pointer to an `fd_tile_test_ctx_t` structure representing the test context.
    - ``ctx``: A pointer to an `fd_pack_ctx_t` structure representing the pack context.
- **Logic and Control Flow**:
    - Retrieve the `locals` structure from `test_ctx`.
    - Check if the number of transactions received in the current bundle is less than the total number of transactions per bundle or if the test context is in an overrun state.
    - If true, set the input link to `test_links[TEST_LINK_RESOLV_PACK]`.
    - If the leader slot in `ctx` is `ULONG_MAX`, set the input link to `test_links[TEST_LINK_POH_PACK]`.
    - If the `ib_result` in `locals->rebate_ref` is `INT_MAX`, set the input link to `test_links[TEST_LINK_BANK_PACK]`.
    - If none of the above conditions are met, set the input link to `NULL`.
- **Output**: The function does not return a value; it modifies the `in_link` field of `test_ctx`.


---
### overrun\_bundle\_select\_out\_links<!-- {{#callable:overrun_bundle_select_out_links}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L448>)

Checks if the `rebate_ref.ib_result` is not `INT_MAX` and `txn_in_pack` is true, then calls `fd_tile_test_check_output` with `FD_TILE_TEST_CALLBACK_AFTER_CREDIT` and the `test_links[TEST_LINK_PACK_BANK]`.
- **Inputs**:
    - `test_links`: An array of pointers to `fd_tile_test_link_t` structures representing the test links.
    - `test_ctx`: A pointer to an `fd_tile_test_ctx_t` structure representing the test context.
    - `ctx`: A pointer to an `fd_pack_ctx_t` structure, marked as unused in this function.
- **Logic and Control Flow**:
    - Checks if `test_ctx->locals->rebate_ref.ib_result` is not equal to `INT_MAX` and `test_ctx->locals->txn_in_pack` is true.
    - If both conditions are true, calls `fd_tile_test_check_output` with `FD_TILE_TEST_CALLBACK_AFTER_CREDIT` and `test_links[TEST_LINK_PACK_BANK]`.
- **Output**: No return value; the function performs an action based on the conditions.


---
### bc\_check<!-- {{#callable:bc_check}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L460>)

Checks if a transaction bundle is not initialized and if the current spot in the context is not null, logging a warning and returning an error code if true.
- **Inputs**:
    - ``test_ctx``: A pointer to a `fd_tile_test_ctx_t` structure, which contains the test context including local variables and state information.
    - ``ctx``: A pointer to a `fd_pack_ctx_t` structure, which contains the pack context including the current spot and other state information.
- **Logic and Control Flow**:
    - Check if `test_ctx->locals->bundle_id` is zero and `ctx->cur_spot` is not null.
    - If both conditions are true, log a warning message 'overrun frag not cleaned up'.
    - Return -1 to indicate an error condition.
    - If the conditions are not met, return 0 to indicate success.
- **Output**: Returns 0 if the check passes without issues, or -1 if a warning condition is detected.


---
### bank\_out\_check<!-- {{#callable:bank_out_check}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L472>)

Verifies the output of the pack-bank link by checking transaction scheduling and matching transaction counts.
- **Inputs**:
    - ``test_ctx``: A pointer to the `fd_tile_test_ctx_t` structure, which contains the local test context.
    - ``ctx``: A pointer to the `fd_pack_ctx_t` structure, which contains the pack context.
    - ``bank_out_link``: A pointer to the `fd_tile_test_link_t` structure, which represents the bank output link.
- **Logic and Control Flow**:
    - Check if `ctx->leader_slot` is `ULONG_MAX`, return 0 if true, indicating no leader slot timeout.
    - Determine if a transaction might be scheduled by checking `ctx->skip_cnt`, return 0 if no transaction is scheduled.
    - Retrieve local variables from `test_ctx->locals`.
    - Calculate the memory location for the output transaction using `bank_out_link` properties.
    - If `locals->bundle_id` is set and `locals->rebate_checked` is not set, verify the transaction size and update the sequence and chunk, then return 0.
    - Calculate the number of transactions in the output and compare it with `locals->txn_cnt`, log a warning and return -1 if they do not match.
    - Iterate over each transaction, comparing payload sizes and contents, logging warnings and returning -1 if mismatches are found.
    - Update the sequence and chunk for `bank_out_link` after successful verification.
    - Update the local transaction count and microblock count.
- **Output**: Returns 0 on successful verification, or -1 if any checks fail.
- **Functions Called**:
    - [`print_txn_treap`](<#print_txn_treap>)
    - [`print_txn_ref_treap`](<#print_txn_ref_treap>)


---
### poh\_out\_check<!-- {{#callable:poh_out_check}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L581>)

Checks if the number of microblocks in the current slot matches the expected count from the previous slot and updates the production sequence and chunk index accordingly.
- **Inputs**:
    - ``test_ctx``: A pointer to `fd_tile_test_ctx_t`, which contains the test context including local variables and state information.
    - ``ctx``: A pointer to `fd_pack_ctx_t`, which is unused in this function.
    - ``poh_out_link``: A pointer to `fd_tile_test_link_t`, representing the output link for the poh (proof of history) process.
- **Logic and Control Flow**:
    - Calculate the memory line index using `fd_mcache_line_idx` with `poh_out_link->prod_seq` and `poh_out_link->depth`.
    - Compute the output memory address by converting the chunk to a local address and adding the control value from the memory line.
    - Check if the size of the memory line equals the size of `fd_done_packing_t`.
    - Cast the output memory to a `fd_done_packing_t` pointer.
    - Compare `done_packing->microblocks_in_slot` with `test_ctx->locals->microblocks_in_prev_slot`.
    - Log a warning and return -1 if the values do not match.
    - Increment `poh_out_link->prod_seq` using `fd_seq_inc`.
    - Update `poh_out_link->chunk` using `fd_dcache_compact_next`.
    - Return 0 to indicate success.
- **Output**: Returns 0 if the check is successful, otherwise returns -1 if there is a mismatch in the microblock count.


---
### resolve\_publish\_txn<!-- {{#callable:resolve_publish_txn}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L606>)

Publishes a transaction from `txn_scratch` to the `resolv_pack_link`'s memory cache and data cache.
- **Inputs**:
    - `test_ctx`: A pointer to `fd_tile_test_ctx_t`, which contains the context for the test, including local variables like `txn_i` and `txn_cnt`.
    - `resolv_pack_link`: A pointer to `fd_tile_test_link_t`, which represents the link to the resolve pack, including its base address and chunk information.
- **Logic and Control Flow**:
    - Retrieve the current transaction index `txn_i` from `test_ctx->locals`.
    - Check if `txn_i` is greater than or equal to `MAX_TEST_TXNS`; if so, return 0.
    - Get the transaction pointer `txnp` from `txn_scratch` using `txn_i`.
    - Calculate the transaction size `txnp_sz` and transaction type size `txnt_sz` for the current transaction.
    - Convert the chunk address from `resolv_pack_link` to a local address and cast it to `fd_txn_m_t` to get `txnm`.
    - Set the payload size and transaction type size in `txnm` using `txnp_sz` and `txnt_sz`.
    - Copy the payload and transaction type data from `txnp` and `txn` to `txnm` using `fd_memcpy`.
    - Calculate the footprint of the realized transaction `txnm_footprint` using `fd_txn_m_realized_footprint`.
    - Test the validity of `txnm_footprint` using `FD_TEST`.
    - Publish the transaction to the memory cache using `fd_mcache_publish`.
    - Set the `bundle_id` of `txnm->block_engine` to 0.
    - Set the transaction count `txn_cnt` in `test_ctx->locals` to 1.
    - Return the `txnm_footprint`.
- **Output**: Returns the size of the published transaction's footprint as an `ulong`.


---
### resolve\_publish\_bundle<!-- {{#callable:resolve_publish_bundle}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L632>)

Publishes a transaction bundle to a specified link and updates transaction metadata.
- **Inputs**:
    - ``test_ctx``: A pointer to `fd_tile_test_ctx_t`, which contains the context for the tile test, including local variables and state.
    - ``resolv_pack_link``: A pointer to `fd_tile_test_link_t`, which represents the link where the transaction bundle will be published.
- **Logic and Control Flow**:
    - Call [`resolve_publish_txn`](<#resolve_publish_txn>) with `test_ctx` and `resolv_pack_link` to get the transaction footprint.
    - Check if `txnm_footprint` is non-zero, indicating a transaction was published.
    - If a transaction was published, retrieve the transaction metadata from the link's chunk and update its `bundle_id` and `bundle_txn_cnt` with values from `test_ctx->locals`.
    - Copy the `block_engine_commission_pk` to the transaction's `commission_pubkey` and set the `commission` to `block_engine_commission_pct`.
    - Update `test_ctx->locals->txn_cnt` to `test_ctx->locals->txn_per_bundle`.
- **Output**: Returns the footprint of the published transaction as an unsigned long integer.
- **Functions Called**:
    - [`resolve_publish_txn`](<#resolve_publish_txn>)


---
### resolve\_publish\_txn\_overrun<!-- {{#callable:resolve_publish_txn_overrun}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L653>)

Handles transaction overrun by incrementing transaction indices and publishing a transaction, adjusting the production sequence if necessary.
- **Inputs**:
    - ``test_ctx``: A pointer to `fd_tile_test_ctx_t`, which contains the test context including local variables and state information.
    - ``resolv_pack_link``: A pointer to `fd_tile_test_link_t`, which represents the link used for publishing transactions and contains metadata such as production sequence and depth.
- **Logic and Control Flow**:
    - Retrieve the local variables from `test_ctx`.
    - Check if `test_ctx->is_overrun` is true; if so, increment `locals->txn_i` and `locals->txn_ref_i`.
    - Call [`resolve_publish_txn`](<#resolve_publish_txn>) with `test_ctx` and `resolv_pack_link` to publish a transaction and store the returned fragment size in `frag_sz`.
    - Check if `resolv_pack_link->prod_seq` is less than `resolv_pack_link->depth`; if true, increment `resolv_pack_link->prod_seq` by `resolv_pack_link->depth` using `fd_seq_inc`.
    - Return the fragment size `frag_sz`.
- **Output**: Returns the size of the published transaction fragment as an `ulong`.
- **Functions Called**:
    - [`resolve_publish_txn`](<#resolve_publish_txn>)


---
### resolve\_publish\_bundle\_overrun<!-- {{#callable:resolve_publish_bundle_overrun}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L668>)

Handles the resolution of transaction bundle overruns by updating transaction indices and publishing the next bundle.
- **Inputs**:
    - ``test_ctx``: A pointer to `fd_tile_test_ctx_t`, which contains the context for the tile test, including local variables and state information.
    - ``resolv_pack_link``: A pointer to `fd_tile_test_link_t`, which represents the link used for publishing resolved bundles.
- **Logic and Control Flow**:
    - Check if `test_ctx->is_overrun` is true, indicating a bundle overrun.
    - If overrun, increment `locals->txn_ref_i` by `locals->bundle_txn_rcvd + 1` to skip overrun transactions.
    - Decrease `locals->txn_in_pack` by `locals->bundle_txn_rcvd` to remove overrun transactions from the pack.
    - Increment `locals->txn_i` and `locals->bundle_id` to move to the next bundle, and reset `locals->bundle_txn_rcvd` to 0.
    - Call [`resolve_publish_bundle`](<#resolve_publish_bundle>) to publish the next bundle and store the returned fragment size in `frag_sz`.
    - If `locals->bundle_txn_rcvd` equals `locals->txn_per_bundle - 2` and `resolv_pack_link->prod_seq` is less than `resolv_pack_link->depth`, increment `resolv_pack_link->prod_seq` using `fd_seq_inc`.
- **Output**: Returns the size of the fragment published by [`resolve_publish_bundle`](<#resolve_publish_bundle>).
- **Functions Called**:
    - [`resolve_publish_bundle`](<#resolve_publish_bundle>)


---
### resolve\_df\_check<!-- {{#callable:resolve_df_check}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L690>)

Verifies the context state during a transaction processing step and checks for mismatches in transaction payloads and bundle attributes.
- **Inputs**:
    - ``test_ctx``: A pointer to `fd_tile_test_ctx_t`, which holds the test context including local variables and state information.
    - ``ctx``: A pointer to `fd_pack_ctx_t`, which holds the current context of the transaction processing, including the current transaction spot and bundle information.
- **Logic and Control Flow**:
    - Retrieve the local variables from `test_ctx` and the current transaction index `ref_i`.
    - Get the transaction pointer `txnp` from the `txn_scratch` array using `ref_i`.
    - Check if `ctx->cur_spot` is NULL; if so, log a warning and return -1.
    - Compare the payload size and content of the current transaction in `ctx->cur_spot` with the reference transaction `txnp`; if they do not match, log warnings and return -1.
    - If `locals->bundle_id` is non-zero, perform additional checks for bundle attributes:
    - Verify if `ctx->is_bundle` is true; if not, log a warning and return -1.
    - Check if the bundle ID, transaction count, received transaction count, signature, commission percentage, and commission public key match the expected values in `locals`; log warnings and return -1 if any mismatch is found.
    - Return 0 if all checks pass.
- **Output**: Returns 0 if all checks pass, otherwise returns -1 if any mismatch or error is detected.
- **Functions Called**:
    - [`print_txn_treap`](<#print_txn_treap>)
    - [`print_txn_ref_treap`](<#print_txn_ref_treap>)


---
### resolve\_af\_update<!-- {{#callable:resolve_af_update}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L746>)

Updates transaction context after a transaction is processed, handling stress test conditions and transaction indexing.
- **Inputs**:
    - ``test_ctx``: A pointer to `fd_tile_test_ctx_t`, which contains the local test context and state information.
    - ``ctx``: A pointer to `fd_pack_ctx_t`, which is unused in this function but typically contains the packing context.
- **Logic and Control Flow**:
    - Retrieve `locals` from `test_ctx` to access local state variables.
    - Check if `is_stress_test` is true; if so, acquire an index from `txn_ref_pool` and update the transaction reference pool and treap with the current transaction index and priority.
    - Increment the transaction index `txn_i`.
    - If `wrap_around` is true, reset `txn_i` using modulo operation with `MAX_TEST_TXNS`.
    - If `bundle_id` is non-zero, increment `bundle_txn_rcvd`.
    - Increment `txn_in_pack` to reflect the number of transactions in the current pack.
    - Update `last_successful_insert` with the current tick count using `fd_tickcount()`.
- **Output**: Returns 0 to indicate successful execution.


---
### poh\_publish<!-- {{#callable:poh_publish}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L767>)

Publishes a `fd_became_leader_t` structure to a specified link and updates the leader slot.
- **Inputs**:
    - ``test_ctx``: A pointer to `fd_tile_test_ctx_t`, which contains the test context and local variables.
    - ``poh_pack_link``: A pointer to `fd_tile_test_link_t`, which represents the link where the `fd_became_leader_t` structure will be published.
- **Logic and Control Flow**:
    - Retrieve the `locals` pointer from `test_ctx` to access local variables.
    - Initialize the `become_leader_ref` structure with current wallclock time, slot duration, maximum microblocks, ticks per slot, epoch, and cost limits.
    - If `crank_enabled` is true, set specific fields in the `bundle->config` structure.
    - Copy the `become_leader_ref` structure to the memory location specified by `poh_pack_link`.
    - Update `curr_leader_slot` with the current `leader_slot`.
    - Increment `leader_slot` and wrap it around using `TRANSACTION_LIFETIME_SLOTS`.
- **Output**: Returns the size of the `fd_became_leader_t` structure, which is `sizeof(fd_became_leader_t)`.


---
### poh\_make\_sig<!-- {{#callable:poh_make_sig}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L793>)

Generates a signature for a Proof of History (PoH) packet indicating a leader change event.
- **Inputs**:
    - ``test_ctx``: A pointer to a `fd_tile_test_ctx_t` structure containing the test context, which includes local state information such as the current leader slot.
    - ``poh_pack_link``: A pointer to a `fd_tile_test_link_t` structure, which is unused in this function.
- **Logic and Control Flow**:
    - Calls the function `fd_disco_poh_sig` with the current leader slot from `test_ctx->locals->curr_leader_slot`, the packet type `POH_PKT_TYPE_BECAME_LEADER`, and a zero value.
    - Returns the result of the `fd_disco_poh_sig` function call.
- **Output**: Returns an unsigned long integer representing the generated PoH signature.


---
### poh\_df\_check<!-- {{#callable:poh_df_check}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L799>)

Compares the `_became_leader` structure in `ctx` with the `become_leader_ref` in `test_ctx` and logs a warning if they do not match.
- **Inputs**:
    - `test_ctx`: A pointer to `fd_tile_test_ctx_t`, which contains the test context including local variables and references.
    - `ctx`: A pointer to `fd_pack_ctx_t`, which contains the context for the pack operation, including the `_became_leader` structure to be checked.
- **Logic and Control Flow**:
    - Use `fd_memeq` to compare `ctx->_became_leader` with `test_ctx->locals->become_leader_ref` for equality over the size of `fd_became_leader_t`.
    - If the structures do not match, log a hex dump warning for both `ctx->_became_leader` and `test_ctx->locals->become_leader_ref`.
    - Log a general warning message indicating the mismatch of the `_became_leader` structure.
    - Return -1 if the structures do not match, otherwise return 0.
- **Output**: Returns 0 if the structures match, otherwise returns -1.


---
### fake\_sign\_IB\_txn<!-- {{#callable:fake_sign_IB_txn}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L813>)

Prepares a fake signature for an IB transaction to prevent blocking in `fd_keyguard_client_sign`.
- **Inputs**:
    - ``ctx``: A pointer to an `fd_pack_ctx_t` structure, which contains context information for the transaction processing, including a reference to the `fd_keyguard_client_t`.
- **Logic and Control Flow**:
    - Retrieve the `fd_keyguard_client_t` from the `ctx->crank->keyguard_client`.
    - Calculate the expected sequence number `fd_mcache_wait_seq_expected` from `client->response_seq`.
    - Determine the memory line `fd_mcache_wait_mline` in the response cache using `fd_mcache_line_idx` and `client->response_depth`.
    - Check if `fd_mcache_wait_mline->chunk` is zero; if so, set it to `ctx->crank->keyguard_client[0].response_chunk0`.
    - If `fd_mcache_wait_mline->chunk` is not zero, update it using `fd_dcache_compact_next` with parameters including `ctx->crank->keyguard_client[0].response_chunk0` and `ctx->crank->keyguard_client[0].response_wmark`.
    - Set `fd_mcache_wait_mline->seq` to `fd_mcache_wait_seq_expected`.
- **Output**: No return value; the function modifies the `fd_mcache_wait_mline` in place.


---
### poh\_af\_check<!-- {{#callable:poh_af_check}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L827>)

Checks if the current leader slot matches the expected leader slot and performs actions based on bundle conditions.
- **Inputs**:
    - ``test_ctx``: A pointer to `fd_tile_test_ctx_t`, which contains the test context and local variables.
    - ``ctx``: A pointer to `fd_pack_ctx_t`, which contains the context for the pack operation, including the current leader slot.
- **Logic and Control Flow**:
    - Retrieve `locals` from `test_ctx->locals` to access local variables.
    - Check if `ctx->leader_slot` is not equal to `locals->curr_leader_slot`. If true, log a warning and return -1.
    - Check if `locals->bundle_id` is non-zero, `locals->bundle_txn_rcvd` equals `locals->txn_per_bundle`, and `locals->crank_enabled` is true. If all conditions are met, call `fake_sign_IB_txn(ctx)`.
    - Set `locals->microblocks_in_prev_slot` to `locals->microblocks_in_slot`.
    - Reset `locals->microblocks_in_slot` to 0.
    - Return 0 to indicate successful completion.
- **Output**: Returns 0 if the leader slot matches and actions are completed successfully, otherwise returns -1 if there is a mismatch in leader slots.
- **Functions Called**:
    - [`fake_sign_IB_txn`](<#fake_sign_ib_txn>)


---
### bank\_rebate\_publish<!-- {{#callable:bank_rebate_publish}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L849>)

Publishes a rebate reference to a bank pack link and returns the size of the rebate structure.
- **Inputs**:
    - ``test_ctx``: A pointer to a `fd_tile_test_ctx_t` structure that contains the test context, including local variables and state information.
    - ``bank_pack_link``: A pointer to a `fd_tile_test_link_t` structure that represents the bank pack link where the rebate reference will be published.
- **Logic and Control Flow**:
    - Sets the `rebate_ref` field in `test_ctx->locals` to a `fd_pack_rebate_t` structure with `ib_result` set to 1.
    - Copies the `rebate_ref` structure to the memory location calculated from `bank_pack_link->base` and `bank_pack_link->chunk`.
    - Returns the size of the `fd_pack_rebate_t` structure.
- **Output**: Returns the size of the `fd_pack_rebate_t` structure, which is the number of bytes copied to the bank pack link.


---
### bank\_rebate\_make\_sig<!-- {{#callable:bank_rebate_make_sig}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L859>)

Generates a signature for a bank rebate using the current leader slot information from the test context.
- **Inputs**:
    - ``test_ctx``: A pointer to a `fd_tile_test_ctx_t` structure that contains the test context, including the current leader slot information.
    - ``bank_pack_link``: A pointer to a `fd_tile_test_link_t` structure, which is unused in this function.
- **Logic and Control Flow**:
    - Calls `fd_disco_poh_sig` with the current leader slot from `test_ctx`, `POH_PKT_TYPE_BECAME_LEADER`, and `0UL` to generate a signature.
    - Passes the generated signature to `fd_disco_poh_sig_slot` to obtain the final signature value.
- **Output**: Returns an unsigned long integer representing the generated signature.


---
### bank\_rebate\_df\_check<!-- {{#callable:bank_rebate_df_check}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L865>)

Checks if the pending rebate size and rebate data in the context match expected values.
- **Inputs**:
    - ``test_ctx``: A pointer to `fd_tile_test_ctx_t`, which contains the test context including local variables and references.
    - ``ctx``: A pointer to `fd_pack_ctx_t`, which contains the context for the pack operation, including pending rebate size and rebate data.
- **Logic and Control Flow**:
    - Check if `ctx->pending_rebate_sz` is equal to `sizeof(fd_pack_rebate_t)`; if not, log a warning and return -1.
    - Use `fd_memeq` to compare `ctx->rebate` with `test_ctx->locals->rebate_ref` for `sizeof(fd_pack_rebate_t)` bytes; if they do not match, log a hexdump warning for both rebates, log a warning, and return -1.
    - If both checks pass, return 0.
- **Output**: Returns 0 if the checks pass, otherwise returns -1 if there is a mismatch.


---
### bank\_rebate\_af\_check<!-- {{#callable:bank_rebate_af_check}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L881>)

Checks if the current leader slot and bundle state are valid, and updates the transaction count in the pack.
- **Inputs**:
    - ``test_ctx``: A pointer to `fd_tile_test_ctx_t`, which contains the test context including local variables and state.
    - ``ctx``: A pointer to `fd_pack_ctx_t`, which contains the context for the pack, including the leader slot and pack state.
- **Logic and Control Flow**:
    - Retrieve `locals` from `test_ctx->locals` to access local state variables.
    - Check if `ctx->leader_slot` is equal to `locals->curr_leader_slot`. If not, log a warning and return -1.
    - Check if `ctx->pack->initializer_bundle_state` is equal to `FD_PACK_IB_STATE_READY`. If not, log a warning and return -1.
    - Increment `locals->txn_in_pack` to indicate an IB transaction has been inserted.
    - Return 0 to indicate success.
- **Output**: Returns 0 on success, or -1 if there is a mismatch in leader slot or bundle state.


---
### pack\_find\_in\_idx<!-- {{#callable:pack_find_in_idx}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L899>)

Finds the index of a memory block in the `ctx->in` array that matches the `base` of `test_link` and assigns it to `test_link->in_idx`.
- **Inputs**:
    - `test_link`: A pointer to an `fd_tile_test_link_t` structure, which contains a `base` member representing the memory block to find.
    - `ctx`: A pointer to an `fd_pack_ctx_t` structure, which contains an array `in` of memory blocks to search through.
- **Logic and Control Flow**:
    - Iterate over each element in the `ctx->in` array.
    - Check if the `mem` member of the current element in `ctx->in` matches the `base` member of `test_link`.
    - If a match is found, assign the current index to `test_link->in_idx` and exit the loop.
- **Output**: No return value; the function modifies `test_link->in_idx` directly.


---
### mock\_privileged\_init<!-- {{#callable:mock_privileged_init}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L927>)

Initializes a mock privileged environment for a tile in a topology, setting up workspace, links, and keyswitch for cranking.
- **Inputs**:
    - ``topo``: A pointer to an `fd_topo_t` structure representing the topology configuration.
    - ``tile``: A pointer to an `fd_topo_tile_t` structure representing the tile to initialize.
- **Logic and Control Flow**:
    - Sets `tile->pack.bank_tile_count` to 1, indicating a single bank tile.
    - Checks if `CRANK_WKSP_SIZE` is greater than the keyswitch footprint and workspace footprint, ensuring sufficient space.
    - Calculates `part_max` and `data_max` using `fd_wksp_part_max_est` and `fd_wksp_data_max_est` respectively.
    - Creates and joins a new workspace `crank_wksp` using `fd_wksp_new` and `fd_wksp_join`.
    - Joins shared memory anonymously with `fd_shmem_join_anonymous`.
    - Sets up a workspace in the topology with `fd_topob_wksp`.
    - Creates and joins sign-in and sign-out links using `fd_topob_link`, `fd_wksp_alloc_laddr`, `fd_mcache_new`, `fd_mcache_join`, `fd_dcache_new`, and `fd_dcache_join`.
    - Verifies the creation of links with `FD_TEST`.
    - Allocates memory for keyswitch and verifies it with `FD_TEST`.
    - Sets up keyswitch object in the topology with `fd_topob_obj` and updates its offset and workspace.
    - Initializes a scratch context and allocates memory for `fd_pack_ctx_t`.
    - Copies various program addresses and authority addresses into the tile's pack bundle.
    - Sets `tile->pack.bundle.commission_bps` and `tile->pack.schedule_strategy` to 0.
    - Copies validator vote and identity public keys into the context's crank structure.
    - Enables the tile's pack bundle by setting `tile->pack.bundle.enabled` to 1.
- **Output**: No return value; the function operates by modifying the `tile` and `topo` structures in place.


---
### pack\_reset<!-- {{#callable:pack_reset}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L998>)

Resets the test environment for a pack tile, initializing various parameters and structures based on the provided configuration.
- **Inputs**:
    - ``topo``: Pointer to the topology structure (`fd_topo_t`) that defines the network topology.
    - ``tile``: Pointer to the tile structure (`fd_topo_tile_t`) representing the current tile in the topology.
    - ``test_ctx``: Pointer to the test context structure (`fd_tile_test_ctx_t`) that holds local test variables and state.
    - ``ctx``: Pointer to the pack context structure (`fd_pack_ctx_t`) that holds the state and configuration for the pack tile.
    - ``txn_per_bundle``: Unsigned long integer specifying the number of transactions per bundle.
    - ``stress_test_target``: Unsigned long integer specifying the target number of transactions for stress testing.
- **Logic and Control Flow**:
    - Initialize `locals` from `test_ctx->locals` to store local test variables.
    - Set `locals->curr_leader_slot` to `ULONG_MAX` and `locals->rebate_ref.ib_result` to `INT_MAX` to reset leader slot and rebate result.
    - If `txn_per_bundle` is non-zero, set `locals->bundle_id` to 1, `locals->txn_per_bundle` to `txn_per_bundle`, and enable cranking by setting `locals->crank_enabled` to 1.
    - If `stress_test_target` is non-zero, enable stress testing by setting `locals->is_stress_test` to 1, `locals->stress_test_target` to `stress_test_target`, and `locals->wrap_around` to 1.
    - Join a new transaction reference treap and pool for stress testing, checking if the scratch size is sufficient and logging an error if not.
    - Reset `ctx->bank_current[0]` to `ULONG_MAX` to start with a fresh bank's consumer sequence.
    - Call [`unprivileged_init`](<fd_pack_tile.c.md#after_fragunprivileged_init>) with `topo` and `tile` to reset the pack context.
    - Set `ctx->wait_duration_ticks[i]` to 10 for all indices `i` starting from 1, leaving the first index unchanged.
- **Output**: No return value; the function modifies the state of the provided context and test structures.
- **Functions Called**:
    - [`after_frag::unprivileged_init`](<fd_pack_tile.c.md#after_fragunprivileged_init>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/disco/pack/test_pack_tile.c#L1035>)

Executes a series of unit tests for a tile-based system, including transaction and bundle processing, overrun scenarios, and stress tests.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Initialize the environment using `fd_boot` and set up a random number generator with a seed from the command line.
    - Initialize the tile unit test with default, override, and user topology configuration paths, and register metrics.
    - Set up various test links (`resolv_pack`, `poh_pack`, `bank_pack`, `pack_bank`, `pack_poh`) for input and output operations.
    - Define a `fd_stem_context_t` structure to manage cache and sequence information for the test links.
    - Populate test vectors for transaction processing using `populate_test_vectors`.
    - Run a series of tests including normal transaction I/O, bundle I/O, leader slot switching, bundle and transaction overrun, and stress tests.
    - For each test, reset the environment, configure the test links, and execute the test using `fd_tile_test_run`.
    - After all tests, clean up by deleting the random number generator and halting the system.
- **Output**: Returns 0 upon successful completion of all tests.
- **Functions Called**:
    - [`mock_privileged_init`](<#mock_privileged_init>)
    - [`after_frag::unprivileged_init`](<fd_pack_tile.c.md#after_fragunprivileged_init>)
    - [`pack_reset`](<#pack_reset>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)