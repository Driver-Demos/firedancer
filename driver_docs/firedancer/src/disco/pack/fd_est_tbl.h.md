<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines a data structure for estimating the sliding-window mean and variance of tagged data.

# Purpose
This code defines a C header file that provides a data structure and associated functions for estimating the sliding-window mean and variance of tagged data. The data structure is designed to handle real-valued inputs, where each value is associated with an opaque tag. The primary purpose is to answer queries about the mean and variance of recent data associated with a specific tag. The implementation uses an exponential moving average (EMA) to provide approximate answers, as tags are mapped to a limited number of bins, which can lead to aliasing. This behavior is intentional, allowing the system to return a mean close to the overall mean when querying a new tag.

The header file defines several key components, including the `fd_est_tbl_t` structure, which holds the state of the estimation table, and the `fd_est_tbl_bin_t` structure, which accumulates statistics for each bin. The file also provides functions for creating, joining, leaving, and deleting the estimation table, as well as functions for updating the table with new data and estimating the mean and variance for a given tag. The design ensures that the table is aligned and has a footprint suitable for the specified number of bins, which must be a power of two. The code includes mechanisms to handle memory alignment and footprint calculations, and it uses inline functions to optimize performance.
# Imports and Dependencies

---
- `../../ballet/fd_ballet_base.h`


# Data Structures

---
### fd\_private\_est\_tbl\_bin
- **Type**: ``struct``
- **Members**:
    - ``x``: The numerator of the EMA of the values that have mapped to this bin.
    - ``x2``: The numerator of the EMA of the square of values that have mapped to this bin.
    - ``d``: The denominator for EMA(x), paired with the numerator from above.
    - ``d2``: An additional denominator used in EMA calculations.
- **Description**: Accumulates statistics for a specific bin in an estimation table, using exponential moving averages (EMA) to track the mean and variance of values that map to this bin. The structure includes numerators for the EMA of values and their squares, as well as denominators for these calculations.


---
### fd\_est\_tbl\_bin\_t
- **Type**: ``struct``
- **Members**:
    - ``x``: The numerator of the EMA of the values that have mapped to this bin.
    - ``x2``: The numerator of the EMA of the square of values that have mapped to this bin.
    - ``d``: The denominator for EMA(x), paired with the numerator from above.
    - ``d2``: An additional denominator used in EMA calculations.
- **Description**: Accumulates statistics about tags that map to a specific bin index, using exponential moving averages (EMA) to track the mean and variance of values associated with each bin.


---
### fd\_private\_est\_tbl
- **Type**: ``struct fd_private_est_tbl``
- **Members**:
    - ``magic``: Set to `FD_EST_TBL_MAGIC` to identify the structure.
    - ``bin_cnt_mask``: Determines the number of bins in the table as a power of two.
    - ``ema_coeff``: Decay coefficient used in Exponential Moving Average (EMA) computations, close to 1.0.
    - ``default_val``: Value returned as mean when a query maps to a bin with few values.
    - ``bins``: Array of bins used to store statistics, with size determined by `bin_cnt_mask`.
- **Description**: The `fd_private_est_tbl` structure is used to estimate the sliding-window mean and variance of tagged data. It maps tags to a smaller array of bins, allowing for approximate answers to queries about the mean and variance of recent data with a specific tag. The structure includes fields for configuration and storage of statistical data, with a focus on efficient computation using Exponential Moving Averages.


---
### fd\_est\_tbl\_t
- **Type**: ``struct fd_private_est_tbl``
- **Members**:
    - ``magic``: Set to `FD_EST_TBL_MAGIC` to identify the structure.
    - ``bin_cnt_mask``: Determines the number of bins in the table, which is a power of two.
    - ``ema_coeff``: The decay coefficient used in Exponential Moving Average (EMA) computations.
    - ``default_val``: The default mean value returned when a query maps to a bin with few values.
    - ``bins``: An array of bins used to accumulate statistics about tags that map to this bin index.
- **Description**: Estimates the sliding-window mean and variance of tagged data, where each value is tagged with an opaque tag. The structure provides approximate answers to queries about the mean and variance of recent data with a specific tag. Tags are mapped to an array of bins, which can lead to aliasing, but this behavior is desirable as it allows the structure to return a mean close to the overall mean for new tags. The structure is aligned to 32 bytes and uses an Exponential Moving Average (EMA) for calculations.


# Functions

---
### fd\_est\_tbl\_align<!-- {{#callable:fd_est_tbl_align}} -->
[View Source →](<../../../../../src/disco/pack/fd_est_tbl.h#L68>)

Returns the alignment requirement for a memory region to hold the state of an `fd_est_tbl`.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the constant `FD_EST_TBL_ALIGN`.
- **Output**: The function returns an `ulong` representing the alignment requirement.


---
### fd\_est\_tbl\_footprint<!-- {{#callable:fd_est_tbl_footprint}} -->
[View Source →](<../../../../../src/disco/pack/fd_est_tbl.h#L99>)

Calculates the memory footprint required for an estimation table with a specified number of bins.
- **Inputs**:
    - `bin_cnt`: The number of bins in the estimation table, which must be a power of two and greater than zero.
- **Logic and Control Flow**:
    - Check if `bin_cnt` is zero or not a power of two; if true, return 0UL.
    - Check if `bin_cnt` exceeds the maximum allowable size based on `ULONG_MAX`; if true, return 0UL.
    - Calculate and return the memory footprint as the size of `fd_est_tbl_t` plus the size of `bin_cnt-1` `fd_est_tbl_bin_t` structures.
- **Output**: Returns the calculated memory footprint as an unsigned long integer, or 0UL if the input is invalid.


---
### fd\_est\_tbl\_new<!-- {{#callable:fd_est_tbl_new}} -->
[View Source →](<../../../../../src/disco/pack/fd_est_tbl.h#L105>)

Initializes a memory region as an estimation table for sliding-window mean and variance calculations with specified parameters.
- **Inputs**:
    - `mem`: Pointer to a memory region that will be formatted as an estimation table.
    - `bin_cnt`: Number of bins in the table, must be a power of two and greater than zero.
    - `history`: Window size for the exponential moving average (EMA) calculations, must be positive.
    - `default_val`: Default value to return as mean when a query maps to a bin with very few values.
- **Logic and Control Flow**:
    - Check if `bin_cnt` is zero or not a power of two; return `NULL` if true.
    - Check if `bin_cnt` exceeds the maximum allowable size; return `NULL` if true.
    - Check if `history` is zero; return `NULL` if true.
    - Cast `mem` to `fd_est_tbl_t` and initialize `bin_cnt_mask`, `ema_coeff`, and `default_val`.
    - Set all bins in the table to zero using `fd_memset`.
    - Set the `magic` field to `FD_EST_TBL_MAGIC` to indicate successful initialization.
    - Return the pointer to the initialized table.
- **Output**: Returns a pointer to the initialized estimation table on success, or `NULL` on failure due to invalid inputs.


---
### fd\_est\_tbl\_join<!-- {{#callable:fd_est_tbl_join}} -->
[View Source →](<../../../../../src/disco/pack/fd_est_tbl.h#L129>)

Validates and returns a pointer to a `fd_est_tbl_t` structure if the magic number matches `FD_EST_TBL_MAGIC`, otherwise returns `NULL`.
- **Inputs**:
    - `_tbl`: A pointer to a memory region that is expected to hold a `fd_est_tbl_t` structure.
- **Logic and Control Flow**:
    - Cast `_tbl` to a `fd_est_tbl_t` pointer and assign it to `tbl`.
    - Check if `tbl->magic` is not equal to `FD_EST_TBL_MAGIC`.
    - If the magic number does not match, return `NULL`.
    - If the magic number matches, return the `tbl` pointer.
- **Output**: A pointer to a `fd_est_tbl_t` structure if the magic number is valid, otherwise `NULL`.


---
### fd\_est\_tbl\_leave<!-- {{#callable:fd_est_tbl_leave}} -->
[View Source →](<../../../../../src/disco/pack/fd_est_tbl.h#L135>)

Returns a pointer to the memory region holding the state of the estimation table when leaving the current join.
- **Inputs**:
    - `tbl`: A pointer to the `fd_est_tbl_t` structure representing the estimation table to leave.
- **Logic and Control Flow**:
    - The function takes a pointer to an `fd_est_tbl_t` structure as input.
    - It returns the same pointer cast to a `void *`, indicating the memory region holding the table state.
- **Output**: A `void *` pointer to the memory region holding the table state.


---
### fd\_est\_tbl\_delete<!-- {{#callable:fd_est_tbl_delete}} -->
[View Source →](<../../../../../src/disco/pack/fd_est_tbl.h#L136>)

Unformats the memory region used by an `fd_est_tbl_t` structure and returns the memory to the caller.
- **Inputs**:
    - `tbl`: A pointer to an `fd_est_tbl_t` structure that represents the estimation table to be deleted.
- **Logic and Control Flow**:
    - Check if the `magic` field of `tbl` is not equal to `FD_EST_TBL_MAGIC`; if so, log a warning message indicating 'invalid magic!'.
    - Use `FD_COMPILER_MFENCE()` to ensure memory ordering before and after setting the `magic` field to `0UL`.
    - Set the `magic` field of `tbl` to `0UL` to indicate that the table is no longer valid.
- **Output**: Returns a pointer to the `tbl`, which is now unformatted and ready for reuse or deallocation.


---
### fd\_est\_tbl\_estimate<!-- {{#callable:fd_est_tbl_estimate}} -->
[View Source →](<../../../../../src/disco/pack/fd_est_tbl.h#L151>)

Estimates the mean and variance of data associated with a specific tag from a sliding-window data structure.
- **Inputs**:
    - ``tbl``: A pointer to a constant `fd_est_tbl_t` structure, which contains the bins and configuration for the estimation table.
    - ``tag``: An unsigned long integer representing the tag for which the mean and variance are to be estimated.
    - ``variance_out``: A pointer to a double where the function will store the estimated variance if it is not NULL.
- **Logic and Control Flow**:
    - Calculate the bin index by applying a mask to the `tag` and retrieve the corresponding bin from the `tbl` structure.
    - Check if the bin's `d` value is greater than 0.0 to determine if there is data for the tag.
    - If no data is present (`d <= 0.0`), set `mean` to `tbl->default_val` and `var` to 0.0.
    - If data is present, calculate `mean` as `bin->x / bin->d` and `var` using the formula `(bin->d * bin->x2 - (bin->x*bin->x)) / (bin->d * bin->d - bin->d2)`.
    - Ensure `var` is non-negative by using `fd_double_if` to set it to 0.0 if it is less than or equal to 0.0.
    - If `variance_out` is not NULL, store the calculated `var` in the location pointed to by `variance_out`.
    - Return the calculated `mean`.
- **Output**: Returns a double representing the estimated mean of the data associated with the specified tag.


---
### fd\_est\_tbl\_update<!-- {{#callable:fd_est_tbl_update}} -->
[View Source →](<../../../../../src/disco/pack/fd_est_tbl.h#L170>)

Inserts a new tagged value into the estimation table and updates the exponential moving averages (EMA) for the mean and variance.
- **Inputs**:
    - ``tbl``: A pointer to the `fd_est_tbl_t` structure representing the estimation table.
    - ``tag``: An unsigned long integer used to identify the data's tag.
    - ``value``: An unsigned integer representing the new value to insert into the table.
- **Logic and Control Flow**:
    - Calculate the bin index by applying the bitwise AND operation between `tag` and `tbl->bin_cnt_mask` to find the appropriate bin in the table.
    - If `FD_EST_TBL_ADAPTIVE` is defined, estimate the mean and variance for the given tag using [`fd_est_tbl_estimate`](<#fd_est_tbl_estimate>), then calculate the normalized squared deviation `dev_sq`.
    - Compute the coefficient `C` based on `dev_sq` and the exponential moving average coefficient `tbl->ema_coeff`. If `FD_EST_TBL_ADAPTIVE` is not defined, set `C` to `tbl->ema_coeff`.
    - Update the bin's `x` and `x2` values using the new `value` and the coefficient `C`, ensuring they do not go below `DBL_MIN`.
    - Update the bin's `d` and `d2` values using the coefficient `C`, ensuring they do not go denormal.
- **Output**: None (the function updates the estimation table in place).
- **Functions Called**:
    - [`fd_est_tbl_estimate`](<#fd_est_tbl_estimate>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)