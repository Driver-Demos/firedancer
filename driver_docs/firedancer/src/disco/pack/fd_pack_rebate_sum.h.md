<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines data structures and functions for managing and reporting transaction rebate summaries.

# Purpose
The code is a C header file that defines structures and functions for managing rebate information related to transaction processing. It is part of a larger system that handles transaction scheduling and execution, specifically focusing on optimizing the use of Compute Units (CUs) by accounting for rebates when transactions consume fewer CUs than initially requested. The file defines the `fd_pack_rebate_sum_t` structure, which digests microblocks and produces rebate messages, and the `fd_pack_rebate_t` structure, which summarizes the rebate information.

The header file provides several functions to manage the rebate information. The [`fd_pack_rebate_sum_add_txn`](<#fd_pack_rebate_sum_add_txn>) function adds rebate information from transactions to a pending summary, while [`fd_pack_rebate_sum_report`](<#fd_pack_rebate_sum_report>) generates a rebate report from the current state. The [`fd_pack_rebate_sum_clear`](<#fd_pack_rebate_sum_clear>) function clears any pending rebate information. These functions are designed to be used in conjunction with transaction processing systems, allowing for efficient scheduling and execution by leveraging rebate data. The file also includes static assertions to ensure that certain size constraints are met, which is important for maintaining system stability and performance.
# Imports and Dependencies

---
- `../fd_disco_base.h`
- `fd_microblock.h`


# Data Structures

---
### fd\_pack\_rebate\_entry\_t
- **Type**: ``struct``
- **Members**:
    - ``key``: Holds the account address.
    - ``rebate_cus``: Stores the number of rebate compute units (CUs).
- **Description**: Defines an entry that associates an account address with a specific number of rebate compute units (CUs).


---
### fd\_pack\_rebate\_sum\_private
- **Type**: ``struct``
- **Members**:
    - `total_cost_rebate`: Stores the total cost rebate as an unsigned long integer.
    - `vote_cost_rebate`: Stores the vote cost rebate as an unsigned long integer.
    - `data_bytes_rebate`: Stores the data bytes rebate as an unsigned long integer.
    - `microblock_cnt_rebate`: Stores the microblock count rebate as an unsigned long integer.
    - `ib_result`: Indicates the result of an internal block operation with -1 for failure, 0 for not an internal block, and 1 for success.
    - `writer_cnt`: Stores the count of writers as an unsigned integer.
    - `map`: An array of `fd_pack_rebate_entry_t` with a fixed size of 8192 elements.
    - `inserted`: An array of pointers to `fd_pack_rebate_entry_t` with a capacity defined by `FD_PACK_REBATE_SUM_CAPACITY`.
- **Description**: The `fd_pack_rebate_sum_private` structure is used to manage and summarize rebate information related to microblocks in a transaction processing system. It holds various rebate-related metrics such as total cost, vote cost, data bytes, and microblock count rebates. The structure also tracks the result of internal block operations and the number of writers. It includes a fixed-size array `map` for storing rebate entries and an array `inserted` for pointers to these entries, facilitating efficient rebate management and reporting.


---
### fd\_pack\_rebate\_sum\_t
- **Type**: ``struct``
- **Members**:
    - ``total_cost_rebate``: Stores the total cost rebate value.
    - ``vote_cost_rebate``: Stores the vote cost rebate value.
    - ``data_bytes_rebate``: Stores the data bytes rebate value.
    - ``microblock_cnt_rebate``: Stores the microblock count rebate value.
    - ``ib_result``: Indicates the result of an internal block operation with values -1, 0, or 1.
    - ``writer_cnt``: Stores the count of writers.
    - ``map``: An array of `fd_pack_rebate_entry_t` structures with a fixed size of 8192.
    - ``inserted``: An array of pointers to `fd_pack_rebate_entry_t` with a capacity defined by `FD_PACK_REBATE_SUM_CAPACITY`.
- **Description**: `fd_pack_rebate_sum_t` is a structure that manages rebate information for transactions, including total cost, vote cost, data bytes, and microblock count rebates. It also tracks the result of internal block operations and the number of writers. The structure contains a map of rebate entries and an array of pointers to these entries, which are used to summarize and report rebate data.


---
### fd\_pack\_rebate
- **Type**: ``struct``
- **Members**:
    - `total_cost_rebate`: Stores the total cost rebate value as an unsigned long integer.
    - `vote_cost_rebate`: Stores the vote cost rebate value as an unsigned long integer.
    - `data_bytes_rebate`: Stores the data bytes rebate value as an unsigned long integer.
    - `microblock_cnt_rebate`: Stores the microblock count rebate value as an unsigned long integer.
    - `ib_result`: Indicates the result of an internal block operation with -1 for failure, 0 for not an internal block, and 1 for success.
    - `writer_cnt`: Stores the count of writers as an unsigned integer.
    - `writer_rebates`: An array of `fd_pack_rebate_entry_t` structures, with a size determined by `writer_cnt`, to store writer rebate entries.
- **Description**: The `fd_pack_rebate` structure is used to summarize rebate information related to transactions, including total cost, vote cost, data bytes, and microblock count rebates. It also records the result of an internal block operation and maintains an array of writer rebate entries, which can vary in size up to 1637 entries based on the `writer_cnt` value.


---
### fd\_pack\_rebate\_t
- **Type**: ``struct``
- **Members**:
    - `total_cost_rebate`: Stores the total cost rebate value.
    - `vote_cost_rebate`: Stores the vote cost rebate value.
    - `data_bytes_rebate`: Stores the data bytes rebate value.
    - `microblock_cnt_rebate`: Stores the microblock count rebate value.
    - `ib_result`: Indicates the result of an internal block operation with values -1, 0, or 1.
    - `writer_cnt`: Stores the count of writers.
    - `writer_rebates`: Array of `fd_pack_rebate_entry_t` that holds writer rebate entries, with a size determined by `writer_cnt`.
- **Description**: `fd_pack_rebate_t` is a structure that encapsulates rebate information for transactions, including total cost, vote cost, data bytes, and microblock count rebates. It also includes an internal block result indicator and a count of writers. The `writer_rebates` array holds entries for each writer, with the actual size determined by the `writer_cnt` field, allowing for up to 1637 entries.


# Functions

---
### fd\_pack\_rebate\_sum\_align<!-- {{#callable:fd_pack_rebate_sum_align}} -->
[View Source →](<../../../../../src/disco/pack/fd_pack_rebate_sum.h#L61>)

Returns the alignment requirement of the `fd_pack_rebate_sum_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `alignof` on `fd_pack_rebate_sum_t` to determine its alignment requirement.
    - Returns the result of the `alignof` operation.
- **Output**: The alignment requirement of the `fd_pack_rebate_sum_t` structure as an `ulong`.


---
### fd\_pack\_rebate\_sum\_footprint<!-- {{#callable:fd_pack_rebate_sum_footprint}} -->
[View Source →](<../../../../../src/disco/pack/fd_pack_rebate_sum.h#L62>)

Calculates the memory footprint of the `fd_pack_rebate_sum_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the size of the `fd_pack_rebate_sum_t` structure using the `sizeof` operator.
- **Output**: The function returns an `ulong` representing the size of the `fd_pack_rebate_sum_t` structure.


# Function Declarations (Public API)

---
### fd\_pack\_rebate\_sum\_new<!-- {{#callable_declaration:fd_pack_rebate_sum_new}} -->
[View Source →](<../../../../../src/disco/pack/fd_pack_rebate_sum.h#L66>)

Initializes a rebate summary structure.
- **Description**: Use this function to initialize a `fd_pack_rebate_sum_t` structure at the specified memory location. This function sets all fields of the structure to their initial values, preparing it for use in rebate calculations. Ensure that the memory provided is correctly aligned and has sufficient space to hold a `fd_pack_rebate_sum_t` structure. This function does not allocate memory; it only initializes the provided memory block.
- **Inputs**:
    - `mem`: A pointer to a memory block where the `fd_pack_rebate_sum_t` structure will be initialized. The memory must be aligned according to `fd_pack_rebate_sum_align()` and have a size of at least `fd_pack_rebate_sum_footprint()`. The caller retains ownership of the memory.
- **Output**: Returns the same pointer passed in `mem`, now initialized as a `fd_pack_rebate_sum_t` structure.
- **See Also**: [`fd_pack_rebate_sum_new`](<fd_pack_rebate_sum.c.md#fd_pack_rebate_sum_new>)  (Implementation)


---
### fd\_pack\_rebate\_sum\_add\_txn<!-- {{#callable_declaration:fd_pack_rebate_sum_add_txn}} -->
[View Source →](<../../../../../src/disco/pack/fd_pack_rebate_sum.h#L91>)

Adds rebate information from transactions to the pending summary.
- **Description**: Use this function to add rebate information from a bundle or microblock of transactions to the pending summary. Ensure that the `EXECUTE_SUCCESS` flag and the `bank_cu` field are populated in each transaction before calling this function. The `s` parameter must be a valid local join. Transactions are indexed from `txn[0]` to `txn[txn_cnt-1]`, and each transaction must have the necessary fields set. If a transaction loads writable accounts from address lookup tables, `adtl_writable[i]` must point to the first writable account address loaded. If no accounts are loaded writably or the `SANITIZE_SUCCESS` flag is not set, `adtl_writable[i]` is ignored and can be `NULL`. The `txn_cnt` must be between 0 and `MAX_TXN_PER_MICROBLOCK`, with `txn_cnt==0` being a no-op. The function does not retain any read interest in `txn` or `adtl_writable` after returning.
- **Inputs**:
    - `s`: A pointer to a `fd_pack_rebate_sum_t` structure. Must be a valid local join.
    - `txns`: A pointer to an array of `fd_txn_p_t` structures. Must not be `NULL` if `txn_cnt` is greater than 0.
    - `adtl_writable`: A pointer to an array of pointers to `fd_acct_addr_t`. Can be `NULL` if `txn_cnt` is 0 or if transactions do not load writable accounts from address lookup tables.
    - `txn_cnt`: The number of transactions to process. Must be in the range [0, `MAX_TXN_PER_MICROBLOCK`]. If 0, the function is a no-op.
- **Output**: Returns the number of times `fd_pack_rebate_sum_report` must be called before the next call to this function with a non-zero `txn_cnt`.
- **See Also**: [`fd_pack_rebate_sum_add_txn`](<fd_pack_rebate_sum.c.md#fd_pack_rebate_sum_add_txn>)  (Implementation)


---
### fd\_pack\_rebate\_sum\_report<!-- {{#callable_declaration:fd_pack_rebate_sum_report}} -->
[View Source →](<../../../../../src/disco/pack/fd_pack_rebate_sum.h#L103>)

Generates a rebate report from the current state.
- **Description**: Use this function to create a rebate report based on the current state of rebate information. Ensure that `s` points to a valid local join and `out` points to a memory region with at least `USHORT_MAX` bytes of capacity. This function writes the rebate report to `out` and updates the state of `s` to prepare for subsequent reports. It returns the number of bytes written, which will be between 0 and `USHORT_MAX`. Call this function before adding new transactions with non-zero transaction counts.
- **Inputs**:
    - `s`: A pointer to a `fd_pack_rebate_sum_t` structure representing the current state of rebate information. Must point to a valid local join.
    - `out`: A pointer to a `fd_pack_rebate_t` structure where the rebate report will be written. Must have at least `USHORT_MAX` bytes of capacity.
- **Output**: Returns the number of bytes written to `out`, ranging from 0 to `USHORT_MAX`.
- **See Also**: [`fd_pack_rebate_sum_report`](<fd_pack_rebate_sum.c.md#fd_pack_rebate_sum_report>)  (Implementation)


---
### fd\_pack\_rebate\_sum\_clear<!-- {{#callable_declaration:fd_pack_rebate_sum_clear}} -->
[View Source →](<../../../../../src/disco/pack/fd_pack_rebate_sum.h#L110>)

Clears the state of any pending rebates.
- **Description**: Use this function to reset the state of a `fd_pack_rebate_sum_t` structure, removing all pending rebate information. This function is useful when you need to start a new rebate calculation from a clean state. It requires that the input structure is a valid local join. This operation is faster than performing a sequence of leave, delete, new, and join operations to achieve the same result.
- **Inputs**:
    - `s`: A pointer to a `fd_pack_rebate_sum_t` structure. Must be a valid local join. The function will reset its state, clearing all pending rebate information.
- **Output**: None
- **See Also**: [`fd_pack_rebate_sum_clear`](<fd_pack_rebate_sum.c.md#fd_pack_rebate_sum_clear>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)