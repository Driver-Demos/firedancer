<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for initializing, joining, leaving, deleting, and processing batches with a shredder object.

# Purpose
The code defines a set of functions for managing and processing data structures related to a "shredder" in a C program. The primary purpose of this code is to handle the creation, initialization, and manipulation of `fd_shredder_t` objects, which are used to process data batches into shreds. These shreds are likely used for data encoding and error correction, as indicated by the use of Reed-Solomon encoding and Merkle tree structures. The functions include [`fd_shredder_new`](<#fd_shredder_new>), [`fd_shredder_join`](<#fd_shredder_join>), [`fd_shredder_leave`](<#fd_shredder_leave>), [`fd_shredder_delete`](<#fd_shredder_delete>), [`fd_shredder_skip_batch`](<#fd_shredder_skip_batch>), [`fd_shredder_init_batch`](<#fd_shredder_init_batch>), [`fd_shredder_next_fec_set`](<#fd_shredder_next_fec_set>), and [`fd_shredder_fini_batch`](<#fd_shredder_fini_batch>), each serving specific roles in the lifecycle and operation of a shredder object.

The code provides a narrow functionality focused on the shredder's lifecycle and operations. It includes memory alignment checks, initialization of shredder properties, and the generation of data and parity shreds. The functions also handle the computation of Merkle roots and signatures, which are essential for data integrity and verification. The code is intended to be part of a larger system, as it includes external dependencies and is not a standalone executable. It does not define public APIs or external interfaces directly but rather provides internal functionality for managing shredder objects within the system.
# Imports and Dependencies

---
- `fd_shredder.h`
- `../../ballet/shred/fd_shred.h`


# Functions

---
### fd\_shredder\_new<!-- {{#callable:fd_shredder_new}} -->
[View Source →](<../../../../../src/disco/shred/fd_shredder.c#L4>)

Initializes a new `fd_shredder_t` structure in the provided memory with specified signer and context.
- **Inputs**:
    - `mem`: A pointer to the memory location where the `fd_shredder_t` structure will be initialized.
    - `signer`: A pointer to a function used for signing operations within the shredder.
    - `signer_ctx`: A pointer to the context that will be used by the signer function.
- **Logic and Control Flow**:
    - Check if `mem` is NULL and log a warning if true, then return NULL.
    - Check if `mem` is aligned according to `fd_shredder_align()` and log a warning if not, then return NULL.
    - Cast `mem` to `fd_shredder_t *` and initialize its fields to default values.
    - Set the `signer` and `signer_ctx` fields of the shredder to the provided arguments.
    - Use memory fences to ensure memory operations are completed before setting the `magic` field to `FD_SHREDDER_MAGIC`.
    - Return the initialized shredder as a `void *`.
- **Output**: A pointer to the initialized `fd_shredder_t` structure, or NULL if there is an error.
- **Functions Called**:
    - [`fd_shredder_align`](<fd_shredder.h.md#fd_shredder_align>)


---
### fd\_shredder\_join<!-- {{#callable:fd_shredder_join}} -->
[View Source →](<../../../../../src/disco/shred/fd_shredder.c#L40>)

Validates and returns a pointer to a `fd_shredder_t` structure if the provided memory is correctly aligned and initialized.
- **Inputs**:
    - `mem`: A pointer to the memory location that is expected to contain a `fd_shredder_t` structure.
- **Logic and Control Flow**:
    - Check if `mem` is NULL; if true, log a warning and return NULL.
    - Check if `mem` is aligned according to [`fd_shredder_align`](<fd_shredder.h.md#fd_shredder_align>); if not, log a warning and return NULL.
    - Cast `mem` to a `fd_shredder_t` pointer and store it in `shredder`.
    - Check if `shredder->magic` equals `FD_SHREDDER_MAGIC`; if not, log a warning and return NULL.
    - Return the `shredder` pointer.
- **Output**: A pointer to a `fd_shredder_t` structure if successful, otherwise NULL.
- **Functions Called**:
    - [`fd_shredder_align`](<fd_shredder.h.md#fd_shredder_align>)


---
### fd\_shredder\_leave<!-- {{#callable:fd_shredder_leave}} -->
[View Source →](<../../../../../src/disco/shred/fd_shredder.c#L62>)

Returns the input `fd_shredder_t` pointer cast to a `void` pointer.
- **Inputs**:
    - `shredder`: A pointer to an `fd_shredder_t` structure.
- **Logic and Control Flow**:
    - Casts the `shredder` pointer to a `void` pointer.
    - Returns the casted pointer.
- **Output**: A `void` pointer that is the casted `shredder` pointer.


---
### fd\_shredder\_delete<!-- {{#callable:fd_shredder_delete}} -->
[View Source →](<../../../../../src/disco/shred/fd_shredder.c#L67>)

Validates and deletes a shredder object by resetting its magic number.
- **Inputs**:
    - `mem`: A pointer to the memory location of the shredder object to delete.
- **Logic and Control Flow**:
    - Cast the input `mem` to a `fd_shredder_t` pointer named `shredder`.
    - Check if the `magic` field of `shredder` is not equal to `FD_SHREDDER_MAGIC`.
    - If the `magic` check fails, log a warning with the message 'bad magic' and return `NULL`.
    - If the `magic` check passes, execute a memory fence using `FD_COMPILER_MFENCE()`.
    - Set the `magic` field of `shredder` to `0UL` using `FD_VOLATILE`.
    - Execute another memory fence using `FD_COMPILER_MFENCE()`.
    - Return the `shredder` pointer cast to a `void *`.
- **Output**: Returns a pointer to the deleted shredder object if successful, or `NULL` if the magic number check fails.


---
### fd\_shredder\_skip\_batch<!-- {{#callable:fd_shredder_skip_batch}} -->
[View Source →](<../../../../../src/disco/shred/fd_shredder.c#L84>)

Updates the shredder's data and parity index offsets based on the number of data and parity shreds calculated for a given entry batch size and shred type, and resets offsets if the slot has changed.
- **Inputs**:
    - `shredder`: A pointer to an `fd_shredder_t` structure that maintains the state of the shredder.
    - `entry_batch_sz`: The size of the entry batch, which determines the number of shreds to skip.
    - `slot`: The slot number to compare with the current slot in the shredder.
    - `shred_type`: The type of shred, which affects the calculation of data and parity shreds.
- **Logic and Control Flow**:
    - Check if `entry_batch_sz` is zero; if so, return `NULL`.
    - If the `slot` is different from `shredder->slot`, reset `data_idx_offset` and `parity_idx_offset` to zero.
    - Calculate the number of data shreds using [`fd_shredder_count_data_shreds`](<fd_shredder.h.md#fd_shredder_count_data_shreds>) with `entry_batch_sz` and `shred_type`.
    - Calculate the number of parity shreds using [`fd_shredder_count_parity_shreds`](<fd_shredder.h.md#fd_shredder_count_parity_shreds>) with `entry_batch_sz` and `shred_type`.
    - Increment `shredder->data_idx_offset` by the number of data shreds calculated.
    - Increment `shredder->parity_idx_offset` by the number of parity shreds calculated.
    - Update `shredder->slot` to the new `slot` value.
    - Return the updated `shredder` pointer.
- **Output**: Returns a pointer to the updated `fd_shredder_t` structure, or `NULL` if `entry_batch_sz` is zero.
- **Functions Called**:
    - [`fd_shredder_count_data_shreds`](<fd_shredder.h.md#fd_shredder_count_data_shreds>)
    - [`fd_shredder_count_parity_shreds`](<fd_shredder.h.md#fd_shredder_count_parity_shreds>)


---
### fd\_shredder\_init\_batch<!-- {{#callable:fd_shredder_init_batch}} -->
[View Source →](<../../../../../src/disco/shred/fd_shredder.c#L110>)

Initializes a `fd_shredder_t` structure with a new batch of entries and updates its metadata.
- **Inputs**:
    - `shredder`: A pointer to the `fd_shredder_t` structure to initialize.
    - `entry_batch`: A pointer to the batch of entries to be processed.
    - `entry_batch_sz`: The size of the entry batch in bytes.
    - `slot`: The slot number associated with the entry batch.
    - `metadata`: A pointer to the metadata associated with the entry batch.
- **Logic and Control Flow**:
    - Check if `entry_batch_sz` is zero; if so, return `NULL`.
    - Assign `entry_batch` to `shredder->entry_batch` and `entry_batch_sz` to `shredder->sz`.
    - Set `shredder->offset` to zero.
    - If `slot` is different from `shredder->slot`, reset `shredder->data_idx_offset` and `shredder->parity_idx_offset` to zero.
    - Update `shredder->slot` with the new `slot` value.
    - Copy the contents of `metadata` to `shredder->meta`.
    - Return the pointer to the initialized `shredder`.
- **Output**: Returns a pointer to the initialized `fd_shredder_t` structure, or `NULL` if `entry_batch_sz` is zero.


---
### fd\_shredder\_next\_fec\_set<!-- {{#callable:fd_shredder_next_fec_set}} -->
[View Source →](<../../../../../src/disco/shred/fd_shredder.c#L135>)

Generates the next Forward Error Correction (FEC) set from a shredder, including data and parity shreds, and updates Merkle roots and signatures.
- **Inputs**:
    - `shredder`: A pointer to an `fd_shredder_t` structure that contains the current state and configuration of the shredder.
    - `result`: A pointer to an `fd_fec_set_t` structure where the function will store the generated data and parity shreds.
    - `chained_merkle_root`: A pointer to a buffer where the function can optionally read or update the chained Merkle root.
    - `out_merkle_root`: A pointer to a buffer where the function can optionally store the output Merkle root.
- **Logic and Control Flow**:
    - Check if the shredder's offset equals the entry size; if so, return `NULL` as there is no more data to process.
    - Determine the shred type based on whether the Merkle root is chained and if the block is complete.
    - Calculate the number of data and parity shreds to generate based on the remaining entry bytes and the FEC set payload size.
    - Initialize the Reed-Solomon encoder for parity shred generation.
    - Iterate over the data shreds to set headers, copy payloads, and prepare for parity data generation.
    - Optionally set the chained Merkle root for each data shred if provided.
    - Iterate over the parity shreds to set headers and prepare for parity data generation.
    - Finalize the Reed-Solomon encoding to generate parity data.
    - Initialize and process a batch SHA-256 computation to generate Merkle leaves for data and parity shreds.
    - Commit the Merkle tree and optionally store the root in `out_merkle_root`.
    - Sign the Merkle root and write the signature and Merkle proof to each shred.
    - Update the shredder's offset and index offsets for data and parity shreds.
    - Optionally update the `chained_merkle_root` with the new Merkle root.
- **Output**: Returns a pointer to the `fd_fec_set_t` structure containing the generated data and parity shreds, or `NULL` if no more data is available to process.
- **Functions Called**:
    - [`fd_shredder_count_data_shreds`](<fd_shredder.h.md#fd_shredder_count_data_shreds>)
    - [`fd_shredder_count_parity_shreds`](<fd_shredder.h.md#fd_shredder_count_parity_shreds>)


---
### fd\_shredder\_fini\_batch<!-- {{#callable:fd_shredder_fini_batch}} -->
[View Source →](<../../../../../src/disco/shred/fd_shredder.c#L322>)

Resets the `fd_shredder_t` structure's batch-related fields to their initial state.
- **Inputs**:
    - `shredder`: A pointer to an `fd_shredder_t` structure that needs to be finalized.
- **Logic and Control Flow**:
    - Set the `entry_batch` field of the `shredder` to `NULL`.
    - Set the `sz` field of the `shredder` to `0UL`.
    - Set the `offset` field of the `shredder` to `0UL`.
    - Return the modified `shredder` pointer.
- **Output**: Returns the pointer to the `fd_shredder_t` structure with its batch-related fields reset.



---
Made with ❤️ by [Driver](https://www.driver.ai/)