<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines methods for building and validating FEC sets from received shreds, with memory management.

# Purpose
The `fd_fec_resolver.h` header file defines an interface for managing Forward Error Correction (FEC) sets from received shreds. It is specifically designed for use within a shred tile, as indicated by its location in the `disco/shred` directory. The primary functionality of this code is to build and validate FEC sets, ensuring that data integrity is maintained during transmission. The interface handles the complexities of memory management, particularly the lifetimes of buffers, to avoid unnecessary data copying once an FEC set is complete. This is achieved through a system of freelists that manage memory allocation and reuse, ensuring that memory used for one FEC set is not prematurely reused for another.

The header file provides several key functions and data structures. It includes methods for creating and managing FEC resolvers, such as [`fd_fec_resolver_new`](<#fd_fec_resolver_new>), which initializes a resolver with specific memory alignment and footprint requirements. The file also defines functions for adding shreds to an FEC set ([`fd_fec_resolver_add_shred`](<#fd_fec_resolver_add_shred>)), querying shred data ([`fd_fec_resolver_shred_query`](<#fd_fec_resolver_shred_query>)), and forcing the completion of an FEC set ([`fd_fec_resolver_force_complete`](<#fd_fec_resolver_force_complete>)). Additionally, it includes mechanisms for signing shreds and validating their integrity using Merkle roots. The header file defines several constants and types, such as `fd_fec_resolver_t` and `fd_fec_resolver_spilled_t`, to support these operations. The interface ensures that FEC sets are managed efficiently, with specific guarantees about memory reuse and the handling of completed sets.
# Imports and Dependencies

---
- `../../ballet/shred/fd_fec_set.h`
- `../../ballet/bmtree/fd_bmtree.h`
- `../../ballet/ed25519/fd_ed25519.h`


# Data Structures

---
### fd\_fec\_resolver\_t
- **Type**: ``struct fd_fec_resolver``
- **Description**: `fd_fec_resolver_t` is a typedef for the `struct fd_fec_resolver`, which is an opaque data structure used to manage Forward Error Correction (FEC) sets. It is designed to handle the lifecycle of FEC sets, ensuring that memory is efficiently reused and that completed FEC sets are properly managed. The structure supports operations such as adding shreds, querying shreds, and forcing the completion of FEC sets. It uses a freelist mechanism to manage memory and ensure that completed FEC sets are not prematurely reused, adhering to specific depth constraints for memory reuse.


---
### fd\_fec\_resolver\_spilled
- **Type**: ``struct``
- **Members**:
    - `slot`: Stores the slot number associated with the FEC set.
    - `fec_set_idx`: Holds the index of the FEC set.
    - `max_dshred_idx`: Indicates the position in the FEC set, within the range [0, FD_REEDSOL_DATA_SHREDS_MAX).
- **Description**: Represents metadata for a spilled FEC set, including its slot, index, and the maximum data shred index received so far.


---
### fd\_fec\_resolver\_spilled\_t
- **Type**: ``struct``
- **Members**:
    - ``slot``: Holds the slot number associated with the spilled FEC set.
    - ``fec_set_idx``: Stores the index of the FEC set within the resolver.
    - ``max_dshred_idx``: Indicates the highest data shred index received in the FEC set, within the range [0, `FD_REEDSOL_DATA_SHREDS_MAX`).
- **Description**: The `fd_fec_resolver_spilled_t` structure is used to store metadata about an FEC set that has been evicted from the current map during the addition of a new shred. It includes information about the slot, the index of the FEC set, and the highest data shred index received so far. This structure helps manage the lifecycle and state of FEC sets within the resolver, particularly when handling incomplete sets that are removed to make room for new ones.


# Function Declarations (Public API)

---
### fd\_fec\_resolver\_footprint<!-- {{#callable_declaration:fd_fec_resolver_footprint}} -->
[View Source →](<../../../../../src/disco/shred/fd_fec_resolver.h#L100>)

Calculates the memory footprint required for an FEC resolver.
- **Description**: Use this function to determine the amount of memory needed to create an FEC set resolver that can manage a specified number of in-progress, partially completed, and completed FEC sets. It also accounts for the memory required to track a certain number of completed FEC sets to avoid duplicates. This function is essential before initializing an FEC resolver to ensure that sufficient memory is allocated. All depth parameters must be positive, and the function returns zero if any parameter is zero or exceeds a safe threshold to prevent overflow.
- **Inputs**:
    - `depth`: Specifies the number of in-progress FEC sets the resolver can handle. Must be a positive value and less than (1UL<<62)-1UL.
    - `partial_depth`: Indicates the minimum number of distinct FEC sets that must be returned before reusing memory for a different FEC set. Must be a positive value.
    - `complete_depth`: Defines the minimum number of completed FEC sets that must be returned before reusing memory for a different FEC set. Must be a positive value.
    - `done_depth`: Specifies the number of completed FEC sets the resolver remembers to recognize duplicates. Must be a positive value and less than (1UL<<62)-1UL.
- **Output**: Returns the required memory footprint in bytes for the FEC resolver, or 0 if any input is invalid.
- **See Also**: [`fd_fec_resolver_footprint`](<fd_fec_resolver.c.md#fd_fec_resolver_footprint>)  (Implementation)


---
### fd\_fec\_resolver\_align<!-- {{#callable_declaration:fd_fec_resolver_align}} -->
[View Source →](<../../../../../src/disco/shred/fd_fec_resolver.h#L112>)

Returns the required memory alignment for an FEC resolver.
- **Description**: Use this function to determine the memory alignment needed for a region to be used as an FEC resolver. This is important to ensure that the memory is correctly aligned for the operations of the FEC resolver. Call this function before allocating memory for an FEC resolver to ensure compatibility.
- **Inputs**: None
- **Output**: The function returns an unsigned long integer representing the required memory alignment in bytes.
- **See Also**: [`fd_fec_resolver_align`](<fd_fec_resolver.c.md#fd_fec_resolver_align>)  (Implementation)


---
### fd\_fec\_resolver\_new<!-- {{#callable_declaration:fd_fec_resolver_new}} -->
[View Source →](<../../../../../src/disco/shred/fd_fec_resolver.h#L136>)

Formats a memory region as a FEC resolver.
- **Description**: Use this function to initialize a memory region as a FEC resolver, which manages FEC sets for processing shreds. Ensure the memory region (`shmem`) has the required alignment and footprint before calling. The function requires several parameters to define the behavior and constraints of the resolver, such as the number of FEC sets in progress, and the conditions under which memory is reused. It returns the `shmem` pointer on success, allowing further operations on the resolver, or `NULL` on failure, logging details of the failure.
- **Inputs**:
    - `shmem`: Pointer to a memory region to format as a FEC resolver. Must have the required alignment and footprint. Caller retains ownership.
    - `signer`: Function pointer for signing shreds requiring retransmitter signatures. Can be `NULL`, in which case signatures are zeroed.
    - `sign_ctx`: Opaque pointer passed as the first argument to `signer`. Ignored if `signer` is `NULL`.
    - `depth`: Number of in-progress FEC sets the resolver can track. Must be positive and less than `(1UL<<62)-1UL`.
    - `partial_depth`: Minimum number of distinct FEC sets before memory reuse. Must be positive.
    - `complete_depth`: Minimum number of completed FEC sets before memory reuse. Must be positive.
    - `done_depth`: Number of FEC sets remembered to recognize duplicates. Must be positive and less than `(1UL<<62)-1UL`.
    - `sets`: Pointer to the first of `depth+partial_depth+complete_depth` FEC sets. The resolver takes ownership and retains write interest until deletion.
    - `max_shred_idx`: Maximum number of data or parity shreds in a block. Must be non-zero and not exceed `UINT_MAX`.
- **Output**: Returns the `shmem` pointer on success, or `NULL` on failure.
- **See Also**: [`fd_fec_resolver_new`](<fd_fec_resolver.c.md#fd_fec_resolver_new>)  (Implementation)


---
### fd\_fec\_resolver\_join<!-- {{#callable_declaration:fd_fec_resolver_join}} -->
[View Source →](<../../../../../src/disco/shred/fd_fec_resolver.h#L147>)

Joins a shared memory region as an FEC resolver.
- **Description**: Use this function to join a shared memory region that has been formatted as an FEC resolver. This operation is necessary before performing any FEC resolver operations on the memory. Ensure that the memory region is correctly formatted and aligned as an FEC resolver before calling this function. The function returns a pointer to the FEC resolver on success or NULL if the operation fails.
- **Inputs**:
    - `shmem`: A pointer to a shared memory region that must be formatted and aligned as an FEC resolver. The caller retains ownership of the memory. If the memory is not correctly formatted or aligned, the function returns NULL.
- **Output**: Returns a pointer to the FEC resolver on success, or NULL if the operation fails.
- **See Also**: [`fd_fec_resolver_join`](<fd_fec_resolver.c.md#fd_fec_resolver_join>)  (Implementation)


---
### fd\_fec\_resolver\_set\_shred\_version<!-- {{#callable_declaration:fd_fec_resolver_set_shred_version}} -->
[View Source →](<../../../../../src/disco/shred/fd_fec_resolver.h#L149>)

Sets the expected shred version for the FEC resolver.
- **Description**: Use this function to specify the expected shred version for a Forward Error Correction (FEC) resolver. This is necessary to ensure that the resolver only processes shreds with the correct version, which helps maintain data integrity. Call this function whenever the expected shred version changes, and before processing any shreds with the resolver. The function does not perform any validation on the shred version, so ensure that the provided version is correct and non-zero.
- **Inputs**:
    - `resolver`: A pointer to an `fd_fec_resolver_t` structure. Must not be null. The caller retains ownership.
    - `expected_shred_version`: An unsigned short representing the expected shred version. Must be non-zero.
- **Output**: None
- **See Also**: [`fd_fec_resolver_set_shred_version`](<fd_fec_resolver.c.md#fd_fec_resolver_set_shred_version>)  (Implementation)


---
### fd\_fec\_resolver\_add\_shred<!-- {{#callable_declaration:fd_fec_resolver_add_shred}} -->
[View Source →](<../../../../../src/disco/shred/fd_fec_resolver.h#L217>)

Notifies the FEC resolver of a newly received shred.
- **Description**: Use this function to add a new shred to the FEC resolver for processing. The function validates the shred and stores it internally. It must be called with a valid resolver and shred. If the shred is valid and completes an FEC set, the function returns a status indicating completion. The function also handles duplicate shreds and can evict incomplete FEC sets if necessary. Ensure that the resolver is properly initialized before calling this function.
- **Inputs**:
    - `resolver`: A pointer to an initialized `fd_fec_resolver_t` structure. Must not be null.
    - `shred`: A pointer to the shred to be added. Must not be null and should point to a valid shred structure.
    - `shred_sz`: The size of the shred in bytes. Must be at least the size of the shred structure.
    - `leader_pubkey`: A pointer to the leader's public key used for signature verification. Must not be null.
    - `out_fec_set`: A pointer to a location where the function will store a pointer to the FEC set if the shred is valid. Must not be null.
    - `out_shred`: A pointer to a location where the function will store a pointer to the copied shred if the shred is valid. Must not be null.
    - `out_merkle_root`: A pointer to a `fd_bmtree_node_t` where the function will store the Merkle root if the shred is valid. Can be null if the Merkle root is not needed.
    - `out_spilled_fec_set`: A pointer to a `fd_fec_resolver_spilled_t` where the function will store metadata of an evicted FEC set if one is evicted. Can be null if eviction metadata is not needed.
- **Output**: Returns an integer status code: `FD_FEC_RESOLVER_SHRED_OKAY` if the shred is valid and added successfully, `FD_FEC_RESOLVER_SHRED_COMPLETES` if the shred completes an FEC set, `FD_FEC_RESOLVER_SHRED_IGNORED` if the shred is a duplicate, and `FD_FEC_RESOLVER_SHRED_REJECTED` if the shred is invalid. On success, writes to `out_fec_set`, `out_shred`, and optionally `out_merkle_root`. Writes to `out_spilled_fec_set` if an FEC set is evicted.
- **See Also**: [`fd_fec_resolver_add_shred`](<fd_fec_resolver.c.md#fd_fec_resolver_add_shred>)  (Implementation)


---
### fd\_fec\_resolver\_done\_contains<!-- {{#callable_declaration:fd_fec_resolver_done_contains}} -->
[View Source →](<../../../../../src/disco/shred/fd_fec_resolver.h#L231>)

Checks if a completed FEC set with a given signature exists.
- **Description**: Use this function to determine if a Forward Error Correction (FEC) set, identified by a specific signature, has been completed and is present in the resolver's done map. This function is useful for verifying the completion status of FEC sets. It returns a boolean-like integer indicating presence or absence. Ensure that the resolver is properly initialized and that the signature is valid before calling this function.
- **Inputs**:
    - `resolver`: A pointer to an `fd_fec_resolver_t` structure. This must be a valid and initialized FEC resolver instance. The caller retains ownership.
    - `signature`: A pointer to a constant `fd_ed25519_sig_t` structure representing the signature of the FEC set. This must not be null and should point to a valid signature. The function will return 0 if the signature is invalid.
- **Output**: Returns 1 if the FEC set with the given signature is completed and present in the done map, otherwise returns 0.
- **See Also**: [`fd_fec_resolver_done_contains`](<fd_fec_resolver.c.md#fd_fec_resolver_done_contains>)  (Implementation)


---
### fd\_fec\_resolver\_shred\_query<!-- {{#callable_declaration:fd_fec_resolver_shred_query}} -->
[View Source →](<../../../../../src/disco/shred/fd_fec_resolver.h#L253>)

Retrieve a data shred from an FEC set.
- **Description**: Use this function to obtain a specific data shred from an FEC set identified by a signature and index. It is important to ensure that the FEC set is currently in progress and resides in the current map of the resolver. The function does not validate the bounds of the shred index or check if the shred has been received, so the caller must ensure the index is valid and the shred exists. This function is primarily intended for use with the force completion API, which requires the last shred in an FEC set.
- **Inputs**:
    - `resolver`: A pointer to an `fd_fec_resolver_t` structure representing the FEC resolver. Must not be null.
    - `signature`: A pointer to a constant `fd_ed25519_sig_t` structure representing the signature of the FEC set. Must not be null.
    - `shred_idx`: An unsigned integer representing the index of the shred within the FEC set. Must be within the valid range for the FEC set.
    - `out_shred`: A pointer to a memory region where the function will copy the data shred. Must not be null and must have space for at least `FD_SHRED_MIN_SZ` bytes.
- **Output**: Returns `FD_FEC_RESOLVER_SHRED_OKAY` if the shred is successfully retrieved and copied to `out_shred`. Returns `FD_FEC_RESOLVER_SHRED_REJECTED` if the FEC set is not in the current map, in which case `out_shred` should be ignored.
- **See Also**: [`fd_fec_resolver_shred_query`](<fd_fec_resolver.c.md#fd_fec_resolver_shred_query>)  (Implementation)


---
### fd\_fec\_resolver\_force\_complete<!-- {{#callable_declaration:fd_fec_resolver_force_complete}} -->
[View Source →](<../../../../../src/disco/shred/fd_fec_resolver.h#L300>)

Forces completion of a partial FEC set in the resolver.
- **Description**: Use this function to complete a Forward Error Correction (FEC) set when all data shreds are received, but no coding shreds are available. This function is useful in scenarios where the Repair protocol cannot request coding shreds. It should be called only when the caller is certain that the provided shred is the last one in the FEC set. The function performs minimal validation, ensuring only that the data shreds are consistent. If the FEC set is invalid, it is discarded, and the function returns an error. The function does not modify the FEC set if it is already complete.
- **Inputs**:
    - `resolver`: A pointer to an `fd_fec_resolver_t` structure. Must not be null. Represents the FEC resolver instance.
    - `last_shred`: A pointer to a `fd_shred_t` structure representing the last shred in the FEC set. Must not be null. The shred must be valid and consistent with the FEC set.
    - `out_fec_set`: A pointer to a location where a pointer to the complete `fd_fec_set_t` will be stored on success. Must not be null.
    - `out_merkle_root`: A pointer to an `fd_bmtree_node_t` where the Merkle root of the FEC set will be copied on success. Can be null, in which case the Merkle root is not written.
- **Output**: Returns `FD_FEC_RESOLVER_SHRED_COMPLETES` on successful completion, `FD_FEC_RESOLVER_SHRED_IGNORED` if the FEC set is already complete, or `FD_FEC_RESOLVER_SHRED_REJECTED` if the shred is invalid or the FEC set does not validate.
- **See Also**: [`fd_fec_resolver_force_complete`](<fd_fec_resolver.c.md#fd_fec_resolver_force_complete>)  (Implementation)


---
### fd\_fec\_resolver\_leave<!-- {{#callable_declaration:fd_fec_resolver_leave}} -->
[View Source →](<../../../../../src/disco/shred/fd_fec_resolver.h#L306>)

Releases resources associated with an FEC resolver.
- **Description**: Use this function to release resources and clean up an FEC resolver when it is no longer needed. This function should be called after all operations on the resolver are complete. It ensures that all internal structures are properly finalized and that any allocated resources are released. The function returns a pointer to the resolver, which can be used for further management or deallocation by the caller.
- **Inputs**:
    - `resolver`: A pointer to an `fd_fec_resolver_t` structure. Must not be null. The function assumes that the resolver is valid and has been previously initialized.
- **Output**: Returns a pointer to the `resolver` that was passed in, allowing the caller to manage or deallocate it as needed.
- **See Also**: [`fd_fec_resolver_leave`](<fd_fec_resolver.c.md#fd_fec_resolver_leave>)  (Implementation)


---
### fd\_fec\_resolver\_delete<!-- {{#callable_declaration:fd_fec_resolver_delete}} -->
[View Source →](<../../../../../src/disco/shred/fd_fec_resolver.h#L307>)

Deletes an FEC resolver and releases its resources.
- **Description**: Use this function to delete an FEC resolver and release the resources associated with it. This function should be called when the FEC resolver is no longer needed, ensuring that all allocated resources are properly freed. The input memory region must have been previously formatted as an FEC resolver using the appropriate initialization function. This function returns the same memory pointer that was passed to it, allowing for potential reuse or deallocation by the caller.
- **Inputs**:
    - `shmem`: A pointer to a memory region that was previously formatted as an FEC resolver. The memory must be valid and properly aligned. Passing a null or invalid pointer results in undefined behavior.
- **Output**: Returns the same pointer passed as input, allowing the caller to reuse or deallocate the memory.
- **See Also**: [`fd_fec_resolver_delete`](<fd_fec_resolver.c.md#fd_fec_resolver_delete>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)