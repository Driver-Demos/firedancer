<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for managing and computing shred destinations using public keys and random sampling.

# Purpose
The code is a C module that manages the distribution of "shreds" in a network, specifically for a blockchain system like Solana. It defines structures and functions to compute destinations for shreds, which are small pieces of data that need to be distributed across validators in the network. The module includes functionality for both staked and unstaked validators, using a weighted sampling method for staked validators and a random sampling method for unstaked validators. The code also handles the initialization, joining, and deletion of shred destination structures, ensuring that memory is properly allocated and aligned.

Key components include the [`fd_shred_dest_new`](<#fd_shred_dest_new>) function, which initializes a new shred destination structure, and the [`fd_shred_dest_compute_first`](<#fd_shred_dest_compute_first>) and [`fd_shred_dest_compute_children`](<#fd_shred_dest_compute_children>) functions, which determine the initial and subsequent destinations for shreds. The module uses a hash-based approach to compute seeds for random number generation, which is crucial for the random sampling of validators. The code also includes utility functions for managing a map of public keys to indices, which helps in efficiently querying and inserting validator information. Overall, the module provides a specialized set of functions for managing shred distribution in a blockchain network, focusing on efficient and secure data dissemination.
# Imports and Dependencies

---
- `fd_shred_dest.h`
- `../../util/tmpl/fd_map_dynamic.c`


# Global Variables

---
### null\_pubkey
- **Type**: ``fd_pubkey_t``
- **Description**: A constant variable of type `fd_pubkey_t` initialized with all zero values. It is defined as a static constant, meaning it is limited to the file scope and cannot be modified.
- **Use**: Used as a null or invalid key representation in the map operations.


# Data Structures

---
### pubkey\_to\_idx
- **Type**: ``struct``
- **Members**:
    - ``key``: Holds a public key of type `fd_pubkey_t`.
    - ``idx``: Stores an index of type `ulong`.
- **Description**: Associates a public key with an index, allowing for efficient lookup and mapping of public keys to their corresponding indices in a data structure.


---
### pubkey\_to\_idx\_t
- **Type**: ``struct``
- **Members**:
    - ``key``: Holds a public key of type `fd_pubkey_t`.
    - ``idx``: Stores an index of type `ulong`.
- **Description**: Associates a public key with an index, allowing for efficient lookup and mapping of public keys to their corresponding indices in a data structure.


---
### shred\_dest\_input
- **Type**: ``struct``
- **Members**:
    - ``slot``: An `ulong` representing the slot number.
    - ``type``: An `uchar` indicating the type of shred, with specific bit patterns for data and code.
    - ``idx``: An `uint` representing the index of the shred.
    - ``leader_pubkey``: An array of 32 `uchar` representing the leader's public key.
- **Description**: A packed structure used to compute the seed for Chacha20, which determines shred destinations. It contains a slot number, a type identifier for the shred, an index, and the leader's public key.


---
### shred\_dest\_input\_t
- **Type**: ``struct``
- **Members**:
    - ``slot``: An `ulong` representing the slot number.
    - ``type``: An `uchar` indicating the type of shred, with specific bit patterns for data and code.
    - ``idx``: A `uint` representing the index of the shred.
    - ``leader_pubkey``: An array of 32 `uchar` representing the leader's public key.
- **Description**: A packed structure used to compute the seed for Chacha20, which determines shred destinations. It contains fields for the slot number, shred type, shred index, and the leader's public key, all of which are used in the hashing process to generate unique seeds for shred distribution.


# Functions

---
### fd\_shred\_dest\_footprint<!-- {{#callable:fd_shred_dest_footprint}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_dest.c#L34>)

Calculates the memory footprint required for a shred destination structure based on the number of staked and unstaked validators.
- **Inputs**:
    - `staked_cnt`: The number of staked validators.
    - `unstaked_cnt`: The number of unstaked validators.
- **Logic and Control Flow**:
    - Calculate the total count of validators by adding `staked_cnt` and `unstaked_cnt`.
    - Determine the largest power of two greater than or equal to twice the maximum of the total count and 1, and find its most significant bit position using `fd_ulong_find_msb`.
    - Initialize a layout with `FD_LAYOUT_INIT` and append various components to it, including alignments and footprints for `fd_shred_dest_t`, `pubkey_to_idx`, `fd_shred_dest_weighted_t`, `fd_wsample`, and `ulong` arrays.
    - Finalize the layout with `FD_LAYOUT_FINI` and return the total memory footprint.
- **Output**: Returns the total memory footprint as an unsigned long integer.
- **Functions Called**:
    - [`fd_shred_dest_align`](<fd_shred_dest.h.md#fd_shred_dest_align>)


---
### fd\_shred\_dest\_new<!-- {{#callable:fd_shred_dest_new}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_dest.c#L49>)

Initializes a new `fd_shred_dest_t` structure with given parameters and memory allocation.
- **Inputs**:
    - ``mem``: Pointer to the memory where the `fd_shred_dest_t` structure will be initialized.
    - ``info``: Pointer to an array of `fd_shred_dest_weighted_t` structures containing information about validators.
    - ``cnt``: Number of elements in the `info` array.
    - ``lsched``: Pointer to the `fd_epoch_leaders_t` structure representing the leader schedule.
    - ``source``: Pointer to the `fd_pubkey_t` structure representing the source public key.
    - ``excluded_stake``: Amount of stake to exclude from the staked nodes.
- **Logic and Control Flow**:
    - Check if `mem` is NULL or misaligned; log a warning and return NULL if true.
    - Calculate `lg_cnt` as the most significant bit of the smallest power of two greater than or equal to twice the maximum of `cnt` and 1.
    - Initialize scratch memory allocation with `footprint` and allocate memory for `fd_shred_dest_t`, `_map`, and `_info`.
    - Copy `info` array to `_info` and count staked and unstaked nodes, ensuring `info` is sorted properly; log a warning and return NULL if not.
    - Check if `excluded_stake` is greater than zero and there are unstaked nodes; log a warning and return NULL if true.
    - Allocate memory for `_wsample` and `_unstaked` based on staked and unstaked counts.
    - Initialize a ChaCha RNG and a weighted sample for staked nodes, adding stakes from `info` and finalizing with `excluded_stake`.
    - Create and populate a `pubkey_to_idx_map` with public keys from `info`, skipping duplicates.
    - Query the `pubkey_to_idx_map` for the `source` public key; log a warning and return NULL if not found.
    - Initialize `sdest` fields with the allocated and computed values.
    - Return the pointer to the initialized `fd_shred_dest_t` structure.
- **Output**: Returns a pointer to the initialized `fd_shred_dest_t` structure or NULL if an error occurs.
- **Functions Called**:
    - [`fd_shred_dest_align`](<fd_shred_dest.h.md#fd_shred_dest_align>)


---
### fd\_shred\_dest\_join<!-- {{#callable:fd_shred_dest_join}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_dest.c#L141>)

Casts a memory pointer to a `fd_shred_dest_t` pointer.
- **Inputs**:
    - `mem`: A pointer to memory that will be cast to a `fd_shred_dest_t` pointer.
- **Logic and Control Flow**:
    - Casts the input `mem` pointer to a `fd_shred_dest_t` pointer.
    - Returns the casted pointer.
- **Output**: A pointer of type `fd_shred_dest_t` cast from the input `mem`.


---
### fd\_shred\_dest\_leave<!-- {{#callable:fd_shred_dest_leave}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_dest.c#L142>)

Returns the input `fd_shred_dest_t` pointer cast to a `void` pointer.
- **Inputs**:
    - `sdest`: A pointer to an `fd_shred_dest_t` structure.
- **Logic and Control Flow**:
    - Casts the `sdest` pointer to a `void` pointer.
    - Returns the casted pointer.
- **Output**: A `void` pointer that is the casted `sdest` pointer.


---
### fd\_shred\_dest\_delete<!-- {{#callable:fd_shred_dest_delete}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_dest.c#L144>)

Deletes resources associated with a `fd_shred_dest_t` object and returns the memory pointer.
- **Inputs**:
    - `mem`: A pointer to the memory location of a `fd_shred_dest_t` object to delete.
- **Logic and Control Flow**:
    - Cast `mem` to a `fd_shred_dest_t` pointer `sdest`.
    - Call `fd_chacha_rng_leave` on `sdest->rng` and then `fd_chacha_rng_delete` to delete the RNG resource.
    - Call `fd_wsample_leave` on `sdest->staked` and then `fd_wsample_delete` to delete the weighted sample resource.
    - Call `pubkey_to_idx_leave` on `sdest->pubkey_to_idx_map` and then `pubkey_to_idx_delete` to delete the pubkey-to-index map resource.
    - Return the original `mem` pointer.
- **Output**: Returns the original memory pointer `mem` after deleting associated resources.


---
### sample\_unstaked\_noprepare<!-- {{#callable:sample_unstaked_noprepare}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_dest.c#L185>)

Selects a random unstaked validator index from a given range, excluding a specified index if it falls within the range.
- **Inputs**:
    - ``sdest``: A pointer to an `fd_shred_dest_t` structure that contains information about staked and unstaked validators.
    - ``remove_idx``: An unsigned long integer representing the index of the element to potentially remove from the unstaked range.
- **Logic and Control Flow**:
    - Check if `remove_idx` is within the range of unstaked validators by comparing it to `sdest->staked_cnt` and `sdest->staked_cnt + sdest->unstaked_cnt`.
    - Calculate `unstaked_cnt` by subtracting 1 if `remove_idx` is within the unstaked range, otherwise keep it as `sdest->unstaked_cnt`.
    - If `unstaked_cnt` is zero, return `FD_WSAMPLE_EMPTY`.
    - Generate a random sample index within the unstaked range using `fd_chacha20_rng_ulong_roll` and add `sdest->staked_cnt` to it.
    - Return the sample index, adjusting it by adding 1 if it equals `remove_idx` and `remove_idx` is within the unstaked range.
- **Output**: Returns an unsigned long integer representing the index of the selected unstaked validator, or `FD_WSAMPLE_EMPTY` if no valid unstaked validators are available.


---
### prepare\_unstaked\_sampling<!-- {{#callable:prepare_unstaked_sampling}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_dest.c#L201>)

Prepares a list of unstaked validator indices for sampling by removing a specified index if it falls within the unstaked range.
- **Inputs**:
    - ``sdest``: A pointer to an `fd_shred_dest_t` structure that contains information about staked and unstaked validators.
    - ``remove_idx``: An unsigned long integer representing the index of the element to remove from the unstaked list if it falls within the unstaked range.
- **Logic and Control Flow**:
    - Calculate if `remove_idx` is within the unstaked range by checking if it is greater than or equal to `sdest->staked_cnt` and less than `sdest->staked_cnt + sdest->unstaked_cnt`.
    - Determine the new count of unstaked validators by subtracting 1 if `remove_idx` is within the unstaked range, otherwise keep the count unchanged.
    - Set `sdest->unstaked_unremoved_cnt` to the new unstaked count.
    - If the new unstaked count is zero, exit the function early.
    - Calculate the upper limit for direct indexing based on whether `remove_idx` is within the unstaked range.
    - Populate the `sdest->unstaked` array with indices, skipping the `remove_idx` if it is within the unstaked range.
- **Output**: No return value; modifies the `sdest->unstaked` array and `sdest->unstaked_unremoved_cnt` in place.


---
### sample\_unstaked<!-- {{#callable:sample_unstaked}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_dest.c#L218>)

Selects and removes a random unstaked validator from the list in `sdest`.
- **Inputs**:
    - `sdest`: A pointer to an `fd_shred_dest_t` structure that contains the list of unstaked validators and related data.
- **Logic and Control Flow**:
    - Check if `sdest->unstaked_unremoved_cnt` is zero; if true, return `FD_WSAMPLE_EMPTY`.
    - Generate a random index using `fd_chacha20_rng_ulong_roll` with `sdest->rng` and `sdest->unstaked_unremoved_cnt`.
    - Retrieve the validator at the random index from `sdest->unstaked` and store it in `to_return`.
    - Replace the validator at the random index with the last validator in the list, then decrement `sdest->unstaked_unremoved_cnt`.
    - Return the value stored in `to_return`.
- **Output**: Returns the index of the selected unstaked validator, or `FD_WSAMPLE_EMPTY` if no unstaked validators are available.


---
### compute\_seeds<!-- {{#callable:compute_seeds}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_dest.c#L231>)

Computes SHA-256 hash seeds for a batch of shreds to determine their destinations.
- **Inputs**:
    - ``sdest``: A pointer to an `fd_shred_dest_t` structure used for shred destination management.
    - ``input_shreds``: A pointer to an array of pointers to `fd_shred_t` structures representing the input shreds.
    - ``shred_cnt``: The number of shreds in the `input_shreds` array.
    - ``leader``: A pointer to an `fd_pubkey_t` structure representing the leader's public key.
    - ``slot``: The slot number that the shreds belong to.
    - ``dest_hash_output``: A 2D array to store the computed hash outputs for each shred.
- **Logic and Control Flow**:
    - Initialize an array `dest_hash_inputs` to store input data for hash computation.
    - Initialize a SHA-256 batch context using `fd_sha256_batch_init`.
    - Iterate over each shred in `input_shreds` up to `shred_cnt`.
    - For each shred, check if its `slot` matches the given `slot`; if not, return -1.
    - Determine the shred type using `fd_shred_type` and set the `type` field in `dest_hash_inputs` accordingly.
    - Copy the leader's public key into the `leader_pubkey` field of `dest_hash_inputs`.
    - Add the current `dest_hash_inputs` entry to the SHA-256 batch using `fd_sha256_batch_add`.
    - Finalize the SHA-256 batch computation with `fd_sha256_batch_fini`.
    - Return 0 to indicate success.
- **Output**: Returns 0 on success, or -1 if any shred's slot does not match the given slot.


---
### fd\_shred\_dest\_compute\_first<!-- {{#callable:fd_shred_dest_compute_first}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_dest.c#L260>)

Computes the first destination index for each shred in a list of input shreds based on the validator's stake and leader schedule.
- **Inputs**:
    - ``sdest``: A pointer to an `fd_shred_dest_t` structure that contains information about the validator's stake and leader schedule.
    - ``input_shreds``: A pointer to an array of pointers to `fd_shred_t` structures representing the input shreds.
    - ``shred_cnt``: The number of shreds in the `input_shreds` array.
    - ``out``: A pointer to an array where the function will store the computed destination indices for each shred.
- **Logic and Control Flow**:
    - If `shred_cnt` is zero, return `out` immediately.
    - If the validator count in `sdest` is less than or equal to one, set all entries in `out` to `FD_SHRED_DEST_NO_DEST` and return `out`.
    - Retrieve the slot from the first shred and get the leader's public key for that slot using `fd_epoch_leaders_get`. If no leader is found, return `NULL`.
    - Call [`compute_seeds`](<#compute_seeds>) to compute hash outputs for each shred. If it fails, return `NULL`.
    - Check if the source validator is staked. If so, remove its index from the staked list using `fd_wsample_remove_idx`.
    - Determine if there are any staked candidates by checking if the staked count is greater than the source validator's staked status.
    - For each shred, seed the random number generator with the computed hash output and sample a destination index from the staked list or unstaked list, storing the result in `out`.
    - Restore the staked list using `fd_wsample_restore_all`.
- **Output**: Returns a pointer to the `out` array containing the computed destination indices for each shred, or `NULL` if an error occurs.
- **Functions Called**:
    - [`compute_seeds`](<#compute_seeds>)
    - [`sample_unstaked_noprepare`](<#sample_unstaked_noprepare>)


---
### fd\_shred\_dest\_compute\_children<!-- {{#callable:fd_shred_dest_compute_children}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_dest.c#L303>)

Computes the child destinations for shreds based on the source validator's position and the network's staked and unstaked nodes.
- **Inputs**:
    - ``sdest``: Pointer to the `fd_shred_dest_t` structure containing the source validator's information and network state.
    - ``input_shreds``: Array of pointers to `fd_shred_t` structures representing the shreds to process.
    - ``shred_cnt``: Number of shreds in the `input_shreds` array.
    - ``out``: Pointer to an array where the function will store the computed child destinations.
    - ``out_stride``: Stride length for accessing the `out` array.
    - ``fanout``: Maximum number of child nodes a node can have in the Turbine tree.
    - ``dest_cnt``: Number of destinations to compute for each shred.
    - ``opt_max_dest_cnt``: Optional pointer to store the maximum number of destinations computed for any shred.
- **Logic and Control Flow**:
    - Initialize `my_orig_idx` and `i_am_staked` to determine the source validator's original index and staked status.
    - Store zero in `opt_max_dest_cnt` if it is not null.
    - Return `out` immediately if `shred_cnt` or `dest_cnt` is zero.
    - Retrieve the leader's public key for the current slot and check if the leader is staked.
    - Return `NULL` if the leader is unknown or if the source validator is the leader.
    - Return `out` filled with `FD_SHRED_DEST_NO_DEST` if the source validator is at the bottom of the Turbine tree.
    - Compute seeds for the shreds using [`compute_seeds`](<#compute_seeds>) and return `NULL` on failure.
    - Iterate over each shred to compute its child destinations.
    - Remove the leader from the staked nodes if applicable.
    - Determine the source validator's position in the shuffled list of nodes.
    - If the source validator is unstaked, handle the unstaked sampling logic.
    - If the source validator is staked, handle the staked sampling logic.
    - Fill `out` with `FD_SHRED_DEST_NO_DEST` if the source validator is at the bottom of the Turbine tree for a shred.
    - Compute the range of indices to send shreds to based on the source validator's position.
    - Sample and store the destination indices in `out` for each shred.
    - Update `max_dest_cnt` with the maximum number of destinations computed for any shred.
    - Store `max_dest_cnt` in `opt_max_dest_cnt` if it is not null.
    - Return `out` with the computed destinations.
- **Output**: Returns a pointer to the `out` array filled with computed child destinations for each shred, or `NULL` on failure.
- **Functions Called**:
    - [`compute_seeds`](<#compute_seeds>)
    - [`prepare_unstaked_sampling`](<#prepare_unstaked_sampling>)
    - [`sample_unstaked`](<#sample_unstaked>)


---
### fd\_shred\_dest\_pubkey\_to\_idx<!-- {{#callable:fd_shred_dest_pubkey_to_idx}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_dest.c#L477>)

Maps a public key to its corresponding index in the shred destination map.
- **Inputs**:
    - ``sdest``: A pointer to an `fd_shred_dest_t` structure that contains the mapping of public keys to indices.
    - ``pubkey``: A constant pointer to an `fd_pubkey_t` structure representing the public key to be mapped.
- **Logic and Control Flow**:
    - Check if the `pubkey` is equal to `null_pubkey.uc` using `memcmp`; if true, return `FD_SHRED_DEST_NO_DEST`.
    - Initialize a `default_res` array with one element having `idx` set to `FD_SHRED_DEST_NO_DEST`.
    - Call `pubkey_to_idx_query` with `sdest->pubkey_to_idx_map`, `*pubkey`, and `default_res` to find the index of the public key.
    - Return the `idx` from the `query` result cast to `fd_shred_dest_idx_t`.
- **Output**: Returns the index of the public key in the shred destination map, or `FD_SHRED_DEST_NO_DEST` if the public key is not found or is a null public key.



---
Made with ❤️ by [Driver](https://www.driver.ai/)