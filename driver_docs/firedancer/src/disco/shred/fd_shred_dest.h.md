<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines methods and data structures for computing shred destinations using stake weights and Turbine tree logic.

# Purpose
The code is a C header file that defines a set of functions and data structures for managing the distribution of shreds in a network, specifically within the context of a system that uses a Turbine tree logic. The primary purpose of this code is to compute and manage the destinations for shreds based on stake weights, which are used to determine the leader and non-leader nodes in the network. The header file includes several other headers, indicating dependencies on other modules for functionalities such as SHA-256 hashing, random number generation, and leader scheduling.

Key components of the code include the `fd_shred_dest_weighted_t` structure, which holds information about a potential destination for a shred, including the validator's public key, stake, IP address, and port. The `fd_shred_dest_t` structure is used to manage the state and configuration of shred destinations, including both staked and unstaked validators. The code provides functions for initializing and managing these structures, such as [`fd_shred_dest_new`](<#fd_shred_dest_new>), [`fd_shred_dest_join`](<#fd_shred_dest_join>), and [`fd_shred_dest_delete`](<#fd_shred_dest_delete>). It also includes functions for computing the first destination and child destinations in the Turbine tree, such as [`fd_shred_dest_compute_first`](<#fd_shred_dest_compute_first>) and [`fd_shred_dest_compute_children`](<#fd_shred_dest_compute_children>). The header defines constants and types to support these operations, ensuring efficient memory usage and alignment.
# Imports and Dependencies

---
- `../../ballet/shred/fd_shred.h`
- `../../ballet/sha256/fd_sha256.h`
- `../../ballet/wsample/fd_wsample.h`
- `../../flamenco/leaders/fd_leaders.h`


# Data Structures

---
### fd\_shred\_dest\_weighted
- **Type**: ``struct``
- **Members**:
    - ``pubkey``: The validator's identity key.
    - ``stake_lamports``: Stake, measured in lamports, or 0 for an unstaked validator.
    - ``ip4``: The validator's IP address, in network byte order.
    - ``port``: The TVU port, in host byte order.
- **Description**: Defines a destination for a shred, including the validator's identity key, stake in lamports, IP address, and TVU port. The structure is used to specify where a shred might be sent, with information typically sourced from Gossip. Note that the IP address and port are stored in different byte orders.


---
### fd\_shred\_dest\_weighted\_t
- **Type**: ``struct``
- **Members**:
    - ``pubkey``: The validator's identity key.
    - ``stake_lamports``: Stake, measured in lamports, or 0 for an unstaked validator.
    - ``ip4``: The validator's IP address, in network byte order.
    - ``port``: The TVU port, in host byte order.
- **Description**: Specifies a destination to which a shred might be sent, with information typically sourced from Gossip. It includes the validator's identity key, stake in lamports, IP address, and TVU port, with IP and host in different byte orders.


---
### pubkey\_to\_idx\_t
- **Type**: ``struct``
- **Members**:
    - `pubkey_to_idx_map`: Maps a public key to an index within the range [0, staked_cnt+unstaked_cnt).
- **Description**: `pubkey_to_idx_t` is a forward-declared structure used to map public keys to indices, which are used to identify destinations in the context of shred distribution. The structure is part of a system that manages the distribution of shreds to validators based on their public keys and stake information.


---
### fd\_shred\_dest\_private
- **Type**: ``struct fd_shred_dest_private``
- **Members**:
    - ``_sha256_batch``: An array for SHA-256 batch processing, aligned to `FD_SHA256_BATCH_ALIGN`.
    - ``rng``: An array of `fd_chacha_rng_t` for random number generation.
    - ``null_dest``: A `fd_shred_dest_weighted_t` initialized to zero, used when a destination does not exist.
    - ``lsched``: A pointer to `fd_epoch_leaders_t` for leader schedule information.
    - ``cnt``: A count of destinations.
    - ``all_destinations``: A pointer to a local copy of all destinations, located after the struct.
    - ``staked``: A pointer to `fd_wsample_t` for staked destinations.
    - ``unstaked``: A pointer to an array of unstaked destination indices.
    - ``unstaked_unremoved_cnt``: A count of unstaked destinations that have not been removed.
    - ``staked_cnt``: A count of staked destinations.
    - ``unstaked_cnt``: A count of unstaked destinations.
    - ``excluded_stake``: The total stake of excluded validators.
    - ``pubkey_to_idx_map``: A pointer to `pubkey_to_idx_t` mapping public keys to destination indices.
    - ``source_validator_orig_idx``: The original index of the source validator in the range [0, staked_cnt+unstaked_cnt).
- **Description**: `fd_shred_dest_private` is a data structure used to manage and compute destinations for shreds in a distributed system, particularly in the context of Solana's Turbine protocol. It includes fields for managing SHA-256 batch processing, random number generation, and destination information, both staked and unstaked. The structure also maintains mappings from public keys to destination indices and tracks the original index of the source validator. It is aligned to `FD_SHRED_DEST_ALIGN` and is designed to handle both existing and non-existing destinations efficiently.


---
### fd\_shred\_dest\_t
- **Type**: ``struct``
- **Members**:
    - `_sha256_batch`: An array aligned to `FD_SHA256_BATCH_ALIGN` for SHA-256 batch operations.
    - `rng`: An array of `fd_chacha_rng_t` for random number generation.
    - `null_dest`: A `fd_shred_dest_weighted_t` initialized to zeros, used when no destination exists.
    - `lsched`: A pointer to `fd_epoch_leaders_t` containing leader schedule information.
    - `cnt`: The count of destinations.
    - `all_destinations`: A pointer to a local copy of all destinations.
    - `staked`: A pointer to `fd_wsample_t` for staked destinations.
    - `unstaked`: A pointer to an array of unstaked destination indices.
    - `unstaked_unremoved_cnt`: The count of unstaked destinations not removed.
    - `staked_cnt`: The count of staked destinations.
    - `unstaked_cnt`: The count of unstaked destinations.
    - `excluded_stake`: The total stake of excluded validators.
    - `pubkey_to_idx_map`: A pointer to `pubkey_to_idx_t` mapping public keys to destination indices.
    - `source_validator_orig_idx`: The original index of the source validator.
- **Description**: `fd_shred_dest_t` is a data structure used to manage and compute destinations for shreds in a distributed system, specifically within the context of the Solana blockchain's Turbine protocol. It includes fields for managing SHA-256 batch operations, random number generation, and destination information, both staked and unstaked. The structure also maintains mappings from public keys to destination indices and tracks the original index of the source validator. It is aligned to `FD_SHRED_DEST_ALIGN` and is designed to efficiently handle a large number of potential destinations, leveraging indices to minimize memory usage.


# Functions

---
### fd\_shred\_dest\_align<!-- {{#callable:fd_shred_dest_align}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_dest.h#L89>)

Returns the alignment requirement for an `fd_shred_dest_t` object.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the constant `FD_SHRED_DEST_ALIGN`.
- **Output**: The function returns an `ulong` representing the alignment requirement for an `fd_shred_dest_t` object.


---
### fd\_shred\_dest\_cnt\_staked<!-- {{#callable:fd_shred_dest_cnt_staked}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_dest.h#L142>)

Returns the number of staked destinations in a given `fd_shred_dest_t` structure.
- **Inputs**:
    - `sdest`: A pointer to an `fd_shred_dest_t` structure, which contains information about shred destinations.
- **Logic and Control Flow**:
    - Accesses the `staked_cnt` member of the `fd_shred_dest_t` structure pointed to by `sdest`.
    - Returns the value of `staked_cnt`, which represents the number of staked destinations.
- **Output**: The function returns an `ulong` representing the number of staked destinations.


---
### fd\_shred\_dest\_cnt\_unstaked<!-- {{#callable:fd_shred_dest_cnt_unstaked}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_dest.h#L143>)

Returns the count of unstaked destinations in a given `fd_shred_dest_t` structure.
- **Inputs**:
    - `sdest`: A pointer to an `fd_shred_dest_t` structure, which contains information about shred destinations.
- **Logic and Control Flow**:
    - Accesses the `unstaked_cnt` member of the `fd_shred_dest_t` structure pointed to by `sdest`.
    - Returns the value of `unstaked_cnt`.
- **Output**: The function returns an `ulong` representing the number of unstaked destinations.


---
### fd\_shred\_dest\_cnt\_all<!-- {{#callable:fd_shred_dest_cnt_all}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_dest.h#L144>)

Calculates the total number of destinations, both staked and unstaked, for a given shred destination object.
- **Inputs**:
    - `sdest`: A pointer to an `fd_shred_dest_t` structure, which contains information about staked and unstaked destinations.
- **Logic and Control Flow**:
    - Accesses the `staked_cnt` member of the `fd_shred_dest_t` structure to get the count of staked destinations.
    - Accesses the `unstaked_cnt` member of the `fd_shred_dest_t` structure to get the count of unstaked destinations.
    - Adds the values of `staked_cnt` and `unstaked_cnt` to compute the total number of destinations.
- **Output**: Returns the sum of staked and unstaked destination counts as an unsigned long integer.


---
### fd\_shred\_dest\_idx\_to\_dest<!-- {{#callable:fd_shred_dest_idx_to_dest}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_dest.h#L219>)

Maps a destination index to an actual destination or a null destination if the index is invalid.
- **Inputs**:
    - ``sdest``: A pointer to an `fd_shred_dest_t` structure containing destination information.
    - ``idx``: A destination index of type `fd_shred_dest_idx_t` to be mapped to an actual destination.
- **Logic and Control Flow**:
    - Checks if `idx` is not equal to `FD_SHRED_DEST_NO_DEST`.
    - If true, returns a pointer to the destination at `sdest->all_destinations + idx`.
    - If false, returns a pointer to `sdest->null_dest`.
- **Output**: A pointer to an `fd_shred_dest_weighted_t` structure representing the destination.


---
### fd\_shred\_dest\_update\_source<!-- {{#callable:fd_shred_dest_update_source}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_dest.h#L234>)

Updates the source validator index in the shred destination structure.
- **Inputs**:
    - ``sdest``: A pointer to an `fd_shred_dest_t` structure, representing the shred destination.
    - ``idx``: An `fd_shred_dest_idx_t` index representing the new source validator index, which must be within the valid range of [0, staked_cnt+unstaked_cnt).
- **Logic and Control Flow**:
    - Assigns the value of `idx` to the `source_validator_orig_idx` field of the `sdest` structure.
- **Output**: No return value; the function updates the `source_validator_orig_idx` field of the `sdest` structure in place.


# Function Declarations (Public API)

---
### fd\_shred\_dest\_footprint<!-- {{#callable_declaration:fd_shred_dest_footprint}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_dest.h#L90>)

Calculates the memory footprint for a shred destination object.
- **Description**: Use this function to determine the amount of memory required to store a shred destination object, which includes both staked and unstaked destinations. This is necessary before allocating memory for such an object. Ensure that the sum of `staked_cnt` and `unstaked_cnt` does not exceed the maximum allowable count for destinations. The function returns the calculated footprint in bytes.
- **Inputs**:
    - `staked_cnt`: The number of destinations with positive stake. Must be a non-negative integer.
    - `unstaked_cnt`: The number of destinations with zero stake. Must be a non-negative integer.
- **Output**: Returns the memory footprint in bytes required to store the specified number of staked and unstaked destinations.
- **See Also**: [`fd_shred_dest_footprint`](<fd_shred_dest.c.md#fd_shred_dest_footprint>)  (Implementation)


---
### fd\_shred\_dest\_new<!-- {{#callable_declaration:fd_shred_dest_new}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_dest.h#L121>)

Formats memory for use as a shred destination object.
- **Description**: Use this function to prepare a memory region to act as a shred destination object, which is used to compute destinations for shreds based on stake weights. Ensure the memory region is properly aligned and has the required footprint. The `info` array must be sorted by stake and include all staked validators, even those without contact info. The function copies the `info` data and retains a read interest in `lsched`. The `source` must be present in `info`, but it will not be a destination. If `excluded_stake` is greater than zero, `info` must not contain unstaked validators. The function returns the memory pointer on success or NULL on error, logging a warning in case of errors.
- **Inputs**:
    - `mem`: Pointer to the start of a memory region with the required alignment and footprint. Must not be null.
    - `info`: Pointer to an array of `fd_shred_dest_weighted_t` structures, sorted by stake and pubkey. Must include all staked validators.
    - `cnt`: Number of elements in the `info` array. Must be non-negative.
    - `lsched`: Pointer to a local join of an `fd_epoch_leaders_t` object. Must not be null.
    - `source`: Pointer to the public key of the current validator. Must be present in `info`.
    - `excluded_stake`: Sum of stakes for excluded validators. If greater than zero, `info` must not contain unstaked validators.
- **Output**: Returns the pointer to the formatted memory region on success, or NULL on error.
- **See Also**: [`fd_shred_dest_new`](<fd_shred_dest.c.md#fd_shred_dest_new>)  (Implementation)


---
### fd\_shred\_dest\_join<!-- {{#callable_declaration:fd_shred_dest_join}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_dest.h#L132>)

Joins a caller to a memory region formatted as an `fd_shred_dest_t` object.
- **Description**: Use this function to associate a caller with a memory region that has been formatted as an `fd_shred_dest_t` object. This is typically done after the memory has been prepared using `fd_shred_dest_new`. Ensure that the memory region is correctly formatted and aligned before calling this function. This function does not perform any validation on the memory region, so incorrect usage may lead to undefined behavior.
- **Inputs**:
    - `mem`: A pointer to a memory region that is expected to be formatted as an `fd_shred_dest_t` object. The caller must ensure that this memory is correctly formatted and aligned. Passing a null pointer or incorrectly formatted memory will result in undefined behavior.
- **Output**: Returns a pointer to an `fd_shred_dest_t` object, which allows the caller to interact with the shred destination data.
- **See Also**: [`fd_shred_dest_join`](<fd_shred_dest.c.md#fd_shred_dest_join>)  (Implementation)


---
### fd\_shred\_dest\_leave<!-- {{#callable_declaration:fd_shred_dest_leave}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_dest.h#L133>)

Leaves a shred destination context.
- **Description**: Use this function to leave a shred destination context that was previously joined. This function is typically called after operations on the shred destination context are complete. Ensure that the context is valid and was previously joined before calling this function. This function does not perform any operations on the context other than returning it as a void pointer.
- **Inputs**:
    - `sdest`: A pointer to a `fd_shred_dest_t` structure representing the shred destination context. Must not be null and should be a valid context that was previously joined.
- **Output**: Returns a void pointer to the `fd_shred_dest_t` structure passed as input.
- **See Also**: [`fd_shred_dest_leave`](<fd_shred_dest.c.md#fd_shred_dest_leave>)  (Implementation)


---
### fd\_shred\_dest\_delete<!-- {{#callable_declaration:fd_shred_dest_delete}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_dest.h#L134>)

Unformats a region of memory previously formatted as an `fd_shred_dest_t` object.
- **Description**: Use this function to unformat a memory region that was previously formatted as an `fd_shred_dest_t` object. This function should be called when the memory is no longer needed in its current format, effectively cleaning up resources associated with the `fd_shred_dest_t` object. Ensure that the memory region was properly formatted before calling this function to avoid undefined behavior.
- **Inputs**:
    - `mem`: A pointer to the memory region to unformat. Must not be null and should point to a valid `fd_shred_dest_t` object.
- **Output**: Returns the original pointer `mem` after unformatting the memory region.
- **See Also**: [`fd_shred_dest_delete`](<fd_shred_dest.c.md#fd_shred_dest_delete>)  (Implementation)


---
### fd\_shred\_dest\_compute\_first<!-- {{#callable_declaration:fd_shred_dest_compute_first}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_dest.h#L160>)

Computes the root destination for each shred in the Turbine tree.
- **Description**: Use this function to determine the initial destination for each shred in a set, based on the Turbine tree logic. This function should be called only when the source validator is the leader for the slot from which the shreds originate. All shreds must belong to the same slot, and the leader for that slot must be known. The function requires a valid `fd_shred_dest_t` object and an array of shreds. It returns the destination indices for each shred in the provided output array. If `shred_cnt` is zero, the function performs no operation and returns the output array. The function returns `NULL` if it encounters an error, such as an unknown leader or a failure in seed computation.
- **Inputs**:
    - `sdest`: A pointer to an `fd_shred_dest_t` object that contains the destination information. It must be properly initialized and must not be null.
    - `input_shreds`: A pointer to an array of pointers to `fd_shred_t` objects, representing the shreds for which destinations are to be computed. All shreds must be from the same slot. This parameter can be null if `shred_cnt` is zero.
    - `shred_cnt`: The number of shreds in the `input_shreds` array. It must be between 0 and 67 inclusive. If zero, the function does nothing.
    - `out`: A pointer to an array where the computed destination indices will be stored. The array must have at least `shred_cnt` elements.
- **Output**: Returns a pointer to the `out` array on success, or `NULL` on failure.
- **See Also**: [`fd_shred_dest_compute_first`](<fd_shred_dest.c.md#fd_shred_dest_compute_first>)  (Implementation)


---
### fd\_shred\_dest\_compute\_children<!-- {{#callable_declaration:fd_shred_dest_compute_children}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_dest.h#L200>)

Computes the children destinations for each shred in the Turbine tree.
- **Description**: Use this function to determine the child validators to which the source validator should send each shred directly in a Turbine tree. All shreds must originate from the same slot, and the leader for that slot must be known. The function writes exactly `dest_cnt` destination indices for each shred, padding with `FD_SHRED_DEST_NO_DEST` if necessary. The typical use case is to set `dest_cnt` equal to `fanout`. The results are stored in `out`, with `out_stride` specifying the number of elements in each logical row. If `opt_max_dest_cnt` is provided, it will store the maximum number of real destinations for any shred, which is always less than or equal to `dest_cnt`. The function returns `out` on success and `NULL` on failure.
- **Inputs**:
    - `sdest`: Pointer to an `fd_shred_dest_t` structure representing the source validator's destination information. Must be a valid local join.
    - `input_shreds`: Array of pointers to `fd_shred_t` structures representing the shreds to process. All shreds must be from the same slot. Accessed as `input_shreds[i]` for `i` in `[0, shred_cnt)`.
    - `shred_cnt`: Number of shreds to process. Must be in the range `[0, 67]`.
    - `out`: Pointer to an array where the destination indices will be stored. The array must have enough space to hold `dest_cnt` indices for each shred.
    - `out_stride`: Number of elements in each logical row of the output array. Must be at least `shred_cnt`.
    - `fanout`: Specifies the fanout of the Turbine tree. Determines the number of child destinations for each shred.
    - `dest_cnt`: Number of destination indices to compute for each shred. Typically set to `fanout`.
    - `opt_max_dest_cnt`: Optional pointer to a `ulong` where the maximum number of real destinations for any shred will be stored. Can be `NULL` if not needed.
- **Output**: Returns `out` on success and `NULL` on failure. Writes destination indices to `out`, with padding if necessary.
- **See Also**: [`fd_shred_dest_compute_children`](<fd_shred_dest.c.md#fd_shred_dest_compute_children>)  (Implementation)


---
### fd\_shred\_dest\_pubkey\_to\_idx<!-- {{#callable_declaration:fd_shred_dest_pubkey_to_idx}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_dest.h#L227>)

Maps a public key to a destination index.
- **Description**: Use this function to find the destination index for a given public key within a shred destination object. This function is useful when you need to determine if a public key is recognized as a destination. If the public key is not known, the function returns a special value indicating no destination. Ensure that the shred destination object is properly initialized before calling this function.
- **Inputs**:
    - `sdest`: A pointer to an `fd_shred_dest_t` object. This must be a valid and initialized shred destination object. The caller retains ownership.
    - `pubkey`: A pointer to a constant `fd_pubkey_t` representing the public key to map. This must not be null. If the public key is all zeros, the function returns a special value indicating no destination.
- **Output**: Returns an `fd_shred_dest_idx_t` which is the index of the destination if the public key is known. If the public key is not known, returns `FD_SHRED_DEST_NO_DEST`.
- **See Also**: [`fd_shred_dest_pubkey_to_idx`](<fd_shred_dest.c.md#fd_shred_dest_pubkey_to_idx>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)