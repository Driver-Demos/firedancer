<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for the `fd_shredder` functionality, including performance and batch processing tests.

# Purpose
The code is a C program designed to test and validate the functionality of a data shredding and forward error correction (FEC) system, specifically for use with the Solana blockchain. It includes several test functions that verify the correct operation of the `fd_shredder` component, which is responsible for creating data and parity shreds from input data batches. The program uses various test data and configurations to ensure that the shredding process produces the expected number of data and parity shreds, and that these shreds are correctly indexed and signed. The tests also include performance measurements to assess the throughput of the shredding process.

The program is structured to include multiple test cases, such as [`test_skip_batch`](<#test_skip_batch>), [`test_shredder_count`](<#test_shredder_count>), and [`test_chained_merkle_shreds`](<#test_chained_merkle_shreds>), each focusing on different aspects of the shredding process. It uses predefined constants and memory allocations to simulate real-world data processing scenarios. The code also includes performance tests ([`perf_test`](<#perf_test>) and [`perf_test2`](<#perf_test2>)) to measure the efficiency of the shredding operations. The main function initializes the test environment, runs all the test cases, and logs the results. The program is intended to be executed in a hosted environment, as indicated by the conditional compilation directives that include additional tests when `FD_HAS_HOSTED` is defined.
# Imports and Dependencies

---
- `fd_shredder.h`
- `../../ballet/shred/fd_shred.h`
- `../../ballet/hex/fd_hex.h`
- `../../util/net/fd_pcap.h`
- `stdio.h`


# Global Variables

---
### perf\_test\_entry\_batch
- **Type**: `uchar`
- **Description**: An array of unsigned characters with a size defined by `PERF_TEST_SZ`, which is 10 megabytes. This array is used to store data for performance testing purposes.
- **Use**: Used to hold a large batch of data entries for performance testing in the `perf_test` function.


---
### skip\_test\_data
- **Type**: `uchar array`
- **Description**: `skip_test_data` is an array of unsigned characters with a size defined by `SKIP_TEST_SZ`, which is set to 1 megabyte (1024 * 1024 bytes).
- **Use**: Used in the `test_skip_batch` function to store random data for testing the batch processing capabilities of shredders.


---
### fec\_set\_memory\_1
- **Type**: `uchar`
- **Description**: `fec_set_memory_1` is a global array of unsigned characters with a size determined by multiplying 2048 by the constant `FD_REEDSOL_DATA_SHREDS_MAX`. This array is used to store data shreds for forward error correction (FEC) operations.
- **Use**: Used to store data shreds in FEC operations, with each shred occupying a segment of 2048 bytes.


---
### fec\_set\_memory\_2
- **Type**: `uchar`
- **Description**: `fec_set_memory_2` is an array of unsigned characters with a size determined by multiplying 2048 by the constant `FD_REEDSOL_PARITY_SHREDS_MAX`. This array is used to store parity shreds in the context of Forward Error Correction (FEC) operations.
- **Use**: Stores parity shreds for FEC operations in the `fd_shredder` process.


---
### \_shredder
- **Type**: `fd_shredder_t[1]`
- **Description**: The `_shredder` variable is an array of one `fd_shredder_t` structure. This structure is used to manage the shredding process, which involves breaking down data into smaller pieces called shreds for processing or transmission.
- **Use**: Used to initialize and manage the shredding process through functions like `fd_shredder_new` and `fd_shredder_join`.


# Data Structures

---
### signer\_ctx
- **Type**: ``struct``
- **Members**:
    - ``sha512``: An array of `fd_sha512_t` used for SHA-512 hashing.
    - ``public_key``: A pointer to an unsigned character array representing the public key.
    - ``private_key``: A pointer to an unsigned character array representing the private key.
- **Description**: Holds cryptographic context for signing operations, including SHA-512 hashing and key management.


---
### signer\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``sha512``: An array of `fd_sha512_t` used for SHA-512 hashing.
    - ``public_key``: A pointer to an unsigned character array representing the public key.
    - ``private_key``: A pointer to an unsigned character array representing the private key.
- **Description**: Holds cryptographic context for signing operations, including SHA-512 hashing and key management, with pointers to both public and private keys.


# Functions

---
### signer\_ctx\_init<!-- {{#callable:signer_ctx_init}} -->
[View Source →](<../../../../../src/disco/shred/test_shredder.c#L34>)

Initializes a `signer_ctx_t` structure by setting up its SHA-512 context and assigning the private and public keys from a given private key input.
- **Inputs**:
    - `ctx`: A pointer to a `signer_ctx_t` structure that will be initialized.
    - `private_key`: A pointer to a constant unsigned character array representing the private key, where the first 32 bytes are the private key and the next 32 bytes are the public key.
- **Logic and Control Flow**:
    - Calls `fd_sha512_new` with `ctx->sha512` to create a new SHA-512 context.
    - Initializes the SHA-512 context by calling `fd_sha512_init` and checks the result with `FD_TEST`.
    - Sets `ctx->public_key` to point to the public key portion of the `private_key` (offset by 32 bytes).
    - Sets `ctx->private_key` to point to the private key portion of the `private_key`.
- **Output**: No return value; the function initializes the `ctx` structure in place.


---
### test\_signer<!-- {{#callable:test_signer}} -->
[View Source →](<../../../../../src/disco/shred/test_shredder.c#L42>)

Generates an Ed25519 signature for a given Merkle root using a provided context containing public and private keys.
- **Inputs**:
    - `_ctx`: A pointer to a `signer_ctx_t` structure that contains the public and private keys and a SHA-512 context.
    - `signature`: A pointer to a buffer where the generated signature will be stored.
    - `merkle_root`: A pointer to the Merkle root data that will be signed.
- **Logic and Control Flow**:
    - Casts the `_ctx` pointer to a `signer_ctx_t` pointer to access the signing context.
    - Calls the `fd_ed25519_sign` function to generate a signature using the provided `merkle_root`, the public and private keys from the context, and the SHA-512 context.
- **Output**: The function does not return a value; it outputs the generated signature in the `signature` buffer.


---
### test\_shredder\_pcap<!-- {{#callable:test_shredder_pcap}} -->
[View Source →](<../../../../../src/disco/shred/test_shredder.c#L58>)

Validates the functionality of the shredder by comparing data and parity shreds from a pcap file against generated shreds.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize a `signer_ctx_t` structure with a private key.
    - Create a new shredder instance and join it.
    - Verify the number of FEC sets, data shreds, and parity shreds from the pcap file.
    - Open the pcap file in memory and create an iterator for it.
    - Initialize metadata for entry batches and set `block_complete` to 1.
    - Initialize a shredder batch and iterate over FEC sets to verify data shreds against pcap data.
    - For each data shred, compare the packet data from the pcap with the generated data shreds.
    - Finalize the shredder batch and start a dummy batch to reset indices.
    - Reinitialize the shredder batch and iterate over FEC sets to verify parity shreds against pcap data.
    - For each parity shred, compare the packet data from the pcap with the generated parity shreds.
    - Finalize the shredder batch.
    - Delete the pcap iterator and close the file.
- **Output**: No output is returned; the function performs tests and logs errors if any mismatches occur.
- **Functions Called**:
    - [`signer_ctx_init`](<#signer_ctx_init>)
    - [`fd_shredder_new`](<fd_shredder.c.md#fd_shredder_new>)
    - [`fd_shredder_join`](<fd_shredder.c.md#fd_shredder_join>)
    - [`fd_shredder_count_fec_sets`](<fd_shredder.h.md#fd_shredder_count_fec_sets>)
    - [`fd_shredder_count_data_shreds`](<fd_shredder.h.md#fd_shredder_count_data_shreds>)
    - [`fd_shredder_count_parity_shreds`](<fd_shredder.h.md#fd_shredder_count_parity_shreds>)
    - [`fd_shredder_init_batch`](<fd_shredder.c.md#fd_shredder_init_batch>)
    - [`fd_shredder_next_fec_set`](<fd_shredder.c.md#fd_shredder_next_fec_set>)
    - [`fd_shredder_fini_batch`](<fd_shredder.c.md#fd_shredder_fini_batch>)


---
### test\_skip\_batch<!-- {{#callable:test_skip_batch}} -->
[View Source →](<../../../../../src/disco/shred/test_shredder.c#L149>)

Tests the functionality of multiple shredders processing and skipping batches of data, ensuring consistency and correctness of data and parity shreds.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize a random number generator and a signer context with a private key.
    - Define the number of shredders as 4 and ensure it is greater than 0.
    - Initialize shredders and join them to the context.
    - Initialize metadata and buffers for data and parity shreds.
    - Fill `skip_test_data` with random bytes using the random number generator.
    - Iterate over `skip_test_data` in chunks, randomly selecting a shredder to process each batch while others skip it.
    - For the selected shredder, initialize a batch, count FEC sets, process each FEC set, and finalize the batch.
    - For other shredders, skip the batch.
    - Verify that all shredders have consistent data and parity index offsets after processing each batch.
    - Increment the slot number every 200,000 bytes and reset data and parity shred counts.
    - Process a final set with the first shredder and compare outputs with other shredders to ensure consistency.
- **Output**: No output is returned; the function performs tests and uses assertions to verify correctness.
- **Functions Called**:
    - [`signer_ctx_init`](<#signer_ctx_init>)
    - [`fd_shredder_new`](<fd_shredder.c.md#fd_shredder_new>)
    - [`fd_shredder_join`](<fd_shredder.c.md#fd_shredder_join>)
    - [`fd_shredder_init_batch`](<fd_shredder.c.md#fd_shredder_init_batch>)
    - [`fd_shredder_count_fec_sets`](<fd_shredder.h.md#fd_shredder_count_fec_sets>)
    - [`fd_shredder_next_fec_set`](<fd_shredder.c.md#fd_shredder_next_fec_set>)
    - [`fd_shredder_fini_batch`](<fd_shredder.c.md#fd_shredder_fini_batch>)
    - [`fd_shredder_skip_batch`](<fd_shredder.c.md#fd_shredder_skip_batch>)


---
### \_internal\_test\_shredder\_count<!-- {{#callable:_internal_test_shredder_count}} -->
[View Source →](<../../../../../src/disco/shred/test_shredder.c#L250>)

Validates the correctness of shredder functions by testing data and parity shred counts, FEC set counts, and shredder output consistency for various data sizes and types.
- **Inputs**:
    - `type`: The type of shred to test, which influences the behavior of the shredder functions.
- **Logic and Control Flow**:
    - Initialize and test the shredder functions for zero data size, ensuring expected counts for data shreds, parity shreds, and FEC sets.
    - Determine if the shred type is chained or resigned, and calculate the overhead based on these properties.
    - Iterate over data sizes from 1 to 999,999, calculating expected data shreds, parity shreds, and FEC sets using a reference implementation logic.
    - For each data size, verify that the calculated counts match the results from the shredder functions.
    - Check that the shredder functions do not exceed maximum allowed shreds for data sizes that result in a single FEC set.
    - Initialize a shredder instance and prepare memory for FEC sets, then iterate over data sizes from 1 to 99,999, initializing batches and verifying that the shredder produces the expected number of data and parity shreds.
- **Output**: No direct output; the function performs internal tests and assertions to validate shredder functionality.
- **Functions Called**:
    - [`fd_shredder_count_data_shreds`](<fd_shredder.h.md#fd_shredder_count_data_shreds>)
    - [`fd_shredder_count_parity_shreds`](<fd_shredder.h.md#fd_shredder_count_parity_shreds>)
    - [`fd_shredder_count_fec_sets`](<fd_shredder.h.md#fd_shredder_count_fec_sets>)
    - [`signer_ctx_init`](<#signer_ctx_init>)
    - [`fd_shredder_new`](<fd_shredder.c.md#fd_shredder_new>)
    - [`fd_shredder_join`](<fd_shredder.c.md#fd_shredder_join>)
    - [`fd_shredder_init_batch`](<fd_shredder.c.md#fd_shredder_init_batch>)
    - [`fd_shredder_next_fec_set`](<fd_shredder.c.md#fd_shredder_next_fec_set>)
    - [`fd_shredder_fini_batch`](<fd_shredder.c.md#fd_shredder_fini_batch>)


---
### test\_shredder\_count<!-- {{#callable:test_shredder_count}} -->
[View Source →](<../../../../../src/disco/shred/test_shredder.c#L342>)

Calls the [`_internal_test_shredder_count`](<#_internal_test_shredder_count>) function with the `FD_SHRED_TYPE_MERKLE_DATA` argument.
- **Inputs**: None
- **Logic and Control Flow**:
    - Invokes the [`_internal_test_shredder_count`](<#_internal_test_shredder_count>) function with the constant `FD_SHRED_TYPE_MERKLE_DATA`.
- **Output**: No output is returned as the function is of type `void`.
- **Functions Called**:
    - [`_internal_test_shredder_count`](<#_internal_test_shredder_count>)


---
### test\_shredder\_count\_chained<!-- {{#callable:test_shredder_count_chained}} -->
[View Source →](<../../../../../src/disco/shred/test_shredder.c#L347>)

Calls the [`_internal_test_shredder_count`](<#_internal_test_shredder_count>) function with the `FD_SHRED_TYPE_MERKLE_DATA_CHAINED` type.
- **Inputs**: None
- **Logic and Control Flow**:
    - Invokes the [`_internal_test_shredder_count`](<#_internal_test_shredder_count>) function with the argument `FD_SHRED_TYPE_MERKLE_DATA_CHAINED`.
- **Output**: No output is returned as the function is of type `void`.
- **Functions Called**:
    - [`_internal_test_shredder_count`](<#_internal_test_shredder_count>)


---
### test\_shredder\_count\_resigned<!-- {{#callable:test_shredder_count_resigned}} -->
[View Source →](<../../../../../src/disco/shred/test_shredder.c#L352>)

Calls [`_internal_test_shredder_count`](<#_internal_test_shredder_count>) with the shred type `FD_SHRED_TYPE_MERKLE_DATA_CHAINED_RESIGNED` to test shredder counting functionality.
- **Inputs**: None
- **Logic and Control Flow**:
    - Invokes the [`_internal_test_shredder_count`](<#_internal_test_shredder_count>) function.
    - Passes the constant `FD_SHRED_TYPE_MERKLE_DATA_CHAINED_RESIGNED` as an argument to [`_internal_test_shredder_count`](<#_internal_test_shredder_count>).
- **Output**: No output is returned as the function is `void`.
- **Functions Called**:
    - [`_internal_test_shredder_count`](<#_internal_test_shredder_count>)


---
### test\_chained\_merkle\_shreds<!-- {{#callable:test_chained_merkle_shreds}} -->
[View Source →](<../../../../../src/disco/shred/test_shredder.c#L357>)

Tests the creation and validation of chained Merkle shreds, ensuring correct data and parity shred counts, and verifying the final Merkle root.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize `expected_final_chained_merkle_root` and `chained_merkle_root` with predefined values using `fd_hex_decode`.
    - Set `data_sz` to 30000 and verify that the number of data and parity shreds is 32 each, and there is 1 FEC set using `FD_TEST`.
    - Fill `perf_test_entry_batch` with sequential values from 0 to `data_sz`.
    - Initialize `meta` and `signer_ctx`, and create a new shredder instance, joining it to `shredder`.
    - Set the shred version of `shredder` to 6051.
    - Initialize `fec_set_memory_1` and `fec_set_memory_2` with the `canary` value.
    - Loop over slots from 10 to 13, skipping slot 11, and set `meta->parent_offset` based on the slot number.
    - For each slot, loop over `setid` from 0 to 9, setting `meta->block_complete` to true for the last set.
    - Initialize a batch with [`fd_shredder_init_batch`](<fd_shredder.c.md#fd_shredder_init_batch>), get the next FEC set with [`fd_shredder_next_fec_set`](<fd_shredder.c.md#fd_shredder_next_fec_set>), and finalize the batch with [`fd_shredder_fini_batch`](<fd_shredder.c.md#fd_shredder_fini_batch>).
    - Verify that `out_merkle_root.hash` is not null and perform per-slot checks on data and parity shreds, ensuring no overflow and correct indexing.
    - Perform a final check to ensure `chained_merkle_root` matches `expected_final_chained_merkle_root`.
- **Output**: No output is returned; the function performs internal tests and validations using `FD_TEST` assertions.
- **Functions Called**:
    - [`fd_shredder_count_data_shreds`](<fd_shredder.h.md#fd_shredder_count_data_shreds>)
    - [`fd_shredder_count_parity_shreds`](<fd_shredder.h.md#fd_shredder_count_parity_shreds>)
    - [`fd_shredder_count_fec_sets`](<fd_shredder.h.md#fd_shredder_count_fec_sets>)
    - [`signer_ctx_init`](<#signer_ctx_init>)
    - [`fd_shredder_new`](<fd_shredder.c.md#fd_shredder_new>)
    - [`fd_shredder_join`](<fd_shredder.c.md#fd_shredder_join>)
    - [`fd_shredder_set_shred_version`](<fd_shredder.h.md#fd_shredder_set_shred_version>)
    - [`fd_shredder_init_batch`](<fd_shredder.c.md#fd_shredder_init_batch>)
    - [`fd_shredder_next_fec_set`](<fd_shredder.c.md#fd_shredder_next_fec_set>)
    - [`fd_shredder_fini_batch`](<fd_shredder.c.md#fd_shredder_fini_batch>)


---
### perf\_test<!-- {{#callable:perf_test}} -->
[View Source →](<../../../../../src/disco/shred/test_shredder.c#L461>)

Performs a performance test on the `fd_shredder` by processing a 10 MB entry batch multiple times and logging the time taken and throughput.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize the `perf_test_entry_batch` array with values from 0 to `PERF_TEST_SZ-1`.
    - Create and initialize a `fd_entry_batch_meta_t` structure to zero.
    - Initialize a `signer_ctx_t` structure with the `test_private_key`.
    - Create a new `fd_shredder` instance and join it to obtain a `shredder` pointer.
    - Set up `fd_fec_set_t` structure with memory locations for data and parity shreds.
    - Start a timer using `fd_log_wallclock` to measure the performance.
    - Loop 100 times to perform the shredding process:
    - Initialize a batch with [`fd_shredder_init_batch`](<fd_shredder.c.md#fd_shredder_init_batch>) using the `shredder`, `perf_test_entry_batch`, and `meta`.
    - Count the number of FEC sets required using [`fd_shredder_count_fec_sets`](<fd_shredder.h.md#fd_shredder_count_fec_sets>).
    - Iterate over each FEC set and process it using [`fd_shredder_next_fec_set`](<fd_shredder.c.md#fd_shredder_next_fec_set>).
    - Finalize the batch with [`fd_shredder_fini_batch`](<fd_shredder.c.md#fd_shredder_fini_batch>).
    - Stop the timer and calculate the elapsed time.
    - Log the performance results in terms of nanoseconds per 10 MB entry batch and the throughput in Gbps.
- **Output**: Logs the performance results, including the time taken per 10 MB entry batch and the throughput in Gbps.
- **Functions Called**:
    - [`signer_ctx_init`](<#signer_ctx_init>)
    - [`fd_shredder_new`](<fd_shredder.c.md#fd_shredder_new>)
    - [`fd_shredder_join`](<fd_shredder.c.md#fd_shredder_join>)
    - [`fd_shredder_init_batch`](<fd_shredder.c.md#fd_shredder_init_batch>)
    - [`fd_shredder_count_fec_sets`](<fd_shredder.h.md#fd_shredder_count_fec_sets>)
    - [`fd_shredder_next_fec_set`](<fd_shredder.c.md#fd_shredder_next_fec_set>)
    - [`fd_shredder_fini_batch`](<fd_shredder.c.md#fd_shredder_fini_batch>)


---
### perf\_test2<!-- {{#callable:perf_test2}} -->
[View Source →](<../../../../../src/disco/shred/test_shredder.c#L495>)

Performs a performance test by processing a batch of data entries through a shredder, measuring the time taken and data throughput.
- **Inputs**: None
- **Logic and Control Flow**:
    - Create an anonymous workspace with a specified size using `fd_wksp_new_anonymous` and verify its creation with `FD_TEST`.
    - Allocate memory for `entry_batch` and `fec_memory` within the workspace using `fd_wksp_alloc` and convert the addresses using `fd_wksp_laddr_fast`.
    - Initialize the `entry_batch` with sequential byte values from 0 to `PERF_TEST2_SZ`.
    - Initialize a `fd_entry_batch_meta_t` structure to zero using `fd_memset`.
    - Initialize a `signer_ctx_t` structure with a private key using [`signer_ctx_init`](<#signer_ctx_init>).
    - Create and join a shredder instance using [`fd_shredder_new`](<fd_shredder.c.md#fd_shredder_new>) and [`fd_shredder_join`](<fd_shredder.c.md#fd_shredder_join>), verifying each step with `FD_TEST`.
    - Set up `fd_fec_set_t` structure to point to allocated `fec_memory` for data and parity shreds.
    - Run a loop for a fixed number of iterations (30), where each iteration initializes a shredder batch, processes FEC sets, and accumulates the number of bytes produced.
    - Calculate the elapsed time using `fd_log_wallclock` before and after the loop.
    - Delete the anonymous workspace using `fd_wksp_delete_anonymous`.
    - Log the performance results, including time per batch and data throughput, using `FD_LOG_NOTICE`.
- **Output**: Logs the performance metrics, including the time per 1 MB entry batch and the data throughput in Gbps.
- **Functions Called**:
    - [`signer_ctx_init`](<#signer_ctx_init>)
    - [`fd_shredder_new`](<fd_shredder.c.md#fd_shredder_new>)
    - [`fd_shredder_join`](<fd_shredder.c.md#fd_shredder_join>)
    - [`fd_shredder_init_batch`](<fd_shredder.c.md#fd_shredder_init_batch>)
    - [`fd_shredder_count_fec_sets`](<fd_shredder.h.md#fd_shredder_count_fec_sets>)
    - [`fd_shredder_next_fec_set`](<fd_shredder.c.md#fd_shredder_next_fec_set>)
    - [`fd_shredder_fini_batch`](<fd_shredder.c.md#fd_shredder_fini_batch>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/disco/shred/test_shredder.c#L539>)

Initializes the environment, performs various tests on the shredder functionality, and logs the results before halting the program.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Checks if the maximum BMTREE depth is correct using `FD_TEST`.
    - Logs a warning if the size of `fd_shredder_t` does not match its footprint, then asserts the match with `FD_TEST`.
    - Executes a series of test functions: [`test_skip_batch`](<#test_skip_batch>), [`test_shredder_count`](<#test_shredder_count>), [`test_shredder_count_chained`](<#test_shredder_count_chained>), [`test_shredder_count_resigned`](<#test_shredder_count_resigned>), [`test_chained_merkle_shreds`](<#test_chained_merkle_shreds>), [`perf_test`](<#perf_test>), and [`perf_test2`](<#perf_test2>).
    - Conditionally executes [`test_shredder_pcap`](<#test_shredder_pcap>) if `FD_HAS_HOSTED` is defined.
    - Logs a notice indicating the tests passed.
    - Calls `fd_halt` to clean up and terminate the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`fd_shredder_footprint`](<fd_shredder.h.md#fd_shredder_footprint>)
    - [`test_skip_batch`](<#test_skip_batch>)
    - [`test_shredder_count`](<#test_shredder_count>)
    - [`test_shredder_count_chained`](<#test_shredder_count_chained>)
    - [`test_shredder_count_resigned`](<#test_shredder_count_resigned>)
    - [`test_chained_merkle_shreds`](<#test_chained_merkle_shreds>)
    - [`perf_test`](<#perf_test>)
    - [`perf_test2`](<#perf_test2>)
    - [`test_shredder_pcap`](<#test_shredder_pcap>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)