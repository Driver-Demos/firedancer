<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Header file for the Firedancer shredder, defining data structures and functions for processing shreds.

# Purpose
The code is a C header file that defines the interface and data structures for a "shredder" component. This component is responsible for processing data into shreds, which are smaller, manageable pieces of data that can be used for efficient data transmission and error correction. The shredder uses techniques such as Merkle trees and Reed-Solomon error correction to ensure data integrity and reliability. The file includes several external dependencies, such as SHA-256 hashing, Ed25519 digital signatures, and Reed-Solomon encoding, indicating that it relies on cryptographic and error correction libraries to perform its functions.

The header file defines a `fd_shredder_t` structure, which encapsulates the state and configuration of a shredder instance. It provides functions to initialize, join, leave, and delete shredder instances, as well as to manage the shredding process through functions like [`fd_shredder_init_batch`](<#fd_shredder_init_batch>), [`fd_shredder_skip_batch`](<#fd_shredder_skip_batch>), [`fd_shredder_next_fec_set`](<#fd_shredder_next_fec_set>), and [`fd_shredder_fini_batch`](<#fd_shredder_fini_batch>). These functions handle the creation of data and parity shreds, compute Merkle proofs, and manage the signing of shreds. The file also defines constants and utility functions to calculate the number of data and parity shreds required for a given data size, based on the type of shreds being used. The shredder is designed to work with different types of shreds, including normal, chained, and resigned chained Merkle shreds, each with specific payload size constraints.
# Imports and Dependencies

---
- `../keyguard/fd_keyguard_client.h`
- `../../ballet/sha256/fd_sha256.h`
- `../../disco/pack/fd_microblock.h`
- `../../ballet/wsample/fd_wsample.h`
- `../../ballet/ed25519/fd_ed25519.h`
- `../../ballet/reedsol/fd_reedsol.h`
- `../../ballet/bmtree/fd_bmtree.h`
- `../../ballet/shred/fd_fec_set.h`
- `../../ballet/shred/fd_shred.h`


# Global Variables

---
### fd\_shredder\_data\_to\_parity\_cnt
- **Type**: `ulong const[33UL]`
- **Description**: An array of 33 unsigned long constants that maps the number of data shreds to the corresponding number of parity shreds required for error correction.
- **Use**: Used to determine the number of parity shreds needed based on the number of data shreds in a Forward Error Correction (FEC) set.


# Data Structures

---
### fd\_shred\_features\_activation\_private
- **Type**: ``union``
- **Members**:
    - ``slots``: An array of unsigned long integers with a size defined by `FD_SHRED_FEATURES_ACTIVATION_SLOT_CNT`.
    - ``disable_turbine_fanout_experiments``: An unsigned long integer to control the disabling of turbine fanout experiments.
    - ``enable_turbine_extended_fanout_experiments``: An unsigned long integer to control the enabling of turbine extended fanout experiments.
    - ``enable_chained_merkle_shreds``: An unsigned long integer to control the enabling of chained Merkle shreds.
    - ``drop_unchained_merkle_shreds``: An unsigned long integer to control the dropping of unchained Merkle shreds.
- **Description**: A union that provides a mechanism to manage feature activation states for shreds, using either an array of slots or individual feature flags represented as unsigned long integers.


---
### fd\_shred\_features\_activation\_t
- **Type**: ``union``
- **Members**:
    - ``slots``: An array of `ulong` with a size defined by `FD_SHRED_FEATURES_ACTIVATION_SLOT_CNT`.
    - ``disable_turbine_fanout_experiments``: A `ulong` field to control the disabling of turbine fanout experiments.
    - ``enable_turbine_extended_fanout_experiments``: A `ulong` field to control the enabling of turbine extended fanout experiments.
    - ``enable_chained_merkle_shreds``: A `ulong` field to control the enabling of chained Merkle shreds.
    - ``drop_unchained_merkle_shreds``: A `ulong` field to control the dropping of unchained Merkle shreds.
- **Description**: The `fd_shred_features_activation_t` union is a data structure that provides slots for feature activation flags related to shred operations. It contains an array of `ulong` values and a structured set of fields that represent specific feature toggles, such as enabling or disabling certain experiments and handling of Merkle shreds. This union allows for flexible management of feature states within the shredder system.


---
### fd\_shredder\_private
- **Type**: ``struct``
- **Members**:
    - `magic`: Stores a unique identifier for the shredder.
    - `shred_version`: Indicates the version of the shred format.
    - `sha256`: Holds a batch of SHA-256 hash computations.
    - `reedsol`: Contains Reed-Solomon error correction data.
    - `bmtree`: Represents a Merkle tree commit structure.
    - `_bmtree_footprint`: Provides storage for the Merkle tree footprint.
    - `bmtree_leaves`: Stores the leaves of the Merkle tree.
    - `entry_batch`: Points to the entry batch data.
    - `sz`: Specifies the size of the entry batch.
    - `offset`: Indicates the offset within the entry batch.
    - `signer_ctx`: Holds the context for the signing function.
    - `signer`: Points to the function used for signing shreds.
    - `meta`: Contains metadata for the entry batch.
    - `slot`: Specifies the slot number for the batch.
    - `data_idx_offset`: Indicates the offset for data shred indices.
    - `parity_idx_offset`: Indicates the offset for parity shred indices.
- **Description**: Aligns and organizes data necessary for processing and managing shreds, including cryptographic hashing, error correction, and Merkle tree operations, while maintaining metadata and context for signing operations.


---
### fd\_shredder\_t
- **Type**: ``struct``
- **Members**:
    - ``magic``: A unique identifier for the shredder instance.
    - ``shred_version``: The version of the shred format used by the shredder.
    - ``sha256``: An array containing a SHA-256 batch processor.
    - ``reedsol``: An array containing a Reed-Solomon encoder.
    - ``bmtree``: A Merkle tree commit structure for data integrity verification.
    - ``bmtree_leaves``: An array of Merkle tree nodes for storing data and parity shreds.
    - ``entry_batch``: A pointer to the entry batch data being processed.
    - ``sz``: The size of the entry batch data.
    - ``offset``: The current offset within the entry batch data.
    - ``signer_ctx``: A context for the signing function.
    - ``signer``: A function pointer for signing shreds.
    - ``meta``: Metadata for the entry batch necessary for shred production.
    - ``slot``: The slot number associated with the entry batch.
    - ``data_idx_offset``: The offset for data shred indices.
    - ``parity_idx_offset``: The offset for parity shred indices.
- **Description**: `fd_shredder_t` is a data structure that manages the process of converting entry batches into shreds, which are smaller, verifiable data units. It includes fields for cryptographic operations, such as SHA-256 hashing and Reed-Solomon encoding, and uses a Merkle tree for data integrity. The structure also maintains state information about the current entry batch, including its size, offset, and associated metadata. Additionally, it supports signing operations through a function pointer and context, allowing for secure verification of the shreds produced.


# Functions

---
### fd\_shredder\_align<!-- {{#callable:fd_shredder_align}} -->
[View Source →](<../../../../../src/disco/shred/fd_shredder.h#L77>)

Returns the alignment requirement for the `fd_shredder_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the constant `FD_SHREDDER_ALIGN`.
- **Output**: The function returns an `ulong` representing the alignment requirement for the `fd_shredder_t` structure.


---
### fd\_shredder\_footprint<!-- {{#callable:fd_shredder_footprint}} -->
[View Source →](<../../../../../src/disco/shred/fd_shredder.h#L78>)

Calculates the memory footprint of the `fd_shredder_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the size of the `fd_shredder_t` structure using the `sizeof` operator.
- **Output**: The function returns an `ulong` representing the size of the `fd_shredder_t` structure in bytes.


---
### fd\_shredder\_set\_shred\_version<!-- {{#callable:fd_shredder_set_shred_version}} -->
[View Source →](<../../../../../src/disco/shred/fd_shredder.h#L90>)

Sets the `shred_version` field of a `fd_shredder_t` structure to a specified value.
- **Inputs**:
    - `shredder`: A pointer to a `fd_shredder_t` structure whose `shred_version` field will be set.
    - `shred_version`: A `ushort` value representing the version to set in the `shredder`'s `shred_version` field.
- **Logic and Control Flow**:
    - Assigns the value of `shred_version` to the `shred_version` field of the `shredder` structure.
- **Output**: No return value; the function modifies the `shred_version` field of the `shredder` structure in place.


---
### fd\_shredder\_count\_fec\_sets<!-- {{#callable:fd_shredder_count_fec_sets}} -->
[View Source →](<../../../../../src/disco/shred/fd_shredder.h#L171>)

Calculates the number of FEC (Forward Error Correction) sets required for a given entry batch size and shred type.
- **Inputs**:
    - `sz_bytes`: The size of the entry batch in bytes.
    - `type`: The type of shreds, which must be one of `FD_SHRED_TYPE_MERKLE_DATA`, `FD_SHRED_TYPE_MERKLE_DATA_CHAINED`, or `FD_SHRED_TYPE_MERKLE_DATA_CHAINED_RESIGNED`.
- **Logic and Control Flow**:
    - Check if the shred type is resigned using `fd_shred_is_resigned(type)`; if true, calculate the number of FEC sets using the resigned payload size.
    - If the shred type is not resigned, check if it is chained using `fd_shred_is_chained(type)`; if true, calculate the number of FEC sets using the chained payload size.
    - If neither resigned nor chained, calculate the number of FEC sets using the normal payload size.
    - Use `fd_ulong_max` to ensure the size is at least twice the payload size minus one before dividing by the payload size to determine the number of FEC sets.
- **Output**: Returns the number of FEC sets as an unsigned long integer.


---
### fd\_shredder\_count\_data\_shreds<!-- {{#callable:fd_shredder_count_data_shreds}} -->
[View Source →](<../../../../../src/disco/shred/fd_shredder.h#L185>)

Calculates the number of data shreds required for a given entry batch size and shred type.
- **Inputs**:
    - `sz_bytes`: The size of the entry batch in bytes.
    - `type`: The type of shreds, which can be one of `FD_SHRED_TYPE_MERKLE_DATA`, `FD_SHRED_TYPE_MERKLE_DATA_CHAINED`, or `FD_SHRED_TYPE_MERKLE_DATA_CHAINED_RESIGNED`.
- **Logic and Control Flow**:
    - Calculate the number of normal FEC sets by calling [`fd_shredder_count_fec_sets`](<#fd_shredder_count_fec_sets>) and subtracting 1.
    - Initialize `shreds` to the number of normal sets multiplied by 32.
    - Check if the shred type is resigned using `fd_shred_is_resigned`.
    - If resigned, calculate `remaining_bytes` and determine additional shreds based on `remaining_bytes` using specific thresholds and formulas.
    - If not resigned, check if the shred type is chained using `fd_shred_is_chained`.
    - If chained, calculate `remaining_bytes` and determine additional shreds based on `remaining_bytes` using specific thresholds and formulas.
    - If neither resigned nor chained, calculate `remaining_bytes` for normal shreds and determine additional shreds based on `remaining_bytes` using specific thresholds and formulas.
    - Return the total number of shreds.
- **Output**: The total number of data shreds required.
- **Functions Called**:
    - [`fd_shredder_count_fec_sets`](<#fd_shredder_count_fec_sets>)


---
### fd\_shredder\_count\_parity\_shreds<!-- {{#callable:fd_shredder_count_parity_shreds}} -->
[View Source →](<../../../../../src/disco/shred/fd_shredder.h#L210>)

Calculates the number of parity shreds required for a given entry batch size and shred type.
- **Inputs**:
    - `sz_bytes`: The size of the entry batch in bytes.
    - `type`: The type of shreds, which can be normal, chained, or resigned.
- **Logic and Control Flow**:
    - Calculate the number of normal FEC sets using [`fd_shredder_count_fec_sets`](<#fd_shredder_count_fec_sets>) and subtract one to get `normal_sets`.
    - Initialize `shreds` as `normal_sets * 32UL`.
    - Check if the shred type is resigned using `fd_shred_is_resigned`.
    - If resigned, calculate `remaining_bytes` and adjust `shreds` based on `remaining_bytes` using specific thresholds and the `fd_shredder_data_to_parity_cnt` table.
    - If not resigned, check if the shred type is chained using `fd_shred_is_chained`.
    - If chained, calculate `remaining_bytes` and adjust `shreds` based on `remaining_bytes` using specific thresholds and the `fd_shredder_data_to_parity_cnt` table.
    - If neither resigned nor chained, calculate `remaining_bytes` for normal shreds and adjust `shreds` based on `remaining_bytes` using specific thresholds and the `fd_shredder_data_to_parity_cnt` table.
    - Return the total number of `shreds`.
- **Output**: The total number of parity shreds required.
- **Functions Called**:
    - [`fd_shredder_count_fec_sets`](<#fd_shredder_count_fec_sets>)


# Function Declarations (Public API)

---
### fd\_shredder\_new<!-- {{#callable_declaration:fd_shredder_new}} -->
[View Source →](<../../../../../src/disco/shred/fd_shredder.h#L85>)

Formats a memory region as a shredder object.
- **Description**: Use this function to initialize a memory region as a shredder object, which is necessary for processing shreds. Ensure that the memory region is properly aligned and non-null before calling this function. This function sets up the shredder with the provided signing function and context, preparing it for further operations. It is important to call this function before using the shredder for any shredding tasks.
- **Inputs**:
    - `mem`: A pointer to a memory region to format as a shredder. Must not be null and must be aligned according to `fd_shredder_align()`. If these conditions are not met, the function returns null.
    - `signer`: A pointer to a function that will sign shreds. The function must match the `fd_shredder_sign_fn` signature. Can be null if no signing is needed.
    - `signer_ctx`: A pointer to a context that will be passed to the signing function. Can be null if no context is needed.
- **Output**: Returns a pointer to the initialized shredder object on success, or null if the memory is null or misaligned.
- **See Also**: [`fd_shredder_new`](<fd_shredder.c.md#fd_shredder_new>)  (Implementation)


---
### fd\_shredder\_join<!-- {{#callable_declaration:fd_shredder_join}} -->
[View Source →](<../../../../../src/disco/shred/fd_shredder.h#L86>)

Joins a shredder object from a memory region.
- **Description**: Use this function to access a shredder object that has been previously initialized in a memory region. Ensure that the memory is correctly aligned and contains a valid shredder object. This function checks for null pointers, memory alignment, and a valid magic number to confirm the integrity of the shredder object. If any of these checks fail, the function returns null, indicating an error.
- **Inputs**:
    - `mem`: A pointer to the memory region containing the shredder object. Must not be null and must be aligned to `fd_shredder_align()`. The memory must contain a valid shredder object with the correct magic number. If these conditions are not met, the function returns null.
- **Output**: Returns a pointer to the shredder object if successful, or null if the input is invalid or the memory does not contain a valid shredder object.
- **See Also**: [`fd_shredder_join`](<fd_shredder.c.md#fd_shredder_join>)  (Implementation)


---
### fd\_shredder\_leave<!-- {{#callable_declaration:fd_shredder_leave}} -->
[View Source →](<../../../../../src/disco/shred/fd_shredder.h#L87>)

Leaves the shredder context.
- **Description**: Use this function to exit the context of a shredder object. It is typically called when the shredder is no longer needed, and you want to release any resources or perform cleanup associated with the shredder. Ensure that the shredder is in a valid state before calling this function.
- **Inputs**:
    - `shredder`: A pointer to a `fd_shredder_t` object. Must not be null. The function returns this pointer as a void pointer.
- **Output**: Returns the input `shredder` pointer cast to a void pointer.
- **See Also**: [`fd_shredder_leave`](<fd_shredder.c.md#fd_shredder_leave>)  (Implementation)


---
### fd\_shredder\_delete<!-- {{#callable_declaration:fd_shredder_delete}} -->
[View Source →](<../../../../../src/disco/shred/fd_shredder.h#L88>)

Deletes a shredder object from memory.
- **Description**: Use this function to delete a shredder object that was previously created. It checks if the memory region contains a valid shredder object by verifying a magic number. If the magic number is incorrect, it logs a warning and returns `NULL`. If the magic number is correct, it resets the magic number to zero and returns the pointer to the shredder object. This function should be called when the shredder object is no longer needed to ensure proper cleanup.
- **Inputs**:
    - `mem`: A pointer to the memory region that contains the shredder object. Must not be null and must point to a valid shredder object. If the magic number is incorrect, the function logs a warning and returns `NULL`.
- **Output**: Returns a pointer to the shredder object if successful, or `NULL` if the magic number is incorrect.
- **See Also**: [`fd_shredder_delete`](<fd_shredder.c.md#fd_shredder_delete>)  (Implementation)


---
### fd\_shredder\_init\_batch<!-- {{#callable_declaration:fd_shredder_init_batch}} -->
[View Source →](<../../../../../src/disco/shred/fd_shredder.h#L249>)

Initializes a shredder for processing an entry batch.
- **Description**: Use this function to prepare a shredder object for processing a new entry batch. The shredder must be a valid local join, and the entry batch size must be greater than zero. The function sets up the shredder with the provided entry batch, size, slot, and metadata. The shredder retains a read interest in the entry batch memory region until `fd_shredder_fini_batch` is called. Ensure that the entry batch memory is not modified during this period. The function returns the shredder in a new batch state, ready for further processing.
- **Inputs**:
    - `shredder`: A pointer to a valid `fd_shredder_t` object. Must be a valid local join.
    - `entry_batch`: A pointer to the first byte of the entry batch memory region. The shredder retains a read interest in this memory.
    - `entry_batch_sz`: The size of the entry batch in bytes. Must be greater than zero.
    - `slot`: The slot number associated with the entry batch. Used to update the shredder's state.
    - `metadata`: A pointer to `fd_entry_batch_meta_t` containing metadata for the entry batch. The shredder does not retain a read interest in this memory.
- **Output**: Returns a pointer to the initialized `fd_shredder_t` object, or NULL if the entry batch size is zero.
- **See Also**: [`fd_shredder_init_batch`](<fd_shredder.c.md#fd_shredder_init_batch>)  (Implementation)


---
### fd\_shredder\_skip\_batch<!-- {{#callable_declaration:fd_shredder_skip_batch}} -->
[View Source →](<../../../../../src/disco/shred/fd_shredder.h#L263>)

Updates the shredder state to skip processing a batch.
- **Description**: Use this function to update the state of a shredder object to skip processing a batch of data. This is useful when you want to advance the shredder's internal indices without actually processing the data. The function must be called with a valid shredder object that is locally joined. The `entry_batch_sz` parameter must be strictly positive, as a zero value will result in a `NULL` return. The function updates the data and parity shred indices as if the batch was processed, and it returns the updated shredder object.
- **Inputs**:
    - `shredder`: A pointer to a valid `fd_shredder_t` object. The shredder must be a valid local join. The caller retains ownership.
    - `entry_batch_sz`: The size of the entry batch in bytes. Must be strictly positive. If zero, the function returns `NULL`.
    - `slot`: The slot number associated with the batch. If it differs from the current slot in the shredder, the function resets the data and parity index offsets.
    - `shred_type`: The type of shreds to be processed. This parameter determines the count of data and parity shreds.
- **Output**: Returns the updated `fd_shredder_t` object with modified data and parity shred indices, or `NULL` if `entry_batch_sz` is zero.
- **See Also**: [`fd_shredder_skip_batch`](<fd_shredder.c.md#fd_shredder_skip_batch>)  (Implementation)


---
### fd\_shredder\_next\_fec\_set<!-- {{#callable_declaration:fd_shredder_next_fec_set}} -->
[View Source →](<../../../../../src/disco/shred/fd_shredder.h#L295>)

Extracts the next FEC set from the current batch.
- **Description**: Use this function to generate the next Forward Error Correction (FEC) set from an ongoing batch. It computes both data and parity shreds, including parity information, Merkle proofs, and signatures. The function updates the shredder's position within the batch and stores the generated FEC set in the provided result structure. Ensure that the shredder is a valid local join and that the signing private key corresponds to the public key used during shredder construction. If the entry batch's data is fully consumed, the function returns NULL.
- **Inputs**:
    - `shredder`: A pointer to a valid `fd_shredder_t` object. Must be a local join and initialized properly before calling this function.
    - `result`: A pointer to an `fd_fec_set_t` structure where the function will store the generated FEC set. The structure is overwritten by this function.
    - `chained_merkle_root`: A pointer to a 32-byte buffer containing the chained Merkle root of the previous FEC set, or NULL if not applicable. If not NULL, it is updated with the new root.
    - `out_merkle_root`: An optional pointer to a buffer of at least 32 bytes. If non-NULL, the function copies the Merkle root of the extracted FEC set into this buffer.
- **Output**: Returns the `result` pointer on success, or NULL if the entry batch's data is fully consumed.
- **See Also**: [`fd_shredder_next_fec_set`](<fd_shredder.c.md#fd_shredder_next_fec_set>)  (Implementation)


---
### fd\_shredder\_fini\_batch<!-- {{#callable_declaration:fd_shredder_fini_batch}} -->
[View Source →](<../../../../../src/disco/shred/fd_shredder.h#L305>)

Finishes processing the current batch in the shredder.
- **Description**: Use this function to complete the processing of the current batch in a shredder. It must be called on a shredder that is currently processing a batch. After calling this function, the shredder will no longer be in a batch and will be ready to start a new batch with `fd_shredder_init_batch`. This function is essential to reset the shredder's state after batch processing.
- **Inputs**:
    - `shredder`: A pointer to a `fd_shredder_t` object. It must be a valid local join and currently in a batch. The function will reset its batch-related state.
- **Output**: Returns the same `fd_shredder_t` pointer passed as input, with its batch-related state reset.
- **See Also**: [`fd_shredder_fini_batch`](<fd_shredder.c.md#fd_shredder_fini_batch>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)