<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for managing and updating stake and shred destination information in a distributed system.

# Purpose
The code is a C module that manages stake and shred destination information for a validator in a distributed network. It provides functionality to initialize, update, and manage stake-related data structures, specifically focusing on the handling of public keys, IP addresses, and stake weights. The module includes functions to sort and deduplicate stake weights, update shred destinations, and manage epoch-specific information. It uses several macros to include sorting functionality from a template file, `fd_sort.c`, and defines constants and structures to handle stake and shred destination data.

The module defines several public APIs, such as [`fd_stake_ci_new`](<#fd_stake_ci_new>), [`fd_stake_ci_join`](<#fd_stake_ci_join>), [`fd_stake_ci_leave`](<#fd_stake_ci_leave>), and [`fd_stake_ci_delete`](<#fd_stake_ci_delete>), which manage the lifecycle of the stake information context. It also provides functions to initialize and finalize stake messages, update shred destinations, and manage identity keys. The code includes mechanisms to handle changes in stake information, ensuring that shred destinations are updated accordingly. The module is designed to be part of a larger system, as indicated by its inclusion of external headers and reliance on specific data structures and constants.
# Imports and Dependencies

---
- `fd_stake_ci.h`
- `fd_shred_dest.h`
- `../../util/net/fd_ip4.h`
- `../../util/tmpl/fd_sort.c`
- `../../util/tmpl/fd_set.c`


# Functions

---
### fd\_stake\_ci\_new<!-- {{#callable:fd_stake_ci_new}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.c#L25>)

Initializes a `fd_stake_ci_t` structure with dummy stake and destination data, and sets up epoch information using the provided identity key.
- **Inputs**:
    - `mem`: A pointer to memory where the `fd_stake_ci_t` structure will be initialized.
    - `identity_key`: A constant pointer to an `fd_pubkey_t` structure representing the identity key to be used for initialization.
- **Logic and Control Flow**:
    - Cast `mem` to a `fd_stake_ci_t` pointer and store it in `info`.
    - Create a dummy stake with a vote key, id key, and a stake value of 1, and a dummy destination with the provided identity key and a dummy IP address.
    - Initialize the first elements of `info->vote_stake_weight` and `info->shred_dest` with the dummy stake and destination, respectively.
    - Iterate twice to initialize epoch information in `info->epoch_info` with default values and join new epoch leaders and shred destinations using the dummy data.
    - Set the first element of `info->identity_key` to the provided `identity_key`.
    - Return the initialized `info` pointer cast to `void *`.
- **Output**: A pointer to the initialized `fd_stake_ci_t` structure cast to `void *`.
- **Functions Called**:
    - [`fd_shred_dest_join`](<fd_shred_dest.c.md#fd_shred_dest_join>)
    - [`fd_shred_dest_new`](<fd_shred_dest.c.md#fd_shred_dest_new>)


---
### fd\_stake\_ci\_join<!-- {{#callable:fd_stake_ci_join}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.c#L52>)

Casts a memory pointer to a `fd_stake_ci_t` pointer.
- **Inputs**:
    - `mem`: A pointer to memory that is expected to be of type `fd_stake_ci_t`.
- **Logic and Control Flow**:
    - Casts the input `mem` to a `fd_stake_ci_t` pointer.
    - Returns the casted pointer.
- **Output**: A pointer of type `fd_stake_ci_t`.


---
### fd\_stake\_ci\_leave<!-- {{#callable:fd_stake_ci_leave}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.c#L54>)

Returns the input pointer cast to a `void *` type.
- **Inputs**:
    - ``info``: A pointer to an `fd_stake_ci_t` structure.
- **Logic and Control Flow**:
    - Casts the `info` pointer to a `void *` type.
    - Returns the casted pointer.
- **Output**: A `void *` pointer that is the casted version of the input `info`.


---
### fd\_stake\_ci\_delete<!-- {{#callable:fd_stake_ci_delete}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.c#L55>)

Returns the input memory pointer without modification.
- **Inputs**:
    - ``mem``: A pointer to a memory block that the function will return.
- **Logic and Control Flow**:
    - The function takes a single input parameter, `mem`.
    - It returns the `mem` pointer without performing any operations on it.
- **Output**: A pointer to the same memory block that was passed as input.


---
### fd\_stake\_ci\_stake\_msg\_init<!-- {{#callable:fd_stake_ci_stake_msg_init}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.c#L58>)

Initializes the `fd_stake_ci_t` structure with data from a `fd_stake_weight_msg_t` message, ensuring the message is not malformed.
- **Inputs**:
    - `info`: A pointer to an `fd_stake_ci_t` structure that will be initialized with data from the message.
    - `msg`: A constant pointer to an `fd_stake_weight_msg_t` structure containing the message data to initialize the `info` structure.
- **Logic and Control Flow**:
    - Checks if the `staked_cnt` in `msg` exceeds `MAX_SHRED_DESTS` and logs an error if true.
    - Copies the `epoch`, `start_slot`, `slot_cnt`, `staked_cnt`, `excluded_stake`, and `vote_keyed_lsched` from `msg` to `info->scratch`.
    - Copies the `weights` array from `msg` to `info->vote_stake_weight` using `fd_memcpy`.
- **Output**: No return value; the function modifies the `info` structure in place.


---
### log\_summary<!-- {{#callable:log_summary}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.c#L75>)

Logs detailed information about stake contact and shred destination details for debugging purposes.
- **Inputs**:
    - ``msg``: A constant character pointer to a message string that provides context for the log.
    - ``info``: A pointer to a `fd_stake_ci_t` structure containing stake contact information.
- **Logic and Control Flow**:
    - The function is conditionally compiled; the main logic is enclosed within a preprocessor directive `#if 0`, which means it is currently disabled.
    - If enabled, it retrieves epoch information from the `info` structure and logs a notice with the provided message `msg`.
    - Iterates over two epochs, logging shred destination details for each epoch, including epoch number, start slot, and slot count.
    - For each shred destination, it logs the public key, stake in lamports, IP address, and port number.
- **Output**: No output is returned as the function is primarily for logging purposes.
- **Functions Called**:
    - [`fd_shred_dest_cnt_all`](<fd_shred_dest.h.md#fd_shred_dest_cnt_all>)
    - [`fd_shred_dest_idx_to_dest`](<fd_shred_dest.h.md#fd_shred_dest_idx_to_dest>)


---
### compute\_id\_weights\_from\_vote\_weights<!-- {{#callable:compute_id_weights_from_vote_weights}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.c#L94>)

Converts vote-based stake weights to ID-based stake weights, deduplicates by ID, and sorts by stake and ID.
- **Inputs**:
    - `stake_weight`: An array of `fd_stake_weight_t` structures to store the converted ID-based stake weights.
    - `vote_stake_weight`: A constant array of `fd_vote_stake_weight_t` structures containing the original vote-based stake weights.
    - `staked_cnt`: The number of elements in the `vote_stake_weight` array.
- **Logic and Control Flow**:
    - Iterate over each element in `vote_stake_weight` and copy the `id_key` and `stake` to `stake_weight` in the old format [(id, stake)].
    - Sort the `stake_weight` array by ID using `sort_weights_by_id_inplace` to prepare for deduplication.
    - Deduplicate the `stake_weight` array by aggregating stakes with the same ID.
    - Calculate the new count of unique IDs, `staked_cnt_by_id`, using `fd_ulong_min`.
    - Sort the `stake_weight` array by stake and then by ID using `sort_weights_by_stake_id_inplace`.
- **Output**: Returns the count of unique IDs after deduplication and sorting.


---
### fd\_stake\_ci\_stake\_msg\_fini<!-- {{#callable:fd_stake_ci_stake_msg_fini}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.c#L132>)

Finalizes the stake message by updating shred destinations and epoch information based on new stake data.
- **Inputs**:
    - ``info``: A pointer to an `fd_stake_ci_t` structure containing the current stake and epoch information.
- **Logic and Control Flow**:
    - Retrieve the current epoch, staked count, unchanged staked count, and vote keyed schedule from `info->scratch`.
    - Get the existing shred destinations and their count from `info->epoch_info`.
    - Initialize an unhit set to track destinations not staked in the new epoch.
    - Compute new staked count using [`compute_id_weights_from_vote_weights`](<#compute_id_weights_from_vote_weights>) function.
    - Iterate over the new staked count to update `info->shred_dest` with existing destinations or fix up pubkeys if necessary.
    - Track any destinations that are no longer staked and update their stake to zero.
    - Sort the unstaked destinations if any were destaked.
    - Clear existing epoch information and create new epoch information with updated shred destinations and leader schedule.
    - Log a summary of the stake update.
- **Output**: No return value; updates are made directly to the `info` structure.
- **Functions Called**:
    - [`fd_shred_dest_cnt_all`](<fd_shred_dest.h.md#fd_shred_dest_cnt_all>)
    - [`compute_id_weights_from_vote_weights`](<#compute_id_weights_from_vote_weights>)
    - [`fd_shred_dest_pubkey_to_idx`](<fd_shred_dest.c.md#fd_shred_dest_pubkey_to_idx>)
    - [`fd_shred_dest_idx_to_dest`](<fd_shred_dest.h.md#fd_shred_dest_idx_to_dest>)
    - [`fd_shred_dest_delete`](<fd_shred_dest.c.md#fd_shred_dest_delete>)
    - [`fd_shred_dest_leave`](<fd_shred_dest.c.md#fd_shred_dest_leave>)
    - [`fd_shred_dest_join`](<fd_shred_dest.c.md#fd_shred_dest_join>)
    - [`fd_shred_dest_new`](<fd_shred_dest.c.md#fd_shred_dest_new>)
    - [`log_summary`](<#log_summary>)


---
### fd\_stake\_ci\_dest\_add\_init<!-- {{#callable:fd_stake_ci_dest_add_init}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.c#L222>)

Returns the `shred_dest` field from the `fd_stake_ci_t` structure.
- **Inputs**:
    - `info`: A pointer to an `fd_stake_ci_t` structure from which the `shred_dest` field is retrieved.
- **Logic and Control Flow**:
    - Accesses the `shred_dest` field of the `fd_stake_ci_t` structure pointed to by `info`.
    - Returns the `shred_dest` field.
- **Output**: A pointer to an `fd_shred_dest_weighted_t` structure, specifically the `shred_dest` field of the `fd_stake_ci_t` structure.


---
### fd\_stake\_ci\_dest\_add\_fini\_impl<!-- {{#callable:fd_stake_ci_dest_add_fini_impl}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.c#L224>)

Updates the list of staked and unstaked destinations by reorganizing and sorting them based on their current status and contact information.
- **Inputs**:
    - ``info``: A pointer to `fd_stake_ci_t` structure containing information about the current stake and destinations.
    - ``cnt``: The number of destinations to process.
    - ``ei``: A pointer to `fd_per_epoch_info_t` structure containing per-epoch information, including the current list of destinations (`sdest`).
- **Logic and Control Flow**:
    - Initialize `found_unstaked_cnt` to 0 and `any_new_unstaked` to 0.
    - Retrieve the count of staked destinations from `ei->sdest` and store it in `staked_cnt`.
    - Iterate over each destination in `info->shred_dest` up to `cnt`.
    - For each destination, determine its index in `ei->sdest` using [`fd_shred_dest_pubkey_to_idx`](<fd_shred_dest.c.md#fd_shred_dest_pubkey_to_idx>).
    - If the destination is unstaked and there is space, copy it to the unstaked part of `info->shred_dest_temp` and set its stake to 0.
    - Update the contact information (IP and port) for destinations that are already in `ei->sdest`.
    - Track if any new unstaked destinations are found and count the unstaked destinations that are already in `ei->sdest`.
    - If no new unstaked destinations are found and the count matches the unstaked count in `ei->sdest`, return early as no further updates are needed.
    - Otherwise, copy the staked destinations to the beginning of `info->shred_dest_temp`.
    - Sort the unstaked destinations by their public key.
    - Delete the current `sdest` and create a new one with the updated list of destinations.
    - If the new `sdest` is `NULL`, log an error and terminate.
- **Output**: The function does not return a value; it updates the `sdest` field in the `fd_per_epoch_info_t` structure pointed to by `ei`.
- **Functions Called**:
    - [`fd_shred_dest_cnt_staked`](<fd_shred_dest.h.md#fd_shred_dest_cnt_staked>)
    - [`fd_shred_dest_pubkey_to_idx`](<fd_shred_dest.c.md#fd_shred_dest_pubkey_to_idx>)
    - [`fd_shred_dest_idx_to_dest`](<fd_shred_dest.h.md#fd_shred_dest_idx_to_dest>)
    - [`fd_shred_dest_cnt_unstaked`](<fd_shred_dest.h.md#fd_shred_dest_cnt_unstaked>)
    - [`fd_shred_dest_delete`](<fd_shred_dest.c.md#fd_shred_dest_delete>)
    - [`fd_shred_dest_leave`](<fd_shred_dest.c.md#fd_shred_dest_leave>)
    - [`fd_shred_dest_join`](<fd_shred_dest.c.md#fd_shred_dest_join>)
    - [`fd_shred_dest_new`](<fd_shred_dest.c.md#fd_shred_dest_new>)


---
### fd\_stake\_ci\_dest\_add\_fini<!-- {{#callable:fd_stake_ci_dest_add_fini}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.c#L304>)

Ensures the local validator is included in the list of shred destinations and updates the destination information for two epochs.
- **Inputs**:
    - ``info``: A pointer to an `fd_stake_ci_t` structure containing information about the current stake and shred destinations.
    - ``cnt``: An unsigned long integer representing the current count of shred destinations.
- **Logic and Control Flow**:
    - Check if `cnt` is less than `MAX_SHRED_DESTS` using `FD_TEST` macro.
    - Iterate over the shred destinations to find if the local validator is already included by comparing public keys.
    - If the local validator is not found, add it to the shred destinations with a dummy IP address.
    - If the local validator is found, update its IP address to the dummy IP address.
    - Call [`fd_stake_ci_dest_add_fini_impl`](<#fd_stake_ci_dest_add_fini_impl>) to update the shred destinations for the current and next epoch.
    - Log a summary of the destination update using [`log_summary`](<#log_summary>).
- **Output**: No return value; the function modifies the `info` structure in place.
- **Functions Called**:
    - [`fd_stake_ci_dest_add_fini_impl`](<#fd_stake_ci_dest_add_fini_impl>)
    - [`log_summary`](<#log_summary>)


---
### fd\_stake\_ci\_get\_idx\_for\_slot<!-- {{#callable:fd_stake_ci_get_idx_for_slot}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.c#L331>)

Finds the index of the epoch information for a given slot.
- **Inputs**:
    - ``info``: A pointer to a `fd_stake_ci_t` structure containing epoch information.
    - ``slot``: An unsigned long integer representing the slot number to search for.
- **Logic and Control Flow**:
    - Initialize `idx` to `ULONG_MAX` to indicate no valid index found yet.
    - Iterate over the two elements in `info->epoch_info`.
    - For each element, check if the `slot` is within the range defined by `start_slot` and `slot_cnt`.
    - If the condition is true, update `idx` with the current index `i`.
    - Return the value of `idx`.
- **Output**: Returns an unsigned long integer representing the index of the epoch information if found, or `ULONG_MAX` if not found.


---
### fd\_stake\_ci\_set\_identity<!-- {{#callable:fd_stake_ci_set_identity}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.c#L341>)

Updates the identity key of a `fd_stake_ci_t` structure and adjusts the shred destination IP addresses accordingly.
- **Inputs**:
    - ``info``: A pointer to a `fd_stake_ci_t` structure that contains the current stake and shred destination information.
    - ``identity_key``: A pointer to a `fd_pubkey_t` structure representing the new identity key to set.
- **Logic and Control Flow**:
    - Iterates over two epochs in the `info->epoch_info` array.
    - For each epoch, retrieves the old and new shred destination indices using [`fd_shred_dest_pubkey_to_idx`](<fd_shred_dest.c.md#fd_shred_dest_pubkey_to_idx>).
    - Checks if the old index is valid using `FD_TEST`.
    - If the new index is valid, updates the IP addresses for the old and new indices and updates the source using [`fd_shred_dest_update_source`](<fd_shred_dest.h.md#fd_shred_dest_update_source>).
    - If the new index is not valid, checks if the total number of destinations is less than `MAX_SHRED_DESTS`.
    - Copies staked destinations to a temporary array and inserts the new identity key in lexicographic order.
    - Creates a new shred destination with the updated list and assigns it to the epoch's `sdest`.
    - Updates the `info->identity_key` with the new `identity_key`.
- **Output**: None (the function modifies the `info` structure in place).
- **Functions Called**:
    - [`fd_shred_dest_pubkey_to_idx`](<fd_shred_dest.c.md#fd_shred_dest_pubkey_to_idx>)
    - [`fd_shred_dest_idx_to_dest`](<fd_shred_dest.h.md#fd_shred_dest_idx_to_dest>)
    - [`fd_shred_dest_update_source`](<fd_shred_dest.h.md#fd_shred_dest_update_source>)
    - [`fd_shred_dest_cnt_staked`](<fd_shred_dest.h.md#fd_shred_dest_cnt_staked>)
    - [`fd_shred_dest_cnt_unstaked`](<fd_shred_dest.h.md#fd_shred_dest_cnt_unstaked>)
    - [`fd_shred_dest_delete`](<fd_shred_dest.c.md#fd_shred_dest_delete>)
    - [`fd_shred_dest_leave`](<fd_shred_dest.c.md#fd_shred_dest_leave>)
    - [`fd_shred_dest_join`](<fd_shred_dest.c.md#fd_shred_dest_join>)
    - [`fd_shred_dest_new`](<fd_shred_dest.c.md#fd_shred_dest_new>)


---
### refresh\_sdest<!-- {{#callable:refresh_sdest}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.c#L394>)

Updates the shred destination list by sorting unstaked entries and recreating the shred destination structure.
- **Inputs**:
    - ``info``: A pointer to `fd_stake_ci_t` structure containing stake and identity information.
    - ``shred_dest_temp``: A pointer to an array of `fd_shred_dest_weighted_t` structures representing temporary shred destinations.
    - ``cnt``: The total number of shred destinations.
    - ``staked_cnt``: The number of staked shred destinations.
    - ``ei``: A pointer to `fd_per_epoch_info_t` structure containing per-epoch information.
- **Logic and Control Flow**:
    - Sorts the unstaked entries in `shred_dest_temp` starting from index `staked_cnt` to `cnt` using `sort_pubkey_inplace` function.
    - Deletes the current shred destination structure using [`fd_shred_dest_delete`](<fd_shred_dest.c.md#fd_shred_dest_delete>) and [`fd_shred_dest_leave`](<fd_shred_dest.c.md#fd_shred_dest_leave>).
    - Creates a new shred destination structure with [`fd_shred_dest_new`](<fd_shred_dest.c.md#fd_shred_dest_new>) and joins it with [`fd_shred_dest_join`](<fd_shred_dest.c.md#fd_shred_dest_join>).
    - Checks if the new shred destination structure is `NULL` and logs an error if it is.
- **Output**: No return value; updates the shred destination structure in `ei`.
- **Functions Called**:
    - [`fd_shred_dest_delete`](<fd_shred_dest.c.md#fd_shred_dest_delete>)
    - [`fd_shred_dest_leave`](<fd_shred_dest.c.md#fd_shred_dest_leave>)
    - [`fd_shred_dest_join`](<fd_shred_dest.c.md#fd_shred_dest_join>)
    - [`fd_shred_dest_new`](<fd_shred_dest.c.md#fd_shred_dest_new>)


---
### ci\_dest\_add\_one\_unstaked<!-- {{#callable:ci_dest_add_one_unstaked}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.c#L409>)

Adds a new unstaked validator entry to the shred destination list if the maximum limit is not exceeded.
- **Inputs**:
    - ``info``: A pointer to `fd_stake_ci_t` structure containing information about the current stake and shred destinations.
    - ``new_entry``: A pointer to `fd_shred_dest_weighted_t` structure representing the new unstaked validator entry to add.
    - ``ei``: A pointer to `fd_per_epoch_info_t` structure containing per-epoch information, including the current shred destination list.
- **Logic and Control Flow**:
    - Check if the current number of shred destinations in `ei->sdest` is greater than or equal to `MAX_SHRED_DESTS`; if so, log a warning and do not add the new entry.
    - Retrieve the current count of shred destinations from `ei->sdest`.
    - Copy all existing shred destinations from `ei->sdest` to `info->shred_dest_temp`.
    - Add the new unstaked entry `new_entry` to `info->shred_dest_temp`.
    - Call [`refresh_sdest`](<#refresh_sdest>) to update the shred destination list with the new entry.
- **Output**: No return value; the function updates the shred destination list in place.
- **Functions Called**:
    - [`fd_shred_dest_cnt_all`](<fd_shred_dest.h.md#fd_shred_dest_cnt_all>)
    - [`fd_shred_dest_idx_to_dest`](<fd_shred_dest.h.md#fd_shred_dest_idx_to_dest>)
    - [`refresh_sdest`](<#refresh_sdest>)
    - [`fd_shred_dest_cnt_staked`](<fd_shred_dest.h.md#fd_shred_dest_cnt_staked>)


---
### ci\_dest\_update\_impl<!-- {{#callable:ci_dest_update_impl}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.c#L428>)

Updates or adds a destination entry in the shred destination list based on the provided public key, IP address, and port.
- **Inputs**:
    - ``info``: A pointer to `fd_stake_ci_t` structure containing stake and destination information.
    - ``pubkey``: A constant pointer to `fd_pubkey_t` representing the public key of the destination.
    - ``ip4``: An unsigned integer representing the IPv4 address of the destination.
    - ``port``: An unsigned short representing the port number of the destination.
    - ``ei``: A pointer to `fd_per_epoch_info_t` structure containing per-epoch information.
- **Logic and Control Flow**:
    - Convert the public key to an index using [`fd_shred_dest_pubkey_to_idx`](<fd_shred_dest.c.md#fd_shred_dest_pubkey_to_idx>) function.
    - Check if the index is `FD_SHRED_DEST_NO_DEST`, indicating the destination does not exist.
    - If the destination does not exist, create a new entry with the provided public key, IP address, and port, and add it as an unstaked destination using [`ci_dest_add_one_unstaked`](<#ci_dest_add_one_unstaked>).
    - If the destination exists, update the IP address and port of the existing destination entry.
- **Output**: No return value; the function updates the destination list in place.
- **Functions Called**:
    - [`fd_shred_dest_pubkey_to_idx`](<fd_shred_dest.c.md#fd_shred_dest_pubkey_to_idx>)
    - [`ci_dest_add_one_unstaked`](<#ci_dest_add_one_unstaked>)
    - [`fd_shred_dest_idx_to_dest`](<fd_shred_dest.h.md#fd_shred_dest_idx_to_dest>)


---
### ci\_dest\_remove\_impl<!-- {{#callable:ci_dest_remove_impl}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.c#L445>)

Removes a destination entry from the list if it is not staked, otherwise retains its stale address.
- **Inputs**:
    - ``info``: A pointer to `fd_stake_ci_t` structure containing information about the current state.
    - ``pubkey``: A constant pointer to `fd_pubkey_t` representing the public key of the destination to remove.
    - ``ei``: A pointer to `fd_per_epoch_info_t` structure containing per-epoch information.
- **Logic and Control Flow**:
    - Convert the `pubkey` to an index using [`fd_shred_dest_pubkey_to_idx`](<fd_shred_dest.c.md#fd_shred_dest_pubkey_to_idx>) function.
    - If the index is `FD_SHRED_DEST_NO_DEST`, exit the function as there is no destination to remove.
    - Retrieve the destination entry using [`fd_shred_dest_idx_to_dest`](<fd_shred_dest.h.md#fd_shred_dest_idx_to_dest>).
    - If the destination's `stake_lamports` is greater than 0, exit the function as staked entries are not removed.
    - Iterate over all current destinations, skipping the one at the index to be removed, and copy the others to a temporary list.
    - Call [`refresh_sdest`](<#refresh_sdest>) to update the destination list with the new count.
- **Output**: No return value; the function modifies the destination list in place.
- **Functions Called**:
    - [`fd_shred_dest_pubkey_to_idx`](<fd_shred_dest.c.md#fd_shred_dest_pubkey_to_idx>)
    - [`fd_shred_dest_idx_to_dest`](<fd_shred_dest.h.md#fd_shred_dest_idx_to_dest>)
    - [`fd_shred_dest_cnt_all`](<fd_shred_dest.h.md#fd_shred_dest_cnt_all>)
    - [`refresh_sdest`](<#refresh_sdest>)
    - [`fd_shred_dest_cnt_staked`](<fd_shred_dest.h.md#fd_shred_dest_cnt_staked>)


---
### fd\_stake\_ci\_dest\_update<!-- {{#callable:fd_stake_ci_dest_update}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.c#L470>)

Updates the destination information for a given public key in two epoch information structures.
- **Inputs**:
    - ``info``: A pointer to an `fd_stake_ci_t` structure that contains epoch information and other related data.
    - ``pubkey``: A constant pointer to an `fd_pubkey_t` structure representing the public key whose destination information is to be updated.
    - ``ip4``: An unsigned integer representing the IPv4 address to be associated with the public key.
    - ``port``: An unsigned short representing the port number to be associated with the public key.
- **Logic and Control Flow**:
    - Calls [`ci_dest_update_impl`](<#ci_dest_update_impl>) with the provided `info`, `pubkey`, `ip4`, and `port`, along with the first epoch information (`info->epoch_info+0UL`).
    - Calls [`ci_dest_update_impl`](<#ci_dest_update_impl>) again with the same parameters, but with the second epoch information (`info->epoch_info+1UL`).
- **Output**: No return value; the function updates the destination information in the provided `fd_stake_ci_t` structure.
- **Functions Called**:
    - [`ci_dest_update_impl`](<#ci_dest_update_impl>)


---
### fd\_stake\_ci\_dest\_remove<!-- {{#callable:fd_stake_ci_dest_remove}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.c#L479>)

Removes a destination associated with a given public key from the current and next epoch information.
- **Inputs**:
    - ``info``: A pointer to an `fd_stake_ci_t` structure containing epoch information.
    - ``pubkey``: A constant pointer to an `fd_pubkey_t` structure representing the public key of the destination to remove.
- **Logic and Control Flow**:
    - Calls [`ci_dest_remove_impl`](<#ci_dest_remove_impl>) to remove the destination associated with `pubkey` from the current epoch (`info->epoch_info+0UL`).
    - Calls [`ci_dest_remove_impl`](<#ci_dest_remove_impl>) to remove the destination associated with `pubkey` from the next epoch (`info->epoch_info+1UL`).
- **Output**: No return value.
- **Functions Called**:
    - [`ci_dest_remove_impl`](<#ci_dest_remove_impl>)


---
### fd\_stake\_ci\_get\_sdest\_for\_slot<!-- {{#callable:fd_stake_ci_get_sdest_for_slot}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.c#L488>)

Retrieves the shred destination for a given slot from the stake information.
- **Inputs**:
    - ``info``: A pointer to a constant `fd_stake_ci_t` structure containing stake information.
    - ``slot``: An unsigned long integer representing the slot number for which the shred destination is requested.
- **Logic and Control Flow**:
    - Call [`fd_stake_ci_get_idx_for_slot`](<#fd_stake_ci_get_idx_for_slot>) with `info` and `slot` to get the index of the epoch information for the given slot.
    - Check if the returned index is not equal to `ULONG_MAX`.
    - If the index is valid, return the shred destination (`sdest`) from the epoch information at the given index.
    - If the index is `ULONG_MAX`, return `NULL`.
- **Output**: A pointer to `fd_shred_dest_t` if the slot is valid, otherwise `NULL`.
- **Functions Called**:
    - [`fd_stake_ci_get_idx_for_slot`](<#fd_stake_ci_get_idx_for_slot>)


---
### fd\_stake\_ci\_get\_lsched\_for\_slot<!-- {{#callable:fd_stake_ci_get_lsched_for_slot}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.c#L495>)

Retrieves the leader schedule for a given slot from the epoch information.
- **Inputs**:
    - ``info``: A pointer to a constant `fd_stake_ci_t` structure containing epoch information.
    - ``slot``: An unsigned long integer representing the slot number for which the leader schedule is requested.
- **Logic and Control Flow**:
    - Call [`fd_stake_ci_get_idx_for_slot`](<#fd_stake_ci_get_idx_for_slot>) with `info` and `slot` to get the index of the epoch information for the given slot.
    - Check if the returned index is not equal to `ULONG_MAX`.
    - If the index is valid, return the leader schedule (`lsched`) from the epoch information at the given index.
    - If the index is `ULONG_MAX`, return `NULL`.
- **Output**: A pointer to `fd_epoch_leaders_t` representing the leader schedule for the specified slot, or `NULL` if the slot is not found.
- **Functions Called**:
    - [`fd_stake_ci_get_idx_for_slot`](<#fd_stake_ci_get_idx_for_slot>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)