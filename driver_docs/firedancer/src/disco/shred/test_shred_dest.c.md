<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for the `fd_shred_dest` functionality, including performance, conformance, and error handling.

# Purpose
The code is a C test suite designed to validate the functionality of a system related to the distribution and management of "shreds" in a network. It includes several test functions that assess different aspects of the system, such as the computation of first and child destinations for shreds, the distribution of shreds in a tree structure, and the performance of these operations. The code imports binary data from external files, which are used as fixtures for testing. These fixtures include public keys, destination information, and peer data.

The test suite is structured to cover various scenarios, including error handling, stake variation, and performance benchmarking. It uses a combination of static assertions, memory alignment checks, and footprint calculations to ensure that the system operates within defined constraints. The tests are executed in the [`main`](<#main>) function, which initializes the system, runs the tests, and logs the results. The code is intended to be compiled and executed as a standalone program, providing a comprehensive set of tests to verify the correctness and efficiency of the shred distribution system.
# Imports and Dependencies

---
- `fd_shred_dest.h`


# Global Variables

---
### \_sd\_footprint
- **Type**: `uchar array`
- **Description**: An array of unsigned characters with a size defined by `TEST_MAX_FOOTPRINT`, which is 4 megabytes. The array is aligned according to `FD_SHRED_DEST_ALIGN`.
- **Use**: Used to store data related to shred destinations, likely for memory alignment and performance optimization in the context of the `fd_shred_dest` operations.


---
### \_l\_footprint
- **Type**: `uchar`
- **Description**: An array of unsigned characters with a size defined by `TEST_MAX_FOOTPRINT`, aligned to `FD_EPOCH_LEADERS_ALIGN`.
- **Use**: Used as a memory buffer for operations related to epoch leaders.


---
### stakes
- **Type**: `fd_vote_stake_weight_t[]`
- **Description**: An array of `fd_vote_stake_weight_t` structures, each representing a validator's stake information. Each element in the array contains fields for the validator's public key (`id_key`), vote key (`vote_key`), and the amount of stake in lamports (`stake`).
- **Use**: Stores stake information for up to `TEST_MAX_VALIDATORS` validators, used in various functions to compute and manage validator stakes and leader schedules.


---
### vote\_keyed\_lsched
- **Type**: ``const ulong``
- **Description**: A constant unsigned long integer initialized to zero.
- **Use**: Used as a parameter in functions related to leader scheduling and destination computation.


# Functions

---
### test\_compute\_first\_matches\_agave<!-- {{#callable:test_compute_first_matches_agave}} -->
[View Source →](<../../../../../src/disco/shred/test_shred_dest.c#L21>)

Tests the computation of the first matching shred destination against expected broadcast peers.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize `cnt` as the number of destination info entries and `info` and `src_key` as pointers to destination info and public key data, respectively.
    - Calculate the number of staked entries and populate the `stakes` array with public keys and stake lamports from `info`.
    - Verify that the memory footprint for shred destinations and epoch leaders is within the defined maximum footprint.
    - Create and join epoch leaders and shred destination objects using the initialized data.
    - Iterate over slots from 0 to 9999, checking if the leader for each slot matches the source key; if not, continue to the next slot.
    - For each matching slot, iterate over shred types and indices, compute the first destination, and verify the result against expected broadcast peers.
    - Ensure that the number of processed peers matches the size of the broadcast peers data.
    - Clean up by deleting and leaving the shred destination and epoch leaders objects.
- **Output**: No output is returned; the function performs tests and assertions to validate behavior.
- **Functions Called**:
    - [`fd_shred_dest_footprint`](<fd_shred_dest.c.md#fd_shred_dest_footprint>)
    - [`fd_shred_dest_join`](<fd_shred_dest.c.md#fd_shred_dest_join>)
    - [`fd_shred_dest_new`](<fd_shred_dest.c.md#fd_shred_dest_new>)
    - [`fd_shred_dest_compute_first`](<fd_shred_dest.c.md#fd_shred_dest_compute_first>)
    - [`fd_shred_dest_idx_to_dest`](<fd_shred_dest.h.md#fd_shred_dest_idx_to_dest>)
    - [`fd_shred_dest_delete`](<fd_shred_dest.c.md#fd_shred_dest_delete>)
    - [`fd_shred_dest_leave`](<fd_shred_dest.c.md#fd_shred_dest_leave>)


---
### test\_compute\_children\_matches\_agave<!-- {{#callable:test_compute_children_matches_agave}} -->
[View Source →](<../../../../../src/disco/shred/test_shred_dest.c#L74>)

Tests the computation of child destinations for shreds against expected results using Agave code.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calculate the number of destination entries from `t1_dest_info_sz` and `sizeof(fd_shred_dest_weighted_t)`.
    - Initialize `stakes` array with public keys and stakes from `info`, and calculate the total number of staked entries.
    - Verify that the memory footprint for shred destinations and epoch leaders is within `TEST_MAX_FOOTPRINT`.
    - Create and join epoch leaders and shred destination structures using `fd_epoch_leaders_new` and [`fd_shred_dest_new`](<fd_shred_dest.c.md#fd_shred_dest_new>).
    - Iterate over slots from 1 to 2000, incrementing by 97, and for each slot, iterate over shred types and indices to compute child destinations using [`fd_shred_dest_compute_children`](<fd_shred_dest.c.md#fd_shred_dest_compute_children>).
    - Compare computed results with expected results from `t1_retransmit_peers` and verify correctness using `FD_TEST`.
    - Clean up by deleting and leaving shred destination and epoch leaders structures.
- **Output**: No output is returned; the function performs tests and uses assertions to verify correctness.
- **Functions Called**:
    - [`fd_shred_dest_footprint`](<fd_shred_dest.c.md#fd_shred_dest_footprint>)
    - [`fd_shred_dest_join`](<fd_shred_dest.c.md#fd_shred_dest_join>)
    - [`fd_shred_dest_new`](<fd_shred_dest.c.md#fd_shred_dest_new>)
    - [`fd_shred_dest_compute_children`](<fd_shred_dest.c.md#fd_shred_dest_compute_children>)
    - [`fd_shred_dest_idx_to_dest`](<fd_shred_dest.h.md#fd_shred_dest_idx_to_dest>)
    - [`fd_shred_dest_delete`](<fd_shred_dest.c.md#fd_shred_dest_delete>)
    - [`fd_shred_dest_leave`](<fd_shred_dest.c.md#fd_shred_dest_leave>)


---
### test\_distribution\_is\_tree<!-- {{#callable:test_distribution_is_tree}} -->
[View Source →](<../../../../../src/disco/shred/test_shred_dest.c#L128>)

Validates that a distribution of shreds forms a tree structure by checking each source index against the leader and computing destinations accordingly.
- **Inputs**:
    - ``info``: A pointer to an array of `fd_shred_dest_weighted_t` structures containing information about the shred destinations.
    - ``cnt``: The number of elements in the `info` array.
    - ``lsched``: A pointer to an `fd_epoch_leaders_t` structure representing the leader schedule.
    - ``fanout``: The maximum number of children a node can have in the tree.
    - ``slot``: The slot number for which the distribution is being tested.
    - ``is_data``: An integer flag indicating whether the shred is data (`1`) or code (`0`).
    - ``idx``: The index of the shred within the slot.
- **Logic and Control Flow**:
    - Initialize an array `hit` to track visited nodes and arrays `out` and `shred` for processing shreds.
    - Set the `slot`, `variant`, and `idx` fields of the `shred` structure based on input parameters.
    - Retrieve the leader's public key for the given `slot` using `fd_epoch_leaders_get`.
    - Iterate over each source index from `0` to `cnt-1`.
    - For each source index, create a new shred destination using [`fd_shred_dest_new`](<fd_shred_dest.c.md#fd_shred_dest_new>) and join it with [`fd_shred_dest_join`](<fd_shred_dest.c.md#fd_shred_dest_join>).
    - If the source index's public key matches the leader's public key, compute the first destination using [`fd_shred_dest_compute_first`](<fd_shred_dest.c.md#fd_shred_dest_compute_first>) and mark the source index as visited.
    - If the source index is not the leader, compute the children destinations using [`fd_shred_dest_compute_children`](<fd_shred_dest.c.md#fd_shred_dest_compute_children>).
    - For each computed destination, check if it is valid and mark it as visited.
    - Delete the shred destination using [`fd_shred_dest_delete`](<fd_shred_dest.c.md#fd_shred_dest_delete>) and leave it using [`fd_shred_dest_leave`](<fd_shred_dest.c.md#fd_shred_dest_leave>).
    - After processing all source indices, verify that all indices have been visited by checking the `hit` array.
- **Output**: No return value; the function uses assertions to validate the tree structure of the distribution.
- **Functions Called**:
    - [`fd_shred_dest_join`](<fd_shred_dest.c.md#fd_shred_dest_join>)
    - [`fd_shred_dest_new`](<fd_shred_dest.c.md#fd_shred_dest_new>)
    - [`fd_shred_dest_compute_first`](<fd_shred_dest.c.md#fd_shred_dest_compute_first>)
    - [`fd_shred_dest_compute_children`](<fd_shred_dest.c.md#fd_shred_dest_compute_children>)
    - [`fd_shred_dest_delete`](<fd_shred_dest.c.md#fd_shred_dest_delete>)
    - [`fd_shred_dest_leave`](<fd_shred_dest.c.md#fd_shred_dest_leave>)


---
### test\_batching<!-- {{#callable:test_batching}} -->
[View Source →](<../../../../../src/disco/shred/test_shred_dest.c#L175>)

Simulates and tests the batching of shreds for different leader and non-leader scenarios over multiple iterations.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initializes a random number generator `r` using `fd_rng_new` and `fd_rng_join`.
    - Sets up an array `info` of `fd_shred_dest_weighted_t` structures with 32 elements, initializing them to zero using `fd_memset`.
    - Iterates 1000 times to simulate different scenarios.
    - In each iteration, assigns random stakes to the `info` array and updates the `stakes` array accordingly.
    - Creates a leader schedule `lsched` using `fd_epoch_leaders_new` and `fd_epoch_leaders_join`.
    - Creates a shred destination `sdest` using [`fd_shred_dest_new`](<fd_shred_dest.c.md#fd_shred_dest_new>) and [`fd_shred_dest_join`](<fd_shred_dest.c.md#fd_shred_dest_join>).
    - Defines a batch count `BATCH_CNT` of 5 and initializes result arrays `result1` and `result2` with specific values.
    - Iterates over slots from 0 to 100 in steps of 4, setting up shreds with random indices and variants.
    - Checks if the current slot leader matches the source key `src_key`.
    - If not a leader, computes children destinations using [`fd_shred_dest_compute_children`](<fd_shred_dest.c.md#fd_shred_dest_compute_children>) and verifies results.
    - If a leader, computes first destinations using [`fd_shred_dest_compute_first`](<fd_shred_dest.c.md#fd_shred_dest_compute_first>) and verifies results.
    - Deletes the shred destination and leader schedule at the end of each iteration.
- **Output**: No output is returned as the function is void and primarily used for testing purposes.
- **Functions Called**:
    - [`fd_shred_dest_join`](<fd_shred_dest.c.md#fd_shred_dest_join>)
    - [`fd_shred_dest_new`](<fd_shred_dest.c.md#fd_shred_dest_new>)
    - [`fd_shred_dest_compute_children`](<fd_shred_dest.c.md#fd_shred_dest_compute_children>)
    - [`fd_shred_dest_compute_first`](<fd_shred_dest.c.md#fd_shred_dest_compute_first>)
    - [`fd_shred_dest_delete`](<fd_shred_dest.c.md#fd_shred_dest_delete>)
    - [`fd_shred_dest_leave`](<fd_shred_dest.c.md#fd_shred_dest_leave>)


---
### test\_vary\_stake<!-- {{#callable:test_vary_stake}} -->
[View Source →](<../../../../../src/disco/shred/test_shred_dest.c#L235>)

Simulates varying stake distributions and tests the distribution of shred destinations in a leader schedule.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initializes a random number generator `r` using `fd_rng_new` and `fd_rng_join`.
    - Sets up an array `info` of `fd_shred_dest_weighted_t` with 32 elements, initialized to zero using `fd_memset`.
    - Iterates 1000 times to simulate different stake distributions.
    - In each iteration, generates random stakes for shred destinations, ensuring they are non-increasing and some are zero.
    - Logs the iteration number and the count of staked destinations every 100 iterations.
    - Generates a separate set of stakes for the leader schedule, ensuring all are positive.
    - Creates a leader schedule `lsched` using `fd_epoch_leaders_new` and `fd_epoch_leaders_join`.
    - Calls [`test_distribution_is_tree`](<#test_distribution_is_tree>) to verify the distribution of shred destinations in the leader schedule.
    - Deletes the leader schedule using `fd_epoch_leaders_delete` and `fd_epoch_leaders_leave`.
    - Deletes the random number generator `r` using `fd_rng_delete` and `fd_rng_leave`.
- **Output**: No output is returned as the function is `void` and primarily performs testing and logging.
- **Functions Called**:
    - [`test_distribution_is_tree`](<#test_distribution_is_tree>)


---
### test\_t1\_vary\_radix<!-- {{#callable:test_t1_vary_radix}} -->
[View Source →](<../../../../../src/disco/shred/test_shred_dest.c#L278>)

Tests the distribution of shred destinations with varying fanout values using a random number generator and leader schedule.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize a random number generator `r` using `fd_rng_new` and `fd_rng_join`.
    - Calculate the number of staked validators by iterating over `t1_dest_info` and summing up non-zero `stake_lamports`.
    - Create a leader schedule `lsched` using `fd_epoch_leaders_new` and `fd_epoch_leaders_join` with the calculated staked validators.
    - Iterate over fanout values from 35 to 649 in steps of 11.
    - For each fanout value, log the fanout and call [`test_distribution_is_tree`](<#test_distribution_is_tree>) with the current fanout and random values for slot, data type, and index.
    - Delete the leader schedule `lsched` using `fd_epoch_leaders_leave` and `fd_epoch_leaders_delete`.
    - Delete the random number generator `r` using `fd_rng_leave` and `fd_rng_delete`.
- **Output**: No output is returned as the function is of type `void`.
- **Functions Called**:
    - [`test_distribution_is_tree`](<#test_distribution_is_tree>)


---
### test\_change\_contact<!-- {{#callable:test_change_contact}} -->
[View Source →](<../../../../../src/disco/shred/test_shred_dest.c#L301>)

Tests the ability to change the IP address of a shred destination and verifies the change.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calculate the number of destination entries by dividing `t1_dest_info_sz` by the size of `fd_shred_dest_weighted_t`.
    - Initialize a pointer `info` to the destination information and a pointer `src_key` to the source public key.
    - Initialize `staked` to zero and iterate over each destination entry to populate the `stakes` array and count the number of staked entries.
    - Create an epoch leaders schedule `lsched` using `fd_epoch_leaders_new` and join it with `fd_epoch_leaders_join`.
    - Create a shred destination `sdest` using [`fd_shred_dest_new`](<fd_shred_dest.c.md#fd_shred_dest_new>) and join it with [`fd_shred_dest_join`](<fd_shred_dest.c.md#fd_shred_dest_join>).
    - Set the IP address of the first destination to 12 and verify the change using `FD_TEST`.
    - Change the IP address of the first destination to 14 and verify the change using `FD_TEST`.
    - Delete the shred destination and epoch leaders schedule using [`fd_shred_dest_delete`](<fd_shred_dest.c.md#fd_shred_dest_delete>) and `fd_epoch_leaders_delete`.
- **Output**: No output is returned; the function performs tests and uses assertions to verify behavior.
- **Functions Called**:
    - [`fd_shred_dest_join`](<fd_shred_dest.c.md#fd_shred_dest_join>)
    - [`fd_shred_dest_new`](<fd_shred_dest.c.md#fd_shred_dest_new>)
    - [`fd_shred_dest_idx_to_dest`](<fd_shred_dest.h.md#fd_shred_dest_idx_to_dest>)
    - [`fd_shred_dest_delete`](<fd_shred_dest.c.md#fd_shred_dest_delete>)
    - [`fd_shred_dest_leave`](<fd_shred_dest.c.md#fd_shred_dest_leave>)


---
### test\_errors<!-- {{#callable:test_errors}} -->
[View Source →](<../../../../../src/disco/shred/test_shred_dest.c#L327>)

Validates error handling in the creation and joining of `fd_shred_dest` and `fd_epoch_leaders` objects.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls [`fd_shred_dest_new`](<fd_shred_dest.c.md#fd_shred_dest_new>) with `NULL` parameters and checks if it returns `NULL` using `FD_TEST`.
    - Initializes `stakes[0]` with specific values and sets `stake` to `100UL`.
    - Retrieves a public key from `t1_pubkey` and assigns it to `src_key`.
    - Creates a new `fd_epoch_leaders` object with specific parameters and joins it using `fd_epoch_leaders_join`.
    - Attempts to create and join a `fd_shred_dest` object with the newly created `lsched` and checks if it returns `NULL` using `FD_TEST`.
    - Deletes the `fd_epoch_leaders` object after the test.
- **Output**: No output is returned; the function uses assertions to validate conditions.
- **Functions Called**:
    - [`fd_shred_dest_new`](<fd_shred_dest.c.md#fd_shred_dest_new>)
    - [`fd_shred_dest_join`](<fd_shred_dest.c.md#fd_shred_dest_join>)


---
### test\_indeterminate<!-- {{#callable:test_indeterminate}} -->
[View Source →](<../../../../../src/disco/shred/test_shred_dest.c#L343>)

Simulates and tests the behavior of a system with full and truncated leader schedules and destination computations, logging the results of matches and unmatched destinations.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize a random number generator `r` using `fd_rng_new` and `fd_rng_join`.
    - Calculate the number of staked entries `staked_cnt` from `t1_dest_info` and populate the `stakes` array with public keys and stakes.
    - Calculate `truncated_cnt` as 99.5% of `staked_cnt` and compute `excluded_stake` for entries beyond `truncated_cnt`.
    - Allocate memory for full and truncated leader schedules using `_l_footprint` and verify memory constraints with `FD_TEST`.
    - Create full and truncated leader schedules `lsched_full` and `lsched_trunc` using `fd_epoch_leaders_new` and `fd_epoch_leaders_join`.
    - Allocate memory for full and truncated shred destinations using `_sd_footprint` and verify memory constraints with `FD_TEST`.
    - Iterate 5000 times to simulate the process of selecting a source public key and creating shred destinations for full and truncated schedules.
    - For each iteration, randomly select a source public key and create shred destinations `sdest_full` and `sdest_trunc`.
    - Randomly select a slot and fanout value, and check if `sdest_trunc` is NULL to update `no_dest_cnt`.
    - Determine the leader for the selected slot and create a shred with random attributes.
    - Compute destination indices for full and truncated schedules using [`fd_shred_dest_compute_first`](<fd_shred_dest.c.md#fd_shred_dest_compute_first>) or [`fd_shred_dest_compute_children`](<fd_shred_dest.c.md#fd_shred_dest_compute_children>).
    - Compare the computed destination indices for full and truncated schedules, updating `match_cnt` and `no_dest_cnt` accordingly.
    - Log the number of matched and unmatched destinations using `FD_LOG_NOTICE`.
    - Clean up by deleting shred destinations and leader schedules, and releasing the random number generator.
- **Output**: Logs the number of matched and unmatched destinations due to truncation.
- **Functions Called**:
    - [`fd_shred_dest_footprint`](<fd_shred_dest.c.md#fd_shred_dest_footprint>)
    - [`fd_shred_dest_join`](<fd_shred_dest.c.md#fd_shred_dest_join>)
    - [`fd_shred_dest_new`](<fd_shred_dest.c.md#fd_shred_dest_new>)
    - [`fd_shred_dest_compute_first`](<fd_shred_dest.c.md#fd_shred_dest_compute_first>)
    - [`fd_shred_dest_compute_children`](<fd_shred_dest.c.md#fd_shred_dest_compute_children>)
    - [`fd_shred_dest_delete`](<fd_shred_dest.c.md#fd_shred_dest_delete>)
    - [`fd_shred_dest_leave`](<fd_shred_dest.c.md#fd_shred_dest_leave>)


---
### test\_performance<!-- {{#callable:test_performance}} -->
[View Source →](<../../../../../src/disco/shred/test_shred_dest.c#L445>)

Measures the performance of computing shred destinations using different batch sizes.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calculate `cnt` as the size of `testnet_dest_info` divided by the size of `fd_shred_dest_weighted_t`.
    - Set `info` to point to `testnet_dest_info`.
    - Set `src_key` to the public key of the 18th element in `info`.
    - Verify that `cnt` is less than or equal to `TEST_MAX_VALIDATORS`.
    - Initialize `staked` to zero and iterate over `info` to populate `stakes` and count non-zero stakes.
    - Verify that the footprint of shred destinations and epoch leaders is within `TEST_MAX_FOOTPRINT`.
    - Measure the time to create and join `fd_epoch_leaders_t` and `fd_shred_dest_t` objects.
    - Initialize `shred` and `shred_ptr` arrays for 16 shreds with different variants.
    - Measure the time to compute children for 1 shred per batch over `TEST_CNT` iterations and log the result.
    - Measure the time to compute children for 16 shreds per batch over `TEST_CNT` iterations and log the result.
- **Output**: Logs the performance results of computing shred destinations for different batch sizes.
- **Functions Called**:
    - [`fd_shred_dest_footprint`](<fd_shred_dest.c.md#fd_shred_dest_footprint>)
    - [`fd_shred_dest_join`](<fd_shred_dest.c.md#fd_shred_dest_join>)
    - [`fd_shred_dest_new`](<fd_shred_dest.c.md#fd_shred_dest_new>)
    - [`fd_shred_dest_compute_children`](<fd_shred_dest.c.md#fd_shred_dest_compute_children>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/disco/shred/test_shred_dest.c#L501>)

Initializes the environment, runs a series of tests on the system, and then halts the program.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Verifies alignment of `fd_shred_dest` using `FD_TEST`.
    - Executes [`test_errors`](<#test_errors>) to check for error conditions.
    - Logs a notice and runs [`test_compute_first_matches_agave`](<#test_compute_first_matches_agave>) and [`test_compute_children_matches_agave`](<#test_compute_children_matches_agave>) to test conformance with Agave code.
    - Logs a notice and runs [`test_vary_stake`](<#test_vary_stake>) to test varying stake conditions.
    - Logs a notice and runs [`test_t1_vary_radix`](<#test_t1_vary_radix>) to test varying radix conditions.
    - Logs a notice and runs [`test_batching`](<#test_batching>) to test batching functionality.
    - Logs a notice and runs [`test_change_contact`](<#test_change_contact>) to test contact change functionality.
    - Logs a notice and runs [`test_indeterminate`](<#test_indeterminate>) to test indeterminate conditions.
    - Logs a notice and runs [`test_performance`](<#test_performance>) to test performance metrics.
    - Logs a final notice indicating all tests passed.
    - Calls `fd_halt` to halt the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`fd_shred_dest_align`](<fd_shred_dest.h.md#fd_shred_dest_align>)
    - [`test_errors`](<#test_errors>)
    - [`test_compute_first_matches_agave`](<#test_compute_first_matches_agave>)
    - [`test_compute_children_matches_agave`](<#test_compute_children_matches_agave>)
    - [`test_vary_stake`](<#test_vary_stake>)
    - [`test_t1_vary_radix`](<#test_t1_vary_radix>)
    - [`test_batching`](<#test_batching>)
    - [`test_change_contact`](<#test_change_contact>)
    - [`test_indeterminate`](<#test_indeterminate>)
    - [`test_performance`](<#test_performance>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)