<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Handles leader schedules and shred destinations across epoch boundaries, with APIs for stake updates.

# Purpose
The `fd_stake_ci.h` file is a C header file that provides functionality for managing leader schedules and shred destinations in a blockchain context, specifically handling the complexities associated with epoch transitions. It defines structures and functions to manage stake delegation changes and their effects on leader schedules and shred destinations across different epochs. The file includes definitions for `fd_stake_ci_t` and `fd_per_epoch_info_t` structures, which store information about epochs, slots, and stake weights. These structures help in determining the leader and shred destination for a given slot, taking into account the necessary epoch-specific adjustments.

The header file also provides a set of APIs for different broadcasting regimes used in blockchain networks, such as Frankendancer and Firedancer. These APIs handle stake weight updates and contact information updates, allowing for the management of shred destinations and leader schedules. Functions like [`fd_stake_ci_stake_msg_init`](<#fd_stake_ci_stake_msg_init>), [`fd_stake_ci_stake_msg_fini`](<#fd_stake_ci_stake_msg_fini>), [`fd_stake_ci_dest_add_init`](<#fd_stake_ci_dest_add_init>), and [`fd_stake_ci_dest_add_fini`](<#fd_stake_ci_dest_add_fini>) are used to process messages related to stake weights and contact information. Additionally, the file includes utility functions for memory management, such as [`fd_stake_ci_new`](<#fd_stake_ci_new>), [`fd_stake_ci_join`](<#fd_stake_ci_join>), [`fd_stake_ci_leave`](<#fd_stake_ci_leave>), and [`fd_stake_ci_delete`](<#fd_stake_ci_delete>), which manage the lifecycle of the `fd_stake_ci_t` structure. The file also provides functions to query leader schedules and shred destinations for specific slots, ensuring that the correct data is used for each slot based on the epoch-specific adjustments.
# Imports and Dependencies

---
- `fd_shred_dest.h`
- `../../flamenco/leaders/fd_leaders.h`


# Data Structures

---
### fd\_per\_epoch\_info\_private
- **Type**: ``struct``
- **Members**:
    - `epoch`: Stores the epoch number for which the data is valid.
    - `start_slot`: Indicates the starting slot number of the epoch.
    - `slot_cnt`: Specifies the number of slots in the epoch.
    - `excluded_stake`: Holds the amount of stake that is excluded.
    - `vote_keyed_lsched`: Contains the vote-keyed leader schedule.
    - `lsched`: Pointer to the leader schedule data structure.
    - `sdest`: Pointer to the shred destination data structure.
    - `_lsched`: Memory buffer for the leader schedule, aligned to `FD_EPOCH_LEADERS_ALIGN`.
    - `_sdest`: Memory buffer for the shred destination, aligned to `FD_SHRED_DEST_ALIGN`.
- **Description**: Represents information specific to an epoch, including leader schedules and shred destinations, valid for a defined range of slots. The structure contains pointers to leader schedule and shred destination data, along with memory buffers for these data structures. It ensures that the data is valid for the specified epoch and slot range, and it manages memory alignment for efficient access.


---
### fd\_per\_epoch\_info\_t
- **Type**: ``struct``
- **Members**:
    - ``epoch``: Stores the epoch number for which the leader schedule and shred destinations are valid.
    - ``start_slot``: Indicates the starting slot number of the epoch.
    - ``slot_cnt``: Specifies the number of slots in the epoch.
    - ``excluded_stake``: Holds the amount of stake that is excluded from the leader schedule.
    - ``vote_keyed_lsched``: Contains the vote-keyed leader schedule.
    - ``lsched``: Pointer to the leader schedule data for the epoch.
    - ``sdest``: Pointer to the shred destination data for the epoch.
    - ``_lsched``: Memory buffer aligned for leader schedule data storage.
    - ``_sdest``: Memory buffer aligned for shred destination data storage.
- **Description**: `fd_per_epoch_info_t` is a structure that encapsulates information relevant to a specific epoch, including the epoch number, the range of slots it covers, and associated leader schedule and shred destination data. It includes pointers to leader schedule and shred destination structures, as well as aligned memory buffers for storing this data. The structure is used to manage and query leader schedules and shred destinations within the specified epoch.


---
### fd\_stake\_ci
- **Type**: ``struct``
- **Members**:
    - ``identity_key``: An array of one `fd_pubkey_t` representing the identity key.
    - ``scratch``: A temporary storage structure used between specific initialization and finalization functions.
    - ``vote_stake_weight``: An array of `fd_vote_stake_weight_t` for storing vote-based stake weights.
    - ``stake_weight``: An array of `fd_stake_weight_t` for storing identity-based stake weights.
    - ``shred_dest``: An array of `fd_shred_dest_weighted_t` for storing weighted shred destinations.
    - ``shred_dest_temp``: A temporary array of `fd_shred_dest_weighted_t` for intermediate processing.
    - ``epoch_info``: An array of two `fd_per_epoch_info_t` structures for storing epoch-specific information.
- **Description**: Manages leader schedules and shred destinations specific to epochs, handling complexities around stake delegation changes and their effects on leader schedules and shred destinations across epoch boundaries.


---
### fd\_stake\_ci\_t
- **Type**: ``struct``
- **Members**:
    - ``identity_key``: An array containing the public key of the local validator's identity keypair.
    - ``scratch``: A temporary storage structure used during stake message and destination addition operations.
    - ``vote_stake_weight``: An array storing the vote-based stake weights for each shred destination.
    - ``stake_weight``: An array storing the identity-based stake weights for each shred destination.
    - ``shred_dest``: An array storing the weighted shred destinations.
    - ``shred_dest_temp``: A temporary array for storing shred destinations during updates.
    - ``epoch_info``: An array storing information about the current and previous epochs.
- **Description**: Manages leader schedules and shred destinations, handling complexities around epoch boundaries and stake delegation changes. It stores identity keys, temporary data for stake and destination updates, and maintains arrays for vote-based and identity-based stake weights, as well as shred destinations. It also keeps track of epoch-specific information to ensure accurate leader and shred destination computations.


# Functions

---
### fd\_stake\_ci\_footprint<!-- {{#callable:fd_stake_ci_footprint}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.h#L81>)

Returns the memory footprint size of the `fd_stake_ci_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calculate the size of the `fd_stake_ci_t` structure using the `sizeof` operator.
    - Return the calculated size as an unsigned long integer.
- **Output**: The function returns an unsigned long integer representing the size of the `fd_stake_ci_t` structure.


---
### fd\_stake\_ci\_align<!-- {{#callable:fd_stake_ci_align}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.h#L82>)

Returns the alignment requirement of the `fd_stake_ci_t` type.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `alignof` to determine the alignment requirement of `fd_stake_ci_t`.
    - Returns the result of `alignof(fd_stake_ci_t)`.
- **Output**: An `ulong` representing the alignment requirement of `fd_stake_ci_t`.


# Function Declarations (Public API)

---
### fd\_stake\_ci\_new<!-- {{#callable_declaration:fd_stake_ci_new}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.h#L90>)

Formats memory as a stake contact information store.
- **Description**: Use this function to initialize a memory region as a stake contact information store, which is necessary for managing leader schedules and shred destinations. This function requires a pointer to a memory region and a public key for the local validator's identity. The function does not retain any interest in the identity key after execution. Ensure that the memory region is properly aligned and has sufficient size to accommodate the data structure.
- **Inputs**:
    - `mem`: A pointer to a memory region that will be formatted as a stake contact information store. The memory must be properly aligned and large enough to hold the data structure. The caller retains ownership.
    - `identity_key`: A pointer to a constant `fd_pubkey_t` representing the public key of the local validator's identity keypair. Must not be null. The function does not retain a read interest in this key after execution.
- **Output**: Returns a pointer to the initialized memory region formatted as a stake contact information store.
- **See Also**: [`fd_stake_ci_new`](<fd_stake_ci.c.md#fd_stake_ci_new>)  (Implementation)


---
### fd\_stake\_ci\_join<!-- {{#callable_declaration:fd_stake_ci_join}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.h#L91>)

Casts a memory region to a `fd_stake_ci_t` pointer.
- **Description**: Use this function to interpret a given memory region as a `fd_stake_ci_t` structure. This is typically done after the memory has been properly initialized to hold a `fd_stake_ci_t` object. Ensure that the memory region is correctly aligned and has the appropriate size for a `fd_stake_ci_t` before calling this function. This function does not perform any validation or initialization of the memory content.
- **Inputs**:
    - `mem`: A pointer to a memory region that is expected to be formatted as a `fd_stake_ci_t`. The caller must ensure that this memory is correctly aligned and sized. The function does not check for null pointers or validate the memory content.
- **Output**: Returns a pointer to the `fd_stake_ci_t` structure located at the given memory address.
- **See Also**: [`fd_stake_ci_join`](<fd_stake_ci.c.md#fd_stake_ci_join>)  (Implementation)


---
### fd\_stake\_ci\_leave<!-- {{#callable_declaration:fd_stake_ci_leave}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.h#L93>)

Returns a pointer to the given stake contact information structure.
- **Description**: Use this function to obtain a generic pointer to a `fd_stake_ci_t` structure. This can be useful when you need to pass the structure to functions that expect a `void*` type. Ensure that the `info` parameter is a valid pointer to a `fd_stake_ci_t` structure before calling this function. The function does not modify the input structure or manage its memory.
- **Inputs**:
    - `info`: A pointer to a `fd_stake_ci_t` structure. Must not be null. The caller retains ownership and responsibility for the memory management of this structure.
- **Output**: Returns a `void*` pointer to the `fd_stake_ci_t` structure provided in the `info` parameter.
- **See Also**: [`fd_stake_ci_leave`](<fd_stake_ci.c.md#fd_stake_ci_leave>)  (Implementation)


---
### fd\_stake\_ci\_delete<!-- {{#callable_declaration:fd_stake_ci_delete}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.h#L94>)

Returns the provided memory pointer without modification.
- **Description**: Use this function to release or delete a stake contact information store when it is no longer needed. It is important to ensure that the memory region pointed to by the input parameter is valid and was previously allocated for this purpose. This function does not perform any deallocation or memory management operations; it simply returns the input pointer.
- **Inputs**:
    - `mem`: A pointer to a memory region that represents a stake contact information store. The pointer must be valid and previously allocated. The function does not modify or deallocate the memory.
- **Output**: Returns the same pointer that was provided as input.
- **See Also**: [`fd_stake_ci_delete`](<fd_stake_ci.c.md#fd_stake_ci_delete>)  (Implementation)


---
### fd\_stake\_ci\_stake\_msg\_init<!-- {{#callable_declaration:fd_stake_ci_stake_msg_init}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.h#L158>)

Initializes stake message data in the stake contact information structure.
- **Description**: Use this function to initialize the stake message data in the `fd_stake_ci_t` structure with the information from a `fd_stake_weight_msg_t` message. This function must be called before any stake message finalization function. It ensures that the stake message data is correctly set up for further processing. The function checks if the number of stakes in the message exceeds the maximum allowed and logs an error if it does.
- **Inputs**:
    - `info`: A pointer to an `fd_stake_ci_t` structure where the stake message data will be initialized. Must not be null. The caller retains ownership.
    - `msg`: A pointer to a constant `fd_stake_weight_msg_t` structure containing the stake message data to initialize. Must not be null. The `staked_cnt` field must not exceed `MAX_SHRED_DESTS`, otherwise an error is logged.
- **Output**: None
- **See Also**: [`fd_stake_ci_stake_msg_init`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_init>)  (Implementation)


---
### fd\_stake\_ci\_stake\_msg\_fini<!-- {{#callable_declaration:fd_stake_ci_stake_msg_fini}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.h#L159>)

Finalizes the processing of stake weight updates.
- **Description**: Use this function to complete the processing of stake weight updates after calling `fd_stake_ci_stake_msg_init`. It updates the shred destinations and leader schedules based on the new stake information. This function must be called when the stake contact info is in stake-msg-pending mode. It ensures that the shred destination list is updated with both staked and unstaked nodes, maintaining the correct order and removing nodes without contact info. Call this function to apply the changes and prepare the system for the next epoch.
- **Inputs**:
    - `info`: A pointer to an `fd_stake_ci_t` structure. This must not be null and must be in stake-msg-pending mode. The caller retains ownership.
- **Output**: None
- **See Also**: [`fd_stake_ci_stake_msg_fini`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_fini>)  (Implementation)


---
### fd\_stake\_ci\_dest\_add\_init<!-- {{#callable_declaration:fd_stake_ci_dest_add_init}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.h#L160>)

Returns a pointer to the shred destination array for modification.
- **Description**: Use this function to obtain a pointer to the shred destination array within the `fd_stake_ci_t` structure. This pointer allows you to modify the array with additional information, such as MAC addresses, before finalizing the update with `fd_stake_ci_dest_add_fini`. Ensure that the `fd_stake_ci_t` structure is properly initialized and that this function is called before `fd_stake_ci_dest_add_fini`. The function does not change the mode of the stake contact info object, and it is safe to call multiple times without calling `fini` in between.
- **Inputs**:
    - `info`: A pointer to an `fd_stake_ci_t` structure. Must not be null. The caller retains ownership and is responsible for ensuring the structure is initialized.
- **Output**: Returns a pointer to the first element of the `shred_dest` array within the `fd_stake_ci_t` structure, which can be modified by the caller.
- **See Also**: [`fd_stake_ci_dest_add_init`](<fd_stake_ci.c.md#fd_stake_ci_dest_add_init>)  (Implementation)


---
### fd\_stake\_ci\_dest\_add\_fini<!-- {{#callable_declaration:fd_stake_ci_dest_add_fini}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.h#L161>)

Finalizes the addition of shred destinations.
- **Description**: Use this function to complete the process of adding shred destinations after calling `fd_stake_ci_dest_add_init`. It ensures that the local validator is included in the list of shred destinations if it was not already present. This function must be called after `fd_stake_ci_dest_add_init` and before any other operation that modifies the shred destinations. It updates the shred destination information for the current and next epoch.
- **Inputs**:
    - `info`: A pointer to an `fd_stake_ci_t` structure. This must not be null and must point to a valid stake contact information store that is in dest-add-pending mode.
    - `cnt`: The number of elements in the shred destination array that were populated. Must be in the range 0 to `MAX_SHRED_DESTS` - 1. If `cnt` is invalid, the behavior is undefined.
- **Output**: None
- **See Also**: [`fd_stake_ci_dest_add_fini`](<fd_stake_ci.c.md#fd_stake_ci_dest_add_fini>)  (Implementation)


---
### fd\_stake\_ci\_dest\_update<!-- {{#callable_declaration:fd_stake_ci_dest_update}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.h#L172>)

Updates or adds a shred destination entry.
- **Description**: Use this function to update or add a shred destination entry for a given public key, IP address, and port. This function is part of the Firedancer's Gossip update model, which handles individual contact info updates. Ensure that the IP address is in network byte order and the port is in host byte order. Both the IP address and port must be non-zero. This function should be called when you need to modify the contact information for a specific node in the network.
- **Inputs**:
    - `info`: A pointer to an `fd_stake_ci_t` structure. This must not be null and should be properly initialized before calling this function. The caller retains ownership.
    - `pubkey`: A pointer to a constant `fd_pubkey_t` structure representing the public key of the node. This must not be null. The caller retains ownership.
    - `ip4`: An unsigned integer representing the IPv4 address in network byte order. Must be non-zero.
    - `port`: An unsigned short representing the port number in host byte order. Must be non-zero.
- **Output**: None
- **See Also**: [`fd_stake_ci_dest_update`](<fd_stake_ci.c.md#fd_stake_ci_dest_update>)  (Implementation)


---
### fd\_stake\_ci\_dest\_remove<!-- {{#callable_declaration:fd_stake_ci_dest_remove}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.h#L173>)

Removes a shred destination entry for a given public key.
- **Description**: Use this function to remove a shred destination entry associated with a specific public key from the stake contact information. This operation is part of the Firedancer's Gossip update model, which handles individual contact info updates. Ensure that the `info` structure is properly initialized and that the `pubkey` is valid before calling this function. This function does not return a value and does not indicate if the removal was successful or if the entry was not found.
- **Inputs**:
    - `info`: A pointer to an `fd_stake_ci_t` structure that contains the stake contact information. Must not be null. The caller retains ownership.
    - `pubkey`: A pointer to a constant `fd_pubkey_t` structure representing the public key of the shred destination to remove. Must not be null. The caller retains ownership.
- **Output**: None
- **See Also**: [`fd_stake_ci_dest_remove`](<fd_stake_ci.c.md#fd_stake_ci_dest_remove>)  (Implementation)


---
### fd\_stake\_ci\_set\_identity<!-- {{#callable_declaration:fd_stake_ci_set_identity}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.h#L178>)

Changes the identity of the local validator at runtime.
- **Description**: Use this function to update the identity key of a local validator. This function modifies the shred destinations to reflect the new identity. It must be called when the validator's identity changes, ensuring that the new identity is correctly integrated into the system. The function handles the case where the new identity is not already present in the shred destinations, adding it as an unstaked validator if necessary. Ensure that the `info` structure is properly initialized before calling this function.
- **Inputs**:
    - `info`: A pointer to an `fd_stake_ci_t` structure representing the stake contact information. Must not be null. The caller retains ownership.
    - `identity_key`: A pointer to a constant `fd_pubkey_t` representing the new identity key. Must not be null. The caller retains ownership.
- **Output**: None
- **See Also**: [`fd_stake_ci_set_identity`](<fd_stake_ci.c.md#fd_stake_ci_set_identity>)  (Implementation)


---
### fd\_stake\_ci\_get\_sdest\_for\_slot<!-- {{#callable_declaration:fd_stake_ci_get_sdest_for_slot}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.h#L194>)

Retrieves the shred destination for a specified slot.
- **Description**: Use this function to obtain the shred destination associated with a specific slot. This is useful when you need to determine where to send or retrieve shreds for a given slot. The function requires a valid `fd_stake_ci_t` structure that contains epoch-specific information. If the slot information is not available, the function returns `NULL`. Ensure that the `fd_stake_ci_t` structure is properly initialized and contains up-to-date epoch information before calling this function.
- **Inputs**:
    - `info`: A pointer to a constant `fd_stake_ci_t` structure. This structure must be initialized and contain valid epoch information. The caller retains ownership and must ensure it is not null.
    - `slot`: An unsigned long integer representing the slot for which the shred destination is requested. There are no specific constraints on the value, but it should correspond to a valid slot within the epoch information contained in `info`.
- **Output**: Returns a pointer to an `fd_shred_dest_t` structure if the shred destination for the specified slot is available; otherwise, returns `NULL`.
- **See Also**: [`fd_stake_ci_get_sdest_for_slot`](<fd_stake_ci.c.md#fd_stake_ci_get_sdest_for_slot>)  (Implementation)


---
### fd\_stake\_ci\_get\_lsched\_for\_slot<!-- {{#callable_declaration:fd_stake_ci_get_lsched_for_slot}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.h#L195>)

Retrieves the leader schedule for a specified slot.
- **Description**: Use this function to obtain the leader schedule associated with a specific slot. This is useful when you need to determine the leader for a given slot without manually adjusting for epoch boundaries. The function returns a pointer to the leader schedule if available, or NULL if the information for the specified slot is not present. Ensure that the `info` parameter is properly initialized before calling this function.
- **Inputs**:
    - `info`: A pointer to a constant `fd_stake_ci_t` structure containing the stake contact information. Must not be null and should be properly initialized.
    - `slot`: An unsigned long integer representing the slot for which the leader schedule is requested. There are no specific constraints on the value, but it should be within the range of slots managed by the `info` structure.
- **Output**: Returns a pointer to an `fd_epoch_leaders_t` structure containing the leader schedule for the specified slot, or NULL if the schedule is not available.
- **See Also**: [`fd_stake_ci_get_lsched_for_slot`](<fd_stake_ci.c.md#fd_stake_ci_get_lsched_for_slot>)  (Implementation)


---
### compute\_id\_weights\_from\_vote\_weights<!-- {{#callable_declaration:compute_id_weights_from_vote_weights}} -->
[View Source →](<../../../../../src/disco/shred/fd_stake_ci.h#L229>)

Converts vote-based stake weights to identity-based stake weights.
- **Description**: Use this function to translate vote-based stake weights into identity-based stake weights, which are necessary for certain operations like building the Turbine tree. This function should be called when you need to convert a list of vote accounts with their associated stakes into a list of identity accounts with aggregated stakes. It processes the input by copying, sorting, and deduplicating entries based on identity keys, and it aggregates stakes for duplicate identities. This function is typically used once per epoch and twice at startup.
- **Inputs**:
    - `stake_weight`: An array of `fd_stake_weight_t` structures where the function will store the converted identity-based stake weights. The caller must ensure this array is large enough to hold `staked_cnt` elements.
    - `vote_stake_weight`: A constant array of `fd_vote_stake_weight_t` structures containing the vote-based stake weights to convert. The array must have at least `staked_cnt` elements.
    - `staked_cnt`: The number of elements in the `vote_stake_weight` array to process. Must be a non-negative integer.
- **Output**: Returns the number of unique identity-based stake weights written to `stake_weight`.
- **See Also**: [`compute_id_weights_from_vote_weights`](<fd_stake_ci.c.md#compute_id_weights_from_vote_weights>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)