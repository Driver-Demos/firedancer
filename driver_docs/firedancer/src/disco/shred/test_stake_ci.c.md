<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for stake and destination management functions in the Firedancer codebase, including transitions, updates, and removals.

# Purpose
The code is a C test suite designed to validate the functionality of a staking and destination management system. It includes various test functions that simulate different scenarios involving staked and unstaked nodes, transitions between states, and updates to contact information. The code uses a series of static functions to generate stake messages and destination addresses, and it checks the correctness of the system's behavior through assertions (`FD_TEST`) that compare expected and actual outcomes.

The main components of the code include functions for generating stake messages ([`generate_stake_msg`](<#generate_stake_msg>)), adding destinations ([`generate_dest_add`](<#generate_dest_add>)), and checking the correctness of destination assignments ([`check_destinations`](<#check_destinations>)). The test suite covers a wide range of scenarios, such as testing only staked nodes, only unstaked nodes, transitions between states, and the handling of identity changes. The code also includes tests for system limits and the ability to update and remove destinations. The [`main`](<#main>) function initializes the test environment, runs all the test cases, and logs the results. The code is structured to ensure that the staking and destination management system behaves as expected under various conditions.
# Imports and Dependencies

---
- `fd_stake_ci.h`


# Global Variables

---
### \_info
- **Type**: ``fd_stake_ci_t` array`
- **Description**: The `_info` variable is a global array of type `fd_stake_ci_t` with a single element. It is used to store information related to stake cluster information.
- **Use**: Used to initialize and manage stake cluster information in various test functions.


---
### stake\_msg
- **Type**: `uchar[]`
- **Description**: An array of unsigned characters with a size defined by the constant `FD_STAKE_CI_STAKE_MSG_SZ`. This array is used to store stake messages.
- **Use**: Used as a buffer to hold stake messages generated by the `generate_stake_msg` function.


---
### identity\_key
- **Type**: `fd_pubkey_t[1]`
- **Description**: `identity_key` is a global array of type `fd_pubkey_t` with a single element. It is used to store a public key that represents the identity of a node in the system.
- **Use**: Used as an identity key for operations involving node identification and stake management.


# Functions

---
### generate\_stake\_msg<!-- {{#callable:generate_stake_msg}} -->
[View Source →](<../../../../../src/disco/shred/test_stake_ci.c#L10>)

Generates a stake weight message by populating a buffer with epoch-related data and stake weights for each staker.
- **Inputs**:
    - `_buf`: A pointer to a buffer where the stake weight message will be stored.
    - `epoch`: An unsigned long integer representing the current epoch.
    - `stakers`: A constant character pointer to a string of staker identifiers.
- **Logic and Control Flow**:
    - Cast the `_buf` to a `fd_stake_weight_msg_t` pointer using `fd_type_pun` and store it in `buf`.
    - Set `buf->epoch` to the provided `epoch`.
    - Calculate `buf->start_slot` as `epoch * SLOTS_PER_EPOCH`.
    - Set `buf->slot_cnt` to `SLOTS_PER_EPOCH`.
    - Set `buf->staked_cnt` to the length of the `stakers` string.
    - Initialize `buf->excluded_stake` and `buf->vote_keyed_lsched` to 0.
    - Iterate over each character in `stakers`, using it to fill `vote_key` and `id_key` in `buf->weights` with the same character, and set `stake` to `1000UL/(i+1UL)` for each staker.
    - Return the buffer cast back to `fd_stake_weight_msg_t` using `fd_type_pun`.
- **Output**: Returns a pointer to the populated `fd_stake_weight_msg_t` structure.


---
### generate\_dest\_add<!-- {{#callable:generate_dest_add}} -->
[View Source →](<../../../../../src/disco/shred/test_stake_ci.c#L35>)

Populates a buffer with destination data and assigns a fixed stake value to each entry.
- **Inputs**:
    - ``buf``: A pointer to an array of `fd_shred_dest_weighted_t` structures where destination data will be stored.
    - ``destinations``: A constant character pointer representing a string of destination identifiers.
- **Logic and Control Flow**:
    - Initialize a counter `i` to 0.
    - Iterate over each character in the `destinations` string until the null terminator is reached.
    - For each character, use `memset` to fill the `buf` at index `i` with the character value, using the size of `fd_shred_dest_weighted_t`.
    - Set the `stake_lamports` field of `buf[i]` to the constant value `0xDEADBEEF0BADF00DUL`.
    - Increment the counter `i` for each character processed.
    - Return the total number of processed destinations, which is the value of `i`.
- **Output**: Returns the number of destinations processed as an unsigned long integer.


---
### check\_destinations<!-- {{#callable:check_destinations}} -->
[View Source →](<../../../../../src/disco/shred/test_stake_ci.c#L46>)

Validates that the staked and unstaked destinations for a given epoch are consistent and meet expected conditions.
- **Inputs**:
    - ``info``: A pointer to a constant `fd_stake_ci_t` structure containing stake configuration information.
    - ``epoch``: An unsigned long integer representing the epoch number to check.
    - ``staked_dests``: A pointer to a constant character string representing the expected staked destinations.
    - ``unstaked_dests``: A pointer to a constant character string representing the expected unstaked destinations.
- **Logic and Control Flow**:
    - Calculate `min_slot` and `max_slot` for the given `epoch` using `SLOTS_PER_EPOCH`.
    - Verify that the staked destination and leader schedule for `min_slot` and `max_slot` are the same using `FD_TEST`.
    - If `staked_dests` is `NULL`, ensure `unstaked_dests` is also `NULL` and verify that there are no staked destinations or leader schedules for `min_slot`.
    - Retrieve the staked destination for `min_slot` and verify it is not `NULL`.
    - Check that the number of staked and unstaked destinations matches the lengths of `staked_dests` and `unstaked_dests`, respectively.
    - For each character in `staked_dests`, verify that it matches the corresponding public key in the staked destination.
    - For each character in `unstaked_dests`, verify that it matches the corresponding public key in the unstaked destination.
    - Retrieve the leader schedule for `min_slot` and verify that there are no leaders for slots outside the current epoch range.
    - Count the number of leader slots for each character in `staked_dests` and ensure that all slots are accounted for.
- **Output**: No return value; the function performs validation checks and uses `FD_TEST` to assert conditions.
- **Functions Called**:
    - [`fd_stake_ci_get_sdest_for_slot`](<fd_stake_ci.c.md#fd_stake_ci_get_sdest_for_slot>)
    - [`fd_stake_ci_get_lsched_for_slot`](<fd_stake_ci.c.md#fd_stake_ci_get_lsched_for_slot>)
    - [`fd_shred_dest_cnt_staked`](<fd_shred_dest.h.md#fd_shred_dest_cnt_staked>)
    - [`fd_shred_dest_idx_to_dest`](<fd_shred_dest.h.md#fd_shred_dest_idx_to_dest>)
    - [`fd_shred_dest_cnt_unstaked`](<fd_shred_dest.h.md#fd_shred_dest_cnt_unstaked>)


---
### test\_staked\_only<!-- {{#callable:test_staked_only}} -->
[View Source →](<../../../../../src/disco/shred/test_stake_ci.c#L120>)

Tests the behavior of staking and destination management for different epochs and staked nodes.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize `fd_stake_ci_t` structure using [`fd_stake_ci_join`](<fd_stake_ci.c.md#fd_stake_ci_join>) and [`fd_stake_ci_new`](<fd_stake_ci.c.md#fd_stake_ci_new>).
    - Generate and initialize stake messages for different epochs using [`generate_stake_msg`](<#generate_stake_msg>) and [`fd_stake_ci_stake_msg_init`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_init>).
    - Finalize stake messages with [`fd_stake_ci_stake_msg_fini`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_fini>).
    - Check the destinations for each epoch using [`check_destinations`](<#check_destinations>).
    - Repeat the process for multiple epochs with different staked nodes.
    - Clean up by deleting the `fd_stake_ci_t` structure using [`fd_stake_ci_delete`](<fd_stake_ci.c.md#fd_stake_ci_delete>) and [`fd_stake_ci_leave`](<fd_stake_ci.c.md#fd_stake_ci_leave>).
- **Output**: No output is returned; the function performs tests and assertions internally.
- **Functions Called**:
    - [`fd_stake_ci_join`](<fd_stake_ci.c.md#fd_stake_ci_join>)
    - [`fd_stake_ci_new`](<fd_stake_ci.c.md#fd_stake_ci_new>)
    - [`fd_stake_ci_stake_msg_init`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_init>)
    - [`generate_stake_msg`](<#generate_stake_msg>)
    - [`fd_stake_ci_stake_msg_fini`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_fini>)
    - [`check_destinations`](<#check_destinations>)
    - [`fd_stake_ci_delete`](<fd_stake_ci.c.md#fd_stake_ci_delete>)
    - [`fd_stake_ci_leave`](<fd_stake_ci.c.md#fd_stake_ci_leave>)


---
### test\_unstaked\_only<!-- {{#callable:test_unstaked_only}} -->
[View Source →](<../../../../../src/disco/shred/test_stake_ci.c#L139>)

Tests the behavior of unstaked nodes by initializing, adding, and checking destinations in a stake cluster information context.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize a stake cluster information context using [`fd_stake_ci_join`](<fd_stake_ci.c.md#fd_stake_ci_join>) and [`fd_stake_ci_new`](<fd_stake_ci.c.md#fd_stake_ci_new>).
    - Generate a stake message for epoch 0 with a single staked node 'I' and finalize it using [`fd_stake_ci_stake_msg_init`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_init>) and [`fd_stake_ci_stake_msg_fini`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_fini>).
    - Check the destinations for epoch 0, expecting 'I' as staked and no unstaked nodes using [`check_destinations`](<#check_destinations>).
    - Add unstaked destinations 'ABC' using [`fd_stake_ci_dest_add_init`](<fd_stake_ci.c.md#fd_stake_ci_dest_add_init>), [`generate_dest_add`](<#generate_dest_add>), and [`fd_stake_ci_dest_add_fini`](<fd_stake_ci.c.md#fd_stake_ci_dest_add_fini>), then check the destinations again.
    - Repeat the process for unstaked destinations 'ABCDEF' and 'ABC', checking the destinations after each addition.
    - Delete the stake cluster information context using [`fd_stake_ci_leave`](<fd_stake_ci.c.md#fd_stake_ci_leave>) and [`fd_stake_ci_delete`](<fd_stake_ci.c.md#fd_stake_ci_delete>).
- **Output**: No output is returned as the function is void and primarily performs tests and assertions.
- **Functions Called**:
    - [`fd_stake_ci_join`](<fd_stake_ci.c.md#fd_stake_ci_join>)
    - [`fd_stake_ci_new`](<fd_stake_ci.c.md#fd_stake_ci_new>)
    - [`fd_stake_ci_stake_msg_init`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_init>)
    - [`generate_stake_msg`](<#generate_stake_msg>)
    - [`fd_stake_ci_stake_msg_fini`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_fini>)
    - [`check_destinations`](<#check_destinations>)
    - [`fd_stake_ci_dest_add_fini`](<fd_stake_ci.c.md#fd_stake_ci_dest_add_fini>)
    - [`generate_dest_add`](<#generate_dest_add>)
    - [`fd_stake_ci_dest_add_init`](<fd_stake_ci.c.md#fd_stake_ci_dest_add_init>)
    - [`fd_stake_ci_delete`](<fd_stake_ci.c.md#fd_stake_ci_delete>)
    - [`fd_stake_ci_leave`](<fd_stake_ci.c.md#fd_stake_ci_leave>)


---
### test\_transitions<!-- {{#callable:test_transitions}} -->
[View Source →](<../../../../../src/disco/shred/test_stake_ci.c#L159>)

Tests various transitions between staked and unstaked states for nodes in a cluster information system.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize `info` by joining a new cluster information instance with [`fd_stake_ci_join`](<fd_stake_ci.c.md#fd_stake_ci_join>) and [`fd_stake_ci_new`](<fd_stake_ci.c.md#fd_stake_ci_new>).
    - Generate and initialize a stake message for epoch 0 with stakers 'ABCD', then finalize the stake message.
    - Add destinations 'ABCDEFGH' and finalize the destination addition, then check destinations for epoch 0 with expected staked 'ABCD' and unstaked 'EFGHI'.
    - Transition half of unstaked nodes to staked by generating a stake message for epoch 1 with stakers 'ABCDEF', finalize it, and check destinations for epochs 0 and 1.
    - Transition nodes back by generating a stake message for epoch 2 with stakers 'AB', finalize it, and check destinations for epochs 1 and 2.
    - Completely swap nodes by generating a stake message for epoch 3 with stakers 'GI', finalize it, and check destinations for epochs 2 and 3.
    - Delete unstaked nodes by adding an empty destination list, finalize it, and check destinations for epochs 2 and 3.
    - Add new unstaked nodes 'KL', finalize the addition, and check destinations for epochs 2 and 3.
    - Delete the cluster information instance by leaving and deleting `info`.
- **Output**: No output is returned; the function performs tests and checks internally.
- **Functions Called**:
    - [`fd_stake_ci_join`](<fd_stake_ci.c.md#fd_stake_ci_join>)
    - [`fd_stake_ci_new`](<fd_stake_ci.c.md#fd_stake_ci_new>)
    - [`fd_stake_ci_stake_msg_init`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_init>)
    - [`generate_stake_msg`](<#generate_stake_msg>)
    - [`fd_stake_ci_stake_msg_fini`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_fini>)
    - [`fd_stake_ci_dest_add_fini`](<fd_stake_ci.c.md#fd_stake_ci_dest_add_fini>)
    - [`generate_dest_add`](<#generate_dest_add>)
    - [`fd_stake_ci_dest_add_init`](<fd_stake_ci.c.md#fd_stake_ci_dest_add_init>)
    - [`check_destinations`](<#check_destinations>)
    - [`fd_stake_ci_delete`](<fd_stake_ci.c.md#fd_stake_ci_delete>)
    - [`fd_stake_ci_leave`](<fd_stake_ci.c.md#fd_stake_ci_leave>)


---
### test\_startup<!-- {{#callable:test_startup}} -->
[View Source →](<../../../../../src/disco/shred/test_stake_ci.c#L195>)

Initializes and tests the startup state of a stake cluster information system by simulating stake messages and checking destination states.
- **Inputs**: None
- **Logic and Control Flow**:
    - Join a new stake cluster information instance using [`fd_stake_ci_join`](<fd_stake_ci.c.md#fd_stake_ci_join>) and [`fd_stake_ci_new`](<fd_stake_ci.c.md#fd_stake_ci_new>).
    - Check that no epoch is known initially by calling [`check_destinations`](<#check_destinations>) with `NULL` for staked and unstaked destinations.
    - Initialize a stake message for epoch 0 with staker 'I' using [`fd_stake_ci_stake_msg_init`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_init>) and [`generate_stake_msg`](<#generate_stake_msg>), then finalize it with [`fd_stake_ci_stake_msg_fini`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_fini>).
    - Check that the destination for epoch 0 is 'I' staked and no unstaked destinations using [`check_destinations`](<#check_destinations>).
    - Initialize a stake message for epoch 1 with staker 'A', finalize it, and check that the destination for epoch 1 is 'A' staked and 'I' unstaked.
    - Delete the current stake cluster information instance using [`fd_stake_ci_delete`](<fd_stake_ci.c.md#fd_stake_ci_delete>) and [`fd_stake_ci_leave`](<fd_stake_ci.c.md#fd_stake_ci_leave>).
    - Restart the process by joining a new stake cluster information instance and initialize a stake message for epoch 0 with staker 'A', finalize it, and check that the destination for epoch 0 is 'A' staked and 'I' unstaked.
    - Delete the stake cluster information instance again.
- **Output**: No output is returned as the function is of type `void` and is used for testing purposes.
- **Functions Called**:
    - [`fd_stake_ci_join`](<fd_stake_ci.c.md#fd_stake_ci_join>)
    - [`fd_stake_ci_new`](<fd_stake_ci.c.md#fd_stake_ci_new>)
    - [`check_destinations`](<#check_destinations>)
    - [`fd_stake_ci_stake_msg_init`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_init>)
    - [`generate_stake_msg`](<#generate_stake_msg>)
    - [`fd_stake_ci_stake_msg_fini`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_fini>)
    - [`fd_stake_ci_delete`](<fd_stake_ci.c.md#fd_stake_ci_delete>)
    - [`fd_stake_ci_leave`](<fd_stake_ci.c.md#fd_stake_ci_leave>)


---
### test\_skip\_ahead<!-- {{#callable:test_skip_ahead}} -->
[View Source →](<../../../../../src/disco/shred/test_stake_ci.c#L220>)

Tests the behavior of the staking system when skipping epochs and verifying the destinations for each epoch.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize `info` by joining a new stake cluster information instance with [`fd_stake_ci_join`](<fd_stake_ci.c.md#fd_stake_ci_join>) and [`fd_stake_ci_new`](<fd_stake_ci.c.md#fd_stake_ci_new>).
    - Generate and initialize a stake message for epoch 0 with stakers 'ABC', finalize the message, and check destinations for epoch 0.
    - Generate and initialize a stake message for epoch 1 with stakers 'ABCDE', finalize the message, and check destinations for epochs 0 and 1.
    - Simulate skipping a few epochs by generating and initializing a stake message for epoch 6 with stakers 'ABCF', finalize the message, and check destinations for epoch 6.
    - Generate and initialize a stake message for epoch 9 with stakers 'GH', finalize the message, and check destinations for epoch 9.
    - Delete the stake cluster information instance by leaving and deleting `info`.
- **Output**: No output is returned; the function performs tests and checks internally.
- **Functions Called**:
    - [`fd_stake_ci_join`](<fd_stake_ci.c.md#fd_stake_ci_join>)
    - [`fd_stake_ci_new`](<fd_stake_ci.c.md#fd_stake_ci_new>)
    - [`fd_stake_ci_stake_msg_init`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_init>)
    - [`generate_stake_msg`](<#generate_stake_msg>)
    - [`fd_stake_ci_stake_msg_fini`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_fini>)
    - [`check_destinations`](<#check_destinations>)
    - [`fd_stake_ci_delete`](<fd_stake_ci.c.md#fd_stake_ci_delete>)
    - [`fd_stake_ci_leave`](<fd_stake_ci.c.md#fd_stake_ci_leave>)


---
### test\_cancel<!-- {{#callable:test_cancel}} -->
[View Source →](<../../../../../src/disco/shred/test_stake_ci.c#L238>)

Tests the cancellation of stake and destination addition operations without finalizing them, and verifies the resulting destinations.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize `info` by joining a new stake cluster instance with [`fd_stake_ci_join`](<fd_stake_ci.c.md#fd_stake_ci_join>) and [`fd_stake_ci_new`](<fd_stake_ci.c.md#fd_stake_ci_new>).
    - Generate and initialize a stake message for epoch 0 with stakers 'ABC', finalize it, and check destinations for epoch 0.
    - Generate a stake message for epoch 1 with stakers 'ABCDE' without finalizing it, and check destinations for epochs 0 and 1.
    - Add destinations 'EFG' and finalize the addition, then check destinations for epochs 0 and 1.
    - Generate destinations 'EFGHIJ' without finalizing, and check destinations for epochs 0 and 1.
    - Delete the stake cluster instance by leaving and deleting `info`.
- **Output**: No output is returned; the function performs tests and checks internally.
- **Functions Called**:
    - [`fd_stake_ci_join`](<fd_stake_ci.c.md#fd_stake_ci_join>)
    - [`fd_stake_ci_new`](<fd_stake_ci.c.md#fd_stake_ci_new>)
    - [`fd_stake_ci_stake_msg_init`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_init>)
    - [`generate_stake_msg`](<#generate_stake_msg>)
    - [`fd_stake_ci_stake_msg_fini`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_fini>)
    - [`check_destinations`](<#check_destinations>)
    - [`fd_stake_ci_dest_add_fini`](<fd_stake_ci.c.md#fd_stake_ci_dest_add_fini>)
    - [`generate_dest_add`](<#generate_dest_add>)
    - [`fd_stake_ci_dest_add_init`](<fd_stake_ci.c.md#fd_stake_ci_dest_add_init>)
    - [`fd_stake_ci_delete`](<fd_stake_ci.c.md#fd_stake_ci_delete>)
    - [`fd_stake_ci_leave`](<fd_stake_ci.c.md#fd_stake_ci_leave>)


---
### test\_ordering<!-- {{#callable:test_ordering}} -->
[View Source →](<../../../../../src/disco/shred/test_stake_ci.c#L258>)

Tests the ordering of stake messages and destination additions in a cluster information context.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize `fd_stake_ci_t` structure by joining a new cluster information instance with [`fd_stake_ci_join`](<fd_stake_ci.c.md#fd_stake_ci_join>) and [`fd_stake_ci_new`](<fd_stake_ci.c.md#fd_stake_ci_new>).
    - Generate and initialize a stake message for epoch 0 with stakers 'ABC', finalize the stake message, and check destinations for epoch 0 with expected staked 'ABC' and unstaked 'I'.
    - Generate and initialize a stake message for epoch 1 with stakers 'BCA', finalize the stake message, and check destinations for epoch 0 with expected staked 'ABC' and unstaked 'I', and for epoch 1 with expected staked 'BCA' and unstaked 'I'.
    - Add destinations 'EFG' to the cluster information, finalize the addition, and check destinations for epochs 0 and 1 with expected unstaked 'EFGI'.
    - Add destinations 'LKJ' to the cluster information, finalize the addition, and check destinations for epochs 0 and 1 with expected unstaked 'IJKL'.
    - Delete the cluster information instance by leaving and deleting it with [`fd_stake_ci_leave`](<fd_stake_ci.c.md#fd_stake_ci_leave>) and [`fd_stake_ci_delete`](<fd_stake_ci.c.md#fd_stake_ci_delete>).
- **Output**: No output is returned as the function is void and primarily performs tests and checks.
- **Functions Called**:
    - [`fd_stake_ci_join`](<fd_stake_ci.c.md#fd_stake_ci_join>)
    - [`fd_stake_ci_new`](<fd_stake_ci.c.md#fd_stake_ci_new>)
    - [`fd_stake_ci_stake_msg_init`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_init>)
    - [`generate_stake_msg`](<#generate_stake_msg>)
    - [`fd_stake_ci_stake_msg_fini`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_fini>)
    - [`check_destinations`](<#check_destinations>)
    - [`fd_stake_ci_dest_add_fini`](<fd_stake_ci.c.md#fd_stake_ci_dest_add_fini>)
    - [`generate_dest_add`](<#generate_dest_add>)
    - [`fd_stake_ci_dest_add_init`](<fd_stake_ci.c.md#fd_stake_ci_dest_add_init>)
    - [`fd_stake_ci_delete`](<fd_stake_ci.c.md#fd_stake_ci_delete>)
    - [`fd_stake_ci_leave`](<fd_stake_ci.c.md#fd_stake_ci_leave>)


---
### test\_destaking<!-- {{#callable:test_destaking}} -->
[View Source →](<../../../../../src/disco/shred/test_stake_ci.c#L280>)

Tests the process of staking and destaking nodes, verifying the correct destinations for each epoch.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize `fd_stake_ci_t` structure using [`fd_stake_ci_join`](<fd_stake_ci.c.md#fd_stake_ci_join>) and [`fd_stake_ci_new`](<fd_stake_ci.c.md#fd_stake_ci_new>).
    - Generate and initialize a stake message for epoch 0 with stakers 'ABCDEF' using [`generate_stake_msg`](<#generate_stake_msg>) and [`fd_stake_ci_stake_msg_init`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_init>).
    - Finalize the stake message with [`fd_stake_ci_stake_msg_fini`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_fini>) and check destinations using [`check_destinations`](<#check_destinations>).
    - Add destinations 'ABCH' using [`generate_dest_add`](<#generate_dest_add>) and [`fd_stake_ci_dest_add_fini`](<fd_stake_ci.c.md#fd_stake_ci_dest_add_fini>), then check destinations again.
    - Repeat the process for epochs 1, 2, and 3 with different stakers and destinations, checking destinations after each operation.
    - Clean up by deleting the `fd_stake_ci_t` structure using [`fd_stake_ci_delete`](<fd_stake_ci.c.md#fd_stake_ci_delete>) and [`fd_stake_ci_leave`](<fd_stake_ci.c.md#fd_stake_ci_leave>).
- **Output**: No output is returned; the function performs tests and checks internally.
- **Functions Called**:
    - [`fd_stake_ci_join`](<fd_stake_ci.c.md#fd_stake_ci_join>)
    - [`fd_stake_ci_new`](<fd_stake_ci.c.md#fd_stake_ci_new>)
    - [`fd_stake_ci_stake_msg_init`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_init>)
    - [`generate_stake_msg`](<#generate_stake_msg>)
    - [`fd_stake_ci_stake_msg_fini`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_fini>)
    - [`check_destinations`](<#check_destinations>)
    - [`fd_stake_ci_dest_add_fini`](<fd_stake_ci.c.md#fd_stake_ci_dest_add_fini>)
    - [`generate_dest_add`](<#generate_dest_add>)
    - [`fd_stake_ci_dest_add_init`](<fd_stake_ci.c.md#fd_stake_ci_dest_add_init>)
    - [`fd_stake_ci_delete`](<fd_stake_ci.c.md#fd_stake_ci_delete>)
    - [`fd_stake_ci_leave`](<fd_stake_ci.c.md#fd_stake_ci_leave>)


---
### test\_changing\_contact\_info<!-- {{#callable:test_changing_contact_info}} -->
[View Source →](<../../../../../src/disco/shred/test_stake_ci.c#L305>)

Tests the process of changing contact information for stake destinations and verifies the updates.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize `fd_stake_ci_t` object `info` by joining a new stake cluster info with `_info` and `identity_key`.
    - Generate a stake message for epoch 0 with staker 'A' and initialize it in `info`, then finalize the stake message.
    - Check that the destinations for epoch 0 are 'A' as staked and 'I' as unstaked.
    - Add a new destination 'AB' to `info` and finalize the addition, then check that the destinations for epoch 0 are 'A' as staked and 'BI' as unstaked.
    - Initialize a new destination list `destinations` and add 'AB' to it, then set specific IP and port values for each destination.
    - Finalize the addition of 2 destinations to `info`.
    - Retrieve the shred destination for slot 0 and verify that the IP and port values match the expected values for each destination.
    - Delete the `info` object by leaving the stake cluster info.
- **Output**: No output is returned; the function performs tests and assertions internally.
- **Functions Called**:
    - [`fd_stake_ci_join`](<fd_stake_ci.c.md#fd_stake_ci_join>)
    - [`fd_stake_ci_new`](<fd_stake_ci.c.md#fd_stake_ci_new>)
    - [`fd_stake_ci_stake_msg_init`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_init>)
    - [`generate_stake_msg`](<#generate_stake_msg>)
    - [`fd_stake_ci_stake_msg_fini`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_fini>)
    - [`check_destinations`](<#check_destinations>)
    - [`fd_stake_ci_dest_add_fini`](<fd_stake_ci.c.md#fd_stake_ci_dest_add_fini>)
    - [`generate_dest_add`](<#generate_dest_add>)
    - [`fd_stake_ci_dest_add_init`](<fd_stake_ci.c.md#fd_stake_ci_dest_add_init>)
    - [`fd_stake_ci_get_sdest_for_slot`](<fd_stake_ci.c.md#fd_stake_ci_get_sdest_for_slot>)
    - [`fd_shred_dest_idx_to_dest`](<fd_shred_dest.h.md#fd_shred_dest_idx_to_dest>)
    - [`fd_stake_ci_delete`](<fd_stake_ci.c.md#fd_stake_ci_delete>)
    - [`fd_stake_ci_leave`](<fd_stake_ci.c.md#fd_stake_ci_leave>)


---
### test\_limits<!-- {{#callable:test_limits}} -->
[View Source →](<../../../../../src/disco/shred/test_stake_ci.c#L333>)

Tests the limits of cluster information and stake weights by simulating scenarios with varying numbers of validators and public keys, ensuring they do not exceed predefined limits.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize `fd_stake_ci_t` structure using [`fd_stake_ci_join`](<fd_stake_ci.c.md#fd_stake_ci_join>) and [`fd_stake_ci_new`](<fd_stake_ci.c.md#fd_stake_ci_new>).
    - Iterate over `stake_weight_cnt` from 40198 to 40201, setting up a `fd_stake_weight_msg_t` buffer for each count.
    - For each `stake_weight_cnt`, iterate over possible stakes, assigning stakes to weights if the count is less than 40200, otherwise adding to `excluded_stake`.
    - Initialize and finalize stake messages using [`fd_stake_ci_stake_msg_init`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_init>) and [`fd_stake_ci_stake_msg_fini`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_fini>).
    - Iterate over `cluster_info_cnt` from 40198 to 40201, initializing destination weights and setting public keys for counts less than 40199.
    - Finalize destination weights using [`fd_stake_ci_dest_add_fini`](<fd_stake_ci.c.md#fd_stake_ci_dest_add_fini>).
    - Perform tests using `FD_TEST` to verify destination and schedule retrieval for each slot.
    - Clean up by deleting the `fd_stake_ci_t` structure using [`fd_stake_ci_delete`](<fd_stake_ci.c.md#fd_stake_ci_delete>) and [`fd_stake_ci_leave`](<fd_stake_ci.c.md#fd_stake_ci_leave>).
- **Output**: No output is returned; the function performs tests and assertions internally.
- **Functions Called**:
    - [`fd_stake_ci_join`](<fd_stake_ci.c.md#fd_stake_ci_join>)
    - [`fd_stake_ci_new`](<fd_stake_ci.c.md#fd_stake_ci_new>)
    - [`fd_stake_ci_stake_msg_init`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_init>)
    - [`fd_stake_ci_stake_msg_fini`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_fini>)
    - [`fd_stake_ci_dest_add_init`](<fd_stake_ci.c.md#fd_stake_ci_dest_add_init>)
    - [`fd_stake_ci_dest_add_fini`](<fd_stake_ci.c.md#fd_stake_ci_dest_add_fini>)
    - [`fd_stake_ci_get_sdest_for_slot`](<fd_stake_ci.c.md#fd_stake_ci_get_sdest_for_slot>)
    - [`fd_stake_ci_get_lsched_for_slot`](<fd_stake_ci.c.md#fd_stake_ci_get_lsched_for_slot>)
    - [`fd_stake_ci_delete`](<fd_stake_ci.c.md#fd_stake_ci_delete>)
    - [`fd_stake_ci_leave`](<fd_stake_ci.c.md#fd_stake_ci_leave>)


---
### test\_set\_identity<!-- {{#callable:test_set_identity}} -->
[View Source →](<../../../../../src/disco/shred/test_stake_ci.c#L388>)

Tests the functionality of setting and migrating identities in a staking context, including transitions between staked and unstaked states.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize `info` by joining a new stake cluster with `identity_key`.
    - Generate and initialize a stake message with stakers 'ABCDEF' and finalize it.
    - Add and finalize destination addresses 'ABCHJZ'.
    - Set a new identity 'N' and check the transition from unstaked to unstaked, expecting 'HIJNZ' as unstaked.
    - Generate and initialize a stake message with stakers 'ABCDN' and finalize it, making 'N' staked.
    - Set a new identity 'H' and check the transition from staked to unstaked, expecting 'HIJZ' as unstaked.
    - Set a new identity 'A' and check the transition from unstaked to staked, expecting 'HIJZ' as unstaked.
    - Set a new identity 'B' and check the transition from staked to staked.
- **Output**: No output is returned; the function performs tests and checks internally.
- **Functions Called**:
    - [`fd_stake_ci_join`](<fd_stake_ci.c.md#fd_stake_ci_join>)
    - [`fd_stake_ci_new`](<fd_stake_ci.c.md#fd_stake_ci_new>)
    - [`fd_stake_ci_stake_msg_init`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_init>)
    - [`generate_stake_msg`](<#generate_stake_msg>)
    - [`fd_stake_ci_stake_msg_fini`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_fini>)
    - [`fd_stake_ci_dest_add_fini`](<fd_stake_ci.c.md#fd_stake_ci_dest_add_fini>)
    - [`generate_dest_add`](<#generate_dest_add>)
    - [`fd_stake_ci_dest_add_init`](<fd_stake_ci.c.md#fd_stake_ci_dest_add_init>)
    - [`check_destinations`](<#check_destinations>)


---
### test\_staked\_by\_vote<!-- {{#callable:test_staked_by_vote}} -->
[View Source →](<../../../../../src/disco/shred/test_stake_ci.c#L421>)

Tests the behavior of staking and unstaking nodes based on vote scheduling and verifies the destinations for each epoch.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize `fd_stake_ci_t` structure using [`fd_stake_ci_join`](<fd_stake_ci.c.md#fd_stake_ci_join>) and [`fd_stake_ci_new`](<fd_stake_ci.c.md#fd_stake_ci_new>).
    - Generate a stake message with a single staker 'I' and set `vote_keyed_lsched` to 1, then initialize and finalize the stake message.
    - Check the destinations for epoch 0, expecting 'I' as staked and no unstaked nodes.
    - Generate a stake message with stakers 'ABC', set `vote_keyed_lsched` to 1, initialize and finalize the stake message, and check destinations for epoch 0, expecting 'ABC' as staked and 'I' as unstaked.
    - Generate and process stake messages with stakers 'ABBB', 'ABBA', and 'ABACBADACBE', checking destinations after each to verify the expected staked and unstaked nodes for epochs 0 and 1.
    - Clean up by deleting the `fd_stake_ci_t` structure using [`fd_stake_ci_delete`](<fd_stake_ci.c.md#fd_stake_ci_delete>) and [`fd_stake_ci_leave`](<fd_stake_ci.c.md#fd_stake_ci_leave>).
- **Output**: No output is returned; the function performs tests and assertions internally.
- **Functions Called**:
    - [`fd_stake_ci_join`](<fd_stake_ci.c.md#fd_stake_ci_join>)
    - [`fd_stake_ci_new`](<fd_stake_ci.c.md#fd_stake_ci_new>)
    - [`generate_stake_msg`](<#generate_stake_msg>)
    - [`fd_stake_ci_stake_msg_init`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_init>)
    - [`fd_stake_ci_stake_msg_fini`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_fini>)
    - [`check_destinations`](<#check_destinations>)
    - [`fd_stake_ci_delete`](<fd_stake_ci.c.md#fd_stake_ci_delete>)
    - [`fd_stake_ci_leave`](<fd_stake_ci.c.md#fd_stake_ci_leave>)


---
### test\_dest\_update<!-- {{#callable:test_dest_update}} -->
[View Source →](<../../../../../src/disco/shred/test_stake_ci.c#L448>)

Tests the updating of destination nodes in a staking cluster, including adding new nodes and modifying existing ones across different epochs.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initializes a staking cluster with staked nodes 'A', 'B', and 'C'.
    - Updates the contact information for an existing staked node 'A' and verifies the update.
    - Adds a new unstaked node 'D' and verifies its addition to the unstaked list.
    - Adds multiple new unstaked nodes 'E' and 'F' and verifies their addition.
    - Updates the contact information for an unstaked node 'D' and verifies the update.
    - Verifies that updates apply to both epoch 0 and epoch 1 by updating node 'B'.
    - Adds a new node 'Z' that should appear in both epochs as unstaked.
    - Updates node 'C' to be unstaked and verifies its presence in epoch 1.
- **Output**: No return value; the function performs tests and uses assertions to verify correctness.
- **Functions Called**:
    - [`fd_stake_ci_join`](<fd_stake_ci.c.md#fd_stake_ci_join>)
    - [`fd_stake_ci_new`](<fd_stake_ci.c.md#fd_stake_ci_new>)
    - [`fd_stake_ci_stake_msg_init`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_init>)
    - [`generate_stake_msg`](<#generate_stake_msg>)
    - [`fd_stake_ci_stake_msg_fini`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_fini>)
    - [`check_destinations`](<#check_destinations>)
    - [`fd_stake_ci_dest_update`](<fd_stake_ci.c.md#fd_stake_ci_dest_update>)
    - [`fd_stake_ci_get_sdest_for_slot`](<fd_stake_ci.c.md#fd_stake_ci_get_sdest_for_slot>)
    - [`fd_shred_dest_pubkey_to_idx`](<fd_shred_dest.c.md#fd_shred_dest_pubkey_to_idx>)
    - [`fd_shred_dest_idx_to_dest`](<fd_shred_dest.h.md#fd_shred_dest_idx_to_dest>)
    - [`fd_stake_ci_delete`](<fd_stake_ci.c.md#fd_stake_ci_delete>)
    - [`fd_stake_ci_leave`](<fd_stake_ci.c.md#fd_stake_ci_leave>)


---
### test\_dest\_remove<!-- {{#callable:test_dest_remove}} -->
[View Source →](<../../../../../src/disco/shred/test_stake_ci.c#L551>)

Tests the removal of nodes from a destination list, handling both staked and unstaked nodes, and ensuring correct behavior across epochs.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize `info` by joining a new stake cluster information instance.
    - Set up initial state with staked nodes A, B, C and unstaked nodes D, E, F using [`fd_stake_ci_stake_msg_init`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_init>) and [`fd_stake_ci_dest_update`](<fd_stake_ci.c.md#fd_stake_ci_dest_update>).
    - Verify initial destinations with [`check_destinations`](<#check_destinations>).
    - Remove unstaked node D using [`fd_stake_ci_dest_remove`](<fd_stake_ci.c.md#fd_stake_ci_dest_remove>) and verify it is removed from the unstaked list.
    - Attempt to remove staked node A, which should not be removed but have its contact info cleared, and verify it remains in the staked list.
    - Attempt to remove a non-existing node Z, which should result in no changes.
    - Ensure that removal operations apply to both epochs by removing unstaked node E and verifying its absence in both epochs.
    - Remove multiple unstaked nodes, such as F, and verify the updated destination lists.
    - Clean up by deleting the stake cluster information instance.
- **Output**: No direct output; the function performs tests and uses assertions to verify correct behavior.
- **Functions Called**:
    - [`fd_stake_ci_join`](<fd_stake_ci.c.md#fd_stake_ci_join>)
    - [`fd_stake_ci_new`](<fd_stake_ci.c.md#fd_stake_ci_new>)
    - [`fd_stake_ci_stake_msg_init`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_init>)
    - [`generate_stake_msg`](<#generate_stake_msg>)
    - [`fd_stake_ci_stake_msg_fini`](<fd_stake_ci.c.md#fd_stake_ci_stake_msg_fini>)
    - [`fd_stake_ci_dest_update`](<fd_stake_ci.c.md#fd_stake_ci_dest_update>)
    - [`check_destinations`](<#check_destinations>)
    - [`fd_stake_ci_dest_remove`](<fd_stake_ci.c.md#fd_stake_ci_dest_remove>)
    - [`fd_stake_ci_get_sdest_for_slot`](<fd_stake_ci.c.md#fd_stake_ci_get_sdest_for_slot>)
    - [`fd_shred_dest_pubkey_to_idx`](<fd_shred_dest.c.md#fd_shred_dest_pubkey_to_idx>)
    - [`fd_shred_dest_idx_to_dest`](<fd_shred_dest.h.md#fd_shred_dest_idx_to_dest>)
    - [`fd_stake_ci_delete`](<fd_stake_ci.c.md#fd_stake_ci_delete>)
    - [`fd_stake_ci_leave`](<fd_stake_ci.c.md#fd_stake_ci_leave>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/disco/shred/test_stake_ci.c#L648>)

Initializes the system, performs a series of tests on staking and destination management, and logs the results.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the system with command-line arguments.
    - Initializes a variable `max` to zero and iterates over possible staked values to find the maximum shred destination footprint.
    - Checks if `MAX_SHRED_DEST_FOOTPRINT` matches the calculated `max` and logs an error if not.
    - Initializes `identity_key` with the character 'I'.
    - Executes a series of test functions to validate staking and destination management logic.
    - Logs a notice message indicating all tests passed.
    - Calls `fd_halt` to terminate the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`fd_shred_dest_footprint`](<fd_shred_dest.c.md#fd_shred_dest_footprint>)
    - [`test_staked_only`](<#test_staked_only>)
    - [`test_unstaked_only`](<#test_unstaked_only>)
    - [`test_transitions`](<#test_transitions>)
    - [`test_startup`](<#test_startup>)
    - [`test_skip_ahead`](<#test_skip_ahead>)
    - [`test_cancel`](<#test_cancel>)
    - [`test_ordering`](<#test_ordering>)
    - [`test_destaking`](<#test_destaking>)
    - [`test_changing_contact_info`](<#test_changing_contact_info>)
    - [`test_limits`](<#test_limits>)
    - [`test_set_identity`](<#test_set_identity>)
    - [`test_staked_by_vote`](<#test_staked_by_vote>)
    - [`test_dest_update`](<#test_dest_update>)
    - [`test_dest_remove`](<#test_dest_remove>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)