<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Handles shreds from microblocks and network, managing memory and flow control for processing and distribution.

# Purpose
The code is a C module that implements a "shred tile" in a distributed system, likely related to blockchain or distributed ledger technology. The shred tile is responsible for handling "shreds," which are data fragments from two sources: microblocks from a banking tile and retransmitted shreds from the network. The module manages these shreds by segmenting memory into two halves of a data cache (dcache) to accommodate different flow control patterns. It ensures that data cache entries are not overwritten unless their corresponding metadata cache (mcache) entries are also overwritten, maintaining data integrity.

The module includes various components and functionalities, such as flow control, memory management, and parallelization strategies. It defines several constants and data structures, including `fd_shred_ctx_t`, which holds the context for shred processing. The code also includes functions for initializing the shred tile, handling incoming shreds, and managing the flow of data through the system. It uses a combination of static assertions, memory alignment, and data structure definitions to ensure efficient and correct operation. The module is designed to be part of a larger system, interfacing with other components through defined APIs and data structures.
# Imports and Dependencies

---
- `../tiles.h`
- `generated/fd_shred_tile_seccomp.h`
- `../../util/pod/fd_pod_format.h`
- `../shred/fd_shredder.h`
- `../shred/fd_shred_batch.h`
- `../shred/fd_shred_dest.h`
- `../shred/fd_fec_resolver.h`
- `../shred/fd_stake_ci.h`
- `../store/fd_store.h`
- `../keyguard/fd_keyload.h`
- `../keyguard/fd_keyguard.h`
- `../keyguard/fd_keyswitch.h`
- `../fd_disco.h`
- `../net/fd_net_tile.h`
- `../../flamenco/leaders/fd_leaders.h`
- `../../util/net/fd_net_headers.h`
- `../../flamenco/gossip/fd_gossip_types.h`
- `linux/unistd.h`
- `../stem/fd_stem.c`


# Global Variables

---
### fd\_tile\_shred
- **Type**: ``fd_topo_run_tile_t``
- **Description**: Defines a `fd_topo_run_tile_t` structure named `fd_tile_shred` with various function pointers and parameters for initializing and running a tile in a topology. The structure includes fields for the tile's name, functions for populating allowed seccomp and file descriptors, alignment and footprint functions for scratch memory, and initialization and run functions.
- **Use**: Used to configure and manage the execution of a shred tile within a topology.


# Data Structures

---
### fd\_shred\_in\_ctx\_t
- **Type**: ``union``
- **Members**:
    - ``mem``: Pointer to a `fd_wksp_t` structure.
    - ``chunk0``: Unsigned long integer representing the initial chunk.
    - ``wmark``: Unsigned long integer representing the watermark.
    - ``net_rx``: Instance of `fd_net_rx_bounds_t`.
- **Description**: The `fd_shred_in_ctx_t` union is a data structure that can represent either a set of memory management fields (`mem`, `chunk0`, `wmark`) or a network reception boundary (`net_rx`). This allows the structure to be used flexibly in contexts where either memory management or network reception is required, depending on the specific use case.


---
### fd\_shred\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``shredder``: Pointer to an `fd_shredder_t` object.
    - ``resolver``: Pointer to an `fd_fec_resolver_t` object.
    - ``identity_key``: Array containing a single `fd_pubkey_t` representing the public key.
    - ``round_robin_id``: Unsigned long representing the round-robin identifier.
    - ``round_robin_cnt``: Unsigned long representing the count for round-robin processing.
    - ``batch_cnt``: Unsigned long representing the number of batches shredded from PoH during the current slot.
    - ``slot``: Unsigned long representing the slot of the most recent microblock seen from PoH.
    - ``keyswitch``: Pointer to an `fd_keyswitch_t` object.
    - ``keyguard_client``: Array containing a single `fd_keyguard_client_t` object.
    - ``shred34``: Pointer to an `fd_shred34_t` object.
    - ``fec_sets``: Pointer to an `fd_fec_set_t` object.
    - ``stake_ci``: Pointer to an `fd_stake_ci_t` object.
    - ``new_dest_ptr``: Pointer to an `fd_shred_dest_weighted_t` object used between during_frag and after_frag.
    - ``new_dest_cnt``: Unsigned long representing the count of new destinations.
    - ``shredded_txn_cnt``: Unsigned long representing the count of shredded transactions.
    - ``poh_in_expect_seq``: Unsigned long representing the expected sequence number for PoH input.
    - ``net_id``: Unsigned short representing the network identifier.
    - ``skip_frag``: Integer flag indicating whether to skip a fragment.
    - ``adtl_dests_leader_cnt``: Unsigned long representing the count of additional leader destinations.
    - ``adtl_dests_leader``: Array of `fd_shred_dest_weighted_t` objects for additional leader destinations.
    - ``adtl_dests_retransmit_cnt``: Unsigned long representing the count of additional retransmit destinations.
    - ``adtl_dests_retransmit``: Array of `fd_shred_dest_weighted_t` objects for additional retransmit destinations.
    - ``data_shred_net_hdr``: Array containing a single `fd_ip4_udp_hdrs_t` object for data shred network headers.
    - ``parity_shred_net_hdr``: Array containing a single `fd_ip4_udp_hdrs_t` object for parity shred network headers.
    - ``shredder_fec_set_idx``: Unsigned long representing the current FEC set index for the shredder.
    - ``shredder_max_fec_set_idx``: Unsigned long representing the maximum FEC set index for the shredder.
    - ``shredder_merkle_root``: Array of 32 unsigned characters representing the Merkle root for the shredder.
    - ``send_fec_set_idx``: Array of unsigned longs representing the indices of FEC sets to send.
    - ``send_fec_set_cnt``: Unsigned long representing the count of FEC sets to send.
    - ``tsorig``: Unsigned long representing the timestamp of the last packet in compressed form.
    - ``shred_buffer_sz``: Unsigned long representing the size of the shred buffer.
    - ``shred_buffer``: Array of unsigned characters representing the shred buffer.
    - ``in``: Array of `fd_shred_in_ctx_t` objects representing input contexts.
    - ``in_kind``: Array of integers representing the kind of input.
    - ``net_out_mem``: Pointer to an `fd_wksp_t` object for network output memory.
    - ``net_out_chunk0``: Unsigned long representing the initial chunk for network output.
    - ``net_out_wmark``: Unsigned long representing the watermark for network output.
    - ``net_out_chunk``: Unsigned long representing the current chunk for network output.
    - ``store_out_idx``: Unsigned long representing the index for store output.
    - ``store_out_mem``: Pointer to an `fd_wksp_t` object for store output memory.
    - ``store_out_chunk0``: Unsigned long representing the initial chunk for store output.
    - ``store_out_wmark``: Unsigned long representing the watermark for store output.
    - ``store_out_chunk``: Unsigned long representing the current chunk for store output.
    - ``shred_out_idx``: Unsigned long representing the index for shred output.
    - ``shred_out_mem``: Pointer to an `fd_wksp_t` object for shred output memory.
    - ``shred_out_chunk0``: Unsigned long representing the initial chunk for shred output.
    - ``shred_out_wmark``: Unsigned long representing the watermark for shred output.
    - ``shred_out_chunk``: Unsigned long representing the current chunk for shred output.
    - ``store``: Pointer to an `fd_store_t` object.
    - ``gossip_upd_buf``: Array containing a single `fd_gossip_update_message_t` object.
    - ``metrics``: Struct containing various metrics related to shreds.
    - ``pending_batch``: Struct representing a pending batch of microblocks.
    - ``features_activation``: Array containing a single `fd_shred_features_activation_t` object.
    - ``scratchpad_dests``: Array of `fd_shred_dest_idx_t` objects used as a scratchpad for destinations.
    - ``chained_merkle_root``: Pointer to an array of unsigned characters representing the chained Merkle root.
    - ``out_merkle_roots``: Array of `fd_bmtree_node_t` objects representing output Merkle roots.
    - ``block_ids``: 2D array of unsigned characters representing block IDs.
- **Description**: `fd_shred_ctx_t` is a complex data structure used in the context of handling shreds, which are data units in a distributed ledger system. It contains pointers to various components such as the shredder, resolver, and key management systems, as well as arrays and counters for managing shreds, FEC sets, and network communication. The structure also includes fields for tracking metrics, pending batches, and feature activations, making it integral to the processing and management of shreds within the system.


# Functions

---
### scratch\_align<!-- {{#callable:scratch_align}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_tile.c#L263>)

Returns a constant alignment value of 128 for scratch memory.
- **Inputs**: None
- **Logic and Control Flow**:
    - The function is defined as `static inline`, indicating it is intended for use within the same translation unit and suggests inlining for performance.
    - The function returns a constant value `128UL`, which is an unsigned long integer.
- **Output**: An unsigned long integer value of 128, representing the alignment size.


---
### scratch\_footprint<!-- {{#callable:scratch_footprint}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_tile.c#L268>)

Calculates the memory footprint required for a scratch space based on the configuration of a given tile.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure that contains configuration details for the tile, including `shred.depth` and `shred.fec_resolver_depth`.
- **Logic and Control Flow**:
    - Calculate `fec_resolver_footprint` using `fd_fec_resolver_footprint` with parameters from `tile->shred` and constants.
    - Calculate `fec_set_cnt` as the sum of `tile->shred.depth`, `tile->shred.fec_resolver_depth`, and 4.
    - Initialize `l` with `FD_LAYOUT_INIT`.
    - Append various components to `l` using `FD_LAYOUT_APPEND`, including `fd_shred_ctx_t`, `fd_stake_ci`, `fd_fec_resolver`, `fd_shredder`, and `fd_fec_set_t` arrays.
    - Finalize the layout with `FD_LAYOUT_FINI` and return the result.
- **Output**: Returns an `ulong` representing the total memory footprint required for the scratch space.
- **Functions Called**:
    - [`scratch_align`](<#scratch_align>)


---
### during\_housekeeping<!-- {{#callable:during_housekeeping}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_tile.c#L284>)

Checks the state of a keyswitch and performs necessary actions if a key switch is pending.
- **Inputs**:
    - `ctx`: A pointer to a `fd_shred_ctx_t` structure that contains the context for the operation, including keyswitch state and other relevant parameters.
- **Logic and Control Flow**:
    - Check if the keyswitch state is `FD_KEYSWITCH_STATE_SWITCH_PENDING` using `fd_keyswitch_state_query` function.
    - If the keyswitch state is pending, retrieve the `seq_must_complete` value from `ctx->keyswitch->param`.
    - Check if `ctx->poh_in_expect_seq` is less than `seq_must_complete` using `fd_seq_lt` function.
    - If `ctx->poh_in_expect_seq` is less, log a warning message and return without further action.
    - If `ctx->poh_in_expect_seq` is not less, copy the keyswitch bytes to `ctx->identity_key->uc` using `memcpy`.
    - Set the identity in `ctx->stake_ci` using `fd_stake_ci_set_identity`.
    - Change the keyswitch state to `FD_KEYSWITCH_STATE_COMPLETED` using `fd_keyswitch_state`.
- **Output**: No return value; the function performs actions based on the keyswitch state and modifies the context accordingly.


---
### metrics\_write<!-- {{#callable:metrics_write}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_tile.c#L302>)

Copies various metrics from the `ctx->metrics` structure to the SHRED module using predefined macros.
- **Inputs**:
    - `ctx`: A pointer to a `fd_shred_ctx_t` structure that contains the metrics to be copied.
- **Logic and Control Flow**:
    - Copies the `contact_info_cnt` metric from `ctx->metrics` to the SHRED module using `FD_MHIST_COPY` macro.
    - Copies the `batch_sz` metric from `ctx->metrics` to the SHRED module using `FD_MHIST_COPY` macro.
    - Copies the `batch_microblock_cnt` metric from `ctx->metrics` to the SHRED module using `FD_MHIST_COPY` macro.
    - Copies the `shredding_timing` metric from `ctx->metrics` to the SHRED module using `FD_MHIST_COPY` macro.
    - Copies the `add_shred_timing` metric from `ctx->metrics` to the SHRED module using `FD_MHIST_COPY` macro.
    - Sets the `repair_rcv_cnt` metric in the SHRED module using `FD_MCNT_SET` macro.
    - Sets the `turbine_rcv_cnt` metric in the SHRED module using `FD_MCNT_SET` macro.
    - Sets the `invalid_block_id_cnt` metric in the SHRED module using `FD_MCNT_SET` macro.
    - Sets the `shred_rejected_unchained_cnt` metric in the SHRED module using `FD_MCNT_SET` macro.
    - Copies the `store_insert_wait` metric from `ctx->metrics` to the SHRED module using `FD_MHIST_COPY` macro.
    - Copies the `store_insert_work` metric from `ctx->metrics` to the SHRED module using `FD_MHIST_COPY` macro.
    - Copies the `shred_processing_result` metric from `ctx->metrics` to the SHRED module using `FD_MCNT_ENUM_COPY` macro.
- **Output**: No return value; the function operates by side effects on the SHRED module.


---
### handle\_new\_cluster\_contact\_info<!-- {{#callable:handle_new_cluster_contact_info}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_tile.c#L320>)

Processes new cluster contact information from a buffer and updates the context with destination details.
- **Inputs**:
    - ``ctx``: A pointer to `fd_shred_ctx_t` structure, which holds the context for the shred operation.
    - ``buf``: A constant pointer to an unsigned character array containing the buffer with new cluster contact information.
- **Logic and Control Flow**:
    - Casts the `buf` to a constant pointer of type `ulong` to access the header information.
    - Extracts the destination count from the header and logs it using `fd_histf_sample`.
    - Checks if the destination count exceeds `MAX_SHRED_DESTS` and logs an error if true.
    - Casts the remaining buffer to a constant pointer of type `fd_shred_dest_wire_t` to access destination details.
    - Initializes destination storage using `fd_stake_ci_dest_add_init` and updates the context with the new destination pointer and count.
    - Iterates over each destination, copying the public key, IP address, and port from the input destinations to the initialized destination storage.
- **Output**: No return value; updates the `ctx` structure with new destination information.


---
### finalize\_new\_cluster\_contact\_info<!-- {{#callable:finalize_new_cluster_contact_info}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_tile.c#L344>)

Finalizes the addition of new cluster contact information by updating the stake contact information with the new destination count.
- **Inputs**:
    - `ctx`: A pointer to a `fd_shred_ctx_t` structure that contains the context for the shred operation, including the stake contact information and the new destination count.
- **Logic and Control Flow**:
    - Calls the function `fd_stake_ci_dest_add_fini` with `ctx->stake_ci` and `ctx->new_dest_cnt` as arguments.
    - This updates the stake contact information with the new destination count.
- **Output**: No return value; the function operates directly on the provided context.


---
### before\_frag<!-- {{#callable:before_frag}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_tile.c#L349>)

Determines the action to take based on the input kind and signature, and updates the context accordingly.
- **Inputs**:
    - `ctx`: A pointer to a `fd_shred_ctx_t` structure that holds the context for the shred operation.
    - `in_idx`: An unsigned long integer representing the index of the input kind in the context.
    - `seq`: An unsigned long integer representing the sequence number.
    - `sig`: An unsigned long integer representing the signature to be processed.
- **Logic and Control Flow**:
    - If the input kind at `in_idx` is `IN_KIND_IPECHO`, check if `sig` is non-zero and within `USHORT_MAX`, set the shred version in the shredder and resolver, and return 1.
    - If the shredder's shred version is not set, return -1.
    - If the input kind at `in_idx` is `IN_KIND_POH`, set `poh_in_expect_seq` to `seq + 1`, and return a bitwise AND of the results of checking if the packet type of `sig` is not `POH_PKT_TYPE_MICROBLOCK` and not `POH_PKT_TYPE_FEAT_ACT_SLOT`.
    - If the input kind at `in_idx` is `IN_KIND_NET`, return a bitwise AND of the results of checking if the protocol of `sig` is not `DST_PROTO_SHRED` and not `DST_PROTO_REPAIR`.
    - If the input kind at `in_idx` is `IN_KIND_GOSSIP`, return whether `sig` is not equal to `FD_GOSSIP_UPDATE_TAG_CONTACT_INFO` and not equal to `FD_GOSSIP_UPDATE_TAG_CONTACT_INFO_REMOVE`.
    - If none of the above conditions are met, return 0.
- **Output**: An integer indicating the result of the checks and actions performed based on the input kind and signature.


---
### during\_frag<!-- {{#callable:during_frag}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_tile.c#L377>)

Processes incoming fragments based on their type and updates the context accordingly, handling different types of data such as repair, contact, gossip, stake, PoH, and network fragments.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_shred_ctx_t` structure, which holds the context for processing the fragment.
    - ``in_idx``: An unsigned long integer representing the index of the input source in the context.
    - ``seq``: An unsigned long integer representing the sequence number of the fragment (unused in this function).
    - ``sig``: An unsigned long integer representing the signature of the fragment.
    - ``chunk``: An unsigned long integer representing the chunk index of the fragment.
    - ``sz``: An unsigned long integer representing the size of the fragment.
    - ``ctl``: An unsigned long integer representing control information for the fragment.
- **Logic and Control Flow**:
    - Initializes `ctx->skip_frag` to 0 and sets `ctx->tsorig` to the current tick count timestamp.
    - Checks the type of input (`ctx->in_kind[in_idx]`) and processes the fragment accordingly.
    - For `IN_KIND_REPAIR`, `IN_KIND_CONTACT`, `IN_KIND_GOSSIP`, and `IN_KIND_STAKE`, verifies the chunk range and processes the fragment by copying data or handling contact information.
    - For `IN_KIND_POH`, handles feature activation slots and microblocks, managing batch processing, slot changes, and shredding logic.
    - For `IN_KIND_NET`, processes network fragments, verifies signatures, and handles unchained merkle shreds, updating metrics and copying data to the shred buffer.
- **Output**: No direct output is returned; the function modifies the `ctx` structure to reflect the processing of the fragment.
- **Functions Called**:
    - [`handle_new_cluster_contact_info`](<#handle_new_cluster_contact_info>)


---
### send\_shred<!-- {{#callable:send_shred}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_tile.c#L702>)

Sends a network packet containing a shred to a specified destination if the destination IP is valid.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_shred_ctx_t` structure, which contains context information for the shred operation.
    - ``stem``: A pointer to the `fd_stem_context_t` structure, which is used for publishing the packet.
    - ``shred``: A constant pointer to the `fd_shred_t` structure, representing the shred to be sent.
    - ``dest``: A constant pointer to the `fd_shred_dest_weighted_t` structure, which contains the destination IP and port for the shred.
    - ``tsorig``: An unsigned long integer representing the original timestamp of the shred.
- **Logic and Control Flow**:
    - Check if the destination IP (`dest->ip4`) is valid; if not, return immediately.
    - Convert the network output chunk to a local address using `fd_chunk_to_laddr`.
    - Determine if the shred is a data shred using `fd_shred_is_data` and select the appropriate network header (`data_shred_net_hdr` or `parity_shred_net_hdr`).
    - Set the destination IP address and network ID in the IP header, and calculate the IP header checksum using `fd_ip4_hdr_check_fast`.
    - Set the destination port in the UDP header.
    - Determine the size of the shred using `fd_ulong_if` to choose between `FD_SHRED_MIN_SZ` and `FD_SHRED_MAX_SZ`.
    - If AVX is available, use non-temporal writes to copy the shred data to the packet, ensuring not to overwrite the cache line containing the network headers.
    - If AVX is not available, use `fd_memcpy` to copy the shred data to the packet.
    - Calculate the packet size and the publication timestamp (`tspub`).
    - Generate a signature for the packet using `fd_disco_netmux_sig`.
    - Publish the packet using `fd_stem_publish`.
    - Update the network output chunk using `fd_dcache_compact_next`.
- **Output**: No return value; the function sends a network packet containing the shred to the specified destination.


---
### after\_frag<!-- {{#callable:after_frag}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_tile.c#L763>)

Processes fragments based on their type and updates the context accordingly, handling various operations like finalizing contact info, updating stake messages, and managing FEC sets.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_shred_ctx_t` structure, which holds the context for the shred operation.
    - ``in_idx``: An unsigned long integer representing the index of the input fragment.
    - ``seq``: An unsigned long integer representing the sequence number of the fragment (unused in the function).
    - ``sig``: An unsigned long integer representing the signature of the fragment.
    - ``sz``: An unsigned long integer representing the size of the fragment (unused in the function).
    - ``tsorig``: An unsigned long integer representing the original timestamp of the fragment (unused in the function).
    - ``_tspub``: An unsigned long integer representing the publication timestamp of the fragment (unused in the function).
    - ``stem``: A pointer to the `fd_stem_context_t` structure, which is used for publishing operations.
- **Logic and Control Flow**:
    - Check if `ctx->skip_frag` is true; if so, return immediately.
    - Handle fragments of type `IN_KIND_CONTACT` by finalizing new cluster contact info.
    - Handle fragments of type `IN_KIND_STAKE` by finalizing stake messages.
    - For `IN_KIND_GOSSIP`, update or remove contact info based on the tag in `ctx->gossip_upd_buf`.
    - For `IN_KIND_POH`, return if no new FEC set was triggered.
    - For `IN_KIND_REPAIR`, check if the FEC set is already completed; if not, attempt to force complete it.
    - For `IN_KIND_NET`, parse the shred, validate it, and update the FEC resolver; handle retransmission and store operations if necessary.
    - If `ctx->send_fec_set_cnt` is zero, return.
    - Distribute shredded transaction counts across FEC sets and update metrics.
    - For each FEC set, insert shreds into the store and notify repair and replay tiles if necessary.
- **Output**: No return value; the function modifies the context and performs operations based on the fragment type.
- **Functions Called**:
    - [`finalize_new_cluster_contact_info`](<#finalize_new_cluster_contact_info>)
    - [`send_shred`](<#send_shred>)


---
### privileged\_init<!-- {{#callable:privileged_init}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_tile.c#L1178>)

Initializes a privileged context for a shred tile by allocating memory and loading an identity key.
- **Inputs**:
    - ``topo``: A pointer to an `fd_topo_t` structure representing the topology of the system.
    - ``tile``: A pointer to an `fd_topo_tile_t` structure representing the specific tile configuration.
- **Logic and Control Flow**:
    - Calls `fd_topo_obj_laddr` to get the local address of the object associated with the tile's object ID.
    - Checks if the `scratch` pointer is not NULL using `FD_TEST`.
    - Initializes a scratch allocator with `FD_SCRATCH_ALLOC_INIT`.
    - Allocates memory for an `fd_shred_ctx_t` structure using `FD_SCRATCH_ALLOC_APPEND`.
    - Checks if the `identity_key_path` in `tile->shred` is an empty string and logs an error if true.
    - Loads the identity key from the specified path using `fd_keyload_load` and assigns it to `ctx->identity_key`.
- **Output**: No return value; the function operates by side effects, initializing the context and logging errors if necessary.


---
### fd\_shred\_signer<!-- {{#callable:fd_shred_signer}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_tile.c#L1193>)

Signs a Merkle root using the ED25519 signature type.
- **Inputs**:
    - `signer_ctx`: A pointer to the signer context, which is used to access the signing functionality.
    - `signature`: An array of 64 unsigned characters where the function will store the generated signature.
    - `merkle_root`: A constant array of 32 unsigned characters representing the Merkle root to be signed.
- **Logic and Control Flow**:
    - Calls the `fd_keyguard_client_sign` function with the provided `signer_ctx`, `signature`, `merkle_root`, a fixed size of 32, and the signature type `FD_KEYGUARD_SIGN_TYPE_ED25519`.
- **Output**: The function does not return a value; it outputs the signature directly into the `signature` array.


---
### unprivileged\_init<!-- {{#callable:unprivileged_init}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_tile.c#L1200>)

Initializes the unprivileged context for a shred tile in a network topology.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure representing the network topology.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure representing the specific tile in the topology to initialize.
- **Logic and Control Flow**:
    - Verify that the output links of the tile match expected names 'shred_net' and 'shred_sign'.
    - Check if the tile has any primary output links; log an error if not.
    - Ensure the depth of the first output link matches the `shred_store_mcache_depth`; log an error if not.
    - Allocate scratch memory for the context and initialize it with `fd_shred_ctx_t`.
    - Set up the round-robin count and ID for the context.
    - Calculate the footprint for the FEC resolver and the required size for FEC sets.
    - Determine the shared memory for FEC sets based on the topology and tile configuration.
    - Check if the `fec_resolver_depth` and `shred_listen_port` are set; log an error if not.
    - Allocate memory for various components like stake, resolver, shredder, and FEC sets.
    - Initialize FEC sets and their associated memory structures.
    - Determine the expected shred version, either from the tile configuration or via gossip if not set.
    - Join the keyswitch object and verify its presence.
    - Find and verify the input link for 'sign_shred'.
    - Initialize the keyguard client with the appropriate caches and MTU.
    - Set up the shredder and resolver with the expected shred version.
    - Initialize network headers for data and parity shreds.
    - Configure additional destinations for retransmission and leader destinations.
    - Iterate over input links to set their kind and initialize memory bounds.
    - Set up the output memory and chunk management for network and store outputs.
    - Initialize various context fields like `poh_in_expect_seq`, `shredder_fec_set_idx`, and metrics.
    - Finalize the scratch memory allocation and check for overflow.
    - Clear the block IDs in the context.
- **Output**: No return value; the function initializes the context for a shred tile.
- **Functions Called**:
    - [`scratch_footprint`](<#scratch_footprint>)


---
### populate\_allowed\_seccomp<!-- {{#callable:populate_allowed_seccomp}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_tile.c#L1478>)

Populates a seccomp filter policy for a shred tile and returns the instruction count.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, representing the topology configuration.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure, representing the tile configuration.
    - ``out_cnt``: An unsigned long integer representing the count of output filters.
    - ``out``: A pointer to a `struct sock_filter` array where the seccomp filter policy will be populated.
- **Logic and Control Flow**:
    - The function does not use the `topo` and `tile` parameters, as indicated by the `(void)` casts.
    - Calls [`populate_sock_filter_policy_fd_shred_tile`](<generated/fd_shred_tile_seccomp.h.md#populate_sock_filter_policy_fd_shred_tile>) with `out_cnt`, `out`, and the file descriptor from `fd_log_private_logfile_fd()`.
    - Returns the value of `sock_filter_policy_fd_shred_tile_instr_cnt`.
- **Output**: Returns an unsigned long integer representing the instruction count of the seccomp filter policy.
- **Functions Called**:
    - [`populate_sock_filter_policy_fd_shred_tile`](<generated/fd_shred_tile_seccomp.h.md#populate_sock_filter_policy_fd_shred_tile>)


---
### populate\_allowed\_fds<!-- {{#callable:populate_allowed_fds}} -->
[View Source →](<../../../../../src/disco/shred/fd_shred_tile.c#L1490>)

Populates an array with allowed file descriptors, including `stderr` and optionally a logfile descriptor.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, which is not used in this function.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure, which is not used in this function.
    - ``out_fds_cnt``: The maximum number of file descriptors that can be stored in the `out_fds` array.
    - ``out_fds``: An array of integers where the function will store the allowed file descriptors.
- **Logic and Control Flow**:
    - Ignore the `topo` and `tile` parameters as they are not used in the function.
    - Check if `out_fds_cnt` is less than 2; if so, log an error and terminate the program.
    - Initialize `out_cnt` to 0 to keep track of the number of file descriptors added.
    - Add the file descriptor for `stderr` (which is 2) to the `out_fds` array and increment `out_cnt`.
    - Check if the logfile descriptor is valid (not equal to -1); if valid, add it to the `out_fds` array and increment `out_cnt`.
    - Return the number of file descriptors added to the `out_fds` array.
- **Output**: Returns the number of file descriptors added to the `out_fds` array.



---
Made with ❤️ by [Driver](https://www.driver.ai/)