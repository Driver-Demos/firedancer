<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for securely loading, parsing, and managing validator identity keys from JSON files.

# Purpose
The code is a C module designed to securely load and manage cryptographic keys from a file. It provides functions to read a key from a specified file path, load it into a protected memory region, and unload it when no longer needed. The primary function, `fd_keyload_load`, reads a key file, which is expected to be formatted as a 64-element JSON array, and stores the key in a memory page that is protected against unauthorized access. The module uses system calls like `mmap`, `mprotect`, and `mlock` to allocate memory pages with guard pages, making them non-dumpable and read-only to enhance security. The [`fd_keyload_unload`](<#fd_fn_sensitivefd_keyload_unload>) function is responsible for securely erasing the key from memory and releasing the allocated pages.

The module also includes utility functions such as [`fd_keyload_alloc_protected_pages`](<#fd_fn_sensitivefd_keyload_alloc_protected_pages>) to allocate memory with specific protection settings and `fd_keyload_read` to parse the key file. Error handling is implemented throughout the code using macros like `FD_LOG_ERR` to log errors and terminate execution if operations fail. The code is intended to be part of a larger system where secure key management is critical, such as in a blockchain or cryptographic application. It does not define public APIs but provides internal functions for secure key handling.
# Imports and Dependencies

---
- `fd_keyload.h`
- `errno.h`
- `string.h`
- `fcntl.h`
- `unistd.h`
- `stdio.h`
- `sys/mman.h`


# Functions

---
### read\_key<!-- {{#callable:FD_FN_SENSITIVE::read_key}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyload.c#L63>)

Opens a key file from a specified path and reads its contents into a provided buffer.
- **Inputs**:
    - `key_path`: A constant character pointer to the path of the key file to open and read.
    - `key`: A pointer to an unsigned character array where the key data will be stored.
- **Logic and Control Flow**:
    - Opens the file at the path specified by `key_path` in read-only mode.
    - Checks if the file descriptor `key_fd` is -1, indicating an error in opening the file.
    - If the error is due to the file not existing (`ENOENT`), logs an error message about the missing key file and suggests updating the configuration or generating a new key.
    - If the error is due to other reasons, logs an error message with details about the failure to open the file.
    - Calls `fd_keyload_read` to read the key data from the opened file descriptor into the `key` buffer.
- **Output**: Returns a pointer to the buffer containing the key data read from the file.


---
### fd\_keyload\_unload<!-- {{#callable:FD_FN_SENSITIVE::fd_keyload_unload}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyload.c#L102>)

Unloads a key from memory by clearing its contents and unmapping its memory pages.
- **Inputs**:
    - `key`: A pointer to the key data in memory.
    - `public_key_only`: An integer flag indicating if only the public key is used (non-zero) or the full key (zero).
- **Logic and Control Flow**:
    - Determine the starting address of the key page based on the `public_key_only` flag.
    - Calculate the size of the memory region to unmap, which includes the key page and guard pages.
    - Attempt to change the memory protection of the key page to allow read and write access using `mprotect`.
    - If `mprotect` fails, log an error message and terminate the process.
    - Clear the contents of the key page using `explicit_bzero`.
    - Attempt to unmap the memory region using `munmap`.
    - If `munmap` fails, log an error message and terminate the process.
- **Output**: None (the function does not return a value).


---
### fd\_keyload\_alloc\_protected\_pages<!-- {{#callable:FD_FN_SENSITIVE::fd_keyload_alloc_protected_pages}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyload.c#L116>)

Allocates memory pages with guard pages for protection and configures them to be non-swappable and non-dumpable.
- **Inputs**:
    - `page_cnt`: The number of pages to allocate for use.
    - `guard_page_cnt`: The number of guard pages to allocate on each side of the usable pages.
- **Logic and Control Flow**:
    - Define `PAGE_SZ` as 4096 bytes, representing the size of a memory page.
    - Use `mmap` to allocate a block of memory that includes the requested pages and the guard pages on both sides, with read and write permissions.
    - Check if `mmap` fails and log an error if it does.
    - Calculate the starting address of the usable pages by adding the size of the guard pages to the base address.
    - Use `mprotect` to set the guard pages to `PROT_NONE`, making them inaccessible.
    - Check if `mprotect` fails and log an error if it does.
    - Use `mlock` to lock the usable pages in memory, preventing them from being swapped to disk.
    - Check if `mlock` fails and log an error if it does.
    - Use `madvise` to set the usable pages to `MADV_WIPEONFORK` and `MADV_DONTDUMP`, preventing them from being included in core dumps and forked processes.
    - Check if `madvise` fails and log an error if it does.
    - Return the pointer to the start of the usable pages.
- **Output**: A pointer to the start of the allocated and protected usable pages.



---
Made with ❤️ by [Driver](https://www.driver.ai/)