<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements logic to fingerprint and verify signing requests to prevent fake signing attacks.

# Purpose
The code is a C module that implements a function to match and verify different types of signing requests to prevent unauthorized signing, known as "fake signing" attacks. The primary function, [`fd_keyguard_payload_match`](<#fd_keyguard_payload_match>), checks if a given payload matches any of the supported message types, such as transaction messages, gossip messages, and TLS CertificateVerify challenges. Each message type has a dedicated function to verify its structure and signature type, ensuring that the payload is correctly identified and authorized. The module is part of a larger system that secures identity keys, particularly in blockchain validator contexts, where unauthorized signing could lead to significant security breaches.

The module uses formal verification techniques to ensure the reliability of its logic. It employs CBMC (C Bounded Model Checker) proofs to verify that the type detection logic is free of false negatives, meaning it will correctly identify a transaction when it is present. The code is designed to handle untrusted inputs and serves as the first line of defense in the authorization process. The implementation avoids using complex parsers to maintain a time complexity of O(1), which is necessary for complete CBMC coverage. This approach ensures that the module can handle a wide range of inputs securely and efficiently.
# Imports and Dependencies

---
- `fd_keyguard.h`
- `../../ballet/shred/fd_shred.h`
- `../../ballet/txn/fd_compact_u16.h`


# Functions

---
### fd\_keyguard\_payload\_matches\_txn\_msg<!-- {{#callable:fd_keyguard_payload_matches_txn_msg}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyguard_match.c#L87>)

Checks if the given data matches the expected format of a transaction message with Ed25519 signatures.
- **Inputs**:
    - ``data``: A pointer to the unsigned character array containing the data to check.
    - ``sz``: The size of the data in bytes.
    - ``sign_type``: The type of signature expected, specifically `FD_KEYGUARD_SIGN_TYPE_ED25519`.
- **Logic and Control Flow**:
    - Set `end` to point to the end of the data array by adding `sz` to `data`.
    - Return 0 if `sign_type` is not `FD_KEYGUARD_SIGN_TYPE_ED25519`.
    - Calculate `txn_msg_min_sz` as the minimum size of a valid transaction message and return 0 if `sz` is less than this value.
    - Initialize `cursor` to point to the start of `data` and read the first byte into `header_b0`.
    - Determine the signature count `sig_cnt` based on the message type (versioned or legacy) and return 0 if the message type is unrecognized or if `sig_cnt` is zero.
    - Calculate the total size of the signatures `sig_sz` and return 0 if it exceeds the transaction size limit.
    - Skip the readonly signed and unsigned count fields by incrementing `cursor`.
    - Check if there is enough data left for address count decoding and return 0 if not.
    - Decode the address count size and value, and return 0 if decoding fails or if `sig_cnt` is greater than the address count.
    - Return 1 if all checks pass, indicating the data matches the expected transaction message format.
- **Output**: Returns 1 if the data matches the expected transaction message format, otherwise returns 0.


---
### fd\_keyguard\_payload\_matches\_ping\_msg<!-- {{#callable:fd_keyguard_payload_matches_ping_msg}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyguard_match.c#L159>)

Checks if the payload matches a specific 'ping' message format for signing.
- **Inputs**:
    - ``data``: A pointer to the payload data to check.
    - ``sz``: The size of the payload data.
    - ``sign_type``: The type of signature used for the payload.
- **Logic and Control Flow**:
    - Check if `sign_type` is `FD_KEYGUARD_SIGN_TYPE_ED25519`.
    - Verify that `sz` is equal to 32.
    - Compare the first 16 bytes of `data` with the string "SOLANA_PING_PONG" using `memcmp`.
    - Return the result of the logical AND operation of the above conditions.
- **Output**: Returns 1 if the payload matches the 'ping' message format; otherwise, returns 0.


---
### fd\_keyguard\_payload\_matches\_pong\_msg<!-- {{#callable:fd_keyguard_payload_matches_pong_msg}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyguard_match.c#L168>)

Checks if the payload matches a specific 'pong' message format.
- **Inputs**:
    - `data`: A pointer to the payload data to check.
    - `sz`: The size of the payload data.
    - `sign_type`: The type of signature used for the payload.
- **Logic and Control Flow**:
    - Checks if `sign_type` is equal to `FD_KEYGUARD_SIGN_TYPE_SHA256_ED25519`.
    - Checks if `sz` is equal to 48.
    - Compares the first 16 bytes of `data` with the string "SOLANA_PING_PONG" using `memcmp`.
    - Returns 1 if all conditions are true, otherwise returns 0.
- **Output**: Returns 1 if the payload matches the 'pong' message format, otherwise returns 0.


---
### fd\_keyguard\_payload\_matches\_prune\_data<!-- {{#callable:fd_keyguard_payload_matches_prune_data}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyguard_match.c#L177>)

Checks if the payload matches the expected size for prune data based on the signature type and data size.
- **Inputs**:
    - ``data``: A pointer to the unsigned character array containing the payload data.
    - ``sz``: The size of the payload data in bytes.
    - ``sign_type``: The type of signature used, expected to be `FD_KEYGUARD_SIGN_TYPE_ED25519` for this function to proceed.
- **Logic and Control Flow**:
    - Check if `sign_type` is `FD_KEYGUARD_SIGN_TYPE_ED25519`; if not, return 0.
    - Define a constant `static_sz` with a value of 80.
    - Check if `sz` is less than `static_sz`; if true, return 0.
    - Load a `ulong` value `prune_cnt` from `data` at offset 32.
    - Calculate `expected_sz` by multiplying `prune_cnt` by 32 and adding `static_sz`, checking for overflow; if overflow occurs, return 0.
    - Check if `sz` equals `expected_sz`; if not, return 0.
    - Return 1 if all checks pass.
- **Output**: Returns 1 if the payload matches the expected size for prune data; otherwise, returns 0.


---
### fd\_keyguard\_payload\_matches\_gossip<!-- {{#callable:fd_keyguard_payload_matches_gossip}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyguard_match.c#L196>)

Checks if a given payload matches the criteria for a gossip message with a specific signing type.
- **Inputs**:
    - ``data``: A pointer to the unsigned character array representing the payload data.
    - ``sz``: The size of the payload data in bytes.
    - ``sign_type``: An integer representing the type of signing used for the payload.
- **Logic and Control Flow**:
    - If `sign_type` is not `FD_KEYGUARD_SIGN_TYPE_ED25519`, return 0.
    - If `sz` is less than 36, return 0.
    - Check if the first byte of `data` is less than 0x20 and the next three bytes are 0x00; if true, return 1.
    - If none of the above conditions are met, return 0.
- **Output**: Returns 1 if the payload matches the criteria for a gossip message; otherwise, returns 0.


---
### fd\_keyguard\_payload\_matches\_repair<!-- {{#callable:fd_keyguard_payload_matches_repair}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyguard_match.c#L220>)

Checks if a repair message payload matches specific criteria for signing.
- **Inputs**:
    - ``data``: A pointer to the message data to check.
    - ``sz``: The size of the message data.
    - ``sign_type``: The type of signing used for the message.
- **Logic and Control Flow**:
    - If `sign_type` is not `FD_KEYGUARD_SIGN_TYPE_ED25519`, return 0.
    - If `sz` is less than 36, return 0.
    - If the first byte of `data` is less than 0x20 and the next three bytes are 0x00, return 1.
    - Return 0 if none of the conditions are met.
- **Output**: Returns 1 if the message matches the criteria for a repair message, otherwise returns 0.


---
### fd\_keyguard\_payload\_matches\_shred<!-- {{#callable:fd_keyguard_payload_matches_shred}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyguard_match.c#L244>)

Checks if the payload matches the criteria for a shred message based on signature type and size.
- **Inputs**:
    - ``data``: A pointer to the payload data to check.
    - ``sz``: The size of the payload data.
    - ``sign_type``: The type of signature used for the payload.
- **Logic and Control Flow**:
    - Ignore the `data` parameter as it is not used in the function.
    - Check if `sign_type` is equal to `FD_KEYGUARD_SIGN_TYPE_ED25519`; if not, return 0.
    - Check if `sz` is equal to 32; if not, return 0.
    - Return 1 if both conditions are met.
- **Output**: Returns 1 if the payload matches the criteria for a shred message; otherwise, returns 0.


---
### fd\_keyguard\_payload\_matches\_tls\_cv<!-- {{#callable:fd_keyguard_payload_matches_tls_cv}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyguard_match.c#L259>)

Checks if a given payload matches the TLS CertificateVerify pattern for a specific signing type and size.
- **Inputs**:
    - ``data``: A pointer to the payload data to check.
    - ``sz``: The size of the payload data.
    - ``sign_type``: The type of signing used, expected to be `FD_KEYGUARD_SIGN_TYPE_ED25519`.
- **Logic and Control Flow**:
    - Return 0 if `sign_type` is not `FD_KEYGUARD_SIGN_TYPE_ED25519`.
    - Check if `sz` matches one of the predefined sizes (130, 146, or 162 bytes); return 0 if not.
    - Define static client and server prefix patterns for TLS 1.3 CertificateVerify messages.
    - Compare the beginning of `data` with the client and server prefixes using `memcmp`.
    - Return 1 if `data` matches either the client or server prefix, otherwise return 0.
- **Output**: Returns 1 if the payload matches the TLS CertificateVerify pattern for the specified signing type and size, otherwise returns 0.


---
### fd\_keyguard\_payload\_matches\_bundle<!-- {{#callable:fd_keyguard_payload_matches_bundle}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyguard_match.c#L291>)

Checks if the payload matches a specific bundle signature type and size.
- **Inputs**:
    - ``data``: Pointer to the payload data to check.
    - ``sz``: Size of the payload data.
    - ``sign_type``: Type of signature used for the payload.
- **Logic and Control Flow**:
    - Ignore the `data` parameter as it is not used in the function.
    - Check if `sign_type` is equal to `FD_KEYGUARD_SIGN_TYPE_PUBKEY_CONCAT_ED25519`; if not, return 0.
    - Check if `sz` is equal to 9; if not, return 0.
    - Return 1 if both conditions are met.
- **Output**: Returns 1 if the payload matches the specified signature type and size, otherwise returns 0.


---
### fd\_keyguard\_payload\_matches\_event<!-- {{#callable:fd_keyguard_payload_matches_event}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyguard_match.c#L303>)

Checks if the payload matches an event signature type and size.
- **Inputs**:
    - ``data``: A pointer to the payload data to check.
    - ``sz``: The size of the payload data.
    - ``sign_type``: The type of signature to check against.
- **Logic and Control Flow**:
    - Ignore the `data` parameter as it is not used in the function.
    - Check if `sign_type` is equal to `FD_KEYGUARD_SIGN_TYPE_FD_METRICS_REPORT_CONCAT_ED25519`.
    - If `sign_type` does not match, return 0.
    - Check if `sz` is equal to 32UL.
    - If `sz` does not match, return 0.
    - If both conditions are met, return 1.
- **Output**: Returns 1 if the payload matches the specified event signature type and size, otherwise returns 0.


---
### fd\_keyguard\_payload\_match<!-- {{#callable:fd_keyguard_payload_match}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyguard_match.c#L315>)

Determines the type of a payload by checking it against various known message types and returns a bitmask indicating the matches.
- **Inputs**:
    - ``data``: A pointer to the payload data to be checked.
    - ``sz``: The size of the payload data in bytes.
    - ``sign_type``: The type of signature used for the payload.
- **Logic and Control Flow**:
    - Initialize a result variable `res` to 0.
    - For each known message type, call the corresponding match function with `data`, `sz`, and `sign_type`.
    - Use `fd_ulong_if` to set the corresponding bit in `res` if the match function returns true.
    - Return the `res` variable, which contains a bitmask of the matched message types.
- **Output**: Returns a `ulong` bitmask where each bit represents whether the payload matches a specific message type.
- **Functions Called**:
    - [`fd_keyguard_payload_matches_txn_msg`](<#fd_keyguard_payload_matches_txn_msg>)
    - [`fd_keyguard_payload_matches_gossip`](<#fd_keyguard_payload_matches_gossip>)
    - [`fd_keyguard_payload_matches_repair`](<#fd_keyguard_payload_matches_repair>)
    - [`fd_keyguard_payload_matches_prune_data`](<#fd_keyguard_payload_matches_prune_data>)
    - [`fd_keyguard_payload_matches_shred`](<#fd_keyguard_payload_matches_shred>)
    - [`fd_keyguard_payload_matches_tls_cv`](<#fd_keyguard_payload_matches_tls_cv>)
    - [`fd_keyguard_payload_matches_ping_msg`](<#fd_keyguard_payload_matches_ping_msg>)
    - [`fd_keyguard_payload_matches_pong_msg`](<#fd_keyguard_payload_matches_pong_msg>)
    - [`fd_keyguard_payload_matches_bundle`](<#fd_keyguard_payload_matches_bundle>)
    - [`fd_keyguard_payload_matches_event`](<#fd_keyguard_payload_matches_event>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)