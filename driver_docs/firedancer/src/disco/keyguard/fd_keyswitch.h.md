<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

APIs for managing the state and lifecycle of a keyswitch in shared memory.

# Purpose
The code is a C header file that defines the interface and data structures for managing a "key switch" mechanism, which is used for out-of-band switching of a validator's key. The file provides a set of macros, data structures, and function prototypes that facilitate the creation, management, and querying of a key switch. The key switch is represented by the `fd_keyswitch_t` structure, which includes fields for magic number verification, state management, and additional parameters.

The header file defines several constants for alignment, footprint, and various states of the key switch, such as `FD_KEYSWITCH_STATE_UNLOCKED`, `FD_KEYSWITCH_STATE_LOCKED`, and others. It provides function prototypes for creating ([`fd_keyswitch_new`](<#fd_keyswitch_new>)), joining ([`fd_keyswitch_join`](<#fd_keyswitch_join>)), leaving ([`fd_keyswitch_leave`](<#fd_keyswitch_leave>)), and deleting ([`fd_keyswitch_delete`](<#fd_keyswitch_delete>)) a key switch. Additionally, it includes inline functions for querying the current state and parameters of the key switch ([`fd_keyswitch_state_query`](<#fd_keyswitch_state_query>) and [`fd_keyswitch_param_query`](<#fd_keyswitch_param_query>)) and for changing the state ([`fd_keyswitch_state`](<#fd_keyswitch_state>)). The file ensures that operations on the key switch are performed with proper memory alignment and synchronization using compiler fences.
# Imports and Dependencies

---
- `../fd_disco_base.h`


# Data Structures

---
### fd\_keyswitch\_private
- **Type**: ``struct fd_keyswitch_private``
- **Members**:
    - `magic`: A magic number used to identify the structure, expected to be `FD_KEYSWITCH_MAGIC`.
    - `state`: Represents the current state of the keyswitch.
    - `result`: Stores the result of the keyswitch operation.
    - `param`: Holds additional parameters for the keyswitch operation.
    - `bytes`: An array of 64 unsigned characters used for additional data storage.
- **Description**: Defines a private data structure for managing the state and parameters of a keyswitch operation, aligned to `FD_KEYSWITCH_ALIGN` and identified by a magic number `FD_KEYSWITCH_MAGIC`. It includes fields for state management, operation results, and additional parameters, with a byte array for extra data storage.


---
### fd\_keyswitch\_t
- **Type**: ``struct``
- **Members**:
    - `magic`: A magic number used to identify the structure, expected to be `FD_KEYSWITCH_MAGIC`.
    - `state`: Represents the current state of the keyswitch.
    - `result`: Stores the result of the last operation performed on the keyswitch.
    - `param`: Holds additional parameters related to the keyswitch operation.
    - `bytes`: An array of 64 bytes used for internal data storage or padding.
- **Description**: The `fd_keyswitch_t` structure is a private data structure used to manage the state and operations of a keyswitch, which is a mechanism for out-of-band switching of a validator's key. It includes fields for a magic number, state, result, parameters, and a byte array for internal use, all aligned to a specified boundary. The structure supports various states such as unlocked, locked, switch pending, unhalt pending, failed, and completed, and provides functions for creating, joining, leaving, and deleting a keyswitch, as well as querying and setting its state.


# Functions

---
### fd\_keyswitch\_state\_query<!-- {{#callable:fd_keyswitch_state_query}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyswitch.h#L94>)

Retrieves the current state of a keyswitch with memory fence operations to ensure proper ordering.
- **Inputs**:
    - `ks`: A pointer to a `fd_keyswitch_t` structure, which must be a current local join.
- **Logic and Control Flow**:
    - Execute a memory fence operation using `FD_COMPILER_MFENCE()` to ensure memory operations are completed before proceeding.
    - Read the `state` field from the `fd_keyswitch_t` structure pointed to by `ks` using `FD_VOLATILE_CONST` to prevent compiler optimizations that could reorder operations.
    - Execute another memory fence operation using `FD_COMPILER_MFENCE()` to ensure the read operation is completed before any subsequent operations.
    - Return the value of the `state` field.
- **Output**: The function returns the current state of the keyswitch as an `ulong` value.


---
### fd\_keyswitch\_param\_query<!-- {{#callable:fd_keyswitch_param_query}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyswitch.h#L107>)

Retrieves the current `param` value from a `fd_keyswitch_t` structure with memory fence operations to ensure data consistency.
- **Inputs**:
    - `ks`: A pointer to a `fd_keyswitch_t` structure, which must be a current local join.
- **Logic and Control Flow**:
    - Execute a compiler memory fence operation using `FD_COMPILER_MFENCE()` to ensure memory operations are completed before proceeding.
    - Read the `param` field from the `fd_keyswitch_t` structure pointed to by `ks` using `FD_VOLATILE_CONST` to prevent compiler optimizations that could reorder operations.
    - Execute another compiler memory fence operation to ensure the read operation is completed before any subsequent operations.
    - Return the value of the `param` field.
- **Output**: Returns the current `param` value from the `fd_keyswitch_t` structure as an `ulong`.


---
### fd\_keyswitch\_state<!-- {{#callable:fd_keyswitch_state}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyswitch.h#L120>)

Sets the state of a `fd_keyswitch_t` object to a specified value with memory fencing for synchronization.
- **Inputs**:
    - `ks`: A pointer to a `fd_keyswitch_t` object whose state will be set.
    - `s`: An unsigned long integer representing the new state to set for the `fd_keyswitch_t` object.
- **Logic and Control Flow**:
    - Execute a memory fence using `FD_COMPILER_MFENCE()` to ensure memory operations are completed before setting the state.
    - Set the `state` field of the `fd_keyswitch_t` object pointed to by `ks` to the value `s` using `FD_VOLATILE`.
    - Execute another memory fence using `FD_COMPILER_MFENCE()` to ensure the state change is visible to other threads.
- **Output**: This function does not return a value.


# Function Declarations (Public API)

---
### fd\_keyswitch\_align<!-- {{#callable_declaration:fd_keyswitch_align}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyswitch.h#L33>)

Returns the required memory alignment for a keyswitch.
- **Description**: Use this function to obtain the alignment requirement for a memory region intended for use as a keyswitch. This is necessary when allocating memory to ensure that the region is correctly aligned for keyswitch operations. The function does not require any parameters and can be called at any time to retrieve the alignment value.
- **Inputs**: None
- **Output**: The function returns an unsigned long integer representing the alignment requirement, which is a constant value defined as `FD_KEYSWITCH_ALIGN`.
- **See Also**: [`fd_keyswitch_align`](<fd_keyswitch.c.md#fd_keyswitch_align>)  (Implementation)


---
### fd\_keyswitch\_footprint<!-- {{#callable_declaration:fd_keyswitch_footprint}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyswitch.h#L42>)

Returns the memory footprint required for a keyswitch.
- **Description**: Use this function to determine the size of the memory region needed to store a keyswitch. This is useful when allocating memory for a keyswitch to ensure that the region is large enough to accommodate it. The function does not require any parameters and can be called at any time to retrieve the constant footprint size.
- **Inputs**: None
- **Output**: The function returns an unsigned long integer representing the memory footprint size required for a keyswitch.
- **See Also**: [`fd_keyswitch_footprint`](<fd_keyswitch.c.md#fd_keyswitch_footprint>)  (Implementation)


---
### fd\_keyswitch\_new<!-- {{#callable_declaration:fd_keyswitch_new}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyswitch.h#L54>)

Formats a memory region for use as a keyswitch.
- **Description**: Use this function to initialize a memory region as a keyswitch. The memory region must be non-null, properly aligned, and have the required footprint. The function sets the initial state of the keyswitch to the specified value. If the memory region is null or misaligned, the function logs a warning and returns null. This function does not join the caller to the keyswitch.
- **Inputs**:
    - `shmem`: A non-null pointer to a memory region with the required alignment and footprint for a keyswitch. The caller retains ownership. If null or misaligned, the function logs a warning and returns null.
    - `state`: The initial state of the keyswitch. It should be a value in the range [0, UINT_MAX].
- **Output**: Returns a pointer to the formatted keyswitch on success, or null on failure.
- **See Also**: [`fd_keyswitch_new`](<fd_keyswitch.c.md#fd_keyswitch_new>)  (Implementation)


---
### fd\_keyswitch\_join<!-- {{#callable_declaration:fd_keyswitch_join}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyswitch.h#L68>)

Joins the caller to a keyswitch.
- **Description**: Use this function to join a caller to a keyswitch, which is a memory region formatted for key switching operations. The function requires a pointer to the memory region (`shks`) that backs the keyswitch in the caller's address space. Ensure that the memory region is properly aligned and initialized with the correct magic number before calling. This function returns a pointer to the keyswitch on success, or NULL if the input is invalid or the memory region is not correctly formatted. A successful join must be followed by a corresponding leave operation to maintain proper resource management.
- **Inputs**:
    - `shks`: A pointer to the first byte of the memory region backing the keyswitch. Must not be NULL and must be aligned according to `fd_keyswitch_align()`. The memory region must contain a valid keyswitch with the correct magic number. If these conditions are not met, the function returns NULL and logs a warning.
- **Output**: Returns a pointer to the keyswitch on success, or NULL if the input is invalid or the memory region is not correctly formatted.
- **See Also**: [`fd_keyswitch_join`](<fd_keyswitch.c.md#fd_keyswitch_join>)  (Implementation)


---
### fd\_keyswitch\_leave<!-- {{#callable_declaration:fd_keyswitch_leave}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyswitch.h#L76>)

Leaves a current local join of a keyswitch.
- **Description**: Use this function to leave a current local join of a keyswitch. It returns a pointer to the underlying shared memory region on success. If the input is null, it logs a warning and returns null. Ensure that the input is a valid pointer to a keyswitch before calling this function.
- **Inputs**:
    - `ks`: A constant pointer to a `fd_keyswitch_t` structure representing the keyswitch to leave. Must not be null. If null, the function logs a warning and returns null.
- **Output**: Returns a pointer to the underlying shared memory region on success, or null if the input is null.
- **See Also**: [`fd_keyswitch_leave`](<fd_keyswitch.c.md#fd_keyswitch_leave>)  (Implementation)


---
### fd\_keyswitch\_delete<!-- {{#callable_declaration:fd_keyswitch_delete}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyswitch.h#L86>)

Unformats a memory region used as a keyswitch.
- **Description**: Use this function to unformat a memory region that was previously formatted as a keyswitch. Ensure that no threads are joined to the keyswitch before calling this function. This function transfers ownership of the memory region back to the caller upon success. It returns a pointer to the underlying shared memory region or NULL if the input is invalid, such as when the pointer does not reference a valid keyswitch. The function logs details of any errors encountered.
- **Inputs**:
    - `shkc`: A pointer to the memory region used as a keyswitch. The pointer must be non-NULL, aligned according to `fd_keyswitch_align()`, and reference a valid keyswitch with the correct magic number. If these conditions are not met, the function returns NULL and logs a warning.
- **Output**: Returns a pointer to the underlying shared memory region on success, or NULL if the input is invalid.
- **See Also**: [`fd_keyswitch_delete`](<fd_keyswitch.c.md#fd_keyswitch_delete>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)