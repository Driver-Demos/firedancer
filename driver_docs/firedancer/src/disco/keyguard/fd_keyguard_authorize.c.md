<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements authorization functions for various payload types and roles in the Firedancer keyguard system.

# Purpose
The code is a C source file that implements authorization functions for different types of payloads in a system. It includes several static functions that check the validity of payloads based on their type, size, and signature type. These functions include [`fd_keyguard_authorize_vote_txn`](<#fd_keyguard_authorize_vote_txn>), [`fd_keyguard_authorize_gossip`](<#fd_keyguard_authorize_gossip>), [`fd_keyguard_authorize_bundle_crank_txn`](<#fd_keyguard_authorize_bundle_crank_txn>), [`fd_keyguard_authorize_ping`](<#fd_keyguard_authorize_ping>), [`fd_keyguard_authorize_pong`](<#fd_keyguard_authorize_pong>), [`fd_keyguard_authorize_gossip_prune`](<#fd_keyguard_authorize_gossip_prune>), [`fd_keyguard_authorize_repair`](<#fd_keyguard_authorize_repair>), and [`fd_keyguard_authorize_tls_cv`](<#fd_keyguard_authorize_tls_cv>). Each function performs specific checks to ensure that the payload meets the required criteria for authorization.

The main function, [`fd_keyguard_payload_authorize`](<#fd_keyguard_payload_authorize>), determines the type of payload and delegates the authorization process to the appropriate function based on the role specified. It handles different roles such as `FD_KEYGUARD_ROLE_SEND`, `FD_KEYGUARD_ROLE_GOSSIP`, `FD_KEYGUARD_ROLE_REPAIR`, `FD_KEYGUARD_ROLE_LEADER`, `FD_KEYGUARD_ROLE_BUNDLE`, `FD_KEYGUARD_ROLE_EVENT`, and `FD_KEYGUARD_ROLE_BUNDLE_CRANK`. The function checks for payload size limits and logs warnings for unauthorized or ambiguous payload types. The code relies on several external constants and functions, such as `fd_keyguard_payload_match`, `fd_ulong_popcnt`, and `fd_memeq`, to perform its operations.
# Imports and Dependencies

---
- `fd_keyguard.h`
- `fd_keyguard_client.h`
- `../bundle/fd_bundle_crank_constants.h`
- `../../waltz/tls/fd_tls.h`


# Data Structures

---
### fd\_keyguard\_sign\_req
- **Type**: ``struct``
- **Members**:
    - ``authority``: A pointer to an `fd_keyguard_authority_t` structure.
- **Description**: Holds a pointer to an `fd_keyguard_authority_t` structure, which is likely used to manage or verify authority-related operations in the context of keyguard signing requests.


---
### fd\_keyguard\_sign\_req\_t
- **Type**: ``struct``
- **Members**:
    - ``authority``: A pointer to an `fd_keyguard_authority_t` structure.
- **Description**: Holds a pointer to an `fd_keyguard_authority_t` structure, which is likely used to manage or verify authority-related operations in the context of keyguard signing requests.


# Functions

---
### fd\_keyguard\_authorize\_vote\_txn<!-- {{#callable:fd_keyguard_authorize_vote_txn}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyguard_authorize.c#L12>)

Always returns 1, indicating successful authorization for a vote transaction.
- **Inputs**:
    - ``authority``: A pointer to a `fd_keyguard_authority_t` structure, representing the authority requesting the authorization.
    - ``data``: A pointer to an array of unsigned characters, representing the data to be authorized.
    - ``sz``: An unsigned long integer representing the size of the data.
    - ``sign_type``: An integer representing the type of signature used for the transaction.
- **Logic and Control Flow**:
    - The function currently does not perform any operations on its inputs.
    - All input parameters are cast to void to suppress unused variable warnings.
    - Returns 1, indicating that the authorization is successful.
- **Output**: An integer value of 1, indicating successful authorization.


---
### fd\_keyguard\_authorize\_gossip<!-- {{#callable:fd_keyguard_authorize_gossip}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyguard_authorize.c#L22>)

Returns a constant value indicating successful authorization for gossip messages.
- **Inputs**:
    - `authority`: A pointer to a `fd_keyguard_authority_t` structure, representing the authority context for the authorization.
    - `data`: A pointer to an array of unsigned characters (`uchar`), representing the data to be authorized.
    - `sz`: An unsigned long integer representing the size of the data.
    - `sign_type`: An integer representing the type of signature used for the authorization.
- **Logic and Control Flow**:
    - The function currently does not perform any operations on the input parameters.
    - All input parameters are explicitly marked as unused with `(void)` to avoid compiler warnings.
    - Returns a constant value `1`, indicating successful authorization.
- **Output**: An integer value `1`, indicating successful authorization.


---
### fd\_keyguard\_authorize\_bundle\_crank\_txn<!-- {{#callable:fd_keyguard_authorize_bundle_crank_txn}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyguard_authorize.c#L32>)

Authorizes a bundle crank transaction based on the signature type and data size, verifying specific byte sequences in the data.
- **Inputs**:
    - `authority`: A pointer to a `fd_keyguard_authority_t` structure, which is not used in the current implementation.
    - `data`: A pointer to an array of unsigned characters representing the transaction data to be authorized.
    - `sz`: An unsigned long integer representing the size of the data array.
    - `sign_type`: An integer representing the type of signature used for the transaction, expected to be `FD_KEYGUARD_SIGN_TYPE_ED25519`.
- **Logic and Control Flow**:
    - Check if `sign_type` is `FD_KEYGUARD_SIGN_TYPE_ED25519`; if not, return 0.
    - Ignore the `authority` parameter as it is not used.
    - Use a switch statement to handle different values of `sz`.
    - For `sz` equal to `FD_BUNDLE_CRANK_2_SZ-65UL`, verify two specific 8-byte sequences in `data` using `fd_memeq` and return the result of the logical AND operation.
    - For `sz` equal to `FD_BUNDLE_CRANK_3_SZ-65UL`, verify three specific 8-byte sequences in `data` using `fd_memeq` and return the result of the logical AND operation.
    - For any other `sz`, return 0.
- **Output**: Returns 1 if the transaction is authorized based on the signature type and data content; otherwise, returns 0.


---
### fd\_keyguard\_authorize\_ping<!-- {{#callable:fd_keyguard_authorize_ping}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyguard_authorize.c#L58>)

Validates a ping message by checking the signature type, data size, and data content.
- **Inputs**:
    - `authority`: A pointer to a `fd_keyguard_authority_t` structure, which is not used in this function.
    - `data`: A pointer to an array of unsigned characters representing the data to be validated.
    - `sz`: An unsigned long integer representing the size of the data.
    - `sign_type`: An integer representing the type of signature used.
- **Logic and Control Flow**:
    - Ignore the `authority` parameter as it is not used.
    - Check if `sign_type` is equal to `FD_KEYGUARD_SIGN_TYPE_ED25519`. If not, return 0.
    - Check if `sz` is equal to 32. If not, return 0.
    - Compare the first 16 bytes of `data` with the string "SOLANA_PING_PONG". If they do not match, return 0.
    - If all checks pass, return 1.
- **Output**: Returns 1 if the data is a valid ping message; otherwise, returns 0.


---
### fd\_keyguard\_authorize\_pong<!-- {{#callable:fd_keyguard_authorize_pong}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyguard_authorize.c#L70>)

Validates a 'pong' message by checking the signature type, data size, and data content.
- **Inputs**:
    - ``authority``: A pointer to a `fd_keyguard_authority_t` structure, which is not used in this function.
    - ``data``: A pointer to an unsigned character array containing the data to be validated.
    - ``sz``: An unsigned long integer representing the size of the data.
    - ``sign_type``: An integer representing the type of signature used for the data.
- **Logic and Control Flow**:
    - Ignore the `authority` parameter as it is not used.
    - Check if `sign_type` is equal to `FD_KEYGUARD_SIGN_TYPE_SHA256_ED25519`; if not, return 0.
    - Check if `sz` is equal to 48; if not, return 0.
    - Compare the first 16 bytes of `data` with the string "SOLANA_PING_PONG"; if they do not match, return 0.
    - If all checks pass, return 1.
- **Output**: Returns 1 if the data is authorized as a 'pong' message; otherwise, returns 0.


---
### fd\_keyguard\_authorize\_gossip\_prune<!-- {{#callable:fd_keyguard_authorize_gossip_prune}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyguard_authorize.c#L82>)

Validates a gossip prune message by checking the signature type, message size, and matching the node's public key.
- **Inputs**:
    - ``authority``: A pointer to a `fd_keyguard_authority_t` structure containing the node's public key.
    - ``data``: A pointer to an array of unsigned characters representing the message data.
    - ``sz``: An unsigned long integer representing the size of the message data.
    - ``sign_type``: An integer representing the type of signature used for the message.
- **Logic and Control Flow**:
    - Check if `sign_type` is not equal to `FD_KEYGUARD_SIGN_TYPE_ED25519`; if true, return 0.
    - Check if `sz` is less than 40; if true, return 0.
    - Compare the first 32 bytes of `data` with `authority->identity_pubkey`; if they do not match, return 0.
    - If all checks pass, return 1.
- **Output**: Returns 1 if the message is authorized, otherwise returns 0.


---
### fd\_keyguard\_authorize\_repair<!-- {{#callable:fd_keyguard_authorize_repair}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyguard_authorize.c#L94>)

Validates a repair message by checking the signature type, data size, discriminant value, and sender identity.
- **Inputs**:
    - ``authority``: A pointer to a `fd_keyguard_authority_t` structure containing the public key for identity verification.
    - ``data``: A pointer to an array of unsigned characters representing the message data to be authorized.
    - ``sz``: An unsigned long integer representing the size of the `data` array.
    - ``sign_type``: An integer representing the type of signature used for the message.
- **Logic and Control Flow**:
    - Check if `sign_type` is `FD_KEYGUARD_SIGN_TYPE_ED25519`; if not, return 0.
    - Check if `sz` is less than 80; if so, return 0.
    - Load a 4-byte unsigned integer `discriminant` from the start of `data`.
    - Set `sender` to point to the data starting at the 5th byte.
    - Check if `discriminant` is less than 8 or greater than 11; if so, return 0.
    - Compare `authority->identity_pubkey` with `sender` for 32 bytes; if they do not match, return 0.
    - If all checks pass, return 1.
- **Output**: Returns 1 if the repair message is authorized, otherwise returns 0.


---
### fd\_keyguard\_authorize\_tls\_cv<!-- {{#callable:fd_keyguard_authorize_tls_cv}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyguard_authorize.c#L114>)

Validates a TLS client verification request by checking the signature type and data size, and comparing the data against a predefined prefix.
- **Inputs**:
    - ``authority``: A pointer to a `fd_keyguard_authority_t` structure, which is not used in this function.
    - ``data``: A pointer to an array of unsigned characters representing the data to be validated.
    - ``sz``: An unsigned long integer representing the size of the data.
    - ``sign_type``: An integer representing the type of signature used.
- **Logic and Control Flow**:
    - Check if `sign_type` is not equal to `FD_KEYGUARD_SIGN_TYPE_ED25519`; if true, return 0.
    - Check if `sz` is not equal to 130; if true, return 0.
    - Compare `data` with `fd_tls13_cli_sign_prefix` using `fd_memeq`; return the result of this comparison.
- **Output**: Returns an integer, 1 if the data matches the expected prefix and conditions, otherwise 0.


---
### fd\_keyguard\_payload\_authorize<!-- {{#callable:fd_keyguard_payload_authorize}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyguard_authorize.c#L126>)

Authorizes a payload based on its type, size, role, and signature type.
- **Inputs**:
    - `authority`: A pointer to a `fd_keyguard_authority_t` structure that contains the authority information for authorization.
    - `data`: A pointer to an unsigned character array that contains the payload data to be authorized.
    - `sz`: An unsigned long integer representing the size of the payload data.
    - `role`: An integer representing the role for which the payload is being authorized.
    - `sign_type`: An integer representing the type of signature used for the payload.
- **Logic and Control Flow**:
    - Check if the size of the payload exceeds `FD_KEYGUARD_SIGN_REQ_MTU`; if so, log a warning and return 0.
    - Determine the payload type by calling [`fd_keyguard_payload_match`](<fd_keyguard_match.c.md#fd_keyguard_payload_match>) and count the number of matches using `fd_ulong_popcnt`.
    - Log a warning if the payload type is unrecognized or ambiguous, unless it is a known ambiguous type like gossip, repair, or shred-ping.
    - Use a switch statement to handle different roles (`FD_KEYGUARD_ROLE_SEND`, `FD_KEYGUARD_ROLE_GOSSIP`, etc.), checking if the payload type matches the expected type for the role.
    - For each role, call the appropriate authorization function (e.g., [`fd_keyguard_authorize_vote_txn`](<#fd_keyguard_authorize_vote_txn>), [`fd_keyguard_authorize_ping`](<#fd_keyguard_authorize_ping>)) and log a warning if the payload is unauthorized.
    - Return 1 if the payload is authorized for the given role, otherwise return 0.
- **Output**: Returns 1 if the payload is authorized for the specified role and signature type; otherwise, returns 0.
- **Functions Called**:
    - [`fd_keyguard_payload_match`](<fd_keyguard_match.c.md#fd_keyguard_payload_match>)
    - [`fd_keyguard_authorize_vote_txn`](<#fd_keyguard_authorize_vote_txn>)
    - [`fd_keyguard_authorize_tls_cv`](<#fd_keyguard_authorize_tls_cv>)
    - [`fd_keyguard_authorize_ping`](<#fd_keyguard_authorize_ping>)
    - [`fd_keyguard_authorize_pong`](<#fd_keyguard_authorize_pong>)
    - [`fd_keyguard_authorize_gossip_prune`](<#fd_keyguard_authorize_gossip_prune>)
    - [`fd_keyguard_authorize_gossip`](<#fd_keyguard_authorize_gossip>)
    - [`fd_keyguard_authorize_repair`](<#fd_keyguard_authorize_repair>)
    - [`fd_keyguard_authorize_bundle_crank_txn`](<#fd_keyguard_authorize_bundle_crank_txn>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)