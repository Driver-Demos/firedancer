<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for managing memory alignment and lifecycle of `fd_keyswitch_t` objects.

# Purpose
The code provides functionality for managing a `fd_keyswitch_t` structure, which is likely used for handling a keyswitch mechanism in shared memory. It includes functions to align, create, join, leave, and delete a keyswitch instance. The [`fd_keyswitch_align`](<#fd_keyswitch_align>) and [`fd_keyswitch_footprint`](<#fd_keyswitch_footprint>) functions return alignment and memory footprint requirements, respectively, which are essential for correctly allocating and managing the shared memory used by the keyswitch.

The [`fd_keyswitch_new`](<#fd_keyswitch_new>) function initializes a new keyswitch instance in a given shared memory region, setting its state and verifying alignment. The [`fd_keyswitch_join`](<#fd_keyswitch_join>) function allows a process to join an existing keyswitch instance, checking for correct alignment and a valid magic number to ensure integrity. The [`fd_keyswitch_leave`](<#fd_keyswitch_leave>) function is used to leave a keyswitch instance, and [`fd_keyswitch_delete`](<#fd_keyswitch_delete>) is responsible for deleting an instance, resetting its magic number to indicate it is no longer valid. The code includes error handling through logging warnings when operations encounter issues such as null pointers, misalignment, or invalid magic numbers.
# Imports and Dependencies

---
- `fd_keyswitch.h`


# Functions

---
### fd\_keyswitch\_align<!-- {{#callable:fd_keyswitch_align}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyswitch.c#L3>)

Returns the alignment requirement for a keyswitch.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the value of `FD_KEYSWITCH_ALIGN`.
- **Output**: The function returns an `ulong` representing the alignment requirement for a keyswitch.


---
### fd\_keyswitch\_footprint<!-- {{#callable:fd_keyswitch_footprint}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyswitch.c#L8>)

Returns the constant `FD_KEYSWITCH_FOOTPRINT`.
- **Inputs**: None
- **Logic and Control Flow**:
    - Return the value of `FD_KEYSWITCH_FOOTPRINT`.
- **Output**: The function returns an `ulong` value which is the constant `FD_KEYSWITCH_FOOTPRINT`.


---
### fd\_keyswitch\_new<!-- {{#callable:fd_keyswitch_new}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyswitch.c#L13>)

Initializes a `fd_keyswitch_t` structure in shared memory with a given state and returns a pointer to it.
- **Inputs**:
    - `shmem`: A pointer to the shared memory where the `fd_keyswitch_t` structure will be initialized.
    - `state`: An unsigned long integer representing the initial state to set in the `fd_keyswitch_t` structure.
- **Logic and Control Flow**:
    - Cast `shmem` to a `fd_keyswitch_t` pointer `ks`.
    - Check if `shmem` is NULL; if so, log a warning and return NULL.
    - Check if `shmem` is aligned according to `fd_keyswitch_align()`; if not, log a warning and return NULL.
    - Get the footprint size using `fd_keyswitch_footprint()`.
    - Set the memory at `ks` to zero for the size of the footprint.
    - Set the `state` field of `ks` to the provided `state` value.
    - Use `FD_COMPILER_MFENCE()` to ensure memory ordering before and after setting `ks->magic`.
    - Set `ks->magic` to `FD_KEYSWITCH_MAGIC` using `FD_VOLATILE`.
    - Return a pointer to the initialized `fd_keyswitch_t` structure.
- **Output**: A pointer to the initialized `fd_keyswitch_t` structure, or NULL if an error occurs.
- **Functions Called**:
    - [`fd_keyswitch_align`](<#fd_keyswitch_align>)
    - [`fd_keyswitch_footprint`](<#fd_keyswitch_footprint>)


---
### fd\_keyswitch\_join<!-- {{#callable:fd_keyswitch_join}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyswitch.c#L40>)

Validates and returns a pointer to a `fd_keyswitch_t` structure if the input is correctly aligned and has the correct magic number.
- **Inputs**:
    - `shks`: A pointer to a memory location that is expected to be a `fd_keyswitch_t` structure.
- **Logic and Control Flow**:
    - Check if `shks` is NULL; if true, log a warning and return NULL.
    - Check if `shks` is aligned according to `fd_keyswitch_align()`; if not, log a warning and return NULL.
    - Cast `shks` to a `fd_keyswitch_t` pointer and store it in `ks`.
    - Check if the `magic` field of `ks` equals `FD_KEYSWITCH_MAGIC`; if not, log a warning and return NULL.
    - Return the `ks` pointer.
- **Output**: A pointer to a `fd_keyswitch_t` structure if all checks pass, otherwise NULL.
- **Functions Called**:
    - [`fd_keyswitch_align`](<#fd_keyswitch_align>)


---
### fd\_keyswitch\_leave<!-- {{#callable:fd_keyswitch_leave}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyswitch.c#L63>)

Returns a pointer to the `fd_keyswitch_t` object if it is not NULL.
- **Inputs**:
    - `ks`: A constant pointer to an `fd_keyswitch_t` object.
- **Logic and Control Flow**:
    - Check if `ks` is NULL using `FD_UNLIKELY`.
    - If `ks` is NULL, log a warning message 'NULL ks' and return NULL.
    - If `ks` is not NULL, return the pointer cast to `void *`.
- **Output**: A `void *` pointer to the `fd_keyswitch_t` object, or NULL if the input is NULL.


---
### fd\_keyswitch\_delete<!-- {{#callable:fd_keyswitch_delete}} -->
[View Source →](<../../../../../src/disco/keyguard/fd_keyswitch.c#L74>)

Deletes a `fd_keyswitch_t` object by validating and resetting its magic number.
- **Inputs**:
    - `shks`: A pointer to the `fd_keyswitch_t` object to delete.
- **Logic and Control Flow**:
    - Check if `shks` is NULL; if true, log a warning and return NULL.
    - Check if `shks` is aligned according to [`fd_keyswitch_align`](<#fd_keyswitch_align>); if not, log a warning and return NULL.
    - Cast `shks` to a `fd_keyswitch_t` pointer `ks`.
    - Check if `ks->magic` is equal to `FD_KEYSWITCH_MAGIC`; if not, log a warning and return NULL.
    - Use memory fences to ensure memory operations are completed before and after setting `ks->magic` to 0.
    - Return the pointer `ks`.
- **Output**: Returns a pointer to the `fd_keyswitch_t` object if successful, or NULL if any validation fails.
- **Functions Called**:
    - [`fd_keyswitch_align`](<#fd_keyswitch_align>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)