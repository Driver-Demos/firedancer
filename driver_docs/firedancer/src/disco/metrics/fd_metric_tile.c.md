<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a Prometheus metrics HTTP server with seccomp filtering and connection management.

# Purpose
The code defines a module for setting up and managing an HTTP server that serves Prometheus metrics. It includes the necessary configurations and functions to initialize, run, and handle HTTP requests for metrics data. The module uses several external libraries, such as `fd_prometheus`, `fd_metrics`, and `fd_http_server`, to facilitate the collection and serving of metrics. The server is configured to handle a maximum of 128 connections and has a buffer size of 32 MiB for outgoing metrics responses.

Key components include the `fd_metric_ctx_t` structure, which holds the server context, and the `METRICS_PARAMS` constant, which defines server parameters like maximum connections and request length. The [`metrics_http_request`](<#metrics_http_request>) function processes incoming HTTP requests, specifically handling GET requests to the `/metrics` endpoint by rendering Prometheus metrics. The module also includes functions for initializing server resources ([`privileged_init`](<#privileged_init>) and [`unprivileged_init`](<#unprivileged_init>)), managing seccomp policies, and handling file descriptors. The `fd_tile_metric` structure encapsulates the server's operational parameters and functions, making it suitable for integration into a larger system that requires metrics monitoring.
# Imports and Dependencies

---
- `fd_prometheus.h`
- `fd_metrics.h`
- `../../waltz/http/fd_http_server.h`
- `../../util/net/fd_ip4.h`
- `sys/types.h`
- `sys/socket.h`
- `unistd.h`
- `string.h`
- `generated/fd_metric_tile_seccomp.h`
- `../stem/fd_stem.c`


# Global Variables

---
### METRICS\_PARAMS
- **Type**: ``fd_http_server_params_t``
- **Description**: Defines the parameters for configuring an HTTP server used for metrics. It specifies limits on connections, request lengths, and buffer sizes for outgoing data.
- **Use**: Used to initialize and configure an HTTP server for handling metrics requests.


---
### fd\_tile\_metric
- **Type**: ``fd_topo_run_tile_t``
- **Description**: Defines a tile configuration for running a metric server. It includes parameters for resource limits, security policies, memory alignment, and initialization functions.
- **Use**: Used to configure and run a metric server tile with specific resource and security settings.


# Data Structures

---
### fd\_metric\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``topo``: A pointer to an `fd_topo_t` structure.
    - ``metrics_server``: A pointer to an `fd_http_server_t` structure.
    - ``boot_ts``: A long integer representing the boot timestamp.
- **Description**: Represents a context for metrics, containing pointers to a topology structure and an HTTP server for metrics, as well as a timestamp indicating when the system booted.


# Functions

---
### scratch\_align<!-- {{#callable:scratch_align}} -->
[View Source →](<../../../../../src/disco/metrics/fd_metric_tile.c#L34>)

Returns a constant alignment value of 128.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the constant value `128UL`.
- **Output**: The function returns an unsigned long integer with the value `128UL`.


---
### scratch\_footprint<!-- {{#callable:scratch_footprint}} -->
[View Source →](<../../../../../src/disco/metrics/fd_metric_tile.c#L39>)

Calculates the memory footprint required for a scratch space based on the alignment and size of `fd_metric_ctx_t` and the HTTP server footprint.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure, which is not used in the function.
- **Logic and Control Flow**:
    - Initialize `l` with `FD_LAYOUT_INIT`.
    - Append the alignment and size of `fd_metric_ctx_t` to `l` using `FD_LAYOUT_APPEND`.
    - Append the alignment and footprint of the HTTP server to `l` using `FD_LAYOUT_APPEND` with `fd_http_server_align()` and `fd_http_server_footprint(METRICS_PARAMS)`.
    - Finalize the layout `l` with `FD_LAYOUT_FINI` using `scratch_align()` and return the result.
- **Output**: Returns an `ulong` representing the calculated memory footprint for the scratch space.
- **Functions Called**:
    - [`scratch_align`](<#scratch_align>)


---
### before\_credit<!-- {{#callable:before_credit}} -->
[View Source →](<../../../../../src/disco/metrics/fd_metric_tile.c#L49>)

Sets the `charge_busy` flag based on the polling result of the metrics server.
- **Inputs**:
    - ``ctx``: A pointer to an `fd_metric_ctx_t` structure that contains the metrics server context.
    - ``stem``: A pointer to an `fd_stem_context_t` structure, which is not used in this function.
    - ``charge_busy``: A pointer to an integer where the function stores the result of the server poll operation.
- **Logic and Control Flow**:
    - The function ignores the `stem` parameter by casting it to void.
    - Calls `fd_http_server_poll` with the metrics server from `ctx` and a timeout of 1 millisecond.
    - Stores the result of the poll operation in the `charge_busy` variable.
- **Output**: The function does not return a value but modifies the integer pointed to by `charge_busy` to indicate the result of the server poll operation.


---
### metrics\_http\_request<!-- {{#callable:metrics_http_request}} -->
[View Source →](<../../../../../src/disco/metrics/fd_metric_tile.c#L57>)

Handles HTTP requests for metrics, returning appropriate responses based on the request method and path.
- **Inputs**:
    - ``request``: A pointer to a `fd_http_server_request_t` structure containing the HTTP request details, including method, path, and context.
- **Logic and Control Flow**:
    - Cast the `ctx` field of the `request` to a `fd_metric_ctx_t` pointer.
    - Check if the request method is not `FD_HTTP_SERVER_METHOD_GET`; if true, return a response with status 400 (Bad Request).
    - Check if the request path is "/metrics"; if true, proceed to render metrics using [`fd_prometheus_render_all`](<fd_prometheus.c.md#fd_prometheus_render_all>).
    - Create a response with status 200 and content type "text/plain; version=0.0.4".
    - Attempt to stage the response body using `fd_http_server_stage_body`; if it fails, log a warning and return a response with status 500 (Internal Server Error).
    - If the path is not "/metrics", return a response with status 404 (Not Found).
- **Output**: Returns a `fd_http_server_response_t` structure with the appropriate HTTP status code and content type based on the request method and path.
- **Functions Called**:
    - [`fd_prometheus_render_all`](<fd_prometheus.c.md#fd_prometheus_render_all>)


---
### metrics\_write<!-- {{#callable:metrics_write}} -->
[View Source →](<../../../../../src/disco/metrics/fd_metric_tile.c#L88>)

Sets the metric `BOOT_TIMESTAMP_NANOS` to the boot timestamp from the context.
- **Inputs**:
    - `ctx`: A pointer to an `fd_metric_ctx_t` structure containing the boot timestamp.
- **Logic and Control Flow**:
    - Retrieve the boot timestamp from the `ctx` structure.
    - Cast the boot timestamp to an unsigned long integer.
    - Set the metric `BOOT_TIMESTAMP_NANOS` using the `FD_MGAUGE_SET` macro with the cast boot timestamp.
- **Output**: No return value; the function updates a metric.


---
### privileged\_init<!-- {{#callable:privileged_init}} -->
[View Source →](<../../../../../src/disco/metrics/fd_metric_tile.c#L93>)

Initializes a metrics HTTP server for a given topology and tile.
- **Inputs**:
    - ``topo``: A pointer to an `fd_topo_t` structure representing the topology.
    - ``tile``: A pointer to an `fd_topo_tile_t` structure representing the tile configuration.
- **Logic and Control Flow**:
    - Retrieve the local address of the object associated with the tile using `fd_topo_obj_laddr` and store it in `scratch`.
    - Initialize the scratch memory allocator with `FD_SCRATCH_ALLOC_INIT`.
    - Allocate memory for an `fd_metric_ctx_t` structure using `FD_SCRATCH_ALLOC_APPEND` and store the pointer in `ctx`.
    - Allocate memory for an `fd_http_server_t` structure using `FD_SCRATCH_ALLOC_APPEND` and store the pointer in `_metrics`.
    - Define `metrics_callbacks` with a request callback function `metrics_http_request`.
    - Create a new HTTP server with `fd_http_server_new`, passing `_metrics`, `METRICS_PARAMS`, `metrics_callbacks`, and `ctx`, then join it with `fd_http_server_join` and assign it to `ctx->metrics_server`.
    - Start listening on the metrics server using `fd_http_server_listen` with the address and port from `tile->metric`.
- **Output**: No return value; the function sets up the HTTP server for metrics collection.


---
### unprivileged\_init<!-- {{#callable:unprivileged_init}} -->
[View Source →](<../../../../../src/disco/metrics/fd_metric_tile.c#L110>)

Initializes an unprivileged context for metrics collection and logs the Prometheus metrics endpoint address.
- **Inputs**:
    - `topo`: A pointer to an `fd_topo_t` structure representing the topology.
    - `tile`: A pointer to an `fd_topo_tile_t` structure representing the tile configuration.
- **Logic and Control Flow**:
    - Obtain a scratch memory address using `fd_topo_obj_laddr` with `topo` and `tile->tile_obj_id`.
    - Initialize scratch memory allocation with `FD_SCRATCH_ALLOC_INIT`.
    - Allocate memory for `fd_metric_ctx_t` within the scratch space using `FD_SCRATCH_ALLOC_APPEND`.
    - Set the `topo` field of `ctx` to the provided `topo` argument.
    - Set the `boot_ts` field of `ctx` to the current wall clock time using `fd_log_wallclock`.
    - Finalize the scratch memory allocation with `FD_SCRATCH_ALLOC_FINI` and check for overflow against the calculated footprint using [`scratch_footprint`](<#scratch_footprint>).
    - Log an error message if a scratch overflow is detected.
    - Log a notice with the Prometheus metrics endpoint address using `FD_LOG_NOTICE`.
- **Output**: No return value; the function performs initialization and logging.
- **Functions Called**:
    - [`scratch_footprint`](<#scratch_footprint>)


---
### populate\_allowed\_seccomp<!-- {{#callable:populate_allowed_seccomp}} -->
[View Source →](<../../../../../src/disco/metrics/fd_metric_tile.c#L128>)

Populates a seccomp filter policy for a specific tile in a topology.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure representing the topology.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure representing the specific tile in the topology.
    - ``out_cnt``: An unsigned long integer representing the count of output filters.
    - ``out``: A pointer to a `struct sock_filter` array where the seccomp filter policy will be stored.
- **Logic and Control Flow**:
    - Retrieve the local address of the object associated with the tile using `fd_topo_obj_laddr` and store it in `scratch`.
    - Initialize a scratch allocation context `l` with `FD_SCRATCH_ALLOC_INIT` using `scratch`.
    - Allocate memory for a `fd_metric_ctx_t` structure within the scratch space using `FD_SCRATCH_ALLOC_APPEND`.
    - Call [`populate_sock_filter_policy_fd_metric_tile`](<generated/fd_metric_tile_seccomp.h.md#populate_sock_filter_policy_fd_metric_tile>) to populate the seccomp filter policy using the provided `out_cnt`, `out`, the file descriptor for the log file, and the file descriptor for the metrics server.
    - Return the instruction count from `sock_filter_policy_fd_metric_tile_instr_cnt`.
- **Output**: Returns an unsigned long integer representing the instruction count for the seccomp filter policy.
- **Functions Called**:
    - [`populate_sock_filter_policy_fd_metric_tile`](<generated/fd_metric_tile_seccomp.h.md#populate_sock_filter_policy_fd_metric_tile>)


---
### populate\_allowed\_fds<!-- {{#callable:populate_allowed_fds}} -->
[View Source →](<../../../../../src/disco/metrics/fd_metric_tile.c#L141>)

Populates an array with file descriptors for standard error, a log file, and a metrics server socket.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure representing the topology.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure representing the tile configuration.
    - ``out_fds_cnt``: An unsigned long integer representing the maximum number of file descriptors that can be stored in `out_fds`.
    - ``out_fds``: A pointer to an integer array where the function will store the allowed file descriptors.
- **Logic and Control Flow**:
    - Allocate scratch memory using `fd_topo_obj_laddr` and initialize it with `FD_SCRATCH_ALLOC_INIT`.
    - Append a `fd_metric_ctx_t` structure to the scratch memory using `FD_SCRATCH_ALLOC_APPEND`.
    - Check if `out_fds_cnt` is less than 3; if true, log an error and terminate the program.
    - Initialize `out_cnt` to 0 and set `out_fds[0]` to 2, which corresponds to the standard error file descriptor.
    - Check if the log file descriptor is valid using `fd_log_private_logfile_fd`; if valid, add it to `out_fds` and increment `out_cnt`.
    - Add the metrics server socket file descriptor to `out_fds` using `fd_http_server_fd` and increment `out_cnt`.
- **Output**: Returns the number of file descriptors added to `out_fds` as an unsigned long integer.



---
Made with ❤️ by [Driver](https://www.driver.ai/)