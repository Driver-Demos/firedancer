<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines a system for managing and updating shared memory metrics with macros for efficient access.

# Purpose
The code defines a C header file for managing metrics in shared memory. It provides a framework for producers and consumers to efficiently read and write metrics data with minimal overhead. The primary functionality includes defining the layout of metrics in shared memory, registering metrics for a thread, and providing macros for updating and accessing these metrics. The metrics are stored as unsigned long integers (`ulong`) and are organized into different categories such as gauges, counters, and histograms. The code includes macros like `FD_MGAUGE_SET`, `FD_MCNT_SET`, and `FD_MHIST_COPY` to facilitate operations on these metrics.

The file also defines several inline functions for managing the metrics memory region, such as [`fd_metrics_new`](<#fd_metrics_new>), [`fd_metrics_register`](<#fd_metrics_register>), and conversion functions like [`fd_metrics_convert_seconds_to_ticks`](<#fd_metrics_convert_seconds_to_ticks>). These functions help initialize, register, and convert time-related metrics. The header file is intended to be included in other C files, providing a public API for metrics management. It does not contain metadata within the metrics area to minimize cache traffic and allow for quick snapshots of the metrics state. The code ensures that updates to the metrics are atomic to maintain consistency during snapshot operations.
# Imports and Dependencies

---
- `fd_metrics_base.h`
- `generated/fd_metrics_all.h`
- `../../tango/tempo/fd_tempo.h`
- `../../util/hist/fd_histf.h`


# Global Variables

---
### fd\_metrics\_base\_tl
- **Type**: `FD_TL ulong *`
- **Description**: A thread-local pointer to the start of the metrics layout in shared memory. It is used to compute metrics for specific links.
- **Use**: Used by `fd_stem` to compute metrics for specific links.


---
### fd\_metrics\_tl
- **Type**: `FD_TL volatile ulong *`
- **Description**: A thread-local pointer to the start of the tile-specific metrics area in shared memory. It is used to access and update metrics specific to a tile, which are defined as offsets from this pointer.
- **Use**: Used by macros to update and access tile-specific metrics in shared memory.


# Functions

---
### fd\_metrics\_tile<!-- {{#callable:fd_metrics_tile}} -->
[View Source →](<../../../../../src/disco/metrics/fd_metrics.h#L123>)

Calculates and returns a pointer to the tile-specific metrics area within a metrics object.
- **Inputs**:
    - `metrics`: A pointer to an array of unsigned long integers representing the metrics object.
- **Logic and Control Flow**:
    - Add 2 to the `metrics` pointer to skip the first two elements, which represent the counts of in-links and out-links.
    - Multiply the first element of `metrics` by `FD_METRICS_ALL_LINK_IN_TOTAL` to calculate the offset for in-link metrics.
    - Multiply the second element of `metrics` by `FD_METRICS_ALL_LINK_OUT_TOTAL` to calculate the offset for out-link metrics.
    - Add these calculated offsets to the `metrics` pointer to reach the start of the tile-specific metrics area.
- **Output**: A pointer to the start of the tile-specific metrics area within the metrics object.


---
### fd\_metrics\_link\_in<!-- {{#callable:fd_metrics_link_in}} -->
[View Source →](<../../../../../src/disco/metrics/fd_metrics.h#L132>)

Calculates the pointer to the in-link metrics area for a given in-link index in a metrics object.
- **Inputs**:
    - `metrics`: A pointer to an array of unsigned long integers representing the metrics object.
    - `in_idx`: An unsigned long integer representing the index of the in-link for which the metrics area is needed.
- **Logic and Control Flow**:
    - Add 2 to the `metrics` pointer to skip the first two elements, which are the in-link and out-link counts.
    - Multiply `FD_METRICS_ALL_LINK_IN_TOTAL` by `in_idx` to calculate the offset for the in-link metrics.
    - Add the calculated offset to the adjusted `metrics` pointer to get the pointer to the in-link metrics area.
- **Output**: A pointer to the in-link metrics area for the specified in-link index.


---
### fd\_metrics\_link\_out<!-- {{#callable:fd_metrics_link_out}} -->
[View Source →](<../../../../../src/disco/metrics/fd_metrics.h#L137>)

Calculates the pointer to the out-link metrics area for a given out-link index in a metrics object.
- **Inputs**:
    - `metrics`: A pointer to an array of unsigned long integers representing the metrics object.
    - `out_idx`: An unsigned long integer representing the index of the out-link for which the metrics pointer is needed.
- **Logic and Control Flow**:
    - Calculate the offset by adding 2 to the base `metrics` pointer.
    - Multiply the first element of `metrics` by `FD_METRICS_ALL_LINK_IN_TOTAL` to get the total in-link metrics offset.
    - Multiply `out_idx` by `FD_METRICS_ALL_LINK_OUT_TOTAL` to get the specific out-link metrics offset.
    - Add these calculated offsets to the base `metrics` pointer to get the final pointer to the out-link metrics area.
- **Output**: A pointer to the out-link metrics area for the specified out-link index.


---
### fd\_metrics\_new<!-- {{#callable:fd_metrics_new}} -->
[View Source →](<../../../../../src/disco/metrics/fd_metrics.h#L147>)

Initializes a shared memory region for metrics storage and sets initial link counts.
- **Inputs**:
    - `shmem`: A pointer to the shared memory region to be initialized.
    - `in_link_cnt`: The number of input links to be stored in the metrics.
    - `out_link_consumer_cnt`: The number of output link consumers to be stored in the metrics.
- **Logic and Control Flow**:
    - Calls `fd_memset` to zero out the memory region pointed to by `shmem` with a size determined by `FD_METRICS_FOOTPRINT` using `in_link_cnt` and `out_link_consumer_cnt`.
    - Casts `shmem` to a `ulong` pointer and assigns it to `metrics`.
    - Sets the first element of `metrics` to `in_link_cnt`.
    - Sets the second element of `metrics` to `out_link_consumer_cnt`.
    - Returns the `shmem` pointer.
- **Output**: Returns the pointer to the initialized shared memory region (`shmem`).


---
### fd\_metrics\_register<!-- {{#callable:fd_metrics_register}} -->
[View Source →](<../../../../../src/disco/metrics/fd_metrics.h#L160>)

Registers a metrics object for the current thread by setting thread-local pointers to the base and tile-specific metrics areas.
- **Inputs**:
    - `metrics`: A pointer to an array of `ulong` values representing the metrics object to register.
- **Logic and Control Flow**:
    - Check if `metrics` is NULL using `FD_UNLIKELY`; if true, log an error with `FD_LOG_ERR`.
    - Set the thread-local variable `fd_metrics_base_tl` to point to `metrics`.
    - Set the thread-local variable `fd_metrics_tl` to point to the tile-specific metrics area by calling `fd_metrics_tile(metrics)`.
    - Return the `metrics` pointer.
- **Output**: Returns the input `metrics` pointer.
- **Functions Called**:
    - [`fd_metrics_tile`](<#fd_metrics_tile>)


---
### fd\_metrics\_convert\_seconds\_to\_ticks<!-- {{#callable:fd_metrics_convert_seconds_to_ticks}} -->
[View Source →](<../../../../../src/disco/metrics/fd_metrics.h#L169>)

Converts a time duration in seconds to a corresponding number of ticks based on a predefined tick rate per nanosecond.
- **Inputs**:
    - `seconds`: A `double` representing the time duration in seconds to convert to ticks.
- **Logic and Control Flow**:
    - Retrieve the tick rate per nanosecond by calling `fd_tempo_tick_per_ns(NULL)` and store it in `tick_per_ns`.
    - Multiply `seconds` by `tick_per_ns` and `1e9` to convert the time duration from seconds to ticks.
    - Cast the result to `ulong` and return it.
- **Output**: Returns an `ulong` representing the number of ticks corresponding to the input time duration in seconds.


---
### fd\_metrics\_convert\_ticks\_to\_seconds<!-- {{#callable:fd_metrics_convert_ticks_to_seconds}} -->
[View Source →](<../../../../../src/disco/metrics/fd_metrics.h#L178>)

Converts a given number of ticks to seconds using the tick rate per nanosecond.
- **Inputs**:
    - `ticks`: The number of ticks to convert to seconds.
- **Logic and Control Flow**:
    - Call `fd_tempo_tick_per_ns` with `NULL` to get the tick rate per nanosecond.
    - Calculate the number of seconds by dividing the `ticks` by the product of `tick_per_ns` and 1e9.
    - Return the calculated seconds as a `double`.
- **Output**: Returns the equivalent time in seconds as a `double`.


---
### fd\_metrics\_convert\_ticks\_to\_nanoseconds<!-- {{#callable:fd_metrics_convert_ticks_to_nanoseconds}} -->
[View Source →](<../../../../../src/disco/metrics/fd_metrics.h#L184>)

Converts a given number of ticks to nanoseconds using the tick rate.
- **Inputs**:
    - `ticks`: The number of ticks to convert to nanoseconds.
- **Logic and Control Flow**:
    - Call `fd_tempo_tick_per_ns` to get the number of ticks per nanosecond.
    - Divide the input `ticks` by the `tick_per_ns` to convert ticks to nanoseconds.
    - Cast the result to `ulong` and return it.
- **Output**: Returns the equivalent time in nanoseconds as an `ulong`.


---
### fd\_metrics\_join<!-- {{#callable:fd_metrics_join}} -->
[View Source →](<../../../../../src/disco/metrics/fd_metrics.h#L190>)

Returns the input memory pointer as a `ulong` pointer.
- **Inputs**:
    - `mem`: A pointer to a memory location that the function will return as a `ulong` pointer.
- **Logic and Control Flow**:
    - The function takes a single input parameter `mem` which is a pointer to a memory location.
    - It returns the input `mem` cast to a `ulong` pointer.
- **Output**: A `ulong` pointer that points to the same memory location as the input `mem`.


---
### fd\_metrics\_leave<!-- {{#callable:fd_metrics_leave}} -->
[View Source →](<../../../../../src/disco/metrics/fd_metrics.h#L191>)

Returns the input memory pointer without modification.
- **Inputs**:
    - `mem`: A pointer to a memory region that the function will return.
- **Logic and Control Flow**:
    - The function takes a single input parameter `mem`, which is a pointer to a memory region.
    - The function returns the same pointer `mem` without any changes.
- **Output**: A pointer to the same memory region passed as input.


---
### fd\_metrics\_delete<!-- {{#callable:fd_metrics_delete}} -->
[View Source →](<../../../../../src/disco/metrics/fd_metrics.h#L192>)

Returns the input memory pointer without modification.
- **Inputs**:
    - ``mem``: A pointer to a memory region that is to be deleted or deallocated.
- **Logic and Control Flow**:
    - The function takes a single input parameter `mem`.
    - It returns the same `mem` pointer without performing any operations on it.
- **Output**: The same pointer `mem` that was passed as input.



---
Made with ❤️ by [Driver](https://www.driver.ai/)