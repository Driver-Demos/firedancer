<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Generates C header and source files for metrics based on given metric definitions and enums.

# Purpose
The code is a Python script designed to generate C header and source files for metrics management. It processes metric definitions and writes them into C files, which are used to define and describe various metrics in a structured format. The script uses functions to convert metric names from camel case to snake case, write metric definitions, and handle different types of metrics such as counters, gauges, and histograms. It generates files for common metrics, link-in and link-out metrics, and tile-specific metrics, ensuring that each metric is properly defined with its name, type, description, and other attributes.

The script defines several private functions to handle specific tasks, such as [`_write_metric`](<#_write_metric>), [`_write_metric_descriptor`](<#_write_metric_descriptor>), [`_write_common`](<#_write_common>), [`_write_tile`](<#_write_tile>), and [`_write_enums`](<#_write_enums>). These functions are responsible for writing the necessary C code to define metrics and their properties, including offsets, types, descriptions, and converters. The [`write_codegen`](<#write_codegen>) function orchestrates the overall process, creating the output directory and invoking the appropriate functions to generate the required C files. The generated files include definitions for metric enums, total counts, and metadata arrays, which are essential for integrating the metrics into a larger system.
# Imports and Dependencies

---
- `.types.*`
- `pathlib.Path`
- `typing.TextIO`
- `os`
- `re`


# Functions

---
### camel2snake<!-- {{#callable:firedancer/src/disco/metrics/generate/write_codegen.camel2snake}} -->
[View Source →](<../../../../../../src/disco/metrics/generate/write_codegen.py#L7>)

Converts a camel case string to a snake case string and returns it in uppercase.
- **Inputs**:
    - `str`: A string in camel case format that needs conversion to snake case.
- **Logic and Control Flow**:
    - Uses a regular expression to find positions in the string where a lowercase letter is followed by an uppercase letter.
    - Inserts an underscore ('_') at these positions to convert the camel case to snake case.
    - Converts the entire resulting string to uppercase.
- **Output**: Returns the converted string in snake case format, all in uppercase letters.


---
### \_write\_metric<!-- {{#callable:firedancer/src/disco/metrics/generate/write_codegen._write_metric}} -->
[View Source →](<../../../../../../src/disco/metrics/generate/write_codegen.py#L10>)

Writes metric definitions to a file based on the provided metric object and prefix.
- **Inputs**:
    - `f`: A file-like object where the metric definitions will be written.
    - `metric`: An instance of the `Metric` class or its subclasses, containing details about the metric to be written.
    - `prefix`: A string prefix to be used in the metric definitions.
- **Logic and Control Flow**:
    - Convert the metric name from camel case to snake case using the [`camel2snake`](<#camel2snake>) function.
    - Strip and join the metric description lines into a single string.
    - Initialize the `converter` variable to 'NONE'.
    - Check if the metric is an instance of `HistogramMetric` and set the `converter` to the metric's converter name if true.
    - Check if the metric has a `converter` attribute and set the `converter` to the metric's converter name if true.
    - Write several `#define` statements to the file `f` using the metric's type, prefix, full name, offset, description, and converter.
    - If the metric is an instance of `GaugeEnumMetric` or `CounterEnumMetric`, write additional `#define` statements for each enum value with its offset.
    - If the metric is an instance of `HistogramMetric`, determine the min and max values based on the converter type and write them to the file.
    - Write a newline character to the file `f` at the end.
- **Output**: Writes metric definitions as `#define` statements to the provided file-like object `f`.
- **Functions Called**:
    - [`firedancer/src/disco/metrics/generate/write_codegen.camel2snake`](<#camel2snake>)


---
### \_write\_metric\_descriptor<!-- {{#callable:firedancer/src/disco/metrics/generate/write_codegen._write_metric_descriptor}} -->
[View Source →](<../../../../../../src/disco/metrics/generate/write_codegen.py#L43>)

Writes metric descriptor definitions to a file based on the type of metric provided.
- **Inputs**:
    - `f`: A file-like object where the metric descriptor will be written.
    - `full_name`: A string representing the full name of the metric.
    - `metric`: An instance of the `Metric` class or its subclasses, representing the metric to be described.
- **Logic and Control Flow**:
    - Check if `metric` is an instance of `CounterMetric` and write a counter metric declaration to the file.
    - Check if `metric` is an instance of `GaugeMetric` and write a gauge metric declaration to the file.
    - Check if `metric` is an instance of `CounterEnumMetric` and iterate over its enum values to write counter enum metric declarations to the file.
    - Check if `metric` is an instance of `GaugeEnumMetric` and iterate over its enum values to write gauge enum metric declarations to the file.
    - Check if `metric` is an instance of `HistogramMetric` and determine the type of histogram converter to write the appropriate histogram metric declaration to the file.
    - Raise an exception if the histogram converter is unknown.
    - Raise a `ValueError` if the metric type is unknown.
- **Output**: Writes metric descriptor definitions to the provided file-like object `f`.
- **Functions Called**:
    - [`firedancer/src/disco/metrics/generate/write_codegen.camel2snake`](<#camel2snake>)


---
### \_write\_common<!-- {{#callable:firedancer/src/disco/metrics/generate/write_codegen._write_common}} -->
[View Source →](<../../../../../../src/disco/metrics/generate/write_codegen.py#L65>)

Generates C header and source files for metrics based on the provided `Metrics` object.
- **Inputs**:
    - `metrics`: An instance of the `Metrics` class containing metric data to be written to files.
- **Logic and Control Flow**:
    - Open the file `fd_metrics_all.h` for writing in the `../generated` directory.
    - Write header guards and include statements to the file.
    - Iterate over `metrics.tiles` and include corresponding header files for each tile.
    - Write sections for LINK OUT, LINK IN, and TILE metrics, calling [`_write_metric`](<#_write_metric>) for each metric in the respective lists.
    - Calculate the total offset for common metrics and write it as a macro definition.
    - Write macro definitions for the total number of LINK IN and LINK OUT metrics.
    - Calculate the maximum offset for tile metrics and write it as a macro definition.
    - Write macro definitions for the number of tile kinds and declare external arrays for tile kind names, sizes, and metrics.
    - Close the header file and open the file `fd_metrics_all.c` for writing.
    - Write include statements and initialize arrays for all, LINK IN, and LINK OUT metrics, calling [`_write_metric_descriptor`](<#_write_metric_descriptor>) for each metric.
    - Write arrays for tile kind names, sizes, and metrics.
    - Close the source file.
- **Output**: C header and source files are generated in the `../generated` directory, containing macro definitions and metric descriptors based on the input `Metrics` object.
- **Functions Called**:
    - [`firedancer/src/disco/metrics/generate/write_codegen._write_metric`](<#_write_metric>)
    - [`firedancer/src/disco/metrics/generate/types.Metric.footprint`](<types.py.md#metricfootprint>)
    - [`firedancer/src/disco/metrics/generate/write_codegen.camel2snake`](<#camel2snake>)
    - [`firedancer/src/disco/metrics/generate/write_codegen._write_metric_descriptor`](<#_write_metric_descriptor>)


---
### \_write\_tile<!-- {{#callable:firedancer/src/disco/metrics/generate/write_codegen._write_tile}} -->
[View Source →](<../../../../../../src/disco/metrics/generate/write_codegen.py#L150>)

Generates C header and source files for metrics associated with a given tile.
- **Inputs**:
    - `tile`: An instance of the `Tile` class representing the tile for which metrics are generated.
    - `metrics`: A list of `Metric` objects representing the metrics to be written for the tile.
- **Logic and Control Flow**:
    - Opens a header file for writing in the `../generated` directory with a name based on the tile's name.
    - Writes include guards and includes necessary header files in the header file.
    - Iterates over each metric in the `metrics` list and calls [`_write_metric`](<#_write_metric>) to write metric-specific definitions to the header file.
    - Calculates the total number of metrics and writes a macro definition for it in the header file.
    - Writes an extern declaration for the metrics array in the header file.
    - Closes the header file after writing the closing include guard.
    - Opens a source file for writing in the `../generated` directory with a name based on the tile's name.
    - Writes a comment indicating the file is generated and includes the corresponding header file.
    - Iterates over each metric in the `metrics` list, constructs a full metric name, and calls [`_write_metric_descriptor`](<#_write_metric_descriptor>) to write metric descriptors to the source file.
    - Closes the source file after writing the metrics array.
- **Output**: Generates a C header file and a C source file for the specified tile's metrics in the `../generated` directory.
- **Functions Called**:
    - [`firedancer/src/disco/metrics/generate/write_codegen._write_metric`](<#_write_metric>)
    - [`firedancer/src/disco/metrics/generate/types.Metric.count`](<types.py.md#metriccount>)
    - [`firedancer/src/disco/metrics/generate/write_codegen.camel2snake`](<#camel2snake>)
    - [`firedancer/src/disco/metrics/generate/write_codegen._write_metric_descriptor`](<#_write_metric_descriptor>)


---
### \_write\_enums<!-- {{#callable:firedancer/src/disco/metrics/generate/write_codegen._write_enums}} -->
[View Source →](<../../../../../../src/disco/metrics/generate/write_codegen.py#L176>)

Generates a C header file with macro definitions for metric enums based on the provided list of `MetricEnum` objects.
- **Inputs**:
    - `enums`: A list of `MetricEnum` objects, each containing a name and a list of values, which represent the enums to be written to the header file.
- **Logic and Control Flow**:
    - Opens a file named 'fd_metrics_enums.h' in the '../generated' directory for writing.
    - Writes the header guard and a comment indicating the file is auto-generated.
    - Iterates over each `MetricEnum` in the `enums` list.
    - For each `MetricEnum`, writes a macro definition for the enum name and the count of its values.
    - Iterates over each value in the `MetricEnum` and writes macro definitions for the index and name of each value.
    - Closes the header guard at the end of the file.
- **Output**: A C header file named 'fd_metrics_enums.h' containing macro definitions for each metric enum and its values.
- **Functions Called**:
    - [`firedancer/src/disco/metrics/generate/write_codegen.camel2snake`](<#camel2snake>)


---
### write\_codegen<!-- {{#callable:firedancer/src/disco/metrics/generate/write_codegen.write_codegen}} -->
[View Source →](<../../../../../../src/disco/metrics/generate/write_codegen.py#L190>)

Generates code files for metrics by writing common, tile-specific, and enum-related data to the filesystem.
- **Inputs**:
    - `metrics`: An instance of the `Metrics` class containing metric data, tiles, and enums to process and write to files.
- **Logic and Control Flow**:
    - Creates a directory named 'generated' relative to the current file's directory if it does not exist.
    - Calls the [`_write_common`](<#_write_common>) function to write common metrics data to a file.
    - Iterates over each tile in `metrics.tiles` and calls [`_write_tile`](<#_write_tile>) to write tile-specific metrics data to files.
    - Calls [`_write_enums`](<#_write_enums>) to write enum-related data to a file.
    - Prints a message indicating the number of metrics and tiles processed.
- **Output**: No return value; writes generated code files to the filesystem and prints a summary message.
- **Functions Called**:
    - [`firedancer/src/disco/metrics/generate/write_codegen._write_common`](<#_write_common>)
    - [`firedancer/src/disco/metrics/generate/write_codegen._write_tile`](<#_write_tile>)
    - [`firedancer/src/disco/metrics/generate/write_codegen._write_enums`](<#_write_enums>)
    - [`firedancer/src/disco/metrics/generate/types.Metrics.count`](<types.py.md#metricscount>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)