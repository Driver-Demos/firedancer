<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Renders Prometheus metrics for HTTP servers using topology and metrics data structures.

# Purpose
The code is a C module designed to render metrics in a format compatible with Prometheus, a popular monitoring and alerting toolkit. It uses an HTTP server to output metrics data, which includes counters, gauges, and histograms. The module defines a structure `fd_prom_render_t` to manage the rendering context, which includes a reference to an HTTP server and a hash of the last metric name processed. The primary functions, such as [`fd_prometheus_render_tile`](<#fd_prometheus_render_tile>) and [`fd_prometheus_render_all`](<#fd_prometheus_render_all>), facilitate the rendering of metrics for individual tiles or all components in a topology, respectively.

The module includes several static functions to handle different types of metrics and their conversions, such as [`render_counter`](<#render_counter>), [`render_histogram`](<#render_histogram>), and [`render_link`](<#render_link>). These functions ensure that metrics are formatted correctly and include necessary metadata like metric names, descriptions, and types. The code also handles the conversion of metric values based on specified units, such as nanoseconds or seconds, and outputs them in a format that Prometheus can scrape. The module is intended to be integrated into a larger system where it can be used to expose metrics data over HTTP for monitoring purposes.
# Imports and Dependencies

---
- `fd_prometheus.h`
- `fd_metrics.h`
- `../topo/fd_topo.h`
- `../../waltz/http/fd_http_server.h`


# Data Structures

---
### fd\_prom\_render
- **Type**: ``struct``
- **Members**:
    - ``http``: Pointer to an `fd_http_server_t` structure.
    - ``last_name_hash``: Stores the hash of the last metric name processed.
- **Description**: Facilitates rendering of Prometheus metrics by storing a reference to an HTTP server and tracking the last processed metric name hash to optimize rendering operations.


---
### fd\_prom\_render\_t
- **Type**: ``struct``
- **Members**:
    - ``http``: Pointer to an `fd_http_server_t` instance for HTTP server interactions.
    - ``last_name_hash``: Stores the hash of the last metric name processed.
- **Description**: Facilitates rendering of Prometheus metrics by maintaining a reference to an HTTP server and tracking the last processed metric name hash to optimize header rendering.


# Functions

---
### fd\_prom\_render\_create<!-- {{#callable:fd_prom_render_create}} -->
[View Source →](<../../../../../src/disco/metrics/fd_prometheus.c#L15>)

Initializes and returns a `fd_prom_render_t` structure with a given HTTP server and a default last name hash.
- **Inputs**:
    - `http`: A pointer to an `fd_http_server_t` structure, representing the HTTP server to associate with the `fd_prom_render_t` structure.
- **Logic and Control Flow**:
    - Creates a `fd_prom_render_t` structure using designated initializers.
    - Sets the `http` field of the structure to the provided `http` argument.
    - Initializes the `last_name_hash` field to 0UL.
    - Returns the initialized `fd_prom_render_t` structure.
- **Output**: A `fd_prom_render_t` structure initialized with the provided HTTP server and a last name hash set to 0UL.


---
### render\_header<!-- {{#callable:render_header}} -->
[View Source →](<../../../../../src/disco/metrics/fd_prometheus.c#L23>)

Renders a header for a metric if it has not been rendered before, based on the metric's name hash.
- **Inputs**:
    - `r`: A pointer to an `fd_prom_render_t` structure, which contains the HTTP server context and the last rendered metric name hash.
    - `metric`: A pointer to a constant `fd_metrics_meta_t` structure, which contains metadata about the metric, including its name and description.
- **Logic and Control Flow**:
    - Calculate the hash of the metric's name using `fd_cstr_hash`.
    - Check if the calculated hash is different from `r->last_name_hash`.
    - If `r->last_name_hash` is not zero, print a newline to the HTTP server using `fd_http_server_printf`.
    - Print the metric's help and type information to the HTTP server using `fd_http_server_printf`.
    - Update `r->last_name_hash` with the new hash value.
- **Output**: No return value; the function outputs data to the HTTP server specified in the `fd_prom_render_t` structure.
- **Functions Called**:
    - [`fd_metrics_meta_type_str`](<fd_metrics_base.h.md#fd_metrics_meta_type_str>)


---
### render\_link<!-- {{#callable:render_link}} -->
[View Source →](<../../../../../src/disco/metrics/fd_prometheus.c#L37>)

Formats and sends a metric value for a specific link to an HTTP server, converting the value if necessary.
- **Inputs**:
    - `r`: A pointer to an `fd_prom_render_t` structure, which contains the HTTP server context.
    - `metric`: A pointer to a constant `fd_metrics_meta_t` structure, which contains metadata about the metric being rendered.
    - `tile`: A pointer to a constant `fd_topo_tile_t` structure, which represents the tile associated with the metric.
    - `link`: A pointer to a constant `fd_topo_link_t` structure, which represents the link associated with the metric.
    - `value`: An unsigned long integer representing the metric value to be rendered.
- **Logic and Control Flow**:
    - Calls [`render_header`](<#render_header>) to ensure the metric header is rendered if it has not been already.
    - Checks the `converter` field of the `metric` to determine if the `value` needs conversion.
    - If `converter` is `FD_METRICS_CONVERTER_NANOSECONDS`, converts `value` from ticks to nanoseconds using [`fd_metrics_convert_ticks_to_nanoseconds`](<fd_metrics.h.md#fd_metrics_convert_ticks_to_nanoseconds>).
    - If `converter` is `FD_METRICS_CONVERTER_NONE`, no conversion is done.
    - If `converter` is unknown, logs an error using `FD_LOG_ERR`.
    - Formats and sends the metric data to the HTTP server using `fd_http_server_printf`, including the metric name, tile and link details, and the (possibly converted) value.
- **Output**: No return value; the function sends formatted metric data to an HTTP server.
- **Functions Called**:
    - [`render_header`](<#render_header>)
    - [`fd_metrics_convert_ticks_to_nanoseconds`](<fd_metrics.h.md#fd_metrics_convert_ticks_to_nanoseconds>)


---
### render\_histogram<!-- {{#callable:render_histogram}} -->
[View Source →](<../../../../../src/disco/metrics/fd_prometheus.c#L56>)

Renders a histogram metric to an HTTP server for a given tile and metric metadata.
- **Inputs**:
    - `r`: A pointer to `fd_prom_render_t`, which contains the HTTP server context.
    - `metric`: A constant pointer to `fd_metrics_meta_t`, which contains metadata about the metric to render.
    - `tile`: A constant pointer to `fd_topo_tile_t`, which represents the tile for which the histogram is rendered.
- **Logic and Control Flow**:
    - Calls [`render_header`](<#render_header>) to render the header for the metric if it has not been rendered yet.
    - Initializes a histogram `hist` based on the metric's converter type, either converting seconds to ticks or using raw values.
    - Iterates over each bucket in the histogram, accumulating values from the tile's metrics and formatting them for output.
    - For each bucket, determines the 'less than or equal' edge value, converting it to seconds if necessary, and formats it as a string.
    - Outputs the formatted bucket data to the HTTP server using `fd_http_server_printf`.
    - Calculates and formats the sum of the histogram values, converting to seconds if necessary, and outputs it to the HTTP server.
    - Outputs the total count of values in the histogram to the HTTP server.
- **Output**: Outputs formatted histogram data, including bucket values, sum, and count, to the HTTP server.
- **Functions Called**:
    - [`render_header`](<#render_header>)
    - [`fd_metrics_convert_seconds_to_ticks`](<fd_metrics.h.md#fd_metrics_convert_seconds_to_ticks>)
    - [`fd_metrics_tile`](<fd_metrics.h.md#fd_metrics_tile>)
    - [`fd_metrics_convert_ticks_to_seconds`](<fd_metrics.h.md#fd_metrics_convert_ticks_to_seconds>)


---
### render\_counter<!-- {{#callable:render_counter}} -->
[View Source →](<../../../../../src/disco/metrics/fd_prometheus.c#L104>)

Formats and outputs a counter metric value to an HTTP server, applying necessary conversions based on the metric's converter type.
- **Inputs**:
    - `r`: A pointer to an `fd_prom_render_t` structure, which contains the HTTP server context for rendering.
    - `metric`: A pointer to a constant `fd_metrics_meta_t` structure, which holds metadata about the metric to be rendered.
    - `tile`: A pointer to a constant `fd_topo_tile_t` structure, which represents the tile associated with the metric.
- **Logic and Control Flow**:
    - Calls [`render_header`](<#render_header>) to output the metric header if it has not been rendered yet.
    - Retrieves the metric value from the tile's metrics using the metric's offset.
    - Checks the `converter` field of the `metric` to determine if the value needs conversion.
    - If the converter is `FD_METRICS_CONVERTER_NANOSECONDS`, converts the value from ticks to nanoseconds.
    - If the converter is `FD_METRICS_CONVERTER_SECONDS`, converts the value from ticks to seconds and rounds it.
    - If the converter is `FD_METRICS_CONVERTER_NONE`, no conversion is applied.
    - Logs an error if the converter type is unknown.
    - Formats and sends the metric name, kind, kind_id, and value to the HTTP server using `fd_http_server_printf`.
    - Includes additional enum information in the output if `enum_name` is present in the metric.
- **Output**: Outputs a formatted string to the HTTP server, representing the metric's name, kind, kind_id, and value, with optional enum information.
- **Functions Called**:
    - [`render_header`](<#render_header>)
    - [`fd_metrics_tile`](<fd_metrics.h.md#fd_metrics_tile>)
    - [`fd_metrics_convert_ticks_to_nanoseconds`](<fd_metrics.h.md#fd_metrics_convert_ticks_to_nanoseconds>)
    - [`fd_metrics_convert_ticks_to_seconds`](<fd_metrics.h.md#fd_metrics_convert_ticks_to_seconds>)


---
### render\_links\_in<!-- {{#callable:render_links_in}} -->
[View Source →](<../../../../../src/disco/metrics/fd_prometheus.c#L131>)

Iterates through metrics and tiles to render incoming link metrics using the [`render_link`](<#render_link>) function.
- **Inputs**:
    - ``r``: A pointer to an `fd_prom_render_t` structure used for rendering.
    - ``topo``: A constant pointer to an `fd_topo_t` structure representing the topology of tiles and links.
    - ``metrics_cnt``: An unsigned long integer representing the number of metrics to process.
    - ``metrics``: A constant pointer to an array of `fd_metrics_meta_t` structures containing metadata for each metric.
- **Logic and Control Flow**:
    - Iterate over each metric in the `metrics` array using a loop indexed by `i`.
    - For each metric, iterate over each tile in the `topo` structure using a loop indexed by `j`.
    - Initialize `polled_in_idx` to zero for tracking polled links.
    - For each tile, iterate over its incoming links using a loop indexed by `k`.
    - Check if the link is polled using `tile->in_link_poll[k]`; if not, continue to the next link.
    - Retrieve the link from `topo->links` using `tile->in_link_id[k]`.
    - Calculate the metric value using [`fd_metrics_link_in`](<fd_metrics.h.md#fd_metrics_link_in>) and the metric's offset.
    - Call [`render_link`](<#render_link>) with the current metric, tile, link, and calculated value.
    - Increment `polled_in_idx` after processing a polled link.
- **Output**: No return value; the function performs rendering operations.
- **Functions Called**:
    - [`fd_metrics_link_in`](<fd_metrics.h.md#fd_metrics_link_in>)
    - [`render_link`](<#render_link>)


---
### render\_links\_out<!-- {{#callable:render_links_out}} -->
[View Source →](<../../../../../src/disco/metrics/fd_prometheus.c#L152>)

Iterates over metrics and topology tiles to render metrics for reliable outgoing links.
- **Inputs**:
    - `r`: A pointer to `fd_prom_render_t`, which manages the rendering state.
    - `topo`: A constant pointer to `fd_topo_t`, representing the topology of tiles and links.
    - `metrics_cnt`: An unsigned long integer representing the number of metrics to process.
    - `metrics`: A constant pointer to an array of `fd_metrics_meta_t`, which contains metadata for each metric.
- **Logic and Control Flow**:
    - Iterate over each metric in the `metrics` array.
    - For each metric, iterate over each tile in the topology.
    - Initialize `reliable_conns_idx` to track reliable connections for the current tile.
    - For each tile, iterate over all other tiles to find consumer tiles.
    - For each consumer tile, iterate over its input links.
    - For each input link, iterate over the current tile's output links.
    - Check if the consumer's input link ID matches the current tile's output link ID and if the link is reliable.
    - If both conditions are true, retrieve the link from the topology and calculate the metric value using [`fd_metrics_link_out`](<fd_metrics.h.md#fd_metrics_link_out>).
    - Call [`render_link`](<#render_link>) to render the metric for the reliable link and increment `reliable_conns_idx`.
- **Output**: No return value; the function performs rendering operations as a side effect.
- **Functions Called**:
    - [`fd_metrics_link_out`](<fd_metrics.h.md#fd_metrics_link_out>)
    - [`render_link`](<#render_link>)


---
### render\_tile\_metric<!-- {{#callable:render_tile_metric}} -->
[View Source →](<../../../../../src/disco/metrics/fd_prometheus.c#L179>)

Renders a metric for a given tile based on its type.
- **Inputs**:
    - `r`: A pointer to an `fd_prom_render_t` structure, which contains rendering context information.
    - `tile`: A pointer to a `fd_topo_tile_t` structure, representing the tile for which the metric is rendered.
    - `metric`: A pointer to a `fd_metrics_meta_t` structure, representing the metric to be rendered.
- **Logic and Control Flow**:
    - Checks if the metric type is `FD_METRICS_TYPE_COUNTER` or `FD_METRICS_TYPE_GAUGE` using `FD_LIKELY` macro.
    - If true, calls [`render_counter`](<#render_counter>) to render the metric as a counter.
    - If the metric type is `FD_METRICS_TYPE_HISTOGRAM`, calls [`render_histogram`](<#render_histogram>) to render the metric as a histogram.
- **Output**: No direct output; it performs rendering operations based on the metric type.
- **Functions Called**:
    - [`render_counter`](<#render_counter>)
    - [`render_histogram`](<#render_histogram>)


---
### render\_tile<!-- {{#callable:render_tile}} -->
[View Source →](<../../../../../src/disco/metrics/fd_prometheus.c#L190>)

Iterates over metrics and tiles to render metrics for a specific tile name.
- **Inputs**:
    - `r`: A pointer to an `fd_prom_render_t` structure used for rendering.
    - `topo`: A pointer to a constant `fd_topo_t` structure representing the topology of tiles.
    - `tile_name`: A constant character pointer representing the name of the tile to render metrics for.
    - `metrics_cnt`: An unsigned long integer representing the count of metrics to process.
    - `metrics`: A pointer to a constant `fd_metrics_meta_t` structure representing the metrics metadata.
- **Logic and Control Flow**:
    - Iterate over each metric using a loop with index `i` from 0 to `metrics_cnt`.
    - For each metric, iterate over each tile in the topology using a loop with index `j` from 0 to `topo->tile_cnt`.
    - Determine the name of the tile using `metrics_name` if available, otherwise use `name`.
    - If `tile_name` is not NULL and does not match the determined tile name, continue to the next tile.
    - Call [`render_tile_metric`](<#render_tile_metric>) to render the metric for the current tile.
- **Output**: No return value; the function performs rendering operations.
- **Functions Called**:
    - [`render_tile_metric`](<#render_tile_metric>)


---
### fd\_prometheus\_render\_tile<!-- {{#callable:fd_prometheus_render_tile}} -->
[View Source →](<../../../../../src/disco/metrics/fd_prometheus.c#L206>)

Renders Prometheus metrics for a specific tile using the provided HTTP server.
- **Inputs**:
    - `http`: A pointer to an `fd_http_server_t` structure, representing the HTTP server used for rendering.
    - `tile`: A pointer to a constant `fd_topo_tile_t` structure, representing the tile for which metrics are rendered.
    - `metrics`: A pointer to a constant `fd_metrics_meta_t` structure, representing the metadata of the metrics to be rendered.
    - `metrics_cnt`: An unsigned long integer representing the number of metrics to render.
- **Logic and Control Flow**:
    - Create a `fd_prom_render_t` object using the provided HTTP server pointer `http`.
    - Iterate over each metric in the `metrics` array, up to `metrics_cnt`.
    - For each metric, call [`render_tile_metric`](<#render_tile_metric>) to render the metric for the specified tile.
- **Output**: No return value; the function outputs rendered metrics to the HTTP server.
- **Functions Called**:
    - [`fd_prom_render_create`](<#fd_prom_render_create>)
    - [`render_tile_metric`](<#render_tile_metric>)


---
### fd\_prometheus\_render\_all<!-- {{#callable:fd_prometheus_render_all}} -->
[View Source →](<../../../../../src/disco/metrics/fd_prometheus.c#L217>)

Renders all Prometheus metrics for a given topology and HTTP server.
- **Inputs**:
    - ``topo``: A pointer to a constant `fd_topo_t` structure representing the topology for which metrics are rendered.
    - ``http``: A pointer to an `fd_http_server_t` structure used to send the rendered metrics.
- **Logic and Control Flow**:
    - Create a `fd_prom_render_t` object `r` using [`fd_prom_render_create`](<#fd_prom_render_create>) with the `http` server.
    - Call [`render_tile`](<#render_tile>) to render all metrics for the entire topology using `FD_METRICS_ALL_TOTAL` and `FD_METRICS_ALL`.
    - Call [`render_links_in`](<#render_links_in>) to render incoming link metrics using `FD_METRICS_ALL_LINK_IN_TOTAL` and `FD_METRICS_ALL_LINK_IN`.
    - Call [`render_links_out`](<#render_links_out>) to render outgoing link metrics using `FD_METRICS_ALL_LINK_OUT_TOTAL` and `FD_METRICS_ALL_LINK_OUT`.
    - Iterate over `FD_METRICS_TILE_KIND_CNT` to render metrics for each tile kind using [`render_tile`](<#render_tile>) with `FD_METRICS_TILE_KIND_NAMES`, `FD_METRICS_TILE_KIND_SIZES`, and `FD_METRICS_TILE_KIND_METRICS`.
- **Output**: No return value; the function outputs metrics to the HTTP server.
- **Functions Called**:
    - [`fd_prom_render_create`](<#fd_prom_render_create>)
    - [`render_tile`](<#render_tile>)
    - [`render_links_in`](<#render_links_in>)
    - [`render_links_out`](<#render_links_out>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)