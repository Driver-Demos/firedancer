<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines a seccomp filter policy for syscall handling with architecture-specific checks and actions.

# Purpose
The code is a C header file that defines a seccomp filter policy for a specific application. It is generated automatically by a script and should not be edited manually. The file includes necessary headers for seccomp and BPF (Berkeley Packet Filter) operations, and it defines architecture-specific constants to ensure compatibility with the runtime environment. The primary function, [`populate_sock_filter_policy_fd_metric_tile`](<#populate_sock_filter_policy_fd_metric_tile>), initializes a BPF filter array with 45 instructions. These instructions enforce a security policy by allowing or denying specific system calls based on predefined conditions.

The filter checks the architecture and various system calls such as `write`, `fsync`, `accept4`, `read`, `sendto`, `close`, and `ppoll`. For each system call, the filter evaluates arguments to determine if the call should be allowed or if the process should be terminated. The filter uses BPF statements and jumps to implement these checks, ensuring that only permitted operations are executed. The function `fd_memcpy` is used to copy the filter instructions into the provided output buffer. This header file is intended to be included in other C source files where the seccomp policy needs to be applied.
# Imports and Dependencies

---
- `../../../../src/util/fd_util_base.h`
- `linux/audit.h`
- `linux/capability.h`
- `linux/filter.h`
- `linux/seccomp.h`
- `linux/bpf.h`
- `sys/syscall.h`
- `signal.h`
- `stddef.h`


# Global Variables

---
### sock\_filter\_policy\_fd\_metric\_tile\_instr\_cnt
- **Type**: ``unsigned int``
- **Description**: Defines the number of instructions in the socket filter policy for the metric tile. It is a constant value set to 45.
- **Use**: Used to verify that the output count is sufficient to hold the filter instructions in the `populate_sock_filter_policy_fd_metric_tile` function.


# Functions

---
### populate\_sock\_filter\_policy\_fd\_metric\_tile<!-- {{#callable:populate_sock_filter_policy_fd_metric_tile}} -->
[View Source →](<../../../../../../src/disco/metrics/generated/fd_metric_tile_seccomp.h#L26>)

Populates a socket filter policy with specific seccomp rules for file descriptor operations.
- **Inputs**:
    - `out_cnt`: The number of elements in the output filter array, expected to be at least 45.
    - `out`: A pointer to an array of `struct sock_filter` where the filter rules will be copied.
    - `logfile_fd`: The file descriptor for the log file, used in syscall checks.
    - `metrics_socket_fd`: The file descriptor for the metrics socket, used in syscall checks.
- **Logic and Control Flow**:
    - Check if `out_cnt` is at least 45 using `FD_TEST` macro.
    - Define a `struct sock_filter` array `filter` with 45 elements containing seccomp rules.
    - Load the architecture from `seccomp_data` and compare it with `ARCH_NR`; jump to `RET_KILL_PROCESS` if they do not match.
    - Load the syscall number and check against allowed syscalls (`write`, `fsync`, `accept4`, `read`, `sendto`, `close`, `ppoll`).
    - For each allowed syscall, load the first argument and compare it with specific values (e.g., `logfile_fd`, `metrics_socket_fd`).
    - If conditions are met, jump to `RET_ALLOW`; otherwise, jump to `RET_KILL_PROCESS`.
    - Copy the `filter` array to the `out` array using `fd_memcpy`.
- **Output**: The function does not return a value; it modifies the `out` array in place with the populated filter rules.



---
Made with ❤️ by [Driver](https://www.driver.ai/)