<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests the functionality of PCAP replay in a hosted environment using transmit and receive tiles.

# Purpose
The code is a C program designed to test the functionality of a packet capture (PCAP) replay system. It is structured to run in a hosted environment, as indicated by the `#if FD_HAS_HOSTED` preprocessor directive. The program defines a configuration structure `test_cfg_t` that holds various parameters and resources needed for the test, such as workspace pointers, command-and-control (CNC) structures, and random number generator seeds. The main components of the program are two functions, [`tx_tile_main`](<#tx_tile_main>) and [`rx_tile_main`](<#rx_tile_main>), which simulate the transmission and reception of network packets, respectively. These functions are executed on separate tiles (or threads) to mimic a real-world network environment.

The program's [`main`](<#main>) function initializes the testing environment by setting up shared memory workspaces, CNC structures, and caches for both transmission and reception. It then launches the [`tx_tile_main`](<#tx_tile_main>) and [`rx_tile_main`](<#rx_tile_main>) functions on separate execution tiles. The program monitors the progress of the PCAP replay, logging diagnostic information and checking for completion or errors. The test runs for a specified duration, after which it halts the execution tiles, cleans up allocated resources, and exits. The code includes static assertions to ensure that certain constants are correctly defined, and it uses a series of tests to validate the alignment and footprint of memory allocations.
# Imports and Dependencies

---
- `../fd_disco.h`


# Data Structures

---
### test\_cfg
- **Type**: ``struct``
- **Members**:
    - `wksp`: Pointer to a workspace of type `fd_wksp_t`.
    - `tx_cnc`: Pointer to a transmit command-and-control structure of type `fd_cnc_t`.
    - `tx_pcap`: Pointer to a constant character string representing the transmit pcap file.
    - `tx_mtu`: Unsigned long representing the maximum transmission unit for transmit.
    - `tx_orig`: Unsigned long representing the original transmission value.
    - `tx_mcache`: Pointer to a transmit metadata cache of type `fd_frag_meta_t`.
    - `tx_dcache`: Pointer to a transmit data cache of type `uchar`.
    - `tx_cr_max`: Unsigned long representing the maximum credit for transmit.
    - `tx_lazy`: Long integer representing the laziness parameter for transmit.
    - `tx_seed`: Unsigned integer representing the seed for transmit random number generation.
    - `rx_cnc`: Pointer to a receive command-and-control structure of type `fd_cnc_t`.
    - `rx_fseq`: Pointer to an unsigned long representing the receive flow sequence.
    - `rx_seed`: Unsigned integer representing the seed for receive random number generation.
    - `rx_lazy`: Integer representing the laziness parameter for receive.
- **Description**: Defines a configuration structure for testing, containing pointers and parameters for both transmit and receive operations, including command-and-control structures, metadata and data caches, and random number generation seeds.


---
### test\_cfg\_t
- **Type**: ``struct``
- **Members**:
    - ``wksp``: Pointer to a workspace of type `fd_wksp_t`.
    - ``tx_cnc``: Pointer to a command-and-control structure for transmission of type `fd_cnc_t`.
    - ``tx_pcap``: Pointer to a constant character string representing the transmission pcap file.
    - ``tx_mtu``: Unsigned long representing the maximum transmission unit size.
    - ``tx_orig``: Unsigned long representing the original transmission size.
    - ``tx_mcache``: Pointer to a transmission metadata cache of type `fd_frag_meta_t`.
    - ``tx_dcache``: Pointer to a transmission data cache of type `uchar`.
    - ``tx_cr_max``: Unsigned long representing the maximum credit for transmission.
    - ``tx_lazy``: Long integer representing the laziness parameter for transmission.
    - ``tx_seed``: Unsigned integer representing the seed for the transmission random number generator.
    - ``rx_cnc``: Pointer to a command-and-control structure for reception of type `fd_cnc_t`.
    - ``rx_fseq``: Pointer to an unsigned long representing the reception flow sequence.
    - ``rx_seed``: Unsigned integer representing the seed for the reception random number generator.
    - ``rx_lazy``: Integer representing the laziness parameter for reception.
- **Description**: `test_cfg_t` is a structure that holds configuration parameters for both transmission and reception processes in a network test setup. It includes pointers to workspace, command-and-control structures, metadata and data caches, and various configuration parameters such as maximum transmission unit, original transmission size, and laziness parameters. It also contains seeds for random number generation used in both transmission and reception processes.


# Functions

---
### tx\_tile\_main<!-- {{#callable:tx_tile_main}} -->
[View Source →](<../../../../../src/disco/pcap/test_pcap_replay.c#L41>)

Executes a tile for replaying packets from a PCAP file using a specified configuration.
- **Inputs**:
    - `argc`: The number of arguments passed to the function, which is not used in this function.
    - `argv`: An array of arguments, where the first element is a pointer to a `test_cfg_t` structure containing configuration parameters for the function.
- **Logic and Control Flow**:
    - Cast `argv` to a `test_cfg_t` pointer to access configuration parameters.
    - Initialize a random number generator `rng` using the seed from the configuration.
    - Allocate a scratch buffer with alignment and size defined by `FD_PCAP_REPLAY_TILE_SCRATCH_FOOTPRINT` and `FD_PCAP_REPLAY_TILE_SCRATCH_ALIGN`.
    - Call `fd_pcap_replay_tile` with the configuration parameters and check for errors using `FD_TEST`.
    - Delete the random number generator and return 0 to indicate successful execution.
- **Output**: Returns 0 to indicate successful execution.


---
### rx\_tile\_main<!-- {{#callable:rx_tile_main}} -->
[View Source →](<../../../../../src/disco/pcap/test_pcap_replay.c#L61>)

Executes a loop to process received data fragments, manage flow control, and handle command-and-control signals.
- **Inputs**:
    - `argc`: The number of arguments passed to the function, used to initialize `rx_idx`.
    - `argv`: An array of arguments, cast to a `test_cfg_t` pointer to access configuration data.
- **Logic and Control Flow**:
    - Initialize `rx_idx` with `argc` and cast `argv` to `test_cfg_t` to access configuration data.
    - Connect to the RX CNC and TX mcache using the configuration data.
    - Initialize the random number generator with the seed from the configuration.
    - Set up housekeeping parameters `async_min` and `async_rem`.
    - Signal the CNC to start running with `FD_CNC_SIGNAL_RUN`.
    - Enter an infinite loop to process data fragments.
    - Wait for a fragment sequence while performing background housekeeping.
    - If housekeeping is due, send flow control credits, update diagnostics, check for CNC signals, and reload the housekeeping timer.
    - If a sequence overrun is detected, log an error and exit the loop.
    - Process the received data fragment by converting the chunk to a local address.
    - Check for overruns during processing and log an error if detected.
    - Increment the sequence number for the next iteration.
    - After exiting the loop, clean up the random number generator and signal the CNC to boot.
- **Output**: Returns 0 upon successful completion.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/disco/pcap/test_pcap_replay.c#L335>)

Initializes the environment and logs a warning if the `FD_HAS_HOSTED` capability is not available, then halts execution.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with `argc` and `argv`.
    - Logs a warning message indicating that the unit test requires `FD_HAS_HOSTED` capabilities.
    - Calls `fd_halt` to stop the execution.
    - Returns 0 to indicate successful completion.
- **Output**: Returns 0, indicating successful execution.



---
Made with ❤️ by [Driver](https://www.driver.ai/)