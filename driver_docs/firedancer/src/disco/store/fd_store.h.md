<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

High-performance in-memory storage engine for FEC set payloads, supporting concurrent access and validation.

# Purpose
The code defines a high-performance in-memory storage engine called `fd_store` for managing FEC (Forward Error Correction) set payloads. These payloads are derived from shreds received over network protocols like Turbine and Repair, which are part of the Solana blockchain infrastructure. The primary function of `fd_store` is to store and manage these FEC sets, which are groupings of shreds that encode the same data with redundancy and security. The storage engine uses a mapping of Merkle root to FEC set payloads, where the Merkle root is a unique identifier generated by hashing all shreds in a FEC set. This design allows for efficient validation and replay of data at the FEC set level rather than at the individual shred level.

The code includes several components and functionalities: it defines data structures for keys and FEC sets, provides functions for creating, joining, and managing the store, and implements concurrency control using read-write locks. The store is designed to support concurrent access by multiple processes, with a focus on minimizing lock contention. The architecture allows for parallel writes by partitioning the keyspace, ensuring that each writer (Shred tile) writes to a unique partition. The code also handles protocol violations like equivocation by using the Merkle root as the key, which provides a robust mechanism for identifying FEC sets. Additionally, the code includes functions for querying, inserting, linking, publishing, and clearing FEC sets, as well as utilities for verifying and printing the store's structure.
# Imports and Dependencies

---
- `../../flamenco/fd_rwlock.h`
- `../../flamenco/types/fd_types_custom.h`
- `../../util/hist/fd_histf.h`
- `../../util/tmpl/fd_pool_para.c`
- `../../util/tmpl/fd_map_chain.c`


# Data Structures

---
### fd\_store\_key
- **Type**: ``struct``
- **Members**:
    - ``mr``: A `fd_hash_t` type representing the Merkle root of the FEC set.
    - ``part``: An `ulong` representing the partition index of the inserter.
- **Description**: The `fd_store_key` structure is a packed data structure used as a key in the `fd_store` mapping. It consists of a Merkle root (`mr`) and a partition index (`part`). The Merkle root uniquely identifies a Forward Error Correction (FEC) set, while the partition index indicates the specific inserter or Shred tile responsible for the insertion. This structure is crucial for managing the storage and retrieval of FEC sets in the `fd_store` system, ensuring that each FEC set can be uniquely identified and accessed.


---
### fd\_store\_key\_t
- **Type**: ``struct``
- **Members**:
    - ``mr``: Merkle root of the FEC set.
    - ``part``: Partition index of the inserter.
- **Description**: Defines a key structure for identifying FEC sets in the `fd_store`. The `mr` field holds the Merkle root, which uniquely identifies the FEC set, while the `part` field indicates the partition index of the inserter, which is used in the hash function to ensure that the same Shred tile always writes to the same map slots, preventing data races.


---
### fd\_store\_fec
- **Type**: ``struct``
- **Members**:
    - ``key``: Map key, merkle root of the FEC set plus a partition index.
    - ``cmr``: Parent's map key, chained merkle root of the FEC set.
    - ``next``: Reserved for internal use by `fd_pool` and `fd_map_chain`.
    - ``parent``: Pool index of the parent.
    - ``child``: Pool index of the left-child.
    - ``sibling``: Pool index of the right-sibling.
    - ``data_sz``: Size of the FEC set payload, guaranteed to be less than `FD_STORE_DATA_MAX`.
    - ``data``: FEC set payload, a coalesced data shreds byte array.
- **Description**: Defines a store element for an FEC set, using a map key based on the merkle root and partition index, and includes pointers for internal tree structure management. The data structure holds the FEC set payload as a byte array and manages relationships between elements using indices for parent, child, and sibling elements.


---
### fd\_store\_fec\_t
- **Type**: ``struct``
- **Members**:
    - ``key``: Map key, merkle root of the FEC set plus a partition index.
    - ``cmr``: Parent's map key, chained merkle root of the FEC set.
    - ``next``: Reserved for internal use by `fd_pool` and `fd_map_chain`.
    - ``parent``: Pool index of the parent.
    - ``child``: Pool index of the left-child.
    - ``sibling``: Pool index of the right-sibling.
    - ``data_sz``: Size of the FEC set payload, guaranteed to be less than `FD_STORE_DATA_MAX`.
    - ``data``: FEC set payload, a byte array of coalesced data shreds.
- **Description**: Defines a store element representing a Forward Error Correction (FEC) set, which is a logical unit for storing data shreds with redundancy and security. The structure includes keys for mapping and chaining, pointers for tree navigation, and a data payload for storing the actual FEC set data. The structure is aligned for performance and designed for concurrent access in a high-performance in-memory storage engine.


---
### fd\_store
- **Type**: ``struct``
- **Members**:
    - `magic`: A magic number used to detect store corruption.
    - `fec_max`: Maximum number of FEC sets that can be stored.
    - `part_cnt`: Number of partitions, also representing the number of writers.
    - `root`: Pool index of the root.
    - `slot0`: A temporary hack needed until the block_id is in the bank (manifest).
    - `store_gaddr`: Workspace global address of the store in the backing workspace, non-zero address.
    - `map_gaddr`: Workspace global address of the map of `fd_store_key` to `fd_store_fec`.
    - `pool_mem_gaddr`: Workspace global address of the `shmem_t` object in `pool_para`.
    - `pool_ele_gaddr`: Workspace global address of the first `ele_t` object in `pool_para`.
    - `lock`: Read-write lock for concurrent access.
- **Description**: The `fd_store` structure is a high-performance in-memory storage engine designed to store FEC set payloads, which are groupings of shreds that encode the same data with redundancy and security. It uses a mapping of merkle root to FEC set payload, ensuring unique identification of FEC sets. The structure supports concurrent access through a read-write lock and is designed for inter-process use, allowing multiple writers and a single reader to access the store concurrently. The store is backed by shared memory within a workspace, making it persistent and remotely inspectable.


---
### fd\_store\_t
- **Type**: ``struct``
- **Members**:
    - ``magic``: Magic number for detecting store corruption.
    - ``fec_max``: Maximum number of FEC sets that can be stored.
    - ``part_cnt``: Number of partitions, also the number of writers.
    - ``root``: Pool index of the root.
    - ``slot0``: Temporary field until block_id is in the bank.
    - ``store_gaddr``: Workspace global address of store in the backing workspace.
    - ``map_gaddr``: Workspace global address of map of `fd_store_key` to `fd_store_fec`.
    - ``pool_mem_gaddr``: Workspace global address of shared memory object in pool.
    - ``pool_ele_gaddr``: Workspace global address of first element object in pool.
    - ``lock``: Read-write lock for concurrent access.
- **Description**: `fd_store_t` is a structure that represents a high-performance in-memory storage engine for FEC set payloads, which are groupings of shreds that encode the same data with redundancy and security. It includes fields for managing the storage and retrieval of these payloads, such as a magic number for corruption detection, maximum storage capacity, partition count, and various global addresses for workspace management. The structure also includes a read-write lock to handle concurrent access, allowing for parallel writes and minimizing lock contention between readers and writers.


---
### fd\_store\_lock\_ctx
- **Type**: ``struct``
- **Members**:
    - ``store_``: A pointer to an `fd_store_t` structure.
    - ``acq_start``: A pointer to a `long` representing the start time of acquisition.
    - ``acq_end``: A pointer to a `long` representing the end time of acquisition.
    - ``work_end``: A pointer to a `long` representing the end time of work.
- **Description**: Manages lock context for an `fd_store`, including acquisition and work timing.


---
### fd\_store\_histf
- **Type**: ``struct``
- **Members**:
    - ``histf``: Pointer to a `fd_histf_t` structure.
    - ``ts``: Timestamp represented as a `long` integer.
- **Description**: The `fd_store_histf` structure is used to store a pointer to a histogram (`fd_histf_t`) and a timestamp (`ts`). This structure is likely used to record and manage timing or frequency data, with the timestamp indicating when a particular event or measurement occurred.


---
### fd\_store\_histf\_t
- **Type**: ``struct``
- **Members**:
    - ``histf``: Pointer to a `fd_histf_t` structure.
    - ``ts``: Timestamp represented as a `long` integer.
- **Description**: `fd_store_histf_t` is a structure that contains a pointer to a histogram (`fd_histf_t`) and a timestamp (`ts`). It is used to sample and record the time taken for certain operations by calculating the difference between the current tick count and the stored timestamp.


# Functions

---
### fd\_store\_align<!-- {{#callable:fd_store_align}} -->
[View Source →](<../../../../../src/disco/store/fd_store.h#L232>)

Returns the alignment requirement for a memory region suitable for use as a store.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the alignment requirement using the `alignof` operator on `fd_store_t`.
- **Output**: An unsigned long integer representing the alignment requirement for `fd_store_t`.


---
### fd\_store\_footprint<!-- {{#callable:fd_store_footprint}} -->
[View Source →](<../../../../../src/disco/store/fd_store.h#L245>)

Calculates the memory footprint required for a store with a specified maximum number of FEC sets.
- **Inputs**:
    - `fec_max`: The maximum number of FEC sets that the store can hold, which must be a power of two.
- **Logic and Control Flow**:
    - Check if `fec_max` is a power of two using `fd_ulong_is_pow2`; if not, return 0.
    - Initialize the layout with `FD_LAYOUT_INIT`.
    - Append the layout for `fd_store_t` with its alignment and size.
    - Append the layout for the map with its alignment and footprint calculated for `fec_max`.
    - Append the layout for the pool with its alignment and footprint.
    - Append the layout for `fd_store_fec_t` with its alignment and size multiplied by `fec_max`.
    - Finalize the layout with the alignment of `fd_store_t`.
- **Output**: Returns the total memory footprint in bytes as an unsigned long integer.
- **Functions Called**:
    - [`fd_store_align`](<#fd_store_align>)


---
### fd\_store\_wksp<!-- {{#callable:fd_store_wksp}} -->
[View Source →](<../../../../../src/disco/store/fd_store.h#L302>)

Calculates and returns a pointer to the workspace backing the given store.
- **Inputs**:
    - `store`: A pointer to a constant `fd_store_t` structure representing the store whose workspace is to be retrieved.
- **Logic and Control Flow**:
    - Casts the `store` pointer to an unsigned long integer.
    - Subtracts the `store_gaddr` field of the `store` from this value.
    - Casts the result back to a pointer of type `fd_wksp_t`.
- **Output**: A pointer to the `fd_wksp_t` structure representing the workspace backing the store.


---
### fd\_store\_pool<!-- {{#callable:fd_store_pool_t::fd_store_pool}} -->
[View Source →](<../../../../../src/disco/store/fd_store.h#L308>)

Computes and returns a local join handle to the pool of FEC set elements in the store.
- **Inputs**:
    - `store`: A pointer to a constant `fd_store_t` structure representing the store from which to retrieve the pool.
- **Logic and Control Flow**:
    - Calls [`fd_store_wksp`](<#fd_store_wksp>) to get the workspace associated with the store.
    - Uses `fd_wksp_laddr_fast` to compute the local address of the pool memory and the first pool element using the workspace and global addresses stored in `store`.
    - Creates and returns an `fd_store_pool_t` structure initialized with the computed local addresses and the maximum number of FEC sets (`ele_max`) from the store.
- **Output**: Returns an `fd_store_pool_t` structure containing local addresses for the pool memory and elements, and the maximum number of elements.
- **Functions Called**:
    - [`fd_store_wksp`](<#fd_store_wksp>)


---
### fd\_store\_map\_const<!-- {{#callable:fd_store_map_const}} -->
[View Source →](<../../../../../src/disco/store/fd_store.h#L319>)

Returns a constant pointer to the map of FEC set payloads in the store.
- **Inputs**:
    - `store`: A constant pointer to an `fd_store_t` structure representing the store.
- **Logic and Control Flow**:
    - Calls [`fd_store_wksp`](<#fd_store_wksp>) with `store` to get the workspace associated with the store.
    - Uses `fd_wksp_laddr_fast` to compute the local address of the map using the workspace and the `map_gaddr` field of `store`.
    - Returns the computed local address as a constant pointer to `fd_store_map_t`.
- **Output**: A constant pointer to `fd_store_map_t`, representing the map of FEC set payloads in the store.
- **Functions Called**:
    - [`fd_store_wksp`](<#fd_store_wksp>)


---
### fd\_store\_fec0\_const<!-- {{#callable:fd_store_fec0_const}} -->
[View Source →](<../../../../../src/disco/store/fd_store.h#L321>)

Returns a constant pointer to the first element in the FEC set pool of a given store.
- **Inputs**:
    - `store`: A constant pointer to an `fd_store_t` structure representing the store from which to retrieve the FEC set pool.
- **Logic and Control Flow**:
    - Call [`fd_store_pool`](<#fd_store_pool_tfd_store_pool>) with `store` to get the pool associated with the store.
    - Return the `ele` field of the pool, which is a pointer to the first element in the FEC set pool.
- **Output**: A constant pointer to the first `fd_store_fec_t` element in the pool.
- **Functions Called**:
    - [`fd_store_pool_t::fd_store_pool`](<#fd_store_pool_tfd_store_pool>)


---
### fd\_store\_root\_const<!-- {{#callable:fd_store_root_const}} -->
[View Source →](<../../../../../src/disco/store/fd_store.h#L323>)

Returns a constant pointer to the root FEC set element in the store.
- **Inputs**:
    - `store`: A constant pointer to an `fd_store_t` structure representing the store from which to retrieve the root FEC set element.
- **Logic and Control Flow**:
    - Call [`fd_store_pool`](<#fd_store_pool_tfd_store_pool>) with `store` to get the pool associated with the store.
    - Return the result of `fd_store_pool_ele_const` with the pool and the root index from `store`.
- **Output**: A constant pointer to an `fd_store_fec_t` structure representing the root FEC set element in the store.
- **Functions Called**:
    - [`fd_store_pool_t::fd_store_pool`](<#fd_store_pool_tfd_store_pool>)


---
### fd\_store\_parent\_const<!-- {{#callable:fd_store_parent_const}} -->
[View Source →](<../../../../../src/disco/store/fd_store.h#L332>)

Retrieves a constant pointer to the parent FEC set of a given FEC set within a store.
- **Inputs**:
    - `store`: A constant pointer to an `fd_store_t` structure representing the store.
    - `fec`: A constant pointer to an `fd_store_fec_t` structure representing the FEC set whose parent is to be retrieved.
- **Logic and Control Flow**:
    - Call [`fd_store_pool`](<#fd_store_pool_tfd_store_pool>) with `store` to get the pool associated with the store.
    - Use `fd_store_pool_ele_const` with the pool and the `parent` index from `fec` to retrieve the parent FEC set.
- **Output**: A constant pointer to the parent `fd_store_fec_t` structure of the given FEC set.
- **Functions Called**:
    - [`fd_store_pool_t::fd_store_pool`](<#fd_store_pool_tfd_store_pool>)


---
### fd\_store\_child\_const<!-- {{#callable:fd_store_child_const}} -->
[View Source →](<../../../../../src/disco/store/fd_store.h#L334>)

Retrieves a constant pointer to the left-child element of a given FEC set in the store.
- **Inputs**:
    - `store`: A constant pointer to the `fd_store_t` structure representing the store.
    - `fec`: A constant pointer to the `fd_store_fec_t` structure representing the FEC set whose child is to be retrieved.
- **Logic and Control Flow**:
    - Compute the pool handle by calling [`fd_store_pool`](<#fd_store_pool_tfd_store_pool>) with the `store` argument.
    - Retrieve the constant pointer to the left-child element of the given FEC set by calling `fd_store_pool_ele_const` with the pool handle and the `child` index from the `fec` structure.
- **Output**: A constant pointer to the `fd_store_fec_t` structure representing the left-child of the given FEC set.
- **Functions Called**:
    - [`fd_store_pool_t::fd_store_pool`](<#fd_store_pool_tfd_store_pool>)


---
### fd\_store\_sibling\_const<!-- {{#callable:fd_store_sibling_const}} -->
[View Source →](<../../../../../src/disco/store/fd_store.h#L336>)

Retrieves a constant pointer to the right-sibling FEC set element from a given store and FEC set element.
- **Inputs**:
    - `store`: A constant pointer to an `fd_store_t` structure representing the store from which to retrieve the sibling.
    - `fec`: A constant pointer to an `fd_store_fec_t` structure representing the FEC set element whose sibling is to be retrieved.
- **Logic and Control Flow**:
    - Compute the pool associated with the given `store` by calling [`fd_store_pool`](<#fd_store_pool_tfd_store_pool>) with `store` as the argument.
    - Retrieve the constant pointer to the sibling element by calling `fd_store_pool_ele_const` with the computed pool and the `sibling` index from the `fec` structure.
- **Output**: A constant pointer to the right-sibling `fd_store_fec_t` element in the store.
- **Functions Called**:
    - [`fd_store_pool_t::fd_store_pool`](<#fd_store_pool_tfd_store_pool>)


---
### fd\_store\_shacq<!-- {{#callable:fd_store_shacq}} -->
[View Source →](<../../../../../src/disco/store/fd_store.h#L343>)

Acquires a shared lock on the `fd_store_t` structure for concurrent read access.
- **Inputs**:
    - `store`: A pointer to an `fd_store_t` structure on which the shared lock is to be acquired.
- **Logic and Control Flow**:
    - Calls the `fd_rwlock_read` function with the address of the `lock` member of the `store` structure to acquire a shared lock.
- **Output**: No output is returned.


---
### fd\_store\_shrel<!-- {{#callable:fd_store_shrel}} -->
[View Source →](<../../../../../src/disco/store/fd_store.h#L344>)

Releases the shared lock on the `fd_store_t` structure.
- **Inputs**:
    - `store`: A pointer to the `fd_store_t` structure whose shared lock is to be released.
- **Logic and Control Flow**:
    - Calls the `fd_rwlock_unread` function with the `lock` member of the `store` structure to release the shared lock.
- **Output**: No return value.


---
### fd\_store\_exacq<!-- {{#callable:fd_store_exacq}} -->
[View Source →](<../../../../../src/disco/store/fd_store.h#L345>)

Acquires an exclusive write lock on the `fd_store_t` structure's lock.
- **Inputs**:
    - `store`: A pointer to an `fd_store_t` structure, which represents the in-memory storage engine for FEC set payloads.
- **Logic and Control Flow**:
    - Calls `fd_rwlock_write` with the address of the `lock` member of the `store` structure to acquire an exclusive write lock.
- **Output**: No return value; the function operates directly on the `store` structure to acquire the lock.


---
### fd\_store\_exrel<!-- {{#callable:fd_store_exrel}} -->
[View Source →](<../../../../../src/disco/store/fd_store.h#L346>)

Releases the exclusive lock on the `fd_store_t` structure.
- **Inputs**:
    - `store`: A pointer to the `fd_store_t` structure whose exclusive lock is to be released.
- **Logic and Control Flow**:
    - Calls the `fd_rwlock_unwrite` function with the address of the `lock` member of the `store` structure to release the exclusive lock.
- **Output**: No return value.


---
### fd\_store\_shared\_lock\_cleanup<!-- {{#callable:fd_store_shared_lock_cleanup}} -->
[View Source →](<../../../../../src/disco/store/fd_store.h#L355>)

Releases a shared lock on a store and records the current tick count in the context's `work_end` field.
- **Inputs**:
    - `ctx`: A pointer to a `fd_store_lock_ctx` structure, which contains the context for the lock operation, including the store and timing fields.
- **Logic and Control Flow**:
    - Set the `work_end` field in the `ctx` structure to the current tick count using `fd_tickcount()`.
    - Release the shared lock on the store by calling `fd_store_shrel()` with the store from the `ctx` structure.
- **Output**: No return value (void function).
- **Functions Called**:
    - [`fd_store_shrel`](<#fd_store_shrel>)


---
### fd\_store\_exclusive\_lock\_cleanup<!-- {{#callable:fd_store_exclusive_lock_cleanup}} -->
[View Source →](<../../../../../src/disco/store/fd_store.h#L368>)

Releases an exclusive lock on a store and records the end time of the lock operation.
- **Inputs**:
    - `ctx`: A pointer to a `fd_store_lock_ctx` structure that contains context information for the lock operation, including the store and timing information.
- **Logic and Control Flow**:
    - Set the value pointed to by `ctx->work_end` to the current tick count using `fd_tickcount()` to record the end time of the lock operation.
    - Call [`fd_store_exrel`](<#fd_store_exrel>) with `ctx->store_` to release the exclusive lock on the store.
- **Output**: No return value (void function).
- **Functions Called**:
    - [`fd_store_exrel`](<#fd_store_exrel>)


---
### fd\_store\_histf<!-- {{#callable:fd_store_histf}} -->
[View Source →](<../../../../../src/disco/store/fd_store.h#L386>)

Records a sample in a histogram based on the time elapsed since a stored timestamp.
- **Inputs**:
    - `ctx`: A pointer to a `fd_store_histf_t` structure containing a histogram and a timestamp.
- **Logic and Control Flow**:
    - Calculate the time difference between the current tick count and the timestamp stored in `ctx->ts`.
    - Use `fd_long_max` to ensure the time difference is not negative by comparing it with 0.
    - Cast the result to `ulong` and record it as a sample in the histogram `ctx->histf` using `fd_histf_sample`.
- **Output**: No return value; the function updates the histogram in the provided context.


---
### fd\_store\_query\_const<!-- {{#callable:fd_store_query_const}} -->
[View Source →](<../../../../../src/disco/store/fd_store.h#L423>)

Queries a constant FEC set in the store using a given Merkle root.
- **Inputs**:
    - `store`: A pointer to a constant `fd_store_t` structure representing the store to query.
    - `merkle_root`: A pointer to an `fd_hash_t` structure representing the Merkle root used as the key for querying the FEC set.
- **Logic and Control Flow**:
    - Initialize a `fd_store_key_t` structure `key` with the given `merkle_root` and set `part` to `UINT_MAX`.
    - Iterate over the number of partitions in the store (`store->part_cnt`).
    - For each partition, set `key.part` to the current partition index `i`.
    - Call `fd_store_map_ele_query_const` with the constant map of the store, the `key`, and the constant first element of the FEC set pool to query for the FEC set.
    - If a non-null FEC set is found, return it immediately.
    - If no FEC set is found after checking all partitions, return `NULL`.
- **Output**: Returns a pointer to a constant `fd_store_fec_t` structure if the FEC set is found, or `NULL` if not found.
- **Functions Called**:
    - [`fd_store_map_const`](<#fd_store_map_const>)
    - [`fd_store_fec0_const`](<#fd_store_fec0_const>)


# Function Declarations (Public API)

---
### fd\_store\_new<!-- {{#callable_declaration:fd_store_new}} -->
[View Source →](<../../../../../src/disco/store/fd_store.h#L266>)

Initializes a memory region for use as a store.
- **Description**: Use this function to format a memory region for use as a store, which is a high-performance in-memory storage engine for FEC set payloads. The memory region must be part of a workspace and properly aligned. The function requires a non-zero partition count and a valid `fec_max` value, which must be a power of two. If any of these conditions are not met, the function returns `NULL` and logs a warning. This function is typically called during the setup phase of an application that uses the store for managing FEC sets.
- **Inputs**:
    - `shmem`: A pointer to the shared memory region to be used as a store. Must not be null and must be aligned according to `fd_store_align()`. The memory must be part of a workspace.
    - `fec_max`: The maximum number of FEC sets that can be stored. Must be a power of two. If not, the function returns `NULL`.
    - `part_cnt`: The number of partitions, which should match the number of writers or shred tiles. Must be greater than zero. If zero, the function returns `NULL`.
- **Output**: Returns a pointer to the initialized memory region on success, or `NULL` on failure.
- **See Also**: [`fd_store_new`](<fd_store.c.md#fd_store_new>)  (Implementation)


---
### fd\_store\_join<!-- {{#callable_declaration:fd_store_join}} -->
[View Source →](<../../../../../src/disco/store/fd_store.h#L275>)

Joins a caller to a shared memory store.
- **Description**: Use this function to join a caller to a shared memory store, allowing access to the store's data. The function requires a valid pointer to the shared memory region that backs the store. The memory must be properly aligned and part of a workspace. The store must have a valid magic number to ensure it is not corrupted. If any of these conditions are not met, the function will return NULL and log a warning. This function is typically used after the store has been initialized and before any operations are performed on it.
- **Inputs**:
    - `shstore`: A pointer to the shared memory region backing the store. Must not be null, must be aligned according to `fd_store_align()`, and must be part of a workspace. The store must have a valid magic number (`FD_STORE_MAGIC`). If these conditions are not met, the function returns NULL.
- **Output**: Returns a pointer to the store in the local address space on success, or NULL if the input is invalid or the store is corrupted.
- **See Also**: [`fd_store_join`](<fd_store.c.md#fd_store_join>)  (Implementation)


---
### fd\_store\_leave<!-- {{#callable_declaration:fd_store_leave}} -->
[View Source →](<../../../../../src/disco/store/fd_store.h#L282>)

Leaves a current local join to a store.
- **Description**: Use this function to leave a current local join to a store. It is important to ensure that the `store` parameter is not null before calling this function. If the `store` is null, the function logs a warning and returns null. This function is typically used when a process no longer needs to interact with a store and wants to release its association with it.
- **Inputs**:
    - `store`: A pointer to a `fd_store_t` structure representing the store to leave. Must not be null. If null, the function logs a warning and returns null.
- **Output**: Returns a pointer to the underlying shared memory region on success, or null if the `store` is null.
- **See Also**: [`fd_store_leave`](<fd_store.c.md#fd_store_leave>)  (Implementation)


---
### fd\_store\_delete<!-- {{#callable_declaration:fd_store_delete}} -->
[View Source →](<../../../../../src/disco/store/fd_store.h#L292>)

Unformats a memory region used as a store.
- **Description**: Use this function to unformat a memory region that was previously used as a store. It should be called when the store is no longer needed and no processes are joined to it. This function checks for a valid store by verifying the alignment and a magic number. If these checks fail, it logs a warning and returns NULL. If successful, it returns a pointer to the underlying shared memory region, transferring ownership to the caller.
- **Inputs**:
    - `shstore`: A pointer to the memory region used as a store. It must be aligned according to `fd_store_align()` and must not be NULL. The store must have a valid magic number (`FD_STORE_MAGIC`). If these conditions are not met, the function logs a warning and returns NULL.
- **Output**: Returns a pointer to the underlying shared memory region if successful, or NULL if the input is invalid.
- **See Also**: [`fd_store_delete`](<fd_store.c.md#fd_store_delete>)  (Implementation)


---
### fd\_store\_insert<!-- {{#callable_declaration:fd_store_insert}} -->
[View Source →](<../../../../../src/disco/store/fd_store.h#L455>)

Inserts a new FEC set into the store.
- **Description**: Use this function to add a new FEC set to the store, identified by a unique Merkle root. Before calling, ensure the store is joined and has available space for a new element. The function requires the caller to have acquired either a shared or exclusive lock on the store. If the Merkle root already exists in the store, the function will not insert the element and will return NULL. If this is the first element inserted, it will be set as the store's root. The caller should release the lock only after they no longer need the returned pointer.
- **Inputs**:
    - `store`: A pointer to the store where the FEC set will be inserted. Must be a valid, joined store instance. The caller retains ownership.
    - `part_idx`: An unsigned long integer representing the partition index of the inserter. Must be a valid index within the store's partition count.
    - `merkle_root`: A pointer to the Merkle root hash that uniquely identifies the FEC set. Must not be null. The caller retains ownership.
- **Output**: Returns a pointer to the newly inserted `fd_store_fec_t` if successful, or NULL if the Merkle root already exists or if an error occurs.
- **See Also**: [`fd_store_insert`](<fd_store.c.md#fd_store_insert>)  (Implementation)


---
### fd\_store\_link<!-- {{#callable_declaration:fd_store_link}} -->
[View Source →](<../../../../../src/disco/store/fd_store.h#L470>)

Links a child FEC set to a parent FEC set in the store.
- **Description**: Use this function to establish a parent-child relationship between two FEC sets in the store. It assumes that both the child and parent FEC sets, identified by their respective merkle roots, are already present in the store. The function requires that the caller has acquired a shared lock on the store before calling. If the child is already linked to a parent, the function returns the child without making changes. This function is useful for maintaining the hierarchical structure of FEC sets within the store.
- **Inputs**:
    - `store`: A pointer to the `fd_store_t` instance where the FEC sets are stored. Must not be null and must be a valid store instance.
    - `merkle_root`: A pointer to the `fd_hash_t` representing the merkle root of the child FEC set. Must not be null and must correspond to an existing element in the store.
    - `chained_merkle_root`: A pointer to the `fd_hash_t` representing the merkle root of the parent FEC set. Must not be null and must correspond to an existing element in the store.
- **Output**: Returns a pointer to the `fd_store_fec_t` representing the child FEC set. Returns NULL if the child or parent FEC set is not found in the store when handholding is enabled.
- **See Also**: [`fd_store_link`](<fd_store.c.md#fd_store_link>)  (Implementation)


---
### fd\_store\_publish<!-- {{#callable_declaration:fd_store_publish}} -->
[View Source →](<../../../../../src/disco/store/fd_store.h#L494>)

Publishes a new root in the store and prunes non-descendant elements.
- **Description**: Use this function to set a new root in the store, identified by the given Merkle root, and remove all elements that do not descend from this new root. This operation is necessary when you want to update the store's root to reflect a new state, ensuring that only relevant elements remain. The function assumes that the Merkle root is already present in the store and connected to the current root. It requires the caller to have acquired an exclusive lock on the store before calling, as it modifies the store's structure. If additional runtime checks are enabled, the function will return NULL if the Merkle root is not found.
- **Inputs**:
    - `store`: A pointer to the `fd_store_t` structure representing the store. The caller must have an exclusive lock on the store before calling this function.
    - `merkle_root`: A constant pointer to an `fd_hash_t` representing the Merkle root of the new root element. It must not be NULL and must correspond to an element currently in the store.
- **Output**: Returns a pointer to the `fd_store_fec_t` structure representing the new root if successful, or NULL if the operation fails (e.g., if the Merkle root is not found when runtime checks are enabled).
- **See Also**: [`fd_store_publish`](<fd_store.c.md#fd_store_publish>)  (Implementation)


---
### fd\_store\_clear<!-- {{#callable_declaration:fd_store_clear}} -->
[View Source →](<../../../../../src/disco/store/fd_store.h#L503>)

Clears all elements from the store.
- **Description**: Use this function to remove all elements from the store and release them back into the pool. This operation does not zero-out fields, and the store must be non-empty before calling this function. If the store is empty and additional runtime checks are enabled, a warning is logged, and the function returns NULL.
- **Inputs**:
    - `store`: A pointer to the `fd_store_t` instance to clear. Must not be NULL and must point to a non-empty store. The caller retains ownership.
- **Output**: Returns a pointer to the cleared `fd_store_t` instance, or NULL if the store was empty and runtime checks are enabled.
- **See Also**: [`fd_store_clear`](<fd_store.c.md#fd_store_clear>)  (Implementation)


---
### fd\_store\_verify<!-- {{#callable_declaration:fd_store_verify}} -->
[View Source →](<../../../../../src/disco/store/fd_store.h#L512>)

Verifies the integrity of the store's internal structure.
- **Description**: Use this function to check the consistency and correctness of the store's internal mappings and partitions. It ensures that the partition sizes match the expected seed values and that each element is correctly placed within its partition. This function should be called when you need to validate the store's state, especially after modifications or before critical operations. It returns an error if any inconsistency is found, such as mismatched partition sizes or elements outside their expected range.
- **Inputs**:
    - `store`: A pointer to an `fd_store_t` structure representing the store to verify. Must not be null. The function will log warnings and return an error if the store's internal structure is inconsistent.
- **Output**: Returns 0 if the store is verified successfully, or -1 if any inconsistency is detected.
- **See Also**: [`fd_store_verify`](<fd_store.c.md#fd_store_verify>)  (Implementation)


---
### fd\_store\_print<!-- {{#callable_declaration:fd_store_print}} -->
[View Source →](<../../../../../src/disco/store/fd_store.h#L515>)

Prints a formatted representation of the store as a tree structure.
- **Description**: Use this function to display the contents of the store in a human-readable tree format. It starts printing from the root of the store and includes each node's FEC set key, represented by the merkle root hash. This function is useful for debugging or inspecting the current state of the store. Ensure that the store is properly initialized and joined before calling this function.
- **Inputs**:
    - `store`: A pointer to a constant `fd_store_t` structure representing the store to print. Must not be null. The caller retains ownership of the store.
- **Output**: None
- **See Also**: [`fd_store_print`](<fd_store.c.md#fd_store_print>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)