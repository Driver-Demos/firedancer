<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for managing a memory-backed store with partitioned data and Merkle tree operations.

# Purpose
The code is a C source file that implements a data structure for managing a store of Forward Error Correction (FEC) elements. It provides functions to create, manage, and manipulate a store that is used to handle FEC data, which is organized in a tree-like structure. The primary operations include creating a new store ([`fd_store_new`](<#fd_store_new>)), joining and leaving a store ([`fd_store_join`](<#fd_store_join>), [`fd_store_leave`](<#fd_store_leave>)), inserting and linking FEC elements ([`fd_store_insert`](<#fd_store_insert>), [`fd_store_link`](<#fd_store_link>)), and publishing and clearing the store ([`fd_store_publish`](<#fd_store_publish>), [`fd_store_clear`](<#fd_store_clear>)). The code also includes functions for verifying the integrity of the store ([`fd_store_verify`](<#fd_store_verify>)) and printing its structure ([`fd_store_print`](<#fd_store_print>)).

The file includes several key components such as memory alignment checks, workspace management, and hash-based partitioning of data. It uses a custom memory allocation strategy with scratch memory allocation macros (`FD_SCRATCH_ALLOC_INIT`, `FD_SCRATCH_ALLOC_APPEND`, `FD_SCRATCH_ALLOC_FINI`) to manage memory within a shared memory segment. The code also defines a set of macros and constants for handling null values and blocking operations. The functions are designed to ensure data integrity and consistency through various checks and logging mechanisms, and they interact with other components like `fd_store_pool` and `fd_store_map` to manage the FEC elements efficiently.
# Imports and Dependencies

---
- `fd_store.h`
- `../../flamenco/fd_flamenco_base.h`
- `stdio.h`


# Global Variables

---
### hash\_null
- **Type**: ``fd_hash_t``
- **Description**: A static constant variable of type `fd_hash_t` initialized with a value of 0. This indicates that `hash_null` is a constant hash value used as a placeholder or default value in the program.
- **Use**: Used as a default or null hash value in various operations within the `fd_store` functions.


# Functions

---
### fd\_store\_new<!-- {{#callable:fd_store_new}} -->
[View Source →](<../../../../../src/disco/store/fd_store.c#L10>)

Initializes a new store in shared memory with specified parameters and returns a pointer to the shared memory if successful.
- **Inputs**:
    - `shmem`: Pointer to the shared memory where the store will be initialized.
    - `fec_max`: Maximum number of Forward Error Correction (FEC) chains in the store.
    - `part_cnt`: Number of partitions for the store, which must be greater than zero.
- **Logic and Control Flow**:
    - Check if `part_cnt` is zero and log a warning if true, then return `NULL`.
    - Check if `shmem` is `NULL` and log a warning if true, then return `NULL`.
    - Check if `shmem` is aligned according to `fd_store_align()` and log a warning if not, then return `NULL`.
    - Calculate the footprint using `fd_store_footprint(fec_max)` and log a warning if it is zero, then return `NULL`.
    - Verify that `shmem` is part of a workspace using `fd_wksp_containing(shmem)` and log a warning if not, then return `NULL`.
    - Calculate `part_slot_cnt` as `fec_max / part_cnt` and set `seed` to `part_slot_cnt`.
    - Initialize scratch memory allocation with `FD_SCRATCH_ALLOC_INIT` and allocate memory for `store`, `map`, `shpool`, and `shele` using `FD_SCRATCH_ALLOC_APPEND`.
    - Verify the allocation with `FD_SCRATCH_ALLOC_FINI` and ensure it matches the expected footprint.
    - Initialize the `store` structure and set its global addresses using `fd_wksp_gaddr_fast`.
    - Set `store` parameters such as `part_cnt`, `fec_max`, and `root`.
    - Initialize the store pool with `fd_store_pool_new` and reset it with `fd_store_pool_reset`.
    - Set the `magic` field of `store` to `FD_STORE_MAGIC` using memory fences for synchronization.
    - Return the `shmem` pointer if all operations are successful.
- **Output**: Returns a pointer to the shared memory (`shmem`) if the store is successfully initialized, otherwise returns `NULL`.
- **Functions Called**:
    - [`fd_store_align`](<fd_store.h.md#fd_store_align>)
    - [`fd_store_footprint`](<fd_store.h.md#fd_store_footprint>)
    - [`fd_store_pool_t::fd_store_pool`](<fd_store.h.md#fd_store_pool_tfd_store_pool>)


---
### fd\_store\_join<!-- {{#callable:fd_store_join}} -->
[View Source →](<../../../../../src/disco/store/fd_store.c#L81>)

Validates and returns a pointer to a `fd_store_t` structure if the input shared memory store is valid and properly aligned.
- **Inputs**:
    - `shstore`: A pointer to the shared memory store to validate and join.
- **Logic and Control Flow**:
    - Check if `shstore` is NULL; if true, log a warning and return NULL.
    - Check if `shstore` is aligned according to `fd_store_align()`; if not, log a warning and return NULL.
    - Retrieve the workspace containing `shstore` using `fd_wksp_containing`; if it is NULL, log a warning and return NULL.
    - Cast `shstore` to a `fd_store_t` pointer and check if its `magic` field equals `FD_STORE_MAGIC`; if not, log a warning and return NULL.
    - Return the `fd_store_t` pointer.
- **Output**: A pointer to a `fd_store_t` structure if successful, otherwise NULL.
- **Functions Called**:
    - [`fd_store_align`](<fd_store.h.md#fd_store_align>)


---
### fd\_store\_leave<!-- {{#callable:fd_store_leave}} -->
[View Source →](<../../../../../src/disco/store/fd_store.c#L109>)

Returns the input `store` pointer if it is not NULL, otherwise logs a warning and returns NULL.
- **Inputs**:
    - `store`: A constant pointer to an `fd_store_t` structure, representing the store to leave.
- **Logic and Control Flow**:
    - Check if the `store` pointer is NULL using `FD_UNLIKELY`.
    - If `store` is NULL, log a warning message 'NULL store' using `FD_LOG_WARNING` and return NULL.
    - If `store` is not NULL, cast it to a `void *` and return it.
- **Output**: A `void *` pointer to the `store` if it is not NULL, otherwise NULL.


---
### fd\_store\_delete<!-- {{#callable:fd_store_delete}} -->
[View Source →](<../../../../../src/disco/store/fd_store.c#L120>)

Deletes a store by validating and resetting its magic number.
- **Inputs**:
    - `shstore`: A pointer to the shared store to delete.
- **Logic and Control Flow**:
    - Check if `shstore` is NULL; if so, log a warning and return NULL.
    - Check if `shstore` is aligned according to [`fd_store_align`](<fd_store.h.md#fd_store_align>); if not, log a warning and return NULL.
    - Cast `shstore` to a `fd_store_t` pointer and check if its `magic` field matches `FD_STORE_MAGIC`; if not, log a warning and return NULL.
    - Use memory fences to ensure memory operations are completed, then set the `magic` field of the store to 0.
    - Return the original `shstore` pointer.
- **Output**: Returns the original `shstore` pointer if successful, or NULL if any validation fails.
- **Functions Called**:
    - [`fd_store_align`](<fd_store.h.md#fd_store_align>)


---
### fd\_store\_insert<!-- {{#callable:fd_store_insert}} -->
[View Source →](<../../../../../src/disco/store/fd_store.c#L146>)

Inserts a new Forward Error Correction (FEC) entry into the store if the Merkle root is not already present.
- **Inputs**:
    - `store`: A pointer to the `fd_store_t` structure representing the store where the FEC entry will be inserted.
    - `part_idx`: An unsigned long integer representing the partition index for the FEC entry.
    - `merkle_root`: A pointer to the `fd_hash_t` structure representing the Merkle root of the FEC entry to be inserted.
- **Logic and Control Flow**:
    - Checks if the Merkle root is already present in the store using [`fd_store_query_const`](<fd_store.h.md#fd_store_query_const>); if present, logs a warning and returns `NULL`.
    - Acquires a new FEC entry from the store's pool using `fd_store_pool_acquire`; if the pool is empty or corrupt, logs an appropriate message and returns `NULL`.
    - Initializes the new FEC entry with the provided Merkle root and partition index, and sets other fields to default values.
    - If the store's root is `null`, sets the new FEC entry as the root.
    - Inserts the new FEC entry into the store's map using `fd_store_map_ele_insert`.
- **Output**: Returns a pointer to the newly inserted `fd_store_fec_t` structure, or `NULL` if the insertion fails.
- **Functions Called**:
    - [`fd_store_query_const`](<fd_store.h.md#fd_store_query_const>)
    - [`fd_store_pool_t::fd_store_pool`](<fd_store.h.md#fd_store_pool_tfd_store_pool>)


---
### fd\_store\_link<!-- {{#callable:fd_store_link}} -->
[View Source →](<../../../../../src/disco/store/fd_store.c#L177>)

Links a child node to a parent node in a store based on Merkle roots.
- **Inputs**:
    - `store`: A pointer to the `fd_store_t` structure representing the store.
    - `merkle_root`: A pointer to the `fd_hash_t` structure representing the Merkle root of the child node.
    - `chained_merkle_root`: A pointer to the `fd_hash_t` structure representing the Merkle root of the parent node.
- **Logic and Control Flow**:
    - If `FD_STORE_USE_HANDHOLDING` is defined, check if both `merkle_root` and `chained_merkle_root` exist in the store; log a warning and return `NULL` if either is missing.
    - Retrieve the pool from the store using [`fd_store_pool`](<fd_store.h.md#fd_store_pool_tfd_store_pool>).
    - Query the store for the parent node using `chained_merkle_root` and for the child node using `merkle_root`.
    - If the child node already has a parent, return the child node as it is already linked.
    - Set the parent of the child node to the index of the parent node in the pool.
    - If the parent node has no child, set the child node as the left child of the parent.
    - If the parent node already has a child, traverse the siblings of the parent's child until the last sibling is found, then set the child node as the right sibling of the last sibling.
    - Return the child node.
- **Output**: Returns a pointer to the `fd_store_fec_t` structure representing the child node.
- **Functions Called**:
    - [`fd_store_query_const`](<fd_store.h.md#fd_store_query_const>)
    - [`fd_store_pool_t::fd_store_pool`](<fd_store.h.md#fd_store_pool_tfd_store_pool>)


---
### fd\_store\_publish<!-- {{#callable:fd_store_publish}} -->
[View Source →](<../../../../../src/disco/store/fd_store.c#L201>)

Replaces the current root of a store with a new root identified by a given Merkle root, while pruning the tree to remove ancestors and descendants of the old root.
- **Inputs**:
    - ``store``: A pointer to the `fd_store_t` structure representing the store.
    - ``merkle_root``: A constant pointer to the `fd_hash_t` structure representing the Merkle root of the new root node.
- **Logic and Control Flow**:
    - If `FD_STORE_USE_HANDHOLDING` is defined, checks if the `merkle_root` exists in the store; logs a warning and returns `NULL` if not found.
    - Retrieves the map, pool, and current root (`oldr`) from the store, and queries the new root (`newr`) using the `merkle_root`.
    - Removes the current root from the map and initializes a BFS queue with it.
    - Performs a BFS traversal to prune the tree, removing nodes that are ancestors of the old root and their descendants, except for the new root.
    - Releases each node from the pool after processing, logging a warning and returning `NULL` if releasing fails.
    - Unlinks the new root from its parent and sets it as the new root of the store.
- **Output**: Returns a pointer to the `fd_store_fec_t` structure representing the new root, or `NULL` if an error occurs.
- **Functions Called**:
    - [`fd_store_pool_t::fd_store_pool`](<fd_store.h.md#fd_store_pool_tfd_store_pool>)


---
### fd\_store\_clear<!-- {{#callable:fd_store_clear}} -->
[View Source →](<../../../../../src/disco/store/fd_store.c#L248>)

Clears all elements from the store and resets its root.
- **Inputs**:
    - `store`: A pointer to the `fd_store_t` structure representing the store to clear.
- **Logic and Control Flow**:
    - Check if the store is empty using `fd_store_root`; if so, log a warning and return `NULL`.
    - Retrieve the map, pool, and fec0 from the store using `fd_store_map`, [`fd_store_pool`](<fd_store.h.md#fd_store_pool_tfd_store_pool>), and `fd_store_fec0`.
    - Initialize `head` and `tail` to the root of the store.
    - Iterate over the map using `fd_store_map_iter_init`, `fd_store_map_iter_done`, and `fd_store_map_iter_next`.
    - For each element, check if its index matches the head's index; if not, set `tail->sibling` to the current index and update `tail`.
    - Set `tail->sibling` to `null` to terminate the list.
    - Iterate over the pool starting from the head, using `fd_store_pool_idx` and `fd_store_pool_ele`.
    - For each element, remove it from the map using `fd_store_map_idx_remove` and release it from the pool using `fd_store_pool_release`.
    - Set the store's root to `null`.
- **Output**: Returns a pointer to the cleared `fd_store_t` structure, or `NULL` if the store was empty.
- **Functions Called**:
    - [`fd_store_pool_t::fd_store_pool`](<fd_store.h.md#fd_store_pool_tfd_store_pool>)


---
### fd\_store\_verify<!-- {{#callable:fd_store_verify}} -->
[View Source →](<../../../../../src/disco/store/fd_store.c#L282>)

Verifies the integrity and correctness of the partitions and elements in a store.
- **Inputs**:
    - ``store``: A pointer to an `fd_store_t` structure representing the store to verify.
- **Logic and Control Flow**:
    - Retrieve the map and fec0 from the store using `fd_store_map` and `fd_store_fec0` functions.
    - Calculate `part_sz` as the division of `store->fec_max` by `store->part_cnt`.
    - Check if `part_sz` is equal to `map->seed`; if not, log a warning and return -1.
    - Iterate over the map using `fd_store_map_iter_init`, `fd_store_map_iter_done`, and `fd_store_map_iter_next`.
    - For each element, check if it is NULL; if so, log a warning and return -1.
    - Calculate `chain_idx` using `fd_store_map_private_chain_idx` and verify it is within the correct partition range; if not, log a warning and return -1.
    - Retrieve the pool from the store using [`fd_store_pool`](<fd_store.h.md#fd_store_pool_tfd_store_pool>).
    - Verify the pool using `fd_store_pool_verify`; if it returns -1, return -1.
    - Return the result of `fd_store_map_verify` with the map, `store->fec_max`, and fec0 as arguments.
- **Output**: Returns 0 if the store is verified successfully, or -1 if any verification step fails.
- **Functions Called**:
    - [`fd_store_pool_t::fd_store_pool`](<fd_store.h.md#fd_store_pool_tfd_store_pool>)


---
### print<!-- {{#callable:print}} -->
[View Source →](<../../../../../src/disco/store/fd_store.c#L316>)

Prints a hierarchical representation of a `fd_store_fec_t` structure starting from a given node.
- **Inputs**:
    - `store`: A pointer to a constant `fd_store_t` structure, representing the store containing the FEC elements.
    - `fec`: A pointer to a constant `fd_store_fec_t` structure, representing the current node in the hierarchy to print.
    - `space`: An integer representing the number of spaces to indent the current line.
    - `prefix`: A string representing the prefix to print before the current node's key.
- **Logic and Control Flow**:
    - If `fec` is `NULL`, return immediately without printing.
    - If `space` is greater than 0, print a newline character.
    - Print `space` number of spaces for indentation.
    - Print the `prefix` followed by the Base58 encoded Merkle root of the current `fec` node.
    - Initialize a `fd_store_pool_t` from the `store` to access pool elements.
    - Get the first child of the current `fec` node using `fd_store_pool_ele_const`.
    - Iterate over each child node of the current `fec` node.
    - If the current child has a sibling, set `new_prefix` to indicate more siblings follow and recursively call `print` with increased `space` and `new_prefix`.
    - If the current child does not have a sibling, set `new_prefix` to indicate the end of the branch and recursively call `print` with increased `space` and `new_prefix`.
    - Continue iterating over siblings until no more siblings are found.
- **Output**: No return value; the function outputs directly to the standard output.
- **Functions Called**:
    - [`fd_store_pool_t::fd_store_pool`](<fd_store.h.md#fd_store_pool_tfd_store_pool>)


---
### fd\_store\_print<!-- {{#callable:fd_store_print}} -->
[View Source →](<../../../../../src/disco/store/fd_store.c#L339>)

Prints the structure of a `fd_store_t` object starting from its root.
- **Inputs**:
    - `store`: A pointer to a constant `fd_store_t` object representing the store to print.
- **Logic and Control Flow**:
    - Logs a notice indicating the start of the store print operation.
    - Calls the [`print`](<#print>) function with the store, its root, an initial indentation level of 0, and an empty prefix to recursively print the store's structure.
    - Prints two newlines after the store structure is printed.
- **Output**: No return value; the function outputs the store structure to the standard output.
- **Functions Called**:
    - [`print`](<#print>)
    - [`fd_store_root_const`](<fd_store.h.md#fd_store_root_const>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)