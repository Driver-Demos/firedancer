<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a deduplication service for input streams, managing context and metrics, and ensuring secure processing.

# Purpose
The code is a C module that implements a deduplication service for processing multiple streams of input fragments. It is designed to handle input from various sources, such as gossip, verification, and executed transactions, and present them to consumers as if they were generated by a single producer. The module defines several context structures, such as `fd_dedup_ctx_t` and `fd_dedup_in_ctx_t`, which store the state and configuration necessary for deduplication operations. These structures manage memory workspaces, transaction caches, and metrics for tracking deduplication performance.

The module includes functions for initializing the deduplication context, processing incoming fragments, and checking for duplicate transactions. The [`during_frag`](<#during_frag>) and [`after_frag`](<#after_frag>) functions are key components that handle fragment processing and deduplication logic. The module also defines security measures to prevent unauthorized access and ensure data integrity. Additionally, it includes functions for setting up security policies and managing file descriptors. The deduplication service is integrated into a larger system through the `fd_tile_dedup` structure, which specifies initialization and execution routines for the deduplication tile.
# Imports and Dependencies

---
- `../fd_txn_m.h`
- `generated/fd_dedup_tile_seccomp.h`
- `../topo/fd_topo.h`
- `../metrics/fd_metrics.h`
- `linux/unistd.h`
- `../stem/fd_stem.c`


# Global Variables

---
### fd\_tile\_dedup
- **Type**: ``fd_topo_run_tile_t``
- **Description**: Represents a configuration for a deduplication tile in a topology. It includes function pointers for initialization, security policy population, and execution.
- **Use**: Used to configure and manage the deduplication process for input streams in a network topology.


# Data Structures

---
### fd\_dedup\_in\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``mem``: Pointer to a workspace (`fd_wksp_t`) associated with the input context.
    - ``chunk0``: Initial chunk index for the input context.
    - ``wmark``: Watermark indicating the upper limit of valid chunks for the input context.
    - ``mtu``: Maximum transmission unit size for the input context.
- **Description**: `fd_dedup_in_ctx_t` is a structure that represents the context for each producer memory cache (mcache) connected to a deduplication tile. It contains information about the workspace, chunk indices, and transmission limits for managing input data streams in a deduplication process.


---
### fd\_dedup\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - `tcache_depth`: Depth of the deduplication's transaction cache.
    - `tcache_map_cnt`: Number of slots to use for the transaction cache map.
    - `tcache_sync`: Pointer to the local join to the oldest key in the transaction cache.
    - `tcache_ring`: Pointer to the transaction cache ring.
    - `tcache_map`: Pointer to the transaction cache map.
    - `in_kind`: Array indicating the kind of input for each producer.
    - `in`: Array of input contexts for each producer.
    - `bundle_failed`: Flag indicating if the current bundle has failed.
    - `bundle_id`: Identifier for the current bundle.
    - `bundle_idx`: Index of the current bundle.
    - `bundle_signatures`: Array storing signatures for the current bundle.
    - `out_mem`: Pointer to the output memory workspace.
    - `out_chunk0`: Initial chunk index for output.
    - `out_wmark`: Watermark for output chunks.
    - `out_chunk`: Current chunk index for output.
    - `hashmap_seed`: Seed for the hash map used in deduplication.
    - `metrics`: Structure containing metrics for deduplication operations.
- **Description**: Contains all state needed to progress the deduplication tile, including transaction cache parameters, input contexts, bundle management, output memory management, and deduplication metrics.


# Functions

---
### scratch\_align<!-- {{#callable:scratch_align}} -->
[View Source →](<../../../../../src/disco/dedup/fd_dedup_tile.c#L60>)

Returns the alignment requirement of the `fd_dedup_ctx_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls the `alignof` operator on the `fd_dedup_ctx_t` type to determine its alignment requirement.
    - Returns the result of the `alignof` operator.
- **Output**: The alignment requirement of the `fd_dedup_ctx_t` structure as an `ulong`.


---
### scratch\_footprint<!-- {{#callable:scratch_footprint}} -->
[View Source →](<../../../../../src/disco/dedup/fd_dedup_tile.c#L65>)

Calculates the memory footprint required for a scratch space based on the deduplication context and tile configuration.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure that contains the deduplication tile configuration.
- **Logic and Control Flow**:
    - Initialize `l` with `FD_LAYOUT_INIT` to start the layout calculation.
    - Append the size and alignment of `fd_dedup_ctx_t` to `l` using `FD_LAYOUT_APPEND`.
    - Append the footprint of the tcache, calculated with `fd_tcache_footprint`, to `l` using `FD_LAYOUT_APPEND`.
    - Finalize the layout with `FD_LAYOUT_FINI`, using the alignment from [`scratch_align`](<#scratch_align>), and return the result.
- **Output**: Returns an `ulong` representing the total memory footprint required for the scratch space.
- **Functions Called**:
    - [`scratch_align`](<#scratch_align>)


---
### metrics\_write<!-- {{#callable:metrics_write}} -->
[View Source →](<../../../../../src/disco/dedup/fd_dedup_tile.c#L73>)

Updates the deduplication metrics for transaction bundle peer failures and deduplication failures.
- **Inputs**:
    - `ctx`: A pointer to a `fd_dedup_ctx_t` structure that contains the deduplication context and metrics to update.
- **Logic and Control Flow**:
    - Set the `TRANSACTION_BUNDLE_PEER_FAILURE` metric using the `bundle_peer_failure_cnt` from the `ctx` structure.
    - Set the `TRANSACTION_DEDUP_FAILURE` metric using the `dedup_fail_cnt` from the `ctx` structure.
- **Output**: No return value; the function updates metrics in the provided context.


---
### during\_frag<!-- {{#callable:during_frag}} -->
[View Source →](<../../../../../src/disco/dedup/fd_dedup_tile.c#L98>)

Processes incoming data fragments by checking bounds, copying data, and handling deduplication based on the type of input.
- **Inputs**:
    - `ctx`: A pointer to the `fd_dedup_ctx_t` context structure containing state information for deduplication.
    - `in_idx`: An index indicating which input stream is being processed.
    - `seq`: A sequence number for the fragment, marked as unused.
    - `sig`: A signature for the fragment, marked as unused.
    - `chunk`: The chunk identifier for the data fragment.
    - `sz`: The size of the data fragment.
    - `ctl`: A control parameter, marked as unused.
- **Logic and Control Flow**:
    - Check if the `chunk` is within the valid range and if `sz` does not exceed the maximum transmission unit (MTU); log an error if not.
    - Convert the `chunk` to a local address for both input and output memory.
    - If the input kind is `IN_KIND_GOSSIP`, check if `sz` exceeds `FD_TPU_RAW_MTU` and log an error if it does; copy the data from source to destination and verify the payload size.
    - If the input kind is `IN_KIND_EXECUTED_TXN`, check if `sz` equals `FD_TXN_SIGNATURE_SZ` and log an error if it does not; compute a hash for deduplication and insert it into the transaction cache.
    - For other input kinds, simply copy the data from source to destination.
- **Output**: No return value; the function performs operations on the provided context and logs errors if conditions are not met.


---
### after\_frag<!-- {{#callable:after_frag}} -->
[View Source →](<../../../../../src/disco/dedup/fd_dedup_tile.c#L141>)

Processes a transaction fragment to check for duplicates and handle bundle-specific logic.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_dedup_ctx_t` structure, which contains the state needed to process the transaction.
    - ``in_idx``: An index indicating the input source of the transaction.
    - ``seq``: A sequence number for the transaction, not used in this function.
    - ``sig``: A signature for the transaction, not used in this function.
    - ``sz``: The size of the transaction, not used in this function.
    - ``tsorig``: The original timestamp of the transaction.
    - ``_tspub``: A timestamp for publication, not used in this function.
    - ``stem``: A pointer to the `fd_stem_context_t` structure, used for publishing the transaction.
- **Logic and Control Flow**:
    - If the transaction is of type `IN_KIND_EXECUTED_TXN`, return immediately.
    - Retrieve the transaction metadata from the output memory using `fd_chunk_to_laddr`.
    - If the transaction belongs to a new bundle, reset the bundle state in `ctx`.
    - If the bundle has previously failed, increment the `bundle_peer_failure_cnt` metric and return.
    - If the transaction is of type `IN_KIND_GOSSIP`, parse the transaction and update the `txn_t_sz` field.
    - Compute a hash for deduplication if the transaction is not part of a bundle.
    - Check for duplicate transactions within the bundle if applicable.
    - If a duplicate is found, update the `bundle_failed` flag and increment the `dedup_fail_cnt` metric.
    - If no duplicate is found, calculate the realized size, publish the transaction, and update the output chunk.
- **Output**: No direct output; modifies the `ctx` structure and may publish a transaction using `fd_stem_publish`.


---
### privileged\_init<!-- {{#callable:privileged_init}} -->
[View Source →](<../../../../../src/disco/dedup/fd_dedup_tile.c#L219>)

Initializes a deduplication context with secure randomization for a given topology and tile.
- **Inputs**:
    - `topo`: A pointer to an `fd_topo_t` structure representing the topology.
    - `tile`: A pointer to an `fd_topo_tile_t` structure representing the tile to initialize.
- **Logic and Control Flow**:
    - Retrieve the local address of the object associated with the tile's object ID using `fd_topo_obj_laddr` and store it in `scratch`.
    - Initialize a scratch allocation context `l` with `FD_SCRATCH_ALLOC_INIT` using `scratch`.
    - Allocate memory for a `fd_dedup_ctx_t` structure within the scratch space using `FD_SCRATCH_ALLOC_APPEND`.
    - Generate a secure random seed for the `hashmap_seed` field of the `fd_dedup_ctx_t` structure using `fd_rng_secure`.
- **Output**: No return value; the function initializes the deduplication context in the provided tile.


---
### unprivileged\_init<!-- {{#callable:unprivileged_init}} -->
[View Source →](<../../../../../src/disco/dedup/fd_dedup_tile.c#L229>)

Initializes the unprivileged context for a deduplication tile by setting up memory allocations, caches, and input/output configurations.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure representing the topology configuration.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure representing the tile configuration.
- **Logic and Control Flow**:
    - Allocate scratch memory using `fd_topo_obj_laddr` to get the local address of the tile object.
    - Initialize the scratch allocator with `FD_SCRATCH_ALLOC_INIT`.
    - Allocate and append a `fd_dedup_ctx_t` context structure to the scratch memory.
    - Create a new transaction cache (`tcache`) using `fd_tcache_new` and join it with `fd_tcache_join`.
    - Check if `tcache` creation failed and log an error if it did.
    - Initialize the `ctx` structure fields such as `bundle_failed`, `bundle_id`, `bundle_idx`, and `metrics`.
    - Set up `tcache` related fields in `ctx` using functions like `fd_tcache_depth`, `fd_tcache_map_cnt`, etc.
    - Verify that the number of input links does not exceed the maximum allowed by checking `tile->in_cnt`.
    - For each input link, configure the `ctx->in` array with memory, MTU, chunk, and watermark values.
    - Determine the kind of each input link (`IN_KIND_GOSSIP`, `IN_KIND_VERIFY`, etc.) based on the link name.
    - Configure the output memory and chunk settings in `ctx` using the first output link.
    - Finalize the scratch allocation with `FD_SCRATCH_ALLOC_FINI` and check for overflow errors.
- **Output**: No direct output; the function initializes the context and memory structures for further processing.
- **Functions Called**:
    - [`scratch_footprint`](<#scratch_footprint>)


---
### populate\_allowed\_seccomp<!-- {{#callable:populate_allowed_seccomp}} -->
[View Source →](<../../../../../src/disco/dedup/fd_dedup_tile.c#L284>)

Configures a seccomp filter policy for a deduplication tile and returns the instruction count.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, representing the topology configuration (unused in this function).
    - ``tile``: A pointer to a `fd_topo_tile_t` structure, representing the tile configuration (unused in this function).
    - ``out_cnt``: An unsigned long integer representing the count of output filters to populate.
    - ``out``: A pointer to a `struct sock_filter` array where the seccomp filter policy will be populated.
- **Logic and Control Flow**:
    - Ignore the `topo` and `tile` inputs as they are not used in this function.
    - Call [`populate_sock_filter_policy_fd_dedup_tile`](<generated/fd_dedup_tile_seccomp.h.md#populate_sock_filter_policy_fd_dedup_tile>) with `out_cnt`, `out`, and the file descriptor from `fd_log_private_logfile_fd()`.
    - Return the value of `sock_filter_policy_fd_dedup_tile_instr_cnt`.
- **Output**: Returns an unsigned long integer representing the number of instructions in the seccomp filter policy.
- **Functions Called**:
    - [`populate_sock_filter_policy_fd_dedup_tile`](<generated/fd_dedup_tile_seccomp.h.md#populate_sock_filter_policy_fd_dedup_tile>)


---
### populate\_allowed\_fds<!-- {{#callable:populate_allowed_fds}} -->
[View Source →](<../../../../../src/disco/dedup/fd_dedup_tile.c#L296>)

Populates an array with file descriptors for standard error and a log file, if available.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, which is not used in this function.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure, which is not used in this function.
    - ``out_fds_cnt``: The maximum number of file descriptors that can be stored in the `out_fds` array.
    - ``out_fds``: An array of integers where the function will store the allowed file descriptors.
- **Logic and Control Flow**:
    - Ignore the `topo` and `tile` parameters as they are not used in the function.
    - Check if `out_fds_cnt` is less than 2; if so, log an error and terminate the program.
    - Initialize `out_cnt` to 0 to keep track of the number of file descriptors added.
    - Add the file descriptor for standard error (`2`) to the `out_fds` array and increment `out_cnt`.
    - Check if the log file descriptor is valid (not `-1`); if valid, add it to the `out_fds` array and increment `out_cnt`.
- **Output**: Returns the number of file descriptors added to the `out_fds` array.



---
Made with ❤️ by [Driver](https://www.driver.ai/)