<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Unit tests for deduplication functionality using multiple tiles and synthetic traffic in a hosted AVX environment.

# Purpose
The code is a C program designed to test a deduplication system using multiple tiles for transmitting (TX), deduplicating (DEDUP), and receiving (RX) data. It is structured to run in a hosted environment with AVX capabilities. The program defines a configuration structure `test_cfg_t` to manage various parameters and memory allocations required for the test, such as command-and-control (CNC) memory, random number generators, flow control sequences, and caches for both transmission and reception.

The main function initializes the environment, sets up the workspace, and configures the tiles for TX, DEDUP, and RX operations. Each tile has a specific role: TX tiles generate and send test traffic, the DEDUP tile processes and deduplicates the traffic, and RX tiles receive and validate the traffic. The program uses AVX instructions for efficient data handling and includes diagnostic logging to monitor performance metrics like fragment processing rates. The test runs for a specified duration, after which it halts the tiles, cleans up resources, and exits. The code is designed to be executed on a system with multiple processing tiles, leveraging parallel execution to simulate a high-throughput data processing environment.
# Imports and Dependencies

---
- `../fd_disco.h`
- `math.h`


# Data Structures

---
### test\_cfg
- **Type**: ``struct``
- **Members**:
    - ``wksp``: Pointer to a workspace of type `fd_wksp_t`.
    - ``tx_cnt``: Number of transmitters.
    - ``tx_lazy``: Lazy parameter for transmitters.
    - ``tx_cnc_mem``: Pointer to memory for transmitter command-and-control.
    - ``tx_cnc_footprint``: Footprint size of transmitter command-and-control memory.
    - ``tx_rng_mem``: Pointer to memory for transmitter random number generator.
    - ``tx_rng_footprint``: Footprint size of transmitter random number generator memory.
    - ``tx_fseq_mem``: Pointer to memory for transmitter flow sequence.
    - ``tx_fseq_footprint``: Footprint size of transmitter flow sequence memory.
    - ``tx_mcache_mem``: Pointer to memory for transmitter metadata cache.
    - ``tx_mcache_footprint``: Footprint size of transmitter metadata cache memory.
    - ``tx_dcache_mem``: Pointer to memory for transmitter data cache.
    - ``tx_dcache_footprint``: Footprint size of transmitter data cache memory.
    - ``tx_fctl_mem``: Pointer to memory for transmitter flow control.
    - ``tx_fctl_footprint``: Footprint size of transmitter flow control memory.
    - ``dedup_cnc_mem``: Pointer to memory for deduplication command-and-control.
    - ``dedup_tcache_mem``: Pointer to memory for deduplication tag cache.
    - ``dedup_mcache_mem``: Pointer to memory for deduplication metadata cache.
    - ``dedup_scratch_mem``: Pointer to scratch memory for deduplication.
    - ``dedup_cr_max``: Maximum credit for deduplication.
    - ``dedup_lazy``: Lazy parameter for deduplication.
    - ``dedup_seed``: Seed for deduplication random number generator.
    - ``rx_cnt``: Number of receivers.
    - ``rx_lazy``: Lazy parameter for receivers.
    - ``rx_cnc_mem``: Pointer to memory for receiver command-and-control.
    - ``rx_cnc_footprint``: Footprint size of receiver command-and-control memory.
    - ``rx_rng_mem``: Pointer to memory for receiver random number generator.
    - ``rx_rng_footprint``: Footprint size of receiver random number generator memory.
    - ``rx_fseq_mem``: Pointer to memory for receiver flow sequence.
    - ``rx_fseq_footprint``: Footprint size of receiver flow sequence memory.
    - ``rx_tcache_mem``: Pointer to memory for receiver tag cache.
    - ``rx_tcache_footprint``: Footprint size of receiver tag cache memory.
    - ``pkt_framing``: Packet framing size.
    - ``pkt_payload_max``: Maximum packet payload size.
    - ``burst_tau``: Time constant for burst traffic.
    - ``burst_avg``: Average burst size.
    - ``dup_thresh``: Threshold for duplicate detection.
    - ``dup_avg_age``: Average age for duplicates.
- **Description**: Defines a configuration structure for testing with fields for managing transmitters, receivers, and deduplication processes. It includes pointers to various memory regions for command-and-control, random number generation, flow sequences, metadata caches, and data caches. The structure also contains parameters for packet handling, burst traffic modeling, and duplicate detection.


---
### test\_cfg\_t
- **Type**: ``struct``
- **Members**:
    - ``wksp``: Pointer to a workspace of type `fd_wksp_t`.
    - ``tx_cnt``: Number of transmit (TX) tiles.
    - ``tx_lazy``: Lazy parameter for TX operations.
    - ``tx_cnc_mem``: Pointer to TX command-and-control memory.
    - ``tx_cnc_footprint``: Size of the TX command-and-control memory footprint.
    - ``tx_rng_mem``: Pointer to TX random number generator memory.
    - ``tx_rng_footprint``: Size of the TX random number generator memory footprint.
    - ``tx_fseq_mem``: Pointer to TX flow sequence memory.
    - ``tx_fseq_footprint``: Size of the TX flow sequence memory footprint.
    - ``tx_mcache_mem``: Pointer to TX memory cache.
    - ``tx_mcache_footprint``: Size of the TX memory cache footprint.
    - ``tx_dcache_mem``: Pointer to TX data cache.
    - ``tx_dcache_footprint``: Size of the TX data cache footprint.
    - ``tx_fctl_mem``: Pointer to TX flow control memory.
    - ``tx_fctl_footprint``: Size of the TX flow control memory footprint.
    - ``dedup_cnc_mem``: Pointer to deduplication command-and-control memory.
    - ``dedup_tcache_mem``: Pointer to deduplication transaction cache memory.
    - ``dedup_mcache_mem``: Pointer to deduplication memory cache.
    - ``dedup_scratch_mem``: Pointer to deduplication scratch memory.
    - ``dedup_cr_max``: Maximum deduplication credit.
    - ``dedup_lazy``: Lazy parameter for deduplication operations.
    - ``dedup_seed``: Seed for deduplication random number generation.
    - ``rx_cnt``: Number of receive (RX) tiles.
    - ``rx_lazy``: Lazy parameter for RX operations.
    - ``rx_cnc_mem``: Pointer to RX command-and-control memory.
    - ``rx_cnc_footprint``: Size of the RX command-and-control memory footprint.
    - ``rx_rng_mem``: Pointer to RX random number generator memory.
    - ``rx_rng_footprint``: Size of the RX random number generator memory footprint.
    - ``rx_fseq_mem``: Pointer to RX flow sequence memory.
    - ``rx_fseq_footprint``: Size of the RX flow sequence memory footprint.
    - ``rx_tcache_mem``: Pointer to RX transaction cache memory.
    - ``rx_tcache_footprint``: Size of the RX transaction cache memory footprint.
    - ``pkt_framing``: Packet framing size.
    - ``pkt_payload_max``: Maximum packet payload size.
    - ``burst_tau``: Burst time constant.
    - ``burst_avg``: Average burst size.
    - ``dup_thresh``: Duplicate threshold for packet processing.
    - ``dup_avg_age``: Average age of duplicates.
- **Description**: `test_cfg_t` is a configuration structure used to manage and configure various parameters and memory allocations for testing a system with multiple transmit (TX) and receive (RX) tiles, as well as deduplication processes. It includes pointers to memory regions for command-and-control, random number generation, flow sequences, memory caches, and data caches for both TX and RX operations. It also contains parameters for packet framing, payload size, burst characteristics, and deduplication settings, allowing for detailed control over the test environment.


# Functions

---
### tx\_tile\_main<!-- {{#callable:tx_tile_main}} -->
[View Source →](<../../../../../src/disco/dedup/test_dedup.c#L56>)

Executes a transmission tile that simulates network packet transmission with flow control, diagnostics, and synthetic load modeling.
- **Inputs**:
    - `argc`: The index of the transmission tile, cast to an unsigned long.
    - `argv`: A pointer to a `test_cfg_t` structure containing configuration parameters for the transmission tile.
- **Logic and Control Flow**:
    - Initialize variables and join various shared memory regions for command-and-control, memory cache, data cache, flow control, and random number generation.
    - Configure housekeeping parameters and synthetic load model based on the configuration settings.
    - Enter an infinite loop to simulate packet transmission, performing housekeeping tasks at a low rate in the background.
    - Check for backpressure and flow control credits to determine if packet transmission can proceed.
    - Simulate receiving and processing of network packets, including generating synthetic fragments and filling data regions with test patterns.
    - Publish the processed fragments to consumers and update sequence numbers and flow control credits.
    - Handle command-and-control signals to determine if the tile should continue running or halt.
    - Perform diagnostics and logging at regular intervals to monitor transmission performance.
    - Exit the loop and signal the command-and-control to boot state before returning.
- **Output**: Returns 0 upon successful execution.


---
### dedup\_tile\_main<!-- {{#callable:dedup_tile_main}} -->
[View Source →](<../../../../../src/disco/dedup/test_dedup.c#L263>)

Initializes and executes a deduplication tile operation using provided configuration and resources.
- **Inputs**:
    - `argc`: An integer representing the argument count, which is not used in this function.
    - `argv`: A pointer to an array of character strings, which is cast to a `test_cfg_t` structure containing configuration data for the deduplication process.
- **Logic and Control Flow**:
    - Cast `argv` to a `test_cfg_t` pointer to access configuration data.
    - Check if `tx_cnt` or `rx_cnt` exceeds 128 and log an error if so.
    - Join the deduplication command-and-control memory using `fd_cnc_join`.
    - Join each transmit memory cache and flow sequence using `fd_mcache_join` and `fd_fseq_join` respectively, for the number of transmitters specified in `tx_cnt`.
    - Join the deduplication transmit cache and memory cache using `fd_tcache_join` and `fd_mcache_join`.
    - Join each receive flow sequence using `fd_fseq_join` for the number of receivers specified in `rx_cnt`.
    - Initialize a random number generator with `fd_rng_new` and join it with `fd_rng_join`.
    - Call `fd_dedup_tile` with the joined resources and configuration parameters to perform the deduplication operation.
    - Log an error if `fd_dedup_tile` returns a non-zero error code.
    - Delete and leave the random number generator and all joined resources in reverse order of their joining.
    - Return 0 to indicate successful execution.
- **Output**: Returns 0 to indicate successful execution or logs an error if a failure occurs.


---
### rx\_tile\_main<!-- {{#callable:rx_tile_main}} -->
[View Source →](<../../../../../src/disco/dedup/test_dedup.c#L312>)

Processes received fragments from a deduplication tile, performs housekeeping, and handles command-and-control signals.
- **Inputs**:
    - `argc`: The index of the RX tile, cast to an unsigned long.
    - `argv`: A pointer to a `test_cfg_t` structure containing configuration data for the RX tile.
- **Logic and Control Flow**:
    - Initialize `rx_idx`, `cfg`, and `wksp` from `argc` and `argv`.
    - Join the RX command-and-control (CNC) memory using `fd_cnc_join` with the appropriate offset.
    - Join the deduplication mcache using `fd_mcache_join` and retrieve its depth and sequence address.
    - Join the deduplication flow control sequence using `fd_fseq_join`.
    - Join the random number generator using `fd_rng_join`.
    - Join the RX tcache using `fd_tcache_join` and retrieve its depth, map count, and synchronization addresses.
    - Initialize housekeeping variables `async_min` and `async_rem`.
    - Enter an infinite loop to process fragments and perform housekeeping.
    - Use `FD_MCACHE_WAIT_REG` to wait for a fragment sequence while performing housekeeping.
    - If `async_rem` is zero, update synchronization info, send flow control credits, send diagnostic info, check for command-and-control signals, and reload the housekeeping timer.
    - If there is a sequence overrun, log an error and exit.
    - Process the received fragment, checking for duplicates and logging errors if found.
    - Validate the fragment payload and log an error if corrupt.
    - Increment the sequence and iteration counters.
    - Signal the CNC to boot and return 0 upon completion.
- **Output**: Returns 0 upon successful completion.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/disco/dedup/test_dedup.c#L735>)

Initializes the environment, logs a warning if certain capabilities are missing, and halts execution.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with `argc` and `argv`.
    - Logs a warning message indicating that the unit test requires `FD_HAS_HOSTED` and `FD_HAS_AVX` capabilities.
    - Calls `fd_halt` to stop further execution.
    - Returns 0 to indicate successful termination.
- **Output**: Returns 0, indicating successful termination of the program.



---
Made with ❤️ by [Driver](https://www.driver.ai/)