<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a plugin tile for processing and managing data fragments in a network topology.

# Purpose
The code defines a plugin module for a system that processes data fragments in a network topology. It includes several components that manage the input and output data streams, handle different types of messages, and ensure data integrity. The module uses a context structure, `fd_plugin_ctx_t`, to maintain state information about the input and output data, including memory workspace pointers, chunk identifiers, and message sizes. The code defines several message types using constants, such as `IN_KIND_REPLAY` and `IN_KIND_GOSSIP`, which categorize the incoming data for processing.

The module provides functions to align and calculate the memory footprint for the plugin context, process data fragments during and after their reception, and initialize the plugin in an unprivileged mode. The [`during_frag`](<#during_frag>) and [`after_frag`](<#after_frag>) functions handle the processing of data fragments, checking message types and sizes, and copying data between memory locations. The [`unprivileged_init`](<#unprivileged_init>) function sets up the plugin's context by associating input links with their respective message types and configuring output memory parameters. The module also includes functions to populate security policies and allowed file descriptors, ensuring that the plugin operates within defined constraints. The `fd_tile_plugin` structure defines the plugin's interface, including its name, initialization, and execution functions, integrating it into the larger system.
# Imports and Dependencies

---
- `../tiles.h`
- `generated/fd_plugin_tile_seccomp.h`
- `../plugin/fd_plugin.h`
- `../stem/fd_stem.c`


# Global Variables

---
### fd\_tile\_plugin
- **Type**: ``fd_topo_run_tile_t``
- **Description**: Defines a structure of type `fd_topo_run_tile_t` named `fd_tile_plugin`. This structure is initialized with several function pointers and parameters that configure the behavior of a plugin tile in a topology.
- **Use**: Used to configure and manage the execution of a plugin tile within a topology, including initialization, security policies, and runtime operations.


# Data Structures

---
### fd\_plugin\_in\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``mem``: A pointer to an `fd_wksp_t` structure, representing a memory workspace.
    - ``chunk0``: An unsigned long integer representing the starting chunk index.
    - ``wmark``: An unsigned long integer representing the watermark or upper limit of chunks.
    - ``mtu``: An unsigned long integer representing the maximum transmission unit size.
- **Description**: Represents a context for plugin input operations, containing memory workspace information and parameters for chunk management such as starting index, watermark, and maximum transmission unit size.


---
### fd\_plugin\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``in_kind``: An array of integers representing the type of input for each context.
    - ``in``: An array of `fd_plugin_in_ctx_t` structures representing input contexts.
    - ``out_mem``: A pointer to `fd_wksp_t` representing the output memory workspace.
    - ``out_chunk0``: An unsigned long representing the initial chunk index for output.
    - ``out_wmark``: An unsigned long representing the watermark for output chunks.
    - ``out_chunk``: An unsigned long representing the current output chunk index.
    - ``sz``: An unsigned long representing the size of the payload computed during fragment processing.
- **Description**: `fd_plugin_ctx_t` is a structure that manages input and output contexts for a plugin, including arrays for input types and contexts, pointers and indices for output memory management, and a size field for payload handling during fragment processing.


# Functions

---
### scratch\_align<!-- {{#callable:scratch_align}} -->
[View Source →](<../../../../../src/disco/plugin/fd_plugin_tile.c#L36>)

Returns a constant alignment value of 128.
- **Inputs**: None
- **Logic and Control Flow**:
    - The function does not take any input parameters.
    - It directly returns the constant value `128UL`.
- **Output**: A constant unsigned long integer value of 128.


---
### scratch\_footprint<!-- {{#callable:scratch_footprint}} -->
[View Source →](<../../../../../src/disco/plugin/fd_plugin_tile.c#L41>)

Calculates the memory footprint required for a `fd_plugin_ctx_t` structure with alignment considerations.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure, which is not used in the function.
- **Logic and Control Flow**:
    - Initialize a variable `l` with `FD_LAYOUT_INIT`.
    - Append the size and alignment of `fd_plugin_ctx_t` to `l` using `FD_LAYOUT_APPEND`.
    - Finalize the layout with `FD_LAYOUT_FINI`, using the alignment value from `scratch_align()`.
- **Output**: Returns an `ulong` representing the calculated memory footprint.
- **Functions Called**:
    - [`scratch_align`](<#scratch_align>)


---
### during\_frag<!-- {{#callable:during_frag}} -->
[View Source →](<../../../../../src/disco/plugin/fd_plugin_tile.c#L49>)

Processes a fragment by determining its size based on its type and signature, and then copies it to the output memory.
- **Inputs**:
    - `ctx`: A pointer to the `fd_plugin_ctx_t` structure that contains context information for the plugin.
    - `in_idx`: An index indicating which input context to use from the `ctx->in` array.
    - `seq`: An unused parameter in this function.
    - `sig`: A signature value that helps determine the type of message being processed.
    - `chunk`: The chunk index in the input memory from which data is read.
    - `sz`: The initial size of the data to be processed.
    - `ctl`: An unused parameter in this function.
- **Logic and Control Flow**:
    - Convert the input chunk index to a memory address for both source and destination using `fd_chunk_to_laddr`.
    - Set `ctx->sz` to the input size `sz`.
    - Check if the input kind is `IN_KIND_GOSSIP` and the signature is `FD_PLUGIN_MSG_GOSSIP_UPDATE`. If true, calculate the size based on the number of peers and set `ctx->sz`.
    - Check if the input kind is `IN_KIND_GOSSIP`, `IN_KIND_POH`, or `IN_KIND_VOTE` and the signature is `FD_PLUGIN_MSG_VOTE_ACCOUNT_UPDATE`. If true, calculate the size based on the number of peers and set `ctx->sz`.
    - Check if the input kind is `IN_KIND_STAKE`. If true, calculate the size based on the number of staked leaders and set `ctx->sz`.
    - Verify that the chunk is within the valid range and that the size does not exceed the maximum transmission unit (MTU). If not, log an error.
    - Copy the data from the source to the destination using `fd_memcpy` with the calculated size `ctx->sz`.
- **Output**: No return value; the function modifies the `ctx` structure and copies data to the output memory.


---
### after\_frag<!-- {{#callable:after_frag}} -->
[View Source →](<../../../../../src/disco/plugin/fd_plugin_tile.c#L82>)

Processes a fragment based on its input kind and signature, then publishes it using the stem context.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_plugin_ctx_t` structure, which contains context information for the plugin.
    - ``in_idx``: An unsigned long integer representing the index of the input kind in the `ctx->in_kind` array.
    - ``seq``: An unsigned long integer representing the sequence number of the fragment (unused in this function).
    - ``sig``: An unsigned long integer representing the signature of the fragment, which is used to determine the type of message.
    - ``sz``: An unsigned long integer representing the size of the fragment (unused in this function).
    - ``tsorig``: An unsigned long integer representing the original timestamp of the fragment (unused in this function).
    - ``tspub``: An unsigned long integer representing the publication timestamp of the fragment (unused in this function).
    - ``stem``: A pointer to the `fd_stem_context_t` structure, which is used to publish the fragment.
- **Logic and Control Flow**:
    - Ignores the `sz`, `seq`, `tsorig`, and `tspub` parameters as they are not used in the function.
    - Uses a switch statement to handle different input kinds based on `ctx->in_kind[in_idx]`.
    - For each case, checks if the `sig` matches expected values using `FD_TEST` macros, except for `IN_KIND_STAKE`, where it sets `sig` to `FD_PLUGIN_MSG_LEADER_SCHEDULE`.
    - Logs an error if `in_idx` does not match any known input kind.
    - Calls `fd_stem_publish` to publish the fragment with the updated `sig`.
    - Updates `ctx->out_chunk` using `fd_dcache_compact_next` to prepare for the next fragment.
- **Output**: No return value; the function operates through side effects on the `ctx` and `stem` structures.


---
### unprivileged\_init<!-- {{#callable:unprivileged_init}} -->
[View Source →](<../../../../../src/disco/plugin/fd_plugin_tile.c#L140>)

Initializes the unprivileged context for a tile by setting up input and output memory contexts and validating link configurations.
- **Inputs**:
    - `topo`: A pointer to an `fd_topo_t` structure representing the topology configuration.
    - `tile`: A pointer to an `fd_topo_tile_t` structure representing the tile configuration.
- **Logic and Control Flow**:
    - Allocate scratch memory for the plugin context using `FD_SCRATCH_ALLOC_INIT` and `FD_SCRATCH_ALLOC_APPEND`.
    - Validate that the number of input links does not exceed the maximum allowed by the context.
    - Iterate over each input link, retrieve the corresponding link and workspace, and set up the input memory context (`mem`, `chunk0`, `wmark`, `mtu`).
    - Validate that each link's MTU does not exceed the MTU of the first output link.
    - Determine the kind of each input link based on its name and assign the corresponding kind constant to `ctx->in_kind[i]`.
    - Set up the output memory context using the first output link's workspace and cache settings.
    - Finalize the scratch memory allocation with `FD_SCRATCH_ALLOC_FINI` and check for overflow errors.
- **Output**: No direct output; modifies the `fd_plugin_ctx_t` structure pointed to by the scratch memory.
- **Functions Called**:
    - [`scratch_footprint`](<#scratch_footprint>)


---
### populate\_allowed\_seccomp<!-- {{#callable:populate_allowed_seccomp}} -->
[View Source →](<../../../../../src/disco/plugin/fd_plugin_tile.c#L183>)

Populates a `sock_filter` array with a security policy for a plugin tile and returns the instruction count.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, which is not used in this function.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure, which is not used in this function.
    - ``out_cnt``: An unsigned long integer representing the number of elements in the `out` array.
    - ``out``: A pointer to an array of `sock_filter` structures where the security policy will be populated.
- **Logic and Control Flow**:
    - The function ignores the `topo` and `tile` inputs by casting them to void.
    - Calls [`populate_sock_filter_policy_fd_plugin_tile`](<generated/fd_plugin_tile_seccomp.h.md#populate_sock_filter_policy_fd_plugin_tile>) with `out_cnt`, `out`, and the file descriptor from `fd_log_private_logfile_fd()`.
    - Returns the value of `sock_filter_policy_fd_plugin_tile_instr_cnt`.
- **Output**: Returns an unsigned long integer representing the number of instructions in the populated security policy.
- **Functions Called**:
    - [`populate_sock_filter_policy_fd_plugin_tile`](<generated/fd_plugin_tile_seccomp.h.md#populate_sock_filter_policy_fd_plugin_tile>)


---
### populate\_allowed\_fds<!-- {{#callable:populate_allowed_fds}} -->
[View Source →](<../../../../../src/disco/plugin/fd_plugin_tile.c#L195>)

Populates an array with file descriptors for `stderr` and a log file, if available.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, which is not used in this function.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure, which is not used in this function.
    - ``out_fds_cnt``: The maximum number of file descriptors that can be stored in the `out_fds` array.
    - ``out_fds``: An array of integers where the function will store the allowed file descriptors.
- **Logic and Control Flow**:
    - Check if `out_fds_cnt` is less than 2; if so, log an error and terminate.
    - Initialize `out_cnt` to 0.
    - Add the file descriptor for `stderr` (2) to the `out_fds` array and increment `out_cnt`.
    - Check if the log file descriptor is valid (not -1); if valid, add it to the `out_fds` array and increment `out_cnt`.
- **Output**: Returns the number of file descriptors added to the `out_fds` array.



---
Made with ❤️ by [Driver](https://www.driver.ai/)