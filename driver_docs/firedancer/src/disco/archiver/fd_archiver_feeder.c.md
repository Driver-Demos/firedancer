<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements an archiver feeder tile system for capturing and forwarding data fragments to a writer tile.

# Purpose
The code defines a component of a data archiving system, specifically focusing on the "archiver feeder" functionality. This component is responsible for forwarding data fragments from multiple input links to a single output link, which is managed by an "archiver writer" tile. The code allows for flexible data capture topologies, such as round-robin or one-to-one configurations, by managing multiple feeder tiles that can handle up to 32 input links. The main structure, `fd_archiver_feeder_tile_ctx_t`, holds context information for both input and output data streams, including memory workspace pointers, chunk indices, and watermark values.

The code includes several functions to initialize and manage the feeder tile's operation. The [`unprivileged_init`](<#unprivileged_init>) function sets up the feeder tile's context, allocating memory and initializing input and output link parameters. The [`during_frag`](<#during_frag>) and [`after_frag`](<#after_frag>) functions handle the processing of data fragments, including copying data from input to output and publishing messages to a queue. The code also defines security policies and file descriptor management through [`populate_allowed_seccomp`](<#populate_allowed_seccomp>) and [`populate_allowed_fds`](<#populate_allowed_fds>) functions. The `fd_topo_run_tile_t` structure at the end of the file encapsulates the feeder tile's configuration and operational functions, making it ready to be integrated into a larger system.
# Imports and Dependencies

---
- `../tiles.h`
- `fd_archiver.h`
- `unistd.h`
- `linux/unistd.h`
- `sys/socket.h`
- `linux/if_xdp.h`
- `generated/archiver_feeder_seccomp.h`
- `../stem/fd_stem.c`


# Global Variables

---
### fd\_tile\_archiver\_feeder
- **Type**: ``fd_topo_run_tile_t``
- **Description**: Defines a tile configuration for an archiver feeder in a topology. It includes function pointers for security policy population, file descriptor population, memory alignment, memory footprint calculation, initialization, and execution.
- **Use**: Used to configure and manage the behavior of an archiver feeder tile in a data processing topology.


# Data Structures

---
### fd\_archiver\_feeder\_in\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``mem``: Pointer to a workspace (`fd_wksp_t`) used for memory management.
    - ``chunk0``: Initial chunk index for data processing.
    - ``wmark``: Watermark indicating the upper limit of valid data chunks.
- **Description**: `fd_archiver_feeder_in_ctx_t` is a structure that holds context information for an archiver feeder input. It includes a pointer to a memory workspace, an initial chunk index, and a watermark to manage data chunks within specified limits. This structure is used to facilitate the forwarding of data fragments from input links to an archiver writer tile.


---
### fd\_archiver\_feeder\_tile\_ctx
- **Type**: ``struct``
- **Members**:
    - ``out_mem``: Pointer to the output memory workspace.
    - ``out_chunk0``: Initial chunk index for output.
    - ``out_wmark``: Watermark for output chunks.
    - ``out_chunk``: Current chunk index for output.
    - ``count``: Counter for tracking operations or elements.
    - ``round_robin_idx``: Index for round-robin scheduling.
    - ``round_robin_cnt``: Count of elements for round-robin scheduling.
    - ``in``: Array of input contexts with a maximum size defined by `FD_ARCHIVER_FEEDER_MAX_INPUT_LINKS`.
- **Description**: Manages the context for an archiver feeder tile, which includes handling input and output memory workspaces, chunk indices, and round-robin scheduling for processing input links. It facilitates the forwarding of data fragments from multiple input links to a single archiver writer tile, supporting flexible topologies for data capture.


---
### fd\_archiver\_feeder\_tile\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - `out_mem`: Pointer to the workspace memory for output.
    - `out_chunk0`: Initial chunk index for output.
    - `out_wmark`: Watermark for output chunks.
    - `out_chunk`: Current chunk index for output.
    - `count`: Counter for processed fragments.
    - `round_robin_idx`: Index for round-robin processing.
    - `round_robin_cnt`: Count of round-robin participants.
    - `in`: Array of input contexts, each containing memory, initial chunk, and watermark.
- **Description**: Manages the context for an archiver feeder tile, which forwards data fragments from multiple input links to a single output link, supporting flexible topologies like round-robin or 1-1 configurations.


# Functions

---
### scratch\_align<!-- {{#callable:scratch_align}} -->
[View Source →](<../../../../../src/disco/archiver/fd_archiver_feeder.c#L42>)

Returns a constant alignment value of 4096 bytes.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the constant value `4096UL`.
- **Output**: A constant unsigned long integer value of 4096.


---
### populate\_allowed\_seccomp<!-- {{#callable:populate_allowed_seccomp}} -->
[View Source →](<../../../../../src/disco/archiver/fd_archiver_feeder.c#L47>)

Populates a seccomp filter policy for an archiver feeder tile and returns the instruction count.
- **Inputs**:
    - `topo`: A pointer to a `fd_topo_t` structure, representing the topology configuration. It is not used in this function.
    - `tile`: A pointer to a `fd_topo_tile_t` structure, representing the tile configuration. It is not used in this function.
    - `out_cnt`: An unsigned long integer representing the count of output filters to populate.
    - `out`: A pointer to a `struct sock_filter` array where the seccomp filter policy will be populated.
- **Logic and Control Flow**:
    - Ignore the `topo` and `tile` inputs as they are not used in the function.
    - Call the [`populate_sock_filter_policy_archiver_feeder`](<generated/archiver_feeder_seccomp.h.md#populate_sock_filter_policy_archiver_feeder>) function with `out_cnt`, `out`, and the file descriptor from `fd_log_private_logfile_fd()`.
    - Return the value of `sock_filter_policy_archiver_feeder_instr_cnt`.
- **Output**: Returns an unsigned long integer representing the number of instructions in the seccomp filter policy.
- **Functions Called**:
    - [`populate_sock_filter_policy_archiver_feeder`](<generated/archiver_feeder_seccomp.h.md#populate_sock_filter_policy_archiver_feeder>)


---
### populate\_allowed\_fds<!-- {{#callable:populate_allowed_fds}} -->
[View Source →](<../../../../../src/disco/archiver/fd_archiver_feeder.c#L59>)

Populates an array with file descriptors for `stderr` and a log file if available.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, not used in this function.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure, not used in this function.
    - ``out_fds_cnt``: An unsigned long integer representing the count of file descriptors, not used in this function.
    - ``out_fds``: A pointer to an integer array where the function will store the allowed file descriptors.
- **Logic and Control Flow**:
    - Initialize `out_cnt` to 0.
    - Assign the file descriptor for `stderr` (2) to `out_fds[out_cnt]` and increment `out_cnt`.
    - Check if `fd_log_private_logfile_fd()` does not return -1, indicating a valid log file descriptor.
    - If valid, assign the log file descriptor to `out_fds[out_cnt]` and increment `out_cnt`.
    - Return `out_cnt`, the number of file descriptors added to `out_fds`.
- **Output**: Returns the number of file descriptors added to the `out_fds` array as an unsigned long integer.


---
### scratch\_footprint<!-- {{#callable:scratch_footprint}} -->
[View Source →](<../../../../../src/disco/archiver/fd_archiver_feeder.c#L77>)

Calculates the memory footprint required for a scratch space aligned to a specific boundary for an archiver feeder tile context.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure, which is not used in the function.
- **Logic and Control Flow**:
    - Initialize a variable `l` with `FD_LAYOUT_INIT`.
    - Append the alignment and size of `fd_archiver_feeder_tile_ctx_t` to `l` using `FD_LAYOUT_APPEND`.
    - Finalize the layout with `FD_LAYOUT_FINI`, using the alignment value from `scratch_align()`.
- **Output**: Returns an `ulong` representing the calculated memory footprint for the scratch space.
- **Functions Called**:
    - [`scratch_align`](<#scratch_align>)


---
### unprivileged\_init<!-- {{#callable:unprivileged_init}} -->
[View Source →](<../../../../../src/disco/archiver/fd_archiver_feeder.c#L85>)

Initializes the context for an unprivileged archiver feeder tile by setting up memory allocations and configuring input and output links.
- **Inputs**:
    - `topo`: A pointer to an `fd_topo_t` structure representing the topology of the system.
    - `tile`: A pointer to an `fd_topo_tile_t` structure representing the specific tile to initialize.
- **Logic and Control Flow**:
    - Allocate scratch memory for the tile using `fd_topo_obj_laddr` to get the local address of the tile object.
    - Initialize the scratch memory allocator with `FD_SCRATCH_ALLOC_INIT`.
    - Allocate and zero-initialize a `fd_archiver_feeder_tile_ctx_t` context structure using `FD_SCRATCH_ALLOC_APPEND` and `memset`.
    - Set the `round_robin_cnt` and `round_robin_idx` fields of the context based on the tile's name count and kind ID.
    - Iterate over each input link of the tile, setting up memory, chunk, and watermark for each input using `fd_dcache_compact_chunk0` and `fd_dcache_compact_wmark`.
    - Configure the output memory, chunk, and watermark for the tile's output link using similar functions.
    - Finalize the scratch memory allocation with `FD_SCRATCH_ALLOC_FINI` and check for overflow using `FD_LOG_ERR` if the allocated memory exceeds the footprint.
- **Output**: No direct output; the function initializes the context for the tile in the provided topology.
- **Functions Called**:
    - [`scratch_align`](<#scratch_align>)
    - [`scratch_footprint`](<#scratch_footprint>)


---
### during\_frag<!-- {{#callable:during_frag}} -->
[View Source →](<../../../../../src/disco/archiver/fd_archiver_feeder.c#L119>)

Processes a fragment by validating its chunk range and copying it to the output memory with a header.
- **Inputs**:
    - `ctx`: Pointer to the `fd_archiver_feeder_tile_ctx_t` structure, which contains context information for the archiver feeder tile.
    - `in_idx`: Index of the input link in the `ctx->in` array.
    - `seq`: Sequence number of the fragment.
    - `sig`: Signature of the fragment.
    - `chunk`: Chunk index of the fragment in the input memory.
    - `sz`: Size of the fragment.
    - `ctl`: Control parameter, currently unused.
- **Logic and Control Flow**:
    - Check if `chunk` is within the valid range defined by `ctx->in[in_idx].chunk0` and `ctx->in[in_idx].wmark`; log an error if not.
    - Convert `chunk` to a local address `src` in the input memory and `ctx->out_chunk` to a local address `dst` in the output memory.
    - If `sz` is non-zero, write a header to `dst` with predefined magic and version numbers, tile ID derived from `sig`, and other fragment metadata.
    - Copy the fragment data from `src` to `dst` starting after the header.
- **Output**: No return value; the function modifies the output memory to include the fragment and its header.


---
### after\_frag<!-- {{#callable:after_frag}} -->
[View Source →](<../../../../../src/disco/archiver/fd_archiver_feeder.c#L151>)

Publishes a message to a queue and updates the output chunk pointer.
- **Inputs**:
    - `ctx`: A pointer to `fd_archiver_feeder_tile_ctx_t`, which contains context information for the archiver feeder tile.
    - `in_idx`: An unused parameter, intended to represent the input index.
    - `seq`: An unused parameter, intended to represent the sequence number.
    - `sig`: An unused parameter, intended to represent the signature.
    - `sz`: The size of the fragment to be published.
    - `tsorig`: The original timestamp of the fragment.
    - `tspub`: An unused parameter, intended to represent the publication timestamp.
    - `stem`: A pointer to `fd_stem_context_t`, which is used to publish the message.
- **Logic and Control Flow**:
    - Calculate `full_sz` by adding `sz` to `FD_ARCHIVER_FRAG_HEADER_FOOTPRINT`.
    - Call `fd_stem_publish` to publish the message with the calculated `full_sz` and `tsorig`.
    - Update `ctx->out_chunk` using `fd_dcache_compact_next` with the new `full_sz`.
- **Output**: No return value; the function operates by side effects on the `ctx` and `stem`.



---
Made with ❤️ by [Driver](https://www.driver.ai/)