<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements an archiver writer tile that timestamps and writes input fragments to an archive tile.

# Purpose
The code defines an archiver writer tile for a data processing system. This tile is responsible for consuming data fragments from multiple input links, adding timestamps to these fragments, and writing them to an archive. The purpose of adding timestamps is to ensure a global order across all packets. The code specifies that there should only be one instance of this archiver writer tile in the system.

The code includes several key components and functions. It defines data structures such as `fd_archiver_writer_tile_ctx_t` to manage the context of the archiver writer, including input buffers, output streams, and statistics. The [`privileged_init`](<#privileged_init>) and [`unprivileged_init`](<#unprivileged_init>) functions initialize the tile, setting up memory and file descriptors for the archive. The [`during_frag`](<#during_frag>) and [`after_frag`](<#after_frag>) functions handle the processing of each data fragment, updating timestamps, and writing the fragments to the output stream. The code also includes functions to manage security policies and file descriptors, ensuring that the tile operates within the expected constraints. The `fd_tile_archiver_writer` structure encapsulates the tile's configuration and operational functions, integrating it into the larger system.
# Imports and Dependencies

---
- `../tiles.h`
- `fd_archiver.h`
- `errno.h`
- `fcntl.h`
- `sys/mman.h`
- `sys/stat.h`
- `string.h`
- `unistd.h`
- `linux/unistd.h`
- `sys/socket.h`
- `linux/if_xdp.h`
- `generated/archiver_writer_seccomp.h`
- `../stem/fd_stem.c`


# Global Variables

---
### fd\_tile\_archiver\_writer
- **Type**: ``fd_topo_run_tile_t``
- **Description**: Defines a tile in the topology that acts as an archiver writer. It consumes data from input links, adds timestamps to fragments, and writes them to an archive tile.
- **Use**: Used to configure and manage the behavior of the archiver writer tile in the system.


# Data Structures

---
### fd\_archiver\_writer\_stats
- **Type**: ``struct``
- **Members**:
    - ``net_shred_in_cnt``: Counts the number of network shreds received.
    - ``net_repair_in_cnt``: Counts the number of network repairs received.
- **Description**: Tracks statistics for the archiver writer, specifically the counts of network shreds and repairs received.


---
### fd\_archiver\_writer\_stats\_t
- **Type**: ``struct``
- **Members**:
    - `net_shred_in_cnt`: Counts the number of incoming network shreds.
    - `net_repair_in_cnt`: Counts the number of incoming network repairs.
- **Description**: `fd_archiver_writer_stats_t` is a structure that holds statistics for an archiver writer, specifically tracking the count of network shreds and repairs processed by the writer.


---
### fd\_archiver\_writer\_in\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``mem``: Pointer to a `fd_wksp_t` structure, representing a memory workspace.
    - ``chunk0``: Unsigned long integer representing the starting chunk index.
    - ``wmark``: Unsigned long integer representing the watermark or upper limit for chunks.
- **Description**: The `fd_archiver_writer_in_ctx_t` structure is used to manage input context for an archiver writer, including memory workspace, starting chunk index, and watermark for chunk processing.


---
### fd\_archiver\_writer\_tile\_ctx
- **Type**: ``struct``
- **Members**:
    - ``out_buf``: Pointer to the output buffer.
    - ``in``: Array of input contexts for archiver writer, with a fixed size of 32.
    - ``stats``: Structure holding statistics for network shred and repair input counts.
    - ``now``: Current timestamp in nanoseconds.
    - ``last_packet_ns``: Timestamp of the last packet in nanoseconds.
    - ``tick_per_ns``: Conversion factor from ticks to nanoseconds.
    - ``archive_ostream``: Buffered output stream for writing to the archive.
    - ``frag_buf``: Buffer for storing fragments with a size defined by `FD_ARCHIVER_WRITER_FRAG_BUF_SZ`.
- **Description**: `fd_archiver_writer_tile_ctx` is a structure used in the archiver writer tile to manage input and output operations, maintain statistics, and handle timing for packet processing. It includes an output buffer, an array of input contexts, a statistics structure, and fields for managing timestamps and conversion factors. The structure also contains a buffered output stream for writing data to the archive and a buffer for storing packet fragments.


---
### fd\_archiver\_writer\_tile\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``out_buf``: Pointer to the output buffer used for writing data.
    - ``in``: Array of input contexts, each containing memory workspace, initial chunk, and watermark.
    - ``stats``: Structure holding statistics for network shred and repair input counts.
    - ``now``: Current timestamp in nanoseconds.
    - ``last_packet_ns``: Timestamp of the last processed packet in nanoseconds.
    - ``tick_per_ns``: Conversion factor from ticks to nanoseconds.
    - ``archive_ostream``: Buffered output stream for writing to the archive.
    - ``frag_buf``: Buffer for storing fragments before writing to the archive.
- **Description**: `fd_archiver_writer_tile_ctx_t` is a structure that manages the context for an archiver writer tile, which processes input data from multiple sources, timestamps each fragment, and writes them to an archive. It includes an output buffer, an array of input contexts, statistics for input counts, and a buffered output stream for efficient data writing. The structure also maintains timing information to ensure proper ordering of fragments.


# Functions

---
### scratch\_align<!-- {{#callable:scratch_align}} -->
[View Source →](<../../../../../src/disco/archiver/fd_archiver_writer.c#L56>)

Returns the alignment size for scratch memory allocation.
- **Inputs**: None
- **Logic and Control Flow**:
    - The function is defined as `static inline`, indicating it is intended for use within the same translation unit and suggests a preference for inlining by the compiler.
    - The function returns a constant value of `4096UL`, which represents the alignment size.
- **Output**: A constant unsigned long integer value `4096UL`, representing the alignment size.


---
### loose\_footprint<!-- {{#callable:loose_footprint}} -->
[View Source →](<../../../../../src/disco/archiver/fd_archiver_writer.c#L61>)

Calculates the memory footprint for a tile using a gigantic page size.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure, which is not used in the function.
- **Logic and Control Flow**:
    - The function takes a single argument `tile`, which is marked as unused with `FD_PARAM_UNUSED`.
    - It returns the product of `1UL` and `FD_SHMEM_GIGANTIC_PAGE_SZ`, which represents the memory footprint.
- **Output**: Returns an unsigned long integer representing the memory footprint size in terms of gigantic page size.


---
### populate\_allowed\_seccomp<!-- {{#callable:populate_allowed_seccomp}} -->
[View Source →](<../../../../../src/disco/archiver/fd_archiver_writer.c#L66>)

Populates a seccomp filter for the archiver writer tile and returns the instruction count.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, which is not used in this function.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure, which contains the `archiver.archive_fd` used in the function.
    - ``out_cnt``: An unsigned long integer representing the count of output filters.
    - ``out``: A pointer to a `struct sock_filter` where the seccomp filter will be populated.
- **Logic and Control Flow**:
    - Calls [`populate_sock_filter_policy_archiver_writer`](<generated/archiver_writer_seccomp.h.md#populate_sock_filter_policy_archiver_writer>) with `out_cnt`, `out`, the file descriptor from `fd_log_private_logfile_fd()`, and the `archive_fd` from the `tile` structure.
    - Returns the value of `sock_filter_policy_archiver_writer_instr_cnt`.
- **Output**: Returns an unsigned long integer representing the instruction count of the seccomp filter.
- **Functions Called**:
    - [`populate_sock_filter_policy_archiver_writer`](<generated/archiver_writer_seccomp.h.md#populate_sock_filter_policy_archiver_writer>)


---
### populate\_allowed\_fds<!-- {{#callable:populate_allowed_fds}} -->
[View Source →](<../../../../../src/disco/archiver/fd_archiver_writer.c#L78>)

Populates an array with file descriptors for standard error, a log file, and an archive file if they are available.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, which is not used in this function.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure, which contains the file descriptor for the archive file.
    - ``out_fds_cnt``: An unsigned long integer representing the count of file descriptors to output, which is not used in this function.
    - ``out_fds``: A pointer to an integer array where the function will store the allowed file descriptors.
- **Logic and Control Flow**:
    - Initialize `out_cnt` to 0.
    - Add the file descriptor for standard error (2) to `out_fds` and increment `out_cnt`.
    - Check if the log file descriptor is valid using `fd_log_private_logfile_fd()`. If valid, add it to `out_fds` and increment `out_cnt`.
    - Check if the archive file descriptor in `tile->archiver.archive_fd` is valid. If valid, add it to `out_fds` and increment `out_cnt`.
    - Return the count of file descriptors added to `out_fds`.
- **Output**: Returns the number of file descriptors added to the `out_fds` array as an unsigned long integer.


---
### scratch\_footprint<!-- {{#callable:scratch_footprint}} -->
[View Source →](<../../../../../src/disco/archiver/fd_archiver_writer.c#L97>)

Calculates the memory footprint required for the scratch space of an archiver writer tile.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure, which is not used in the function.
- **Logic and Control Flow**:
    - Initialize a variable `l` with `FD_LAYOUT_INIT`.
    - Append the size and alignment of `fd_archiver_writer_tile_ctx_t` to `l` using `FD_LAYOUT_APPEND`.
    - Append the size of `FD_ARCHIVER_WRITER_OUT_BUF_SZ` with an alignment of 4096 to `l` using `FD_LAYOUT_APPEND`.
    - Finalize the layout with `FD_LAYOUT_FINI` using `scratch_align()` and return the result.
- **Output**: Returns an `ulong` representing the calculated memory footprint.
- **Functions Called**:
    - [`scratch_align`](<#scratch_align>)


---
### privileged\_init<!-- {{#callable:privileged_init}} -->
[View Source →](<../../../../../src/disco/archiver/fd_archiver_writer.c#L106>)

Initializes resources and opens an archive file for a tile in a topology.
- **Inputs**:
    - ``topo``: A pointer to an `fd_topo_t` structure representing the topology.
    - ``tile``: A pointer to an `fd_topo_tile_t` structure representing the tile to initialize.
- **Logic and Control Flow**:
    - Obtain a scratch memory address using `fd_topo_obj_laddr` with `topo` and `tile->tile_obj_id`.
    - Initialize scratch memory allocation with `FD_SCRATCH_ALLOC_INIT`.
    - Allocate and zero-initialize a `fd_archiver_writer_tile_ctx_t` context structure using `FD_SCRATCH_ALLOC_APPEND` and `memset`.
    - Allocate an output buffer for the context using `FD_SCRATCH_ALLOC_APPEND`.
    - Finalize the scratch memory allocation with `FD_SCRATCH_ALLOC_FINI`.
    - Open or create an archive file specified by `tile->archiver.rocksdb_path` using `open` with flags `O_RDWR | O_CREAT | O_DIRECT` and permissions `0666`.
    - Log an error and exit if the file cannot be opened or created.
- **Output**: No return value; initializes resources and opens a file, updating `tile->archiver.archive_fd`.
- **Functions Called**:
    - [`scratch_align`](<#scratch_align>)


---
### unprivileged\_init<!-- {{#callable:unprivileged_init}} -->
[View Source →](<../../../../../src/disco/archiver/fd_archiver_writer.c#L123>)

Initializes the unprivileged components of an archiver writer tile, setting up memory, input links, and output streams.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure representing the topology of the system.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure representing the specific tile to initialize.
- **Logic and Control Flow**:
    - Allocate scratch memory for the tile using `fd_topo_obj_laddr` and `FD_SCRATCH_ALLOC_INIT`.
    - Allocate and initialize a `fd_archiver_writer_tile_ctx_t` context structure in the scratch memory.
    - Allocate an output buffer in the scratch memory for the context.
    - Finalize the scratch memory allocation with `FD_SCRATCH_ALLOC_FINI`.
    - Truncate the archive file associated with the tile to zero length using `ftruncate`.
    - Seek to the beginning of the archive file using `lseek`.
    - For each input link, retrieve the workspace and initialize the input context with memory, chunk0, and watermark values.
    - Initialize the output stream using `fd_io_buffered_ostream_init` with the archive file descriptor and output buffer.
    - Set the `tick_per_ns` field in the context using `fd_tempo_tick_per_ns`.
- **Output**: No return value; the function initializes the tile's context and prepares it for operation.
- **Functions Called**:
    - [`scratch_align`](<#scratch_align>)


---
### during\_housekeeping<!-- {{#callable:during_housekeeping}} -->
[View Source →](<../../../../../src/disco/archiver/fd_archiver_writer.c#L166>)

Updates the current time in nanoseconds for the archiver writer context.
- **Inputs**:
    - `ctx`: A pointer to a `fd_archiver_writer_tile_ctx_t` structure, which holds the context for the archiver writer tile.
- **Logic and Control Flow**:
    - Call the function `fd_tickcount()` to get the current tick count.
    - Divide the tick count by `ctx->tick_per_ns` to convert it to nanoseconds.
    - Cast the result to `ulong` and assign it to `ctx->now`.
- **Output**: The function does not return a value; it updates the `now` field in the `ctx` structure.


---
### during\_frag<!-- {{#callable:during_frag}} -->
[View Source →](<../../../../../src/disco/archiver/fd_archiver_writer.c#L171>)

Processes an incoming fragment by validating its range, updating its timestamp, and copying it to a buffer while updating statistics.
- **Inputs**:
    - `ctx`: A pointer to `fd_archiver_writer_tile_ctx_t`, which contains context information for the archiver writer tile.
    - `in_idx`: An index indicating which input context to use from the `ctx->in` array.
    - `seq`: An unused parameter, marked with `FD_PARAM_UNUSED`.
    - `sig`: An unused parameter, marked with `FD_PARAM_UNUSED`.
    - `chunk`: The chunk identifier for the fragment being processed.
    - `sz`: The size of the fragment being processed.
    - `ctl`: An unused parameter, marked with `FD_PARAM_UNUSED`.
- **Logic and Control Flow**:
    - Checks if `chunk` is within the valid range defined by `ctx->in[in_idx].chunk0` and `ctx->in[in_idx].wmark`, and if `sz` is greater than or equal to `FD_ARCHIVER_FRAG_HEADER_FOOTPRINT`; logs an error if not.
    - Converts the `chunk` to a memory address using `fd_chunk_to_laddr` and assigns it to `src`.
    - Casts `src` to a `fd_archiver_frag_header_t` pointer and verifies the `magic` field against `FD_ARCHIVER_HEADER_MAGIC`.
    - Calculates the time since the last packet and updates `header->ns_since_prev_fragment`; updates `ctx->last_packet_ns` with the current time.
    - Copies the fragment from `src` to `ctx->frag_buf` using `fd_memcpy`.
    - Increments `ctx->stats.net_shred_in_cnt` if `header->tile_id` equals `FD_ARCHIVER_TILE_ID_SHRED`, and `ctx->stats.net_repair_in_cnt` if `header->tile_id` equals `FD_ARCHIVER_TILE_ID_REPAIR`.
- **Output**: No return value; the function operates by modifying the context and buffer in place.


---
### after\_frag<!-- {{#callable:after_frag}} -->
[View Source →](<../../../../../src/disco/archiver/fd_archiver_writer.c#L206>)

Writes a fragment from the buffer to the archive output stream and logs a warning if the write fails.
- **Inputs**:
    - `ctx`: A pointer to the `fd_archiver_writer_tile_ctx_t` structure, which contains the context for the archiver writer tile, including the output stream and fragment buffer.
    - `in_idx`: An unused parameter representing the index of the input.
    - `seq`: An unused parameter representing the sequence number.
    - `sig`: An unused parameter representing the signature.
    - `sz`: The size of the fragment to write.
    - `tsorig`: An unused parameter representing the original timestamp.
    - `tspub`: An unused parameter representing the publication timestamp.
    - `stem`: An unused parameter representing a pointer to the `fd_stem_context_t` structure.
- **Logic and Control Flow**:
    - Call `fd_io_buffered_ostream_write` to write the fragment from `ctx->frag_buf` to `ctx->archive_ostream` with size `sz`.
    - Check if the write operation returns a non-zero error code.
    - If an error occurs, log a warning message with the size of the fragment and the error code.
- **Output**: No return value; the function performs an action and logs a warning if an error occurs.



---
Made with ❤️ by [Driver](https://www.driver.ai/)