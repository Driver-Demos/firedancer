<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines a seccomp filter for syscall control in the archiver writer, generated by a script.

# Purpose
The code is a C header file that defines a seccomp (secure computing mode) filter policy for an archiver writer. It is generated automatically and should not be edited manually. The file includes several Linux headers related to auditing, capabilities, filtering, seccomp, and BPF (Berkeley Packet Filter), which are necessary for defining and applying the seccomp filter. The code is designed to work on specific architectures, such as `i386`, `x86_64`, and `aarch64`, and it will produce an error if compiled on an unsupported architecture.

The main functionality of the code is encapsulated in the [`populate_sock_filter_policy_archiver_writer`](<#populate_sock_filter_policy_archiver_writer>) function. This function initializes a BPF filter array with 16 instructions that enforce a security policy. The policy checks the architecture and allows or denies system calls based on predefined conditions. Specifically, it allows `write` and `fsync` system calls if they meet certain criteria related to file descriptors (`logfile_fd` and `archive_fd`). If the conditions are not met, the process is terminated using `SECCOMP_RET_KILL_PROCESS`. The function uses `fd_memcpy` to copy the filter instructions to the output buffer. This header file is intended to be included in other C source files that require this specific seccomp policy.
# Imports and Dependencies

---
- `../../../../src/util/fd_util_base.h`
- `linux/audit.h`
- `linux/capability.h`
- `linux/filter.h`
- `linux/seccomp.h`
- `linux/bpf.h`
- `sys/syscall.h`
- `signal.h`
- `stddef.h`


# Global Variables

---
### sock\_filter\_policy\_archiver\_writer\_instr\_cnt
- **Type**: ``unsigned int``
- **Description**: Defines the number of instructions in the socket filter policy for the archiver writer. This constant is used to ensure the correct number of filter instructions are processed.
- **Use**: Used to verify that the `populate_sock_filter_policy_archiver_writer` function processes the correct number of filter instructions.


# Functions

---
### populate\_sock\_filter\_policy\_archiver\_writer<!-- {{#callable:populate_sock_filter_policy_archiver_writer}} -->
[View Source →](<../../../../../../src/disco/archiver/generated/archiver_writer_seccomp.h#L26>)

Populates a `sock_filter` array with a predefined seccomp filter policy for syscall filtering.
- **Inputs**:
    - `out_cnt`: The number of elements in the `out` array, which must be at least 16.
    - `out`: A pointer to a `sock_filter` array where the filter policy will be copied.
    - `logfile_fd`: The file descriptor for the log file, used in syscall filtering.
    - `archive_fd`: The file descriptor for the archive file, used in syscall filtering.
- **Logic and Control Flow**:
    - Check if `out_cnt` is at least 16 using `FD_TEST` macro.
    - Define a `sock_filter` array `filter` with 16 elements to specify the seccomp filter policy.
    - Load the architecture from `seccomp_data` and compare it with `ARCH_NR`; jump to `RET_KILL_PROCESS` if they do not match.
    - Load the syscall number and check if it is `SYS_write` or `SYS_fsync`; if not, jump to `RET_KILL_PROCESS`.
    - For `SYS_write`, check if the first argument matches `2`, `archive_fd`, or `logfile_fd`; allow the syscall if any match, otherwise jump to `RET_KILL_PROCESS`.
    - For `SYS_fsync`, check if the first argument matches `logfile_fd`; allow the syscall if it matches, otherwise jump to `RET_KILL_PROCESS`.
    - Use `fd_memcpy` to copy the `filter` array to the `out` array.
- **Output**: The function does not return a value; it modifies the `out` array in place.



---
Made with ❤️ by [Driver](https://www.driver.ai/)