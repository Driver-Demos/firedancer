<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines a seccomp filter for syscall restrictions, generated by a script, with architecture-specific checks.

# Purpose
The code is a C header file that defines a seccomp (secure computing mode) filter policy for a process, specifically for an "archiver feeder" component. The file is automatically generated and should not be edited manually. It includes several Linux headers related to auditing, capabilities, filtering, and seccomp, which are necessary for defining and applying the seccomp filter. The code is designed to work on specific architectures, such as `i386`, `x86_64`, and `aarch64`, and it will produce an error if compiled on an unsupported architecture.

The main functionality is provided by the [`populate_sock_filter_policy_archiver_feeder`](<#populate_sock_filter_policy_archiver_feeder>) function, which initializes a `sock_filter` array with 14 instructions. These instructions define a seccomp filter that restricts the system calls a process can make. The filter allows only specific system calls, such as `write` and `fsync`, and checks the first argument of these calls to ensure they match a specified file descriptor (`logfile_fd`). If the conditions are not met, the filter will terminate the process using `SECCOMP_RET_KILL_PROCESS`. The function uses `fd_memcpy` to copy the filter instructions into the provided output buffer.
# Imports and Dependencies

---
- `../../../../src/util/fd_util_base.h`
- `linux/audit.h`
- `linux/capability.h`
- `linux/filter.h`
- `linux/seccomp.h`
- `linux/bpf.h`
- `sys/syscall.h`
- `signal.h`
- `stddef.h`


# Global Variables

---
### sock\_filter\_policy\_archiver\_feeder\_instr\_cnt
- **Type**: ``unsigned int``
- **Description**: A constant unsigned integer that represents the number of instructions in a socket filter policy for the archiver feeder.
- **Use**: Used to define the size of the `filter` array in the `populate_sock_filter_policy_archiver_feeder` function.


# Functions

---
### populate\_sock\_filter\_policy\_archiver\_feeder<!-- {{#callable:populate_sock_filter_policy_archiver_feeder}} -->
[View Source →](<../../../../../../src/disco/archiver/generated/archiver_feeder_seccomp.h#L26>)

Populates a `sock_filter` array with a predefined seccomp filter policy to control process execution based on system call checks.
- **Inputs**:
    - `out_cnt`: The number of elements in the `out` array, which must be at least 14.
    - `out`: A pointer to a `sock_filter` array where the filter policy will be copied.
    - `logfile_fd`: The file descriptor to be checked against syscall arguments for write and fsync operations.
- **Logic and Control Flow**:
    - Check if `out_cnt` is at least 14 using `FD_TEST` macro.
    - Define a `sock_filter` array `filter` with 14 elements to specify the seccomp filter policy.
    - Load the architecture from `seccomp_data` and compare it with `ARCH_NR`; if not equal, jump to `RET_KILL_PROCESS`.
    - Load the syscall number and check if it is `SYS_write` or `SYS_fsync`; if not, jump to `RET_KILL_PROCESS`.
    - For `SYS_write`, load the first syscall argument and check if it is 2 or `logfile_fd`; if not, jump to `RET_KILL_PROCESS`.
    - For `SYS_fsync`, load the first syscall argument and check if it is `logfile_fd`; if not, jump to `RET_KILL_PROCESS`.
    - If none of the conditions are met, execute `RET_KILL_PROCESS`.
    - Copy the `filter` array to the `out` array using `fd_memcpy`.
- **Output**: The `out` array is populated with the seccomp filter policy.



---
Made with ❤️ by [Driver](https://www.driver.ai/)