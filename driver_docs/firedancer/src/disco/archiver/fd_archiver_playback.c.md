<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements an archiver playback tile that reads from an archive file, adds delay, and forwards data to receiver tiles.

# Purpose
The code defines a module for an "archiver playback tile" in a distributed system. This module reads data from an archive file and reproduces the timing of the original data capture by introducing artificial delays. It then forwards the data fragments to receiver tiles, which include shred, quic, gossip, and repair tiles. The module is designed to replace the input links to these receiver tiles, ensuring that the data is replayed with the same timing as the original capture.

The module includes several key components, such as the `fd_archiver_playback_tile_ctx_t` structure, which maintains the context for the playback operation, including statistics, timing information, and output contexts. The code also defines functions for initializing the playback tile in both privileged and unprivileged modes, setting up the necessary resources and file descriptors. The playback process involves reading headers and fragments from the archive file, determining the appropriate output link, and publishing the fragments to the receiver tiles. The module uses several macros and inline functions to manage memory alignment and footprint calculations, and it integrates with a larger system through the `fd_topo_run_tile_t` structure, which specifies the tile's name, initialization functions, and runtime behavior.
# Imports and Dependencies

---
- `../tiles.h`
- `fd_archiver.h`
- `errno.h`
- `fcntl.h`
- `string.h`
- `sys/mman.h`
- `sys/stat.h`
- `unistd.h`
- `linux/unistd.h`
- `sys/socket.h`
- `linux/if_xdp.h`
- `generated/archiver_playback_seccomp.h`
- `../../util/pod/fd_pod_format.h`
- `../stem/fd_stem.c`


# Global Variables

---
### fd\_tile\_archiver\_playback
- **Type**: ``fd_topo_run_tile_t``
- **Description**: Defines a tile configuration for the archiver playback functionality. This structure includes function pointers and parameters necessary for initializing and running the archiver playback tile.
- **Use**: Used to configure and manage the execution of the archiver playback tile in the system.


# Data Structures

---
### fd\_archiver\_playback\_stats
- **Type**: ``struct``
- **Members**:
    - ``net_shred_out_cnt``: Counts the number of network shred outputs.
    - ``net_quic_out_cnt``: Counts the number of network QUIC outputs.
    - ``net_gossip_out_cnt``: Counts the number of network gossip outputs.
    - ``net_repair_out_cnt``: Counts the number of network repair outputs.
- **Description**: Tracks the number of different types of network outputs (shred, QUIC, gossip, and repair) in an archiver playback system.


---
### fd\_archiver\_playback\_stats\_t
- **Type**: ``struct``
- **Members**:
    - `net_shred_out_cnt`: Counts the number of network shred outputs.
    - `net_quic_out_cnt`: Counts the number of network QUIC outputs.
    - `net_gossip_out_cnt`: Counts the number of network gossip outputs.
    - `net_repair_out_cnt`: Counts the number of network repair outputs.
- **Description**: Tracks the number of different types of network outputs during the playback of archived data, specifically for shred, QUIC, gossip, and repair outputs.


---
### fd\_archiver\_playback\_out\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``mem``: Pointer to a `fd_wksp_t` structure, representing a memory workspace.
    - ``mtu``: Maximum transmission unit size for the data chunks.
    - ``chunk0``: Initial chunk index for data storage.
    - ``wmark``: Watermark for data chunk management.
    - ``chunk``: Current chunk index for data storage.
- **Description**: `fd_archiver_playback_out_ctx_t` is a structure that manages the context for output data chunks in an archiver playback system. It includes a pointer to a memory workspace, the maximum transmission unit size, and indices for managing data chunks, including the initial chunk, current chunk, and a watermark for chunk management.


---
### fd\_archiver\_playback\_tile\_ctx
- **Type**: ``struct``
- **Members**:
    - ``istream``: Buffered input stream for reading data.
    - ``istream_buf``: Buffer for the input stream.
    - ``stats``: Playback statistics for the archiver.
    - ``tick_per_ns``: Conversion factor from ticks to nanoseconds.
    - ``prev_publish_time``: Timestamp of the previous publish event.
    - ``now``: Current timestamp.
    - ``need_notify``: Flag indicating if notification is needed.
    - ``notified``: Flag indicating if notification has been received.
    - ``out``: Array of output contexts for playback.
    - ``playback_done``: Flag indicating if playback is complete.
    - ``done_time``: Timestamp when playback was completed.
    - ``playback_started``: Flag indicating if playback has started.
    - ``playback_cnt``: Array counting playback events for each tile.
    - ``published_wmark``: Pointer to the published watermark, shared with the replay tile.
- **Description**: Manages the context for playback of archived data, including input stream handling, timing, notification management, and output to receiver tiles. It maintains playback statistics, timing information, and state flags to control the playback process and ensure synchronization with other components.


---
### fd\_archiver\_playback\_tile\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``istream``: Buffered input stream for reading data.
    - ``istream_buf``: Buffer for the input stream.
    - ``stats``: Playback statistics for network outputs.
    - ``tick_per_ns``: Ticks per nanosecond for time calculations.
    - ``prev_publish_time``: Previous time a fragment was published.
    - ``now``: Current time in ticks.
    - ``need_notify``: Flag indicating if notification is needed before playback.
    - ``notified``: Flag indicating if notification has been received.
    - ``out``: Array of output contexts for different network links.
    - ``playback_done``: Flag indicating if playback is complete.
    - ``done_time``: Time when playback was completed.
    - ``playback_started``: Flag indicating if playback has started.
    - ``playback_cnt``: Count of fragments played back for each tile type.
    - ``published_wmark``: Watermark for published fragments, shared with replay tile.
- **Description**: Manages the playback of archived data by reading from an input stream, applying timing delays, and forwarding data to output links. It maintains playback statistics, handles timing calculations, and manages notifications for fragment playback. The structure includes contexts for output links and tracks the state of playback, including whether it has started or completed.


# Functions

---
### scratch\_align<!-- {{#callable:scratch_align}} -->
[View Source →](<../../../../../src/disco/archiver/fd_archiver_playback.c#L72>)

Returns a constant alignment value of 4096 bytes.
- **Inputs**: None
- **Logic and Control Flow**:
    - The function is defined as `static inline`, indicating it is intended for use within the same translation unit and suggests inlining for performance.
    - The function is marked with `FD_FN_CONST`, indicating it has no side effects and its return value depends only on its parameters, which in this case are none.
    - The function simply returns the constant value `4096UL`.
- **Output**: A constant unsigned long integer value of 4096.


---
### loose\_footprint<!-- {{#callable:loose_footprint}} -->
[View Source →](<../../../../../src/disco/archiver/fd_archiver_playback.c#L77>)

Calculates the memory footprint for a tile using a constant page size.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure, which is not used in the function.
- **Logic and Control Flow**:
    - The function takes a single argument `tile`, which is marked as unused with `FD_PARAM_UNUSED`.
    - It returns the product of `1UL` and `FD_SHMEM_GIGANTIC_PAGE_SZ`, which represents a constant memory size.
- **Output**: Returns an `ulong` representing the memory footprint size, specifically `FD_SHMEM_GIGANTIC_PAGE_SZ`.


---
### populate\_allowed\_seccomp<!-- {{#callable:populate_allowed_seccomp}} -->
[View Source →](<../../../../../src/disco/archiver/fd_archiver_playback.c#L82>)

Populates a seccomp filter for archiver playback with specific file descriptors.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, which is not used in this function.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure containing the `archiver.archive_fd`.
    - ``out_cnt``: An unsigned long integer representing the count of output filters.
    - ``out``: A pointer to a `struct sock_filter` array where the seccomp filter will be populated.
- **Logic and Control Flow**:
    - Ignore the `topo` parameter as it is not used.
    - Call [`populate_sock_filter_policy_archiver_playback`](<generated/archiver_playback_seccomp.h.md#populate_sock_filter_policy_archiver_playback>) with `out_cnt`, `out`, the file descriptor from `fd_log_private_logfile_fd()`, and the `archive_fd` from `tile->archiver`.
    - Return the value of `sock_filter_policy_archiver_playback_instr_cnt`.
- **Output**: Returns the number of instructions in the seccomp filter as an unsigned long integer.
- **Functions Called**:
    - [`populate_sock_filter_policy_archiver_playback`](<generated/archiver_playback_seccomp.h.md#populate_sock_filter_policy_archiver_playback>)


---
### populate\_allowed\_fds<!-- {{#callable:populate_allowed_fds}} -->
[View Source →](<../../../../../src/disco/archiver/fd_archiver_playback.c#L96>)

Populates an array with file descriptors for standard error, a log file, and an archive file if they are available.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, which is not used in this function.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure, which contains information about the tile, including the archive file descriptor.
    - ``out_fds_cnt``: An unsigned long integer representing the count of output file descriptors, which is not used in this function.
    - ``out_fds``: A pointer to an integer array where the function will store the allowed file descriptors.
- **Logic and Control Flow**:
    - Initialize `out_cnt` to 0.
    - Assign the file descriptor for standard error (2) to `out_fds[out_cnt]` and increment `out_cnt`.
    - Check if the log file descriptor is valid (not -1) using `fd_log_private_logfile_fd()`. If valid, assign it to `out_fds[out_cnt]` and increment `out_cnt`.
    - Check if the archive file descriptor in `tile->archiver.archive_fd` is valid (not -1). If valid, assign it to `out_fds[out_cnt]` and increment `out_cnt`.
    - Return the count of valid file descriptors stored in `out_fds`.
- **Output**: Returns the number of valid file descriptors stored in the `out_fds` array as an unsigned long integer.


---
### scratch\_footprint<!-- {{#callable:scratch_footprint}} -->
[View Source →](<../../../../../src/disco/archiver/fd_archiver_playback.c#L112>)

Calculates the memory footprint required for a scratch space layout for an archiver playback tile.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure, which is not used in the function.
- **Logic and Control Flow**:
    - Initialize a variable `l` with `FD_LAYOUT_INIT`.
    - Append the layout of `fd_archiver_playback_tile_ctx_t` to `l` using `FD_LAYOUT_APPEND`, considering its alignment and size.
    - Append a buffer size to `l` using `FD_LAYOUT_APPEND` with a fixed alignment of 4096 and size `FD_ARCHIVE_PLAYBACK_BUFFER_SZ`.
    - Finalize the layout using `FD_LAYOUT_FINI` with the alignment obtained from `scratch_align()`.
- **Output**: Returns an `ulong` representing the calculated memory footprint for the scratch space layout.
- **Functions Called**:
    - [`scratch_align`](<#scratch_align>)


---
### privileged\_init<!-- {{#callable:privileged_init}} -->
[View Source →](<../../../../../src/disco/archiver/fd_archiver_playback.c#L121>)

Initializes resources and opens an archive file for a playback tile in a privileged context.
- **Inputs**:
    - ``topo``: A pointer to an `fd_topo_t` structure representing the topology configuration.
    - ``tile``: A pointer to an `fd_topo_tile_t` structure representing the tile configuration.
- **Logic and Control Flow**:
    - Obtain a scratch memory address using `fd_topo_obj_laddr` with `topo` and `tile->tile_obj_id`.
    - Initialize scratch memory allocation with `FD_SCRATCH_ALLOC_INIT`.
    - Allocate and zero-initialize a `fd_archiver_playback_tile_ctx_t` context structure using `FD_SCRATCH_ALLOC_APPEND` and `memset`.
    - Allocate a buffer for `istream_buf` in the context structure using `FD_SCRATCH_ALLOC_APPEND`.
    - Finalize the scratch memory allocation with `FD_SCRATCH_ALLOC_FINI`.
    - Open the archive file specified by `tile->archiver.rocksdb_path` with read-only and direct I/O flags using `open`.
    - Check if the file descriptor is valid; if not, log an error using `FD_LOG_ERR`.
- **Output**: No return value; modifies the `tile` structure and logs errors if the archive file cannot be opened.
- **Functions Called**:
    - [`scratch_align`](<#scratch_align>)


---
### unprivileged\_init<!-- {{#callable:unprivileged_init}} -->
[View Source →](<../../../../../src/disco/archiver/fd_archiver_playback.c#L138>)

Initializes the unprivileged context for an archiver playback tile, setting up memory, input streams, and output links.
- **Inputs**:
    - `topo`: A pointer to an `fd_topo_t` structure representing the topology configuration.
    - `tile`: A pointer to an `fd_topo_tile_t` structure representing the tile configuration.
- **Logic and Control Flow**:
    - Allocate scratch memory for the tile context using `FD_SCRATCH_ALLOC_INIT` and `FD_SCRATCH_ALLOC_APPEND`.
    - Initialize the `istream_buf` for buffered input stream operations.
    - Finalize the scratch memory allocation with `FD_SCRATCH_ALLOC_FINI`.
    - Set `tick_per_ns` using `fd_tempo_tick_per_ns` to determine the timing resolution.
    - Initialize the buffered input stream with `fd_io_buffered_istream_init`.
    - Perform an initial read from the input stream and log a warning if it fails.
    - Set up output links by iterating over `tile->out_cnt` and configuring each link's MTU, memory, and chunk settings.
    - Initialize various playback context fields such as `playback_done`, `playback_started`, `now`, `prev_publish_time`, `need_notify`, and `notified`.
    - Verify that the tile has exactly one input link with `FD_TEST`.
    - Query the `root_slot` property from `topo->props` and join it to `ctx->published_wmark`.
    - Log an error if `ctx->published_wmark` is not set or if the `root_slot` query fails.
    - Log a warning indicating the completion of the playback tile initialization.
- **Output**: No return value; the function initializes the context for playback operations.
- **Functions Called**:
    - [`scratch_align`](<#scratch_align>)


---
### during\_housekeeping<!-- {{#callable:during_housekeeping}} -->
[View Source →](<../../../../../src/disco/archiver/fd_archiver_playback.c#L190>)

Updates the current time in the context structure by converting the tick count to nanoseconds.
- **Inputs**:
    - `ctx`: A pointer to a `fd_archiver_playback_tile_ctx_t` structure that holds the context for the archiver playback tile.
- **Logic and Control Flow**:
    - Call the `fd_tickcount()` function to get the current tick count.
    - Divide the tick count by `ctx->tick_per_ns` to convert it to nanoseconds.
    - Cast the result to `ulong` and assign it to `ctx->now`.
- **Output**: No return value; updates the `now` field in the `ctx` structure.


---
### after\_frag<!-- {{#callable:after_frag}} -->
[View Source →](<../../../../../src/disco/archiver/fd_archiver_playback.c#L195>)

Checks if the input index is zero and sets the `notified` field of the context to 1.
- **Inputs**:
    - `ctx`: A pointer to `fd_archiver_playback_tile_ctx_t`, which is the context for the archiver playback tile.
    - `in_idx`: An unsigned long integer representing the input index.
    - `seq`: An unsigned long integer representing the sequence number (unused).
    - `sig`: An unsigned long integer representing the signature (unused).
    - `sz`: An unsigned long integer representing the size (unused).
    - `tsorig`: An unsigned long integer representing the original timestamp (unused).
    - `tspub`: An unsigned long integer representing the publish timestamp (unused).
    - `stem`: A pointer to `fd_stem_context_t`, which is the context for the stem (unused).
- **Logic and Control Flow**:
    - Check if `in_idx` is not equal to 0 using `FD_UNLIKELY` macro.
    - If `in_idx` is not 0, log an error message indicating that playback seems corrupted using `FD_LOG_ERR`.
    - Set the `notified` field of the `ctx` structure to 1.
- **Output**: No return value; the function modifies the `ctx` structure directly.


---
### after\_credit<!-- {{#callable:after_credit}} -->
[View Source →](<../../../../../src/disco/archiver/fd_archiver_playback.c#L208>)

Processes playback of archived fragments, ensuring correct timing and forwarding to appropriate output links.
- **Inputs**:
    - `ctx`: A pointer to `fd_archiver_playback_tile_ctx_t`, which holds the context for the playback operation.
    - `stem`: A pointer to `fd_stem_context_t`, which is used for publishing fragments.
    - `opt_poll_in`: An optional pointer to an integer, marked as unused in this function.
    - `charge_busy`: An optional pointer to an integer, marked as unused in this function.
- **Logic and Control Flow**:
    - Check if playback is done; if so, log an error if the current time exceeds the done time by more than 5 seconds and return.
    - If playback has not started, query the published watermark; if it is valid, mark playback as started and log a warning, otherwise return.
    - Peek the header from the input stream without consuming it; log an error if peeking fails.
    - Check the header's magic number; if it is invalid, log a warning, mark playback as done, and return.
    - If the current time is less than the previous publish time plus the time since the previous fragment, return to delay publishing.
    - If notification is needed and not received, return.
    - Read the header from the stream; if reading fails, log a warning, mark playback as done, and return.
    - Determine the output link based on the header's tile ID; increment the corresponding playback count or log an error if the tile ID is unsupported.
    - Read the fragment from the stream into the destination buffer; if reading fails, log a warning, mark playback as done, and return.
    - If notification is needed, reset the notification flag.
    - Check if the fragment size exceeds the maximum transmission unit (MTU) for the link; if so, log an error.
    - Publish the fragment using `fd_stem_publish` and update the chunk pointer for the output link.
    - Update the previous publish time to the current time.
- **Output**: No direct output; modifies the state of `ctx` and interacts with the `stem` for publishing.



---
Made with ❤️ by [Driver](https://www.driver.ai/)