<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines a seccomp filter policy for QUIC with architecture-specific syscall handling.

# Purpose
The code is a C header file that defines a seccomp (secure computing mode) filter policy for a QUIC (Quick UDP Internet Connections) application. It is automatically generated and should not be edited manually. The file includes necessary headers for working with seccomp and BPF (Berkeley Packet Filter) and defines architecture-specific constants to ensure compatibility with the runtime environment. The code specifies a BPF program that restricts the system calls available to the application, enhancing security by allowing only specific system calls such as `write`, `fsync`, and `getrandom`. The filter checks the architecture and syscall numbers, and it uses conditional jumps to either allow or kill the process based on the syscall and its arguments.

The function [`populate_sock_filter_policy_quic`](<#populate_sock_filter_policy_quic>) is the main component of this file. It initializes a `sock_filter` array with 17 instructions that define the seccomp policy. The function takes parameters for the output filter count, the filter array, and file descriptors for logging. The filter logic includes checks for syscall numbers and arguments, allowing certain operations based on predefined conditions. If a syscall does not match the allowed criteria, the process is terminated. This header file is intended to be included in other C source files to apply the defined seccomp policy to a QUIC application, providing a layer of security by limiting the system calls that the application can execute.
# Imports and Dependencies

---
- `../../../../src/util/fd_util_base.h`
- `linux/audit.h`
- `linux/capability.h`
- `linux/filter.h`
- `linux/seccomp.h`
- `linux/bpf.h`
- `sys/syscall.h`
- `signal.h`
- `stddef.h`


# Global Variables

---
### sock\_filter\_policy\_quic\_instr\_cnt
- **Type**: ``unsigned int``
- **Description**: Defines the number of instructions in the socket filter policy for QUIC. This constant is used to ensure that the correct number of instructions are processed in the filter.
- **Use**: Used to verify the instruction count in the `populate_sock_filter_policy_quic` function.


# Functions

---
### populate\_sock\_filter\_policy\_quic<!-- {{#callable:populate_sock_filter_policy_quic}} -->
[View Source →](<../../../../../../src/disco/quic/generated/quic_seccomp.h#L26>)

Populates a socket filter policy for QUIC with specific seccomp rules to allow or kill processes based on system call checks.
- **Inputs**:
    - `out_cnt`: The number of elements in the output filter array, which must be at least 17.
    - `out`: A pointer to an array of `struct sock_filter` where the filter policy will be stored.
    - `logfile_fd`: The file descriptor for the log file, used in syscall checks.
    - `keylog_fd`: The file descriptor for the key log file, used in syscall checks.
- **Logic and Control Flow**:
    - Check if `out_cnt` is at least 17 using `FD_TEST` macro.
    - Define a `struct sock_filter` array `filter` with 17 elements to specify seccomp rules.
    - Load the architecture from `seccomp_data` and compare it with `ARCH_NR`; jump to `RET_KILL_PROCESS` if they do not match.
    - Load the syscall number and check if it matches `SYS_write`, `SYS_fsync`, or `SYS_getrandom`.
    - For `SYS_write`, check if the first argument matches 2, `logfile_fd`, or `keylog_fd`; allow if matched, otherwise jump to `RET_KILL_PROCESS`.
    - For `SYS_fsync`, check if the first argument matches `logfile_fd`; allow if matched, otherwise jump to `RET_KILL_PROCESS`.
    - If none of the syscalls match, jump to `RET_KILL_PROCESS`.
    - Copy the `filter` array to the `out` array using `fd_memcpy`.
- **Output**: The function does not return a value; it populates the `out` array with the defined seccomp filter policy.



---
Made with ❤️ by [Driver](https://www.driver.ai/)