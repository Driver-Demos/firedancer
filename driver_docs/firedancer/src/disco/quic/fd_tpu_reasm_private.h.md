<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Reusable logic for fd_tpu_reasm, including slot management and reassembly queue operations.

# Purpose
The `fd_tpu_reasm_private.h` file is a C header file that provides internal logic for the reassembly of data packets in a Transmission Processing Unit (TPU) context. It is designed to be included in test cases and other components that require access to the reassembly logic. The file defines a set of macros and functions that manage reassembly slots, which are used to store and process incoming data packets. The reassembly process involves organizing packets into a coherent sequence, which is crucial for applications that require data integrity and order.

Key components of this file include the definition of a map structure (`fd_tpu_reasm_map`) for managing reassembly slots, and a set of functions for manipulating these slots. Functions such as [`fd_tpu_reasm_reset`](<#fd_tpu_reasm_reset>), [`slot_get_idx`](<#slot_get_idx>), and [`slotq_push_head`](<#slotq_push_head>) are used to initialize, access, and manage the lifecycle of reassembly slots. The file also implements a Least Recently Used (LRU) cache mechanism to efficiently allocate and evict slots, ensuring optimal memory usage. Additionally, the file includes logic for querying and removing slots from the reassembly map, which is essential for maintaining the state of the reassembly process. The use of inline functions and macros suggests that performance is a consideration, as these constructs can reduce function call overhead.
# Imports and Dependencies

---
- `fd_tpu.h`
- `assert.h`
- `../../util/tmpl/fd_map_chain.c`


# Functions

---
### slot\_get\_idx<!-- {{#callable:slot_get_idx}} -->
[View Source →](<../../../../../src/disco/quic/fd_tpu_reasm_private.h#L37>)

Calculates the index of a given reassembly slot within a reassembly structure and logs an error if the index is invalid.
- **Inputs**:
    - `reasm`: A pointer to a `fd_tpu_reasm_t` structure representing the reassembly context.
    - `slot`: A pointer to a `fd_tpu_reasm_slot_t` structure representing the specific slot whose index is to be calculated.
- **Logic and Control Flow**:
    - Calculate the index of the `slot` by subtracting the base address of the slots array from the address of the `slot` and store it in `slot_idx`.
    - Check if `slot_idx` is greater than or equal to the sum of `reasm->depth` and `reasm->burst`.
    - If the condition is true, log a critical error message indicating an invalid slot pointer with the calculated `slot_idx` and the sum of `reasm->depth` and `reasm->burst`.
    - Return `slot_idx` cast to an unsigned integer.
- **Output**: Returns the index of the slot as an unsigned integer (`uint`).
- **Functions Called**:
    - [`fd_tpu_reasm_slots_laddr_const`](<fd_tpu.h.md#fd_tpu_reasm_slots_laddr_const>)


---
### slot\_get\_offset<!-- {{#callable:slot_get_offset}} -->
[View Source →](<../../../../../src/disco/quic/fd_tpu_reasm_private.h#L48>)

Calculates the memory offset for a given slot index in the reassembly process.
- **Inputs**:
    - `slot_idx`: The index of the slot for which to calculate the memory offset.
- **Logic and Control Flow**:
    - Multiply the `slot_idx` by the constant `FD_TPU_REASM_MTU` to compute the offset.
- **Output**: Returns the computed memory offset as an unsigned long integer (`ulong`).


---
### slot\_get\_data<!-- {{#callable:slot_get_data}} -->
[View Source →](<../../../../../src/disco/quic/fd_tpu_reasm_private.h#L64>)

Returns a pointer to the start of the data for a given slot index in the reassembly structure.
- **Inputs**:
    - `reasm`: A pointer to the `fd_tpu_reasm_t` structure, which contains the reassembly data cache.
    - `slot_idx`: An unsigned long integer representing the index of the slot whose data is to be accessed.
- **Logic and Control Flow**:
    - Calculate the offset for the given `slot_idx` by calling `slot_get_offset(slot_idx)`.
    - Add the calculated offset to the base address of the data cache `reasm->dcache`.
    - Return the resulting pointer, which points to the start of the data for the specified slot.
- **Output**: A pointer to an `uchar` that represents the start of the data for the specified slot index in the reassembly data cache.
- **Functions Called**:
    - [`slot_get_offset`](<#slot_get_offset>)


---
### slot\_get\_data\_const<!-- {{#callable:slot_get_data_const}} -->
[View Source →](<../../../../../src/disco/quic/fd_tpu_reasm_private.h#L70>)

Returns a constant pointer to the data cache at the specified slot index.
- **Inputs**:
    - ``reasm``: A constant pointer to an `fd_tpu_reasm_t` structure, which contains the data cache and other reassembly-related information.
    - ``slot_idx``: An unsigned long integer representing the index of the slot in the data cache.
- **Logic and Control Flow**:
    - Calculate the offset in the data cache by calling [`slot_get_offset`](<#slot_get_offset>) with `slot_idx` as the argument.
    - Add the calculated offset to the base address of the data cache (`reasm->dcache`).
    - Return the resulting address as a constant pointer to an unsigned character.
- **Output**: A constant pointer to an unsigned character (`uchar const *`) that points to the data at the specified slot index in the data cache.
- **Functions Called**:
    - [`slot_get_offset`](<#slot_get_offset>)


---
### slot\_get\_data\_pkt\_payload<!-- {{#callable:slot_get_data_pkt_payload}} -->
[View Source →](<../../../../../src/disco/quic/fd_tpu_reasm_private.h#L76>)

Calculates the memory address of the packet payload within a reassembly slot.
- **Inputs**:
    - `reasm`: A pointer to the `fd_tpu_reasm_t` structure, which contains the reassembly context and data cache.
    - `slot_idx`: An unsigned long integer representing the index of the slot within the reassembly structure.
- **Logic and Control Flow**:
    - Calculate the offset for the given `slot_idx` by calling `slot_get_offset(slot_idx)`.
    - Add the size of `fd_txn_m_t` to the calculated offset to skip the header portion.
    - Return the pointer to the start of the packet payload by adding the calculated offset to `reasm->dcache`.
- **Output**: A pointer to the start of the packet payload within the specified reassembly slot.
- **Functions Called**:
    - [`slot_get_offset`](<#slot_get_offset>)


---
### slot\_begin<!-- {{#callable:slot_begin}} -->
[View Source →](<../../../../../src/disco/quic/fd_tpu_reasm_private.h#L82>)

Initializes a reassembly slot to a busy state with default identifiers.
- **Inputs**:
    - `slot`: A pointer to a `fd_tpu_reasm_slot_t` structure that represents the reassembly slot to initialize.
- **Logic and Control Flow**:
    - Call `memset` to set all bytes of the `slot` to zero.
    - Set the `state` field of the `slot`'s key to `FD_TPU_REASM_STATE_BUSY`.
    - Set the `conn_uid` field of the `slot`'s key to `ULONG_MAX`.
    - Set the `stream_id` field of the `slot`'s key to `FD_TPU_REASM_SID_MASK`.
- **Output**: No return value; the function modifies the `slot` in place.


---
### slotq\_push\_head<!-- {{#callable:slotq_push_head}} -->
[View Source →](<../../../../../src/disco/quic/fd_tpu_reasm_private.h#L98>)

Adds a slot to the head of the reassembly queue in a least recently used (LRU) cache.
- **Inputs**:
    - `reasm`: A pointer to the `fd_tpu_reasm_t` structure representing the reassembly context.
    - `slot`: A pointer to the `fd_tpu_reasm_slot_t` structure representing the slot to add to the queue head.
- **Logic and Control Flow**:
    - Get the index of the `slot` using [`slot_get_idx`](<#slot_get_idx>) function.
    - Retrieve the current head index from `reasm->head`.
    - Calculate the address of the current head slot using [`fd_tpu_reasm_slots_laddr`](<fd_tpu.h.md#fd_tpu_reasm_slots_laddr>) and the head index.
    - Set the `lru_prev` of the current head slot to the index of the new slot.
    - Set the `lru_prev` of the new slot to `UINT_MAX` to indicate it has no previous slot.
    - Set the `lru_next` of the new slot to the current head index.
    - Update `reasm->head` to the index of the new slot.
- **Output**: No return value; the function modifies the reassembly queue in place.
- **Functions Called**:
    - [`slot_get_idx`](<#slot_get_idx>)
    - [`fd_tpu_reasm_slots_laddr`](<fd_tpu.h.md#fd_tpu_reasm_slots_laddr>)


---
### slotq\_push\_tail<!-- {{#callable:slotq_push_tail}} -->
[View Source →](<../../../../../src/disco/quic/fd_tpu_reasm_private.h#L116>)

Adds a slot to the tail of the reassembly queue in a least-recently-used (LRU) cache.
- **Inputs**:
    - `reasm`: A pointer to the `fd_tpu_reasm_t` structure representing the reassembly context.
    - `slot`: A pointer to the `fd_tpu_reasm_slot_t` structure representing the slot to add to the tail of the queue.
- **Logic and Control Flow**:
    - Get the index of the slot using [`slot_get_idx`](<#slot_get_idx>) function.
    - Retrieve the current tail index from the `reasm` structure.
    - Check that the current tail index is within the valid range of slots using `FD_TEST`.
    - Get a pointer to the current tail slot using the [`fd_tpu_reasm_slots_laddr`](<fd_tpu.h.md#fd_tpu_reasm_slots_laddr>) function and the tail index.
    - Set the `lru_next` of the current tail slot to the index of the new slot.
    - Set the `lru_prev` of the new slot to the current tail index.
    - Set the `lru_next` of the new slot to `UINT_MAX` to indicate it is the new tail.
    - Update the `reasm->tail` to the index of the new slot.
- **Output**: No return value; the function modifies the reassembly queue in place.
- **Functions Called**:
    - [`slot_get_idx`](<#slot_get_idx>)
    - [`fd_tpu_reasm_slots_laddr`](<fd_tpu.h.md#fd_tpu_reasm_slots_laddr>)


---
### slotq\_remove<!-- {{#callable:slotq_remove}} -->
[View Source →](<../../../../../src/disco/quic/fd_tpu_reasm_private.h#L152>)

Removes a slot from a doubly linked list in a reassembly queue, updating the list's head, tail, and adjacent slots as necessary.
- **Inputs**:
    - `reasm`: A pointer to the `fd_tpu_reasm_t` structure representing the reassembly queue.
    - `slot`: A pointer to the `fd_tpu_reasm_slot_t` structure representing the slot to remove from the queue.
- **Logic and Control Flow**:
    - Retrieve the index of the slot using [`slot_get_idx`](<#slot_get_idx>) function.
    - Store the previous and next slot indices from the slot's `lru_prev` and `lru_next` fields.
    - Set the slot's `lru_prev` and `lru_next` fields to `UINT_MAX` to mark it as removed.
    - Calculate pointers to the previous and next slots using [`fd_tpu_reasm_slots_laddr`](<fd_tpu.h.md#fd_tpu_reasm_slots_laddr>).
    - If the slot is the head of the queue, update the head to the next slot and set the next slot's `lru_prev` to `UINT_MAX`.
    - If the slot is the tail of the queue, update the tail to the previous slot and set the previous slot's `lru_next` to `UINT_MAX`.
    - For slots that are neither head nor tail, update the `lru_next` of the previous slot and the `lru_prev` of the next slot to bypass the removed slot.
    - Check for out-of-bounds errors on `lru_prev` and `lru_next` indices and log errors if necessary.
- **Output**: No return value; the function modifies the reassembly queue in place.
- **Functions Called**:
    - [`slot_get_idx`](<#slot_get_idx>)
    - [`fd_tpu_reasm_slots_laddr`](<fd_tpu.h.md#fd_tpu_reasm_slots_laddr>)


---
### smap\_insert<!-- {{#callable:smap_insert}} -->
[View Source →](<../../../../../src/disco/quic/fd_tpu_reasm_private.h#L195>)

Inserts a reassembly slot into the reassembly map.
- **Inputs**:
    - `reasm`: A pointer to the `fd_tpu_reasm_t` structure, which represents the reassembly context.
    - `slot`: A pointer to the `fd_tpu_reasm_slot_t` structure, which represents the slot to insert into the reassembly map.
- **Logic and Control Flow**:
    - Calls `fd_tpu_reasm_map_laddr` with `reasm` to get the local address of the reassembly map.
    - Calls [`fd_tpu_reasm_slots_laddr`](<fd_tpu.h.md#fd_tpu_reasm_slots_laddr>) with `reasm` to get the local address of the reassembly slots.
    - Calls `fd_tpu_reasm_map_ele_insert` with the local address of the reassembly map, the `slot`, and the local address of the reassembly slots to insert the slot into the map.
- **Output**: No return value; the function performs an insertion operation.
- **Functions Called**:
    - [`fd_tpu_reasm_slots_laddr`](<fd_tpu.h.md#fd_tpu_reasm_slots_laddr>)


---
### smap\_remove<!-- {{#callable:smap_remove}} -->
[View Source →](<../../../../../src/disco/quic/fd_tpu_reasm_private.h#L221>)

Removes a slot from the reassembly map in the reassembly structure.
- **Inputs**:
    - `reasm`: A pointer to the `fd_tpu_reasm_t` structure, which contains the reassembly map and slots.
    - `slot`: A pointer to the `fd_tpu_reasm_slot_t` structure, representing the slot to be removed from the reassembly map.
- **Logic and Control Flow**:
    - Calls `fd_tpu_reasm_map_idx_remove` with the reassembly map address, the key of the slot, `ULONG_MAX`, and the slots address.
    - The function `fd_tpu_reasm_map_idx_remove` handles the removal of the slot from the map.
- **Output**: No return value; the function operates directly on the data structures provided.
- **Functions Called**:
    - [`fd_tpu_reasm_slots_laddr`](<fd_tpu.h.md#fd_tpu_reasm_slots_laddr>)


# Function Declarations (Public API)

---
### fd\_tpu\_reasm\_reset<!-- {{#callable_declaration:fd_tpu_reasm_reset}} -->
[View Source →](<../../../../../src/disco/quic/fd_tpu_reasm_private.h#L27>)

Initializes all reassembly slots to their initial state.
- **Description**: Use this function to reset the reassembly slots to their initial state, which is necessary when starting a new reassembly process or recovering from an error. This function corrupts any messages currently visible in the mcache ring, so ensure that no important data is present before calling it. It is important to call this function only when the reassembly structure is properly initialized and not in use by other operations.
- **Inputs**:
    - `reasm`: A pointer to an `fd_tpu_reasm_t` structure. This must not be null and should point to a valid reassembly structure. The caller retains ownership of this structure.
- **Output**: None
- **See Also**: [`fd_tpu_reasm_reset`](<fd_tpu_reasm.c.md#fd_tpu_reasm_reset>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)