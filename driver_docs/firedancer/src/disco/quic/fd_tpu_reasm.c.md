<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for managing and manipulating TPU reassembly slots, including initialization, querying, and publishing.

# Purpose
The code is a C module that implements a reassembly mechanism for data packets, specifically designed for a TPU (Transaction Processing Unit) environment. It provides functions to manage memory allocation, initialize, and manipulate reassembly slots, which are used to handle fragmented data packets. The module includes functions to calculate memory alignment and footprint requirements ([`fd_tpu_reasm_align`](<#fd_tpu_reasm_align>), [`fd_tpu_reasm_footprint`](<#fd_tpu_reasm_footprint>)), create and initialize new reassembly objects ([`fd_tpu_reasm_new`](<#fd_tpu_reasm_new>)), reset the state of reassembly slots ([`fd_tpu_reasm_reset`](<#fd_tpu_reasm_reset>)), and manage the lifecycle of reassembly objects ([`fd_tpu_reasm_join`](<#fd_tpu_reasm_join>), [`fd_tpu_reasm_leave`](<#fd_tpu_reasm_leave>), [`fd_tpu_reasm_delete`](<#fd_tpu_reasm_delete>)).

The module also provides functions to handle the reassembly process, such as querying and preparing slots for new data fragments ([`fd_tpu_reasm_query`](<#fd_tpu_reasm_query>), [`fd_tpu_reasm_prepare`](<#fd_tpu_reasm_prepare>)), adding fragments to a slot ([`fd_tpu_reasm_frag`](<#fd_tpu_reasm_frag>)), and publishing reassembled data to a memory cache ([`fd_tpu_reasm_publish`](<#fd_tpu_reasm_publish>), [`fd_tpu_reasm_publish_fast`](<#fd_tpu_reasm_publish_fast>)). The code ensures that the reassembly process is efficient by managing slot states and using a hash map to track the status of each slot. The module is intended to be used as part of a larger system where data packets are processed and reassembled before being published to a cache for further use.
# Imports and Dependencies

---
- `fd_tpu.h`
- `fd_tpu_reasm_private.h`
- `../../tango/dcache/fd_dcache.h`
- `../../tango/mcache/fd_mcache.h`


# Functions

---
### fd\_tpu\_reasm\_align<!-- {{#callable:fd_tpu_reasm_align}} -->
[View Source →](<../../../../../src/disco/quic/fd_tpu_reasm.c#L6>)

Returns the alignment requirement of the `fd_tpu_reasm_t` type.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls the `alignof` operator on the `fd_tpu_reasm_t` type to determine its alignment requirement.
    - Returns the result of the `alignof` operation.
- **Output**: The alignment requirement of the `fd_tpu_reasm_t` type as an `ulong`.


---
### fd\_tpu\_reasm\_footprint<!-- {{#callable:fd_tpu_reasm_footprint}} -->
[View Source →](<../../../../../src/disco/quic/fd_tpu_reasm.c#L11>)

Calculates the memory footprint required for TPU reassembly based on given depth and burst values.
- **Inputs**:
    - `depth`: The depth of the TPU reassembly, which must be a power of two and less than or equal to 0x7fffffffUL.
    - `burst`: The burst size for the TPU reassembly, which must be at least 2 and less than or equal to 0x7fffffffUL.
- **Logic and Control Flow**:
    - Check if `depth` is a power of two, `depth` is less than or equal to 0x7fffffffUL, `burst` is at least 2, and `burst` is less than or equal to 0x7fffffffUL; if any condition fails, return 0UL.
    - Calculate `slot_cnt` as the sum of `depth` and `burst`.
    - Estimate `chain_cnt` using `fd_tpu_reasm_map_chain_cnt_est` with `slot_cnt`.
    - Calculate the memory footprint using a series of `FD_LAYOUT_APPEND` calls to append various components to the layout, including headers, public slots, slots, and map, and finalize the layout with `FD_LAYOUT_FINI`.
- **Output**: Returns the calculated memory footprint as an unsigned long integer, or 0UL if input validation fails.
- **Functions Called**:
    - [`fd_tpu_reasm_align`](<#fd_tpu_reasm_align>)


---
### fd\_tpu\_reasm\_new<!-- {{#callable:fd_tpu_reasm_new}} -->
[View Source →](<../../../../../src/disco/quic/fd_tpu_reasm.c#L33>)

Allocates and initializes a new TPU reassembly object in shared memory.
- **Inputs**:
    - ``shmem``: Pointer to the shared memory where the reassembly object will be created.
    - ``depth``: The depth of the reassembly buffer, representing the number of slots for public data.
    - ``burst``: The burst size, representing the number of additional slots for temporary data.
    - ``orig``: The origin identifier, which must not exceed `FD_FRAG_META_ORIG_MAX`.
    - ``dcache``: Pointer to the data cache used by the reassembly object.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL or not aligned to `FD_TPU_REASM_ALIGN`, returning NULL if true.
    - Verify the footprint of the reassembly object with [`fd_tpu_reasm_footprint`](<#fd_tpu_reasm_footprint>), returning NULL if invalid.
    - Ensure `orig` does not exceed `FD_FRAG_META_ORIG_MAX`, returning NULL if it does.
    - Calculate the required data size with [`fd_tpu_reasm_req_data_sz`](<fd_tpu.h.md#fd_tpu_reasm_req_data_sz>) and check if `dcache` has sufficient size, logging a warning and returning NULL if not.
    - Calculate `slot_cnt` as the sum of `depth` and `burst`, returning NULL if zero.
    - Estimate `chain_cnt` using `fd_tpu_reasm_map_chain_cnt_est`.
    - Initialize memory layout using `FD_SCRATCH_ALLOC_INIT` and `FD_SCRATCH_ALLOC_APPEND` for `reasm`, `pub_slots`, `slots`, and `map_mem`.
    - Zero out memory for `reasm` and `slots` using `fd_memset`.
    - Create and join a new map with `fd_tpu_reasm_map_new` and `fd_tpu_reasm_map_join`, logging a warning and returning NULL if it fails.
    - Set offsets and properties in the `reasm` object, including `slots_off`, `pub_slots_off`, `map_off`, `dcache`, `depth`, `burst`, `head`, `tail`, `slot_cnt`, and `orig`.
    - Reset the reassembly object with [`fd_tpu_reasm_reset`](<#fd_tpu_reasm_reset>).
    - Set the `magic` field to `FD_TPU_REASM_MAGIC` with memory fences before and after.
    - Return the initialized `reasm` object.
- **Output**: Returns a pointer to the newly created `fd_tpu_reasm_t` object, or NULL if any validation or allocation fails.
- **Functions Called**:
    - [`fd_tpu_reasm_footprint`](<#fd_tpu_reasm_footprint>)
    - [`fd_tpu_reasm_req_data_sz`](<fd_tpu.h.md#fd_tpu_reasm_req_data_sz>)
    - [`fd_tpu_reasm_align`](<#fd_tpu_reasm_align>)
    - [`fd_tpu_reasm_reset`](<#fd_tpu_reasm_reset>)


---
### fd\_tpu\_reasm\_reset<!-- {{#callable:fd_tpu_reasm_reset}} -->
[View Source →](<../../../../../src/disco/quic/fd_tpu_reasm.c#L98>)

Resets the state of a TPU reassembly structure by initializing slots and clearing the hash map.
- **Inputs**:
    - `reasm`: A pointer to an `fd_tpu_reasm_t` structure that represents the TPU reassembly context to reset.
- **Logic and Control Flow**:
    - Retrieve `depth`, `burst`, and calculate `node_cnt` from the `reasm` structure.
    - Get pointers to the slots, public slots, and map using helper functions.
    - Initialize the first `depth` slots to the `FD_TPU_REASM_STATE_PUB` state and set their attributes to default values.
    - Store the indices of these slots in the `pub_slots` array.
    - Initialize the remaining slots to the `FD_TPU_REASM_STATE_FREE` state and set their attributes, including `lru_prev` and `lru_next`, using conditional logic.
    - Clear the hash map by setting all chain entries to `UINT_MAX`.
- **Output**: No return value; the function modifies the `reasm` structure in place.
- **Functions Called**:
    - [`fd_tpu_reasm_slots_laddr`](<fd_tpu.h.md#fd_tpu_reasm_slots_laddr>)
    - [`fd_tpu_reasm_pub_slots_laddr`](<fd_tpu.h.md#fd_tpu_reasm_pub_slots_laddr>)


---
### fd\_tpu\_reasm\_join<!-- {{#callable:fd_tpu_reasm_join}} -->
[View Source →](<../../../../../src/disco/quic/fd_tpu_reasm.c#L141>)

Validates the magic number of a `fd_tpu_reasm_t` structure and returns the structure if valid.
- **Inputs**:
    - `shreasm`: A pointer to a `fd_tpu_reasm_t` structure that needs validation.
- **Logic and Control Flow**:
    - Cast `shreasm` to a `fd_tpu_reasm_t` pointer and assign it to `reasm`.
    - Check if the `magic` field of `reasm` is not equal to `FD_TPU_REASM_MAGIC`.
    - If the `magic` field is invalid, log a warning message and return `NULL`.
    - If the `magic` field is valid, return the `reasm` pointer.
- **Output**: Returns a pointer to the `fd_tpu_reasm_t` structure if the magic number is valid, otherwise returns `NULL`.


---
### fd\_tpu\_reasm\_leave<!-- {{#callable:fd_tpu_reasm_leave}} -->
[View Source →](<../../../../../src/disco/quic/fd_tpu_reasm.c#L151>)

Returns the input `fd_tpu_reasm_t` pointer without modification.
- **Inputs**:
    - `reasm`: A pointer to an `fd_tpu_reasm_t` structure.
- **Logic and Control Flow**:
    - The function takes a single input parameter `reasm`, which is a pointer to an `fd_tpu_reasm_t` structure.
    - It returns the same pointer `reasm` without any modification or additional processing.
- **Output**: A pointer to the `fd_tpu_reasm_t` structure passed as input.


---
### fd\_tpu\_reasm\_delete<!-- {{#callable:fd_tpu_reasm_delete}} -->
[View Source →](<../../../../../src/disco/quic/fd_tpu_reasm.c#L156>)

Resets the `magic` field of a `fd_tpu_reasm_t` structure to zero and returns the input pointer.
- **Inputs**:
    - `shreasm`: A pointer to a `fd_tpu_reasm_t` structure that will be modified.
- **Logic and Control Flow**:
    - Check if `shreasm` is NULL using `FD_UNLIKELY`; if true, return NULL.
    - Set the `magic` field of the `fd_tpu_reasm_t` structure to 0UL.
    - Return the input pointer `shreasm`.
- **Output**: Returns the input pointer `shreasm`, or NULL if `shreasm` is NULL.


---
### fd\_tpu\_reasm\_query<!-- {{#callable:fd_tpu_reasm_query}} -->
[View Source →](<../../../../../src/disco/quic/fd_tpu_reasm.c#L164>)

Queries a reassembly map for a slot associated with a given connection UID and stream ID.
- **Inputs**:
    - `reasm`: A pointer to the reassembly structure (`fd_tpu_reasm_t`) to query.
    - `conn_uid`: The connection unique identifier (`ulong`) to query in the reassembly map.
    - `stream_id`: The stream identifier (`ulong`) to query in the reassembly map.
- **Logic and Control Flow**:
    - Calls the `smap_query` function with the provided `reasm`, `conn_uid`, and `stream_id` as arguments.
    - Returns the result of the `smap_query` function call.
- **Output**: Returns a pointer to an `fd_tpu_reasm_slot_t` structure if the query is successful, or `NULL` if not.


---
### fd\_tpu\_reasm\_prepare<!-- {{#callable:fd_tpu_reasm_prepare}} -->
[View Source →](<../../../../../src/disco/quic/fd_tpu_reasm.c#L171>)

Prepares a reassembly slot for a new connection and stream, updating its metadata and position in the queue.
- **Inputs**:
    - ``reasm``: A pointer to the `fd_tpu_reasm_t` structure representing the reassembly context.
    - ``conn_uid``: An unsigned long integer representing the connection unique identifier.
    - ``stream_id``: An unsigned long integer representing the stream identifier.
    - ``tsorig``: A long integer representing the original timestamp.
- **Logic and Control Flow**:
    - Pop the tail slot from the reassembly queue using `slotq_pop_tail` and assign it to `slot`.
    - Remove the slot from the reassembly map using [`smap_remove`](<fd_tpu_reasm_private.h.md#smap_remove>).
    - Initialize the slot using [`slot_begin`](<fd_tpu_reasm_private.h.md#slot_begin>).
    - Push the slot to the head of the reassembly queue using [`slotq_push_head`](<fd_tpu_reasm_private.h.md#slotq_push_head>).
    - Set the slot's connection UID to `conn_uid`.
    - Set the slot's stream ID to `stream_id` masked with `FD_TPU_REASM_SID_MASK`.
    - Insert the slot back into the reassembly map using [`smap_insert`](<fd_tpu_reasm_private.h.md#smap_insert>).
    - Compute the compressed timestamp using `fd_frag_meta_ts_comp` and assign it to `slot->tsorig_comp`.
    - Return the prepared slot.
- **Output**: Returns a pointer to the prepared `fd_tpu_reasm_slot_t` structure.
- **Functions Called**:
    - [`smap_remove`](<fd_tpu_reasm_private.h.md#smap_remove>)
    - [`slot_begin`](<fd_tpu_reasm_private.h.md#slot_begin>)
    - [`slotq_push_head`](<fd_tpu_reasm_private.h.md#slotq_push_head>)
    - [`smap_insert`](<fd_tpu_reasm_private.h.md#smap_insert>)


---
### fd\_tpu\_reasm\_frag<!-- {{#callable:fd_tpu_reasm_frag}} -->
[View Source →](<../../../../../src/disco/quic/fd_tpu_reasm.c#L187>)

Processes a fragment of data for reassembly in a specified slot.
- **Inputs**:
    - ``reasm``: A pointer to the reassembly context (`fd_tpu_reasm_t`).
    - ``slot``: A pointer to the reassembly slot (`fd_tpu_reasm_slot_t`) where the fragment will be processed.
    - ``data``: A pointer to the data fragment to be reassembled.
    - ``data_sz``: The size of the data fragment in bytes.
    - ``data_off``: The offset in bytes from the start of the reassembled message where the data fragment should be placed.
- **Logic and Control Flow**:
    - Check if the slot's state is `FD_TPU_REASM_STATE_BUSY`; if not, return `FD_TPU_REASM_ERR_STATE`.
    - Calculate the slot index and retrieve the maximum transmission unit (`mtu`) and current size (`sz0`) of the slot.
    - If `data_off` is greater than `sz0`, cancel the reassembly for the slot and return `FD_TPU_REASM_ERR_SKIP`.
    - If `data_off` is less than `sz0`, adjust `data_off`, `data_sz`, and `data` to skip already known data.
    - Calculate the new size `sz1` as `sz0 + data_sz`; if `sz1` is less than `sz0` or greater than `mtu`, cancel the reassembly and return `FD_TPU_REASM_ERR_SZ`.
    - Copy the data fragment into the slot's message buffer at the offset `sz0`.
    - Update the slot's size to `sz1` and return `FD_TPU_REASM_SUCCESS`.
- **Output**: Returns an integer status code indicating success or the type of error encountered.
- **Functions Called**:
    - [`slot_get_idx`](<fd_tpu_reasm_private.h.md#slot_get_idx>)
    - [`fd_tpu_reasm_cancel`](<#fd_tpu_reasm_cancel>)
    - [`slot_get_data_pkt_payload`](<fd_tpu_reasm_private.h.md#slot_get_data_pkt_payload>)


---
### fd\_tpu\_reasm\_publish<!-- {{#callable:fd_tpu_reasm_publish}} -->
[View Source →](<../../../../../src/disco/quic/fd_tpu_reasm.c#L228>)

Publishes a reassembled transaction to the memory cache and manages slot states in the TPU reassembly process.
- **Inputs**:
    - `reasm`: A pointer to the `fd_tpu_reasm_t` structure representing the TPU reassembly context.
    - `slot`: A pointer to the `fd_tpu_reasm_slot_t` structure representing the slot to be published.
    - `mcache`: A pointer to the `fd_frag_meta_t` structure representing the memory cache where the transaction will be published.
    - `base`: A pointer to the base address, assumed to be aligned to `FD_CHUNK_ALIGN`.
    - `seq`: An unsigned long integer representing the sequence number for the transaction.
    - `tspub`: A long integer representing the publication timestamp.
    - `source_ipv4`: An unsigned integer representing the source IPv4 address.
    - `source_tpu`: An unsigned char representing the source TPU identifier.
- **Logic and Control Flow**:
    - Check if the slot state is `FD_TPU_REASM_STATE_BUSY`; if not, return `FD_TPU_REASM_ERR_STATE`.
    - Calculate the chunk index from the base and buffer addresses; log a critical error if the base is invalid.
    - Determine the least recently published slot to free; log a warning and reset if the slot index is out of bounds.
    - Prepare the transaction metadata and publish it to the memory cache using the appropriate method based on available instruction sets (AVX, SSE, or none).
    - Update the slot state to `FD_TPU_REASM_STATE_PUB` and mark it as published.
    - Free the oldest published slot and update its state to `FD_TPU_REASM_STATE_FREE`; log a warning and reset if the slot state is inconsistent.
- **Output**: Returns `FD_TPU_REASM_SUCCESS` on successful publication, or an error code such as `FD_TPU_REASM_ERR_STATE` if an error occurs.
- **Functions Called**:
    - [`slot_get_idx`](<fd_tpu_reasm_private.h.md#slot_get_idx>)
    - [`slot_get_data`](<fd_tpu_reasm_private.h.md#slot_get_data>)
    - [`fd_tpu_reasm_pub_slots_laddr`](<fd_tpu.h.md#fd_tpu_reasm_pub_slots_laddr>)
    - [`fd_tpu_reasm_reset`](<#fd_tpu_reasm_reset>)
    - [`slotq_remove`](<fd_tpu_reasm_private.h.md#slotq_remove>)
    - [`fd_tpu_reasm_slots_laddr`](<fd_tpu.h.md#fd_tpu_reasm_slots_laddr>)
    - [`slotq_push_tail`](<fd_tpu_reasm_private.h.md#slotq_push_tail>)


---
### fd\_tpu\_reasm\_cancel<!-- {{#callable:fd_tpu_reasm_cancel}} -->
[View Source →](<../../../../../src/disco/quic/fd_tpu_reasm.c#L307>)

Cancels a reassembly operation for a given slot if it is in a busy state.
- **Inputs**:
    - ``reasm``: A pointer to the `fd_tpu_reasm_t` structure representing the reassembly context.
    - ``slot``: A pointer to the `fd_tpu_reasm_slot_t` structure representing the slot to be canceled.
- **Logic and Control Flow**:
    - Checks if the slot's state is not `FD_TPU_REASM_STATE_BUSY`; if true, exits the function.
    - Removes the slot from the slot queue using [`slotq_remove`](<fd_tpu_reasm_private.h.md#slotq_remove>).
    - Removes the slot from the slot map using [`smap_remove`](<fd_tpu_reasm_private.h.md#smap_remove>).
    - Sets the slot's state to `FD_TPU_REASM_STATE_FREE`.
    - Resets the slot's `conn_uid` to `ULONG_MAX` and `stream_id` to `0UL`.
    - Pushes the slot to the tail of the slot queue using [`slotq_push_tail`](<fd_tpu_reasm_private.h.md#slotq_push_tail>).
- **Output**: No return value; the function operates directly on the provided slot and reassembly context.
- **Functions Called**:
    - [`slotq_remove`](<fd_tpu_reasm_private.h.md#slotq_remove>)
    - [`smap_remove`](<fd_tpu_reasm_private.h.md#smap_remove>)
    - [`slotq_push_tail`](<fd_tpu_reasm_private.h.md#slotq_push_tail>)


---
### fd\_tpu\_reasm\_publish\_fast<!-- {{#callable:fd_tpu_reasm_publish_fast}} -->
[View Source →](<../../../../../src/disco/quic/fd_tpu_reasm.c#L319>)

Publishes a new data slot in the reassembly structure and frees the least recently published slot.
- **Inputs**:
    - `reasm`: Pointer to the reassembly structure.
    - `data`: Pointer to the data to be published.
    - `sz`: Size of the data to be published.
    - `mcache`: Pointer to the metadata cache.
    - `base`: Base address for chunk alignment.
    - `seq`: Sequence number for the data.
    - `tspub`: Timestamp for when the data is published.
    - `source_ipv4`: Source IPv4 address of the data.
    - `source_tpu`: Source TPU identifier of the data.
- **Logic and Control Flow**:
    - Check if the size of the data exceeds the maximum transmission unit (`FD_TPU_REASM_MTU`).
    - Acquire the least recent slot from the reassembly structure and prepare it for new data.
    - Calculate the buffer address for the new slot and verify its validity.
    - Identify the least recently published slot to be freed.
    - Copy the data into the new slot and update its metadata.
    - Publish the new slot by updating the metadata cache and freeing the old slot.
    - Check for memory corruption and reset the reassembly structure if detected.
    - Return success or error code based on the operation outcome.
- **Output**: Returns an integer status code indicating success or specific error conditions.
- **Functions Called**:
    - [`smap_remove`](<fd_tpu_reasm_private.h.md#smap_remove>)
    - [`slot_begin`](<fd_tpu_reasm_private.h.md#slot_begin>)
    - [`slot_get_idx`](<fd_tpu_reasm_private.h.md#slot_get_idx>)
    - [`slot_get_data`](<fd_tpu_reasm_private.h.md#slot_get_data>)
    - [`fd_tpu_reasm_pub_slots_laddr`](<fd_tpu.h.md#fd_tpu_reasm_pub_slots_laddr>)
    - [`fd_tpu_reasm_reset`](<#fd_tpu_reasm_reset>)
    - [`fd_tpu_reasm_slots_laddr`](<fd_tpu.h.md#fd_tpu_reasm_slots_laddr>)
    - [`slotq_push_tail`](<fd_tpu_reasm_private.h.md#slotq_push_tail>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)