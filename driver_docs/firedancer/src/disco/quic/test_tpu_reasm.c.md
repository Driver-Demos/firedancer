<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for the TPU reassembly functionality, including state verification and memory management.

# Purpose
The code is a C program that tests the functionality of a transaction processing unit (TPU) reassembly system. It includes the main function and a helper function [`verify_state`](<#verify_state>) to check the integrity of the reassembly state. The program imports necessary headers and a binary transaction fixture, `transaction4`, for testing purposes. The [`verify_state`](<#verify_state>) function ensures that the data structures maintain their invariants, such as checking for invalid states, duplicates, and the correct order of slots in the queue. The main function initializes various components, including random number generators, memory caches, and the TPU reassembly system. It performs a series of tests to validate the reassembly system's behavior under different conditions, such as acquiring, publishing, and canceling slots.

The program is structured to test the TPU reassembly system's ability to handle transactions efficiently and correctly. It verifies that the system can manage memory and state transitions properly, ensuring that slots are correctly acquired, published, and released. The code uses macros and logging to facilitate debugging and ensure that the system behaves as expected. The tests cover various scenarios, including invalid parameter handling, memory boundary checks, and the correct functioning of the reassembly system under stress conditions. The program concludes by cleaning up resources and logging the test results.
# Imports and Dependencies

---
- `fd_tpu.h`
- `fd_tpu_reasm_private.h`
- `../../tango/mcache/fd_mcache.h`
- `../../tango/dcache/fd_dcache.h`


# Functions

---
### verify\_state<!-- {{#callable:verify_state}} -->
[View Source →](<../../../../../src/disco/quic/test_tpu_reasm.c#L11>)

Validates the state of a reassembly structure by checking invariants and scanning slots for consistency.
- **Inputs**:
    - ``reasm``: A pointer to an `fd_tpu_reasm_t` structure representing the reassembly state to verify.
    - ``mcache``: A pointer to an array of `fd_frag_meta_t` structures representing the metadata cache to check for invalid states and duplicates.
- **Logic and Control Flow**:
    - Check that `reasm->slots_off` is non-zero.
    - Retrieve the local addresses of the slots and public slots using [`fd_tpu_reasm_slots_laddr`](<fd_tpu.h.md#fd_tpu_reasm_slots_laddr>) and [`fd_tpu_reasm_pub_slots_laddr`](<fd_tpu.h.md#fd_tpu_reasm_pub_slots_laddr>).
    - Initialize `depth`, `burst`, `slot_cnt`, and `free_cnt` from the `reasm` structure.
    - Verify that `depth + burst` equals `slot_cnt`, and that `reasm->head` and `reasm->tail` are within bounds.
    - Iterate over `depth` to check each fragment in `mcache` for size validity and slot index bounds, marking visited slots temporarily.
    - Reset the state of visited slots to `FD_TPU_REASM_STATE_PUB`.
    - Scan slots from `head` to `tail`, checking node bounds, queue depth, and state consistency, while counting free slots.
    - Use `smap_query` to verify busy slot lookups and optional map presence for other states.
    - Ensure the queue depth from `head` to `tail` matches `burst`.
    - Scan slots from `tail` to `head`, verifying node bounds and queue depth consistency.
    - Ensure the queue depth from `tail` to `head` matches `burst`.
- **Output**: Returns the count of free slots (`free_cnt`) in the reassembly structure.
- **Functions Called**:
    - [`fd_tpu_reasm_slots_laddr`](<fd_tpu.h.md#fd_tpu_reasm_slots_laddr>)
    - [`fd_tpu_reasm_pub_slots_laddr`](<fd_tpu.h.md#fd_tpu_reasm_pub_slots_laddr>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/disco/quic/test_tpu_reasm.c#L85>)

Initializes and tests the TPU reassembly system, including memory allocation, state verification, and transaction processing.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the system with command-line arguments.
    - Initializes a random number generator `rng` using `fd_rng_new` and `fd_rng_join`.
    - Verifies alignment of TPU reassembly using `FD_TEST` and [`fd_tpu_reasm_align`](<fd_tpu_reasm.c.md#fd_tpu_reasm_align>).
    - Tests invalid parameters for TPU reassembly footprint using [`fd_tpu_reasm_footprint`](<fd_tpu_reasm.c.md#fd_tpu_reasm_footprint>).
    - Defines constants `depth`, `burst`, and `slot_cnt` for memory allocation.
    - Allocates and initializes memory for `mcache` and `dcache` using `fd_mcache_new` and `fd_dcache_new`.
    - Creates and joins a TPU reassembly object `reasm` using [`fd_tpu_reasm_new`](<fd_tpu_reasm.c.md#fd_tpu_reasm_new>) and [`fd_tpu_reasm_join`](<fd_tpu_reasm.c.md#fd_tpu_reasm_join>).
    - Verifies the state of the reassembly system using [`verify_state`](<#verify_state>).
    - Checks memory bounds for slots and public slots in `tpu_reasm_mem`.
    - Performs a loop to publish fragments, verifying data integrity and setting slot sizes.
    - Confirms that the number of active slots matches `burst`.
    - Resets the reassembly system using [`fd_tpu_reasm_reset`](<fd_tpu_reasm.c.md#fd_tpu_reasm_reset>) and verifies state again.
    - Tests basic publishing of transactions using [`fd_tpu_reasm_frag`](<fd_tpu_reasm.c.md#fd_tpu_reasm_frag>) and [`fd_tpu_reasm_publish`](<fd_tpu_reasm.c.md#fd_tpu_reasm_publish>).
    - Prepares the reassembly system for further operations, verifying free slot count.
    - Tests canceling and publishing of slots in a loop, using random operations and verifying state.
    - Cleans up by deleting and leaving the reassembly, mcache, and RNG objects.
    - Logs a notice of successful execution and halts the system.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`fd_tpu_reasm_align`](<fd_tpu_reasm.c.md#fd_tpu_reasm_align>)
    - [`fd_tpu_reasm_footprint`](<fd_tpu_reasm.c.md#fd_tpu_reasm_footprint>)
    - [`fd_tpu_reasm_req_data_sz`](<fd_tpu.h.md#fd_tpu_reasm_req_data_sz>)
    - [`fd_tpu_reasm_join`](<fd_tpu_reasm.c.md#fd_tpu_reasm_join>)
    - [`fd_tpu_reasm_new`](<fd_tpu_reasm.c.md#fd_tpu_reasm_new>)
    - [`fd_tpu_reasm_slots_laddr`](<fd_tpu.h.md#fd_tpu_reasm_slots_laddr>)
    - [`fd_tpu_reasm_pub_slots_laddr`](<fd_tpu.h.md#fd_tpu_reasm_pub_slots_laddr>)
    - [`verify_state`](<#verify_state>)
    - [`fd_tpu_reasm_acquire`](<fd_tpu.h.md#fd_tpu_reasm_acquire>)
    - [`slot_get_idx`](<fd_tpu_reasm_private.h.md#slot_get_idx>)
    - [`slot_get_data`](<fd_tpu_reasm_private.h.md#slot_get_data>)
    - [`fd_tpu_reasm_reset`](<fd_tpu_reasm.c.md#fd_tpu_reasm_reset>)
    - [`fd_tpu_reasm_frag`](<fd_tpu_reasm.c.md#fd_tpu_reasm_frag>)
    - [`fd_tpu_reasm_publish`](<fd_tpu_reasm.c.md#fd_tpu_reasm_publish>)
    - [`fd_tpu_reasm_cancel`](<fd_tpu_reasm.c.md#fd_tpu_reasm_cancel>)
    - [`fd_tpu_reasm_delete`](<fd_tpu_reasm.c.md#fd_tpu_reasm_delete>)
    - [`fd_tpu_reasm_leave`](<fd_tpu_reasm.c.md#fd_tpu_reasm_leave>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)