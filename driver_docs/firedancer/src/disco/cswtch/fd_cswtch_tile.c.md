<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements context switch monitoring for tiles, including initialization and metric updates.

# Purpose
The code is a C source file that manages context switch metrics for a set of computational units referred to as "tiles." It includes functionality to initialize, monitor, and report on the context switches of these tiles. The file defines a structure `fd_cswtch_ctx_t` to maintain the state and metrics for each tile, including the number of voluntary and involuntary context switches. The code uses system calls to read process status information from the `/proc` filesystem, which is typical for Linux systems, to gather these metrics.

The file also defines several functions for initializing the context ([`privileged_init`](<#privileged_init>) and [`unprivileged_init`](<#unprivileged_init>)), handling context switch metrics ([`before_credit`](<#before_credit>)), and setting up security policies ([`populate_allowed_seccomp`](<#populate_allowed_seccomp>) and [`populate_allowed_fds`](<#populate_allowed_fds>)). The `fd_tile_cswtch` structure at the end of the file acts as an interface for running the context switch monitoring process, linking the initialization and execution functions together. This code is part of a larger system, as indicated by the inclusion of other modules and the use of a callback mechanism (`STEM_CALLBACK_BEFORE_CREDIT`) to integrate with a broader framework.
# Imports and Dependencies

---
- `../metrics/fd_metrics.h`
- `../stem/fd_stem.h`
- `../topo/fd_topo.h`
- `fcntl.h`
- `errno.h`
- `stdlib.h`
- `sys/types.h`
- `time.h`
- `unistd.h`
- `generated/fd_cswtch_tile_seccomp.h`
- `../../disco/stem/fd_stem.c`


# Global Variables

---
### fd\_tile\_cswtch
- **Type**: ``fd_topo_run_tile_t``
- **Description**: Defines a tile configuration for running a context switch monitoring process. It includes function pointers for initialization, resource allocation, and execution of the tile.
- **Use**: Used to configure and manage the execution of a context switch monitoring tile in a topology.


# Data Structures

---
### fd\_cswtch\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``next_report_nanos``: Stores the time in nanoseconds for the next report.
    - ``tile_cnt``: Holds the count of tiles being monitored.
    - ``first_seen_died``: Records the first time a tile is detected as dead.
    - ``status_fds``: Contains file descriptors for the status of each tile.
    - ``metrics``: Points to metrics data for each tile.
- **Description**: Manages context switch metrics for a set of tiles, tracking the status and metrics of each tile, and scheduling reports at specified intervals.


# Functions

---
### scratch\_align<!-- {{#callable:scratch_align}} -->
[View Source →](<../../../../../src/disco/cswtch/fd_cswtch_tile.c#L25>)

Returns a constant alignment value of 128.
- **Inputs**: None
- **Logic and Control Flow**:
    - The function does not take any input parameters.
    - It directly returns the constant value `128UL`.
- **Output**: A constant unsigned long integer value of 128.


---
### scratch\_footprint<!-- {{#callable:scratch_footprint}} -->
[View Source →](<../../../../../src/disco/cswtch/fd_cswtch_tile.c#L30>)

Calculates the memory footprint required for a scratch space aligned to the context switch context structure.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure, which is not used in the function.
- **Logic and Control Flow**:
    - Initialize a variable `l` with `FD_LAYOUT_INIT`.
    - Append the alignment and size of `fd_cswtch_ctx_t` to `l` using `FD_LAYOUT_APPEND`.
    - Finalize the layout with `FD_LAYOUT_FINI`, using the alignment value from `scratch_align()`.
- **Output**: Returns an `ulong` representing the calculated memory footprint for the scratch space.
- **Functions Called**:
    - [`scratch_align`](<#scratch_align>)


---
### before\_credit<!-- {{#callable:before_credit}} -->
[View Source →](<../../../../../src/disco/cswtch/fd_cswtch_tile.c#L38>)

Monitors and updates context switch metrics for a set of tiles, handling process status and timing for reporting.
- **Inputs**:
    - ``ctx``: A pointer to `fd_cswtch_ctx_t` structure containing context switch monitoring data and metrics.
    - ``stem``: A pointer to `fd_stem_context_t` structure, which is not used in this function.
    - ``charge_busy``: A pointer to an integer that will be set to 1 if the function performs any processing.
- **Logic and Control Flow**:
    - Get the current time using `fd_log_wallclock()` and compare it with `ctx->next_report_nanos` to determine if a report is due.
    - If the current time is less than `ctx->next_report_nanos`, calculate the sleep duration and call `clock_nanosleep()` to wait before returning.
    - Update `ctx->next_report_nanos` by adding the report interval in nanoseconds.
    - Set `*charge_busy` to 1 to indicate processing has occurred.
    - Iterate over each tile in `ctx->tile_cnt` and reset the file descriptor position using `lseek()`.
    - Read the status file for each tile into a buffer, handling errors and checking for process termination.
    - If a process has died, check if it is allowed to shut down and update metrics accordingly.
    - If a process has died and is not allowed to shut down, log a warning if it has been dead for more than 10 seconds.
    - Parse the status file contents to extract voluntary and involuntary context switch counts, updating the metrics in `ctx`.
    - Log errors if expected context switch metrics are not found in the status file.
- **Output**: No return value; updates the `ctx` structure and `charge_busy` flag, and logs errors or warnings as needed.


---
### privileged\_init<!-- {{#callable:privileged_init}} -->
[View Source →](<../../../../../src/disco/cswtch/fd_cswtch_tile.c#L142>)

Initializes context for privileged operations by setting up status file descriptors and metrics for each tile in the topology.
- **Inputs**:
    - ``topo``: A pointer to an `fd_topo_t` structure representing the topology of tiles.
    - ``tile``: A pointer to an `fd_topo_tile_t` structure representing the specific tile to initialize.
- **Logic and Control Flow**:
    - Obtain a scratch memory address using `fd_topo_obj_laddr` with `topo` and `tile->tile_obj_id`.
    - Initialize scratch allocation with `FD_SCRATCH_ALLOC_INIT`.
    - Allocate memory for `fd_cswtch_ctx_t` using `FD_SCRATCH_ALLOC_APPEND`.
    - Check if the number of tiles in `topo` is less than `FD_TILE_MAX` using `FD_TEST`.
    - Set `ctx->tile_cnt` to `topo->tile_cnt`.
    - Iterate over each tile in `topo` using a loop from 0 to `topo->tile_cnt`.
    - For each tile, join metrics using `fd_metrics_join` and `fd_topo_obj_laddr`.
    - In a loop, determine `pid` and `tid` for the current tile; if the current tile matches `tile->id`, use `fd_sandbox_getpid` and `fd_sandbox_gettid`, otherwise use `fd_metrics_tile`.
    - If `pid` or `tid` is zero, pause and retry using `FD_SPIN_PAUSE`.
    - Format the path to the status file using `fd_cstr_printf_check`.
    - Open the status file and store the file descriptor in `ctx->status_fds[i]`.
    - Store the metrics pointer in `ctx->metrics[i]`.
    - If opening the status file fails, log an error using `FD_LOG_ERR`.
- **Output**: No return value; the function modifies the `ctx` structure to store file descriptors and metrics pointers for each tile.


---
### unprivileged\_init<!-- {{#callable:unprivileged_init}} -->
[View Source →](<../../../../../src/disco/cswtch/fd_cswtch_tile.c#L180>)

Initializes an unprivileged context for a tile in a topology by setting up scratch memory and context switch metrics.
- **Inputs**:
    - `topo`: A pointer to an `fd_topo_t` structure representing the topology.
    - `tile`: A pointer to an `fd_topo_tile_t` structure representing the tile to initialize.
- **Logic and Control Flow**:
    - Obtain a local address for the tile's object using `fd_topo_obj_laddr` and store it in `scratch`.
    - Initialize scratch memory allocation with `FD_SCRATCH_ALLOC_INIT`.
    - Allocate memory for a `fd_cswtch_ctx_t` context structure using `FD_SCRATCH_ALLOC_APPEND`.
    - Set all elements of `ctx->first_seen_died` to zero using `memset`.
    - Set `ctx->next_report_nanos` to the current wall clock time using `fd_log_wallclock`.
    - Finalize the scratch memory allocation with `FD_SCRATCH_ALLOC_FINI` and store the result in `scratch_top`.
    - Check if `scratch_top` exceeds the allowed footprint using [`scratch_footprint`](<#scratch_footprint>), and log an error if it does.
- **Output**: No return value; the function initializes the context for the tile.
- **Functions Called**:
    - [`scratch_footprint`](<#scratch_footprint>)


---
### populate\_allowed\_seccomp<!-- {{#callable:populate_allowed_seccomp}} -->
[View Source →](<../../../../../src/disco/cswtch/fd_cswtch_tile.c#L196>)

Populates a `sock_filter` array with a seccomp policy for a tile and returns the instruction count.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, which is not used in this function.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure, which is not used in this function.
    - ``out_cnt``: An unsigned long integer representing the number of elements in the `out` array.
    - ``out``: A pointer to an array of `sock_filter` structures where the seccomp policy will be populated.
- **Logic and Control Flow**:
    - Ignore the `topo` and `tile` input parameters as they are not used in the function.
    - Call the [`populate_sock_filter_policy_fd_cswtch_tile`](<generated/fd_cswtch_tile_seccomp.h.md#populate_sock_filter_policy_fd_cswtch_tile>) function with `out_cnt`, `out`, and the file descriptor obtained from `fd_log_private_logfile_fd()`.
    - Return the value of `sock_filter_policy_fd_cswtch_tile_instr_cnt`.
- **Output**: Returns an unsigned long integer representing the number of instructions in the seccomp policy.
- **Functions Called**:
    - [`populate_sock_filter_policy_fd_cswtch_tile`](<generated/fd_cswtch_tile_seccomp.h.md#populate_sock_filter_policy_fd_cswtch_tile>)


---
### populate\_allowed\_fds<!-- {{#callable:populate_allowed_fds}} -->
[View Source →](<../../../../../src/disco/cswtch/fd_cswtch_tile.c#L208>)

Populates an array with file descriptors for stderr, a logfile, and status descriptors for each tile.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure representing the topology.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure representing the tile.
    - ``out_fds_cnt``: The maximum number of file descriptors that can be stored in `out_fds`.
    - ``out_fds``: An array where the function will store the allowed file descriptors.
- **Logic and Control Flow**:
    - Allocate scratch memory for the context using `fd_topo_obj_laddr` and `FD_SCRATCH_ALLOC_APPEND`.
    - Check if `out_fds_cnt` is less than the required number of file descriptors (2 plus the number of tiles in the context). If so, log an error.
    - Initialize `out_cnt` to 0 and set `out_fds[0]` to 2 (stderr).
    - If the logfile file descriptor is valid, add it to `out_fds` and increment `out_cnt`.
    - Iterate over each tile in the context and add its status file descriptor to `out_fds`, incrementing `out_cnt` for each.
- **Output**: Returns the number of file descriptors added to `out_fds`.



---
Made with ❤️ by [Driver](https://www.driver.ai/)