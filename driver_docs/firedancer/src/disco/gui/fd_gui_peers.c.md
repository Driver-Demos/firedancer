<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for managing peer connections and gossip message handling in a GUI context, including alignment, footprint calculation, and WebSocket communication.

# Purpose
The code is a C module that manages peer connections and their associated data in a networked environment. It provides functionality for aligning memory, calculating memory footprints, and managing shared memory for peer data structures. The module includes functions to create, join, and manage peer contexts, which are used to track and update information about network peers, such as their connection status, bandwidth usage, and gossip statistics.

The module defines several functions for handling WebSocket connections, processing gossip messages, and updating peer information based on received data. It includes mechanisms for sorting and filtering peer data, as well as broadcasting updates to connected clients. The code also manages the allocation and deallocation of resources for peer data structures, ensuring that memory is aligned and properly sized for efficient access. Additionally, the module provides functions for logging and debugging, allowing developers to monitor the state of peer connections and the data being exchanged.
# Imports and Dependencies

---
- `fd_gui_peers.h`
- `fd_gui_printf.h`
- `../../ballet/json/cJSON.h`
- `../../flamenco/gossip/fd_gossip_private.h`
- `../../util/tmpl/fd_sort.c`


# Functions

---
### fd\_gui\_peers\_align<!-- {{#callable:fd_gui_peers_align}} -->
[View Source →](<../../../../../src/disco/gui/fd_gui_peers.c#L9>)

Determines the maximum alignment requirement among several components and ensures it is a power of two.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize `a` to 128UL.
    - Update `a` to the maximum of its current value and the alignment of `fd_gui_peers_ctx_t`.
    - Update `a` to the maximum of its current value and the alignment returned by `fd_gui_peers_live_table_align()`.
    - Update `a` to the maximum of its current value and the alignment returned by `fd_gui_peers_bandwidth_tracking_align()`.
    - Update `a` to the maximum of its current value and the alignment returned by `fd_gui_peers_node_pubkey_map_align()`.
    - Update `a` to the maximum of its current value and the alignment returned by `fd_gui_peers_node_sock_map_align()`.
    - Update `a` to the maximum of its current value and the alignment of `fd_gui_peers_ws_conn_t`.
    - Assert that `a` is a power of two using `FD_TEST`.
    - Return `a`.
- **Output**: Returns the maximum alignment requirement as an unsigned long integer.


---
### fd\_gui\_peers\_footprint<!-- {{#callable:fd_gui_peers_footprint}} -->
[View Source →](<../../../../../src/disco/gui/fd_gui_peers.c#L22>)

Calculates the memory footprint required for GUI peers based on the maximum number of WebSocket connections.
- **Inputs**:
    - `max_ws_conn_cnt`: The maximum number of WebSocket connections to consider for the footprint calculation.
- **Logic and Control Flow**:
    - Estimate the number of chains for the node public key map and socket map using `fd_gui_peers_node_pubkey_map_chain_cnt_est` and `fd_gui_peers_node_sock_map_chain_cnt_est` with `FD_CONTACT_INFO_TABLE_SIZE`.
    - Initialize the layout with `FD_LAYOUT_INIT`.
    - Append the size and alignment of `fd_gui_peers_ctx_t` to the layout using `FD_LAYOUT_APPEND`.
    - Append the alignment and footprint of the live table, bandwidth tracking, node public key map, and node socket map to the layout using `FD_LAYOUT_APPEND`.
    - Append the size for the WebSocket connections to the layout using `FD_LAYOUT_APPEND`.
    - Finalize the layout with `FD_LAYOUT_FINI` and return the calculated footprint.
- **Output**: Returns the calculated memory footprint as an unsigned long integer.
- **Functions Called**:
    - [`fd_gui_peers_align`](<#fd_gui_peers_align>)


---
### fd\_gui\_peers\_new<!-- {{#callable:fd_gui_peers_new}} -->
[View Source →](<../../../../../src/disco/gui/fd_gui_peers.c#L38>)

Initializes a new GUI peers context using shared memory and sets up various data structures for managing WebSocket connections and peer information.
- **Inputs**:
    - ``shmem``: Pointer to shared memory used for allocation and storage of the context and related data structures.
    - ``http``: Pointer to an `fd_http_server_t` structure representing the HTTP server associated with the GUI peers.
    - ``topo``: Pointer to an `fd_topo_t` structure representing the network topology information.
    - ``max_ws_conn_cnt``: Maximum number of WebSocket connections that can be managed by the context.
    - ``now``: Current time in nanoseconds, used to initialize timing-related fields in the context.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL or misaligned; log a warning and return NULL if so.
    - Estimate the number of chains for public key and socket maps based on `FD_CONTACT_INFO_TABLE_SIZE`.
    - Initialize scratch memory allocation using `shmem`.
    - Allocate memory for the context and various data structures such as live table, bandwidth tracking, public key map, and socket map.
    - Initialize the `client_viewports` array with `max_ws_conn_cnt` elements, setting each `connected` field to 0.
    - Set the `http`, `topo`, `max_ws_conn_cnt`, `open_ws_conn_cnt`, and `active_ws_conn_id` fields in the context.
    - Initialize timing fields `next_client_nanos`, `next_metric_rate_update_nanos`, and `next_gossip_stats_update_nanos` with `now`.
    - Zero out the `gossip_stats` structure and mark all entries in `contact_info_table` as invalid.
    - Create and join new instances of live table, bandwidth tracking, public key map, and socket map, seeding them with initial values.
    - Return the `shmem` pointer.
- **Output**: Returns the `shmem` pointer if successful, or NULL if there is an error with the input `shmem`.
- **Functions Called**:
    - [`fd_gui_peers_align`](<#fd_gui_peers_align>)


---
### fd\_gui\_peers\_join<!-- {{#callable:fd_gui_peers_join}} -->
[View Source →](<../../../../../src/disco/gui/fd_gui_peers.c#L93>)

Validates and returns a pointer to a `fd_gui_peers_ctx_t` structure from shared memory if the memory is non-null and properly aligned.
- **Inputs**:
    - `shmem`: A pointer to shared memory that is expected to contain a `fd_gui_peers_ctx_t` structure.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL; if so, log a warning and return NULL.
    - Check if `shmem` is aligned according to `fd_gui_peers_align()`; if not, log a warning and return NULL.
    - Cast `shmem` to a `fd_gui_peers_ctx_t` pointer and return it.
- **Output**: A pointer to a `fd_gui_peers_ctx_t` structure if successful, otherwise NULL.
- **Functions Called**:
    - [`fd_gui_peers_align`](<#fd_gui_peers_align>)


---
### fd\_gui\_sum\_tiles\_counter<!-- {{#callable:fd_gui_sum_tiles_counter}} -->
[View Source →](<../../../../../src/disco/gui/fd_gui_peers.c#L110>)

Calculates the sum of a specific metric for tiles with a given name in a topology.
- **Inputs**:
    - ``peers``: A pointer to a `fd_gui_peers_ctx_t` structure that contains the topology information.
    - ``name``: A constant character pointer representing the name of the tiles to match.
    - ``tile_cnt``: An unsigned long integer representing the maximum number of tiles to consider.
    - ``metric_idx``: An unsigned long integer representing the index of the metric to sum.
- **Logic and Control Flow**:
    - Initialize `total` to 0.
    - Iterate over each tile in the topology using a loop from 0 to `peers->topo->tile_cnt`.
    - For each tile, check if the tile's name matches the given `name` using `strcmp`.
    - If a match is found, verify that the tile's `kind_id` is less than `tile_cnt` using `FD_TEST`.
    - Retrieve the tile's metrics using `fd_metrics_tile` and add the metric at `metric_idx` to `total`.
    - Return the accumulated `total`.
- **Output**: Returns the sum of the specified metric for all matching tiles as an unsigned long integer.


---
### fd\_gui\_peers\_gossip\_stats\_snap<!-- {{#callable:fd_gui_peers_gossip_stats_snap}} -->
[View Source →](<../../../../../src/disco/gui/fd_gui_peers.c#L127>)

Captures and updates various network and storage statistics for gossip peers.
- **Inputs**:
    - ``peers``: A pointer to the `fd_gui_peers_ctx_t` structure, which contains context information about the peers.
    - ``gossip_stats``: A pointer to the `fd_gui_peers_gossip_stats_t` structure, which will be updated with the latest gossip statistics.
    - ``now``: A long integer representing the current time, used to timestamp the statistics.
- **Logic and Control Flow**:
    - Set the `sample_time` in `gossip_stats` to the current time `now`.
    - Calculate the number of tiles for 'gossvf' and 'gossip' using `fd_topo_tile_name_cnt`.
    - Update various network health statistics by summing counters from tiles using [`fd_gui_sum_tiles_counter`](<#fd_gui_sum_tiles_counter>).
    - Initialize `network_health_total_stake` and `network_health_total_peers` to zero, with a note to fetch these from RPC in the future.
    - Calculate ingress and egress peer sizes and total bytes per second using bandwidth tracking iterators.
    - Iterate over ingress and egress peers to update their respective statistics, including peer names, bytes per second, and identities.
    - Sum up total ingress and egress bytes using [`fd_gui_sum_tiles_counter`](<#fd_gui_sum_tiles_counter>) for various message types.
    - Update storage statistics, including capacity, expired count, evicted count, and active counts for different CRDS values.
    - Update storage transaction counts and bytes for different CRDS values using [`fd_gui_sum_tiles_counter`](<#fd_gui_sum_tiles_counter>).
    - Update message bytes and counts for both received and transmitted messages using [`fd_gui_sum_tiles_counter`](<#fd_gui_sum_tiles_counter>).
- **Output**: Updates the `gossip_stats` structure with the latest network and storage statistics.
- **Functions Called**:
    - [`fd_gui_sum_tiles_counter`](<#fd_gui_sum_tiles_counter>)


---
### fd\_gui\_peers\_contact\_info\_eq<!-- {{#callable:fd_gui_peers_contact_info_eq}} -->
[View Source →](<../../../../../src/disco/gui/fd_gui_peers.c#L403>)

Compares two `fd_contact_info_t` structures to determine if they are equal based on specific fields.
- **Inputs**:
    - `ci1`: A pointer to the first `fd_contact_info_t` structure to compare.
    - `ci2`: A pointer to the second `fd_contact_info_t` structure to compare.
- **Logic and Control Flow**:
    - Initialize `ci_eq` to compare `shred_version`, `instance_creation_wallclock_nanos`, and various fields in the `version` structure of `ci1` and `ci2` for equality.
    - If `ci_eq` is false, return 0 immediately, indicating inequality.
    - Iterate over each socket in `ci1` and `ci2` up to `FD_CONTACT_INFO_SOCKET_CNT`.
    - For each socket, compare the `addr` and `port` fields; if any pair is not equal, return 0.
    - If all comparisons are equal, return 1, indicating the structures are equal.
- **Output**: Returns 1 if the structures are equal, otherwise returns 0.


---
### fd\_gui\_peers\_handle\_gossip\_message<!-- {{#callable:fd_gui_peers_handle_gossip_message}} -->
[View Source →](<../../../../../src/disco/gui/fd_gui_peers.c#L424>)

Processes a gossip message by identifying the peer, parsing the message, and updating metrics based on whether the message is received or transmitted.
- **Inputs**:
    - ``peers``: A pointer to the `fd_gui_peers_ctx_t` context, which contains information about the peers and their connections.
    - ``payload``: A pointer to the message payload data to be processed.
    - ``payload_sz``: The size of the message payload in bytes.
    - ``peer_sock``: A pointer to the `fd_ip4_port_t` structure representing the peer's socket information.
    - ``is_rx``: An integer flag indicating if the message is received (`1`) or transmitted (`0`).
- **Logic and Control Flow**:
    - Query the peer from the socket map using `peer_sock` and the context's contact info table.
    - Iterate through possible duplicate sockets to find the peer with the most recent update timestamp.
    - If no peer is found, exit the function.
    - Parse the gossip message from the `payload` into a `fd_gossip_view_t` structure.
    - If the message cannot be parsed, exit the function.
    - Verify the message tag is within the valid range of gossip message types.
    - Update the appropriate metrics (`gossvf_rx` or `gossip_tx`) for the peer based on the `is_rx` flag and the message tag.
    - Log the payload size if logging is enabled.
- **Output**: No return value; the function updates peer metrics and logs information as side effects.


---
### fd\_gui\_peers\_handle\_gossip\_update<!-- {{#callable:fd_gui_peers_handle_gossip_update}} -->
[View Source →](<../../../../../src/disco/gui/fd_gui_peers.c#L454>)

Handles updates to the peer's gossip information based on the type of update message received.
- **Inputs**:
    - ``peers``: A pointer to the `fd_gui_peers_ctx_t` structure, which contains the context for managing peer information.
    - ``update``: A constant pointer to the `fd_gossip_update_message_t` structure, which contains the update message details.
    - ``now``: A long integer representing the current time in nanoseconds.
- **Logic and Control Flow**:
    - Checks the `tag` of the `update` to determine the type of update message.
    - For `FD_GOSSIP_UPDATE_TAG_CONTACT_INFO`, verifies the consistency of the public key and index, then updates or adds the peer's contact information in the tables and broadcasts the update to WebSocket clients.
    - For `FD_GOSSIP_UPDATE_TAG_CONTACT_INFO_REMOVE`, verifies the index, removes the peer's contact information from the tables, and broadcasts the removal to WebSocket clients.
    - Logs errors if any invariant checks fail, such as mismatched public keys or invalid indices.
- **Output**: No return value; the function updates the peer's context and broadcasts changes as necessary.
- **Functions Called**:
    - [`fd_gui_peers_contact_info_eq`](<#fd_gui_peers_contact_info_eq>)
    - [`fd_gui_peers_printf_nodes`](<fd_gui_printf.c.md#fd_gui_peers_printf_nodes>)
    - [`fd_gui_printf_peers_view_resize`](<fd_gui_printf.c.md#fd_gui_printf_peers_view_resize>)


---
### fd\_gui\_peers\_handle\_vote\_update<!-- {{#callable:fd_gui_peers_handle_vote_update}} -->
[View Source →](<../../../../../src/disco/gui/fd_gui_peers.c#L609>)

Processes vote updates by deduplicating, sorting, and updating peer information based on stake and vote slots.
- **Inputs**:
    - ``peers``: A pointer to the `fd_gui_peers_ctx_t` structure, which contains context information for peers.
    - ``votes``: A pointer to an array of `fd_gui_peers_vote_t` structures representing the votes to be processed.
    - ``vote_cnt``: The number of votes in the `votes` array.
    - ``now``: A timestamp representing the current time, although it is not used in the function.
- **Logic and Control Flow**:
    - Copy the `votes` array to `votes_sorted` for processing.
    - Sort `votes_sorted` by stake in descending order and by node account in a stable manner to deduplicate votes, keeping the one with the largest stake.
    - Calculate the total stake and flag duplicate node accounts by setting their stake to `ULONG_MAX`.
    - Sort `votes_sorted` by `last_vote_slot` to find the stake-weighted 67th percentile `last_vote_slot`.
    - Iterate through `votes_sorted` to calculate the cumulative stake and determine the 67th percentile `last_vote_slot`.
    - Reuse `votes_scratch` to store actions and indices for publishing state updates.
    - Iterate through `votes_sorted` to update peer information if there are changes in stake or delinquency status.
    - If there are updates, call [`fd_gui_peers_printf_nodes`](<fd_gui_printf.c.md#fd_gui_peers_printf_nodes>) and `fd_http_server_ws_broadcast` to publish the changes.
- **Output**: No return value; updates peer information and broadcasts changes if necessary.
- **Functions Called**:
    - [`fd_gui_peers_printf_nodes`](<fd_gui_printf.c.md#fd_gui_peers_printf_nodes>)


---
### fd\_gui\_peers\_viewport\_snap<!-- {{#callable:fd_gui_peers_viewport_snap}} -->
[View Source →](<../../../../../src/disco/gui/fd_gui_peers.c#L702>)

Updates the viewport of a WebSocket client with the latest peer data from the live table.
- **Inputs**:
    - ``peers``: A pointer to the `fd_gui_peers_ctx_t` structure, which contains the context for managing peer connections and viewports.
    - ``ws_conn_id``: An unsigned long integer representing the WebSocket connection ID for the client whose viewport is being updated.
- **Logic and Control Flow**:
    - Check if the client associated with `ws_conn_id` is connected and has a valid `row_cnt` within the allowed range.
    - If the number of active sort keys in the live table equals the maximum allowed, find and disconnect the oldest client to free up a sort key.
    - Iterate over the live table starting from the client's sort key and update the client's viewport with peer data, ensuring the data fits within the client's specified row range.
- **Output**: No return value; the function updates the client's viewport in place.


---
### fd\_gui\_peers\_request\_scroll<!-- {{#callable:fd_gui_peers_request_scroll}} -->
[View Source →](<../../../../../src/disco/gui/fd_gui_peers.c#L736>)

Handles a scroll request for a client's viewport in a WebSocket connection, updating the viewport's start row and row count if valid.
- **Inputs**:
    - ``peers``: A pointer to the `fd_gui_peers_ctx_t` structure, which contains the context for managing peer connections and viewports.
    - ``ws_conn_id``: An unsigned long integer representing the WebSocket connection ID for the client making the request.
    - ``request_id``: An unsigned long integer representing the unique ID of the request being processed.
    - ``params``: A constant pointer to a `cJSON` object containing the parameters for the scroll request, specifically `start_row` and `row_cnt`.
- **Logic and Control Flow**:
    - Check if the client associated with `ws_conn_id` is connected; if not, return `FD_HTTP_SERVER_CONNECTION_CLOSE_BAD_REQUEST`.
    - Retrieve the `start_row` parameter from `params` and verify it is a number; if not, return `FD_HTTP_SERVER_CONNECTION_CLOSE_BAD_REQUEST`.
    - Retrieve the `row_cnt` parameter from `params` and verify it is a number; if not, return `FD_HTTP_SERVER_CONNECTION_CLOSE_BAD_REQUEST`.
    - Check if `row_cnt` is zero, exceeds `FD_GUI_PEERS_WS_VIEWPORT_MAX_SZ`, or if `start_row` is invalid; if any condition is true, send a null query response and return 0.
    - Check if the current viewport's `start_row` and `row_cnt` match the requested values; if they do, return 0 as no update is needed.
    - Update the client's viewport with the new `start_row` and `row_cnt` values.
    - Send a viewport request update to the client using [`fd_gui_printf_peers_viewport_request`](<fd_gui_printf.c.md#fd_gui_printf_peers_viewport_request>) and `fd_http_server_ws_send`.
- **Output**: Returns 0 on success or `FD_HTTP_SERVER_CONNECTION_CLOSE_BAD_REQUEST` if the request is invalid.
- **Functions Called**:
    - [`fd_gui_printf_null_query_response`](<fd_gui_printf.c.md#fd_gui_printf_null_query_response>)
    - [`fd_gui_printf_peers_viewport_request`](<fd_gui_printf.c.md#fd_gui_printf_peers_viewport_request>)


---
### fd\_gui\_peers\_request\_sort<!-- {{#callable:fd_gui_peers_request_sort}} -->
[View Source →](<../../../../../src/disco/gui/fd_gui_peers.c#L770>)

Sorts the live table of peers based on specified column and direction parameters for a given WebSocket connection.
- **Inputs**:
    - ``peers``: A pointer to the `fd_gui_peers_ctx_t` structure representing the context of peers.
    - ``ws_conn_id``: An unsigned long integer representing the WebSocket connection ID.
    - ``request_id``: An unsigned long integer representing the request ID.
    - ``params``: A constant pointer to a `cJSON` object containing the parameters for sorting, specifically the columns (`col`) and directions (`dir`).
- **Logic and Control Flow**:
    - Check if the WebSocket connection is active; if not, return a bad request error.
    - Retrieve the `col` parameter from `params` and verify it is an array; if not, return a bad request error.
    - Iterate over the `col` array to populate the `sort_key.col` array with column indices, checking bounds; return a bad request error if out of bounds.
    - Retrieve the `dir` parameter from `params` and verify it is an array; if not, log a warning and return a bad request error.
    - Iterate over the `dir` array to populate the `sort_key.dir` array with direction values, checking bounds; return a bad request error if out of bounds.
    - Verify the constructed `sort_key` using `fd_gui_peers_live_table_verify_sort_key`; return a bad request error if verification fails.
    - Copy the verified `sort_key` to the client's viewport sort key.
    - Send a sort request message to the WebSocket client and ensure the message is sent successfully.
- **Output**: Returns 0 on success or a bad request error code if any validation fails.
- **Functions Called**:
    - [`fd_gui_printf_peers_viewport_request`](<fd_gui_printf.c.md#fd_gui_printf_peers_viewport_request>)


---
### fd\_gui\_peers\_ws\_message<!-- {{#callable:fd_gui_peers_ws_message}} -->
[View Source →](<../../../../../src/disco/gui/fd_gui_peers.c#L812>)

Processes WebSocket messages for peer context by parsing JSON data and executing specific actions based on the message content.
- **Inputs**:
    - ``peers``: A pointer to the `fd_gui_peers_ctx_t` structure representing the peer context.
    - ``ws_conn_id``: An unsigned long integer representing the WebSocket connection ID.
    - ``data``: A pointer to an unsigned char array containing the message data.
    - ``data_len``: An unsigned long integer representing the length of the message data.
- **Logic and Control Flow**:
    - Parse the JSON data using `cJSON_ParseWithLengthOpts` and check for parsing errors.
    - Retrieve the `id` field from the JSON object and verify it is a number.
    - Retrieve the `topic` field from the JSON object and verify it is a string.
    - Retrieve the `key` field from the JSON object and verify it is a string.
    - If the `topic` is "gossip" and the `key` is "query_sort", retrieve the `params` object and call [`fd_gui_peers_request_sort`](<#fd_gui_peers_request_sort>).
    - If the `topic` is "gossip" and the `key` is "query_scroll", retrieve the `params` object and call [`fd_gui_peers_request_scroll`](<#fd_gui_peers_request_scroll>).
    - If the `topic` and `key` do not match known values, return `FD_HTTP_SERVER_CONNECTION_CLOSE_UNKNOWN_METHOD`.
    - Delete the JSON object after processing.
- **Output**: Returns an integer status code indicating the result of processing the message, such as `FD_HTTP_SERVER_CONNECTION_CLOSE_BAD_REQUEST` or the result from [`fd_gui_peers_request_sort`](<#fd_gui_peers_request_sort>) or [`fd_gui_peers_request_scroll`](<#fd_gui_peers_request_scroll>).
- **Functions Called**:
    - [`fd_gui_peers_request_sort`](<#fd_gui_peers_request_sort>)
    - [`fd_gui_peers_request_scroll`](<#fd_gui_peers_request_scroll>)


---
### fd\_gui\_peers\_viewport\_log<!-- {{#callable:fd_gui_peers_viewport_log}} -->
[View Source →](<../../../../../src/disco/gui/fd_gui_peers.c#L870>)

Generates and logs a formatted table of peer connection statistics for a specific WebSocket connection.
- **Inputs**:
    - ``peers``: A pointer to the `fd_gui_peers_ctx_t` structure, which contains the context for peer connections and viewports.
    - ``ws_conn_id``: An unsigned long integer representing the WebSocket connection ID for which the viewport log is generated.
- **Logic and Control Flow**:
    - Check if the `row_cnt` for the specified WebSocket connection is valid and within the maximum allowed size.
    - Initialize a character buffer `out` and a pointer `p` to format the output string.
    - Append the header of the table to the output string, including the table size and maximum viewport size.
    - Verify that the WebSocket connection is active by checking the `connected` flag.
    - Iterate over the live table of peers, starting from the specified `start_row` and up to the `row_cnt`, to gather peer statistics.
    - For each peer, encode the public key to Base58 and format the IP address.
    - Append each peer's statistics, including RX/TX rates and public key, to the output string.
    - Finalize the output string by appending the table footer.
    - Log the formatted output string using `FD_LOG_NOTICE`.
- **Output**: No return value; the function logs the formatted peer statistics to the console.


---
### fd\_gui\_peers\_ws\_conn\_rr\_grow<!-- {{#callable:fd_gui_peers_ws_conn_rr_grow}} -->
[View Source →](<../../../../../src/disco/gui/fd_gui_peers.c#L921>)

Increments the count of open WebSocket connections and sets the active connection ID if no connections are currently open.
- **Inputs**:
    - ``peers``: A pointer to a `fd_gui_peers_ctx_t` structure representing the context of peers.
    - ``ws_conn_id``: An unsigned long integer representing the WebSocket connection ID to be set as active if no connections are open.
- **Logic and Control Flow**:
    - Checks if the `open_ws_conn_cnt` is zero using `FD_UNLIKELY` macro.
    - If true, sets `active_ws_conn_id` to `ws_conn_id`.
    - Increments `open_ws_conn_cnt` by one.
- **Output**: No return value (void function).


---
### fd\_gui\_peers\_ws\_conn\_rr\_shrink<!-- {{#callable:fd_gui_peers_ws_conn_rr_shrink}} -->
[View Source →](<../../../../../src/disco/gui/fd_gui_peers.c#L927>)

Decreases the count of open WebSocket connections and updates the active connection ID if necessary.
- **Inputs**:
    - ``peers``: A pointer to the `fd_gui_peers_ctx_t` structure, which contains the context for managing WebSocket connections.
    - ``ws_conn_id``: The ID of the WebSocket connection that is being closed or removed.
- **Logic and Control Flow**:
    - Decrement the `open_ws_conn_cnt` in the `peers` context.
    - Check if the `open_ws_conn_cnt` is non-zero and if the `active_ws_conn_id` matches the `ws_conn_id` being removed.
    - If both conditions are true, iterate over possible connection IDs to find the next active connection.
    - Set `active_ws_conn_id` to the next connected WebSocket connection ID found in the iteration.
- **Output**: No return value; the function modifies the `peers` context in place.


---
### fd\_gui\_peers\_ws\_conn\_rr\_advance<!-- {{#callable:fd_gui_peers_ws_conn_rr_advance}} -->
[View Source →](<../../../../../src/disco/gui/fd_gui_peers.c#L942>)

Advances the active WebSocket connection in a round-robin manner if conditions are met.
- **Inputs**:
    - ``peers``: A pointer to the `fd_gui_peers_ctx_t` structure, which contains the context for managing WebSocket connections.
    - ``now``: A long integer representing the current time in nanoseconds.
- **Logic and Control Flow**:
    - Check if there are no open WebSocket connections or if the current time `now` is less than or equal to `peers->next_client_nanos`; if so, return 0.
    - Iterate over the range from 1 to `peers->max_ws_conn_cnt + 1` to find the next active WebSocket connection.
    - Calculate `next_ws_conn_id` as the sum of `peers->active_ws_conn_id` and the loop index `i`, modulo `peers->max_ws_conn_cnt`.
    - If the client viewport at `next_ws_conn_id` is connected, update `peers->active_ws_conn_id` to `next_ws_conn_id` and break the loop.
    - Return 1 to indicate that the active WebSocket connection has been advanced.
- **Output**: Returns 1 if the active WebSocket connection is advanced, otherwise returns 0.


---
### fd\_gui\_peers\_poll<!-- {{#callable:fd_gui_peers_poll}} -->
[View Source →](<../../../../../src/disco/gui/fd_gui_peers.c#L956>)

Polls and updates the state of WebSocket connections and metrics for GUI peers.
- **Inputs**:
    - ``peers``: A pointer to the `fd_gui_peers_ctx_t` structure, which holds the context for GUI peers.
    - ``now``: A long integer representing the current time in nanoseconds.
- **Logic and Control Flow**:
    - Initialize `did_work` to 0 to track if any work was done.
    - Check if the WebSocket connection needs to advance in a round-robin manner using [`fd_gui_peers_ws_conn_rr_advance`](<#fd_gui_peers_ws_conn_rr_advance>).
    - If a connection is active and has rows, update the viewport and send updates via WebSocket.
    - Update the `next_client_nanos` to schedule the next client update based on the number of open connections.
    - Check if it's time to update metric rates by comparing `now` with `next_metric_rate_update_nanos`.
    - Iterate over each peer in the `node_pubkey_map` to calculate new metric rates and update the live table and bandwidth tracking if rates have changed.
    - Update `next_metric_rate_update_nanos` to schedule the next metric rate update.
    - Check if it's time to update gossip statistics by comparing `now` with `next_gossip_stats_update_nanos`.
    - Capture and print gossip statistics, then broadcast them via WebSocket.
    - Update `next_gossip_stats_update_nanos` to schedule the next gossip stats update.
    - Return `did_work` to indicate if any updates were performed.
- **Output**: Returns an integer `did_work` indicating whether any updates were performed (1 if work was done, 0 otherwise).
- **Functions Called**:
    - [`fd_gui_peers_ws_conn_rr_advance`](<#fd_gui_peers_ws_conn_rr_advance>)
    - [`fd_gui_printf_peers_viewport_update`](<fd_gui_printf.c.md#fd_gui_printf_peers_viewport_update>)
    - [`fd_gui_peers_viewport_log`](<#fd_gui_peers_viewport_log>)
    - [`fd_gui_peers_viewport_snap`](<#fd_gui_peers_viewport_snap>)
    - [`fd_gui_peers_gossip_stats_snap`](<#fd_gui_peers_gossip_stats_snap>)
    - [`fd_gui_peers_printf_gossip_stats`](<fd_gui_printf.c.md#fd_gui_peers_printf_gossip_stats>)


---
### fd\_gui\_peers\_ws\_open<!-- {{#callable:fd_gui_peers_ws_open}} -->
[View Source →](<../../../../../src/disco/gui/fd_gui_peers.c#L1054>)

Initializes a WebSocket connection for a client in the `fd_gui_peers_ctx_t` context.
- **Inputs**:
    - ``peers``: A pointer to the `fd_gui_peers_ctx_t` structure representing the context for GUI peers.
    - ``ws_conn_id``: An unsigned long integer representing the WebSocket connection ID.
    - ``now``: A long integer representing the current time in nanoseconds.
- **Logic and Control Flow**:
    - Sets the `connected` field of the client's viewport at `ws_conn_id` to 1, indicating an active connection.
    - Sets the `connected_time` field of the client's viewport to the current time `now`.
    - Initializes the `start_row` and `row_cnt` fields of the client's viewport to 0.
    - Sets the `sort_key` field of the client's viewport to `FD_GUI_PEERS_LIVE_TABLE_DEFAULT_SORT_KEY`.
    - Calls [`fd_gui_peers_ws_conn_rr_grow`](<#fd_gui_peers_ws_conn_rr_grow>) to update the round-robin connection management with the new connection.
    - Calls [`fd_gui_peers_printf_node_all`](<fd_gui_printf.c.md#fd_gui_peers_printf_node_all>) to print all nodes to the WebSocket clients.
    - Sends a WebSocket message using `fd_http_server_ws_send` to confirm the connection.
- **Output**: No return value; the function operates by modifying the state of the `peers` context.
- **Functions Called**:
    - [`fd_gui_peers_ws_conn_rr_grow`](<#fd_gui_peers_ws_conn_rr_grow>)
    - [`fd_gui_peers_printf_node_all`](<fd_gui_printf.c.md#fd_gui_peers_printf_node_all>)


---
### fd\_gui\_peers\_ws\_close<!-- {{#callable:fd_gui_peers_ws_close}} -->
[View Source →](<../../../../../src/disco/gui/fd_gui_peers.c#L1067>)

Closes a WebSocket connection by removing the sort key from the live table, marking the connection as disconnected, and updating the round-robin connection management.
- **Inputs**:
    - ``peers``: A pointer to the `fd_gui_peers_ctx_t` structure, which contains the context for managing peer connections.
    - ``ws_conn_id``: An unsigned long integer representing the WebSocket connection ID to be closed.
- **Logic and Control Flow**:
    - Call `fd_gui_peers_live_table_sort_key_remove` to remove the sort key associated with the WebSocket connection from the live table.
    - Set the `connected` field of the `client_viewports` array at index `ws_conn_id` to 0, indicating the connection is closed.
    - Call [`fd_gui_peers_ws_conn_rr_shrink`](<#fd_gui_peers_ws_conn_rr_shrink>) to update the round-robin management of WebSocket connections.
- **Output**: No return value; the function operates by modifying the state of the `peers` context.
- **Functions Called**:
    - [`fd_gui_peers_ws_conn_rr_shrink`](<#fd_gui_peers_ws_conn_rr_shrink>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)