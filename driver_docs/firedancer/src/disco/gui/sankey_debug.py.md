<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Scrapes a URL or file for Prometheus metrics, parses them, and prints a Sankey diagram of the data flow.

# Purpose
The code is a script designed to process and analyze Prometheus metrics data, either from a URL or a local file. It uses the `requests` library to fetch data from a URL and processes the data using regular expressions to extract specific metrics. The [`parse_prometheus_text`](<#parse_prometheus_text>) function parses the text data and organizes it into a dictionary, where keys are tuples representing metric attributes, and values are integers representing metric counts. The script then uses these parsed metrics to compute various statistics related to network transactions and their processing stages.

The script includes a [`print_sankey`](<#print_sankey>) function that calculates and prints a detailed breakdown of transaction metrics, such as those received via different protocols (e.g., UDP, QUIC) and various failure or success states during processing. The [`main`](<#main>) function serves as the entry point, handling command-line arguments to determine the source of the metrics data and invoking the necessary functions to parse and display the data. The script is intended to be run as a standalone program, providing a detailed analysis of transaction metrics for debugging or monitoring purposes.
# Imports and Dependencies

---
- `re`
- `sys`
- `requests`
- `typing.Dict`
- `typing.Tuple`
- `typing.Optional`
- `pprint`


# Functions

---
### scrape\_url<!-- {{#callable:firedancer/src/disco/gui/sankey_debug.scrape_url}} -->
[View Source →](<../../../../../src/disco/gui/sankey_debug.py#L7>)

Fetches the content of a given URL and returns it as a string.
- **Inputs**:
    - `url`: A string representing the URL to fetch.
- **Logic and Control Flow**:
    - Send a GET request to the specified URL using the `requests.get` method.
    - Check if the HTTP request was successful by calling `raise_for_status` on the response object.
    - Set the response encoding to 'utf-8'.
    - Return the text content of the response.
- **Output**: A string containing the text content of the HTTP response.


---
### parse\_prometheus\_text<!-- {{#callable:firedancer/src/disco/gui/sankey_debug.parse_prometheus_text}} -->
[View Source →](<../../../../../src/disco/gui/sankey_debug.py#L13>)

Parses Prometheus text data to extract metrics and their values into a dictionary.
- **Inputs**:
    - `text`: A string containing Prometheus formatted text data.
- **Logic and Control Flow**:
    - Compile a regular expression pattern to match Prometheus metrics with specific attributes and values.
    - Initialize an empty dictionary `result` to store parsed metrics and their values.
    - Iterate over each line in the input `text` by splitting it into lines.
    - For each line, attempt to match it against the compiled regular expression pattern.
    - If a match is found, extract the metric name, kind, optional link kind ID, optional variant, and value from the matched groups.
    - Use the extracted kind, metric name, and either the variant or link kind ID as a key in the `result` dictionary.
    - Increment the value associated with the key in the `result` dictionary by the extracted value.
    - Return the `result` dictionary containing the parsed metrics and their aggregated values.
- **Output**: A dictionary where keys are tuples of kind, metric name, and optional variant or link kind ID, and values are integers representing the aggregated metric values.


---
### get\_link\_count<!-- {{#callable:firedancer/src/disco/gui/sankey_debug.get_link_count}} -->
[View Source →](<../../../../../src/disco/gui/sankey_debug.py#L26>)

Calculates the count of links for a given metric, optionally filtered by a specific consumer or link.
- **Inputs**:
    - `summed`: A dictionary where keys are tuples of consumer, metric, and optional link, and values are integers representing counts.
    - `metric`: A string representing the metric to filter the counts.
    - `link`: An optional string representing the link to filter the counts.
    - `consumer`: An optional string representing the consumer to filter the counts.
- **Logic and Control Flow**:
    - If `consumer` is not `None`, return the count from `summed` for the tuple `(consumer, metric, link)` or 0 if not found.
    - If `consumer` is `None`, create a set of all consumers from `summed` where the metric and link match the given `metric` and `link`.
    - Sum the counts from `summed` for each consumer in the set with the given `metric` and `link`, and return the total.
- **Output**: An integer representing the total count of links for the specified metric, optionally filtered by consumer and link.


---
### print\_sankey<!-- {{#callable:firedancer/src/disco/gui/sankey_debug.print_sankey}} -->
[View Source →](<../../../../../src/disco/gui/sankey_debug.py#L33>)

Generates and prints a detailed report of transaction metrics and their flow through various stages.
- **Inputs**:
    - `summed`: A dictionary where keys are tuples of strings and an optional string, representing different metrics and links, and values are integers representing counts.
- **Logic and Control Flow**:
    - Calls [`get_link_count`](<#get_link_count>) multiple times to retrieve counts for various metrics and links, such as 'bundle_transaction_received', 'dedup_gossiped_votes_received', and others.
    - Calculates several intermediate values like `in_block_engine`, `in_gossip`, `in_udp`, `in_quic`, and others by summing or subtracting results from [`get_link_count`](<#get_link_count>).
    - Prints a formatted report using the calculated values, showing metrics like 'block_engine', 'gossip', 'udp', 'quic', and others.
    - Computes totals and reconciles input and output counts for different stages like 'VERIFY', 'DEDUP', 'RESOLV', and 'PACK'.
    - Displays the computed totals and unaccounted transactions in a structured format.
- **Output**: A printed report detailing the counts of various transaction metrics and their flow through different stages.
- **Functions Called**:
    - [`firedancer/src/disco/gui/sankey_debug.get_link_count`](<#get_link_count>)


---
### main<!-- {{#callable:firedancer/src/disco/gui/sankey_debug.main}} -->
[View Source →](<../../../../../src/disco/gui/sankey_debug.py#L172>)

Executes the main logic for processing a URL or file path to parse Prometheus text and print a Sankey diagram.
- **Inputs**: None
- **Logic and Control Flow**:
    - Checks if the number of command-line arguments is not equal to 2; if true, prints usage instructions and exits the program.
    - Retrieves the URL or file path from the command-line arguments.
    - Checks if the URL starts with 'http'; if true, calls [`scrape_url`](<#scrape_url>) to fetch content from the URL, otherwise reads content from the file path.
    - Parses the content using [`parse_prometheus_text`](<#parse_prometheus_text>).
    - Uses `pprint` to print the parsed data.
    - Calls [`print_sankey`](<#print_sankey>) to print the Sankey diagram based on the parsed data.
- **Output**: No return value; outputs are printed to the console.
- **Functions Called**:
    - [`firedancer/src/disco/gui/sankey_debug.scrape_url`](<#scrape_url>)
    - [`firedancer/src/disco/gui/sankey_debug.parse_prometheus_text`](<#parse_prometheus_text>)
    - [`firedancer/src/disco/gui/sankey_debug.print_sankey`](<#print_sankey>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)