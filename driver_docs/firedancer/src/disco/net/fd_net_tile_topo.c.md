<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Topology support routines for configuring network tiles with XDP and socket providers.

# Purpose
The code provides topology support routines for network tiles, specifically focusing on configuring and managing network interfaces using either XDP (eXpress Data Path) or socket-based communication. It defines functions to set up network tiles ([`setup_xdp_tile`](<#setup_xdp_tile>) and [`setup_sock_tile`](<#setup_sock_tile>)) and manage their configurations based on the network provider specified in the configuration (`fd_config_net_t`). The code includes logic to create and configure workspaces and links for network communication, handling both XDP and socket-based setups. It also includes error handling for invalid configurations and ensures that network resources are correctly allocated and initialized.

The primary components of the code include functions for setting up network tiles ([`fd_topos_net_tiles`](<#fd_topos_net_tiles>)), adding and managing network links ([`add_xdp_rx_link`](<#add_xdp_rx_link>), [`fd_topos_net_rx_link`](<#fd_topos_net_rx_link>)), and finalizing network tile configurations ([`fd_topos_net_tile_finish`](<#fd_topos_net_tile_finish>)). The code interacts with various components such as `fd_topo_t`, `fd_topo_tile_t`, and `fd_config_net_t` to manage network topology and configuration. It also uses several utility functions and macros for memory and string operations. The code is intended to be part of a larger system where it is responsible for configuring network tiles and links, ensuring that they are set up correctly for either XDP or socket-based communication.
# Imports and Dependencies

---
- `fd_net_tile.h`
- `../topo/fd_topob.h`
- `../netlink/fd_netlink_tile.h`
- `../../app/shared/fd_config.h`
- `../../util/pod/fd_pod_format.h`
- `net/if.h`


# Functions

---
### setup\_xdp\_tile<!-- {{#callable:setup_xdp_tile}} -->
[View Source →](<../../../../../src/disco/net/fd_net_tile_topo.c#L11>)

Configures an XDP tile in the network topology with specified parameters and settings.
- **Inputs**:
    - ``topo``: A pointer to the `fd_topo_t` structure representing the network topology.
    - ``i``: An unsigned long integer representing the index of the tile being set up.
    - ``netlink_tile``: A pointer to the `fd_topo_tile_t` structure representing the netlink tile.
    - ``tile_to_cpu``: A constant pointer to an array of unsigned long integers mapping tiles to CPU indices.
    - ``net_cfg``: A constant pointer to the `fd_config_net_t` structure containing network configuration settings.
- **Logic and Control Flow**:
    - Retrieve a tile from the topology using `fd_topob_tile` with specific parameters.
    - Create a link in the topology using `fd_topob_link`.
    - Configure the tile's input and output using `fd_topob_tile_in` and `fd_topob_tile_out`.
    - Join the netlink topology with the tile using `fd_netlink_topo_join`.
    - Retrieve a topology object for the UMEM using `fd_topob_obj`.
    - Set the tile to use the UMEM object with read-write mode using `fd_topob_tile_uses`.
    - Insert the UMEM object ID into the topology properties using `fd_pod_insertf_ulong`.
    - Initialize and set the XDP interface name in the tile using `fd_cstr_init`, `fd_cstr_append_cstr_safe`, and `fd_cstr_fini`.
    - Set the tile's bind address from the network configuration.
    - Configure XDP settings such as flush timeout, queue sizes, and zero-copy mode from the network configuration.
    - Set the XDP mode using `fd_memset` and `fd_memcpy`.
    - Assign various object IDs from the netlink tile to the XDP tile.
    - Set the free ring depth based on the XDP TX queue size, and increase it for loopback if `i` is zero.
- **Output**: No return value; the function modifies the `fd_topo_t` and `fd_topo_tile_t` structures in place.


---
### setup\_sock\_tile<!-- {{#callable:setup_sock_tile}} -->
[View Source →](<../../../../../src/disco/net/fd_net_tile_topo.c#L54>)

Configures a socket tile in the network topology with specified binding address and buffer sizes.
- **Inputs**:
    - ``topo``: A pointer to the `fd_topo_t` structure representing the network topology.
    - ``tile_to_cpu``: A pointer to an array of unsigned long integers mapping tiles to CPU indices.
    - ``net_cfg``: A pointer to the `fd_config_net_t` structure containing network configuration parameters.
- **Logic and Control Flow**:
    - Retrieve a tile from the topology using `fd_topob_tile` with parameters for a socket tile.
    - Set the `bind_address` of the tile's socket network configuration to the parsed bind address from `net_cfg`.
    - Check if the `receive_buffer_size` in `net_cfg` exceeds `INT_MAX`; if so, log an error.
    - Check if the `send_buffer_size` in `net_cfg` exceeds `INT_MAX`; if so, log an error.
    - Assign the `receive_buffer_size` from `net_cfg` to the tile's socket receive buffer size, casting it to an integer.
    - Assign the `send_buffer_size` from `net_cfg` to the tile's socket send buffer size, casting it to an integer.
- **Output**: No return value; the function modifies the `fd_topo_tile_t` structure pointed to by `tile`.


---
### fd\_topos\_net\_tiles<!-- {{#callable:fd_topos_net_tiles}} -->
[View Source →](<../../../../../src/disco/net/fd_net_tile_topo.c#L67>)

Configures network tiles based on the specified provider type, either 'xdp' or 'socket', and sets up the necessary workspaces and configurations.
- **Inputs**:
    - ``topo``: A pointer to the `fd_topo_t` structure representing the network topology.
    - ``net_tile_cnt``: The number of network tiles to configure.
    - ``net_cfg``: A constant pointer to the `fd_config_net_t` structure containing network configuration details.
    - ``netlnk_max_routes``: The maximum number of routes for the netlink tile.
    - ``netlnk_max_peer_routes``: The maximum number of peer routes for the netlink tile.
    - ``netlnk_max_neighbors``: The maximum number of neighbors for the netlink tile.
    - ``tile_to_cpu``: An array mapping tile indices to CPU indices.
- **Logic and Control Flow**:
    - Initializes the 'net_umem' workspace for packet buffers.
    - Checks the `provider` field in `net_cfg` to determine the type of network configuration ('xdp' or 'socket').
    - If the provider is 'xdp', initializes workspaces for 'net', 'netlnk', 'netbase', and 'net_netlnk'.
    - Creates a netlink tile and configures it using `fd_netlink_topo_create`.
    - Iterates over the number of network tiles (`net_tile_cnt`) and calls [`setup_xdp_tile`](<#setup_xdp_tile>) for each tile.
    - If the provider is 'socket', initializes the 'sock' workspace and iterates over the network tiles to call [`setup_sock_tile`](<#setup_sock_tile>).
    - Logs an error if the `provider` is neither 'xdp' nor 'socket'.
- **Output**: No return value; the function operates by side effects on the `topo` structure and related configurations.
- **Functions Called**:
    - [`setup_xdp_tile`](<#setup_xdp_tile>)
    - [`setup_sock_tile`](<#setup_sock_tile>)


---
### topo\_is\_xdp<!-- {{#callable:topo_is_xdp}} -->
[View Source →](<../../../../../src/disco/net/fd_net_tile_topo.c#L112>)

Checks if any tile in the topology is named 'net' and returns 1 if found, otherwise returns 0.
- **Inputs**:
    - `topo`: A pointer to an `fd_topo_t` structure representing the topology to check.
- **Logic and Control Flow**:
    - Iterates over each tile in the `topo` structure using a for loop.
    - Compares the `name` of each tile with the string "net" using `strcmp`.
    - If a match is found, returns 1 immediately.
    - If no match is found after checking all tiles, returns 0.
- **Output**: Returns 1 if a tile named 'net' is found, otherwise returns 0.


---
### add\_xdp\_rx\_link<!-- {{#callable:add_xdp_rx_link}} -->
[View Source →](<../../../../../src/disco/net/fd_net_tile_topo.c#L123>)

Adds a new XDP RX link to the topology structure.
- **Inputs**:
    - ``topo``: A pointer to the `fd_topo_t` structure representing the network topology.
    - ``link_name``: A constant character pointer representing the name of the link to be added.
    - ``net_kind_id``: An unsigned long integer representing the network kind identifier.
    - ``depth``: An unsigned long integer representing the depth of the link.
- **Logic and Control Flow**:
    - Check if `topo` or `link_name` is NULL and log an error if true.
    - Check if the length of `link_name` exceeds the maximum allowed size and log an error if true.
    - Check if the current link count exceeds the maximum allowed links and log an error if true.
    - Initialize `kind_id` to 0 and iterate over existing links to count occurrences of `link_name`.
    - Create a new link in the `topo` structure at the current link count index.
    - Copy `link_name` to the new link's name field and set its ID, kind ID, depth, MTU, and burst values.
    - Retrieve the mcache object ID and assign it to the new link's mcache object ID field.
    - Insert the depth property into the topology's properties using the mcache object ID.
    - Query the dcache object ID using the network kind ID and assign it to the new link's dcache object ID field.
    - Check if the dcache object ID is invalid and log an error if true.
    - Increment the link count in the `topo` structure.
- **Output**: None (the function modifies the `topo` structure in place).


---
### fd\_topos\_net\_rx\_link<!-- {{#callable:fd_topos_net_rx_link}} -->
[View Source →](<../../../../../src/disco/net/fd_net_tile_topo.c#L155>)

Configures a network receive link in a topology based on whether XDP is used.
- **Inputs**:
    - ``topo``: A pointer to the `fd_topo_t` structure representing the network topology.
    - ``link_name``: A constant character pointer representing the name of the link.
    - ``net_kind_id``: An unsigned long integer representing the network kind identifier.
    - ``depth``: An unsigned long integer representing the depth of the link.
- **Logic and Control Flow**:
    - Check if the topology uses XDP by calling [`topo_is_xdp`](<#topo_is_xdp>) with `topo` as the argument.
    - If XDP is used, call [`add_xdp_rx_link`](<#add_xdp_rx_link>) with the provided arguments to add an XDP receive link.
    - Call `fd_topob_tile_out` with the parameters `topo`, "net", `net_kind_id`, `link_name`, and `net_kind_id` to configure the tile output for XDP.
    - If XDP is not used, call `fd_topob_link` with the parameters `topo`, `link_name`, "net_umem", `depth`, `FD_NET_MTU`, and 64 to configure a non-XDP link.
    - Call `fd_topob_tile_out` with the parameters `topo`, "sock", `net_kind_id`, `link_name`, and `net_kind_id` to configure the tile output for non-XDP.
- **Output**: No return value (void function).
- **Functions Called**:
    - [`topo_is_xdp`](<#topo_is_xdp>)
    - [`add_xdp_rx_link`](<#add_xdp_rx_link>)


---
### fd\_topos\_tile\_in\_net<!-- {{#callable:fd_topos_tile_in_net}} -->
[View Source →](<../../../../../src/disco/net/fd_net_tile_topo.c#L169>)

Processes each tile in the topology and calls `fd_topob_tile_in` for tiles named 'net' or 'sock'.
- **Inputs**:
    - ``topo``: A pointer to an `fd_topo_t` structure representing the topology.
    - ``fseq_wksp``: A constant character pointer representing the workspace sequence.
    - ``link_name``: A constant character pointer representing the name of the link.
    - ``link_kind_id``: An unsigned long integer representing the kind ID of the link.
    - ``reliable``: An integer indicating if the link is reliable.
    - ``polled``: An integer indicating if the link is polled.
- **Logic and Control Flow**:
    - Iterates over each tile in the `topo` structure using a for loop.
    - Checks if the tile's name is 'net' or 'sock' using `strcmp`.
    - If the tile's name matches, calls `fd_topob_tile_in` with the tile's name, kind ID, and other parameters.
- **Output**: No return value (void function).


---
### fd\_topos\_net\_tile\_finish<!-- {{#callable:fd_topos_net_tile_finish}} -->
[View Source →](<../../../../../src/disco/net/fd_net_tile_topo.c#L184>)

Finalizes the network tile configuration by adjusting queue sizes and creating a dcache object.
- **Inputs**:
    - ``topo``: A pointer to the `fd_topo_t` structure representing the network topology.
    - ``net_kind_id``: An unsigned long integer representing the network kind identifier.
- **Logic and Control Flow**:
    - Check if the topology is XDP using [`topo_is_xdp`](<#topo_is_xdp>); if not, return immediately.
    - Find the network tile using `fd_topo_find_tile` and store it in `net_tile`.
    - Calculate `rx_depth` and `tx_depth` by increasing them by 50%.
    - If `net_kind_id` is 0, double `rx_depth` and `tx_depth` for loopback XSK.
    - Initialize `cum_frame_cnt` with the sum of `rx_depth` and `tx_depth`.
    - Iterate over each outgoing link of `net_tile` to accumulate the depth of all RX mcaches into `cum_frame_cnt`.
    - Retrieve `umem_obj_id` using `fd_pod_queryf_ulong` and ensure it is valid.
    - Ensure `net_tile->net.umem_dcache_obj_id` is greater than 0.
    - Insert `cum_frame_cnt`, `2UL`, and `2048UL` into `topo->props` for the dcache object using `fd_pod_insertf_ulong`.
- **Output**: No return value; the function modifies the `topo` structure in place.
- **Functions Called**:
    - [`topo_is_xdp`](<#topo_is_xdp>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)