<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

A test file for XDP tile functionality, including packet structures, network configuration, and test loops for verifying packet transmission and reception.

# Purpose
The code is a C source file that serves as a test configuration for an XDP (eXpress Data Path) tile, specifically for testing network packet processing. It includes definitions for packet structures, such as `gre_pkt_t` and `pkt_t`, which represent GRE (Generic Routing Encapsulation) and standard IP packets, respectively. The file sets up various network configurations, including routing tables, neighbor tables, and network device tables, to simulate a network environment for testing purposes. It also defines several macros and constants for configuring the test environment, such as interface indices and IP addresses.

The main function initializes the test environment, including setting up a random number generator, configuring the network topology, and initializing test links for transmitting and receiving packets. The code includes functions for setting up and verifying the network packet processing logic, such as [`setup_routing_table`](<#setup_routing_table>), [`setup_neighbor_table`](<#setup_neighbor_table>), and [`setup_netdev_table`](<#setup_netdev_table>). It also includes test loops to simulate packet transmission and reception, using functions like [`quic_publish`](<#quic_publish>) and [`xsk_recv`](<#xsk_recv>) to handle packet processing. The test suite verifies the correct operation of the network tile by checking the routing logic and packet contents at various stages of the test.
# Imports and Dependencies

---
- `fd_xdp_tile.c`
- `../../../app/shared/fd_tile_unit_test.h`
- `../../../app/shared/fd_tile_unit_test_tmpl.c`
- `../../../app/fdctl/topology.c`
- `../../../app/firedancer/topology.c`


# Global Variables

---
### metrics\_scratch
- **Type**: ``static uchar[]``
- **Description**: An array of unsigned characters used as a scratch space for metrics data. The size of the array is determined by the `FD_METRICS_FOOTPRINT` macro with parameters `10, 10`, and it is aligned according to `FD_METRICS_ALIGN`. The array is initialized to zero.
- **Use**: Used to store temporary metrics data in a memory-aligned manner.


---
### config
- **Type**: ``config_t[1]``
- **Description**: An array of one element of type `config_t`. The `config` variable is used to store configuration data for the test environment.
- **Use**: Holds configuration data for initializing and running the test environment.


---
### xsk\_ring\_scratch
- **Type**: ``uchar[]``
- **Description**: An array of unsigned characters (`uchar`) with a size defined by `XSK_RING_SCRATCH_MAX`, which is set to 4MB. The array is aligned to the size of a normal shared memory page (`FD_SHMEM_NORMAL_PAGE_SZ`).
- **Use**: Used as a scratch space for XSK ring operations, likely for temporary storage or manipulation of data related to XDP socket operations.


---
### rx\_gre\_pkt
- **Type**: ``gre_pkt_t` array`
- **Description**: An array of `gre_pkt_t` structures, each representing a GRE (Generic Routing Encapsulation) packet. Each packet contains Ethernet, IPv4, GRE, and UDP headers, along with a small data payload.
- **Use**: Used to store and manage a collection of GRE packets for testing purposes, with a maximum of `TEST_MAX_PKTS` packets.


---
### rx\_pkt
- **Type**: ``pkt_t` array`
- **Description**: An array of `pkt_t` structures, each representing a network packet with Ethernet, IPv4, and UDP headers, along with a small data payload. The array is statically allocated with a size defined by `TEST_MAX_PKTS`, which is 32.
- **Use**: Used to store and manage incoming network packets for processing in the test configuration.


---
### tx\_pkt\_input
- **Type**: ``pkt_t` array`
- **Description**: An array of `pkt_t` structures, each representing a packet with Ethernet, IPv4, and UDP headers, along with a small data payload. The array is initialized with zero values and has a size defined by `TEST_MAX_PKTS`.
- **Use**: Used to store input packets for transmission in the test environment.


---
### tx\_gre\_pkt\_output
- **Type**: ``gre_pkt_t` array`
- **Description**: An array of `gre_pkt_t` structures, each representing a GRE (Generic Routing Encapsulation) packet. Each packet includes Ethernet, outer IPv4, GRE, inner IPv4, and UDP headers, along with a small data payload.
- **Use**: Stores GRE packets for transmission in a test environment, with a maximum of `TEST_MAX_PKTS` packets.


---
### tx\_pkt\_output
- **Type**: ``pkt_t` array`
- **Description**: An array of `pkt_t` structures, each representing a packet with Ethernet, IPv4, and UDP headers, along with a small data payload. The array is initialized with zero values and has a size defined by `TEST_MAX_PKTS`, which is 32.
- **Use**: Stores the expected output packets for transmission in the test environment.


---
### banned\_ip
- **Type**: ``uint``
- **Description**: Represents an IPv4 address that is blackholed at the route table. The address is defined using the `FD_IP4_ADDR` macro with the values `7,0,0,1`, which corresponds to the integer value `16777223`. This address is not routed and is effectively blocked.
- **Use**: Used in the routing table setup to define a blackhole route, preventing packets from being sent to this IP address.


---
### default\_src\_ip
- **Type**: ``uint``
- **Description**: Represents the default source IP address used in network configurations. It is defined using the `FD_IP4_ADDR` macro with the IP address 64.130.35.241.
- **Use**: Used as the default source IP address in network operations and configurations.


---
### random\_ip
- **Type**: ``uint``
- **Description**: A constant unsigned integer representing an IPv4 address, specifically 64.130.35.240. This address is converted to a 32-bit integer using the `FD_IP4_ADDR` macro.
- **Use**: Used as a placeholder or test IP address in network configurations or simulations.


---
### gw\_ip
- **Type**: ``uint``
- **Description**: Represents the IP address of the gateway in the network configuration. It is defined as a constant unsigned integer using the `FD_IP4_ADDR` macro to convert the IP address `192.168.1.1` into a 32-bit integer.
- **Use**: Used in network routing configurations to specify the gateway IP address.


---
### gre0\_src\_ip
- **Type**: ``uint``
- **Description**: Represents the source IP address for the GRE0 interface, defined as a constant using the `FD_IP4_ADDR` macro with the IP address 192.168.123.1.
- **Use**: Used in network configurations and routing tables to specify the source IP for GRE0 packets.


---
### gre0\_dst\_ip
- **Type**: ``uint``
- **Description**: Represents the destination IP address for the GRE0 tunnel interface. It is defined as a constant 32-bit unsigned integer using the `FD_IP4_ADDR` macro to convert the IP address 192.168.123.6 into its numeric form.
- **Use**: Used in network configuration to specify the destination IP for GRE0 tunnel routing.


---
### gre0\_outer\_src\_ip
- **Type**: ``uint``
- **Description**: Represents the outer source IP address for the GRE0 interface, defined as a constant using the `FD_IP4_ADDR` macro with the IP address 10.0.0.1.
- **Use**: Used in network configuration to specify the source IP for GRE0 tunnel packets.


---
### gre0\_outer\_dst\_ip
- **Type**: ``uint``
- **Description**: Represents the outer destination IP address for the GRE0 interface, defined as a constant using the `FD_IP4_ADDR` macro with the IP address 10.0.0.2. The value is stored as an unsigned integer.
- **Use**: Used in network configuration to specify the destination IP for GRE0 tunnels.


---
### gre0\_outer\_src\_ip\_fake
- **Type**: ``uint``
- **Description**: Represents a constant IPv4 address used as a fake source IP for GRE (Generic Routing Encapsulation) tunnel 0. The address is defined using the `FD_IP4_ADDR` macro with the value `10.0.0.3`, which corresponds to the integer `50331658`. This is a static constant variable, meaning its value is fixed and cannot be changed during runtime.
- **Use**: Used in network configurations, particularly in routing tables, to simulate a source IP address for GRE tunnel 0.


---
### gre1\_src\_ip
- **Type**: ``uint``
- **Description**: Represents the source IP address for the GRE1 interface in the network configuration. The IP address is set to 193.169.123.1, which is converted to an integer using the `FD_IP4_ADDR` macro.
- **Use**: Used in network configurations and routing tables to specify the source IP for GRE1 tunnels.


---
### gre1\_dst\_ip
- **Type**: ``uint``
- **Description**: Represents the destination IP address for the GRE1 tunnel, defined as a constant 32-bit unsigned integer. The IP address is set to 193.169.123.6, which corresponds to the integer value 108767681.
- **Use**: Used in network configuration to specify the destination IP for GRE1 tunnel communications.


---
### gre1\_outer\_src\_ip
- **Type**: ``uint``
- **Description**: Represents the outer source IP address for the GRE1 tunnel interface. The IP address is defined using the `FD_IP4_ADDR` macro with the values (11,1,0,1), which corresponds to the integer value 16777483.
- **Use**: Used in network configurations to specify the source IP for GRE1 tunnel packets.


---
### gre1\_outer\_dst\_ip
- **Type**: ``uint``
- **Description**: Represents the outer destination IP address for the GRE1 tunnel, defined as a constant using the `FD_IP4_ADDR` macro with the IP address 11.1.0.2. The numerical representation of this IP address is 33554699.
- **Use**: Used in network configuration to specify the destination IP for the GRE1 tunnel.


---
### eth0\_dst\_mac\_addr
- **Type**: ``uchar[6]``
- **Description**: An array of 6 unsigned characters representing the destination MAC address for the `eth0` network interface. The MAC address is initialized to the values `{0xa, 0xb, 0xc, 0xd, 0xe, 0xf}`.
- **Use**: Used to store the destination MAC address for the `eth0` interface in network operations.


---
### eth0\_src\_mac\_addr
- **Type**: ``uchar[6]``
- **Description**: An array of 6 unsigned characters that represents the source MAC address for the `eth0` network interface. The MAC address is initialized to the values `{0x1, 0x2, 0x3, 0x4, 0x5, 0x6}`.
- **Use**: Used to store the source MAC address for the `eth0` interface in network operations.


---
### eth1\_src\_mac\_addr
- **Type**: ``uchar[6]``
- **Description**: An array of 6 unsigned characters representing the source MAC address for the Ethernet interface `eth1`. The MAC address is initialized to the values `{0xde, 0xf1, 0x23, 0x45, 0x67, 0x89}`.
- **Use**: Used to store the source MAC address for network operations involving the `eth1` interface.


---
### xdp\_rx\_ring\_cons
- **Type**: ``uint``
- **Description**: A static global variable that represents the consumer index for the XDP RX ring. It is initialized to 0.
- **Use**: Tracks the position in the RX ring where the next packet will be consumed.


---
### xdp\_rx\_ring\_prod
- **Type**: ``uint``
- **Description**: A static global variable of type `uint` initialized to 0. It is used to track the producer index of the XDP RX ring.
- **Use**: Tracks the producer index for the XDP RX ring in the `fd_xsk_t` structure.


---
### xdp\_tx\_ring\_cons
- **Type**: ``uint``
- **Description**: `xdp_tx_ring_cons` is a static global variable of type `uint` that is initialized to 0. It is used to track the consumer index of the XDP (eXpress Data Path) transmit ring buffer.
- **Use**: Tracks the consumer index for the XDP transmit ring buffer to manage packet transmission.


---
### xdp\_tx\_ring\_prod
- **Type**: ``uint``
- **Description**: `xdp_tx_ring_prod` is a static global variable of type `uint` that is initialized to 0. It is used to track the producer index of the XDP (eXpress Data Path) transmit ring.
- **Use**: Tracks the producer index for the XDP transmit ring to manage packet transmission.


---
### xdp\_fr\_ring\_cons
- **Type**: ``uint``
- **Description**: `xdp_fr_ring_cons` is a static global variable of type `uint` that is initialized to 0. It is used to track the consumer index of the XDP fill ring in a network packet processing context.
- **Use**: Tracks the consumer index of the XDP fill ring.


---
### xdp\_fr\_ring\_prod
- **Type**: ``uint``
- **Description**: A static unsigned integer variable initialized to 0.
- **Use**: Tracks the production sequence number for the XDP fill ring.


---
### xdp\_cr\_ring\_cons
- **Type**: ``uint``
- **Description**: `xdp_cr_ring_cons` is a static unsigned integer variable initialized to 0. It is used to track the consumer index of the completion ring in an XDP (eXpress Data Path) context.
- **Use**: Tracks the consumer index of the completion ring in an XDP context.


---
### xdp\_cr\_ring\_prod
- **Type**: ``uint``
- **Description**: A static unsigned integer variable initialized to 0.
- **Use**: Tracks the production sequence number for the XDP completion ring.


---
### xdp\_rx\_flags
- **Type**: ``uint``
- **Description**: `xdp_rx_flags` is a static unsigned integer variable initialized to 0. It is used to store flags related to the XDP (eXpress Data Path) receive operations.
- **Use**: Used to manage and track the state or configuration of XDP receive operations.


---
### xdp\_tx\_flags
- **Type**: ``uint``
- **Description**: Stores flags related to the transmission (TX) operations in the XDP (eXpress Data Path) context. It is initialized to zero, indicating no flags are set initially.
- **Use**: Used to manage and track the state or configuration of TX operations in the XDP context.


---
### xdp\_fr\_flags
- **Type**: ``uint``
- **Description**: Represents a static unsigned integer variable initialized to 0. It is used to store flags related to the XDP (eXpress Data Path) frame ring.
- **Use**: Used to manage and track the state or configuration of the XDP frame ring in the network processing context.


---
### xdp\_cr\_flags
- **Type**: ``uint``
- **Description**: A static unsigned integer variable initialized to 0.
- **Use**: Stores flags related to the XDP (eXpress Data Path) completion ring.


---
### populate\_test\_vectors
- **Type**: `function`
- **Description**: Populates test vectors with network packets for testing purposes. It initializes GRE and non-GRE packet templates and fills arrays with these templates, modifying certain fields to create unique test packets.
- **Use**: Used to prepare test data for network packet processing tests.


# Data Structures

---
### gre\_pkt\_t
- **Type**: ``struct``
- **Members**:
    - ``eth``: Contains the Ethernet header information.
    - ``outer_ip4``: Holds the outer IPv4 header for the packet.
    - ``gre``: Stores the GRE header details.
    - ``inner_ip4``: Contains the inner IPv4 header for encapsulated data.
    - ``udp``: Holds the UDP header information.
    - ``data``: An array of 3 unsigned characters for additional data.
- **Description**: Defines a packed structure for a GRE packet, including Ethernet, outer and inner IPv4, GRE, and UDP headers, along with a small data payload.


---
### pkt\_t
- **Type**: ``struct``
- **Members**:
    - `eth`: Contains the Ethernet header of the packet.
    - `ip4`: Contains the IPv4 header of the packet.
    - `udp`: Contains the UDP header of the packet.
    - `data`: Holds a fixed-size array of 3 unsigned characters for additional packet data.
- **Description**: Defines a network packet structure with Ethernet, IPv4, and UDP headers, followed by a small data payload. The `__attribute__((packed))` ensures that the compiler does not add any padding between the fields, which is important for network packet structures to maintain a specific layout.


---
### fd\_tile\_test\_locals
- **Type**: ``struct``
- **Members**:
    - ``xsk``: Pointer to an `fd_xsk_t` structure, representing the XDP socket.
    - ``xsk_base``: Pointer to the base address of the XDP socket memory.
    - ``fr_ring_depth``: Depth of the fill ring buffer.
    - ``rx_ring_prod``: Producer index for the RX ring buffer.
    - ``fr_ring_cons``: Consumer index for the fill ring buffer.
    - ``rx_gre_pkt_idx``: Index into the `rx_gre_pkt` array.
    - ``rx_pkt_idx``: Index into the `rx_pkt` array.
    - ``rx_pkt_ref_idx``: Index into the `rx_pkt` array for before_credit check.
    - ``tx_input_pkt_idx``: Index into the `tx_pkt_input` array.
    - ``tx_output_pkt_idx``: Index into the `tx_pkt_output` array.
    - ``tx_output_gre_pkt_idx``: Index into the `tx_gre_pkt_output` array.
    - ``tx_input_dst_ip``: Destination IP address for the input packet.
    - ``tx_is_gre``: Flag indicating if the packet is a GRE packet.
    - ``tx_output_sz``: Size of the expected output packet.
    - ``tx_output``: Pointer to the expected output packet.
- **Description**: The `fd_tile_test_locals` structure is used to manage the state and indices related to packet processing in an XDP (eXpress Data Path) environment. It includes pointers and indices for managing XDP socket rings, packet indices for both GRE and non-GRE packets, and fields for handling transmission details such as destination IP, packet type, and expected output size. This structure is essential for tracking the flow and processing of packets in a network test scenario.


# Functions

---
### add\_neighbor<!-- {{#callable:add_neighbor}} -->
[View Source →](<../../../../../../src/disco/net/xdp/test_xdp_tile1.c#L139>)

Adds a neighbor entry to a hash map with a specified IPv4 address and MAC address.
- **Inputs**:
    - ``join``: A pointer to a `fd_neigh4_hmap_t` structure representing the hash map where the neighbor entry will be added.
    - ``ip4_addr``: An unsigned integer representing the IPv4 address of the neighbor.
    - ``mac0``: An unsigned character representing the first byte of the MAC address.
    - ``mac1``: An unsigned character representing the second byte of the MAC address.
    - ``mac2``: An unsigned character representing the third byte of the MAC address.
    - ``mac3``: An unsigned character representing the fourth byte of the MAC address.
    - ``mac4``: An unsigned character representing the fifth byte of the MAC address.
    - ``mac5``: An unsigned character representing the sixth byte of the MAC address.
- **Logic and Control Flow**:
    - Prepare a query for the hash map using `fd_neigh4_hmap_prepare` with the given `ip4_addr` and check if the preparation is successful.
    - Retrieve the element from the query using `fd_neigh4_hmap_query_ele`.
    - Set the state of the element to `FD_NEIGH4_STATE_ACTIVE`.
    - Assign the `ip4_addr` to the element's `ip4_addr` field.
    - Assign the MAC address bytes to the element's `mac_addr` array.
    - Publish the query using `fd_neigh4_hmap_publish`.
- **Output**: No return value; the function modifies the hash map by adding or updating a neighbor entry.


---
### setup\_routing\_table<!-- {{#callable:setup_routing_table}} -->
[View Source →](<../../../../../../src/disco/net/xdp/test_xdp_tile1.c#L155>)

Configures the routing table by inserting predefined routes and hops into the local and main FIB4 tables.
- **Inputs**:
    - ``ctx``: A pointer to `fd_net_ctx_t` structure that contains the local and main FIB4 tables to be configured.
- **Logic and Control Flow**:
    - Retrieve `fib_local` and `fib_main` from `ctx` and verify they are not NULL using `FD_TEST` macro.
    - Define several `fd_fib4_hop_t` structures (`hop1` to `hop7`) with specific interface indices, source IP addresses, and route types.
    - Insert each hop into the appropriate FIB4 table (`fib_local` or `fib_main`) using `fd_fib4_insert` and verify success with `FD_TEST`.
    - Assign the modified `fib_local` and `fib_main` back to `ctx`.
- **Output**: No return value; modifies the routing tables within the `ctx` structure.


---
### setup\_neighbor\_table<!-- {{#callable:setup_neighbor_table}} -->
[View Source →](<../../../../../../src/disco/net/xdp/test_xdp_tile1.c#L209>)

Initializes the neighbor table in the network context by adding specific IP and MAC address mappings.
- **Inputs**:
    - `ctx`: A pointer to the `fd_net_ctx_t` structure, which contains the network context including the neighbor table to be set up.
- **Logic and Control Flow**:
    - Retrieve the `neigh4_hmap` from the `ctx` structure.
    - Call [`add_neighbor`](<#add_neighbor>) to add a mapping for `gre0_outer_dst_ip` with the MAC address from `eth0_dst_mac_addr`.
    - Call [`add_neighbor`](<#add_neighbor>) to add a mapping for `gre1_outer_dst_ip` with the MAC address from `eth0_dst_mac_addr`.
    - Call [`add_neighbor`](<#add_neighbor>) to add a mapping for `gw_ip` with the MAC address from `eth0_dst_mac_addr`.
- **Output**: No return value; the function modifies the neighbor table within the provided network context.
- **Functions Called**:
    - [`add_neighbor`](<#add_neighbor>)


---
### setup\_netdev\_table<!-- {{#callable:setup_netdev_table}} -->
[View Source →](<../../../../../../src/disco/net/xdp/test_xdp_tile1.c#L217>)

Initializes the network device table in the given context with predefined configurations for GRE, Ethernet, and Loopback interfaces.
- **Inputs**:
    - `ctx`: A pointer to an `fd_net_ctx_t` structure that holds the network context, including the network device table to be set up.
- **Logic and Control Flow**:
    - Assigns a GRE interface configuration to `ctx->netdev_tbl.dev_tbl[IF_IDX_GRE0]` with specific interface index, device type, and source/destination IP addresses.
    - Assigns a GRE interface configuration to `ctx->netdev_tbl.dev_tbl[IF_IDX_GRE1]` with specific interface index, device type, and destination IP address.
    - Assigns an Ethernet interface configuration to `ctx->netdev_tbl.dev_tbl[IF_IDX_ETH0]` with specific interface index and device type.
    - Assigns an Ethernet interface configuration to `ctx->netdev_tbl.dev_tbl[IF_IDX_ETH1]` with specific interface index and device type.
    - Assigns a Loopback interface configuration to `ctx->netdev_tbl.dev_tbl[IF_IDX_LO]` with specific interface index and device type.
    - Copies the source MAC address for `IF_IDX_ETH0` from `eth0_src_mac_addr` to `ctx->netdev_tbl.dev_tbl[IF_IDX_ETH0].mac_addr`.
    - Copies the source MAC address for `IF_IDX_ETH1` from `eth1_src_mac_addr` to `ctx->netdev_tbl.dev_tbl[IF_IDX_ETH1].mac_addr`.
    - Sets the device count in the network device table header to `IF_IDX_GRE1 + 1`.
- **Output**: No return value; the function modifies the `ctx` structure in place.


---
### xdp\_find\_in\_idx<!-- {{#callable:xdp_find_in_idx}} -->
[View Source →](<../../../../../../src/disco/net/xdp/test_xdp_tile1.c#L253>)

Finds the index of a memory block in the `ctx->in` array that matches the `test_link->base` and assigns it to `test_link->in_idx`.
- **Inputs**:
    - `test_link`: A pointer to an `fd_tile_test_link_t` structure, which contains a `base` member to be matched against the `mem` member of elements in the `ctx->in` array.
    - `ctx`: A pointer to an `fd_net_ctx_t` structure, which contains an array `in` of structures with a `mem` member to be compared against `test_link->base`.
- **Logic and Control Flow**:
    - Iterate over each element in the `ctx->in` array using a loop with index `i`.
    - For each element, check if the `mem` member of the current element matches `test_link->base`.
    - If a match is found, assign the current index `i` to `test_link->in_idx` and exit the loop.
- **Output**: No explicit return value; modifies `test_link->in_idx` to store the index of the matching element.


---
### mock\_privileged\_init<!-- {{#callable:mock_privileged_init}} -->
[View Source →](<../../../../../../src/disco/net/xdp/test_xdp_tile1.c#L265>)

Initializes network context and XSK (AF_XDP socket) for a given tile in a topology.
- **Inputs**:
    - ``topo``: Pointer to the topology structure `fd_topo_t`.
    - ``tile``: Pointer to the tile structure `fd_topo_tile_t`.
- **Logic and Control Flow**:
    - Allocates scratch memory for network context and free transaction queue using `FD_SCRATCH_ALLOC_INIT` and `FD_SCRATCH_ALLOC_APPEND` macros.
    - Initializes the network context `ctx` to zero using `fd_memset`.
    - Sets up the source MAC address and default IP address for the network context.
    - Aligns and calculates the size of the UMEM region for packet data storage, ensuring it is 4096-byte aligned.
    - Calculates chunk bounds for the UMEM region and checks for validity, logging errors if bounds are invalid.
    - Sets up the free transaction queue in the network context with the depth specified in the tile's XDP configuration.
    - Configures XSK parameters, including interface index, queue ID, bind flags, and queue depths, based on the tile's XDP configuration.
    - Initializes the XSK structure `xsk` with the configured parameters, checking for errors in the parameters and logging errors if any are found.
    - Joins a workspace for XSK ring buffers and allocates memory for packet and frame rings, checking for successful allocation.
    - Sets up ring producers, consumers, and flags for RX, TX, FR, and CR rings in the XSK structure.
    - Sets the program link file descriptor and XSK count in the network context.
- **Output**: No return value; the function modifies the network context and XSK structures in place.


---
### quic\_publish<!-- {{#callable:quic_publish}} -->
[View Source →](<../../../../../../src/disco/net/xdp/test_xdp_tile1.c#L481>)

Selects and publishes a packet for transmission based on the current loop index, updating packet indices and returning the size of the packet.
- **Inputs**:
    - ``test_ctx``: A pointer to `fd_tile_test_ctx_t`, which contains the test context including local variables and state.
    - ``quic_net_link``: A pointer to `fd_tile_test_link_t`, representing the network link for QUIC communication.
- **Logic and Control Flow**:
    - Retrieve local variables from `test_ctx`.
    - Determine the type of packet to publish based on `test_ctx->loop_i % 3`.
    - For case 0, set up GRE packet parameters and update local variables.
    - For case 1, set up non-GRE packet parameters and update local variables.
    - For case 2, set up parameters for an invalid destination and update local variables.
    - Assign the destination IP address to the input packet's destination address.
    - Copy the input packet to the location specified by `quic_net_link` using `fd_memcpy`.
    - Increment the packet indices for GRE, non-GRE, and input packets.
    - Return the size of the packet, `sizeof(pkt_t)`.
- **Output**: Returns the size of the packet, which is `sizeof(pkt_t)`.


---
### quic\_make\_sig<!-- {{#callable:quic_make_sig}} -->
[View Source →](<../../../../../../src/disco/net/xdp/test_xdp_tile1.c#L527>)

Generates a signature for a QUIC network packet using the destination IP and a predefined QUIC port.
- **Inputs**:
    - ``test_ctx``: A pointer to a `fd_tile_test_ctx_t` structure containing the test context, including local variables and state information.
    - ``quic_net_link``: A pointer to a `fd_tile_test_link_t` structure representing the QUIC network link, marked as unused in this function.
- **Logic and Control Flow**:
    - Calls the function `fd_disco_netmux_sig` with parameters: 0, `QUIC_PORT`, `test_ctx->locals->tx_input_dst_ip`, `DST_PROTO_OUTGOING`, and 0.
    - Returns the result of the `fd_disco_netmux_sig` function call.
- **Output**: Returns an unsigned long integer representing the generated signature for the QUIC network packet.


---
### quic\_bf\_check<!-- {{#callable:quic_bf_check}} -->
[View Source →](<../../../../../../src/disco/net/xdp/test_xdp_tile1.c#L535>)

Validates the routing logic and packet attributes in a network context against expected values.
- **Inputs**:
    - ``test_ctx``: A pointer to `fd_tile_test_ctx_t`, which contains the test context including expected filter and packet attributes.
    - ``ctx``: A pointer to `fd_net_ctx_t`, which contains the network context including the current packet operation details.
- **Logic and Control Flow**:
    - Check if `test_ctx->filter` matches `test_ctx->filter_exp`; if not, log a warning and return -1.
    - If `test_ctx->filter_exp` is true, return 0 immediately.
    - Check if `ctx->tx_op.frame` is assigned; if not, log a warning and return -1.
    - Verify if `ctx->tx_op.use_gre` matches `test_ctx->locals->tx_is_gre`; if not, log a warning and return -1.
    - Compare `ctx->tx_op.mac_addrs` with expected destination and source MAC addresses; if they do not match, log a warning and return -1.
    - If `test_ctx->locals->tx_is_gre` is true, verify the inner and outer source and destination IP addresses in the GRE packet; if any do not match, log a warning and return -1.
    - If `test_ctx->locals->tx_is_gre` is false, verify the source IP address in the non-GRE packet; if it does not match, log a warning and return -1.
    - Return 0 if all checks pass.
- **Output**: Returns 0 if all checks pass, otherwise returns -1 if any check fails.


---
### xsk\_af\_check<!-- {{#callable:xsk_af_check}} -->
[View Source →](<../../../../../../src/disco/net/xdp/test_xdp_tile1.c#L590>)

Verifies if the transmitted packet matches the expected output packet in the XDP socket's TX ring.
- **Inputs**:
    - ``test_ctx``: A pointer to `fd_tile_test_ctx_t`, which contains the test context and local variables.
    - ``ctx``: A pointer to `fd_net_ctx_t`, which contains the network context and configuration.
- **Logic and Control Flow**:
    - Retrieve the local variables from `test_ctx` and the TX descriptor from the XDP socket's TX ring.
    - Calculate the memory address of the output packet using the descriptor's address and the UMEM frame base address from `ctx`.
    - Check if the length of the TX descriptor matches the expected output size stored in `test_ctx`'s locals.
    - Compare the memory content of the output packet with the expected output packet using `fd_memeq`.
    - If the length or content does not match, log a warning and return -1.
    - If the packet matches, return 0.
- **Output**: Returns 0 if the packet matches the expected output, otherwise returns -1.


---
### select\_tx\_path\_in\_link<!-- {{#callable:select_tx_path_in_link}} -->
[View Source →](<../../../../../../src/disco/net/xdp/test_xdp_tile1.c#L608>)

Assigns the transmission link from the `test_links` array to the `in_link` field of `test_ctx`.
- **Inputs**:
    - ``test_links``: An array of pointers to `fd_tile_test_link_t` structures, representing the available test links.
    - ``test_ctx``: A pointer to an `fd_tile_test_ctx_t` structure, which holds the context for the tile test.
    - ``ctx``: A pointer to an `fd_net_ctx_t` structure, which is unused in this function.
- **Logic and Control Flow**:
    - Access the `test_links` array using the `TEST_LINK_TX` index to get the transmission link.
    - Assign the transmission link to the `in_link` field of the `test_ctx` structure.
- **Output**: No output is returned as the function is of type `void`.


---
### xsk\_recv<!-- {{#callable:xsk_recv}} -->
[View Source →](<../../../../../../src/disco/net/xdp/test_xdp_tile1.c#L619>)

Receives a packet from the fill ring, processes it, and pushes it into the RX ring.
- **Inputs**:
    - ``test_ctx``: A pointer to `fd_tile_test_ctx_t` structure containing the test context and local variables.
- **Logic and Control Flow**:
    - Retrieve the `xsk` pointer from `locals` in `test_ctx`.
    - Assert that `xsk` is not NULL using `FD_TEST`.
    - Retrieve a frame offset from the fill ring using `fr_ring_cons` and `fr_ring_depth`.
    - Increment the fill ring consumer index and update the fill ring consumer pointer.
    - Select a packet to receive based on the loop index modulo 2, choosing between GRE and non-GRE packets.
    - Assert that the selected packet is not NULL using `FD_TEST`.
    - Copy the selected packet into the frame at the calculated offset in the RX ring.
    - Push the frame into the RX ring by updating the packet ring with the frame offset and packet size.
    - Increment the RX ring producer index and update the RX ring producer pointer.
    - Update the packet indices for GRE and non-GRE packets.
- **Output**: No return value; the function operates on the `test_ctx` and its associated structures.


---
### select\_rx\_path\_out\_links<!-- {{#callable:select_rx_path_out_links}} -->
[View Source →](<../../../../../../src/disco/net/xdp/test_xdp_tile1.c#L667>)

Selects the output link for receiving packets and processes the packet reception.
- **Inputs**:
    - ``test_links``: An array of pointers to `fd_tile_test_link_t` structures representing the test links.
    - ``test_ctx``: A pointer to `fd_tile_test_ctx_t` structure representing the test context.
    - ``ctx``: A pointer to `fd_net_ctx_t` structure representing the network context, marked as unused in this function.
- **Logic and Control Flow**:
    - Call the [`xsk_recv`](<#xsk_recv>) function with `test_ctx` to receive a packet.
    - Call `fd_tile_test_check_output` with `FD_TILE_TEST_CALLBACK_BEFORE_CREDIT` and the RX test link to check the output.
- **Output**: No return value; the function operates through side effects on the provided structures.
- **Functions Called**:
    - [`xsk_recv`](<#xsk_recv>)


---
### quic\_out\_check<!-- {{#callable:quic_out_check}} -->
[View Source →](<../../../../../../src/disco/net/xdp/test_xdp_tile1.c#L676>)

Validates the size and content of a packet in a network link against expected values and updates the sequence number if successful.
- **Inputs**:
    - ``test_ctx``: A pointer to `fd_tile_test_ctx_t`, which contains the test context including local variables and state.
    - ``ctx``: A pointer to `fd_net_ctx_t`, which is unused in this function.
    - ``net_quic_link``: A pointer to `fd_tile_test_link_t`, representing the network link to check.
- **Logic and Control Flow**:
    - Calculate the memory line index using `fd_mcache_line_idx` with `net_quic_link->prod_seq` and `net_quic_link->depth` to get `mline`.
    - Check if the size of the packet (`mline->sz`) matches the expected size (`sizeof(pkt_t)`).
    - If the size does not match, log a warning and return -1.
    - Calculate the output memory address using `fd_chunk_to_laddr` and `mline->ctl`.
    - Compare the memory content at the output address with the reference packet using `fd_memeq`.
    - If the content does not match, log a hexdump warning for both the output and reference, log additional warnings, and return -1.
    - If the size and content match, increment the production sequence number using `fd_seq_inc` and return 0.
- **Output**: Returns 0 if the packet size and content match the expected values, otherwise returns -1.


---
### xdp\_reset<!-- {{#callable:xdp_reset}} -->
[View Source →](<../../../../../../src/disco/net/xdp/test_xdp_tile1.c#L702>)

Resets the XDP context by initializing various network tables, clearing packet rings, and setting flags and counters to zero.
- **Inputs**:
    - ``test_ctx``: A pointer to `fd_tile_test_ctx_t`, which holds the test context and local state for the XDP tile test.
    - ``ctx``: A pointer to `fd_net_ctx_t`, which contains the network context including XDP socket and memory information.
- **Logic and Control Flow**:
    - Assigns the first XDP socket from `ctx` to `xsk` and updates `test_ctx->locals` with this socket and its base memory address.
    - Calls [`setup_routing_table`](<#setup_routing_table>), [`setup_neighbor_table`](<#setup_neighbor_table>), and [`setup_netdev_table`](<#setup_netdev_table>) to initialize network tables in `ctx`.
    - Checks for the existence of a GRE interface using [`net_check_gre_interface_exists`](<fd_xdp_tile.c.md#net_check_gre_interface_exists>) and asserts its presence with `FD_TEST`.
    - Clears the packet rings (`ring_rx`, `ring_tx`, `ring_fr`, `ring_cr`) using `fd_memset` to set all entries to zero.
    - Resets the production and consumption indices (`xdp_rx_ring_prod`, `xdp_rx_ring_cons`, etc.) and flags (`xdp_rx_flags`, `xdp_tx_flags`, etc.) to zero.
    - Sets the cached production and consumption indices for each ring in `xsk` to zero.
    - Sets `ctx->next_xdp_stats_refresh` to `LONG_MAX` to avoid polling XDP statistics.
- **Output**: No return value; the function modifies the state of `test_ctx` and `ctx` in place.
- **Functions Called**:
    - [`setup_routing_table`](<#setup_routing_table>)
    - [`setup_neighbor_table`](<#setup_neighbor_table>)
    - [`setup_netdev_table`](<#setup_netdev_table>)
    - [`net_check_gre_interface_exists`](<fd_xdp_tile.c.md#net_check_gre_interface_exists>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../../src/disco/net/xdp/test_xdp_tile1.c#L736>)

Initializes and runs a tile unit test for network packet processing using XDP and GRE tunnels.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Retrieves the random number generator seed from the command line using `fd_env_strip_cmdline_uint`.
    - Initializes a random number generator with `fd_rng_new` and `fd_rng_join`.
    - Sets up the tile unit test environment with `fd_tile_unit_test_init`, using default and user-specified topology configurations.
    - Registers metrics using `fd_metrics_register` and `fd_metrics_new`.
    - Finds and validates the network tile index with `fd_topo_find_tile` and `FD_TEST`.
    - Initializes network context with [`mock_privileged_init`](<#mock_privileged_init>) and [`unprivileged_init`](<fd_xdp_tile.c.md#unprivileged_init>).
    - Checks the initial device table for GRE interface existence with [`net_check_gre_interface_exists`](<fd_xdp_tile.c.md#net_check_gre_interface_exists>).
    - Initializes test links for transmission and reception using `fd_tile_test_init_link_in` and `fd_tile_test_init_link_out`.
    - Populates test vectors with `populate_test_vectors`.
    - Runs the tile test twice with `fd_tile_test_reset_env`, [`xdp_reset`](<#xdp_reset>), and `fd_tile_test_run`.
    - Deletes the random number generator with `fd_rng_delete` and `fd_rng_leave`.
    - Logs the test result and halts the program with `FD_LOG_NOTICE` and `fd_halt`.
- **Output**: The function does not return a value; it performs initialization, testing, and cleanup operations.
- **Functions Called**:
    - [`mock_privileged_init`](<#mock_privileged_init>)
    - [`unprivileged_init`](<fd_xdp_tile.c.md#unprivileged_init>)
    - [`net_check_gre_interface_exists`](<fd_xdp_tile.c.md#net_check_gre_interface_exists>)
    - [`net_tx_route`](<fd_xdp_tile.c.md#net_tx_route>)
    - [`xdp_reset`](<#xdp_reset>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)