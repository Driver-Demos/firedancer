<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for XDP tile packet processing, including setup of network and routing tables, and packet handling logic.

# Purpose
The code is a C program that sets up and tests a network processing environment using XDP (eXpress Data Path) and GRE (Generic Routing Encapsulation) tunnels. It includes the configuration of network interfaces, routing tables, and neighbor tables, and it simulates packet processing through a series of test cases. The program uses various libraries and modules to manage network contexts, memory allocation, and packet handling. It defines constants and structures for network configuration, such as IP addresses and MAC addresses, and it includes functions to add neighbors and set up routing and network device tables.

The [`main`](<#main>) function initializes the network environment, including memory workspaces and network topology, and it sets up the necessary data structures for packet processing. It then runs a series of test loops to validate the packet processing logic, including GRE encapsulation and standard packet handling. The tests involve simulating packet reception, routing, and transmission, and they verify the correctness of the network operations by comparing expected and actual packet data. The program uses macros and functions from included libraries to perform operations like memory copying, checksum calculation, and network device configuration.
# Imports and Dependencies

---
- `linux/if_arp.h`
- `linux/if_link.h`
- `stdlib.h`
- `fd_xdp_tile.c`
- `../../../disco/topo/fd_topob.h`
- `../../../waltz/neigh/fd_neigh4_map.h`
- `../../../util/net/fd_ip4.h`
- `../../../waltz/ip/fd_fib4.h`
- `../../../util/tmpl/fd_map.h`
- `../../../tango/dcache/fd_dcache.h`
- `../../../tango/mcache/fd_mcache.h`


# Global Variables

---
### wksp\_scratch
- **Type**: ``uchar[]``
- **Description**: An array of unsigned characters (`uchar`) with a size defined by `SCRATCH_MAX`, which is set to 5MB. The array is aligned to the size of a normal shared memory page (`FD_SHMEM_NORMAL_PAGE_SZ`).
- **Use**: Used as a scratch workspace memory area for various operations, including memory allocation and data storage in the program.


---
### banned\_ip
- **Type**: ``uint``
- **Description**: Represents an IPv4 address that is blackholed at the route table. The address is defined using the `FD_IP4_ADDR` macro with the values `7,0,0,1`. This indicates that any traffic to this IP address is intentionally dropped or ignored by the network routing logic.
- **Use**: Used in the routing table setup to define a blackhole route, ensuring that packets destined for this IP are discarded.


---
### default\_src\_ip
- **Type**: ``uint``
- **Description**: Represents the default source IP address used in network configurations. It is defined as a constant 32-bit unsigned integer using the `FD_IP4_ADDR` macro to convert the IP address 64.130.35.241 into a suitable format.
- **Use**: Used as the default source IP address in network routing and configuration settings.


---
### random\_ip
- **Type**: ``uint``
- **Description**: Represents an IPv4 address in a 32-bit unsigned integer format. The address is set to `64.130.35.240` using the `FD_IP4_ADDR` macro.
- **Use**: Used as a placeholder or example IP address in the network configuration.


---
### gw\_ip
- **Type**: ``uint``
- **Description**: Represents the IP address of the gateway in the network configuration. It is defined as a constant unsigned integer using the `FD_IP4_ADDR` macro to convert the IP address 192.168.1.1 into a suitable format for use in the program.
- **Use**: Used in the setup of routing tables and neighbor tables to define the gateway IP address for network operations.


---
### gre0\_src\_ip
- **Type**: ``uint``
- **Description**: Represents the source IP address for the GRE0 interface, defined as a constant using the `FD_IP4_ADDR` macro with the IP address 192.168.123.1.
- **Use**: Used in network configurations and routing tables to specify the source IP for GRE0 tunnels.


---
### gre0\_dst\_ip
- **Type**: ``uint``
- **Description**: Represents the destination IP address for the GRE0 tunnel interface. It is defined as a constant using the `FD_IP4_ADDR` macro with the IP address 192.168.123.6.
- **Use**: Used in the setup of routing tables and network configurations for GRE0 tunnel operations.


---
### gre0\_outer\_src\_ip
- **Type**: ``uint``
- **Description**: Represents the outer source IP address for the GRE0 tunnel interface. It is defined as a constant using the `FD_IP4_ADDR` macro to set the IP address to 10.0.0.1.
- **Use**: Used in network configurations to specify the source IP for GRE0 tunnel packets.


---
### gre0\_outer\_dst\_ip
- **Type**: ``uint``
- **Description**: Represents the outer destination IP address for the GRE0 tunnel interface. It is defined as a constant using the `FD_IP4_ADDR` macro with the IP address 10.0.0.2.
- **Use**: Used in network configuration to specify the destination IP for GRE0 tunnel encapsulation.


---
### gre0\_outer\_src\_ip\_fake
- **Type**: ``uint``
- **Description**: Represents a constant IPv4 address used as a fake outer source IP for the GRE0 interface. The address is set to `10.0.0.3` using the `FD_IP4_ADDR` macro.
- **Use**: Used in network configuration to define a fake outer source IP for GRE0 tunnels.


---
### gre1\_src\_ip
- **Type**: ``uint``
- **Description**: Represents the source IP address for the GRE1 interface in the network configuration. It is defined using the `FD_IP4_ADDR` macro with the IP address 193.169.123.1.
- **Use**: Used to specify the source IP address for GRE1 in network routing and configuration.


---
### gre1\_dst\_ip
- **Type**: ``uint``
- **Description**: Represents the destination IP address for the GRE1 tunnel interface. It is defined using the `FD_IP4_ADDR` macro with the IP address 193.169.123.6.
- **Use**: Used in network configuration to specify the destination IP for GRE1 tunnel routing.


---
### gre1\_outer\_src\_ip
- **Type**: ``uint``
- **Description**: Represents the outer source IP address for the GRE1 tunnel interface. It is defined using the `FD_IP4_ADDR` macro to convert the IP address 11.1.0.1 into a 32-bit unsigned integer.
- **Use**: Used in network configuration to specify the source IP for GRE1 tunnel encapsulation.


---
### gre1\_outer\_dst\_ip
- **Type**: ``uint``
- **Description**: Represents the outer destination IP address for the GRE1 tunnel interface. It is defined using the `FD_IP4_ADDR` macro with the IP address 11.1.0.2.
- **Use**: Used to configure the GRE1 tunnel interface's outer destination IP address in network settings.


---
### eth0\_dst\_mac\_addr
- **Type**: ``uchar[6]``
- **Description**: An array of 6 unsigned characters that represents the destination MAC address for the `eth0` network interface. The MAC address is initialized to the values `{0xa, 0xb, 0xc, 0xd, 0xe, 0xf}`.
- **Use**: Used to store the destination MAC address for the `eth0` interface in network operations.


---
### eth0\_src\_mac\_addr
- **Type**: ``uchar[6]``
- **Description**: An array of 6 unsigned characters that represents the source MAC address for the `eth0` network interface. The MAC address is initialized to the values `{0x1, 0x2, 0x3, 0x4, 0x5, 0x6}`.
- **Use**: Used to store the source MAC address for the `eth0` interface in network operations.


---
### eth1\_dst\_mac\_addr
- **Type**: ``uchar[6]``
- **Description**: An array of 6 unsigned characters representing the destination MAC address for the Ethernet interface `eth1`. The MAC address is initialized to the value `{0x12, 0x34, 0x56, 0x78, 0x9a, 0xbc}`.
- **Use**: Used to store the destination MAC address for network operations involving the `eth1` interface.


---
### eth1\_src\_mac\_addr
- **Type**: ``uchar[6]``
- **Description**: An array of 6 unsigned characters that represents the source MAC address for the Ethernet interface `eth1`. The MAC address is initialized to the value `{0xde, 0xf1, 0x23, 0x45, 0x67, 0x89}`.
- **Use**: Used to store the source MAC address for network operations involving the `eth1` interface.


---
### xdp\_rx\_ring\_cons
- **Type**: ``uint``
- **Description**: Represents the consumer index for the XDP RX ring buffer. It is used to track the position in the RX ring where the next packet should be consumed.
- **Use**: Tracks the position in the RX ring for packet consumption in the XDP processing flow.


---
### xdp\_rx\_ring\_prod
- **Type**: ``uint``
- **Description**: A static global variable of type `uint` initialized to 0. It is used to track the producer index of the XDP RX ring.
- **Use**: Tracks the producer index for the XDP RX ring in the network processing context.


---
### xdp\_tx\_ring\_cons
- **Type**: ``uint``
- **Description**: Represents the consumer index for the XDP TX ring buffer. It is initialized to zero and is used to track the position of the next packet to be processed in the TX ring.
- **Use**: Tracks the consumer position in the XDP TX ring for packet transmission.


---
### xdp\_tx\_ring\_prod
- **Type**: ``uint``
- **Description**: Represents the producer index for the XDP TX ring buffer. It is used to track the position where the next packet should be placed in the TX ring for transmission.
- **Use**: Tracks the position for the next packet in the XDP TX ring buffer.


---
### xdp\_tx\_flags
- **Type**: ``uint``
- **Description**: Stores flags related to the XDP (eXpress Data Path) transmission process. It is initialized to zero, indicating no flags are set initially.
- **Use**: Used to control or indicate specific behaviors or states in the XDP transmission process.


---
### xdp\_fr\_ring\_cons
- **Type**: ``uint``
- **Description**: Represents the consumer index for the XDP fill ring. It is used to track the position in the ring where the next frame should be consumed.
- **Use**: Tracks the consumer position in the XDP fill ring for frame management.


---
### xdp\_fr\_ring\_prod
- **Type**: ``uint``
- **Description**: Represents the producer index for the XDP fill ring. It is used to track the number of frames that have been added to the fill ring.
- **Use**: Tracks the number of frames added to the XDP fill ring.


---
### xdp\_cr\_ring\_cons
- **Type**: ``uint``
- **Description**: Represents the consumer index for the XDP completion ring. It is initialized to zero and is used to track the position in the completion ring where the next completed frame will be consumed.
- **Use**: Tracks the consumer index for the XDP completion ring in the network processing context.


---
### xdp\_cr\_ring\_prod
- **Type**: ``uint``
- **Description**: A static unsigned integer variable initialized to 0. It is used to track the production sequence number for the XDP completion ring.
- **Use**: Tracks the production sequence number for the XDP completion ring.


---
### rxq\_depth
- **Type**: `ulong`
- **Description**: Defines the depth of the receive queue for network packet processing.
- **Use**: Used to set the size of the receive queue in the XDP tile configuration.


---
### txq\_depth
- **Type**: ``ulong``
- **Description**: Defines the depth of the transmit queue for network operations. It is a constant value set to 128.
- **Use**: Used to specify the size of the transmit queue in network configurations.


---
### link\_depth
- **Type**: `ulong`
- **Description**: `link_depth` is a static global variable of type `ulong` initialized to 128UL.
- **Use**: It is used to define the depth of a link in the context of network operations.


---
### ring\_fr\_depth
- **Type**: ``uint``
- **Description**: Defines the depth of the fill ring used in the XDP (eXpress Data Path) context. The value is set to 256, calculated as 128U multiplied by 2.
- **Use**: Used to allocate memory for the fill ring in the XDP context, determining how many frames it can hold.


---
### xsk\_rings\_depth
- **Type**: ``uint``
- **Description**: Defines the depth of the XDP socket rings, specifically for the RX, TX, and completion rings. It is a constant value set to 128U.
- **Use**: Used to specify the size of the XDP socket rings for handling network packet processing.


---
### umem\_base
- **Type**: ``void *``
- **Description**: Points to the base address of the user memory (UMEM) region used for packet processing. It is initialized to `wksp_scratch`, which is a statically allocated scratch space for workspace memory.
- **Use**: Used as the starting address for memory operations related to packet processing in the network application.


---
### frame\_sz
- **Type**: ``ulong``
- **Description**: Defines the size of a frame in bytes, set to 2048. This is a constant value used throughout the program.
- **Use**: Used to determine the size of memory frames for network operations.


# Functions

---
### add\_neighbor<!-- {{#callable:add_neighbor}} -->
[View Source →](<../../../../../../src/disco/net/xdp/test_xdp_tile.c#L69>)

Adds a neighbor entry to the IPv4 neighbor hash map with the specified IP address and MAC address.
- **Inputs**:
    - ``join``: A pointer to the `fd_neigh4_hmap_t` structure representing the neighbor hash map to which the entry will be added.
    - ``ip4_addr``: The IPv4 address of the neighbor to be added.
    - ``mac0`, `mac1`, `mac2`, `mac3`, `mac4`, `mac5``: The six bytes of the MAC address of the neighbor to be added.
- **Logic and Control Flow**:
    - Prepare the neighbor hash map for the addition of a new entry using `fd_neigh4_hmap_prepare` with the provided `ip4_addr` and store the result in `query`.
    - Check if the preparation was successful by asserting that `prepare_res` equals `FD_MAP_SUCCESS`.
    - Retrieve the entry element pointer from the query using `fd_neigh4_hmap_query_ele`.
    - Set the state of the entry to `FD_NEIGH4_STATE_ACTIVE`.
    - Assign the provided `ip4_addr` to the entry's `ip4_addr` field.
    - Assign the provided MAC address bytes to the entry's `mac_addr` field.
    - Publish the new entry to the hash map using `fd_neigh4_hmap_publish`.
- **Output**: No return value; the function modifies the neighbor hash map in place.


---
### setup\_routing\_table<!-- {{#callable:setup_routing_table}} -->
[View Source →](<../../../../../../src/disco/net/xdp/test_xdp_tile.c#L85>)

Initializes and configures the local and main routing tables with specific IP routes and hops.
- **Inputs**:
    - `ctx`: A pointer to `fd_net_ctx_t` structure where the routing tables will be stored.
    - `fib4_local_mem`: A pointer to memory allocated for the local FIB4 routing table.
    - `fib4_main_mem`: A pointer to memory allocated for the main FIB4 routing table.
- **Logic and Control Flow**:
    - Join the local and main FIB4 routing tables using `fd_fib4_join` and verify their success with `FD_TEST`.
    - Define several `fd_fib4_hop_t` structures representing different network interfaces and routing types.
    - Insert these hops into the local and main routing tables using `fd_fib4_insert`, verifying each insertion with `FD_TEST`.
    - Assign the joined local and main FIB4 tables to the `fib_local` and `fib_main` fields of the `ctx` structure.
- **Output**: No direct output; modifies the `ctx` structure to include the initialized routing tables.


---
### setup\_netdev\_table<!-- {{#callable:setup_netdev_table}} -->
[View Source →](<../../../../../../src/disco/net/xdp/test_xdp_tile.c#L140>)

Initializes the network device table in the given context with specific configurations for GRE, Ethernet, and loopback interfaces.
- **Inputs**:
    - `ctx`: A pointer to an `fd_net_ctx_t` structure that holds the network context, including the network device table to be set up.
- **Logic and Control Flow**:
    - Assigns configurations for GRE interfaces `IF_IDX_GRE0` and `IF_IDX_GRE1` in the `dev_tbl` array of `ctx->netdev_tbl` with specific interface indices, device types, and IP addresses.
    - Configures Ethernet interfaces `IF_IDX_ETH0` and `IF_IDX_ETH1` with their respective interface indices and device types in the `dev_tbl` array.
    - Sets up the loopback interface `IF_IDX_LO` with its interface index and device type in the `dev_tbl` array.
    - Copies the source MAC addresses for `IF_IDX_ETH0` and `IF_IDX_ETH1` from predefined arrays to the corresponding entries in the `dev_tbl`.
    - Updates the `dev_cnt` field in the `hdr` of `ctx->netdev_tbl` to reflect the number of configured devices.
- **Output**: No return value; the function modifies the `ctx` structure in place.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../../src/disco/net/xdp/test_xdp_tile.c#L175>)

Initializes and tests a network processing environment using shared memory, topology setup, and packet processing simulations.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Determines the CPU index and adjusts it if necessary.
    - Estimates workspace partition and data maximum sizes and creates a new workspace.
    - Joins the shared memory and sets up a mock topology with a tile and its properties.
    - Allocates memory for the network tile and initializes it.
    - Sets up UMEM/dcache for the network tile and verifies its allocation.
    - Mocks RX and TX links, allocating and joining memory caches for them.
    - Initializes routing tables and neighbor tables with specific configurations.
    - Sets up a netdev table with GRE and Ethernet interfaces.
    - Prepares the context for packet processing, including memory allocations and initializations.
    - Runs a test loop to simulate packet processing through different stages: before_credit, before_frag, during_frag, and after_frag.
    - Validates the packet processing by checking expected outcomes at each stage.
    - Logs a success message and halts the program.
- **Output**: The function does not return a value; it performs setup and testing operations, logging success or failure.
- **Functions Called**:
    - [`scratch_align`](<fd_xdp_tile.c.md#scratch_align>)
    - [`scratch_footprint`](<fd_xdp_tile.c.md#scratch_footprint>)
    - [`init_device_table`](<fd_xdp_tile.c.md#init_device_table>)
    - [`setup_routing_table`](<#setup_routing_table>)
    - [`net_check_gre_interface_exists`](<fd_xdp_tile.c.md#net_check_gre_interface_exists>)
    - [`net_tx_route`](<fd_xdp_tile.c.md#net_tx_route>)
    - [`add_neighbor`](<#add_neighbor>)
    - [`setup_netdev_table`](<#setup_netdev_table>)
    - [`before_credit`](<fd_xdp_tile.c.md#before_credit>)
    - [`before_frag`](<fd_xdp_tile.c.md#before_frag>)
    - [`during_frag`](<fd_xdp_tile.c.md#during_frag>)
    - [`after_frag`](<fd_xdp_tile.c.md#after_frag>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)