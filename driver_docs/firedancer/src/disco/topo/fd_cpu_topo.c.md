<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for initializing and printing CPU topology information, including sibling and NUMA node details.

# Purpose
The code provides functionality for managing and querying CPU topology information on a system. It includes functions to read CPU-related data from the file system, specifically from the `/sys/devices/system/cpu/` directory, which is common in Linux environments. The code defines several static and public functions to determine the number of CPUs, check if a CPU is online, find sibling CPUs in hyperthreaded pairs, and initialize a data structure representing the CPU topology. The [`fd_topo_cpus_init`](<#fd_topo_cpus_init>) function populates a `fd_topo_cpus_t` structure with information about each CPU, including its index, online status, NUMA node, and sibling CPU index if applicable.

The code is part of a larger system that likely deals with CPU resource management or monitoring. It includes functions such as [`fd_topo_cpu_cnt`](<#fd_topo_cpu_cnt>) to count the number of CPUs, [`fd_topob_sibling_idx`](<#fd_topob_sibling_idx>) to find sibling CPUs, and [`fd_topo_cpus_printf`](<#fd_topo_cpus_printf>) to log the CPU topology information. The code uses error handling to log and exit on failures, ensuring that any issues with reading the system files or parsing data are reported. The inclusion of headers like `fd_cpu_topo.h` and `fd_shmem_private.h` suggests that this code is part of a broader library or application that deals with CPU topology and shared memory management.
# Imports and Dependencies

---
- `fd_cpu_topo.h`
- `../../util/shmem/fd_shmem_private.h`
- `errno.h`
- `unistd.h`
- `fcntl.h`
- `stdio.h`
- `stdlib.h`


# Functions

---
### read\_uint\_file<!-- {{#callable:read_uint_file}} -->
[View Source →](<../../../../../src/disco/topo/fd_cpu_topo.c#L11>)

Reads an unsigned integer from a file specified by a given path and logs errors if any file operations fail.
- **Inputs**:
    - ``path``: A constant character pointer to the file path from which to read the unsigned integer.
    - ``errmsg_enoent``: A constant character pointer to the error message to log if the file does not exist.
- **Logic and Control Flow**:
    - Open the file at the specified `path` in read mode using `fopen`.
    - If the file cannot be opened, check if the error is due to the file not existing (`ENOENT`).
    - Log an error message using `FD_LOG_ERR` with `errmsg_enoent` if the file does not exist, otherwise log a generic error message.
    - Initialize an unsigned integer `value` to 0.
    - Attempt to read an unsigned integer from the file using `fscanf`.
    - If reading fails, log an error message indicating failure to read the unsigned integer.
    - Close the file using `fclose` and log an error if closing fails.
    - Return the read unsigned integer `value`.
- **Output**: Returns the unsigned integer read from the file.


---
### fd\_topo\_cpu\_cnt<!-- {{#callable:fd_topo_cpu_cnt}} -->
[View Source →](<../../../../../src/disco/topo/fd_cpu_topo.c#L26>)

Determines the total number of CPUs present in the system by reading the CPU range from the system file `/sys/devices/system/cpu/present`.
- **Inputs**: None
- **Logic and Control Flow**:
    - Declare a character array `path` with size `PATH_MAX` and use `fd_cstr_printf_check` to format the path to `/sys/devices/system/cpu/present`.
    - Declare a character array `line` with size 128 to store the content read from the file.
    - Open the file at the path stored in `path` using `open` with read-only access.
    - If the file descriptor `fd` is -1, log an error and exit.
    - Read the content of the file into `line` using `read`.
    - If `read` returns -1, log an error and exit; if the number of bytes read is greater than or equal to the size of `line`, log a buffer too small error and exit.
    - Close the file descriptor `fd` and log an error if `close` fails.
    - Terminate the string in `line` by setting `line[bytes_read]` to '\0'.
    - Use `strtok_r` to tokenize `line` using '-' as the delimiter to find the end of the CPU range.
    - Convert the token representing the end of the CPU range to an unsigned long using `fd_cstr_to_ulong`.
    - Return the value of the end of the CPU range plus one.
- **Output**: Returns the total number of CPUs as an unsigned long integer.


---
### fd\_topob\_sibling\_idx<!-- {{#callable:fd_topob_sibling_idx}} -->
[View Source →](<../../../../../src/disco/topo/fd_cpu_topo.c#L54>)

Finds the sibling CPU index for a given CPU index by reading the system's CPU topology information.
- **Inputs**:
    - `cpu_idx`: The index of the CPU for which to find the sibling CPU index.
- **Logic and Control Flow**:
    - Constructs a file path to the CPU's topology information using `cpu_idx`.
    - Opens the file at the constructed path for reading.
    - Reads the contents of the file into a buffer `line`.
    - Checks if the read operation was successful and if the buffer size was sufficient.
    - Closes the file descriptor after reading.
    - Searches for a comma in the `line` to separate sibling CPU indices.
    - If no comma is found, returns `ULONG_MAX`.
    - Parses the first and second CPU indices from the `line`.
    - Checks for parsing errors and logs an error if any occur.
    - Compares the parsed indices with `cpu_idx` to determine the sibling index.
    - Returns the sibling CPU index if found, otherwise logs an error.
- **Output**: The sibling CPU index if found, otherwise `ULONG_MAX` if no sibling is found or an error occurs.


---
### fd\_topo\_cpus\_online<!-- {{#callable:fd_topo_cpus_online}} -->
[View Source →](<../../../../../src/disco/topo/fd_cpu_topo.c#L86>)

Checks if a specified CPU is online by reading its status from the system file.
- **Inputs**:
    - `cpu_idx`: The index of the CPU to check if it is online.
- **Logic and Control Flow**:
    - If `cpu_idx` is 0, return 1 because CPU 0 cannot be set to offline.
    - Create a file path string for the CPU's online status file using `fd_cstr_printf_check`.
    - Call [`read_uint_file`](<#read_uint_file>) with the constructed path to read the online status of the CPU.
    - Return the result of [`read_uint_file`](<#read_uint_file>) as an integer.
- **Output**: Returns 1 if the CPU is online, otherwise returns 0.
- **Functions Called**:
    - [`read_uint_file`](<#read_uint_file>)


---
### fd\_topo\_cpus\_init<!-- {{#callable:fd_topo_cpus_init}} -->
[View Source →](<../../../../../src/disco/topo/fd_cpu_topo.c#L95>)

Initializes the CPU topology structure with information about each CPU's index, online status, NUMA node, and sibling CPU.
- **Inputs**:
    - `cpus`: A pointer to an `fd_topo_cpus_t` structure that will be initialized with CPU topology information.
- **Logic and Control Flow**:
    - Set `cpus->numa_node_cnt` to the number of NUMA nodes using `fd_numa_node_cnt()`.
    - Set `cpus->cpu_cnt` to the total number of CPUs using `fd_topo_cpu_cnt()`.
    - Iterate over each CPU index from 0 to `cpus->cpu_cnt - 1`.
    - For each CPU, set `cpus->cpu[i].idx` to the current index `i`.
    - Determine if the CPU is online using `fd_topo_cpus_online(i)` and set `cpus->cpu[i].online`.
    - Set `cpus->cpu[i].numa_node` to the NUMA node index of the CPU using `fd_numa_node_idx(i)`.
    - If the CPU is online, set `cpus->cpu[i].sibling` to the sibling CPU index using `fd_topob_sibling_idx(i)`; otherwise, set it to `ULONG_MAX`.
- **Output**: The function does not return a value; it initializes the `fd_topo_cpus_t` structure pointed to by `cpus` with CPU topology data.
- **Functions Called**:
    - [`fd_topo_cpu_cnt`](<#fd_topo_cpu_cnt>)
    - [`fd_topo_cpus_online`](<#fd_topo_cpus_online>)
    - [`fd_topob_sibling_idx`](<#fd_topob_sibling_idx>)


---
### fd\_topo\_cpus\_printf<!-- {{#callable:fd_topo_cpus_printf}} -->
[View Source →](<../../../../../src/disco/topo/fd_cpu_topo.c#L109>)

Logs the status of each CPU in the `fd_topo_cpus_t` structure.
- **Inputs**:
    - `cpus`: A pointer to an `fd_topo_cpus_t` structure containing CPU information.
- **Logic and Control Flow**:
    - Iterates over each CPU in the `cpus` structure using a for loop.
    - For each CPU, logs its index, online status, sibling index, and NUMA node using `FD_LOG_NOTICE`.
- **Output**: No return value; outputs log messages for each CPU.



---
Made with ❤️ by [Driver](https://www.driver.ai/)