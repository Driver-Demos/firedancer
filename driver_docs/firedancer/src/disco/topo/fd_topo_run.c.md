<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Manages the execution of tiles in a topology, including logging, sandboxing, and thread management.

# Purpose
The code is a C source file that manages the execution of "tiles" within a topology framework. It provides functionality to initialize, configure, and run these tiles, which are likely components or processes within a larger system. The file includes functions for setting up logging, handling debugger attachment, and managing thread execution for tiles. It also includes mechanisms for sandboxing processes, which involves setting resource limits and configuring security policies using seccomp filters. The code is structured to support both single-threaded and multi-threaded execution of tiles, with provisions for setting CPU affinity and thread priorities.

Key components of the code include the [`fd_topo_run_tile`](<#fd_topo_run_tile>) function, which is responsible for running a tile with specific configurations, and the [`run_tile_thread`](<#run_tile_thread>) function, which manages the creation and execution of threads for tiles. The code also includes functions for managing memory and stack allocation, such as [`fd_topo_tile_stack_join`](<#fd_topo_tile_stack_join>) and [`fd_topo_tile_stack_join_anon`](<#fd_topo_tile_stack_join_anon>), which handle memory mapping and guard region setup. Additionally, the code provides a mechanism to install XDP (Express Data Path) programs on network interfaces, which is handled by the [`fd_topo_install_xdp`](<#fd_topo_install_xdp>) function. Overall, the code is designed to facilitate the execution and management of tiles within a controlled and secure environment.
# Imports and Dependencies

---
- `fd_topo.h`
- `../metrics/fd_metrics.h`
- `../../waltz/xdp/fd_xdp1.h`
- `../../util/tile/fd_tile_private.h`
- `unistd.h`
- `signal.h`
- `errno.h`
- `pthread.h`
- `sys/syscall.h`
- `linux/futex.h`
- `sys/resource.h`
- `sys/prctl.h`
- `sys/stat.h`
- `sys/mman.h`
- `net/if.h`


# Data Structures

---
### fd\_topo\_run\_thread\_args\_t
- **Type**: ``struct``
- **Members**:
    - ``topo``: Pointer to a `fd_topo_t` structure.
    - ``tile``: Pointer to a `fd_topo_tile_t` structure.
    - ``tile_run``: Instance of `fd_topo_run_tile_t`.
    - ``uid``: User ID for the thread.
    - ``gid``: Group ID for the thread.
    - ``copied``: Volatile integer indicating if the structure has been copied.
    - ``stack_lo``: Pointer to the lower bound of the stack.
    - ``stack_hi``: Pointer to the upper bound of the stack.
- **Description**: Holds arguments for running a thread in a topology, including pointers to topology and tile structures, user and group IDs, a flag indicating if the structure has been copied, and stack boundaries.


# Functions

---
### initialize\_logging<!-- {{#callable:initialize_logging}} -->
[View Source →](<../../../../../src/disco/topo/fd_topo_run.c#L20>)

Initializes logging for a specific tile by setting CPU, thread, and stack configurations, and logs the booting information.
- **Inputs**:
    - `tile_name`: A constant character pointer representing the name of the tile.
    - `tile_kind_id`: An unsigned long integer representing the kind ID of the tile.
    - `tid`: An unsigned long integer representing the thread ID.
- **Logic and Control Flow**:
    - Calls `fd_log_cpu_set` with `NULL` to set the CPU for logging.
    - Sets the private thread ID using `fd_log_private_tid_set`.
    - Formats the thread name using `fd_cstr_printf_check` and stores it in `thread_name`.
    - Sets the thread name for logging using `fd_log_thread_set`.
    - Discovers the private stack using `fd_log_private_stack_discover`.
    - Logs the booting information of the tile using `FD_LOG_INFO`.
    - Initializes the wallclock string using `fd_log_wallclock_cstr` to ensure time zone settings are loaded before sandboxing.
- **Output**: No return value; the function performs logging initialization and configuration.


---
### check\_wait\_debugger<!-- {{#callable:check_wait_debugger}} -->
[View Source →](<../../../../../src/disco/topo/fd_topo_run.c#L49>)

Checks if a debugger should attach to a process and waits for a signal to proceed if necessary.
- **Inputs**:
    - `pid`: The process ID of the tile to which the debugger may attach.
    - `wait`: A pointer to a volatile integer that indicates whether the process should wait.
    - `debugger`: A pointer to a volatile integer that indicates whether a debugger should attach to the process.
- **Logic and Control Flow**:
    - If `debugger` is not null, log a warning that a debugger is attaching to the process with the given `pid`.
    - Attempt to stop the process using `kill` with `SIGSTOP` and log an error if it fails.
    - Set the value pointed to by `debugger` to 1 to indicate the debugger has attached.
    - If `wait` is not null, enter a loop that pauses execution until the value pointed to by `wait` becomes non-zero.
- **Output**: No return value; the function modifies the values pointed to by `wait` and `debugger`.


---
### fd\_topo\_run\_tile<!-- {{#callable:fd_topo_run_tile}} -->
[View Source →](<../../../../../src/disco/topo/fd_topo_run.c#L65>)

Executes a tile within a topology, potentially within a sandbox, and manages its lifecycle and resources.
- **Inputs**:
    - ``topo``: A pointer to the `fd_topo_t` structure representing the topology.
    - ``tile``: A pointer to the `fd_topo_tile_t` structure representing the tile to run.
    - ``sandbox``: An integer flag indicating whether to run the tile in a sandbox environment.
    - ``keep_controlling_terminal``: An integer flag indicating whether to keep the controlling terminal.
    - ``dumpable``: An integer flag indicating whether the process is dumpable.
    - ``uid``: The user ID to use when entering the sandbox.
    - ``gid``: The group ID to use when entering the sandbox.
    - ``allow_fd``: An integer representing a file descriptor to allow in the sandbox.
    - ``wait``: A volatile integer pointer used to wait for a condition before proceeding.
    - ``debugger``: A volatile integer pointer used to wait for a debugger to attach.
    - ``tile_run``: A pointer to the `fd_topo_run_tile_t` structure containing functions and settings for running the tile.
- **Logic and Control Flow**:
    - Sets the thread name using `prctl` and logs an error if it fails.
    - Retrieves the process ID and thread ID using `fd_sandbox_getpid` and `fd_sandbox_gettid`.
    - Calls [`check_wait_debugger`](<#check_wait_debugger>) to handle debugger attachment and waiting conditions.
    - Initializes logging for the tile using [`initialize_logging`](<#initialize_logging>).
    - Preloads shared memory by calling [`fd_topo_join_tile_workspaces`](<fd_topo.c.md#fd_topo_join_tile_workspaces>).
    - Executes `privileged_init` if it is defined in `tile_run`.
    - Configures allowed file descriptors and seccomp filters using `populate_allowed_fds` and `populate_allowed_seccomp` if they are defined.
    - Determines the file descriptor limit using `rlimit_file_cnt_fn` if it is defined.
    - Enters a sandbox environment using `fd_sandbox_enter` if `sandbox` is true, otherwise switches user and group IDs using `fd_sandbox_switch_uid_gid`.
    - Joins all IPC objects in the workspaces by calling [`fd_topo_fill_tile`](<fd_topo.c.md#fd_topo_fill_tile>).
    - Registers metrics for the tile using `fd_metrics_register`.
    - Sets metrics for process ID and thread ID using `FD_MGAUGE_SET`.
    - Executes `unprivileged_init` if it is defined in `tile_run`.
    - Runs the tile using the `run` function in `tile_run`.
    - Logs an error if the tile's run loop returns unexpectedly and `allow_shutdown` is false.
    - Sets the tile's status metric to 2 using `FD_MGAUGE_SET`.
- **Output**: No return value; the function manages the execution and lifecycle of a tile.
- **Functions Called**:
    - [`check_wait_debugger`](<#check_wait_debugger>)
    - [`initialize_logging`](<#initialize_logging>)
    - [`fd_topo_join_tile_workspaces`](<fd_topo.c.md#fd_topo_join_tile_workspaces>)
    - [`fd_topo_fill_tile`](<fd_topo.c.md#fd_topo_fill_tile>)


---
### run\_tile\_thread\_main<!-- {{#callable:run_tile_thread_main}} -->
[View Source →](<../../../../../src/disco/topo/fd_topo_run.c#L170>)

Executes a thread for a tile in a topology, ensuring stack safety and running the tile's main function.
- **Inputs**:
    - `_args`: A pointer to `fd_topo_run_thread_args_t` structure containing the arguments for the thread.
- **Logic and Control Flow**:
    - Copy the contents of `_args` into a local `fd_topo_run_thread_args_t` variable `args`.
    - Use `FD_COMPILER_MFENCE()` to ensure memory fence operations before and after setting `copied` to 1 in `_args`.
    - Call `madvise` with `MADV_DONTFORK` to prevent the stack from being copied during a fork operation.
    - Log an error and exit if `madvise` fails.
    - Call [`fd_topo_run_tile`](<#fd_topo_run_tile>) with the parameters from `args` to execute the tile's main function.
    - Check if the tile allows shutdown using `FD_TEST`.
    - Return `NULL` after execution.
- **Output**: Returns `NULL` after executing the tile's main function.
- **Functions Called**:
    - [`fd_topo_run_tile`](<#fd_topo_run_tile>)


---
### fd\_topo\_tile\_stack\_join\_anon<!-- {{#callable:fd_topo_tile_stack_join_anon}} -->
[View Source →](<../../../../../src/disco/topo/fd_topo_run.c#L195>)

Allocates a private anonymous memory region for a stack with guard pages to prevent memory corruption during fork operations.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calculate the size of the stack as twice the value of `FD_TILE_PRIVATE_STACK_SZ`.
    - Set memory protection to read and write, and flags to private, anonymous, and stack.
    - Attempt to allocate memory using `mmap` with huge pages if AddressSanitizer (ASAN) and MemorySanitizer (MSAN) are not enabled.
    - If the initial `mmap` call fails, attempt to allocate memory without huge pages.
    - Log an error and terminate if memory allocation fails.
    - Create a lower guard region by mapping a page with no access permissions before the stack.
    - Log an error and terminate if the lower guard region mapping fails.
    - Create an upper guard region by mapping a page with no access permissions after the stack.
    - Log an error and terminate if the upper guard region mapping fails.
    - Return the pointer to the allocated stack.
- **Output**: Returns a pointer to the allocated stack memory.


---
### fd\_topo\_tile\_stack\_join<!-- {{#callable:fd_topo_tile_stack_join}} -->
[View Source →](<../../../../../src/disco/topo/fd_topo_run.c#L228>)

Joins a shared memory stack for a tile, setting up guard regions for memory protection.
- **Inputs**:
    - `app_name`: The name of the application, used to construct the shared memory name.
    - `tile_name`: The name of the tile, used to construct the shared memory name.
    - `tile_kind_id`: The kind identifier for the tile, used to construct the shared memory name.
- **Logic and Control Flow**:
    - If `FD_HAS_MSAN` is defined, call [`fd_topo_tile_stack_join_anon`](<#fd_topo_tile_stack_join_anon>) and return its result.
    - Construct a shared memory name using `app_name`, `tile_name`, and `tile_kind_id`.
    - Join the shared memory using `fd_shmem_join` with read-write mode.
    - If joining fails, log an error and terminate.
    - Release a huge page size of memory at the start of the stack and adjust the stack pointer.
    - Release another huge page size of memory at the end of the stack and adjust the stack pointer.
    - Create a guard region at the lower end of the stack using `mmap` with `PROT_NONE` to prevent access.
    - Create a guard region at the higher end of the stack using `mmap` with `PROT_NONE` to prevent access.
    - Return the adjusted stack pointer.
- **Output**: A pointer to the joined stack with guard regions set up for memory protection.
- **Functions Called**:
    - [`fd_topo_tile_stack_join_anon`](<#fd_topo_tile_stack_join_anon>)


---
### fd\_topo\_install\_xdp<!-- {{#callable:fd_topo_install_xdp}} -->
[View Source →](<../../../../../src/disco/topo/fd_topo_run.c#L263>)

Installs an XDP program on a network interface and manages file descriptors for the XDP socket and program link.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure that contains the topology information.
    - ``bind_addr``: An unsigned integer representing the address to bind the XDP program to.
- **Logic and Control Flow**:
    - Finds the index of the tile with the name 'net' and index 0 in the topology using [`fd_topo_find_tile`](<fd_topo.h.md#fd_topo_find_tile>).
    - Checks if the tile index is valid and retrieves the corresponding tile from the topology.
    - Creates an array of UDP port candidates from the tile's XDP network configuration.
    - Retrieves the network interface index using `if_nametoindex` and logs an error if it fails.
    - Calls `fd_xdp_install` to install the XDP program on the network interface with the specified bind address and UDP ports.
    - Duplicates the file descriptor for the XDP socket map to a fixed value (123462) and closes the original file descriptor, logging an error if any operation fails.
    - Duplicates the file descriptor for the XDP program link to a fixed value (123463) and closes the original file descriptor, logging an error if any operation fails.
    - Updates the `xsk_map_fd` and `prog_link_fd` in the `xdp_fds` structure to the fixed values.
- **Output**: Returns an `fd_xdp_fds_t` structure containing the file descriptors for the XDP socket map and program link.
- **Functions Called**:
    - [`fd_topo_find_tile`](<fd_topo.h.md#fd_topo_find_tile>)


---
### run\_tile\_thread<!-- {{#callable:run_tile_thread}} -->
[View Source →](<../../../../../src/disco/topo/fd_topo_run.c#L299>)

Initializes and runs a thread for a specific tile in a topology, setting up stack, CPU affinity, and thread attributes.
- **Inputs**:
    - `topo`: Pointer to the `fd_topo_t` structure representing the topology.
    - `tile`: Pointer to the `fd_topo_tile_t` structure representing the tile to run.
    - `tile_run`: Structure of type `fd_topo_run_tile_t` containing run configurations for the tile.
    - `uid`: User ID for the thread.
    - `gid`: Group ID for the thread.
    - `floating_cpu_set`: Pointer to a `fd_cpuset_t` structure representing the CPU set for floating threads.
    - `floating_priority`: Priority level for floating threads.
    - `args`: Pointer to `fd_topo_run_thread_args_t` structure to store thread arguments.
- **Logic and Control Flow**:
    - Check if `tile_run.for_tpool` is true; if so, return immediately as the thread will be assigned by a thread pool later.
    - Join the stack for the tile using [`fd_topo_tile_stack_join`](<#fd_topo_tile_stack_join>) with the application's name, tile's name, and kind ID.
    - Initialize thread attributes using `pthread_attr_init` and set the stack using `pthread_attr_setstack`.
    - Declare a CPU set and determine if the tile's CPU index is less than 65535; if so, set the thread's CPU affinity and priority.
    - If the CPU index is not less than 65535, copy the floating CPU set and set the priority using `setpriority`.
    - Set the CPU affinity using `fd_cpuset_setaffinity` and handle errors if the affinity cannot be set.
    - Populate the `args` structure with the provided inputs and stack information.
    - Create a new thread using `pthread_create`, passing `run_tile_thread_main` as the thread function and `args` as the argument.
- **Output**: No return value; the function sets up and starts a thread for a tile.
- **Functions Called**:
    - [`fd_topo_tile_stack_join`](<#fd_topo_tile_stack_join>)


---
### fd\_topo\_run\_single\_process<!-- {{#callable:fd_topo_run_single_process}} -->
[View Source →](<../../../../../src/disco/topo/fd_topo_run.c#L353>)

Executes a single-threaded topology by running each tile in the topology with specified user and group IDs, while managing CPU affinity and process priority.
- **Inputs**:
    - ``topo``: A pointer to an `fd_topo_t` structure representing the topology to run.
    - ``agave``: An integer flag indicating whether to run only agave tiles (1), non-agave tiles (0), or all tiles (any other value).
    - ``uid``: An unsigned integer representing the user ID to switch to during execution.
    - ``gid``: An unsigned integer representing the group ID to switch to during execution.
    - ``tile_run``: A function pointer to a function that takes a constant pointer to an `fd_topo_tile_t` and returns an `fd_topo_run_tile_t` structure, which contains the run configuration for a tile.
- **Logic and Control Flow**:
    - Logs the start of the single-threaded topology execution with the number of tiles and memory size.
    - Saves the current CPU affinity and process priority to restore them later.
    - Iterates over each tile in the topology, checking if it should be run based on the `agave` flag and the tile's `is_agave` property.
    - For each tile that should be run, calls the `tile_run` function to get the run configuration and then calls [`run_tile_thread`](<#run_tile_thread>) to execute the tile in a separate thread.
    - Waits for each tile's thread to signal that it has copied its arguments by checking the `copied` flag in `fd_topo_run_thread_args_t`.
    - Switches the process to the specified user and group IDs using `fd_sandbox_switch_uid_gid`.
    - Restores the original process priority and CPU affinity.
- **Output**: No return value; the function performs its operations as a side effect.
- **Functions Called**:
    - [`fd_topo_mlock`](<fd_topo.c.md#fd_topo_mlock>)
    - [`run_tile_thread`](<#run_tile_thread>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)