<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a scheduling system for transaction processing, including block management and task dispatching.

# Purpose
The code defines a scheduling system for processing transactions in a blockchain-like environment. It is implemented in C and consists of several components, including structures, constants, and functions that manage the scheduling and execution of transactions. The primary structures are `fd_sched_block`, `fd_sched_metrics`, and `fd_sched`, which represent a block of transactions, metrics for tracking scheduling performance, and the scheduler itself, respectively.

The code provides functionality for managing transaction blocks, including parsing transactions from data buffers, scheduling them for execution, and handling the completion of tasks. It includes mechanisms for staging and promoting blocks, managing execution lanes, and tracking the state of transactions and blocks. The scheduler uses a dispatcher to manage the execution of transactions and ensure that tasks are completed in an orderly manner. The code also includes functions for creating, joining, and deleting scheduler instances, as well as for handling specific tasks such as ingesting data, advancing the root of the block tree, and abandoning blocks.
# Imports and Dependencies

---
- `fd_sched.h`
- `../../disco/fd_disco_base.h`
- `../../flamenco/runtime/fd_runtime.h`
- `../../flamenco/runtime/sysvar/fd_sysvar_slot_hashes.h`
- `../../util/tmpl/fd_set.c`


# Data Structures

---
### fd\_sched\_block
- **Type**: ``struct``
- **Members**:
    - `slot`: Stores the slot number for the block.
    - `parent_slot`: Stores the slot number of the parent block.
    - `parent_idx`: Index of the parent in the pool.
    - `child_idx`: Index of the left-child in the pool.
    - `sibling_idx`: Index of the right-sibling in the pool.
    - `txn_parsed_cnt`: Counts the number of parsed transactions.
    - `txn_exec_in_flight_cnt`: Counts the number of transactions currently being executed.
    - `txn_exec_done_cnt`: Counts the number of transactions that have completed execution.
    - `txn_sigverify_in_flight_cnt`: Counts the number of transactions currently undergoing signature verification.
    - `txn_sigverify_done_cnt`: Counts the number of transactions that have completed signature verification.
    - `txn_done_cnt`: Counts the number of transactions that are fully processed.
    - `txn_idx`: Array of transaction indices, ordered by parse sequence.
    - `shred_cnt`: Counts the number of shreds processed.
    - `txn`: Buffer for storing transaction data, aligned to `fd_txn_t`.
    - `poh`: Stores the latest PoH hash from ingested FEC sets.
    - `mblks_rem`: Number of microblocks remaining in the current batch.
    - `txns_rem`: Number of transactions remaining in the current microblock.
    - `aluts`: Buffer for resolving ALUT accounts for parallelism.
    - `fec_buf_sz`: Size of the FEC buffer in bytes.
    - `fec_buf_soff`: Starting offset into the FEC buffer for unparsed transactions.
    - `fec_eob`: Flag indicating if the last FEC set in the batch is being ingested.
    - `fec_sob`: Flag indicating if the parser expects a new batch.
    - `fec_eos`: Flag indicating if the last FEC set in the block has been ingested.
    - `rooted`: Flag indicating if the block is rooted.
    - `dying`: Flag indicating if the block has been abandoned.
    - `in_sched`: Flag indicating if the block is tracked by the scheduler.
    - `in_rdisp`: Flag indicating if the block is tracked by the dispatcher.
    - `block_start_signaled`: Flag indicating if the start-of-block sentinel has been dispatched.
    - `block_end_signaled`: Flag indicating if the end-of-block sentinel has been dispatched.
    - `block_start_done`: Flag indicating if the start-of-block processing is complete.
    - `block_end_done`: Flag indicating if the end-of-block processing is complete.
    - `staged`: Flag indicating if the block is in a dispatcher staging lane.
    - `staging_lane`: Lane index for staging, ignored if not staged.
    - `luf_depth`: Depth of the longest unstaged fork starting from this node.
    - `fec_buf`: Buffer for residual data from previous FEC sets.
- **Description**: Represents a scheduling block in a transaction processing system, managing the state and processing of transactions within a specific slot. It maintains hierarchical relationships with parent and child blocks, tracks transaction processing states, and manages parser and block states for efficient scheduling and dispatching.


---
### fd\_sched\_block\_t
- **Type**: ``struct``
- **Members**:
    - `slot`: The slot number of the block.
    - `parent_slot`: The slot number of the parent block.
    - `parent_idx`: Index of the parent in the pool.
    - `child_idx`: Index of the left-child in the pool.
    - `sibling_idx`: Index of the right-sibling in the pool.
    - `txn_parsed_cnt`: Count of parsed transactions.
    - `txn_exec_in_flight_cnt`: Count of transactions currently being executed.
    - `txn_exec_done_cnt`: Count of transactions that have completed execution.
    - `txn_sigverify_in_flight_cnt`: Count of transactions currently undergoing signature verification.
    - `txn_sigverify_done_cnt`: Count of transactions that have completed signature verification.
    - `txn_done_cnt`: Count of transactions that are fully processed.
    - `txn_idx`: Array of transaction indices, indexed by parse order.
    - `shred_cnt`: Count of shreds in the block.
    - `txn`: Buffer for storing transaction data.
    - `poh`: Latest PoH hash seen from the ingested FEC sets.
    - `mblks_rem`: Number of microblocks remaining in the current batch.
    - `txns_rem`: Number of transactions remaining in the current microblock.
    - `aluts`: Buffer for resolving ALUT accounts for parallelism.
    - `fec_buf_sz`: Size of the FEC buffer in bytes.
    - `fec_buf_soff`: Starting offset into FEC buffer for unparsed transactions.
    - `fec_eob`: Flag indicating if the last FEC set in the batch is being ingested.
    - `fec_sob`: Flag indicating if the parser expects a new batch.
    - `fec_eos`: Flag indicating if the last FEC set in the block has been ingested.
    - `rooted`: Flag indicating if the block is rooted.
    - `dying`: Flag indicating if the block is abandoned and no transactions should be scheduled from it.
    - `in_sched`: Flag indicating if the block is tracked by the scheduler.
    - `in_rdisp`: Flag indicating if the block is tracked by the dispatcher.
    - `block_start_signaled`: Flag indicating if the start-of-block sentinel has been dispatched.
    - `block_end_signaled`: Flag indicating if the end-of-block sentinel has been dispatched.
    - `block_start_done`: Flag indicating if the start-of-block processing is completed.
    - `block_end_done`: Flag indicating if the end-of-block processing is completed.
    - `staged`: Flag indicating if the block is in a dispatcher staging lane.
    - `staging_lane`: Staging lane index, ignored if not staged.
    - `luf_depth`: Depth of the longest unstaged fork starting from this node.
    - `fec_buf`: Buffer for residual data from the previous FEC set.
- **Description**: Represents a block in a scheduling system, containing metadata and state information for managing transactions and their execution within a distributed system. It includes fields for tracking the block's position in a hierarchy, transaction counts, execution states, and various flags for managing the block's lifecycle and processing state.


---
### fd\_sched\_metrics
- **Type**: ``struct``
- **Members**:
    - `block_added_cnt`: Counts the total number of blocks added.
    - `block_added_staged_cnt`: Counts the number of blocks added that are staged.
    - `block_added_unstaged_cnt`: Counts the number of blocks added that are unstaged.
    - `block_added_dead_ood_cnt`: Counts the number of blocks added that are dead or out-of-order.
    - `block_removed_cnt`: Counts the number of blocks removed.
    - `block_abandoned_cnt`: Counts the number of blocks abandoned.
    - `block_bad_cnt`: Counts the number of bad blocks encountered.
    - `block_promoted_cnt`: Counts the number of blocks promoted.
    - `block_demoted_cnt`: Counts the number of blocks demoted.
    - `deactivate_no_child_cnt`: Counts the number of deactivations due to no child blocks.
    - `deactivate_no_txn_cnt`: Counts the number of deactivations due to no transactions.
    - `deactivate_pruned_cnt`: Counts the number of deactivations due to pruning.
    - `deactivate_abandoned_cnt`: Counts the number of deactivations due to abandonment.
    - `lane_switch_cnt`: Counts the number of lane switches.
    - `lane_promoted_cnt`: Counts the number of lanes promoted.
    - `lane_demoted_cnt`: Counts the number of lanes demoted.
    - `alut_success_cnt`: Counts the number of successful ALUT operations.
    - `alut_serializing_cnt`: Counts the number of ALUT operations that required serialization.
    - `txn_abandoned_parsed_cnt`: Counts the number of parsed transactions that were abandoned.
    - `txn_abandoned_exec_done_cnt`: Counts the number of executed transactions that were abandoned.
    - `txn_abandoned_done_cnt`: Counts the number of completed transactions that were abandoned.
    - `txn_max_in_flight_cnt`: Tracks the maximum number of transactions in flight.
    - `txn_weighted_in_flight_cnt`: Tracks the weighted count of transactions in flight.
    - `txn_weighted_in_flight_tickcount`: Tracks the tick count for weighted transactions in flight.
    - `txn_none_in_flight_tickcount`: Tracks the tick count when no transactions are in flight.
    - `txn_parsed_cnt`: Counts the number of transactions parsed.
    - `txn_exec_done_cnt`: Counts the number of transactions that have completed execution.
    - `txn_sigverify_done_cnt`: Counts the number of transactions that have completed signature verification.
    - `txn_done_cnt`: Counts the number of transactions that are fully done.
    - `bytes_ingested_cnt`: Counts the total number of bytes ingested.
    - `bytes_ingested_unparsed_cnt`: Counts the number of ingested bytes that remain unparsed.
    - `bytes_dropped_cnt`: Counts the number of bytes dropped.
    - `fec_cnt`: Counts the number of FEC (Forward Error Correction) operations.
- **Description**: Tracks various metrics related to block scheduling and transaction processing, including counts of blocks added, removed, and abandoned, as well as transaction parsing and execution statistics.


---
### fd\_sched\_metrics\_t
- **Type**: ``struct``
- **Members**:
    - `block_added_cnt`: Counts the number of blocks added.
    - `block_added_staged_cnt`: Counts the number of staged blocks added.
    - `block_added_unstaged_cnt`: Counts the number of unstaged blocks added.
    - `block_added_dead_ood_cnt`: Counts the number of out-of-order dead blocks added.
    - `block_removed_cnt`: Counts the number of blocks removed.
    - `block_abandoned_cnt`: Counts the number of blocks abandoned.
    - `block_bad_cnt`: Counts the number of bad blocks encountered.
    - `block_promoted_cnt`: Counts the number of blocks promoted.
    - `block_demoted_cnt`: Counts the number of blocks demoted.
    - `deactivate_no_child_cnt`: Counts the number of deactivations due to no child blocks.
    - `deactivate_no_txn_cnt`: Counts the number of deactivations due to no transactions.
    - `deactivate_pruned_cnt`: Counts the number of deactivations due to pruning.
    - `deactivate_abandoned_cnt`: Counts the number of deactivations due to abandonment.
    - `lane_switch_cnt`: Counts the number of lane switches.
    - `lane_promoted_cnt`: Counts the number of lane promotions.
    - `lane_demoted_cnt`: Counts the number of lane demotions.
    - `alut_success_cnt`: Counts the number of successful ALUT operations.
    - `alut_serializing_cnt`: Counts the number of ALUT operations that required serialization.
    - `txn_abandoned_parsed_cnt`: Counts the number of parsed transactions that were abandoned.
    - `txn_abandoned_exec_done_cnt`: Counts the number of executed transactions that were abandoned.
    - `txn_abandoned_done_cnt`: Counts the number of completed transactions that were abandoned.
    - `txn_max_in_flight_cnt`: Tracks the maximum number of transactions in flight.
    - `txn_weighted_in_flight_cnt`: Tracks the weighted count of transactions in flight.
    - `txn_weighted_in_flight_tickcount`: Tracks the tick count for weighted transactions in flight.
    - `txn_none_in_flight_tickcount`: Tracks the tick count when no transactions are in flight.
    - `txn_parsed_cnt`: Counts the number of parsed transactions.
    - `txn_exec_done_cnt`: Counts the number of executed transactions.
    - `txn_sigverify_done_cnt`: Counts the number of transactions with completed signature verification.
    - `txn_done_cnt`: Counts the number of completed transactions.
    - `bytes_ingested_cnt`: Tracks the number of bytes ingested.
    - `bytes_ingested_unparsed_cnt`: Tracks the number of unparsed bytes ingested.
    - `bytes_dropped_cnt`: Tracks the number of bytes dropped.
    - `fec_cnt`: Counts the number of FEC sets processed.
- **Description**: Tracks various metrics related to the scheduling and processing of blocks and transactions, including counts of added, removed, and abandoned blocks, as well as transaction processing statistics such as parsing, execution, and signature verification.


---
### fd\_sched
- **Type**: ``struct``
- **Members**:
    - `metrics`: An array of `fd_sched_metrics_t` structures that store various metrics related to the scheduler.
    - `canary`: A magic number used for validation, expected to be `FD_SCHED_MAGIC`.
    - `block_cnt_max`: The maximum number of blocks that can be managed, immutable.
    - `exec_cnt`: The number of execution units available, immutable.
    - `txn_in_flight_last_tick`: The last tick when a transaction was in flight.
    - `root_idx`: The index of the root block in the block pool.
    - `rdisp`: A pointer to a `fd_rdisp_t` structure for dispatching tasks.
    - `txn_exec_ready_bitset`: A bitset indicating which execution units are ready for transaction execution.
    - `sigverify_ready_bitset`: A bitset indicating which execution units are ready for signature verification.
    - `active_bank_idx`: The index of the actively replayed block, or `ULONG_MAX` if no block is active.
    - `staged_bitset`: A bitset indicating which staging lanes are occupied.
    - `staged_head_bank_idx`: An array indicating the head of the linear chain in each staging lane.
    - `txn_pool_free_cnt`: The count of free transaction slots in the pool.
    - `txn_pool`: An array of `fd_txn_p_t` structures representing the transaction pool.
    - `txn_to_bank_idx`: An array mapping transaction indices to bank indices.
    - `exec_done_set`: A bitset indicating which transactions have completed execution.
    - `sigverify_done_set`: A bitset indicating which transactions have completed signature verification.
    - `block_pool`: A pointer to an array of `fd_sched_block_t` structures representing the block pool.
- **Description**: The `fd_sched` structure manages the scheduling of transactions and blocks within a system. It maintains metrics, execution readiness, and staging information for blocks and transactions. The structure includes arrays and bitsets to track the state and readiness of transactions and blocks, as well as pointers to other structures for dispatching and managing tasks. The `fd_sched` structure is central to coordinating the execution and verification of transactions across multiple execution units.


---
### fd\_sched\_t
- **Type**: ``struct``
- **Members**:
    - `metrics`: Holds performance metrics for the scheduler.
    - `canary`: A magic number used for validation.
    - `block_cnt_max`: The maximum number of blocks that can be managed.
    - `exec_cnt`: The number of execution units available.
    - `txn_in_flight_last_tick`: Timestamp of the last transaction in flight.
    - `root_idx`: Index of the root block.
    - `rdisp`: Pointer to the dispatcher structure.
    - `txn_exec_ready_bitset`: Bitset indicating which execution units are ready for transaction execution.
    - `sigverify_ready_bitset`: Bitset indicating which execution units are ready for signature verification.
    - `active_bank_idx`: Index of the currently active block.
    - `staged_bitset`: Bitset indicating which staging lanes are occupied.
    - `staged_head_bank_idx`: Array holding the head of the chain in each staging lane.
    - `txn_pool_free_cnt`: Count of free transaction slots in the pool.
    - `txn_pool`: Array of transaction pointers.
    - `txn_to_bank_idx`: Array mapping transaction indices to bank indices.
    - `exec_done_set`: Bitset indicating which transactions have completed execution.
    - `sigverify_done_set`: Bitset indicating which transactions have completed signature verification.
    - `block_pool`: Pointer to the pool of blocks managed by the scheduler.
- **Description**: Manages the scheduling of transactions and blocks, tracking their states and execution readiness. It uses bitsets to manage execution and signature verification readiness, and maintains a pool of blocks and transactions. The structure also includes metrics for performance tracking and uses a dispatcher to manage block execution.


# Functions

---
### block\_pool\_ele<!-- {{#callable:block_pool_ele}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L196>)

Retrieves a pointer to a block in the scheduler's block pool based on the given index.
- **Inputs**:
    - `sched`: A pointer to an `fd_sched_t` structure, which contains the scheduler's state and block pool.
    - `idx`: An unsigned long integer representing the index of the block in the block pool to retrieve.
- **Logic and Control Flow**:
    - Checks if `idx` is less than `sched->block_cnt_max` or if `idx` is equal to `ULONG_MAX` using `FD_TEST` macro.
    - If `idx` is `ULONG_MAX`, returns `NULL`.
    - Otherwise, returns a pointer to the block at the specified index in the `sched->block_pool`.
- **Output**: A pointer to an `fd_sched_block_t` structure if `idx` is valid, or `NULL` if `idx` is `ULONG_MAX`.


---
### block\_is\_void<!-- {{#callable:block_is_void}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L202>)

Checks if a block has reached the end of its stream and has no parsed transactions.
- **Inputs**:
    - `block`: A pointer to a `fd_sched_block_t` structure representing the block to check.
- **Logic and Control Flow**:
    - Check if the `fec_eos` flag of the `block` is set, indicating the end of the stream.
    - Check if the `txn_parsed_cnt` of the `block` is zero, indicating no transactions were parsed.
    - Return true if both conditions are met, otherwise return false.
- **Output**: Returns an integer value: 1 if the block is void (end of stream and no transactions parsed), 0 otherwise.


---
### block\_should\_signal\_end<!-- {{#callable:block_should_signal_end}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L209>)

Determines if a block should signal the end of its processing based on specific conditions.
- **Inputs**:
    - ``block``: A pointer to a `fd_sched_block_t` structure representing the block to check.
- **Logic and Control Flow**:
    - Check if `block->fec_eos` is true, indicating the end of the stream for the block.
    - Verify that `block->txn_parsed_cnt` equals `block->txn_done_cnt`, meaning all parsed transactions are done.
    - Ensure `block->block_start_done` is true, indicating the start of block processing is complete.
    - Confirm `block->block_end_signaled` is false, meaning the end of block has not been signaled yet.
    - Return true if all conditions are met, otherwise return false.
- **Output**: Returns an integer (1 or 0) indicating whether the block should signal the end of its processing.


---
### block\_will\_signal\_end<!-- {{#callable:block_will_signal_end}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L214>)

Checks if a block will signal the end of a stream based on its FEC end-of-stream status and whether the block end has been signaled.
- **Inputs**:
    - `block`: A pointer to a `fd_sched_block_t` structure representing the block to check.
- **Logic and Control Flow**:
    - Check if the `fec_eos` flag of the block is set, indicating the end of the stream.
    - Check if the `block_end_signaled` flag of the block is not set, indicating the end of the block has not been signaled yet.
    - Return true if both conditions are met, otherwise return false.
- **Output**: Returns an integer value: 1 if the block will signal the end, 0 otherwise.


---
### block\_is\_dispatchable<!-- {{#callable:block_is_dispatchable}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L222>)

Determines if a block is ready for dispatch based on transaction and block state.
- **Inputs**:
    - `block`: A pointer to a `fd_sched_block_t` structure representing the block to check for dispatch readiness.
- **Logic and Control Flow**:
    - Calculate `exec_queued_cnt` as the difference between `txn_parsed_cnt` and the sum of `txn_exec_in_flight_cnt` and `txn_exec_done_cnt`.
    - Calculate `sigverify_queued_cnt` as the difference between `txn_parsed_cnt` and the sum of `txn_sigverify_in_flight_cnt` and `txn_sigverify_done_cnt`.
    - Return true if `exec_queued_cnt` or `sigverify_queued_cnt` is greater than zero, or if `block_start_signaled` is false, or if `block_will_signal_end(block)` returns true.
- **Output**: Returns an integer indicating whether the block is dispatchable (non-zero) or not (zero).
- **Functions Called**:
    - [`block_will_signal_end`](<#block_will_signal_end>)


---
### block\_is\_in\_flight<!-- {{#callable:block_is_in_flight}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L232>)

Checks if a block has any transactions currently being executed or verified, or if the block's end has been signaled but not completed.
- **Inputs**:
    - `block`: A pointer to a `fd_sched_block_t` structure representing the block to check.
- **Logic and Control Flow**:
    - Evaluates if `block->txn_exec_in_flight_cnt` is non-zero, indicating transactions are being executed.
    - Checks if `block->txn_sigverify_in_flight_cnt` is non-zero, indicating transactions are being verified.
    - Verifies if `block->block_end_signaled` is true and `block->block_end_done` is false, indicating the block's end has been signaled but not completed.
    - Returns true if any of the above conditions are met, otherwise returns false.
- **Output**: Returns an integer value (1 or 0) indicating whether the block is in flight.


---
### block\_is\_done<!-- {{#callable:block_is_done}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L237>)

Checks if a block is complete by verifying specific conditions on its state.
- **Inputs**:
    - `block`: A pointer to a `fd_sched_block_t` structure representing the block to check.
- **Logic and Control Flow**:
    - Checks if `block->fec_eos` is true, indicating the end of the stream for the block.
    - Verifies that `block->txn_parsed_cnt` is equal to `block->txn_done_cnt`, ensuring all transactions are processed.
    - Checks if `block->block_start_done` is true, confirming the start of block processing is complete.
    - Checks if `block->block_end_done` is true, confirming the end of block processing is complete.
- **Output**: Returns an integer value of 1 if the block is complete, otherwise returns 0.


---
### block\_is\_stageable<!-- {{#callable:block_is_stageable}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L242>)

Determines if a block is eligible for staging based on its completion and dispatcher status.
- **Inputs**:
    - `block`: A pointer to a `fd_sched_block_t` structure representing the block to check.
- **Logic and Control Flow**:
    - Checks if the block is not done and not marked as dying using [`block_is_done`](<#block_is_done>) and `block->dying` respectively.
    - If the block is stageable and not in the dispatcher (`block->in_rdisp` is false), logs a critical error indicating an invariant violation.
    - Returns the result of the stageability check as an integer.
- **Output**: Returns an integer indicating if the block is stageable (1 if true, 0 if false).
- **Functions Called**:
    - [`block_is_done`](<#block_is_done>)


---
### block\_is\_promotable<!-- {{#callable:block_is_promotable}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L257>)

Determines if a block is promotable by checking if it is stageable, dispatchable, and not already staged.
- **Inputs**:
    - `block`: A pointer to a `fd_sched_block_t` structure representing the block to check for promotability.
- **Logic and Control Flow**:
    - Calls [`block_is_stageable`](<#block_is_stageable>) to check if the block is stageable.
    - Calls [`block_is_dispatchable`](<#block_is_dispatchable>) to check if the block is dispatchable.
    - Checks if the block is not already staged by evaluating `!block->staged`.
    - Returns true if all conditions are met, otherwise returns false.
- **Output**: Returns an integer value: 1 if the block is promotable, 0 otherwise.
- **Functions Called**:
    - [`block_is_stageable`](<#block_is_stageable>)
    - [`block_is_dispatchable`](<#block_is_dispatchable>)


---
### block\_is\_activatable<!-- {{#callable:block_is_activatable}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L262>)

Determines if a block is ready to be activated by checking if it is stageable, dispatchable, and staged.
- **Inputs**:
    - `block`: A pointer to a `fd_sched_block_t` structure representing the block to check.
- **Logic and Control Flow**:
    - Calls [`block_is_stageable`](<#block_is_stageable>) to check if the block is stageable.
    - Calls [`block_is_dispatchable`](<#block_is_dispatchable>) to check if the block is dispatchable.
    - Checks if the `staged` flag of the block is set.
    - Returns true if all conditions are met, otherwise returns false.
- **Output**: Returns an integer value (1 or 0) indicating whether the block is activatable (1) or not (0).
- **Functions Called**:
    - [`block_is_stageable`](<#block_is_stageable>)
    - [`block_is_dispatchable`](<#block_is_dispatchable>)


---
### block\_should\_deactivate<!-- {{#callable:block_should_deactivate}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L267>)

Determines if a block should be deactivated based on its activatable and in-flight status.
- **Inputs**:
    - `block`: A pointer to a `fd_sched_block_t` structure representing the block to check for deactivation.
- **Logic and Control Flow**:
    - Checks if the block is not activatable by calling `block_is_activatable(block)`.
    - Checks if the block has no tasks in-flight by calling `block_is_in_flight(block)`.
    - Returns true if both conditions are met, indicating the block should be deactivated.
- **Output**: Returns an integer value (1 or 0) indicating whether the block should be deactivated (1 for true, 0 for false).
- **Functions Called**:
    - [`block_is_activatable`](<#block_is_activatable>)
    - [`block_is_in_flight`](<#block_is_in_flight>)


---
### print\_block<!-- {{#callable:print_block}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L277>)

Logs detailed information about the state of a given `fd_sched_block_t` structure.
- **Inputs**:
    - `block`: A pointer to an `fd_sched_block_t` structure containing various state and metrics of a scheduling block.
- **Logic and Control Flow**:
    - Calls `FD_LOG_INFO` to log the state of the `block` parameter.
    - Logs various fields of the `fd_sched_block_t` structure, including slot numbers, staging status, transaction counts, and buffer sizes.
- **Output**: No return value; the function outputs log information to the logging system.


---
### print\_block\_and\_parent<!-- {{#callable:print_block_and_parent}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L283>)

Prints the details of a given block and its parent block if the parent exists.
- **Inputs**:
    - ``sched``: A pointer to an `fd_sched_t` structure, which contains scheduling information and a pool of blocks.
    - ``block``: A pointer to an `fd_sched_block_t` structure, representing the block whose details are to be printed.
- **Logic and Control Flow**:
    - Call [`print_block`](<#print_block>) to print the details of the given `block`.
    - Retrieve the parent block using [`block_pool_ele`](<#block_pool_ele>) with `sched` and `block->parent_idx`.
    - Check if the parent block exists using `FD_LIKELY`.
    - If the parent block exists, call [`print_block`](<#print_block>) to print its details.
- **Output**: No output is returned; the function performs logging of block details.
- **Functions Called**:
    - [`print_block`](<#print_block>)
    - [`block_pool_ele`](<#block_pool_ele>)


---
### print\_metrics<!-- {{#callable:print_metrics}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L290>)

Logs various metrics from the `fd_sched_t` structure using the `FD_LOG_NOTICE` macro.
- **Inputs**:
    - `sched`: A pointer to an `fd_sched_t` structure containing the metrics to log.
- **Logic and Control Flow**:
    - Accesses the `metrics` field of the `sched` structure.
    - Logs multiple metrics using the `FD_LOG_NOTICE` macro, including counts of blocks added, removed, abandoned, promoted, demoted, and various transaction-related metrics.
    - Uses the `FD_LOG_NOTICE` macro to format and output the metrics as a single log entry.
- **Output**: No return value; the function outputs metrics to the log.


---
### print\_sched<!-- {{#callable:print_sched}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L296>)

Logs the state of a scheduler and prints details of staged blocks.
- **Inputs**:
    - `sched`: A pointer to an `fd_sched_t` structure representing the scheduler whose state is to be logged.
- **Logic and Control Flow**:
    - Logs various attributes of the scheduler such as `canary`, `block_cnt_max`, `exec_cnt`, `root_idx`, `txn_exec_ready_bitset`, `sigverify_ready_bitset`, `active_idx`, `staged_bitset`, `staged_head_idx`, and `txn_pool_free_cnt`.
    - Iterates over each staging lane up to `FD_SCHED_MAX_STAGING_LANES`.
    - For each lane, checks if the lane is occupied by examining the `staged_bitset`.
    - If a lane is occupied, retrieves the block at the head of the lane using [`block_pool_ele`](<#block_pool_ele>) and calls [`print_block`](<#print_block>) to log its details.
- **Output**: No return value; the function performs logging as a side effect.
- **Functions Called**:
    - [`block_pool_ele`](<#block_pool_ele>)
    - [`print_block`](<#print_block>)


---
### print\_all<!-- {{#callable:print_all}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L308>)

Prints the metrics, scheduler state, and block information for a given scheduler and block.
- **Inputs**:
    - ``sched``: A pointer to a `fd_sched_t` structure representing the scheduler whose metrics and state will be printed.
    - ``block``: A pointer to a `fd_sched_block_t` structure representing the block whose information will be printed along with its parent block.
- **Logic and Control Flow**:
    - Call [`print_metrics`](<#print_metrics>) with `sched` to print the scheduler's metrics.
    - Call [`print_sched`](<#print_sched>) with `sched` to print the scheduler's state.
    - Call [`print_block_and_parent`](<#print_block_and_parent>) with `sched` and `block` to print the block's information and its parent's information.
- **Output**: No output is returned as the function is of type `void` and its purpose is to print information to the log.
- **Functions Called**:
    - [`print_metrics`](<#print_metrics>)
    - [`print_sched`](<#print_sched>)
    - [`print_block_and_parent`](<#print_block_and_parent>)


---
### fd\_sched\_align<!-- {{#callable:fd_sched_align}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L318>)

Calculates the alignment requirement for the `fd_sched_t` structure, ensuring it is minimally cache line aligned.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `fd_ulong_max` to determine the maximum alignment requirement among `alignof(fd_sched_t)`, `fd_rdisp_align()`, `alignof(fd_sched_block_t)`, and 64UL.
    - Returns the maximum alignment value, ensuring the alignment is at least a cache line size.
- **Output**: Returns an unsigned long integer representing the maximum alignment requirement for the `fd_sched_t` structure.


---
### fd\_sched\_footprint<!-- {{#callable:fd_sched_footprint}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L324>)

Calculates the memory footprint required for a scheduler with a specified maximum number of blocks.
- **Inputs**:
    - `block_cnt_max`: The maximum number of blocks that the scheduler can handle.
- **Logic and Control Flow**:
    - Initialize a layout variable `l` with `FD_LAYOUT_INIT`.
    - Append the size of `fd_sched_t` to the layout using `FD_LAYOUT_APPEND` with alignment from `fd_sched_align()`.
    - Append the footprint of the dispatcher to the layout using `FD_LAYOUT_APPEND` with alignment from `fd_rdisp_align()` and footprint from `fd_rdisp_footprint()`.
    - Append the size of the block pool to the layout using `FD_LAYOUT_APPEND` with alignment from `alignof(fd_sched_block_t)` and size calculated as `block_cnt_max * sizeof(fd_sched_block_t)`.
    - Finalize the layout using `FD_LAYOUT_FINI` with alignment from `fd_sched_align()` and return the calculated footprint.
- **Output**: Returns the total memory footprint in bytes as an unsigned long integer.
- **Functions Called**:
    - [`fd_sched_align`](<#fd_sched_align>)


---
### fd\_sched\_new<!-- {{#callable:fd_sched_new}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L333>)

Initializes a new scheduler object in the provided memory space, setting up its internal structures and returning a pointer to it.
- **Inputs**:
    - `mem`: A pointer to the memory space where the scheduler object will be initialized.
    - `block_cnt_max`: The maximum number of blocks that the scheduler can handle.
    - `exec_cnt`: The number of execution contexts, which must be between 1 and 64 inclusive.
- **Logic and Control Flow**:
    - Checks that `exec_cnt` is non-zero and does not exceed 64.
    - Initializes scratch memory allocation with `FD_SCRATCH_ALLOC_INIT`.
    - Allocates memory for the scheduler object, dispatcher, and block pool using `FD_SCRATCH_ALLOC_APPEND`.
    - Finalizes the memory allocation with `FD_SCRATCH_ALLOC_FINI`.
    - Generates a seed using the current tick count XORed with `FD_SCHED_MAGIC`.
    - Initializes the dispatcher with `fd_rdisp_new` using the generated seed.
    - Initializes each block in the block pool to not be in the scheduler.
    - Resets the scheduler's metrics to zero using `fd_memset`.
    - Sets various fields in the scheduler structure, including `canary`, `block_cnt_max`, `exec_cnt`, `root_idx`, `active_bank_idx`, and `staged_bitset`.
    - Initializes the transaction execution and signature verification ready bitsets using `fd_ulong_mask_lsb`.
    - Sets the transaction pool free count to `FD_SCHED_MAX_DEPTH-1UL`.
    - Initializes the execution and signature verification done sets with `txn_bitset_new`.
- **Output**: Returns a pointer to the newly initialized scheduler object.
- **Functions Called**:
    - [`fd_sched_align`](<#fd_sched_align>)


---
### fd\_sched\_join<!-- {{#callable:fd_sched_join}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L372>)

Initializes and joins a scheduler structure from a memory block, setting up its dispatcher and block pool.
- **Inputs**:
    - `mem`: A pointer to the memory block where the scheduler structure is stored.
    - `block_cnt_max`: The maximum number of blocks that the scheduler can handle.
- **Logic and Control Flow**:
    - Cast the `mem` pointer to a `fd_sched_t` pointer named `sched`.
    - Verify that `sched->canary` equals `FD_SCHED_MAGIC` to ensure the integrity of the scheduler structure.
    - Verify that `sched->block_cnt_max` equals `block_cnt_max` to ensure the correct configuration.
    - Initialize a scratch allocator with `mem`.
    - Append memory allocations for the scheduler, dispatcher, and block pool using the scratch allocator.
    - Finalize the scratch allocator to ensure proper alignment.
    - Join the dispatcher using `fd_rdisp_join` and assign it to `sched->rdisp`.
    - Assign the block pool memory to `sched->block_pool`.
    - Join the transaction bitsets `exec_done_set` and `sigverify_done_set` for the scheduler.
    - Return the pointer to the `sched` structure.
- **Output**: Returns a pointer to the initialized and joined `fd_sched_t` structure.
- **Functions Called**:
    - [`fd_sched_align`](<#fd_sched_align>)


---
### fd\_sched\_fec\_can\_ingest<!-- {{#callable:fd_sched_fec_can_ingest}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L394>)

Checks if a Forward Error Correction (FEC) set can be ingested into the scheduler based on available transaction pool space and FEC set size.
- **Inputs**:
    - ``sched``: A pointer to an `fd_sched_t` structure representing the scheduler.
    - ``fec``: A pointer to an `fd_sched_fec_t` structure representing the FEC set to be ingested.
- **Logic and Control Flow**:
    - Verify that the `sched` canary value matches `FD_SCHED_MAGIC` to ensure the scheduler is valid.
    - Check that `fec->bank_idx` and `fec->parent_bank_idx` are within the valid range of `sched->block_cnt_max`.
    - If `fec->fec->data_sz` exceeds `FD_SCHED_MAX_PAYLOAD_PER_FEC`, log a critical error and exit.
    - Calculate the size of the FEC buffer by checking if the FEC is the first in the block and adjusting `fec_buf_sz` accordingly.
    - Add the size of the FEC data to `fec_buf_sz`.
    - Determine if there are enough free entries in the transaction pool by comparing `sched->txn_pool_free_cnt` to the calculated transaction count based on `fec_buf_sz`.
- **Output**: Returns a non-zero value if the FEC set can be ingested, otherwise returns zero.
- **Functions Called**:
    - [`block_pool_ele`](<#block_pool_ele>)


---
### fd\_sched\_can\_ingest<!-- {{#callable:fd_sched_can_ingest}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L421>)

Determines if the scheduler can ingest a specified number of FEC (Forward Error Correction) sets based on available transaction pool space.
- **Inputs**:
    - ``sched``: A pointer to an `fd_sched_t` structure representing the scheduler state.
    - ``fec_cnt``: An unsigned long integer representing the number of FEC sets to be ingested.
- **Logic and Control Flow**:
    - Verify that the `sched` structure's `canary` field equals `FD_SCHED_MAGIC` to ensure the scheduler is valid.
    - Calculate the worst-case number of transactions (`txn_cnt`) that can be extracted from the maximum payload per FEC set, assuming each transaction is of minimum serialized size.
    - Check if the available transaction pool (`sched->txn_pool_free_cnt`) can accommodate the total number of transactions (`txn_cnt * fec_cnt`) that could be extracted from the specified number of FEC sets.
    - Return a boolean indicating whether the scheduler can ingest the specified number of FEC sets.
- **Output**: Returns an integer (boolean) indicating whether the scheduler can ingest the specified number of FEC sets (1 for yes, 0 for no).


---
### fd\_sched\_fec\_ingest<!-- {{#callable:fd_sched_fec_ingest}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L432>)

Processes a Forward Error Correction (FEC) set for a scheduling system, managing block states and metrics.
- **Inputs**:
    - ``sched``: A pointer to an `fd_sched_t` structure representing the scheduler state.
    - ``fec``: A pointer to an `fd_sched_fec_t` structure containing the FEC set data to be ingested.
- **Logic and Control Flow**:
    - Verify that the scheduler and FEC set are valid by checking magic numbers and indices.
    - If the FEC data size exceeds the maximum allowed, log a critical error and exit.
    - Retrieve the block associated with the FEC's bank index from the block pool.
    - If the FEC is the first in a block, initialize a new block and attempt to stage it.
    - If the block is marked as dying, increment the dead block count and drop the FEC data.
    - Attempt to find a staging lane for the block, inheriting from the parent if possible, or allocate a new lane if necessary.
    - If the block is dying, drop the FEC data and return.
    - Ensure the block is in the dispatcher; log a critical error if not.
    - Check for various invariant violations related to block state and log errors if found.
    - Move any residual data in the block's buffer to the start and append the new FEC data.
    - If the buffer overflows, log a bad block error, abandon the subtree, and return.
    - Update block and scheduler metrics with the new FEC data.
    - Parse the block's transactions; if parsing fails, log a bad block error, abandon the subtree, and return.
    - Check if the active block needs to be set or updated.
- **Output**: Returns 1 on successful ingestion, or 0 if the block is identified as bad and abandoned.
- **Functions Called**:
    - [`block_pool_ele`](<#block_pool_ele>)
    - [`add_block`](<#add_block>)
    - [`block_is_stageable`](<#block_is_stageable>)
    - [`print_block`](<#print_block>)
    - [`subtree_abandon`](<#subtree_abandon>)
    - [`check_or_set_active_block`](<#check_or_set_active_block>)
    - [`fd_sched_parse`](<#fd_sched_parse>)


---
### fd\_sched\_task\_next\_ready<!-- {{#callable:fd_sched_task_next_ready}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L627>)

Determines the next ready task for execution in a scheduling system, prioritizing transaction execution and handling various task types.
- **Inputs**:
    - `sched`: A pointer to an `fd_sched_t` structure representing the scheduler state.
    - `out`: A pointer to an `fd_sched_task_t` structure where the function will store the details of the next ready task.
- **Logic and Control Flow**:
    - Check if the scheduler's canary value is valid to ensure the scheduler is initialized correctly.
    - Calculate the `exec_fully_ready_bitset` by performing a bitwise AND operation between `sigverify_ready_bitset[0]` and `txn_exec_ready_bitset[0]`.
    - If `exec_fully_ready_bitset` is zero, return early with 0, indicating no tasks are ready.
    - Check if `active_bank_idx` is `ULONG_MAX`, indicating no active block, and return 0 if true.
    - Set the task type in `out` to `FD_SCHED_TT_NULL`.
    - Retrieve the active block using `active_bank_idx` and check if it should be deactivated, logging a critical error if true.
    - If the block's start is not signaled, set the task type to `FD_SCHED_TT_BLOCK_START`, populate `out->block_start` with block details, mark the block start as signaled, and return 1.
    - Calculate `exec_tile_idx0` and `exec_queued_cnt` to determine if transaction execution is possible.
    - If transactions are queued and execution is possible, set the task type to `FD_SCHED_TT_TXN_EXEC`, populate `out->txn_exec` with transaction details, update metrics, and return 1.
    - If no transactions are ready for execution, check if sigverify tasks can be dispatched, set the task type to `FD_SCHED_TT_TXN_SIGVERIFY`, populate `out->txn_sigverify`, update metrics, and return 1.
    - If the block should signal end, set the task type to `FD_SCHED_TT_BLOCK_END`, populate `out->block_end`, mark the block end as signaled, and return 1.
    - If no tasks are ready and the block is not in-flight, log a critical error and return 0.
- **Output**: Returns an `ulong` indicating whether a task was successfully scheduled (1) or not (0).
- **Functions Called**:
    - [`block_pool_ele`](<#block_pool_ele>)
    - [`block_should_deactivate`](<#block_should_deactivate>)
    - [`print_all`](<#print_all>)
    - [`block_is_in_flight`](<#block_is_in_flight>)
    - [`block_should_signal_end`](<#block_should_signal_end>)


---
### fd\_sched\_task\_done<!-- {{#callable:fd_sched_task_done}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L812>)

Marks a task as completed in the scheduler and updates the state of the associated block and transaction.
- **Inputs**:
    - `sched`: A pointer to the `fd_sched_t` structure representing the scheduler.
    - `task_type`: An unsigned long indicating the type of task that is completed, such as `FD_SCHED_TT_BLOCK_START`, `FD_SCHED_TT_BLOCK_END`, `FD_SCHED_TT_TXN_EXEC`, or `FD_SCHED_TT_TXN_SIGVERIFY`.
    - `txn_idx`: An unsigned long representing the index of the transaction associated with the task, used for transaction execution and signature verification tasks.
    - `exec_idx`: An unsigned long representing the execution index, used to identify the execution tile for the task.
- **Logic and Control Flow**:
    - Verify that the scheduler's canary value matches `FD_SCHED_MAGIC` to ensure the scheduler is valid.
    - Determine the `bank_idx` based on the `task_type`. For block start and end tasks, use the active bank index. For transaction execution and signature verification tasks, use the transaction-to-bank index mapping.
    - Retrieve the block associated with the `bank_idx` from the block pool.
    - Check invariants to ensure the block is staged and in the dispatcher.
    - For block start tasks, mark the block start as done.
    - For block end tasks, mark the block end as done.
    - For transaction execution tasks, update metrics, mark the transaction as done, and check if both execution and signature verification are complete to release the transaction.
    - For transaction signature verification tasks, update metrics, mark the transaction as done, and check if both execution and signature verification are complete to release the transaction.
    - If the block is dying and has no in-flight transactions, abandon the subtree starting from this block.
    - If the block is not dying and is not the active block, log a critical error for invariant violation.
    - Attempt to switch the active block if necessary.
- **Output**: No return value; the function updates the state of the scheduler and blocks.
- **Functions Called**:
    - [`block_pool_ele`](<#block_pool_ele>)
    - [`block_is_in_flight`](<#block_is_in_flight>)
    - [`subtree_abandon`](<#subtree_abandon>)
    - [`maybe_switch_block`](<#maybe_switch_block>)


---
### fd\_sched\_block\_abandon<!-- {{#callable:fd_sched_block_abandon}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L931>)

Abandons a block in the scheduler, ensuring it is the actively replayed block, and resets the active block index.
- **Inputs**:
    - ``sched``: A pointer to the `fd_sched_t` structure representing the scheduler.
    - ``bank_idx``: The index of the block to abandon within the scheduler's block pool.
- **Logic and Control Flow**:
    - Verify that the scheduler's canary value matches `FD_SCHED_MAGIC` to ensure integrity.
    - Check that `bank_idx` is less than `sched->block_cnt_max` to ensure it is a valid index.
    - Retrieve the block from the block pool using [`block_pool_ele`](<#block_pool_ele>) with `sched` and `bank_idx`.
    - If `bank_idx` is not equal to `sched->active_bank_idx`, log a critical error indicating an invariant violation, as abandoning should only occur on actively replayed blocks.
    - Call [`subtree_abandon`](<#subtree_abandon>) to abandon the block and its subtree.
    - Reset `sched->active_bank_idx` to `ULONG_MAX` to indicate no active block.
    - Increment the `deactivate_abandoned_cnt` metric in `sched->metrics`.
    - Log an informational message indicating the block has been abandoned.
    - Call [`print_block_and_parent`](<#print_block_and_parent>) to print details of the block and its parent.
    - Call [`try_activate_block`](<#try_activate_block>) to attempt to activate another block.
- **Output**: No return value; the function operates by modifying the scheduler state and logging information.
- **Functions Called**:
    - [`block_pool_ele`](<#block_pool_ele>)
    - [`print_all`](<#print_all>)
    - [`subtree_abandon`](<#subtree_abandon>)
    - [`print_block_and_parent`](<#print_block_and_parent>)
    - [`try_activate_block`](<#try_activate_block>)


---
### fd\_sched\_block\_add\_done<!-- {{#callable:fd_sched_block_add_done}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L958>)

Adds a block to the scheduler and initializes its state, setting it as a completed block with specific attributes.
- **Inputs**:
    - ``sched``: A pointer to the `fd_sched_t` structure representing the scheduler.
    - ``bank_idx``: An unsigned long integer representing the index of the block in the scheduler's block pool.
    - ``parent_bank_idx``: An unsigned long integer representing the index of the parent block in the scheduler's block pool.
    - ``slot``: An unsigned long integer representing the slot number for the block.
- **Logic and Control Flow**:
    - Checks if the scheduler's canary value matches `FD_SCHED_MAGIC` to ensure the scheduler is valid.
    - Verifies that `bank_idx` is less than `sched->block_cnt_max` to ensure the block index is within bounds.
    - Retrieves the block from the block pool using [`block_pool_ele`](<#block_pool_ele>) with `bank_idx`.
    - Calls [`add_block`](<#add_block>) to add the block to the scheduler with the given `bank_idx` and `parent_bank_idx`.
    - Sets various fields of the block to indicate it is completed, including setting `txn_parsed_cnt`, `txn_exec_done_cnt`, `txn_sigverify_done_cnt`, and `txn_done_cnt` to `UINT_MAX`.
    - Sets flags `fec_eos`, `block_start_signaled`, `block_end_signaled`, `block_start_done`, and `block_end_done` to 1, indicating the block is fully processed.
    - If `parent_bank_idx` is not `ULONG_MAX`, retrieves the parent block and sets the block's `parent_slot` to the parent's slot.
    - If `parent_bank_idx` is `ULONG_MAX`, sets the block's `parent_slot` to `ULONG_MAX`, marks the block as rooted, and updates `sched->root_idx` to `bank_idx`.
- **Output**: No return value; the function modifies the state of the scheduler and the specified block.
- **Functions Called**:
    - [`block_pool_ele`](<#block_pool_ele>)
    - [`add_block`](<#add_block>)


---
### fd\_sched\_advance\_root<!-- {{#callable:fd_sched_advance_root}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L987>)

Advances the root of a scheduling tree to a new specified root index, updating the tree structure accordingly.
- **Inputs**:
    - `sched`: A pointer to an `fd_sched_t` structure representing the scheduler.
    - `root_idx`: An unsigned long integer representing the index of the new root block in the scheduler's block pool.
- **Logic and Control Flow**:
    - Verify that the scheduler's canary value matches `FD_SCHED_MAGIC` to ensure integrity.
    - Check that `root_idx` and the current `root_idx` of the scheduler are within valid bounds.
    - Retrieve the new root block and the current root block from the block pool using `root_idx` and `sched->root_idx`, respectively.
    - Log a critical error if the current root block is not marked as rooted.
    - If the new root index is the same as the current root index, log an informational message and exit early.
    - Initialize a traversal starting from the current root block, setting its `parent_idx` to `ULONG_MAX`.
    - Iterate through the tree starting from the current root, marking each block as not in the scheduler (`in_sched = 0`) and linking children to be visited using the `parent_idx` field.
    - For each block, check for in-flight transactions and log a critical error if any are found.
    - Log a critical error if a block is still in the dispatcher.
    - Set the `parent_idx` of the new root block to `ULONG_MAX` and update the scheduler's `root_idx` to the new root index.
- **Output**: No return value; the function modifies the scheduler's state in place.
- **Functions Called**:
    - [`block_pool_ele`](<#block_pool_ele>)
    - [`block_is_in_flight`](<#block_is_in_flight>)


---
### fd\_sched\_root\_notify<!-- {{#callable:fd_sched_root_notify}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L1052>)

Notifies the scheduler of a new root block and updates the rooted status of blocks in the path from the new root to the old root, abandoning minority forks.
- **Inputs**:
    - ``sched``: A pointer to the `fd_sched_t` structure representing the scheduler.
    - ``root_idx``: An unsigned long integer representing the index of the new root block in the block pool.
- **Logic and Control Flow**:
    - Verify that the scheduler's canary value is correct and that `root_idx` and `sched->root_idx` are within valid bounds.
    - Retrieve the block at `root_idx` and the current root block from the block pool.
    - Check if the current root block is rooted; if not, log a critical error.
    - If the new root is the same as the current root, log an informational message and return early.
    - Traverse from the new root to the old root, marking each block as rooted, and log critical errors if any block is not done, dying, staged, or in the dispatcher.
    - If the traversal does not reach the old root, log a critical error indicating the new root is not a descendant of the old root.
    - Store the current active bank index.
    - Traverse from the old root towards the new root, abandoning all minority forks by checking each child block's rooted status and calling [`subtree_abandon`](<#subtree_abandon>) on unrooted children.
    - If the active block was abandoned, reset it and try to activate a new block.
- **Output**: None
- **Functions Called**:
    - [`block_pool_ele`](<#block_pool_ele>)
    - [`block_is_done`](<#block_is_done>)
    - [`subtree_abandon`](<#subtree_abandon>)
    - [`try_activate_block`](<#try_activate_block>)


---
### fd\_sched\_get\_txn<!-- {{#callable:fd_sched_get_txn}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L1132>)

Retrieves a transaction from the transaction pool of a scheduler based on a given index.
- **Inputs**:
    - ``sched``: A pointer to an `fd_sched_t` structure, which represents the scheduler containing the transaction pool.
    - ``txn_idx``: An unsigned long integer representing the index of the transaction to retrieve from the transaction pool.
- **Logic and Control Flow**:
    - Checks if the `sched` canary value is equal to `FD_SCHED_MAGIC` to ensure the scheduler is valid.
    - If `txn_idx` is greater than or equal to `FD_SCHED_MAX_DEPTH`, returns `NULL` to indicate an invalid index.
    - Returns a pointer to the transaction at the specified index in the scheduler's transaction pool.
- **Output**: A pointer to an `fd_txn_p_t` structure representing the transaction at the specified index, or `NULL` if the index is invalid.


---
### fd\_sched\_get\_poh<!-- {{#callable:fd_sched_get_poh}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L1141>)

Retrieves the PoH hash from a specified block in the scheduler's block pool.
- **Inputs**:
    - ``sched``: A pointer to an `fd_sched_t` structure, representing the scheduler.
    - ``bank_idx``: An unsigned long integer representing the index of the block in the scheduler's block pool.
- **Logic and Control Flow**:
    - Verify that the `sched` structure's `canary` field equals `FD_SCHED_MAGIC` to ensure the scheduler is valid.
    - Check that `bank_idx` is less than `sched->block_cnt_max` to ensure the block index is within bounds.
    - Retrieve the block from the scheduler's block pool using the [`block_pool_ele`](<#block_pool_ele>) function with `sched` and `bank_idx`.
    - Return the address of the `poh` field from the retrieved block.
- **Output**: A pointer to an `fd_hash_t` structure, representing the PoH hash of the specified block.
- **Functions Called**:
    - [`block_pool_ele`](<#block_pool_ele>)


---
### fd\_sched\_get\_shred\_cnt<!-- {{#callable:fd_sched_get_shred_cnt}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L1149>)

Retrieves the `shred_cnt` value from a specified block in the scheduler.
- **Inputs**:
    - `sched`: A pointer to an `fd_sched_t` structure, which represents the scheduler containing the block pool.
    - `bank_idx`: An unsigned long integer representing the index of the block within the scheduler's block pool.
- **Logic and Control Flow**:
    - Verify that the `sched` pointer's `canary` field matches `FD_SCHED_MAGIC` to ensure the scheduler is valid.
    - Check that `bank_idx` is less than `sched->block_cnt_max` to ensure the block index is within bounds.
    - Retrieve the block from the scheduler's block pool using the [`block_pool_ele`](<#block_pool_ele>) function with `sched` and `bank_idx`.
    - Return the `shred_cnt` field from the retrieved block.
- **Output**: Returns the `shred_cnt` value, which is a `uint` representing the number of shreds in the specified block.
- **Functions Called**:
    - [`block_pool_ele`](<#block_pool_ele>)


---
### fd\_sched\_leave<!-- {{#callable:fd_sched_leave}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L1157>)

Returns the input `fd_sched_t` pointer `sched` without modification.
- **Inputs**:
    - `sched`: A pointer to an `fd_sched_t` structure, representing the scheduler to leave.
- **Logic and Control Flow**:
    - The function takes a single input, a pointer to an `fd_sched_t` structure named `sched`.
    - It returns the same pointer `sched` without performing any operations on it.
- **Output**: A pointer to the `fd_sched_t` structure that was passed as input.


---
### fd\_sched\_delete<!-- {{#callable:fd_sched_delete}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L1158>)

Returns the input memory pointer without modification.
- **Inputs**:
    - ``mem``: A pointer to a memory block that the function will return.
- **Logic and Control Flow**:
    - The function takes a single input argument, `mem`.
    - It returns the `mem` pointer without performing any operations on it.
- **Output**: The function returns the same pointer that was passed as the input argument `mem`.


---
### add\_block<!-- {{#callable:add_block}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L1163>)

Initializes a new block in the scheduler and links it to its parent block if applicable.
- **Inputs**:
    - ``sched``: A pointer to the `fd_sched_t` structure representing the scheduler.
    - ``bank_idx``: The index of the block in the block pool to be added.
    - ``parent_bank_idx``: The index of the parent block in the block pool, or `ULONG_MAX` if there is no parent.
- **Logic and Control Flow**:
    - Retrieve the block from the block pool using `bank_idx` and ensure it is not already scheduled (`!block->in_sched`).
    - Initialize various counters and flags in the block to zero or default values, such as `txn_parsed_cnt`, `txn_exec_in_flight_cnt`, `fec_buf_sz`, `fec_sob`, etc.
    - Set the block's `in_sched` flag to 1, indicating it is now part of the scheduler.
    - If `parent_bank_idx` is `ULONG_MAX`, return immediately as there is no parent to link to.
    - Retrieve the parent block using `parent_bank_idx` and set the current block's `parent_idx` to `parent_bank_idx`.
    - If the parent block has no child (`parent_block->child_idx == ULONG_MAX`), set the parent's `child_idx` to `bank_idx`.
    - If the parent block already has a child, traverse the sibling chain until the end and set the last sibling's `sibling_idx` to `bank_idx`.
    - If the parent block is marked as dying, mark the current block as dying as well.
- **Output**: The function does not return a value.
- **Functions Called**:
    - [`block_pool_ele`](<#block_pool_ele>)


---
### fd\_sched\_parse<!-- {{#callable:fd_sched_parse}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L1244>)

Parses a scheduling block to process transactions and microblocks, updating the scheduler and block state accordingly.
- **Inputs**:
    - ``sched``: A pointer to the `fd_sched_t` structure representing the scheduler.
    - ``block``: A pointer to the `fd_sched_block_t` structure representing the block to be parsed.
    - ``alut_ctx``: A pointer to the `fd_sched_alut_ctx_t` structure used for address lookup table context.
- **Logic and Control Flow**:
    - Enter an infinite loop to process transactions and microblocks.
    - While there are remaining transactions (`txns_rem` > 0), call [`fd_sched_parse_txn`](<#fd_sched_parse_txn>) to parse each transaction.
    - If parsing a transaction fails, return the error code.
    - If no transactions remain but there are microblocks (`mblks_rem` > 0), parse the microblock header, update the block state, and continue parsing transactions.
    - If no transactions or microblocks remain and it is the start of a batch (`fec_sob` is set), load the number of microblocks from the buffer, update the block state, and continue parsing.
    - If no transactions or microblocks remain and it is not the start of a batch, exit the loop.
    - If it is the end of a batch (`fec_eob` is set), update the scheduler metrics, reset the buffer offsets, and prepare for the next batch.
- **Output**: Returns `FD_SCHED_PARSER_OK` on successful parsing or an error code if parsing fails.
- **Functions Called**:
    - [`fd_sched_parse_txn`](<#fd_sched_parse_txn>)


---
### fd\_sched\_parse\_txn<!-- {{#callable:fd_sched_parse_txn}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L1288>)

Parses a transaction from a block's buffer and updates the scheduler and block state accordingly.
- **Inputs**:
    - ``sched``: A pointer to the `fd_sched_t` structure representing the scheduler.
    - ``block``: A pointer to the `fd_sched_block_t` structure representing the block containing the transaction data.
    - ``alut_ctx``: A pointer to the `fd_sched_alut_ctx_t` structure providing context for address lookup table operations.
- **Logic and Control Flow**:
    - Initialize a pointer `txn` to the transaction data in the block using `fd_type_pun`.
    - Parse the transaction using `fd_txn_parse_core`, updating `pay_sz` and `txn_sz` with the payload and transaction sizes, respectively.
    - If parsing fails (either `pay_sz` or `txn_sz` is zero), return `FD_SCHED_PARSER_AGAIN_LATER`.
    - Check if the block has exceeded the maximum number of transactions per slot (`FD_MAX_TXN_PER_SLOT`); if so, return `FD_SCHED_PARSER_BAD_BLOCK`.
    - Determine if the transaction has address lookup tables (ALUTs) and attempt to expand them if present.
    - If ALUT expansion is successful, update the scheduler's metrics for successful ALUT operations; otherwise, mark the transaction as serializing.
    - Add the transaction to the scheduler's dispatcher using `fd_rdisp_add_txn`, and update the scheduler's metrics and transaction pool.
    - Copy the transaction payload and data into the scheduler's transaction pool.
    - Update the block's transaction index and buffer offset, and increment the parsed transaction count.
    - If signature verification is skipped (`FD_SCHED_SKIP_SIGVERIFY`), mark the transaction as verified.
    - Decrement the remaining transaction count in the block.
    - Return `FD_SCHED_PARSER_OK` to indicate successful parsing.
- **Output**: Returns an integer status code indicating the result of the parsing operation: `FD_SCHED_PARSER_OK`, `FD_SCHED_PARSER_AGAIN_LATER`, or `FD_SCHED_PARSER_BAD_BLOCK`.


---
### try\_activate\_block<!-- {{#callable:try_activate_block}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L1352>)

Activates a block for scheduling by checking staged lanes and promoting unstaged blocks if necessary.
- **Inputs**:
    - ``sched``: A pointer to the `fd_sched_t` structure representing the scheduler state.
- **Logic and Control Flow**:
    - Initialize `staged_bitset` with `sched->staged_bitset` to check for any allocated staging lanes.
    - Iterate over `staged_bitset` to find the least significant bit set, indicating a lane index with a staged block.
    - For each lane, retrieve the head block and its parent block using [`block_pool_ele`](<#block_pool_ele>).
    - Check if the parent block is done and the head block is activatable; if so, set `sched->active_bank_idx` to the head block index and increment `lane_switch_cnt`.
    - If no staged blocks are activatable, check if there are unstaged blocks to promote by computing the longest unstaged fork depth from the root index.
    - If a promotable fork is found, check if there are available staging lanes; if not, log a critical error for unimplemented demotion logic.
    - Find an available lane index and stage the longest unstaged fork, setting `sched->active_bank_idx` to the head bank index of the staged fork.
    - If no unstaged blocks are promotable, the function completes without activating any block.
- **Output**: No explicit return value; modifies the `sched` structure to set the active block index or log errors.
- **Functions Called**:
    - [`block_pool_ele`](<#block_pool_ele>)
    - [`block_is_done`](<#block_is_done>)
    - [`block_is_activatable`](<#block_is_activatable>)
    - [`compute_longest_unstaged_fork`](<#compute_longest_unstaged_fork>)
    - [`stage_longest_unstaged_fork`](<#stage_longest_unstaged_fork>)


---
### check\_or\_set\_active\_block<!-- {{#callable:check_or_set_active_block}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L1423>)

Checks if the active block in the scheduler is set and valid, and activates a block if necessary.
- **Inputs**:
    - ``sched``: A pointer to a `fd_sched_t` structure representing the scheduler state.
- **Logic and Control Flow**:
    - Checks if `sched->active_bank_idx` is `ULONG_MAX`, indicating no active block is set.
    - If no active block is set, calls `try_activate_block(sched)` to attempt to activate a block.
    - If an active block is set, retrieves the active block using `block_pool_ele(sched, sched->active_bank_idx)`.
    - Checks if the active block should be deactivated using `block_should_deactivate(active_block)`.
    - If the active block should be deactivated, logs a critical error indicating an invariant violation.
- **Output**: No return value; the function operates on the scheduler state pointed to by `sched`.
- **Functions Called**:
    - [`try_activate_block`](<#try_activate_block>)
    - [`block_pool_ele`](<#block_pool_ele>)
    - [`block_should_deactivate`](<#block_should_deactivate>)
    - [`print_all`](<#print_all>)


---
### subtree\_abandon<!-- {{#callable:subtree_abandon}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L1437>)

Abandons a subtree of blocks in a scheduling system, ensuring proper order and handling of invariants.
- **Inputs**:
    - ``sched``: A pointer to the `fd_sched_t` structure representing the scheduler.
    - ``block``: A pointer to the `fd_sched_block_t` structure representing the block to abandon.
- **Logic and Control Flow**:
    - Checks if the block is rooted and logs a critical error if it is.
    - Checks if a staged block is not in the dispatcher and logs a critical error if it is.
    - Sets the `dying` flag on the block to indicate it is being abandoned.
    - If the block is in the dispatcher, retrieves the parent block and checks for its existence, logging a critical error if not found.
    - Determines if the block can be abandoned in order based on its parent's state and staging lane.
    - If the block can be abandoned and has no in-flight transactions, removes it from the dispatcher and updates metrics.
    - Releases the staging lane if the block was staged.
    - Recursively abandons all child blocks in the subtree.
- **Output**: No return value; the function operates by modifying the state of the scheduler and blocks.
- **Functions Called**:
    - [`block_pool_ele`](<#block_pool_ele>)
    - [`subtree_abandon`](<#subtree_abandon>)


---
### maybe\_switch\_block<!-- {{#callable:maybe_switch_block}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L1524>)

Manages the transition of active blocks in a scheduling system by checking if a block is done or should be deactivated, and potentially switching to a child block or releasing the staging lane.
- **Inputs**:
    - ``sched``: A pointer to the `fd_sched_t` structure, which represents the scheduler state.
    - ``bank_idx``: An unsigned long integer representing the index of the block in the block pool.
- **Logic and Control Flow**:
    - Retrieve the block from the block pool using [`block_pool_ele`](<#block_pool_ele>) with `sched` and `bank_idx`.
    - Check if the block is done using [`block_is_done`](<#block_is_done>).
    - If the block is done, set `block->in_rdisp` and `block->staged` to 0, remove the block from the dispatcher using `fd_rdisp_remove_block`, and increment the `block_removed_cnt` metric.
    - Check for a child block in the same staging lane by iterating over `child_idx` and checking if the child is staged and in the same lane.
    - If a valid child block is found, check if it is not dying and activatable. If not activatable, reset `active_bank_idx`, increment `deactivate_no_txn_cnt`, and call [`try_activate_block`](<#try_activate_block>).
    - If the child block is activatable, set it as the active block and update the staged head bank index for the lane.
    - If no valid child block is found, clear the staging lane bit in `staged_bitset`, set the staged head bank index to `ULONG_MAX`, reset `active_bank_idx`, increment `deactivate_no_child_cnt`, and call [`try_activate_block`](<#try_activate_block>).
    - If the block is not done but should be deactivated (checked using [`block_should_deactivate`](<#block_should_deactivate>)), reset `active_bank_idx`, increment `deactivate_no_txn_cnt`, and call [`try_activate_block`](<#try_activate_block>).
- **Output**: No return value; the function modifies the scheduler state and metrics.
- **Functions Called**:
    - [`block_pool_ele`](<#block_pool_ele>)
    - [`block_is_done`](<#block_is_done>)
    - [`block_is_activatable`](<#block_is_activatable>)
    - [`try_activate_block`](<#try_activate_block>)
    - [`subtree_abandon`](<#subtree_abandon>)
    - [`block_should_deactivate`](<#block_should_deactivate>)


---
### find\_and\_stage\_longest\_unstaged\_fork<!-- {{#callable:find_and_stage_longest_unstaged_fork}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L1591>)

Finds and stages the longest unstaged fork in a scheduling tree, returning the index of the head block of the staged lane.
- **Inputs**:
    - `sched`: A pointer to a `fd_sched_t` structure representing the scheduling tree.
    - `lane_idx`: An integer representing the index of the staging lane to use.
- **Logic and Control Flow**:
    - Retrieve the root index from the `sched` structure.
    - Check if `root_idx` is `ULONG_MAX`, indicating an uninitialized scheduler, and log a critical error if so.
    - Call [`compute_longest_unstaged_fork`](<#compute_longest_unstaged_fork>) to calculate the longest unstaged fork depth starting from the root index.
    - Call [`stage_longest_unstaged_fork`](<#stage_longest_unstaged_fork>) to stage blocks on the longest unstaged fork, using the specified `lane_idx`.
    - Check for invariant violations by comparing `depth` and `head_bank_idx`, and log a critical error if any are found.
    - Return `head_bank_idx`, which is the index of the head block of the staged lane.
- **Output**: Returns the index of the head block of the staged lane as an `ulong`, or `ULONG_MAX` if no staging occurred.
- **Functions Called**:
    - [`compute_longest_unstaged_fork`](<#compute_longest_unstaged_fork>)
    - [`stage_longest_unstaged_fork`](<#stage_longest_unstaged_fork>)


---
### compute\_longest\_unstaged\_fork<!-- {{#callable:compute_longest_unstaged_fork}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L1616>)

Calculates the depth of the longest unstaged fork in a scheduling tree, starting from a given block index.
- **Inputs**:
    - ``sched``: A pointer to the `fd_sched_t` structure, representing the scheduler context.
    - ``bank_idx``: An unsigned long integer representing the index of the block in the scheduler's block pool from which to start the calculation.
- **Logic and Control Flow**:
    - Checks if `bank_idx` is equal to `ULONG_MAX` and logs a critical error if true.
    - Retrieves the block from the block pool using [`block_pool_ele`](<#block_pool_ele>) with `sched` and `bank_idx`.
    - Initializes `max_child_depth` to 0 and `child_idx` to the block's `child_idx`.
    - Enters a loop that continues while `child_idx` is not `ULONG_MAX`.
    - Within the loop, recursively calls [`compute_longest_unstaged_fork`](<#compute_longest_unstaged_fork>) for each child and updates `max_child_depth` if the returned depth is greater.
    - Updates `child_idx` to the sibling index of the current child block.
    - After the loop, calculates the block's `luf_depth` as `max_child_depth` plus 1 if the block is promotable, otherwise 0.
    - Returns the calculated `luf_depth`.
- **Output**: Returns the depth of the longest stageable unstaged fork as an unsigned long integer.
- **Functions Called**:
    - [`block_pool_ele`](<#block_pool_ele>)
    - [`compute_longest_unstaged_fork`](<#compute_longest_unstaged_fork>)
    - [`block_is_promotable`](<#block_is_promotable>)


---
### stage\_longest\_unstaged\_fork\_helper<!-- {{#callable:stage_longest_unstaged_fork_helper}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L1639>)

Stages the longest unstaged fork in a scheduling system, promoting blocks as necessary.
- **Inputs**:
    - ``sched``: A pointer to the `fd_sched_t` structure representing the scheduler.
    - ``bank_idx``: An unsigned long integer representing the index of the bank to start staging from.
    - ``lane_idx``: An integer representing the index of the lane to stage the blocks into.
- **Logic and Control Flow**:
    - Checks if `bank_idx` is `ULONG_MAX` and logs a critical error if true.
    - Retrieves the block from the block pool using `bank_idx`.
    - Determines if the block is promotable and sets `stage_it` accordingly.
    - If `stage_it` is true, marks the block as staged, assigns it to the specified lane, promotes the block in the dispatcher, and increments the block promoted count in the scheduler metrics.
    - Checks if the block is a leaf node (i.e., `child_idx` is `ULONG_MAX`) and returns `rv` if true.
    - Initializes `max_depth` and `best_child_idx` to track the deepest child block.
    - Iterates over child blocks to find the one with the maximum `luf_depth`.
    - Recursively calls itself to stage descendants if `best_child_idx` is not `ULONG_MAX`.
    - Updates `rv` with the head bank index of the staged lane if necessary.
    - Returns the index of the head block of the staged lane or `ULONG_MAX` if no block was staged.
- **Output**: Returns the index of the head block of the staged lane on success, or `ULONG_MAX` if no block was staged.
- **Functions Called**:
    - [`block_pool_ele`](<#block_pool_ele>)
    - [`block_is_promotable`](<#block_is_promotable>)


---
### stage\_longest\_unstaged\_fork<!-- {{#callable:stage_longest_unstaged_fork}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L1682>)

Stages the longest unstaged fork in the scheduler and updates the scheduler's state accordingly.
- **Inputs**:
    - ``sched``: A pointer to the `fd_sched_t` structure representing the scheduler.
    - ``bank_idx``: An unsigned long integer representing the index of the bank to start staging from.
    - ``lane_idx``: An integer representing the index of the lane to stage the fork into.
- **Logic and Control Flow**:
    - Calls [`stage_longest_unstaged_fork_helper`](<#stage_longest_unstaged_fork_helper>) to find the head bank index of the longest unstaged fork starting from `bank_idx`.
    - Checks if the returned `head_bank_idx` is not equal to `ULONG_MAX`, indicating a valid fork was found.
    - If a valid fork is found, increments the `lane_promoted_cnt` metric in the scheduler's metrics.
    - Sets the bit corresponding to `lane_idx` in the scheduler's `staged_bitset`.
    - Updates the `staged_head_bank_idx` for the given `lane_idx` with the `head_bank_idx`.
    - Returns the `head_bank_idx`.
- **Output**: Returns the index of the head block of the staged lane if successful, or `ULONG_MAX` if no valid fork was found.
- **Functions Called**:
    - [`stage_longest_unstaged_fork_helper`](<#stage_longest_unstaged_fork_helper>)


# Function Declarations (Public API)

---
### add\_block<!-- {{#callable_declaration:add_block}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L164>)

Adds a block to the scheduler.
- **Description**: Use this function to add a new block to the scheduler, linking it to a parent block if specified. This function initializes the block's state and sets up its position in the scheduling hierarchy. It must be called with a valid scheduler and block indices. If the parent index is `ULONG_MAX`, the block is added as a root node. The function handles linking the block to its parent and siblings, and marks the block as dying if its parent is dying.
- **Inputs**:
    - `sched`: A pointer to an `fd_sched_t` structure representing the scheduler. Must not be null.
    - `bank_idx`: An unsigned long representing the index of the block to add. Must be within the valid range of block indices in the scheduler.
    - `parent_bank_idx`: An unsigned long representing the index of the parent block. If `ULONG_MAX`, the block is added as a root node.
- **Output**: None
- **See Also**: [`add_block`](<#add_block>)  (Implementation)


---
### fd\_sched\_parse<!-- {{#callable_declaration:fd_sched_parse}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L169>)

Parses transactions from a scheduling block.
- **Description**: Use this function to parse transactions from a given scheduling block within a scheduler context. It processes transactions until all are parsed or an error occurs. Call this function when you need to extract and process transactions from a block. Ensure that the block and scheduler are properly initialized before calling. The function handles cases where transactions span multiple microblocks and manages the end-of-batch conditions.
- **Inputs**:
    - `sched`: A pointer to an `fd_sched_t` structure representing the scheduler context. Must not be null.
    - `block`: A pointer to an `fd_sched_block_t` structure representing the block to parse. Must not be null and should be properly initialized.
    - `alut_ctx`: A pointer to an `fd_sched_alut_ctx_t` structure used for address lookup table context. Must not be null.
- **Output**: Returns an integer status code: `FD_SCHED_PARSER_OK` on success, `FD_SCHED_PARSER_AGAIN_LATER` if more data is needed, or `FD_SCHED_PARSER_BAD_BLOCK` if the block is invalid.
- **See Also**: [`fd_sched_parse`](<#fd_sched_parse>)  (Implementation)


---
### fd\_sched\_parse\_txn<!-- {{#callable_declaration:fd_sched_parse_txn}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L172>)

Parses a transaction from a block in the scheduler.
- **Description**: Use this function to parse a transaction from a given block within a scheduler. It processes the transaction data and updates the scheduler's state accordingly. This function must be called with valid scheduler and block pointers, and it assumes that the block contains transaction data to parse. It handles cases where the transaction cannot be fully parsed or when the block contains more transactions than allowed, returning specific status codes in these scenarios.
- **Inputs**:
    - `sched`: A pointer to an `fd_sched_t` structure representing the scheduler. Must not be null. The function updates the scheduler's state based on the parsed transaction.
    - `block`: A pointer to an `fd_sched_block_t` structure representing the block containing transaction data. Must not be null. The function reads from and updates this block.
    - `alut_ctx`: A pointer to an `fd_sched_alut_ctx_t` structure providing context for address lookup table expansion. Must not be null. The function uses this context to attempt ALUT expansion if applicable.
- **Output**: Returns an integer status code: `FD_SCHED_PARSER_OK` (0) if parsing is successful, `FD_SCHED_PARSER_AGAIN_LATER` (1) if the transaction cannot be fully parsed, or `FD_SCHED_PARSER_BAD_BLOCK` (2) if the block contains more transactions than allowed.
- **See Also**: [`fd_sched_parse_txn`](<#fd_sched_parse_txn>)  (Implementation)


---
### try\_activate\_block<!-- {{#callable_declaration:try_activate_block}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L175>)

Attempts to activate a block for scheduling.
- **Description**: Use this function to activate a block for scheduling if there are available staging lanes. It checks for any allocated staging lanes that can be activated and promotes unstaged blocks if necessary. This function must be called when the scheduler is initialized and ready to manage blocks. It ensures that the active block is set correctly and updates scheduling metrics accordingly. It does not return a value and modifies the scheduler state directly.
- **Inputs**:
    - `sched`: A pointer to an `fd_sched_t` structure representing the scheduler. Must not be null. The function modifies the scheduler's state based on the current scheduling needs.
- **Output**: None
- **See Also**: [`try_activate_block`](<#try_activate_block>)  (Implementation)


---
### check\_or\_set\_active\_block<!-- {{#callable_declaration:check_or_set_active_block}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L178>)

Checks or sets the active block in the scheduler.
- **Description**: Use this function to ensure that the scheduler has an active block set for processing. If no active block is currently set, it attempts to activate one. If an active block is already set, it verifies that the block should remain active. This function must be called in contexts where the scheduler's active block status needs validation or adjustment.
- **Inputs**:
    - `sched`: A pointer to an `fd_sched_t` structure representing the scheduler. Must not be null. The function assumes the scheduler is properly initialized and manages the active block state within this structure.
- **Output**: None
- **See Also**: [`check_or_set_active_block`](<#check_or_set_active_block>)  (Implementation)


---
### subtree\_abandon<!-- {{#callable_declaration:subtree_abandon}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L181>)

Marks a block and its descendants as abandoned.
- **Description**: Use this function to mark a block and all its descendant blocks in the scheduling tree as abandoned. This function is typically called when a block is no longer needed or is invalid. It ensures that the block is removed from the dispatcher and that no further transactions are scheduled from it. Preconditions include that the block must not be rooted, and it should be in the dispatcher if it is staged. The function handles the orderly abandonment of blocks, ensuring that parent blocks are abandoned before their children if they are on the same staging lane.
- **Inputs**:
    - `sched`: A pointer to an `fd_sched_t` structure representing the scheduler. Must not be null. The caller retains ownership.
    - `block`: A pointer to an `fd_sched_block_t` structure representing the block to abandon. Must not be null and must not be rooted. The caller retains ownership.
- **Output**: None
- **See Also**: [`subtree_abandon`](<#subtree_abandon>)  (Implementation)


---
### maybe\_switch\_block<!-- {{#callable_declaration:maybe_switch_block}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L184>)

Switches the active block in the scheduler if necessary.
- **Description**: Use this function to manage the active block in a scheduler by checking if the current block is done or should be deactivated. It handles the transition to a child block in the same staging lane if available, or releases the staging lane if no child block is present. This function should be called when there is a need to evaluate the status of the current block and potentially switch to another block for continued processing.
- **Inputs**:
    - `sched`: A pointer to an `fd_sched_t` structure representing the scheduler. Must not be null. The caller retains ownership.
    - `bank_idx`: An unsigned long representing the index of the current block in the scheduler's block pool. Must be a valid index within the scheduler's block pool.
- **Output**: None
- **See Also**: [`maybe_switch_block`](<#maybe_switch_block>)  (Implementation)


---
### find\_and\_stage\_longest\_unstaged\_fork<!-- {{#callable_declaration:find_and_stage_longest_unstaged_fork}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L187>)

Stages the longest unstaged fork in the scheduler.
- **Description**: Use this function to find and stage the longest unstaged fork in the scheduler's fork tree. This function is useful when you need to promote unstaged blocks to a staging lane for processing. It must be called with a valid scheduler that has been initialized and is not in an error state. The function will log a critical error if the scheduler is uninitialized or if there is an invariant violation during the staging process.
- **Inputs**:
    - `sched`: A pointer to a `fd_sched_t` structure representing the scheduler. It must be initialized and not null. The function assumes ownership of this pointer for the duration of the call.
    - `lane_idx`: An integer representing the index of the staging lane to use. It must be within the valid range of staging lanes available in the scheduler.
- **Output**: Returns the index of the head block of the staged lane on success, or `ULONG_MAX` if no staging occurred.
- **See Also**: [`find_and_stage_longest_unstaged_fork`](<#find_and_stage_longest_unstaged_fork>)  (Implementation)


---
### compute\_longest\_unstaged\_fork<!-- {{#callable_declaration:compute_longest_unstaged_fork}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L190>)

Calculates the depth of the longest unstaged fork in a scheduling tree.
- **Description**: Use this function to determine the depth of the longest unstaged fork starting from a given node in a scheduling tree. This function is useful for scheduling tasks in a hierarchical structure where nodes can have child and sibling relationships. It must be called with a valid `fd_sched_t` pointer and a valid `bank_idx` that does not equal `ULONG_MAX`. If `bank_idx` is `ULONG_MAX`, the function will log a critical error. The function traverses the tree recursively, updating the depth of each node based on its promotability and the depth of its children.
- **Inputs**:
    - `sched`: A pointer to an `fd_sched_t` structure representing the scheduling context. Must not be null.
    - `bank_idx`: An unsigned long representing the index of the node in the scheduling tree. Must not be `ULONG_MAX`.
- **Output**: Returns the depth of the longest unstaged fork as an unsigned long.
- **See Also**: [`compute_longest_unstaged_fork`](<#compute_longest_unstaged_fork>)  (Implementation)


---
### stage\_longest\_unstaged\_fork<!-- {{#callable_declaration:stage_longest_unstaged_fork}} -->
[View Source →](<../../../../../src/discof/replay/fd_sched.c#L193>)

Stages the longest unstaged fork in a scheduling lane.
- **Description**: Use this function to stage the longest unstaged fork in a specified scheduling lane. It updates the scheduling metrics and marks the lane as occupied if a fork is successfully staged. This function is typically called when there is a need to promote unstaged blocks to a staged state for processing. Ensure that the `sched` parameter is properly initialized before calling this function.
- **Inputs**:
    - `sched`: A pointer to an `fd_sched_t` structure representing the scheduler. Must not be null and should be properly initialized.
    - `bank_idx`: An unsigned long representing the index of the bank to start staging from. Must be a valid index within the scheduler's block pool.
    - `lane_idx`: An integer representing the index of the lane to stage the fork in. Must be within the valid range of staging lanes.
- **Output**: Returns the index of the head bank of the staged lane if successful, or `ULONG_MAX` if no fork was staged.
- **See Also**: [`stage_longest_unstaged_fork`](<#stage_longest_unstaged_fork>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)