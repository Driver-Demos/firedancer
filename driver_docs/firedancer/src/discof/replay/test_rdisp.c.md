<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for the `fd_rdisp` dispatcher, including transaction addition, scheduling, and block management.

# Purpose
The code is a C program designed to test and validate a transaction dispatcher system, likely for a blockchain or distributed ledger environment. It includes functions to add transactions ([`add_txn`](<#add_txn>) and [`add_txn2`](<#add_txn2>)), manage transaction blocks, and simulate transaction execution. The program uses a random number generator to create and test various transaction scenarios, ensuring that the dispatcher can handle different transaction dependencies and orderings. The code also includes a main function that sets up the environment, runs tests on the dispatcher, and logs the results.

The program is structured to handle both hosted and non-hosted environments, with conditional compilation directives (`#if FD_HAS_HOSTED`) to include system-specific headers and functionality. It defines several constants and data structures, such as `event_t` for managing transaction events and a priority queue for scheduling transactions. The code also includes functions for parsing transaction data from a file, simulating transaction execution, and verifying the correctness of the dispatcher. The main function orchestrates the testing process, including setting up random tests and validating the dispatcher's behavior under various conditions.
# Imports and Dependencies

---
- `stdalign.h`
- `fd_rdisp.h`
- `errno.h`
- `fcntl.h`
- `unistd.h`
- `sys/mman.h`
- `sys/stat.h`
- `../../util/tmpl/fd_prq.c`
- `../../util/tmpl/fd_sort.c`


# Global Variables

---
### footprint
- **Type**: `uchar array`
- **Description**: An array of unsigned characters with a size defined by the macro `TEST_FOOTPRINT`, which is set to 512 megabytes. The array is aligned to a 128-byte boundary.
- **Use**: Used as a memory buffer for operations related to the `fd_rdisp` dispatcher.


---
### verify\_scratch
- **Type**: ``uint[512UL]``
- **Description**: An array of unsigned integers with 512 elements.
- **Use**: Used as a scratch space for verification processes.


# Data Structures

---
### event\_t
- **Type**: ``struct``
- **Members**:
    - `timeout`: Stores the timeout value for the event.
    - `exec_idx`: Stores the execution index for the event.
    - `txn_idx`: Stores the transaction index for the event.
- **Description**: Defines an `event_t` structure that holds information about an event, including its timeout, execution index, and transaction index. This structure is used to manage and track events within a system, allowing for scheduling and execution based on the specified indices and timeout.


# Functions

---
### tag<!-- {{#callable:tag}} -->
[View Source →](<../../../../../src/discof/replay/test_rdisp.c#L20>)

Returns the input value `x` as the output.
- **Inputs**:
    - `x`: An unsigned long integer (`ulong`) to be returned.
- **Logic and Control Flow**:
    - The function takes an input parameter `x` of type `ulong`.
    - It directly returns the input value `x` without any modification.
- **Output**: The function returns the input value `x` as an `FD_RDISP_BLOCK_TAG_T` type.


---
### tag\_eq<!-- {{#callable:tag_eq}} -->
[View Source →](<../../../../../src/discof/replay/test_rdisp.c#L21>)

Compares two values to check if they are equal.
- **Inputs**:
    - `t1`: The first value of type `FD_RDISP_BLOCK_TAG_T` to compare.
    - `t2`: The second value of type `ulong` to compare.
- **Logic and Control Flow**:
    - Compares `t1` and `t2` using the equality operator `==`.
- **Output**: Returns an integer value `1` if `t1` and `t2` are equal, otherwise returns `0`.


---
### add\_txn<!-- {{#callable:add_txn}} -->
[View Source →](<../../../../../src/discof/replay/test_rdisp.c#L23>)

Categorizes input strings into signer, nonsigner, and alternate categories, constructs a transaction, and adds it to a dispatcher.
- **Inputs**:
    - ``rdisp``: A pointer to a `fd_rdisp_t` structure, representing the dispatcher where the transaction will be added.
    - ``rng``: A pointer to a `fd_rng_t` structure, used for random number generation.
    - ``tag``: A `FD_RDISP_BLOCK_TAG_T` value, used to tag the transaction block.
    - ``writable``: A constant character pointer to a writable string, representing writable accounts.
    - ``readonly``: A constant character pointer to a readonly string, representing readonly accounts.
    - ``serializing``: An integer flag indicating whether the transaction should be serialized.
- **Logic and Control Flow**:
    - Initialize a 3D array `categorized` to store categorized accounts and a 2D array `cat_cnts` to count them.
    - Iterate over `writable` and `readonly` strings, categorizing each character into signer, nonsigner, or alternate categories using a random number generator.
    - Ensure the total count of categorized accounts does not exceed 38.
    - Initialize a transaction structure `txn` and set its fields based on the categorized account counts.
    - Prepare a payload array and fill it with account addresses using the categorized data.
    - Determine if an alternate address table should be used based on the `serializing` flag and a random condition.
    - Call `fd_rdisp_add_txn` to add the transaction to the dispatcher and return the result.
- **Output**: Returns an unsigned long integer, which is the result of the `fd_rdisp_add_txn` function call.


---
### ushort\_to\_acct<!-- {{#callable:ushort_to_acct}} -->
[View Source →](<../../../../../src/discof/replay/test_rdisp.c#L69>)

Stores a given `ushort` value into each of the 16 `ushort` elements of the `b` array within a `fd_acct_addr_t` structure.
- **Inputs**:
    - `a`: A pointer to a `fd_acct_addr_t` structure where the `ushort` value will be stored.
    - `v`: A `ushort` value to be stored in the `b` array of the `fd_acct_addr_t` structure.
- **Logic and Control Flow**:
    - Iterates over 16 elements (from 0 to 15) of the `b` array in the `fd_acct_addr_t` structure.
    - For each element, stores the `ushort` value `v` at the position `b + 2*k` using the `FD_STORE` macro.
- **Output**: No return value; the function modifies the `b` array in the `fd_acct_addr_t` structure in place.


---
### add\_txn2<!-- {{#callable:add_txn2}} -->
[View Source →](<../../../../../src/discof/replay/test_rdisp.c#L71>)

Categorizes account addresses into signer, nonsigner, and alternate groups, constructs a transaction, and adds it to a dispatcher.
- **Inputs**:
    - ``rdisp``: A pointer to a `fd_rdisp_t` structure, representing the dispatcher where the transaction will be added.
    - ``rng``: A pointer to a `fd_rng_t` structure, used to generate random numbers for categorizing accounts.
    - ``tag``: A `FD_RDISP_BLOCK_TAG_T` value, used to tag the transaction block.
    - ``accts``: A pointer to an array of `ushort` values, representing account addresses to be categorized and included in the transaction.
    - ``acct_cnt``: An `ulong` value, indicating the number of accounts in the `accts` array.
- **Logic and Control Flow**:
    - Initialize a 3D array `categorized` to store accounts based on their category (signer, nonsigner, alt) and access type (writable, readonly).
    - Initialize a 2D array `cat_cnts` to count the number of accounts in each category and access type.
    - Iterate over each account in `accts`, determine its category using a random number, and store it in the `categorized` array based on its access type.
    - Check that the total number of signer and nonsigner accounts does not exceed 38.
    - Create a transaction structure `txn` and set its fields based on the categorized account counts.
    - Convert categorized account addresses to `fd_acct_addr_t` format and store them in `payload` and `alt` arrays.
    - Call `fd_rdisp_add_txn` to add the constructed transaction to the dispatcher `rdisp`.
- **Output**: Returns an `ulong` value, which is the index of the added transaction in the dispatcher.
- **Functions Called**:
    - [`ushort_to_acct`](<#ushort_to_acct>)


---
### pop\_option<!-- {{#callable:pop_option}} -->
[View Source →](<../../../../../src/discof/replay/test_rdisp.c#L111>)

Searches for a specified index in an array and marks it if found.
- **Inputs**:
    - `indices`: A pointer to an array of unsigned long integers where the search is performed.
    - `cnt`: The number of elements in the `indices` array to search through.
    - `idx`: The index value to search for in the `indices` array.
- **Logic and Control Flow**:
    - Iterate over the `indices` array from 0 to `cnt-1`.
    - Check if the current element in `indices` is equal to `idx`.
    - If a match is found, set the high bit of the matched element by performing a bitwise OR with `0x8000000000UL` and return `idx`.
    - If no match is found after the loop, return `0UL`.
- **Output**: Returns the `idx` if found and marked, otherwise returns `0UL`.


---
### test\_mainnet<!-- {{#callable:test_mainnet}} -->
[View Source →](<../../../../../src/discof/replay/test_rdisp.c#L130>)

Processes a mainnet test by reading a block file, parsing transactions, and scheduling them for execution.
- **Inputs**:
    - `filename`: The name of the block file to read, which is unused if `FD_HAS_HOSTED` is not defined.
    - `exec_cnt`: The number of execution tiles, which is unused if `FD_HAS_HOSTED` is not defined.
    - `ticks_per_cu`: The number of ticks per compute unit, which is unused if `FD_HAS_HOSTED` is not defined.
    - `staging_lane`: The staging lane identifier, which is unused if `FD_HAS_HOSTED` is not defined.
    - `check_results`: A flag to indicate whether to check transaction results, which is unused if `FD_HAS_HOSTED` is not defined.
- **Logic and Control Flow**:
    - Checks if the environment is hosted and if a filename is provided; if not, logs a notice and exits.
    - Opens the block file and maps it into memory for reading.
    - Initializes transaction and account data structures for parsing and processing transactions.
    - Parses transactions from the block file, adding them to a dispatcher for scheduling.
    - Schedules transactions for execution, updating execution states and checking results if required.
    - Logs the duration of transaction insertion and scheduling.
    - Unmaps the file from memory and closes the file descriptor.
- **Output**: No output is returned; the function performs operations and logs notices.
- **Functions Called**:
    - [`tag`](<#tag>)


---
### random\_test<!-- {{#callable:random_test}} -->
[View Source →](<../../../../../src/discof/replay/test_rdisp.c#L268>)

Tests random graph generation and transaction dispatching using a random number generator over a specified number of iterations.
- **Inputs**:
    - ``rng``: A pointer to a `fd_rng_t` structure, which is a random number generator used for generating random values.
    - ``iterations``: An unsigned long integer specifying the number of iterations to perform the random graph tests.
- **Logic and Control Flow**:
    - Logs the start of random graph testing.
    - Initializes `depth` and `block_depth` variables and checks if the dispatcher footprint and alignment are within limits.
    - Creates and joins a new dispatcher using `fd_rdisp_new` and `fd_rdisp_join`, and verifies its creation.
    - Iterates over the specified number of `iterations`, logging the current iteration and RNG state.
    - For each iteration, initializes a data structure `d` to store graph and transaction information.
    - Constructs random graphs by adding blocks to the dispatcher and generating random edges and clusters using reservoir sampling.
    - For each graph, adds transactions to the dispatcher and manages their dispatching and completion.
    - Verifies that all expected transactions are dispatched and completed correctly.
    - Removes blocks from the dispatcher and verifies the dispatcher state after each iteration.
    - Deletes the dispatcher at the end of the test.
- **Output**: No return value; the function performs tests and logs results.
- **Functions Called**:
    - [`tag`](<#tag>)
    - [`add_txn2`](<#add_txn2>)
    - [`fd_rdisp_verify`](<fd_rdisp.c.md#fd_rdisp_verify>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/discof/replay/test_rdisp.c#L428>)

Initializes the environment, processes command-line arguments, sets up a random number generator, and performs a series of tests on a dispatcher system.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of strings representing the command-line arguments.
- **Logic and Control Flow**:
    - Call `fd_boot` to initialize the environment with command-line arguments.
    - Create and join a random number generator using `fd_rng_new` and `fd_rng_join`.
    - Extract command-line arguments for `--block-file`, `--exec-tiles`, and `--random-iterations` using `fd_env_strip_cmdline_cstr` and `fd_env_strip_cmdline_ulong`.
    - Log the number of random iterations to be used.
    - Call [`test_mainnet`](<#test_mainnet>) with the extracted block file and execution parameters.
    - Set up dispatcher parameters and verify footprint and alignment constraints using `FD_TEST`.
    - Create and join a dispatcher using `fd_rdisp_new` and `fd_rdisp_join`.
    - Perform a series of tests on the dispatcher, including adding and removing blocks, adding transactions, and verifying dispatcher state using `FD_TEST`.
    - Conduct a random test on the dispatcher using [`random_test`](<#random_test>).
    - Delete the random number generator and dispatcher using `fd_rng_delete` and `fd_rdisp_delete`.
    - Log a success message and call `fd_halt` to terminate the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`test_mainnet`](<#test_mainnet>)
    - [`tag`](<#tag>)
    - [`add_txn`](<#add_txn>)
    - [`tag_eq`](<#tag_eq>)
    - [`fd_rdisp_verify`](<fd_rdisp.c.md#fd_rdisp_verify>)
    - [`pop_option`](<#pop_option>)
    - [`add_txn2`](<#add_txn2>)
    - [`random_test`](<#random_test>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)