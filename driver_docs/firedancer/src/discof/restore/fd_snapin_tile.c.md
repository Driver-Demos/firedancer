<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

A state machine implementation for parsing and loading snapshots into an in-memory database, with transaction cache management and error handling.

# Purpose
The code defines a C module for a component named `snapin`, which functions as a state machine to parse and load both full and incremental snapshots into an in-memory database. The primary purpose of this module is to manage the loading of account data and transaction caches, which are essential for maintaining the state of a distributed ledger or blockchain system. The module includes several key components, such as structures for managing blockhash entries, transaction caches, and account data. It also defines functions for processing different types of data fragments and control messages, which are used to manage the state transitions of the `snapin` tile.

The module imports various utilities and dependencies, indicating that it is part of a larger system. It includes headers for parsing and managing snapshots, metrics, and account databases. The code defines several constants and structures, such as `fd_blockhash_entry_t` and `fd_snapin_tile_t`, which are used to manage the state and data of the `snapin` tile. The module also includes functions for verifying slot deltas, processing manifests, and handling account data. Additionally, it defines a `fd_topo_run_tile_t` structure, which specifies the initialization and execution functions for the `snapin` tile, indicating that this module is intended to be integrated into a larger system that manages multiple tiles or components.
# Imports and Dependencies

---
- `utils/fd_ssctrl.h`
- `utils/fd_ssparse.h`
- `utils/fd_ssmanifest_parser.h`
- `utils/fd_slot_delta_parser.h`
- `utils/fd_ssmsg.h`
- `../../disco/topo/fd_topo.h`
- `../../disco/metrics/fd_metrics.h`
- `../../flamenco/accdb/fd_accdb_admin.h`
- `../../flamenco/accdb/fd_accdb_user.h`
- `../../flamenco/runtime/fd_acc_mgr.h`
- `../../flamenco/runtime/fd_txncache.h`
- `../../flamenco/runtime/sysvar/fd_sysvar_slot_history.h`
- `generated/fd_snapin_tile_seccomp.h`
- `../../util/tmpl/fd_map_chain.c`
- `../../disco/stem/fd_stem.c`


# Global Variables

---
### fd\_tile\_snapin
- **Type**: ``fd_topo_run_tile_t``
- **Description**: Represents a configuration for running a tile in a topology. It includes function pointers and parameters necessary for initializing and running the tile.
- **Use**: Used to define the behavior and properties of the `snapin` tile in the system.


# Data Structures

---
### fd\_blockhash\_entry
- **Type**: ``struct``
- **Members**:
    - ``blockhash``: A member of type `fd_hash_t` that stores the block hash.
    - ``map``: A nested `struct` containing `prev` and `next` of type `ulong` for linked list navigation.
- **Description**: Defines a structure to store a block hash and its position in a linked list using `prev` and `next` pointers for navigation.


---
### fd\_blockhash\_entry\_t
- **Type**: ``struct``
- **Members**:
    - ``blockhash``: Stores the block hash as an `fd_hash_t` type.
    - ``map``: Contains two `ulong` members, `prev` and `next`, for linked list navigation.
- **Description**: Defines a structure for storing a block hash and its position in a linked list, using `prev` and `next` to navigate between entries.


---
### blockhash\_group
- **Type**: ``struct``
- **Members**:
    - ``blockhash``: An array of 32 unsigned characters representing a block hash.
    - ``txnhash_offset``: An unsigned long integer representing the offset of the transaction hash.
- **Description**: The `blockhash_group` structure is used to store a block hash and its associated transaction hash offset. The `blockhash` field holds a 32-byte hash value, while the `txnhash_offset` field indicates the position of the transaction hash related to this block hash. This structure is likely used in contexts where block hashes and their transaction offsets need to be managed or referenced together.


---
### blockhash\_group\_t
- **Type**: ``struct``
- **Members**:
    - ``blockhash``: An array of 32 unsigned characters representing a block hash.
    - ``txnhash_offset``: An unsigned long integer representing the offset of the transaction hash.
- **Description**: `blockhash_group_t` is a structure that contains a block hash and an offset for a transaction hash. The `blockhash` field stores a 32-byte hash value, while the `txnhash_offset` field indicates the position of the transaction hash related to the block hash. This structure is used to manage and reference block hashes and their associated transaction hash offsets within a system that processes blockchain data.


---
### fd\_snapin\_tile
- **Type**: ``struct``
- **Members**:
    - ``full``: Indicates if the snapshot is full or incremental.
    - ``state``: Represents the current state of the snapshot process.
    - ``seed``: Stores a random seed for hash operations.
    - ``boot_timestamp``: Records the timestamp when the snapshot process started.
    - ``accdb_admin``: Holds administrative account database information.
    - ``accdb``: Holds user account database information.
    - ``txncache``: Points to a transaction cache structure.
    - ``acc_data``: Points to account data being processed.
    - ``xid``: Stores the transaction ID for the current operation.
    - ``stem``: Points to the stem context for publishing messages.
    - ``ssparse``: Points to the snapshot parser structure.
    - ``manifest_parser``: Points to the manifest parser structure.
    - ``slot_delta_parser``: Points to the slot delta parser structure.
    - ``flags``: Contains flags indicating the status of various operations.
    - ``bank_slot``: Stores the current bank slot number.
    - ``blockhash_offsets_len``: Indicates the length of the blockhash offsets array.
    - ``blockhash_offsets``: Points to an array of blockhash groups.
    - ``txncache_entries_len``: Indicates the length of the transaction cache entries array.
    - ``txncache_entries``: Points to an array of transaction cache entries.
    - ``txncache_root_fork_id``: Stores the root fork ID for the transaction cache.
    - ``metrics``: Contains metrics related to the snapshot process.
    - ``in``: Holds input workspace and related parameters.
    - ``manifest_out``: Holds output workspace and related parameters for the manifest.
- **Description**: Represents a state machine for parsing and loading full or incremental snapshots, managing account data, and interfacing with various parsers and caches. It maintains state and metrics for the snapshot process, and handles input and output through defined workspaces.


---
### fd\_snapin\_tile\_t
- **Type**: ``struct``
- **Members**:
    - ``full``: Indicates if the snapshot is full or incremental.
    - ``state``: Represents the current state of the snapin tile.
    - ``seed``: Stores a random seed for operations.
    - ``boot_timestamp``: Records the timestamp when the snapin tile was initialized.
    - ``accdb_admin``: Holds administrative account database information.
    - ``accdb``: Holds user account database information.
    - ``txncache``: Points to the transaction cache structure.
    - ``acc_data``: Points to the account data being processed.
    - ``xid``: Stores the transaction ID.
    - ``stem``: Points to the stem context.
    - ``ssparse``: Points to the snapshot parser.
    - ``manifest_parser``: Points to the manifest parser.
    - ``slot_delta_parser``: Points to the slot delta parser.
    - ``flags``: Contains flags indicating the processing status of the manifest and status cache.
    - ``bank_slot``: Stores the current bank slot number.
    - ``blockhash_offsets_len``: Indicates the length of the blockhash offsets array.
    - ``blockhash_offsets``: Points to the blockhash offsets array.
    - ``txncache_entries_len``: Indicates the length of the transaction cache entries array.
    - ``txncache_entries``: Points to the transaction cache entries array.
    - ``txncache_root_fork_id``: Stores the root fork ID of the transaction cache.
    - ``metrics``: Contains metrics related to bytes read and accounts inserted.
    - ``in``: Holds input workspace and related parameters.
    - ``manifest_out``: Holds output workspace and related parameters for the manifest.
- **Description**: `fd_snapin_tile_t` is a structure that represents a state machine responsible for parsing and loading snapshots, both full and incremental, into an in-memory database. It manages various components such as account databases, transaction caches, and parsers for snapshots, manifests, and slot deltas. The structure maintains state information, processing flags, and metrics to track the progress and performance of snapshot loading operations. It also handles input and output workspaces for data processing and communication.


# Functions

---
### should\_shutdown<!-- {{#callable:should_shutdown}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapin_tile.c#L125>)

Checks if the `ctx` state is `FD_SNAPSHOT_STATE_SHUTDOWN` and logs a notice if true.
- **Inputs**:
    - `ctx`: A pointer to a `fd_snapin_tile_t` structure representing the context of the snapin tile.
- **Logic and Control Flow**:
    - Checks if `ctx->state` is equal to `FD_SNAPSHOT_STATE_SHUTDOWN` using `FD_UNLIKELY` for branch prediction optimization.
    - If the condition is true, logs a notice with the number of accounts loaded and the time taken since `ctx->boot_timestamp`.
    - Returns the result of the comparison `ctx->state == FD_SNAPSHOT_STATE_SHUTDOWN`.
- **Output**: Returns an integer that is non-zero if `ctx->state` is `FD_SNAPSHOT_STATE_SHUTDOWN`, otherwise returns zero.


---
### scratch\_align<!-- {{#callable:scratch_align}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapin_tile.c#L133>)

Returns a constant value of 128 as an unsigned long integer.
- **Inputs**: None
- **Logic and Control Flow**:
    - The function does not take any input parameters.
    - It directly returns the constant value `128UL`.
- **Output**: An unsigned long integer with the value 128.


---
### scratch\_footprint<!-- {{#callable:scratch_footprint}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapin_tile.c#L138>)

Calculates the memory footprint required for various components of a `fd_snapin_tile_t` structure.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure, which contains configuration details for the tile, including `max_live_slots`.
- **Logic and Control Flow**:
    - Initialize `l` with `FD_LAYOUT_INIT`.
    - Append the size and alignment of `fd_snapin_tile_t` to `l` using `FD_LAYOUT_APPEND`.
    - Append the size and alignment of a sparse structure with a footprint of `1UL<<24UL` using `FD_LAYOUT_APPEND`.
    - Append the size and alignment of a transaction cache with a footprint based on `tile->snapin.max_live_slots` using `FD_LAYOUT_APPEND`.
    - Append the size and alignment of a manifest parser using `FD_LAYOUT_APPEND`.
    - Append the size and alignment of a slot delta parser using `FD_LAYOUT_APPEND`.
    - Append the size and alignment of `fd_sstxncache_entry_t` multiplied by `FD_SNAPIN_TXNCACHE_MAX_ENTRIES` using `FD_LAYOUT_APPEND`.
    - Append the size and alignment of `blockhash_group_t` multiplied by `FD_SNAPIN_MAX_SLOT_DELTA_GROUPS` using `FD_LAYOUT_APPEND`.
    - Finalize the layout with `FD_LAYOUT_FINI` and return the result.
- **Output**: Returns an `ulong` representing the total memory footprint required.
- **Functions Called**:
    - [`fd_ssparse_align`](<utils/fd_ssparse.c.md#fd_ssparse_align>)
    - [`fd_ssparse_footprint`](<utils/fd_ssparse.c.md#fd_ssparse_footprint>)
    - [`fd_ssmanifest_parser_align`](<utils/fd_ssmanifest_parser.c.md#fd_ssmanifest_parser_align>)
    - [`fd_ssmanifest_parser_footprint`](<utils/fd_ssmanifest_parser.c.md#fd_ssmanifest_parser_footprint>)
    - [`fd_slot_delta_parser_align`](<utils/fd_slot_delta_parser.c.md#fd_slot_delta_parser_align>)
    - [`fd_slot_delta_parser_footprint`](<utils/fd_slot_delta_parser.c.md#fd_slot_delta_parser_footprint>)


---
### metrics\_write<!-- {{#callable:metrics_write}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapin_tile.c#L152>)

Updates metrics for a `fd_snapin_tile_t` context by setting various gauge values.
- **Inputs**:
    - `ctx`: A pointer to a `fd_snapin_tile_t` structure containing the metrics to update.
- **Logic and Control Flow**:
    - Set the gauge `SNAPIN, FULL_BYTES_READ` to the value of `ctx->metrics.full_bytes_read`.
    - Set the gauge `SNAPIN, INCREMENTAL_BYTES_READ` to the value of `ctx->metrics.incremental_bytes_read`.
    - Set the gauge `SNAPIN, ACCOUNTS_INSERTED` to the value of `ctx->metrics.accounts_inserted`.
    - Set the gauge `SNAPIN, STATE` to the value of `ctx->state` cast to `ulong`.
- **Output**: No return value; the function updates metrics in the system.


---
### verify\_slot\_deltas\_with\_slot\_history<!-- {{#callable:verify_slot_deltas_with_slot_history}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapin_tile.c#L160>)

Verifies that each transaction cache entry's slot exists in the slot history.
- **Inputs**:
    - ``ctx``: A pointer to a `fd_snapin_tile_t` structure containing transaction cache entries.
    - ``slot_history``: A pointer to a `fd_slot_history_global_t` structure representing the global slot history.
- **Logic and Control Flow**:
    - Iterates over each transaction cache entry in `ctx->txncache_entries` using a for loop.
    - For each entry, checks if the slot exists in `slot_history` using `fd_sysvar_slot_history_find_slot`.
    - If a slot is not found, returns -1 immediately.
    - If all slots are found, returns 0.
- **Output**: Returns 0 if all slots are found in the slot history, otherwise returns -1 if any slot is missing.


---
### verify\_slot\_deltas\_with\_bank\_slot<!-- {{#callable:verify_slot_deltas_with_bank_slot}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapin_tile.c#L171>)

Checks if any transaction cache entry's slot exceeds the given bank slot and returns -1 if so, otherwise returns 0.
- **Inputs**:
    - ``ctx``: A pointer to a `fd_snapin_tile_t` structure that contains transaction cache entries.
    - ``bank_slot``: An unsigned long integer representing the bank slot to compare against transaction cache entry slots.
- **Logic and Control Flow**:
    - Iterates over each transaction cache entry in `ctx->txncache_entries` up to `ctx->txncache_entries_len`.
    - For each entry, checks if the entry's slot is greater than `bank_slot`.
    - If any entry's slot is greater than `bank_slot`, returns -1 immediately.
    - If no entry's slot is greater than `bank_slot`, returns 0 after the loop.
- **Output**: Returns -1 if any transaction cache entry's slot is greater than `bank_slot`, otherwise returns 0.


---
### transition\_malformed<!-- {{#callable:transition_malformed}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapin_tile.c#L181>)

Sets the state of the `fd_snapin_tile_t` context to error and publishes an error control message.
- **Inputs**:
    - ``ctx``: A pointer to an `fd_snapin_tile_t` structure representing the current context.
    - ``stem``: A pointer to an `fd_stem_context_t` structure used for publishing messages.
- **Logic and Control Flow**:
    - Set the `state` of `ctx` to `FD_SNAPSHOT_STATE_ERROR`.
    - Call `fd_stem_publish` with `stem` and specific parameters to publish an error control message.
- **Output**: No return value; the function operates by side effects on the input structures.


---
### populate\_txncache<!-- {{#callable:populate_txncache}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapin_tile.c#L188>)

Populates the transaction cache by constructing a fork chain of blockhashes and inserting transactions into it.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_snapin_tile_t` context structure, which contains the transaction cache and other related data.
    - ``blockhashes``: An array of `fd_snapshot_manifest_blockhash_t` structures containing blockhashes to be used in the transaction cache.
    - ``blockhashes_len``: The number of blockhashes in the `blockhashes` array.
- **Logic and Control Flow**:
    - Check that `blockhashes_len` is within the valid range (1 to 301).
    - Find the minimum sequence number (`seq_min`) from the `hash_index` of the blockhashes.
    - Calculate the maximum sequence number (`seq_max`) and handle overflow errors.
    - Initialize an array `banks` to store blockhashes and related data, ensuring no duplicate or out-of-range indices.
    - Create a hashset of the 151 most recent blockhashes and insert them into a map to track their offsets.
    - Load blockhash offsets from the context and update the `banks` array with these offsets.
    - Construct a linear fork chain in the transaction cache using the `banks` array.
    - Insert transactions into the transaction cache, assuming they executed at the current root.
    - Finalize all banks in the transaction cache, setting the transaction hash offset for future queries.
    - Advance the root of the transaction cache to the latest fork.
- **Output**: Returns 0 on success, or 1 if an error occurs during processing.
- **Functions Called**:
    - [`transition_malformed`](<#transition_malformed>)


---
### process\_manifest<!-- {{#callable:process_manifest}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapin_tile.c#L404>)

Processes a snapshot manifest by verifying slot deltas, populating the transaction cache, and publishing the manifest.
- **Inputs**:
    - ``ctx``: A pointer to a `fd_snapin_tile_t` structure that contains context and state information for processing the manifest.
- **Logic and Control Flow**:
    - Convert the manifest chunk to a local address using `fd_chunk_to_laddr` and assign it to `manifest`.
    - Set `ctx->bank_slot` to the slot value from the manifest.
    - Verify slot deltas with the bank slot using [`verify_slot_deltas_with_bank_slot`](<#verify_slot_deltas_with_bank_slot>); if verification fails, log a warning, transition to a malformed state, and return.
    - Populate the transaction cache using [`populate_txncache`](<#populate_txncache>); if this fails, log a warning, transition to a malformed state, and return.
    - Set the `txncache_fork_id` in the manifest to the value of `ctx->txncache_root_fork_id.val`.
    - Determine the signature based on whether `ctx->full` is true or false, using [`fd_ssmsg_sig`](<utils/fd_ssmsg.h.md#fd_ssmsg_sig>) with `FD_SSMSG_MANIFEST_FULL` or `FD_SSMSG_MANIFEST_INCREMENTAL`.
    - Publish the manifest using `fd_stem_publish` with the determined signature and other parameters.
    - Update `ctx->manifest_out.chunk` using `fd_dcache_compact_next` to prepare for the next manifest.
- **Output**: No return value; the function modifies the state of `ctx` and publishes the manifest.
- **Functions Called**:
    - [`verify_slot_deltas_with_bank_slot`](<#verify_slot_deltas_with_bank_slot>)
    - [`transition_malformed`](<#transition_malformed>)
    - [`populate_txncache`](<#populate_txncache>)
    - [`fd_ssmsg_sig`](<utils/fd_ssmsg.h.md#fd_ssmsg_sig>)


---
### process\_account\_header<!-- {{#callable:process_account_header}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapin_tile.c#L429>)

Processes an account header by querying or preparing a record, updating metadata, and potentially publishing the record.
- **Inputs**:
    - ``ctx``: A pointer to `fd_snapin_tile_t` structure, representing the context for the operation.
    - ``result``: A pointer to `fd_ssparse_advance_result_t` structure, containing the account header data to process.
- **Logic and Control Flow**:
    - Retrieve the `funk` database from the `ctx` structure.
    - Generate a record key `id` using the public key from `result->account_header.pubkey`.
    - Attempt to query the record using `fd_funk_rec_query_try`.
    - If the record does not exist, prepare a new record and set `should_publish` to 1.
    - Retrieve the metadata from the record using `fd_funk_val`.
    - If metadata exists and its slot is greater than the current slot, set `ctx->acc_data` to NULL and return.
    - Flush the old value from the record and allocate new memory for the metadata and account data.
    - Initialize the metadata with values from `result->account_header`.
    - Update `ctx->acc_data` to point to the new account data location and increment the `accounts_inserted` metric.
    - If `should_publish` is true, publish the prepared record using `fd_funk_rec_publish`.
- **Output**: No explicit return value; updates the context and possibly publishes a record.


---
### process\_account\_data<!-- {{#callable:process_account_data}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapin_tile.c#L481>)

Copies account data from the `result` structure to the `ctx` structure if `ctx->acc_data` is not NULL.
- **Inputs**:
    - `ctx`: A pointer to an `fd_snapin_tile_t` structure, which contains the context for processing account data, including a pointer to the account data buffer (`acc_data`).
    - `result`: A pointer to an `fd_ssparse_advance_result_t` structure, which contains the account data to be processed, including the data and its size (`account_data.data` and `account_data.data_sz`).
- **Logic and Control Flow**:
    - Check if `ctx->acc_data` is NULL using `FD_UNLIKELY`; if it is NULL, return immediately without processing.
    - Use `fd_memcpy` to copy `result->account_data.data` to `ctx->acc_data`.
    - Increment `ctx->acc_data` by `result->account_data.data_sz` to update the pointer to the next position in the buffer.
- **Output**: No return value; the function modifies the `ctx` structure in place.


---
### streamlined\_insert<!-- {{#callable:streamlined_insert}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapin_tile.c#L493>)

Inserts an unfragmented account into the database during a full snapshot load.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_snapin_tile_t` context structure, which contains the database and metrics information.
    - ``rec``: A pointer to the `fd_funk_rec_t` record structure where the account data will be stored.
    - ``frame``: A constant pointer to an array of unsigned characters containing the account data to be inserted.
    - ``slot``: An unsigned long integer representing the slot number associated with the account.
- **Logic and Control Flow**:
    - Load `data_len`, `lamports`, and `rent_epoch` from the `frame` using `fd_ulong_load_8_fast` at specific offsets.
    - Copy the account owner data from the `frame` to the `owner` array.
    - Determine if the account is executable by checking a specific byte in the `frame`.
    - Check if `data_len` exceeds `FD_RUNTIME_ACC_SZ_MAX` and log an error if it does.
    - Flush the current value in `rec` using `fd_funk_val_flush`.
    - Allocate memory for the account metadata and data using `fd_alloc_malloc_at_least`, and log an error if allocation fails.
    - Initialize the metadata structure `meta` with zeroes and set its fields using the loaded values and `slot`.
    - Copy the account data from the `frame` to the allocated space after the metadata.
    - Increment the `accounts_inserted` metric in `ctx`.
- **Output**: No return value; the function modifies the `rec` and updates the `ctx` metrics.


---
### process\_account\_batch<!-- {{#callable:process_account_batch}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapin_tile.c#L536>)

Processes a batch of account data by deriving map chains, loading hash chain heads, walking hash chains, creating map entries, and inserting accounts.
- **Inputs**:
    - ``ctx``: A pointer to a `fd_snapin_tile_t` structure, which contains context information for processing the account batch.
    - ``result``: A pointer to a `fd_ssparse_advance_result_t` structure, which contains the batch of account data to process.
- **Logic and Control Flow**:
    - Initialize pointers to the account database and record map from the context.
    - Derive map chains by calculating hash values for each account's public key and determining the chain index.
    - Load the head and version count of each hash chain in parallel.
    - Determine the maximum chain length across all chains.
    - Walk through each hash chain in parallel to find existing records that match the public key.
    - For each account, if no existing record is found, acquire a new record from the pool, initialize it, and insert it into the hash map.
    - If an existing record is found, check if the existing record's slot is newer than the current batch's slot; if so, skip the record.
    - Finally, insert the accounts into the database using the [`streamlined_insert`](<#streamlined_insert>) function.
- **Output**: No direct output; the function modifies the state of the account database by inserting or updating account records.
- **Functions Called**:
    - [`streamlined_insert`](<#streamlined_insert>)


---
### handle\_data\_frag<!-- {{#callable:handle_data_frag}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapin_tile.c#L624>)

Processes data fragments in a snapshot stream, handling different states and parsing results to update context and metrics.
- **Inputs**:
    - ``ctx``: A pointer to a `fd_snapin_tile_t` structure representing the current context of the snapshot processing.
    - ``chunk``: An unsigned long representing the current chunk of data being processed.
    - ``sz``: An unsigned long representing the size of the data fragment.
    - ``stem``: A pointer to a `fd_stem_context_t` structure used for publishing control messages.
- **Logic and Control Flow**:
    - Checks if the context state is `FD_SNAPSHOT_STATE_FINISHING` or `FD_SNAPSHOT_STATE_ERROR` and handles these cases by transitioning to a malformed state or ignoring the fragment, respectively.
    - Verifies that the chunk is within valid bounds and the size does not exceed the maximum transmission unit (MTU).
    - Enters a loop to process the data fragment until all bytes are consumed.
    - Calls [`fd_ssparse_advance`](<utils/fd_ssparse.c.md#fd_ssparse_advance>) to parse the data and handles different results such as errors, manifest parsing, status cache updates, and account data processing.
    - Updates context flags and metrics based on the parsing results and checks if the manifest and status cache are fully processed to trigger further processing.
    - Adjusts the position in the input data and determines if the fragment needs reprocessing based on the remaining size.
- **Output**: Returns an integer indicating whether the fragment needs reprocessing (1) or not (0).
- **Functions Called**:
    - [`transition_malformed`](<#transition_malformed>)
    - [`fd_ssparse_advance`](<utils/fd_ssparse.c.md#fd_ssparse_advance>)
    - [`fd_ssmanifest_parser_consume`](<utils/fd_ssmanifest_parser.c.md#fd_ssmanifest_parser_consume>)
    - [`fd_slot_delta_parser_consume`](<utils/fd_slot_delta_parser.c.md#fd_slot_delta_parser_consume>)
    - [`process_account_header`](<#process_account_header>)
    - [`process_account_data`](<#process_account_data>)
    - [`process_account_batch`](<#process_account_batch>)
    - [`process_manifest`](<#process_manifest>)


---
### handle\_control\_frag<!-- {{#callable:handle_control_frag}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapin_tile.c#L733>)

Handles control signals for a snapshot state machine, updating the state and performing actions based on the signal type.
- **Inputs**:
    - `ctx`: A pointer to a `fd_snapin_tile_t` structure representing the current context of the snapshot state machine.
    - `stem`: A pointer to a `fd_stem_context_t` structure used for publishing messages.
    - `sig`: An unsigned long integer representing the control signal to handle.
- **Logic and Control Flow**:
    - Retrieve the `funk` object from `ctx->accdb->funk`.
    - Use a switch statement to handle different control signals (`sig`).
    - For `FD_SNAPSHOT_MSG_CTRL_INIT_FULL` and `FD_SNAPSHOT_MSG_CTRL_INIT_INCR`, enable batch processing, reset state, and initialize parsers.
    - For `FD_SNAPSHOT_MSG_CTRL_FAIL`, reset the state to idle and clear or cancel transactions based on the `full` flag.
    - For `FD_SNAPSHOT_MSG_CTRL_NEXT`, check the state and transition to idle, then attach a child transaction ID.
    - For `FD_SNAPSHOT_MSG_CTRL_DONE`, verify slot deltas, publish transactions, and update the transaction ID to the restored slot number.
    - For `FD_SNAPSHOT_MSG_CTRL_SHUTDOWN`, set the state to shutdown and write metrics.
    - For `FD_SNAPSHOT_MSG_CTRL_ERROR`, set the state to error.
    - Log an error for unexpected control signals.
    - Forward the control message down the pipeline using `fd_stem_publish`.
- **Output**: No direct output; the function modifies the state of `ctx` and publishes messages using `stem`.
- **Functions Called**:
    - [`fd_ssparse_batch_enable`](<utils/fd_ssparse.c.md#fd_ssparse_batch_enable>)
    - [`fd_ssparse_reset`](<utils/fd_ssparse.c.md#fd_ssparse_reset>)
    - [`fd_ssmanifest_parser_init`](<utils/fd_ssmanifest_parser.c.md#fd_ssmanifest_parser_init>)
    - [`fd_slot_delta_parser_init`](<utils/fd_slot_delta_parser.c.md#fd_slot_delta_parser_init>)
    - [`transition_malformed`](<#transition_malformed>)
    - [`verify_slot_deltas_with_slot_history`](<#verify_slot_deltas_with_slot_history>)
    - [`fd_ssmsg_sig`](<utils/fd_ssmsg.h.md#fd_ssmsg_sig>)
    - [`metrics_write`](<#metrics_write>)


---
### returnable\_frag<!-- {{#callable:returnable_frag}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapin_tile.c#L837>)

Processes a fragment by handling data or control messages based on the signature.
- **Inputs**:
    - `ctx`: A pointer to a `fd_snapin_tile_t` structure representing the context of the snapin tile.
    - `in_idx`: An unused parameter representing the input index.
    - `seq`: An unused parameter representing the sequence number.
    - `sig`: An unsigned long integer representing the signature of the fragment.
    - `chunk`: An unsigned long integer representing the chunk of data.
    - `sz`: An unsigned long integer representing the size of the data.
    - `ctl`: An unused parameter representing control information.
    - `tsorig`: An unused parameter representing the original timestamp.
    - `tspub`: An unused parameter representing the publication timestamp.
    - `stem`: A pointer to a `fd_stem_context_t` structure representing the stem context.
- **Logic and Control Flow**:
    - Check if the `ctx->state` is not equal to `FD_SNAPSHOT_STATE_SHUTDOWN` using `FD_TEST` macro.
    - Assign the `stem` to `ctx->stem`.
    - If `sig` is equal to `FD_SNAPSHOT_MSG_DATA`, call [`handle_data_frag`](<#handle_data_frag>) with `ctx`, `chunk`, `sz`, and `stem` as arguments and return its result.
    - Otherwise, call [`handle_control_frag`](<#handle_control_frag>) with `ctx`, `stem`, and `sig` as arguments.
    - Set `ctx->stem` to `NULL`.
    - Return 0.
- **Output**: Returns an integer, 0 if the fragment is a control message or the result of [`handle_data_frag`](<#handle_data_frag>) if it is a data message.
- **Functions Called**:
    - [`handle_data_frag`](<#handle_data_frag>)
    - [`handle_control_frag`](<#handle_control_frag>)


---
### populate\_allowed\_fds<!-- {{#callable:populate_allowed_fds}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapin_tile.c#L858>)

Populates an array with allowed file descriptors, including `stderr` and optionally a logfile descriptor, and returns the count of populated descriptors.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, which is not used in this function.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure, which is not used in this function.
    - ``out_fds_cnt``: The maximum number of file descriptors that can be stored in the `out_fds` array.
    - ``out_fds``: A pointer to an array of integers where the function will store the allowed file descriptors.
- **Logic and Control Flow**:
    - Check if `out_fds_cnt` is less than 2; if true, log an error and terminate the program.
    - Initialize `out_cnt` to 0.
    - Assign the file descriptor for `stderr` (2) to `out_fds[out_cnt]` and increment `out_cnt`.
    - Check if the logfile descriptor is valid (not -1); if true, assign it to `out_fds[out_cnt]` and increment `out_cnt`.
    - Return the value of `out_cnt`, which represents the number of file descriptors populated.
- **Output**: Returns the number of file descriptors populated in the `out_fds` array.


---
### populate\_allowed\_seccomp<!-- {{#callable:populate_allowed_seccomp}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapin_tile.c#L874>)

Populates a seccomp filter policy for a snapin tile and returns the instruction count.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, which is not used in this function.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure, which is not used in this function.
    - ``out_cnt``: An unsigned long integer representing the count of output filters.
    - ``out``: A pointer to a `struct sock_filter` array where the seccomp filter policy will be populated.
- **Logic and Control Flow**:
    - Calls [`populate_sock_filter_policy_fd_snapin_tile`](<generated/fd_snapin_tile_seccomp.h.md#populate_sock_filter_policy_fd_snapin_tile>) with `out_cnt`, `out`, and the file descriptor from `fd_log_private_logfile_fd()` to populate the seccomp filter policy.
    - Returns the value of `sock_filter_policy_fd_snapin_tile_instr_cnt`.
- **Output**: Returns an unsigned long integer representing the instruction count of the seccomp filter policy.
- **Functions Called**:
    - [`populate_sock_filter_policy_fd_snapin_tile`](<generated/fd_snapin_tile_seccomp.h.md#populate_sock_filter_policy_fd_snapin_tile>)


---
### privileged\_init<!-- {{#callable:privileged_init}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapin_tile.c#L885>)

Initializes a `fd_snapin_tile_t` context with secure random seed generation and memory allocation.
- **Inputs**:
    - ``topo``: A pointer to an `fd_topo_t` structure representing the topology.
    - ``tile``: A pointer to an `fd_topo_tile_t` structure representing the tile configuration.
- **Logic and Control Flow**:
    - Calls `fd_topo_obj_laddr` to get the local address of the tile object using `topo` and `tile->tile_obj_id`.
    - Initializes a scratch memory allocator with `FD_SCRATCH_ALLOC_INIT` using the obtained local address.
    - Allocates memory for a `fd_snapin_tile_t` context using `FD_SCRATCH_ALLOC_APPEND`.
    - Generates a secure random seed for the context using `fd_rng_secure`.
- **Output**: No output is returned as the function is of type `void`.


---
### unprivileged\_init<!-- {{#callable:unprivileged_init}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapin_tile.c#L896>)

Initializes the unprivileged components of a `fd_snapin_tile_t` structure using the provided topology and tile information.
- **Inputs**:
    - ``topo``: A pointer to an `fd_topo_t` structure representing the topology configuration.
    - ``tile``: A pointer to an `fd_topo_tile_t` structure representing the tile configuration.
- **Logic and Control Flow**:
    - Allocate scratch memory using `fd_topo_obj_laddr` to get the local address of the tile object ID.
    - Initialize a scratch allocator with `FD_SCRATCH_ALLOC_INIT`.
    - Allocate memory for `fd_snapin_tile_t`, `fd_ssparse`, `fd_txncache`, `fd_ssmanifest_parser`, and `fd_slot_delta_parser` using `FD_SCRATCH_ALLOC_APPEND`.
    - Set initial values for `ctx->full`, `ctx->state`, and `ctx->boot_timestamp`.
    - Join the admin and user account databases using `fd_accdb_admin_join` and `fd_accdb_user_join`.
    - Copy the transaction ID from the root of the admin account database to `ctx->xid`.
    - Join the transaction cache shared memory and initialize the transaction cache using `fd_txncache_shmem_join` and `fd_txncache_join`.
    - Initialize `ctx->txncache_entries_len` and `ctx->blockhash_offsets_len` to zero.
    - Create new instances of `fd_ssparse`, `fd_ssmanifest_parser`, and `fd_slot_delta_parser` and verify their creation with `FD_TEST`.
    - Set up the output workspace and chunk information for the manifest using `fd_dcache_compact_chunk0` and `fd_dcache_compact_wmark`.
    - Reset and initialize parsers for sparse, manifest, and slot delta using [`fd_ssparse_reset`](<utils/fd_ssparse.c.md#fd_ssparse_reset>), [`fd_ssmanifest_parser_init`](<utils/fd_ssmanifest_parser.c.md#fd_ssmanifest_parser_init>), and [`fd_slot_delta_parser_init`](<utils/fd_slot_delta_parser.c.md#fd_slot_delta_parser_init>).
    - Set up the input workspace and chunk information using `fd_dcache_compact_chunk0` and `fd_dcache_compact_wmark`.
    - Initialize the `ctx->flags` structure to zero using `fd_memset`.
- **Output**: No return value; the function initializes the `fd_snapin_tile_t` structure in place.
- **Functions Called**:
    - [`fd_ssparse_align`](<utils/fd_ssparse.c.md#fd_ssparse_align>)
    - [`fd_ssparse_footprint`](<utils/fd_ssparse.c.md#fd_ssparse_footprint>)
    - [`fd_ssmanifest_parser_align`](<utils/fd_ssmanifest_parser.c.md#fd_ssmanifest_parser_align>)
    - [`fd_ssmanifest_parser_footprint`](<utils/fd_ssmanifest_parser.c.md#fd_ssmanifest_parser_footprint>)
    - [`fd_slot_delta_parser_align`](<utils/fd_slot_delta_parser.c.md#fd_slot_delta_parser_align>)
    - [`fd_slot_delta_parser_footprint`](<utils/fd_slot_delta_parser.c.md#fd_slot_delta_parser_footprint>)
    - [`fd_ssparse_new`](<utils/fd_ssparse.c.md#fd_ssparse_new>)
    - [`fd_ssmanifest_parser_join`](<utils/fd_ssmanifest_parser.c.md#fd_ssmanifest_parser_join>)
    - [`fd_ssmanifest_parser_new`](<utils/fd_ssmanifest_parser.c.md#fd_ssmanifest_parser_new>)
    - [`fd_slot_delta_parser_join`](<utils/fd_slot_delta_parser.c.md#fd_slot_delta_parser_join>)
    - [`fd_slot_delta_parser_new`](<utils/fd_slot_delta_parser.c.md#fd_slot_delta_parser_new>)
    - [`fd_ssparse_reset`](<utils/fd_ssparse.c.md#fd_ssparse_reset>)
    - [`fd_ssmanifest_parser_init`](<utils/fd_ssmanifest_parser.c.md#fd_ssmanifest_parser_init>)
    - [`fd_slot_delta_parser_init`](<utils/fd_slot_delta_parser.c.md#fd_slot_delta_parser_init>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)