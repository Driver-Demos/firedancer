<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

A state machine for decompressing full and incremental snapshot byte streams using Zstandard.

# Purpose
The code defines a C module that implements a state machine for decompressing snapshot byte streams. It is part of a larger system that handles data compression and decompression, specifically using the Zstandard (ZSTD) library. The module is designed to process both full and incremental snapshot streams, which it receives from another component called the `snapld` tile. The main structure, `fd_snapdc_tile_t`, maintains the state of the decompression process, including the ZSTD decompression context, input and output workspace details, and metrics for tracking the number of bytes read and decompressed.

The module includes several functions to manage the decompression process. These functions handle control and data fragments, manage state transitions, and update metrics. The [`handle_control_frag`](<#handle_control_frag>) function processes control signals to reset or change the state of the decompression stream, while [`handle_data_frag`](<#handle_data_frag>) processes incoming data fragments, decompresses them, and handles any errors that occur during decompression. The module also includes initialization functions to set up the decompression context and workspace, and it defines a `fd_topo_run_tile_t` structure to integrate with the larger system, specifying functions for allowed file descriptors, seccomp policies, and the main run loop.
# Imports and Dependencies

---
- `utils/fd_ssctrl.h`
- `../../disco/topo/fd_topo.h`
- `../../disco/metrics/fd_metrics.h`
- `generated/fd_snapdc_tile_seccomp.h`
- `zstd.h`
- `../../disco/stem/fd_stem.c`


# Global Variables

---
### fd\_tile\_snapdc
- **Type**: ``fd_topo_run_tile_t``
- **Description**: Defines a tile configuration for running a decompression state machine in a distributed system. It includes function pointers for populating allowed file descriptors and seccomp filters, as well as initialization and execution routines.
- **Use**: Used to configure and manage the execution of a decompression tile in a distributed system.


# Data Structures

---
### fd\_snapdc\_tile
- **Type**: ``struct``
- **Members**:
    - ``full``: Indicates if the snapshot is full or incremental.
    - ``state``: Represents the current state of the tile.
    - ``zstd``: Pointer to a Zstandard decompression context.
    - ``in``: Contains input workspace and related metadata.
    - ``out``: Contains output workspace and related metadata.
    - ``metrics``: Tracks metrics for full and incremental decompression.
- **Description**: Manages the decompression of snapshot byte streams, handling both full and incremental snapshots, and maintains state and metrics for the decompression process.


---
### fd\_snapdc\_tile\_t
- **Type**: ``struct``
- **Members**:
    - ``full``: Indicates if the snapshot is full (1) or incremental (0).
    - ``state``: Represents the current state of the tile in the snapshot process.
    - ``zstd``: Pointer to a Zstandard decompression context.
    - ``in``: Contains input workspace details and fragment position.
    - ``out``: Contains output workspace details and chunk information.
    - ``metrics``: Tracks metrics for full and incremental snapshots, including bytes read.
- **Description**: Manages the decompression of snapshot byte streams, handling both full and incremental snapshots, and maintains state and metrics for the decompression process.


# Functions

---
### scratch\_align<!-- {{#callable:scratch_align}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapdc_tile.c#L55>)

Calculates the maximum alignment requirement between the `fd_snapdc_tile_t` structure and 32 bytes.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `fd_ulong_max` with `alignof(fd_snapdc_tile_t)` and `32UL` as arguments.
    - Returns the result of `fd_ulong_max`, which is the maximum of the two values.
- **Output**: Returns an `ulong` representing the maximum alignment requirement.


---
### scratch\_footprint<!-- {{#callable:scratch_footprint}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapdc_tile.c#L60>)

Calculates the memory footprint required for a scratch space used by a tile in a decompression process.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure, which represents a tile in the topology; however, it is not used in the function.
- **Logic and Control Flow**:
    - Initialize a variable `l` with `FD_LAYOUT_INIT` to start the layout calculation.
    - Append the size and alignment of `fd_snapdc_tile_t` to `l` using `FD_LAYOUT_APPEND`.
    - Append the estimated size of a Zstandard decompression stream to `l` with a 32-byte alignment using `FD_LAYOUT_APPEND`.
    - Finalize the layout calculation with `FD_LAYOUT_FINI`, using the alignment returned by `scratch_align()`, and return the result.
- **Output**: Returns an `ulong` representing the total memory footprint required for the scratch space.
- **Functions Called**:
    - [`scratch_align`](<#scratch_align>)


---
### should\_shutdown<!-- {{#callable:should_shutdown}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapdc_tile.c#L69>)

Checks if the `fd_snapdc_tile_t` context is in the shutdown state.
- **Inputs**:
    - `ctx`: A pointer to a `fd_snapdc_tile_t` structure representing the context of the snapdc tile.
- **Logic and Control Flow**:
    - Compares the `state` field of the `ctx` structure to the constant `FD_SNAPSHOT_STATE_SHUTDOWN`.
    - Returns the result of the comparison as an integer.
- **Output**: Returns an integer value: 1 if the `state` is `FD_SNAPSHOT_STATE_SHUTDOWN`, otherwise 0.


---
### metrics\_write<!-- {{#callable:metrics_write}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapdc_tile.c#L74>)

Updates metrics for full and incremental compressed and decompressed bytes read, and the current state of the context.
- **Inputs**:
    - `ctx`: A pointer to a `fd_snapdc_tile_t` structure containing the metrics and state to update.
- **Logic and Control Flow**:
    - Calls `FD_MGAUGE_SET` to update the metric `SNAPDC` for `FULL_COMPRESSED_BYTES_READ` with `ctx->metrics.full.compressed_bytes_read`.
    - Calls `FD_MGAUGE_SET` to update the metric `SNAPDC` for `FULL_DECOMPRESSED_BYTES_READ` with `ctx->metrics.full.decompressed_bytes_read`.
    - Calls `FD_MGAUGE_SET` to update the metric `SNAPDC` for `INCREMENTAL_COMPRESSED_BYTES_READ` with `ctx->metrics.incremental.compressed_bytes_read`.
    - Calls `FD_MGAUGE_SET` to update the metric `SNAPDC` for `INCREMENTAL_DECOMPRESSED_BYTES_READ` with `ctx->metrics.incremental.decompressed_bytes_read`.
    - Calls `FD_MGAUGE_SET` to update the metric `SNAPDC` for `STATE` with the current state cast to `ulong`.
- **Output**: No return value; the function updates metrics in place.


---
### handle\_control\_frag<!-- {{#callable:handle_control_frag}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapdc_tile.c#L85>)

Processes control signals to manage the state of a decompression stream and forward control messages.
- **Inputs**:
    - `ctx`: A pointer to a `fd_snapdc_tile_t` structure representing the decompression context.
    - `stem`: A pointer to a `fd_stem_context_t` structure used for publishing control messages.
    - `sig`: An unsigned long integer representing the control signal to process.
- **Logic and Control Flow**:
    - If `sig` is `FD_SNAPSHOT_MSG_META`, return immediately without processing.
    - Reset the decompression stream using `ZSTD_DCtx_reset` and log an error if it fails.
    - Use a switch statement to handle different control signals (`sig`).
    - For `FD_SNAPSHOT_MSG_CTRL_INIT_FULL`, set the state to `FD_SNAPSHOT_STATE_PROCESSING`, mark as full, and reset metrics.
    - For `FD_SNAPSHOT_MSG_CTRL_INIT_INCR`, set the state to `FD_SNAPSHOT_STATE_PROCESSING`, mark as incremental, and reset metrics.
    - For `FD_SNAPSHOT_MSG_CTRL_FAIL`, set the state to `FD_SNAPSHOT_STATE_IDLE` if the current state is valid.
    - For `FD_SNAPSHOT_MSG_CTRL_NEXT` and `FD_SNAPSHOT_MSG_CTRL_DONE`, check the state and set to `FD_SNAPSHOT_STATE_IDLE` or `FD_SNAPSHOT_STATE_ERROR` as needed.
    - For `FD_SNAPSHOT_MSG_CTRL_SHUTDOWN`, set the state to `FD_SNAPSHOT_STATE_SHUTDOWN` and write metrics.
    - For `FD_SNAPSHOT_MSG_CTRL_ERROR`, set the state to `FD_SNAPSHOT_STATE_ERROR`.
    - Log an error for unexpected control signals.
    - Forward the control message using `fd_stem_publish`.
- **Output**: No direct output is returned, but the function modifies the state of `ctx` and publishes control messages using `fd_stem_publish`.
- **Functions Called**:
    - [`metrics_write`](<#metrics_write>)


---
### handle\_data\_frag<!-- {{#callable:handle_data_frag}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapdc_tile.c#L147>)

Processes data fragments for decompression and manages state transitions based on the snapshot's current state.
- **Inputs**:
    - `ctx`: A pointer to a `fd_snapdc_tile_t` structure representing the current context of the snapshot decompression process.
    - `stem`: A pointer to a `fd_stem_context_t` structure used for publishing messages.
    - `chunk`: An unsigned long integer representing the current data chunk to process.
    - `sz`: An unsigned long integer representing the size of the data fragment.
- **Logic and Control Flow**:
    - Checks if the current state is `FD_SNAPSHOT_STATE_FINISHING` and sets the state to `FD_SNAPSHOT_STATE_ERROR` if true, then publishes an error message and returns 0.
    - Ignores data fragments if the state is `FD_SNAPSHOT_STATE_ERROR` and returns 0.
    - Logs an error if the state is not `FD_SNAPSHOT_STATE_PROCESSING`.
    - Validates the input parameters against the context's constraints using `FD_TEST`.
    - Retrieves the input data and output buffer addresses based on the current fragment position and chunk.
    - Decompresses the input data using `ZSTD_decompressStream_simpleArgs` and checks for errors.
    - If decompression produces output, publishes a data message and updates the output chunk position.
    - Updates the fragment position and validates it against the size.
    - Updates the metrics for compressed and decompressed bytes read based on whether the snapshot is full or incremental.
    - Checks if decompression is complete and if there is trailing data, sets the state to `FD_SNAPSHOT_STATE_ERROR` and publishes an error message.
    - Sets the state to `FD_SNAPSHOT_STATE_FINISHING` if decompression is complete without errors.
    - Determines if more output is possible and resets the fragment position if not, then returns whether more output is possible.
- **Output**: Returns an integer indicating whether more output is possible (1) or not (0).


---
### returnable\_frag<!-- {{#callable:returnable_frag}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapdc_tile.c#L226>)

Determines if a fragment is returnable by checking its type and handling it accordingly.
- **Inputs**:
    - `ctx`: A pointer to a `fd_snapdc_tile_t` structure representing the context of the snapshot decompression tile.
    - `in_idx`: An unused `ulong` parameter.
    - `seq`: An unused `ulong` parameter.
    - `sig`: A `ulong` representing the signal type of the fragment.
    - `chunk`: A `ulong` representing the chunk of data associated with the fragment.
    - `sz`: A `ulong` representing the size of the data chunk.
    - `ctl`: An unused `ulong` parameter.
    - `tsorig`: An unused `ulong` parameter.
    - `tspub`: An unused `ulong` parameter.
    - `stem`: A pointer to a `fd_stem_context_t` structure used for publishing messages.
- **Logic and Control Flow**:
    - Checks that the `ctx->state` is not equal to `FD_SNAPSHOT_STATE_SHUTDOWN` using `FD_TEST` macro.
    - If `sig` equals `FD_SNAPSHOT_MSG_DATA`, calls [`handle_data_frag`](<#handle_data_frag>) with `ctx`, `stem`, `chunk`, and `sz` as arguments and returns its result.
    - If `sig` is not `FD_SNAPSHOT_MSG_DATA`, calls [`handle_control_frag`](<#handle_control_frag>) with `ctx`, `stem`, and `sig` as arguments.
    - Returns 0 if the fragment is not a data fragment.
- **Output**: Returns an integer indicating whether the fragment is returnable, specifically the result of [`handle_data_frag`](<#handle_data_frag>) if the fragment is a data fragment, otherwise 0.
- **Functions Called**:
    - [`handle_data_frag`](<#handle_data_frag>)
    - [`handle_control_frag`](<#handle_control_frag>)


---
### populate\_allowed\_fds<!-- {{#callable:populate_allowed_fds}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapdc_tile.c#L245>)

Populates an array with file descriptors for standard error and a log file, if available.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, which is not used in this function.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure, which is not used in this function.
    - ``out_fds_cnt``: The maximum number of file descriptors that can be stored in the `out_fds` array.
    - ``out_fds``: An array of integers where the function will store the allowed file descriptors.
- **Logic and Control Flow**:
    - Check if `out_fds_cnt` is less than 2; if true, log an error and terminate the program.
    - Initialize `out_cnt` to 0.
    - Assign the file descriptor for standard error (2) to `out_fds[0]` and increment `out_cnt`.
    - Check if the log file descriptor is valid (not -1); if true, assign it to `out_fds[1]` and increment `out_cnt`.
- **Output**: Returns the number of file descriptors stored in the `out_fds` array.


---
### populate\_allowed\_seccomp<!-- {{#callable:populate_allowed_seccomp}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapdc_tile.c#L261>)

Configures seccomp filters for a tile by populating a `sock_filter` array and returns the instruction count.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, which is not used in this function.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure, which is not used in this function.
    - ``out_cnt``: An unsigned long integer representing the count of output filters.
    - ``out``: A pointer to an array of `sock_filter` structures where the seccomp filters will be populated.
- **Logic and Control Flow**:
    - Calls [`populate_sock_filter_policy_fd_snapdc_tile`](<generated/fd_snapdc_tile_seccomp.h.md#populate_sock_filter_policy_fd_snapdc_tile>) with `out_cnt`, `out`, and the file descriptor from `fd_log_private_logfile_fd()` to populate the seccomp filters.
    - Returns the value of `sock_filter_policy_fd_snapdc_tile_instr_cnt`, which represents the number of instructions in the seccomp filter.
- **Output**: Returns an unsigned long integer representing the number of instructions in the seccomp filter.
- **Functions Called**:
    - [`populate_sock_filter_policy_fd_snapdc_tile`](<generated/fd_snapdc_tile_seccomp.h.md#populate_sock_filter_policy_fd_snapdc_tile>)


---
### unprivileged\_init<!-- {{#callable:unprivileged_init}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapdc_tile.c#L270>)

Initializes the unprivileged context for a tile in a topology, setting up memory and decompression stream.
- **Inputs**:
    - `topo`: A pointer to the `fd_topo_t` structure representing the topology.
    - `tile`: A pointer to the `fd_topo_tile_t` structure representing the tile to initialize.
- **Logic and Control Flow**:
    - Allocate scratch memory using `fd_topo_obj_laddr` to get the local address of the tile object.
    - Initialize the scratch allocator with `FD_SCRATCH_ALLOC_INIT`.
    - Allocate memory for `fd_snapdc_tile_t` and a Zstandard decompression stream using `FD_SCRATCH_ALLOC_APPEND`.
    - Set the initial state of the context to `FD_SNAPSHOT_STATE_IDLE`.
    - Initialize the Zstandard decompression stream with `ZSTD_initStaticDStream` and verify its success with `FD_TEST`.
    - Set the initial fragment position to 0 and clear the metrics structure with `fd_memset`.
    - Check that the tile has exactly one input and one output, logging an error if not.
    - Retrieve and set up the output workspace, chunk, watermark, and MTU using the topology links and workspaces.
    - Retrieve and set up the input workspace, chunk, watermark, and MTU similarly.
    - Finalize the scratch allocation with `FD_SCRATCH_ALLOC_FINI` and check for overflow, logging an error if it occurs.
- **Output**: No return value; the function initializes the context and sets up memory and decompression stream for the tile.
- **Functions Called**:
    - [`scratch_footprint`](<#scratch_footprint>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)