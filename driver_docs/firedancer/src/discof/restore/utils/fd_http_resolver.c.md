<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements an HTTP resolver for managing peer connections and state transitions using socket operations and deadline lists.

# Purpose
The code is a C module that implements an HTTP resolver system for managing and resolving peer connections. It provides functionality to handle multiple peers, each represented by a `fd_ssresolve_peer_t` structure, which includes information about the peer's address, state, and associated socket connections. The module uses a pool and deadline lists to manage the lifecycle of peers, categorizing them into unresolved, resolving, valid, and invalid states. The resolver system is designed to handle asynchronous socket connections using non-blocking I/O and the `poll` system call to monitor multiple file descriptors for readiness to perform I/O operations.

The module defines several key functions, including [`fd_http_resolver_new`](<#fd_http_resolver_new>), which initializes a new resolver instance, and [`fd_http_resolver_add`](<#fd_http_resolver_add>), which adds a new peer to the resolver. The [`poll_advance`](<#poll_advance>) function is responsible for advancing the state of the resolver by checking the readiness of sockets and updating the state of peers based on the results of the `poll` call. The module also includes utility functions for aligning and calculating the memory footprint of the resolver structures. The resolver system is designed to be integrated into a larger application, providing a mechanism to resolve and maintain connections to multiple peers efficiently.
# Imports and Dependencies

---
- `fd_http_resolver.h`
- `fd_ssresolve.h`
- `../../../util/log/fd_log.h`
- `../../../util/fd_util.h`
- `poll.h`
- `errno.h`
- `unistd.h`
- `sys/socket.h`
- `netinet/in.h`
- `netinet/tcp.h`
- `../../../util/tmpl/fd_pool.c`
- `../../../util/tmpl/fd_dlist.c`


# Data Structures

---
### fd\_ssresolve\_peer
- **Type**: ``struct``
- **Members**:
    - ``addr``: Stores the IPv4 address and port of the peer.
    - ``ssinfo``: Holds session information for the peer.
    - ``full_ssresolve``: Pointer to a full session resolver.
    - ``inc_ssresolve``: Pointer to an incremental session resolver.
    - ``pool``: Contains the next index in the pool.
    - ``deadline``: Contains the next and previous indices for deadline management.
    - ``fd``: Contains the index of the file descriptor.
    - ``state``: Indicates the current state of the peer.
    - ``deadline_nanos``: Specifies the deadline in nanoseconds for the peer's state.
- **Description**: Manages peer information for session resolution, including address, session details, resolver pointers, pool management, deadline tracking, file descriptor index, state, and deadline timing.


---
### fd\_ssresolve\_peer\_t
- **Type**: ``struct``
- **Members**:
    - ``addr``: Stores the IP address and port of the peer.
    - ``ssinfo``: Holds snapshot information for the peer.
    - ``full_ssresolve``: Pointer to a full snapshot resolver for the peer.
    - ``inc_ssresolve``: Pointer to an incremental snapshot resolver for the peer.
    - ``pool``: Contains the next index in the pool.
    - ``deadline``: Holds the next and previous indices for deadline management.
    - ``fd``: Stores the index of the file descriptor.
    - ``state``: Indicates the current state of the peer.
    - ``deadline_nanos``: Specifies the deadline in nanoseconds for the peer's state.
- **Description**: `fd_ssresolve_peer_t` is a structure that represents a peer in a snapshot resolution system. It contains information about the peer's address, snapshot data, and state management. The structure includes pointers to full and incremental snapshot resolvers, as well as fields for managing deadlines and file descriptors. The state field indicates whether the peer is unresolved, refreshing, valid, or invalid, and the `deadline_nanos` field specifies timing constraints for these states.


---
### fd\_http\_resolver\_private
- **Type**: ``struct``
- **Members**:
    - ``pool``: Pointer to a pool of `fd_ssresolve_peer_t` structures.
    - ``unresolved``: Pointer to a list of peers that are unresolved.
    - ``resolving``: Pointer to a list of peers that are currently resolving.
    - ``valid``: Pointer to a list of peers that are valid.
    - ``invalid``: Pointer to a list of peers that are invalid.
    - ``fds_len``: Number of file descriptors in use.
    - ``fds``: Pointer to an array of `struct pollfd` for polling file descriptors.
    - ``fds_idx``: Pointer to an array of indices for file descriptors.
    - ``incremental_snapshot_fetch``: Flag indicating if incremental snapshot fetch is enabled.
    - ``cb_arg``: Pointer to user-defined callback argument.
    - ``on_resolve_cb``: Callback function to call when a peer is resolved.
    - ``magic``: Magic number to verify the integrity of the structure.
- **Description**: Manages the state and operations of HTTP peer resolution, including tracking peers in various states (unresolved, resolving, valid, invalid), handling file descriptors for network operations, and executing callbacks upon resolution. It uses a pool of `fd_ssresolve_peer_t` structures to manage peer information and deadlines for state transitions.


# Functions

---
### fd\_http\_resolver\_align<!-- {{#callable:fd_http_resolver_align}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_http_resolver.c#L79>)

Calculates the maximum alignment requirement for the `fd_http_resolver_t` structure and its associated components.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `fd_ulong_max` to determine the maximum alignment requirement among several components.
    - Checks the alignment of `fd_http_resolver_t`, `peer_pool`, `deadline_list`, `struct pollfd`, and `ulong`.
    - Returns the maximum alignment value found.
- **Output**: Returns an `ulong` representing the maximum alignment requirement.


---
### fd\_http\_resolver\_footprint<!-- {{#callable:fd_http_resolver_footprint}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_http_resolver.c#L84>)

Calculates the memory footprint required for an HTTP resolver based on the number of peers.
- **Inputs**:
    - `peers_cnt`: The number of peers for which the memory footprint is calculated.
- **Logic and Control Flow**:
    - Initialize the layout with `FD_LAYOUT_INIT`.
    - Append the size and alignment of `fd_http_resolver_t` to the layout.
    - Append the size and alignment of the peer pool, calculated using `peer_pool_align()` and `peer_pool_footprint(peers_cnt)`.
    - Append the size and alignment of four deadline lists, each calculated using `deadline_list_align()` and `deadline_list_footprint()`.
    - Append the size and alignment of an array of `struct pollfd` for twice the number of peers.
    - Append the size and alignment of an array of `ulong` for twice the number of peers.
    - Iterate over twice the number of peers and append the size and alignment of `fd_ssresolve_t` for each using `fd_ssresolve_align()` and `fd_ssresolve_footprint()`.
    - Finalize the layout with `FD_LAYOUT_FINI()` using the alignment of `fd_http_resolver_t`.
- **Output**: Returns the total memory footprint as an `ulong` value.
- **Functions Called**:
    - [`fd_ssresolve_align`](<fd_ssresolve.c.md#fd_ssresolve_align>)
    - [`fd_ssresolve_footprint`](<fd_ssresolve.c.md#fd_ssresolve_footprint>)
    - [`fd_http_resolver_align`](<#fd_http_resolver_align>)


---
### fd\_http\_resolver\_new<!-- {{#callable:fd_http_resolver_new}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_http_resolver.c#L103>)

Initializes a new HTTP resolver instance with specified parameters and memory allocations.
- **Inputs**:
    - ``shmem``: A pointer to shared memory where the resolver will be allocated.
    - ``peers_cnt``: The number of peers to manage, must be at least 1.
    - ``incremental_snapshot_fetch``: A flag indicating whether to use incremental snapshot fetching.
    - ``on_resolve_cb``: A callback function to be called upon resolution of a peer.
    - ``cb_arg``: An argument to pass to the callback function.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL or not aligned, and return NULL if so.
    - Check if `peers_cnt` is less than 1, and return NULL if so.
    - Initialize memory allocations for the resolver and its components using `FD_SCRATCH_ALLOC_APPEND`.
    - Join the newly created pools and lists to the resolver structure.
    - Initialize the `fds` and `fds_idx` arrays for managing file descriptors.
    - Iterate over the peer pool to allocate and join full and incremental snapshot resolvers for each peer.
    - Set the `incremental_snapshot_fetch`, `cb_arg`, and `on_resolve_cb` fields in the resolver.
    - Set the `magic` field to `FD_HTTP_RESOLVER_MAGIC` to indicate successful initialization.
    - Return a pointer to the initialized resolver.
- **Output**: A pointer to the newly created `fd_http_resolver_t` instance, or NULL if initialization fails.
- **Functions Called**:
    - [`fd_http_resolver_align`](<#fd_http_resolver_align>)
    - [`fd_ssresolve_align`](<fd_ssresolve.c.md#fd_ssresolve_align>)
    - [`fd_ssresolve_footprint`](<fd_ssresolve.c.md#fd_ssresolve_footprint>)
    - [`fd_ssresolve_join`](<fd_ssresolve.c.md#fd_ssresolve_join>)
    - [`fd_ssresolve_new`](<fd_ssresolve.c.md#fd_ssresolve_new>)


---
### fd\_http\_resolver\_join<!-- {{#callable:fd_http_resolver_join}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_http_resolver.c#L162>)

Validates and returns a pointer to a `fd_http_resolver_t` structure if the input pointer is valid and correctly aligned.
- **Inputs**:
    - `shresolver`: A pointer to a shared memory region that is expected to contain a `fd_http_resolver_t` structure.
- **Logic and Control Flow**:
    - Check if `shresolver` is NULL; if so, log a warning and return NULL.
    - Check if `shresolver` is aligned according to [`fd_http_resolver_align`](<#fd_http_resolver_align>); if not, log a warning and return NULL.
    - Cast `shresolver` to a `fd_http_resolver_t` pointer and store it in `resolver`.
    - Check if `resolver->magic` equals `FD_HTTP_RESOLVER_MAGIC`; if not, log a warning and return NULL.
    - Return the `resolver` pointer.
- **Output**: A pointer to a `fd_http_resolver_t` structure if all checks pass, otherwise NULL.
- **Functions Called**:
    - [`fd_http_resolver_align`](<#fd_http_resolver_align>)


---
### fd\_http\_resolver\_add<!-- {{#callable:fd_http_resolver_add}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_http_resolver.c#L184>)

Adds a new peer to the HTTP resolver's unresolved list and initializes its state and address.
- **Inputs**:
    - `resolver`: A pointer to an `fd_http_resolver_t` structure that manages the peer pool and lists.
    - `addr`: An `fd_ip4_port_t` structure representing the IP address and port of the peer to add.
- **Logic and Control Flow**:
    - Check if there is a free slot in the peer pool using `peer_pool_free`; if not, log an error and exit.
    - Acquire a new peer element from the pool using `peer_pool_ele_acquire`.
    - Set the peer's state to `PEER_STATE_UNRESOLVED`.
    - Assign the provided `addr` to the peer's `addr` field.
    - Initialize various fields of the peer (`fd.idx`, `ssinfo.full.slot`, `ssinfo.incremental.base_slot`, `ssinfo.incremental.slot`) to `ULONG_MAX`.
    - Add the peer to the tail of the `unresolved` list using `deadline_list_ele_push_tail`.
- **Output**: No return value; the function modifies the state of the `resolver` and its associated peer pool.


---
### create\_socket<!-- {{#callable:create_socket}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_http_resolver.c#L200>)

Creates a non-blocking TCP socket, configures it, and attempts to connect to a specified peer, adding the socket to the resolver's file descriptor list.
- **Inputs**:
    - `resolver`: A pointer to an `fd_http_resolver_t` structure that manages the socket connections and file descriptors.
    - `peer`: A pointer to an `fd_ssresolve_peer_t` structure that contains the address and port information for the peer to connect to.
- **Logic and Control Flow**:
    - Create a non-blocking TCP socket using the `socket` function with `AF_INET` and `SOCK_STREAM|SOCK_NONBLOCK` flags.
    - Check if the socket creation failed and log an error if it did.
    - Set the TCP_NODELAY option on the socket to disable Nagle's algorithm using `setsockopt`.
    - Check if setting the socket option failed and log an error if it did.
    - Initialize a `sockaddr_in` structure with the peer's address and port, converting the port to network byte order using `fd_ushort_bswap`.
    - Attempt to connect the socket to the peer's address using `connect`.
    - If the connection attempt fails and the error is not `EINPROGRESS`, close the socket, log an error, and return -1.
    - Add the socket to the resolver's file descriptor list with `POLLIN|POLLOUT` events and zeroed `revents`.
    - Return 0 to indicate success.
- **Output**: Returns 0 on success, or -1 if the socket connection fails.


---
### peer\_connect<!-- {{#callable:peer_connect}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_http_resolver.c#L231>)

Establishes a connection to a peer and initializes its resolution state.
- **Inputs**:
    - ``resolver``: A pointer to an `fd_http_resolver_t` structure that manages peer connections and resolutions.
    - ``peer``: A pointer to an `fd_ssresolve_peer_t` structure representing the peer to connect to.
- **Logic and Control Flow**:
    - Call [`create_socket`](<#create_socket>) to establish a socket connection for the full snapshot; if it fails, return the error code.
    - Store the peer's index in the resolver's `fds_idx` array and update the peer's file descriptor index.
    - Increment the resolver's `fds_len` to account for the new connection.
    - Initialize the peer's full snapshot resolution using [`fd_ssresolve_init`](<fd_ssresolve.c.md#fd_ssresolve_init>).
    - If `incremental_snapshot_fetch` is enabled, repeat the socket creation and initialization process for the incremental snapshot.
    - If `incremental_snapshot_fetch` is not enabled, set up a placeholder in the `fds` array with a file descriptor of `-1` and update `fds_idx` with `ULONG_MAX`.
    - Return `0` to indicate success.
- **Output**: Returns `0` on success or an error code if socket creation fails.
- **Functions Called**:
    - [`create_socket`](<#create_socket>)
    - [`fd_ssresolve_init`](<fd_ssresolve.c.md#fd_ssresolve_init>)


---
### remove\_peer<!-- {{#callable:remove_peer}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_http_resolver.c#L261>)

Removes a peer from the resolver's file descriptor list and updates the list accordingly.
- **Inputs**:
    - `resolver`: A pointer to the `fd_http_resolver_t` structure that contains the peer information and file descriptor list.
    - `idx`: The index of the peer in the file descriptor list to be removed.
- **Logic and Control Flow**:
    - Check if `idx` is less than `resolver->fds_len` using `FD_TEST` macro.
    - Close the file descriptors at `idx` and `idx+1` in the `resolver->fds` array.
    - If `resolver->fds_len` is 2, set `resolver->fds_len` to 0 and return.
    - Replace the file descriptors and indices at `idx` and `idx+1` with the last two entries in the list.
    - Update the peer's `fd.idx` to the new index `idx`.
    - Decrease `resolver->fds_len` by 2.
- **Output**: No return value; the function modifies the `resolver` structure in place.


---
### unresolve\_peer<!-- {{#callable:unresolve_peer}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_http_resolver.c#L287>)

Transitions a peer from an unresolved or refreshing state to an invalid state and updates its deadline.
- **Inputs**:
    - ``resolver``: A pointer to the `fd_http_resolver_t` structure that manages the peer resolution process.
    - ``peer``: A pointer to the `fd_ssresolve_peer_t` structure representing the peer to unresolve.
    - ``now``: A long integer representing the current time in nanoseconds.
- **Logic and Control Flow**:
    - Checks if the peer's state is either `PEER_STATE_UNRESOLVED` or `PEER_STATE_REFRESHING` using `FD_TEST` macro.
    - Calls [`remove_peer`](<#remove_peer>) to remove the peer from the resolver's file descriptor list.
    - Removes the peer from the `resolving` deadline list using `deadline_list_ele_remove`.
    - Sets the peer's state to `PEER_STATE_INVALID`.
    - Updates the peer's `deadline_nanos` to `now + PEER_DEADLINE_NANOS_INVALID`.
    - Adds the peer to the `invalid` deadline list using `deadline_list_ele_push_tail`.
- **Output**: No return value; the function modifies the state and deadline of the `peer` and updates the resolver's lists.
- **Functions Called**:
    - [`remove_peer`](<#remove_peer>)


---
### poll\_resolve<!-- {{#callable:poll_resolve}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_http_resolver.c#L299>)

Handles the resolution of a peer's address by processing poll events and updating the peer's state based on the results of the resolution.
- **Inputs**:
    - `resolver`: A pointer to an `fd_http_resolver_t` structure that manages the state and resources for resolving peers.
    - `pfd`: A pointer to a `struct pollfd` that contains the file descriptor and event flags for polling.
    - `peer`: A pointer to an `fd_ssresolve_peer_t` structure representing the peer being resolved.
    - `ssresolve`: A pointer to an `fd_ssresolve_t` structure used for the resolution process.
    - `idx`: An unsigned long integer representing the index of the peer in the resolver's file descriptor array.
    - `now`: A long integer representing the current time in nanoseconds.
- **Logic and Control Flow**:
    - Check if the `POLLOUT` event is set in `pfd->revents` and call [`fd_ssresolve_advance_poll_out`](<fd_ssresolve.c.md#fd_ssresolve_advance_poll_out>) to advance the resolution process for outgoing data.
    - If [`fd_ssresolve_advance_poll_out`](<fd_ssresolve.c.md#fd_ssresolve_advance_poll_out>) returns `FD_SSRESOLVE_ADVANCE_ERROR`, call [`unresolve_peer`](<#unresolve_peer>) to mark the peer as unresolved and return -1.
    - Check if the `POLLIN` event is set in `pfd->revents` and call [`fd_ssresolve_advance_poll_in`](<fd_ssresolve.c.md#fd_ssresolve_advance_poll_in>) to advance the resolution process for incoming data.
    - If [`fd_ssresolve_advance_poll_in`](<fd_ssresolve.c.md#fd_ssresolve_advance_poll_in>) returns `FD_SSRESOLVE_ADVANCE_ERROR`, call [`unresolve_peer`](<#unresolve_peer>) to mark the peer as unresolved and return -1.
    - If [`fd_ssresolve_advance_poll_in`](<fd_ssresolve.c.md#fd_ssresolve_advance_poll_in>) returns `FD_SSRESOLVE_ADVANCE_AGAIN`, return -1 to indicate the resolution should be retried.
    - If [`fd_ssresolve_advance_poll_in`](<fd_ssresolve.c.md#fd_ssresolve_advance_poll_in>) returns `FD_SSRESOLVE_ADVANCE_SUCCESS`, update the peer's `ssinfo` with the resolved slot information.
    - Return 0 to indicate successful resolution.
- **Output**: Returns 0 on successful resolution or -1 if an error occurs during the resolution process.
- **Functions Called**:
    - [`fd_ssresolve_advance_poll_out`](<fd_ssresolve.c.md#fd_ssresolve_advance_poll_out>)
    - [`unresolve_peer`](<#unresolve_peer>)
    - [`fd_ssresolve_advance_poll_in`](<fd_ssresolve.c.md#fd_ssresolve_advance_poll_in>)


---
### poll\_advance<!-- {{#callable:poll_advance}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_http_resolver.c#L339>)

Processes file descriptors in a resolver to handle network events and update peer states.
- **Inputs**:
    - ``resolver``: A pointer to an `fd_http_resolver_t` structure that contains the state and configuration for the HTTP resolver.
    - ``now``: A long integer representing the current time in nanoseconds.
- **Logic and Control Flow**:
    - Check if `resolver->fds_len` is zero; if so, return immediately.
    - Call `fd_syscall_poll` to poll the file descriptors in `resolver->fds` with a timeout of zero.
    - If no file descriptors are ready (`nfds` is zero), return.
    - If `fd_syscall_poll` returns -1 and `errno` is `EINTR`, return.
    - If `fd_syscall_poll` returns -1 for any other reason, log an error and exit.
    - Iterate over each file descriptor in `resolver->fds`.
    - For each file descriptor, check if it is invalid (`fd == -1`) or has error events (`POLLERR` or `POLLHUP`); if so, call [`unresolve_peer`](<#unresolve_peer>) and continue to the next file descriptor.
    - Determine if the current index is for a full or incremental snapshot and get the corresponding `fd_ssresolve_t` object.
    - If the snapshot is not done, call [`poll_resolve`](<#poll_resolve>) to process the file descriptor; if [`poll_resolve`](<#poll_resolve>) returns non-zero, continue to the next file descriptor.
    - If both full and incremental snapshots are done, update the peer state to `PEER_STATE_VALID`, set the deadline, remove the peer from the resolving list, add it to the valid list, remove the peer from the file descriptor list, and call the resolve callback.
- **Output**: No return value; the function updates the state of peers and the resolver based on network events.
- **Functions Called**:
    - [`unresolve_peer`](<#unresolve_peer>)
    - [`fd_ssresolve_is_done`](<fd_ssresolve.c.md#fd_ssresolve_is_done>)
    - [`poll_resolve`](<#poll_resolve>)
    - [`remove_peer`](<#remove_peer>)


---
### fd\_http\_resolver\_advance<!-- {{#callable:fd_http_resolver_advance}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_http_resolver.c#L384>)

Manages the state transitions of peers in an HTTP resolver by processing unresolved, resolving, invalid, and valid peers based on deadlines and connection results.
- **Inputs**:
    - ``resolver``: A pointer to an `fd_http_resolver_t` structure that manages the state of peers.
    - ``now``: A long integer representing the current time in nanoseconds.
    - ``selector``: A pointer to an `fd_sspeer_selector_t` structure used to manage peer selection.
- **Logic and Control Flow**:
    - Iterates over the `unresolved` list, attempts to connect each peer, and moves them to the `resolving` or `invalid` list based on the connection result.
    - Processes the `resolving` list, checking deadlines, and moves peers to the `invalid` list if they exceed their deadline, removing them from the selector.
    - Iterates over the `invalid` list, checking deadlines, and moves peers back to the `unresolved` list if they exceed their deadline.
    - Processes the `valid` list, checking deadlines, and attempts to reconnect peers, moving them to the `resolving` or `invalid` list based on the connection result.
    - Calls [`poll_advance`](<#poll_advance>) to handle polling of file descriptors and further resolve peers.
- **Output**: No direct output; modifies the state of peers within the `resolver` and updates the `selector` as necessary.
- **Functions Called**:
    - [`peer_connect`](<#peer_connect>)
    - [`remove_peer`](<#remove_peer>)
    - [`fd_sspeer_selector_remove`](<fd_sspeer_selector.c.md#fd_sspeer_selector_remove>)
    - [`poll_advance`](<#poll_advance>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)