<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Header file for a snapshot pinger that manages and selects peers based on ICMP ping latency.

# Purpose
The code defines a C header file for a module that manages a snapshot pinger, referred to as `ssping`. The primary function of `ssping` is to maintain a list of peers that are reachable for snapshot downloads and to determine the "best" peer based on the lowest latency in response to ICMP ping requests. The module assumes a maximum number of peers, which aligns with expectations from a gossip system, and allows for dynamic addition and removal of peers within this limit.

Key components of the module include the definition of the `fd_ssping_t` structure and several functions for managing the lifecycle and operations of the snapshot pinger. Functions such as [`fd_ssping_new`](<#fd_ssping_new>), [`fd_ssping_add`](<#fd_ssping_add>), and [`fd_ssping_remove`](<#fd_ssping_remove>) are provided to create a new pinger instance, add peers to be tracked, and remove peers, respectively. The module also includes functionality to invalidate peers temporarily and to advance the ping tracker to maintain the state of pings. The [`fd_ssping_get_sockfd`](<#fd_ssping_get_sockfd>) function returns the file descriptor for the ping socket, facilitating network operations. The module defines a callback type, `fd_ssping_on_ping_fn_t`, for handling ping responses, allowing for custom actions based on ping results.
# Imports and Dependencies

---
- `../../../util/fd_util_base.h`
- `../../../util/net/fd_net_headers.h`


# Data Structures

---
### fd\_sspeer\_selector\_t
- **Type**: ``struct``
- **Members**:
    - ``fd_sspeer_selector_private``: An opaque structure used to define `fd_sspeer_selector_t`.
- **Description**: `fd_sspeer_selector_t` is a typedef for an opaque structure `fd_sspeer_selector_private`, which is used in the context of a snapshot pinger system to manage peer selection based on criteria such as latency. The structure is part of a system that maintains a list of peers for snapshot downloads and selects the best peer based on certain metrics. The details of the structure's implementation are hidden, as indicated by the use of a private struct.


---
### fd\_ssping\_t
- **Type**: ``struct``
- **Members**:
    - ``fd_ssping_private``: Defines the private structure for the `fd_ssping_t` type.
- **Description**: The `fd_ssping_t` data structure is a typedef for a private structure used in the snapshot pinger system. It is responsible for maintaining a list of peers that are reachable for snapshot download and selecting the best peer based on criteria such as latency. The structure supports operations to add, remove, and invalidate peers, as well as to advance the ping tracker and retrieve the ping socket file descriptor.


# Function Declarations (Public API)

---
### fd\_ssping\_align<!-- {{#callable_declaration:fd_ssping_align}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssping.h#L34>)

Returns the alignment requirement for the snapshot pinger.
- **Description**: Use this function to obtain the alignment requirement for memory allocations related to the snapshot pinger. This is necessary to ensure that memory is correctly aligned for the data structures used by the snapshot pinger. Call this function before allocating memory for the snapshot pinger to determine the correct alignment boundary.
- **Inputs**: None
- **Output**: The function returns an unsigned long integer representing the alignment requirement in bytes.
- **See Also**: [`fd_ssping_align`](<fd_ssping.c.md#fd_ssping_align>)  (Implementation)


---
### fd\_ssping\_footprint<!-- {{#callable_declaration:fd_ssping_footprint}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssping.h#L39>)

Calculate the memory footprint required for a snapshot pinger with a given number of peers.
- **Description**: Use this function to determine the memory size needed to initialize a snapshot pinger that can handle a specified maximum number of peers. This is useful for allocating sufficient memory resources before creating a new snapshot pinger instance. Ensure that the `max_peers` parameter accurately reflects the maximum number of peers you expect to manage, as this directly influences the calculated footprint.
- **Inputs**:
    - `max_peers`: Specifies the maximum number of peers the snapshot pinger will manage. Must be a non-negative integer. If the value is invalid, the function behavior is undefined.
- **Output**: Returns the size in bytes of the memory footprint required for the snapshot pinger.
- **See Also**: [`fd_ssping_footprint`](<fd_ssping.c.md#fd_ssping_footprint>)  (Implementation)


---
### fd\_ssping\_new<!-- {{#callable_declaration:fd_ssping_new}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssping.h#L42>)

Creates a new snapshot pinger instance.
- **Description**: Use this function to create a new snapshot pinger instance that maintains a list of peers for snapshot download. It selects the best peer based on the lowest latency in response to an ICMP ping request. Ensure that the shared memory pointer is non-null and properly aligned, and that the maximum number of peers is at least one. This function initializes the pinger with a specified random seed and sets a callback function to handle ping responses. It returns a pointer to the newly created pinger instance or NULL if any preconditions are not met.
- **Inputs**:
    - `shmem`: Pointer to shared memory for the pinger instance. Must not be null and must be aligned according to `fd_ssping_align()`.
    - `max_peers`: Maximum number of peers to track. Must be at least 1.
    - `seed`: Random seed for initializing internal data structures. Can be any unsigned long value.
    - `on_ping_cb`: Callback function to handle ping responses. Must be a valid function pointer.
    - `cb_arg`: User-defined argument passed to the callback function. Can be any pointer value.
- **Output**: Returns a pointer to the newly created pinger instance, or NULL if initialization fails due to invalid input parameters.
- **See Also**: [`fd_ssping_new`](<fd_ssping.c.md#fd_ssping_new>)  (Implementation)


---
### fd\_ssping\_join<!-- {{#callable_declaration:fd_ssping_join}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssping.h#L49>)

Joins a snapshot pinger instance from shared memory.
- **Description**: Use this function to obtain a handle to a snapshot pinger instance from a shared memory region. The shared memory pointer must be aligned according to the alignment requirements of the snapshot pinger and must point to a valid snapshot pinger instance. This function checks the alignment and validity of the provided memory and returns a pointer to the snapshot pinger if successful. If the memory is null, misaligned, or does not contain a valid snapshot pinger, the function returns null.
- **Inputs**:
    - `shping`: A pointer to the shared memory region containing the snapshot pinger. Must not be null and must be aligned according to `fd_ssping_align()`. The memory must contain a valid snapshot pinger instance.
- **Output**: Returns a pointer to the snapshot pinger instance if successful, or null if the input is invalid.
- **See Also**: [`fd_ssping_join`](<fd_ssping.c.md#fd_ssping_join>)  (Implementation)


---
### fd\_ssping\_add<!-- {{#callable_declaration:fd_ssping_add}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssping.h#L63>)

Add a peer to the snapshot pinger for tracking.
- **Description**: Use this function to add a peer to the snapshot pinger, which will continuously ping the peer to monitor its status. The function allows adding the same address multiple times, with internal reference counting to manage removals. If the maximum number of peers is reached, adding a new peer will have no effect. This function is useful for maintaining an up-to-date list of reachable peers for snapshot downloads.
- **Inputs**:
    - `ssping`: A pointer to an `fd_ssping_t` structure representing the snapshot pinger. Must not be null.
    - `addr`: An `fd_ip4_port_t` representing the address of the peer to add. The address can be added multiple times and is reference counted internally.
- **Output**: None
- **See Also**: [`fd_ssping_add`](<fd_ssping.c.md#fd_ssping_add>)  (Implementation)


---
### fd\_ssping\_remove<!-- {{#callable_declaration:fd_ssping_remove}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssping.h#L72>)

Removes a peer from tracking by the snapshot pinger.
- **Description**: Use this function to remove a peer from the snapshot pinger's tracking list. The function decreases the reference count for the specified peer and removes it only if the count reaches zero. If the peer is not currently tracked, the function does nothing. This function is useful for managing the list of peers that are actively monitored for snapshot downloads.
- **Inputs**:
    - `ssping`: A pointer to an `fd_ssping_t` structure representing the snapshot pinger instance. Must not be null.
    - `addr`: The `fd_ip4_port_t` address of the peer to remove. The address must correspond to a peer currently tracked by the snapshot pinger.
- **Output**: Returns 1 if the peer was successfully removed, or 0 if the peer is still being tracked due to a non-zero reference count.
- **See Also**: [`fd_ssping_remove`](<fd_ssping.c.md#fd_ssping_remove>)  (Implementation)


---
### fd\_ssping\_invalidate<!-- {{#callable_declaration:fd_ssping_invalidate}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssping.h#L79>)

Marks a peer as invalid for selection.
- **Description**: Use this function to mark a peer as invalid when it is not suitable for selection, such as when it refuses a connection or provides a bad snapshot. This function updates the peer's state to invalid and sets a deadline for when it can be reconsidered for selection. It must be called with a valid `fd_ssping_t` instance and a valid `fd_ip4_port_t` address. The function does nothing if the peer is already in an invalid state or if the peer is not found.
- **Inputs**:
    - `ssping`: A pointer to an `fd_ssping_t` instance. Must not be null. Represents the snapshot pinger managing the peer.
    - `addr`: An `fd_ip4_port_t` representing the address of the peer to invalidate. Must be a valid address of a tracked peer.
    - `now`: A `long` representing the current time in nanoseconds. Used to set the invalidation deadline for the peer.
- **Output**: None
- **See Also**: [`fd_ssping_invalidate`](<fd_ssping.c.md#fd_ssping_invalidate>)  (Implementation)


---
### fd\_ssping\_advance<!-- {{#callable_declaration:fd_ssping_advance}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssping.h#L89>)

Advances the ping tracker to the specified time.
- **Description**: Use this function to update the state of the ping tracker to the current time, specified by `now`. It should be called periodically to refresh ping states and manage networking tasks. This function also interacts with the peer selector to invalidate peers as necessary. Ensure that the `ssping` and `selector` are properly initialized before calling this function.
- **Inputs**:
    - `ssping`: A pointer to an `fd_ssping_t` structure representing the snapshot pinger. Must not be null and should be properly initialized.
    - `now`: A `long` integer representing the current time in nanoseconds. This value is used to update the ping tracker.
    - `selector`: A pointer to an `fd_sspeer_selector_t` structure used to manage peer selection. Must not be null and should be properly initialized.
- **Output**: None
- **See Also**: [`fd_ssping_advance`](<fd_ssping.c.md#fd_ssping_advance>)  (Implementation)


---
### fd\_ssping\_get\_sockfd<!-- {{#callable_declaration:fd_ssping_get_sockfd}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssping.h#L96>)

Return the ping socket file descriptor.
- **Description**: Use this function to obtain the file descriptor for the socket used by the snapshot pinger. This is necessary when you need to perform operations directly on the socket, such as monitoring or configuring it. Ensure that the `ssping` object is valid and properly initialized before calling this function.
- **Inputs**:
    - `ssping`: A pointer to a constant `fd_ssping_t` structure. It must not be null and should point to a valid snapshot pinger instance. The function does not modify the object.
- **Output**: Returns the socket file descriptor as an integer. The value is valid if the `ssping` object is correctly initialized.
- **See Also**: [`fd_ssping_get_sockfd`](<fd_ssping.c.md#fd_ssping_get_sockfd>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)