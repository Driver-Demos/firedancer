<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a system for managing and sending ICMP pings to peers, tracking their states and latencies.

# Purpose
The code is a C module that implements a system for managing and monitoring the state of network peers using ICMP echo requests, commonly known as "ping". It defines a structure `fd_ssping_peer` to represent each peer, which includes fields for reference count, address, state, latency, and deadline. The module uses several data structures, such as pools, maps, and deadline lists, to manage the lifecycle and state transitions of peers. These states include unpinged, pinged, valid, refreshing, and invalid, each with associated deadlines for state transitions.

The module provides functions to initialize and manage the pinging process, including [`fd_ssping_new`](<#fd_ssping_new>) for creating a new pinging instance, [`fd_ssping_add`](<#fd_ssping_add>) and [`fd_ssping_remove`](<#fd_ssping_remove>) for managing peers, and [`fd_ssping_advance`](<#fd_ssping_advance>) for progressing the state of peers based on time and received ping responses. It uses Linux's ICMP datagram sockets to send and receive ICMP echo packets without requiring raw socket privileges. The code also includes mechanisms to handle ping bursts and track the latency of responses. The module is designed to be integrated into a larger system, as indicated by its use of external utilities and templates for data structure management.
# Imports and Dependencies

---
- `fd_ssping.h`
- `fd_sspeer_selector.h`
- `../../../util/fd_util.h`
- `../../../util/bits/fd_bits.h`
- `../../../util/log/fd_log.h`
- `errno.h`
- `unistd.h`
- `sys/socket.h`
- `netinet/in.h`
- `netinet/ip_icmp.h`
- `../../../util/tmpl/fd_pool.c`
- `../../../util/tmpl/fd_map_chain.c`
- `../../../util/tmpl/fd_dlist.c`


# Data Structures

---
### fd\_ssping\_peer
- **Type**: ``struct``
- **Members**:
    - ``refcnt``: Reference count for the peer.
    - ``addr``: IP address and port of the peer.
    - ``pool.next``: Next index in the pool list.
    - ``map.next``: Next index in the map list.
    - ``map.prev``: Previous index in the map list.
    - ``deadline.next``: Next index in the deadline list.
    - ``deadline.prev``: Previous index in the deadline list.
    - ``state``: Current state of the peer.
    - ``latency_nanos``: Latency in nanoseconds for the peer.
    - ``deadline_nanos``: Deadline in nanoseconds for the peer.
- **Description**: Manages peer information for ICMP ping operations, including reference counting, address storage, and linked list management for pool, map, and deadline tracking. It also tracks the state, latency, and deadline of each peer.


---
### fd\_ssping\_peer\_t
- **Type**: ``struct``
- **Members**:
    - ``refcnt``: Reference count for the peer.
    - ``addr``: IP address and port of the peer.
    - ``pool.next``: Next index in the pool.
    - ``map.next``: Next index in the map.
    - ``map.prev``: Previous index in the map.
    - ``deadline.next``: Next index in the deadline list.
    - ``deadline.prev``: Previous index in the deadline list.
    - ``state``: Current state of the peer.
    - ``latency_nanos``: Latency in nanoseconds for the peer.
    - ``deadline_nanos``: Deadline in nanoseconds for the peer.
- **Description**: Represents a peer in the SSPing system, storing information such as reference count, address, state, latency, and deadline. It includes fields for managing the peer in various data structures like pools, maps, and deadline lists.


---
### fd\_ssping\_private
- **Type**: ``struct``
- **Members**:
    - `pool`: Pointer to a pool of `fd_ssping_peer_t` structures.
    - `map`: Pointer to a map of peers.
    - `unpinged`: Pointer to a list of peers that have not been pinged.
    - `pinged`: Pointer to a list of peers that have been pinged.
    - `valid`: Pointer to a list of peers that are valid.
    - `refreshing`: Pointer to a list of peers that are refreshing.
    - `invalid`: Pointer to a list of peers that are invalid.
    - `sockfd`: Socket file descriptor for ICMP communication.
    - `on_ping_cb`: Callback function for handling ping responses.
    - `cb_arg`: Argument for the callback function.
    - `magic`: Magic number for structure validation.
- **Description**: Manages the state and operations of ICMP pinging for a set of peers, including tracking their status in various lists (unpinged, pinged, valid, refreshing, invalid) and handling socket communication for sending and receiving ICMP echo requests and replies.


---
### ssping\_pkt
- **Type**: ``struct``
- **Members**:
    - ``icmp``: Contains the ICMP header for the packet.
    - ``port``: Stores the UDP port number associated with the peer.
- **Description**: Encapsulates an ICMP echo request packet with an additional UDP port number to identify the peer. This structure is used to send and receive ICMP echo requests and replies, where the `icmp` field holds the ICMP header and the `port` field is used to track the UDP port number for peer identification.


# Functions

---
### fd\_ssping\_align<!-- {{#callable:fd_ssping_align}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssping.c#L114>)

Calculates the maximum alignment requirement among several components related to `fd_ssping_t`.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `fd_ulong_max` to determine the maximum alignment requirement among `alignof(fd_ssping_t)`, `peer_pool_align()`, `peer_map_align()`, and `deadline_list_align()`.
    - Returns the maximum alignment value obtained from the above calculations.
- **Output**: Returns an `ulong` representing the maximum alignment requirement.


---
### fd\_ssping\_footprint<!-- {{#callable:fd_ssping_footprint}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssping.c#L122>)

Calculates the memory footprint required for an `fd_ssping_t` structure and its associated components based on the maximum number of peers.
- **Inputs**:
    - `max_peers`: The maximum number of peers to consider when calculating the memory footprint.
- **Logic and Control Flow**:
    - Initialize the layout with `FD_LAYOUT_INIT`.
    - Append the size and alignment of `fd_ssping_t` to the layout using `FD_LAYOUT_APPEND`.
    - Append the size and alignment of the peer pool, calculated with `peer_pool_footprint`, to the layout.
    - Append the size and alignment of the peer map, calculated with `peer_map_footprint` and `peer_map_chain_cnt_est`, to the layout.
    - Append the size and alignment of five deadline lists, each calculated with `deadline_list_footprint`, to the layout.
    - Finalize the layout with `FD_LAYOUT_FINI` and return the total footprint.
- **Output**: Returns the total memory footprint as an `ulong` value.
- **Functions Called**:
    - [`fd_ssping_align`](<#fd_ssping_align>)


---
### fd\_ssping\_new<!-- {{#callable:fd_ssping_new}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssping.c#L137>)

Initializes a new `fd_ssping_t` structure for managing ICMP ping operations using shared memory.
- **Inputs**:
    - `shmem`: Pointer to shared memory where the `fd_ssping_t` structure will be allocated.
    - `max_peers`: Maximum number of peers that can be managed by the `fd_ssping_t` structure.
    - `seed`: Seed value for initializing the peer map.
    - `on_ping_cb`: Callback function to be called when a ping response is received.
    - `cb_arg`: Argument to be passed to the callback function.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL and log a warning if true, then return NULL.
    - Check if `shmem` is aligned according to `fd_ssping_align()` and log a warning if not, then return NULL.
    - Check if `max_peers` is less than 1 and log a warning if true, then return NULL.
    - Initialize scratch memory allocation with `shmem`.
    - Allocate and initialize various components of `fd_ssping_t` including peer pool, peer map, and deadline lists.
    - Create a non-blocking ICMP socket for sending and receiving ping packets.
    - Assign the callback function and its argument to the `fd_ssping_t` structure.
    - Set the `magic` field of `fd_ssping_t` to `FD_SSPING_MAGIC` to indicate successful initialization.
    - Return a pointer to the initialized `fd_ssping_t` structure.
- **Output**: Returns a pointer to the newly created `fd_ssping_t` structure, or NULL if initialization fails.
- **Functions Called**:
    - [`fd_ssping_align`](<#fd_ssping_align>)


---
### fd\_ssping\_join<!-- {{#callable:fd_ssping_join}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssping.c#L194>)

Validates and returns a pointer to a `fd_ssping_t` structure if the input is correctly aligned and initialized.
- **Inputs**:
    - `shping`: A pointer to a shared memory region that is expected to contain a `fd_ssping_t` structure.
- **Logic and Control Flow**:
    - Check if `shping` is NULL; if true, log a warning and return NULL.
    - Check if `shping` is aligned according to `fd_ssping_align()`; if not, log a warning and return NULL.
    - Cast `shping` to a `fd_ssping_t` pointer and store it in `ssping`.
    - Check if the `magic` field of `ssping` equals `FD_SSPING_MAGIC`; if not, log a warning and return NULL.
    - Return the `ssping` pointer.
- **Output**: A pointer to a `fd_ssping_t` structure if all checks pass, otherwise NULL.
- **Functions Called**:
    - [`fd_ssping_align`](<#fd_ssping_align>)


---
### fd\_ssping\_get\_sockfd<!-- {{#callable:fd_ssping_get_sockfd}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssping.c#L216>)

Retrieves the socket file descriptor from the `fd_ssping_t` structure.
- **Inputs**:
    - `ssping`: A pointer to a constant `fd_ssping_t` structure from which to retrieve the socket file descriptor.
- **Logic and Control Flow**:
    - Accesses the `sockfd` member of the `ssping` structure.
    - Returns the value of `ssping->sockfd`.
- **Output**: The function returns an integer representing the socket file descriptor.


---
### fd\_ssping\_add<!-- {{#callable:fd_ssping_add}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssping.c#L221>)

Adds a peer to the `fd_ssping_t` structure, initializing it if it does not already exist.
- **Inputs**:
    - ``ssping``: A pointer to an `fd_ssping_t` structure, which manages the state of peers for ping operations.
    - ``addr``: An `fd_ip4_port_t` structure representing the IP address and port of the peer to add.
- **Logic and Control Flow**:
    - Query the peer map in `ssping` for a peer with the given `addr`.
    - If the peer does not exist, check if there is space in the peer pool.
    - If there is space, acquire a new peer from the pool and initialize its fields.
    - Set the peer's state to `PEER_STATE_UNPINGED` and its latency to `ULONG_MAX`.
    - Insert the new peer into the peer map and add it to the unpinged deadline list.
    - Increment the reference count of the peer.
- **Output**: No return value; the function modifies the `ssping` structure in place.


---
### fd\_ssping\_remove<!-- {{#callable:fd_ssping_remove}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssping.c#L240>)

Removes a peer from the `fd_ssping_t` structure if its reference count reaches zero.
- **Inputs**:
    - `ssping`: A pointer to the `fd_ssping_t` structure that manages the peer.
    - `addr`: The `fd_ip4_port_t` address of the peer to remove.
- **Logic and Control Flow**:
    - Query the peer map for the peer associated with `addr` using `peer_map_ele_query`.
    - Check that the peer exists and its reference count is non-zero using `FD_TEST`.
    - Decrement the peer's reference count.
    - If the reference count is zero, remove the peer from the appropriate deadline list based on its state using `deadline_list_ele_remove`.
    - Remove the peer from the peer map using `peer_map_ele_remove_fast`.
    - Release the peer back to the pool using `peer_pool_ele_release`.
    - Return 1 if the peer was removed, otherwise return 0.
- **Output**: Returns 1 if the peer is removed, otherwise returns 0.


---
### fd\_ssping\_invalidate<!-- {{#callable:fd_ssping_invalidate}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssping.c#L272>)

Invalidates a peer in the `fd_ssping_t` structure by changing its state to `PEER_STATE_INVALID` and updating its deadline.
- **Inputs**:
    - ``ssping``: A pointer to the `fd_ssping_t` structure that manages the peer.
    - ``addr``: The `fd_ip4_port_t` address of the peer to invalidate.
    - ``now``: The current time in nanoseconds, used to set the new deadline for the peer.
- **Logic and Control Flow**:
    - Query the peer from the `ssping->map` using the `addr`.
    - If the peer is not found, return immediately.
    - Check the current state of the peer and remove it from the corresponding deadline list (`unpinged`, `pinged`, `valid`, or `refreshing`).
    - If the peer is already in the `PEER_STATE_INVALID` state, return immediately.
    - Set the peer's state to `PEER_STATE_INVALID`.
    - Update the peer's `deadline_nanos` to `now + PEER_DEADLINE_NANOS_INVALID`.
    - Add the peer to the `invalid` deadline list.
- **Output**: No output is returned; the function modifies the state of the peer within the `fd_ssping_t` structure.


---
### recv\_pings<!-- {{#callable:recv_pings}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssping.c#L299>)

Processes incoming ICMP echo replies and updates peer states accordingly.
- **Inputs**:
    - `ssping`: A pointer to an `fd_ssping_t` structure that contains the state and configuration for the ping operation.
    - `now`: A long integer representing the current time in nanoseconds.
- **Logic and Control Flow**:
    - Iterates up to `PING_BURST_MAX` times to process incoming packets.
    - Receives a packet using `recvfrom` and checks if it is a valid ICMP echo reply.
    - If the packet is valid, constructs a key from the source address and port to query the peer map.
    - If the peer is found and in a valid state, removes it from its current deadline list.
    - Calculates the latency and updates the peer's state to `PEER_STATE_VALID`.
    - Pushes the peer to the valid deadline list and logs the ping information.
    - Calls the `on_ping_cb` callback with the peer's address and latency.
- **Output**: No return value; the function updates the state of peers and logs information.


---
### send\_pings<!-- {{#callable:send_pings}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssping.c#L329>)

Sends ICMP echo requests to peers in a deadline list until a specified time or a maximum burst limit is reached.
- **Inputs**:
    - ``ssping``: A pointer to an `fd_ssping_t` structure that contains the state and configuration for sending pings.
    - ``list``: A pointer to a `deadline_list_t` structure that contains peers to which pings will be sent.
    - ``until``: A `long` integer representing the time limit until which pings can be sent.
- **Logic and Control Flow**:
    - Initialize `msg_cnt` to 0 and declare arrays for packets, I/O vectors, addresses, and message headers, each with a size of `PING_BURST_MAX`.
    - Iterate over the `list` using a forward iterator, stopping if `msg_cnt` reaches `PING_BURST_MAX` or the iterator is done.
    - For each peer in the list, check if the peer's `deadline_nanos` is greater than `until`; if so, break the loop.
    - Prepare an ICMP echo packet for each peer, set up the corresponding I/O vector, address, and message header, and increment `msg_cnt`.
    - If `msg_cnt` is zero, return 0 immediately.
    - Call `sendmmsg` to send the prepared messages; if it fails with errors other than `EAGAIN` or `EINTR`, log a warning and return 0.
    - Ensure the result from `sendmmsg` is within the expected range and return the result as an unsigned integer.
- **Output**: Returns the number of messages successfully sent as an unsigned integer.


---
### fd\_ssping\_advance<!-- {{#callable:fd_ssping_advance}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssping.c#L376>)

Manages the state transitions of peers in a pinging system based on deadlines and received pings.
- **Inputs**:
    - ``ssping``: A pointer to an `fd_ssping_t` structure representing the pinging system state.
    - ``now``: A long integer representing the current time in nanoseconds.
    - ``selector``: A pointer to an `fd_sspeer_selector_t` structure used to manage peer selection.
- **Logic and Control Flow**:
    - Send pings to peers in the `unpinged` list and update their state to `PEER_STATE_PINGED` with a new deadline.
    - Move peers from the `pinged` list to the `invalid` list if their deadline has passed, and remove them from the selector.
    - Send pings to peers in the `valid` list and update their state to `PEER_STATE_REFRESHING` with a new deadline.
    - Move peers from the `refreshing` list to the `invalid` list if their deadline has passed, and remove them from the selector.
    - Move peers from the `invalid` list back to the `unpinged` list if their deadline has passed.
    - Receive pings and update the state of peers accordingly.
- **Output**: No return value; the function modifies the state of peers within the `fd_ssping_t` structure.
- **Functions Called**:
    - [`send_pings`](<#send_pings>)
    - [`fd_sspeer_selector_remove`](<fd_sspeer_selector.c.md#fd_sspeer_selector_remove>)
    - [`recv_pings`](<#recv_pings>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)