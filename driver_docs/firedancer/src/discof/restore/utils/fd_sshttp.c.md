<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements an HTTP client for sending requests, handling responses, and managing HTTP state transitions.

# Purpose
The code is a C module that implements a simple HTTP client for sending HTTP GET requests and handling responses. It is designed to manage HTTP connections, send requests, receive responses, and handle HTTP redirects. The module defines a state machine with states such as `FD_SSHTTP_STATE_INIT`, `FD_SSHTTP_STATE_REQ`, `FD_SSHTTP_STATE_RESP`, and `FD_SSHTTP_STATE_DL` to track the progress of an HTTP transaction. The primary data structure used is `fd_sshttp_private`, which holds information about the connection state, request and response data, and other necessary metadata.

The module provides several functions to manage the lifecycle of an HTTP request. The [`fd_sshttp_new`](<#fd_sshttp_new>) function initializes a new HTTP client instance, while [`fd_sshttp_init`](<#fd_sshttp_init>) sets up the request details and establishes a connection to the server. The [`fd_sshttp_advance`](<#fd_sshttp_advance>) function progresses the state machine by sending requests, reading responses, and handling data transfer. The module also includes functions to handle redirects ([`follow_redirect`](<#follow_redirect>)) and to read the response body ([`read_body`](<#read_body>)). Additionally, utility functions like [`fd_sshttp_snapshot_names`](<#fd_sshttp_snapshot_names>) and [`fd_sshttp_content_len`](<#fd_sshttp_content_len>) provide access to snapshot names and content length, respectively. The code uses various system calls and socket programming techniques to manage network communication.
# Imports and Dependencies

---
- `fd_sshttp.h`
- `fd_ssarchive.h`
- `../../../waltz/http/picohttpparser.h`
- `../../../util/log/fd_log.h`
- `../../../flamenco/types/fd_types_custom.h`
- `unistd.h`
- `errno.h`
- `stdlib.h`
- `sys/socket.h`
- `netinet/tcp.h`
- `netinet/in.h`


# Data Structures

---
### fd\_sshttp\_private
- **Type**: ``struct``
- **Members**:
    - `state`: Stores the current state of the HTTP connection.
    - `deadline`: Represents the time limit for the current operation.
    - `full`: Indicates if the full snapshot is being processed.
    - `hops`: Counts the number of redirects allowed.
    - `addr`: Holds the IP address and port for the connection.
    - `sockfd`: File descriptor for the socket connection.
    - `request`: Buffer to store the HTTP request data.
    - `request_len`: Length of the HTTP request data.
    - `request_sent`: Tracks the amount of request data sent.
    - `response_len`: Length of the HTTP response data received.
    - `response`: Buffer to store the HTTP response data.
    - `full_snapshot_name`: Stores the name of the full snapshot file.
    - `incremental_snapshot_name`: Stores the name of the incremental snapshot file.
    - `content_len`: Length of the content in the HTTP response body.
    - `content_read`: Tracks the amount of content read from the response body.
    - `magic`: Magic number for validation of the structure.
- **Description**: Manages the state and data for an HTTP connection, including request and response handling, snapshot file names, and connection parameters such as socket file descriptor and IP address.


# Functions

---
### fd\_sshttp\_align<!-- {{#callable:fd_sshttp_align}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sshttp.c#L48>)

Returns the alignment requirement for the `fd_sshttp_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the value of the macro `FD_SSHTTP_ALIGN`.
- **Output**: The function returns an `ulong` representing the alignment requirement for the `fd_sshttp_t` structure.


---
### fd\_sshttp\_footprint<!-- {{#callable:fd_sshttp_footprint}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sshttp.c#L53>)

Calculates the memory footprint required for an `fd_sshttp_t` structure with alignment.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize a variable `l` with `FD_LAYOUT_INIT`.
    - Append the size of `fd_sshttp_t` to `l` using `FD_LAYOUT_APPEND` with alignment `FD_SSHTTP_ALIGN`.
    - Finalize the layout and return the result using `FD_LAYOUT_FINI` with alignment `FD_SSHTTP_ALIGN`.
- **Output**: Returns the calculated memory footprint as an `ulong`.


---
### fd\_sshttp\_new<!-- {{#callable:fd_sshttp_new}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sshttp.c#L61>)

Initializes a new `fd_sshttp_t` structure in shared memory with proper alignment and initial state.
- **Inputs**:
    - `shmem`: A pointer to the shared memory where the `fd_sshttp_t` structure will be initialized.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL; if so, log a warning and return NULL.
    - Check if `shmem` is aligned according to [`fd_sshttp_align`](<#fd_sshttp_align>); if not, log a warning and return NULL.
    - Initialize a scratch allocator with `shmem`.
    - Allocate memory for `fd_sshttp_t` using the scratch allocator.
    - Set the `state` of `fd_sshttp_t` to `FD_SSHTTP_STATE_INIT`.
    - Initialize `full_snapshot_name` and `incremental_snapshot_name` to empty strings.
    - Use memory fences to ensure memory operations are completed before setting `magic`.
    - Set the `magic` field of `fd_sshttp_t` to `FD_SSHTTP_MAGIC` using a volatile store.
    - Return a pointer to the initialized `fd_sshttp_t` structure.
- **Output**: A pointer to the newly initialized `fd_sshttp_t` structure, or NULL if initialization fails.
- **Functions Called**:
    - [`fd_sshttp_align`](<#fd_sshttp_align>)


---
### fd\_sshttp\_join<!-- {{#callable:fd_sshttp_join}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sshttp.c#L87>)

Validates and returns a pointer to a `fd_sshttp_t` structure if the input is correctly aligned and initialized.
- **Inputs**:
    - `shhttp`: A pointer to a memory location that is expected to be a `fd_sshttp_t` structure.
- **Logic and Control Flow**:
    - Check if `shhttp` is NULL; if so, log a warning and return NULL.
    - Check if `shhttp` is aligned according to [`fd_sshttp_align`](<#fd_sshttp_align>); if not, log a warning and return NULL.
    - Cast `shhttp` to a `fd_sshttp_t` pointer and store it in `sshttp`.
    - Check if the `magic` field of `sshttp` matches `FD_SSHTTP_MAGIC`; if not, log a warning and return NULL.
    - Return the `sshttp` pointer.
- **Output**: A pointer to a `fd_sshttp_t` structure if all checks pass, otherwise NULL.
- **Functions Called**:
    - [`fd_sshttp_align`](<#fd_sshttp_align>)


---
### fd\_sshttp\_init<!-- {{#callable:fd_sshttp_init}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sshttp.c#L109>)

Initializes an HTTP connection and prepares an HTTP GET request for a specified path and address.
- **Inputs**:
    - `http`: A pointer to an `fd_sshttp_t` structure that holds the state and data for the HTTP connection.
    - `addr`: An `fd_ip4_port_t` structure that specifies the IPv4 address and port for the HTTP connection.
    - `path`: A constant character pointer to the path for the HTTP GET request.
    - `path_len`: An unsigned long integer representing the length of the path.
    - `now`: A long integer representing the current time, used to set the request deadline.
- **Logic and Control Flow**:
    - Checks if the `http` state is `FD_SSHTTP_STATE_INIT` to ensure it is in the initial state.
    - Sets the number of allowed redirects (`hops`) to 4.
    - Initializes the `request_sent` counter to 0.
    - Formats the HTTP GET request string and stores it in the `http->request` buffer, checking for formatting errors.
    - Creates a socket for the HTTP connection using `socket(AF_INET, SOCK_STREAM, 0)` and logs an error if socket creation fails.
    - Sets a receive timeout of 10 milliseconds on the socket using `setsockopt` and logs an error if it fails.
    - Configures the `sockaddr_in` structure with the address and port, converting the port to network byte order.
    - Attempts to connect the socket to the specified address and port, handling errors and closing the socket if the connection fails and the error is not `EINPROGRESS`.
    - Sets the `http` state to `FD_SSHTTP_STATE_REQ` to indicate that the request is ready to be sent.
    - Calculates and sets the request deadline to 500 milliseconds from the current time (`now`).
- **Output**: No return value; the function modifies the `http` structure to set up the HTTP connection and request.


---
### fd\_sshttp\_cancel<!-- {{#callable:fd_sshttp_cancel}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sshttp.c#L158>)

Cancels an ongoing HTTP operation by closing the socket and resetting the state.
- **Inputs**:
    - `http`: A pointer to an `fd_sshttp_t` structure representing the HTTP operation to cancel.
- **Logic and Control Flow**:
    - Checks if the `http` state is not `FD_SSHTTP_STATE_INIT` and if `sockfd` is not -1.
    - If the above condition is true, attempts to close the socket using `close(http->sockfd)`.
    - Logs an error if closing the socket fails.
    - Sets `http->sockfd` to -1 after closing the socket.
    - Resets the `http` state to `FD_SSHTTP_STATE_INIT`.
- **Output**: No return value; the function operates directly on the `http` structure.


---
### send\_request<!-- {{#callable:send_request}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sshttp.c#L167>)

Attempts to send an HTTP request over a socket and manages the state of the request process.
- **Inputs**:
    - ``http``: A pointer to an `fd_sshttp_t` structure that contains the HTTP request and connection details.
    - ``now``: A long integer representing the current time, used to check against the request deadline.
- **Logic and Control Flow**:
    - Checks if the current time `now` exceeds the `http->deadline`; if true, cancels the request and returns `FD_SSHTTP_ADVANCE_ERROR`.
    - Attempts to send the remaining portion of the HTTP request using `sendto`.
    - If `sendto` returns -1 and `errno` is `EAGAIN`, returns `FD_SSHTTP_ADVANCE_AGAIN`.
    - If `sendto` returns -1 for other reasons, cancels the request and returns `FD_SSHTTP_ADVANCE_ERROR`.
    - Updates `http->request_sent` with the number of bytes successfully sent.
    - If the entire request has been sent (`http->request_sent` equals `http->request_len`), updates the state to `FD_SSHTTP_STATE_RESP`, resets `http->response_len`, and sets a new deadline.
    - Returns `FD_SSHTTP_ADVANCE_AGAIN` to indicate the request process should continue.
- **Output**: Returns an integer status code indicating the result of the send operation, such as `FD_SSHTTP_ADVANCE_ERROR` or `FD_SSHTTP_ADVANCE_AGAIN`.
- **Functions Called**:
    - [`fd_sshttp_cancel`](<#fd_sshttp_cancel>)


---
### follow\_redirect<!-- {{#callable:follow_redirect}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sshttp.c#L192>)

Handles HTTP redirects by processing the 'Location' header and preparing a new HTTP request to the redirected URL.
- **Inputs**:
    - ``http``: A pointer to an `fd_sshttp_t` structure representing the current HTTP session.
    - ``headers``: An array of `phr_header` structures containing the HTTP headers from the response.
    - ``header_cnt``: The number of headers in the `headers` array.
    - ``now``: The current time, used for setting deadlines and timeouts.
- **Logic and Control Flow**:
    - Check if the maximum number of redirects (`http->hops`) is exceeded; if so, log a warning, cancel the HTTP session, and return an error.
    - Decrement the `http->hops` counter to track the number of redirects followed.
    - Iterate over the headers to find the 'Location' header; if not found, log a warning, cancel the session, and return an error.
    - Validate the 'Location' header value; if invalid, log a warning, cancel the session, and return an error.
    - Extract the snapshot name from the 'Location' header and parse it to obtain entry slots and a decoded hash.
    - If parsing fails, log a warning, cancel the session, and return an error.
    - Encode the hash using Base58 and construct the snapshot file name based on whether it is incremental or full.
    - Prepare a new HTTP GET request using the location from the 'Location' header.
    - Log the redirect action and reinitialize the HTTP session with the new request details.
    - Return a status indicating that the process should advance again.
- **Output**: Returns `FD_SSHTTP_ADVANCE_AGAIN` if successful, or `FD_SSHTTP_ADVANCE_ERROR` if an error occurs.
- **Functions Called**:
    - [`fd_sshttp_cancel`](<#fd_sshttp_cancel>)
    - [`fd_ssarchive_parse_filename`](<fd_ssarchive.c.md#fd_ssarchive_parse_filename>)
    - [`fd_sshttp_init`](<#fd_sshttp_init>)


---
### read\_response<!-- {{#callable:read_response}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sshttp.c#L278>)

Reads and processes an HTTP response from a socket, handling timeouts, errors, redirects, and data extraction.
- **Inputs**:
    - ``http``: A pointer to an `fd_sshttp_t` structure representing the HTTP connection state.
    - ``data_len``: A pointer to an `ulong` that specifies the length of the data buffer and receives the length of the data read.
    - ``data``: A pointer to an `uchar` buffer where the function stores the response data.
    - ``now``: A `long` integer representing the current time, used to check for timeouts.
- **Logic and Control Flow**:
    - Check if the current time `now` exceeds the `http->deadline`; if so, log a timeout warning, cancel the HTTP operation, and return an error code.
    - Attempt to read data from the socket using `recvfrom`; handle `EAGAIN` by returning 0, and other errors by logging a warning, canceling the operation, and returning an error code.
    - Update `http->response_len` with the number of bytes read.
    - Parse the HTTP response using `phr_parse_response`; handle parsing errors by logging a warning, canceling the operation, and returning an error code or a retry code.
    - Check for HTTP redirect status codes (301, 302, 303, 304, 307, 308); if found, call [`follow_redirect`](<#follow_redirect>) to handle the redirect.
    - Check for a non-200 status code; if found, log a warning, cancel the operation, and return an error code.
    - Initialize `http->content_read` and set `http->content_len` to `ULONG_MAX`; search for the 'content-length' header to update `http->content_len`.
    - If 'content-length' is not found, log a warning, cancel the operation, and return an error code.
    - Set `http->state` to `FD_SSHTTP_STATE_DL` to indicate the start of downloading the response body.
    - If there is remaining unparsed data in the response, check if the `data` buffer is large enough, copy the data to `data`, update `http->content_read`, and return a data code.
    - If all data is parsed, return a retry code.
- **Output**: Returns an integer status code indicating success, need to retry, or an error.
- **Functions Called**:
    - [`fd_sshttp_cancel`](<#fd_sshttp_cancel>)
    - [`follow_redirect`](<#follow_redirect>)


---
### read\_body<!-- {{#callable:read_body}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sshttp.c#L363>)

Reads data from an HTTP response body into a buffer, handling various conditions such as completion, errors, and retries.
- **Inputs**:
    - `http`: A pointer to an `fd_sshttp_t` structure representing the HTTP connection state.
    - `data_len`: A pointer to an `ulong` that specifies the maximum number of bytes to read and will be updated with the actual number of bytes read.
    - `data`: A pointer to a buffer where the function will store the read data.
- **Logic and Control Flow**:
    - Check if the content has already been fully read (`http->content_read >= http->content_len`).
    - If fully read, cancel the HTTP operation, reset the state to `FD_SSHTTP_STATE_INIT`, and return `FD_SSHTTP_ADVANCE_DONE`.
    - Assert that there is more content to read (`http->content_read < http->content_len`).
    - Attempt to read data from the socket using `recvfrom`, with the read size being the minimum of `*data_len` and the remaining content length.
    - If `recvfrom` returns -1 and `errno` is `EAGAIN`, return `FD_SSHTTP_ADVANCE_AGAIN` to indicate a retry is needed.
    - If `recvfrom` returns -1 for other reasons, cancel the HTTP operation and return `FD_SSHTTP_ADVANCE_ERROR`.
    - If no data is read (`read == 0`), return `FD_SSHTTP_ADVANCE_AGAIN`.
    - Update `*data_len` with the number of bytes read and increment `http->content_read` by the same amount.
    - Return `FD_SSHTTP_ADVANCE_DATA` to indicate data was successfully read.
- **Output**: An integer status code indicating the result of the read operation, such as `FD_SSHTTP_ADVANCE_DONE`, `FD_SSHTTP_ADVANCE_AGAIN`, `FD_SSHTTP_ADVANCE_ERROR`, or `FD_SSHTTP_ADVANCE_DATA`.
- **Functions Called**:
    - [`fd_sshttp_cancel`](<#fd_sshttp_cancel>)


---
### fd\_sshttp\_snapshot\_names<!-- {{#callable:fd_sshttp_snapshot_names}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sshttp.c#L389>)

Assigns the full and incremental snapshot names from the `fd_sshttp_t` structure to the provided pointers.
- **Inputs**:
    - ``http``: A pointer to a constant `fd_sshttp_t` structure containing snapshot names.
    - ``full_snapshot_name``: A pointer to a `char` pointer where the full snapshot name will be stored.
    - ``incremental_snapshot_name``: A pointer to a `char` pointer where the incremental snapshot name will be stored.
- **Logic and Control Flow**:
    - Assign the `full_snapshot_name` pointer to the `full_snapshot_name` field of the `http` structure.
    - Assign the `incremental_snapshot_name` pointer to the `incremental_snapshot_name` field of the `http` structure.
- **Output**: No return value; the function modifies the pointers provided as arguments to point to the respective snapshot names.


---
### fd\_sshttp\_content\_len<!-- {{#callable:fd_sshttp_content_len}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sshttp.c#L397>)

Retrieves the `content_len` field from the `fd_sshttp_t` structure.
- **Inputs**:
    - `http`: A pointer to a constant `fd_sshttp_t` structure from which to retrieve the content length.
- **Logic and Control Flow**:
    - Accesses the `content_len` field of the `fd_sshttp_t` structure pointed to by `http`.
    - Returns the value of the `content_len` field.
- **Output**: The function returns an `ulong` representing the content length stored in the `fd_sshttp_t` structure.


---
### fd\_sshttp\_advance<!-- {{#callable:fd_sshttp_advance}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sshttp.c#L402>)

Advances the state of an HTTP transaction based on the current state of the `fd_sshttp_t` object.
- **Inputs**:
    - `http`: A pointer to an `fd_sshttp_t` object representing the HTTP transaction state.
    - `data_len`: A pointer to an `ulong` that will store the length of the data read.
    - `data`: A pointer to a buffer where the function will store the data read.
    - `now`: A `long` representing the current time, used for timeout checks.
- **Logic and Control Flow**:
    - Checks the current state of the `http` object.
    - If the state is `FD_SSHTTP_STATE_INIT`, returns `FD_SSHTTP_ADVANCE_AGAIN`.
    - If the state is `FD_SSHTTP_STATE_REQ`, calls [`send_request`](<#send_request>) to send the HTTP request and returns its result.
    - If the state is `FD_SSHTTP_STATE_RESP`, calls [`read_response`](<#read_response>) to read the HTTP response headers and returns its result.
    - If the state is `FD_SSHTTP_STATE_DL`, calls [`read_body`](<#read_body>) to read the HTTP response body and returns its result.
    - If the state is not recognized, returns 0.
- **Output**: An integer indicating the result of the state advancement, which can be `FD_SSHTTP_ADVANCE_AGAIN`, `FD_SSHTTP_ADVANCE_ERROR`, `FD_SSHTTP_ADVANCE_DATA`, or `FD_SSHTTP_ADVANCE_DONE`.
- **Functions Called**:
    - [`send_request`](<#send_request>)
    - [`read_response`](<#read_response>)
    - [`read_body`](<#read_body>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)