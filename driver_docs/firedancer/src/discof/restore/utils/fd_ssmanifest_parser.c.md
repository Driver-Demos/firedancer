<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Parses and processes snapshot manifest data, managing state transitions and validating input.

# Purpose
The code is a C source file that defines a parser for a snapshot manifest, specifically for a system that appears to manage blockchain or distributed ledger data. The file includes several header files, such as `fd_ssmanifest_parser.h`, `fd_ssmsg.h`, and `fd_log.h`, which suggest that it is part of a larger system or library. The primary functionality of this file is to parse and validate a snapshot manifest, which is a structured representation of the state of a blockchain at a specific point in time.

The file defines a large number of constants representing different states and data fields within the snapshot manifest. These constants are used to manage the parsing state machine, which is implemented in the [`state_size`](<#state_size>), [`state_dst`](<#state_dst>), [`state_validate`](<#state_validate>), and [`state_process`](<#state_process>) functions. The `fd_ssmanifest_parser_private` structure holds the current state of the parser, including offsets, indices, and pointers to the destination data structures. The parser processes input data in a state-driven manner, validating and storing parsed data into a `fd_snapshot_manifest_t` structure. The code also includes functions for initializing and consuming data with the parser, ensuring that the manifest is correctly parsed and validated.
# Imports and Dependencies

---
- `fd_ssmanifest_parser.h`
- `fd_ssmsg.h`
- `../../../util/log/fd_log.h`


# Data Structures

---
### fd\_ssmanifest\_parser\_private
- **Type**: ``struct``
- **Members**:
    - ``state``: Stores the current state of the parser.
    - ``off``: Tracks the current offset in the parsing process.
    - ``dst``: Points to the destination buffer for parsed data.
    - ``dst_cur``: Indicates the current position in the destination buffer.
    - ``dst_sz``: Specifies the size of the destination buffer.
    - ``option``: Holds an option value used in parsing.
    - ``variant``: Stores a variant identifier for parsing.
    - ``idx1``: First index used for iteration or lookup.
    - ``idx2``: Second index used for iteration or lookup.
    - ``length1``: First length value used in parsing.
    - ``length2``: Second length value used in parsing.
    - ``length3``: Third length value used in parsing.
    - ``length4``: Fourth length value used in parsing.
    - ``epoch_stakes_len``: Length of the epoch stakes array.
    - ``epoch``: Current epoch being processed.
    - ``epoch_stakes_epoch``: Epoch value related to stakes.
    - ``epoch_idx``: Index for the current epoch stakes.
    - ``account_data_start``: Offset where account data starts.
    - ``acc_vec_slot``: Slot identifier for account vectors.
    - ``acc_vec_id``: ID for account vectors.
    - ``acc_vec_file_sz``: File size for account vectors.
    - ``seed``: Seed value used in parsing.
    - ``manifest``: Pointer to the snapshot manifest structure.
- **Description**: Manages the state and data required for parsing a snapshot manifest, including tracking offsets, buffer positions, and various indices and lengths for processing different sections of the manifest.


# Functions

---
### state\_size<!-- {{#callable:state_size}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssmanifest_parser.c#L355>)

Calculates the size of the state based on the current state of the parser.
- **Inputs**:
    - `parser`: A pointer to a `fd_ssmanifest_parser_t` structure that contains the current state and lengths used to determine the size.
- **Logic and Control Flow**:
    - Retrieve `length1`, `length2`, `length3`, and `length4` from the `parser` structure.
    - Use a switch statement to determine the size based on the `parser->state`.
    - For each case, return a specific size value, which may depend on `length1`, `length2`, `length3`, or `length4`.
    - If the state is unknown, log an error message.
- **Output**: Returns an `ulong` representing the size of the state.


---
### state\_dst<!-- {{#callable:state_dst}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssmanifest_parser.c#L679>)

Returns a pointer to a specific field in the `fd_snapshot_manifest_t` structure based on the current state of the parser.
- **Inputs**:
    - `parser`: A pointer to an `fd_ssmanifest_parser_t` structure that contains the current state and indices for parsing.
- **Logic and Control Flow**:
    - Retrieve `idx1`, `idx2`, and `manifest` from the `parser` structure.
    - Use a `switch` statement to determine the action based on `parser->state`.
    - For each case, return a pointer to a specific field in the `manifest` or `parser` structure, or return `NULL` if the state does not correspond to a valid field.
- **Output**: A pointer to a `uchar` that points to a specific field in the `fd_snapshot_manifest_t` structure or `NULL` if the state does not correspond to a valid field.


---
### state\_log<!-- {{#callable:state_log}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssmanifest_parser.c#L1003>)

Logs the current state of the parser and associated manifest data for debugging purposes.
- **Inputs**:
    - ``parser``: A pointer to a `fd_ssmanifest_parser_t` structure, which contains the current state and associated manifest data.
- **Logic and Control Flow**:
    - Retrieve the `manifest` from the `parser` structure.
    - Use a `switch` statement to determine the current `state` of the `parser`.
    - For each case in the `switch` statement, log a message with the state name and the corresponding value from the `manifest` or `parser`.
    - If the state does not match any case, do nothing.
- **Output**: No output is returned; the function logs messages for debugging.


---
### state\_validate<!-- {{#callable:state_validate}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssmanifest_parser.c#L1053>)

Validates the state of a parser by checking various conditions based on the current state and logs warnings if any condition fails.
- **Inputs**:
    - `parser`: A pointer to a `fd_ssmanifest_parser_t` structure, which contains the current state and associated data for validation.
- **Logic and Control Flow**:
    - Retrieve the `manifest` from the `parser` structure.
    - Use a switch statement to check the `parser->state` and validate specific conditions for each state.
    - For states related to options, check if the option value is greater than 1 and log a warning if true.
    - For states related to variants, check if the variant value is greater than 2 and log a warning if true.
    - For states related to lengths, check if the length is invalid (e.g., zero or exceeding a maximum) and log a warning if true.
    - Return -1 if any validation fails, otherwise continue to the next state.
    - Return 0 if all validations pass.
- **Output**: Returns 0 if all validations pass, or -1 if any validation fails.


---
### state\_process<!-- {{#callable:state_process}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssmanifest_parser.c#L1351>)

Processes the state of a snapshot manifest parser, updating its state and handling account vector mappings and epoch stakes.
- **Inputs**:
    - ``parser``: A pointer to a `fd_ssmanifest_parser_t` structure that holds the current state and data of the parser.
    - ``acc_vec_map``: A pointer to an `acc_vec_map_t` structure used for mapping account vectors.
    - ``acc_vec_pool``: A pointer to an `acc_vec_t` structure used as a pool for account vectors.
- **Logic and Control Flow**:
    - Checks if the parser's state is not `STATE_DONE` using `FD_TEST` macro.
    - Handles the `STATE_ACCOUNTS_DB_STORAGES_ACCOUNT_VECS_FILE_SZ` state by checking if the `acc_vec_pool` is full and inserting a new account vector if not.
    - Handles duplicate account vectors by querying `acc_vec_map` and logging a warning if a duplicate is found.
    - Updates the parser's state based on the current state and specific conditions, such as `STATE_EPOCH_STAKES_KEY` and `STATE_VERSIONED_EPOCH_STAKES_EPOCH`, by calculating `epoch_delta` and setting `epoch_idx`.
    - Processes various states related to stakes and vote accounts, updating the parser's state and handling specific conditions for each state.
    - Handles options and updates the manifest based on the parser's state and options, such as `STATE_HASHES_PER_TICK_OPTION` and `STATE_LTHASH_OPTION`.
    - Iterates over lengths and indices for specific states, updating the parser's state and indices accordingly.
    - Increments the parser's state by one and returns 0 at the end of the function.
- **Output**: Returns 0 on successful processing or -1 if an error occurs, such as when the `acc_vec_pool` is full or a duplicate account vector is found.


---
### fd\_ssmanifest\_parser\_align<!-- {{#callable:fd_ssmanifest_parser_align}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssmanifest_parser.c#L1569>)

Returns the alignment requirement of the `fd_ssmanifest_parser_t` type.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls the `alignof` operator on `fd_ssmanifest_parser_t` to determine its alignment requirement.
    - Returns the result of the `alignof` operation.
- **Output**: The function returns an `ulong` representing the alignment requirement of the `fd_ssmanifest_parser_t` type.


---
### fd\_ssmanifest\_parser\_footprint<!-- {{#callable:fd_ssmanifest_parser_footprint}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssmanifest_parser.c#L1574>)

Calculates the memory footprint required for an `fd_ssmanifest_parser_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize a variable `l` with `FD_LAYOUT_INIT` to start the layout calculation.
    - Append the alignment and size of `fd_ssmanifest_parser_t` to `l` using `FD_LAYOUT_APPEND`.
    - Finalize the layout calculation with `FD_LAYOUT_FINI` using the alignment of `fd_ssmanifest_parser_t`.
- **Output**: Returns the calculated memory footprint as an `ulong` value.


---
### fd\_ssmanifest\_parser\_new<!-- {{#callable:fd_ssmanifest_parser_new}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssmanifest_parser.c#L1581>)

Allocates and initializes a new `fd_ssmanifest_parser_t` object in shared memory.
- **Inputs**:
    - `shmem`: A pointer to the shared memory where the parser will be allocated.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL; if so, log a warning and return NULL.
    - Check if `shmem` is aligned to the alignment requirements of `fd_ssmanifest_parser_t`; if not, log a warning and return NULL.
    - Initialize a scratch allocator with `shmem`.
    - Allocate memory for a `fd_ssmanifest_parser_t` object using the scratch allocator.
    - Return a pointer to the newly allocated `fd_ssmanifest_parser_t` object.
- **Output**: A pointer to the newly allocated `fd_ssmanifest_parser_t` object, or NULL if an error occurs.


---
### fd\_ssmanifest\_parser\_join<!-- {{#callable:fd_ssmanifest_parser_join}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssmanifest_parser.c#L1599>)

Returns the input `shmem` pointer as a `fd_ssmanifest_parser_t` pointer.
- **Inputs**:
    - `shmem`: A pointer to shared memory that is expected to be aligned and of type `fd_ssmanifest_parser_t`.
- **Logic and Control Flow**:
    - The function takes a single input parameter `shmem`.
    - It returns the `shmem` pointer cast to a `fd_ssmanifest_parser_t` pointer.
- **Output**: A pointer of type `fd_ssmanifest_parser_t *` that is the same as the input `shmem` pointer.


---
### fd\_ssmanifest\_parser\_init<!-- {{#callable:fd_ssmanifest_parser_init}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssmanifest_parser.c#L1604>)

Initializes a `fd_ssmanifest_parser_t` structure with a given state and associates it with a `fd_snapshot_manifest_t`.
- **Inputs**:
    - `parser`: A pointer to a `fd_ssmanifest_parser_t` structure that will be initialized.
    - `manifest`: A pointer to a `fd_snapshot_manifest_t` structure that the parser will use.
- **Logic and Control Flow**:
    - Sets the `state` of `parser` to `STATE_BLOCKHASH_QUEUE_LAST_HASH_INDEX`.
    - Initializes `off` to 0UL, `dst` to the result of `state_dst(parser)`, `dst_sz` to the result of `state_size(parser)`, and `dst_cur` to 0UL.
    - Assigns the `manifest` pointer to the `manifest` field of `parser`.
    - Initializes scratch memory allocation for `parser` and appends the size of `fd_ssmanifest_parser_t` to it.
- **Output**: No return value; the function initializes the `parser` in place.
- **Functions Called**:
    - [`state_dst`](<#state_dst>)
    - [`state_size`](<#state_size>)


---
### fd\_ssmanifest\_parser\_consume<!-- {{#callable:fd_ssmanifest_parser_consume}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssmanifest_parser.c#L1618>)

Consumes data from a buffer to update the parser state and process the data according to the parser's current state.
- **Inputs**:
    - `parser`: A pointer to `fd_ssmanifest_parser_t`, which maintains the current state and data of the parser.
    - `buf`: A pointer to a buffer of type `uchar const *` containing the data to be consumed.
    - `bufsz`: An `ulong` representing the size of the buffer.
    - `acc_vec_map`: A pointer to `acc_vec_map_t`, used for managing account vectors, can be NULL.
    - `acc_vec_pool`: A pointer to `acc_vec_t`, used for managing account vector pools, can be NULL.
- **Logic and Control Flow**:
    - Initialize the state variable for debugging if `SSMANIFEST_DEBUG` is enabled.
    - Enter a loop that continues while `bufsz` is non-zero.
    - Calculate the number of bytes to consume using `fd_ulong_min` between `bufsz` and the remaining space in the destination buffer (`parser->dst_sz - parser->dst_cur`).
    - If there is a destination buffer and bytes to consume, copy the data from `buf` to `parser->dst` using `memcpy`.
    - Update the parser's offset, current destination position, buffer pointer, and buffer size after consuming data.
    - If the current destination position equals the destination size, validate and process the parser state.
    - Update the destination buffer and size for the next state if processing is successful.
    - Break the loop if the parser state is `STATE_DONE`.
    - Return `FD_SSMANIFEST_PARSER_ADVANCE_AGAIN` if the buffer size is zero but the state is not `STATE_DONE`.
    - Log a warning and return `FD_SSMANIFEST_PARSER_ADVANCE_ERROR` if there is excess data in the buffer after processing.
- **Output**: Returns an integer status code: `FD_SSMANIFEST_PARSER_ADVANCE_DONE` on successful completion, `FD_SSMANIFEST_PARSER_ADVANCE_AGAIN` if more data is needed, or `FD_SSMANIFEST_PARSER_ADVANCE_ERROR` if an error occurs.
- **Functions Called**:
    - [`state_log`](<#state_log>)
    - [`state_validate`](<#state_validate>)
    - [`state_process`](<#state_process>)
    - [`state_dst`](<#state_dst>)
    - [`state_size`](<#state_size>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)