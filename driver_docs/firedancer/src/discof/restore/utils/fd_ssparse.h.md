<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Header file for a Solana snapshot parser, defining data structures, constants, and functions for streaming snapshot parsing.

# Purpose
The code is a C header file that defines a snapshot parser for Solana, named `fd_ssparse`. It is designed to parse Solana snapshot data in a streaming manner, processing the data chunk by chunk. The file includes definitions for constants, data structures, and function prototypes that facilitate the parsing process. The `fd_ssparse` parser can handle different types of data within a snapshot, such as manifest, status cache, account headers, account data, and account batches. The parser is capable of processing these components and returning results through the `fd_ssparse_advance_result_t` structure.

The header file defines several macros and data structures to manage the parsing process. It includes a pool and map implementation for managing account vectors, which are used to track account data within the snapshot. The file also provides function prototypes for creating, joining, resetting, and advancing the parser, as well as enabling batch processing. Additionally, it includes test and fuzzing APIs to populate the internal account vector map for testing purposes. The header file is intended to be included in other C source files that require Solana snapshot parsing functionality.
# Imports and Dependencies

---
- `../../../util/fd_util_base.h`
- `../../../util/tmpl/fd_pool.c`
- `../../../util/tmpl/fd_map_chain.c`


# Data Structures

---
### fd\_ssparse\_t
- **Type**: ``fd_ssparse_t``
- **Members**:
    - ``fd_ssparse_private``: A forward declaration for the private structure used internally by `fd_ssparse_t`.
- **Description**: Parses Solana snapshot data in a streaming manner, processing chunks of data sequentially.


---
### acc\_vec\_key
- **Type**: ``struct``
- **Members**:
    - `slot`: Stores an unsigned long integer representing a slot.
    - `id`: Stores an unsigned long integer representing an identifier.
- **Description**: Defines a key structure with two unsigned long integer fields, `slot` and `id`, used to uniquely identify elements in a vector or map.


---
### acc\_vec\_key\_t
- **Type**: ``struct``
- **Members**:
    - `slot`: Stores the slot number as an unsigned long integer.
    - `id`: Stores the identifier as an unsigned long integer.
- **Description**: Defines a key structure for an account vector with two members: `slot` and `id`, both of which are unsigned long integers. This structure is used as a key in mapping operations, likely to uniquely identify account vectors in a larger data structure or system.


---
### acc\_vec
- **Type**: ``struct``
- **Members**:
    - `key`: Holds a key of type `acc_vec_key_t` that uniquely identifies the vector.
    - `file_sz`: Stores the size of the file associated with the vector.
    - `map_next`: Points to the next element in a map chain.
    - `map_prev`: Points to the previous element in a map chain.
    - `pool_next`: Points to the next element in a pool.
- **Description**: Defines a structure used to manage and track account vectors, including their unique keys, file sizes, and their positions within map and pool data structures.


---
### acc\_vec\_t
- **Type**: ``struct``
- **Members**:
    - `key`: Stores the key for the vector, consisting of a slot and an id.
    - `file_sz`: Represents the size of the file associated with the vector.
    - `map_next`: Holds the index of the next element in the map.
    - `map_prev`: Holds the index of the previous element in the map.
    - `pool_next`: Holds the index of the next element in the pool.
- **Description**: Defines a structure used to manage account vectors, including their keys, file sizes, and linkage information for map and pool data structures.


---
### fd\_ssparse\_advance\_result
- **Type**: ``struct``
- **Members**:
    - ``bytes_consumed``: Indicates the number of bytes processed.
    - ``manifest``: Contains data, size, and pointers to account vector map and pool.
    - ``status_cache``: Holds data and its size for status caching.
    - ``account_header``: Stores account metadata including slot, data length, public key, lamports, rent epoch, owner, executable flag, and hash.
    - ``account_data``: Contains account data and its size.
    - ``account_batch``: Holds pointers to account entries, batch count, and slot for batch processing.
- **Description**: Represents the result of advancing a snapshot parser, containing information about bytes consumed and various data structures for manifest, status cache, account header, account data, and account batch.


---
### fd\_ssparse\_advance\_result\_t
- **Type**: ``struct``
- **Members**:
    - ``bytes_consumed``: Indicates the number of bytes processed in the current operation.
    - ``manifest``: Contains data related to the manifest, including a pointer to the data, its size, and associated account vector map and pool.
    - ``status_cache``: Holds a pointer to the status cache data and its size.
    - ``account_header``: Stores information about an account header, including slot, data length, public key, lamports, rent epoch, owner, executable status, and hash.
    - ``account_data``: Contains a pointer to account data and its size.
    - ``account_batch``: Includes pointers to account entries in a batch, the count of entries, and the slot number.
- **Description**: `fd_ssparse_advance_result_t` is a `struct` that encapsulates the result of advancing a snapshot parser in a Solana snapshot parsing operation. It includes a `bytes_consumed` field to track the number of bytes processed and a union of structures that store specific data related to different stages of the parsing process, such as manifest, status cache, account header, account data, and account batch. Each structure within the union provides detailed fields relevant to its context, facilitating efficient parsing and processing of snapshot data.


# Function Declarations (Public API)

---
### fd\_ssparse\_align<!-- {{#callable_declaration:fd_ssparse_align}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssparse.h#L109>)

Returns the alignment requirement for the Solana snapshot parser.
- **Description**: Use this function to obtain the alignment requirement for the `fd_ssparse_t` type, which is necessary when allocating memory for a Solana snapshot parser. This function ensures that the memory alignment is compatible with the parser's internal data structures. It is important to call this function before allocating memory for the parser to avoid alignment issues that could lead to undefined behavior.
- **Inputs**: None
- **Output**: The function returns an `ulong` value representing the alignment requirement in bytes.
- **See Also**: [`fd_ssparse_align`](<fd_ssparse.c.md#fd_ssparse_align>)  (Implementation)


---
### fd\_ssparse\_footprint<!-- {{#callable_declaration:fd_ssparse_footprint}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssparse.h#L114>)

Calculates the memory footprint required for a parser with a specified number of account vectors.
- **Description**: Use this function to determine the amount of memory needed to allocate for a parser that can handle a given number of account vectors. This is useful for setting up memory allocations before initializing the parser. Ensure that the `max_acc_vecs` parameter is set to the maximum number of account vectors you expect to process, as this will directly affect the calculated footprint size.
- **Inputs**:
    - `max_acc_vecs`: Specifies the maximum number of account vectors the parser will handle. Must be a non-negative integer. If an invalid value is provided, the behavior is undefined.
- **Output**: Returns the size in bytes of the memory footprint required for the parser.
- **See Also**: [`fd_ssparse_footprint`](<fd_ssparse.c.md#fd_ssparse_footprint>)  (Implementation)


---
### fd\_ssparse\_new<!-- {{#callable_declaration:fd_ssparse_new}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssparse.h#L117>)

Creates a new Solana snapshot parser in shared memory.
- **Description**: Use this function to initialize a new Solana snapshot parser in a specified shared memory region. This function must be called with a valid, aligned shared memory pointer. The parser is designed to process snapshots in a streaming manner, chunk by chunk. Ensure that the shared memory is properly aligned according to the alignment requirements of the parser. The function returns a pointer to the initialized parser or NULL if the shared memory is NULL or not aligned.
- **Inputs**:
    - `shmem`: Pointer to the shared memory region where the parser will be initialized. Must not be NULL and must be aligned according to `fd_ssparse_align()`. Caller retains ownership.
    - `max_acc_vecs`: Maximum number of account vectors the parser can handle. Must be a positive integer.
    - `seed`: Seed value for initializing internal structures. Can be any unsigned long value.
- **Output**: Returns a pointer to the initialized `fd_ssparse_t` parser on success, or NULL if the input `shmem` is NULL or not properly aligned.
- **See Also**: [`fd_ssparse_new`](<fd_ssparse.c.md#fd_ssparse_new>)  (Implementation)


---
### fd\_ssparse\_join<!-- {{#callable_declaration:fd_ssparse_join}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssparse.h#L122>)

Joins a shared memory region to a snapshot parser.
- **Description**: Use this function to associate a shared memory region with a snapshot parser. The shared memory region must be aligned according to the alignment requirements of the parser. This function checks the validity of the shared memory region by verifying its alignment and a magic number. If the shared memory region is invalid, the function returns `NULL`. Ensure that the shared memory region is correctly initialized and aligned before calling this function.
- **Inputs**:
    - `shssparse`: A pointer to the shared memory region to join with the snapshot parser. Must not be null and must be aligned according to `fd_ssparse_align()`. The memory region must have a valid magic number (`FD_SSPARSE_MAGIC`). If these conditions are not met, the function returns `NULL`.
- **Output**: Returns a pointer to the `fd_ssparse_t` structure if successful, or `NULL` if the input is invalid.
- **See Also**: [`fd_ssparse_join`](<fd_ssparse.c.md#fd_ssparse_join>)  (Implementation)


---
### fd\_ssparse\_reset<!-- {{#callable_declaration:fd_ssparse_reset}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssparse.h#L126>)

Rewinds the parser to accept a new snapshot stream.
- **Description**: Use this function to reset the parser state, allowing it to process a new snapshot stream from the beginning. This function must be called before starting to parse a new snapshot stream, ensuring that all internal counters and states are set to their initial values. It is important to call this function to avoid any residual state from previous parsing operations, which could lead to incorrect parsing results.
- **Inputs**:
    - `ssparse`: A pointer to an `fd_ssparse_t` object representing the parser. Must not be null. The caller retains ownership of this object. The function assumes that the object is properly initialized before calling.
- **Output**: None
- **See Also**: [`fd_ssparse_reset`](<fd_ssparse.c.md#fd_ssparse_reset>)  (Implementation)


---
### fd\_ssparse\_advance<!-- {{#callable_declaration:fd_ssparse_advance}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssparse.h#L136>)

Parses a snapshot stream chunk.
- **Description**: Use this function to parse a chunk of a snapshot stream with a given parser. It requires a valid parser object and a data buffer containing the snapshot stream chunk. The function updates the result object with parsing details, except when the return value indicates an error or the need to process more data. Ensure the parser is properly initialized before calling this function.
- **Inputs**:
    - `ssparse`: A pointer to a `fd_ssparse_t` parser object. Must not be null and should be initialized before use.
    - `data`: A pointer to a buffer containing the snapshot stream chunk. Must not be null.
    - `data_sz`: The size of the data buffer. Must be a valid size for the data provided.
    - `result`: A pointer to a `fd_ssparse_advance_result_t` object where the function will store the parsing result. Must not be null.
- **Output**: Returns an integer indicating the parsing result. The result object is populated with details if the return value is not `FD_SSPARSE_ADVANCE_AGAIN` or `FD_SSPARSE_ADVANCE_ERROR`.
- **See Also**: [`fd_ssparse_advance`](<fd_ssparse.c.md#fd_ssparse_advance>)  (Implementation)


---
### fd\_ssparse\_batch\_enable<!-- {{#callable_declaration:fd_ssparse_batch_enable}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssparse.h#L146>)

Toggles batch processing for a snapshot parser.
- **Description**: Use this function to enable or disable batch processing in a Solana snapshot parser. When batch processing is enabled, the parser will deliver `FD_SSPARSE_ADVANCE_ACCOUNT_BATCH` messages, which can help optimize the processing of accounts by reducing per-account overhead. This function should be called when you want to change the batch processing mode of an existing parser instance.
- **Inputs**:
    - `ssparse`: A pointer to an `fd_ssparse_t` object representing the snapshot parser. Must not be null.
    - `enabled`: An integer value where non-zero enables batch processing and zero disables it.
- **Output**: None
- **See Also**: [`fd_ssparse_batch_enable`](<fd_ssparse.c.md#fd_ssparse_batch_enable>)  (Implementation)


---
### fd\_ssparse\_populate\_acc\_vec\_map<!-- {{#callable_declaration:fd_ssparse_populate_acc_vec_map}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssparse.h#L155>)

Populates the internal append vector map with account data.
- **Description**: Use this function to populate the internal append vector map of a `fd_ssparse_t` object with account data for testing or fuzzing purposes. This function takes arrays of slots, IDs, and file sizes, and inserts them into the map. It is important to ensure that the `ssparse` object is properly initialized before calling this function. The function will return an error if it encounters a duplicate entry in the map.
- **Inputs**:
    - `ssparse`: A pointer to a `fd_ssparse_t` object. Must not be null and must be initialized before use.
    - `slots`: An array of slot values. Each element corresponds to an entry in the map. Must not be null.
    - `ids`: An array of ID values. Each element corresponds to an entry in the map. Must not be null.
    - `file_szs`: An array of file sizes. Each element corresponds to an entry in the map. Must not be null.
    - `cnt`: The number of elements in the `slots`, `ids`, and `file_szs` arrays. Must be greater than zero.
- **Output**: Returns 0 on success. Returns -1 if a duplicate entry is found in the map.
- **See Also**: [`fd_ssparse_populate_acc_vec_map`](<fd_ssparse.c.md#fd_ssparse_populate_acc_vec_map>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)