<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for peer selection functionality in the `fd_sspeer_selector` component.

# Purpose
The code is a C program that tests the functionality of a peer selection mechanism using a structure called `fd_sspeer_selector_t`. It includes functions to add peers with specific attributes such as address, slot information, and latency, and then evaluates the best peer based on these attributes. The program uses a series of test cases to verify that the peer selection logic correctly identifies the best peer according to the given criteria, such as latency and slot alignment.

The program begins by setting up a shared memory workspace and initializing the peer selector. It then runs a series of tests defined in the [`test_basic_peer_selection`](<#test_basic_peer_selection>) function. This function adds peers with varying latencies and slot configurations, and checks if the peer selection logic correctly identifies the best peer. The tests cover scenarios such as adding peers with better latency, peers with lagging slots, and peers that are fast but do not have resolved slots. The main function orchestrates the setup and teardown of the shared memory and peer selector, ensuring that resources are properly allocated and freed.
# Imports and Dependencies

---
- `fd_sspeer_selector.h`
- `../../../util/fd_util.h`


# Functions

---
### add\_peer<!-- {{#callable:add_peer}} -->
[View Source →](<../../../../../../src/discof/restore/utils/test_sspeer_selector.c#L5>)

Adds a peer to the selector with specified address, slots, and latency, and returns the result of the addition.
- **Inputs**:
    - `selector`: A pointer to `fd_sspeer_selector_t`, which manages peer selection.
    - `addr`: An `fd_ip4_port_t` structure representing the IP address and port of the peer.
    - `full_slot`: An `ulong` representing the full slot value for the peer.
    - `incremental_slot`: An `ulong` representing the incremental slot value for the peer.
    - `latency`: An `ulong` representing the latency associated with the peer.
- **Logic and Control Flow**:
    - Checks if `full_slot` is not equal to `ULONG_MAX` using `FD_LIKELY` macro.
    - If `full_slot` is valid, initializes an `fd_ssinfo_t` structure with `full_slot` and `incremental_slot`.
    - Calls [`fd_sspeer_selector_add`](<fd_sspeer_selector.c.md#fd_sspeer_selector_add>) with the initialized `fd_ssinfo_t` structure and returns its result.
    - If `full_slot` is `ULONG_MAX`, calls [`fd_sspeer_selector_add`](<fd_sspeer_selector.c.md#fd_sspeer_selector_add>) with `NULL` for the `fd_ssinfo_t` structure and returns its result.
- **Output**: Returns the result of [`fd_sspeer_selector_add`](<fd_sspeer_selector.c.md#fd_sspeer_selector_add>), which is an `ulong`.
- **Functions Called**:
    - [`fd_sspeer_selector_add`](<fd_sspeer_selector.c.md#fd_sspeer_selector_add>)


---
### test\_basic\_peer\_selection<!-- {{#callable:test_basic_peer_selection}} -->
[View Source →](<../../../../../../src/discof/restore/utils/test_sspeer_selector.c#L22>)

Tests the selection of the best peer based on slot information and latency.
- **Inputs**:
    - ``selector``: A pointer to an `fd_sspeer_selector_t` structure that manages peer selection.
- **Logic and Control Flow**:
    - Initialize `cluster_ssinfo` with specific slot values.
    - Call [`fd_sspeer_selector_process_cluster_slot`](<fd_sspeer_selector.c.md#fd_sspeer_selector_process_cluster_slot>) to process the cluster slot information.
    - Add a peer with specific address, slot, and latency values using [`add_peer`](<#add_peer>) and verify it is the best peer using [`fd_sspeer_selector_best`](<fd_sspeer_selector.c.md#fd_sspeer_selector_best>).
    - Repeat the process of adding peers with different slot and latency values, and verify the best peer selection after each addition.
    - Update `cluster_ssinfo` and process the new cluster slot information.
    - Continue adding peers with varying slot and latency values, checking the best peer selection each time.
    - Test incremental peer selection by calling [`fd_sspeer_selector_best`](<fd_sspeer_selector.c.md#fd_sspeer_selector_best>) with different parameters.
- **Output**: No return value; the function performs tests and uses assertions to verify peer selection logic.
- **Functions Called**:
    - [`fd_sspeer_selector_process_cluster_slot`](<fd_sspeer_selector.c.md#fd_sspeer_selector_process_cluster_slot>)
    - [`add_peer`](<#add_peer>)
    - [`fd_sspeer_selector_best`](<fd_sspeer_selector.c.md#fd_sspeer_selector_best>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../../src/discof/restore/utils/test_sspeer_selector.c#L116>)

Initializes shared memory, creates a workspace, and tests peer selection functionality.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Call `fd_boot` to initialize the environment with command-line arguments.
    - Set `page_cnt` to 1 and `_page_sz` to "gigantic".
    - Determine `numa_idx` using `fd_shmem_numa_idx` with 0 as the argument.
    - Create a new anonymous workspace `wksp` using `fd_wksp_new_anonymous` with the page size, page count, CPU index, name "wksp", and 0 as arguments.
    - Check if `wksp` is valid using `FD_TEST`.
    - Allocate shared memory `shmem` in the workspace using `fd_wksp_alloc_laddr` with alignment, footprint, and 1 as arguments.
    - Create and join a new peer selector `selector` using [`fd_sspeer_selector_new`](<fd_sspeer_selector.c.md#fd_sspeer_selector_new>) and [`fd_sspeer_selector_join`](<fd_sspeer_selector.c.md#fd_sspeer_selector_join>) with `shmem`, 65535, 1, and 0 as arguments.
    - Check if `selector` is valid using `FD_TEST`.
    - Call [`test_basic_peer_selection`](<#test_basic_peer_selection>) with `selector` to perform peer selection tests.
    - Free the allocated shared memory and delete the selector using `fd_wksp_free_laddr`, [`fd_sspeer_selector_delete`](<fd_sspeer_selector.c.md#fd_sspeer_selector_delete>), and [`fd_sspeer_selector_leave`](<fd_sspeer_selector.c.md#fd_sspeer_selector_leave>).
    - Return 0 to indicate successful execution.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`fd_sspeer_selector_align`](<fd_sspeer_selector.c.md#fd_sspeer_selector_align>)
    - [`fd_sspeer_selector_footprint`](<fd_sspeer_selector.c.md#fd_sspeer_selector_footprint>)
    - [`fd_sspeer_selector_join`](<fd_sspeer_selector.c.md#fd_sspeer_selector_join>)
    - [`fd_sspeer_selector_new`](<fd_sspeer_selector.c.md#fd_sspeer_selector_new>)
    - [`test_basic_peer_selection`](<#test_basic_peer_selection>)
    - [`fd_sspeer_selector_delete`](<fd_sspeer_selector.c.md#fd_sspeer_selector_delete>)
    - [`fd_sspeer_selector_leave`](<fd_sspeer_selector.c.md#fd_sspeer_selector_leave>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)