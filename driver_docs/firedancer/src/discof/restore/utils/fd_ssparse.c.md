<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions and structures for parsing and managing sparse data archives in memory.

# Purpose
The code is a C source file that implements a parser for a specific file format, likely a TAR archive, with additional structures and logic to handle specific data types within the archive. The primary structure, `fd_ssparse_private`, maintains the state of the parser, including various flags, version information, and data related to TAR headers and account data. The parser operates in a state machine manner, with defined states such as `FD_SSPARSE_STATE_TAR_HEADER`, `FD_SSPARSE_STATE_VERSION`, and others, to manage the parsing process.

The file provides several functions to initialize, reset, and advance the parser through the data. The [`fd_ssparse_new`](<#fd_ssparse_new>) function initializes a new parser instance, setting up memory and state. The [`fd_ssparse_advance`](<#fd_ssparse_advance>) function is the core of the parser, advancing through the data based on the current state and the input data. It uses helper functions like [`advance_tar`](<#advance_tar>), [`advance_version`](<#advance_version>), and others to handle specific parsing tasks. The code also includes functions to manage account vectors, such as [`fd_ssparse_populate_acc_vec_map`](<#fd_ssparse_populate_acc_vec_map>), which populates a map with account vector data. The parser is designed to handle specific file structures and data, with error handling and logging for invalid states or data.
# Imports and Dependencies

---
- `fd_ssparse.h`
- `../../../util/log/fd_log.h`
- `../../../util/archive/fd_tar.h`
- `../../../flamenco/runtime/fd_runtime_const.h`
- `stdio.h`


# Data Structures

---
### fd\_ssparse\_private
- **Type**: ``struct``
- **Members**:
    - ``state``: Stores the current state of the parsing process.
    - ``batch_enabled``: Indicates if batch processing is enabled.
    - ``flags``: Contains flags for tracking parsing progress.
    - ``version``: Holds the version information as a 5-byte array.
    - ``manifest``: Contains pointers to the account vector map and pool.
    - ``tar``: Stores TAR file header and byte consumption details.
    - ``account``: Holds account header and data consumption details.
    - ``acc_vec_bytes``: Tracks the number of bytes in the account vector.
    - ``slot``: Stores the current slot number.
    - ``bytes_consumed``: Tracks the total number of bytes consumed.
    - ``seed``: Stores the seed value for random operations.
    - ``max_acc_vecs``: Indicates the maximum number of account vectors.
    - ``magic``: Holds a magic number for validation purposes.
- **Description**: The `fd_ssparse_private` structure is used to manage the state and data of a sparse file parsing process. It includes fields for tracking the current state, enabling batch processing, and storing flags for parsing progress. The structure also contains arrays and pointers for handling version information, manifest data, TAR file headers, and account data. Additionally, it tracks byte consumption, slot numbers, and includes a magic number for validation.


# Functions

---
### fd\_ssparse\_align<!-- {{#callable:fd_ssparse_align}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssparse.c#L61>)

Calculates the maximum alignment requirement for `fd_ssparse_t` and associated vector pools and maps.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `fd_ulong_max` to determine the maximum alignment requirement between `alignof(fd_ssparse_t)`, `acc_vec_pool_align()`, and `acc_vec_map_align()`.
- **Output**: Returns the maximum alignment requirement as an `ulong`.


---
### fd\_ssparse\_footprint<!-- {{#callable:fd_ssparse_footprint}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssparse.c#L66>)

Calculates the memory footprint required for a sparse data structure based on the maximum number of accumulator vectors.
- **Inputs**:
    - `max_acc_vecs`: The maximum number of accumulator vectors that the sparse data structure will support.
- **Logic and Control Flow**:
    - Initialize a layout variable `l` with `FD_LAYOUT_INIT`.
    - Append the alignment and size of `fd_ssparse_t` to the layout `l` using `FD_LAYOUT_APPEND`.
    - Append the alignment and footprint of the accumulator vector pool to the layout `l` using `FD_LAYOUT_APPEND`, based on `max_acc_vecs`.
    - Append the alignment and footprint of the accumulator vector map to the layout `l` using `FD_LAYOUT_APPEND`, based on `max_acc_vecs`.
    - Finalize the layout `l` with `FD_LAYOUT_FINI` and return the result.
- **Output**: Returns the total memory footprint in bytes as an `ulong`.
- **Functions Called**:
    - [`fd_ssparse_align`](<#fd_ssparse_align>)


---
### fd\_ssparse\_new<!-- {{#callable:fd_ssparse_new}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssparse.c#L75>)

Initializes a new `fd_ssparse_t` structure in shared memory with specified parameters and returns a pointer to it.
- **Inputs**:
    - ``shmem``: Pointer to the shared memory where the `fd_ssparse_t` structure will be initialized.
    - ``max_acc_vecs``: Maximum number of accumulator vectors to allocate.
    - ``seed``: Seed value for initializing the accumulator vector map.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL; if so, log a warning and return NULL.
    - Check if `shmem` is properly aligned; if not, log a warning and return NULL.
    - Initialize scratch memory allocation with `shmem`.
    - Allocate memory for `fd_ssparse_t`, accumulator vector pool, and accumulator vector map using scratch memory allocation.
    - Initialize the accumulator vector pool and map with the allocated memory and join them to the `fd_ssparse_t` structure.
    - Set the initial state of `fd_ssparse_t` to `FD_SSPARSE_STATE_TAR_HEADER`.
    - Clear the `flags` structure within `fd_ssparse_t`.
    - Initialize various fields of `fd_ssparse_t` to zero or the provided parameters (`seed` and `max_acc_vecs`).
    - Set the `magic` field of `fd_ssparse_t` to `FD_SSPARSE_MAGIC` with memory fence operations to ensure memory ordering.
    - Return a pointer to the initialized `fd_ssparse_t` structure.
- **Output**: A pointer to the newly initialized `fd_ssparse_t` structure, or NULL if initialization fails due to invalid input.
- **Functions Called**:
    - [`fd_ssparse_align`](<#fd_ssparse_align>)


---
### fd\_ssparse\_join<!-- {{#callable:fd_ssparse_join}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssparse.c#L123>)

Validates and returns a pointer to a `fd_ssparse_t` structure if the input is correctly aligned and has the correct magic number.
- **Inputs**:
    - `shssparse`: A pointer to a shared memory region that is expected to contain a `fd_ssparse_t` structure.
- **Logic and Control Flow**:
    - Check if `shssparse` is NULL; if so, log a warning and return NULL.
    - Check if `shssparse` is aligned according to [`fd_ssparse_align`](<#fd_ssparse_align>); if not, log a warning and return NULL.
    - Cast `shssparse` to a `fd_ssparse_t` pointer and store it in `ssparse`.
    - Check if `ssparse->magic` equals `FD_SSPARSE_MAGIC`; if not, log a warning and return NULL.
    - Return the `ssparse` pointer.
- **Output**: A pointer to a `fd_ssparse_t` structure if all checks pass, otherwise NULL.
- **Functions Called**:
    - [`fd_ssparse_align`](<#fd_ssparse_align>)


---
### fd\_ssparse\_reset<!-- {{#callable:fd_ssparse_reset}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssparse.c#L145>)

Resets the `fd_ssparse_t` structure to its initial state.
- **Inputs**:
    - `ssparse`: A pointer to an `fd_ssparse_t` structure that will be reset.
- **Logic and Control Flow**:
    - Set the `state` of `ssparse` to `FD_SSPARSE_STATE_TAR_HEADER`.
    - Clear the `flags` field of `ssparse` using `fd_memset`.
    - Set `bytes_consumed` to 0.
    - Reset the `tar` structure fields: `header_bytes_consumed`, `file_bytes_consumed`, and `file_bytes` to 0.
    - Reset the `account` structure fields: `header_bytes_consumed`, `data_bytes_consumed`, and `data_len` to 0.
    - Set `acc_vec_bytes` to 0.
    - Call `acc_vec_map_reset` on `ssparse->manifest.acc_vec_map`.
    - Call `acc_vec_pool_reset` on `ssparse->manifest.acc_vec_pool`.
- **Output**: No return value; the function operates directly on the `ssparse` structure.


---
### advance\_tar<!-- {{#callable:advance_tar}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssparse.c#L164>)

Processes TAR file data to update the parsing state and validate TAR headers.
- **Inputs**:
    - ``ssparse``: A pointer to an `fd_ssparse_t` structure that maintains the state of the TAR parsing process.
    - ``data``: A pointer to the data buffer containing TAR file data to be processed.
    - ``data_sz``: The size of the data buffer in bytes.
    - ``result``: A pointer to an `fd_ssparse_advance_result_t` structure to store the result of the parsing operation.
- **Logic and Control Flow**:
    - Calculate the number of bytes to consume from `data` and update `ssparse` and `result` accordingly.
    - If the header is not fully consumed (less than 512 bytes), return `FD_SSPARSE_ADVANCE_AGAIN`.
    - Check the TAR header magic for validity; if invalid, check for zero-filled header and handle accordingly.
    - If a valid TAR header is found after a zero frame, log a warning and return an error.
    - Determine the file size from the TAR header and validate it.
    - Check the type of the TAR entry and determine the desired state based on the entry name.
    - Update the `ssparse` state and flags based on the desired state and validate against expected conditions.
    - Return `FD_SSPARSE_ADVANCE_AGAIN` to indicate that more data is needed for further processing.
- **Output**: Returns an integer status code indicating the result of the operation, such as `FD_SSPARSE_ADVANCE_ERROR`, `FD_SSPARSE_ADVANCE_AGAIN`, or `FD_SSPARSE_ADVANCE_DONE`.


---
### advance\_version<!-- {{#callable:advance_version}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssparse.c#L315>)

Processes a version file by consuming data, updating state, and validating the version string.
- **Inputs**:
    - `ssparse`: A pointer to a `fd_ssparse_t` structure that maintains the state and data of the parsing process.
    - `data`: A pointer to the data buffer containing the version information to be processed.
    - `data_sz`: The size of the data buffer in bytes.
    - `result`: A pointer to a `fd_ssparse_advance_result_t` structure where the function stores the number of bytes consumed.
- **Logic and Control Flow**:
    - Calculate the number of bytes to consume using `fd_ulong_min` between `data_sz` and the remaining bytes in the version file.
    - If no bytes can be consumed, return `FD_SSPARSE_ADVANCE_ERROR`.
    - Copy the consumed bytes from `data` to the `version` field in `ssparse`.
    - Update `file_bytes_consumed` and `bytes_consumed` in `ssparse`, and set `result->bytes_consumed` to the number of bytes consumed.
    - If the version file is not fully consumed, return `FD_SSPARSE_ADVANCE_AGAIN`.
    - Verify that the consumed version string matches "1.2.0"; if not, log a warning and return `FD_SSPARSE_ADVANCE_ERROR`.
    - Set the state of `ssparse` to `FD_SSPARSE_STATE_SCROLL_TAR_HEADER` and return `FD_SSPARSE_ADVANCE_AGAIN`.
- **Output**: Returns an integer status code indicating success, need for more data, or an error.


---
### advance\_status\_cache<!-- {{#callable:advance_status_cache}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssparse.c#L343>)

Advances the status cache parsing by consuming data and updating the parsing state.
- **Inputs**:
    - ``ssparse``: A pointer to the `fd_ssparse_t` structure that maintains the parsing state and metadata.
    - ``data``: A pointer to the data buffer containing the status cache data to be processed.
    - ``data_sz``: The size of the data buffer in bytes.
    - ``result``: A pointer to the `fd_ssparse_advance_result_t` structure where the function stores the result of the parsing operation.
- **Logic and Control Flow**:
    - Calculate the number of bytes to consume using `fd_ulong_min` between `data_sz` and the remaining bytes in the file (`ssparse->tar.file_bytes - ssparse->tar.file_bytes_consumed`).
    - If no bytes can be consumed, return `FD_SSPARSE_ADVANCE_ERROR`.
    - Update `ssparse->tar.file_bytes_consumed` and `ssparse->bytes_consumed` by adding the consumed bytes.
    - Set `result->bytes_consumed` to the number of bytes consumed.
    - Set `result->status_cache.data` to the input `data` and `result->status_cache.data_sz` to the number of bytes consumed.
    - If the total consumed bytes are less than the file size, return `FD_SSPARSE_ADVANCE_STATUS_CACHE`.
    - If the total consumed bytes equal the file size, set `ssparse->state` to `FD_SSPARSE_STATE_SCROLL_TAR_HEADER` and return `FD_SSPARSE_ADVANCE_STATUS_CACHE`.
- **Output**: Returns an integer status code indicating the result of the operation, either `FD_SSPARSE_ADVANCE_ERROR` or `FD_SSPARSE_ADVANCE_STATUS_CACHE`.


---
### advance\_manifest<!-- {{#callable:advance_manifest}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssparse.c#L368>)

Advances the parsing of a manifest file within a TAR archive, updating the state and result accordingly.
- **Inputs**:
    - ``ssparse``: A pointer to the `fd_ssparse_t` structure, which maintains the state of the parsing process.
    - ``data``: A pointer to the data buffer containing the manifest data to be processed.
    - ``data_sz``: The size of the data buffer in bytes.
    - ``result``: A pointer to the `fd_ssparse_advance_result_t` structure, which will store the results of the parsing operation.
- **Logic and Control Flow**:
    - Calculate the number of bytes to consume by taking the minimum of `data_sz` and the remaining bytes in the TAR file (`ssparse->tar.file_bytes - ssparse->tar.file_bytes_consumed`).
    - If no bytes can be consumed, return `FD_SSPARSE_ADVANCE_ERROR`.
    - Update `ssparse->tar.file_bytes_consumed` and `ssparse->bytes_consumed` by adding the consumed bytes.
    - Set `result->bytes_consumed` to the number of bytes consumed.
    - Update `result->manifest.data` to point to the input `data` and set `result->manifest.data_sz` to the number of bytes consumed.
    - Copy the `acc_vec_map` and `acc_vec_pool` from `ssparse->manifest` to `result->manifest`.
    - If the file is not fully consumed, return `FD_SSPARSE_ADVANCE_MANIFEST`.
    - If the file is fully consumed, update `ssparse->state` to `FD_SSPARSE_STATE_SCROLL_TAR_HEADER` and return `FD_SSPARSE_ADVANCE_MANIFEST`.
- **Output**: Returns an integer status code indicating the result of the operation, such as `FD_SSPARSE_ADVANCE_MANIFEST` or `FD_SSPARSE_ADVANCE_ERROR`.


---
### advance\_next\_tar<!-- {{#callable:advance_next_tar}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssparse.c#L395>)

Advances the parsing state by skipping padding bytes in a TAR file and updates the parsing state if necessary.
- **Inputs**:
    - `ssparse`: A pointer to the `fd_ssparse_t` structure that maintains the current parsing state and progress.
    - `data`: A pointer to the data buffer, which is not used in this function.
    - `data_sz`: The size of the data buffer, used to determine how many padding bytes can be skipped.
    - `result`: A pointer to the `fd_ssparse_advance_result_t` structure where the function stores the number of bytes consumed.
- **Logic and Control Flow**:
    - Calculate the number of padding bytes remaining to align the consumed bytes to the next 512-byte boundary.
    - Determine the number of padding bytes to skip, which is the minimum of the remaining padding bytes and `data_sz`.
    - If no padding bytes can be skipped and there are still bytes remaining, return `FD_SSPARSE_ADVANCE_ERROR`.
    - Update `ssparse->bytes_consumed` and `result->bytes_consumed` with the number of padding bytes skipped.
    - Subtract the skipped padding bytes from the remaining bytes.
    - If no bytes remain, set the state to `FD_SSPARSE_STATE_TAR_HEADER`.
    - Return `FD_SSPARSE_ADVANCE_AGAIN` to indicate that the parsing should continue.
- **Output**: Returns an integer status code indicating whether the parsing should continue (`FD_SSPARSE_ADVANCE_AGAIN`) or if an error occurred (`FD_SSPARSE_ADVANCE_ERROR`).


---
### advance\_account\_batch<!-- {{#callable:advance_account_batch}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssparse.c#L415>)

Processes account data in batches, ensuring alignment and size constraints are met, and updates the parser state accordingly.
- **Inputs**:
    - ``ssparse``: A pointer to the `fd_ssparse_t` structure, which maintains the state and data of the sparse parser.
    - ``data``: A pointer to the input data buffer containing account information.
    - ``data_sz``: The size of the input data buffer in bytes.
    - ``result``: A pointer to the `fd_ssparse_advance_result_t` structure, which stores the results of the batch processing.
- **Logic and Control Flow**:
    - Checks if the parser is aligned to an account; if not, returns `FD_SSPARSE_ADVANCE_AGAIN`.
    - Calculates available data size and checks if it is sufficient for at least four accounts; if not, returns `FD_SSPARSE_ADVANCE_AGAIN`.
    - Initializes the batch count to zero and iterates over the data to process accounts until the batch is full or data is insufficient.
    - For each account, calculates the size, checks for fragmentation, and validates the account data size.
    - Updates the batch count and stores account headers in the result structure.
    - If the batch count is less than the maximum, returns `FD_SSPARSE_ADVANCE_AGAIN`.
    - Updates the consumed bytes in the `ssparse` structure and the result structure.
    - Resets the parser state to `FD_SSPARSE_STATE_ACCOUNT_PADDING` and sets the slot in the result structure.
    - Returns `FD_SSPARSE_ADVANCE_ACCOUNT_BATCH` to indicate successful batch processing.
- **Output**: Returns an integer status code indicating the result of the batch processing, such as `FD_SSPARSE_ADVANCE_AGAIN` or `FD_SSPARSE_ADVANCE_ACCOUNT_BATCH`.


---
### advance\_account\_header<!-- {{#callable:advance_account_header}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssparse.c#L468>)

Processes account header data from a data stream and updates the parsing state accordingly.
- **Inputs**:
    - ``ssparse``: A pointer to an `fd_ssparse_t` structure that maintains the state of the parsing process.
    - ``data``: A pointer to the data buffer containing the account header information.
    - ``data_sz``: The size of the data buffer in bytes.
    - ``result``: A pointer to an `fd_ssparse_advance_result_t` structure where the function stores the results of the parsing operation.
- **Logic and Control Flow**:
    - Calculate the number of bytes to consume from the data buffer, considering the remaining bytes needed for the account header and the available data size.
    - If no bytes can be consumed, check if the file bytes consumed equals the account vector bytes; if so, set the state to `FD_SSPARSE_STATE_SCROLL_ACCOUNT_GARBAGE` and return `FD_SSPARSE_ADVANCE_AGAIN`, otherwise return `FD_SSPARSE_ADVANCE_ERROR`.
    - If the bytes to consume are less than 136, copy the data to the account header buffer; if batch processing is enabled, attempt to process the batch and return if successful.
    - Update the consumed bytes counters in `ssparse` and `result`.
    - If the account header is not fully consumed, return `FD_SSPARSE_ADVANCE_AGAIN`.
    - Load the account header fields from the data buffer or the account header buffer if fully consumed.
    - Validate the `data_len` and `executable` fields, logging warnings and returning `FD_SSPARSE_ADVANCE_ERROR` if invalid.
    - Update the `result` structure with the parsed account header fields.
    - Set the parsing state to `FD_SSPARSE_STATE_ACCOUNT_DATA` and return `FD_SSPARSE_ADVANCE_ACCOUNT_HEADER`.
- **Output**: Returns an integer indicating the result of the parsing operation, such as `FD_SSPARSE_ADVANCE_AGAIN`, `FD_SSPARSE_ADVANCE_ERROR`, or `FD_SSPARSE_ADVANCE_ACCOUNT_HEADER`.
- **Functions Called**:
    - [`advance_account_batch`](<#advance_account_batch>)


---
### advance\_account\_data<!-- {{#callable:advance_account_data}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssparse.c#L530>)

Advances the account data parsing state by consuming data and updating the parsing result.
- **Inputs**:
    - ``ssparse``: A pointer to the `fd_ssparse_t` structure that maintains the state of the parsing process.
    - ``data``: A pointer to the data buffer containing the account data to be processed.
    - ``data_sz``: The size of the data buffer in bytes.
    - ``result``: A pointer to the `fd_ssparse_advance_result_t` structure where the function stores the result of the parsing operation.
- **Logic and Control Flow**:
    - Check if all account data bytes have been consumed; if so, set the state to `FD_SSPARSE_STATE_ACCOUNT_PADDING` and return `FD_SSPARSE_ADVANCE_AGAIN`.
    - Calculate the number of bytes to consume by taking the minimum of `data_sz` and the remaining bytes in the append vector.
    - If no bytes can be consumed, log a warning and return `FD_SSPARSE_ADVANCE_ERROR`.
    - Update the number of consumed bytes in the `ssparse` structure and the `result` structure.
    - Set the `result->account_data.data_sz` to the number of bytes consumed and `result->account_data.data` to the input data pointer.
    - Verify that the total consumed bytes do not exceed the account data length.
    - If all account data bytes are consumed, set the state to `FD_SSPARSE_STATE_ACCOUNT_PADDING`.
    - Return `FD_SSPARSE_ADVANCE_ACCOUNT_DATA`.
- **Output**: Returns an integer indicating the result of the operation, which can be `FD_SSPARSE_ADVANCE_AGAIN`, `FD_SSPARSE_ADVANCE_ERROR`, or `FD_SSPARSE_ADVANCE_ACCOUNT_DATA`.


---
### advance\_account\_padding<!-- {{#callable:advance_account_padding}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssparse.c#L565>)

Handles the padding of account data to ensure alignment and updates the state of the parser accordingly.
- **Inputs**:
    - `ssparse`: A pointer to the `fd_ssparse_t` structure, which maintains the state of the sparse parser.
    - `data`: A pointer to the data buffer, though it is not used in this function.
    - `data_sz`: The size of the data buffer, used to determine how much padding can be consumed.
    - `result`: A pointer to the `fd_ssparse_advance_result_t` structure, which stores the result of the advance operation, including the number of bytes consumed.
- **Logic and Control Flow**:
    - Calculate the padding size needed to align `ssparse->tar.file_bytes_consumed` to an 8-byte boundary.
    - Determine the minimum of the calculated padding size and the remaining bytes in the account vector (`ssparse->acc_vec_bytes - ssparse->tar.file_bytes_consumed`).
    - If no padding is needed, check if all bytes have been consumed; if so, set the state to `FD_SSPARSE_STATE_SCROLL_TAR_HEADER`, otherwise set it to `FD_SSPARSE_STATE_ACCOUNT_HEADER`, reset `ssparse->account.header_bytes_consumed`, and return `FD_SSPARSE_ADVANCE_AGAIN`.
    - Calculate the number of bytes to consume as the minimum of `data_sz` and the padding size.
    - If no bytes can be consumed, return `FD_SSPARSE_ADVANCE_ERROR`.
    - Update `ssparse->tar.file_bytes_consumed`, `ssparse->bytes_consumed`, and `result->bytes_consumed` by the number of bytes consumed.
    - Calculate the remaining padding needed to align `ssparse->tar.file_bytes_consumed` to an 8-byte boundary.
    - If no remaining padding is needed, reset `ssparse->account.header_bytes_consumed` and set the state to `FD_SSPARSE_STATE_ACCOUNT_HEADER`.
    - Return `FD_SSPARSE_ADVANCE_AGAIN`.
- **Output**: Returns an integer indicating the result of the advance operation, either `FD_SSPARSE_ADVANCE_AGAIN` or `FD_SSPARSE_ADVANCE_ERROR`.


---
### advance\_account\_garbage<!-- {{#callable:advance_account_garbage}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssparse.c#L597>)

Advances the parsing state by consuming a specified amount of data from the account garbage section of a TAR file.
- **Inputs**:
    - ``ssparse``: A pointer to the `fd_ssparse_t` structure, which maintains the state of the parsing process.
    - ``data``: A pointer to the data buffer containing the data to be consumed; however, it is not used in this function.
    - ``data_sz``: The size of the data buffer, indicating the maximum number of bytes that can be consumed.
    - ``result``: A pointer to the `fd_ssparse_advance_result_t` structure, where the function stores the number of bytes consumed.
- **Logic and Control Flow**:
    - Calculate the number of bytes to consume using `fd_ulong_min` between `data_sz` and the remaining bytes in the TAR file (`ssparse->tar.file_bytes - ssparse->tar.file_bytes_consumed`).
    - If no bytes can be consumed (`consume` is zero), return `FD_SSPARSE_ADVANCE_ERROR`.
    - Update `ssparse->tar.file_bytes_consumed`, `ssparse->bytes_consumed`, and `result->bytes_consumed` by adding `consume`.
    - If the total consumed bytes are less than the total file bytes, return `FD_SSPARSE_ADVANCE_AGAIN`.
    - If all bytes are consumed, set the state to `FD_SSPARSE_STATE_SCROLL_TAR_HEADER` and return `FD_SSPARSE_ADVANCE_AGAIN`.
- **Output**: Returns an integer indicating the result of the operation: `FD_SSPARSE_ADVANCE_ERROR` if no bytes are consumed, or `FD_SSPARSE_ADVANCE_AGAIN` if the operation is successful.


---
### fd\_ssparse\_advance<!-- {{#callable:fd_ssparse_advance}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssparse.c#L616>)

Advances the state of the `fd_ssparse_t` parser based on its current state and the provided data.
- **Inputs**:
    - `ssparse`: A pointer to an `fd_ssparse_t` structure representing the current state of the parser.
    - `data`: A pointer to the data buffer to be processed.
    - `data_sz`: The size of the data buffer.
    - `result`: A pointer to an `fd_ssparse_advance_result_t` structure to store the result of the operation.
- **Logic and Control Flow**:
    - Initialize `result->bytes_consumed` to 0.
    - Use a switch statement to determine the current state of `ssparse`.
    - Call the appropriate function to handle the current state, passing `ssparse`, `data`, `data_sz`, and `result` as arguments.
    - If the state is invalid, log an error message and terminate the program.
- **Output**: Returns an integer status code indicating the result of the operation, which varies depending on the specific state handling function called.
- **Functions Called**:
    - [`advance_tar`](<#advance_tar>)
    - [`advance_next_tar`](<#advance_next_tar>)
    - [`advance_version`](<#advance_version>)
    - [`advance_manifest`](<#advance_manifest>)
    - [`advance_account_header`](<#advance_account_header>)
    - [`advance_account_data`](<#advance_account_data>)
    - [`advance_account_padding`](<#advance_account_padding>)
    - [`advance_status_cache`](<#advance_status_cache>)
    - [`advance_account_garbage`](<#advance_account_garbage>)


---
### fd\_ssparse\_batch\_enable<!-- {{#callable:fd_ssparse_batch_enable}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssparse.c#L637>)

Sets the `batch_enabled` flag in the `fd_ssparse_t` structure based on the `enabled` parameter.
- **Inputs**:
    - ``ssparse``: A pointer to an `fd_ssparse_t` structure where the batch mode will be enabled or disabled.
    - ``enabled``: An integer value that determines whether to enable (non-zero) or disable (zero) batch mode.
- **Logic and Control Flow**:
    - Converts the `enabled` integer to a boolean value using the double negation `!!` operator.
    - Assigns the boolean result to the `batch_enabled` field of the `ssparse` structure.
- **Output**: No return value; the function modifies the `batch_enabled` field of the `ssparse` structure in place.


---
### fd\_ssparse\_populate\_acc\_vec\_map<!-- {{#callable:fd_ssparse_populate_acc_vec_map}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssparse.c#L643>)

Populates the accumulator vector map with keys and associated file sizes from given arrays.
- **Inputs**:
    - ``ssparse``: A pointer to an `fd_ssparse_t` structure that contains the accumulator vector map and pool.
    - ``slots``: An array of slot numbers corresponding to each accumulator vector.
    - ``ids``: An array of IDs corresponding to each accumulator vector.
    - ``file_szs``: An array of file sizes corresponding to each accumulator vector.
    - ``cnt``: The number of elements in the `slots`, `ids`, and `file_szs` arrays.
- **Logic and Control Flow**:
    - Iterates over each element in the input arrays up to `cnt`.
    - For each element, creates a key using the current slot and ID.
    - Checks if the key already exists in the accumulator vector map using `acc_vec_map_ele_query`.
    - If the key exists, returns -1 indicating an error.
    - If the key does not exist, acquires a new accumulator vector from the pool using `acc_vec_pool_ele_acquire`.
    - Sets the ID, slot, and file size of the acquired accumulator vector.
    - Inserts the accumulator vector into the map using `acc_vec_map_ele_insert`.
    - Continues the process for all elements in the arrays.
    - Returns 0 upon successful completion of all insertions.
- **Output**: Returns 0 on success, or -1 if a key already exists in the map.



---
Made with ❤️ by [Driver](https://www.driver.ai/)