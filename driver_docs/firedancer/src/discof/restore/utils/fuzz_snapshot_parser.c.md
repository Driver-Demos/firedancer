<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Fuzz testing utilities for snapshot parsing, including custom mutator and input testing functions.

# Purpose
The code is a C source file that implements a custom mutator and test function for use with a fuzzing framework, specifically designed to work with LLVM's libFuzzer. The primary purpose of this code is to generate and test various data inputs for a parser, which is likely part of a larger system dealing with snapshot data in a tar-like format. The code includes functions to initialize the fuzzer, create tar headers, add different types of snapshot chunks, and handle garbage data. It uses randomization to create diverse test cases, which helps in identifying potential vulnerabilities or bugs in the parser.

The [`LLVMFuzzerCustomMutator`](<#llvmfuzzercustommutator>) function is responsible for generating random data inputs, including structured data like version headers, manifests, and account vectors, as well as unstructured random and garbage data. The [`LLVMFuzzerTestOneInput`](<#llvmfuzzertestoneinput>) function tests these inputs against a parser, which is initialized and reset for each test case. The code uses several utility functions and macros from included headers to manage memory, logging, and random number generation. The overall structure supports the creation of a variety of test cases to ensure the robustness of the parser against unexpected or malformed inputs.
# Imports and Dependencies

---
- `fd_ssparse.h`
- `../../../util/fd_util.h`
- `../../../util/archive/fd_tar.h`
- `../../../util/sanitize/fd_fuzz.h`
- `assert.h`
- `stdlib.h`


# Global Variables

---
### parser\_mem
- **Type**: `void *`
- **Description**: A pointer to a memory block used by the parser. It is allocated with a specific alignment and size using `aligned_alloc`.
- **Use**: Used to store and manage memory for the parser operations in the fuzzer initialization.


# Functions

---
### LLVMFuzzerInitialize<!-- {{#callable:LLVMFuzzerInitialize}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fuzz_snapshot_parser.c#L14>)

Initializes the fuzzer environment by setting up logging, memory allocation, and exit handlers.
- **Inputs**:
    - `argc`: A pointer to the argument count, typically from the command line.
    - `argv`: A pointer to the argument vector, typically from the command line.
- **Logic and Control Flow**:
    - Sets the environment variable `FD_LOG_BACKTRACE` to `0` to disable backtrace logging.
    - Calls `fd_boot` to initialize the system with the provided `argc` and `argv`.
    - Registers `fd_halt` to be called on program exit using `atexit`.
    - Sets the core and logfile log levels to `4` using `fd_log_level_core_set` and `fd_log_level_logfile_set`.
    - Allocates aligned memory for `parser_mem` using `aligned_alloc` with alignment and size determined by [`fd_ssparse_align`](<fd_ssparse.c.md#fd_ssparse_align>) and [`fd_ssparse_footprint`](<fd_ssparse.c.md#fd_ssparse_footprint>).
    - Asserts that `parser_mem` is successfully allocated.
- **Output**: Returns `0` to indicate successful initialization.
- **Functions Called**:
    - [`fd_ssparse_align`](<fd_ssparse.c.md#fd_ssparse_align>)
    - [`fd_ssparse_footprint`](<fd_ssparse.c.md#fd_ssparse_footprint>)


---
### make\_tar\_hdr<!-- {{#callable:make_tar_hdr}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fuzz_snapshot_parser.c#L30>)

Creates a TAR header in the provided data buffer with specified file name and size.
- **Inputs**:
    - ``data``: A pointer to a buffer where the TAR header will be created.
    - ``name``: A constant character pointer representing the name of the file to be included in the TAR header.
    - ``name_sz``: An unsigned long integer representing the size of the file name.
    - ``file_sz``: An unsigned long integer representing the size of the file to be included in the TAR header.
- **Logic and Control Flow**:
    - Cast the `data` buffer to a `fd_tar_meta_t` structure pointer named `tar`.
    - Mutate the `data` buffer using `LLVMFuzzerMutate` to introduce random changes within the size of `fd_tar_meta_t`.
    - Copy the TAR magic number `FD_TAR_MAGIC` into the `magic` field of the `tar` structure.
    - Copy the file name from `name` into the `name` field of the `tar` structure using `fd_memcpy`.
    - Set the file size in the `tar` structure using `fd_tar_meta_set_size`.
    - Set the `typeflag` field of the `tar` structure to `FD_TAR_TYPE_REGULAR` to indicate a regular file.
- **Output**: No return value; the function modifies the `data` buffer in place to contain the TAR header.


---
### add\_snapshot\_chunk<!-- {{#callable:add_snapshot_chunk}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fuzz_snapshot_parser.c#L43>)

Adds a snapshot chunk to a data buffer, updating the offset and available space, and returns 0 if successful or mutates the data if space is insufficient.
- **Inputs**:
    - `data`: A pointer to the data buffer where the snapshot chunk will be added.
    - `offset`: A pointer to the current offset in the data buffer, which will be updated.
    - `avail`: A pointer to the available space in the data buffer, which will be updated.
    - `name`: A constant character pointer representing the name of the snapshot chunk.
    - `name_sz`: The size of the name of the snapshot chunk.
    - `file_sz`: The size of the file to be added as a snapshot chunk.
- **Logic and Control Flow**:
    - Check if the available space is less than the size of a tar header plus the file size; if true, mutate the data and return the result.
    - Create a tar header at the current offset using [`make_tar_hdr`](<#make_tar_hdr>), then update the offset and available space by the size of the tar header.
    - Mutate the data for the file size at the current offset, then update the offset and available space by the file size.
    - Calculate the padding needed to align the offset to 512 bytes, and check if the available space is less than the padding; if true, mutate the data and return the result.
    - Mutate the data for the padding at the current offset, then update the offset and available space by the padding.
    - Return 0 to indicate successful addition of the snapshot chunk.
- **Output**: Returns 0 if the snapshot chunk is successfully added, or the result of `LLVMFuzzerMutate` if there is insufficient space.
- **Functions Called**:
    - [`make_tar_hdr`](<#make_tar_hdr>)


---
### make\_version<!-- {{#callable:make_version}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fuzz_snapshot_parser.c#L71>)

Creates a version tar header in the provided data buffer, potentially mutating it based on random conditions.
- **Inputs**:
    - ``data``: Pointer to the data buffer where the version tar header will be created.
    - ``rng``: Pointer to the random number generator used for random decisions.
    - ``offset``: Pointer to the current offset in the data buffer, which will be updated.
    - ``avail``: Pointer to the available space in the data buffer, which will be updated.
- **Logic and Control Flow**:
    - Initialize `file_sz` to 5UL and determine if a wrong version size should be used, potentially increasing `file_sz`.
    - Check if available space is less than the required size for a tar header and `file_sz`; if so, mutate the data and return.
    - Create a tar header with the name 'version' and update `offset` and `avail`.
    - Determine if a random version should be used; if so, mutate the data, otherwise write the version '1.2.0' to the data buffer.
    - Calculate padding needed to align to 512 bytes, check if available space is sufficient, and mutate the data if not.
    - Apply padding to the data buffer, update `offset` and `avail`, and return 0.
- **Output**: Returns 0 if successful, or the result of `LLVMFuzzerMutate` if there is insufficient space.
- **Functions Called**:
    - [`make_tar_hdr`](<#make_tar_hdr>)


---
### add\_garbage<!-- {{#callable:add_garbage}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fuzz_snapshot_parser.c#L106>)

Mutates a specified portion of data and adjusts offset and available space, adding padding if necessary.
- **Inputs**:
    - `data`: Pointer to the data buffer to mutate.
    - `offset`: Pointer to the current offset in the data buffer, which will be updated.
    - `avail`: Pointer to the available space in the data buffer, which will be updated.
    - `file_sz`: Size of the file to consider for mutation.
- **Logic and Control Flow**:
    - Calculate `byte_to_mutate` as the minimum of `sizeof(fd_tar_meta_t) + file_sz` and `*avail`.
    - Call `LLVMFuzzerMutate` to mutate `byte_to_mutate` bytes starting from `data + *offset`.
    - Update `*offset` by adding `byte_to_mutate`.
    - Update `*avail` by subtracting `byte_to_mutate`.
    - Calculate `padding` needed to align `*offset` to the next 512-byte boundary.
    - If `*avail` is less than `padding`, call `LLVMFuzzerMutate` to mutate the remaining available bytes and return.
    - Otherwise, call `LLVMFuzzerMutate` to mutate `padding` bytes starting from `data + *offset`.
    - Update `*offset` by adding `padding`.
    - Update `*avail` by subtracting `padding`.
- **Output**: Returns 0 after mutating the data and adjusting the offset and available space.


---
### LLVMFuzzerCustomMutator<!-- {{#callable:LLVMFuzzerCustomMutator}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fuzz_snapshot_parser.c#L135>)

Mutates input data to create a structured fuzzing input with random snapshot chunks and tar headers.
- **Inputs**:
    - `data`: Pointer to the input data buffer to be mutated.
    - `size`: Current size of the input data buffer, which is not used in the function.
    - `max_size`: Maximum allowable size for the mutated data buffer.
    - `seed`: Seed for the random number generator to ensure reproducibility of mutations.
- **Logic and Control Flow**:
    - Initialize a random number generator with the given seed.
    - Calculate the number of account vectors (`acc_vec_cnt`) and their properties (`slots`, `ids`, `file_szs`).
    - Check if there is enough space to store the account vector count and their properties; if not, call `LLVMFuzzerMutate` to mutate the data.
    - Store the account vector count and properties in the data buffer.
    - Align the data to 512 bytes and adjust available space accordingly.
    - Determine if random snapshot chunks should be included using a random decision.
    - If including random snapshot chunks, repeatedly select a snapshot chunk type and process it until space is insufficient or all chunks are processed.
    - If not including random snapshot chunks, create a version tar header, status cache, manifest, and account vectors, possibly including garbage data.
    - Ensure the data ends with a zero tar frame and optionally a valid tar header.
    - Return the final offset as the size of the mutated data.
- **Output**: Returns the final offset, which represents the size of the mutated data buffer.
- **Functions Called**:
    - [`make_version`](<#make_version>)
    - [`add_snapshot_chunk`](<#add_snapshot_chunk>)
    - [`add_garbage`](<#add_garbage>)
    - [`make_tar_hdr`](<#make_tar_hdr>)


---
### LLVMFuzzerTestOneInput<!-- {{#callable:LLVMFuzzerTestOneInput}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fuzz_snapshot_parser.c#L300>)

Processes input data to parse and advance through a sparse data structure, returning 0 on success or -1 on error.
- **Inputs**:
    - `data`: A pointer to the input data buffer, which is a constant unsigned character array.
    - `size`: The size of the input data buffer, given as a constant unsigned long integer.
- **Logic and Control Flow**:
    - Create a new sparse parser using [`fd_ssparse_new`](<fd_ssparse.c.md#fd_ssparse_new>) with predefined memory and parameters.
    - Check if the parser is successfully created using `assert`.
    - Reset the parser using [`fd_ssparse_reset`](<fd_ssparse.c.md#fd_ssparse_reset>).
    - Check if the input size is less than the size of an unsigned long; if true, return -1.
    - Extract the number of access vectors (`acc_vec_cnt`) from the input data.
    - Check if `acc_vec_cnt` exceeds `MAX_ACC_VEC_CNT`; if true, return -1.
    - Calculate the offset to padding based on `acc_vec_cnt` and check if the input size is less than this offset; if true, return -1.
    - Initialize arrays `slots`, `ids`, and `file_szs` to store access vector information.
    - Populate these arrays by extracting data from the input buffer.
    - Populate the access vector map in the parser using [`fd_ssparse_populate_acc_vec_map`](<fd_ssparse.c.md#fd_ssparse_populate_acc_vec_map>); if it fails, return -1.
    - Calculate the offset to the actual input data, aligning it to 512 bytes, and check if the input size is less than this offset; if true, return -1.
    - Initialize a result structure for advancing the parser.
    - Iterate over the input data, advancing the parser with [`fd_ssparse_advance`](<fd_ssparse.c.md#fd_ssparse_advance>) until it returns `FD_SSPARSE_ADVANCE_DONE` or `FD_SSPARSE_ADVANCE_ERROR`.
    - Adjust the data pointer and size based on the bytes consumed in each iteration.
- **Output**: Returns 0 on successful processing of the input data or -1 if an error occurs during parsing or validation.
- **Functions Called**:
    - [`fd_ssparse_new`](<fd_ssparse.c.md#fd_ssparse_new>)
    - [`fd_ssparse_reset`](<fd_ssparse.c.md#fd_ssparse_reset>)
    - [`fd_ssparse_populate_acc_vec_map`](<fd_ssparse.c.md#fd_ssparse_populate_acc_vec_map>)
    - [`fd_ssparse_advance`](<fd_ssparse.c.md#fd_ssparse_advance>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)