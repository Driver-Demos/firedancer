<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions to recover blockhashes and restore bank state from a snapshot manifest in the Firedancer codebase.

# Purpose
The code is a C source file that provides functionality for recovering and initializing blockchain-related data structures from a snapshot manifest. It includes two main functions: [`blockhashes_recover`](<#blockhashes_recover>) and [`fd_ssload_recover`](<#fd_ssload_recover>). The [`blockhashes_recover`](<#blockhashes_recover>) function initializes and populates a blockhash queue from a given array of blockhashes, ensuring that the sequence of hash indices is gapless and does not wrap around. It also handles potential errors related to sequence number wraparound and duplicate indices.

The [`fd_ssload_recover`](<#fd_ssload_recover>) function is responsible for setting up various components of a blockchain bank from a snapshot manifest. It configures the bank's slot, hash, fee rate governor, inflation parameters, epoch schedule, rent, and other attributes. It also manages the recovery of blockhashes, vote states, and stake delegations for different epochs. The function ensures that the bank's state is consistent with the snapshot data, updating various parameters and structures to reflect the current and previous epochs' stakes and vote states. This code is part of a larger system that deals with blockchain state management and recovery.
# Imports and Dependencies

---
- `fd_ssload.h`
- `../../../flamenco/runtime/sysvar/fd_sysvar_epoch_schedule.h`
- `fd_ssmsg.h`


# Functions

---
### blockhashes\_recover<!-- {{#callable:blockhashes_recover}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssload.c#L6>)

Recovers blockhashes from a snapshot manifest and initializes them in a blockhash queue.
- **Inputs**:
    - `blockhashes`: A pointer to an `fd_blockhashes_t` structure where the blockhashes will be initialized.
    - `ages`: A pointer to an array of `fd_snapshot_manifest_blockhash_t` structures containing the blockhash data to recover.
    - `age_cnt`: The number of blockhash entries in the `ages` array.
    - `seed`: A seed value used for initializing the blockhashes.
- **Logic and Control Flow**:
    - Initialize the `blockhashes` structure with the given `seed` and verify `age_cnt` is within valid limits.
    - Determine the minimum sequence number (`seq_min`) from the `hash_index` fields in the `ages` array.
    - Calculate the maximum sequence number (`seq_max`) and check for overflow, logging an error if detected.
    - Reset the blockhash queue by pushing empty elements to the deque for each entry in `ages`.
    - For each entry in `ages`, calculate its index in the deque, checking for overflow and logging an error if detected.
    - Verify that the calculated index does not already exist in the deque, logging an error if a duplicate is found.
    - Copy the blockhash and fee calculator data from each `ages` entry to the corresponding deque element.
    - Insert the index into the blockhash map.
- **Output**: No return value; the function modifies the `blockhashes` structure in place.


---
### fd\_ssload\_recover<!-- {{#callable:fd_ssload_recover}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssload.c#L59>)

Restores the state of a bank from a snapshot manifest, updating various bank parameters and vote states.
- **Inputs**:
    - ``manifest``: A pointer to an `fd_snapshot_manifest_t` structure containing the snapshot data to recover the bank state.
    - ``banks``: A pointer to an `fd_banks_t` structure representing the collection of banks.
    - ``bank``: A pointer to an `fd_bank_t` structure representing the bank to be recovered.
    - ``vote_state_credits``: A pointer to an `fd_vote_state_credits_t` structure to store vote state credits for the previous epoch.
- **Logic and Control Flow**:
    - Set the bank's slot and parent slot using values from the `manifest`.
    - Copy the bank hash and parent bank hash from the `manifest` to the bank.
    - Modify the bank's fee rate governor and set its parameters from the `manifest`.
    - Modify the bank's inflation parameters and set them from the `manifest`.
    - Modify the bank's epoch schedule and set its parameters from the `manifest`.
    - Calculate the current epoch from the slot and set it in the bank.
    - Modify the bank's rent parameters and set them from the `manifest`.
    - Set the bank's hashes per tick, using a default if not specified in the `manifest`.
    - Modify the bank's long-term hash and set it from the `manifest`, or zero it if not specified.
    - Recover blockhashes from the `manifest` and set them in the bank's block hash queue.
    - Set the bank's Proof of History (PoH) using the last blockhash if available.
    - Set various bank parameters such as capitalization, lamports per signature, transaction count, tick height, and others from the `manifest`.
    - Determine the last restart slot from the `manifest`'s hard forks and set it in the bank.
    - Query stake delegations for the current epoch and update them from the `manifest`.
    - Join and update vote stakes for the previous epoch (E-1) using data from the `manifest`.
    - Set the total epoch stake for the previous epoch using data from the `manifest`.
    - Join and update vote stakes for the previous epoch (E-2) using data from the `manifest`.
    - Join and update vote states for the current epoch using data from the `manifest`.
    - Set the bank's transaction cache fork ID from the `manifest`.
- **Output**: No return value; the function modifies the state of the `bank` and related structures in place.
- **Functions Called**:
    - [`blockhashes_recover`](<#blockhashes_recover>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)