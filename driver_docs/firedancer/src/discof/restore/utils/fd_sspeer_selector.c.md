<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a peer selector with data structures for managing peers, including scoring and selection logic.

# Purpose
The code defines a module for managing and selecting peers based on their network performance metrics, such as latency and slot information. It uses data structures like pools, maps, and treaps to efficiently manage and score peers. The primary data structure is `fd_sspeer_selector_t`, which holds references to these data structures and manages the state of peer selection. The module provides functions to create, join, leave, and delete a peer selector, as well as to add, remove, and update peers within the selector. It also includes functionality to calculate and update peer scores based on latency and slot information, and to select the best peer based on these scores.

The code includes several macros and templates to define and manage the underlying data structures, such as `fd_pool`, `fd_map_chain`, and `fd_treap`, which are used to implement the pool, map, and treap functionalities, respectively. The module is designed to be used in a networked environment where peers are selected based on their performance metrics, and it provides a public API for interacting with the peer selector. The code ensures alignment and memory management through functions like [`fd_sspeer_selector_align`](<#fd_sspeer_selector_align>) and [`fd_sspeer_selector_footprint`](<#fd_sspeer_selector_footprint>), and it uses a magic number to verify the integrity of the selector instances.
# Imports and Dependencies

---
- `fd_sspeer_selector.h`
- `../../../util/tmpl/fd_pool.c`
- `../../../util/tmpl/fd_map_chain.c`
- `../../../util/tmpl/fd_treap.c`


# Data Structures

---
### fd\_sspeer\_private
- **Type**: ``struct``
- **Members**:
    - ``addr``: Stores the IP address and port of the peer.
    - ``ssinfo``: Holds session information for the peer.
    - ``latency``: Represents the latency of the peer.
    - ``score``: Indicates the score of the peer based on latency and session information.
    - ``pool``: Contains a single member `next` for pool management.
    - ``map``: Contains `next` and `prev` for mapping management.
    - ``score_treap``: Contains `parent`, `left`, `right`, and `prio` for treap management based on score.
- **Description**: The `fd_sspeer_private` structure is used to manage peer information in a network context, including address, session details, latency, and a calculated score. It also includes nested structures for managing the peer in a pool, a map, and a score-based treap, which are used for efficient data organization and retrieval.


---
### fd\_sspeer\_private\_t
- **Type**: ``struct``
- **Members**:
    - ``addr``: Stores the IP address and port of the peer.
    - ``ssinfo``: Holds session information for the peer.
    - ``latency``: Represents the latency of the peer.
    - ``score``: Indicates the score of the peer based on latency and session information.
    - ``pool.next``: Points to the next element in the pool.
    - ``map.next``: Points to the next element in the map.
    - ``map.prev``: Points to the previous element in the map.
    - ``score_treap.parent``: Points to the parent node in the score treap.
    - ``score_treap.left``: Points to the left child node in the score treap.
    - ``score_treap.right``: Points to the right child node in the score treap.
    - ``score_treap.prio``: Stores the priority of the node in the score treap.
- **Description**: `fd_sspeer_private_t` is a `struct` that encapsulates information about a peer, including its address, session information, latency, and score. It also includes fields for managing the peer within a pool, a map, and a score treap, which are used for efficient storage and retrieval operations. The `pool`, `map`, and `score_treap` fields facilitate the organization of peers in different data structures for optimized access and manipulation.


---
### fd\_sspeer\_selector\_private
- **Type**: ``struct``
- **Members**:
    - `pool`: Pointer to a pool of `fd_sspeer_private_t` structures.
    - `map`: Pointer to a `peer_map_t` structure for managing peer mappings.
    - `score_treap`: Pointer to a `score_treap_t` structure for managing peer scores.
    - `shadow_score_treap`: Pointer to a secondary `score_treap_t` structure for managing peer scores.
    - `peer_idx_list`: Pointer to a list of peer indices.
    - `cluster_slot`: `fd_sscluster_slot_t` structure representing the cluster slot information.
    - `incremental_snapshot_fetch`: Integer flag indicating if incremental snapshot fetch is enabled.
    - `magic`: Unsigned long integer used for validation, expected to be `FD_SSPEER_SELECTOR_MAGIC`.
- **Description**: Manages peer selection by maintaining pools, maps, and treaps for peer data, scores, and indices, and includes mechanisms for snapshot fetching and validation.


# Functions

---
### fd\_sspeer\_selector\_align<!-- {{#callable:fd_sspeer_selector_align}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sspeer_selector.c#L77>)

Determines the maximum alignment requirement among several data structures and types used in the `fd_sspeer_selector` module.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `fd_ulong_max` to find the maximum alignment requirement among `alignof(fd_sspeer_selector_t)`, `peer_pool_align()`, `score_treap_align()`, and `alignof(ulong)`.
- **Output**: Returns the maximum alignment requirement as an `ulong` value.


---
### fd\_sspeer\_selector\_footprint<!-- {{#callable:fd_sspeer_selector_footprint}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sspeer_selector.c#L82>)

Calculates the memory footprint required for a peer selector structure based on the maximum number of peers.
- **Inputs**:
    - `max_peers`: The maximum number of peers that the selector will manage.
- **Logic and Control Flow**:
    - Initialize the layout variable `l` with `FD_LAYOUT_INIT`.
    - Append the size and alignment of `fd_sspeer_selector_t` to `l`.
    - Append the size and alignment of the peer pool, calculated for `2 * max_peers`, to `l`.
    - Append the size and alignment of the peer map, calculated for `2 * max_peers`, to `l`.
    - Append the size and alignment of the score treap, calculated for `max_peers`, to `l` twice.
    - Append the size and alignment of an array of `ulong` for `max_peers` elements to `l`.
    - Finalize the layout with `FD_LAYOUT_FINI` and return the total footprint.
- **Output**: Returns the total memory footprint in bytes as an `ulong`.
- **Functions Called**:
    - [`fd_sspeer_selector_align`](<#fd_sspeer_selector_align>)


---
### fd\_sspeer\_selector\_new<!-- {{#callable:fd_sspeer_selector_new}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sspeer_selector.c#L95>)

Initializes a new `fd_sspeer_selector_t` structure in shared memory with specified parameters and returns a pointer to it.
- **Inputs**:
    - `shmem`: Pointer to shared memory where the selector will be initialized.
    - `max_peers`: Maximum number of peers that the selector can handle.
    - `incremental_snapshot_fetch`: Flag indicating whether incremental snapshot fetching is enabled.
    - `seed`: Seed value for initializing the peer map.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL; if so, log a warning and return NULL.
    - Check if `shmem` is aligned according to [`fd_sspeer_selector_align`](<#fd_sspeer_selector_align>); if not, log a warning and return NULL.
    - Check if `max_peers` is less than 1; if so, log a warning and return NULL.
    - Initialize scratch memory allocation with `shmem`.
    - Allocate memory for `fd_sspeer_selector_t`, peer pool, peer map, score treap, shadow score treap, and peer index list using `FD_SCRATCH_ALLOC_APPEND`.
    - Initialize the `selector` structure with the allocated memory and join the peer pool, peer map, and score treaps.
    - Set `cluster_slot.full` and `cluster_slot.incremental` to 0, and `incremental_snapshot_fetch` to the provided value.
    - Set the `magic` field of the selector to `FD_SSPEER_SELECTOR_MAGIC` using memory fences for synchronization.
    - Return a pointer to the initialized `selector`.
- **Output**: Returns a pointer to the newly initialized `fd_sspeer_selector_t` structure, or NULL if initialization fails.
- **Functions Called**:
    - [`fd_sspeer_selector_align`](<#fd_sspeer_selector_align>)


---
### fd\_sspeer\_selector\_join<!-- {{#callable:fd_sspeer_selector_join}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sspeer_selector.c#L140>)

Validates and returns a pointer to a `fd_sspeer_selector_t` structure if the input is correctly aligned and has the correct magic number.
- **Inputs**:
    - `shselector`: A pointer to a shared memory region that is expected to contain a `fd_sspeer_selector_t` structure.
- **Logic and Control Flow**:
    - Check if `shselector` is NULL; if so, log a warning and return NULL.
    - Check if `shselector` is aligned according to [`fd_sspeer_selector_align`](<#fd_sspeer_selector_align>); if not, log a warning and return NULL.
    - Cast `shselector` to a `fd_sspeer_selector_t` pointer.
    - Check if the `magic` field of the `selector` is equal to `FD_SSPEER_SELECTOR_MAGIC`; if not, log a warning and return NULL.
    - Return the `selector` pointer.
- **Output**: A pointer to a `fd_sspeer_selector_t` structure if all checks pass, otherwise NULL.
- **Functions Called**:
    - [`fd_sspeer_selector_align`](<#fd_sspeer_selector_align>)


---
### fd\_sspeer\_selector\_leave<!-- {{#callable:fd_sspeer_selector_leave}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sspeer_selector.c#L162>)

Leaves the `fd_sspeer_selector_t` structure by detaching its components and returning the selector.
- **Inputs**:
    - `selector`: A pointer to the `fd_sspeer_selector_t` structure to leave.
- **Logic and Control Flow**:
    - Check if `selector` is NULL; if true, log a warning and return NULL.
    - Check if `selector` is misaligned; if true, log a warning and return NULL.
    - Check if `selector->magic` is not equal to `FD_SSPEER_SELECTOR_MAGIC`; if true, log a warning and return NULL.
    - Call `peer_pool_leave` on `selector->pool` and update `selector->pool`.
    - Call `peer_map_leave` on `selector->map` and update `selector->map`.
    - Call `score_treap_leave` on `selector->score_treap` and update `selector->score_treap`.
    - Call `score_treap_leave` on `selector->shadow_score_treap` and update `selector->shadow_score_treap`.
    - Return the `selector` cast to a `void *`.
- **Output**: Returns a `void *` pointer to the `selector` if successful, or NULL if any checks fail.
- **Functions Called**:
    - [`fd_sspeer_selector_align`](<#fd_sspeer_selector_align>)


---
### fd\_sspeer\_selector\_delete<!-- {{#callable:fd_sspeer_selector_delete}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sspeer_selector.c#L187>)

Deletes a `fd_sspeer_selector_t` object by validating its alignment and magic number, then deallocating its resources.
- **Inputs**:
    - `shselector`: A pointer to the shared memory selector object to delete.
- **Logic and Control Flow**:
    - Check if `shselector` is NULL; if so, log a warning and return NULL.
    - Check if `shselector` is aligned according to [`fd_sspeer_selector_align`](<#fd_sspeer_selector_align>); if not, log a warning and return NULL.
    - Cast `shselector` to a `fd_sspeer_selector_t` pointer named `selector`.
    - Check if `selector->magic` is equal to `FD_SSPEER_SELECTOR_MAGIC`; if not, log a warning and return NULL.
    - Delete the `pool`, `map`, `score_treap`, and `shadow_score_treap` resources associated with `selector`.
    - Set `selector->magic` to 0 using memory fences to ensure proper ordering.
    - Return the `selector` pointer.
- **Output**: A pointer to the deleted `fd_sspeer_selector_t` object, or NULL if an error occurred.
- **Functions Called**:
    - [`fd_sspeer_selector_align`](<#fd_sspeer_selector_align>)


---
### fd\_sspeer\_selector\_score<!-- {{#callable:fd_sspeer_selector_score}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sspeer_selector.c#L219>)

Calculates a score for a peer based on its latency and slot information.
- **Inputs**:
    - ``selector``: A pointer to an `fd_sspeer_selector_t` structure that contains the cluster slot information.
    - ``peer_latency``: The latency of the peer, with a default value of `DEFAULT_PEER_LATENCY` if set to `ULONG_MAX`.
    - ``ssinfo``: A pointer to a constant `fd_ssinfo_t` structure containing the peer's slot information.
- **Logic and Control Flow**:
    - Initialize `slots_behind_penalty` to 1000 and set `slot` to `ULONG_MAX` and `slots_behind` to `DEFAULT_SLOTS_BEHIND`.
    - If `peer_latency` is `ULONG_MAX`, set it to `DEFAULT_PEER_LATENCY`.
    - Check if `ssinfo` is not null and `ssinfo->full.slot` is not `ULONG_MAX`.
    - If `ssinfo->incremental.slot` is `ULONG_MAX`, set `slot` to `ssinfo->full.slot` and calculate `slots_behind` using `selector->cluster_slot.full`.
    - Otherwise, set `slot` to `ssinfo->incremental.slot` and calculate `slots_behind` using `selector->cluster_slot.incremental`.
    - Return the sum of `peer_latency` and the product of `slots_behind_penalty` and `slots_behind`.
- **Output**: Returns an `ulong` representing the calculated score for the peer.


---
### fd\_sspeer\_selector\_update<!-- {{#callable:fd_sspeer_selector_update}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sspeer_selector.c#L243>)

Updates a peer's score and information in the selector based on new latency and ssinfo values.
- **Inputs**:
    - ``selector``: A pointer to the `fd_sspeer_selector_t` structure that manages the peer selection.
    - ``peer``: A pointer to the `fd_sspeer_private_t` structure representing the peer to update.
    - ``latency``: The new latency value for the peer, or `ULONG_MAX` if the latency should not be updated.
    - ``ssinfo``: A pointer to the new `fd_ssinfo_t` structure for the peer, or `NULL` if the ssinfo should not be updated.
- **Logic and Control Flow**:
    - Remove the peer from the `score_treap` using `score_treap_ele_remove`.
    - Determine the effective latency to use, which is the provided `latency` if it is not `ULONG_MAX`, otherwise the peer's current latency.
    - Determine the effective `ssinfo` to use, which is the provided `ssinfo` if it is not `NULL`, otherwise the peer's current `ssinfo`.
    - Calculate the peer's new score using [`fd_sspeer_selector_score`](<#fd_sspeer_selector_score>) with the effective latency and `ssinfo`.
    - If `ssinfo` is provided, update the peer's `ssinfo` with the new value.
    - If `latency` is not `ULONG_MAX`, update the peer's latency with the new value.
    - Reinsert the peer into the `score_treap` using `score_treap_ele_insert`.
- **Output**: No return value; the function updates the peer's score and information in place.
- **Functions Called**:
    - [`fd_sspeer_selector_score`](<#fd_sspeer_selector_score>)


---
### fd\_sspeer\_selector\_add<!-- {{#callable:fd_sspeer_selector_add}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sspeer_selector.c#L266>)

Adds or updates a peer in the selector with the given address, latency, and snapshot information, and returns the peer's score.
- **Inputs**:
    - `selector`: A pointer to the `fd_sspeer_selector_t` structure that manages the peer selection.
    - `addr`: The IP address and port of the peer to add or update.
    - `latency`: The latency value associated with the peer.
    - `ssinfo`: A pointer to the `fd_ssinfo_t` structure containing snapshot information for the peer.
- **Logic and Control Flow**:
    - Query the peer map for an existing peer with the given address.
    - If the peer exists, update its latency and snapshot information using [`fd_sspeer_selector_update`](<#fd_sspeer_selector_update>).
    - If the peer does not exist, check if there is space in the peer pool; if not, return `ULONG_MAX`.
    - Acquire a new peer element from the pool and initialize it with the provided address, latency, and snapshot information.
    - Calculate the peer's score using [`fd_sspeer_selector_score`](<#fd_sspeer_selector_score>) and insert the peer into the peer map and score treap.
    - Return the peer's score.
- **Output**: The function returns the score of the peer as an `ulong`. If the peer cannot be added due to lack of space, it returns `ULONG_MAX`.
- **Functions Called**:
    - [`fd_sspeer_selector_update`](<#fd_sspeer_selector_update>)
    - [`fd_sspeer_selector_score`](<#fd_sspeer_selector_score>)


---
### fd\_sspeer\_selector\_remove<!-- {{#callable:fd_sspeer_selector_remove}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sspeer_selector.c#L296>)

Removes a peer from the selector based on its address.
- **Inputs**:
    - `selector`: A pointer to the `fd_sspeer_selector_t` structure, which manages the peer selection.
    - `addr`: The `fd_ip4_port_t` address of the peer to remove from the selector.
- **Logic and Control Flow**:
    - Query the peer map using `peer_map_ele_query` to find the peer associated with the given address.
    - If the peer is not found, exit the function.
    - Remove the peer from the score treap using `score_treap_ele_remove`.
    - Remove the peer from the peer map using `peer_map_ele_remove_fast`.
    - Release the peer back to the pool using `peer_pool_ele_release`.
- **Output**: No output is returned; the function performs operations to remove a peer from the selector.


---
### fd\_sspeer\_selector\_best<!-- {{#callable:fd_sspeer_selector_best}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sspeer_selector.c#L307>)

Selects the best peer from a score treap based on given criteria.
- **Inputs**:
    - ``selector``: A pointer to an `fd_sspeer_selector_t` structure that contains the score treap and pool of peers.
    - ``incremental``: An integer flag indicating whether to consider incremental base slots.
    - ``base_slot``: An unsigned long integer representing the base slot to match when `incremental` is true.
- **Logic and Control Flow**:
    - If `incremental` is true, check that `base_slot` is not `ULONG_MAX` using `FD_TEST` macro.
    - Initialize a forward iterator for the score treap using `score_treap_fwd_iter_init`.
    - Iterate over the score treap using a forward iterator until `score_treap_fwd_iter_done` returns true.
    - For each peer, check if the peer's `ssinfo.full.slot` is not `ULONG_MAX` and if `incremental` is false or the peer's `ssinfo.incremental.base_slot` matches `base_slot`.
    - If a peer meets the criteria, return a new `fd_sspeer_t` structure with the peer's address, `ssinfo`, and score.
    - If no peer meets the criteria, return a default `fd_sspeer_t` structure with `addr` set to zero, `ssinfo` slots set to `ULONG_MAX`, and `score` set to `ULONG_MAX`.
- **Output**: An `fd_sspeer_t` structure representing the best peer found, or a default structure if no suitable peer is found.


---
### fd\_sspeer\_selector\_process\_cluster\_slot<!-- {{#callable:fd_sspeer_selector_process_cluster_slot}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sspeer_selector.c#L337>)

Updates the cluster slot information and rescales peer scores based on the new slot values.
- **Inputs**:
    - ``selector``: A pointer to the `fd_sspeer_selector_t` structure that manages peer selection and scoring.
    - ``full_slot``: An unsigned long integer representing the full slot value to process.
    - ``incremental_slot``: An unsigned long integer representing the incremental slot value to process.
- **Logic and Control Flow**:
    - Return immediately if both `full_slot` and `incremental_slot` are `ULONG_MAX`.
    - Assert that `full_slot` is not `ULONG_MAX`.
    - If `incremental_snapshot_fetch` is true, check conditions to return early based on the relationship between `incremental_slot`, `full_slot`, and the current cluster slot values.
    - If `incremental_snapshot_fetch` is false, return early if `full_slot` is less than or equal to the current cluster full slot.
    - Update the `selector`'s cluster slot with the new `full_slot` and `incremental_slot` values.
    - Return if the score treap is empty.
    - Iterate over all peers in the score treap, calculate new scores, and insert them into a shadow score treap.
    - Remove all peers from the original score treap and release them back to the pool.
    - Swap the original score treap with the shadow score treap.
- **Output**: No return value; the function updates the state of the `selector`.
- **Functions Called**:
    - [`fd_sspeer_selector_score`](<#fd_sspeer_selector_score>)


---
### fd\_sspeer\_selector\_cluster\_slot<!-- {{#callable:fd_sspeer_selector_cluster_slot}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sspeer_selector.c#L394>)

Returns the `cluster_slot` from the given `fd_sspeer_selector_t` structure.
- **Inputs**:
    - `selector`: A pointer to an `fd_sspeer_selector_t` structure from which to retrieve the `cluster_slot`.
- **Logic and Control Flow**:
    - Accesses the `cluster_slot` member of the `selector` structure.
    - Returns the value of `cluster_slot`.
- **Output**: The function returns an `fd_sscluster_slot_t` value, which is the `cluster_slot` of the provided `selector`.



---
Made with ❤️ by [Driver](https://www.driver.ai/)