<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a state machine for parsing slot delta entries with error handling and memory management.

# Purpose
The code defines a C module for parsing slot delta data, which is likely used in a system that processes transaction data or similar structures. The module is centered around a state machine implemented in the `fd_slot_delta_parser_private` structure, which manages the parsing process through various states defined by constants such as `STATE_SLOT_DELTAS_LEN`, `STATE_SLOT_DELTA_SLOT`, and others. These states guide the parsing of different components of the slot delta data, such as slot identifiers, block hashes, and transaction indices.

The module provides functions to initialize, process, and manage the lifecycle of a slot delta parser. The [`fd_slot_delta_parser_new`](<#fd_slot_delta_parser_new>) function allocates and initializes the parser, while [`fd_slot_delta_parser_init`](<#fd_slot_delta_parser_init>) resets it for a new parsing session. The [`fd_slot_delta_parser_consume`](<#fd_slot_delta_parser_consume>) function is the core of the parsing logic, consuming input data and transitioning through states to extract and validate slot delta entries. The parser uses a pool and a set to manage slot entries and detect duplicates, ensuring that the parsed data is consistent and valid. The module also includes functions for memory alignment and footprint calculation, which are important for efficient memory management in systems with strict performance requirements.
# Imports and Dependencies

---
- `fd_slot_delta_parser.h`


# Data Structures

---
### fd\_slot\_delta\_parser\_private
- **Type**: ``struct``
- **Members**:
    - ``state``: Stores the current state of the parser state machine.
    - ``entry_avail``: Indicates if a parsed entry is available.
    - ``group_avail``: Indicates if a parsed group is available.
    - ``dst``: Pointer to the destination where the next parsed value is stored.
    - ``dst_cur``: Current offset into `dst`.
    - ``dst_sz``: Size of `dst`.
    - ``len``: Number of slot delta entries.
    - ``is_root``: Indicates if the current slot delta entry is rooted.
    - ``txnhash_offset``: Offset into the transaction cache for the current slot delta entry.
    - ``slot_delta_status_len``: Number of blockhashes in the slot delta entry.
    - ``cache_status_len``: Number of transactions associated with the blockhash.
    - ``borsh_io_error_len``: Used to parse a variable length `borsh_io_error` string.
    - ``error_discriminant``: Stores the error discriminant of a transaction result.
    - ``error``: Stores the error code of a transaction result.
    - ``slot_pool``: Pool backing a slot hashset.
    - ``slot_set``: Slot hash set to detect duplicate slots.
    - ``slot_pool_ele_cnt``: Count of slots in the pool.
    - ``entry``: Array of parsed slot delta entries.
- **Description**: Manages the parsing of slot delta entries, maintaining state information, destination storage, and error handling. It uses a state machine to process data and detect duplicate slots, while managing a pool of slots and a hash set for efficient lookup. The structure also handles transaction results and errors, storing relevant information for further processing.


# Functions

---
### state\_size<!-- {{#callable:state_size}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_slot_delta_parser.c#L49>)

Determines the size of the data type or value associated with the current state of the parser.
- **Inputs**:
    - `parser`: A pointer to an `fd_slot_delta_parser_t` structure, which contains the current state and other relevant data for parsing.
- **Logic and Control Flow**:
    - Checks the `state` of the `parser` using a `switch` statement.
    - For each state, returns the size of the corresponding data type or value, such as `sizeof(ulong)`, `sizeof(uchar)`, or specific constants like `32UL` or `20UL`.
    - For the state `STATE_CACHE_STATUS_RESULT_ERR_INSTR_ERR_CUSTOM_BORSH_ERR`, returns the value of `parser->borsh_io_error_len`.
    - If the state is `STATE_DONE`, returns `0UL`.
    - If the state is unknown, logs an error using `FD_LOG_ERR`.
- **Output**: Returns an `ulong` representing the size of the data type or value associated with the current state of the parser.


---
### state\_dst<!-- {{#callable:state_dst}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_slot_delta_parser.c#L73>)

Returns a pointer to the destination buffer based on the current state of the parser.
- **Inputs**:
    - `parser`: A pointer to an `fd_slot_delta_parser_t` structure that contains the current state and data of the parser.
- **Logic and Control Flow**:
    - Checks the `state` of the `parser` using a switch statement.
    - For each state, returns a pointer to the corresponding member of the `parser` structure or its `entry` substructure.
    - Returns `NULL` for states `STATE_CACHE_STATUS_RESULT_ERR_INSTR_IDX`, `STATE_CACHE_STATUS_RESULT_ERR_INSTR_ERR_CUSTOM_BORSH_ERR`, and `STATE_DONE`.
    - Logs an error if the state is unknown.
- **Output**: A pointer to an `uchar` that indicates the destination buffer for the current state, or `NULL` if the state does not require a destination buffer.


---
### state\_log<!-- {{#callable:state_log}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_slot_delta_parser.c#L98>)

Logs the current state of the `fd_slot_delta_parser_t` parser for debugging purposes.
- **Inputs**:
    - `parser`: A pointer to an `fd_slot_delta_parser_t` structure, which contains the current state and data of the parser.
- **Logic and Control Flow**:
    - Checks the current state of the `parser` using a switch statement.
    - Logs a message with the state name and relevant data using `FD_LOG_NOTICE` for specific states.
    - Handles states `STATE_SLOT_DELTAS_LEN`, `STATE_SLOT_DELTA_SLOT`, `STATE_SLOT_DELTA_IS_ROOT`, `STATE_SLOT_DELTA_STATUS_LEN`, `STATE_STATUS_BLOCKHASH`, and `STATE_CACHE_STATUS_LEN`.
    - Does nothing for states not explicitly handled in the switch statement.
- **Output**: No return value; the function logs messages for debugging.


---
### state\_validate<!-- {{#callable:state_validate}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_slot_delta_parser.c#L112>)

Validates the current state of the `fd_slot_delta_parser_t` parser and returns an error code if any validation checks fail.
- **Inputs**:
    - `parser`: A pointer to an `fd_slot_delta_parser_t` structure that holds the current state and data for the parser.
- **Logic and Control Flow**:
    - Check the current state of the parser using a switch statement.
    - If the state is `STATE_SLOT_DELTAS_LEN`, verify that `parser->len` does not exceed `FD_SLOT_DELTA_MAX_ENTRIES`.
    - If the state is `STATE_SLOT_DELTA_SLOT`, check for duplicate slot entries and ensure the slot pool does not exceed `FD_SLOT_DELTA_MAX_ENTRIES`.
    - If the state is `STATE_SLOT_DELTA_IS_ROOT`, ensure that `parser->is_root` is true.
    - Return specific error codes if any validation checks fail, otherwise return 0.
- **Output**: Returns 0 if validation is successful, or a specific error code if a validation check fails.


---
### loop<!-- {{#callable:loop}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_slot_delta_parser.c#L144>)

Updates the parser's state based on the current status lengths and entry count.
- **Inputs**:
    - `parser`: A pointer to a `fd_slot_delta_parser_t` structure that holds the current state and status lengths of the parser.
- **Logic and Control Flow**:
    - Checks if `parser->cache_status_len` is non-zero; if true, sets `parser->state` to `STATE_CACHE_STATUS_KEY_SLICE`.
    - If `parser->cache_status_len` is zero, checks if `parser->slot_delta_status_len` is non-zero; if true, sets `parser->state` to `STATE_STATUS_BLOCKHASH`.
    - If both `parser->cache_status_len` and `parser->slot_delta_status_len` are zero, checks if `parser->len` is non-zero; if true, sets `parser->state` to `STATE_SLOT_DELTA_SLOT`.
    - If all the above conditions are false, sets `parser->state` to `STATE_DONE`.
- **Output**: The function does not return a value; it modifies the `state` field of the `parser` structure.


---
### result\_loop<!-- {{#callable:result_loop}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_slot_delta_parser.c#L157>)

Sets the `entry_avail` flag to 1 and calls the [`loop`](<#loop>) function to update the parser's state.
- **Inputs**:
    - `parser`: A pointer to an `fd_slot_delta_parser_t` structure, which holds the state and data for parsing slot delta entries.
- **Logic and Control Flow**:
    - Sets `parser->entry_avail` to 1, indicating that a parsed entry is available.
    - Calls the [`loop`](<#loop>) function with the `parser` as an argument to update the parser's state based on its current status.
- **Output**: No return value; the function modifies the state of the `parser` in place.
- **Functions Called**:
    - [`loop`](<#loop>)


---
### state\_process<!-- {{#callable:state_process}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_slot_delta_parser.c#L163>)

Transitions the state of a `fd_slot_delta_parser_t` object through a series of predefined states based on its current state and conditions.
- **Inputs**:
    - `parser`: A pointer to a `fd_slot_delta_parser_t` object that contains the current state and other related data for processing.
- **Logic and Control Flow**:
    - Check that the parser's state is not `STATE_DONE` using `FD_TEST` macro.
    - Use a `switch` statement to handle different states of the parser.
    - For each state, update the parser's state to the next logical state.
    - In `STATE_SLOT_DELTA_SLOT`, decrement `parser->len`.
    - In `STATE_SLOT_DELTA_STATUS_LEN`, call `loop(parser)` if `parser->slot_delta_status_len` is zero, otherwise set the state to `STATE_STATUS_BLOCKHASH`.
    - In `STATE_STATUS_BLOCKHASH`, decrement `parser->slot_delta_status_len`.
    - In `STATE_STATUS_TXN_IDX`, set `parser->group_avail` to 1.
    - In `STATE_CACHE_STATUS_LEN`, call `loop(parser)` if `parser->cache_status_len` is zero, otherwise set the state to `STATE_CACHE_STATUS_KEY_SLICE`.
    - In `STATE_CACHE_STATUS_KEY_SLICE`, decrement `parser->cache_status_len`.
    - In `STATE_CACHE_STATUS_RESULT`, check `parser->error_discriminant` and either set `parser->entry->result` to 0 and call `result_loop(parser)`, or set the state to `STATE_CACHE_STATUS_RESULT_ERR`.
    - In `STATE_CACHE_STATUS_RESULT_ERR`, check `parser->error_discriminant` for specific values to determine the next state or set `parser->entry->result` and call `result_loop(parser)`.
    - Handle specific error states by transitioning to the appropriate next state or setting `parser->entry->result` and calling `result_loop(parser)`.
    - Log an error if the state is unknown.
- **Output**: No direct output; modifies the state and related fields of the `parser` object.
- **Functions Called**:
    - [`loop`](<#loop>)
    - [`result_loop`](<#result_loop>)


---
### fd\_slot\_delta\_parser\_align<!-- {{#callable:fd_slot_delta_parser_align}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_slot_delta_parser.c#L249>)

Calculates the alignment requirement for the `fd_slot_delta_parser_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `fd_ulong_max` to determine the maximum alignment requirement between `alignof(fd_slot_delta_parser_t)` and `slot_set_align()`.
    - Returns the result of the `fd_ulong_max` function.
- **Output**: Returns an `ulong` representing the maximum alignment requirement for the `fd_slot_delta_parser_t` structure.


---
### fd\_slot\_delta\_parser\_footprint<!-- {{#callable:fd_slot_delta_parser_footprint}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_slot_delta_parser.c#L254>)

Calculates the memory footprint required for a `fd_slot_delta_parser_t` structure and its associated slot pool and slot set.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize `ulong l` with `FD_LAYOUT_INIT`.
    - Append the alignment and size of `fd_slot_delta_parser_t` to `l` using `FD_LAYOUT_APPEND`.
    - Append the alignment and footprint of the slot pool with maximum entries to `l`.
    - Append the alignment and footprint of the slot set with maximum entries to `l`.
    - Return the finalized layout size using `FD_LAYOUT_FINI`.
- **Output**: Returns the total memory footprint as an `ulong` for the `fd_slot_delta_parser_t` and its associated components.


---
### fd\_slot\_delta\_parser\_new<!-- {{#callable:fd_slot_delta_parser_new}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_slot_delta_parser.c#L263>)

Initializes a new `fd_slot_delta_parser_t` structure in shared memory for parsing slot delta entries.
- **Inputs**:
    - `shmem`: A pointer to shared memory where the parser will be initialized.
- **Logic and Control Flow**:
    - Checks if `shmem` is NULL and logs a warning if true, returning NULL.
    - Checks if `shmem` is aligned according to `fd_slot_delta_parser_align()` and logs a warning if not, returning NULL.
    - Initializes a scratch allocator with `shmem`.
    - Allocates memory for a `fd_slot_delta_parser_t` structure, a slot pool, and a slot set using the scratch allocator.
    - Initializes the slot pool and slot set, joining them to the parser structure.
    - Iterates over the slot pool to set each slot entry's slot to `ULONG_MAX`.
    - Sets initial values for `entry_avail`, `group_avail`, `slot_pool_ele_cnt`, and `state` in the parser structure.
    - Returns a pointer to the initialized `fd_slot_delta_parser_t` structure.
- **Output**: A pointer to the newly initialized `fd_slot_delta_parser_t` structure, or NULL if initialization fails.
- **Functions Called**:
    - [`fd_slot_delta_parser_align`](<#fd_slot_delta_parser_align>)


---
### fd\_slot\_delta\_parser\_join<!-- {{#callable:fd_slot_delta_parser_join}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_slot_delta_parser.c#L299>)

Returns the input `shmem` pointer as a `fd_slot_delta_parser_t` pointer.
- **Inputs**:
    - `shmem`: A pointer to shared memory that is expected to be of type `fd_slot_delta_parser_t`.
- **Logic and Control Flow**:
    - The function takes a single input parameter `shmem`.
    - It returns the `shmem` pointer cast to a `fd_slot_delta_parser_t` pointer.
- **Output**: A pointer of type `fd_slot_delta_parser_t` that is the same as the input `shmem` pointer.


---
### fd\_slot\_delta\_parser\_leave<!-- {{#callable:fd_slot_delta_parser_leave}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_slot_delta_parser.c#L304>)

Returns the input `parser` cast to a `void *` type.
- **Inputs**:
    - `parser`: A pointer to a `fd_slot_delta_parser_t` structure.
- **Logic and Control Flow**:
    - Casts the `parser` to a `void *` type.
    - Returns the casted `parser`.
- **Output**: A `void *` pointer to the input `parser`.


---
### fd\_slot\_delta\_parser\_delete<!-- {{#callable:fd_slot_delta_parser_delete}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_slot_delta_parser.c#L309>)

Returns the input `shmem` pointer without modification.
- **Inputs**:
    - `shmem`: A pointer to shared memory that the function will return.
- **Logic and Control Flow**:
    - The function takes a single input parameter `shmem`.
    - It returns the `shmem` pointer without any changes.
- **Output**: The function returns the same `shmem` pointer that it receives as input.


---
### fd\_slot\_delta\_parser\_init<!-- {{#callable:fd_slot_delta_parser_init}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_slot_delta_parser.c#L314>)

Initializes a `fd_slot_delta_parser_t` structure to prepare it for parsing operations.
- **Inputs**:
    - `parser`: A pointer to a `fd_slot_delta_parser_t` structure that will be initialized.
- **Logic and Control Flow**:
    - Set the `state` of `parser` to `STATE_SLOT_DELTAS_LEN`.
    - Initialize `len`, `is_root`, `slot_delta_status_len`, `cache_status_len`, `borsh_io_error_len`, and `error_discriminant` to zero.
    - Iterate over `slot_pool` up to `slot_pool_ele_cnt`, remove each slot entry from `slot_set`, and set its `slot` to `ULONG_MAX`.
    - Set `slot_pool_ele_cnt` to zero.
    - Set `dst` to the result of `state_dst(parser)`, `dst_sz` to the result of `state_size(parser)`, and `dst_cur` to zero.
    - Set `entry_avail` and `group_avail` to zero.
- **Output**: No return value; the function modifies the `parser` structure in place.
- **Functions Called**:
    - [`state_dst`](<#state_dst>)
    - [`state_size`](<#state_size>)


---
### fd\_slot\_delta\_parser\_consume<!-- {{#callable:fd_slot_delta_parser_consume}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_slot_delta_parser.c#L341>)

Consumes data from a buffer to parse slot delta entries and updates the parser state accordingly.
- **Inputs**:
    - `parser`: A pointer to an `fd_slot_delta_parser_t` structure that maintains the state of the parser.
    - `buf`: A pointer to a buffer containing the data to be consumed and parsed.
    - `bufsz`: The size of the buffer in bytes.
    - `result`: A pointer to an `fd_slot_delta_parser_advance_result_t` structure where the function stores the result of the parsing operation.
- **Logic and Control Flow**:
    - Initialize `data` to point to `buf` and `data_sz` to `bufsz`.
    - Enter a loop that continues while `data_sz` is non-zero.
    - Check if the parser state is `STATE_DONE`; if so, break the loop.
    - Calculate `consume` as the minimum of `data_sz` and the remaining space in the destination buffer (`parser->dst_sz - parser->dst_cur`).
    - If there is space in the destination buffer and `consume` is non-zero, copy `consume` bytes from `data` to the destination buffer (`parser->dst`).
    - Update `parser->dst_cur`, `data`, and `data_sz` by `consume` bytes.
    - If `parser->dst_cur` equals `parser->dst_sz`, validate the current state using [`state_validate`](<#state_validate>).
    - If validation fails, set `result->bytes_consumed` and return the error code.
    - Process the current state using [`state_process`](<#state_process>), update the destination buffer and size using [`state_dst`](<#state_dst>) and [`state_size`](<#state_size>), and reset `parser->dst_cur`.
    - If a group is available, update `result` with group information, reset `parser->group_avail`, and return `FD_SLOT_DELTA_PARSER_ADVANCE_GROUP`.
    - If an entry is available, update `result` with entry information, reset `parser->entry_avail`, and return `FD_SLOT_DELTA_PARSER_ADVANCE_ENTRY`.
    - If `data_sz` is non-zero after the loop, log a warning, set `result->bytes_consumed`, and return `FD_SLOT_DELTA_PARSER_ADVANCE_ERROR_EXCESS_DATA_IN_BUFFER`.
    - Set `result->bytes_consumed` and return `FD_SLOT_DELTA_PARSER_ADVANCE_DONE` if the parser state is `STATE_DONE`, otherwise return `FD_SLOT_DELTA_PARSER_ADVANCE_AGAIN`.
- **Output**: Returns an integer indicating the result of the parsing operation, which can be a success, an error, or a need to continue parsing.
- **Functions Called**:
    - [`state_log`](<#state_log>)
    - [`state_validate`](<#state_validate>)
    - [`state_process`](<#state_process>)
    - [`state_dst`](<#state_dst>)
    - [`state_size`](<#state_size>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)