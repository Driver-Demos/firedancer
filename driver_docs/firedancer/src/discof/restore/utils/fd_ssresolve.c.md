<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a snapshot resolution utility for sending requests and handling responses in a networked environment.

# Purpose
The code is a C module that manages the process of sending HTTP requests to retrieve snapshot files from a server and handling the responses. It defines a state machine with three states: `FD_SSRESOLVE_STATE_REQ` for sending requests, `FD_SSRESOLVE_STATE_RESP` for receiving responses, and `FD_SSRESOLVE_STATE_DONE` for completion. The module includes functions to initialize and manage the state of a `fd_ssresolve_t` structure, which holds information about the request and response, such as the socket file descriptor, request and response buffers, and the current state.

The module provides functions to create and join a `fd_ssresolve_t` instance, send HTTP requests, and read HTTP responses. It handles HTTP redirects by parsing the "Location" header and updating the state accordingly. The code uses the `picohttpparser` library for parsing HTTP responses and includes error handling for various conditions, such as malformed responses and unexpected states. The module is designed to be used in a networked environment where snapshot files are retrieved over HTTP, and it provides a structured approach to managing the request-response lifecycle.
# Imports and Dependencies

---
- `fd_ssresolve.h`
- `fd_ssarchive.h`
- `../../../waltz/http/picohttpparser.h`
- `../../../util/log/fd_log.h`
- `unistd.h`
- `errno.h`
- `stdlib.h`
- `strings.h`
- `sys/socket.h`
- `netinet/tcp.h`
- `netinet/in.h`


# Data Structures

---
### fd\_ssresolve\_private
- **Type**: ``struct``
- **Members**:
    - `state`: Indicates the current state of the resolution process.
    - `deadline`: Specifies the time limit for the resolution process.
    - `addr`: Holds the IP address and port information.
    - `sockfd`: Stores the socket file descriptor used for communication.
    - `full`: Indicates whether a full snapshot is requested.
    - `request`: Contains the HTTP request data to be sent.
    - `request_sent`: Tracks the number of bytes of the request that have been sent.
    - `request_len`: Specifies the total length of the HTTP request.
    - `response_len`: Tracks the length of the received HTTP response.
    - `response`: Stores the HTTP response data received.
    - `magic`: Used to verify the integrity of the structure.
- **Description**: Manages the state and data for resolving a snapshot request over HTTP, including request and response handling, socket communication, and state transitions.


# Functions

---
### fd\_ssresolve\_align<!-- {{#callable:fd_ssresolve_align}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssresolve.c#L38>)

Returns the alignment requirement for the `fd_ssresolve` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the value of the macro `FD_SSRESOLVE_ALIGN`.
- **Output**: The alignment requirement for the `fd_ssresolve` structure as an `ulong`.


---
### fd\_ssresolve\_footprint<!-- {{#callable:fd_ssresolve_footprint}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssresolve.c#L43>)

Calculates the memory footprint required for an `fd_ssresolve_t` structure with alignment considerations.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize a variable `l` with `FD_LAYOUT_INIT`.
    - Append the size of `fd_ssresolve_t` to `l` with alignment `FD_SSRESOLVE_ALIGN` using `FD_LAYOUT_APPEND`.
    - Finalize the layout and return the calculated footprint using `FD_LAYOUT_FINI`.
- **Output**: Returns an `ulong` representing the memory footprint required for an `fd_ssresolve_t` structure, including alignment.


---
### fd\_ssresolve\_new<!-- {{#callable:fd_ssresolve_new}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssresolve.c#L51>)

Initializes a new `fd_ssresolve_t` structure in shared memory with default values and checks for alignment.
- **Inputs**:
    - `shmem`: A pointer to shared memory where the `fd_ssresolve_t` structure will be initialized.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL; if so, log a warning and return NULL.
    - Check if `shmem` is aligned according to [`fd_ssresolve_align`](<#fd_ssresolve_align>); if not, log a warning and return NULL.
    - Initialize a scratch allocator with `shmem`.
    - Allocate memory for `fd_ssresolve_t` using the scratch allocator.
    - Set the initial state of `ssresolve` to `FD_SSRESOLVE_STATE_REQ`.
    - Initialize `request_sent`, `request_len`, and `response_len` to 0.
    - Use memory fences to ensure memory operations are completed before setting `ssresolve->magic`.
    - Set `ssresolve->magic` to `FD_SSRESOLVE_MAGIC` using a volatile store.
    - Return a pointer to the initialized `fd_ssresolve_t` structure.
- **Output**: A pointer to the newly initialized `fd_ssresolve_t` structure, or NULL if an error occurs.
- **Functions Called**:
    - [`fd_ssresolve_align`](<#fd_ssresolve_align>)


---
### fd\_ssresolve\_join<!-- {{#callable:fd_ssresolve_join}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssresolve.c#L78>)

Validates and returns a pointer to a `fd_ssresolve_t` structure if the input is correctly aligned and initialized.
- **Inputs**:
    - `_ssresolve`: A pointer to a memory location that is expected to be a `fd_ssresolve_t` structure.
- **Logic and Control Flow**:
    - Check if `_ssresolve` is `NULL`; if so, log a warning and return `NULL`.
    - Verify if `_ssresolve` is aligned according to `fd_ssresolve_align()`; if not, log a warning and return `NULL`.
    - Cast `_ssresolve` to a `fd_ssresolve_t` pointer.
    - Check if the `magic` field of the `fd_ssresolve_t` structure matches `FD_SSRESOLVE_MAGIC`; if not, log a warning and return `NULL`.
    - Return the `fd_ssresolve_t` pointer if all checks pass.
- **Output**: A pointer to a `fd_ssresolve_t` structure if validation is successful, otherwise `NULL`.
- **Functions Called**:
    - [`fd_ssresolve_align`](<#fd_ssresolve_align>)


---
### fd\_ssresolve\_init<!-- {{#callable:fd_ssresolve_init}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssresolve.c#L100>)

Initializes an `fd_ssresolve_t` structure with specified address, socket, and mode, and sets initial state and counters.
- **Inputs**:
    - ``ssresolve``: A pointer to an `fd_ssresolve_t` structure to initialize.
    - ``addr``: An `fd_ip4_port_t` representing the IP address and port.
    - ``sockfd``: An integer representing the socket file descriptor.
    - ``full``: An integer indicating whether to request a full snapshot (non-zero) or an incremental snapshot (zero).
- **Logic and Control Flow**:
    - Assigns the `addr` to `ssresolve->addr`.
    - Assigns the `sockfd` to `ssresolve->sockfd`.
    - Assigns the `full` to `ssresolve->full`.
    - Sets `ssresolve->state` to `FD_SSRESOLVE_STATE_REQ`, indicating the initial request state.
    - Initializes `ssresolve->request_sent`, `ssresolve->request_len`, and `ssresolve->response_len` to zero.
- **Output**: No return value; the function modifies the `ssresolve` structure in place.


---
### fd\_ssresolve\_render\_req<!-- {{#callable:fd_ssresolve_render_req}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssresolve.c#L115>)

Constructs an HTTP GET request for a snapshot or incremental snapshot based on the `full` flag in the `fd_ssresolve_t` structure.
- **Inputs**:
    - ``ssresolve``: A pointer to an `fd_ssresolve_t` structure that contains the request buffer and the `full` flag.
    - ``addr``: An `fd_ip4_port_t` structure that contains the IP address and port information for the request.
- **Logic and Control Flow**:
    - Check if the `full` flag in `ssresolve` is set to true.
    - If `full` is true, format a request for a full snapshot and store it in `ssresolve->request`.
    - If `full` is false, format a request for an incremental snapshot and store it in `ssresolve->request`.
    - Use `fd_cstr_printf_check` to format the request string and update `ssresolve->request_len`.
- **Output**: No return value; modifies the `request` and `request_len` fields of the `fd_ssresolve_t` structure.


---
### fd\_ssresolve\_send\_request<!-- {{#callable:fd_ssresolve_send_request}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssresolve.c#L137>)

Sends a request over a socket and updates the state of the `fd_ssresolve_t` structure based on the success of the send operation.
- **Inputs**:
    - `ssresolve`: A pointer to an `fd_ssresolve_t` structure that contains the state and data for the request.
- **Logic and Control Flow**:
    - Check if `ssresolve->state` is `FD_SSRESOLVE_STATE_REQ` to ensure the function is called in the correct state.
    - If `ssresolve->request_len` is zero, call [`fd_ssresolve_render_req`](<#fd_ssresolve_render_req>) to prepare the request data.
    - Use `sendto` to send the request data from `ssresolve->request` starting at `ssresolve->request_sent` for the remaining length.
    - If `sendto` returns -1 and `errno` is `EAGAIN`, return `FD_SSRESOLVE_ADVANCE_AGAIN` to indicate the operation should be retried.
    - If `sendto` returns -1 for other reasons, return `FD_SSRESOLVE_ADVANCE_ERROR` to indicate an error occurred.
    - Update `ssresolve->request_sent` by adding the number of bytes successfully sent.
    - If all bytes have been sent (`ssresolve->request_sent` equals `ssresolve->request_len`), update `ssresolve->state` to `FD_SSRESOLVE_STATE_RESP` and return `FD_SSRESOLVE_ADVANCE_SUCCESS`.
    - If not all bytes have been sent, return `FD_SSRESOLVE_ADVANCE_AGAIN` to indicate the operation should be retried.
- **Output**: An integer indicating the result of the send operation: `FD_SSRESOLVE_ADVANCE_AGAIN`, `FD_SSRESOLVE_ADVANCE_ERROR`, or `FD_SSRESOLVE_ADVANCE_SUCCESS`.
- **Functions Called**:
    - [`fd_ssresolve_render_req`](<#fd_ssresolve_render_req>)


---
### fd\_ssresolve\_parse\_redirect<!-- {{#callable:fd_ssresolve_parse_redirect}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssresolve.c#L160>)

Parses HTTP redirect headers to extract and validate the snapshot file location, updating the result structure with the appropriate slot information.
- **Inputs**:
    - ``ssresolve``: A pointer to an `fd_ssresolve_t` structure that maintains the state of the snapshot resolution process.
    - ``headers``: An array of `phr_header` structures representing the HTTP headers received in the response.
    - ``header_cnt``: The number of headers in the `headers` array.
    - ``result``: A pointer to an `fd_ssresolve_result_t` structure where the function will store the parsed slot information.
- **Logic and Control Flow**:
    - Initialize `location_len` to 0 and `location` to NULL.
    - Iterate over the `headers` array to find a header with the name 'location'.
    - If a 'location' header is found, check if its value is valid (non-empty and starts with '/').
    - If the 'location' header is invalid, log a warning and return `FD_SSRESOLVE_ADVANCE_ERROR`.
    - If the 'location' header is valid, set `location_len` and `location` to the header's value and break the loop.
    - Check if `location_len` is greater than or equal to `PATH_MAX-1`; if so, return `FD_SSRESOLVE_ADVANCE_ERROR`.
    - Copy the snapshot name from `location` into `snapshot_name`, excluding the leading '/'.
    - Parse the `snapshot_name` to extract `full_entry_slot`, `incremental_entry_slot`, and `decoded_hash` using [`fd_ssarchive_parse_filename`](<fd_ssarchive.c.md#fd_ssarchive_parse_filename>).
    - If parsing fails, log a warning and return `FD_SSRESOLVE_ADVANCE_ERROR`.
    - Determine the appropriate slot values for `result` based on `incremental_entry_slot` and `full_entry_slot`.
    - Set `ssresolve->state` to `FD_SSRESOLVE_STATE_DONE`.
    - Return `FD_SSRESOLVE_ADVANCE_SUCCESS`.
- **Output**: Returns `FD_SSRESOLVE_ADVANCE_SUCCESS` on successful parsing and updating of the result, or `FD_SSRESOLVE_ADVANCE_ERROR` if an error occurs during parsing or validation.
- **Functions Called**:
    - [`fd_ssarchive_parse_filename`](<fd_ssarchive.c.md#fd_ssarchive_parse_filename>)


---
### fd\_ssresolve\_read\_response<!-- {{#callable:fd_ssresolve_read_response}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssresolve.c#L208>)

Reads and processes an HTTP response from a socket, handling redirects and errors.
- **Inputs**:
    - ``ssresolve``: A pointer to an `fd_ssresolve_t` structure that contains the state and response data for the socket operation.
    - ``result``: A pointer to an `fd_ssresolve_result_t` structure where the function stores the result of a successful redirect parsing.
- **Logic and Control Flow**:
    - Checks if the `ssresolve` state is `FD_SSRESOLVE_STATE_RESP` to ensure it is ready to read a response.
    - Attempts to read data from the socket using `recvfrom` and updates the `response_len` with the number of bytes read.
    - If `recvfrom` returns -1 and `errno` is `EAGAIN`, returns `FD_SSRESOLVE_ADVANCE_AGAIN` to indicate a retry is needed.
    - If `recvfrom` fails with another error, logs a warning and returns `FD_SSRESOLVE_ADVANCE_ERROR`.
    - Parses the HTTP response using `phr_parse_response`, checking for parsing errors and returning `FD_SSRESOLVE_ADVANCE_ERROR` or `FD_SSRESOLVE_ADVANCE_AGAIN` as needed.
    - Checks if the response status indicates a redirect (status codes 301, 302, 303, 304, 307, 308) and calls [`fd_ssresolve_parse_redirect`](<#fd_ssresolve_parse_redirect>) if true, returning its result.
    - Logs a warning and returns `FD_SSRESOLVE_ADVANCE_ERROR` if the status is not 200.
- **Output**: Returns an integer status code indicating the result of the operation, such as `FD_SSRESOLVE_ADVANCE_AGAIN`, `FD_SSRESOLVE_ADVANCE_ERROR`, or the result of [`fd_ssresolve_parse_redirect`](<#fd_ssresolve_parse_redirect>).
- **Functions Called**:
    - [`fd_ssresolve_parse_redirect`](<#fd_ssresolve_parse_redirect>)


---
### fd\_ssresolve\_advance\_poll\_out<!-- {{#callable:fd_ssresolve_advance_poll_out}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssresolve.c#L256>)

Advances the state of the `fd_ssresolve_t` object based on its current state, either sending a request or indicating readiness to receive a response.
- **Inputs**:
    - `ssresolve`: A pointer to an `fd_ssresolve_t` structure that holds the state and data for the snapshot resolution process.
- **Logic and Control Flow**:
    - Check the current state of `ssresolve` using a switch statement.
    - If the state is `FD_SSRESOLVE_STATE_REQ`, call [`fd_ssresolve_send_request`](<#fd_ssresolve_send_request>) to send a request and store the result in `res`.
    - If the state is `FD_SSRESOLVE_STATE_RESP`, set `res` to `FD_SSRESOLVE_ADVANCE_AGAIN` to indicate readiness to receive a response.
    - If the state is neither `FD_SSRESOLVE_STATE_REQ` nor `FD_SSRESOLVE_STATE_RESP`, log an error for an unexpected state and return `FD_SSRESOLVE_ADVANCE_ERROR`.
    - Return the value of `res`.
- **Output**: Returns an integer indicating the result of the operation, which can be a success, an error, or a signal to try again.
- **Functions Called**:
    - [`fd_ssresolve_send_request`](<#fd_ssresolve_send_request>)


---
### fd\_ssresolve\_advance\_poll\_in<!-- {{#callable:fd_ssresolve_advance_poll_in}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssresolve.c#L276>)

Advances the state of the `fd_ssresolve_t` object based on its current state and processes incoming data if necessary.
- **Inputs**:
    - `ssresolve`: A pointer to an `fd_ssresolve_t` structure that holds the state and data for the snapshot resolution process.
    - `result`: A pointer to an `fd_ssresolve_result_t` structure where the function stores the result of the snapshot resolution if applicable.
- **Logic and Control Flow**:
    - Check the current state of `ssresolve` using a switch statement.
    - If the state is `FD_SSRESOLVE_STATE_RESP`, call [`fd_ssresolve_read_response`](<#fd_ssresolve_read_response>) to process the response and store the result in `result`.
    - If the state is `FD_SSRESOLVE_STATE_REQ`, set `res` to `FD_SSRESOLVE_ADVANCE_AGAIN` to indicate that the request should be sent again.
    - If the state is neither `FD_SSRESOLVE_STATE_RESP` nor `FD_SSRESOLVE_STATE_REQ`, log an error for the unexpected state and return `FD_SSRESOLVE_ADVANCE_ERROR`.
    - Return the value of `res` which indicates the result of the operation.
- **Output**: Returns an integer indicating the result of the operation, which can be `FD_SSRESOLVE_ADVANCE_AGAIN`, `FD_SSRESOLVE_ADVANCE_ERROR`, or the result of [`fd_ssresolve_read_response`](<#fd_ssresolve_read_response>).
- **Functions Called**:
    - [`fd_ssresolve_read_response`](<#fd_ssresolve_read_response>)


---
### fd\_ssresolve\_is\_done<!-- {{#callable:fd_ssresolve_is_done}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssresolve.c#L298>)

Checks if the `fd_ssresolve_t` object has reached the 'done' state.
- **Inputs**:
    - `ssresolve`: A pointer to an `fd_ssresolve_t` object, which contains the state information of the snapshot resolution process.
- **Logic and Control Flow**:
    - Accesses the `state` member of the `fd_ssresolve_t` structure pointed to by `ssresolve`.
    - Compares the `state` with the constant `FD_SSRESOLVE_STATE_DONE`.
    - Returns the result of the comparison as an integer.
- **Output**: Returns 1 if the `state` is `FD_SSRESOLVE_STATE_DONE`, otherwise returns 0.



---
Made with ❤️ by [Driver](https://www.driver.ai/)