<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Utilities for parsing, managing, and removing snapshot files in a directory.

# Purpose
The code is a C source file that manages snapshot archives in a directory. It provides functions to parse snapshot filenames, find the latest snapshot pair, and remove old snapshots based on specified limits. The [`fd_ssarchive_parse_filename`](<#fd_ssarchive_parse_filename>) function interprets snapshot filenames to extract full and incremental slot numbers and a hash. The [`fd_ssarchive_latest_pair`](<#fd_ssarchive_latest_pair>) function identifies the most recent full and incremental snapshot pair in a given directory. The [`fd_ssarchive_remove_old_snapshots`](<#fd_ssarchive_remove_old_snapshots>) function deletes older snapshots beyond a specified number to maintain a manageable number of snapshots in the directory.

The file includes several external dependencies, such as logging utilities and sorting templates, which are used to handle errors and sort snapshot entries. The code defines a structure `fd_ssarchive_entry_t` to represent snapshot entries, and it uses macros to set maximum limits for full and incremental snapshot entries. The functions in this file are designed to be part of a larger system that manages snapshot archives, providing a focused set of operations related to snapshot file handling and directory management.
# Imports and Dependencies

---
- `fd_ssarchive.h`
- `../../../util/log/fd_log.h`
- `errno.h`
- `dirent.h`
- `stdlib.h`
- `unistd.h`
- `../../../util/tmpl/fd_sort.c`


# Data Structures

---
### fd\_ssarchive\_entry
- **Type**: ``struct``
- **Members**:
    - `slot`: Stores an unsigned long integer representing the slot number.
    - `path`: Stores a character array of maximum size `PATH_MAX` representing the file path.
- **Description**: Represents an entry in the snapshot archive, containing a slot number and a file path. The `slot` member is used to identify the position or order of the entry, while the `path` member holds the file path associated with the entry. This structure is used to manage and sort snapshot entries in the archive.


---
### fd\_ssarchive\_entry\_t
- **Type**: ``struct``
- **Members**:
    - `slot`: Stores the slot number for the archive entry.
    - `path`: Holds the file path of the archive entry, with a maximum length defined by `PATH_MAX`.
- **Description**: Defines an archive entry with a slot number and a file path, used to manage and sort snapshot entries in a directory.


# Functions

---
### fd\_ssarchive\_parse\_filename<!-- {{#callable:fd_ssarchive_parse_filename}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssarchive.c#L24>)

Parses a filename to extract snapshot type, slot numbers, and hash, returning success or failure.
- **Inputs**:
    - `_name`: A pointer to a character array containing the filename to parse.
    - `full_slot`: A pointer to an unsigned long where the function will store the full slot number.
    - `incremental_slot`: A pointer to an unsigned long where the function will store the incremental slot number, or `ULONG_MAX` if not applicable.
    - `hash`: An array of unsigned characters where the function will store the decoded hash.
- **Logic and Control Flow**:
    - Copy the input filename `_name` to a local buffer `name` with a maximum length of `PATH_MAX-1` characters.
    - Check if the filename starts with 'incremental-snapshot-' or 'snapshot-' to determine the snapshot type and adjust the pointer `ptr` accordingly.
    - Search for the next '-' character to separate the slot number, and convert the substring to an unsigned long `slot`.
    - Store the `slot` in `full_slot` and, if the snapshot is incremental, repeat the process to find and store the `incremental_slot`.
    - Search for the '.' character to separate the hash, and ensure its length does not exceed `FD_BASE58_ENCODED_32_LEN`.
    - Copy the hash substring to `encoded_hash`, decode it using `fd_base58_decode_32`, and store the result in `hash`.
    - Verify that the filename ends with '.tar.zst'.
    - Return 0 on success or -1 on failure at any step.
- **Output**: Returns 0 on successful parsing and -1 if the filename does not match the expected format or if any parsing step fails.


---
### fd\_ssarchive\_latest\_pair<!-- {{#callable:fd_ssarchive_latest_pair}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssarchive.c#L87>)

Finds the latest full and incremental snapshot files in a directory and updates the provided slots and paths accordingly.
- **Inputs**:
    - ``directory``: A string representing the path to the directory where snapshot files are stored.
    - ``incremental_snapshot``: An integer flag indicating whether to search for incremental snapshots (non-zero value) or not (zero value).
    - ``full_slot``: A pointer to an unsigned long where the function will store the slot number of the latest full snapshot.
    - ``incremental_slot``: A pointer to an unsigned long where the function will store the slot number of the latest incremental snapshot.
    - ``full_path``: A character array with a size of at least `PATH_MAX` where the function will store the path to the latest full snapshot.
    - ``incremental_path``: A character array with a size of at least `PATH_MAX` where the function will store the path to the latest incremental snapshot.
- **Logic and Control Flow**:
    - Initialize `full_slot` and `incremental_slot` to `ULONG_MAX`.
    - Open the directory specified by `directory` and handle errors if the directory cannot be opened.
    - Iterate over each entry in the directory, skipping `.` and `..` entries.
    - Parse each entry's filename to extract `entry_full_slot` and `entry_incremental_slot` using [`fd_ssarchive_parse_filename`](<#fd_ssarchive_parse_filename>).
    - If the entry is a full snapshot and has a higher slot number than the current `full_slot`, update `full_slot` and `full_path`.
    - Close the directory and check for errors during reading or closing.
    - If no full snapshot is found, return -1.
    - If `incremental_snapshot` is zero, return 0.
    - Reopen the directory and repeat the iteration process to find the latest incremental snapshot that matches the `full_slot`.
    - Update `incremental_slot` and `incremental_path` if a matching incremental snapshot is found.
    - Close the directory and check for errors during reading or closing.
    - Return 0 on successful completion.
- **Output**: Returns 0 on success, -1 if no full snapshot is found, or 0 if `incremental_snapshot` is zero and no incremental snapshot is needed.
- **Functions Called**:
    - [`fd_ssarchive_parse_filename`](<#fd_ssarchive_parse_filename>)


---
### fd\_ssarchive\_remove\_old\_snapshots<!-- {{#callable:fd_ssarchive_remove_old_snapshots}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_ssarchive.c#L159>)

Removes old snapshot files from a directory, keeping only a specified number of full and incremental snapshots.
- **Inputs**:
    - `directory`: The path to the directory containing snapshot files.
    - `max_full_snapshots_to_keep`: The maximum number of full snapshot files to retain.
    - `max_incremental_snapshots_to_keep`: The maximum number of incremental snapshot files to retain.
- **Logic and Control Flow**:
    - Initialize counters for full and incremental snapshots and arrays to store their entries.
    - Open the specified directory and handle errors if the directory cannot be opened.
    - Iterate over each entry in the directory, skipping '.' and '..' entries.
    - Parse each entry's filename to determine if it is a full or incremental snapshot and store it in the appropriate array if valid.
    - If the number of full snapshots exceeds the specified maximum, sort the entries and remove the oldest ones beyond the limit.
    - If the number of incremental snapshots exceeds the specified maximum, sort the entries and remove the oldest ones beyond the limit.
    - Close the directory and handle any errors that occur during reading or closing.
- **Output**: No return value; the function performs file deletions as a side effect.
- **Functions Called**:
    - [`fd_ssarchive_parse_filename`](<#fd_ssarchive_parse_filename>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)