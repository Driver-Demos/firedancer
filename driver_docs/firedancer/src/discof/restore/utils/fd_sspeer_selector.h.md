<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Header file for a snapshot peer selector that manages and selects optimal peers for downloading snapshots.

# Purpose
This C header file defines the interface for a snapshot peer selector, which is responsible for selecting the most optimal peer to download snapshots from in a network. The optimal peer is defined as the closest peer that provides the most recent snapshot. The file includes necessary utility and network headers and defines several data structures, such as `fd_ssinfo_t`, `fd_sscluster_slot_t`, and `fd_sspeer_t`, which store information about snapshot slots, cluster slots, and peer details, respectively. It provides function prototypes for managing the peer selector, including creating, joining, and deleting a selector, adding and removing peers, selecting the best peer, and updating the cluster slot information. The file uses macros and type definitions to ensure consistent and efficient handling of peer selection operations.
# Imports and Dependencies

---
- `../../../util/fd_util_base.h`
- `../../../util/net/fd_net_headers.h`


# Data Structures

---
### fd\_ssinfo
- **Type**: ``struct``
- **Members**:
    - ``full``: Contains a `slot` field representing the snapshot slot for a full snapshot.
    - ``incremental``: Contains `base_slot` and `slot` fields representing the base and current snapshot slots for an incremental snapshot.
- **Description**: Stores resolved snapshot slot information from a peer, with separate fields for full and incremental snapshot slots.


---
### fd\_ssinfo\_t
- **Type**: ``struct``
- **Members**:
    - ``full``: Contains a `slot` field representing the resolved snapshot slot from a peer.
    - ``incremental``: Contains `base_slot` and `slot` fields representing the resolved incremental snapshot slots from a peer.
- **Description**: Stores resolved snapshot slot information from a peer, with separate fields for full and incremental snapshot slots.


---
### fd\_sscluster\_slot
- **Type**: ``struct``
- **Members**:
    - `full`: Stores the highest full snapshot slot seen in the cluster.
    - `incremental`: Stores the highest incremental snapshot slot seen in the cluster.
- **Description**: Stores the highest full and incremental snapshot slot pair observed in the cluster, providing a way to track the most recent snapshot data available.


---
### fd\_sscluster\_slot\_t
- **Type**: ``struct``
- **Members**:
    - ``full``: Stores the highest full snapshot slot seen in the cluster.
    - ``incremental``: Stores the highest incremental snapshot slot seen in the cluster.
- **Description**: Stores the highest full and incremental snapshot slot pair observed in the cluster, which helps in determining the most recent snapshot data available.


---
### fd\_sspeer
- **Type**: ``struct``
- **Members**:
    - `addr`: Address of the peer.
    - `ssinfo`: Resolved snapshot slot information of the peer.
    - `score`: Selector score of the peer.
- **Description**: Represents a selected peer from the snapshot peer selector, including the peer's address, resolved snapshot slots, and selector score.


---
### fd\_sspeer\_t
- **Type**: ``struct``
- **Members**:
    - ``addr``: Address of the peer.
    - ``ssinfo``: Resolved snapshot slot information of the peer.
    - ``score``: Selector score of the peer.
- **Description**: Represents a selected peer from the snapshot peer selector, including the peer's address, resolved snapshot slots, and selector score.


---
### fd\_sspeer\_selector\_t
- **Type**: ``fd_sspeer_selector_t``
- **Members**:
    - ``fd_sspeer_selector_private``: An opaque structure that represents the internal state and data of the snapshot peer selector.
- **Description**: `fd_sspeer_selector_t` is a typedef for an opaque structure `fd_sspeer_selector_private`, which is used to manage the selection of the most optimal snapshot peer for downloading snapshots. The structure is part of a system that continuously evaluates and selects peers based on criteria such as proximity and the recency of the snapshot they serve. The implementation details of `fd_sspeer_selector_private` are hidden, allowing for encapsulation and abstraction of the peer selection logic.


# Function Declarations (Public API)

---
### fd\_sspeer\_selector\_align<!-- {{#callable_declaration:fd_sspeer_selector_align}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sspeer_selector.h#L50>)

Returns the alignment requirement for a snapshot peer selector.
- **Description**: Use this function to obtain the alignment requirement for a snapshot peer selector. This is necessary when allocating memory for a selector to ensure proper alignment. The function does not require any parameters and can be called at any time to retrieve the alignment value.
- **Inputs**: None
- **Output**: The function returns an unsigned long integer representing the alignment requirement in bytes.
- **See Also**: [`fd_sspeer_selector_align`](<fd_sspeer_selector.c.md#fd_sspeer_selector_align>)  (Implementation)


---
### fd\_sspeer\_selector\_footprint<!-- {{#callable_declaration:fd_sspeer_selector_footprint}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sspeer_selector.h#L55>)

Calculate the memory footprint required for a peer selector.
- **Description**: Use this function to determine the amount of memory needed to store a peer selector for a given number of peers. This is useful when allocating memory for the peer selector structure. The function calculates the footprint based on the maximum number of peers specified. Ensure that the `max_peers` parameter is a positive number to avoid undefined behavior.
- **Inputs**:
    - `max_peers`: Specifies the maximum number of peers the selector will manage. Must be a positive integer. If the value is zero or negative, the behavior is undefined.
- **Output**: Returns the size in bytes of the memory footprint required for the peer selector.
- **See Also**: [`fd_sspeer_selector_footprint`](<fd_sspeer_selector.c.md#fd_sspeer_selector_footprint>)  (Implementation)


---
### fd\_sspeer\_selector\_new<!-- {{#callable_declaration:fd_sspeer_selector_new}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sspeer_selector.h#L58>)

Creates a new snapshot peer selector.
- **Description**: Use this function to create a new snapshot peer selector, which selects the most optimal peer for downloading snapshots. Ensure that `shmem` is a valid, aligned memory region and `max_peers` is at least 1. The function initializes the selector with the given parameters and returns a pointer to the new selector. If any preconditions are not met, the function returns `NULL`.
- **Inputs**:
    - `shmem`: A pointer to a shared memory region where the selector will be created. Must not be null and must be aligned according to `fd_sspeer_selector_align()`.
    - `max_peers`: The maximum number of peers the selector can manage. Must be at least 1.
    - `incremental_snapshot_fetch`: An integer flag indicating whether incremental snapshot fetching is enabled.
    - `seed`: A seed value for initializing internal data structures.
- **Output**: Returns a pointer to the newly created snapshot peer selector, or `NULL` if an error occurs.
- **See Also**: [`fd_sspeer_selector_new`](<fd_sspeer_selector.c.md#fd_sspeer_selector_new>)  (Implementation)


---
### fd\_sspeer\_selector\_join<!-- {{#callable_declaration:fd_sspeer_selector_join}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sspeer_selector.h#L64>)

Joins a shared memory snapshot peer selector.
- **Description**: Use this function to join an existing snapshot peer selector that is stored in shared memory. This function checks if the provided pointer is non-null, properly aligned, and has a valid magic number before returning a pointer to the selector. It is important to ensure that the shared memory region is correctly initialized and aligned according to the requirements of the selector before calling this function.
- **Inputs**:
    - `shselector`: A pointer to the shared memory region containing the snapshot peer selector. Must not be null, must be aligned according to `fd_sspeer_selector_align`, and must have a valid magic number. If these conditions are not met, the function returns NULL.
- **Output**: Returns a pointer to the `fd_sspeer_selector_t` if successful, or NULL if the input is invalid.
- **See Also**: [`fd_sspeer_selector_join`](<fd_sspeer_selector.c.md#fd_sspeer_selector_join>)  (Implementation)


---
### fd\_sspeer\_selector\_leave<!-- {{#callable_declaration:fd_sspeer_selector_leave}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sspeer_selector.h#L67>)

Leaves the snapshot peer selector.
- **Description**: Use this function to leave a snapshot peer selector, which is part of a system that selects the most optimal peer for downloading snapshots. This function should be called when the selector is no longer needed. It checks for a valid and aligned `selector` with the correct magic number before proceeding. If any of these checks fail, it logs a warning and returns `NULL`. If successful, it leaves the internal components of the selector and returns a pointer to the selector.
- **Inputs**:
    - `selector`: A pointer to a `fd_sspeer_selector_t` structure. It must not be null, must be aligned according to `fd_sspeer_selector_align()`, and must have a valid magic number (`FD_SSPEER_SELECTOR_MAGIC`). If these conditions are not met, the function logs a warning and returns `NULL`.
- **Output**: Returns a pointer to the `selector` if successful, or `NULL` if the input is invalid.
- **See Also**: [`fd_sspeer_selector_leave`](<fd_sspeer_selector.c.md#fd_sspeer_selector_leave>)  (Implementation)


---
### fd\_sspeer\_selector\_delete<!-- {{#callable_declaration:fd_sspeer_selector_delete}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sspeer_selector.h#L70>)

Deletes a snapshot peer selector.
- **Description**: Use this function to delete a snapshot peer selector when it is no longer needed. This function checks if the provided selector is valid, aligned, and has the correct magic number before proceeding with the deletion. It safely deletes internal resources associated with the selector and resets its magic number to prevent further use. Call this function only when the selector is not in use by any other operations.
- **Inputs**:
    - `shselector`: A pointer to the snapshot peer selector to delete. Must not be null, must be aligned according to `fd_sspeer_selector_align`, and must have a valid magic number. If these conditions are not met, the function logs a warning and returns null.
- **Output**: Returns a pointer to the deleted selector if successful, or null if the input is invalid.
- **See Also**: [`fd_sspeer_selector_delete`](<fd_sspeer_selector.c.md#fd_sspeer_selector_delete>)  (Implementation)


---
### fd\_sspeer\_selector\_add<!-- {{#callable_declaration:fd_sspeer_selector_add}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sspeer_selector.h#L76>)

Add or update a peer in the selector and return the peer's score.
- **Description**: Use this function to add a new peer to the snapshot peer selector or update an existing peer's score based on the provided latency and snapshot information. If the peer already exists, the function updates the peer's score using the given latency and snapshot information. If the peer does not exist, it adds the peer to the selector. The function returns the updated score of the peer. Ensure that the selector is properly initialized before calling this function.
- **Inputs**:
    - `selector`: A pointer to an `fd_sspeer_selector_t` structure. Must not be null. The selector must be initialized before use.
    - `addr`: The address of the peer as an `fd_ip4_port_t`. Represents the network address and port of the peer.
    - `latency`: The latency of the peer as an `ulong`. Represents the time delay associated with the peer.
    - `ssinfo`: A pointer to a constant `fd_ssinfo_t` structure containing snapshot slot information. Can be null, in which case default values are used for the peer's snapshot information.
- **Output**: Returns the updated score of the peer as an `ulong`. If the peer cannot be added due to resource constraints, returns `ULONG_MAX`.
- **See Also**: [`fd_sspeer_selector_add`](<fd_sspeer_selector.c.md#fd_sspeer_selector_add>)  (Implementation)


---
### fd\_sspeer\_selector\_remove<!-- {{#callable_declaration:fd_sspeer_selector_remove}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sspeer_selector.h#L85>)

Removes a peer from the selector.
- **Description**: Use this function to remove a peer from the snapshot peer selector when the peer is not reachable or is serving corrupted or malformed snapshots. This function does nothing if the specified peer does not exist in the selector. It is important to ensure that the selector is properly initialized and that the peer address is valid before calling this function.
- **Inputs**:
    - `selector`: A pointer to an `fd_sspeer_selector_t` structure. Must not be null. The caller retains ownership.
    - `addr`: The address of the peer to remove, specified as an `fd_ip4_port_t`. The address must be valid and correspond to a peer in the selector.
- **Output**: None
- **See Also**: [`fd_sspeer_selector_remove`](<fd_sspeer_selector.c.md#fd_sspeer_selector_remove>)  (Implementation)


---
### fd\_sspeer\_selector\_best<!-- {{#callable_declaration:fd_sspeer_selector_best}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sspeer_selector.h#L92>)

Selects the best peer for snapshot download.
- **Description**: Use this function to select the most optimal peer for downloading a snapshot. It can select either a full or incremental snapshot based on the `incremental` parameter. If selecting an incremental snapshot, ensure `base_slot` is a valid full snapshot slot. The function returns a peer with the highest score that meets the criteria or a default peer if no suitable peer is found.
- **Inputs**:
    - `selector`: A pointer to an `fd_sspeer_selector_t` structure. Must not be null. Represents the snapshot peer selector.
    - `incremental`: An integer indicating whether to select a peer for an incremental snapshot (non-zero) or a full snapshot (zero). If non-zero, `base_slot` must be valid.
    - `base_slot`: An unsigned long representing the base slot for incremental snapshots. Must not be `ULONG_MAX` if `incremental` is non-zero.
- **Output**: Returns an `fd_sspeer_t` structure representing the selected peer. If no suitable peer is found, returns a default peer with `ULONG_MAX` values.
- **See Also**: [`fd_sspeer_selector_best`](<fd_sspeer_selector.c.md#fd_sspeer_selector_best>)  (Implementation)


---
### fd\_sspeer\_selector\_process\_cluster\_slot<!-- {{#callable_declaration:fd_sspeer_selector_process_cluster_slot}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sspeer_selector.h#L99>)

Updates the cluster slot and re-scores peers.
- **Description**: Use this function to update the internal cluster slot of the selector and re-score all peers when the cluster slot advances. This function should be called whenever there is a new full or incremental slot to process. It is important to ensure that at least one of the slots is not `ULONG_MAX` before calling this function, as both slots being `ULONG_MAX` will result in no operation. The function updates the selector's internal state and re-scores peers based on the new slot information.
- **Inputs**:
    - `selector`: A pointer to an `fd_sspeer_selector_t` structure. Must not be null. The caller retains ownership.
    - `full_slot`: An unsigned long representing the new full slot value. Must not be `ULONG_MAX` unless `incremental_slot` is also `ULONG_MAX`.
    - `incremental_slot`: An unsigned long representing the new incremental slot value. Must not be `ULONG_MAX` unless `full_slot` is also `ULONG_MAX`.
- **Output**: None
- **See Also**: [`fd_sspeer_selector_process_cluster_slot`](<fd_sspeer_selector.c.md#fd_sspeer_selector_process_cluster_slot>)  (Implementation)


---
### fd\_sspeer\_selector\_cluster\_slot<!-- {{#callable_declaration:fd_sspeer_selector_cluster_slot}} -->
[View Source →](<../../../../../../src/discof/restore/utils/fd_sspeer_selector.h#L107>)

Obtain the current cluster slot from the selector.
- **Description**: Use this function to get the highest resolved full and incremental slot pair seen in the cluster from the snapshot peer selector. This function is useful when you need to know the current state of the cluster slots for decision-making or monitoring purposes. Ensure that the `selector` is properly initialized and joined before calling this function to avoid undefined behavior.
- **Inputs**:
    - `selector`: A pointer to an `fd_sspeer_selector_t` structure. Must not be null and must point to a valid, initialized selector. The caller retains ownership of this pointer.
- **Output**: Returns an `fd_sscluster_slot_t` structure containing the highest full and incremental slot pair seen in the cluster.
- **See Also**: [`fd_sspeer_selector_cluster_slot`](<fd_sspeer_selector.c.md#fd_sspeer_selector_cluster_slot>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)