<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements the snapld tile for loading data from local files or HTTP/TCP connections and sending it for decompression.

# Purpose
The code defines a module responsible for managing the loading of data from local files or HTTP/TCP connections and sending it to another module for decompression. The primary structure, `fd_snapld_tile_t`, holds configuration and state information, including file descriptors for local files and an HTTP session object. The module includes functions for initializing resources, managing file descriptors, and handling data transfer operations. It uses a combination of local file access and HTTP requests to retrieve data, which is then published to a downstream component for further processing.

The module is part of a larger system, as indicated by its integration with other components through the use of headers and function calls. It defines several static functions to manage memory allocation, initialize resources, and handle data transfer and control messages. The module also includes a `fd_topo_run_tile_t` structure, which specifies the functions and parameters needed to run the tile within the system's topology. This structure includes function pointers for initialization, resource management, and execution, indicating that the module is designed to be part of a larger, possibly distributed, system.
# Imports and Dependencies

---
- `utils/fd_ssarchive.h`
- `utils/fd_ssctrl.h`
- `utils/fd_sshttp.h`
- `../../disco/topo/fd_topo.h`
- `../../disco/metrics/fd_metrics.h`
- `errno.h`
- `fcntl.h`
- `unistd.h`
- `sys/socket.h`
- `generated/fd_snapld_tile_seccomp.h`
- `../../disco/stem/fd_stem.c`


# Global Variables

---
### fd\_tile\_snapld
- **Type**: ``fd_topo_run_tile_t``
- **Description**: Represents a configuration structure for a tile in a topology that handles loading data from local files or HTTP/TCP connections and sending it to another tile for decompression. It includes function pointers for initialization, running, and resource management, as well as configuration flags and limits.
- **Use**: Used to define and manage the behavior and resources of a tile responsible for data loading and transmission in a distributed system.


# Data Structures

---
### fd\_snapld\_tile\_t
- **Type**: ``struct``
- **Members**:
    - ``config``: Contains configuration data with a file path.
    - ``state``: Indicates the current state of the tile.
    - ``load_full``: Flag to indicate if a full load is required.
    - ``load_file``: Flag to indicate if loading from a file is required.
    - ``sent_meta``: Flag to indicate if metadata has been sent.
    - ``local_full_fd``: File descriptor for the local full snapshot file.
    - ``local_incr_fd``: File descriptor for the local incremental snapshot file.
    - ``sshttp``: Pointer to an HTTP/TCP connection handler.
    - ``in_rd``: Contains a base pointer for input read operations.
    - ``out_dc``: Contains memory workspace and data chunking information for output.
- **Description**: Manages the loading of data from local files or HTTP/TCP connections and sends it to another tile for decompression. It maintains state information, file descriptors for local files, and handles HTTP connections. The structure also includes configuration data, flags for load operations, and workspace details for data output.


# Functions

---
### scratch\_align<!-- {{#callable:scratch_align}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapld_tile.c#L51>)

Calculates the maximum alignment requirement between `fd_snapld_tile_t` and `fd_sshttp_t`.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `fd_ulong_max` to determine the maximum alignment requirement.
    - Uses `alignof(fd_snapld_tile_t)` to get the alignment of `fd_snapld_tile_t`.
    - Calls `fd_sshttp_align()` to get the alignment requirement of `fd_sshttp_t`.
    - Returns the maximum of the two alignment values.
- **Output**: Returns an `ulong` representing the maximum alignment requirement.
- **Functions Called**:
    - [`fd_sshttp_align`](<utils/fd_sshttp.c.md#fd_sshttp_align>)


---
### scratch\_footprint<!-- {{#callable:scratch_footprint}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapld_tile.c#L56>)

Calculates the memory footprint required for a scratch space layout for a tile.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure, which is not used in this function.
- **Logic and Control Flow**:
    - Initialize a variable `l` with `FD_LAYOUT_INIT`.
    - Append the alignment and size of `fd_snapld_tile_t` to `l` using `FD_LAYOUT_APPEND`.
    - Append the alignment and footprint of `fd_sshttp` to `l` using `FD_LAYOUT_APPEND`.
    - Finalize the layout with `FD_LAYOUT_FINI` using `scratch_align()` and return the result.
- **Output**: Returns an `ulong` representing the calculated memory footprint for the scratch space layout.
- **Functions Called**:
    - [`fd_sshttp_align`](<utils/fd_sshttp.c.md#fd_sshttp_align>)
    - [`fd_sshttp_footprint`](<utils/fd_sshttp.c.md#fd_sshttp_footprint>)
    - [`scratch_align`](<#scratch_align>)


---
### privileged\_init<!-- {{#callable:privileged_init}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapld_tile.c#L64>)

Initializes the `fd_snapld_tile_t` context by allocating memory and opening file descriptors for the latest snapshot files.
- **Inputs**:
    - `topo`: A pointer to an `fd_topo_t` structure, which contains topology information.
    - `tile`: A pointer to an `fd_topo_tile_t` structure, which contains tile-specific information, including the snapshot path.
- **Logic and Control Flow**:
    - Allocate scratch memory using `fd_topo_obj_laddr` and `FD_SCRATCH_ALLOC_INIT` for the `fd_snapld_tile_t` context.
    - Attempt to retrieve the latest snapshot file paths and slots using [`fd_ssarchive_latest_pair`](<utils/fd_ssarchive.c.md#fd_ssarchive_latest_pair>).
    - If retrieval fails, set `local_full_fd` and `local_incr_fd` in the context to -1.
    - If retrieval succeeds, open the full snapshot file using `open` and store the file descriptor in `local_full_fd`.
    - If the incremental snapshot slot is valid, open the incremental snapshot file and store the file descriptor in `local_incr_fd`.
    - Log an error and terminate if any `open` operation fails.
- **Output**: No return value; modifies the `fd_snapld_tile_t` context within the allocated scratch memory.
- **Functions Called**:
    - [`fd_ssarchive_latest_pair`](<utils/fd_ssarchive.c.md#fd_ssarchive_latest_pair>)


---
### populate\_allowed\_fds<!-- {{#callable:populate_allowed_fds}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapld_tile.c#L93>)

Populates an array with file descriptors related to logging and local file access, returning the count of populated descriptors.
- **Inputs**:
    - `topo`: A pointer to a `fd_topo_t` structure representing the topology.
    - `tile`: A pointer to a `fd_topo_tile_t` structure representing the tile configuration.
    - `out_fds_cnt`: An unsigned long integer indicating the maximum number of file descriptors that can be stored in `out_fds`.
    - `out_fds`: A pointer to an integer array where the function will store the allowed file descriptors.
- **Logic and Control Flow**:
    - Check if `out_fds_cnt` is less than 4; if true, log an error and terminate.
    - Initialize `out_cnt` to 0 and set `out_fds[0]` to 2, which corresponds to `stderr`.
    - Check if the log file descriptor is valid (not -1); if valid, add it to `out_fds`.
    - Allocate scratch memory and initialize a `fd_snapld_tile_t` context from it.
    - Check if `ctx->local_full_fd` is valid (not -1); if valid, add it to `out_fds`.
    - Check if `ctx->local_incr_fd` is valid (not -1); if valid, add it to `out_fds`.
- **Output**: Returns the number of file descriptors added to `out_fds` as an unsigned long integer.


---
### populate\_allowed\_seccomp<!-- {{#callable:populate_allowed_seccomp}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapld_tile.c#L115>)

Populates a seccomp filter policy for a `fd_snapld_tile_t` context using provided topology and tile information.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure representing the topology configuration.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure representing the tile configuration.
    - ``out_cnt``: An unsigned long integer representing the count of output filters.
    - ``out``: A pointer to an array of `struct sock_filter` where the seccomp filter policy will be populated.
- **Logic and Control Flow**:
    - Retrieve the local address of the object associated with the tile using `fd_topo_obj_laddr` and store it in `scratch`.
    - Initialize the scratch memory allocator with `FD_SCRATCH_ALLOC_INIT`.
    - Allocate memory for a `fd_snapld_tile_t` context using `FD_SCRATCH_ALLOC_APPEND`.
    - Call [`populate_sock_filter_policy_fd_snapld_tile`](<generated/fd_snapld_tile_seccomp.h.md#populate_sock_filter_policy_fd_snapld_tile>) to populate the seccomp filter policy using the provided `out_cnt`, `out`, and file descriptors from the context.
    - Return the instruction count from `sock_filter_policy_fd_snapld_tile_instr_cnt`.
- **Output**: Returns the instruction count of the seccomp filter policy as an unsigned long integer.
- **Functions Called**:
    - [`populate_sock_filter_policy_fd_snapld_tile`](<generated/fd_snapld_tile_seccomp.h.md#populate_sock_filter_policy_fd_snapld_tile>)


---
### unprivileged\_init<!-- {{#callable:unprivileged_init}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapld_tile.c#L128>)

Initializes the unprivileged context for a tile in the topology, setting up memory allocations and HTTP connections.
- **Inputs**:
    - `topo`: A pointer to the `fd_topo_t` structure representing the topology.
    - `tile`: A pointer to the `fd_topo_tile_t` structure representing the tile to initialize.
- **Logic and Control Flow**:
    - Allocate scratch memory for the tile using `fd_topo_obj_laddr` and `FD_SCRATCH_ALLOC_INIT`.
    - Append memory for `fd_snapld_tile_t` and HTTP context using `FD_SCRATCH_ALLOC_APPEND`.
    - Copy the snapshot path from `tile->snapld.snapshots_path` to `ctx->config.path`.
    - Set the initial state of the context to `FD_SNAPSHOT_STATE_IDLE`.
    - Initialize the HTTP context by creating and joining a new HTTP session with [`fd_sshttp_new`](<utils/fd_sshttp.c.md#fd_sshttp_new>) and [`fd_sshttp_join`](<utils/fd_sshttp.c.md#fd_sshttp_join>).
    - Verify that the tile has exactly one input and one output link using `FD_TEST`.
    - Retrieve and verify the input link named "snapct_ld" and set the input read base address.
    - Retrieve and verify the output link named "snapld_dc" and set the output data cache memory, chunk, watermark, and MTU.
- **Output**: No return value; the function initializes the context and sets up the necessary configurations for the tile.
- **Functions Called**:
    - [`fd_sshttp_align`](<utils/fd_sshttp.c.md#fd_sshttp_align>)
    - [`fd_sshttp_footprint`](<utils/fd_sshttp.c.md#fd_sshttp_footprint>)
    - [`fd_sshttp_join`](<utils/fd_sshttp.c.md#fd_sshttp_join>)
    - [`fd_sshttp_new`](<utils/fd_sshttp.c.md#fd_sshttp_new>)


---
### should\_shutdown<!-- {{#callable:should_shutdown}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapld_tile.c#L158>)

Checks if the `ctx` state is set to `FD_SNAPSHOT_STATE_SHUTDOWN`.
- **Inputs**:
    - `ctx`: A pointer to a `fd_snapld_tile_t` structure, which contains the state of the tile.
- **Logic and Control Flow**:
    - Compare the `state` field of the `ctx` structure with `FD_SNAPSHOT_STATE_SHUTDOWN`.
    - Return the result of the comparison as an integer.
- **Output**: Returns 1 if the `ctx` state is `FD_SNAPSHOT_STATE_SHUTDOWN`, otherwise returns 0.


---
### metrics\_write<!-- {{#callable:metrics_write}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapld_tile.c#L163>)

Updates the metric gauge for the `SNAPLD` state with the current state of the `fd_snapld_tile_t` context.
- **Inputs**:
    - `ctx`: A pointer to an `fd_snapld_tile_t` structure representing the context whose state is to be written to the metrics.
- **Logic and Control Flow**:
    - Calls the macro `FD_MGAUGE_SET` with parameters `SNAPLD`, `STATE`, and the current state of the `ctx` cast to `ulong`.
- **Output**: No return value; the function updates a metric gauge.


---
### after\_credit<!-- {{#callable:after_credit}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapld_tile.c#L168>)

Processes data from a file or HTTP connection and updates the state and output buffer accordingly.
- **Inputs**:
    - `ctx`: A pointer to `fd_snapld_tile_t` structure that holds the context and state information for the operation.
    - `stem`: A pointer to `fd_stem_context_t` structure used for publishing messages.
    - `opt_poll_in`: An unused integer pointer parameter.
    - `charge_busy`: A pointer to an integer that indicates if the function has performed work that should be accounted for.
- **Logic and Control Flow**:
    - Check if `ctx->state` is not `FD_SNAPSHOT_STATE_PROCESSING`; if so, return immediately.
    - Convert the current output chunk to a local address using `fd_chunk_to_laddr`.
    - If `ctx->load_file` is true, read data from the appropriate file descriptor into the output buffer.
    - If the read result is less than or equal to zero, handle end-of-file or error conditions, updating `ctx->state` and publishing error messages if necessary.
    - If data is read successfully, publish it and update the output chunk pointer, setting `*charge_busy` to 1.
    - If `ctx->load_file` is false, use [`fd_sshttp_advance`](<utils/fd_sshttp.c.md#fd_sshttp_advance>) to process data from an HTTP connection.
    - Handle different results from [`fd_sshttp_advance`](<utils/fd_sshttp.c.md#fd_sshttp_advance>), including publishing metadata and data, updating the state, and handling errors.
- **Output**: No direct output is returned, but the function updates the state of `ctx`, modifies the output buffer, and may publish messages using `fd_stem_publish`.
- **Functions Called**:
    - [`fd_sshttp_advance`](<utils/fd_sshttp.c.md#fd_sshttp_advance>)
    - [`fd_sshttp_snapshot_names`](<utils/fd_sshttp.c.md#fd_sshttp_snapshot_names>)
    - [`fd_sshttp_content_len`](<utils/fd_sshttp.c.md#fd_sshttp_content_len>)


---
### returnable\_frag<!-- {{#callable:returnable_frag}} -->
[View Source →](<../../../../../src/discof/restore/fd_snapld_tile.c#L236>)

Handles control messages for snapshot operations, updating the state of the `fd_snapld_tile_t` context and forwarding messages downstream.
- **Inputs**:
    - `ctx`: Pointer to the `fd_snapld_tile_t` context structure.
    - `in_idx`: Unused input parameter.
    - `seq`: Unused input parameter.
    - `sig`: Signal indicating the type of control message.
    - `chunk`: Chunk identifier for the message.
    - `sz`: Size of the message.
    - `ctl`: Unused input parameter.
    - `tsorig`: Unused input parameter.
    - `tspub`: Unused input parameter.
    - `stem`: Pointer to the `fd_stem_context_t` structure for publishing messages.
- **Logic and Control Flow**:
    - Switches on the `sig` parameter to determine the type of control message.
    - For `FD_SNAPSHOT_MSG_CTRL_INIT_FULL` and `FD_SNAPSHOT_MSG_CTRL_INIT_INCR`, checks if the context state is `FD_SNAPSHOT_STATE_IDLE` and initializes the snapshot loading process.
    - For `FD_SNAPSHOT_MSG_CTRL_FAIL`, cancels the HTTP operation and sets the context state to `FD_SNAPSHOT_STATE_IDLE`.
    - For `FD_SNAPSHOT_MSG_CTRL_NEXT` and `FD_SNAPSHOT_MSG_CTRL_DONE`, checks if the context state is `FD_SNAPSHOT_STATE_FINISHING` and sets it to `FD_SNAPSHOT_STATE_IDLE`, otherwise sets it to `FD_SNAPSHOT_STATE_ERROR`.
    - For `FD_SNAPSHOT_MSG_CTRL_SHUTDOWN`, sets the context state to `FD_SNAPSHOT_STATE_SHUTDOWN` and writes metrics.
    - Logs an error for any invalid `sig` values.
    - Publishes the control message downstream using `fd_stem_publish`.
- **Output**: Returns 0 after processing the control message.
- **Functions Called**:
    - [`fd_sshttp_init`](<utils/fd_sshttp.c.md#fd_sshttp_init>)
    - [`fd_sshttp_cancel`](<utils/fd_sshttp.c.md#fd_sshttp_cancel>)
    - [`metrics_write`](<#metrics_write>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)