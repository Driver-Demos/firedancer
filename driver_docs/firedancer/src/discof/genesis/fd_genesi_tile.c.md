<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a tile for managing Solana genesis files, including local file handling and peer retrieval.

# Purpose
The code is a C source file that defines a module for handling the initialization and management of a "genesis" file in a distributed system. The module is part of a larger system that appears to be related to blockchain or distributed ledger technology, as indicated by the use of terms like "genesis", "accounts", and "hashes". The primary functionality of this module is to manage the loading and verification of a genesis file, which is a critical component in blockchain systems as it contains the initial state of the ledger.

The module defines a structure `fd_genesi_tile_t` that encapsulates the state and resources needed for managing the genesis file, including file descriptors, memory buffers, and hash values. It includes functions for initializing the module in both privileged and unprivileged contexts, handling local and remote genesis files, and verifying the integrity and type of the genesis data. The code also integrates with other components of the system, such as account databases and hash functions, to ensure the genesis data is correctly processed and verified. The module is designed to be part of a larger system, as indicated by its integration with other components and its use of external libraries and headers.
# Imports and Dependencies

---
- `linux/limits.h`
- `fd_genesi_tile.h`
- `fd_genesis_client.h`
- `../../disco/topo/fd_topo.h`
- `../../ballet/sha256/fd_sha256.h`
- `../../flamenco/runtime/fd_txn_account.h`
- `../../flamenco/accdb/fd_accdb_admin.h`
- `../../flamenco/accdb/fd_accdb_user.h`
- `../../flamenco/runtime/fd_hashes.h`
- `../../util/archive/fd_tar.h`
- `stdio.h`
- `errno.h`
- `fcntl.h`
- `sys/poll.h`
- `sys/socket.h`
- `sys/stat.h`
- `unistd.h`
- `netinet/in.h`
- `linux/fs.h`
- `bzlib.h`
- `generated/fd_genesi_tile_seccomp.h`
- `../../disco/stem/fd_stem.c`


# Global Variables

---
### fd\_tile\_genesi
- **Type**: ``fd_topo_run_tile_t``
- **Description**: Represents a configuration structure for a tile in the topology, specifically for the 'genesi' tile. It includes function pointers and parameters that define the behavior and resource limits of the tile.
- **Use**: Used to configure and manage the 'genesi' tile within the system's topology.


# Data Structures

---
### fd\_genesi\_tile
- **Type**: ``struct``
- **Members**:
    - ``accdb_admin``: An array of one `fd_accdb_admin_t` structure for account database administration.
    - ``accdb``: An array of one `fd_accdb_user_t` structure for user account database.
    - ``genesis_hash``: A 32-byte array storing the hash of the genesis block.
    - ``client``: A pointer to an `fd_genesis_client_t` structure for client operations.
    - ``lthash``: An array of one `fd_lthash_value_t` structure for ledger transaction hash.
    - ``local_genesis``: An integer flag indicating if the genesis is local.
    - ``bootstrap``: An integer flag indicating if the system is in bootstrap mode.
    - ``shutdown``: An integer flag indicating if the system should shut down.
    - ``has_expected_genesis_hash``: An integer flag indicating if there is an expected genesis hash.
    - ``expected_genesis_hash``: A 32-byte array storing the expected genesis hash.
    - ``expected_shred_version``: A 16-bit unsigned integer storing the expected shred version.
    - ``genesis_sz``: An unsigned long storing the size of the genesis data.
    - ``genesis``: A buffer for decoded genesis data, aligned to `fd_genesis_solana_global_t`.
    - ``buffer``: A buffer for reading the genesis file.
    - ``genesis_path``: A character array storing the path to the genesis file.
    - ``in_fd``: An integer file descriptor for input operations.
    - ``out_fd``: An integer file descriptor for output operations.
    - ``out_dir_fd``: An integer file descriptor for the output directory.
    - ``out_mem``: A pointer to an `fd_wksp_t` structure for output memory workspace.
    - ``out_chunk0``: An unsigned long indicating the initial output chunk.
    - ``out_wmark``: An unsigned long indicating the watermark for output operations.
    - ``out_chunk``: An unsigned long indicating the current output chunk.
    - ``bz2_alloc``: A pointer to an `fd_alloc_t` structure for BZ2 memory allocation.
- **Description**: Manages the state and operations related to the genesis block in a distributed ledger system, including handling account databases, genesis data, and client interactions. It includes flags for system state, buffers for data storage, and file descriptors for input/output operations.


---
### fd\_genesi\_tile\_t
- **Type**: ``struct``
- **Members**:
    - ``accdb_admin``: An array of one `fd_accdb_admin_t` structure for account database administration.
    - ``accdb``: An array of one `fd_accdb_user_t` structure for user account database.
    - ``genesis_hash``: A 32-byte array storing the hash of the genesis block.
    - ``client``: A pointer to an `fd_genesis_client_t` structure for client operations.
    - ``lthash``: An array of one `fd_lthash_value_t` structure for storing hash values.
    - ``local_genesis``: An integer flag indicating if the genesis is local.
    - ``bootstrap``: An integer flag indicating if the system is in bootstrap mode.
    - ``shutdown``: An integer flag indicating if the system should shut down.
    - ``has_expected_genesis_hash``: An integer flag indicating if an expected genesis hash is set.
    - ``expected_genesis_hash``: A 32-byte array storing the expected genesis hash.
    - ``expected_shred_version``: A 16-bit unsigned integer storing the expected shred version.
    - ``genesis_sz``: An unsigned long storing the size of the genesis data.
    - ``genesis``: A buffer for decoded genesis data, aligned to `fd_genesis_solana_global_t`.
    - ``buffer``: A buffer for reading the genesis file.
    - ``genesis_path``: A character array storing the path to the genesis file.
    - ``in_fd``: An integer file descriptor for input operations.
    - ``out_fd``: An integer file descriptor for output operations.
    - ``out_dir_fd``: An integer file descriptor for the output directory.
    - ``out_mem``: A pointer to an `fd_wksp_t` structure for output memory workspace.
    - ``out_chunk0``: An unsigned long indicating the initial output chunk.
    - ``out_wmark``: An unsigned long indicating the watermark for output.
    - ``out_chunk``: An unsigned long indicating the current output chunk.
    - ``bz2_alloc``: A pointer to an `fd_alloc_t` structure for BZ2 memory allocation.
- **Description**: The `fd_genesi_tile_t` structure manages the genesis process, including reading and verifying the genesis file, handling account databases, and managing client operations. It contains various fields for storing genesis data, file descriptors for input and output operations, and flags for controlling the process flow. The structure also includes buffers for data handling and pointers to client and memory allocation structures.


# Functions

---
### bz2\_malloc<!-- {{#callable:bz2_malloc}} -->
[View Source →](<../../../../../src/discof/genesis/fd_genesi_tile.c#L29>)

Allocates memory using a custom allocator and returns a pointer to the allocated memory.
- **Inputs**:
    - ``opaque``: A pointer to a custom allocator of type `fd_alloc_t`.
    - ``items``: The number of items to allocate.
    - ``size``: The size of each item to allocate.
- **Logic and Control Flow**:
    - Casts the `opaque` pointer to a `fd_alloc_t` pointer named `alloc`.
    - Calculates the total size to allocate by multiplying `items` and `size`.
    - Calls `fd_alloc_malloc` with `alloc`, alignment of `max_align_t`, and the calculated size to allocate memory.
    - Checks if the result of `fd_alloc_malloc` is `NULL` using `FD_UNLIKELY`; if so, returns `NULL`.
    - Returns the pointer to the allocated memory.
- **Output**: A pointer to the allocated memory, or `NULL` if the allocation fails.


---
### bz2\_free<!-- {{#callable:bz2_free}} -->
[View Source →](<../../../../../src/discof/genesis/fd_genesi_tile.c#L40>)

Frees a memory block using a custom allocator if the address is not null.
- **Inputs**:
    - ``opaque``: A pointer to a custom allocator of type `fd_alloc_t`.
    - ``addr``: A pointer to the memory block to be freed.
- **Logic and Control Flow**:
    - Cast `opaque` to `fd_alloc_t *` and store it in `alloc`.
    - Check if `addr` is null using `FD_UNLIKELY`; if true, return immediately.
    - Call `fd_alloc_free` with `alloc` and `addr` to free the memory block.
- **Output**: No return value (void function).


---
### scratch\_align<!-- {{#callable:scratch_align}} -->
[View Source →](<../../../../../src/discof/genesis/fd_genesi_tile.c#L87>)

Returns the alignment requirement of the `fd_genesi_tile_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls the `alignof` operator on the `fd_genesi_tile_t` type to determine its alignment requirement.
    - Returns the result of the `alignof` operation.
- **Output**: The alignment requirement of the `fd_genesi_tile_t` structure as an `ulong`.


---
### scratch\_footprint<!-- {{#callable:scratch_footprint}} -->
[View Source →](<../../../../../src/discof/genesis/fd_genesi_tile.c#L92>)

Calculates the memory footprint required for a scratch space based on the alignment and size of various components.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure, which is not used in the function.
- **Logic and Control Flow**:
    - Initialize `l` with `FD_LAYOUT_INIT`.
    - Append the alignment and size of `fd_genesi_tile_t` to `l` using `FD_LAYOUT_APPEND`.
    - Append the alignment and footprint of `fd_genesis_client` to `l` using `FD_LAYOUT_APPEND`.
    - Append the alignment and footprint of `fd_alloc` to `l` using `FD_LAYOUT_APPEND`.
    - Finalize the layout with `FD_LAYOUT_FINI` using `scratch_align()` and return the result.
- **Output**: Returns an `ulong` representing the total memory footprint required for the scratch space.
- **Functions Called**:
    - [`fd_genesis_client_align`](<fd_genesis_client.c.md#fd_genesis_client_align>)
    - [`fd_genesis_client_footprint`](<fd_genesis_client.c.md#fd_genesis_client_footprint>)
    - [`scratch_align`](<#scratch_align>)


---
### loose\_footprint<!-- {{#callable:loose_footprint}} -->
[View Source →](<../../../../../src/discof/genesis/fd_genesi_tile.c#L103>)

Returns a constant value representing the leftover space for bzip2 allocations.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure, which is not used in the function.
- **Logic and Control Flow**:
    - The function takes a single argument `tile`, which is not used in the function body.
    - The function returns a constant value `1UL<<26`, which is equivalent to 64 MiB.
- **Output**: A constant unsigned long integer value of 64 MiB (1UL<<26).


---
### should\_shutdown<!-- {{#callable:should_shutdown}} -->
[View Source →](<../../../../../src/discof/genesis/fd_genesi_tile.c#L110>)

Checks if the `shutdown` flag in the `fd_genesi_tile_t` context is set.
- **Inputs**:
    - `ctx`: A pointer to an `fd_genesi_tile_t` structure, which contains the `shutdown` flag to check.
- **Logic and Control Flow**:
    - Accesses the `shutdown` member of the `fd_genesi_tile_t` structure pointed to by `ctx`.
    - Returns the value of the `shutdown` member.
- **Output**: Returns an integer representing the value of the `shutdown` flag in the `fd_genesi_tile_t` context.


---
### initialize\_accdb<!-- {{#callable:initialize_accdb}} -->
[View Source →](<../../../../../src/discof/genesis/fd_genesi_tile.c#L115>)

Initializes the account database by inserting accounts from the genesis data into the root transaction.
- **Inputs**:
    - `ctx`: A pointer to a `fd_genesi_tile_t` structure that contains the context for the account database initialization.
- **Logic and Control Flow**:
    - Set the root transaction ID using `fd_funk_txn_xid_set_root`.
    - Retrieve the genesis data from the context using `fd_type_pun`.
    - Join the accounts from the genesis data using `fd_genesis_solana_accounts_join`.
    - Iterate over each account in the genesis data.
    - For each account, prepare a record key and prepare a record using `fd_funk_rec_prepare`.
    - Check if the record preparation was successful using `FD_TEST`.
    - Truncate the record value to fit the account metadata and data using `fd_funk_val_truncate`.
    - Check if the truncation was successful using `FD_TEST`.
    - Copy the account owner, lamports, slot, executable flag, and data length into the metadata.
    - Copy the account data into the allocated space after the metadata.
    - Publish the prepared record using `fd_funk_rec_publish`.
    - Compute a new hash for the account using `fd_hashes_account_lthash`.
    - Add the new hash to the local transaction hash using `fd_lthash_add`.
- **Output**: No return value; the function modifies the account database in the context.


---
### verify\_cluster\_type<!-- {{#callable:verify_cluster_type}} -->
[View Source →](<../../../../../src/discof/genesis/fd_genesi_tile.c#L149>)

Verifies that the `genesis_hash` matches the expected hash for the specified cluster type in the `genesis` object.
- **Inputs**:
    - `genesis`: A pointer to a `fd_genesis_solana_global_t` structure that contains the cluster type information.
    - `genesis_hash`: A pointer to a 32-byte array representing the hash of the genesis file.
    - `genesis_path`: A string representing the file path to the genesis file.
- **Logic and Control Flow**:
    - Define constants for cluster types: `TESTNET`, `MAINNET`, `DEVNET`, and `DEVELOPMENT`.
    - Decode base58 strings into 32-byte arrays for `mainnet_hash`, `testnet_hash`, and `devnet_hash`.
    - Use a switch statement to check the `cluster_type` in the `genesis` object.
    - For `MAINNET`, compare `genesis_hash` with `mainnet_hash` and log an error if they do not match.
    - For `TESTNET`, compare `genesis_hash` with `testnet_hash` and log an error if they do not match.
    - For `DEVNET`, compare `genesis_hash` with `devnet_hash` and log an error if they do not match.
    - Do nothing for other cluster types.
- **Output**: No return value; logs an error if the `genesis_hash` does not match the expected hash for the cluster type.


---
### after\_credit<!-- {{#callable:after_credit}} -->
[View Source →](<../../../../../src/discof/genesis/fd_genesi_tile.c#L199>)

Handles the processing of genesis data, either from a local file or by retrieving and decompressing it from a remote peer, and updates the system state accordingly.
- **Inputs**:
    - ``ctx``: A pointer to a `fd_genesi_tile_t` structure that holds the context and state information for the genesis processing.
    - ``stem``: A pointer to a `fd_stem_context_t` structure used for publishing events.
    - ``opt_poll_in``: An optional pointer to an integer, not used in the function.
    - ``charge_busy``: A pointer to an integer that indicates if the system is busy processing.
- **Logic and Control Flow**:
    - Check if `ctx->shutdown` is true; if so, return immediately.
    - If `ctx->local_genesis` is true, process the local genesis file by copying data to the output memory and publishing the appropriate event.
    - If `ctx->bootstrap` is true, copy additional bootstrap data and publish a bootstrap completion event.
    - If `ctx->local_genesis` is false, attempt to retrieve genesis data from a remote peer using [`fd_genesis_client_poll`](<fd_genesis_client.c.md#fd_genesis_client_poll>).
    - If retrieval fails, log an error and exit; if successful, decompress the data using BZ2 functions.
    - Verify the decompressed data, calculate its hash, and compare it with the expected hash if applicable.
    - Decode the genesis data and verify its cluster type.
    - Copy the hash to the output memory, publish the genesis hash event, and write the decompressed data to a file.
    - Rename the temporary file to its final name and log the successful retrieval.
    - Set `ctx->shutdown` to true to indicate completion.
- **Output**: No direct output is returned; the function modifies the state of `ctx` and `charge_busy`, and logs messages or errors as needed.
- **Functions Called**:
    - [`fd_genesis_client_poll`](<fd_genesis_client.c.md#fd_genesis_client_poll>)
    - [`verify_cluster_type`](<#verify_cluster_type>)


---
### process\_local\_genesis<!-- {{#callable:process_local_genesis}} -->
[View Source →](<../../../../../src/discof/genesis/fd_genesi_tile.c#L323>)

Processes a local genesis file by reading, validating, and decoding it, then verifies its hash and cluster type.
- **Inputs**:
    - ``ctx``: A pointer to an `fd_genesi_tile_t` structure that contains context information for processing the genesis file.
    - ``genesis_path``: A constant character pointer to the path of the genesis file to be processed.
- **Logic and Control Flow**:
    - Use `fstat` to get the size of the file associated with `ctx->in_fd` and store it in `size`.
    - Check if the file size exceeds the buffer size in `ctx->buffer`; if so, log an error and exit.
    - Read the file in a loop until the entire file is read into `ctx->buffer`, logging an error if `read` fails or returns 0 prematurely.
    - Close the file descriptor `ctx->in_fd` and log an error if `close` fails.
    - Initialize a `fd_bincode_decode_ctx_t` structure with the buffer data and its end.
    - Decode the genesis footprint using `fd_genesis_solana_decode_footprint` and store the size in `ctx->genesis_sz`, logging an error if decoding fails or if the size exceeds `ctx->genesis`.
    - Decode the global genesis data using `fd_genesis_solana_decode_global` and verify the result.
    - Compute the SHA-256 hash of the buffer and store it in `hash.c`.
    - Call [`verify_cluster_type`](<#verify_cluster_type>) to check the cluster type against the computed hash.
    - Copy the computed hash to `ctx->genesis_hash`.
    - If `ctx->bootstrap` and `ctx->expected_shred_version` are set, compute a shred version from the hash and verify it against `ctx->expected_shred_version`, logging an error if they do not match.
    - If `ctx->has_expected_genesis_hash` is set, compare `ctx->genesis_hash` with `ctx->expected_genesis_hash` and log an error if they do not match.
- **Output**: No return value; the function logs errors and exits on failure conditions.
- **Functions Called**:
    - [`verify_cluster_type`](<#verify_cluster_type>)


---
### privileged\_init<!-- {{#callable:privileged_init}} -->
[View Source →](<../../../../../src/discof/genesis/fd_genesi_tile.c#L392>)

Initializes a privileged context for a tile by setting up local or remote genesis file handling.
- **Inputs**:
    - ``topo``: A pointer to an `fd_topo_t` structure representing the topology.
    - ``tile``: A pointer to an `fd_topo_tile_t` structure representing the tile configuration.
- **Logic and Control Flow**:
    - Allocate scratch memory for the tile using `fd_topo_obj_laddr` and `FD_SCRATCH_ALLOC_INIT`.
    - Append memory for `fd_genesi_tile_t` and `fd_genesis_client_t` structures using `FD_SCRATCH_ALLOC_APPEND`.
    - Set `ctx->local_genesis` to 1, indicating local genesis handling.
    - Attempt to open the genesis file specified by `tile->genesi.genesis_path` with read-only and close-on-exec flags.
    - If the file does not exist (`errno == ENOENT`), log an informational message and check if the tile is bootstrapping the cluster without entrypoints.
    - If no entrypoints are provided and downloading is not allowed, log an error and exit.
    - If downloading is allowed, prepare the directory for downloading the genesis file, switching to non-root user and group IDs for file creation.
    - Open a partial genesis file for writing and set `ctx->local_genesis` to 0, indicating remote genesis handling.
    - Initialize the genesis client with entrypoints if available.
- **Output**: No return value; the function initializes the context for handling genesis files.
- **Functions Called**:
    - [`fd_genesis_client_align`](<fd_genesis_client.c.md#fd_genesis_client_align>)
    - [`fd_genesis_client_footprint`](<fd_genesis_client.c.md#fd_genesis_client_footprint>)
    - [`fd_genesis_client_join`](<fd_genesis_client.c.md#fd_genesis_client_join>)
    - [`fd_genesis_client_new`](<fd_genesis_client.c.md#fd_genesis_client_new>)
    - [`fd_genesis_client_init`](<fd_genesis_client.c.md#fd_genesis_client_init>)


---
### unprivileged\_init<!-- {{#callable:unprivileged_init}} -->
[View Source →](<../../../../../src/discof/genesis/fd_genesi_tile.c#L454>)

Initializes the unprivileged context for a tile in a topology, setting up memory allocations, joining databases, and preparing for genesis processing.
- **Inputs**:
    - ``topo``: A pointer to an `fd_topo_t` structure representing the topology configuration.
    - ``tile``: A pointer to an `fd_topo_tile_t` structure representing the specific tile configuration within the topology.
- **Logic and Control Flow**:
    - Allocate scratch memory using `fd_topo_obj_laddr` to get the local address of the tile object ID.
    - Initialize scratch memory allocation with `FD_SCRATCH_ALLOC_INIT`.
    - Append allocations for `fd_genesi_tile_t`, `fd_genesis_client`, and a generic allocator using `FD_SCRATCH_ALLOC_APPEND`.
    - Join the admin and user databases using `fd_accdb_admin_join` and `fd_accdb_user_join`.
    - Zero out the `lthash` in the context structure.
    - Set `shutdown` to 0 and determine if bootstrapping is needed based on `entrypoints_cnt`.
    - Copy expected genesis hash and shred version from `tile` to `ctx`.
    - If `in_fd` is valid, call [`process_local_genesis`](<#process_local_genesis>) and [`initialize_accdb`](<#initialize_accdb>) if bootstrapping.
    - Check and format the genesis path using `fd_cstr_printf_check`.
    - Set up output memory, chunk, and watermark using `fd_dcache_compact_chunk0` and `fd_dcache_compact_wmark`.
    - Join the BZ2 allocator with `fd_alloc_join`.
    - Finalize scratch allocation and check for overflow with `FD_SCRATCH_ALLOC_FINI`.
- **Output**: No return value; the function operates by side effects on the provided `topo` and `tile` structures.
- **Functions Called**:
    - [`fd_genesis_client_align`](<fd_genesis_client.c.md#fd_genesis_client_align>)
    - [`fd_genesis_client_footprint`](<fd_genesis_client.c.md#fd_genesis_client_footprint>)
    - [`process_local_genesis`](<#process_local_genesis>)
    - [`initialize_accdb`](<#initialize_accdb>)
    - [`scratch_footprint`](<#scratch_footprint>)


---
### rlimit\_file\_cnt<!-- {{#callable:rlimit_file_cnt}} -->
[View Source →](<../../../../../src/discof/genesis/fd_genesi_tile.c#L494>)

Calculates the number of file descriptors needed for a tile, including standard files and entrypoints.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, which is not used in this function.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure, which contains the `entrypoints_cnt` field used to determine the number of entrypoints.
- **Logic and Control Flow**:
    - Initialize the file descriptor count with 4, accounting for standard files: stderr, logfile, genesis file, and genesis directory.
    - Add the number of entrypoints from `tile->genesi.entrypoints_cnt` to the file descriptor count.
- **Output**: Returns the total number of file descriptors as an unsigned long integer.


---
### populate\_allowed\_seccomp<!-- {{#callable:populate_allowed_seccomp}} -->
[View Source →](<../../../../../src/discof/genesis/fd_genesi_tile.c#L504>)

Configures seccomp filters for a specific tile based on its file descriptors.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure representing the topology.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure representing the tile configuration.
    - ``out_cnt``: An unsigned long integer representing the count of output filters.
    - ``out``: A pointer to an array of `sock_filter` structures where the seccomp filters will be stored.
- **Logic and Control Flow**:
    - Allocate scratch memory using `fd_topo_obj_laddr` and `FD_SCRATCH_ALLOC_INIT`.
    - Append a `fd_genesi_tile_t` structure to the scratch memory using `FD_SCRATCH_ALLOC_APPEND`.
    - Determine the file descriptors (`in_fd`, `out_fd`, `out_dir_fd`) based on the context's `in_fd` value.
    - Call [`populate_sock_filter_policy_fd_genesi_tile`](<generated/fd_genesi_tile_seccomp.h.md#populate_sock_filter_policy_fd_genesi_tile>) with the determined file descriptors and other parameters to populate the seccomp filters.
    - Return the instruction count from `sock_filter_policy_fd_genesi_tile_instr_cnt`.
- **Output**: Returns an unsigned long integer representing the number of seccomp filter instructions.
- **Functions Called**:
    - [`populate_sock_filter_policy_fd_genesi_tile`](<generated/fd_genesi_tile_seccomp.h.md#populate_sock_filter_policy_fd_genesi_tile>)


---
### populate\_allowed\_fds<!-- {{#callable:populate_allowed_fds}} -->
[View Source →](<../../../../../src/discof/genesis/fd_genesi_tile.c#L530>)

Populates an array with file descriptors that are allowed for a specific tile in a topology.
- **Inputs**:
    - `topo`: A pointer to a `fd_topo_t` structure representing the topology.
    - `tile`: A pointer to a `fd_topo_tile_t` structure representing the tile within the topology.
    - `out_fds_cnt`: The maximum number of file descriptors that can be stored in the `out_fds` array.
    - `out_fds`: A pointer to an array of integers where the allowed file descriptors will be stored.
- **Logic and Control Flow**:
    - Allocate scratch memory and initialize a `fd_genesi_tile_t` context from the topology and tile information.
    - Check if `out_fds_cnt` is less than the required number of file descriptors (`tile->genesi.entrypoints_cnt + 5`). If so, log an error and exit.
    - Initialize `out_cnt` to 0 and add the file descriptor for `stderr` to `out_fds`.
    - If a logfile file descriptor is available, add it to `out_fds`.
    - If `ctx->in_fd` is -1, indicating no input file descriptor, add `ctx->out_dir_fd` and `ctx->out_fd` to `out_fds`.
    - Iterate over the entry points in `tile->genesi.entrypoints_cnt`, adding each valid file descriptor from `ctx->client` to `out_fds`.
    - If `ctx->in_fd` is not -1, add it to `out_fds`.
    - Return the count of file descriptors added to `out_fds`.
- **Output**: Returns the number of file descriptors added to the `out_fds` array.
- **Functions Called**:
    - [`fd_genesis_client_get_pollfds`](<fd_genesis_client.c.md#fd_genesis_client_get_pollfds>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)