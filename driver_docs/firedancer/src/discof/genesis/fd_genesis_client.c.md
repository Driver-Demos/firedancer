<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a client for connecting to and communicating with genesis servers using HTTP over TCP.

# Purpose
The code defines a C module for a client that connects to multiple servers to download a file named `genesis.tar.bz2`. It uses non-blocking sockets and the `poll` system call to manage multiple connections simultaneously. The module includes functions to initialize the client, establish connections to specified servers, send HTTP GET requests, and read responses. The client is designed to handle up to `FD_TOPO_GOSSIP_ENTRYPOINTS_MAX` connections, and it processes responses using the `picohttpparser` library to parse HTTP headers and check for a successful status code (200 OK). The module also includes functions to close individual or all connections and to compute a SHA-256 hash of the downloaded content.

The module provides a public API for creating and managing a `fd_genesis_client_t` instance, which represents the client state. The [`fd_genesis_client_new`](<#fd_genesis_client_new>) and [`fd_genesis_client_join`](<#fd_genesis_client_join>) functions are used to allocate and initialize the client in shared memory. The [`fd_genesis_client_init`](<#fd_genesis_client_init>) function sets up connections to the specified servers, and [`fd_genesis_client_poll`](<#fd_genesis_client_poll>) is used to poll the connections for activity, handling both outgoing requests and incoming responses. The module also includes utility functions to retrieve the client's poll file descriptors and to align and calculate the memory footprint of the client structure.
# Imports and Dependencies

---
- `fd_genesis_client.h`
- `../../waltz/http/picohttpparser.h`
- `../../disco/topo/fd_topo.h`
- `../../util/fd_util.h`
- `../../ballet/sha256/fd_sha256.h`
- `errno.h`
- `netinet/in.h`
- `string.h`
- `strings.h`
- `sys/socket.h`
- `unistd.h`
- `sys/poll.h`
- `stdlib.h`


# Data Structures

---
### fd\_genesis\_client\_peer
- **Type**: ``struct``
- **Members**:
    - ``addr``: Stores the IP address and port of the peer.
    - ``writing``: Indicates if the peer is currently writing data.
    - ``request_bytes_sent``: Tracks the number of bytes sent in the request.
    - ``response_bytes_read``: Tracks the number of bytes read in the response.
    - ``response``: Holds the response data with a maximum size of 10 MiB.
- **Description**: Manages the state and data transfer details for a peer in the Genesis client, including network address, data transfer status, and response storage.


---
### fd\_genesis\_client\_peer\_t
- **Type**: ``struct``
- **Members**:
    - ``addr``: Stores the IP address and port of the peer.
    - ``writing``: Indicates if the peer is currently writing data.
    - ``request_bytes_sent``: Tracks the number of bytes sent in the request.
    - ``response_bytes_read``: Tracks the number of bytes read in the response.
    - ``response``: Holds the response data with a maximum size of 10 MiB.
- **Description**: Manages the state and data for a peer in the Genesis client, including network address, data transmission status, and response handling.


---
### fd\_genesis\_client\_private
- **Type**: ``struct``
- **Members**:
    - `start_time_nanos`: Stores the start time in nanoseconds.
    - `peer_cnt`: Holds the count of peers.
    - `remaining_peer_cnt`: Tracks the number of remaining peers.
    - `pollfds`: Array of `struct pollfd` for managing file descriptors for polling.
    - `peers`: Array of `fd_genesis_client_peer_t` representing the peers.
    - `magic`: Stores a magic number for validation purposes.
- **Description**: Manages the state and operations of a genesis client, including tracking peers, managing connections, and handling network polling.


# Functions

---
### fd\_genesis\_client\_align<!-- {{#callable:fd_genesis_client_align}} -->
[View Source →](<../../../../../src/discof/genesis/fd_genesis_client.c#L39>)

Returns the alignment requirement of the `fd_genesis_client_t` type.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls the `alignof` operator on `fd_genesis_client_t` to determine its alignment requirement.
    - Returns the result of the `alignof` operation.
- **Output**: The alignment requirement of the `fd_genesis_client_t` type as an `ulong`.


---
### fd\_genesis\_client\_footprint<!-- {{#callable:fd_genesis_client_footprint}} -->
[View Source →](<../../../../../src/discof/genesis/fd_genesis_client.c#L44>)

Calculates the memory footprint of the `fd_genesis_client_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Return the size of the `fd_genesis_client_t` structure using the `sizeof` operator.
- **Output**: Returns an `ulong` representing the size of the `fd_genesis_client_t` structure.


---
### fd\_genesis\_client\_new<!-- {{#callable:fd_genesis_client_new}} -->
[View Source →](<../../../../../src/discof/genesis/fd_genesis_client.c#L49>)

Initializes a new `fd_genesis_client_t` structure in shared memory, ensuring proper alignment and setting a magic number for validation.
- **Inputs**:
    - `shmem`: A pointer to shared memory where the `fd_genesis_client_t` structure will be initialized.
- **Logic and Control Flow**:
    - Cast `shmem` to a `fd_genesis_client_t` pointer named `gen`.
    - Check if `shmem` is NULL; if true, log a warning and return NULL.
    - Check if `shmem` is aligned according to `fd_genesis_client_align()`; if not, log a warning and return NULL.
    - Use memory fence operations to ensure memory ordering before and after setting `gen->magic` to `FD_GENESIS_CLIENT_MAGIC`.
    - Return the pointer to the initialized `fd_genesis_client_t` structure.
- **Output**: A pointer to the initialized `fd_genesis_client_t` structure, or NULL if initialization fails.
- **Functions Called**:
    - [`fd_genesis_client_align`](<#fd_genesis_client_align>)


---
### fd\_genesis\_client\_join<!-- {{#callable:fd_genesis_client_join}} -->
[View Source →](<../../../../../src/discof/genesis/fd_genesis_client.c#L70>)

Validates and returns a pointer to a `fd_genesis_client_t` structure if the input is correctly aligned and has the correct magic number.
- **Inputs**:
    - `shgen`: A pointer to a shared memory region that is expected to contain a `fd_genesis_client_t` structure.
- **Logic and Control Flow**:
    - Check if `shgen` is NULL; if true, log a warning and return NULL.
    - Check if `shgen` is aligned according to [`fd_genesis_client_align`](<#fd_genesis_client_align>); if not, log a warning and return NULL.
    - Cast `shgen` to a `fd_genesis_client_t` pointer and store it in `gen`.
    - Check if `gen->magic` equals `FD_GENESIS_CLIENT_MAGIC`; if not, log a warning and return NULL.
    - Return the `gen` pointer.
- **Output**: A pointer to a `fd_genesis_client_t` structure if all checks pass, otherwise NULL.
- **Functions Called**:
    - [`fd_genesis_client_align`](<#fd_genesis_client_align>)


---
### fd\_genesis\_client\_init<!-- {{#callable:fd_genesis_client_init}} -->
[View Source →](<../../../../../src/discof/genesis/fd_genesis_client.c#L92>)

Initializes a `fd_genesis_client_t` structure by setting up non-blocking socket connections to a list of servers and preparing the client for polling.
- **Inputs**:
    - `client`: A pointer to a `fd_genesis_client_t` structure that will be initialized.
    - `servers`: A pointer to an array of `fd_ip4_port_t` structures representing the server addresses and ports to connect to.
    - `servers_len`: The number of servers in the `servers` array.
- **Logic and Control Flow**:
    - Check if `servers_len` is less than or equal to `FD_TOPO_GOSSIP_ENTRYPOINTS_MAX` using `FD_TEST` macro.
    - Initialize `peer_cnt` to zero to keep track of successfully connected peers.
    - Iterate over each server in the `servers` array.
    - For each server, set the port to 8899 and create a non-blocking socket with `socket()` function.
    - Attempt to connect the socket to the server using `connect()`. If the connection fails and the error is not `EINPROGRESS`, close the socket and continue to the next server.
    - If the connection is successful or in progress, store the socket file descriptor and server information in the `client` structure's `pollfds` and `peers` arrays, respectively, and increment `peer_cnt`.
    - After processing all servers, set the file descriptor of any remaining `pollfds` entries to -1 to indicate they are unused.
    - Set `client->peer_cnt` and `client->remaining_peer_cnt` to `peer_cnt`.
    - Record the current wall clock time in `client->start_time_nanos` using `fd_log_wallclock()`.
- **Output**: The function does not return a value; it initializes the `client` structure in place.


---
### close\_one<!-- {{#callable:close_one}} -->
[View Source →](<../../../../../src/discof/genesis/fd_genesis_client.c#L136>)

Closes a specific file descriptor in the `fd_genesis_client_t` structure and updates the remaining peer count.
- **Inputs**:
    - `client`: A pointer to an `fd_genesis_client_t` structure that contains the file descriptors and peer information.
    - `idx`: An unsigned long integer representing the index of the file descriptor to close in the `pollfds` array of the `client`.
- **Logic and Control Flow**:
    - Check if closing the file descriptor at `client->pollfds[idx].fd` returns -1, indicating an error, and log the error using `FD_LOG_ERR` if so.
    - Set the file descriptor at `client->pollfds[idx].fd` to -1 to mark it as closed.
    - Decrement the `remaining_peer_cnt` in the `client` structure by 1.
- **Output**: No return value; the function operates directly on the `client` structure.


---
### close\_all<!-- {{#callable:close_all}} -->
[View Source →](<../../../../../src/discof/genesis/fd_genesis_client.c#L144>)

Closes all active file descriptors in the `client`'s `pollfds` array.
- **Inputs**:
    - `client`: A pointer to an `fd_genesis_client_t` structure containing the `pollfds` array and the `peer_cnt` count of active peers.
- **Logic and Control Flow**:
    - Iterates over each file descriptor in the `client->pollfds` array up to `client->peer_cnt`.
    - Checks if the file descriptor is not already closed (i.e., not equal to -1).
    - Calls [`close_one`](<#close_one>) to close the file descriptor and mark it as closed by setting it to -1.
- **Output**: No return value; the function operates directly on the `client` structure to close file descriptors.
- **Functions Called**:
    - [`close_one`](<#close_one>)


---
### write\_conn<!-- {{#callable:write_conn}} -->
[View Source →](<../../../../../src/discof/genesis/fd_genesis_client.c#L152>)

Sends an HTTP GET request to a specified peer if writing is enabled, and updates the peer's state based on the result.
- **Inputs**:
    - `client`: A pointer to an `fd_genesis_client_t` structure representing the client that manages the connection.
    - `conn_idx`: An unsigned long integer representing the index of the connection in the client's peer list.
- **Logic and Control Flow**:
    - Retrieve the peer at the specified `conn_idx` from the client's peer list.
    - Check if the peer is in a writing state; if not, return immediately.
    - Prepare an HTTP GET request string to download a file from the peer.
    - Use `fd_cstr_printf_check` to format the request string with the peer's address and port.
    - Send the request using `sendto`, starting from the last sent byte, and update the number of bytes sent.
    - If `sendto` returns -1 and `errno` is `EAGAIN`, return without further action.
    - If `sendto` returns -1 for other reasons, close the connection using [`close_one`](<#close_one>) and return.
    - If the entire request has been sent, update the peer's state to indicate writing is complete and reset the response byte counter.
- **Output**: No return value; the function modifies the state of the peer within the `client` structure.
- **Functions Called**:
    - [`close_one`](<#close_one>)


---
### rpc\_phr\_content\_length<!-- {{#callable:rpc_phr_content_length}} -->
[View Source →](<../../../../../src/discof/genesis/fd_genesis_client.c#L187>)

Extracts the 'Content-Length' value from HTTP headers if present, otherwise returns `ULONG_MAX`.
- **Inputs**:
    - ``headers``: A pointer to an array of `phr_header` structures representing HTTP headers.
    - ``num_headers``: The number of headers in the `headers` array.
- **Logic and Control Flow**:
    - Iterates over each header in the `headers` array.
    - Checks if the header name length is 14 and matches 'Content-Length' (case-insensitive).
    - If a match is found, attempts to convert the header's value to an unsigned long integer using `strtoul`.
    - If conversion fails (i.e., no digits were found), returns `ULONG_MAX`.
    - If conversion succeeds, returns the parsed content length.
    - If no 'Content-Length' header is found, returns `ULONG_MAX`.
- **Output**: Returns the content length as an unsigned long integer if found and valid, otherwise returns `ULONG_MAX`.


---
### read\_conn<!-- {{#callable:read_conn}} -->
[View Source →](<../../../../../src/discof/genesis/fd_genesis_client.c#L201>)

Reads data from a specified connection, processes the HTTP response, and stores the response content in a buffer if valid.
- **Inputs**:
    - `client`: A pointer to an `fd_genesis_client_t` structure representing the client.
    - `conn_idx`: An unsigned long integer representing the index of the connection to read from.
    - `buffer`: A double pointer to an unsigned char where the function will store the address of the response content.
    - `buffer_sz`: A pointer to an unsigned long where the function will store the size of the response content.
- **Logic and Control Flow**:
    - Check if the peer is currently writing; if so, return 1.
    - Attempt to read data from the connection using `recvfrom`; handle errors and update the number of bytes read.
    - Parse the HTTP response using `phr_parse_response`; handle parsing errors and check for a valid HTTP 200 status code.
    - Determine the content length from the HTTP headers using [`rpc_phr_content_length`](<#rpc_phr_content_length>); handle errors related to content length.
    - Check if the content length and headers are within the buffer size limits; if not, close the connection and return 1.
    - If the content is fully read, set `buffer` and `buffer_sz` to point to the response content and its size, respectively.
    - Compute a SHA-256 hash of the response content.
    - Return 0 to indicate successful reading and processing of the response.
- **Output**: Returns 0 on success, indicating the response was read and processed correctly; returns 1 on failure or if more data is needed.
- **Functions Called**:
    - [`close_one`](<#close_one>)
    - [`rpc_phr_content_length`](<#rpc_phr_content_length>)


---
### fd\_genesis\_client\_poll<!-- {{#callable:fd_genesis_client_poll}} -->
[View Source →](<../../../../../src/discof/genesis/fd_genesis_client.c#L266>)

Monitors and manages network connections for a client, handling read and write operations, and closing connections when necessary.
- **Inputs**:
    - `client`: A pointer to an `fd_genesis_client_t` structure representing the client whose connections are being polled.
    - `peer`: A pointer to an `fd_ip4_port_t` structure where the function will store the address of the peer if a connection is successfully read.
    - `buffer`: A pointer to a pointer to an `uchar` array where the function will store the address of the buffer containing the response data if a connection is successfully read.
    - `buffer_sz`: A pointer to an `ulong` where the function will store the size of the buffer containing the response data if a connection is successfully read.
    - `charge_busy`: A pointer to an `int` that will be set to 1 to indicate that the function is busy processing connections.
- **Logic and Control Flow**:
    - Check if there are remaining peers to poll; if not, return -1.
    - Check if the elapsed time since `start_time_nanos` exceeds 20 seconds; if so, close all connections and return -1.
    - Call `fd_syscall_poll` to poll the file descriptors for events; handle errors and interruptions appropriately.
    - Set `charge_busy` to 1 to indicate activity.
    - Iterate over the maximum number of gossip entry points, checking each file descriptor for readiness to read or write.
    - If a file descriptor is ready for writing, call [`write_conn`](<#write_conn>) to handle the write operation.
    - If a file descriptor is ready for reading, call [`read_conn`](<#read_conn>) to handle the read operation; if successful, close all connections, set `peer` to the current peer's address, and return 0.
    - Return 1 if no connections were successfully read.
- **Output**: Returns 0 if a connection is successfully read, -1 if there are no remaining peers or the operation times out, and 1 if no connections are ready or an error occurs.
- **Functions Called**:
    - [`close_all`](<#close_all>)
    - [`write_conn`](<#write_conn>)
    - [`read_conn`](<#read_conn>)


---
### fd\_genesis\_client\_get\_pollfds<!-- {{#callable:fd_genesis_client_get_pollfds}} -->
[View Source →](<../../../../../src/discof/genesis/fd_genesis_client.c#L302>)

Returns the array of `pollfd` structures associated with the given `fd_genesis_client_t` client.
- **Inputs**:
    - `client`: A pointer to an `fd_genesis_client_t` structure, which contains the `pollfd` array to be returned.
- **Logic and Control Flow**:
    - Accesses the `pollfds` member of the `fd_genesis_client_t` structure pointed to by `client`.
    - Returns the `pollfds` array.
- **Output**: A pointer to the `pollfds` array within the `fd_genesis_client_t` structure.



---
Made with ❤️ by [Driver](https://www.driver.ai/)