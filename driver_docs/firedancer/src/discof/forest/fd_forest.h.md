<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

An API for repairing and managing block data structures in a distributed system, using a tree model to track and repair missing data.

# Purpose
The `fd_forest.h` file defines an API for managing and repairing data blocks in a distributed system. It is specifically designed to handle blocks discovered through Turbine and Gossip protocols, which are part of a larger cluster communication framework. The primary function of this API is to ensure that blocks, identified by slots, are fully received by requesting repairs for any missing data shreds. The API maintains a tree structure to track the ancestry of slots and a frontier to manage the oldest blocks that still require repair. This structure is fork-aware, meaning it can handle multiple branches or forks in the data stream.

The file defines several key data structures and functions. The `fd_forest_blk` structure implements a tree using a left-child, right-sibling model, which is safe for global address space operations. The `fd_forest` structure is the top-level container that holds the root of the tree and various memory pools and maps for managing the blocks and their relationships. The API provides functions for initializing, joining, and managing the forest, as well as inserting and querying blocks and shreds. It also includes mechanisms for publishing new roots and verifying the integrity of the forest. The file uses several macros to define and manage memory pools and maps, ensuring efficient handling of the data structures involved.
# Imports and Dependencies

---
- `../../disco/fd_disco_base.h`
- `../../util/tmpl/fd_set.c`
- `../../util/tmpl/fd_pool.c`
- `../../util/tmpl/fd_map_chain.c`
- `../../util/tmpl/fd_dlist.c`
- `../../util/tmpl/fd_deque_dynamic.c`


# Data Structures

---
### fd\_forest\_blk
- **Type**: ``struct``
- **Members**:
    - `slot`: Map key for the block.
    - `parent_slot`: Map key of the parent block.
    - `next`: Used internally by `fd_pool` and `fd_map_chain`.
    - `parent`: Pool index of the parent in the tree.
    - `child`: Pool index of the left-child.
    - `sibling`: Pool index of the right-sibling.
    - `consumed_idx`: Highest contiguous consumed shred index.
    - `buffered_idx`: Highest contiguous buffered shred index.
    - `complete_idx`: Shred index with `SLOT_COMPLETE_FLAG`, indicating the last shred index in the slot.
    - `fecs`: Array of FEC set indices or the index of the last shred in every FEC set.
    - `idxs`: Array of data shred indices.
    - `cmpl`: Array of last shred indices of every FEC set completed by `shred_tile`.
    - `est_buffered_tick_recv`: Estimated tick of shred at `buffered_idx`, used for limiting eager repair.
    - `code`: Array of code shred indices.
    - `first_shred_ts`: Timestamp of the first shred received in the slot.
    - `first_req_ts`: Tick of the first request received in the slot.
    - `turbine_cnt`: Number of shreds received from turbine.
    - `repair_cnt`: Number of data shreds received from repair.
    - `recovered_cnt`: Number of shreds recovered from Reed-Solomon recovery.
- **Description**: Implements a left-child, right-sibling n-ary tree structure for managing blocks in a forest, with each element maintaining indices for its parent, left-most child, and right sibling. It tracks various indices related to shreds, including consumed, buffered, and complete indices, as well as metrics for shreds received from different sources. The structure is aligned to 128 bytes and supports operations from processes with separate local forest joins.


---
### fd\_forest\_blk\_t
- **Type**: ``struct``
- **Members**:
    - `slot`: Map key for the block.
    - `parent_slot`: Map key of the parent block.
    - `next`: Used internally by `fd_pool` and `fd_map_chain`.
    - `parent`: Pool index of the parent in the tree.
    - `child`: Pool index of the left-most child.
    - `sibling`: Pool index of the right sibling.
    - `consumed_idx`: Highest contiguous consumed shred index.
    - `buffered_idx`: Highest contiguous buffered shred index.
    - `complete_idx`: Index of the last shred in the slot with `SLOT_COMPLETE_FLAG`.
    - `fecs`: Indexes of the last shred in every FEC set.
    - `idxs`: Data shred indexes.
    - `cmpl`: Indexes of the last shred of every completed FEC set.
    - `est_buffered_tick_recv`: Estimated tick of the shred at `buffered_idx`.
    - `code`: Code shred indexes.
    - `first_shred_ts`: Timestamp of the first shred received in the slot.
    - `first_req_ts`: Tick of the first request received in the slot.
    - `turbine_cnt`: Number of shreds received from the turbine.
    - `repair_cnt`: Number of data shreds received from repair.
    - `recovered_cnt`: Number of shreds recovered from Reed-Solomon recovery.
- **Description**: Implements a left-child, right-sibling n-ary tree structure for managing blocks in a forest. Each element maintains references to its left-most child, right sibling, and parent, allowing for efficient traversal and manipulation of the tree. The structure is designed to be gaddr-safe, supporting operations from processes with separate local forest joins. It also tracks various metrics and indexes related to shreds, facilitating the repair and completion of blocks in a distributed system.


---
### fd\_forest\_cns
- **Type**: ``struct``
- **Members**:
    - `slot`: Stores the slot number associated with the data structure.
    - `forest_pool_idx`: Holds the index in the forest pool.
    - `hash`: Reserved for use by the pool and map chain.
    - `next`: Reserved for use by a doubly linked list (dlist).
    - `prev`: Reserved for use by a doubly linked list (dlist).
- **Description**: Represents a node in a forest data structure, where each node is associated with a slot and indexed within a pool. The `hash`, `next`, and `prev` fields are reserved for internal use by the pool, map chain, and doubly linked list operations, respectively. This structure is used to manage and track elements within a forest, particularly in the context of block repair and ancestry tracking.


---
### fd\_forest\_cns\_t
- **Type**: ``struct``
- **Members**:
    - `slot`: Holds the slot number associated with the data structure.
    - `forest_pool_idx`: Stores the index of the pool in the forest.
    - `hash`: Reserved for use by pool and map_chain operations.
    - `next`: Reserved for use by doubly linked list operations.
    - `prev`: Reserved for use by doubly linked list operations.
- **Description**: `fd_forest_cns_t` is a data structure used within the forest API to manage and track the consumption of blocks in a distributed system. It contains fields for slot identification, pool indexing, and reserved fields for hash and linked list operations, facilitating the organization and traversal of data within the forest's consumption map and list structures.


---
### fd\_forest
- **Type**: ``struct fd_forest``
- **Members**:
    - `root`: Pool index of the root element.
    - `iter`: Pool index of the iterator.
    - `wksp_gaddr`: Workspace global address of `fd_forest` in the backing workspace, non-zero address.
    - `ver_gaddr`: Workspace global address of version sequence, incremented on write operations.
    - `pool_gaddr`: Workspace global address of `fd_pool`.
    - `ancestry_gaddr`: Workspace global address of `fd_forest_ancestry`.
    - `frontier_gaddr`: Workspace global address of leaves that need repair.
    - `subtrees_gaddr`: Workspace global address of the head of orphaned trees.
    - `orphaned_gaddr`: Workspace global address of map of parent slot to singly-linked list of elements orphaned by that parent slot.
    - `consumed_gaddr`: Workspace global address of map of slot to pool index of the completed repair frontier.
    - `conslist_gaddr`: Workspace global address of `fd_forest_conslist`.
    - `conspool_gaddr`: Workspace global address of `fd_forest_conspool`.
    - `deque_gaddr`: Workspace global address of `fd_forest_deque`, used internally for breadth-first search.
    - `magic`: Magic number to verify the structure, should equal `FD_FOREST_MAGIC`.
    - `subtree_cnt`: Number of subtrees in the forest, useful for iteration.
- **Description**: Represents a data structure for managing and repairing blocks in a distributed system, maintaining a tree of slot ancestry and a frontier of blocks needing repair. The structure includes various global addresses for workspace management, a magic number for validation, and a count of subtrees for iteration purposes. It is aligned to 128 bytes and is used in conjunction with other components like pools and maps to manage the state and operations of the forest.


---
### fd\_forest\_t
- **Type**: ``struct``
- **Members**:
    - `root`: Pool index of the root element in the forest.
    - `iter`: Pool index of the iterator for traversing the forest.
    - `wksp_gaddr`: Workspace global address of the forest in the backing workspace.
    - `ver_gaddr`: Workspace global address of the version sequence, incremented on write operations.
    - `pool_gaddr`: Workspace global address of the element pool.
    - `ancestry_gaddr`: Workspace global address of the ancestry map.
    - `frontier_gaddr`: Workspace global address of the frontier map, representing leaves that need repair.
    - `subtrees_gaddr`: Workspace global address of the subtrees map, representing the head of orphaned trees.
    - `orphaned_gaddr`: Workspace global address of the orphaned map, mapping parent slots to orphaned elements.
    - `consumed_gaddr`: Workspace global address of the consumed map, mapping slots to pool indices of completed repair frontiers.
    - `conslist_gaddr`: Workspace global address of the consumed list.
    - `conspool_gaddr`: Workspace global address of the consumed pool.
    - `deque_gaddr`: Workspace global address of the deque used internally for breadth-first search operations.
    - `magic`: Magic number for identifying the structure, set to `FD_FOREST_MAGIC`.
    - `subtree_cnt`: Number of subtrees in the forest, useful for iteration.
- **Description**: Holds the root of a tree structure and manages memory pools and map structures for block repair operations in a distributed system. The structure is aligned to 128 bytes and includes various global addresses for workspace management, a magic number for validation, and a count of subtrees for iteration purposes. It is designed to maintain and repair blocks by constructing an ancestry tree and managing a frontier of blocks that need repair.


---
### fd\_forest\_iter
- **Type**: ``struct``
- **Members**:
    - ``ele_idx``: Index of the current element in the iteration.
    - ``shred_idx``: Index of the current shred in the iteration.
    - ``frontier_ver``: Version number of the forest frontier at the time of initialization.
    - ``head``: Frontier node root of the current iteration, assuming no insertions or deletions in the frontier.
- **Description**: Facilitates iteration over a frontier node of the forest and its children, maintaining state information such as the current element and shred indices, the version of the frontier, and the root node of the current iteration.


---
### fd\_forest\_iter\_t
- **Type**: ``struct``
- **Members**:
    - ``ele_idx``: Index of the current element in the pool.
    - ``shred_idx``: Index of the current shred.
    - ``frontier_ver``: Version number of the frontier at the time of initialization.
    - ``head``: Iterator for the frontier node 'root' of the current iteration.
- **Description**: `fd_forest_iter_t` is a structure used to iterate over a frontier node of the forest and its children. It maintains the current element index, shred index, and the version of the frontier at initialization. The `head` member is an iterator for the frontier node 'root', ensuring that the iteration is consistent as long as no insertions or deletions occur in the frontier. This structure supports safe concurrent operations and helps in requesting shreds for repair.


# Functions

---
### fd\_forest\_align<!-- {{#callable:fd_forest_align}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L192>)

Returns the required memory alignment for a `fd_forest_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `alignof` to determine the alignment requirement of the `fd_forest_t` type.
    - Returns the alignment value.
- **Output**: An `ulong` representing the alignment requirement for a `fd_forest_t` structure.


---
### fd\_forest\_footprint<!-- {{#callable:fd_forest_footprint}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L205>)

Calculates the memory footprint required for a forest data structure with a specified maximum number of elements.
- **Inputs**:
    - `ele_max`: The maximum number of elements that the forest can contain.
- **Logic and Control Flow**:
    - Initialize the layout with `FD_LAYOUT_INIT`.
    - Append the alignment and size of `fd_forest_t` to the layout.
    - Append the alignment and footprint of `fd_fseq` to the layout.
    - Append the alignment and footprint of `fd_forest_pool` with `ele_max` to the layout.
    - Append the alignment and footprint of `fd_forest_ancestry` with `ele_max` to the layout.
    - Append the alignment and footprint of `fd_forest_frontier` with `ele_max` to the layout.
    - Append the alignment and footprint of `fd_forest_subtrees` with `ele_max` to the layout.
    - Append the alignment and footprint of `fd_forest_orphaned` with `ele_max` to the layout.
    - Append the alignment and footprint of `fd_forest_consumed` with `ele_max` to the layout.
    - Append the alignment and footprint of `fd_forest_conslist` to the layout.
    - Append the alignment and footprint of `fd_forest_conspool` with `ele_max` to the layout.
    - Append the alignment and footprint of `fd_forest_deque` with `ele_max` to the layout.
    - Finalize the layout with `FD_LAYOUT_FINI` and return the total footprint.
- **Output**: The function returns an unsigned long integer representing the total memory footprint required for the forest data structure.
- **Functions Called**:
    - [`fd_forest_align`](<#fd_forest_align>)


---
### fd\_forest\_wksp<!-- {{#callable:fd_forest_wksp}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L290>)

Calculates the local workspace address for a given forest structure by adjusting its global address.
- **Inputs**:
    - ``forest``: A pointer to a constant `fd_forest_t` structure representing the forest whose workspace address is to be calculated.
- **Logic and Control Flow**:
    - Cast the `forest` pointer to an unsigned long integer.
    - Subtract the `wksp_gaddr` field of the `forest` structure from the casted value.
    - Cast the result back to a pointer of type `fd_wksp_t`.
- **Output**: A pointer to `fd_wksp_t`, representing the local workspace address corresponding to the given forest.


---
### fd\_forest\_ver<!-- {{#callable:fd_forest_ver}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L304>)

Returns a pointer to the version number sequence of a forest.
- **Inputs**:
    - `forest`: A pointer to an `fd_forest_t` structure representing the forest.
- **Logic and Control Flow**:
    - Calls [`fd_forest_wksp`](<#fd_forest_wksp>) with `forest` to get the workspace backing the forest.
    - Calls `fd_wksp_laddr_fast` with the workspace and `forest->ver_gaddr` to get the local address of the version number sequence.
- **Output**: A pointer to the version number sequence (`ulong *`) of the forest.
- **Functions Called**:
    - [`fd_forest_wksp`](<#fd_forest_wksp>)


---
### fd\_forest\_ver\_const<!-- {{#callable:fd_forest_ver_const}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L309>)

Returns a constant pointer to the version number sequence of a forest.
- **Inputs**:
    - `forest`: A pointer to a constant `fd_forest_t` structure representing the forest.
- **Logic and Control Flow**:
    - Calls [`fd_forest_wksp`](<#fd_forest_wksp>) with `forest` to get the workspace backing the forest.
    - Calls `fd_wksp_laddr_fast` with the workspace and `forest->ver_gaddr` to get the local address of the version number sequence.
- **Output**: A constant pointer to an unsigned long integer representing the version number sequence of the forest.
- **Functions Called**:
    - [`fd_forest_wksp`](<#fd_forest_wksp>)


---
### fd\_forest\_pool\_const<!-- {{#callable:fd_forest_pool_const}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L322>)

Returns a constant pointer to the element pool of a forest structure in the caller's address space.
- **Inputs**:
    - `forest`: A constant pointer to an `fd_forest_t` structure representing the forest.
- **Logic and Control Flow**:
    - Calls [`fd_forest_wksp`](<#fd_forest_wksp>) with the `forest` pointer to get the workspace backing the forest.
    - Uses `fd_wksp_laddr_fast` to compute the local address of the element pool using the workspace and the `pool_gaddr` from the `forest`.
    - Returns the computed local address as a constant pointer to `fd_forest_blk_t`.
- **Output**: A constant pointer to `fd_forest_blk_t`, representing the element pool of the forest in the caller's address space.
- **Functions Called**:
    - [`fd_forest_wksp`](<#fd_forest_wksp>)


---
### fd\_forest\_ancestry\_const<!-- {{#callable:fd_forest_ancestry_const}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L335>)

Returns a constant pointer to the ancestry map of a given forest.
- **Inputs**:
    - `forest`: A constant pointer to an `fd_forest_t` structure representing the forest whose ancestry map is to be accessed.
- **Logic and Control Flow**:
    - Calls [`fd_forest_wksp`](<#fd_forest_wksp>) with the `forest` pointer to get the workspace backing the forest.
    - Uses `fd_wksp_laddr_fast` to compute the local address of the ancestry map using the workspace and the `ancestry_gaddr` from the `forest` structure.
    - Returns the computed local address as a constant pointer to `fd_forest_ancestry_t`.
- **Output**: A constant pointer to `fd_forest_ancestry_t`, representing the ancestry map of the forest in the caller's address space.
- **Functions Called**:
    - [`fd_forest_wksp`](<#fd_forest_wksp>)


---
### fd\_forest\_frontier\_const<!-- {{#callable:fd_forest_frontier_const}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L348>)

Returns a constant pointer to the frontier map of a given forest.
- **Inputs**:
    - `forest`: A constant pointer to an `fd_forest_t` structure representing the forest.
- **Logic and Control Flow**:
    - Calls [`fd_forest_wksp`](<#fd_forest_wksp>) with the `forest` pointer to get the workspace backing the forest.
    - Uses `fd_wksp_laddr_fast` to compute the local address of the frontier map using the workspace and the `frontier_gaddr` from the `forest`.
    - Returns the computed local address as a constant pointer to `fd_forest_frontier_t`.
- **Output**: A constant pointer to `fd_forest_frontier_t`, representing the frontier map of the forest.
- **Functions Called**:
    - [`fd_forest_wksp`](<#fd_forest_wksp>)


---
### fd\_forest\_subtrees\_const<!-- {{#callable:fd_forest_subtrees_const}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L361>)

Returns a constant pointer to the subtrees map of a given forest.
- **Inputs**:
    - `forest`: A constant pointer to an `fd_forest_t` structure representing the forest.
- **Logic and Control Flow**:
    - Calls [`fd_forest_wksp`](<#fd_forest_wksp>) with the `forest` pointer to get the workspace backing the forest.
    - Uses `fd_wksp_laddr_fast` to compute the local address of the subtrees map using the workspace and the `subtrees_gaddr` from the `forest`.
    - Returns the computed local address as a constant pointer to `fd_forest_subtrees_t`.
- **Output**: A constant pointer to `fd_forest_subtrees_t`, representing the subtrees map of the forest.
- **Functions Called**:
    - [`fd_forest_wksp`](<#fd_forest_wksp>)


---
### fd\_forest\_orphaned\_const<!-- {{#callable:fd_forest_orphaned_const}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L374>)

Returns a constant pointer to the orphaned map of a given forest.
- **Inputs**:
    - ``forest``: A constant pointer to an `fd_forest_t` structure representing the forest.
- **Logic and Control Flow**:
    - Call [`fd_forest_wksp`](<#fd_forest_wksp>) with `forest` to get the workspace backing the forest.
    - Use `fd_wksp_laddr_fast` with the workspace and `forest->orphaned_gaddr` to get the local address of the orphaned map.
- **Output**: A constant pointer to `fd_forest_orphaned_t`, representing the orphaned map in the caller's address space.
- **Functions Called**:
    - [`fd_forest_wksp`](<#fd_forest_wksp>)


---
### fd\_forest\_consumed\_const<!-- {{#callable:fd_forest_consumed_const}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L387>)

Returns a constant pointer to the consumed map of a forest.
- **Inputs**:
    - ``forest``: A pointer to a constant `fd_forest_t` structure representing the forest.
- **Logic and Control Flow**:
    - Call [`fd_forest_wksp`](<#fd_forest_wksp>) with `forest` to get the workspace associated with the forest.
    - Call `fd_wksp_laddr_fast` with the workspace and `forest->consumed_gaddr` to get the local address of the consumed map.
- **Output**: A constant pointer to `fd_forest_consumed_t`, representing the consumed map of the forest.
- **Functions Called**:
    - [`fd_forest_wksp`](<#fd_forest_wksp>)


---
### fd\_forest\_conslist\_const<!-- {{#callable:fd_forest_conslist_const}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L400>)

Returns a constant pointer to the `fd_forest_conslist_t` structure associated with a given `fd_forest_t` instance.
- **Inputs**:
    - `forest`: A constant pointer to an `fd_forest_t` structure representing the forest from which to retrieve the conslist.
- **Logic and Control Flow**:
    - Calls [`fd_forest_wksp`](<#fd_forest_wksp>) with the `forest` pointer to get the workspace backing the forest.
    - Uses `fd_wksp_laddr_fast` to compute the local address of the conslist using the workspace and the `conslist_gaddr` from the `forest`.
    - Returns the computed local address as a constant pointer to `fd_forest_conslist_t`.
- **Output**: A constant pointer to `fd_forest_conslist_t` representing the conslist of the given forest.
- **Functions Called**:
    - [`fd_forest_wksp`](<#fd_forest_wksp>)


---
### fd\_forest\_conspool\_const<!-- {{#callable:fd_forest_conspool_const}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L413>)

Returns a constant pointer to the conspool of a given forest.
- **Inputs**:
    - `forest`: A constant pointer to an `fd_forest_t` structure representing the forest.
- **Logic and Control Flow**:
    - Calls [`fd_forest_wksp`](<#fd_forest_wksp>) with `forest` to get the workspace backing the forest.
    - Uses `fd_wksp_laddr_fast` to compute the local address of the conspool using the workspace and `forest->conspool_gaddr`.
    - Returns the computed local address as a constant pointer to `fd_forest_cns_t`.
- **Output**: A constant pointer to `fd_forest_cns_t`, representing the conspool of the forest.
- **Functions Called**:
    - [`fd_forest_wksp`](<#fd_forest_wksp>)


---
### fd\_forest\_root\_slot<!-- {{#callable:fd_forest_root_slot}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L421>)

Retrieves the slot number of the root element in a forest structure, returning `ULONG_MAX` if the root is uninitialized.
- **Inputs**:
    - ``forest``: A pointer to a constant `fd_forest_t` structure representing the forest.
- **Logic and Control Flow**:
    - Check if the `root` of the `forest` is equal to the null index of the forest pool using `fd_forest_pool_idx_null` and [`fd_forest_pool_const`](<#fd_forest_pool_const>).
    - If the `root` is uninitialized (null index), return `ULONG_MAX`.
    - Otherwise, retrieve the slot number of the root element from the forest pool using `fd_forest_pool_ele_const` and return it.
- **Output**: Returns the slot number of the root element in the forest, or `ULONG_MAX` if the root is uninitialized.
- **Functions Called**:
    - [`fd_forest_pool_const`](<#fd_forest_pool_const>)


# Function Declarations (Public API)

---
### fd\_forest\_new<!-- {{#callable_declaration:fd_forest_new}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L238>)

Formats a memory region for use as a forest.
- **Description**: Use this function to prepare a memory region for managing a forest structure, which is used for repairing blocks in a distributed system. The memory region must be aligned and have sufficient size to accommodate the forest structure. This function should be called before any other operations on the forest. Ensure that the memory region is part of a workspace and is not null. The function returns a pointer to the formatted memory region or null if any preconditions are not met.
- **Inputs**:
    - `shmem`: A pointer to the memory region to format. Must not be null and must be aligned according to `fd_forest_align()`. The memory region must be part of a workspace.
    - `ele_max`: The maximum number of elements the forest can manage. Must be a power of two.
    - `seed`: A seed value for initializing the forest's internal structures. Any unsigned long value is valid.
- **Output**: Returns a pointer to the formatted memory region on success, or null if the input conditions are not met.
- **See Also**: [`fd_forest_new`](<fd_forest.c.md#fd_forest_new>)  (Implementation)


---
### fd\_forest\_join<!-- {{#callable_declaration:fd_forest_join}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L246>)

Joins a caller to a forest structure.
- **Description**: Use this function to join a caller to a forest structure, which is a shared memory region. This function checks if the provided pointer is valid and properly aligned. It also verifies that the forest is part of a workspace. If any of these conditions are not met, the function logs a warning and returns NULL. This function is typically used after initializing or creating a forest to allow operations on it.
- **Inputs**:
    - `shforest`: A pointer to the shared memory region representing the forest. It must not be NULL, must be properly aligned, and must be part of a workspace. If these conditions are not met, the function logs a warning and returns NULL.
- **Output**: Returns a pointer to the forest structure in the local address space on success, or NULL if the input is invalid.
- **See Also**: [`fd_forest_join`](<fd_forest.c.md#fd_forest_join>)  (Implementation)


---
### fd\_forest\_leave<!-- {{#callable_declaration:fd_forest_leave}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L253>)

Leaves a current local join to a forest.
- **Description**: Use this function to leave a current local join to a forest. It returns a pointer to the underlying shared memory region if successful. If the input is null, it logs a warning and returns null. This function is useful when you need to safely disconnect from a forest without affecting other processes that might be joined to it.
- **Inputs**:
    - `forest`: A pointer to a constant `fd_forest_t` structure representing the forest to leave. Must not be null. If null, the function logs a warning and returns null.
- **Output**: Returns a pointer to the underlying shared memory region on success, or null if the input is null.
- **See Also**: [`fd_forest_leave`](<fd_forest.c.md#fd_forest_leave>)  (Implementation)


---
### fd\_forest\_delete<!-- {{#callable_declaration:fd_forest_delete}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L263>)

Unformats a memory region used as a forest.
- **Description**: Use this function to unformat a memory region that was previously used as a forest. It should be called when no processes are joined to the forest, ensuring that the memory region is not in use. This function returns the pointer to the underlying shared memory region, transferring ownership back to the caller. If the input is invalid, such as when the pointer is null or misaligned, the function logs a warning and returns null.
- **Inputs**:
    - `forest`: A pointer to the memory region used as a forest. It must not be null and must be properly aligned. If the pointer is null or misaligned, the function logs a warning and returns null.
- **Output**: Returns a pointer to the underlying shared memory region if successful, or null if the input is invalid.
- **See Also**: [`fd_forest_delete`](<fd_forest.c.md#fd_forest_delete>)  (Implementation)


---
### fd\_forest\_init<!-- {{#callable_declaration:fd_forest_init}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L274>)

Initializes a forest with a specified root slot.
- **Description**: Use this function to initialize a forest structure with a given root slot. This function must be called on a valid local join of the forest, and no other processes should be joined to the forest at the time of initialization. The function sets up the root node and prepares the forest for further operations. It is typically called by the process that formatted the forest's memory. Ensure that the forest is in an uninitialized state before calling this function.
- **Inputs**:
    - `forest`: A pointer to a `fd_forest_t` structure that represents the forest to initialize. Must not be null and must point to a valid local join of the forest.
    - `root`: An unsigned long integer representing the initial root slot for the forest. This is the slot that the forest will use as its root after initialization.
- **Output**: Returns a pointer to the initialized `fd_forest_t` structure.
- **See Also**: [`fd_forest_init`](<fd_forest.c.md#fd_forest_init>)  (Implementation)


---
### fd\_forest\_fini<!-- {{#callable_declaration:fd_forest_fini}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L280>)

Finalizes a forest structure.
- **Description**: Use this function to finalize a forest structure when it is no longer needed. This function assumes that the forest is a valid local join and that no other processes are joined to it. It updates the version to indicate the forest is uninitialized and clears all elements from the forest's internal structures. This function is typically called before deallocating or reinitializing the forest.
- **Inputs**:
    - `forest`: A pointer to a `fd_forest_t` structure that represents the forest to finalize. It must be a valid local join and not null. The function does not handle null pointers and expects the caller to ensure the forest is in a valid state for finalization.
- **Output**: Returns the pointer to the finalized `fd_forest_t` structure.
- **See Also**: [`fd_forest_fini`](<fd_forest.c.md#fd_forest_fini>)  (Implementation)


---
### fd\_forest\_query<!-- {{#callable_declaration:fd_forest_query}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L427>)

Queries a block in the forest by its slot.
- **Description**: Use this function to retrieve a block from the forest structure using a specific slot number. This function is useful when you need to access or inspect a block associated with a particular slot in the forest. Ensure that the forest is properly initialized and joined before calling this function. The function will return a pointer to the block if it exists, or a null pointer if the block is not found.
- **Inputs**:
    - `forest`: A pointer to an `fd_forest_t` structure representing the forest. Must not be null and should be a valid, initialized forest.
    - `slot`: An unsigned long integer representing the slot number of the block to query. There are no specific constraints on the value, but it should correspond to a valid slot in the forest for a successful query.
- **Output**: Returns a pointer to an `fd_forest_blk_t` structure representing the block associated with the given slot, or null if the block is not found.
- **See Also**: [`fd_forest_query`](<fd_forest.c.md#fd_forest_query>)  (Implementation)


---
### fd\_forest\_blk\_insert<!-- {{#callable_declaration:fd_forest_blk_insert}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L438>)

Inserts a new block into the forest.
- **Description**: Use this function to add a new block to the forest structure, which is a tree-like data structure used for managing blocks in a distributed system. This function assumes that the slot is greater than the root slot of the forest and that there is a free element in the block pool. It is idempotent, meaning it can be called multiple times with the same slot without adverse effects. The function returns the inserted block element, which can be used for further operations.
- **Inputs**:
    - `forest`: A pointer to an `fd_forest_t` structure representing the forest. Must not be null and should be a valid local join.
    - `slot`: An unsigned long integer representing the slot of the block to insert. Must be greater than the root slot of the forest.
    - `parent_slot`: An unsigned long integer representing the slot of the parent block. This is used to establish the parent-child relationship in the forest.
- **Output**: Returns a pointer to the inserted `fd_forest_blk_t` element, representing the new block in the forest.
- **See Also**: [`fd_forest_blk_insert`](<fd_forest.c.md#fd_forest_blk_insert>)  (Implementation)


---
### fd\_forest\_data\_shred\_insert<!-- {{#callable_declaration:fd_forest_data_shred_insert}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L450>)

Inserts a new data shred into the forest.
- **Description**: Use this function to add a new data shred to an existing block in the forest. This function assumes that the block corresponding to the given slot is already present in the forest, typically inserted using `fd_forest_blk_insert`. It updates various indices and counters related to the shred and advances the consumed frontier. This function is essential for maintaining the integrity and completeness of the block data as it is received from different sources.
- **Inputs**:
    - `forest`: A pointer to an `fd_forest_t` structure representing the forest. Must not be null and should be a valid local join.
    - `slot`: An unsigned long representing the slot of the block to which the shred belongs. Must correspond to an existing block in the forest.
    - `parent_slot`: An unsigned long representing the parent slot of the block. Used to maintain the ancestry of slots.
    - `shred_idx`: An unsigned integer representing the index of the shred within the block. Must be a valid index for the block.
    - `fec_set_idx`: An unsigned integer representing the FEC set index. Must be greater than zero to be inserted.
    - `slot_complete`: An integer flag indicating if the slot is complete. Non-zero values indicate completion.
    - `ref_tick`: An integer representing the reference tick for the shred. Used for timing and ordering purposes.
    - `src`: An integer indicating the source of the shred. Valid values are `SHRED_SRC_TURBINE`, `SHRED_SRC_REPAIR`, or `SHRED_SRC_RECOVERED`.
- **Output**: Returns a pointer to the `fd_forest_blk_t` structure corresponding to the block where the shred was inserted.
- **See Also**: [`fd_forest_data_shred_insert`](<fd_forest.c.md#fd_forest_data_shred_insert>)  (Implementation)


---
### fd\_forest\_code\_shred\_insert<!-- {{#callable_declaration:fd_forest_code_shred_insert}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L453>)

Inserts a code shred into the forest for a given slot.
- **Description**: Use this function to insert a code shred into the forest structure for a specified slot. This function assumes that the slot is already present in the forest. It updates the timestamp of the first shred if it is the first one being inserted. If the `shred_idx` exceeds the maximum allowed index, the function logs a message and increments the turbine count without tracking the shred. If the shred index is valid and not already present, it inserts the shred and increments the turbine count. This function returns a pointer to the forest block associated with the slot or `NULL` if the slot is not found.
- **Inputs**:
    - `forest`: A pointer to the `fd_forest_t` structure representing the forest. Must not be null. The caller retains ownership.
    - `slot`: An unsigned long integer representing the slot in the forest where the shred should be inserted. Must correspond to an existing slot in the forest.
    - `shred_idx`: An unsigned integer representing the index of the shred to insert. Must be within the valid range for the block's code shreds. If it exceeds the maximum, the shred is not tracked.
- **Output**: Returns a pointer to the `fd_forest_blk_t` structure for the slot if successful, or `NULL` if the slot is not found.
- **See Also**: [`fd_forest_code_shred_insert`](<fd_forest.c.md#fd_forest_code_shred_insert>)  (Implementation)


---
### fd\_forest\_fec\_insert<!-- {{#callable_declaration:fd_forest_fec_insert}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L461>)

Inserts a fully completed FEC set into the forest.
- **Description**: Use this function to add a fully completed Forward Error Correction (FEC) set to an existing slot in the forest. This function assumes that the slot is already present in the forest, typically after a block insert operation. It updates the completion index for the slot and inserts data shreds for the specified FEC set. This function is essential for maintaining the integrity of the forest's data structure as it progresses through the repair process.
- **Inputs**:
    - `forest`: A pointer to an `fd_forest_t` structure representing the forest. Must not be null and should be a valid local join.
    - `slot`: An unsigned long integer representing the slot to which the FEC set belongs. Must already exist in the forest.
    - `parent_slot`: An unsigned long integer representing the parent slot of the current slot. Used to maintain the ancestry of slots.
    - `last_shred_idx`: An unsigned integer indicating the index of the last shred in the FEC set. Must be a valid shred index.
    - `fec_set_idx`: An unsigned integer representing the index of the FEC set. Must be a valid index within the context of the slot.
    - `slot_complete`: An integer flag indicating whether the slot is complete. Non-zero if complete, zero otherwise.
    - `ref_tick`: An integer representing a reference tick for the operation. Used for internal timing and ordering purposes.
- **Output**: Returns a pointer to the `fd_forest_blk_t` structure corresponding to the slot, or null if the operation fails.
- **See Also**: [`fd_forest_fec_insert`](<fd_forest.c.md#fd_forest_fec_insert>)  (Implementation)


---
### fd\_forest\_fec\_clear<!-- {{#callable_declaration:fd_forest_fec_clear}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L516>)

Clears the FEC set at a specified slot and index.
- **Description**: Use this function to clear a Forward Error Correction (FEC) set at a given slot and FEC set index within a forest structure. This function should be called when you need to remove FEC set indices from a block in the forest. It is important to ensure that the slot is greater than the root slot of the forest before calling this function, as it will ignore requests for slots less than or equal to the root slot. The function will also ignore requests if the specified slot does not exist in the forest or if the maximum shred index is already marked as complete. This function does not affect the consumed frontier invariants.
- **Inputs**:
    - `forest`: A pointer to an `fd_forest_t` structure representing the forest. Must not be null and should be a valid local join.
    - `slot`: An unsigned long integer representing the slot number. Must be greater than the root slot of the forest.
    - `fec_set_idx`: An unsigned integer representing the index of the FEC set to clear. Must be a valid index within the forest.
    - `max_shred_idx`: An unsigned integer representing the maximum shred index to clear. The function will ignore the request if this index is already marked as complete.
- **Output**: None
- **See Also**: [`fd_forest_fec_clear`](<fd_forest.c.md#fd_forest_fec_clear>)  (Implementation)


---
### fd\_forest\_publish<!-- {{#callable_declaration:fd_forest_publish}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L524>)

Publishes a new root slot in the forest.
- **Description**: Use this function to set a new root slot in the forest, effectively updating the tree structure to use this slot and its descendants as the new tree. This operation removes elements not part of the new root's subtree. Ensure the slot is present in the forest before calling this function. The function handles edge cases where the new root slot might not be immediately available, inserting it if necessary. It also manages orphaned elements and updates the consumed frontier as needed.
- **Inputs**:
    - `forest`: A pointer to an `fd_forest_t` structure representing the forest. Must not be null and should be a valid local join.
    - `new_root_slot`: An unsigned long integer representing the new root slot to publish. Must be greater than the current root slot.
- **Output**: Returns a pointer to the new root element of type `fd_forest_blk_t const *`. Returns NULL if the new root slot is older than the current root slot.
- **See Also**: [`fd_forest_publish`](<fd_forest.c.md#fd_forest_publish>)  (Implementation)


---
### fd\_forest\_iter\_init<!-- {{#callable_declaration:fd_forest_iter_init}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L560>)

Initializes an iterator for traversing the forest frontier.
- **Description**: Use this function to create an iterator that starts at the first element on the forest's frontier. This function is typically called when you need to begin a traversal of the forest to identify blocks that require repair. The function assumes that the forest is properly initialized and contains at least one element on the frontier. It returns an iterator that can be used to navigate through the forest's elements, focusing on those that are not yet complete. This function is useful in scenarios where you need to process or repair blocks in a forest structure.
- **Inputs**:
    - `forest`: A pointer to an `fd_forest_t` structure representing the forest. This parameter must not be null and should point to a valid, initialized forest structure. The caller retains ownership of the forest.
- **Output**: Returns an `fd_forest_iter_t` structure initialized to the first element on the forest's frontier. If no elements are available for iteration, the iterator will indicate completion.
- **See Also**: [`fd_forest_iter_init`](<fd_forest.c.md#fd_forest_iter_init>)  (Implementation)


---
### fd\_forest\_iter\_next<!-- {{#callable_declaration:fd_forest_iter_next}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L563>)

Advances the iterator to the next shred in the forest.
- **Description**: Use this function to move an iterator to the next shred in a forest structure. It is important to ensure that the iterator's `frontier_ver` matches the current version of the forest to avoid resetting the iterator. If the forest has changed since the iterator was initialized, the function will reset the iterator to indicate no more elements are available. This function is useful for traversing the forest in a breadth-first manner, and it handles cases where the forest structure may have been modified during iteration.
- **Inputs**:
    - `iter`: An `fd_forest_iter_t` structure representing the current state of the iterator. The caller must ensure this is a valid iterator initialized for the forest.
    - `forest`: A pointer to a constant `fd_forest_t` structure representing the forest to iterate over. The caller must ensure this is a valid and initialized forest structure.
- **Output**: Returns an updated `fd_forest_iter_t` structure representing the next position in the iteration. If no more elements are available, the iterator is reset to indicate completion.
- **See Also**: [`fd_forest_iter_next`](<fd_forest.c.md#fd_forest_iter_next>)  (Implementation)


---
### fd\_forest\_iter\_done<!-- {{#callable_declaration:fd_forest_iter_done}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L566>)

Checks if the iterator has reached the end of the forest.
- **Description**: Use this function to determine if an iterator has completed its traversal of the forest. It is typically called after initializing and advancing an iterator to check if there are more elements to process. This function is useful in loops that iterate over elements in the forest, allowing the loop to terminate when all elements have been visited.
- **Inputs**:
    - `iter`: An iterator of type `fd_forest_iter_t`. It represents the current position in the forest traversal. The iterator must be valid and initialized.
    - `forest`: A pointer to a constant `fd_forest_t` structure. It represents the forest being traversed. The pointer must not be null and should point to a valid forest structure.
- **Output**: Returns a non-zero integer if the iterator has reached the end of the forest, otherwise returns zero.
- **See Also**: [`fd_forest_iter_done`](<fd_forest.c.md#fd_forest_iter_done>)  (Implementation)


---
### fd\_forest\_verify<!-- {{#callable_declaration:fd_forest_verify}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L574>)

Checks if the forest structure is valid and not corrupt.
- **Description**: Use this function to verify the integrity of a forest structure. It checks for null pointers, alignment, workspace association, magic number correctness, and ensures that the forest is initialized and valid. It also verifies that elements are correctly organized within the forest's internal maps and that all necessary invariants are maintained. Call this function when you need to ensure that the forest is in a consistent state before performing operations that depend on its integrity.
- **Inputs**:
    - `forest`: A pointer to a `fd_forest_t` structure. Must not be null and must be aligned according to `fd_forest_align()`. The forest must be part of a workspace and initialized with the correct magic number. If these conditions are not met, the function returns -1.
- **Output**: Returns 0 if the forest is valid and not corrupt, or -1 if any validation checks fail.
- **See Also**: [`fd_forest_verify`](<fd_forest.c.md#fd_forest_verify>)  (Implementation)


---
### fd\_forest\_frontier\_print<!-- {{#callable_declaration:fd_forest_frontier_print}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L577>)

Prints the current state of the forest frontier.
- **Description**: Use this function to display the current state of the forest frontier, which includes information about blocks that need repair. This function is useful for debugging or monitoring the repair process. It must be called with a valid, initialized `fd_forest_t` structure. The function outputs the information to the standard output and does not return any value.
- **Inputs**:
    - `forest`: A pointer to a constant `fd_forest_t` structure representing the forest. It must not be null and should be properly initialized before calling this function. The caller retains ownership of the memory.
- **Output**: None
- **See Also**: [`fd_forest_frontier_print`](<fd_forest.c.md#fd_forest_frontier_print>)  (Implementation)


---
### fd\_forest\_print<!-- {{#callable_declaration:fd_forest_print}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.h#L598>)

Prints a formatted representation of the forest structure.
- **Description**: Use this function to print a detailed view of the forest structure, including its ancestry, frontier, and orphaned elements. This function is useful for debugging or logging the current state of the forest. It should be called when the forest is in a valid state, as indicated by a non-empty root. If the root is uninitialized or invalid, the function will not produce any output.
- **Inputs**:
    - `forest`: A pointer to a constant `fd_forest_t` structure representing the forest to print. The pointer must not be null, and the forest must be properly initialized and joined by the caller. If the root of the forest is `ULONG_MAX`, the function will return without printing.
- **Output**: None
- **See Also**: [`fd_forest_print`](<fd_forest.c.md#fd_forest_print>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)