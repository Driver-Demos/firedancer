<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for managing and manipulating a data structure called `fd_forest`, including creation, deletion, and traversal operations.

# Purpose
The code defines a C module for managing a data structure called a "forest," which is a collection of trees. This module provides functions to create, manipulate, and verify the integrity of these forests. The primary operations include creating a new forest in shared memory, joining and leaving a forest, and deleting a forest. The module also includes functions to insert and remove elements from the forest, manage the relationships between elements (such as parent-child and sibling links), and advance the state of the forest based on certain conditions.

The module defines several static and public functions, with the public functions serving as the main API for interacting with the forest. These functions include [`fd_forest_new`](<#fd_forest_new>), [`fd_forest_join`](<#fd_forest_join>), [`fd_forest_leave`](<#fd_forest_leave>), [`fd_forest_delete`](<#fd_forest_delete>), and others for inserting and managing elements within the forest. The code also includes functions for printing the structure of the forest, which can be useful for debugging and visualization. The module uses various helper functions and macros to manage memory alignment, logging, and error handling. The forest structure is designed to be used in a concurrent environment, as indicated by the use of memory fences and volatile variables to ensure proper synchronization.
# Imports and Dependencies

---
- `fd_forest.h`
- `stdio.h`


# Functions

---
### ver\_inc<!-- {{#callable:ver_inc}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L3>)

Increments the version number pointed to by `ver` by querying its current value and updating it with an increment of 1.
- **Inputs**:
    - ``ver``: A pointer to a pointer of type `ulong`, representing the version number to be incremented.
- **Logic and Control Flow**:
    - Dereferences the double pointer `ver` to obtain the current version number.
    - Calls `fd_fseq_query` with the dereferenced version to get the current version value.
    - Increments the obtained version value by 1.
    - Calls `fd_fseq_update` with the incremented value to update the version.
- **Output**: No return value; the function updates the version number in place.


---
### fd\_forest\_new<!-- {{#callable:fd_forest_new}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L9>)

Initializes a new forest data structure in shared memory with specified parameters.
- **Inputs**:
    - `shmem`: Pointer to the shared memory where the forest will be initialized.
    - `ele_max`: Maximum number of elements the forest can contain, must be a power of two.
    - `seed`: Seed value used for initializing certain components of the forest.
- **Logic and Control Flow**:
    - Check if `ele_max` is a power of two using `FD_TEST` and `fd_ulong_is_pow2`.
    - Return `NULL` and log a warning if `shmem` is `NULL`.
    - Return `NULL` and log a warning if `shmem` is not aligned to `fd_forest_align()`.
    - Calculate the memory footprint required using [`fd_forest_footprint`](<fd_forest.h.md#fd_forest_footprint>) and return `NULL` if it is zero.
    - Verify that `shmem` is part of a workspace using `fd_wksp_containing` and return `NULL` if not.
    - Clear the memory at `shmem` using `fd_memset`.
    - Allocate and initialize various components of the forest using `FD_SCRATCH_ALLOC_APPEND`.
    - Set initial values for the forest structure, including root, subtree count, and global addresses for various components.
    - Use memory fences to ensure memory operations are completed before setting the forest's magic number.
    - Return the pointer to the initialized shared memory.
- **Output**: Returns a pointer to the initialized shared memory if successful, or `NULL` if an error occurs.
- **Functions Called**:
    - [`fd_forest_align`](<fd_forest.h.md#fd_forest_align>)
    - [`fd_forest_footprint`](<fd_forest.h.md#fd_forest_footprint>)


---
### fd\_forest\_join<!-- {{#callable:fd_forest_join}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L73>)

Validates and returns a pointer to a `fd_forest_t` structure if it is non-null, properly aligned, and part of a workspace.
- **Inputs**:
    - `shforest`: A pointer to a shared memory region that is expected to contain a `fd_forest_t` structure.
- **Logic and Control Flow**:
    - Cast `shforest` to a `fd_forest_t` pointer and assign it to `forest`.
    - Check if `forest` is NULL; if so, log a warning and return NULL.
    - Check if `forest` is aligned according to [`fd_forest_align`](<fd_forest.h.md#fd_forest_align>); if not, log a warning and return NULL.
    - Determine if `forest` is part of a workspace using `fd_wksp_containing`; if not, log a warning and return NULL.
    - Return the `forest` pointer.
- **Output**: A pointer to a `fd_forest_t` structure if all checks pass, otherwise NULL.
- **Functions Called**:
    - [`fd_forest_align`](<fd_forest.h.md#fd_forest_align>)


---
### fd\_forest\_leave<!-- {{#callable:fd_forest_leave}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L96>)

Returns a pointer to the given `forest` if it is not NULL, otherwise logs a warning and returns NULL.
- **Inputs**:
    - `forest`: A constant pointer to an `fd_forest_t` structure, representing the forest to leave.
- **Logic and Control Flow**:
    - Check if `forest` is NULL using `FD_UNLIKELY`; if true, log a warning with `FD_LOG_WARNING` and return NULL.
    - If `forest` is not NULL, cast it to a `void *` and return it.
- **Output**: A `void *` pointer to the `forest` if it is not NULL, otherwise NULL.


---
### fd\_forest\_delete<!-- {{#callable:fd_forest_delete}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L107>)

Validates and returns a pointer to a forest object if it is non-null and properly aligned.
- **Inputs**:
    - `forest`: A pointer to a forest object that needs validation and potential deletion.
- **Logic and Control Flow**:
    - Check if `forest` is NULL; if so, log a warning and return NULL.
    - Check if `forest` is aligned according to `fd_forest_align()`; if not, log a warning and return NULL.
    - Return the `forest` pointer if it passes the above checks.
- **Output**: Returns the `forest` pointer if it is valid and aligned, otherwise returns NULL.
- **Functions Called**:
    - [`fd_forest_align`](<fd_forest.h.md#fd_forest_align>)


---
### consumed\_insert<!-- {{#callable:consumed_insert}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L126>)

Inserts an element into the consumed list and the conslist of a forest data structure.
- **Inputs**:
    - ``forest``: A pointer to the `fd_forest_t` structure representing the forest.
    - ``slot``: An unsigned long integer representing the slot number to be inserted.
    - ``pool_idx``: An unsigned long integer representing the index in the pool where the element is located.
- **Logic and Control Flow**:
    - Retrieve the `consumed` list from the `forest` using `fd_forest_consumed` function.
    - Retrieve the `pool` from the `forest` using `fd_forest_conspool` function.
    - Acquire a new element `ele` from the `pool` using `fd_forest_conspool_ele_acquire`.
    - Set the `slot` and `forest_pool_idx` fields of `ele` to the provided `slot` and `pool_idx` values.
    - Insert `ele` into the `consumed` list using `fd_forest_consumed_ele_insert`.
    - Push `ele` to the tail of the conslist using `fd_forest_conslist_ele_push_tail`.
- **Output**: This function does not return a value.


---
### consumed\_remove<!-- {{#callable:consumed_remove}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L137>)

Removes an element from the consumed list in a forest data structure and releases its resources.
- **Inputs**:
    - ``forest``: A pointer to the `fd_forest_t` structure representing the forest from which to remove the consumed element.
    - ``slot``: An unsigned long integer representing the slot of the element to be removed from the consumed list.
- **Logic and Control Flow**:
    - Retrieve the consumed list and pool from the forest using `fd_forest_consumed` and `fd_forest_conspool` functions.
    - Attempt to remove the element associated with the given `slot` from the consumed list using `fd_forest_consumed_ele_remove`.
    - If the element is successfully removed, remove it from the conslist using `fd_forest_conslist_ele_remove`.
    - Release the element back to the pool using `fd_forest_conspool_ele_release`.
- **Output**: This function does not return a value.


---
### fd\_forest\_init<!-- {{#callable:fd_forest_init}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L148>)

Initializes a forest data structure with a root node using a specified root slot.
- **Inputs**:
    - ``forest``: A pointer to an `fd_forest_t` structure that represents the forest to initialize.
    - ``root_slot``: An unsigned long integer representing the slot number for the root node.
- **Logic and Control Flow**:
    - Check if `forest` is not NULL and if the forest version is uninitialized using `FD_TEST` macros.
    - Increment the forest version using the `VER_INC` macro.
    - Retrieve the pool, null index, and frontier from the forest.
    - Acquire a new element from the pool to serve as the root node and initialize its fields with `root_slot` and null values for parent, child, and sibling.
    - Set the `fecs` and `cmpl` indices of the root element to full using `fd_forest_blk_idxs_full`.
    - Set the root of the forest to the index of the root element in the pool.
    - Insert the root element into the frontier and the consumed map using `fd_forest_frontier_ele_insert` and [`consumed_insert`](<#consumed_insert>).
    - Perform sanity checks to ensure the root element is correctly initialized and inserted into the frontier.
    - Return the initialized `forest` structure.
- **Output**: Returns a pointer to the initialized `fd_forest_t` structure.
- **Functions Called**:
    - [`fd_forest_ver`](<fd_forest.h.md#fd_forest_ver>)
    - [`consumed_insert`](<#consumed_insert>)


---
### fd\_forest\_deque<!-- {{#callable:fd_forest_deque}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L185>)

Returns the local address of the deque associated with a given forest.
- **Inputs**:
    - ``forest``: A pointer to an `fd_forest_t` structure representing the forest whose deque address is to be retrieved.
- **Logic and Control Flow**:
    - Calls [`fd_forest_wksp`](<fd_forest.h.md#fd_forest_wksp>) to get the workspace associated with the `forest`.
    - Calls `fd_wksp_laddr_fast` with the workspace and the deque global address from the `forest` to get the local address of the deque.
- **Output**: A pointer to an `ulong` representing the local address of the deque associated with the given forest.
- **Functions Called**:
    - [`fd_forest_wksp`](<fd_forest.h.md#fd_forest_wksp>)


---
### fd\_forest\_fini<!-- {{#callable:fd_forest_fini}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L190>)

Finalizes a forest data structure by clearing its elements and updating its version to uninitialized.
- **Inputs**:
    - ``forest``: A pointer to the `fd_forest_t` structure that represents the forest to finalize.
- **Logic and Control Flow**:
    - Updates the forest version to `FD_FOREST_VER_INVAL` to mark it as invalid.
    - Retrieves various components of the forest such as pool, ancestry, frontier, subtrees, and orphaned.
    - Checks if the pool is used; if not, returns the forest immediately.
    - Initializes a deque and removes all elements from it.
    - Iterates over ancestry, frontier, subtrees, and orphaned components, pushing their indices to the deque.
    - For each index in the deque, removes the element from its respective component and releases the pool index.
    - Sets the forest root to the null index.
    - If `FD_FOREST_USE_HANDHOLDING` is defined, asserts that the pool is not used.
    - Updates the forest version to `FD_FOREST_VER_UNINIT` to mark it as uninitialized.
    - Returns the modified forest.
- **Output**: Returns a pointer to the finalized `fd_forest_t` structure.
- **Functions Called**:
    - [`fd_forest_ver`](<fd_forest.h.md#fd_forest_ver>)
    - [`fd_forest_deque`](<#fd_forest_deque>)


---
### fd\_forest\_verify<!-- {{#callable:fd_forest_verify}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L253>)

Verifies the integrity and validity of a `fd_forest_t` structure by checking its alignment, workspace association, magic number, initialization state, and the consistency of its internal maps.
- **Inputs**:
    - `forest`: A pointer to a constant `fd_forest_t` structure that represents the forest to verify.
- **Logic and Control Flow**:
    - Check if `forest` is NULL and log a warning if true, returning -1.
    - Verify if `forest` is aligned according to `fd_forest_align()` and log a warning if misaligned, returning -1.
    - Ensure `forest` is part of a workspace using `fd_wksp_containing()` and log a warning if not, returning -1.
    - Check if `forest->magic` matches `FD_FOREST_MAGIC` and log a warning if it does not, returning -1.
    - Verify if the forest is initialized by querying `fd_fseq_query()` and log a warning if uninitialized, returning -1.
    - Retrieve constant pointers to the forest's internal maps: `pool`, `frontier`, `orphaned`, `ancestry`, and `subtrees`.
    - Verify each map (`ancestry`, `frontier`, `subtrees`, `orphaned`) using their respective verify functions, returning -1 if any verification fails.
    - Iterate over elements in `frontier`, `orphaned`, and `subtrees` to ensure elements do not appear in more than one map, returning -1 if any do.
    - For each element in `frontier`, trace back to ensure an ancestor exists in the `consumed` map, returning -1 if not found.
    - Ensure each element in the `consumed` map is present in either the `frontier` or `ancestry` map, returning -1 if not.
- **Output**: Returns 0 if the forest is valid, otherwise returns -1 if any verification step fails.
- **Functions Called**:
    - [`fd_forest_align`](<fd_forest.h.md#fd_forest_align>)
    - [`fd_forest_ver_const`](<fd_forest.h.md#fd_forest_ver_const>)
    - [`fd_forest_pool_const`](<fd_forest.h.md#fd_forest_pool_const>)
    - [`fd_forest_frontier_const`](<fd_forest.h.md#fd_forest_frontier_const>)
    - [`fd_forest_orphaned_const`](<fd_forest.h.md#fd_forest_orphaned_const>)
    - [`fd_forest_ancestry_const`](<fd_forest.h.md#fd_forest_ancestry_const>)
    - [`fd_forest_subtrees_const`](<fd_forest.h.md#fd_forest_subtrees_const>)
    - [`fd_forest_consumed_const`](<fd_forest.h.md#fd_forest_consumed_const>)
    - [`fd_forest_conspool_const`](<fd_forest.h.md#fd_forest_conspool_const>)


---
### ancestry\_frontier\_remove<!-- {{#callable:ancestry_frontier_remove}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L347>)

Removes and returns an element from the ancestry or frontier maps of a forest data structure based on a given slot.
- **Inputs**:
    - ``forest``: A pointer to the `fd_forest_t` structure representing the forest from which an element is to be removed.
    - ``slot``: An unsigned long integer representing the slot identifier of the element to be removed from the ancestry or frontier maps.
- **Logic and Control Flow**:
    - Retrieve the pool of elements from the forest using `fd_forest_pool` function.
    - Attempt to remove the element from the ancestry map using `fd_forest_ancestry_ele_remove`.
    - If the element is not found in the ancestry map, attempt to remove it from the frontier map using `fd_forest_frontier_ele_remove`.
    - Return the removed element, if any, or `NULL` if no element was removed.
- **Output**: A pointer to the `fd_forest_blk_t` structure representing the removed element, or `NULL` if no element was removed.


---
### subtrees\_orphaned\_remove<!-- {{#callable:subtrees_orphaned_remove}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L356>)

Removes and returns an element from either the orphaned or subtrees maps in a forest data structure.
- **Inputs**:
    - ``forest``: A pointer to the `fd_forest_t` structure representing the forest.
    - ``slot``: An unsigned long integer representing the slot of the element to remove.
- **Logic and Control Flow**:
    - Retrieve the pool of elements from the forest using `fd_forest_pool` function.
    - Attempt to remove an element from the orphaned map using `fd_forest_orphaned_ele_remove`.
    - If an element is found in the orphaned map, return it immediately.
    - If no element is found in the orphaned map, attempt to remove an element from the subtrees map using `fd_forest_subtrees_ele_remove`.
    - If an element is found in the subtrees map, decrement the `subtree_cnt` of the forest.
    - Return the element found in either the orphaned or subtrees map, or `NULL` if no element is found.
- **Output**: A pointer to the `fd_forest_blk_t` structure representing the removed element, or `NULL` if no element is found.


---
### link\_sibling<!-- {{#callable:link_sibling}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L369>)

Links an element to the end of a sibling chain in a forest data structure.
- **Inputs**:
    - ``forest``: A pointer to the `fd_forest_t` structure representing the forest.
    - ``sibling``: A pointer to the `fd_forest_blk_t` structure representing the starting sibling block.
    - ``ele``: A pointer to the `fd_forest_blk_t` structure representing the element to link as a sibling.
- **Logic and Control Flow**:
    - Retrieve the pool of blocks from the forest using `fd_forest_pool` function.
    - Get the null index for the pool using `fd_forest_pool_idx_null`.
    - Iterate through the sibling chain until the last sibling is found (i.e., `sibling->sibling` is equal to `null`).
    - Set the `sibling` field of the last sibling to the index of `ele` in the pool using `fd_forest_pool_idx`.
- **Output**: No return value; the function modifies the sibling chain in the forest data structure.


---
### link<!-- {{#callable:link}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L379>)

Links a child node to a parent node in a forest data structure, either as a left-child or a right-sibling.
- **Inputs**:
    - ``forest``: A pointer to the `fd_forest_t` structure representing the forest.
    - ``parent``: A pointer to the `fd_forest_blk_t` structure representing the parent node.
    - ``child``: A pointer to the `fd_forest_blk_t` structure representing the child node to be linked.
- **Logic and Control Flow**:
    - Retrieve the pool of blocks from the forest using `fd_forest_pool` function.
    - Get the null index for the pool using `fd_forest_pool_idx_null`.
    - Check if the `parent` node has no child (`parent->child` equals `null`).
    - If true, set `parent->child` to the index of the `child` node in the pool, making it the left-child.
    - If false, call [`link_sibling`](<#link_sibling>) to link the `child` as a right-sibling of the existing child.
    - Set the `child->parent` to the index of the `parent` node in the pool.
- **Output**: No return value; the function modifies the `parent` and `child` nodes in place.
- **Functions Called**:
    - [`link_sibling`](<#link_sibling>)


---
### advance\_consumed\_frontier<!-- {{#callable:advance_consumed_frontier}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L393>)

Attempts to advance the consumed frontier in a forest data structure using a breadth-first search (BFS) approach.
- **Inputs**:
    - ``forest``: A pointer to the `fd_forest_t` structure representing the forest.
    - ``slot``: An unsigned long integer representing the current slot to start advancing from.
    - ``parent_slot``: An unsigned long integer representing the parent slot of the current slot.
- **Logic and Control Flow**:
    - Retrieve the pools and consumed map from the forest structure.
    - Query the consumed map for the element corresponding to the `slot` or `parent_slot`.
    - If no element is found, exit the function.
    - Push the pool index of the found element onto the queue.
    - While the queue is not empty, pop the head of the queue and retrieve the corresponding element from the pool.
    - Check if the element's child is complete and all FECs are completed.
    - If complete, remove the element from the consumed map and add its children to the consumed frontier.
    - Push the children onto the queue to continue the BFS.
- **Output**: No explicit return value; the function modifies the forest's consumed frontier in place.
- **Functions Called**:
    - [`fd_forest_deque`](<#fd_forest_deque>)
    - [`consumed_remove`](<#consumed_remove>)
    - [`consumed_insert`](<#consumed_insert>)


---
### query<!-- {{#callable:query}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L430>)

Searches for an element in a forest data structure using a given slot identifier.
- **Inputs**:
    - ``forest``: A pointer to the `fd_forest_t` structure representing the forest to search.
    - ``slot``: An unsigned long integer representing the slot identifier to search for in the forest.
- **Logic and Control Flow**:
    - Initialize pointers to various components of the forest: `pool`, `ancestry`, `frontier`, `subtrees`, and `orphaned`.
    - Set `ele` to `NULL` initially.
    - Query the `ancestry` component for the element with the given `slot`.
    - If the element is not found in `ancestry`, query the `frontier` component.
    - If still not found, query the `subtrees` component.
    - If still not found, query the `orphaned` component.
    - Return the found element or `NULL` if not found in any component.
- **Output**: A pointer to the `fd_forest_blk_t` structure representing the found element, or `NULL` if the element is not found.


---
### acquire<!-- {{#callable:acquire}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L446>)

Acquires a new block from the pool and initializes its fields for a given slot and parent slot in the forest.
- **Inputs**:
    - ``forest``: A pointer to the `fd_forest_t` structure representing the forest.
    - ``slot``: An unsigned long integer representing the slot number for the new block.
    - ``parent_slot``: An unsigned long integer representing the parent slot number for the new block.
- **Logic and Control Flow**:
    - Retrieve the block pool from the forest using `fd_forest_pool` function.
    - Check if there is a free block in the pool using `fd_forest_pool_free`. If not, log an error and exit.
    - Acquire a new block from the pool using `fd_forest_pool_ele_acquire`.
    - Initialize the block's `slot` and `parent_slot` with the provided values.
    - Set the block's `next`, `parent`, `child`, and `sibling` pointers to null using `fd_forest_pool_idx_null`.
    - Set the block's `consumed_idx`, `buffered_idx`, and `complete_idx` to `UINT_MAX`.
    - Initialize the block's `fecs`, `idxs`, and `cmpl` arrays to null using `fd_forest_blk_idxs_null`.
    - Set the block's `est_buffered_tick_recv` to 0.
    - Initialize metrics tracking fields such as `first_shred_ts`, `first_req_ts`, `turbine_cnt`, `repair_cnt`, and `recovered_cnt` to 0.
    - Return the initialized block.
- **Output**: Returns a pointer to the newly acquired and initialized `fd_forest_blk_t` block.


---
### fd\_forest\_query<!-- {{#callable:fd_forest_query}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L488>)

Queries a forest data structure for a block at a specified slot.
- **Inputs**:
    - ``forest``: A pointer to an `fd_forest_t` structure representing the forest to query.
    - ``slot``: An unsigned long integer representing the slot number to query within the forest.
- **Logic and Control Flow**:
    - Calls the [`query`](<#query>) function with the provided `forest` and `slot` as arguments.
    - Returns the result of the [`query`](<#query>) function call.
- **Output**: A pointer to an `fd_forest_blk_t` structure representing the block at the specified slot, or `NULL` if not found.
- **Functions Called**:
    - [`query`](<#query>)


---
### fd\_forest\_blk\_insert<!-- {{#callable:fd_forest_blk_insert}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L493>)

Inserts a block into a forest data structure, linking it to its parent and updating the forest's state.
- **Inputs**:
    - ``forest``: A pointer to the `fd_forest_t` structure representing the forest.
    - ``slot``: An unsigned long integer representing the slot of the block to insert.
    - ``parent_slot``: An unsigned long integer representing the slot of the parent block.
- **Logic and Control Flow**:
    - Check if the block with the given `slot` already exists in the forest using [`query`](<#query>); if it does, return it.
    - Acquire a new block for the given `slot` and `parent_slot` using [`acquire`](<#acquire>).
    - Determine the location of the parent block (`ancestry`, `frontier`, `orphaned`, or `subtrees`) and insert the new block accordingly.
    - If the parent is found, link the new block to the parent using [`link`](<#link>).
    - Iterate over subtrees to find and connect orphaned blocks to the new block if their parent slot matches the new block's slot.
    - If the new block is in the frontier, extend the frontier by iterating over its children and updating their status.
    - Ensure the new block is reachable from the consumed frontier, adding it to the consumed map if necessary.
    - Return the newly inserted block.
- **Output**: Returns a pointer to the newly inserted `fd_forest_blk_t` block.
- **Functions Called**:
    - [`fd_forest_root_slot`](<fd_forest.h.md#fd_forest_root_slot>)
    - [`query`](<#query>)
    - [`fd_forest_deque`](<#fd_forest_deque>)
    - [`acquire`](<#acquire>)
    - [`link`](<#link>)
    - [`consumed_insert`](<#consumed_insert>)


---
### fd\_forest\_data\_shred\_insert<!-- {{#callable:fd_forest_data_shred_insert}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L592>)

Inserts a data shred into a forest block and updates related metadata.
- **Inputs**:
    - ``forest``: A pointer to the `fd_forest_t` structure representing the forest.
    - ``slot``: The slot number where the shred is to be inserted.
    - ``parent_slot``: The parent slot number of the current slot.
    - ``shred_idx``: The index of the shred to be inserted.
    - ``fec_set_idx``: The index of the FEC set associated with the shred.
    - ``slot_complete``: A flag indicating if the slot is complete.
    - ``ref_tick``: The reference tick count for timing purposes.
    - ``src``: The source of the shred, which can be turbine, repair, or recovered.
- **Logic and Control Flow**:
    - Increment the version counter using `VER_INC` macro.
    - Query the forest for the block associated with the given `slot`.
    - If the block is not found and handholding is enabled, log an error.
    - Insert the `fec_set_idx` and `shred_idx` into the block's FECs if conditions are met.
    - Update the block's `complete_idx` if the slot is complete.
    - If the shred is newly seen, update the source counters (`turbine_cnt`, `repair_cnt`, `recovered_cnt`).
    - Set the `first_shred_ts` if it is not already set.
    - Insert the `shred_idx` into the block's indices.
    - Update the `buffered_idx` and `est_buffered_tick_recv` while the next shred index is present.
    - Call [`advance_consumed_frontier`](<#advance_consumed_frontier>) to attempt to advance the consumed frontier.
- **Output**: Returns a pointer to the `fd_forest_blk_t` structure representing the block where the shred was inserted.
- **Functions Called**:
    - [`query`](<#query>)
    - [`advance_consumed_frontier`](<#advance_consumed_frontier>)


---
### fd\_forest\_fec\_insert<!-- {{#callable:fd_forest_fec_insert}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L621>)

Inserts a Forward Error Correction (FEC) block into the forest data structure, updating the completion index and inserting data shreds as needed.
- **Inputs**:
    - ``forest``: A pointer to the `fd_forest_t` structure representing the forest.
    - ``slot``: The slot number where the FEC block is to be inserted.
    - ``parent_slot``: The parent slot number of the current slot.
    - ``last_shred_idx``: The index of the last shred in the FEC set.
    - ``fec_set_idx``: The index of the FEC set to be inserted.
    - ``slot_complete``: A flag indicating if the slot is complete.
    - ``ref_tick``: A reference tick count for timing purposes.
- **Logic and Control Flow**:
    - Increment the version counter using `VER_INC` macro.
    - Query the forest for the block element corresponding to the given `slot`.
    - If the element is not found and handholding is enabled, log an error.
    - Insert the `last_shred_idx` into the completion index of the element.
    - Iterate from `fec_set_idx` to `last_shred_idx`, inserting data shreds using [`fd_forest_data_shred_insert`](<#fd_forest_data_shred_insert>).
    - Return the updated block element.
- **Output**: Returns a pointer to the `fd_forest_blk_t` structure representing the inserted or updated block element.
- **Functions Called**:
    - [`query`](<#query>)
    - [`fd_forest_data_shred_insert`](<#fd_forest_data_shred_insert>)


---
### fd\_forest\_code\_shred\_insert<!-- {{#callable:fd_forest_code_shred_insert}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L640>)

Inserts a code shred into a forest block and updates the block's state accordingly.
- **Inputs**:
    - ``forest``: A pointer to the `fd_forest_t` structure representing the forest where the code shred will be inserted.
    - ``slot``: An unsigned long integer representing the slot number of the block where the code shred will be inserted.
    - ``shred_idx``: An unsigned integer representing the index of the code shred to be inserted.
- **Logic and Control Flow**:
    - Query the forest for the block corresponding to the given `slot` using the [`query`](<#query>) function.
    - If the block is not found, return `NULL`.
    - If the block's `first_shred_ts` is zero, set it to the current tick count using `fd_tickcount()`.
    - Check if `shred_idx` is greater than or equal to the maximum index allowed for the block's code shreds using `fd_forest_blk_idxs_max`.
    - If `shred_idx` is out of bounds, log a message, increment the block's `turbine_cnt`, and return the block.
    - If the code shred at `shred_idx` is not already present in the block, increment the block's `turbine_cnt` and insert the code shred using `fd_forest_blk_idxs_insert`.
    - Return the block.
- **Output**: A pointer to the `fd_forest_blk_t` structure representing the block where the code shred was inserted, or `NULL` if the block was not found.
- **Functions Called**:
    - [`query`](<#query>)


---
### fd\_forest\_fec\_clear<!-- {{#callable:fd_forest_fec_clear}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L661>)

Clears FEC (Forward Error Correction) indices from a specified slot in the forest data structure.
- **Inputs**:
    - ``forest``: A pointer to the `fd_forest_t` structure representing the forest.
    - ``slot``: An unsigned long integer representing the slot number to clear FEC indices from.
    - ``fec_set_idx``: An unsigned integer representing the starting index of the FEC set to clear.
    - ``max_shred_idx``: An unsigned integer representing the maximum shred index to consider for clearing.
- **Logic and Control Flow**:
    - Increment the version counter using `VER_INC` macro.
    - Check if `slot` is less than or equal to the root slot of the forest; if true, log a notice and return.
    - Query the forest for the block element corresponding to `slot`; if not found, return.
    - Check if the `max_shred_idx` is already marked as complete in the block's `cmpl` indices; if true, return.
    - Iterate from `fec_set_idx` to `fec_set_idx + max_shred_idx`, removing each index from the block's `idxs`.
    - If `fec_set_idx` is zero, set `buffered_idx` to `UINT_MAX`; otherwise, update `buffered_idx` to the minimum of its current value and `fec_set_idx - 1`, or `UINT_MAX` if it was `UINT_MAX`.
- **Output**: No output is returned; the function modifies the forest data structure in place.
- **Functions Called**:
    - [`fd_forest_root_slot`](<fd_forest.h.md#fd_forest_root_slot>)
    - [`query`](<#query>)


---
### fd\_forest\_publish<!-- {{#callable:fd_forest_publish}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L690>)

Updates the root of a forest data structure to a new slot, managing the tree structure and handling edge cases.
- **Inputs**:
    - ``forest``: A pointer to the `fd_forest_t` structure representing the forest.
    - ``new_root_slot``: An unsigned long integer representing the new root slot to be published.
- **Logic and Control Flow**:
    - Logs the function call with the new root slot.
    - Increments the version of the forest.
    - Retrieves various components of the forest such as ancestry, orphaned, frontier, subtrees, conspool, pool, and queue.
    - Queries the pool for the old and new root elements.
    - Checks if the new root slot is older than the current root and logs a warning if so.
    - Handles edge cases where the new root slot is not present by inserting it into the forest.
    - Removes the old root and adds it to a prune queue.
    - Performs a breadth-first search (BFS) to prune the tree, excluding the new root and its descendants.
    - Unlinks the new root from its parent and updates the forest's root index.
    - Checks if the new root is an orphan and extends the frontier if necessary.
    - Handles edge cases where the consumed list is empty by inserting the new root into the consumed map.
    - Cleans up orphans by adding relevant ones to the prune queue and performing BFS to clean up their children.
- **Output**: Returns a pointer to the `fd_forest_blk_t` structure representing the new root element.
- **Functions Called**:
    - [`fd_forest_deque`](<#fd_forest_deque>)
    - [`query`](<#query>)
    - [`fd_forest_blk_insert`](<#fd_forest_blk_insert>)
    - [`advance_consumed_frontier`](<#advance_consumed_frontier>)
    - [`ancestry_frontier_remove`](<#ancestry_frontier_remove>)
    - [`consumed_remove`](<#consumed_remove>)
    - [`subtrees_orphaned_remove`](<#subtrees_orphaned_remove>)
    - [`consumed_insert`](<#consumed_insert>)


---
### fd\_forest\_clear<!-- {{#callable:fd_forest_clear}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L827>)

Returns the input `fd_forest_t` pointer without modification.
- **Inputs**:
    - `forest`: A pointer to an `fd_forest_t` structure.
- **Logic and Control Flow**:
    - The function takes a single input, `forest`, which is a pointer to an `fd_forest_t` structure.
    - It immediately returns the `forest` pointer without performing any operations on it.
- **Output**: The same `fd_forest_t` pointer that was passed as input.


---
### fd\_forest\_iter\_init<!-- {{#callable:fd_forest_iter_init}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L832>)

Initializes an iterator for traversing elements in a forest data structure, starting from the first element on the consumed frontier.
- **Inputs**:
    - ``forest``: A pointer to the `fd_forest_t` structure representing the forest to iterate over.
- **Logic and Control Flow**:
    - Retrieve constant pointers to the pool, conspool, and conslist from the `forest`.
    - Initialize a consumed iterator using `fd_forest_conslist_iter_fwd_init` with the conslist and conspool.
    - Create a `repair_iter` structure with initial values, including a null pool index, `UINT_MAX` for shred index, the current version of the forest, and the consumed iterator.
    - Retrieve the first element from the consumed iterator using `fd_forest_conslist_iter_ele_const`.
    - Access the corresponding element in the pool using `fd_forest_pool_ele_const`.
    - Enter a loop to skip elements that are complete by checking if `complete_idx` equals `buffered_idx`.
    - Advance the consumed iterator to the next element if the current element is complete.
    - If the consumed iterator is done, set `repair_iter.ele_idx` to null and `repair_iter.shred_idx` to `UINT_MAX`, then return `repair_iter`.
    - If an incomplete element is found, set `repair_iter.ele_idx` to the element's pool index and `repair_iter.shred_idx` to the next shred index to process.
    - Return the initialized `repair_iter`.
- **Output**: Returns an `fd_forest_iter_t` structure initialized to iterate over the forest starting from the first incomplete element on the consumed frontier.
- **Functions Called**:
    - [`fd_forest_pool_const`](<fd_forest.h.md#fd_forest_pool_const>)
    - [`fd_forest_conspool_const`](<fd_forest.h.md#fd_forest_conspool_const>)
    - [`fd_forest_ver_const`](<fd_forest.h.md#fd_forest_ver_const>)


---
### fd\_forest\_iter\_next<!-- {{#callable:fd_forest_iter_next}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L872>)

Advances the iterator to the next element in the forest traversal, handling changes in the frontier and wrapping around indices as needed.
- **Inputs**:
    - `iter`: The current iterator state, of type `fd_forest_iter_t`, which includes the current element index, shred index, frontier version, and head of the frontier iterator.
    - `forest`: A constant pointer to the forest structure, `fd_forest_t`, which contains the data and state of the forest being traversed.
- **Logic and Control Flow**:
    - Retrieve the pool, current element, conslist, and conspool from the forest using the current iterator's element index.
    - Check if the frontier version has changed since the iterator was initialized; if so, reset the iterator to indicate no more elements.
    - Increment the shred index and enter a loop to find the next valid shred or element.
    - If the next shred index exceeds the current element's complete index or the current shred index is `UINT_MAX`, move to the next element's child and update the iterator.
    - If the current element index is null, check if the frontier version is unchanged; if so, advance the frontier iterator and update the iterator with the next element.
    - If a valid shred index is found, update the iterator's shred index and exit the loop.
    - Return the updated iterator.
- **Output**: Returns the updated iterator of type `fd_forest_iter_t`, which may indicate the next element or that traversal is complete.
- **Functions Called**:
    - [`fd_forest_pool_const`](<fd_forest.h.md#fd_forest_pool_const>)
    - [`fd_forest_conslist_const`](<fd_forest.h.md#fd_forest_conslist_const>)
    - [`fd_forest_conspool_const`](<fd_forest.h.md#fd_forest_conspool_const>)
    - [`fd_forest_ver_const`](<fd_forest.h.md#fd_forest_ver_const>)


---
### fd\_forest\_iter\_done<!-- {{#callable:fd_forest_iter_done}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L947>)

Checks if the iterator has reached the end of the elements in the forest.
- **Inputs**:
    - ``iter``: An iterator of type `fd_forest_iter_t` that traverses elements in the forest.
    - ``forest``: A constant pointer to a `fd_forest_t` structure representing the forest being iterated over.
- **Logic and Control Flow**:
    - Retrieve a constant pointer to the pool of blocks in the forest using `fd_forest_pool_const(forest)`.
    - Compare the `ele_idx` of the iterator with the null index of the pool obtained using `fd_forest_pool_idx_null(pool)`.
    - Return true if `ele_idx` is equal to the null index, indicating no more elements to iterate over.
- **Output**: Returns an integer that is non-zero if the iterator has no more elements to iterate over, otherwise returns zero.
- **Functions Called**:
    - [`fd_forest_pool_const`](<fd_forest.h.md#fd_forest_pool_const>)


---
### preorder<!-- {{#callable:preorder}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L955>)

Performs a preorder traversal of a tree structure and prints the slot value of each node.
- **Inputs**:
    - ``forest``: A pointer to a constant `fd_forest_t` structure representing the forest containing the tree.
    - ``ele``: A pointer to a constant `fd_forest_blk_t` structure representing the current element (node) in the tree to process.
- **Logic and Control Flow**:
    - Retrieve the pool of elements from the forest using [`fd_forest_pool_const`](<fd_forest.h.md#fd_forest_pool_const>) function.
    - Get the first child of the current element using `fd_forest_pool_ele_const` function.
    - Print the slot value of the current element using `printf`.
    - Enter a loop that continues as long as the child element is not NULL.
    - Within the loop, recursively call `preorder` on the child element.
    - Update the child element to its sibling using `fd_forest_pool_ele_const` function.
- **Output**: No return value; the function outputs the slot values to the standard output.
- **Functions Called**:
    - [`fd_forest_pool_const`](<fd_forest.h.md#fd_forest_pool_const>)


---
### fd\_forest\_preorder\_print<!-- {{#callable:fd_forest_preorder_print}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L966>)

Prints the nodes of a forest in preorder traversal starting from the root.
- **Inputs**:
    - ``forest``: A pointer to a constant `fd_forest_t` structure representing the forest to traverse and print.
- **Logic and Control Flow**:
    - Logs a notice indicating the start of preorder traversal.
    - Calls the [`preorder`](<#preorder>) function with the root node of the forest to print nodes in preorder.
    - Prints a newline after the traversal is complete.
- **Output**: No return value; the function outputs the traversal to the standard output.
- **Functions Called**:
    - [`preorder`](<#preorder>)
    - [`fd_forest_pool_const`](<fd_forest.h.md#fd_forest_pool_const>)


---
### orphaned\_print<!-- {{#callable:orphaned_print}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L973>)

Prints the structure of orphaned elements in a forest data structure, showing their hierarchical relationships.
- **Inputs**:
    - ``forest``: A pointer to a constant `fd_forest_t` structure representing the forest.
    - ``ele``: A pointer to a constant `fd_forest_blk_t` structure representing the current element to print.
    - ``prev``: A pointer to a constant `fd_forest_blk_t` structure representing the previous element in the sequence.
    - ``last_printed``: An unsigned long integer representing the last printed slot number.
    - ``depth``: An integer representing the current depth in the hierarchy for indentation purposes.
    - ``prefix``: A constant character pointer used as a prefix for formatting the output.
- **Logic and Control Flow**:
    - Check if `ele` is `NULL`; if so, return immediately.
    - Retrieve the pool of elements from the forest using [`fd_forest_pool_const`](<fd_forest.h.md#fd_forest_pool_const>).
    - Calculate the number of digits in the current element's slot using `fd_ulong_base10_dig_cnt`.
    - If `prefix` is not empty, print spaces for indentation based on `depth` and then print the `prefix`.
    - If `prev` is `NULL`, print the start of a new interval with the current element's slot and update `last_printed` and `depth`.
    - Retrieve the current element's child using `fd_forest_pool_ele_const`.
    - Check if the slots are non-consecutive or if the current element has multiple children; if so, print the appropriate closing and opening brackets and update `last_printed` and `depth`.
    - If there are no children, print the closing bracket and return.
    - Initialize `new_prefix` to an empty string and iterate over the children, recursively calling `orphaned_print` for each child.
    - Set up the `new_prefix` for subsequent iterations based on whether there are more siblings.
- **Output**: No return value; the function outputs formatted text to the standard output.
- **Functions Called**:
    - [`fd_forest_pool_const`](<fd_forest.h.md#fd_forest_pool_const>)


---
### ancestry\_print<!-- {{#callable:ancestry_print}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L1060>)

Prints the ancestry of a given element in a forest structure, handling different cases for child elements and elision.
- **Inputs**:
    - ``forest``: A pointer to a constant `fd_forest_t` structure representing the forest.
    - ``ele``: A pointer to a constant `fd_forest_blk_t` structure representing the current element in the forest.
    - ``space``: An integer representing the number of spaces to indent the output.
    - ``prefix``: A constant character pointer used as a prefix for the printed output.
    - ``prev``: A pointer to a constant `fd_forest_blk_t` structure representing the previous element in the forest.
    - ``elide``: An integer flag indicating whether to elide the output (1 for elide, 0 for no elide).
- **Logic and Control Flow**:
    - Check if `ele` is `NULL`; if so, return immediately.
    - Retrieve the child of the current element using `fd_forest_pool_ele_const`.
    - If `elide` is false, print a newline if `space` is greater than 0, then print spaces, the `prefix`, and the slot of `ele`.
    - If there is no child and `elide` is false, print a closing bracket and return.
    - If there is no child and `elide` is true, print the slot and a closing bracket, then return.
    - Set `prev` to `ele` and prepare a new prefix for child elements.
    - Check if there is one child and if the child's slot is non-consecutive; handle printing and recursion accordingly.
    - If there is one child and the child's slot is consecutive, call `ancestry_print` recursively with `elide` set to 1.
    - If there are multiple children, handle printing and recursion for each child, adjusting the prefix to indicate branches.
- **Output**: No return value; the function outputs to the console.
- **Functions Called**:
    - [`fd_forest_pool_const`](<fd_forest.h.md#fd_forest_pool_const>)


---
### fd\_forest\_ancestry\_print<!-- {{#callable:fd_forest_ancestry_print}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L1128>)

Prints the ancestry of a forest structure to the standard output.
- **Inputs**:
    - ``forest``: A pointer to a constant `fd_forest_t` structure representing the forest whose ancestry is to be printed.
- **Logic and Control Flow**:
    - Prints a header '[Ancestry]' followed by a newline.
    - Calls the [`ancestry_print`](<#ancestry_print>) function with the root element of the forest to print the ancestry tree.
    - Flushes the standard output to ensure all printed content is displayed immediately.
- **Output**: No return value; the function outputs directly to the standard output.
- **Functions Called**:
    - [`ancestry_print`](<#ancestry_print>)
    - [`fd_forest_pool_const`](<fd_forest.h.md#fd_forest_pool_const>)


---
### fd\_forest\_frontier\_print<!-- {{#callable:fd_forest_frontier_print}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L1135>)

Prints the details of the elements in the forest's frontier that are next to be repaired.
- **Inputs**:
    - ``forest``: A pointer to a constant `fd_forest_t` structure representing the forest whose frontier elements are to be printed.
- **Logic and Control Flow**:
    - Prints a header '[Repairing Next]' to indicate the start of the frontier elements list.
    - Retrieves constant pointers to the forest's conslist, conspool, and pool using [`fd_forest_conslist_const`](<fd_forest.h.md#fd_forest_conslist_const>), [`fd_forest_conspool_const`](<fd_forest.h.md#fd_forest_conspool_const>), and [`fd_forest_pool_const`](<fd_forest.h.md#fd_forest_pool_const>) respectively.
    - Initializes an iterator `iter` to traverse the conslist using `fd_forest_conslist_iter_fwd_init`.
    - Iterates over the conslist using a for loop, checking if the iteration is complete with `fd_forest_conslist_iter_done`.
    - For each element in the conslist, retrieves the corresponding element from the pool using `fd_forest_pool_ele_const`.
    - Prints the slot number and the buffered and complete indices of each element in the format '%lu (%u/%u)'.
    - Flushes the standard output buffer to ensure all printed content is displayed immediately.
- **Output**: No return value; the function outputs directly to the standard output.
- **Functions Called**:
    - [`fd_forest_conslist_const`](<fd_forest.h.md#fd_forest_conslist_const>)
    - [`fd_forest_conspool_const`](<fd_forest.h.md#fd_forest_conspool_const>)
    - [`fd_forest_pool_const`](<fd_forest.h.md#fd_forest_pool_const>)


---
### fd\_forest\_orphaned\_print<!-- {{#callable:fd_forest_orphaned_print}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L1152>)

Prints the orphaned subtrees of a forest data structure.
- **Inputs**:
    - ``forest``: A pointer to a constant `fd_forest_t` structure representing the forest to be processed.
- **Logic and Control Flow**:
    - Prints the header '[Orphaned]' to indicate the start of orphaned subtrees output.
    - Retrieves the constant subtrees and pool from the given forest using [`fd_forest_subtrees_const`](<fd_forest.h.md#fd_forest_subtrees_const>) and [`fd_forest_pool_const`](<fd_forest.h.md#fd_forest_pool_const>).
    - Initializes an iterator for the subtrees using `fd_forest_subtrees_iter_init`.
    - Iterates over each subtree using a loop that continues until `fd_forest_subtrees_iter_done` returns true.
    - For each subtree element, retrieves the element using `fd_forest_subtrees_iter_ele_const`.
    - Calls [`orphaned_print`](<#orphaned_print>) to print details of each orphaned subtree element.
    - Flushes the standard output buffer to ensure all output is printed.
- **Output**: No return value; the function outputs directly to the standard output.
- **Functions Called**:
    - [`fd_forest_subtrees_const`](<fd_forest.h.md#fd_forest_subtrees_const>)
    - [`fd_forest_pool_const`](<fd_forest.h.md#fd_forest_pool_const>)
    - [`orphaned_print`](<#orphaned_print>)


---
### fd\_forest\_print<!-- {{#callable:fd_forest_print}} -->
[View Source →](<../../../../../src/discof/forest/fd_forest.c#L1166>)

Prints the structure of a forest, including its ancestry, frontier, and orphaned elements, to the standard output.
- **Inputs**:
    - ``forest``: A pointer to a constant `fd_forest_t` structure representing the forest to print.
- **Logic and Control Flow**:
    - Check if the `forest` root is `ULONG_MAX`; if true, return immediately without printing.
    - Log a notice indicating the start of the forest print operation.
    - Call [`fd_forest_ancestry_print`](<#fd_forest_ancestry_print>) to print the ancestry of the forest.
    - Call [`fd_forest_frontier_print`](<#fd_forest_frontier_print>) to print the frontier of the forest.
    - Call [`fd_forest_orphaned_print`](<#fd_forest_orphaned_print>) to print the orphaned elements of the forest.
    - Print a newline character to separate the output visually.
    - Flush the standard output to ensure all printed content is displayed.
- **Output**: No return value; the function outputs the forest structure to the standard output.
- **Functions Called**:
    - [`fd_forest_ancestry_print`](<#fd_forest_ancestry_print>)
    - [`fd_forest_frontier_print`](<#fd_forest_frontier_print>)
    - [`fd_forest_orphaned_print`](<#fd_forest_orphaned_print>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)