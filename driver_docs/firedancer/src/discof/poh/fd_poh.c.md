<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a Proof of History (PoH) state machine with functions for state transitions, hashing, and microblock management.

# Purpose
The code implements a Proof of History (PoH) state machine, which is a component used in distributed systems to maintain a verifiable sequence of events. The state machine transitions through several states: `UNINIT`, `FOLLOWER`, `WAITING_FOR_BANK`, `WAITING_FOR_SLOT`, `LEADER`, and `WAITING_FOR_RESET`. The state machine starts in the `UNINIT` state and transitions to `FOLLOWER` once a snapshot is loaded. In the `FOLLOWER` state, the machine hashes continuously to reach a `next_leader_slot`. Upon reaching this slot, it transitions to `WAITING_FOR_BANK`, where it waits for additional information to proceed with hashing and mixins until the end of the block. The state machine can be reset at any time, except when in the `UNINIT` state, by the replay tile, which may adjust the reset slot. The `next_leader_slot` must always advance forward.

The code defines several functions to manage the PoH state machine. Functions like [`fd_poh_new`](<#fd_poh_new>) and [`fd_poh_join`](<#fd_poh_join>) initialize and join the PoH state machine, respectively. The [`fd_poh_reset`](<#fd_poh_reset>) function resets the state machine with new parameters, while [`fd_poh_begin_leader`](<#fd_poh_begin_leader>) and [`fd_poh_done_packing`](<#fd_poh_done_packing>) manage transitions related to leadership roles. The [`fd_poh_advance`](<#fd_poh_advance>) function advances the state machine by hashing and publishing ticks or microblocks as needed. The code also includes utility functions such as [`fd_poh_align`](<#fd_poh_align>) and [`fd_poh_footprint`](<#fd_poh_footprint>) to provide alignment and memory footprint information. The state machine is designed to handle leader and follower roles, manage hash counts, and publish results to a replay system, ensuring a consistent and verifiable sequence of events in a distributed environment.
# Imports and Dependencies

---
- `fd_poh.h`


# Functions

---
### fd\_poh\_align<!-- {{#callable:fd_poh_align}} -->
[View Source →](<../../../../../src/discof/poh/fd_poh.c#L57>)

Returns the constant `FD_POH_ALIGN`.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the value of the constant `FD_POH_ALIGN`.
- **Output**: The output is the constant `FD_POH_ALIGN` of type `ulong`.


---
### fd\_poh\_footprint<!-- {{#callable:fd_poh_footprint}} -->
[View Source →](<../../../../../src/discof/poh/fd_poh.c#L62>)

Returns the constant value `FD_POH_FOOTPRINT`.
- **Inputs**: None
- **Logic and Control Flow**:
    - The function does not take any input parameters.
    - It directly returns the value of the constant `FD_POH_FOOTPRINT`.
- **Output**: The function returns an `ulong` representing the constant `FD_POH_FOOTPRINT`.


---
### fd\_poh\_new<!-- {{#callable:fd_poh_new}} -->
[View Source →](<../../../../../src/discof/poh/fd_poh.c#L67>)

Initializes a `fd_poh_t` structure in shared memory, setting its state to uninitialized and aligning it properly.
- **Inputs**:
    - `shmem`: A pointer to shared memory where the `fd_poh_t` structure will be initialized.
- **Logic and Control Flow**:
    - Cast `shmem` to a `fd_poh_t` pointer named `poh`.
    - Check if `poh` is NULL; if so, log a warning and return NULL.
    - Check if `poh` is misaligned using `fd_ulong_is_aligned`; if so, log a warning and return NULL.
    - Set `poh->hashcnt_per_tick` to `ULONG_MAX`.
    - Set `poh->state` to `STATE_UNINIT`.
    - Use `FD_COMPILER_MFENCE` to ensure memory ordering before and after setting `poh->magic` to `FD_POH_MAGIC`.
    - Return the pointer `poh` cast to `void *`.
- **Output**: Returns a pointer to the initialized `fd_poh_t` structure, or NULL if there is an error.
- **Functions Called**:
    - [`fd_poh_align`](<#fd_poh_align>)


---
### fd\_poh\_join<!-- {{#callable:fd_poh_join}} -->
[View Source →](<../../../../../src/discof/poh/fd_poh.c#L91>)

Validates and initializes a `fd_poh_t` structure from a shared memory pointer, setting output pointers for shredding and replaying.
- **Inputs**:
    - ``shpoh``: A pointer to shared memory that should contain a `fd_poh_t` structure.
    - ``shred_out``: A pointer to an `fd_poh_out_t` structure for shredding output.
    - ``replay_out``: A pointer to an `fd_poh_out_t` structure for replaying output.
- **Logic and Control Flow**:
    - Check if `shpoh` is NULL; if so, log a warning and return NULL.
    - Check if `shpoh` is aligned according to [`fd_poh_align`](<#fd_poh_align>); if not, log a warning and return NULL.
    - Cast `shpoh` to a `fd_poh_t` pointer and check if its `magic` field matches `FD_POH_MAGIC`; if not, log a warning and return NULL.
    - Copy the contents of `shred_out` to `poh->shred_out` and `replay_out` to `poh->replay_out`.
    - Return the `fd_poh_t` pointer.
- **Output**: Returns a pointer to the initialized `fd_poh_t` structure, or NULL if validation fails.
- **Functions Called**:
    - [`fd_poh_align`](<#fd_poh_align>)


---
### transition\_to\_follower<!-- {{#callable:transition_to_follower}} -->
[View Source →](<../../../../../src/discof/poh/fd_poh.c#L118>)

Transitions the state of the PoH machine to 'follower' and handles the completion of a leader slot if applicable.
- **Inputs**:
    - ``poh``: A pointer to an `fd_poh_t` structure representing the current state of the PoH machine.
    - ``stem``: A pointer to an `fd_stem_context_t` structure used for publishing data.
    - ``completed_leader_slot``: An integer indicating whether the leader slot was completed (non-zero) or not (zero).
- **Logic and Control Flow**:
    - Verify that the current state of `poh` is one of the valid states for transitioning to follower (`STATE_LEADER`, `STATE_WAITING_FOR_BANK`, `STATE_WAITING_FOR_SLOT`, or `STATE_WAITING_FOR_RESET`).
    - If `completed_leader_slot` is true, ensure the current state is `STATE_LEADER`.
    - If the current state is `STATE_LEADER` or `STATE_WAITING_FOR_SLOT`, prepare a `fd_poh_leader_slot_ended_t` structure with the completed slot information, including the block hash, and publish it using `fd_stem_publish`.
    - Update the `chunk` in `poh->replay_out` to the next compacted chunk using `fd_dcache_compact_next`.
    - Set the state of `poh` to `STATE_FOLLOWER`.
- **Output**: No return value; the function modifies the state of the `poh` structure and publishes data if necessary.


---
### update\_hashes\_per\_tick<!-- {{#callable:update_hashes_per_tick}} -->
[View Source →](<../../../../../src/discof/poh/fd_poh.c#L139>)

Updates the number of hashes per tick in the `fd_poh_t` structure and recalculates related timing and slot information if the value has changed.
- **Inputs**:
    - `poh`: A pointer to an `fd_poh_t` structure that holds the state and configuration of the Proof of History (PoH) machine.
    - `hashcnt_per_tick`: The new number of hashes to be performed per tick.
- **Logic and Control Flow**:
    - Check if the current `hashcnt_per_tick` in `poh` is different from the provided `hashcnt_per_tick`.
    - If the current `hashcnt_per_tick` is not `ULONG_MAX`, log a warning about the change in `hashcnt_per_tick`.
    - Recalculate `hashcnt_duration_ns` as the ratio of `tick_duration_ns` to `hashcnt_per_tick`.
    - Update `hashcnt_per_slot` by multiplying `ticks_per_slot` with `hashcnt_per_tick`.
    - Set `hashcnt_per_tick` in `poh` to the new value.
    - Reset the slot and hash count to the reset slot and zero, respectively, ensuring any interim ticks are discarded.
- **Output**: No return value; the function updates the `fd_poh_t` structure in place.


---
### fd\_poh\_reset<!-- {{#callable:fd_poh_reset}} -->
[View Source →](<../../../../../src/discof/poh/fd_poh.c#L176>)

Resets the Proof of History (PoH) state machine to a new state based on the provided parameters.
- **Inputs**:
    - `poh`: A pointer to the `fd_poh_t` structure representing the PoH state machine.
    - `stem`: A pointer to the `fd_stem_context_t` structure used for publishing.
    - `timestamp`: The local timestamp when the reset is occurring.
    - `hashcnt_per_tick`: The number of hashes per tick of the bank that completed.
    - `ticks_per_slot`: The number of ticks per slot.
    - `tick_duration_ns`: The duration of each tick in nanoseconds.
    - `completed_slot`: The slot that successfully produced a block.
    - `completed_blockhash`: A pointer to the hash of the last tick in the produced block.
    - `next_leader_slot`: The next slot where this node will be leader.
    - `max_microblocks_in_slot`: The maximum number of microblocks that may appear in a slot.
    - `completed_block_id`: A pointer to the block ID of the completed block.
- **Logic and Control Flow**:
    - Copy `completed_blockhash` to `poh->reset_hash`, `poh->hash`, and `poh->completed_block_id`.
    - Set `poh->slot` to `completed_slot + 1` and initialize `poh->hashcnt`, `poh->last_slot`, `poh->last_hashcnt`, and `poh->reset_slot` to zero or the new slot value.
    - Set `poh->next_leader_slot`, `poh->max_microblocks_per_slot`, and `poh->reset_slot_start_ns` to the respective input values.
    - If `poh->state` is `STATE_UNINIT`, initialize `poh->tick_duration_ns`, `poh->ticks_per_slot`, and set `poh->state` to `STATE_FOLLOWER`.
    - If `poh->state` is not `STATE_UNINIT`, verify that `tick_duration_ns` and `ticks_per_slot` match the current values.
    - Call [`update_hashes_per_tick`](<#update_hashes_per_tick>) to update the hash count per tick.
    - Set `poh->microblocks_lower_bound` to `poh->max_microblocks_per_slot`.
    - If `poh->state` is not `STATE_FOLLOWER`, call [`transition_to_follower`](<#transition_to_follower>).
    - If `poh->slot` equals `poh->next_leader_slot`, set `poh->state` to `STATE_WAITING_FOR_BANK`.
- **Output**: No return value; the function modifies the state of the `fd_poh_t` structure in place.
- **Functions Called**:
    - [`update_hashes_per_tick`](<#update_hashes_per_tick>)
    - [`transition_to_follower`](<#transition_to_follower>)


---
### fd\_poh\_begin\_leader<!-- {{#callable:fd_poh_begin_leader}} -->
[View Source →](<../../../../../src/discof/poh/fd_poh.c#L220>)

Initializes the Proof of History (PoH) state machine to begin a leader slot with specified parameters.
- **Inputs**:
    - ``poh``: A pointer to the `fd_poh_t` structure representing the PoH state machine.
    - ``slot``: The slot number that the PoH is transitioning to as a leader.
    - ``hashcnt_per_tick``: The number of hashes to compute per tick.
    - ``ticks_per_slot``: The number of ticks in each slot.
    - ``tick_duration_ns``: The duration of each tick in nanoseconds.
    - ``max_microblocks_in_slot``: The maximum number of microblocks allowed in a slot.
- **Logic and Control Flow**:
    - Checks that the current state of `poh` is either `STATE_FOLLOWER` or `STATE_WAITING_FOR_BANK`.
    - Verifies that the `slot` matches `poh->next_leader_slot`.
    - Sets `poh->max_microblocks_per_slot` to `max_microblocks_in_slot + 1` to reserve an empty microblock at the end of the slot.
    - Confirms that `tick_duration_ns` and `ticks_per_slot` match the current PoH configuration.
    - Calls [`update_hashes_per_tick`](<#update_hashes_per_tick>) to update the hash count per tick.
    - Transitions the state to `STATE_WAITING_FOR_SLOT` if the current state is `STATE_FOLLOWER`, otherwise to `STATE_LEADER`.
    - Sets `poh->microblocks_lower_bound` to 0.
    - Logs the beginning of the leader slot with the current slot, last slot, and last hash count.
- **Output**: No return value; modifies the state of the `fd_poh_t` structure.
- **Functions Called**:
    - [`update_hashes_per_tick`](<#update_hashes_per_tick>)


---
### fd\_poh\_have\_leader\_bank<!-- {{#callable:fd_poh_have_leader_bank}} -->
[View Source →](<../../../../../src/discof/poh/fd_poh.c#L248>)

Checks if the PoH state is either `STATE_WAITING_FOR_SLOT` or `STATE_LEADER`.
- **Inputs**:
    - `poh`: A pointer to a constant `fd_poh_t` structure representing the Proof of History (PoH) state machine.
- **Logic and Control Flow**:
    - Check if `poh->state` is equal to `STATE_WAITING_FOR_SLOT` or `STATE_LEADER`.
    - Return 1 if either condition is true, otherwise return 0.
- **Output**: Returns an integer indicating whether the PoH state is `STATE_WAITING_FOR_SLOT` or `STATE_LEADER`.


---
### fd\_poh\_hashing\_to\_leader\_slot<!-- {{#callable:fd_poh_hashing_to_leader_slot}} -->
[View Source →](<../../../../../src/discof/poh/fd_poh.c#L253>)

Determines if the PoH (Proof of History) machine is currently hashing towards the next leader slot.
- **Inputs**:
    - `poh`: A pointer to a constant `fd_poh_t` structure representing the current state of the PoH machine.
- **Logic and Control Flow**:
    - Check if the `state` of `poh` is either `STATE_WAITING_FOR_SLOT` or `STATE_LEADER` and store the result in `hashing`.
    - Return the logical AND of `hashing` and the condition `poh->slot < poh->next_leader_slot`.
- **Output**: Returns an integer indicating whether the PoH machine is hashing towards the next leader slot (1 if true, 0 if false).


---
### fd\_poh\_done\_packing<!-- {{#callable:fd_poh_done_packing}} -->
[View Source →](<../../../../../src/discof/poh/fd_poh.c#L259>)

Ensures the packing process in a leader state is complete by verifying microblock counts and adjusting internal counters.
- **Inputs**:
    - ``poh``: A pointer to an `fd_poh_t` structure representing the current state of the Proof of History (PoH) machine.
    - ``microblocks_in_slot``: The number of microblocks that have been packed in the current slot.
- **Logic and Control Flow**:
    - Check if the PoH machine is in the `STATE_LEADER` state using `FD_TEST`.
    - Log the completion of packing with the current slot and microblock information using `FD_LOG_INFO`.
    - Verify that the `microblocks_lower_bound` is equal to `microblocks_in_slot` using `FD_TEST`.
    - Ensure `microblocks_lower_bound` does not exceed `max_microblocks_per_slot` using `FD_TEST`.
    - Adjust `microblocks_lower_bound` by adding the difference between `max_microblocks_per_slot` and `microblocks_in_slot`.
    - Confirm that `microblocks_lower_bound` equals `max_microblocks_per_slot` using `FD_TEST`.
- **Output**: No return value; the function modifies the state of the `fd_poh_t` structure pointed to by `poh`.


---
### publish\_tick<!-- {{#callable:publish_tick}} -->
[View Source →](<../../../../../src/discof/poh/fd_poh.c#L273>)

Publishes a tick for a Proof of History (PoH) slot, updating metadata and handling skipped slots.
- **Inputs**:
    - ``poh``: A pointer to the `fd_poh_t` structure, which contains the state and configuration of the PoH instance.
    - ``stem``: A pointer to the `fd_stem_context_t` structure, which is used for publishing data.
    - ``hash``: An array of 32 unsigned characters representing the hash to be published with the tick.
    - ``is_skipped``: An integer flag indicating whether the tick is for a skipped slot (non-zero if skipped).
- **Logic and Control Flow**:
    - Calculate `hashcnt` based on the current and last hash count per tick.
    - Determine the destination address `dst` for writing metadata and tick data.
    - Check if the current slot is greater than or equal to the reset slot using `FD_TEST`.
    - If `is_skipped` is true, set `meta->reference_tick` and `meta->block_complete` to zero; otherwise, calculate and set these values based on `hashcnt`.
    - Set `meta->parent_block_id_valid` to 1 and copy the `completed_block_id` to `meta->parent_block_id`.
    - Calculate the `slot` and `meta->parent_offset` based on whether the block is complete.
    - Verify that `hashcnt` is greater than `poh->last_hashcnt` using `FD_TEST`.
    - Calculate `hash_delta` as the difference between `hashcnt` and `poh->last_hashcnt`.
    - Advance `dst` to point to the tick header and set `tick->hashcnt_delta`, copy `hash` to `tick->hash`, and set `tick->txn_cnt` to zero.
    - Calculate the publication timestamp `tspub` and size `sz` of the data to be published.
    - Generate a signature `sig` and publish the tick using `fd_stem_publish`.
    - Update `poh->shred_out->chunk` to the next compacted chunk.
    - If `hashcnt` equals `poh->hashcnt_per_slot`, increment `poh->last_slot` and reset `poh->last_hashcnt`; otherwise, update `poh->last_hashcnt` to `hashcnt`.
- **Output**: No return value; the function performs operations to publish a tick and update the PoH state.


---
### fd\_poh\_advance<!-- {{#callable:fd_poh_advance}} -->
[View Source →](<../../../../../src/discof/poh/fd_poh.c#L323>)

Advances the Proof of History (PoH) state machine by updating hash counts and handling state transitions based on the current state and slot.
- **Inputs**:
    - `poh`: A pointer to the `fd_poh_t` structure representing the current state of the PoH machine.
    - `stem`: A pointer to the `fd_stem_context_t` structure used for publishing ticks and microblocks.
    - `opt_poll_in`: A pointer to an integer that indicates whether to process incoming microblocks (set to 0 if not processing).
    - `charge_busy`: A pointer to an integer that indicates whether the function has performed work (set to 1 if work was done).
- **Logic and Control Flow**:
    - Check if the PoH state is `STATE_UNINIT` or `STATE_WAITING_FOR_RESET`, and return if true.
    - Check if the PoH state is `STATE_WAITING_FOR_BANK`, and return if true.
    - If the PoH state is `STATE_LEADER` and there are skipped ticks, publish them and set `opt_poll_in` to 0 and `charge_busy` to 1, then return.
    - Determine if the system is in low power mode based on `hashcnt_per_tick`.
    - Calculate `max_remaining_microblocks` and `max_remaining_ticks_or_microblocks` to determine the available capacity for microblocks.
    - Calculate `restricted_hashcnt` and `min_hashcnt` to define the range for the target hash count.
    - Calculate the current time and determine `target_hashcnt` based on the PoH state and current time.
    - Clamp `target_hashcnt` to the range defined by `min_hashcnt` and `restricted_hashcnt`.
    - Adjust `target_hashcnt` to ensure it does not exceed the next tick boundary.
    - If `target_hashcnt` is equal to the current `hashcnt`, return without further action.
    - Set `charge_busy` to 1 to indicate work was done.
    - If `hashcnt` is less than `target_hashcnt`, update the hash and `hashcnt` to `target_hashcnt`.
    - If `hashcnt` reaches `hashcnt_per_slot`, increment the slot and reset `hashcnt`.
    - Handle state transitions based on the current PoH state and hash count, publishing ticks or transitioning to follower state as needed.
- **Output**: No direct output is returned, but the function updates the state of the PoH machine and may modify `opt_poll_in` and `charge_busy`.
- **Functions Called**:
    - [`publish_tick`](<#publish_tick>)
    - [`transition_to_follower`](<#transition_to_follower>)


---
### publish\_microblock<!-- {{#callable:publish_microblock}} -->
[View Source →](<../../../../../src/discof/poh/fd_poh.c#L596>)

Publishes a microblock by preparing metadata, copying transaction data, and invoking the publish function.
- **Inputs**:
    - ``poh``: A pointer to the `fd_poh_t` structure, which contains the state and data for the Proof of History (PoH) process.
    - ``stem``: A pointer to the `fd_stem_context_t` structure, which is used for publishing the microblock.
    - ``slot``: An unsigned long integer representing the current slot number for the microblock.
    - ``hashcnt_delta``: An unsigned long integer representing the change in hash count since the last microblock.
    - ``txn_cnt``: An unsigned long integer representing the number of transactions to include in the microblock.
    - ``txns``: A pointer to an array of `fd_txn_p_t` structures, each representing a transaction to be included in the microblock.
- **Logic and Control Flow**:
    - Convert the chunk address from `poh->shred_out` to a local address and assign it to `dst`.
    - Verify that `slot` is greater than or equal to `poh->reset_slot`.
    - Initialize the `meta` structure at `dst` with parent offset, reference tick, and block completion status.
    - Set `parent_block_id_valid` to 1 and copy `poh->completed_block_id` to `meta->parent_block_id`.
    - Advance `dst` by the size of `fd_entry_batch_meta_t` and initialize the `header` structure with `hashcnt_delta` and the current hash.
    - Advance `dst` by the size of `fd_entry_batch_header_t` and iterate over `txns` to copy successful transaction payloads to `dst`, updating `payload_sz` and `included_txn_cnt`.
    - Set `header->txn_cnt` to `included_txn_cnt`.
    - Calculate the timestamp for publication and the size of the microblock, then compute a new signature for the microblock.
    - Publish the microblock using `fd_stem_publish` and update `poh->shred_out->chunk` to the next compacted chunk.
- **Output**: No return value; the function performs operations to publish a microblock.


---
### fd\_poh1\_mixin<!-- {{#callable:fd_poh1_mixin}} -->
[View Source →](<../../../../../src/discof/poh/fd_poh.c#L643>)

Processes transactions for a given slot, updates the hash state, and publishes a microblock if transactions are successfully executed.
- **Inputs**:
    - ``poh``: A pointer to the `fd_poh_t` structure representing the Proof of History state.
    - ``stem``: A pointer to the `fd_stem_context_t` structure used for publishing microblocks.
    - ``slot``: The current slot number being processed.
    - ``hash``: A pointer to a 32-byte array representing the hash to be mixed in.
    - ``txn_cnt``: The number of transactions to process.
    - ``txns``: A pointer to an array of `fd_txn_p_t` structures representing the transactions to be processed.
- **Logic and Control Flow**:
    - Check if the current slot matches the expected leader slot and the current slot in `poh`; log an error if not.
    - Verify that the `poh` state is `STATE_LEADER` and that the microblocks lower bound is less than the maximum allowed per slot.
    - Increment the microblocks lower bound by one.
    - Initialize `executed_txn_cnt` to zero and iterate over each transaction to count those with the `FD_TXN_P_FLAGS_EXECUTE_SUCCESS` flag set.
    - If no transactions are successfully executed, return without further processing.
    - Copy the current `poh` hash and the provided `hash` into a 64-byte array and compute a new SHA-256 hash, updating the `poh` hash.
    - Increment the `poh` hash count and calculate the difference from the last hash count.
    - Check if the hash count reaches the slot boundary and update the slot and hash count accordingly.
    - Update the last slot and last hash count in `poh`.
    - Check if the hash count reaches the tick boundary and transition to follower state if the slot exceeds the next leader slot.
    - Call [`publish_microblock`](<#publish_microblock>) to publish the processed microblock.
- **Output**: No return value; the function updates the state of `poh` and publishes a microblock if applicable.
- **Functions Called**:
    - [`transition_to_follower`](<#transition_to_follower>)
    - [`publish_microblock`](<#publish_microblock>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)