<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a Proof of History (PoH) tile for transaction ordering and processing in a distributed system.

# Purpose
The code defines a module for managing Proof of History (PoH) operations in a distributed system. It includes structures and functions to handle the processing of microblocks, which are small units of transactions, in a specific order to prevent race conditions. The module ensures that microblocks are processed in the order they are produced by the packing component, which is crucial for maintaining the correct sequence of transactions and preventing misordering in the accounts database. The code defines two main structures: `fd_poh_in_t` for input management and `fd_poh_tile_t` for handling PoH operations, including tracking the expected order of microblocks and managing input and output links.

The module also includes several inline functions for managing memory alignment and footprint, processing input fragments, and initializing the PoH tile in an unprivileged context. It uses a callback mechanism to handle specific events, such as after crediting and determining if a fragment is returnable. The code integrates with a larger system through the `fd_topo_run_tile_t` structure, which specifies the tile's name, security policies, and initialization and execution functions. This module is part of a larger framework, as indicated by the inclusion of other headers and the use of external functions and structures.
# Imports and Dependencies

---
- `fd_poh.h`
- `generated/fd_poh_tile_seccomp.h`
- `fd_poh_tile.h`
- `../replay/fd_replay_tile.h`
- `../../disco/tiles.h`
- `../../disco/stem/fd_stem.c`


# Global Variables

---
### fd\_tile\_poh
- **Type**: ``fd_topo_run_tile_t``
- **Description**: Defines a `fd_topo_run_tile_t` structure named `fd_tile_poh` with various function pointers and parameters for managing a tile in a topology. The structure includes fields for security policies, memory alignment, initialization functions, and a run function.
- **Use**: Used to configure and manage the execution of a tile named 'poh' in a topology.


# Data Structures

---
### fd\_poh\_in
- **Type**: ``struct``
- **Members**:
    - ``mem``: A pointer to a `fd_wksp_t` structure, representing a memory workspace.
    - ``chunk0``: An unsigned long integer representing the starting chunk index.
    - ``wmark``: An unsigned long integer representing the watermark or upper limit for chunks.
    - ``mtu``: An unsigned long integer representing the maximum transmission unit size.
- **Description**: The `fd_poh_in` structure is used to manage input data for a Proof of History (PoH) tile. It contains a pointer to a memory workspace (`mem`), and three unsigned long integers: `chunk0`, `wmark`, and `mtu`, which are used to track the starting chunk index, the watermark for chunks, and the maximum transmission unit size, respectively. This structure is part of a larger system that processes and orders microblocks in a distributed ledger environment.


---
### fd\_poh\_in\_t
- **Type**: ``struct``
- **Members**:
    - ``mem``: Pointer to a workspace memory area.
    - ``chunk0``: Initial chunk index in the workspace.
    - ``wmark``: Watermark indicating the upper limit of valid data in the workspace.
    - ``mtu``: Maximum transmission unit size for data chunks.
- **Description**: `fd_poh_in_t` is a structure that holds information about a workspace memory area, including pointers to the memory, the initial chunk index, a watermark for data validity, and the maximum transmission unit size. This structure is used to manage and track data chunks within a workspace in the context of processing transactions or data packets.


---
### fd\_poh\_tile
- **Type**: ``struct``
- **Members**:
    - ``poh``: An array of `fd_poh_t` structures, used for Proof of History (PoH) operations.
    - ``expect_pack_idx``: An unsigned integer that tracks the expected index of the next pack operation to ensure correct order.
    - ``in_cnt``: A count of input links currently being processed.
    - ``idle_cnt``: A count of idle cycles when no input is processed.
    - ``in_kind``: An array of integers indicating the type of each input link.
    - ``in``: An array of `fd_poh_in_t` structures representing input links.
    - ``shred_out``: An array of `fd_poh_out_t` structures for output related to shredding.
    - ``replay_out``: An array of `fd_poh_out_t` structures for output related to replay operations.
- **Description**: The `fd_poh_tile` structure manages the processing of microblocks in a Proof of History (PoH) system, ensuring that transactions are processed in the correct order to prevent race conditions. It includes fields for tracking the expected order of operations, counts of inputs and idle cycles, and arrays for managing input and output links. The structure is designed to handle different types of input links, such as replay, pack, and bank, and ensures that microblocks with conflicting accounts are executed in the correct sequence.


---
### fd\_poh\_tile\_t
- **Type**: ``struct``
- **Members**:
    - `poh`: An array of one `fd_poh_t` structure, which is likely used for Proof of History (PoH) operations.
    - `expect_pack_idx`: A `uint` that tracks the expected index of the next pack operation.
    - `in_cnt`: A `ulong` that counts the number of input links.
    - `idle_cnt`: A `ulong` that counts the number of idle cycles.
    - `in_kind`: An array of 64 `int` values that categorize the type of each input link.
    - `in`: An array of 64 `fd_poh_in_t` structures that store input link information.
    - `shred_out`: An array of one `fd_poh_out_t` structure for output related to shreds.
    - `replay_out`: An array of one `fd_poh_out_t` structure for output related to replay.
- **Description**: `fd_poh_tile_t` is a structure that manages the processing of microblocks in a Proof of History (PoH) system. It includes fields for tracking the expected order of pack operations, counting input and idle cycles, and categorizing input links. The structure also contains arrays for handling input and output data related to PoH operations, ensuring that microblocks are processed in the correct order to prevent race conditions and maintain the integrity of the accounts database.


# Functions

---
### scratch\_align<!-- {{#callable:scratch_align}} -->
[View Source →](<../../../../../src/discof/poh/fd_poh_tile.c#L51>)

Returns a constant alignment value of 128.
- **Inputs**: None
- **Logic and Control Flow**:
    - The function is defined as `static inline`, indicating it is intended for use within the same translation unit and suggests a preference for inlining by the compiler.
    - The function is marked with `FD_FN_CONST`, indicating that it has no side effects and its return value depends only on its parameters (of which there are none).
    - The function simply returns the constant value `128UL`.
- **Output**: A constant unsigned long value of 128.


---
### scratch\_footprint<!-- {{#callable:scratch_footprint}} -->
[View Source →](<../../../../../src/discof/poh/fd_poh_tile.c#L56>)

Calculates the memory footprint required for a `fd_poh_tile_t` structure with specific alignment.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure, which is not used in the function.
- **Logic and Control Flow**:
    - Initialize a variable `l` with `FD_LAYOUT_INIT`.
    - Append the size and alignment of `fd_poh_tile_t` to `l` using `FD_LAYOUT_APPEND`.
    - Finalize the layout with `FD_LAYOUT_FINI`, using the alignment from `scratch_align()`.
    - Return the calculated memory footprint.
- **Output**: Returns an `ulong` representing the memory footprint required for a `fd_poh_tile_t` structure with the specified alignment.
- **Functions Called**:
    - [`scratch_align`](<#scratch_align>)


---
### after\_credit<!-- {{#callable:after_credit}} -->
[View Source →](<../../../../../src/discof/poh/fd_poh_tile.c#L64>)

Increments the idle counter and advances the PoH context if the idle count exceeds twice the input count.
- **Inputs**:
    - `ctx`: A pointer to a `fd_poh_tile_t` structure representing the PoH context.
    - `stem`: A pointer to a `fd_stem_context_t` structure used in the PoH advancement.
    - `opt_poll_in`: A pointer to an integer that may be used in the PoH advancement process.
    - `charge_busy`: A pointer to an integer that may be used in the PoH advancement process.
- **Logic and Control Flow**:
    - Increment `ctx->idle_cnt` by 1.
    - Check if `ctx->idle_cnt` is greater than or equal to twice `ctx->in_cnt`.
    - If the condition is true, call [`fd_poh_advance`](<fd_poh.c.md#fd_poh_advance>) with `ctx->poh`, `stem`, `opt_poll_in`, and `charge_busy` as arguments.
    - Reset `ctx->idle_cnt` to 0.
- **Output**: No direct output; modifies the state of `ctx` and potentially advances the PoH context.
- **Functions Called**:
    - [`fd_poh_advance`](<fd_poh.c.md#fd_poh_advance>)


---
### returnable\_frag<!-- {{#callable:returnable_frag}} -->
[View Source →](<../../../../../src/discof/poh/fd_poh_tile.c#L95>)

Processes input fragments based on their type and updates the context accordingly, handling various conditions and errors.
- **Inputs**:
    - `ctx`: Pointer to the `fd_poh_tile_t` context structure.
    - `in_idx`: Index of the input in the context's input array.
    - `seq`: Sequence number of the fragment (unused in this function).
    - `sig`: Signature of the fragment, used to determine specific actions.
    - `chunk`: Chunk identifier for the fragment.
    - `sz`: Size of the fragment.
    - `ctl`: Control parameter (unused in this function).
    - `tsorig`: Original timestamp of the fragment (unused in this function).
    - `tspub`: Publication timestamp of the fragment (unused in this function).
    - `stem`: Pointer to the `fd_stem_context_t` structure.
- **Logic and Control Flow**:
    - Ignore certain parameters (`seq`, `ctl`, `tsorig`, `tspub`) as they are not used in the function.
    - Check if `sig` is `ULONG_MAX` and the input kind is `IN_KIND_PACK`; if true, reset `idle_cnt` and return 0.
    - Validate the `chunk` and `sz` against the context's input range and MTU; log an error if invalid.
    - Check for race conditions related to leader bank status and return 1 if conditions are not met.
    - For `IN_KIND_BANK` or `IN_KIND_PACK`, validate the `pack_idx` against `expect_pack_idx`; log an error or return 1 if out of order.
    - Use a switch statement to handle different input kinds (`IN_KIND_PACK`, `IN_KIND_REPLAY`, `IN_KIND_BANK`) and perform specific actions based on the `sig` value.
    - Reset `idle_cnt` to 0 and return 0 at the end of the function.
- **Output**: Returns 0 on successful processing or 1 if certain conditions are not met.
- **Functions Called**:
    - [`fd_poh_have_leader_bank`](<fd_poh.c.md#fd_poh_have_leader_bank>)
    - [`fd_poh_hashing_to_leader_slot`](<fd_poh.c.md#fd_poh_hashing_to_leader_slot>)
    - [`fd_poh_done_packing`](<fd_poh.c.md#fd_poh_done_packing>)
    - [`fd_poh_begin_leader`](<fd_poh_tile.h.md#fd_poh_begin_leader>)
    - [`fd_poh_reset`](<fd_poh_tile.h.md#fd_poh_reset>)
    - [`fd_poh1_mixin`](<fd_poh.c.md#fd_poh1_mixin>)


---
### out1<!-- {{#callable:out1}} -->
[View Source →](<../../../../../src/discof/poh/fd_poh_tile.c#L185>)

Finds and returns the output link information for a given link name in a topology tile.
- **Inputs**:
    - `topo`: A pointer to a `fd_topo_t` structure representing the topology.
    - `tile`: A pointer to a `fd_topo_tile_t` structure representing the tile within the topology.
    - `name`: A string representing the name of the output link to find.
- **Logic and Control Flow**:
    - Initialize `idx` to `ULONG_MAX` to track the index of the output link with the specified name.
    - Iterate over each output link in the `tile` using a loop from 0 to `tile->out_cnt`.
    - For each link, retrieve the link information from `topo->links` using the link ID from `tile->out_link_id`.
    - Compare the link's name with the specified `name` using `strcmp`.
    - If a match is found and `idx` is already set, log an error indicating multiple links with the same name.
    - If a match is found and `idx` is not set, update `idx` with the current index.
    - After the loop, if `idx` is still `ULONG_MAX`, log an error indicating no link with the specified name was found.
    - Retrieve the memory workspace for the link using `topo->workspaces` and the link's `dcache_obj_id`.
    - Calculate `chunk0` and `wmark` using `fd_dcache_compact_chunk0` and `fd_dcache_compact_wmark` respectively.
    - Return a `fd_poh_out_t` structure initialized with the found link's index, memory, `chunk0`, and `wmark`.
- **Output**: Returns a `fd_poh_out_t` structure containing the index, memory workspace, `chunk0`, and `wmark` of the found output link.


---
### unprivileged\_init<!-- {{#callable:unprivileged_init}} -->
[View Source →](<../../../../../src/discof/poh/fd_poh_tile.c#L208>)

Initializes the unprivileged context for a tile in the topology, setting up input links and output connections for processing.
- **Inputs**:
    - `topo`: A pointer to the `fd_topo_t` structure representing the topology configuration.
    - `tile`: A pointer to the `fd_topo_tile_t` structure representing the specific tile to initialize.
- **Logic and Control Flow**:
    - Allocate scratch memory for the tile using `fd_topo_obj_laddr` and `FD_SCRATCH_ALLOC_INIT`.
    - Allocate and initialize a `fd_poh_tile_t` context within the scratch memory using `FD_SCRATCH_ALLOC_APPEND`.
    - Set initial values for `expect_pack_idx`, `in_cnt`, and `idle_cnt` in the context.
    - Iterate over each input link of the tile, setting up memory, chunk, watermark, and MTU for each link in the context.
    - Determine the kind of each input link (`IN_KIND_REPLAY`, `IN_KIND_PACK`, `IN_KIND_BANK`) based on the link name and store it in the context.
    - Set up output connections for `shred_out` and `replay_out` using the [`out1`](<#out1>) function.
    - Join the PoH context with the new PoH instance using [`fd_poh_join`](<fd_poh.c.md#fd_poh_join>).
    - Finalize the scratch allocation with `FD_SCRATCH_ALLOC_FINI` and check for scratch overflow, logging an error if it occurs.
- **Output**: No return value; the function initializes the context and sets up the necessary links and connections for the tile.
- **Functions Called**:
    - [`out1`](<#out1>)
    - [`fd_poh_join`](<fd_poh.c.md#fd_poh_join>)
    - [`fd_poh_new`](<fd_poh.c.md#fd_poh_new>)
    - [`scratch_footprint`](<#scratch_footprint>)


---
### populate\_allowed\_seccomp<!-- {{#callable:populate_allowed_seccomp}} -->
[View Source →](<../../../../../src/discof/poh/fd_poh_tile.c#L246>)

Populates a seccomp filter policy for a tile and returns the instruction count.
- **Inputs**:
    - `topo`: A pointer to a `fd_topo_t` structure, which is not used in this function.
    - `tile`: A pointer to a `fd_topo_tile_t` structure, which is not used in this function.
    - `out_cnt`: An unsigned long integer representing the count of output filters.
    - `out`: A pointer to an array of `struct sock_filter` where the seccomp filter policy will be populated.
- **Logic and Control Flow**:
    - The function ignores the `topo` and `tile` inputs as they are not used.
    - Calls [`populate_sock_filter_policy_fd_poh_tile`](<generated/fd_poh_tile_seccomp.h.md#populate_sock_filter_policy_fd_poh_tile>) with `out_cnt`, `out`, and the file descriptor from `fd_log_private_logfile_fd()`.
    - Returns the value of `sock_filter_policy_fd_poh_tile_instr_cnt`.
- **Output**: Returns an unsigned long integer representing the instruction count of the seccomp filter policy.
- **Functions Called**:
    - [`populate_sock_filter_policy_fd_poh_tile`](<generated/fd_poh_tile_seccomp.h.md#populate_sock_filter_policy_fd_poh_tile>)


---
### populate\_allowed\_fds<!-- {{#callable:populate_allowed_fds}} -->
[View Source →](<../../../../../src/discof/poh/fd_poh_tile.c#L258>)

Populates an array with file descriptors for standard error and a log file, if available.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, which is not used in this function.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure, which is not used in this function.
    - ``out_fds_cnt``: The maximum number of file descriptors that can be stored in the `out_fds` array.
    - ``out_fds``: An array of integers where the function will store the allowed file descriptors.
- **Logic and Control Flow**:
    - Check if `out_fds_cnt` is less than 2; if true, log an error and terminate.
    - Initialize `out_cnt` to 0.
    - Assign the file descriptor for standard error (2) to `out_fds[0]` and increment `out_cnt`.
    - Check if the log file descriptor is valid (not -1); if true, assign it to `out_fds[1]` and increment `out_cnt`.
    - Return the count of file descriptors stored in `out_fds`.
- **Output**: Returns the number of file descriptors stored in the `out_fds` array.



---
Made with ❤️ by [Driver](https://www.driver.ai/)