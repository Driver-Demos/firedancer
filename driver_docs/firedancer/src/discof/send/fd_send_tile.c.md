<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a system for managing and sending network connections using QUIC and UDP protocols, including connection mapping, message handling, and metrics tracking.

# Purpose
The code is a C source file that implements a network communication module using the QUIC protocol. It is designed to manage connections and send data packets to network peers, specifically focusing on handling leader election and communication in a distributed system. The module includes functionality for establishing and maintaining QUIC connections, sending and receiving data packets, and managing connection states. It uses a map to associate leader public keys with their respective connection information, including IP addresses and ports for both UDP and QUIC protocols.

Key components of the code include the definition of a connection map (`fd_send_conn_map`) to track connection information for staked peers, the setup of QUIC connection limits (`fd_quic_limits_t`), and various callback functions for handling QUIC events such as connection establishment and termination. The code also includes functions for sending data packets to network peers, managing contact information updates, and ensuring connections are established for specific slots in a distributed system. Additionally, the code integrates with a larger system through input and output links, and it includes metrics collection for monitoring connection and data transmission performance.
# Imports and Dependencies

---
- `fd_send_tile.h`
- `../../disco/topo/fd_topo.h`
- `../../disco/keyguard/fd_keyload.h`
- `../../disco/fd_txn_m.h`
- `../../disco/keyguard/fd_keyguard.h`
- `../../discof/tower/fd_tower_tile.h`
- `generated/fd_send_tile_seccomp.h`
- `../../flamenco/gossip/fd_gossip_types.h`
- `sys/random.h`
- `../../util/tmpl/fd_map.c`
- `../../disco/stem/fd_stem.c`


# Global Variables

---
### quic\_limits
- **Type**: ``fd_quic_limits_t``
- **Description**: Defines the limits for QUIC connections and resources. It includes parameters such as the number of connections, handshake count, connection ID count, inflight frame count, and buffer sizes.
- **Use**: Used to configure the maximum limits and resource allocations for QUIC connections in the application.


---
### handle\_contact\_info\_removal
- **Type**: `function`
- **Description**: Removes contact information for a given public key from the connection map. It closes any existing QUIC connections and resets the IP and port information for the specified entry.
- **Use**: Used to handle the removal of contact information when a contact info removal message is received.


---
### fd\_tile\_send
- **Type**: ``fd_topo_run_tile_t``
- **Description**: Defines a structure for a tile in the topology that handles sending operations. It includes function pointers for initialization, security policy population, and execution of the tile's main logic.
- **Use**: Used to configure and manage the execution of a send tile in a distributed system.


# Functions

---
### scratch\_align<!-- {{#callable:scratch_align}} -->
[View Source →](<../../../../../src/discof/send/fd_send_tile.c#L52>)

Calculates the maximum alignment requirement among three values: 128, the alignment required by QUIC, and the alignment required by the connection map.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `fd_quic_align()` to get the alignment requirement for QUIC.
    - Calls `fd_send_conn_map_align()` to get the alignment requirement for the connection map.
    - Uses `fd_ulong_max()` to find the maximum value among 128, the result of `fd_quic_align()`, and the result of `fd_send_conn_map_align()`.
- **Output**: Returns the maximum alignment requirement as an unsigned long integer.


---
### scratch\_footprint<!-- {{#callable:scratch_footprint}} -->
[View Source →](<../../../../../src/discof/send/fd_send_tile.c#L57>)

Calculates the memory footprint required for a scratch space based on various alignment and size requirements.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure, which is not used in the function.
- **Logic and Control Flow**:
    - Initialize `l` with `FD_LAYOUT_INIT` to start the layout calculation.
    - Append the size and alignment of `fd_send_tile_ctx_t` to `l` using `FD_LAYOUT_APPEND`.
    - Append the size and alignment of the QUIC context using `fd_quic_align()` and `fd_quic_footprint(&quic_limits)` to `l`.
    - Append the size and alignment of the connection map using `fd_send_conn_map_align()` and `fd_send_conn_map_footprint()` to `l`.
    - Finalize the layout with `FD_LAYOUT_FINI(l, scratch_align())` to compute the total footprint.
- **Output**: Returns an `ulong` representing the total memory footprint required for the scratch space.
- **Functions Called**:
    - [`scratch_align`](<#scratch_align>)


---
### quic\_tls\_cv\_sign<!-- {{#callable:quic_tls_cv_sign}} -->
[View Source →](<../../../../../src/discof/send/fd_send_tile.c#L68>)

Signs a payload using the ED25519 algorithm and records the signing duration.
- **Inputs**:
    - ``signer_ctx``: A pointer to the signing context, which is of type `fd_send_tile_ctx_t`.
    - ``signature``: An array of 64 unsigned characters where the function will store the generated signature.
    - ``payload``: A constant array of 130 unsigned characters representing the data to be signed.
- **Logic and Control Flow**:
    - Retrieve the signing context from `signer_ctx` and cast it to `fd_send_tile_ctx_t` type.
    - Record the current time using `fd_clock_now` and store it in `dt` as a negative value.
    - Call `fd_keyguard_client_sign` to sign the `payload` using the ED25519 algorithm, storing the result in `signature`.
    - Update `dt` by adding the current time to it, and store the current time in `ctx->now`.
    - Record the signing duration in `ctx->metrics.sign_duration` using `fd_histf_sample`.
- **Output**: The function does not return a value; it modifies the `signature` array in place.


---
### quic\_hs\_complete<!-- {{#callable:quic_hs_complete}} -->
[View Source →](<../../../../../src/discof/send/fd_send_tile.c#L81>)

Handles the completion of a QUIC handshake by updating metrics and logging the event.
- **Inputs**:
    - ``conn``: A pointer to the `fd_quic_conn_t` structure representing the QUIC connection.
    - ``quic_ctx``: A pointer to a context object, which is unused in this function.
- **Logic and Control Flow**:
    - Cast `quic_ctx` to `fd_send_tile_ctx_t *` and assign it to `ctx`.
    - Retrieve the connection entry context using `fd_quic_conn_get_context` and cast it to `fd_send_conn_entry_t *`, assigning it to `entry`.
    - If `entry` is NULL, return immediately.
    - Iterate over the `entry->conn` array to find the index where the connection matches `conn`.
    - Increment the `quic_hs_complete` metric for the found index in `ctx->metrics`.
    - Log a debug message indicating the completion of the QUIC handshake for the leader identified by `entry->pubkey.key`.
- **Output**: No return value; the function updates metrics and logs a message.


---
### port\_idx\_is\_quic<!-- {{#callable:port_idx_is_quic}} -->
[View Source →](<../../../../../src/discof/send/fd_send_tile.c#L94>)

Checks if a given port index corresponds to a QUIC port.
- **Inputs**:
    - `port_idx`: An unsigned long integer representing the port index to check.
- **Logic and Control Flow**:
    - Compares `port_idx` with `FD_SEND_PORT_QUIC_VOTE_IDX` and `FD_SEND_PORT_QUIC_TPU_IDX`.
    - Returns a bitwise OR of the results of these comparisons.
- **Output**: Returns an integer that is non-zero if `port_idx` matches either `FD_SEND_PORT_QUIC_VOTE_IDX` or `FD_SEND_PORT_QUIC_TPU_IDX`, indicating it is a QUIC port.


---
### quic\_conn\_final<!-- {{#callable:quic_conn_final}} -->
[View Source →](<../../../../../src/discof/send/fd_send_tile.c#L100>)

Handles the finalization of a QUIC connection by clearing the connection entry and updating metrics.
- **Inputs**:
    - ``conn``: A pointer to the `fd_quic_conn_t` structure representing the QUIC connection to finalize.
    - ``quic_ctx``: A pointer to the context associated with the QUIC connection, typically of type `fd_send_tile_ctx_t`.
- **Logic and Control Flow**:
    - Retrieve the connection entry using `fd_quic_conn_get_context` and type punning.
    - Check if the entry is NULL and log a critical error if so.
    - Type pun the `quic_ctx` to `fd_send_tile_ctx_t`.
    - Initialize `clr_idx` to an invalid index value (`~0UL`).
    - Iterate over the `entry->conn` array to find the matching connection.
    - If a match is found, set the connection to NULL, update `clr_idx`, log a debug message, and increment the corresponding metric.
    - If no match is found (`clr_idx` remains `~0UL`), log a critical error indicating the connection was not found.
- **Output**: No return value; the function operates through side effects on the connection entry and context.


---
### send\_to\_net<!-- {{#callable:send_to_net}} -->
[View Source →](<../../../../../src/discof/send/fd_send_tile.c#L129>)

Sends a network packet by constructing it from given headers and payload, and then publishing it to a network link.
- **Inputs**:
    - `ctx`: A pointer to `fd_send_tile_ctx_t` structure, which contains context information for sending the packet.
    - `ip4_hdr`: A pointer to a constant `fd_ip4_hdr_t` structure, representing the IPv4 header of the packet.
    - `udp_hdr`: A pointer to a constant `fd_udp_hdr_t` structure, representing the UDP header of the packet.
    - `payload`: A pointer to a constant unsigned character array, representing the payload data of the packet.
    - `payload_sz`: An unsigned long integer representing the size of the payload in bytes.
- **Logic and Control Flow**:
    - Load the destination IP address from the IPv4 header using `FD_LOAD` macro.
    - Calculate the size of the IPv4 header using `FD_IP4_GET_LEN`.
    - Retrieve the network output link from the context and calculate the memory addresses for different layers of the packet (L2, L3, L4, L5).
    - Copy the Ethernet header from the context to the L2 address, the IPv4 header to the L3 address, the UDP header to the L4 address, and the payload to the L5 address using `fd_memcpy`.
    - Generate a signature for the packet using `fd_disco_netmux_sig` with the destination IP address and other parameters.
    - Publish the packet to the network link using `fd_stem_publish` with the calculated signature, chunk, and size.
    - Update the chunk in the network output link using `fd_dcache_compact_next` to prepare for the next packet.
- **Output**: No return value; the function operates by side effects, sending a packet to the network.


---
### quic\_tx\_aio\_send<!-- {{#callable:quic_tx_aio_send}} -->
[View Source →](<../../../../../src/discof/send/fd_send_tile.c#L158>)

Processes a batch of packets, sending each valid packet to the network and optionally updating the batch index.
- **Inputs**:
    - `_ctx`: A pointer to the context (`fd_send_tile_ctx_t`) used for sending packets.
    - `batch`: A pointer to an array of `fd_aio_pkt_info_t` structures, each containing packet information.
    - `batch_cnt`: The number of packets in the `batch` array.
    - `opt_batch_idx`: An optional pointer to a `ulong` where the function can store the number of processed packets.
    - `flush`: An unused parameter in this function.
- **Logic and Control Flow**:
    - Iterates over each packet in the `batch` array up to `batch_cnt`.
    - Checks if the packet size is less than `FD_NETMUX_SIG_MIN_HDR_SZ`; if so, skips processing that packet.
    - Extracts the IP header, UDP header, and payload from each packet buffer.
    - Calculates the payload size by subtracting the sizes of the IP and UDP headers from the total buffer size.
    - Calls [`send_to_net`](<#send_to_net>) to send the packet to the network using the extracted headers and payload.
    - If `opt_batch_idx` is not null, sets it to `batch_cnt`.
- **Output**: Returns `FD_AIO_SUCCESS` to indicate successful processing of the batch.
- **Functions Called**:
    - [`send_to_net`](<#send_to_net>)


---
### during\_housekeeping<!-- {{#callable:during_housekeeping}} -->
[View Source →](<../../../../../src/discof/send/fd_send_tile.c#L183>)

Increments the housekeeping counter, recalibrates the clock if needed, and periodically checks and logs the status of connection map entries.
- **Inputs**:
    - ``ctx``: A pointer to a `fd_send_tile_ctx_t` structure that contains the context for the send tile, including connection map and metrics.
- **Logic and Control Flow**:
    - Increment `ctx->housekeeping_ctr` by 1.
    - Check if `ctx->recal_next` is less than or equal to `ctx->now`; if true, update `ctx->recal_next` using `fd_clock_default_recal`.
    - Define `MAP_STATS_PERIOD` as 32.
    - If `ctx->housekeeping_ctr` modulo `MAP_STATS_PERIOD` equals 0, perform the following:
    - Retrieve the number of slots in the connection map using `fd_send_conn_map_slot_cnt()`.
    - Initialize counters `staked_no_ci`, `stale_ci`, and `map_real_cnt` to 0.
    - Iterate over each entry in the connection map:
    - Check if the entry's `pubkey` is not equal to a null key using `fd_send_conn_map_key_equal`; if true, increment `map_real_cnt`.
    - If the entry has not received a contact info message (`got_ci_msg` is false), increment `staked_no_ci`.
    - If the entry's last contact info timestamp is stale (older than `CONTACT_INFO_STALE_NS`), increment `stale_ci`.
    - Update `ctx->metrics.staked_no_ci` and `ctx->metrics.stale_ci` with the respective counters.
    - Log the number of entries without contact info and stale entries using `FD_LOG_DEBUG`.
- **Output**: No return value; the function operates on the `ctx` structure to update its state and metrics.


---
### quic\_connect<!-- {{#callable:quic_connect}} -->
[View Source →](<../../../../../src/discof/send/fd_send_tile.c#L219>)

Initiates a QUIC connection for a specified entry and port index using stored contact information.
- **Inputs**:
    - `ctx`: A pointer to `fd_send_tile_ctx_t`, which contains context information for the send tile.
    - `entry`: A pointer to `fd_send_conn_entry_t`, which holds connection information for a specific peer.
    - `port_idx`: An unsigned long integer representing the index of the port to connect to.
- **Logic and Control Flow**:
    - Initialize `conn_idx` with `port_idx`, `dst_ip` with the IP address from `entry->ip4s[port_idx]`, and `dst_port` with the port from `entry->ports[port_idx]`.
    - Check that `entry->conn[conn_idx]` is `NULL` to ensure no existing connection at this index.
    - Call `fd_quic_connect` to create a new QUIC connection using the destination IP, port, source IP, source port, and current time from `ctx`.
    - If the connection creation fails, log a warning and return `NULL`.
    - Log a debug message indicating the successful creation of the connection.
    - Store the new connection in `entry->conn[conn_idx]`.
    - Set the context of the new connection to `entry` using `fd_quic_conn_set_context`.
    - Return the newly created connection.
- **Output**: Returns a pointer to the newly created `fd_quic_conn_t` connection, or `NULL` if the connection creation fails.


---
### ensure\_conn\_for\_slot<!-- {{#callable:ensure_conn_for_slot}} -->
[View Source →](<../../../../../src/discof/send/fd_send_tile.c#L246>)

Ensures a connection exists for a leader's public key if it is a leader for the specified slot, creating a connection if necessary.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_send_tile_ctx_t` context structure, which contains connection maps, metrics, and other necessary data for managing connections.
    - ``target_slot``: An unsigned long integer representing the target slot for which to ensure a connection.
    - ``lifespan``: A long integer specifying the lifespan of the connection in nanoseconds.
- **Logic and Control Flow**:
    - Retrieve the leader's public key for the given `target_slot` using `fd_multi_epoch_leaders_get_leader_for_slot` function.
    - If no leader is found, increment the `NoLeader` metric for both QUIC ports and return.
    - Query the connection map for an entry corresponding to the leader's public key using `fd_send_conn_map_query`.
    - If no entry is found, log a critical error indicating an attempt to ensure a connection for an unstaked public key.
    - Iterate over each QUIC port (defined by `FD_SEND_PORT_QUIC_CNT`).
    - For each port, check if the IP address or port is missing in the entry; if so, increment the `NoCI` metric and continue to the next port.
    - If a connection does not exist for the port, attempt to create a new connection using [`quic_connect`](<#quic_connect>).
    - If the connection creation is successful, increment the `NewConnection` metric and call `fd_quic_service` to service the QUIC connection.
    - If a connection already exists, increment the `Connected` metric, call `fd_quic_conn_let_die` to manage the connection's lifespan, and service the QUIC connection.
- **Output**: No direct output is returned, but the function updates metrics and manages connections within the provided context.
- **Functions Called**:
    - [`quic_connect`](<#quic_connect>)


---
### leader\_send<!-- {{#callable:leader_send}} -->
[View Source →](<../../../../../src/discof/send/fd_send_tile.c#L285>)

Sends a payload to a specified public key using either QUIC or UDP protocols, depending on the connection details available.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_send_tile_ctx_t` structure, which contains context information for sending data.
    - ``pubkey``: A pointer to a constant `fd_pubkey_t` structure representing the public key of the recipient.
    - ``payload``: A pointer to a constant unsigned character array containing the data to be sent.
    - ``payload_sz``: An unsigned long integer representing the size of the payload in bytes.
- **Logic and Control Flow**:
    - Queries the connection map using the provided `pubkey` to find the corresponding connection entry.
    - If no entry is found, logs a critical error indicating an unstaked public key.
    - Iterates over all possible send ports (`FD_SEND_PORT_CNT`).
    - For each port, checks if the IP address and port are routable; if not, increments the `FD_METRICS_ENUM_TXN_SEND_RESULT_V_NO_CI_IDX` metric and continues to the next port.
    - If the port is a QUIC port, checks if a connection exists; if not, logs a debug message, increments the `FD_METRICS_ENUM_TXN_SEND_RESULT_V_NO_CONN_IDX` metric, and continues.
    - Attempts to create a new QUIC stream; if unsuccessful, logs a debug message, increments the `FD_METRICS_ENUM_TXN_SEND_RESULT_V_NO_STREAM_IDX` metric, and continues.
    - If successful, increments the `FD_METRICS_ENUM_TXN_SEND_RESULT_V_SUCCESS_IDX` metric, sends the payload over the QUIC stream, and triggers an immediate send using `fd_quic_service`.
    - For non-QUIC ports, prepares the IP and UDP headers, increments the `FD_METRICS_ENUM_TXN_SEND_RESULT_V_SUCCESS_IDX` metric, and sends the payload using [`send_to_net`](<#send_to_net>).
- **Output**: No return value; the function performs its operations through side effects, such as sending data and updating metrics.
- **Functions Called**:
    - [`port_idx_is_quic`](<#port_idx_is_quic>)
    - [`send_to_net`](<#send_to_net>)


---
### handle\_contact\_info\_update<!-- {{#callable:handle_contact_info_update}} -->
[View Source →](<../../../../../src/discof/send/fd_send_tile.c#L344>)

Updates contact information for a connection entry and manages QUIC connections based on the new information.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_send_tile_ctx_t` context structure, which contains connection maps and metrics.
    - ``msg``: A pointer to a constant `fd_gossip_update_message_t` structure containing the new contact information to process.
- **Logic and Control Flow**:
    - Initialize a static array `socket_idx` to map socket types to indices.
    - Query the connection map using the public key from `msg` to find the corresponding connection entry.
    - If the entry is not found, increment the `unstaked_ci_rcvd` metric and return.
    - Iterate over each socket type defined in `FD_SEND_PORT_CNT`.
    - For each socket, retrieve the new IP address and port from `msg` and compare them with the existing values in the entry.
    - If the new IP or port is zero, log a debug message and increment the `unroutable` metric for that socket type, then continue to the next socket.
    - Determine if the contact information has changed by comparing the old and new IP addresses and ports.
    - Update the entry with the new IP address and port.
    - If the socket type is QUIC and the information has changed, close the existing QUIC connection if it exists.
    - Determine the appropriate metric index based on whether the information changed and whether the old port was zero, and increment the corresponding metric.
    - Set the `got_ci_msg` flag to 1 and update `last_ci_ns` with the current time from `ctx`.
- **Output**: No return value; updates the connection entry and metrics in the provided context.
- **Functions Called**:
    - [`port_idx_is_quic`](<#port_idx_is_quic>)


---
### finalize\_stake\_msg<!-- {{#callable:finalize_stake_msg}} -->
[View Source →](<../../../../../src/discof/send/fd_send_tile.c#L416>)

Finalizes the stake message by updating the connection map with staked validators.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_send_tile_ctx_t` context structure containing the connection map and multi-epoch leaders information.
- **Logic and Control Flow**:
    - Calls `fd_multi_epoch_leaders_stake_msg_fini` to finalize the stake message for the multi-epoch leaders.
    - Retrieves the current stake destinations using `fd_multi_epoch_leaders_get_stake_weights` and `fd_multi_epoch_leaders_get_stake_cnt`.
    - Checks if the `stakes` pointer is NULL and logs a warning if no stake destinations are available, then returns.
    - Iterates over each stake destination to update the connection map.
    - For each stake, queries the connection map for an entry with the corresponding public key using `fd_send_conn_map_query`.
    - If no entry exists for a public key, inserts a new entry into the connection map using `fd_send_conn_map_insert` and initializes it.
- **Output**: No explicit output; modifies the connection map within the context.


---
### handle\_vote\_msg<!-- {{#callable:handle_vote_msg}} -->
[View Source →](<../../../../../src/discof/send/fd_send_tile.c#L445>)

Processes a signed vote transaction by parsing, signing, sending to leaders, ensuring connections, and publishing to gossip.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_send_tile_ctx_t` context structure, which contains various configurations and state information needed for processing.
    - ``vote_slot``: An unsigned long integer representing the slot number for which the vote is being processed.
    - ``signed_vote_txn``: A pointer to an unsigned char array containing the signed vote transaction data.
    - ``vote_txn_sz``: An unsigned long integer representing the size of the signed vote transaction.
- **Logic and Control Flow**:
    - Allocate memory for the transaction and parse the signed vote transaction using `fd_txn_parse`.
    - Sign the transaction using `fd_keyguard_client_sign` with the extracted message and signature offsets.
    - Log the received vote for the specified slot.
    - Iterate over a predefined number of target leaders and send the signed transaction to each leader using [`leader_send`](<#leader_send>).
    - For each target slot, ensure a connection exists using [`ensure_conn_for_slot`](<#ensure_conn_for_slot>).
    - Prepare the transaction for gossip by copying it to a gossip message buffer and publishing it using `fd_stem_publish`.
- **Output**: No explicit return value; the function performs operations on the provided context and sends data to network components.
- **Functions Called**:
    - [`leader_send`](<#leader_send>)
    - [`ensure_conn_for_slot`](<#ensure_conn_for_slot>)


---
### before\_credit<!-- {{#callable:before_credit}} -->
[View Source →](<../../../../../src/discof/send/fd_send_tile.c#L502>)

Updates the context with the current time and processes QUIC service to determine if the system is busy.
- **Inputs**:
    - ``ctx``: A pointer to `fd_send_tile_ctx_t`, which is the context for the send tile.
    - ``stem``: A pointer to `fd_stem_context_t`, which is the context for the stem.
    - ``charge_busy``: A pointer to an integer that will be set to indicate if the system is busy after processing QUIC service.
- **Logic and Control Flow**:
    - Assigns the `stem` pointer to `ctx->stem` to update the context with the current stem.
    - Retrieves the current time using `fd_clock_now` and assigns it to `ctx->now`.
    - Calls `fd_quic_service` with `ctx->quic` and `ctx->now` to process QUIC service and assigns the result to `*charge_busy`.
- **Output**: The function does not return a value, but it updates `*charge_busy` to indicate if the system is busy.


---
### before\_frag<!-- {{#callable:before_frag}} -->
[View Source →](<../../../../../src/discof/send/fd_send_tile.c#L513>)

Determines if a fragment should be processed based on the type of input link and the signature provided.
- **Inputs**:
    - ``ctx``: A pointer to a `fd_send_tile_ctx_t` structure that contains context information for the send tile.
    - ``in_idx``: An unsigned long integer representing the index of the input link in the context's `in_links` array.
    - ``seq``: An unsigned long integer representing the sequence number, marked as unused with `FD_PARAM_UNUSED`.
    - ``sig``: An unsigned long integer representing the signature of the fragment.
- **Logic and Control Flow**:
    - Checks if the input link at index `in_idx` in `ctx->in_links` is of kind `IN_KIND_GOSSIP` using `FD_UNLIKELY` for branch prediction optimization.
    - If the input link is of kind `IN_KIND_GOSSIP`, it returns true (1) if the `sig` is neither `FD_GOSSIP_UPDATE_TAG_CONTACT_INFO` nor `FD_GOSSIP_UPDATE_TAG_CONTACT_INFO_REMOVE`.
    - If the input link is not of kind `IN_KIND_GOSSIP`, it returns false (0).
- **Output**: Returns an integer: 1 if the fragment should be processed, 0 otherwise.


---
### during\_frag<!-- {{#callable:during_frag}} -->
[View Source →](<../../../../../src/discof/send/fd_send_tile.c#L525>)

Processes incoming fragments based on their type and performs specific actions such as copying data, initializing messages, or handling vote messages.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_send_tile_ctx_t` context structure, which contains various buffers and state information for processing.
    - ``in_idx``: An unsigned long integer representing the index of the input link being processed.
    - ``seq``: An unsigned long integer representing the sequence number, marked as unused with `FD_PARAM_UNUSED`.
    - ``sig``: An unsigned long integer representing the signature, marked as unused with `FD_PARAM_UNUSED`.
    - ``chunk``: An unsigned long integer representing the chunk identifier within the data cache.
    - ``sz``: An unsigned long integer representing the size of the data fragment.
    - ``ctl``: An unsigned long integer representing control information for the fragment.
- **Logic and Control Flow**:
    - Retrieve the input link from the context using `in_idx` and check if `chunk` is within the valid range defined by `chunk0` and `wmark`; log an error if not.
    - Determine the type of the input link (`kind`) and perform actions based on this type.
    - If `kind` is `IN_KIND_NET`, translate the fragment and copy it to `ctx->quic_buf`.
    - If `kind` is `IN_KIND_STAKE`, check if `sz` exceeds the maximum expected size and log an error if it does; initialize a stake message using the data cache entry.
    - If `kind` is `IN_KIND_GOSSIP`, copy the data cache entry to `ctx->contact_buf`.
    - If `kind` is `IN_KIND_TOWER`, verify the size of the fragment, copy the vote transaction, and handle the vote message.
- **Output**: No direct output; the function modifies the context and logs errors as needed.
- **Functions Called**:
    - [`handle_vote_msg`](<#handle_vote_msg>)


---
### after\_frag<!-- {{#callable:after_frag}} -->
[View Source →](<../../../../../src/discof/send/fd_send_tile.c#L570>)

Handles different types of incoming messages by processing network packets, updating contact information, or finalizing stake messages based on the message kind.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_send_tile_ctx_t` structure, which holds the context for the send tile operation.
    - ``in_idx``: An unsigned long integer representing the index of the input link.
    - ``seq``: An unsigned long integer representing the sequence number, marked as unused.
    - ``sig``: An unsigned long integer representing the signature, marked as unused.
    - ``sz``: An unsigned long integer representing the size of the message.
    - ``tsorig``: An unsigned long integer representing the original timestamp, marked as unused.
    - ``tspub``: An unsigned long integer representing the publish timestamp, marked as unused.
    - ``stem``: A pointer to the `fd_stem_context_t` structure, which is used to update the context's stem.
- **Logic and Control Flow**:
    - Assigns the `stem` pointer to `ctx->stem` to update the context's stem.
    - Retrieves the input link from `ctx->in_links` using `in_idx` and determines the kind of message using `in_link->kind`.
    - If the message kind is `IN_KIND_NET`, processes the network packet using `fd_quic_process_packet` with the QUIC context, IP packet, and size.
    - If the message kind is `IN_KIND_GOSSIP`, checks the message tag and calls [`handle_contact_info_update`](<#handle_contact_info_update>) or `handle_contact_info_removal` based on the tag value.
    - If the message kind is `IN_KIND_STAKE`, calls [`finalize_stake_msg`](<#finalize_stake_msg>) to finalize the stake message.
- **Output**: No return value; the function operates by side effects on the context and input data.
- **Functions Called**:
    - [`handle_contact_info_update`](<#handle_contact_info_update>)
    - [`finalize_stake_msg`](<#finalize_stake_msg>)


---
### privileged\_init<!-- {{#callable:privileged_init}} -->
[View Source →](<../../../../../src/discof/send/fd_send_tile.c#L607>)

Initializes a privileged context for a tile in a topology, setting up memory and loading an identity key.
- **Inputs**:
    - ``topo``: A pointer to an `fd_topo_t` structure representing the topology.
    - ``tile``: A pointer to an `fd_topo_tile_t` structure representing the tile to initialize.
- **Logic and Control Flow**:
    - Calls `fd_topo_obj_laddr` to get the local address of the tile object in the topology.
    - Initializes scratch memory using `FD_SCRATCH_ALLOC_INIT`.
    - Allocates memory for `fd_send_tile_ctx_t` using `FD_SCRATCH_ALLOC_APPEND` and sets it to zero using `fd_memset`.
    - Checks if `identity_key_path` in `tile->send` is empty and logs an error if true.
    - Loads the identity key from the path specified in `tile->send.identity_key_path` using `fd_keyload_load` and stores it in `ctx->identity_key`.
- **Output**: No return value; initializes the context and logs errors if necessary.


---
### setup\_input\_link<!-- {{#callable:setup_input_link}} -->
[View Source →](<../../../../../src/discof/send/fd_send_tile.c#L622>)

Initializes and configures an input link for a given tile in the topology.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_send_tile_ctx_t` context structure where the input link description will be stored.
    - ``topo``: A pointer to the `fd_topo_t` structure representing the topology of the system.
    - ``tile``: A pointer to the `fd_topo_tile_t` structure representing the specific tile in the topology.
    - ``kind``: An unsigned long integer representing the kind of input link to set up.
    - ``name``: A constant character pointer representing the name of the input link to find and set up.
- **Logic and Control Flow**:
    - Finds the index of the input link in the topology using `fd_topo_find_tile_in_link` with the given `name` and checks if it is valid.
    - Retrieves the input link from the topology using the found index and stores it in `in_link`.
    - Initializes the input link description in `ctx->in_links` at the found index with memory workspace, chunk, watermark, dcache, and kind.
    - Returns the initialized input link description.
- **Output**: Returns a pointer to the initialized `fd_send_link_in_t` structure for the input link.


---
### setup\_output\_link<!-- {{#callable:setup_output_link}} -->
[View Source →](<../../../../../src/discof/send/fd_send_tile.c#L642>)

Configures an output link descriptor for a specified tile and topology.
- **Inputs**:
    - ``desc``: A pointer to an `fd_send_link_out_t` structure that will be configured.
    - ``topo``: A pointer to an `fd_topo_t` structure representing the topology.
    - ``tile``: A pointer to an `fd_topo_tile_t` structure representing the tile.
    - ``name``: A constant character pointer representing the name of the output link.
- **Logic and Control Flow**:
    - Finds the index of the output link using `fd_topo_find_tile_out_link` with the given `topo`, `tile`, and `name`.
    - Asserts that the found index is not `ULONG_MAX` using `FD_TEST`.
    - Retrieves the output link from the topology's links array using the found index.
    - Configures the `desc` structure with the index, memory cache, synchronization address, depth, memory workspace, initial chunk, watermark, and current chunk.
- **Output**: The function does not return a value; it modifies the `desc` structure in place.


---
### unprivileged\_init<!-- {{#callable:unprivileged_init}} -->
[View Source →](<../../../../../src/discof/send/fd_send_tile.c#L661>)

Initializes the unprivileged components of a tile in a network topology for sending data using QUIC and UDP protocols.
- **Inputs**:
    - ``topo``: A pointer to the `fd_topo_t` structure representing the network topology.
    - ``tile``: A pointer to the `fd_topo_tile_t` structure representing the specific tile to initialize.
- **Logic and Control Flow**:
    - Allocate scratch memory for the tile using `fd_topo_obj_laddr` and `FD_SCRATCH_ALLOC_INIT`.
    - Check if the tile has any output links; log an error if not.
    - Allocate and initialize a `fd_send_tile_ctx_t` context structure in the scratch memory.
    - Join the multi-epoch leaders using `fd_multi_epoch_leaders_join` and store in the context.
    - Create and join a QUIC transmission asynchronous I/O object using `fd_aio_new` and `fd_aio_join`; log an error if joining fails.
    - Create and join a QUIC object using `fd_quic_new` and `fd_quic_join`; log an error if joining fails.
    - Configure the QUIC object with client role, timeouts, and signing context.
    - Set up input links for gossip, stake, tower, and network using [`setup_input_link`](<#setup_input_link>).
    - Set up output links for transaction sending and network sending using [`setup_output_link`](<#setup_output_link>).
    - Initialize a keyguard client for signing operations; log an error if joining fails.
    - Initialize metrics for the context and QUIC object using `fd_histf_join`.
    - Finalize scratch memory allocation and check for overflow; log an error if overflow occurs.
    - Initialize the clock and set recalibration and current time values in the context.
- **Output**: No return value; the function initializes the tile's context and network components.
- **Functions Called**:
    - [`setup_input_link`](<#setup_input_link>)
    - [`setup_output_link`](<#setup_output_link>)
    - [`scratch_align`](<#scratch_align>)
    - [`scratch_footprint`](<#scratch_footprint>)


---
### populate\_allowed\_seccomp<!-- {{#callable:populate_allowed_seccomp}} -->
[View Source →](<../../../../../src/discof/send/fd_send_tile.c#L757>)

Populates a seccomp filter policy for a send tile and returns the instruction count.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, which is not used in this function.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure, which is not used in this function.
    - ``out_cnt``: An unsigned long integer representing the count of output filters.
    - ``out``: A pointer to a `struct sock_filter` array where the function will store the seccomp filter policy.
- **Logic and Control Flow**:
    - Calls [`populate_sock_filter_policy_fd_send_tile`](<generated/fd_send_tile_seccomp.h.md#populate_sock_filter_policy_fd_send_tile>) with `out_cnt`, `out`, and the file descriptor of the log file to populate the seccomp filter policy.
    - Returns the constant `sock_filter_policy_fd_send_tile_instr_cnt`.
- **Output**: Returns an unsigned long integer representing the instruction count of the seccomp filter policy.
- **Functions Called**:
    - [`populate_sock_filter_policy_fd_send_tile`](<generated/fd_send_tile_seccomp.h.md#populate_sock_filter_policy_fd_send_tile>)


---
### populate\_allowed\_fds<!-- {{#callable:populate_allowed_fds}} -->
[View Source →](<../../../../../src/discof/send/fd_send_tile.c#L767>)

Populates an array with allowed file descriptors, including `stderr` and optionally a logfile descriptor.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, marked as unused.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure, marked as unused.
    - ``out_fds_cnt``: The maximum number of file descriptors that can be stored in the `out_fds` array.
    - ``out_fds``: A pointer to an array of integers where the function will store the allowed file descriptors.
- **Logic and Control Flow**:
    - Checks if `out_fds_cnt` is less than 2; if true, logs an error and exits.
    - Initializes `out_cnt` to 0 and assigns `stderr` (file descriptor 2) to `out_fds[0]`, then increments `out_cnt`.
    - Checks if the logfile descriptor is valid (not -1); if true, assigns it to `out_fds[out_cnt]` and increments `out_cnt`.
- **Output**: Returns the number of file descriptors stored in the `out_fds` array.


---
### metrics\_write<!-- {{#callable:metrics_write}} -->
[View Source →](<../../../../../src/discof/send/fd_send_tile.c#L781>)

Updates various metrics related to sending operations and QUIC connections in the context of a network tile.
- **Inputs**:
    - ``ctx``: A pointer to `fd_send_tile_ctx_t` structure containing metrics and context for the send tile.
- **Logic and Control Flow**:
    - Set basic counters for leader not found, unstaked contact info received, and contact info removed using `FD_MCNT_SET` macro.
    - Copy port-separated contact info metrics using `FD_MCNT_ENUM_COPY` macro for QUIC and UDP ports.
    - Copy port-separated send result metrics using `FD_MCNT_ENUM_COPY` macro for QUIC and UDP ports.
    - Copy port-separated QUIC metrics using `FD_MCNT_ENUM_COPY` macro for handshake completion and connection results.
    - Set gauges for staked without contact info and stale contact info using `FD_MGAUGE_SET` macro.
    - Copy histogram for sign duration using `FD_MHIST_COPY` macro.
    - Set general QUIC metrics for received and sent data using `FD_MCNT_SET` and `FD_MCNT_ENUM_COPY` macros.
    - Set connection metrics for state, allocation, creation, closure, abortion, timeout, retry, and errors using `FD_MCNT_SET` and `FD_MGAUGE_ENUM_COPY` macros.
    - Copy packet and frame metrics using `FD_MCNT_ENUM_COPY` and `FD_MCNT_SET` macros.
    - Copy handshake metrics using `FD_MCNT_SET` macro.
    - Copy frame parsing error metrics using `FD_MCNT_SET` macro.
    - Copy service and receive duration histograms using `FD_MHIST_COPY` macro.
- **Output**: No return value; the function updates metrics in the `ctx` structure.



---
Made with ❤️ by [Driver](https://www.driver.ai/)