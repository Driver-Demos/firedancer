<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a client for IP echo services, handling socket connections and response parsing.

# Purpose
The code is a C implementation of an IP echo client, which is designed to manage connections to multiple servers and handle communication with them. It provides functions to initialize, join, and manage the lifecycle of an `fd_ipecho_client_t` structure, which represents the client. The client can connect to a list of servers, send requests, and parse responses. The code includes functions to align and calculate the memory footprint of the client structure, create a new client instance, and join an existing one. It also provides mechanisms to initialize connections to servers, send requests, and read responses.

The client uses non-blocking sockets and the `poll` system call to manage multiple connections simultaneously. It maintains an array of `pollfd` structures to track the state of each connection. The [`fd_ipecho_client_poll`](<#fd_ipecho_client_poll>) function is responsible for polling the connections and handling read and write events. The code also includes utility functions to close individual or all connections and parse server responses to extract specific information, such as the shred version. The implementation ensures proper alignment and error handling throughout the connection and communication processes.
# Imports and Dependencies

---
- `fd_ipecho_client.h`
- `fd_ipecho_client_private.h`
- `../../util/fd_util.h`
- `errno.h`
- `netinet/in.h`
- `string.h`
- `sys/socket.h`
- `unistd.h`


# Functions

---
### fd\_ipecho\_client\_align<!-- {{#callable:fd_ipecho_client_align}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_client.c#L12>)

Returns the alignment requirement of the `fd_ipecho_client_t` type.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls the `alignof` operator on `fd_ipecho_client_t` to determine its alignment requirement.
    - Returns the result of the `alignof` operation.
- **Output**: The alignment requirement of the `fd_ipecho_client_t` type as an `ulong`.


---
### fd\_ipecho\_client\_footprint<!-- {{#callable:fd_ipecho_client_footprint}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_client.c#L17>)

Returns the size of the `fd_ipecho_client_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calculate the size of the `fd_ipecho_client_t` structure using the `sizeof` operator.
    - Return the calculated size.
- **Output**: The function returns an `ulong` representing the size of the `fd_ipecho_client_t` structure.


---
### fd\_ipecho\_client\_new<!-- {{#callable:fd_ipecho_client_new}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_client.c#L22>)

Initializes a new `fd_ipecho_client_t` structure in shared memory with alignment and magic number checks.
- **Inputs**:
    - `shmem`: A pointer to shared memory where the `fd_ipecho_client_t` structure will be initialized.
- **Logic and Control Flow**:
    - Cast `shmem` to a `fd_ipecho_client_t` pointer named `ipe`.
    - Check if `shmem` is NULL; if true, log a warning and return NULL.
    - Check if `shmem` is aligned according to [`fd_ipecho_client_align`](<#fd_ipecho_client_align>); if not, log a warning and return NULL.
    - Use memory fence operations to ensure memory ordering before and after setting the `magic` field of `ipe`.
    - Set the `magic` field of `ipe` to `FD_IPECHO_CLIENT_MAGIC`.
    - Return the `ipe` pointer cast to a `void *`.
- **Output**: A pointer to the initialized `fd_ipecho_client_t` structure, or NULL if an error occurs.
- **Functions Called**:
    - [`fd_ipecho_client_align`](<#fd_ipecho_client_align>)


---
### fd\_ipecho\_client\_join<!-- {{#callable:fd_ipecho_client_join}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_client.c#L43>)

Validates and returns a pointer to a `fd_ipecho_client_t` structure if the input is correctly aligned and has the correct magic number.
- **Inputs**:
    - ``shipe``: A pointer to a memory location that is expected to be a `fd_ipecho_client_t` structure.
- **Logic and Control Flow**:
    - Check if `shipe` is NULL; if true, log a warning and return NULL.
    - Check if `shipe` is aligned according to `fd_ipecho_client_align()`; if not, log a warning and return NULL.
    - Cast `shipe` to a `fd_ipecho_client_t` pointer and store it in `ipe`.
    - Check if the `magic` field of `ipe` equals `FD_IPECHO_CLIENT_MAGIC`; if not, log a warning and return NULL.
    - Return the `ipe` pointer.
- **Output**: A pointer to a `fd_ipecho_client_t` structure if all checks pass, otherwise NULL.
- **Functions Called**:
    - [`fd_ipecho_client_align`](<#fd_ipecho_client_align>)


---
### fd\_ipecho\_client\_init<!-- {{#callable:fd_ipecho_client_init}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_client.c#L65>)

Initializes a client structure to connect to multiple servers using non-blocking sockets.
- **Inputs**:
    - `client`: A pointer to an `fd_ipecho_client_t` structure that will be initialized.
    - `servers`: A pointer to an array of `fd_ip4_port_t` structures representing the servers to connect to.
    - `servers_len`: The number of servers in the `servers` array.
- **Logic and Control Flow**:
    - Initialize `peer_cnt` to 0.
    - Iterate over each server in the `servers` array.
    - For each server, create a non-blocking socket using `socket()` and check for errors.
    - Set up a `sockaddr_in` structure with the server's address and port.
    - Attempt to connect to the server using `connect()`, and handle errors by closing the socket and continuing to the next server.
    - If the connection is successful or in progress, store the socket file descriptor and initialize the corresponding `pollfd` and peer data in the `client` structure.
    - Increment `peer_cnt` for each successful connection attempt.
    - Set unused `pollfd` entries to -1 for up to 16 total entries.
    - Store the total number of peers in `client->peer_cnt` and `client->remaining_peer_cnt`.
    - Record the current time in `client->start_time_nanos` using `fd_log_wallclock()`.
- **Output**: The function does not return a value; it initializes the `client` structure with connection information for the specified servers.


---
### close\_one<!-- {{#callable:close_one}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_client.c#L106>)

Closes a specific connection for a client and updates the client's state.
- **Inputs**:
    - `client`: A pointer to the `fd_ipecho_client_t` structure representing the client whose connection is to be closed.
    - `idx`: An unsigned long integer representing the index of the connection to close in the client's `pollfds` array.
- **Logic and Control Flow**:
    - Checks if closing the file descriptor at the specified index in the client's `pollfds` array fails, and logs an error if it does.
    - Sets the file descriptor at the specified index in the client's `pollfds` array to -1 to indicate it is closed.
    - Decrements the `remaining_peer_cnt` of the client to reflect the closed connection.
- **Output**: No return value; the function modifies the `client` structure in place.


---
### close\_all<!-- {{#callable:close_all}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_client.c#L114>)

Closes all active file descriptors in the `client`'s `pollfds` array.
- **Inputs**:
    - `client`: A pointer to an `fd_ipecho_client_t` structure that contains the `pollfds` array and `peer_cnt`.
- **Logic and Control Flow**:
    - Iterates over each file descriptor in the `client->pollfds` array up to `client->peer_cnt`.
    - Checks if the file descriptor is not equal to -1, indicating it is active.
    - Calls [`close_one`](<#close_one>) to close the active file descriptor and mark it as closed.
- **Output**: No return value; the function operates directly on the `client` structure to close file descriptors.
- **Functions Called**:
    - [`close_one`](<#close_one>)


---
### fd\_ipecho\_client\_parse\_response<!-- {{#callable:fd_ipecho_client_parse_response}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_client.c#L122>)

Parses a response to extract the shred version if the response is valid.
- **Inputs**:
    - ``response``: A pointer to the response data to be parsed.
    - ``response_len``: The length of the response data.
    - ``_shred_version``: A pointer to a `ushort` where the parsed shred version will be stored if the response is valid.
- **Logic and Control Flow**:
    - Check if `response_len` is less than 8; if true, return `FD_IPECHO_PARSE_ERR`.
    - Compare the first 4 bytes of `response` with "\0\0\0\0"; if they do not match, return `FD_IPECHO_PARSE_ERR`.
    - Load a 4-byte unsigned integer from `response` starting at offset 4 into `ip_variant`; if `ip_variant` is greater than 1, return `FD_IPECHO_PARSE_ERR`.
    - Set `offset` to 8; if `ip_variant` is 0, increment `offset` by 4, otherwise increment by 16.
    - Check if `response_len` is less than `offset + 3`; if true, return `FD_IPECHO_PARSE_ERR`.
    - Check if the byte at `response[offset]` is not 1; if true, return `FD_IPECHO_PARSE_ERR`.
    - Load a 2-byte unsigned integer from `response` starting at `offset + 1` into `shred_version`; if `shred_version` is 0, return `FD_IPECHO_PARSE_ERR`.
    - Store `shred_version` in `_shred_version` and return `FD_IPECHO_PARSE_OK`.
- **Output**: Returns `FD_IPECHO_PARSE_OK` if the response is valid and the shred version is successfully parsed; otherwise, returns `FD_IPECHO_PARSE_ERR`.


---
### write\_conn<!-- {{#callable:write_conn}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_client.c#L147>)

Sends a predefined request to a peer connection if writing is enabled and updates the peer's state based on the result.
- **Inputs**:
    - `client`: A pointer to an `fd_ipecho_client_t` structure representing the client containing peer connections.
    - `conn_idx`: An unsigned long integer representing the index of the connection in the client's peer array.
- **Logic and Control Flow**:
    - Retrieve the peer at the specified `conn_idx` from the client's peer array.
    - Check if the peer is in a writing state; if not, exit the function.
    - Define a request array of 21 bytes with predefined values, including a newline character at the end.
    - Attempt to send the request to the peer's file descriptor using `sendto`, starting from the last sent byte.
    - If `sendto` returns -1 and `errno` is `EAGAIN`, exit the function as no data was written.
    - If `sendto` returns -1 for any other reason, call [`close_one`](<#close_one>) to close the connection and exit the function.
    - Update the peer's `request_bytes_sent` by the number of bytes successfully written.
    - If the total bytes sent equals the size of the request, set the peer's `writing` flag to 0 and reset `response_bytes_read` to 0.
- **Output**: No direct output is returned; the function modifies the state of the peer within the client structure.
- **Functions Called**:
    - [`close_one`](<#close_one>)


---
### read\_conn<!-- {{#callable:read_conn}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_client.c#L180>)

Reads data from a connection and processes the response for a specific client.
- **Inputs**:
    - `client`: A pointer to the `fd_ipecho_client_t` structure representing the client.
    - `conn_idx`: An unsigned long integer representing the index of the connection to read from.
    - `shred_version`: A pointer to an unsigned short where the function will store the parsed shred version from the response.
- **Logic and Control Flow**:
    - Check if the peer at the given connection index is currently writing; if so, return 1.
    - Attempt to read data from the connection using `recvfrom`.
    - If `recvfrom` returns -1 and the error is `EAGAIN` or `EINTR`, return 1.
    - If `recvfrom` returns -1 for any other reason, close the connection and return 1.
    - Add the number of bytes read to `response_bytes_read` of the peer.
    - If any bytes were read, return 1.
    - Parse the response using [`fd_ipecho_client_parse_response`](<#fd_ipecho_client_parse_response>).
    - If the response is parsed successfully (`FD_IPECHO_PARSE_OK`), return 0.
    - If the response parsing fails, close the connection and return 1.
- **Output**: Returns 0 if the response is successfully parsed, otherwise returns 1.
- **Functions Called**:
    - [`close_one`](<#close_one>)
    - [`fd_ipecho_client_parse_response`](<#fd_ipecho_client_parse_response>)


---
### fd\_ipecho\_client\_poll<!-- {{#callable:fd_ipecho_client_poll}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_client.c#L212>)

Monitors and manages network connections for an IP echo client, handling read and write operations and closing connections when necessary.
- **Inputs**:
    - ``client``: A pointer to an `fd_ipecho_client_t` structure representing the IP echo client.
    - ``shred_version``: A pointer to a `ushort` where the function stores the shred version if a response is successfully parsed.
    - ``charge_busy``: A pointer to an `int` that the function sets to 1 to indicate that the client is busy processing.
- **Logic and Control Flow**:
    - Checks if there are remaining peers to process; if not, returns -1.
    - Checks if the elapsed time since `start_time_nanos` exceeds 2 seconds; if so, closes all connections and returns -1.
    - Calls `fd_syscall_poll` to poll the file descriptors for events; handles errors and sets `charge_busy` to 1 if successful.
    - Iterates over up to 16 connections, checking for valid file descriptors.
    - For each valid connection, checks for `POLLOUT` events to perform write operations using [`write_conn`](<#write_conn>).
    - Checks for `POLLIN` events to perform read operations using [`read_conn`](<#read_conn>); if a response is successfully parsed, closes all connections and returns 0.
    - Continues processing until all connections are handled or a condition to exit is met.
- **Output**: Returns 1 if processing is ongoing, 0 if a response is successfully parsed and all connections are closed, or -1 if there are no remaining peers or a timeout occurs.
- **Functions Called**:
    - [`close_all`](<#close_all>)
    - [`write_conn`](<#write_conn>)
    - [`read_conn`](<#read_conn>)


---
### fd\_ipecho\_client\_get\_pollfds<!-- {{#callable:fd_ipecho_client_get_pollfds}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_client.c#L245>)

Returns the `pollfds` array from the given `fd_ipecho_client_t` client structure.
- **Inputs**:
    - `client`: A pointer to an `fd_ipecho_client_t` structure from which the `pollfds` array is retrieved.
- **Logic and Control Flow**:
    - Accesses the `pollfds` member of the `client` structure.
    - Returns the `pollfds` array.
- **Output**: A pointer to a constant `struct pollfd` array, which is part of the `fd_ipecho_client_t` structure.



---
Made with ❤️ by [Driver](https://www.driver.ai/)