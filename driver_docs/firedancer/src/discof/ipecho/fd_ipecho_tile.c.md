<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements the ipecho tile for network communication, including client-server setup and metrics handling.

# Purpose
The code defines a module for managing an IP echo service, which includes both client and server components. It is part of a larger system that uses a tile-based architecture, as indicated by the use of `fd_topo_tile_t` and related structures. The module provides functionality for initializing and running an IP echo service, which involves setting up network connections, handling client-server communication, and managing metrics related to the service's operation. The code includes functions for aligning and calculating the memory footprint of the service context, writing metrics, polling clients, and handling server operations.

The module defines a structure `fd_ipecho_tile_ctx_t` to maintain the context of the IP echo service, including server and client pointers, network binding information, and shred versioning details. It provides initialization functions for both privileged and unprivileged contexts, which allocate necessary resources and set up the client and server components. The code also includes functions to manage file descriptors and security policies, ensuring that the service operates within defined resource limits and security constraints. The module is designed to be integrated into a larger system, as indicated by the inclusion of the `fd_stem.c` file, which suggests that the service is part of a broader framework for managing network services.
# Imports and Dependencies

---
- `fd_ipecho_client.h`
- `fd_ipecho_server.h`
- `../genesis/fd_genesi_tile.h`
- `../../disco/topo/fd_topo.h`
- `../../disco/metrics/fd_metrics.h`
- `../../ballet/lthash/fd_lthash.h`
- `netinet/in.h`
- `sys/socket.h`
- `sys/poll.h`
- `generated/fd_ipecho_tile_seccomp.h`
- `../../disco/stem/fd_stem.c`


# Global Variables

---
### fd\_tile\_ipecho
- **Type**: ``fd_topo_run_tile_t``
- **Description**: Represents a configuration structure for running a tile in the topology with specific settings for the 'ipecho' tile. It includes function pointers for resource limits, security policies, initialization routines, and execution logic.
- **Use**: Used to configure and manage the execution of the 'ipecho' tile within the topology framework.


# Data Structures

---
### fd\_ipecho\_tile\_ctx
- **Type**: ``struct``
- **Members**:
    - ``retrieving``: Indicates if the context is currently retrieving data.
    - ``server``: Pointer to a `fd_ipecho_server_t` structure representing the server.
    - ``client``: Pointer to a `fd_ipecho_client_t` structure representing the client.
    - ``bind_address``: Stores the IP address to bind the server.
    - ``bind_port``: Stores the port number to bind the server.
    - ``bootstrap_shred_version``: Holds the initial shred version for bootstrapping.
    - ``expected_shred_version``: Holds the shred version expected from the client.
    - ``genesi_in_mem``: Pointer to a `fd_wksp_t` structure for in-memory workspace.
    - ``genesi_in_chunk0``: Stores the initial chunk index in the workspace.
    - ``genesi_in_wmark``: Stores the watermark for the workspace.
- **Description**: Manages the context for an IP echo tile, including server and client configurations, network binding details, and workspace memory management. It facilitates communication between a server and client, handling shred versioning and workspace memory operations.


---
### fd\_ipecho\_tile\_ctx\_t
- **Type**: `struct`
- **Members**:
    - `retrieving`: An integer flag that indicates if the context is in the process of retrieving data.
    - `server`: A pointer to an `fd_ipecho_server_t` structure, representing the server component.
    - `client`: A pointer to an `fd_ipecho_client_t` structure, representing the client component.
    - `bind_address`: An unsigned integer representing the IP address to bind to.
    - `bind_port`: An unsigned short representing the port number to bind to.
    - `bootstrap_shred_version`: An unsigned short representing the initial shred version for bootstrapping.
    - `expected_shred_version`: An unsigned short representing the expected shred version.
    - `genesi_in_mem`: A pointer to an `fd_wksp_t` structure, representing the memory workspace for Genesis input.
    - `genesi_in_chunk0`: An unsigned long representing the initial chunk index in the Genesis input.
    - `genesi_in_wmark`: An unsigned long representing the watermark for the Genesis input.
- **Description**: Represents the context for an IP echo tile, managing both client and server components, network binding details, and shred versioning for data retrieval and processing.


# Functions

---
### scratch\_align<!-- {{#callable:scratch_align}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_tile.c#L33>)

Returns the alignment requirement of the `fd_ipecho_tile_ctx_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Uses the `alignof` operator to determine the alignment requirement of the `fd_ipecho_tile_ctx_t` structure.
    - Returns the alignment value.
- **Output**: The alignment requirement of the `fd_ipecho_tile_ctx_t` structure as an `ulong`.


---
### scratch\_footprint<!-- {{#callable:scratch_footprint}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_tile.c#L38>)

Calculates the memory footprint required for a scratch space based on the alignment and size of various components.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure, which is not used in the function.
- **Logic and Control Flow**:
    - Initialize `l` with `FD_LAYOUT_INIT` to start the layout calculation.
    - Append the alignment and size of `fd_ipecho_tile_ctx_t` to `l` using `FD_LAYOUT_APPEND`.
    - Append the alignment and footprint of the client using `fd_ipecho_client_align()` and `fd_ipecho_client_footprint()`.
    - Append the alignment and footprint of the server using `fd_ipecho_server_align()` and `fd_ipecho_server_footprint(1024UL)`.
    - Finalize the layout with `FD_LAYOUT_FINI` using `scratch_align()` and return the result.
- **Output**: Returns an `ulong` representing the total memory footprint required for the scratch space.
- **Functions Called**:
    - [`fd_ipecho_client_align`](<fd_ipecho_client.c.md#fd_ipecho_client_align>)
    - [`fd_ipecho_client_footprint`](<fd_ipecho_client.c.md#fd_ipecho_client_footprint>)
    - [`fd_ipecho_server_align`](<fd_ipecho_server.c.md#fd_ipecho_server_align>)
    - [`fd_ipecho_server_footprint`](<fd_ipecho_server.c.md#fd_ipecho_server_footprint>)
    - [`scratch_align`](<#scratch_align>)


---
### metrics\_write<!-- {{#callable:metrics_write}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_tile.c#L49>)

Updates server metrics for connection count, bytes read and written, and connections closed status.
- **Inputs**:
    - ``ctx``: A pointer to a `fd_ipecho_tile_ctx_t` structure that contains the server context.
- **Logic and Control Flow**:
    - Retrieve the server metrics using [`fd_ipecho_server_metrics`](<fd_ipecho_server.h.md#fd_ipecho_server_metrics>) with the server from `ctx`.
    - Set the `IPECHO` metric `CONNECTION_COUNT` to the value of `metrics->connection_cnt` using `FD_MGAUGE_SET`.
    - Set the `IPECHO` metric `BYTES_READ` to the value of `metrics->bytes_read` using `FD_MCNT_SET`.
    - Set the `IPECHO` metric `BYTES_WRITTEN` to the value of `metrics->bytes_written` using `FD_MCNT_SET`.
    - Set the `IPECHO` metric `CONNECTIONS_CLOSED_OK` to the value of `metrics->connections_closed_ok` using `FD_MCNT_SET`.
    - Set the `IPECHO` metric `CONNECTIONS_CLOSED_ERROR` to the value of `metrics->connections_closed_error` using `FD_MCNT_SET`.
- **Output**: No return value; the function updates metrics in place.
- **Functions Called**:
    - [`fd_ipecho_server_metrics`](<fd_ipecho_server.h.md#fd_ipecho_server_metrics>)


---
### poll\_client<!-- {{#callable:poll_client}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_tile.c#L60>)

Polls the client for a shred version and updates the context and server if successful.
- **Inputs**:
    - ``ctx``: A pointer to a `fd_ipecho_tile_ctx_t` structure that contains the context for the client and server operations.
    - ``stem``: A pointer to a `fd_stem_context_t` structure used for publishing the shred version.
    - ``charge_busy``: A pointer to an integer that indicates whether the client is busy.
- **Logic and Control Flow**:
    - Check if `ctx->client` is NULL; if so, return immediately.
    - Call [`fd_ipecho_client_poll`](<fd_ipecho_client.c.md#fd_ipecho_client_poll>) to poll the client for a shred version and store the result in `result`.
    - If `result` is 0, check if `ctx->expected_shred_version` is set and does not match `shred_version`; if so, log an error.
    - Log the retrieved shred version and update the metrics gauge with `shred_version`.
    - Publish the shred version using `fd_stem_publish` and set the server's shred version with [`fd_ipecho_server_set_shred_version`](<fd_ipecho_server.c.md#fd_ipecho_server_set_shred_version>).
    - Set `ctx->retrieving` to 0 and return.
    - If `result` is -1, log an error indicating the inability to determine the shred version.
- **Output**: No return value; the function updates the context and logs information or errors as needed.
- **Functions Called**:
    - [`fd_ipecho_client_poll`](<fd_ipecho_client.c.md#fd_ipecho_client_poll>)
    - [`fd_ipecho_server_set_shred_version`](<fd_ipecho_server.c.md#fd_ipecho_server_set_shred_version>)


---
### after\_credit<!-- {{#callable:after_credit}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_tile.c#L86>)

Determines whether to poll the client or server based on the `retrieving` status in the context.
- **Inputs**:
    - ``ctx``: A pointer to a `fd_ipecho_tile_ctx_t` structure that contains the context for the operation, including the `retrieving` status and server information.
    - ``stem``: A pointer to a `fd_stem_context_t` structure used in the [`poll_client`](<#poll_client>) function.
    - ``opt_poll_in``: An optional integer pointer, not used in the function.
    - ``charge_busy``: A pointer to an integer that indicates whether the operation is busy.
- **Logic and Control Flow**:
    - Ignore the `opt_poll_in` parameter as it is not used in the function.
    - Set `timeout` to 0 if `ctx->retrieving` is true, otherwise set it to 10.
    - If `ctx->retrieving` is true, call [`poll_client`](<#poll_client>) with `ctx`, `stem`, and `charge_busy` as arguments.
    - If `ctx->retrieving` is false, call [`fd_ipecho_server_poll`](<fd_ipecho_server.c.md#fd_ipecho_server_poll>) with `ctx->server`, `charge_busy`, and `timeout` as arguments.
- **Output**: No return value; the function operates through side effects on the context and server.
- **Functions Called**:
    - [`poll_client`](<#poll_client>)
    - [`fd_ipecho_server_poll`](<fd_ipecho_server.c.md#fd_ipecho_server_poll>)


---
### returnable\_frag<!-- {{#callable:returnable_frag}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_tile.c#L99>)

Processes a fragment to update the shred version if the signature indicates bootstrap completion.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_ipecho_tile_ctx_t` structure, which contains context information for the operation.
    - ``in_idx``: An unused input index.
    - ``seq``: An unused sequence number.
    - ``sig``: A signature value used to determine if the bootstrap process is completed.
    - ``chunk``: An index to a memory chunk used to retrieve data.
    - ``sz``: An unused size parameter.
    - ``ctl``: An unused control parameter.
    - ``tsorig``: A timestamp for the original event.
    - ``tspub``: An unused publication timestamp.
    - ``stem``: A pointer to the `fd_stem_context_t` structure, which is used for publishing updates.
- **Logic and Control Flow**:
    - Check if `sig` equals `GENESI_SIG_BOOTSTRAP_COMPLETED` to determine if the bootstrap process is completed.
    - If the bootstrap is completed, retrieve a source address from `ctx->genesi_in_mem` using `chunk`.
    - Copy a hash from the source address into a local union `hash`.
    - Calculate an XOR checksum of the hash values.
    - Byte-swap the XOR checksum and increment it if it is less than `USHORT_MAX`, otherwise set it to `USHORT_MAX`.
    - Test the XOR checksum to ensure it is valid.
    - Set the shred version metric using `FD_MGAUGE_SET`.
    - Publish the shred version using `fd_stem_publish`.
    - Update the server's shred version using [`fd_ipecho_server_set_shred_version`](<fd_ipecho_server.c.md#fd_ipecho_server_set_shred_version>).
    - Set `ctx->retrieving` to 0 to indicate the retrieval process is complete.
- **Output**: Always returns 0.
- **Functions Called**:
    - [`fd_ipecho_server_set_shred_version`](<fd_ipecho_server.c.md#fd_ipecho_server_set_shred_version>)


---
### privileged\_init<!-- {{#callable:privileged_init}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_tile.c#L139>)

Initializes the context for a tile by setting up client and server components using scratch memory.
- **Inputs**:
    - `topo`: A pointer to an `fd_topo_t` structure representing the topology.
    - `tile`: A pointer to an `fd_topo_tile_t` structure representing the tile configuration.
- **Logic and Control Flow**:
    - Obtain a scratch memory address using `fd_topo_obj_laddr` with `topo` and `tile->tile_obj_id`.
    - Initialize scratch memory allocation with `FD_SCRATCH_ALLOC_INIT`.
    - Allocate memory for `fd_ipecho_tile_ctx_t`, client, and server using `FD_SCRATCH_ALLOC_APPEND`.
    - Set `ctx->bind_address`, `ctx->bind_port`, and `ctx->expected_shred_version` from `tile->ipecho`.
    - Set `ctx->retrieving` to 1 to indicate the start of retrieval.
    - If `tile->ipecho.entrypoints_cnt` is non-zero, initialize the client using [`fd_ipecho_client_new`](<fd_ipecho_client.c.md#fd_ipecho_client_new>), [`fd_ipecho_client_join`](<fd_ipecho_client.c.md#fd_ipecho_client_join>), and [`fd_ipecho_client_init`](<fd_ipecho_client.c.md#fd_ipecho_client_init>).
    - If no entrypoints, set `ctx->client` to NULL.
    - Initialize the server using [`fd_ipecho_server_new`](<fd_ipecho_server.c.md#fd_ipecho_server_new>), [`fd_ipecho_server_join`](<fd_ipecho_server.c.md#fd_ipecho_server_join>), and [`fd_ipecho_server_init`](<fd_ipecho_server.c.md#fd_ipecho_server_init>).
    - Finalize scratch memory allocation with `FD_SCRATCH_ALLOC_FINI`.
    - Check for scratch memory overflow and log an error if it occurs.
- **Output**: No return value; initializes the context for the tile.
- **Functions Called**:
    - [`fd_ipecho_client_align`](<fd_ipecho_client.c.md#fd_ipecho_client_align>)
    - [`fd_ipecho_client_footprint`](<fd_ipecho_client.c.md#fd_ipecho_client_footprint>)
    - [`fd_ipecho_server_align`](<fd_ipecho_server.c.md#fd_ipecho_server_align>)
    - [`fd_ipecho_server_footprint`](<fd_ipecho_server.c.md#fd_ipecho_server_footprint>)
    - [`fd_ipecho_client_join`](<fd_ipecho_client.c.md#fd_ipecho_client_join>)
    - [`fd_ipecho_client_new`](<fd_ipecho_client.c.md#fd_ipecho_client_new>)
    - [`fd_ipecho_client_init`](<fd_ipecho_client.c.md#fd_ipecho_client_init>)
    - [`fd_ipecho_server_join`](<fd_ipecho_server.c.md#fd_ipecho_server_join>)
    - [`fd_ipecho_server_new`](<fd_ipecho_server.c.md#fd_ipecho_server_new>)
    - [`fd_ipecho_server_init`](<fd_ipecho_server.c.md#fd_ipecho_server_init>)
    - [`scratch_footprint`](<#scratch_footprint>)


---
### unprivileged\_init<!-- {{#callable:unprivileged_init}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_tile.c#L172>)

Initializes the unprivileged context for a tile in the topology.
- **Inputs**:
    - `topo`: A pointer to the `fd_topo_t` structure representing the topology.
    - `tile`: A pointer to the `fd_topo_tile_t` structure representing the tile to initialize.
- **Logic and Control Flow**:
    - Retrieve the local address of the tile object using `fd_topo_obj_laddr` and store it in `scratch`.
    - Initialize the scratch allocator with `FD_SCRATCH_ALLOC_INIT` using `scratch`.
    - Allocate memory for `fd_ipecho_tile_ctx_t` using `FD_SCRATCH_ALLOC_APPEND` and store the pointer in `ctx`.
    - Set the `IPECHO` metric for `SHRED_VERSION` using `FD_MGAUGE_SET` with the expected shred version from the tile.
    - Retrieve the workspace memory for the input link of the tile and store it in `ctx->genesi_in_mem`.
    - Calculate and store the compacted chunk0 and watermark for the input link's dcache in `ctx->genesi_in_chunk0` and `ctx->genesi_in_wmark`, respectively.
- **Output**: No return value; the function initializes the context for the tile.


---
### rlimit\_file\_cnt<!-- {{#callable:rlimit_file_cnt}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_tile.c#L187>)

Calculates the total number of file descriptors needed for logging, client entrypoints, and server connections.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, which is not used in this function.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure that contains information about the number of client entrypoints.
- **Logic and Control Flow**:
    - Initialize the count with 1 for `stderr` and 1 for the `logfile`.
    - Add the number of client entrypoints from `tile->ipecho.entrypoints_cnt`.
    - Add 1 for the server's socket.
    - Add 1024 for the server's connections.
- **Output**: Returns an `ulong` representing the total number of file descriptors required.


---
### populate\_allowed\_seccomp<!-- {{#callable:populate_allowed_seccomp}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_tile.c#L201>)

Populates a seccomp filter policy for a tile and returns the instruction count.
- **Inputs**:
    - `topo`: A pointer to a `fd_topo_t` structure, which is not used in this function.
    - `tile`: A pointer to a `fd_topo_tile_t` structure, which is not used in this function.
    - `out_cnt`: An unsigned long integer representing the count of output filters.
    - `out`: A pointer to a `struct sock_filter` array where the seccomp filter policy will be populated.
- **Logic and Control Flow**:
    - Ignores the `topo` and `tile` inputs by casting them to void.
    - Calls [`populate_sock_filter_policy_fd_ipecho_tile`](<generated/fd_ipecho_tile_seccomp.h.md#populate_sock_filter_policy_fd_ipecho_tile>) with `out_cnt`, `out`, and the file descriptor of the log file to populate the seccomp filter policy.
    - Returns the value of `sock_filter_policy_fd_ipecho_tile_instr_cnt`, which represents the instruction count of the seccomp filter policy.
- **Output**: Returns an unsigned long integer representing the instruction count of the seccomp filter policy.
- **Functions Called**:
    - [`populate_sock_filter_policy_fd_ipecho_tile`](<generated/fd_ipecho_tile_seccomp.h.md#populate_sock_filter_policy_fd_ipecho_tile>)


---
### populate\_allowed\_fds<!-- {{#callable:populate_allowed_fds}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_tile.c#L213>)

Populates an array with file descriptors related to logging and network connections for a given tile.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure representing the topology.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure representing the tile configuration.
    - ``out_fds_cnt``: The maximum number of file descriptors that can be stored in the `out_fds` array.
    - ``out_fds``: An array where the function will store the allowed file descriptors.
- **Logic and Control Flow**:
    - Allocate scratch memory for the tile context using `fd_topo_obj_laddr` and `FD_SCRATCH_ALLOC_INIT`.
    - Append a `fd_ipecho_tile_ctx_t` structure to the scratch memory using `FD_SCRATCH_ALLOC_APPEND`.
    - Check if `out_fds_cnt` is less than the required number of file descriptors (3 plus the number of entrypoints). If so, log an error using `FD_LOG_ERR`.
    - Initialize `out_cnt` to 0 and set `out_fds[0]` to 2, which represents `stderr`.
    - If the log file descriptor is valid, add it to `out_fds` and increment `out_cnt`.
    - Iterate over the entrypoints in `tile->ipecho.entrypoints_cnt`, retrieve each file descriptor using [`fd_ipecho_client_get_pollfds`](<fd_ipecho_client.c.md#fd_ipecho_client_get_pollfds>), and add valid descriptors to `out_fds`.
    - Add the server's socket file descriptor to `out_fds` using [`fd_ipecho_server_sockfd`](<fd_ipecho_server.c.md#fd_ipecho_server_sockfd>).
    - Return the total count of file descriptors added to `out_fds`.
- **Output**: Returns the number of file descriptors added to the `out_fds` array.
- **Functions Called**:
    - [`fd_ipecho_client_get_pollfds`](<fd_ipecho_client.c.md#fd_ipecho_client_get_pollfds>)
    - [`fd_ipecho_server_sockfd`](<fd_ipecho_server.c.md#fd_ipecho_server_sockfd>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)