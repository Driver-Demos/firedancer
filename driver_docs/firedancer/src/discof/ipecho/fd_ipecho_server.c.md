<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

An IPv4 echo server implementation with connection management and metrics tracking.

# Purpose
The code defines a server implementation for an IP echo service, which listens for incoming TCP connections and echoes back the IP address of the client. The main components include the `fd_ipecho_server` structure, which manages the server's state, including the socket file descriptor, connection pool, and metrics. The `fd_ipecho_server_connection` structure represents individual client connections, tracking the state of each connection, the client's IP address, and the data being read or written.

The server is initialized and managed through several functions. [`fd_ipecho_server_new`](<#fd_ipecho_server_new>) allocates and initializes the server in shared memory, setting up the connection pool and poll file descriptors. [`fd_ipecho_server_init`](<#fd_ipecho_server_init>) configures the server's socket for listening on a specified IP address and port. The server uses non-blocking I/O and the `poll` system call to manage multiple connections simultaneously. The [`fd_ipecho_server_poll`](<#fd_ipecho_server_poll>) function handles incoming connections and data, using helper functions like [`accept_conns`](<#accept_conns>), [`read_conn`](<#read_conn>), and [`write_conn`](<#write_conn>) to process client requests and send responses. The server also includes error handling for network-related issues and maintains metrics on connection activity.
# Imports and Dependencies

---
- `fd_ipecho_server.h`
- `../../util/fd_util.h`
- `../../util/net/fd_ip4.h`
- `errno.h`
- `unistd.h`
- `sys/poll.h`
- `sys/socket.h`
- `netinet/in.h`
- `../../util/tmpl/fd_pool.c`


# Data Structures

---
### fd\_ipecho\_server\_connection
- **Type**: ``struct``
- **Members**:
    - ``state``: Stores the current state of the connection, such as reading or writing.
    - ``ipv4``: Holds the IPv4 address of the connection.
    - ``parent``: Used as an index or reference to a parent connection or pool.
    - ``request_bytes_read``: Tracks the number of bytes read from the request.
    - ``request_bytes``: Buffers the request data, with a maximum size of 22 bytes.
    - ``response_bytes_written``: Tracks the number of bytes written to the response.
    - ``response_bytes``: Buffers the response data, with a maximum size of 27 bytes.
- **Description**: Manages the state and data of a single connection in an IP echo server, including tracking the connection's state, IP address, and the bytes read from requests and written to responses.


---
### fd\_ipecho\_server\_connection\_t
- **Type**: ``struct``
- **Members**:
    - `state`: Indicates the current state of the connection, either reading or writing.
    - `ipv4`: Stores the IPv4 address of the connection.
    - `parent`: Used as a link to the parent in a pool structure.
    - `request_bytes_read`: Tracks the number of bytes read from the request.
    - `request_bytes`: Holds the bytes of the request, with a maximum size of 22 bytes.
    - `response_bytes_written`: Tracks the number of bytes written to the response.
    - `response_bytes`: Holds the bytes of the response, with a maximum size of 27 bytes.
- **Description**: Manages the state and data of a single connection in an IP echo server, including the connection's state, IP address, and buffers for request and response data.


---
### fd\_ipecho\_server
- **Type**: ``struct``
- **Members**:
    - `sockfd`: Socket file descriptor for the server.
    - `shred_version`: Version of the shred protocol used by the server.
    - `evict_idx`: Index for evicting connections when the pool is full.
    - `max_connection_cnt`: Maximum number of connections the server can handle.
    - `pool`: Pointer to a pool of server connections.
    - `pollfds`: Pointer to an array of `pollfd` structures for polling connections.
    - `metrics`: Array of server metrics for monitoring performance.
    - `magic`: Magic number for verifying the integrity of the server structure.
- **Description**: Manages an IP echo server, handling socket connections, maintaining a pool of connections, and tracking server metrics. It uses a socket file descriptor to listen for incoming connections and employs a connection pool to manage active connections. The server can handle a specified maximum number of connections and uses polling to monitor socket events. The `shred_version` field indicates the protocol version, while the `magic` field ensures the structure's integrity. Metrics are collected to monitor server performance.


# Functions

---
### fd\_ipecho\_server\_align<!-- {{#callable:fd_ipecho_server_align}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_server.c#L62>)

Returns the alignment requirement for the `fd_ipecho_server` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - The function does not take any input parameters.
    - It directly returns the constant value `128UL`.
- **Output**: The function returns an unsigned long integer value of `128UL`, representing the alignment requirement.


---
### fd\_ipecho\_server\_footprint<!-- {{#callable:fd_ipecho_server_footprint}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_server.c#L67>)

Calculates the memory footprint required for an IP echo server based on the maximum number of connections.
- **Inputs**:
    - `max_connection_cnt`: The maximum number of connections the server can handle.
- **Logic and Control Flow**:
    - Initialize the layout variable `l` with `FD_LAYOUT_INIT`.
    - Append the alignment and size of `fd_ipecho_server_t` to `l` using `FD_LAYOUT_APPEND`.
    - Append the alignment and footprint of the connection pool to `l` using `FD_LAYOUT_APPEND`, calculated with `conn_pool_align()` and `conn_pool_footprint(max_connection_cnt)`.
    - Append the alignment and size of the `pollfd` array to `l` using `FD_LAYOUT_APPEND`, calculated as `(1UL+max_connection_cnt)*sizeof(struct pollfd)`.
    - Finalize the layout with `FD_LAYOUT_FINI` and return the result.
- **Output**: Returns the total memory footprint in bytes as an unsigned long integer.
- **Functions Called**:
    - [`fd_ipecho_server_align`](<#fd_ipecho_server_align>)


---
### fd\_ipecho\_server\_new<!-- {{#callable:fd_ipecho_server_new}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_server.c#L76>)

Initializes a new IP echo server instance in shared memory with a specified maximum number of connections.
- **Inputs**:
    - ``shmem``: A pointer to the shared memory where the server instance will be initialized.
    - ``max_connection_cnt``: The maximum number of connections that the server can handle.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL and log a warning if true, then return NULL.
    - Check if `shmem` is aligned according to `fd_ipecho_server_align()` and log a warning if not, then return NULL.
    - Initialize scratch memory allocation with `FD_SCRATCH_ALLOC_INIT`.
    - Allocate memory for the server structure, connection pool, and poll file descriptors using `FD_SCRATCH_ALLOC_APPEND`.
    - Join the connection pool using `conn_pool_join` and verify the pool is valid with `FD_TEST`.
    - Initialize each poll file descriptor in the server's `pollfds` array to have a file descriptor of -1 and set events to `POLLIN | POLLOUT`.
    - Set the server's `evict_idx` to 0 and `max_connection_cnt` to the provided maximum connection count.
    - Zero out the server's metrics structure using `memset`.
    - Set the server's `magic` field to `FD_IPECHO_SERVER_MAGIC` using memory fences to ensure proper ordering.
    - Return the pointer to the initialized server structure.
- **Output**: A pointer to the newly created `fd_ipecho_server_t` structure, or NULL if initialization fails.
- **Functions Called**:
    - [`fd_ipecho_server_align`](<#fd_ipecho_server_align>)


---
### fd\_ipecho\_server\_join<!-- {{#callable:fd_ipecho_server_join}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_server.c#L114>)

Validates and returns a pointer to a `fd_ipecho_server_t` structure if the input is correctly aligned and initialized.
- **Inputs**:
    - ``shipe``: A pointer to a memory location that is expected to contain a `fd_ipecho_server_t` structure.
- **Logic and Control Flow**:
    - Check if `shipe` is `NULL`; if so, log a warning and return `NULL`.
    - Verify if `shipe` is aligned according to `fd_ipecho_server_align()`; if not, log a warning and return `NULL`.
    - Cast `shipe` to a `fd_ipecho_server_t` pointer and store it in `server`.
    - Check if `server->magic` equals `FD_IPECHO_SERVER_MAGIC`; if not, log a warning and return `NULL`.
    - Return the `server` pointer.
- **Output**: A pointer to a `fd_ipecho_server_t` structure if successful, otherwise `NULL`.
- **Functions Called**:
    - [`fd_ipecho_server_align`](<#fd_ipecho_server_align>)


---
### fd\_ipecho\_server\_init<!-- {{#callable:fd_ipecho_server_init}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_server.c#L136>)

Initializes a TCP server socket for an IP echo server with specified address, port, and shred version.
- **Inputs**:
    - `server`: A pointer to an `fd_ipecho_server_t` structure that will be initialized.
    - `address`: The IPv4 address to bind the server socket to, in network byte order.
    - `port`: The port number to bind the server socket to, in host byte order.
    - `shred_version`: The version of the shred protocol to use; if 0, it indicates the version is not set.
- **Logic and Control Flow**:
    - Set the `shred_version` of the server to the provided `shred_version`.
    - Create a non-blocking TCP socket using `socket()` and store the file descriptor in `server->sockfd`.
    - If socket creation fails, log an error and terminate the process.
    - Set the socket option `SO_REUSEADDR` to allow reuse of local addresses.
    - If setting the socket option fails, log an error and terminate the process.
    - Initialize a `sockaddr_in` structure with the provided `address` and `port`, converting the port to network byte order using `fd_ushort_bswap()`.
    - Bind the socket to the specified address and port using `bind()`.
    - If binding fails, log an error with details and terminate the process.
    - Set the socket to listen for incoming connections with a backlog equal to `server->max_connection_cnt`.
    - If listening fails, log an error and terminate the process.
    - Store the server socket file descriptor in the last element of the `pollfds` array with the `POLLIN` event flag set.
- **Output**: No return value; initializes the server structure and prepares the server socket for accepting connections.


---
### fd\_ipecho\_server\_set\_shred\_version<!-- {{#callable:fd_ipecho_server_set_shred_version}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_server.c#L169>)

Sets the `shred_version` field of a `fd_ipecho_server_t` structure.
- **Inputs**:
    - `server`: A pointer to a `fd_ipecho_server_t` structure whose `shred_version` field will be set.
    - `shred_version`: A `ushort` value representing the shred version to set in the server structure.
- **Logic and Control Flow**:
    - Assigns the `shred_version` parameter to the `shred_version` field of the `server` structure.
- **Output**: No return value.


---
### is\_expected\_network\_error<!-- {{#callable:is_expected_network_error}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_server.c#L175>)

Checks if a given error code corresponds to an expected network error.
- **Inputs**:
    - `err`: An integer representing the error code to check.
- **Logic and Control Flow**:
    - Compares the input error code `err` against a predefined list of network-related error codes.
    - Returns true if `err` matches any of the specified error codes, indicating it is an expected network error.
    - Returns false if `err` does not match any of the specified error codes.
- **Output**: Returns an integer value: 1 if the error code is an expected network error, 0 otherwise.


---
### close\_conn<!-- {{#callable:close_conn}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_server.c#L193>)

Closes a connection in the server, updates metrics, and releases the connection pool element.
- **Inputs**:
    - `server`: A pointer to the `fd_ipecho_server_t` structure representing the server.
    - `conn_idx`: The index of the connection to close in the server's `pollfds` array.
    - `reason`: An integer indicating the reason for closing the connection, although it is not used directly in the function logic.
- **Logic and Control Flow**:
    - Check if the file descriptor at `conn_idx` in `server->pollfds` is not -1 using `FD_TEST` macro.
    - Attempt to close the file descriptor at `conn_idx` in `server->pollfds`. If closing fails, log an error using `FD_LOG_ERR`.
    - Set the file descriptor at `conn_idx` in `server->pollfds` to -1 to mark it as closed.
    - Release the connection pool element at `conn_idx` using `conn_pool_ele_release`.
    - Check if the server's `connection_cnt` metric is non-zero using `FD_TEST` macro.
    - Decrement the server's `connection_cnt` metric by 1.
    - If `reason` equals `CLOSE_OK`, increment the `connections_closed_ok` metric; otherwise, increment the `connections_closed_error` metric.
- **Output**: No return value.


---
### accept\_conns<!-- {{#callable:accept_conns}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_server.c#L210>)

Accepts incoming connections on a server socket and manages connection pool resources.
- **Inputs**:
    - ``server``: A pointer to a `fd_ipecho_server_t` structure representing the server instance.
- **Logic and Control Flow**:
    - Enter an infinite loop to continuously accept connections.
    - Initialize a `sockaddr_in` structure to store client address information.
    - Call `accept4` to accept a new connection on the server's listening socket.
    - If `accept4` returns -1, check the error code: if `EAGAIN`, break the loop; if an expected network error, continue; otherwise, log an error and exit.
    - If the connection pool is full, close the least recently used connection and update the eviction index.
    - Acquire a new connection ID from the connection pool.
    - Store the new connection's file descriptor and address in the server's data structures.
    - Initialize the connection's state to `STATE_READING` and reset byte counters.
    - Increment the server's connection count metric.
- **Output**: No return value; the function modifies the server's connection pool and metrics in place.
- **Functions Called**:
    - [`is_expected_network_error`](<#is_expected_network_error>)
    - [`close_conn`](<#close_conn>)


---
### read\_conn<!-- {{#callable:read_conn}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_server.c#L239>)

Handles reading data from a connection in a server, processes the request, and prepares a response.
- **Inputs**:
    - `server`: A pointer to the `fd_ipecho_server_t` structure representing the server.
    - `conn_idx`: The index of the connection in the server's connection pool.
- **Logic and Control Flow**:
    - Retrieve the connection from the server's connection pool using `conn_idx`.
    - Check if the connection state is not `STATE_READING`; if so, close the connection with `CLOSE_EXPECTED_EOF` and return.
    - Attempt to read data from the connection's file descriptor into the connection's request buffer.
    - If no data is available (`EAGAIN`), return without action.
    - If a network error occurs, close the connection with `CLOSE_PEER_RESET` and return.
    - If a read error occurs, log the error and abort.
    - If the read size is zero and the request is not 21 bytes, close the connection with `CLOSE_BAD_LENGTH` and return.
    - Update the server's metrics and the connection's read byte count with the size of the data read.
    - If the request size exceeds the buffer, close the connection with `CLOSE_LARGE_REQUEST` and return.
    - Check if the request header is valid; if not, close the connection with `CLOSE_BAD_HEADER` and return.
    - Check if the request trailer is valid; if not, close the connection with `CLOSE_BAD_TRAILER` and return.
    - Prepare a response buffer with predefined data, including the connection's IP address and server's shred version.
    - Change the connection state to `STATE_WRITING` and reset the response bytes written count.
    - Copy the prepared response into the connection's response buffer.
- **Output**: No direct output; modifies the connection state and buffers within the server structure.
- **Functions Called**:
    - [`close_conn`](<#close_conn>)
    - [`is_expected_network_error`](<#is_expected_network_error>)


---
### write\_conn<!-- {{#callable:write_conn}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_server.c#L298>)

Handles writing data to a connection in a server, ensuring data is sent and connection is closed appropriately.
- **Inputs**:
    - `server`: A pointer to the `fd_ipecho_server_t` structure representing the server.
    - `conn_idx`: The index of the connection in the server's connection pool.
- **Logic and Control Flow**:
    - Retrieve the connection from the server's connection pool using `conn_idx`.
    - Check if the connection state is `STATE_READING`; if so, return immediately as no writing is needed.
    - Attempt to send data from the connection's `response_bytes` buffer using `sendto`.
    - If `sendto` returns -1 and `errno` is `EAGAIN`, return as no data was written.
    - If `sendto` returns -1 and the error is an expected network error, close the connection with `CLOSE_PEER_RESET`.
    - If `sendto` returns -1 for any other reason, log an error and abort.
    - Update the server's metrics for bytes written and the connection's `response_bytes_written`.
    - If all response bytes have been written, close the connection with `CLOSE_OK`.
- **Output**: No return value; the function operates on the server and connection data structures directly.
- **Functions Called**:
    - [`is_expected_network_error`](<#is_expected_network_error>)
    - [`close_conn`](<#close_conn>)


---
### fd\_ipecho\_server\_poll<!-- {{#callable:fd_ipecho_server_poll}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_server.c#L320>)

Monitors and manages incoming and outgoing connections for an IP echo server, handling read and write operations based on the server's state and connection events.
- **Inputs**:
    - ``server``: A pointer to an `fd_ipecho_server_t` structure representing the server instance to poll for connections.
    - ``charge_busy``: A pointer to an integer that will be set to 1 if the server is busy processing connections.
    - ``timeout_ms``: An integer specifying the timeout in milliseconds for the polling operation.
- **Logic and Control Flow**:
    - Check if the `shred_version` of the server is 0; if so, return immediately as the server is not ready to accept connections.
    - Call `fd_syscall_poll` to poll the server's file descriptors for events, using the specified `timeout_ms`.
    - If no file descriptors are ready (`nfds` is 0) or the poll was interrupted (`errno` is `EINTR`), return immediately.
    - If `fd_syscall_poll` returns an error, log the error and terminate the process.
    - Set `*charge_busy` to 1 to indicate the server is busy.
    - Iterate over each file descriptor in the server's `pollfds` array.
    - If a file descriptor is -1, skip to the next iteration.
    - If the current index is equal to `max_connection_cnt`, call [`accept_conns`](<#accept_conns>) to accept new connections.
    - Otherwise, check if the `POLLIN` event is set for the current file descriptor and call [`read_conn`](<#read_conn>) if it is.
    - If the file descriptor is still valid, check if the `POLLOUT` event is set and call [`write_conn`](<#write_conn>) if it is.
- **Output**: No return value; the function operates on the server and connection states directly.
- **Functions Called**:
    - [`accept_conns`](<#accept_conns>)
    - [`read_conn`](<#read_conn>)
    - [`write_conn`](<#write_conn>)


---
### fd\_ipecho\_server\_metrics<!-- {{#callable:fd_ipecho_server_metrics}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_server.c#L349>)

Returns a pointer to the metrics of the specified IP echo server.
- **Inputs**:
    - `server`: A pointer to an `fd_ipecho_server_t` structure representing the IP echo server.
- **Logic and Control Flow**:
    - Accesses the `metrics` field of the `fd_ipecho_server_t` structure pointed to by `server`.
    - Returns the value of the `metrics` field, which is a pointer to an `fd_ipecho_server_metrics_t` structure.
- **Output**: A pointer to an `fd_ipecho_server_metrics_t` structure containing the server's metrics.


---
### fd\_ipecho\_server\_sockfd<!-- {{#callable:fd_ipecho_server_sockfd}} -->
[View Source →](<../../../../../src/discof/ipecho/fd_ipecho_server.c#L354>)

Returns the socket file descriptor from the `fd_ipecho_server_t` structure.
- **Inputs**:
    - `server`: A pointer to an `fd_ipecho_server_t` structure, which contains the server's state and configuration.
- **Logic and Control Flow**:
    - Accesses the `sockfd` member of the `fd_ipecho_server_t` structure pointed to by `server`.
    - Returns the value of `server->sockfd`.
- **Output**: The socket file descriptor (`int`) associated with the server.



---
Made with ❤️ by [Driver](https://www.driver.ai/)