<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a bank tile for processing transactions, including functions for transaction handling, hashing, and metrics management.

# Purpose
The code is a C source file that defines a module for handling banking operations within a distributed system. It is part of a larger software architecture, as indicated by the numerous included headers from various directories. The primary focus of this module is to manage transactions, including their execution, validation, and integration into a distributed ledger or blockchain-like system. The module defines a structure `fd_bank_ctx_t` that holds the context for banking operations, including transaction processing, memory management, and metrics tracking.

The module includes several functions that handle different stages of transaction processing. These functions include [`before_frag`](<#before_frag>), [`during_frag`](<#during_frag>), and [`after_frag`](<#after_frag>), which manage the lifecycle of transaction fragments. The [`handle_microblock`](<#handle_microblock>) and [`handle_bundle`](<#handle_bundle>) functions process transactions either individually or in bundles, ensuring they are executed correctly and their results are recorded. The module also includes functions for initializing the banking context, managing memory allocations, and setting up security policies. The `fd_tile_bank` structure at the end of the file defines the entry points and configuration for running this module as part of a larger system, indicating that it is designed to be integrated into a distributed execution environment.
# Imports and Dependencies

---
- `fd_bank_err.h`
- `../../disco/tiles.h`
- `generated/fd_bank_tile_seccomp.h`
- `../../disco/pack/fd_pack.h`
- `../../disco/pack/fd_pack_cost.h`
- `../../ballet/blake3/fd_blake3.h`
- `../../ballet/bmtree/fd_bmtree.h`
- `../../disco/metrics/fd_metrics.h`
- `../../util/pod/fd_pod_format.h`
- `../../disco/pack/fd_pack_rebate_sum.h`
- `../../disco/metrics/generated/fd_metrics_bank.h`
- `../../disco/metrics/generated/fd_metrics_enums.h`
- `../../flamenco/runtime/fd_runtime.h`
- `../../flamenco/runtime/fd_bank.h`
- `../../disco/stem/fd_stem.c`


# Global Variables

---
### fd\_tile\_bank
- **Type**: ``fd_topo_run_tile_t``
- **Description**: Defines a `fd_topo_run_tile_t` structure named `fd_tile_bank` with various function pointers and properties for managing a bank tile in a distributed system. It includes function pointers for security policy population, file descriptor population, scratch memory alignment, scratch memory footprint calculation, unprivileged initialization, and execution.
- **Use**: Used to configure and manage the execution of a bank tile in a distributed system.


# Data Structures

---
### fd\_bank\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``kind_id``: Stores the unique identifier for the bank kind.
    - ``blake3``: Pointer to a `fd_blake3_t` structure for Blake3 hashing.
    - ``bmtree``: Pointer to a binary Merkle tree structure.
    - ``_bank_idx``: Stores the index of the bank.
    - ``_pack_idx``: Stores the index of the pack.
    - ``_txn_idx``: Stores the index of the transaction.
    - ``_is_bundle``: Indicates if the context is part of a bundle.
    - ``busy_fseq``: Pointer to a sequence of busy flags.
    - ``pack_in_mem``: Pointer to the workspace for input packing memory.
    - ``pack_in_chunk0``: Stores the initial chunk index for input packing.
    - ``pack_in_wmark``: Stores the watermark for input packing.
    - ``out_mem``: Pointer to the workspace for output memory.
    - ``out_chunk0``: Stores the initial chunk index for output.
    - ``out_wmark``: Stores the watermark for output.
    - ``out_chunk``: Stores the current chunk index for output.
    - ``rebate_mem``: Pointer to the workspace for rebate memory.
    - ``rebate_chunk0``: Stores the initial chunk index for rebates.
    - ``rebate_wmark``: Stores the watermark for rebates.
    - ``rebate_chunk``: Stores the current chunk index for rebates.
    - ``rebates_for_slot``: Stores the number of rebates for the current slot.
    - ``rebater``: Array of `fd_pack_rebate_sum_t` for rebate calculations.
    - ``banks``: Pointer to a `fd_banks_t` structure for bank management.
    - ``exec_spad``: Pointer to a scratchpad for execution context.
    - ``funk``: Array of `fd_funk_t` for function management.
    - ``progcache``: Array of `fd_progcache_t` for program cache management.
    - ``txn_ctx``: Array of `fd_exec_txn_ctx_t` for transaction execution context.
    - ``metrics``: Structure containing transaction result metrics.
- **Description**: Manages the context for a bank operation, including transaction processing, memory management, and metrics tracking. It contains various pointers to memory workspaces and structures for handling transactions, rebates, and execution contexts. The structure also includes fields for tracking indices and states related to banking operations, such as transaction indices and bundle status. Additionally, it maintains metrics for transaction results and provides facilities for hashing and Merkle tree operations.


# Functions

---
### scratch\_align<!-- {{#callable:scratch_align}} -->
[View Source →](<../../../../../src/discof/bank/fd_bank_tile.c#L59>)

Returns a constant alignment value of 128.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the constant value `128UL`.
- **Output**: A constant unsigned long integer value `128UL`.


---
### scratch\_footprint<!-- {{#callable:scratch_footprint}} -->
[View Source →](<../../../../../src/discof/bank/fd_bank_tile.c#L64>)

Calculates the memory footprint required for various components in a tile's scratch space.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure representing the tile for which the scratch footprint is calculated.
- **Logic and Control Flow**:
    - Initialize `l` with `FD_LAYOUT_INIT`.
    - Append the size and alignment of `fd_bank_ctx_t` to `l` using `FD_LAYOUT_APPEND`.
    - Append the size and alignment of `FD_BLAKE3_FOOTPRINT` to `l` using `FD_LAYOUT_APPEND`.
    - Append the size and alignment of `FD_BMTREE_COMMIT_FOOTPRINT(0)` to `l` using `FD_LAYOUT_APPEND`.
    - Append the size and alignment of `FD_SPAD_FOOTPRINT` with a default footprint to `l` using `FD_LAYOUT_APPEND`.
    - Append the size and alignment of `fd_txncache_footprint` based on `tile->bank.max_live_slots` to `l` using `FD_LAYOUT_APPEND`.
    - Append the size and alignment of `FD_PROGCACHE_SCRATCH_FOOTPRINT` to `l` using `FD_LAYOUT_APPEND`.
    - Finalize the layout with `FD_LAYOUT_FINI` and return the result.
- **Output**: Returns an `ulong` representing the total memory footprint required for the tile's scratch space.
- **Functions Called**:
    - [`scratch_align`](<#scratch_align>)


---
### metrics\_write<!-- {{#callable:metrics_write}} -->
[View Source →](<../../../../../src/discof/bank/fd_bank_tile.c#L77>)

Copies transaction result metrics from the `ctx` structure to the `BANKF` metrics enumeration.
- **Inputs**:
    - `ctx`: A pointer to an `fd_bank_ctx_t` structure containing transaction result metrics to be copied.
- **Logic and Control Flow**:
    - Calls the macro `FD_MCNT_ENUM_COPY` with `BANKF`, `TRANSACTION_RESULT`, and `ctx->metrics.txn_result` as arguments.
    - The macro copies the transaction result metrics from `ctx->metrics.txn_result` to the `BANKF` metrics enumeration.
- **Output**: No return value; the function operates by side effect on the `ctx` structure.


---
### before\_frag<!-- {{#callable:before_frag}} -->
[View Source →](<../../../../../src/discof/bank/fd_bank_tile.c#L82>)

Checks if a given signature corresponds to a microblock and matches the context's bank kind ID.
- **Inputs**:
    - ``ctx``: A pointer to an `fd_bank_ctx_t` structure that contains the context, including the bank kind ID.
    - ``in_idx``: An unused input parameter, typically representing an index.
    - ``seq``: An unused input parameter, typically representing a sequence number.
    - ``sig``: An unsigned long integer representing the signature to be checked.
- **Logic and Control Flow**:
    - Ignore `in_idx` and `seq` as they are not used in the function logic.
    - Check if the packet type of `sig` is not `POH_PKT_TYPE_MICROBLOCK` using `fd_disco_poh_sig_pkt_type`; if true, return 1.
    - Retrieve the target bank kind ID from `sig` using `fd_disco_poh_sig_bank_tile`.
    - Check if the target bank kind ID does not match `ctx->kind_id`; if true, return 1.
    - If both checks pass, return 0.
- **Output**: Returns 0 if the signature is a microblock and matches the context's bank kind ID; otherwise, returns 1.


---
### during\_frag<!-- {{#callable:during_frag}} -->
[View Source →](<../../../../../src/discof/bank/fd_bank_tile.c#L99>)

Copies data from a source chunk to a destination chunk and updates context indices based on a trailer structure.
- **Inputs**:
    - `ctx`: A pointer to `fd_bank_ctx_t` structure containing context information for the operation.
    - `in_idx`: An unused parameter of type `ulong`.
    - `seq`: An unused parameter of type `ulong`.
    - `sig`: An unused parameter of type `ulong`.
    - `chunk`: A `ulong` representing the source chunk index in the input memory.
    - `sz`: A `ulong` representing the size of the data to be copied.
    - `ctl`: An unused parameter of type `ulong`.
- **Logic and Control Flow**:
    - Convert the source chunk index to a memory address using `fd_chunk_to_laddr` and store it in `src`.
    - Convert the destination chunk index to a memory address using `fd_chunk_to_laddr` and store it in `dst`.
    - Check if the `chunk` is within the valid range and if `sz` is not greater than `USHORT_MAX`; log an error if the check fails.
    - Copy data from `src` to `dst`, excluding the size of `fd_microblock_bank_trailer_t`.
    - Retrieve the trailer from the end of the source data and update the context indices (`_bank_idx`, `_pack_idx`, `_txn_idx`, `_is_bundle`) with values from the trailer.
- **Output**: No return value; the function updates the context structure `ctx`.


---
### hash\_transactions<!-- {{#callable:hash_transactions}} -->
[View Source →](<../../../../../src/discof/bank/fd_bank_tile.c#L122>)

Computes a Merkle tree hash of successful transactions and stores the root hash in the provided mixin buffer.
- **Inputs**:
    - `mem`: A pointer to memory used for initializing the Merkle tree commit structure.
    - `txns`: An array of transaction pointers to be processed.
    - `txn_cnt`: The number of transactions in the `txns` array.
    - `mixin`: A buffer where the resulting root hash of the Merkle tree will be stored.
- **Logic and Control Flow**:
    - Initialize a Merkle tree commit structure using the provided memory.
    - Iterate over each transaction in the `txns` array.
    - For each transaction, check if it has the `FD_TXN_P_FLAGS_EXECUTE_SUCCESS` flag set; if not, skip it.
    - For each signature in a successful transaction, compute a hash of the signature and append it to the Merkle tree.
    - Finalize the Merkle tree to obtain the root hash.
    - Copy the root hash into the `mixin` buffer.
- **Output**: The function does not return a value but modifies the `mixin` buffer to contain the root hash of the Merkle tree.


---
### handle\_microblock<!-- {{#callable:handle_microblock}} -->
[View Source →](<../../../../../src/discof/bank/fd_bank_tile.c#L143>)

Processes a microblock by executing transactions, updating metrics, and publishing results.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_bank_ctx_t` structure, which contains the context for the bank operations.
    - ``seq``: An unsigned long integer representing the sequence number of the microblock.
    - ``sig``: An unsigned long integer representing the signature of the microblock.
    - ``sz``: An unsigned long integer representing the size of the microblock.
    - ``begin_tspub``: An unsigned long integer representing the timestamp when the microblock processing began.
    - ``stem``: A pointer to the `fd_stem_context_t` structure, which is used for publishing the results.
- **Logic and Control Flow**:
    - Convert the output memory chunk to a local address using `fd_chunk_to_laddr`.
    - Calculate the slot and transaction count from the signature and size, respectively.
    - Query the bank using `fd_banks_bank_query` and verify the bank slot matches the calculated slot.
    - Iterate over each transaction in the microblock.
    - For each transaction, prepare and execute it using `fd_runtime_prepare_and_execute_txn`.
    - If the transaction fails sanitation, add it to the rebate sum and update metrics, then continue to the next transaction.
    - If the transaction executes successfully, update its flags and metrics.
    - Finalize the transaction using `fd_runtime_finalize_txn` and check for errors.
    - Calculate the actual consumed compute units and account data compute units.
    - Check if the transaction is a simple vote and adjust compute units accordingly.
    - Update the transaction's consumed and rebated compute units.
    - Add the transaction to the rebate sum with `fd_pack_rebate_sum_add_txn`.
    - Check if the actual compute units exceed the requested amount and log an error if so.
    - Update the sequence number in the busy sequence using `fd_fseq_update`.
    - Hash the transactions and update the microblock trailer with the hash and other metadata.
    - Calculate the microblock duration and update the trailer with transaction timing percentages.
    - Write metrics using [`metrics_write`](<#metrics_write>).
    - Calculate the bank signature and publish the microblock using `fd_stem_publish`.
    - Update the output chunk pointer using `fd_dcache_compact_next`.
- **Output**: No return value; the function operates through side effects on the input structures and memory.
- **Functions Called**:
    - [`fd_bank_err_from_runtime_err`](<fd_bank_err.h.md#fd_bank_err_from_runtime_err>)
    - [`hash_transactions`](<#hash_transactions>)
    - [`metrics_write`](<#metrics_write>)


---
### handle\_bundle<!-- {{#callable:handle_bundle}} -->
[View Source →](<../../../../../src/discof/bank/fd_bank_tile.c#L313>)

Processes a bundle of transactions, executing them, updating metrics, and publishing results.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_bank_ctx_t` structure, which contains the context for the bank operations.
    - ``seq``: An unsigned long integer representing the sequence number of the bundle.
    - ``sig``: An unsigned long integer representing the signature of the bundle.
    - ``sz``: An unsigned long integer representing the size of the bundle.
    - ``begin_tspub``: An unsigned long integer representing the timestamp when the processing of the bundle began.
    - ``stem``: A pointer to the `fd_stem_context_t` structure, which is used for publishing the results.
- **Logic and Control Flow**:
    - Convert the output memory chunk to a local address and cast it to a transaction pointer array.
    - Calculate the slot and transaction count from the signature and size, respectively.
    - Initialize arrays for writable alternate accounts, transaction errors, execution compute units, account data compute units, timestamps, and tips.
    - Iterate over each transaction in the bundle, preparing and executing them, updating flags and error states.
    - If any transaction fails, mark the entire bundle as failed; otherwise, mark all transactions as successful.
    - Update the busy sequence to indicate processing completion.
    - Calculate consumed compute units for each transaction, adjusting for simple vote transactions.
    - Rebate compute units for failed transactions and update actual consumed compute units.
    - Add transactions to the rebate sum and prepare them for publishing.
    - Copy transactions to a temporary array and publish each transaction separately with its microblock trailer.
    - Update metrics after processing all transactions.
- **Output**: No direct output is returned, but the function updates the context, metrics, and publishes results through the `stem`.
- **Functions Called**:
    - [`fd_bank_err_from_runtime_err`](<fd_bank_err.h.md#fd_bank_err_from_runtime_err>)
    - [`hash_transactions`](<#hash_transactions>)
    - [`metrics_write`](<#metrics_write>)


---
### after\_frag<!-- {{#callable:after_frag}} -->
[View Source →](<../../../../../src/discof/bank/fd_bank_tile.c#L471>)

Processes a fragment by handling either a bundle or a microblock, updating rebate information, and publishing results.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_bank_ctx_t` structure, which contains context information for the bank.
    - ``in_idx``: An unused input index.
    - ``seq``: The sequence number of the fragment.
    - ``sig``: The signature of the fragment, used to determine the slot.
    - ``sz``: The size of the fragment.
    - ``tsorig``: The original timestamp of the fragment.
    - ``tspub``: The publication timestamp of the fragment.
    - ``stem``: A pointer to the `fd_stem_context_t` structure, which is used for publishing.
- **Logic and Control Flow**:
    - Calculate the slot from the signature using `fd_disco_poh_sig_slot`.
    - Check if the slot is different from `ctx->rebates_for_slot`; if so, clear the rebate sum and update `ctx->rebates_for_slot`.
    - Determine if the context is a bundle or a microblock using `ctx->_is_bundle` and call [`handle_bundle`](<#handle_bundle>) or [`handle_microblock`](<#handle_microblock>) accordingly.
    - In a loop, report the rebate sum and publish it using `fd_stem_publish` until no more rebates are reported.
    - Update `ctx->rebate_chunk` using `fd_dcache_compact_next` after each publication.
- **Output**: No return value; the function operates through side effects on the context and stem.
- **Functions Called**:
    - [`handle_bundle`](<#handle_bundle>)
    - [`handle_microblock`](<#handle_microblock>)


---
### unprivileged\_init<!-- {{#callable:unprivileged_init}} -->
[View Source →](<../../../../../src/discof/bank/fd_bank_tile.c#L503>)

Initializes the unprivileged context for a bank tile in a distributed system.
- **Inputs**:
    - `topo`: A pointer to an `fd_topo_t` structure representing the topology of the system.
    - `tile`: A pointer to an `fd_topo_tile_t` structure representing the specific tile to initialize.
- **Logic and Control Flow**:
    - Allocate scratch memory using `fd_topo_obj_laddr` to get the local address of the tile object ID.
    - Initialize a scratch allocator with `FD_SCRATCH_ALLOC_INIT`.
    - Allocate and initialize various components such as `fd_bank_ctx_t`, `blake3`, `bmtree`, `exec_spad`, `_txncache`, and `pc_scratch` using `FD_SCRATCH_ALLOC_APPEND`.
    - Set up the `ctx` structure with various components, ensuring non-null values using the `NONNULL` macro.
    - Join and initialize various components like `fd_blake3`, `fd_spad`, `fd_funk`, `fd_progcache`, and `fd_txncache` using their respective join and new functions.
    - Retrieve and join the `banks` and `busy_fseq` using `fd_banks_join` and `fd_fseq_join`, ensuring they are not null.
    - Initialize the `metrics` field of `ctx` to zero using `memset`.
    - Set up memory and chunk pointers for `pack_in`, `out`, and `rebate` using `fd_dcache_compact_chunk0` and `fd_dcache_compact_wmark`.
- **Output**: No return value; the function initializes the context in place.


---
### populate\_allowed\_seccomp<!-- {{#callable:populate_allowed_seccomp}} -->
[View Source →](<../../../../../src/discof/bank/fd_bank_tile.c#L581>)

Populates a `sock_filter` array with a security policy for a bank tile and returns the instruction count.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, which is not used in this function.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure, which is not used in this function.
    - ``out_cnt``: An unsigned long integer representing the count of output filters to populate.
    - ``out``: A pointer to a `sock_filter` structure where the function will populate the security policy.
- **Logic and Control Flow**:
    - The function ignores the `topo` and `tile` inputs by casting them to void.
    - Calls [`populate_sock_filter_policy_fd_bank_tile`](<generated/fd_bank_tile_seccomp.h.md#populate_sock_filter_policy_fd_bank_tile>) with `out_cnt`, `out`, and the file descriptor from `fd_log_private_logfile_fd()`.
    - Returns the value of `sock_filter_policy_fd_bank_tile_instr_cnt`.
- **Output**: Returns an unsigned long integer representing the count of instructions in the populated security policy.
- **Functions Called**:
    - [`populate_sock_filter_policy_fd_bank_tile`](<generated/fd_bank_tile_seccomp.h.md#populate_sock_filter_policy_fd_bank_tile>)


---
### populate\_allowed\_fds<!-- {{#callable:populate_allowed_fds}} -->
[View Source →](<../../../../../src/discof/bank/fd_bank_tile.c#L593>)

Populates an array with file descriptors for `stderr` and optionally a logfile, returning the count of populated descriptors.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, which is not used in this function.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure, which is not used in this function.
    - ``out_fds_cnt``: An unsigned long integer representing the maximum number of file descriptors that can be stored in `out_fds`.
    - ``out_fds``: A pointer to an integer array where the function will store the allowed file descriptors.
- **Logic and Control Flow**:
    - Ignores the `topo` and `tile` inputs as they are not used in the function.
    - Checks if `out_fds_cnt` is less than 2; if so, logs an error and terminates the program.
    - Initializes `out_cnt` to 0 and assigns the file descriptor for `stderr` (2) to `out_fds[0]`, then increments `out_cnt`.
    - Checks if the logfile file descriptor is valid (not -1); if valid, assigns it to `out_fds[1]` and increments `out_cnt`.
    - Returns the value of `out_cnt`, which is the number of file descriptors populated.
- **Output**: Returns an unsigned long integer representing the number of file descriptors populated in `out_fds`.



---
Made with ❤️ by [Driver](https://www.driver.ai/)