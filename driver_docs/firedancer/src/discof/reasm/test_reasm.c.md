<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for the reassembly functionality in the Firedancer codebase, including insertion, publishing, and slot management.

# Purpose
The code is a C source file that implements a test suite for a reassembly module, which is part of a larger system. The primary purpose of this code is to test the functionality of the reassembly process, which involves inserting, querying, and managing data fragments (FECs - Forward Error Correction) within a workspace. The code includes several test functions: [`test_insert`](<#test_insert>), [`test_publish`](<#test_publish>), and [`test_slot_mr`](<#test_slot_mr>), each designed to validate different aspects of the reassembly logic. These functions perform operations such as inserting FECs into the reassembly structure, checking the order of data delivery, and handling edge cases like equivocating FEC sets.

The code uses several macros and functions from included headers, such as `fd_reasm.h` and `fd_reasm_private.h`, to interact with the reassembly module. It defines a macro `PRINT_MAP` for logging purposes and uses various data structures like `ancestry_t`, `frontier_t`, `orphaned_t`, and `subtrees_t` to manage the state of the reassembly process. The [`main`](<#main>) function initializes the environment, sets up a workspace, and executes the test functions to ensure the reassembly module behaves as expected. The code also includes validation checks using `FD_TEST` to assert the correctness of operations and uses logging to provide insights into the reassembly process.
# Imports and Dependencies

---
- `fd_reasm.h`
- `fd_reasm_private.h`
- `../../disco/fd_disco_base.h`


# Functions

---
### test\_insert<!-- {{#callable:test_insert}} -->
[View Source →](<../../../../../src/discof/reasm/test_reasm.c#L18>)

Tests the insertion and querying of FEC (Forward Error Correction) sets in a reassembly structure.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for memory allocation and management.
- **Logic and Control Flow**:
    - Allocate memory for the reassembly structure using `fd_wksp_alloc_laddr` and initialize it with [`fd_reasm_new`](<fd_reasm.c.md#fd_reasm_new>) and [`fd_reasm_join`](<fd_reasm.c.md#fd_reasm_join>).
    - Verify the successful creation of the reassembly structure with `FD_TEST`.
    - Define several `fd_hash_t` variables representing different FEC sets.
    - Insert FEC sets into the reassembly structure using [`fd_reasm_insert`](<fd_reasm.c.md#fd_reasm_insert>) and verify their presence with [`fd_reasm_query`](<fd_reasm.c.md#fd_reasm_query>) and `FD_TEST`.
    - Check the relationships and positions of FEC sets in the reassembly structure using various query functions like `frontier_ele_query`, `ancestry_ele_query`, and `subtrees_ele_query`.
    - Define an expected order of FEC sets and verify the output order using [`fd_reasm_out`](<fd_reasm.c.md#fd_reasm_out>) and `FD_TEST`.
    - Test the insertion of equivocating FEC sets and verify their positions in the reassembly structure.
    - Free the allocated memory for the reassembly structure using `fd_wksp_free_laddr`.
- **Output**: No return value; the function performs tests and assertions on the reassembly structure.
- **Functions Called**:
    - [`fd_reasm_align`](<fd_reasm.c.md#fd_reasm_align>)
    - [`fd_reasm_footprint`](<fd_reasm.c.md#fd_reasm_footprint>)
    - [`fd_reasm_join`](<fd_reasm.c.md#fd_reasm_join>)
    - [`fd_reasm_new`](<fd_reasm.c.md#fd_reasm_new>)
    - [`fd_reasm_insert`](<fd_reasm.c.md#fd_reasm_insert>)
    - [`fd_reasm_query`](<fd_reasm.c.md#fd_reasm_query>)
    - [`fd_reasm_out`](<fd_reasm.c.md#fd_reasm_out>)
    - [`fd_reasm_delete`](<fd_reasm.c.md#fd_reasm_delete>)
    - [`fd_reasm_leave`](<fd_reasm.c.md#fd_reasm_leave>)


---
### test\_publish<!-- {{#callable:test_publish}} -->
[View Source →](<../../../../../src/discof/reasm/test_reasm.c#L109>)

Tests the functionality of the reassembly process, including insertion, in-order delivery, and publishing of FEC (Forward Error Correction) sets.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for memory allocation and management.
- **Logic and Control Flow**:
    - Allocate memory for reassembly using `fd_wksp_alloc_laddr` and initialize a reassembly object with [`fd_reasm_new`](<fd_reasm.c.md#fd_reasm_new>) and [`fd_reasm_join`](<fd_reasm.c.md#fd_reasm_join>).
    - Insert FEC sets into the reassembly structure using [`fd_reasm_insert`](<fd_reasm.c.md#fd_reasm_insert>), simulating a sequence of operations including setting a root and adding orphan FECs.
    - Perform backward and interleaved repairs by inserting additional FEC sets.
    - Check the in-order delivery of FEC sets by iterating through the output of [`fd_reasm_out`](<fd_reasm.c.md#fd_reasm_out>) and verifying the order with `FD_TEST`.
    - Publish a new root using [`fd_reasm_publish`](<fd_reasm.c.md#fd_reasm_publish>) and verify the new root and ancestry with `FD_TEST`.
    - Free the allocated memory and clean up the reassembly object using [`fd_reasm_delete`](<fd_reasm.c.md#fd_reasm_delete>) and `fd_wksp_free_laddr`.
- **Output**: No return value; the function performs tests and assertions to verify the reassembly process.
- **Functions Called**:
    - [`fd_reasm_align`](<fd_reasm.c.md#fd_reasm_align>)
    - [`fd_reasm_footprint`](<fd_reasm.c.md#fd_reasm_footprint>)
    - [`fd_reasm_join`](<fd_reasm.c.md#fd_reasm_join>)
    - [`fd_reasm_new`](<fd_reasm.c.md#fd_reasm_new>)
    - [`fd_reasm_insert`](<fd_reasm.c.md#fd_reasm_insert>)
    - [`fd_reasm_out`](<fd_reasm.c.md#fd_reasm_out>)
    - [`fd_reasm_publish`](<fd_reasm.c.md#fd_reasm_publish>)
    - [`fd_reasm_query`](<fd_reasm.c.md#fd_reasm_query>)
    - [`fd_reasm_delete`](<fd_reasm.c.md#fd_reasm_delete>)
    - [`fd_reasm_leave`](<fd_reasm.c.md#fd_reasm_leave>)


---
### test\_slot\_mr<!-- {{#callable:test_slot_mr}} -->
[View Source →](<../../../../../src/discof/reasm/test_reasm.c#L184>)

Tests the insertion and chaining of FEC (Forward Error Correction) sets in a reassembly structure, ensuring correct ancestry and frontier relationships.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for memory allocation and management.
- **Logic and Control Flow**:
    - Allocate memory for the reassembly structure using `fd_wksp_alloc_laddr` and initialize it with [`fd_reasm_new`](<fd_reasm.c.md#fd_reasm_new>) and [`fd_reasm_join`](<fd_reasm.c.md#fd_reasm_join>).
    - Verify the reassembly structure and its `slot_mr` field are correctly initialized using `FD_TEST`.
    - Insert a root FEC set with [`fd_reasm_insert`](<fd_reasm.c.md#fd_reasm_insert>) and verify its presence in the frontier using [`fd_reasm_query`](<fd_reasm.c.md#fd_reasm_query>) and `frontier_ele_query`.
    - Attempt to insert a second FEC set with an incorrect parent hash (`mr0` instead of `mr1`), verify it chains correctly using `ancestry_ele_query` and is present in the frontier.
    - Insert a third FEC set with an incorrect parent hash (`mr0` instead of `mr3`), verify it is orphaned using `subtrees_ele_query`.
    - Insert a fourth FEC set with a correct parent hash (`mr2`), verify it chains correctly using `ancestry_ele_query` and that the previously orphaned FEC (`mr4`) is now chained.
- **Output**: No return value; the function performs tests and assertions to verify the correct behavior of the reassembly structure.
- **Functions Called**:
    - [`fd_reasm_align`](<fd_reasm.c.md#fd_reasm_align>)
    - [`fd_reasm_footprint`](<fd_reasm.c.md#fd_reasm_footprint>)
    - [`fd_reasm_join`](<fd_reasm.c.md#fd_reasm_join>)
    - [`fd_reasm_new`](<fd_reasm.c.md#fd_reasm_new>)
    - [`fd_reasm_insert`](<fd_reasm.c.md#fd_reasm_insert>)
    - [`fd_reasm_query`](<fd_reasm.c.md#fd_reasm_query>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/discof/reasm/test_reasm.c#L222>)

Initializes the environment, creates a workspace, runs tests on data insertion, publication, and slot management, and verifies signature repair and replay functionality.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Sets `page_cnt` to 1 and `_page_sz` to "gigantic" for workspace configuration.
    - Retrieves the NUMA index using `fd_shmem_numa_idx` with an argument of 0.
    - Creates a new anonymous workspace `wksp` using `fd_wksp_new_anonymous` with the specified page size, page count, and CPU index.
    - Verifies the successful creation of the workspace with `FD_TEST`.
    - Executes [`test_insert`](<#test_insert>), [`test_publish`](<#test_publish>), and [`test_slot_mr`](<#test_slot_mr>) functions with the workspace as an argument to test various functionalities.
    - Generates a signature `sig` using `fd_disco_repair_replay_sig` with specific parameters.
    - Verifies the signature's slot, parent offset, data count, and completion status using `FD_TEST`.
    - Calls `fd_halt` to terminate the environment.
    - Returns 0 to indicate successful execution.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`test_insert`](<#test_insert>)
    - [`test_publish`](<#test_publish>)
    - [`test_slot_mr`](<#test_slot_mr>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)