<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functionalities for capturing and analyzing network shreds and bank hashes, outputting data to CSV and binary files.

# Purpose
The code is a C source file that defines a module for capturing and processing network data related to shreds and repairs in a distributed system. It is part of a larger system that involves network communication and data processing, as indicated by the inclusion of various headers related to networking, data types, and utilities. The module has two main functionalities: it spies on network links (`net_shred`, `repair_net`, and `shred_out`) to output data to CSV files for post-analysis of repair performance, and it captures bank hashes and slices of shreds from replay and repair tiles, respectively, outputting them to binary files for reproducing live replay executions.

The module defines several data structures and functions to manage the capture and processing of network data. The `fd_capture_tile_ctx_t` structure holds the context for capturing data, including buffers, file descriptors, and configuration parameters. The module initializes file handlers for writing captured data to files and sets up the necessary context for processing incoming network fragments. It includes functions for handling different types of network fragments, such as shreds, repair requests, and gossip messages, and processes them accordingly. The module also defines functions for managing memory alignment and footprint calculations, which are crucial for efficient data handling in a high-performance network environment.
# Imports and Dependencies

---
- `../../disco/topo/fd_topo.h`
- `../../disco/net/fd_net_tile.h`
- `../../flamenco/types/fd_types.h`
- `../../flamenco/fd_flamenco_base.h`
- `../../util/pod/fd_pod_format.h`
- `../../flamenco/gossip/fd_gossip_types.h`
- `../../disco/fd_disco.h`
- `../../discof/fd_discof.h`
- `../../discof/replay/fd_replay_tile.h`
- `../../discof/replay/fd_exec.h`
- `../../discof/restore/utils/fd_ssmsg.h`
- `../../discof/restore/utils/fd_ssmanifest_parser.h`
- `../../flamenco/runtime/sysvar/fd_sysvar_epoch_schedule.h`
- `errno.h`
- `fcntl.h`
- `sys/mman.h`
- `sys/stat.h`
- `string.h`
- `stdio.h`
- `unistd.h`
- `linux/unistd.h`
- `sys/socket.h`
- `linux/if_xdp.h`
- `generated/fd_shredcap_tile_seccomp.h`
- `../../disco/stem/fd_stem.c`


# Global Variables

---
### privileged\_init
- **Type**: `function`
- **Description**: Initializes file descriptors for various output files related to network and repair data capture. It constructs file paths using the `folder_path` from the `tile` structure and opens the files for writing.
- **Use**: Used to set up file descriptors for capturing and logging network and repair data.


---
### fd\_tile\_shredcap
- **Type**: ``fd_topo_run_tile_t``
- **Description**: Defines a tile configuration for the `shredcap` functionality. It includes various function pointers and parameters for initialization, security, and execution of the tile.
- **Use**: Used to configure and manage the execution of a tile that captures and processes network data related to shreds and bank hashes.


# Data Structures

---
### fd\_capture\_in\_ctx\_t
- **Type**: ``union``
- **Members**:
    - ``mem``: Pointer to a `fd_wksp_t` structure.
    - ``chunk0``: Unsigned long integer representing the initial chunk.
    - ``wmark``: Unsigned long integer representing a watermark.
    - ``net_rx``: Instance of `fd_net_rx_bounds_t` structure.
- **Description**: `fd_capture_in_ctx_t` is a union that can represent either a structure containing a pointer to a workspace (`mem`), an initial chunk (`chunk0`), and a watermark (`wmark`), or an instance of `fd_net_rx_bounds_t`. This union is used to manage input contexts in a flexible manner, allowing for different types of data handling within the same memory space.


---
### out\_link
- **Type**: ``struct``
- **Members**:
    - ``idx``: An unsigned long integer that likely serves as an index or identifier.
    - ``mcache``: A pointer to `fd_frag_meta_t`, which is likely a metadata cache.
    - ``sync``: A pointer to an unsigned long integer, possibly used for synchronization.
    - ``depth``: An unsigned long integer that might represent a depth or level.
    - ``seq``: An unsigned long integer that likely represents a sequence number.
    - ``mem``: A pointer to `fd_wksp_t`, which is likely a workspace or memory area.
    - ``chunk0``: An unsigned long integer that might represent the initial chunk or offset.
    - ``wmark``: An unsigned long integer that likely represents a watermark or threshold.
    - ``chunk``: An unsigned long integer that might represent a current chunk or position.
- **Description**: The `out_link` structure is a compound data type that manages various attributes related to data handling and memory management. It includes pointers to metadata and memory areas, as well as several unsigned long integers that likely serve as indices, sequence numbers, and markers for data processing. This structure is used to manage output links in a system, possibly for data streaming or communication purposes.


---
### out\_link\_t
- **Type**: ``struct``
- **Members**:
    - ``idx``: Index of the output link.
    - ``mcache``: Pointer to a metadata cache.
    - ``sync``: Pointer to a synchronization variable.
    - ``depth``: Depth of the metadata cache.
    - ``seq``: Sequence number for the output link.
    - ``mem``: Pointer to a workspace memory.
    - ``chunk0``: Initial chunk index in the workspace.
    - ``wmark``: Watermark for the workspace.
    - ``chunk``: Current chunk index in the workspace.
- **Description**: Defines an output link structure used to manage and track the state of an output link in a network or data processing system. It includes fields for indexing, metadata caching, synchronization, and memory management, allowing for efficient handling of data chunks and sequence tracking.


---
### fd\_capture\_tile\_ctx
- **Type**: ``struct``
- **Members**:
    - ``in_kind``: Array of 32 unsigned characters representing input kinds.
    - ``in_links``: Array of 32 `fd_capture_in_ctx_t` structures representing input links.
    - ``skip_frag``: Integer flag to skip fragments.
    - ``repair_intake_listen_port``: Unsigned short representing the repair intake listen port.
    - ``shred_buffer_sz``: Unsigned long representing the size of the shred buffer.
    - ``shred_buffer``: Array of unsigned characters for the shred buffer with size `FD_NET_MTU`.
    - ``repair_buffer_sz``: Unsigned long representing the size of the repair buffer.
    - ``repair_buffer``: Array of unsigned characters for the repair buffer with size `FD_NET_MTU`.
    - ``stake_out``: Array of one `out_link_t` structure for stake output.
    - ``snap_out``: Array of one `out_link_t` structure for snapshot output.
    - ``enable_publish_stake_weights``: Integer flag to enable publishing of stake weights.
    - ``manifest_wmark``: Pointer to an unsigned long representing the manifest watermark.
    - ``manifest_bank_mem``: Pointer to unsigned characters for manifest bank memory.
    - ``banks``: Pointer to `fd_banks_t` structure representing banks.
    - ``bank``: Pointer to `fd_bank_t` structure representing a bank.
    - ``manifest_path``: Character array for the manifest path with size `PATH_MAX`.
    - ``manifest_load_done``: Integer flag indicating if the manifest load is done.
    - ``manifest_spad_mem``: Pointer to unsigned characters for manifest scratchpad memory.
    - ``manifest_spad``: Pointer to `fd_spad_t` structure for manifest scratchpad.
    - ``shared_spad_mem``: Pointer to unsigned characters for shared scratchpad memory.
    - ``shared_spad``: Pointer to `fd_spad_t` structure for shared scratchpad.
    - ``intake_hdr``: Array of one `fd_ip4_udp_hdrs_t` structure for intake headers.
    - ``now``: Unsigned long representing the current time.
    - ``last_packet_ns``: Unsigned long representing the last packet timestamp in nanoseconds.
    - ``tick_per_ns``: Double representing ticks per nanosecond.
    - ``shred_ostream``: `fd_io_buffered_ostream_t` structure for shred output stream.
    - ``repair_ostream``: `fd_io_buffered_ostream_t` structure for repair output stream.
    - ``fecs_ostream``: `fd_io_buffered_ostream_t` structure for FECs output stream.
    - ``peers_ostream``: `fd_io_buffered_ostream_t` structure for peers output stream.
    - ``slices_ostream``: `fd_io_buffered_ostream_t` structure for slices output stream.
    - ``bank_hashes_ostream``: `fd_io_buffered_ostream_t` structure for bank hashes output stream.
    - ``shreds_fd``: Integer file descriptor for shreds.
    - ``requests_fd``: Integer file descriptor for requests.
    - ``fecs_fd``: Integer file descriptor for FECs.
    - ``peers_fd``: Integer file descriptor for peers.
    - ``slices_fd``: Integer file descriptor for slices.
    - ``bank_hashes_fd``: Integer file descriptor for bank hashes.
    - ``write_buf_sz``: Unsigned long representing the write buffer size.
    - ``shreds_buf``: Pointer to unsigned characters for the shreds buffer.
    - ``requests_buf``: Pointer to unsigned characters for the requests buffer.
    - ``fecs_buf``: Pointer to unsigned characters for the FECs buffer.
    - ``peers_buf``: Pointer to unsigned characters for the peers buffer.
    - ``slices_buf``: Pointer to unsigned characters for the slices buffer.
    - ``bank_hashes_buf``: Pointer to unsigned characters for the bank hashes buffer.
    - ``alloc``: Pointer to `fd_alloc_t` structure for memory allocation.
    - ``contact_info_buffer``: Array of unsigned characters for contact information buffer with size `MAX_BUFFER_SIZE`.
- **Description**: `fd_capture_tile_ctx` is a structure that manages the context for capturing and processing network data related to shreds, repairs, and bank hashes. It includes buffers and file descriptors for handling different types of data streams, as well as pointers to various memory and configuration structures. The structure is used to facilitate the capture and analysis of network traffic and to manage the state and configuration of the capture process.


---
### fd\_capture\_tile\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``in_kind``: Array of 32 `uchar` values representing the type of input link.
    - ``in_links``: Array of 32 `fd_capture_in_ctx_t` structures representing input link contexts.
    - ``skip_frag``: Integer flag to indicate whether to skip a fragment.
    - ``repair_intake_listen_port``: Port number for listening to repair intake.
    - ``shred_buffer_sz``: Size of the shred buffer.
    - ``shred_buffer``: Buffer for storing shreds with a size of `FD_NET_MTU`.
    - ``repair_buffer_sz``: Size of the repair buffer.
    - ``repair_buffer``: Buffer for storing repair data with a size of `FD_NET_MTU`.
    - ``stake_out``: Array of one `out_link_t` structure for stake output link.
    - ``snap_out``: Array of one `out_link_t` structure for snapshot output link.
    - ``enable_publish_stake_weights``: Integer flag to enable publishing of stake weights.
    - ``manifest_wmark``: Pointer to a `ulong` representing the manifest watermark.
    - ``manifest_bank_mem``: Pointer to `uchar` representing memory for manifest banks.
    - ``banks``: Pointer to `fd_banks_t` structure for bank management.
    - ``bank``: Pointer to `fd_bank_t` structure for a single bank.
    - ``manifest_path``: Character array for storing the path to the manifest file.
    - ``manifest_load_done``: Integer flag indicating if the manifest load is complete.
    - ``manifest_spad_mem``: Pointer to `uchar` for manifest scratchpad memory.
    - ``manifest_spad``: Pointer to `fd_spad_t` structure for manifest scratchpad.
    - ``shared_spad_mem``: Pointer to `uchar` for shared scratchpad memory.
    - ``shared_spad``: Pointer to `fd_spad_t` structure for shared scratchpad.
    - ``intake_hdr``: Array of one `fd_ip4_udp_hdrs_t` structure for intake headers.
    - ``now``: Current time in `ulong`.
    - ``last_packet_ns``: Timestamp of the last packet in nanoseconds.
    - ``tick_per_ns``: Conversion factor from ticks to nanoseconds.
    - ``shred_ostream``: Buffered output stream for shreds.
    - ``repair_ostream``: Buffered output stream for repairs.
    - ``fecs_ostream``: Buffered output stream for FECs.
    - ``peers_ostream``: Buffered output stream for peers.
    - ``slices_ostream``: Buffered output stream for slices.
    - ``bank_hashes_ostream``: Buffered output stream for bank hashes.
    - ``shreds_fd``: File descriptor for shreds.
    - ``requests_fd``: File descriptor for requests.
    - ``fecs_fd``: File descriptor for FECs.
    - ``peers_fd``: File descriptor for peers.
    - ``slices_fd``: File descriptor for slices.
    - ``bank_hashes_fd``: File descriptor for bank hashes.
    - ``write_buf_sz``: Size of the write buffer.
    - ``shreds_buf``: Pointer to `uchar` buffer for shreds.
    - ``requests_buf``: Pointer to `uchar` buffer for requests.
    - ``fecs_buf``: Pointer to `uchar` buffer for FECs.
    - ``peers_buf``: Pointer to `uchar` buffer for peers.
    - ``slices_buf``: Pointer to `uchar` buffer for slices.
    - ``bank_hashes_buf``: Pointer to `uchar` buffer for bank hashes.
    - ``alloc``: Pointer to `fd_alloc_t` structure for memory allocation.
    - ``contact_info_buffer``: Buffer for storing contact information with a maximum size of `MAX_BUFFER_SIZE`.
- **Description**: `fd_capture_tile_ctx_t` is a structure that manages the context for capturing and processing network data in a tile-based system. It includes arrays for input link types and contexts, buffers for shreds and repairs, and output streams for various data types. The structure also contains file descriptors for handling file operations, memory allocation pointers, and flags for controlling operations like manifest loading and stake weight publishing. It is designed to facilitate the capture and analysis of network data, including shreds, repairs, and bank hashes, and to manage the associated resources and configurations.


# Functions

---
### scratch\_align<!-- {{#callable:scratch_align}} -->
[View Source →](<../../../../../src/discof/shredcap/fd_shredcap_tile.c#L137>)

Returns a constant value of 4096UL.
- **Inputs**: None
- **Logic and Control Flow**:
    - The function is defined as `static inline`, indicating it is intended for use within the same translation unit and suggests potential inlining by the compiler.
    - The function is marked with `FD_FN_CONST`, indicating it has no side effects and its return value depends only on its parameters, which are none in this case.
    - The function body contains a single return statement that returns the constant value `4096UL`.
- **Output**: Returns the unsigned long integer value `4096UL`.


---
### manifest\_bank\_align<!-- {{#callable:manifest_bank_align}} -->
[View Source →](<../../../../../src/discof/shredcap/fd_shredcap_tile.c#L142>)

Returns the alignment requirement for a manifest bank by calling `fd_banks_align()`.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls the function `fd_banks_align()` to get the alignment requirement.
    - Returns the result of `fd_banks_align()`.
- **Output**: The function returns an `ulong` value representing the alignment requirement for a manifest bank.


---
### manifest\_bank\_footprint<!-- {{#callable:manifest_bank_footprint}} -->
[View Source →](<../../../../../src/discof/shredcap/fd_shredcap_tile.c#L147>)

Calculates the memory footprint required for the manifest bank using predefined constants for maximum total banks and fork width.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls the `fd_banks_footprint` function with `MANIFEST_MAX_TOTAL_BANKS` and `MANIFEST_MAX_FORK_WIDTH` as arguments.
    - Returns the result of the `fd_banks_footprint` function call.
- **Output**: Returns an `ulong` representing the calculated memory footprint for the manifest bank.


---
### manifest\_load\_align<!-- {{#callable:manifest_load_align}} -->
[View Source →](<../../../../../src/discof/shredcap/fd_shredcap_tile.c#L152>)

Returns a constant alignment value of 128 for manifest loading.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the constant value `128UL`.
- **Output**: The function returns an unsigned long integer (`ulong`) with the value `128UL`.


---
### manifest\_load\_footprint<!-- {{#callable:manifest_load_footprint}} -->
[View Source →](<../../../../../src/discof/shredcap/fd_shredcap_tile.c#L157>)

Returns the memory footprint required for loading a manifest, set to 2GB.
- **Inputs**: None
- **Logic and Control Flow**:
    - The function contains a comment explaining that a manifest typically requires 1GB, but closer to 2GB have been observed in mainnet, so the footprint is set to 2GB.
    - The function returns the value `2UL * FD_SHMEM_GIGANTIC_PAGE_SZ`.
- **Output**: Returns an unsigned long integer representing the memory footprint size, specifically 2GB.


---
### manifest\_spad\_max\_alloc\_align<!-- {{#callable:manifest_spad_max_alloc_align}} -->
[View Source →](<../../../../../src/discof/shredcap/fd_shredcap_tile.c#L165>)

Returns the alignment value for the maximum allocation of a scratchpad in the manifest.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the constant `FD_SPAD_ALIGN`.
- **Output**: The function returns an `ulong` representing the alignment value for the maximum allocation of a scratchpad.


---
### manifest\_spad\_max\_alloc\_footprint<!-- {{#callable:manifest_spad_max_alloc_footprint}} -->
[View Source →](<../../../../../src/discof/shredcap/fd_shredcap_tile.c#L170>)

Calculates the maximum memory footprint required for the manifest load scratchpad by adding a constant offset to the manifest load footprint.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls the [`manifest_load_footprint`](<#manifest_load_footprint>) function to get the base memory footprint for the manifest load.
    - Adds `128UL * FD_SHMEM_HUGE_PAGE_SZ` to the result of [`manifest_load_footprint`](<#manifest_load_footprint>) to account for additional memory requirements.
- **Output**: Returns an `ulong` representing the total memory footprint required for the manifest load scratchpad.
- **Functions Called**:
    - [`manifest_load_footprint`](<#manifest_load_footprint>)


---
### shared\_spad\_max\_alloc\_align<!-- {{#callable:shared_spad_max_alloc_align}} -->
[View Source →](<../../../../../src/discof/shredcap/fd_shredcap_tile.c#L178>)

Returns the alignment value for shared scratchpad memory allocation.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the constant `FD_SPAD_ALIGN`.
- **Output**: The function returns an `ulong` representing the alignment value for shared scratchpad memory allocation.


---
### shared\_spad\_max\_alloc\_footprint<!-- {{#callable:shared_spad_max_alloc_footprint}} -->
[View Source →](<../../../../../src/discof/shredcap/fd_shredcap_tile.c#L183>)

Calculates the maximum memory footprint required for the shared scratchpad used by manifest banks and manifest load.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `manifest_bank_footprint()` to get the memory footprint for manifest banks.
    - Calls `manifest_load_footprint()` to get the memory footprint for manifest load.
    - Uses `fd_ulong_max()` to return the larger of the two footprints.
- **Output**: Returns the maximum of the memory footprints for manifest banks and manifest load as an unsigned long integer.
- **Functions Called**:
    - [`manifest_bank_footprint`](<#manifest_bank_footprint>)
    - [`manifest_load_footprint`](<#manifest_load_footprint>)


---
### loose\_footprint<!-- {{#callable:loose_footprint}} -->
[View Source →](<../../../../../src/discof/shredcap/fd_shredcap_tile.c#L193>)

Calculates the memory footprint required for a tile context and aligns it to a gigantic page size.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure, which is unused in this function.
- **Logic and Control Flow**:
    - Initialize `footprint` with the size of `fd_capture_tile_ctx_t`.
    - Add the result of `manifest_bank_footprint()` to `footprint`.
    - Add the result of `fd_spad_footprint(manifest_spad_max_alloc_footprint())` to `footprint`.
    - Add the result of `fd_spad_footprint(shared_spad_max_alloc_footprint())` to `footprint`.
    - Add the result of `fd_alloc_footprint()` to `footprint`.
    - Align `footprint` to `FD_SHMEM_GIGANTIC_PAGE_SZ` using `fd_ulong_align_up`.
    - Return the aligned `footprint`.
- **Output**: Returns an `ulong` representing the aligned memory footprint size.
- **Functions Called**:
    - [`manifest_bank_footprint`](<#manifest_bank_footprint>)
    - [`manifest_spad_max_alloc_footprint`](<#manifest_spad_max_alloc_footprint>)
    - [`shared_spad_max_alloc_footprint`](<#shared_spad_max_alloc_footprint>)


---
### populate\_allowed\_seccomp<!-- {{#callable:populate_allowed_seccomp}} -->
[View Source →](<../../../../../src/discof/shredcap/fd_shredcap_tile.c#L204>)

Populates a seccomp filter with allowed file descriptors for a specific tile.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, which is not used in this function.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure containing file descriptor information for the tile.
    - ``out_cnt``: The number of entries in the `out` array.
    - ``out``: A pointer to an array of `sock_filter` structures where the seccomp filter rules will be stored.
- **Logic and Control Flow**:
    - Calls [`populate_sock_filter_policy_fd_shredcap_tile`](<generated/fd_shredcap_tile_seccomp.h.md#populate_sock_filter_policy_fd_shredcap_tile>) with `out_cnt`, `out`, and file descriptors from `tile->shredcap` and `fd_log_private_logfile_fd()` as arguments.
    - Returns the value of `sock_filter_policy_fd_shredcap_tile_instr_cnt`.
- **Output**: Returns an `ulong` representing the number of instructions in the seccomp filter.
- **Functions Called**:
    - [`populate_sock_filter_policy_fd_shredcap_tile`](<generated/fd_shredcap_tile_seccomp.h.md#populate_sock_filter_policy_fd_shredcap_tile>)


---
### scratch\_footprint<!-- {{#callable:scratch_footprint}} -->
[View Source →](<../../../../../src/discof/shredcap/fd_shredcap_tile.c#L219>)

Calculates the memory footprint required for a scratchpad based on various alignment and footprint requirements.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure, which is not used in the function.
- **Logic and Control Flow**:
    - Initialize `l` with `FD_LAYOUT_INIT` to start the layout calculation.
    - Append the size and alignment of `fd_capture_tile_ctx_t` to `l` using `FD_LAYOUT_APPEND`.
    - Append the alignment and footprint of the manifest bank to `l`.
    - Append the alignment and footprint of the manifest scratchpad to `l`.
    - Append the alignment and footprint of the shared scratchpad to `l`.
    - Append the alignment and footprint of the allocator to `l`.
    - Finalize the layout with `FD_LAYOUT_FINI` using `scratch_align()` and return the result.
- **Output**: Returns an `ulong` representing the total memory footprint required for the scratchpad.
- **Functions Called**:
    - [`manifest_bank_align`](<#manifest_bank_align>)
    - [`manifest_bank_footprint`](<#manifest_bank_footprint>)
    - [`manifest_spad_max_alloc_align`](<#manifest_spad_max_alloc_align>)
    - [`manifest_spad_max_alloc_footprint`](<#manifest_spad_max_alloc_footprint>)
    - [`shared_spad_max_alloc_align`](<#shared_spad_max_alloc_align>)
    - [`shared_spad_max_alloc_footprint`](<#shared_spad_max_alloc_footprint>)
    - [`scratch_align`](<#scratch_align>)


---
### generate\_stake\_weight\_msg\_manifest<!-- {{#callable:generate_stake_weight_msg_manifest}} -->
[View Source →](<../../../../../src/discof/shredcap/fd_shredcap_tile.c#L231>)

Generates a stake weight message manifest for a given epoch using the provided epoch schedule and epoch stakes, and outputs the message size.
- **Inputs**:
    - `epoch`: The current epoch for which the stake weight message is generated.
    - `epoch_schedule`: A pointer to the `fd_epoch_schedule_t` structure containing the schedule details for the epoch.
    - `epoch_stakes`: A pointer to the `fd_snapshot_manifest_epoch_stakes_t` structure containing the stakes for the epoch.
    - `stake_weight_msg_out`: A pointer to an unsigned long where the generated stake weight message will be stored.
- **Logic and Control Flow**:
    - Cast `stake_weight_msg_out` to a `fd_stake_weight_msg_t` pointer and assign it to `stake_weight_msg`.
    - Set the `epoch`, `staked_cnt`, `start_slot`, `slot_cnt`, `excluded_stake`, and `vote_keyed_lsched` fields of `stake_weight_msg`.
    - Check if the epoch is before the activation epoch for testnet or mainnet and adjust `vote_keyed_lsched` accordingly.
    - Iterate over `epoch_stakes->vote_stakes_len` to copy stake and identity information from `epoch_stakes` to `stake_weights`.
    - Sort the `stake_weights` array by stake and vote using `sort_vote_weights_by_stake_vote_inplace`.
    - Return the size of the stake weight message using `fd_stake_weight_msg_sz`.
- **Output**: Returns the size of the generated stake weight message as an unsigned long.


---
### publish\_stake\_weights\_manifest<!-- {{#callable:publish_stake_weights_manifest}} -->
[View Source →](<../../../../../src/discof/shredcap/fd_shredcap_tile.c#L266>)

Publishes stake weight messages for the current and next epoch based on the provided manifest.
- **Inputs**:
    - ``ctx``: A pointer to `fd_capture_tile_ctx_t`, which contains context information for the capture tile, including memory and chunk management for stake weights.
    - ``stem``: A pointer to `fd_stem_context_t`, which is used for publishing messages.
    - ``manifest``: A constant pointer to `fd_snapshot_manifest_t`, which contains epoch schedule parameters and epoch stakes information.
- **Logic and Control Flow**:
    - Retrieve the epoch schedule from the `manifest` using `fd_type_pun_const` and calculate the current epoch using `fd_slot_to_epoch`.
    - For the current epoch, convert the chunk to a local address using `fd_chunk_to_laddr`, generate the stake weight message using [`generate_stake_weight_msg_manifest`](<#generate_stake_weight_msg_manifest>), and publish it using `fd_stem_publish`.
    - Update the chunk pointer using `fd_dcache_compact_next` and log the current epoch stake weights.
    - Repeat the process for the next epoch by incrementing the epoch value and using the next set of epoch stakes from the `manifest`.
- **Output**: No return value; the function operates by side effects, publishing messages and updating context state.
- **Functions Called**:
    - [`generate_stake_weight_msg_manifest`](<#generate_stake_weight_msg_manifest>)


---
### before\_frag<!-- {{#callable:before_frag}} -->
[View Source →](<../../../../../src/discof/shredcap/fd_shredcap_tile.c#L290>)

Determines if a fragment should be processed based on its type and signature.
- **Inputs**:
    - ``ctx``: A pointer to a `fd_capture_tile_ctx_t` structure that contains context information about the capture tile.
    - ``in_idx``: An unsigned long integer representing the index of the input kind in the `ctx->in_kind` array.
    - ``seq``: An unsigned long integer representing the sequence number, which is unused in this function.
    - ``sig``: An unsigned long integer representing the signature of the fragment.
- **Logic and Control Flow**:
    - Checks if the input kind at `in_idx` is `NET_SHRED` using `FD_LIKELY` macro.
    - If true, calls `fd_disco_netmux_sig_proto` with `sig` and checks if the result is not equal to `DST_PROTO_SHRED` and `DST_PROTO_REPAIR`.
    - Returns 1 if both conditions are true, otherwise returns 0.
    - If the input kind at `in_idx` is `GOSSIP_OUT` using `FD_UNLIKELY` macro, checks if `sig` is not equal to `FD_GOSSIP_UPDATE_TAG_CONTACT_INFO`.
    - Returns 1 if the condition is true, otherwise returns 0.
    - If none of the above conditions are met, returns 0.
- **Output**: Returns an integer indicating whether the fragment should be processed (1) or not (0).


---
### handle\_new\_contact\_info<!-- {{#callable:handle_new_contact_info}} -->
[View Source →](<../../../../../src/discof/shredcap/fd_shredcap_tile.c#L303>)

Processes new contact information from a buffer and writes it to an output stream if certain conditions are met.
- **Inputs**:
    - ``ctx``: A pointer to a `fd_capture_tile_ctx_t` structure that contains context information, including output streams.
    - ``buf``: A constant pointer to an unsigned character array that contains the buffer with contact information.
- **Logic and Control Flow**:
    - Cast the buffer `buf` to a `fd_gossip_update_message_t` pointer to access the contact information.
    - Extract the TVU and repair socket information from the message.
    - Check if the TVU socket is non-zero; if true, format the TVU information into a string and write it to the `peers_ostream` in `ctx`.
    - Check if the repair socket is non-zero; if true, format the repair information into a string and write it to the `peers_ostream` in `ctx`.
    - Use `FD_TEST` to ensure that the write operations to the output stream are successful.
- **Output**: No return value; writes formatted contact information to the `peers_ostream` in `ctx` if conditions are met.


---
### is\_fec\_completes\_msg<!-- {{#callable:is_fec_completes_msg}} -->
[View Source →](<../../../../../src/discof/shredcap/fd_shredcap_tile.c#L328>)

Checks if the given size `sz` matches the expected size for a FEC complete message.
- **Inputs**:
    - `sz`: The size to check against the expected FEC complete message size.
- **Logic and Control Flow**:
    - Compares the input size `sz` to the sum of `FD_SHRED_DATA_HEADER_SZ` and twice `FD_SHRED_MERKLE_ROOT_SZ`.
    - Returns 1 if the sizes match, indicating a complete FEC message; otherwise, returns 0.
- **Output**: Returns an integer indicating whether the size matches the expected FEC complete message size (1 for match, 0 for no match).


---
### during\_frag<!-- {{#callable:during_frag}} -->
[View Source →](<../../../../../src/discof/shredcap/fd_shredcap_tile.c#L333>)

Processes incoming fragments based on their type and updates the context accordingly.
- **Inputs**:
    - `ctx`: Pointer to the `fd_capture_tile_ctx_t` structure that holds the context for processing fragments.
    - `in_idx`: Index of the input link in the `ctx->in_kind` array.
    - `seq`: Sequence number of the fragment, marked as unused with `FD_PARAM_UNUSED`.
    - `sig`: Signature or identifier for the fragment.
    - `chunk`: Chunk identifier for the fragment data.
    - `sz`: Size of the fragment data.
    - `ctl`: Control information for the fragment.
- **Logic and Control Flow**:
    - Set `ctx->skip_frag` to 0 to indicate the fragment should not be skipped initially.
    - Check the type of input link using `ctx->in_kind[in_idx]` and process accordingly.
    - For `SHRED_OUT`, check if the fragment completes a message using `is_fec_completes_msg(sz)`. If not, set `ctx->skip_frag` to 1 and return.
    - For `NET_SHRED`, translate the fragment and parse it. If parsing fails, set `ctx->skip_frag` to 1 and return. Copy the fragment data to `ctx->shred_buffer`.
    - For `REPAIR_NET`, check the source port and discriminant to filter out non-repair requests. If conditions are not met, set `ctx->skip_frag` to 1 and return. Copy the fragment data to `ctx->repair_buffer`.
    - For `REPAIR_SHREDCAP`, write a header, the fragment data, and a trailer to the `slices_ostream`. Log critical errors if writing fails.
    - For `REPLAY_OUT`, check if the signature matches `REPLAY_SIG_SLOT_COMPLETED`. If not, return. Otherwise, write a bank hash message to the `bank_hashes_ostream`.
    - For other types, check if the chunk is within valid range. If not, log an error. Otherwise, copy the fragment data to `ctx->contact_info_buffer`.
- **Output**: No direct output; modifies the `ctx` structure based on the fragment type and content.
- **Functions Called**:
    - [`is_fec_completes_msg`](<#is_fec_completes_msg>)


---
### after\_credit<!-- {{#callable:after_credit}} -->
[View Source →](<../../../../../src/discof/shredcap/fd_shredcap_tile.c#L442>)

Processes a manifest file if it has not been loaded yet, updates the context with the manifest data, and publishes the manifest and stake weights.
- **Inputs**:
    - ``ctx``: A pointer to `fd_capture_tile_ctx_t` structure, which holds the context for capturing tile operations.
    - ``stem``: A pointer to `fd_stem_context_t` structure, which is used for publishing data.
    - ``opt_poll_in``: An unused integer pointer parameter, marked with `FD_PARAM_UNUSED`.
    - ``charge_busy``: An unused integer pointer parameter, marked with `FD_PARAM_UNUSED`.
- **Logic and Control Flow**:
    - Checks if the manifest has already been loaded by evaluating `ctx->manifest_load_done`.
    - If the manifest is not loaded, checks if `ctx->manifest_path` is not an empty string.
    - Resets the scratchpad `ctx->manifest_spad` to prepare for loading a new manifest.
    - Opens the manifest file specified by `ctx->manifest_path` for reading.
    - If the file cannot be opened, logs a warning and exits the function.
    - Allocates memory for the manifest in `ctx->manifest_spad` and verifies the allocation.
    - Allocates a buffer in `ctx->shared_spad` for reading the manifest file content.
    - Reads the manifest file into the buffer and verifies the read operation.
    - Initializes and consumes the manifest data using a parser, verifying successful parsing.
    - Logs the manifest bank slot and updates the manifest watermark with the slot value.
    - Copies the manifest data to the output chunk and publishes it using `fd_stem_publish`.
    - Updates the chunk pointer for the next data and publishes a 'done' message.
    - Calls [`publish_stake_weights_manifest`](<#publish_stake_weights_manifest>) to publish the stake weights from the manifest.
    - Sets `ctx->manifest_load_done` to 1 to indicate the manifest has been processed.
- **Output**: No return value; the function operates on the provided context and updates it accordingly.
- **Functions Called**:
    - [`manifest_load_align`](<#manifest_load_align>)
    - [`manifest_load_footprint`](<#manifest_load_footprint>)
    - [`publish_stake_weights_manifest`](<#publish_stake_weights_manifest>)


---
### after\_frag<!-- {{#callable:after_frag}} -->
[View Source →](<../../../../../src/discof/shredcap/fd_shredcap_tile.c#L502>)

Processes different types of network fragments and writes relevant data to output streams based on the fragment type.
- **Inputs**:
    - ``ctx``: A pointer to `fd_capture_tile_ctx_t`, which holds context information for processing fragments.
    - ``in_idx``: An index indicating the type of input fragment being processed.
    - ``seq``: A sequence number, marked as unused in this function.
    - ``sig``: A signature or identifier for the fragment.
    - ``sz``: The size of the fragment.
    - ``tsorig``: The original timestamp, marked as unused in this function.
    - ``tspub``: The publication timestamp, marked as unused in this function.
    - ``stem``: A pointer to `fd_stem_context_t`, marked as unused in this function.
- **Logic and Control Flow**:
    - Checks if `ctx->skip_frag` is true; if so, returns immediately.
    - Determines the type of fragment based on `ctx->in_kind[in_idx]`.
    - For `SHRED_OUT`, processes a FEC completes message and writes data to `ctx->fecs_ostream`.
    - For `NET_SHRED`, processes network shreds, extracts information, and writes to `ctx->shred_ostream`.
    - For `REPAIR_NET`, decodes repair requests and writes relevant data to `ctx->repair_ostream`.
    - For `GOSSIP_OUT`, calls [`handle_new_contact_info`](<#handle_new_contact_info>) to process contact information.
- **Output**: Writes processed data to different output streams based on the type of fragment.
- **Functions Called**:
    - [`handle_new_contact_info`](<#handle_new_contact_info>)


---
### populate\_allowed\_fds<!-- {{#callable:populate_allowed_fds}} -->
[View Source →](<../../../../../src/discof/shredcap/fd_shredcap_tile.c#L614>)

Populates an array with file descriptors related to logging and various file operations if they are valid.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, which is not used in this function.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure containing file descriptors for various operations.
    - ``out_fds_cnt``: An unsigned long integer representing the count of output file descriptors, which is not used in this function.
    - ``out_fds``: A pointer to an integer array where the function will store the valid file descriptors.
- **Logic and Control Flow**:
    - Initialize `out_cnt` to 0.
    - Add the file descriptor for `stderr` (2) to `out_fds` and increment `out_cnt`.
    - Check if the file descriptor for the log file is valid using `fd_log_private_logfile_fd()`. If valid, add it to `out_fds` and increment `out_cnt`.
    - For each file descriptor in `tile->shredcap` (shreds_fd, requests_fd, fecs_fd, peers_fd, slices_fd, bank_hashes_fd), check if it is valid (not equal to -1). If valid, add it to `out_fds` and increment `out_cnt`.
- **Output**: Returns the number of valid file descriptors added to `out_fds` as an unsigned long integer.


---
### init\_file\_handlers<!-- {{#callable:init_file_handlers}} -->
[View Source →](<../../../../../src/discof/shredcap/fd_shredcap_tile.c#L690>)

Initializes file handlers by setting up file descriptors, truncating files, allocating buffers, and initializing buffered output streams.
- **Inputs**:
    - ``ctx``: A pointer to `fd_capture_tile_ctx_t` structure, which holds context information for the capture tile.
    - ``ctx_file``: A pointer to an integer where the file descriptor for the context will be stored.
    - ``tile_file``: An integer representing the file descriptor of the tile file to be used.
    - ``ctx_buf``: A pointer to a pointer to an unsigned character buffer, which will be allocated and used for buffered output.
    - ``ctx_ostream``: A pointer to `fd_io_buffered_ostream_t` structure, which will be initialized for buffered output streaming.
- **Logic and Control Flow**:
    - Assigns `tile_file` to `*ctx_file` to set the file descriptor for the context.
    - Calls `ftruncate` on `*ctx_file` to truncate the file to zero length, logging an error if it fails.
    - Uses `lseek` to move the file offset to the beginning of the file, logging an error if it fails.
    - Allocates memory for `*ctx_buf` using `fd_alloc_malloc` with the allocation context from `ctx`, logging an error if allocation fails.
    - Initializes `ctx_ostream` using `fd_io_buffered_ostream_init` with the file descriptor, buffer, and buffer size, logging an error if initialization fails.
- **Output**: No return value; the function modifies the input pointers to set up file handling and streaming.


---
### unprivileged\_init<!-- {{#callable:unprivileged_init}} -->
[View Source →](<../../../../../src/discof/shredcap/fd_shredcap_tile.c#L722>)

Initializes the unprivileged context for a tile in a topology, setting up memory allocations, input links, output links, and file handlers.
- **Inputs**:
    - `topo`: A pointer to `fd_topo_t`, representing the topology configuration.
    - `tile`: A pointer to `fd_topo_tile_t`, representing the specific tile configuration within the topology.
- **Logic and Control Flow**:
    - Allocate scratch memory and initialize context, manifest bank, manifest scratchpad, shared scratchpad, and allocator memory.
    - Iterate over input links to configure them based on their names, setting up memory and watermark configurations.
    - Set up the stake weights output link if available, otherwise log a warning and zero out the structure.
    - Set up the snapshot output link if available, otherwise log a warning and zero out the structure.
    - Log the status of the `enable_publish_stake_weights` flag from the tile configuration.
    - Query and join the root slot object ID to set up the manifest watermark if available, otherwise log an error.
    - Initialize banks and set the bank slot to zero, logging an error if initialization fails.
    - Copy the manifest path from the tile configuration and initialize the manifest and shared scratchpads.
    - Join the allocator and log an error if joining fails.
    - Initialize file handlers for CSV and binary files, writing headers to CSV files and logging errors if writing fails.
- **Output**: No return value; the function operates by side effects on the provided `topo` and `tile` structures.
- **Functions Called**:
    - [`manifest_bank_align`](<#manifest_bank_align>)
    - [`manifest_bank_footprint`](<#manifest_bank_footprint>)
    - [`manifest_spad_max_alloc_align`](<#manifest_spad_max_alloc_align>)
    - [`manifest_spad_max_alloc_footprint`](<#manifest_spad_max_alloc_footprint>)
    - [`shared_spad_max_alloc_align`](<#shared_spad_max_alloc_align>)
    - [`shared_spad_max_alloc_footprint`](<#shared_spad_max_alloc_footprint>)
    - [`scratch_align`](<#scratch_align>)
    - [`init_file_handlers`](<#init_file_handlers>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)