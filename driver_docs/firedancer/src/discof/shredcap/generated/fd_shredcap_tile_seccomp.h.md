<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines a seccomp filter policy for syscall access control based on architecture and file descriptors.

# Purpose
The code is a C header file that defines a seccomp (secure computing mode) filter policy for a specific application. It is generated automatically and should not be edited manually. The file includes necessary headers for seccomp and related Linux kernel functionalities, such as `linux/audit.h`, `linux/seccomp.h`, and others. The code defines architecture-specific constants to ensure compatibility with the runtime architecture, supporting `i386`, `x86_64`, and `aarch64` architectures.

The main functionality of the code is encapsulated in the [`populate_sock_filter_policy_fd_shredcap_tile`](<#populate_sock_filter_policy_fd_shredcap_tile>) function. This function initializes a Berkeley Packet Filter (BPF) program that enforces a security policy by allowing or denying specific system calls based on predefined rules. The filter checks the architecture and syscall numbers, allowing only certain syscalls like `write` and `fsync` if they meet specific conditions. If the conditions are not met, the process is terminated using `SECCOMP_RET_KILL_PROCESS`. The function uses `fd_memcpy` to copy the filter rules into the provided output buffer. This header file is intended to be included in other C source files where the seccomp filter policy is required.
# Imports and Dependencies

---
- `../../../../src/util/fd_util_base.h`
- `linux/audit.h`
- `linux/capability.h`
- `linux/filter.h`
- `linux/seccomp.h`
- `linux/bpf.h`
- `sys/syscall.h`
- `signal.h`
- `stddef.h`


# Global Variables

---
### sock\_filter\_policy\_fd\_shredcap\_tile\_instr\_cnt
- **Type**: ``unsigned int``
- **Description**: Defines the number of instructions in the socket filter policy for the `fd_shredcap_tile` component. This constant is used to ensure that the correct number of instructions are processed in the filter.
- **Use**: Used to verify the count of instructions in the `populate_sock_filter_policy_fd_shredcap_tile` function.


# Functions

---
### populate\_sock\_filter\_policy\_fd\_shredcap\_tile<!-- {{#callable:populate_sock_filter_policy_fd_shredcap_tile}} -->
[View Source →](<../../../../../../src/discof/shredcap/generated/fd_shredcap_tile_seccomp.h#L26>)

Populates a `sock_filter` array with a seccomp filter policy to control system call access based on file descriptors.
- **Inputs**:
    - `out_cnt`: The number of elements in the `out` array, expected to be at least 22.
    - `out`: A pointer to a `sock_filter` array where the filter policy will be stored.
    - `logfile_fd`: The file descriptor for the log file, used in syscall checks.
    - `shreds_fd`: The file descriptor for shreds, used in syscall checks.
    - `requests_fd`: The file descriptor for requests, used in syscall checks.
    - `fec_fd`: The file descriptor for FEC, used in syscall checks.
    - `peers_fd`: The file descriptor for peers, used in syscall checks.
- **Logic and Control Flow**:
    - Check if `out_cnt` is at least 22, using `FD_TEST` macro.
    - Define a `sock_filter` array `filter` with 22 elements to specify the seccomp filter policy.
    - Load the architecture from `seccomp_data` and compare it with `ARCH_NR`; jump to `RET_KILL_PROCESS` if they do not match.
    - Load the syscall number and check if it is `SYS_write` or `SYS_fsync`; if not, jump to `RET_KILL_PROCESS`.
    - For `SYS_write`, load the first syscall argument and compare it with various file descriptors (`2`, `shreds_fd`, `requests_fd`, `logfile_fd`, `fec_fd`, `peers_fd`); allow the syscall if any match, otherwise jump to `RET_KILL_PROCESS`.
    - For `SYS_fsync`, load the first syscall argument and compare it with `logfile_fd`; allow the syscall if it matches, otherwise jump to `RET_KILL_PROCESS`.
    - Copy the `filter` array to the `out` array using `fd_memcpy`.
- **Output**: The `out` array is populated with a seccomp filter policy that allows or kills processes based on syscall numbers and file descriptor checks.



---
Made with ❤️ by [Driver](https://www.driver.ai/)