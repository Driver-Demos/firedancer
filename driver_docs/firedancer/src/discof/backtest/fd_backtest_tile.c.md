<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a backtest tile for processing and replaying data using RocksDB, handling shreds, and managing slots.

# Purpose
The code is a C module that implements a backtesting system for a distributed ledger using RocksDB as a storage backend. It is designed to simulate the processing of ledger data, specifically focusing on the handling of "shreds" and "slots," which are components of the ledger's data structure. The module defines several structures, such as `fd_backt_in_t`, `fd_backt_out_t`, and `fd_backt_tile_t`, which manage input and output data buffers, as well as the state of the backtesting process. The code includes functions for initializing the backtesting environment, processing ledger data, and handling various events during the backtest, such as the completion of slots and the publication of results.

The module is part of a larger system, as indicated by the inclusion of headers from other components like `fd_store.h`, `fd_metrics.h`, and `fd_replay_tile.h`. It defines a set of constants and macros to manage buffer sizes and input types. The code also includes callback functions for handling credit events and fragment processing, which are integrated into a larger framework using the `fd_stem.c` module. The `fd_tile_backtest` structure at the end of the file provides an interface for running the backtest tile within the system, specifying functions for initialization and execution. This module is intended to be part of a larger application, likely involving multiple tiles and components working together to simulate and analyze ledger data.
# Imports and Dependencies

---
- `fd_backtest_rocksdb.h`
- `../../disco/store/fd_store.h`
- `../../disco/metrics/fd_metrics.h`
- `../../discof/replay/fd_replay_tile.h`
- `../../discof/restore/utils/fd_ssmsg.h`
- `../../discof/tower/fd_tower_tile.h`
- `../../util/pod/fd_pod.h`
- `stdlib.h`
- `../../disco/stem/fd_stem.c`


# Global Variables

---
### fd\_tile\_backtest
- **Type**: ``fd_topo_run_tile_t``
- **Description**: Defines a `fd_topo_run_tile_t` structure named `fd_tile_backtest`. This structure is initialized with specific function pointers and parameters for managing a backtest tile in a topology.
- **Use**: Used to configure and manage the execution of a backtest tile within a larger system topology.


# Data Structures

---
### fd\_backt\_in
- **Type**: ``struct``
- **Members**:
    - ``mem``: Pointer to a `fd_wksp_t` workspace.
    - ``chunk0``: Initial chunk index in the workspace.
    - ``wmark``: Watermark for the workspace.
    - ``mtu``: Maximum transmission unit size.
- **Description**: The `fd_backt_in` structure is used to manage input data in a workspace for backtesting operations. It includes a pointer to a workspace, an initial chunk index, a watermark to track data usage, and a maximum transmission unit size to define the largest data packet that can be processed.


---
### fd\_backt\_in\_t
- **Type**: ``struct``
- **Members**:
    - ``mem``: A pointer to an `fd_wksp_t` structure, representing a memory workspace.
    - ``chunk0``: An unsigned long integer representing the initial chunk index.
    - ``wmark``: An unsigned long integer representing the watermark for the data.
    - ``mtu``: An unsigned long integer representing the maximum transmission unit.
- **Description**: The `fd_backt_in_t` structure is used to manage input data in a backtest environment. It contains a pointer to a memory workspace (`mem`), and several unsigned long integers (`chunk0`, `wmark`, and `mtu`) that manage data chunking and transmission parameters. This structure is part of a larger system that processes data in a backtest simulation, ensuring data is correctly chunked and transmitted within defined limits.


---
### fd\_backt\_out
- **Type**: ``struct``
- **Members**:
    - ``idx``: An unsigned long integer that likely serves as an index or identifier.
    - ``mem``: A pointer to an `fd_wksp_t` structure, representing a memory workspace.
    - ``chunk0``: An unsigned long integer representing the initial chunk or offset in the memory workspace.
    - ``wmark``: An unsigned long integer representing a watermark or limit in the memory workspace.
    - ``chunk``: An unsigned long integer representing the current chunk or offset in the memory workspace.
- **Description**: The `fd_backt_out` structure is used to manage output data related to memory workspaces in a backtesting context. It includes an index, a pointer to a memory workspace, and several unsigned long integers that track the initial and current chunks, as well as a watermark within the workspace. This structure is likely used to facilitate data output operations in a backtesting system.


---
### fd\_backt\_out\_t
- **Type**: ``struct``
- **Members**:
    - ``idx``: Index of the output link.
    - ``mem``: Pointer to the workspace memory.
    - ``chunk0``: Initial chunk index in the workspace.
    - ``wmark``: Watermark for the workspace.
    - ``chunk``: Current chunk index in the workspace.
- **Description**: `fd_backt_out_t` is a structure that manages output data in a workspace. It includes an index to identify the output link, a pointer to the workspace memory, and chunk indices to track the data's position and watermark within the workspace.


---
### fd\_backt\_tile
- **Type**: ``struct``
- **Members**:
    - ``initialized``: Indicates if the snapshot load is complete and processing can start.
    - ``genesis``: Indicates if the genesis state is set.
    - ``snapshot_done``: Indicates if the snapshot load is complete.
    - ``rocksdb``: Pointer to a `fd_backtest_rocksdb_t` structure for database operations.
    - ``prev_slot``: Stores the previous slot number.
    - ``prev_fec_set_idx``: Stores the previous FEC set index.
    - ``chained_prev_slot``: Stores the chained previous slot number.
    - ``chained_prev_fec_set_idx``: Stores the chained previous FEC set index.
    - ``start_slot``: Indicates the starting slot number for processing.
    - ``end_slot``: Indicates the ending slot number for processing.
    - ``reading_slot_cnt``: Counts the number of slots read.
    - ``reading_slot``: Indicates the current slot being read.
    - ``reading_shred_idx``: Index of the current shred being read.
    - ``reading_shred_cnt``: Counts the number of shreds read.
    - ``idle_cnt``: Counts the number of idle cycles.
    - ``prior_completion_timestamp``: Stores the timestamp of the prior completion.
    - ``replay_time``: Tracks the time taken for replay.
    - ``publish_time``: Tracks the time taken for publishing.
    - ``slot_cnt``: Counts the number of slots processed.
    - ``store``: Pointer to a `fd_store_t` structure for storage operations.
    - ``in_kind``: Array indicating the kind of input for each input link.
    - ``in``: Array of `fd_backt_in_t` structures for input management.
    - ``shred_out``: Array of `fd_backt_out_t` structures for shred output.
    - ``tower_out``: Array of `fd_backt_out_t` structures for tower output.
    - ``shreds_idx``: Index for the current shred in the buffer.
    - ``shreds_cnt``: Count of shreds in the buffer.
    - ``shreds``: Buffer for storing shreds.
    - ``bank_hash_idx``: Index for the current bank hash in the buffer.
    - ``bank_hash_cnt``: Count of bank hashes in the buffer.
    - ``bank_hashes``: Buffer for storing bank hashes.
- **Description**: Manages the state and operations for a backtest tile, including handling of slots, shreds, and bank hashes, as well as interfacing with RocksDB and storage systems. It ensures proper sequencing and processing of data fragments, preventing race conditions during snapshot loading and replay operations.


---
### fd\_backt\_tile\_t
- **Type**: ``struct``
- **Members**:
    - ``initialized``: Indicates if the snapshot load is complete and the tile is ready to process replay fragments.
    - ``genesis``: Indicates if the tile is in the genesis state.
    - ``snapshot_done``: Indicates if the snapshot load is complete.
    - ``rocksdb``: Pointer to the `fd_backtest_rocksdb_t` structure for database operations.
    - ``prev_slot``: Stores the previous slot number processed.
    - ``prev_fec_set_idx``: Stores the previous FEC set index processed.
    - ``chained_prev_slot``: Stores the chained previous slot number.
    - ``chained_prev_fec_set_idx``: Stores the chained previous FEC set index.
    - ``start_slot``: Indicates the starting slot number for processing.
    - ``end_slot``: Indicates the ending slot number for processing.
    - ``reading_slot_cnt``: Counts the number of slots read.
    - ``reading_slot``: Indicates the current slot being read.
    - ``reading_shred_idx``: Index of the current shred being read.
    - ``reading_shred_cnt``: Counts the number of shreds read.
    - ``idle_cnt``: Counts the number of idle cycles.
    - ``prior_completion_timestamp``: Stores the timestamp of the prior completion.
    - ``replay_time``: Tracks the time taken for replay operations.
    - ``publish_time``: Tracks the time taken for publishing operations.
    - ``slot_cnt``: Counts the number of slots processed.
    - ``store``: Pointer to the `fd_store_t` structure for storage operations.
    - ``in_kind``: Array indicating the kind of input for each input link.
    - ``in``: Array of `fd_backt_in_t` structures representing input links.
    - ``shred_out``: Array of `fd_backt_out_t` structures for shred output.
    - ``tower_out``: Array of `fd_backt_out_t` structures for tower output.
    - ``shreds_idx``: Index for the current position in the shreds buffer.
    - ``shreds_cnt``: Counts the number of shreds in the buffer.
    - ``shreds``: Buffer to store shreds with a maximum size defined by `SHRED_BUFFER_LEN`.
    - ``bank_hash_idx``: Index for the current position in the bank hashes buffer.
    - ``bank_hash_cnt``: Counts the number of bank hashes in the buffer.
    - ``bank_hashes``: Buffer to store bank hashes with a maximum size defined by `BANK_HASH_BUFFER_LEN`.
- **Description**: Represents a backtest tile structure used in a simulation environment to process and manage data related to slots, shreds, and bank hashes. It handles the initialization, processing, and completion of replay and snapshot operations, and manages input and output links for data flow. The structure maintains various counters and flags to track the state and progress of the backtest operations.


# Functions

---
### scratch\_align<!-- {{#callable:scratch_align}} -->
[View Source →](<../../../../../src/discof/backtest/fd_backtest_tile.c#L92>)

Returns a constant alignment value of 128.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the constant value `128UL`.
- **Output**: The function returns an unsigned long integer with the value `128UL`.


---
### scratch\_footprint<!-- {{#callable:scratch_footprint}} -->
[View Source →](<../../../../../src/discof/backtest/fd_backtest_tile.c#L97>)

Calculates the memory footprint required for a scratch space based on the alignment and size of `fd_backt_tile_t` and RocksDB components.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure, which is not used in the function.
- **Logic and Control Flow**:
    - Initialize `l` with `FD_LAYOUT_INIT`.
    - Append the layout of `fd_backt_tile_t` to `l` using `FD_LAYOUT_APPEND` with its alignment and size.
    - Append the layout of RocksDB components to `l` using `FD_LAYOUT_APPEND` with their alignment and footprint.
    - Finalize the layout with `FD_LAYOUT_FINI` using the alignment from `scratch_align()`.
- **Output**: Returns an `ulong` representing the total memory footprint required for the scratch space.
- **Functions Called**:
    - [`fd_backtest_rocksdb_align`](<fd_backtest_rocksdb.c.md#fd_backtest_rocksdb_align>)
    - [`fd_backtest_rocksdb_footprint`](<fd_backtest_rocksdb.c.md#fd_backtest_rocksdb_footprint>)
    - [`scratch_align`](<#scratch_align>)


---
### before\_credit<!-- {{#callable:before_credit}} -->
[View Source →](<../../../../../src/discof/backtest/fd_backtest_tile.c#L106>)

Checks various conditions and updates the context for processing shreds in a backtest environment.
- **Inputs**:
    - `ctx`: A pointer to a `fd_backt_tile_t` structure that holds the context for the backtest tile.
    - `stem`: A pointer to a `fd_stem_context_t` structure, which is not used in this function.
    - `charge_busy`: A pointer to an integer that indicates if the function has set the context to busy.
- **Logic and Control Flow**:
    - If `ctx->initialized` is false, return immediately.
    - If `ctx->snapshot_done` is false, return immediately.
    - Increment `ctx->idle_cnt`.
    - If `ctx->idle_cnt` is less than or equal to 1, return.
    - If `ctx->reading_slot` is greater than `ctx->end_slot`, return.
    - If `ctx->shreds_cnt` equals `SHRED_BUFFER_LEN`, return.
    - If `*stem->min_cr_avail` is less than 128, return.
    - If `ctx->reading_slot_cnt - ctx->slot_cnt` is greater than or equal to 30, return.
    - Set `*charge_busy` to 1.
    - If `ctx->reading_shred_cnt` equals `ctx->reading_shred_idx`, check if `ctx->bank_hash_cnt` equals `BANK_HASH_BUFFER_LEN` and return if true.
    - Call [`fd_backtest_rocksdb_next_root_slot`](<fd_backtest_rocksdb.c.md#fd_backtest_rocksdb_next_root_slot>) to get the next root slot and update `ctx->reading_slot` and `ctx->reading_shred_cnt`.
    - If the call to [`fd_backtest_rocksdb_next_root_slot`](<fd_backtest_rocksdb.c.md#fd_backtest_rocksdb_next_root_slot>) fails, set `ctx->reading_slot` to `ctx->end_slot + 1`.
    - If `ctx->reading_slot` is greater than `ctx->end_slot`, return.
    - Increment `ctx->reading_slot_cnt` and reset `ctx->reading_shred_idx` to 0.
    - Get the bank hash for the current slot and copy it to `ctx->bank_hashes`.
    - Increment `ctx->bank_hash_cnt`.
    - Get the shred for the current slot and index, and copy it to `ctx->shreds`.
    - Increment `ctx->reading_shred_idx` and `ctx->shreds_cnt`.
- **Output**: No return value; updates the `ctx` and `charge_busy` based on the conditions checked.
- **Functions Called**:
    - [`fd_backtest_rocksdb_next_root_slot`](<fd_backtest_rocksdb.c.md#fd_backtest_rocksdb_next_root_slot>)
    - [`fd_backtest_rocksdb_bank_hash`](<fd_backtest_rocksdb.c.md#fd_backtest_rocksdb_bank_hash>)
    - [`fd_backtest_rocksdb_shred`](<fd_backtest_rocksdb.c.md#fd_backtest_rocksdb_shred>)


---
### after\_credit<!-- {{#callable:after_credit}} -->
[View Source →](<../../../../../src/discof/backtest/fd_backtest_tile.c#L145>)

Processes shreds in a backtest tile, updating context and publishing completed FEC sets.
- **Inputs**:
    - ``ctx``: A pointer to a `fd_backt_tile_t` structure representing the context of the backtest tile.
    - ``stem``: A pointer to a `fd_stem_context_t` structure used for publishing.
    - ``opt_poll_in``: An optional pointer to an integer, not used in this function.
    - ``charge_busy``: A pointer to an integer that indicates if the function has performed work.
- **Logic and Control Flow**:
    - Check if there are at least two shreds or if the reading slot is beyond the end slot with remaining shreds; if not, return.
    - Check if the store root is valid; if not, return.
    - Set `*charge_busy` to 1 and reset `ctx->idle_cnt` to 0.
    - Retrieve the current and next shreds from the context's shred buffer.
    - Determine if the current shred completes a slot or FEC set.
    - Overwrite the Merkle root and chained Merkle root with slot numbers and FEC set index if necessary.
    - Query the store for the FEC set and append the shred's payload to it.
    - Update the context's shred index and count, and previous slot and FEC set index.
    - If the FEC set is complete, prepare and publish a completion message with Merkle roots.
    - Update the context's output chunk and publish time if necessary.
- **Output**: No return value; updates the context and publishes completed FEC sets.


---
### returnable\_frag<!-- {{#callable:returnable_frag}} -->
[View Source →](<../../../../../src/discof/backtest/fd_backtest_tile.c#L222>)

Processes different types of input signals to manage the state of a backtest tile, including initializing, replaying, and handling snapshots.
- **Inputs**:
    - ``ctx``: A pointer to a `fd_backt_tile_t` structure representing the context of the backtest tile.
    - ``in_idx``: An index indicating which input kind to process from the `ctx->in_kind` array.
    - ``seq``: A sequence number, which is not used in the function.
    - ``sig``: A signal value used to determine the type of message or event, such as `FD_SSMSG_DONE` or `REPLAY_SIG_SLOT_COMPLETED`.
    - ``chunk``: An index or identifier for a specific chunk of data in the input memory.
    - ``sz``: The size of the data, which is not used in the function.
    - ``ctl``: A control value, which is not used in the function.
    - ``tsorig``: The original timestamp, which is not used in the function.
    - ``tspub``: The publication timestamp used when publishing data.
    - ``stem``: A pointer to a `fd_stem_context_t` structure used for publishing data.
- **Logic and Control Flow**:
    - Ignores `seq`, `sz`, `ctl`, and `tsorig` as they are not used in the function.
    - Checks the input kind using `ctx->in_kind[in_idx]` and processes based on the type: `IN_KIND_SNAP`, `IN_KIND_GENESI`, or `IN_KIND_REPLAY`.
    - For `IN_KIND_SNAP`, if the signal indicates `FD_SSMSG_DONE`, it sets `ctx->snapshot_done` to 1 and initializes replay and publish times.
    - For `IN_KIND_GENESI`, if `ctx->genesis` is true, it initializes the context and sets `ctx->snapshot_done` to 1.
    - For `IN_KIND_REPLAY`, it checks if the signal is `REPLAY_SIG_SLOT_COMPLETED` and if the context is initialized; if not, it returns early.
    - Processes replay completion messages, updating timestamps, bank hashes, and slot counts, and logs notices or errors based on bank hash matches.
    - If the replayed slot is greater than or equal to `ctx->end_slot`, it logs completion and exits the program.
    - Publishes a `fd_tower_slot_done_t` message using `fd_stem_publish` and updates the chunk index for the next message.
    - Logs an error and exits if the input kind is unhandled.
- **Output**: Returns 0 on successful processing or early exit conditions, and 1 if the context is not initialized during replay processing.
- **Functions Called**:
    - [`fd_backtest_rocksdb_init`](<fd_backtest_rocksdb.c.md#fd_backtest_rocksdb_init>)


---
### out1<!-- {{#callable:out1}} -->
[View Source →](<../../../../../src/discof/backtest/fd_backtest_tile.c#L324>)

Finds and returns the output link information for a given link name in a topology tile.
- **Inputs**:
    - `topo`: A pointer to a `fd_topo_t` structure representing the topology.
    - `tile`: A pointer to a `fd_topo_tile_t` structure representing the tile within the topology.
    - `name`: A string representing the name of the output link to find.
- **Logic and Control Flow**:
    - Initialize `idx` to `ULONG_MAX` to track the index of the matching link.
    - Iterate over the output links of the tile using a loop from 0 to `tile->out_cnt`.
    - For each link, retrieve the link information from `topo->links` using the link ID from `tile->out_link_id`.
    - Compare the link's name with the input `name` using `strcmp`.
    - If a match is found and `idx` is not `ULONG_MAX`, log an error indicating multiple links with the same name.
    - If a match is found and `idx` is `ULONG_MAX`, set `idx` to the current index.
    - After the loop, if `idx` is still `ULONG_MAX`, log an error indicating no link was found with the given name.
    - Retrieve the memory workspace, chunk0, and watermark for the link using the topology and link information.
    - Return a `fd_backt_out_t` structure with the found index, memory workspace, chunk0, watermark, and chunk.
- **Output**: A `fd_backt_out_t` structure containing the index, memory workspace, chunk0, watermark, and chunk for the found output link.


---
### unprivileged\_init<!-- {{#callable:unprivileged_init}} -->
[View Source →](<../../../../../src/discof/backtest/fd_backtest_tile.c#L347>)

Initializes the unprivileged context for a backtest tile by setting up memory allocations, initializing context fields, and configuring input and output links.
- **Inputs**:
    - ``topo``: A pointer to an `fd_topo_t` structure representing the topology configuration.
    - ``tile``: A pointer to an `fd_topo_tile_t` structure representing the tile configuration.
- **Logic and Control Flow**:
    - Allocate scratch memory using `fd_topo_obj_laddr` and initialize it with `FD_SCRATCH_ALLOC_INIT`.
    - Allocate and append memory for `fd_backt_tile_t` and RocksDB using `FD_SCRATCH_ALLOC_APPEND`.
    - Initialize context fields such as `snapshot_done`, `initialized`, `genesis`, `idle_cnt`, `end_slot`, and others to default values.
    - Join the RocksDB instance using [`fd_backtest_rocksdb_join`](<fd_backtest_rocksdb.c.md#fd_backtest_rocksdb_join>) and [`fd_backtest_rocksdb_new`](<fd_backtest_rocksdb.c.md#fd_backtest_rocksdb_new>).
    - Query the store object ID using `fd_pod_query_ulong` and join the store using `fd_store_join`.
    - Verify the number of input links does not exceed the context's input array size.
    - Iterate over input links, configure memory, chunk, watermark, and MTU for each link, and set the input kind based on the link name.
    - Configure output links `shred_out` and `tower_out` using the [`out1`](<#out1>) function.
    - Finalize scratch memory allocation with `FD_SCRATCH_ALLOC_FINI` and check for overflow.
- **Output**: No return value; the function initializes the context for further operations.
- **Functions Called**:
    - [`fd_backtest_rocksdb_align`](<fd_backtest_rocksdb.c.md#fd_backtest_rocksdb_align>)
    - [`fd_backtest_rocksdb_footprint`](<fd_backtest_rocksdb.c.md#fd_backtest_rocksdb_footprint>)
    - [`fd_backtest_rocksdb_join`](<fd_backtest_rocksdb.c.md#fd_backtest_rocksdb_join>)
    - [`fd_backtest_rocksdb_new`](<fd_backtest_rocksdb.c.md#fd_backtest_rocksdb_new>)
    - [`out1`](<#out1>)
    - [`scratch_footprint`](<#scratch_footprint>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)