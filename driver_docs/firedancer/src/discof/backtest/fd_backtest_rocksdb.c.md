<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for managing and querying a read-only RocksDB database for backtesting purposes.

# Purpose
The code is a C module that interfaces with a RocksDB database to perform backtesting operations. It provides functions to initialize, access, and iterate over data stored in a RocksDB instance. The module is designed to work with a specific database schema that includes column families such as "default", "root", "meta", "data_shred", and "bank_hashes". The primary operations include opening a RocksDB database in read-only mode, iterating over root slots, retrieving metadata and shreds, and accessing bank hashes.

The module defines a private structure `fd_backtest_rocksdb_private` to manage the database connection and associated resources. It includes functions like [`fd_backtest_rocksdb_new`](<#fd_backtest_rocksdb_new>) to create a new database instance, [`fd_backtest_rocksdb_join`](<#fd_backtest_rocksdb_join>) to join an existing instance, and [`fd_backtest_rocksdb_init`](<#fd_backtest_rocksdb_init>) to initialize the iterator for root slots. The functions [`fd_backtest_rocksdb_next_root_slot`](<#fd_backtest_rocksdb_next_root_slot>), [`fd_backtest_rocksdb_shred`](<#fd_backtest_rocksdb_shred>), and [`fd_backtest_rocksdb_bank_hash`](<#fd_backtest_rocksdb_bank_hash>) provide mechanisms to navigate and retrieve specific data from the database. The module uses RocksDB's C API to perform these operations and includes error handling to ensure the integrity of the database interactions.
# Imports and Dependencies

---
- `fd_backtest_rocksdb.h`
- `../../ballet/shred/fd_shred.h`
- `../../flamenco/types/fd_types.h`
- `rocksdb/c.h`
- `../../../opt/include/rocksdb/c.h`


# Data Structures

---
### fd\_backtest\_rocksdb\_private
- **Type**: ``struct``
- **Members**:
    - `db`: Pointer to a RocksDB database instance.
    - `readoptions`: Pointer to RocksDB read options.
    - `iter_root`: Pointer to a RocksDB iterator for the root column family.
    - `cfs`: Array of pointers to RocksDB column family handles.
    - `magic`: Unsigned long integer used for validation or identification.
- **Description**: Encapsulates the private data and configuration for interacting with a RocksDB database in a backtesting context. It includes pointers to the database, read options, an iterator for navigating the root column family, and handles for multiple column families. The `magic` field is used to ensure the integrity or validity of the structure.


# Functions

---
### fd\_backtest\_rocksdb\_align<!-- {{#callable:fd_backtest_rocksdb_align}} -->
[View Source →](<../../../../../src/discof/backtest/fd_backtest_rocksdb.c#L24>)

Returns the alignment requirement of the `fd_backtest_rocksdb_t` type.
- **Inputs**: None
- **Logic and Control Flow**:
    - Uses the `alignof` operator to determine the alignment requirement of the `fd_backtest_rocksdb_t` type.
    - Returns the alignment value as an unsigned long integer.
- **Output**: An unsigned long integer representing the alignment requirement of the `fd_backtest_rocksdb_t` type.


---
### fd\_backtest\_rocksdb\_footprint<!-- {{#callable:fd_backtest_rocksdb_footprint}} -->
[View Source →](<../../../../../src/discof/backtest/fd_backtest_rocksdb.c#L29>)

Returns the size of the `fd_backtest_rocksdb_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calculate the size of the `fd_backtest_rocksdb_t` structure using the `sizeof` operator.
    - Return the calculated size.
- **Output**: The function returns an `ulong` representing the size of the `fd_backtest_rocksdb_t` structure.


---
### fd\_backtest\_rocksdb\_new<!-- {{#callable:fd_backtest_rocksdb_new}} -->
[View Source →](<../../../../../src/discof/backtest/fd_backtest_rocksdb.c#L34>)

Initializes a RocksDB instance for read-only access using shared memory and a specified path.
- **Inputs**:
    - `shmem`: A pointer to shared memory where the RocksDB instance will be initialized.
    - `path`: A constant character pointer to the file path for the RocksDB database.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL; if so, log a warning and return NULL.
    - Check if `shmem` is aligned according to [`fd_backtest_rocksdb_align`](<#fd_backtest_rocksdb_align>); if not, log a warning and return NULL.
    - Cast `shmem` to a `fd_backtest_rocksdb_t` pointer named `db`.
    - Define an array `cf_names` with column family names for the database.
    - Create RocksDB options using `rocksdb_options_create`.
    - Define an array `cf_options` with the same options for each column family.
    - Attempt to open the RocksDB database in read-only mode with column families using `rocksdb_open_for_read_only_column_families`; if an error occurs, log it and terminate the program.
    - Create read options for the database using `rocksdb_readoptions_create`.
    - Create an iterator for the 'root' column family using `rocksdb_create_iterator_cf`.
    - Set the `magic` field of `db` to `FD_BACKTEST_ROCKSDB_MAGIC` using memory fences for thread safety.
    - Return the initialized `db` pointer.
- **Output**: A pointer to the initialized `fd_backtest_rocksdb_t` structure, or NULL if initialization fails.
- **Functions Called**:
    - [`fd_backtest_rocksdb_align`](<#fd_backtest_rocksdb_align>)


---
### fd\_backtest\_rocksdb\_join<!-- {{#callable:fd_backtest_rocksdb_join}} -->
[View Source →](<../../../../../src/discof/backtest/fd_backtest_rocksdb.c#L92>)

Validates and returns a pointer to a `fd_backtest_rocksdb_t` structure if the input shared memory block is correctly aligned and initialized.
- **Inputs**:
    - `shdb`: A pointer to a shared memory block that is expected to contain a `fd_backtest_rocksdb_t` structure.
- **Logic and Control Flow**:
    - Check if `shdb` is NULL; if so, log a warning and return NULL.
    - Check if `shdb` is aligned according to `fd_backtest_rocksdb_align()`; if not, log a warning and return NULL.
    - Cast `shdb` to a `fd_backtest_rocksdb_t` pointer and store it in `db`.
    - Check if `db->magic` equals `FD_BACKTEST_ROCKSDB_MAGIC`; if not, log a warning and return NULL.
    - Return the `db` pointer.
- **Output**: A pointer to a `fd_backtest_rocksdb_t` structure if all checks pass, otherwise NULL.
- **Functions Called**:
    - [`fd_backtest_rocksdb_align`](<#fd_backtest_rocksdb_align>)


---
### fd\_backtest\_rocksdb\_init<!-- {{#callable:fd_backtest_rocksdb_init}} -->
[View Source →](<../../../../../src/discof/backtest/fd_backtest_rocksdb.c#L114>)

Initializes a RocksDB iterator to a specific root slot in a backtest database.
- **Inputs**:
    - ``db``: A pointer to an `fd_backtest_rocksdb_t` structure representing the backtest database.
    - ``root_slot``: An unsigned long integer representing the root slot to seek in the database.
- **Logic and Control Flow**:
    - Convert `root_slot` to big-endian format using `fd_ulong_bswap` and store it in `key`.
    - Use `rocksdb_iter_seek` to position the iterator `db->iter_root` at the key corresponding to `key`.
    - Verify that the iterator is valid using `FD_TEST` and `rocksdb_iter_valid`.
- **Output**: No return value; the function modifies the state of the `db` iterator.


---
### fd\_backtest\_rocksdb\_next\_root\_slot<!-- {{#callable:fd_backtest_rocksdb_next_root_slot}} -->
[View Source →](<../../../../../src/discof/backtest/fd_backtest_rocksdb.c#L123>)

Retrieves the next root slot and its associated shred count from a RocksDB iterator.
- **Inputs**:
    - ``db``: A pointer to an `fd_backtest_rocksdb_t` structure representing the database context.
    - ``root_slot``: A pointer to an `ulong` where the function will store the next root slot value.
    - ``shred_cnt``: A pointer to an `ulong` where the function will store the shred count associated with the root slot.
- **Logic and Control Flow**:
    - Advance the RocksDB iterator `db->iter_root` to the next entry.
    - Check if the iterator is valid; if not, return 0 to indicate no more entries.
    - Retrieve the key from the current iterator position and determine its length.
    - Use the key to fetch the slot metadata from the 'meta' column family in the database.
    - Check for errors during the fetch operation and log an error if any occur.
    - Initialize a decoding context with the fetched slot metadata.
    - Decode the footprint of the slot metadata to determine the total size required for decoding.
    - Allocate memory for the slot metadata using `fd_alloca_check`.
    - Decode the slot metadata into a `fd_slot_meta_t` structure.
    - Store the slot and received shred count from the decoded metadata into `root_slot` and `shred_cnt`, respectively.
    - Return 1 to indicate successful retrieval of the next root slot.
- **Output**: Returns 1 if a new root slot and shred count are successfully retrieved, otherwise returns 0 if no more entries are available.


---
### fd\_backtest\_rocksdb\_shred<!-- {{#callable:fd_backtest_rocksdb_shred}} -->
[View Source →](<../../../../../src/discof/backtest/fd_backtest_rocksdb.c#L155>)

Retrieves a shred from a RocksDB database using a specified slot and shred index.
- **Inputs**:
    - ``db``: A pointer to an `fd_backtest_rocksdb_t` structure representing the database context.
    - ``slot``: An unsigned long integer representing the slot number to query.
    - ``shred_idx``: An unsigned long integer representing the index of the shred within the slot to query.
- **Logic and Control Flow**:
    - Create a 16-byte key by storing the byte-swapped `slot` and `shred_idx` values into the key array.
    - Call `rocksdb_get_cf` to retrieve the shred data from the column family at index 3 using the constructed key.
    - Check if there is an error during the retrieval; if so, log the error and terminate the program.
    - Verify that the length of the retrieved data does not exceed `FD_SHRED_MAX_SZ`.
    - Parse the retrieved shred data using `fd_shred_parse` to ensure it is valid.
- **Output**: Returns a pointer to the retrieved shred data as a constant character pointer.


---
### fd\_backtest\_rocksdb\_bank\_hash<!-- {{#callable:fd_backtest_rocksdb_bank_hash}} -->
[View Source →](<../../../../../src/discof/backtest/fd_backtest_rocksdb.c#L173>)

Retrieves and decodes the frozen hash for a given slot from a RocksDB database.
- **Inputs**:
    - ``db``: A pointer to an `fd_backtest_rocksdb_t` structure representing the RocksDB database.
    - ``slot``: An unsigned long integer representing the slot number for which the frozen hash is retrieved.
- **Logic and Control Flow**:
    - Convert the `slot` number to a byte-swapped format and store it in the `key` array.
    - Use `rocksdb_get_cf` to retrieve the frozen hash associated with the `slot` from the `bank_hashes` column family in the database.
    - Check for errors during the retrieval process and log an error message if any occur.
    - Initialize a `fd_bincode_decode_ctx_t` structure to decode the retrieved frozen hash data.
    - Calculate the total size required for decoding using `fd_frozen_hash_versioned_decode_footprint`.
    - Allocate memory for the decoded data using `fd_alloca_check`.
    - Decode the frozen hash data into a `fd_frozen_hash_versioned_t` structure using `fd_frozen_hash_versioned_decode`.
    - Return the `frozen_hash.uc` from the decoded structure.
- **Output**: Returns a pointer to an unsigned char array representing the decoded frozen hash.



---
Made with ❤️ by [Driver](https://www.driver.ai/)