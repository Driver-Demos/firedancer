<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements the policy for a Repair agent, including deduplication, peer management, and request strategies.

# Purpose
The code defines a C header file for implementing a repair policy agent, which is part of a larger system for managing data integrity and synchronization in a distributed network. The primary function of this code is to manage the repair requests for missing or incomplete data shreds in a distributed ledger system, such as Solana. The policy determines which data shreds are missing and need to be requested, and it selects the appropriate peer nodes from which to request these shreds. The policy uses a round-robin depth-first search (DFS) strategy with time-based deduplication to efficiently manage repair requests and avoid redundant requests within a specified time window.

Key components of the code include the `fd_policy_dedup` structure, which implements a deduplication cache to track and manage repair requests, and the `fd_policy_peers` structure, which manages peer nodes and their associated metadata, such as request and response counts, latency measurements, and stake information. The code also defines several functions for creating, joining, and managing the policy, as well as functions for selecting peers and updating request and response information. The header file includes several macros and inline functions to facilitate the management of deduplication keys and peer selection based on latency thresholds.
# Imports and Dependencies

---
- `../../flamenco/types/fd_types_custom.h`
- `../forest/fd_forest.h`
- `../../util/net/fd_net_headers.h`
- `fd_repair.h`
- `../../util/tmpl/fd_pool.c`
- `../../util/tmpl/fd_map_chain.c`
- `../../util/tmpl/fd_dlist.c`
- `../../util/tmpl/fd_map_dynamic.c`


# Global Variables

---
### bucket\_stages
- **Type**: ``uint[7]``
- **Description**: An array of unsigned integers that defines the stages of peer selection based on latency policies. The array contains seven elements, where the first element is `FD_POLICY_LATENCY_SLOW` and the remaining six elements are `FD_POLICY_LATENCY_FAST`. This configuration is used to cycle through peers, prioritizing those with faster response times.
- **Use**: Used to determine the frequency of selecting peers with different latency characteristics in the repair policy.


# Data Structures

---
### fd\_policy\_dedup\_t
- **Type**: ``struct``
- **Members**:
    - ``map``: Pointer to a map of dedup elements.
    - ``pool``: Pointer to a memory pool of dedup elements.
    - ``lru``: Pointer to a singly-linked list of dedup elements by insertion order.
- **Description**: Manages a deduplication cache for repair requests, using a map and linked list to track and evict the least recently used requests when the cache is full.


---
### fd\_policy\_dedup\_ele
- **Type**: ``struct``
- **Members**:
    - ``key``: Compact encoding of `fd_repair_req_t`.
    - ``prev``: Reserved for least recently used (LRU) operations.
    - ``next``: Reserved for LRU operations.
    - ``hash``: Reserved for pool and map chain operations.
    - ``req_ts``: Timestamp when the request was sent.
- **Description**: Represents an element in a deduplication cache for repair requests, using a compact key encoding to identify requests and fields reserved for LRU and hash operations.


---
### fd\_policy\_dedup\_ele\_t
- **Type**: ``struct``
- **Members**:
    - `key`: Compact encoding of `fd_repair_req_t`.
    - `prev`: Reserved by LRU (Least Recently Used) mechanism.
    - `next`: Reserved by LRU mechanism.
    - `hash`: Reserved by pool and map_chain.
    - `req_ts`: Timestamp when the request was sent.
- **Description**: Represents an element in the deduplication cache for repair requests, using a compact key encoding to identify requests and maintaining links for LRU management.


---
### fd\_policy\_dedup
- **Type**: ``struct``
- **Members**:
    - ``map``: Pointer to a map of deduplication elements.
    - ``pool``: Pointer to a memory pool of deduplication elements.
    - ``lru``: Pointer to a singly-linked list of deduplication elements by insertion order.
- **Description**: Manages a deduplication cache for repair requests, using a map and a linked list to track and evict the least recently used requests when the cache is full.


---
### fd\_policy\_peer
- **Type**: ``struct``
- **Members**:
    - ``key``: Public key of the validator, used as a map key.
    - ``hash``: Reserved for map operations.
    - ``ip4``: IPv4 address of the peer.
    - ``port``: Repair server port of the peer.
    - ``req_cnt``: Count of requests sent to this peer.
    - ``res_cnt``: Count of responses received from this peer.
    - ``first_req_ts``: Timestamp of the first request sent to this peer.
    - ``last_req_ts``: Timestamp of the last request sent to this peer.
    - ``first_resp_ts``: Timestamp of the first response received from this peer.
    - ``last_resp_ts``: Timestamp of the last response received from this peer.
    - ``total_lat``: Total round-trip time over all responses in nanoseconds.
    - ``stake``: Stake value associated with the peer.
    - ``pool_idx``: Index in the pool for this peer.
- **Description**: Represents a peer validator that serves repairs, discovered through gossip, with fields for tracking network and performance metrics such as request and response counts, timestamps, and latency.


---
### fd\_policy\_peer\_t
- **Type**: ``struct``
- **Members**:
    - ``key``: Public key of the validator, used as a map key.
    - ``hash``: Reserved for map operations.
    - ``ip4``: IPv4 address of the peer.
    - ``port``: Repair server port of the peer.
    - ``req_cnt``: Count of requests sent to this peer.
    - ``res_cnt``: Count of responses received from this peer.
    - ``first_req_ts``: Timestamp of the first request sent to this peer.
    - ``last_req_ts``: Timestamp of the last request sent to this peer.
    - ``first_resp_ts``: Timestamp of the first response received from this peer.
    - ``last_resp_ts``: Timestamp of the last response received from this peer.
    - ``total_lat``: Total round-trip time over all responses in nanoseconds.
    - ``stake``: Stake value associated with the peer.
    - ``pool_idx``: Index in the pool for this peer.
- **Description**: Represents a peer validator that serves repairs, discovered through gossip messages containing the validator's IP and repair server port. It tracks request and response counts, timestamps for the first and last requests and responses, total latency, and stake information. The structure is used in the context of a repair policy to manage and select peers for repair requests.


---
### fd\_peer
- **Type**: ``struct``
- **Members**:
    - ``identity``: Holds the public key of the peer.
    - ``next``: Stores the index of the next peer in a linked list.
    - ``prev``: Stores the index of the previous peer in a linked list.
- **Description**: Defines a peer in a linked list structure, identified by a public key and linked to other peers through `next` and `prev` indices.


---
### fd\_peer\_t
- **Type**: ``struct``
- **Members**:
    - ``identity``: Public key of the peer.
    - ``next``: Index of the next peer in the list.
    - ``prev``: Index of the previous peer in the list.
- **Description**: Represents a peer in a doubly-linked list, identified by a public key, and used for tracking peers in a repair policy system.


---
### fd\_policy\_peers
- **Type**: ``struct``
- **Members**:
    - ``pool``: Memory pool of repair peer public keys, containing entries of both doubly linked lists.
    - ``fast``: Pointer to a doubly linked list for peers with latency in the range [0, `FD_POLICY_LATENCY_THRESH`] ms.
    - ``slow``: Pointer to a doubly linked list for peers with latency greater than `FD_POLICY_LATENCY_THRESH` ms.
    - ``map``: Dynamic map of public key to peer data.
    - ``select``: Structure containing the stage and round-robin index for selecting the next peer.
- **Description**: Manages the data structures and bookkeeping necessary for selecting repair peers using a round-robin strategy. It organizes peers into two latency-based groups (`fast` and `slow`) and uses a memory pool (`pool`) to store peer public keys. The `map` provides a dynamic mapping from public keys to peer data, while the `select` structure facilitates the round-robin selection process by maintaining the current stage and index of the next peer to select.


---
### fd\_policy\_peers\_t
- **Type**: ``struct``
- **Members**:
    - ``pool``: Memory pool of repair peer public keys, containing entries of both doubly-linked lists.
    - ``fast``: Doubly-linked list for peers with latency less than or equal to `FD_POLICY_LATENCY_THRESH`.
    - ``slow``: Doubly-linked list for peers with latency greater than `FD_POLICY_LATENCY_THRESH`.
    - ``map``: Dynamic map of public key to peer data.
    - ``select``: Structure containing the stage and round-robin index of the next peer.
- **Description**: Implements data structures and bookkeeping for selecting repair peers using a round-robin strategy. It maintains a memory pool of peer public keys, categorizes peers into fast and slow latency groups, and uses a dynamic map to associate public keys with peer data. The `select` structure helps in determining the next peer to contact based on the round-robin index.


---
### fd\_policy
- **Type**: ``struct``
- **Members**:
    - `dedup`: A deduplication cache for already sent requests.
    - `peers`: Contains strategy and data for repair peers.
    - `tsmax`: Maximum time for an iteration before resetting the DFS to root.
    - `tsref`: Reference timestamp for resetting DFS.
    - `iterf`: Forest iterator for traversing the repair forest.
    - `tsreset`: Timestamp of the last reset of the forest iterator.
    - `turbine_slot0`: A slot identifier for turbine operations.
    - `nonce`: A unique identifier for requests.
- **Description**: Implements the policy of the Repair agent, determining which shreds the validator needs to request and from which peers. It uses a round-robin DFS strategy with time-based deduplication to manage repair requests and peer selection. The structure includes fields for deduplication, peer management, iteration timing, and turbine operations.


---
### fd\_policy\_t
- **Type**: ``struct``
- **Members**:
    - `dedup`: A deduplication cache for already sent repair requests.
    - `peers`: Data structures and strategy for selecting repair peers.
    - `tsmax`: Maximum time for an iteration before resetting the DFS to root.
    - `tsref`: Reference timestamp for resetting DFS.
    - `iterf`: Forest iterator for traversing the repair forest.
    - `tsreset`: Timestamp of the last reset of `iterf`.
    - `turbine_slot0`: Slot number for turbine operations.
    - `nonce`: Nonce value for operations.
- **Description**: Implements the policy of the Repair agent, determining which shreds the validator needs to request and from which peers, using a round-robin DFS strategy with time-based deduplication.


# Functions

---
### fd\_policy\_dedup\_key<!-- {{#callable:fd_policy_dedup_key}} -->
[View Source →](<../../../../../src/discof/repair/fd_policy.h#L55>)

Generates a unique key by encoding the `kind`, `slot`, and `shred_idx` into a single `ulong` value.
- **Inputs**:
    - `kind`: An unsigned integer representing the type of shred (2 bits).
    - `slot`: An unsigned long integer representing the slot number (32 bits).
    - `shred_idx`: An unsigned integer representing the shred index (15 bits).
- **Logic and Control Flow**:
    - Shift `kind` left by 61 bits to occupy the most significant 2 bits of the `ulong`.
    - Shift `slot` left by 30 bits to occupy the next 32 bits of the `ulong`.
    - Shift `shred_idx` left by 15 bits to occupy the next 15 bits of the `ulong`.
    - Combine the shifted values using bitwise OR to form the final key.
- **Output**: Returns a `ulong` that serves as a compact encoding of the input parameters.


---
### fd\_policy\_dedup\_key\_kind<!-- {{#callable:fd_policy_dedup_key_kind}} -->
[View Source →](<../../../../../src/discof/repair/fd_policy.h#L60>)

Extracts the 2-bit 'kind' field from a 64-bit 'key'.
- **Inputs**:
    - `key`: A 64-bit unsigned long integer representing a compactly encoded repair request key.
- **Logic and Control Flow**:
    - Calls the function `fd_ulong_extract` with `key`, `62`, and `63` as arguments to extract bits 62 and 63 from `key`.
    - Casts the result of `fd_ulong_extract` to an unsigned integer (`uint`).
    - Returns the extracted and casted value.
- **Output**: Returns a 2-bit unsigned integer representing the 'kind' field extracted from the 'key'.


---
### fd\_policy\_dedup\_key\_slot<!-- {{#callable:fd_policy_dedup_key_slot}} -->
[View Source →](<../../../../../src/discof/repair/fd_policy.h#L61>)

Extracts the slot component from a compactly encoded `fd_repair_req_t` key.
- **Inputs**:
    - `key`: A `ulong` representing the compactly encoded `fd_repair_req_t` key from which the slot is to be extracted.
- **Logic and Control Flow**:
    - Calls the `fd_ulong_extract` function with `key`, a start bit position of 30, and an end bit position of 61.
    - Returns the extracted slot value as a `ulong`.
- **Output**: A `ulong` representing the extracted slot value from the given key.


---
### fd\_policy\_dedup\_key\_shred\_idx<!-- {{#callable:fd_policy_dedup_key_shred_idx}} -->
[View Source →](<../../../../../src/discof/repair/fd_policy.h#L62>)

Extracts the `shred_idx` field from a compactly encoded `fd_repair_req_t` key.
- **Inputs**:
    - `key`: A `ulong` representing a compactly encoded `fd_repair_req_t` key.
- **Logic and Control Flow**:
    - Calls the function `fd_ulong_extract` with parameters `key`, `15`, and `29` to extract bits 15 to 29 from `key`.
    - Casts the result of `fd_ulong_extract` to `uint`.
    - Returns the casted result.
- **Output**: A `uint` representing the `shred_idx` extracted from the `key`.


---
### fd\_policy\_align<!-- {{#callable:fd_policy_align}} -->
[View Source →](<../../../../../src/discof/repair/fd_policy.h#L197>)

Returns the alignment requirement of the `fd_policy_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls the `alignof` operator on `fd_policy_t` to determine its alignment requirement.
    - Returns the result of the `alignof` operator.
- **Output**: The alignment requirement of the `fd_policy_t` structure as an `ulong`.


---
### fd\_policy\_footprint<!-- {{#callable:fd_policy_footprint}} -->
[View Source →](<../../../../../src/discof/repair/fd_policy.h#L202>)

Calculates the memory footprint required for a policy structure based on deduplication and peer constraints.
- **Inputs**:
    - `dedup_max`: The maximum number of deduplication elements to consider.
    - `peer_max`: The maximum number of peers to track.
- **Logic and Control Flow**:
    - Calculate `lg_peer_max` as the most significant bit of the smallest power of two greater than or equal to `peer_max`.
    - Initialize the layout with `FD_LAYOUT_INIT`.
    - Append the alignment and size of `fd_policy_t` to the layout.
    - Append the alignment and footprint of the deduplication map for `dedup_max` elements.
    - Append the alignment and footprint of the deduplication pool for `dedup_max` elements.
    - Append the alignment and footprint of the deduplication LRU cache.
    - Append the alignment and footprint of the peer map for `lg_peer_max` elements.
    - Append the alignment and footprint of the peer pool for `peer_max` elements.
    - Append the alignment and footprint of the peer doubly-linked list twice.
    - Finalize the layout with `fd_policy_align()`.
- **Output**: Returns the total memory footprint required for the policy structure.
- **Functions Called**:
    - [`fd_policy_align`](<#fd_policy_align>)


---
### fd\_policy\_peer\_latency\_bucket<!-- {{#callable:fd_policy_peer_latency_bucket}} -->
[View Source →](<../../../../../src/discof/repair/fd_policy.h#L278>)

Determines the latency bucket for a peer based on the average round-trip time (RTT) and response count.
- **Inputs**:
    - ``policy``: A pointer to an `fd_policy_t` structure that contains peer latency information.
    - ``total_rtt``: The total round-trip time in nanoseconds for all responses from a peer.
    - ``res_cnt``: The count of responses received from a peer.
- **Logic and Control Flow**:
    - Check if `res_cnt` is zero or if the average RTT (calculated as `total_rtt / res_cnt`) is greater than `FD_POLICY_LATENCY_THRESH`.
    - If either condition is true, return the `slow` latency bucket from `policy->peers`.
    - Otherwise, return the `fast` latency bucket from `policy->peers`.
- **Output**: Returns a pointer to an `fd_peer_dlist_t` representing either the `slow` or `fast` latency bucket.


# Function Declarations (Public API)

---
### fd\_policy\_new<!-- {{#callable_declaration:fd_policy_new}} -->
[View Source →](<../../../../../src/discof/repair/fd_policy.h#L230>)

Formats a memory region for use as a policy.
- **Description**: Use this function to initialize a memory region for policy management in a repair agent. The memory region must be non-null, properly aligned, and have sufficient size to accommodate the deduplication and peer management structures. This function sets up the necessary data structures and initializes them with the provided parameters. It returns a pointer to the initialized memory region or null if the input is invalid or misaligned.
- **Inputs**:
    - `shmem`: A pointer to the memory region to format. Must not be null and must be aligned according to `fd_policy_align()`. Caller retains ownership.
    - `dedup_max`: The maximum number of deduplication entries. Must be a positive integer.
    - `peer_max`: The maximum number of peers to track. Must be a positive integer.
    - `seed`: A seed value for initializing the deduplication map. Can be any unsigned long value.
- **Output**: Returns a pointer to the initialized memory region on success, or null if the input is invalid or misaligned.
- **See Also**: [`fd_policy_new`](<fd_policy.c.md#fd_policy_new>)  (Implementation)


---
### fd\_policy\_join<!-- {{#callable_declaration:fd_policy_join}} -->
[View Source →](<../../../../../src/discof/repair/fd_policy.h#L238>)

Joins the caller to a shared policy.
- **Description**: Use this function to join a caller to a shared policy object. The function requires a pointer to the shared memory region that backs the policy. The memory region must be properly aligned and part of a workspace. If the input is null, misaligned, or not part of a workspace, the function logs a warning and returns null. This function is typically called after the policy has been initialized and formatted for use.
- **Inputs**:
    - `shpolicy`: A pointer to the shared memory region backing the policy. Must not be null, must be aligned according to `fd_policy_align()`, and must be part of a workspace. If these conditions are not met, the function returns null and logs a warning.
- **Output**: Returns a pointer to the policy in the local address space on success, or null on failure.
- **See Also**: [`fd_policy_join`](<fd_policy.c.md#fd_policy_join>)  (Implementation)


---
### fd\_policy\_leave<!-- {{#callable_declaration:fd_policy_leave}} -->
[View Source →](<../../../../../src/discof/repair/fd_policy.h#L245>)

Leaves a current local join to a policy.
- **Description**: Use this function to leave a current local join to a policy. It returns a pointer to the underlying shared memory region if successful. If the input is null, it logs a warning and returns null. This function is useful when you need to safely disconnect from a policy without losing access to the shared memory.
- **Inputs**:
    - `policy`: A pointer to a constant `fd_policy_t` structure. It must not be null. If null, the function logs a warning and returns null.
- **Output**: Returns a pointer to the underlying shared memory region on success, or null if the input is invalid.
- **See Also**: [`fd_policy_leave`](<fd_policy.c.md#fd_policy_leave>)  (Implementation)


---
### fd\_policy\_delete<!-- {{#callable_declaration:fd_policy_delete}} -->
[View Source →](<../../../../../src/discof/repair/fd_policy.h#L254>)

Unformats a memory region used as a policy.
- **Description**: Use this function to unformat a memory region that was previously formatted for use as a policy. This function should be called only when no entities are joined to the policy. It returns a pointer to the underlying shared memory region, transferring ownership of the memory back to the caller. If the input is not a valid policy, the function logs a warning and returns NULL.
- **Inputs**:
    - `policy`: A pointer to the memory region used as a policy. Must not be NULL and must be aligned according to `fd_policy_align()`. If the pointer is NULL or misaligned, the function logs a warning and returns NULL.
- **Output**: Returns a pointer to the underlying shared memory region if successful, or NULL if the input is invalid.
- **See Also**: [`fd_policy_delete`](<fd_policy.c.md#fd_policy_delete>)  (Implementation)


---
### fd\_policy\_next<!-- {{#callable_declaration:fd_policy_next}} -->
[View Source →](<../../../../../src/discof/repair/fd_policy.h#L260>)

Returns the next repair request to be made.
- **Description**: Use this function to determine the next repair request that should be made according to the current policy. It implements a round-robin depth-first search strategy to identify missing shreds that need to be requested. This function must be called with a valid policy, forest, and repair context. It returns a repair message if a request is ready to be made, or NULL if no request is needed at the moment. Ensure that the forest is not empty and that there are peers available in the policy before calling this function.
- **Inputs**:
    - `policy`: A pointer to an `fd_policy_t` structure. Must not be null and should be properly initialized and joined.
    - `forest`: A pointer to an `fd_forest_t` structure. Must not be null and should represent the current state of the repair forest.
    - `repair`: A pointer to an `fd_repair_t` structure. Must not be null and should be initialized for handling repair messages.
    - `now`: A `long` representing the current time in a suitable format for the policy's timing logic.
    - `highest_known_slot`: An `ulong` representing the highest known slot number. Used to determine if a repair request is necessary.
- **Output**: Returns a pointer to an `fd_repair_msg_t` structure representing the next repair request, or NULL if no request is needed.
- **See Also**: [`fd_policy_next`](<fd_policy.c.md#fd_policy_next>)  (Implementation)


---
### fd\_policy\_peer\_insert<!-- {{#callable_declaration:fd_policy_peer_insert}} -->
[View Source →](<../../../../../src/discof/repair/fd_policy.h#L263>)

Inserts a peer into the policy's peer map if space allows.
- **Description**: Use this function to add a new peer to the policy's peer map. It checks if the peer already exists and if there is space available in the map. If the peer does not exist and there is space, it inserts the peer and initializes its attributes. This function is useful when you need to track a new peer for repair requests. Ensure that the policy is properly initialized before calling this function.
- **Inputs**:
    - `policy`: A pointer to an `fd_policy_t` structure. Must not be null. The caller retains ownership.
    - `key`: A pointer to an `fd_pubkey_t` structure representing the peer's public key. Must not be null. The caller retains ownership.
    - `addr`: A pointer to an `fd_ip4_port_t` structure containing the peer's IP address and port. Must not be null. The caller retains ownership.
- **Output**: Returns a pointer to the newly inserted `fd_policy_peer_t` if successful, or `NULL` if the peer already exists or if there is no space available in the map.
- **See Also**: [`fd_policy_peer_insert`](<fd_policy.c.md#fd_policy_peer_insert>)  (Implementation)


---
### fd\_policy\_peer\_query<!-- {{#callable_declaration:fd_policy_peer_query}} -->
[View Source →](<../../../../../src/discof/repair/fd_policy.h#L266>)

Queries a peer in the policy using a public key.
- **Description**: Use this function to find a peer validator in the policy's peer map by providing the peer's public key. This function is useful when you need to retrieve information about a specific peer that is part of the repair policy. Ensure that the `policy` parameter is a valid and initialized policy object, and the `key` parameter is a valid public key of a peer. The function returns a pointer to the peer data if the peer is found, or `NULL` if the peer does not exist in the map.
- **Inputs**:
    - `policy`: A pointer to an `fd_policy_t` object representing the policy. Must not be null and should be properly initialized.
    - `key`: A pointer to a constant `fd_pubkey_t` representing the public key of the peer to query. Must not be null.
- **Output**: Returns a pointer to an `fd_policy_peer_t` if the peer is found, or `NULL` if the peer is not found in the policy's peer map.
- **See Also**: [`fd_policy_peer_query`](<fd_policy.c.md#fd_policy_peer_query>)  (Implementation)


---
### fd\_policy\_peer\_remove<!-- {{#callable_declaration:fd_policy_peer_remove}} -->
[View Source →](<../../../../../src/discof/repair/fd_policy.h#L269>)

Removes a peer from the policy.
- **Description**: Use this function to remove a peer from the policy's tracking system. This is useful when a peer is no longer needed or should not be considered for future operations. Ensure that the `policy` is properly initialized and that the `key` corresponds to a peer currently tracked by the policy. The function safely handles the removal even if the peer is currently being iterated over, adjusting the iterator as necessary. If the peer is not found, the function returns immediately without making changes.
- **Inputs**:
    - `policy`: A pointer to an `fd_policy_t` structure. Must not be null and should be a valid, initialized policy object.
    - `key`: A pointer to a constant `fd_pubkey_t` representing the public key of the peer to remove. Must not be null and should correspond to a peer currently tracked by the policy.
- **Output**: Returns 1 if the peer was successfully removed, or 0 if the peer was not found.
- **See Also**: [`fd_policy_peer_remove`](<fd_policy.c.md#fd_policy_peer_remove>)  (Implementation)


---
### fd\_policy\_peer\_select<!-- {{#callable_declaration:fd_policy_peer_select}} -->
[View Source →](<../../../../../src/discof/repair/fd_policy.h#L272>)

Selects the next peer for repair requests.
- **Description**: Use this function to select the next peer from which to request repairs based on the current policy. It implements a round-robin strategy, alternating between peers with different latency characteristics. This function must be called with a valid `fd_policy_t` object that has been properly initialized. It returns the public key of the selected peer, ensuring that the selection process adheres to the policy's latency and deduplication rules.
- **Inputs**:
    - `policy`: A pointer to an `fd_policy_t` structure. This must not be null and should be initialized before calling this function. The function uses this structure to determine the next peer to select based on the current policy settings.
- **Output**: A pointer to an `fd_pubkey_t` structure representing the public key of the selected peer. The function returns this pointer to indicate the peer that should be used for the next repair request.
- **See Also**: [`fd_policy_peer_select`](<fd_policy.c.md#fd_policy_peer_select>)  (Implementation)


---
### fd\_policy\_peer\_request\_update<!-- {{#callable_declaration:fd_policy_peer_request_update}} -->
[View Source →](<../../../../../src/discof/repair/fd_policy.h#L275>)

Updates the request statistics for a specified peer.
- **Description**: Use this function to update the request count and timestamps for a peer identified by its public key. This function should be called whenever a request is sent to a peer. It increments the request count and updates the last request timestamp. If this is the first request to the peer, it also sets the first request timestamp. Ensure that the `policy` is properly initialized and that the `to` parameter points to a valid public key of a peer.
- **Inputs**:
    - `policy`: A pointer to an `fd_policy_t` structure. Must not be null. Represents the policy context in which the peer request statistics are updated.
    - `to`: A pointer to a constant `fd_pubkey_t` structure. Must not be null. Represents the public key of the peer whose request statistics are to be updated.
- **Output**: None
- **See Also**: [`fd_policy_peer_request_update`](<fd_policy.c.md#fd_policy_peer_request_update>)  (Implementation)


---
### fd\_policy\_peer\_response\_update<!-- {{#callable_declaration:fd_policy_peer_response_update}} -->
[View Source →](<../../../../../src/discof/repair/fd_policy.h#L284>)

Updates the response statistics for a peer.
- **Description**: Use this function to update the response statistics of a peer identified by its public key. This function should be called whenever a response is received from a peer to update the round-trip time (RTT) and response count. It assumes that the peer is already known to the policy. The function will adjust the peer's latency bucket if necessary, based on the updated statistics.
- **Inputs**:
    - `policy`: A pointer to an `fd_policy_t` structure. Must not be null. Represents the policy context that tracks peer information.
    - `to`: A pointer to a constant `fd_pubkey_t` structure. Must not be null. Represents the public key of the peer whose response statistics are being updated.
    - `rtt`: A long integer representing the round-trip time in nanoseconds. Should be a non-negative value.
- **Output**: None
- **See Also**: [`fd_policy_peer_response_update`](<fd_policy.c.md#fd_policy_peer_response_update>)  (Implementation)


---
### fd\_policy\_set\_turbine\_slot0<!-- {{#callable_declaration:fd_policy_set_turbine_slot0}} -->
[View Source →](<../../../../../src/discof/repair/fd_policy.h#L287>)

Set the initial turbine slot for a policy.
- **Description**: Use this function to set the initial turbine slot for a given policy. This function is typically used to initialize or update the starting point for turbine operations within the policy. Ensure that the `policy` parameter is a valid pointer to an `fd_policy_t` structure before calling this function.
- **Inputs**:
    - `policy`: A pointer to an `fd_policy_t` structure. Must not be null. The caller retains ownership and is responsible for ensuring the pointer is valid.
    - `slot`: An unsigned long value representing the turbine slot to set. There are no specific constraints on the value, but it should be meaningful within the context of the application.
- **Output**: None
- **See Also**: [`fd_policy_set_turbine_slot0`](<fd_policy.c.md#fd_policy_set_turbine_slot0>)  (Implementation)


---
### fd\_policy\_reset<!-- {{#callable_declaration:fd_policy_reset}} -->
[View Source →](<../../../../../src/discof/repair/fd_policy.h#L290>)

Resets the policy's iterator and timestamp.
- **Description**: Use this function to reset the internal iterator and timestamp of a policy. This is typically necessary when the policy needs to start a new iteration cycle over the repair forest. Ensure that the `policy` and `forest` pointers are valid and properly initialized before calling this function.
- **Inputs**:
    - `policy`: A pointer to an `fd_policy_t` structure. Must not be null and should be properly initialized before use.
    - `forest`: A pointer to an `fd_forest_t` structure. Must not be null and should be properly initialized before use.
- **Output**: None
- **See Also**: [`fd_policy_reset`](<fd_policy.c.md#fd_policy_reset>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)