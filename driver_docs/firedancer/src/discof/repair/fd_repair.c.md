<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for creating, joining, leaving, and deleting repair objects, and generating repair messages.

# Purpose
The code provides functionality for managing and manipulating repair messages in a distributed system. It defines a set of functions that operate on a `fd_repair_t` structure, which is used to create, join, leave, and delete repair contexts. The functions [`fd_repair_new`](<#fd_repair_new>), [`fd_repair_join`](<#fd_repair_join>), [`fd_repair_leave`](<#fd_repair_leave>), and [`fd_repair_delete`](<#fd_repair_delete>) handle memory alignment and workspace validation to ensure that the repair context is correctly initialized and managed. The code also includes functions for generating specific types of repair messages, such as [`fd_repair_pong`](<#fd_repair_pong>), [`fd_repair_shred`](<#fd_repair_shred>), [`fd_repair_highest_shred`](<#fd_repair_highest_shred>), and [`fd_repair_orphan`](<#fd_repair_orphan>). These functions populate a `fd_repair_msg_t` structure with message details, including the sender and recipient public keys, timestamps, nonces, slots, and other relevant data.

The code imports several headers, indicating dependencies on external components for SHA-256 hashing and key management. The `fd_sha256_hash` function is used to generate hash tokens for the [`fd_repair_pong`](<#fd_repair_pong>) function, which is part of the message generation process. The code is structured to ensure that all operations on the repair context and messages are performed safely, with checks for null pointers and memory alignment. This code is intended to be part of a larger system where repair messages are used to maintain data integrity and synchronization across distributed nodes.
# Imports and Dependencies

---
- `fd_repair.h`
- `../../ballet/sha256/fd_sha256.h`
- `../../disco/keyguard/fd_keyguard_client.h`


# Functions

---
### fd\_repair\_new<!-- {{#callable:fd_repair_new}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair.c#L5>)

Initializes a memory region for a repair structure and assigns an identity key to it.
- **Inputs**:
    - `shmem`: A pointer to a shared memory region where the repair structure will be initialized.
    - `identity_key`: A pointer to an `fd_pubkey_t` structure that contains the identity key to assign to the repair structure.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL; if true, log a warning and return NULL.
    - Check if `shmem` is aligned according to [`fd_repair_align`](<fd_repair.h.md#fd_repair_align>); if not, log a warning and return NULL.
    - Calculate the memory footprint required for the repair structure using [`fd_repair_footprint`](<fd_repair.h.md#fd_repair_footprint>).
    - Set the memory region pointed to by `shmem` to zero for the calculated footprint size using `fd_memset`.
    - Cast `shmem` to a `fd_repair_t` pointer and assign the dereferenced `identity_key` to the `identity_key` field of the repair structure.
    - Return the `shmem` pointer.
- **Output**: Returns a pointer to the initialized shared memory region, or NULL if an error occurs.
- **Functions Called**:
    - [`fd_repair_align`](<fd_repair.h.md#fd_repair_align>)
    - [`fd_repair_footprint`](<fd_repair.h.md#fd_repair_footprint>)


---
### fd\_repair\_join<!-- {{#callable:fd_repair_join}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair.c#L27>)

Validates and returns a pointer to a `fd_repair_t` structure if it is non-null, aligned, and part of a workspace.
- **Inputs**:
    - `shrepair`: A pointer to a shared memory region that is expected to be a `fd_repair_t` structure.
- **Logic and Control Flow**:
    - Cast `shrepair` to a `fd_repair_t` pointer named `repair`.
    - Check if `repair` is NULL; if true, log a warning and return NULL.
    - Check if `repair` is aligned according to [`fd_repair_align`](<fd_repair.h.md#fd_repair_align>); if not, log a warning and return NULL.
    - Determine if `repair` is part of a workspace using `fd_wksp_containing`; if not, log a warning and return NULL.
    - Return the `repair` pointer.
- **Output**: A pointer to a `fd_repair_t` structure if all checks pass, otherwise NULL.
- **Functions Called**:
    - [`fd_repair_align`](<fd_repair.h.md#fd_repair_align>)


---
### fd\_repair\_leave<!-- {{#callable:fd_repair_leave}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair.c#L50>)

Returns the input `repair` pointer if it is not NULL, otherwise logs a warning and returns NULL.
- **Inputs**:
    - `repair`: A pointer to a constant `fd_repair_t` structure that the function will check for NULL.
- **Logic and Control Flow**:
    - Check if the `repair` pointer is NULL using `FD_UNLIKELY`.
    - If `repair` is NULL, log a warning message 'NULL repair' and return NULL.
    - If `repair` is not NULL, cast it to a `void *` and return it.
- **Output**: A `void *` pointer to the `repair` structure if it is not NULL, otherwise NULL.


---
### fd\_repair\_delete<!-- {{#callable:fd_repair_delete}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair.c#L61>)

Validates the `repair` pointer for nullity and alignment, then returns it.
- **Inputs**:
    - `repair`: A pointer to the repair object to be validated and returned.
- **Logic and Control Flow**:
    - Check if `repair` is NULL; if true, log a warning and return NULL.
    - Check if `repair` is not aligned according to `fd_repair_align()`; if true, log a warning and return NULL.
    - Return the `repair` pointer.
- **Output**: Returns the `repair` pointer if it is non-null and properly aligned; otherwise, returns NULL.
- **Functions Called**:
    - [`fd_repair_align`](<fd_repair.h.md#fd_repair_align>)


---
### fd\_repair\_pong<!-- {{#callable:fd_repair_pong}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair.c#L77>)

Generates a PONG message in response to a PING token by creating a hash and setting message details.
- **Inputs**:
    - `repair`: A pointer to an `fd_repair_t` structure that holds the repair message and identity key.
    - `ping_token`: A pointer to an `fd_hash_t` structure that contains the PING token to respond to.
- **Logic and Control Flow**:
    - Create a pre-image buffer of size `FD_REPAIR_PONG_PREIMAGE_SZ`.
    - Copy the string "SOLANA_PING_PONG" into the first 16 bytes of the pre-image buffer.
    - Copy the 32-byte `ping_token->uc` into the pre-image buffer starting at the 17th byte.
    - Generate a SHA-256 hash of the pre-image and store it in `repair->msg.pong.hash`.
    - Set `repair->msg.kind` to `FD_REPAIR_KIND_PONG`.
    - Set `repair->msg.pong.from` to `repair->identity_key`.
    - Return a pointer to `repair->msg`.
- **Output**: A pointer to the `fd_repair_msg_t` structure containing the PONG message.


---
### fd\_repair\_shred<!-- {{#callable:fd_repair_shred}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair.c#L91>)

Initializes a `fd_repair_msg_t` structure for a shred message with specified parameters.
- **Inputs**:
    - `repair`: A pointer to a `fd_repair_t` structure that contains the message to initialize.
    - `to`: A pointer to a `fd_pubkey_t` structure representing the recipient's public key.
    - `ts`: A timestamp of type `ulong` for the message.
    - `nonce`: A `uint` value used as a nonce for the message.
    - `slot`: A `ulong` value representing the slot number for the message.
    - `shred_idx`: A `ulong` value representing the shred index for the message.
- **Logic and Control Flow**:
    - Set all bytes of `repair->msg` to zero using `memset`.
    - Set `repair->msg.kind` to `FD_REPAIR_KIND_SHRED`.
    - Assign `repair->identity_key` to `repair->msg.shred.from`.
    - Assign the value pointed to by `to` to `repair->msg.shred.to`.
    - Assign `ts` to `repair->msg.shred.ts`.
    - Assign `nonce` to `repair->msg.shred.nonce`.
    - Assign `slot` to `repair->msg.shred.slot`.
    - Assign `shred_idx` to `repair->msg.shred.shred_idx`.
    - Return a pointer to `repair->msg`.
- **Output**: A pointer to the initialized `fd_repair_msg_t` structure within the `repair` object.


---
### fd\_repair\_highest\_shred<!-- {{#callable:fd_repair_highest_shred}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair.c#L109>)

Initializes a `fd_repair_msg_t` structure for a highest shred repair message and returns a pointer to it.
- **Inputs**:
    - `repair`: A pointer to a `fd_repair_t` structure that contains the repair message to initialize.
    - `to`: A constant pointer to a `fd_pubkey_t` structure representing the recipient's public key.
    - `ts`: An unsigned long integer representing the timestamp for the message.
    - `nonce`: An unsigned integer used as a nonce for the message.
    - `slot`: An unsigned long integer representing the slot number for the message.
    - `shred_idx`: An unsigned long integer representing the shred index for the message.
- **Logic and Control Flow**:
    - Set all bytes of `repair->msg` to zero using `memset`.
    - Set `repair->msg.kind` to `FD_REPAIR_KIND_HIGHEST_SHRED`.
    - Assign `repair->identity_key` to `repair->msg.highest_shred.from`.
    - Assign the value pointed to by `to` to `repair->msg.highest_shred.to`.
    - Assign `ts` to `repair->msg.highest_shred.ts`.
    - Assign `nonce` to `repair->msg.highest_shred.nonce`.
    - Assign `slot` to `repair->msg.highest_shred.slot`.
    - Assign `shred_idx` to `repair->msg.highest_shred.shred_idx`.
    - Return a pointer to `repair->msg`.
- **Output**: A pointer to the initialized `fd_repair_msg_t` structure.


---
### fd\_repair\_orphan<!-- {{#callable:fd_repair_orphan}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair.c#L127>)

Creates and returns an orphan repair message with specified parameters.
- **Inputs**:
    - `repair`: A pointer to an `fd_repair_t` structure where the message will be stored.
    - `to`: A pointer to a `fd_pubkey_t` structure representing the recipient's public key.
    - `ts`: A timestamp of type `ulong` for the message.
    - `nonce`: A `uint` value used as a unique identifier for the message.
    - `slot`: A `ulong` value representing the slot number associated with the message.
- **Logic and Control Flow**:
    - Initialize the `msg` field of the `repair` structure to zero using `memset`.
    - Set the `kind` field of the `msg` to `FD_REPAIR_KIND_ORPHAN`.
    - Assign the `identity_key` of `repair` to the `from` field of the `orphan` message.
    - Copy the `to` public key to the `to` field of the `orphan` message.
    - Set the `ts`, `nonce`, and `slot` fields of the `orphan` message to the provided `ts`, `nonce`, and `slot` values respectively.
    - Return a pointer to the `msg` field of the `repair` structure.
- **Output**: A pointer to the `fd_repair_msg_t` structure within the `repair` structure, containing the newly created orphan message.



---
Made with ❤️ by [Driver](https://www.driver.ai/)