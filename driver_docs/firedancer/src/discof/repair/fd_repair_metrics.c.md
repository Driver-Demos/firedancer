<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for managing and printing repair metrics, including slot tracking and performance analysis.

# Purpose
The code defines a set of functions for managing and analyzing repair metrics related to data slots, likely in a distributed system context. It provides functionality to initialize, join, and update a `fd_repair_metrics_t` structure, which tracks metrics for data slots, including timestamps and counts related to repairs and turbine operations. The code includes functions to set specific metrics, such as [`fd_repair_metrics_set_turbine_slot0`](<#fd_repair_metrics_set_turbine_slot0>), and to add new slot data with [`fd_repair_metrics_add_slot`](<#fd_repair_metrics_add_slot>). The metrics are stored in a circular buffer, and the code ensures that the buffer does not overflow by updating the start index when necessary.

Additionally, the code includes functions for printing and analyzing the collected metrics. The [`fd_repair_metrics_print`](<#fd_repair_metrics_print>) function outputs a visual representation of the slot metrics, showing the duration of each slot's processing time. It also calculates and logs statistics such as the average slot duration and pipeline factors, which are useful for performance analysis. The [`print_catchup_stats`](<#print_catchup_stats>) function provides detailed statistics about the time taken to process slots up to a specific turbine slot, offering insights into the efficiency of the data processing pipeline. The code is structured to support both verbose and non-verbose output modes, allowing for flexible logging based on the user's needs.
# Imports and Dependencies

---
- `fd_repair_metrics.h`
- `stdio.h`
- `../../disco/metrics/fd_metrics.h`


# Global Variables

---
### dashes
- **Type**: ``char` array`
- **Description**: A static `char` array named `dashes` with a size of `MAX_WIDTH + 1`, initialized with a sequence of '=' characters. The array is used to create a visual representation of a line of dashes.
- **Use**: Used in the `fd_repair_metrics_print` function to print a visual representation of slot durations.


---
### spaces
- **Type**: ``char[]``
- **Description**: A static character array initialized with spaces, with a size of `MAX_WIDTH + 1`. The array is filled with spaces to provide a buffer for formatting output.
- **Use**: Used to format output by providing a buffer of spaces for alignment in printed charts.


# Functions

---
### fd\_repair\_metrics\_new<!-- {{#callable:fd_repair_metrics_new}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_metrics.c#L6>)

Initializes a `fd_repair_metrics_t` structure with default values.
- **Inputs**:
    - `mem`: A pointer to a memory location where the `fd_repair_metrics_t` structure will be initialized.
- **Logic and Control Flow**:
    - Cast the `mem` pointer to a `fd_repair_metrics_t` pointer and assign it to `repair_metrics`.
    - Set the `st` and `en` fields of `repair_metrics` to `UINT_MAX`.
    - Set the `turbine_slot0` field of `repair_metrics` to 0.
    - Return the `repair_metrics` pointer.
- **Output**: Returns a pointer to the initialized `fd_repair_metrics_t` structure.


---
### fd\_repair\_metrics\_join<!-- {{#callable:fd_repair_metrics_join}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_metrics.c#L16>)

Casts a `void *` pointer to a `fd_repair_metrics_t *` pointer.
- **Inputs**:
    - `repair_metrics`: A `void *` pointer that is expected to point to a `fd_repair_metrics_t` structure.
- **Logic and Control Flow**:
    - Casts the input `repair_metrics` from a `void *` to a `fd_repair_metrics_t *`.
    - Returns the casted pointer.
- **Output**: A pointer of type `fd_repair_metrics_t *` that points to the same memory location as the input `repair_metrics`.


---
### fd\_repair\_metrics\_set\_turbine\_slot0<!-- {{#callable:fd_repair_metrics_set_turbine_slot0}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_metrics.c#L21>)

Sets the `turbine_slot0` field of a `fd_repair_metrics_t` structure.
- **Inputs**:
    - `repair_metrics`: A pointer to a `fd_repair_metrics_t` structure whose `turbine_slot0` field will be set.
    - `turbine_slot0`: An unsigned long integer value to set as the `turbine_slot0` field in the `fd_repair_metrics_t` structure.
- **Logic and Control Flow**:
    - Assigns the value of `turbine_slot0` to the `turbine_slot0` field of the `repair_metrics` structure.
- **Output**: No return value.


---
### fd\_repair\_metrics\_add\_slot<!-- {{#callable:fd_repair_metrics_add_slot}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_metrics.c#L26>)

Adds a new slot entry to the repair metrics, updating the start and end indices as needed.
- **Inputs**:
    - `repair_metrics`: A pointer to the `fd_repair_metrics_t` structure where the slot data will be added.
    - `slot`: The slot number to add to the repair metrics.
    - `first_ts`: The timestamp of the first event in the slot.
    - `slot_complete_ts`: The timestamp when the slot was completed.
    - `repair_cnt`: The count of repairs made in the slot.
    - `turbine_cnt`: The count of turbine events in the slot.
- **Logic and Control Flow**:
    - Calculate the next end index `next_en` by incrementing the current end index and taking modulo `FD_CATCHUP_METRICS_MAX`.
    - Check if `next_en` equals the start index `st` or if `st` is `UINT_MAX`; if true, increment the start index `st` to maintain the circular buffer.
    - Store the provided slot data (`slot`, `first_ts`, `slot_complete_ts`, `repair_cnt`, `turbine_cnt`) at the `next_en` index in the `slots` array of `repair_metrics`.
    - Update the end index `en` to `next_en`.
    - If `DEBUG_LOGGING` is enabled and the slot equals `turbine_slot0`, call [`fd_repair_metrics_print`](<#fd_repair_metrics_print>) to log the repair metrics.
- **Output**: No return value; the function updates the `fd_repair_metrics_t` structure in place.
- **Functions Called**:
    - [`fd_repair_metrics_print`](<#fd_repair_metrics_print>)


---
### print\_catchup\_stats<!-- {{#callable:print_catchup_stats}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_metrics.c#L55>)

Calculates and logs statistics related to the catchup process of repair metrics.
- **Inputs**:
    - `repair_metrics`: A pointer to an `fd_repair_metrics_t` structure containing repair metrics data.
- **Logic and Control Flow**:
    - Initialize variables for minimum timestamp, turbine timestamp, total slot completion time, previous slot completion timestamp, and incremental slot completion total.
    - Iterate over the slots in the `repair_metrics` starting from `st` to `en`, wrapping around using modulo `FD_CATCHUP_METRICS_MAX`.
    - For each slot, update the minimum timestamp using `fd_min`.
    - If the current slot is less than or equal to `turbine_slot0`, add the slot completion time to `slot_cmpl_time_total` and increment `catchup_cnt`.
    - If the current slot is equal to `turbine_slot0`, set `turbine_ts` to the slot completion timestamp.
    - Calculate incremental slot completion time if the current slot is less than or equal to `turbine_slot0` and the difference between the current and previous slot completion timestamps is positive.
    - Update `prev_slot_cmpl_ts` to the current slot completion timestamp.
    - Break the loop if the current index equals `en`.
    - If `turbine_ts` is greater than 0, calculate `pipelined_time` and log the time taken to reach the first turbine.
    - Calculate and log the pipeline factor and average incremental slot completion time.
- **Output**: Logs the time taken to reach the first turbine, the pipeline factor, and the average incremental slot completion time.


---
### fd\_repair\_metrics\_print<!-- {{#callable:fd_repair_metrics_print}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_metrics.c#L99>)

Prints a visual representation of repair metrics for slots, including slot durations and repair counts, with optional verbosity.
- **Inputs**:
    - `repair_metrics`: A pointer to an `fd_repair_metrics_t` structure containing the repair metrics data.
    - `verbose`: An integer flag that, if non-zero, enables verbose output with additional repair count details.
- **Logic and Control Flow**:
    - Initialize `min_ts`, `max_ts`, `turbine0`, and `cnt` variables.
    - Iterate over the slots from `repair_metrics->st` to `repair_metrics->en`, updating `min_ts`, `max_ts`, and `slot_cmpl_duration_total`.
    - Check if the current slot is `turbine_slot0` and set `turbine0` to 1 if true.
    - Calculate `tick_sz` as the time span divided by `MAX_WIDTH`.
    - Iterate over the slots again to print each slot's visual representation, adjusting for verbosity if `verbose` is non-zero.
    - Print additional information if the current slot is `turbine_slot0`.
    - Flush the output buffer to ensure all data is printed.
    - Log the number of slots and average slot duration.
    - Call [`print_catchup_stats`](<#print_catchup_stats>) if `turbine0` is true.
- **Output**: No return value; outputs data to standard output and logs information.
- **Functions Called**:
    - [`print_catchup_stats`](<#print_catchup_stats>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)