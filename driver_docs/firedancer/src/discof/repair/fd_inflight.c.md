<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Manages inflight request tables with functions to insert, remove, and query requests.

# Purpose
The code provides functionality for managing inflight requests using a data structure that includes a pool, a map, and a doubly linked list. It is part of a C library intended to be used in other programs. The primary components include functions for creating and joining an inflight table ([`fd_inflights_new`](<#fd_inflights_new>) and [`fd_inflights_join`](<#fd_inflights_join>)), inserting requests ([`fd_inflights_request_insert`](<#fd_inflights_request_insert>)), removing requests ([`fd_inflights_request_remove`](<#fd_inflights_request_remove>)), and querying requests ([`fd_inflights_request_query`](<#fd_inflights_request_query>)). The code uses memory allocation and alignment functions to manage the inflight table and its associated data structures.

The [`fd_inflights_new`](<#fd_inflights_new>) function initializes a new inflight table in shared memory, while [`fd_inflights_join`](<#fd_inflights_join>) allows a program to access an existing inflight table. The [`fd_inflights_request_insert`](<#fd_inflights_request_insert>) function adds a new request to the table, handling eviction if necessary. The [`fd_inflights_request_remove`](<#fd_inflights_request_remove>) function removes a request and calculates the round-trip time. The [`fd_inflights_request_query`](<#fd_inflights_request_query>) function checks if a request with a specific nonce exists in the table. The code ensures proper memory alignment and checks for potential errors, such as null pointers and misaligned memory.
# Imports and Dependencies

---
- `fd_inflight.h`


# Functions

---
### fd\_inflights\_new<!-- {{#callable:fd_inflights_new}} -->
[View Source →](<../../../../../src/discof/repair/fd_inflight.c#L3>)

Initializes a new inflight table in shared memory and sets up its components.
- **Inputs**:
    - `shmem`: A pointer to the shared memory where the inflight table will be initialized.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL; if so, log a warning and return NULL.
    - Calculate the memory footprint required for the inflight table.
    - Initialize a scratch allocator with `shmem`.
    - Allocate memory for the inflight table, pool, map, and doubly linked list using the scratch allocator.
    - Verify that the total allocated memory matches the expected footprint.
    - Initialize and join the pool, map, and doubly linked list components of the inflight table.
    - Check that the pool, map, and doubly linked list are successfully initialized.
- **Output**: Returns the pointer to the shared memory (`shmem`) where the inflight table is initialized, or NULL if initialization fails.
- **Functions Called**:
    - [`fd_inflights_footprint`](<fd_inflight.h.md#fd_inflights_footprint>)
    - [`fd_inflights_align`](<fd_inflight.h.md#fd_inflights_align>)


---
### fd\_inflights\_join<!-- {{#callable:fd_inflights_join}} -->
[View Source →](<../../../../../src/discof/repair/fd_inflight.c#L30>)

Validates and returns a pointer to an `fd_inflights_t` structure from shared memory if it is correctly aligned and part of a workspace.
- **Inputs**:
    - `shmem`: A pointer to shared memory that is expected to contain an `fd_inflights_t` structure.
- **Logic and Control Flow**:
    - Cast `shmem` to an `fd_inflights_t` pointer named `table`.
    - Check if `table` is NULL; if so, log a warning and return NULL.
    - Check if `table` is aligned according to `fd_inflights_align()`; if not, log a warning and return NULL.
    - Determine if `table` is part of a workspace using `fd_wksp_containing`; if not, log a warning and return NULL.
    - Return the `fd_inflights_t` pointer cast from `shmem`.
- **Output**: A pointer to an `fd_inflights_t` structure if successful, or NULL if any validation fails.
- **Functions Called**:
    - [`fd_inflights_align`](<fd_inflight.h.md#fd_inflights_align>)


---
### fd\_inflights\_request\_insert<!-- {{#callable:fd_inflights_request_insert}} -->
[View Source →](<../../../../../src/discof/repair/fd_inflight.c#L53>)

Inserts a new inflight request into the table, evicting the oldest request if necessary.
- **Inputs**:
    - `table`: A pointer to the `fd_inflights_t` structure representing the inflight request table.
    - `nonce`: An unsigned long integer representing the unique identifier for the inflight request.
    - `pubkey`: A pointer to a constant `fd_pubkey_t` structure representing the public key associated with the inflight request.
- **Logic and Control Flow**:
    - Check if the inflight pool has no free elements using `fd_inflight_pool_free`.
    - If the pool is full, evict the oldest inflight request by popping the head of the doubly linked list using `fd_inflight_dlist_ele_pop_head`.
    - Remove the evicted request from the map using `fd_inflight_map_ele_remove` and release it back to the pool using `fd_inflight_pool_ele_release`.
    - Acquire a new inflight request element from the pool using `fd_inflight_pool_ele_acquire`.
    - Set the `nonce`, `timestamp_ns`, and `pubkey` fields of the acquired inflight request.
    - Insert the new inflight request into the map using `fd_inflight_map_ele_insert`.
    - Push the new inflight request to the tail of the doubly linked list using `fd_inflight_dlist_ele_push_tail`.
- **Output**: None (the function modifies the inflight request table in place).


---
### fd\_inflights\_request\_remove<!-- {{#callable:fd_inflights_request_remove}} -->
[View Source →](<../../../../../src/discof/repair/fd_inflight.c#L70>)

Removes a request from the inflight table and returns the round-trip time (RTT) if the request exists.
- **Inputs**:
    - `table`: A pointer to the `fd_inflights_t` structure representing the inflight table.
    - `nonce`: An unsigned long integer representing the unique identifier of the request to remove.
    - `peer_out`: A pointer to an `fd_pubkey_t` structure where the function will store the public key of the removed request.
- **Logic and Control Flow**:
    - Call `fd_inflight_map_ele_remove` to attempt to remove the request with the given `nonce` from the map.
    - If the request exists (`FD_LIKELY(inflight_req)`), calculate the current time using `fd_log_wallclock` and compute the RTT by subtracting the request's timestamp from the current time.
    - Store the public key of the removed request in `peer_out`.
    - Remove the request from the map, doubly linked list, and release it back to the pool using `fd_inflight_map_ele_remove`, `fd_inflight_dlist_ele_remove`, and `fd_inflight_pool_ele_release`, respectively.
    - Return the calculated RTT.
    - If the request does not exist, return 0.
- **Output**: Returns the round-trip time (RTT) as a long integer if the request is successfully removed, or 0 if the request does not exist.


---
### fd\_inflights\_request\_query<!-- {{#callable:fd_inflights_request_query}} -->
[View Source →](<../../../../../src/discof/repair/fd_inflight.c#L87>)

Queries the inflight request table for a request with a specific nonce.
- **Inputs**:
    - `table`: A pointer to an `fd_inflights_t` structure representing the inflight request table.
    - `nonce`: An unsigned long integer representing the unique identifier of the inflight request to query.
- **Logic and Control Flow**:
    - Calls `fd_inflight_map_ele_query` with the `map` from the `table`, the address of `nonce`, `NULL`, and the `pool` from the `table`.
- **Output**: Returns a pointer to an `fd_inflight_t` structure if the request with the specified nonce is found, otherwise returns `NULL`.



---
Made with ❤️ by [Driver](https://www.driver.ai/)