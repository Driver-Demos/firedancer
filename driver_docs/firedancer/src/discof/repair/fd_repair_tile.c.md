<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a repair tile for handling synchronous and asynchronous requests, including credit tracking and request signing, within a distributed system.

# Purpose
The code defines a request handling architecture for a repair tile in a distributed system. It implements two request handling patterns: synchronous and asynchronous. Synchronous request handling is used for lightweight protocol messages that require immediate signing and response, such as PINGs and PONGs, which are used to manage peer connectivity and liveness. Asynchronous request handling is used for repair requests, which are sent to a sign tile, allowing the repair tile to continue processing other operations without blocking. The repair tile manually tracks credits for asynchronous sign links to prevent deadlocks and ensure that the system can handle requests efficiently.

The code includes several components and structures to manage the request handling process. It defines data structures for managing incoming and outgoing requests, such as `in_ctx_t` and `out_ctx_t`, and uses maps and queues to track pending sign requests. The code also includes functions for sending packets, managing pending sign requests, and handling different types of messages, such as contact information updates and signed requests. The repair tile is integrated into a larger system through various input and output links, and it uses a round-robin approach to distribute asynchronous requests across multiple sign tiles for load balancing. The code also includes metrics collection to monitor the performance of the repair tile.
# Imports and Dependencies

---
- `../genesis/fd_genesi_tile.h`
- `../../disco/topo/fd_topo.h`
- `generated/fd_repair_tile_seccomp.h`
- `../../disco/fd_disco.h`
- `../../disco/keyguard/fd_keyload.h`
- `../../disco/keyguard/fd_keyguard.h`
- `../../disco/net/fd_net_tile.h`
- `../../disco/store/fd_store.h`
- `../../flamenco/gossip/fd_gossip_types.h`
- `../tower/fd_tower_tile.h`
- `../../discof/restore/utils/fd_ssmsg.h`
- `../../util/pod/fd_pod_format.h`
- `../../util/net/fd_net_headers.h`
- `../../tango/fd_tango_base.h`
- `../forest/fd_forest.h`
- `fd_repair_metrics.h`
- `fd_inflight.h`
- `fd_repair.h`
- `fd_policy.h`
- `../../util/tmpl/fd_map_dynamic.c`
- `../../util/tmpl/fd_queue.c`
- `../../disco/stem/fd_stem.c`


# Global Variables

---
### metric\_index
- **Type**: ``uint[]``
- **Description**: An array that maps different repair request types to their corresponding metric array indices. The array is indexed by repair kinds such as `FD_REPAIR_KIND_SHRED`, `FD_REPAIR_KIND_HIGHEST_SHRED`, and `FD_REPAIR_KIND_ORPHAN`. Each element in the array corresponds to a specific metric index defined by constants like `FD_METRICS_ENUM_REPAIR_SENT_REQUEST_TYPES_V_NEEDED_WINDOW_IDX`, `FD_METRICS_ENUM_REPAIR_SENT_REQUEST_TYPES_V_NEEDED_HIGHEST_WINDOW_IDX`, and `FD_METRICS_ENUM_REPAIR_SENT_REQUEST_TYPES_V_NEEDED_ORPHAN_IDX`. The size of the array is determined by the number of repair kinds plus one.
- **Use**: Used to access the metric index for a given repair request type.


---
### fd\_tile\_repair
- **Type**: ``fd_topo_run_tile_t``
- **Description**: Defines a `fd_topo_run_tile_t` structure named `fd_tile_repair` with various function pointers and parameters for managing a repair tile in a network topology. The structure includes fields for initialization, footprint calculation, and execution of the repair tile's operations.
- **Use**: Used to configure and manage the behavior of a repair tile in a network topology.


# Data Structures

---
### in\_ctx\_t
- **Type**: ``union``
- **Members**:
    - ``mem``: Pointer to a `fd_wksp_t` structure.
    - ``chunk0``: Unsigned long integer representing the initial chunk.
    - ``wmark``: Unsigned long integer representing the watermark.
    - ``mtu``: Unsigned long integer representing the maximum transmission unit.
    - ``net_rx``: Instance of `fd_net_rx_bounds_t` structure.
- **Description**: `in_ctx_t` is a union that provides two different views of the same memory space. It can either be accessed as a structure containing a pointer to a workspace (`mem`), initial chunk (`chunk0`), watermark (`wmark`), and maximum transmission unit (`mtu`), or as a `fd_net_rx_bounds_t` structure (`net_rx`). This design allows for flexible handling of input context data, depending on the specific requirements of the operation being performed.


---
### out\_ctx
- **Type**: ``struct``
- **Members**:
    - ``idx``: Stores the index of the outgoing context.
    - ``mem``: Pointer to a workspace memory structure.
    - ``chunk0``: Initial chunk index in the workspace.
    - ``wmark``: Watermark for the workspace memory.
    - ``chunk``: Current chunk index in the workspace.
    - ``in_idx``: Index of the incoming link.
    - ``credits``: Available credits for the link.
    - ``max_credits``: Maximum credits or depth for the link.
- **Description**: The `out_ctx` structure manages the context for outgoing links in a repair tile system. It includes indices and pointers for memory management, as well as credit tracking for asynchronous operations. The `credits` and `max_credits` fields are specifically used to manage the `sign_repair` link, ensuring that the system does not exceed its capacity and avoids deadlock scenarios.


---
### out\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``idx``: Index of the outgoing link.
    - ``mem``: Pointer to the workspace memory.
    - ``chunk0``: Initial chunk index in the workspace.
    - ``wmark``: Watermark for the workspace memory.
    - ``chunk``: Current chunk index in the workspace.
    - ``in_idx``: Index of the incoming link.
    - ``credits``: Available credits for the link.
    - ``max_credits``: Maximum credits (depth) for the link.
- **Description**: `out_ctx_t` is a structure that manages the context for outgoing links in a network communication system. It includes fields for tracking the index of the outgoing link, memory workspace, chunk indices, and credit management for flow control. The `credits` and `max_credits` fields are specifically used for managing the `repair_sign` link, ensuring that the number of items in the work queue does not exceed a specified limit to prevent overruns.


---
### fd\_fec\_sig
- **Type**: ``struct``
- **Members**:
    - ``key``: Contains a map key where the 32 most significant bits represent the slot and the 32 least significant bits represent the `fec_set_idx`.
    - ``sig``: Holds the Ed25519 signature identifier of the FEC.
- **Description**: The `fd_fec_sig` structure is used to represent a Forward Error Correction (FEC) signature in a network repair context. It contains a `key` that uniquely identifies a FEC set by combining slot and index information, and a `sig` that stores the Ed25519 signature associated with the FEC. This structure is essential for managing and verifying FEC signatures within the repair process.


---
### fd\_fec\_sig\_t
- **Type**: ``struct``
- **Members**:
    - ``key``: Map key with 32 most significant bits as slot and 32 least significant bits as FEC set index.
    - ``sig``: Ed25519 signature identifier of the FEC.
- **Description**: `fd_fec_sig_t` is a structure that holds information about a Forward Error Correction (FEC) signature. It contains a `key` that uniquely identifies the FEC set by combining the slot and FEC set index, and a `sig` which is the Ed25519 signature associated with the FEC. This structure is used to manage and verify FEC signatures within the repair tile's operations.


---
### pong\_data
- **Type**: ``struct``
- **Members**:
    - ``peer_addr``: Stores the peer's IPv4 address and port.
    - ``hash``: Contains a hash value related to the pong message.
    - ``daddr``: Holds the destination address for the pong message.
- **Description**: The `pong_data` structure contains information necessary to sign and send a pong message, which is not included in the pong message itself. It includes the peer's address and port, a hash value, and the destination address for the pong message.


---
### pong\_data\_t
- **Type**: ``struct``
- **Members**:
    - ``peer_addr``: Stores the IP address and port of the peer.
    - ``hash``: Contains a hash value used for verification or identification.
    - ``daddr``: Holds the destination address for the pong message.
- **Description**: Contains data necessary to sign and send a pong message, including peer address, hash, and destination address, which are not part of the pong message itself.


---
### sign\_req
- **Type**: ``struct``
- **Members**:
    - ``key``: Map key used for identifying the request, linked to `ctx->pending_key_next`.
    - ``buflen``: Length of the buffer or message.
    - ``buf``: Buffer to store data, sized to fit `fd_repair_msg_t`.
    - ``msg``: Message of type `fd_repair_msg_t`.
    - ``pong_data``: Data specific to pong messages, populated only for pong messages.
- **Description**: The `sign_req` structure is used to represent a signing request in the system. It contains a key for mapping purposes, a buffer length, and a union that can either hold a buffer or a message of type `fd_repair_msg_t`. Additionally, it includes `pong_data` which is used specifically for pong messages. This structure is part of the asynchronous request handling mechanism, where requests are sent to a sign tile and processed without blocking the repair tile.


---
### sign\_req\_t
- **Type**: ``struct``
- **Members**:
    - ``key``: A map key used to identify the request, typically `ctx->pending_key_next`.
    - ``buflen``: The length of the buffer that holds the message.
    - ``buf``: A buffer that can hold a message of type `fd_repair_msg_t`.
    - ``msg``: A union member that represents a repair message.
    - ``pong_data``: Data specific to pong messages, populated only for pong messages.
- **Description**: The `sign_req_t` structure is used to represent a signing request in the repair process. It contains a key to identify the request, a buffer to hold the message, and additional data specific to pong messages. The structure is part of a system that handles signing requests asynchronously, allowing the repair tile to continue processing other tasks while waiting for the signing to complete.


---
### sign\_pending
- **Type**: ``struct``
- **Members**:
    - ``msg``: Contains a repair message of type `fd_repair_msg_t`.
    - ``pong_data``: Holds additional data for pong messages, populated only for pong messages.
- **Description**: The `sign_pending` structure is used to store information about pending sign requests, specifically for repair messages and pong messages. It contains a repair message (`msg`) and additional pong-specific data (`pong_data`). This structure is part of a system that handles asynchronous signing requests, where messages are queued and processed for signing by a sign tile.


---
### sign\_pending\_t
- **Type**: ``struct``
- **Members**:
    - ``msg``: Contains the repair message to be signed.
    - ``pong_data``: Holds additional data for pong messages, populated only for pong messages.
- **Description**: `sign_pending_t` is a structure that holds information about pending sign requests, specifically for repair messages that need to be signed. It contains a repair message (`msg`) and additional pong data (`pong_data`) that is used only for pong messages. This structure is part of a queue system that manages sign requests, ensuring they are dispatched when sign tiles are available.


---
### ctx
- **Type**: ``struct``
- **Members**:
    - ``tsdebug``: Timestamp for debug printing.
    - ``repair_seed``: Seed for repair operations.
    - ``repair_intake_addr``: Address for repair intake.
    - ``repair_serve_addr``: Address for repair serving.
    - ``forest``: Pointer to a `fd_forest_t` structure.
    - ``fec_sigs``: Pointer to a `fd_fec_sig_t` structure.
    - ``store``: Pointer to a `fd_store_t` structure.
    - ``policy``: Pointer to a `fd_policy_t` structure.
    - ``inflight``: Pointer to a `fd_inflights_t` structure.
    - ``protocol``: Pointer to a `fd_repair_t` structure.
    - ``identity_public_key``: Public key for identity.
    - ``wksp``: Pointer to a `fd_wksp_t` structure.
    - ``stem``: Pointer to a `fd_stem_context_t` structure.
    - ``in_kind``: Array indicating the kind of input links.
    - ``in_links``: Array of `in_ctx_t` structures for input links.
    - ``skip_frag``: Flag to skip fragment processing.
    - ``net_out_idx``: Index for network output.
    - ``net_out_mem``: Pointer to a `fd_wksp_t` structure for network output memory.
    - ``net_out_chunk0``: Initial chunk for network output.
    - ``net_out_wmark``: Watermark for network output.
    - ``net_out_chunk``: Current chunk for network output.
    - ``snap_out_chunk``: Chunk for snapshot output.
    - ``shred_tile_cnt``: Count of shred tiles.
    - ``shred_out_ctx``: Array of `out_ctx_t` structures for shred output context.
    - ``repair_sign_cnt``: Count of repair sign links.
    - ``repair_sign_out_ctx``: Array of `out_ctx_t` structures for repair sign output context.
    - ``sign_rrobin_idx``: Index for round-robin distribution of sign requests.
    - ``pending_key_next``: Next key for pending sign requests.
    - ``signs_map``: Pointer to a `sign_req_t` structure map for sign requests.
    - ``sign_queue``: Pointer to a `sign_pending_t` structure queue for pending sign requests.
    - ``net_id``: Network identifier.
    - ``buffer``: Buffer for network data including headers.
    - ``intake_hdr``: Header for intake network packets.
    - ``serve_hdr``: Header for serve network packets.
    - ``manifest_slot``: Slot for manifest data.
    - ``metrics``: Structure for various metrics.
    - ``slot_metrics``: Pointer to a `fd_repair_metrics_t` structure for slot-level metrics.
    - ``turbine_slot0``: Slot indicating catchup completion.
- **Description**: Represents the context for handling repair operations, including network communication, signing requests, and managing various protocol and policy structures. It contains fields for managing input and output links, tracking metrics, and handling asynchronous operations. The structure is designed to facilitate the repair process by managing resources and state information necessary for efficient operation.


---
### ctx\_t
- **Type**: ``struct``
- **Members**:
    - `tsdebug`: Timestamp for debug printing.
    - `repair_seed`: Seed for repair operations.
    - `repair_intake_addr`: IP and port for repair intake.
    - `repair_serve_addr`: IP and port for repair serve.
    - `forest`: Pointer to `fd_forest_t` for managing the forest structure.
    - `fec_sigs`: Pointer to `fd_fec_sig_t` for managing FEC signatures.
    - `store`: Pointer to `fd_store_t` for storage operations.
    - `policy`: Pointer to `fd_policy_t` for policy management.
    - `inflight`: Pointer to `fd_inflights_t` for managing inflight requests.
    - `protocol`: Pointer to `fd_repair_t` for repair protocol operations.
    - `identity_public_key`: Public key for identity verification.
    - `wksp`: Pointer to `fd_wksp_t` for workspace management.
    - `stem`: Pointer to `fd_stem_context_t` for stem context.
    - `in_kind`: Array indicating the kind of each input link.
    - `in_links`: Array of `in_ctx_t` for managing input links.
    - `skip_frag`: Flag to indicate if a fragment should be skipped.
    - `net_out_idx`: Index for network output.
    - `net_out_mem`: Pointer to `fd_wksp_t` for network output memory.
    - `net_out_chunk0`: Initial chunk for network output.
    - `net_out_wmark`: Watermark for network output.
    - `net_out_chunk`: Current chunk for network output.
    - `snap_out_chunk`: Chunk for snapshot output.
    - `shred_tile_cnt`: Count of shred tiles.
    - `shred_out_ctx`: Array of `out_ctx_t` for managing shred output contexts.
    - `repair_sign_cnt`: Count of repair sign links.
    - `repair_sign_out_ctx`: Array of `out_ctx_t` for managing repair sign output contexts.
    - `sign_rrobin_idx`: Index for round-robin distribution of sign requests.
    - `pending_key_next`: Next key for pending sign requests.
    - `signs_map`: Pointer to `sign_req_t` map for managing sign requests.
    - `sign_queue`: Pointer to `sign_pending_t` queue for managing pending sign requests.
    - `net_id`: Network identifier.
    - `buffer`: Buffer for storing data.
    - `intake_hdr`: Header for intake network packets.
    - `serve_hdr`: Header for serve network packets.
    - `manifest_slot`: Slot for manifest operations.
    - `metrics`: Structure for managing various metrics.
    - `slot_metrics`: Pointer to `fd_repair_metrics_t` for slot-level metrics.
    - `turbine_slot0`: Slot indicating catchup completion.
- **Description**: `ctx_t` is a structure that manages the context for repair operations, including network communication, request handling, and metrics tracking. It contains various fields for managing input and output links, pending sign requests, and protocol operations. The structure also includes pointers to other structures for managing the forest, policy, inflight requests, and metrics. Additionally, it handles network packet headers and buffers for data storage.


# Functions

---
### scratch\_align<!-- {{#callable:scratch_align}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_tile.c#L319>)

Returns the alignment value for scratch memory, which is 128 bytes.
- **Inputs**: None
- **Logic and Control Flow**:
    - The function is defined as a static inline function, which suggests it is intended for use within the same translation unit and optimized for performance.
    - The function returns a constant value of 128UL, indicating the alignment requirement for scratch memory.
- **Output**: Returns an unsigned long integer value of 128, representing the alignment size.


---
### loose\_footprint<!-- {{#callable:loose_footprint}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_tile.c#L324>)

Calculates the memory footprint for a loose configuration using a gigantic page size.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure, which is not used in this function.
- **Logic and Control Flow**:
    - Returns the product of 1 and `FD_SHMEM_GIGANTIC_PAGE_SZ`.
- **Output**: The function returns an `ulong` representing the memory footprint size.


---
### scratch\_footprint<!-- {{#callable:scratch_footprint}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_tile.c#L329>)

Calculates the memory footprint required for various components of a repair tile based on the given tile configuration.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure that contains configuration details for the repair tile, including `repair_sign_depth`, `repair_sign_cnt`, and `slot_max`.
- **Logic and Control Flow**:
    - Calculate `total_sign_depth` as the product of `repair_sign_depth` and `repair_sign_cnt` from the `tile` structure.
    - Determine `lg_sign_depth` by finding the most significant bit of the smallest power of two greater than or equal to `total_sign_depth`, then add 1.
    - Initialize `l` with `FD_LAYOUT_INIT`.
    - Append various components to `l` using `FD_LAYOUT_APPEND`, specifying alignment and size for each component, including `ctx_t`, `fd_repair`, `fd_forest`, `fd_policy`, `fd_inflights`, `fd_fec_sig`, `fd_signs_map`, `fd_signs_queue`, and `fd_repair_metrics`.
    - Finalize the layout with `FD_LAYOUT_FINI` using `scratch_align()` and return the result.
- **Output**: Returns an `ulong` representing the total memory footprint required for the repair tile's components.
- **Functions Called**:
    - [`fd_repair_align`](<fd_repair.h.md#fd_repair_align>)
    - [`fd_repair_footprint`](<fd_repair.h.md#fd_repair_footprint>)
    - [`fd_policy_align`](<fd_policy.h.md#fd_policy_align>)
    - [`fd_policy_footprint`](<fd_policy.h.md#fd_policy_footprint>)
    - [`fd_inflights_align`](<fd_inflight.h.md#fd_inflights_align>)
    - [`fd_inflights_footprint`](<fd_inflight.h.md#fd_inflights_footprint>)
    - [`fd_repair_metrics_align`](<fd_repair_metrics.h.md#fd_repair_metrics_align>)
    - [`fd_repair_metrics_footprint`](<fd_repair_metrics.h.md#fd_repair_metrics_footprint>)
    - [`scratch_align`](<#scratch_align>)


---
### sign\_map\_insert<!-- {{#callable:sign_map_insert}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_tile.c#L349>)

Inserts a new pending sign request into the signs map if there is available space and returns a pointer to the inserted request.
- **Inputs**:
    - `ctx`: A pointer to the `ctx_t` structure, which contains the context for the operation, including the signs map and the next pending key.
    - `msg`: A pointer to a constant `fd_repair_msg_t` structure, representing the repair message to be signed.
    - `opt_pong_data`: A pointer to a constant `pong_data_t` structure, representing optional pong data to be included in the sign request.
- **Logic and Control Flow**:
    - Check if the signs map has reached its maximum capacity using `fd_signs_map_key_cnt` and `fd_signs_map_key_max` functions.
    - If the map is full, return `NULL` to indicate failure to insert a new request.
    - Insert a new sign request into the signs map using `fd_signs_map_insert` with the current `pending_key_next` value from the context, and increment `pending_key_next`.
    - If the insertion fails (unlikely unless the same nonce is used twice), return `NULL`.
    - Copy the contents of `msg` into the `msg` field of the newly inserted sign request.
    - Calculate the buffer length of the message using [`fd_repair_sz`](<fd_repair.h.md#fd_repair_sz>) and store it in the `buflen` field of the sign request.
    - If `opt_pong_data` is provided, copy its contents into the `pong_data` field of the sign request.
    - Return a pointer to the newly inserted sign request.
- **Output**: A pointer to the newly inserted `sign_req_t` structure, or `NULL` if the insertion fails.
- **Functions Called**:
    - [`fd_repair_sz`](<fd_repair.h.md#fd_repair_sz>)


---
### sign\_map\_remove<!-- {{#callable:sign_map_remove}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_tile.c#L365>)

Removes a pending sign request from the `signs_map` using a specified key.
- **Inputs**:
    - ``ctx``: A pointer to a `ctx_t` structure that contains the `signs_map` from which the function will remove a pending sign request.
    - ``key``: An unsigned long integer representing the key of the pending sign request to be removed from the `signs_map`.
- **Logic and Control Flow**:
    - Query the `signs_map` in the `ctx` structure using the provided `key` to find the pending sign request.
    - If the pending sign request is not found, return -1 to indicate failure.
    - If the pending sign request is found, remove it from the `signs_map`.
    - Return 0 to indicate successful removal of the sign request.
- **Output**: Returns 0 if the sign request is successfully removed, or -1 if the sign request is not found.


---
### send\_packet<!-- {{#callable:send_packet}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_tile.c#L374>)

Sends a network packet with specified IP and UDP headers, payload, and metadata, updating metrics and managing memory chunks.
- **Inputs**:
    - ``ctx``: A pointer to a `ctx_t` structure containing context and state information for the operation.
    - ``stem``: A pointer to a `fd_stem_context_t` structure used for publishing the packet.
    - ``is_intake``: An integer flag indicating whether to use the intake header (`1`) or the serve header (`0`).
    - ``dst_ip_addr``: The destination IP address for the packet.
    - ``dst_port``: The destination port for the packet.
    - ``src_ip_addr``: The source IP address for the packet.
    - ``payload``: A pointer to the payload data to be included in the packet.
    - ``payload_sz``: The size of the payload data in bytes.
    - ``tsorig``: The original timestamp for the packet.
- **Logic and Control Flow**:
    - Increment the send packet count in the metrics of `ctx`.
    - Allocate memory for the packet using `fd_chunk_to_laddr` with `ctx->net_out_mem` and `ctx->net_out_chunk`.
    - Copy the appropriate IP and UDP headers into the packet based on `is_intake`.
    - Set the source and destination IP addresses in the IP header.
    - Update the network ID and checksum in the IP header.
    - Set the destination port and length in the UDP header.
    - Copy the payload data into the packet after the headers.
    - Set the UDP checksum to zero.
    - Calculate the publication timestamp using `fd_frag_meta_ts_comp` and `fd_tickcount`.
    - Generate a signature for the packet using `fd_disco_netmux_sig`.
    - Calculate the total packet size including headers and payload.
    - Publish the packet using `fd_stem_publish` with the calculated signature, chunk, packet size, and timestamps.
    - Update `ctx->net_out_chunk` to the next available chunk using `fd_dcache_compact_next`.
- **Output**: No return value; the function operates by side effects, sending a packet and updating context state.


---
### sign\_avail\_credits<!-- {{#callable:sign_avail_credits}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_tile.c#L413>)

Finds and returns the `out_ctx_t` structure with the maximum available credits from the `repair_sign_out_ctx` array in the given context.
- **Inputs**:
    - `ctx`: A pointer to a `ctx_t` structure that contains the `repair_sign_out_ctx` array and its count `repair_sign_cnt`.
- **Logic and Control Flow**:
    - Initialize `sign_out` to `NULL` and `max_credits` to 0.
    - Iterate over each `out_ctx_t` in the `repair_sign_out_ctx` array using a loop from 0 to `ctx->repair_sign_cnt`.
    - For each `out_ctx_t`, check if its `credits` is greater than `max_credits`.
    - If true, update `max_credits` to the current `credits` and set `sign_out` to point to the current `out_ctx_t`.
    - After the loop, return `sign_out`.
- **Output**: Returns a pointer to the `out_ctx_t` structure with the maximum available credits, or `NULL` if no credits are available.


---
### fd\_repair\_send\_sign\_request<!-- {{#callable:fd_repair_send_sign_request}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_tile.c#L429>)

Prepares and sends a signing request for a repair message, which will be signed asynchronously by a sign tile.
- **Inputs**:
    - ``ctx``: A pointer to the context structure containing the state and configuration for the repair process.
    - ``sign_out``: A pointer to the output context structure for managing the sign request output.
    - ``msg``: A constant pointer to the repair message that needs to be signed.
    - ``opt_pong_data``: A constant pointer to optional pong data, used if the message kind is `FD_REPAIR_KIND_PONG`.
- **Logic and Control Flow**:
    - Insert a new sign request into the sign map using [`sign_map_insert`](<#sign_map_insert>) with the provided message and optional pong data.
    - If the insertion fails, return immediately.
    - Initialize variables `sig`, `preimage_sz`, and `dst` for signature, preimage size, and destination address respectively.
    - Check if the message kind is `FD_REPAIR_KIND_PONG`. If true, prepare a pong preimage using [`preimage_pong`](<fd_repair.h.md#preimage_pong>), copy it to the destination, and set the signature type to `FD_KEYGUARD_SIGN_TYPE_SHA256_ED25519`.
    - If the message kind is not `FD_REPAIR_KIND_PONG`, prepare the message preimage using [`preimage_req`](<fd_repair.h.md#preimage_req>), copy it to the destination, and set the signature type to `FD_KEYGUARD_SIGN_TYPE_ED25519`.
    - Publish the signing request using `fd_stem_publish` with the prepared signature and preimage size.
    - Update the `sign_out` chunk using `fd_dcache_compact_next` to manage memory allocation.
    - Increment the sent packet type metric for the message kind.
    - Decrement the available credits in `sign_out`.
- **Output**: No return value; the function operates by side effects on the provided context and output structures.
- **Functions Called**:
    - [`sign_map_insert`](<#sign_map_insert>)
    - [`preimage_pong`](<fd_repair.h.md#preimage_pong>)
    - [`preimage_req`](<fd_repair.h.md#preimage_req>)


---
### before\_frag<!-- {{#callable:before_frag}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_tile.c#L462>)

Determines if a fragment should be processed based on its type and signature.
- **Inputs**:
    - `ctx`: A pointer to the `ctx_t` structure, which contains context information for the operation.
    - `in_idx`: An unsigned long integer representing the index of the incoming link.
    - `seq`: An unsigned long integer representing the sequence number, which is unused in this function.
    - `sig`: An unsigned long integer representing the signature of the fragment.
- **Logic and Control Flow**:
    - Retrieve the kind of input from `ctx->in_kind` using `in_idx`.
    - If the input kind is `IN_KIND_NET`, check if the protocol of the signature is not `DST_PROTO_REPAIR` and return the result.
    - If the input kind is `IN_KIND_SHRED`, check if the root slot of the forest is `ULONG_MAX` and return -1 if true, otherwise return 0.
    - If the input kind is `IN_KIND_GOSSIP`, check if the signature is not `FD_GOSSIP_UPDATE_TAG_CONTACT_INFO` or `FD_GOSSIP_UPDATE_TAG_CONTACT_INFO_REMOVE` and return the result.
    - Return 0 if none of the above conditions are met.
- **Output**: An integer indicating whether the fragment should be processed (0) or not (non-zero).


---
### during\_frag<!-- {{#callable:during_frag}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_tile.c#L477>)

Processes incoming fragments based on their type and performs actions such as copying data to a buffer or logging errors.
- **Inputs**:
    - ``ctx``: A pointer to a `ctx_t` structure that holds the context for processing fragments.
    - ``in_idx``: An unsigned long integer representing the index of the incoming link.
    - ``seq``: An unsigned long integer representing the sequence number, marked as unused.
    - ``sig``: An unsigned long integer representing the signature, marked as unused.
    - ``chunk``: An unsigned long integer representing the chunk identifier.
    - ``sz``: An unsigned long integer representing the size of the data.
    - ``ctl``: An unsigned long integer representing control information.
- **Logic and Control Flow**:
    - Set `ctx->skip_frag` to 0 to indicate that the fragment should not be skipped.
    - Determine the kind of input (`in_kind`) using `ctx->in_kind[in_idx]` and retrieve the corresponding context (`in_ctx`).
    - For `IN_KIND_TOWER`, `IN_KIND_GOSSIP`, `IN_KIND_SHRED`, and `IN_KIND_SIGN`, check if `chunk` is within the valid range and `sz` is less than or equal to `mtu`; if not, log an error.
    - For `IN_KIND_TOWER`, `IN_KIND_NET`, `IN_KIND_GOSSIP`, `IN_KIND_SHRED`, and `IN_KIND_SIGN`, copy data from the source to `ctx->buffer` using `fd_memcpy`.
    - For `IN_KIND_GENESIS`, `IN_KIND_STAKE`, and `IN_KIND_SNAP`, return immediately without further processing.
    - For `IN_KIND_SNAP`, if the message signature is not `FD_SSMSG_DONE`, set `ctx->snap_out_chunk` to `chunk`.
    - Log an error if the input kind is unknown.
- **Output**: No return value; the function operates by modifying the `ctx` structure and performing side effects such as logging errors.


---
### after\_snap<!-- {{#callable:after_snap}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_tile.c#L547>)

Initializes the forest structure in the context with data from a snapshot manifest if the message signature indicates completion.
- **Inputs**:
    - ``ctx``: A pointer to the `ctx_t` structure, which holds the context for the operation.
    - ``sig``: An unsigned long integer representing the message signature.
    - ``chunk``: A pointer to an unsigned char array containing the snapshot manifest data.
- **Logic and Control Flow**:
    - Check if the message signature `sig` indicates completion using `fd_ssmsg_sig_message` and compare it to `FD_SSMSG_DONE`.
    - If the signature does not indicate completion, return immediately.
    - Cast the `chunk` pointer to a `fd_snapshot_manifest_t` pointer named `manifest`.
    - Initialize the forest in the context `ctx` using `fd_forest_init` with the slot from the `manifest`.
    - Verify that the root slot of the forest is not `ULONG_MAX` using `FD_TEST`.
- **Output**: No output is returned; the function modifies the `ctx` structure in place.


---
### after\_contact<!-- {{#callable:after_contact}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_tile.c#L558>)

Processes a contact update message to potentially initiate a proactive repair request.
- **Inputs**:
    - ``ctx``: A pointer to the `ctx_t` structure, which contains the context for the repair process.
    - ``msg``: A pointer to a `fd_gossip_update_message_t` structure, which contains the contact information of a peer.
- **Logic and Control Flow**:
    - Extracts the contact information from the `msg` parameter.
    - Retrieves the repair peer's address and port from the contact information.
    - Checks if the repair peer's address or port is invalid; if so, exits the function.
    - Inserts the peer into the policy using [`fd_policy_peer_insert`](<fd_policy.c.md#fd_policy_peer_insert>) with the public key and repair peer information.
    - If the peer is successfully inserted, creates a placeholder repair request using [`fd_repair_shred`](<fd_repair.c.md#fd_repair_shred>).
    - Pushes the created repair request into the sign queue using `fd_signs_queue_push`.
- **Output**: No return value; the function operates through side effects on the context and sign queue.
- **Functions Called**:
    - [`fd_policy_peer_insert`](<fd_policy.c.md#fd_policy_peer_insert>)
    - [`fd_repair_shred`](<fd_repair.c.md#fd_repair_shred>)


---
### after\_sign<!-- {{#callable:after_sign}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_tile.c#L575>)

Processes the completion of a signing request by updating credits, handling pending requests, and sending responses.
- **Inputs**:
    - ``ctx``: A pointer to the `ctx_t` structure, which contains the context for the operation.
    - ``in_idx``: An unsigned long integer representing the index of the incoming link.
    - ``sig``: An unsigned long integer representing the signature associated with the request.
    - ``stem``: A pointer to the `fd_stem_context_t` structure, which is used for sending packets.
- **Logic and Control Flow**:
    - Extracts the `pending_key` from the `sig` by shifting it 32 bits to the right.
    - Iterates over the `repair_sign_out_ctx` array to find the sign tile that sent the response and increments its credits if they are below the maximum.
    - Queries the `signs_map` for a pending request using the `pending_key`.
    - If no pending request is found, logs a critical error.
    - If the pending request is a PONG message, copies the signature from the buffer, sends a packet, and removes the request from the `signs_map`.
    - For regular repair shred requests, copies the signature to the pending buffer, queries the policy for an active peer, and handles the case where the peer is no longer active by selecting a new peer and re-queuing the request.
    - If the request is a regular repair request, inserts it into the inflight requests and updates the policy for the peer.
    - Sends a packet with the signed data and removes the request from the `signs_map`.
- **Output**: No return value; the function operates through side effects on the `ctx` and `stem` structures.
- **Functions Called**:
    - [`send_packet`](<#send_packet>)
    - [`fd_repair_sz`](<fd_repair.h.md#fd_repair_sz>)
    - [`sign_map_remove`](<#sign_map_remove>)
    - [`fd_policy_peer_query`](<fd_policy.c.md#fd_policy_peer_query>)
    - [`fd_policy_peer_select`](<fd_policy.c.md#fd_policy_peer_select>)
    - [`fd_inflights_request_insert`](<fd_inflight.c.md#fd_inflights_request_insert>)
    - [`fd_policy_peer_request_update`](<fd_policy.c.md#fd_policy_peer_request_update>)


---
### after\_shred<!-- {{#callable:after_shred}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_tile.c#L632>)

Processes a shred by inserting its signature into a map and updating various metrics and data structures based on its type and source.
- **Inputs**:
    - ``ctx``: A pointer to the `ctx_t` structure, which contains context and state information for the operation.
    - ``sig``: An unsigned long integer representing the signature of the shred.
    - ``shred``: A pointer to the `fd_shred_t` structure, which contains the shred data to be processed.
    - ``nonce``: An unsigned long integer used to identify the request associated with the shred.
- **Logic and Control Flow**:
    - Determine if the shred is a code shred using `fd_shred_is_code` and `fd_shred_type` functions.
    - Determine the source of the shred signature using `fd_disco_shred_out_shred_sig_is_turbine`.
    - If the shred is not a code shred, attempt to remove the request from inflight requests using [`fd_inflights_request_remove`](<fd_inflight.c.md#fd_inflights_request_remove>).
    - If the request removal is successful, update the peer response policy and sample the response latency.
    - Insert the shred into the forest data structure using `fd_forest_blk_insert` and `fd_forest_data_shred_insert`.
    - If the shred is a code shred, insert it into the forest using `fd_forest_code_shred_insert`.
- **Output**: No return value; the function operates by side effects on the provided context and data structures.
- **Functions Called**:
    - [`fd_inflights_request_remove`](<fd_inflight.c.md#fd_inflights_request_remove>)
    - [`fd_policy_peer_response_update`](<fd_policy.c.md#fd_policy_peer_response_update>)


---
### after\_fec<!-- {{#callable:after_fec}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_tile.c#L665>)

Handles the insertion of shreds into the forest and updates metrics when a FEC (Forward Error Correction) set is completed.
- **Inputs**:
    - ``ctx``: A pointer to the `ctx_t` structure, which contains the context for the operation, including the forest and metrics.
    - ``shred``: A pointer to the `fd_shred_t` structure, representing the shred to be processed.
- **Logic and Control Flow**:
    - Check if the shred's data flags indicate that the slot is complete and extract the reference tick.
    - Insert the shred into the forest using `fd_forest_blk_insert` and `fd_forest_fec_insert` functions.
    - Query the FEC signature map to check if a signature exists for the current FEC set and remove it if found.
    - Verify that the forest block element is non-empty using `FD_TEST`.
    - If the forest block is complete, calculate the duration since the first request or shred timestamp, update metrics, and log the completion information.
- **Output**: No explicit return value; the function updates the forest and metrics in the provided context.
- **Functions Called**:
    - [`fd_repair_metrics_add_slot`](<fd_repair_metrics.c.md#fd_repair_metrics_add_slot>)


---
### after\_net<!-- {{#callable:after_net}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_tile.c#L695>)

Processes incoming network packets, specifically handling UDP packets for repair protocol messages, and queues responses for signing.
- **Inputs**:
    - `ctx`: A pointer to a `ctx_t` structure that contains the context for processing network packets.
    - `sz`: An unsigned long integer representing the size of the data in the buffer.
- **Logic and Control Flow**:
    - Cast the buffer in `ctx` to an Ethernet header, then to an IPv4 header, and finally to a UDP header.
    - Calculate the data pointer by offsetting from the UDP header.
    - Check if the UDP header and data are within the bounds of the buffer size `sz`; return if not.
    - Extract the UDP payload size and validate it against the minimum UDP header size; return if invalid.
    - Calculate the data size by subtracting the UDP header size from the total UDP payload size.
    - Check if the data size is within the bounds of the buffer size `sz`; return if not.
    - Extract the source address and port from the IPv4 and UDP headers to form a `fd_ip4_port_t` structure.
    - Check if the destination port matches the repair intake address in `ctx`; if not, log a warning and return.
    - If the data size is less than the size of `fd_repair_ping_t`, return (potentially increment a malformed ping counter).
    - Cast the data to a `fd_repair_ping_t` structure and switch on the `kind` field.
    - If the kind is `FD_REPAIR_KIND_PING`, create a pong message and push it to the sign queue with the peer address and hash.
    - Log an error if the kind is unhandled.
- **Output**: No explicit output; the function modifies the context and potentially logs messages or pushes to a queue.
- **Functions Called**:
    - [`fd_repair_pong`](<fd_repair.h.md#fd_repair_pong>)


---
### after\_evict<!-- {{#callable:after_evict}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_tile.c#L729>)

Clears the Forward Error Correction (FEC) data for a specific slot and FEC set index in the forest context.
- **Inputs**:
    - ``ctx``: A pointer to the `ctx_t` structure, which contains the forest context and other relevant data.
    - ``sig``: An unsigned long integer representing the signature used to determine the slot, FEC set index, and maximum index for clearing.
- **Logic and Control Flow**:
    - Extracts the `spilled_slot` from the `sig` using `fd_disco_shred_out_shred_sig_slot` function.
    - Extracts the `spilled_fec_set_idx` from the `sig` using `fd_disco_shred_out_shred_sig_fec_set_idx` function.
    - Extracts the `spilled_max_idx` from the `sig` using `fd_disco_shred_out_shred_sig_data_cnt` function.
    - Calls `fd_forest_fec_clear` with the extracted `spilled_slot`, `spilled_fec_set_idx`, and `spilled_max_idx` to clear the FEC data in the forest.
- **Output**: No return value; the function operates directly on the `ctx` structure to clear FEC data.


---
### after\_frag<!-- {{#callable:after_frag}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_tile.c#L739>)

Processes incoming fragments based on their type and updates the context accordingly.
- **Inputs**:
    - ``ctx``: Pointer to the context structure that holds the state and data for processing.
    - ``in_idx``: Index of the incoming link from which the fragment is received.
    - ``seq``: Sequence number of the fragment (unused in this function).
    - ``sig``: Signature or identifier of the fragment.
    - ``sz``: Size of the fragment.
    - ``tsorig``: Original timestamp of the fragment (unused in this function).
    - ``tspub``: Publication timestamp of the fragment (unused in this function).
    - ``stem``: Pointer to the stem context used for publishing data.
- **Logic and Control Flow**:
    - Checks if `ctx->skip_frag` is true and returns immediately if so.
    - Sets `ctx->stem` to the provided `stem` pointer.
    - Retrieves the kind of input from `ctx->in_kind[in_idx]` and processes based on the type.
    - For `IN_KIND_GENESIS` with `sig` equal to `GENESI_SIG_BOOTSTRAP_COMPLETED`, initializes the forest and resets the policy.
    - For `IN_KIND_GOSSIP`, processes contact information or removes a peer based on the signature.
    - For `IN_KIND_TOWER`, publishes the new root slot and resets the policy if `msg->new_root` is true.
    - For `IN_KIND_SIGN`, calls [`after_sign`](<#after_sign>) to handle the signed fragment.
    - For `IN_KIND_SHRED`, handles different message types such as resolver evict, FEC complete, and new shred, updating the forest and metrics accordingly.
    - For `IN_KIND_STAKE`, simply returns as no processing is needed.
    - For `IN_KIND_SNAP`, calls [`after_snap`](<#after_snap>) to process the snapshot.
    - For `IN_KIND_NET`, calls [`after_net`](<#after_net>) to process the network fragment.
- **Output**: No direct output; modifies the context and state based on the fragment type.
- **Functions Called**:
    - [`fd_policy_reset`](<fd_policy.c.md#fd_policy_reset>)
    - [`after_contact`](<#after_contact>)
    - [`fd_policy_peer_remove`](<fd_policy.c.md#fd_policy_peer_remove>)
    - [`after_sign`](<#after_sign>)
    - [`after_evict`](<#after_evict>)
    - [`fd_repair_metrics_set_turbine_slot0`](<fd_repair_metrics.c.md#fd_repair_metrics_set_turbine_slot0>)
    - [`fd_policy_set_turbine_slot0`](<fd_policy.c.md#fd_policy_set_turbine_slot0>)
    - [`after_fec`](<#after_fec>)
    - [`after_shred`](<#after_shred>)
    - [`after_snap`](<#after_snap>)
    - [`after_net`](<#after_net>)


---
### after\_credit<!-- {{#callable:after_credit}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_tile.c#L896>)

Manages the process of sending sign requests to available sign tiles and handles pending sign requests.
- **Inputs**:
    - ``ctx``: A pointer to the `ctx_t` structure, which contains the context for the repair process.
    - ``stem``: A pointer to the `fd_stem_context_t` structure, which is unused in this function.
    - ``opt_poll_in``: A pointer to an integer, which is unused in this function.
    - ``charge_busy``: A pointer to an integer that is set to 1 to indicate the function has performed work.
- **Logic and Control Flow**:
    - Get the current wall clock time using `fd_log_wallclock()` and store it in `now`.
    - Set `*charge_busy` to 1 to indicate that the function has performed work.
    - Call `sign_avail_credits(ctx)` to check for available sign tiles with credits.
    - If no sign tiles are available, increment `ctx->metrics->sign_tile_unavail` and return.
    - If the sign queue is not empty, pop a sign request from the queue and send it using `fd_repair_send_sign_request()`.
    - If the sign queue is empty, call `fd_policy_next()` to get the next repair message to send.
    - If a repair message is available, send it using `fd_repair_send_sign_request()`.
- **Output**: No return value; the function modifies the state of the `ctx` and potentially sends sign requests.
- **Functions Called**:
    - [`sign_avail_credits`](<#sign_avail_credits>)
    - [`fd_repair_send_sign_request`](<#fd_repair_send_sign_request>)
    - [`fd_policy_next`](<fd_policy.c.md#fd_policy_next>)


---
### during\_housekeeping<!-- {{#callable:during_housekeeping}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_tile.c#L924>)

Performs periodic housekeeping tasks, including logging debug information if enabled.
- **Inputs**:
    - `ctx`: A pointer to a `ctx_t` structure, which contains context information for the operation.
- **Logic and Control Flow**:
    - The function takes a `ctx_t` pointer as input, which is not used in the function body when `DEBUG_LOGGING` is disabled.
    - If `DEBUG_LOGGING` is enabled, the function retrieves the current wall clock time using `fd_log_wallclock()`.
    - It checks if the difference between the current time and the last debug timestamp (`ctx->tsdebug`) exceeds 10 seconds.
    - If the condition is met, it prints the forest structure using `fd_forest_print()` and updates `ctx->tsdebug` with the current time.
- **Output**: No output is returned as the function is `void`.


---
### privileged\_init<!-- {{#callable:privileged_init}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_tile.c#L936>)

Initializes a privileged context for a repair tile by setting up memory and loading identity keys.
- **Inputs**:
    - ``topo``: A pointer to an `fd_topo_t` structure representing the topology configuration.
    - ``tile``: A pointer to an `fd_topo_tile_t` structure representing the tile configuration.
- **Logic and Control Flow**:
    - Obtain a scratch memory address using `fd_topo_obj_laddr` with `topo` and `tile->tile_obj_id`.
    - Initialize a scratch allocator with `FD_SCRATCH_ALLOC_INIT`.
    - Allocate memory for a `ctx_t` structure using `FD_SCRATCH_ALLOC_APPEND` and set it to zero using `fd_memset`.
    - Load the identity key from the path specified in `tile->repair.identity_key_path` using `fd_keyload_load`.
    - Copy the public part of the identity key into `ctx->identity_public_key.uc` using `fd_memcpy`.
    - Generate a secure random seed for `ctx->repair_seed` using `fd_rng_secure`.
- **Output**: No return value; the function initializes the context in place.


---
### unprivileged\_init<!-- {{#callable:unprivileged_init}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_tile.c#L951>)

Initializes the unprivileged context for a repair tile in a network topology.
- **Inputs**:
    - ``topo``: A pointer to the `fd_topo_t` structure representing the network topology.
    - ``tile``: A pointer to the `fd_topo_tile_t` structure representing the specific tile in the topology to initialize.
- **Logic and Control Flow**:
    - Calculate `total_sign_depth` and `lg_sign_depth` based on the repair sign depth and count from the `tile` structure.
    - Initialize a scratch memory allocator with `FD_SCRATCH_ALLOC_INIT`.
    - Allocate and initialize various components of the `ctx_t` structure using `FD_SCRATCH_ALLOC_APPEND`, including `protocol`, `forest`, `policy`, `inflight`, `fec_sigs`, `signs_map`, `sign_queue`, and `slot_metrics`.
    - Verify the scratch allocation with `FD_SCRATCH_ALLOC_FINI`.
    - Join the allocated components to their respective contexts using functions like [`fd_repair_join`](<fd_repair.c.md#fd_repair_join>), `fd_forest_join`, etc.
    - Check the number of input links and log an error if it exceeds `MAX_IN_LINKS`.
    - Iterate over input links to initialize them based on their type (e.g., `net_repair`, `sign_repair`, etc.) and set up their memory and bounds.
    - Initialize output links similarly, setting up `net_out`, `shred_out`, and `repair_sign_out` contexts.
    - Verify the presence of required links and log errors if any are missing.
    - Set up network addresses and headers for repair intake and serve operations.
    - Log the initialized repair addresses and set up metrics and debug timestamps.
- **Output**: No return value; the function initializes the context for a repair tile.
- **Functions Called**:
    - [`fd_repair_align`](<fd_repair.h.md#fd_repair_align>)
    - [`fd_repair_footprint`](<fd_repair.h.md#fd_repair_footprint>)
    - [`fd_policy_align`](<fd_policy.h.md#fd_policy_align>)
    - [`fd_policy_footprint`](<fd_policy.h.md#fd_policy_footprint>)
    - [`fd_inflights_align`](<fd_inflight.h.md#fd_inflights_align>)
    - [`fd_inflights_footprint`](<fd_inflight.h.md#fd_inflights_footprint>)
    - [`fd_repair_metrics_align`](<fd_repair_metrics.h.md#fd_repair_metrics_align>)
    - [`fd_repair_metrics_footprint`](<fd_repair_metrics.h.md#fd_repair_metrics_footprint>)
    - [`scratch_align`](<#scratch_align>)
    - [`scratch_footprint`](<#scratch_footprint>)
    - [`fd_repair_join`](<fd_repair.c.md#fd_repair_join>)
    - [`fd_repair_new`](<fd_repair.c.md#fd_repair_new>)
    - [`fd_policy_join`](<fd_policy.c.md#fd_policy_join>)
    - [`fd_policy_new`](<fd_policy.c.md#fd_policy_new>)
    - [`fd_inflights_join`](<fd_inflight.c.md#fd_inflights_join>)
    - [`fd_inflights_new`](<fd_inflight.c.md#fd_inflights_new>)
    - [`fd_repair_metrics_join`](<fd_repair_metrics.c.md#fd_repair_metrics_join>)
    - [`fd_repair_metrics_new`](<fd_repair_metrics.c.md#fd_repair_metrics_new>)


---
### populate\_allowed\_seccomp<!-- {{#callable:populate_allowed_seccomp}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_tile.c#L1103>)

Configures a seccomp filter for a repair tile by populating a socket filter policy.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, which is not used in this function.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure, which is not used in this function.
    - ``out_cnt``: An unsigned long integer representing the count of output filters to populate.
    - ``out``: A pointer to a `struct sock_filter` array where the function will populate the seccomp filter rules.
- **Logic and Control Flow**:
    - Calls [`populate_sock_filter_policy_fd_repair_tile`](<generated/fd_repair_tile_seccomp.h.md#populate_sock_filter_policy_fd_repair_tile>) with `out_cnt`, `out`, the file descriptor of the log file, and -1 as arguments.
    - Returns the value of `sock_filter_policy_fd_repair_tile_instr_cnt`.
- **Output**: Returns an unsigned long integer representing the number of instructions in the seccomp filter policy.
- **Functions Called**:
    - [`populate_sock_filter_policy_fd_repair_tile`](<generated/fd_repair_tile_seccomp.h.md#populate_sock_filter_policy_fd_repair_tile>)


---
### populate\_allowed\_fds<!-- {{#callable:populate_allowed_fds}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_tile.c#L1113>)

Populates an array with file descriptors for `stderr` and optionally a log file, returning the count of populated descriptors.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, which is unused in this function.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure, which is unused in this function.
    - ``out_fds_cnt``: The maximum number of file descriptors that can be stored in the `out_fds` array.
    - ``out_fds``: A pointer to an array of integers where the function will store the file descriptors.
- **Logic and Control Flow**:
    - Check if `out_fds_cnt` is less than 2; if true, log an error and terminate.
    - Initialize `out_cnt` to 0.
    - Assign the file descriptor for `stderr` (2) to `out_fds[out_cnt]` and increment `out_cnt`.
    - Check if the log file descriptor is valid (not -1); if true, assign it to `out_fds[out_cnt]` and increment `out_cnt`.
    - Return `out_cnt`, the number of file descriptors populated.
- **Output**: Returns the number of file descriptors populated in the `out_fds` array.


---
### metrics\_write<!-- {{#callable:metrics_write}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair_tile.c#L1127>)

Updates various repair metrics in the context structure using predefined macros.
- **Inputs**:
    - ``ctx``: A pointer to a `ctx_t` structure containing the metrics to update.
- **Logic and Control Flow**:
    - Set the `CURRENT_SLOT` metric using `ctx->metrics->current_slot`.
    - Set the `REPAIRED_SLOTS` metric using `ctx->metrics->repaired_slots`.
    - Set the `REQUEST_PEERS` metric using the result of `fd_peer_pool_used(ctx->policy->peers.pool)`.
    - Set the `SIGN_TILE_UNAVAIL` metric using `ctx->metrics->sign_tile_unavail`.
    - Set the `TOTAL_PKT_COUNT` metric using `ctx->metrics->send_pkt_cnt`.
    - Copy the `SENT_PKT_TYPES` metrics from `ctx->metrics->sent_pkt_types`.
    - Copy the `SLOT_COMPLETE_TIME` histogram from `ctx->metrics->slot_compl_time`.
    - Copy the `RESPONSE_LATENCY` histogram from `ctx->metrics->response_latency`.
- **Output**: None (void function).



---
Made with ❤️ by [Driver](https://www.driver.ai/)