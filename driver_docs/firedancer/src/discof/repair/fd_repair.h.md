<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements the Solana Repair protocol for recovering missing shreds with message types like Pong, Shred, HighestShred, and Orphan.

# Purpose
The code defines the implementation of the Solana Repair protocol, which is used for recovering missing shreds that a validator expects but has not received. The file is a C header file that provides the necessary data structures and function prototypes to facilitate the repair process. It does not include the logic for determining when a validator should expect a shred or which peer to request it from; instead, it focuses on the protocol for requesting shreds from other validators. The protocol supports four message types: `Pong`, `Shred`, `HighestShred`, and `Orphan`, each serving a specific purpose in the repair process. The `Pong` message is part of a Ping-Pong protocol for address validation, while the other messages are used to request specific shreds or information about shreds from peer validators.

The file defines several data structures, such as `fd_repair_pong_t`, `fd_repair_shred_req_t`, `fd_repair_highest_shred_req_t`, and `fd_repair_orphan_req_t`, which represent the different types of repair requests. It also includes a `fd_repair_msg_t` structure that encapsulates all message types. The code provides function prototypes for creating and managing repair requests, such as [`fd_repair_new`](<#fd_repair_new>), [`fd_repair_join`](<#fd_repair_join>), [`fd_repair_leave`](<#fd_repair_leave>), and [`fd_repair_delete`](<#fd_repair_delete>). Additionally, it includes utility functions for handling message serialization and preimage generation for signing. The file uses bincode serialization for communication and includes runtime checks and logging if `FD_REPAIR_USE_HANDHOLDING` is defined.
# Imports and Dependencies

---
- `../../ballet/ed25519/fd_ed25519.h`
- `../../flamenco/types/fd_types_custom.h`


# Global Variables

---
### from
- **Type**: `fd_pubkey_t`
- **Description**: `from` is a variable of type `fd_pubkey_t` that represents the public key of the validator that sent a request in the Solana Repair protocol.
- **Use**: Used to identify the sender of a repair request in the protocol's message header.


---
### to
- **Type**: `fd_pubkey_t`
- **Description**: The `to` variable is a public key of the validator that is being requested in the repair protocol.
- **Use**: Used to specify the recipient validator in repair requests.


---
### ts
- **Type**: `ulong`
- **Description**: A timestamp in milliseconds since the Unix epoch (1970-01-01T00:00:00Z).
- **Use**: Used as part of the common header in repair request messages to indicate the time of the request.


---
### nonce
- **Type**: `uint`
- **Description**: A 32-bit unsigned integer used as a nonce in the repair protocol.
- **Use**: Echoed back by the responding validator in the repair response.


---
### null\_pubkey
- **Type**: ``fd_pubkey_t``
- **Description**: A static constant variable of type `fd_pubkey_t`, initialized with all zero values. It represents a public key with no specific value or identity.
- **Use**: Used as a placeholder or default value for public key fields where no valid key is available or required.


# Data Structures

---
### fd\_repair\_pong
- **Type**: ``struct``
- **Members**:
    - `from`: Public key of the validator responding with the pong.
    - `hash`: SHA-256 hash generated from a ping hash.
    - `sig`: Signature of the `from` field over the preceding hash field.
- **Description**: Defines the structure of a Pong message in the Solana Repair protocol, which is used to validate the identity of a validator responding to a repair request. The structure includes the public key of the responding validator, a hash generated from a ping token, and a signature to ensure the integrity and authenticity of the hash.


---
### fd\_repair\_pong\_t
- **Type**: ``struct fd_repair_pong``
- **Members**:
    - `from`: Public key of the validator responding with the pong.
    - `hash`: SHA-256 hash generated from a ping hash.
    - `sig`: Signature of the `from` validator over the preceding hash field.
- **Description**: Defines the schema for a Pong message in the Solana Repair protocol, which is used to validate the identity of a validator through a Ping-Pong protocol. The structure contains the public key of the responding validator, a hash generated from a ping token, and a signature over this hash to ensure authenticity.


---
### fd\_repair\_shred\_req
- **Type**: ``struct fd_repair_shred_req``
- **Members**:
    - ``REQ_HDR``: Defines a common header for repair request types, including fields for signature, sender and receiver public keys, timestamp, and nonce.
    - ``slot``: Specifies the slot number for the requested shred.
    - ``shred_idx``: Indicates the index of the shred within the specified slot.
- **Description**: Requests a specific shred from a peer validator by specifying the slot and shred index, using a common header for repair requests.


---
### fd\_repair\_shred\_req\_t
- **Type**: ``struct fd_repair_shred_req``
- **Members**:
    - ``sig``: ed25519 signature over all the subsequent fields.
    - ``from``: Public key of the validator that sent the request.
    - ``to``: Public key of the validator that is being requested.
    - ``ts``: Timestamp in milliseconds since the UNIX epoch.
    - ``nonce``: Nonce to be echoed back by the responding validator.
    - ``slot``: Slot number for which the shred is requested.
    - ``shred_idx``: Index of the shred within the specified slot.
- **Description**: Requests a specific shred at a given slot and shred index from a peer validator, using a common header that includes a signature, public keys of the sender and receiver, a timestamp, and a nonce.


---
### fd\_repair\_highest\_shred\_req
- **Type**: ``struct fd_repair_highest_shred_req``
- **Members**:
    - ``REQ_HDR``: Defines a common header for repair request types, including signature, sender and receiver public keys, timestamp, and nonce.
    - ``slot``: Specifies the slot number for which the highest shred is requested.
    - ``shred_idx``: Indicates the minimum shred index for the requested highest shred.
- **Description**: Represents a request for the highest shred in a specified slot that is greater than or equal to a given shred index, used in the Solana Repair protocol to recover missing shreds from peer validators.


---
### fd\_repair\_highest\_shred\_req\_t
- **Type**: ``struct``
- **Members**:
    - ``sig``: ed25519 signature over all the subsequent fields.
    - ``from``: Public key of the validator that sent the request.
    - ``to``: Public key of the validator that is being requested.
    - ``ts``: Timestamp in milliseconds since the UNIX epoch.
    - ``nonce``: Nonce to be echoed back by the responding validator.
    - ``slot``: Slot number for which the highest shred is requested.
    - ``shred_idx``: Shred index that the requested shred must be greater than or equal to.
- **Description**: Requests the highest shred in a specified slot that is greater than or equal to a given shred index from a peer validator. It includes a common header with fields for signature, sender and receiver public keys, timestamp, and nonce, followed by the slot and shred index fields specific to this request type.


---
### fd\_repair\_orphan\_req
- **Type**: ``struct``
- **Members**:
    - ``REQ_HDR``: Defines a common header for repair request types, including fields for signature, sender and receiver public keys, timestamp, and nonce.
    - ``slot``: Specifies the slot number for which ancestor shreds are requested.
- **Description**: Requests ancestor shreds for a given slot from a peer validator, allowing the peer to respond with up to 10 ancestor shreds, each being the last shred for its respective slot.


---
### fd\_repair\_orphan\_req\_t
- **Type**: ``struct``
- **Members**:
    - ``sig``: ed25519 signature over all the subsequent fields.
    - ``from``: Public key of the validator that sent the request.
    - ``to``: Public key of the validator that is being requested.
    - ``ts``: Timestamp in milliseconds since UNIX epoch.
    - ``nonce``: Nonce to be echoed back by the responding validator.
    - ``slot``: Slot number for which the orphan request is made.
- **Description**: Represents a request to retrieve ancestor shreds of a specified slot from a peer validator, where the peer can respond with shreds for up to 10 ancestor slots, each being the last shred for that slot.


---
### fd\_repair\_msg
- **Type**: ``struct``
- **Members**:
    - ``kind``: An unsigned integer that specifies the type of repair message, using predefined constants like `FD_REPAIR_KIND_PONG`, `FD_REPAIR_KIND_SHRED`, `FD_REPAIR_KIND_HIGHEST_SHRED`, and `FD_REPAIR_KIND_ORPHAN`.
    - ``pong``: A member of type `fd_repair_pong_t` used when the message is a Pong type.
    - ``shred``: A member of type `fd_repair_shred_req_t` used when the message is a Shred request.
    - ``highest_shred``: A member of type `fd_repair_highest_shred_req_t` used when the message is a Highest Shred request.
    - ``orphan``: A member of type `fd_repair_orphan_req_t` used when the message is an Orphan request.
- **Description**: Defines a packed structure for repair messages in the Solana Repair protocol, which includes a `kind` field to specify the message type and a union to hold the specific message data for Pong, Shred, Highest Shred, or Orphan requests.


---
### fd\_repair\_msg\_t
- **Type**: ``struct``
- **Members**:
    - ``kind``: Specifies the type of repair message using predefined constants like `FD_REPAIR_KIND_PONG`, `FD_REPAIR_KIND_SHRED`, etc.
    - ``pong``: Holds data for a Pong message, including a public key, hash, and signature.
    - ``shred``: Contains fields for a Shred request, including a signature, public keys, timestamp, nonce, slot, and shred index.
    - ``highest_shred``: Contains fields for a Highest Shred request, including a signature, public keys, timestamp, nonce, slot, and shred index.
    - ``orphan``: Contains fields for an Orphan request, including a signature, public keys, timestamp, nonce, and slot.
- **Description**: Defines the schema for all types of repair messages in the Solana Repair protocol, using a union to encapsulate different message types such as Pong, Shred, Highest Shred, and Orphan, each with its own specific data structure.


---
### fd\_repair\_ping
- **Type**: `struct`
- **Members**:
    - ``kind``: An unsigned integer that specifies the type of message, using predefined constants like `FD_REPAIR_KIND_PING`.
    - ``ping``: A `fd_repair_pong_t` structure that contains the ping data for the repair protocol.
- **Description**: Represents a packed structure used in the Solana Repair protocol to handle ping messages. It includes a `kind` field to identify the message type and a `ping` field that holds the ping data, encapsulated in a `fd_repair_pong_t` structure. This structure is part of the protocol's mechanism to validate addresses through a Ping-Pong exchange.


---
### fd\_repair\_ping\_t
- **Type**: ``struct``
- **Members**:
    - ``kind``: Specifies the type of repair message, using predefined constants like `FD_REPAIR_KIND_PONG`.
    - ``ping``: Contains the `fd_repair_pong_t` structure, which holds the details of a Pong message.
- **Description**: Defines the structure for a repair ping message in the Solana Repair protocol, which includes a message type identifier and a Pong message structure for address validation in the Ping-Pong protocol.


---
### fd\_repair
- **Type**: ``struct``
- **Members**:
    - `identity_key`: Validator identity key.
    - `sign_fn`: User-provided signing callback function.
    - `sign_ctx`: User-provided context for the signing callback.
    - `msg`: Buffer for outgoing repair requests.
- **Description**: Implements the Solana Repair protocol, which is used to recover shreds that a validator expects but has not received. It includes a validator's identity key, a user-provided signing function and context, and a message buffer for outgoing repair requests. The structure facilitates the creation and management of repair requests in the Solana network.


---
### fd\_repair\_t
- **Type**: ``struct``
- **Members**:
    - ``identity_key``: Holds the public key of the validator.
    - ``sign_fn``: Pointer to a user-provided function for signing messages.
    - ``sign_ctx``: User-provided context for the signing callback function.
    - ``msg``: Buffer for storing outgoing repair requests.
- **Description**: Implements the Solana Repair protocol, which is used to recover missing shreds that a validator expects but has not received. The structure contains the validator's identity key, a function pointer for signing messages, a context for the signing function, and a message buffer for outgoing requests. The protocol supports different message types such as Pong, Shred, HighestShred, and Orphan, each serving a specific purpose in the repair process.


# Functions

---
### fd\_repair\_align<!-- {{#callable:fd_repair_align}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair.h#L191>)

Returns the alignment requirement of the `fd_repair_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls the `alignof` operator on `fd_repair_t` to determine its alignment requirement.
    - Returns the result of the `alignof` operation.
- **Output**: The alignment requirement of the `fd_repair_t` structure as an `ulong`.


---
### fd\_repair\_footprint<!-- {{#callable:fd_repair_footprint}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair.h#L196>)

Returns the size in bytes of the `fd_repair_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calculate the size of the `fd_repair_t` structure using the `sizeof` operator.
    - Return the calculated size.
- **Output**: The function returns an `ulong` representing the size in bytes of the `fd_repair_t` structure.


---
### fd\_repair\_sz<!-- {{#callable:fd_repair_sz}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair.h#L249>)

Calculates the size of a serialized repair message based on its type.
- **Inputs**:
    - `msg`: A pointer to a `fd_repair_msg_t` structure representing the repair message whose size is to be calculated.
- **Logic and Control Flow**:
    - Check the `kind` field of the `msg` to determine the type of repair message.
    - If `kind` is `FD_REPAIR_KIND_PONG`, return the size of a `uint` plus the size of `fd_repair_pong_t`.
    - If `kind` is `FD_REPAIR_KIND_SHRED`, return the size of a `uint` plus the size of `fd_repair_shred_req_t`.
    - If `kind` is `FD_REPAIR_KIND_HIGHEST_SHRED`, return the size of a `uint` plus the size of `fd_repair_highest_shred_req_t`.
    - If `kind` is `FD_REPAIR_KIND_ORPHAN`, return the size of a `uint` plus the size of `fd_repair_orphan_req_t`.
    - If `kind` does not match any known type, log an error indicating an unhandled repair kind.
- **Output**: Returns the size of the serialized repair message as an `ulong`.


---
### preimage\_pong<!-- {{#callable:preimage_pong}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair.h#L264>)

Creates a preimage by concatenating a predefined prefix with a ping token and returns a pointer to the preimage buffer.
- **Inputs**:
    - `ping_token`: A pointer to a `fd_hash_t` structure representing the ping token to be included in the preimage.
    - `preimage_buf`: A pointer to a buffer where the preimage will be stored.
    - `preimage_sz`: The size of the preimage buffer, expected to be `FD_REPAIR_PONG_PREIMAGE_SZ`.
- **Logic and Control Flow**:
    - If `FD_REPAIR_USE_HANDHOLDING` is defined, check if `preimage_sz` is equal to `FD_REPAIR_PONG_PREIMAGE_SZ`; if not, log an error.
    - Calculate the size of the prefix by subtracting one from the size of `FD_REPAIR_PONG_PREIMAGE_PREFIX` to exclude the null terminator.
    - Copy the prefix `FD_REPAIR_PONG_PREIMAGE_PREFIX` into the `preimage_buf`.
    - Copy the `ping_token` into the `preimage_buf` immediately after the prefix.
    - Return the `preimage_buf` pointer.
- **Output**: A pointer to the `preimage_buf` containing the concatenated prefix and ping token.


---
### preimage\_req<!-- {{#callable:preimage_req}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair.h#L300>)

Generates a preimage for signing from a repair request message by adjusting the message structure and calculating the preimage size.
- **Inputs**:
    - `msg`: A pointer to a `fd_repair_msg_t` structure representing the repair request message.
    - `preimage_sz`: A pointer to an `ulong` where the function will store the size of the preimage.
- **Logic and Control Flow**:
    - Cast the `msg` pointer to a `uchar` pointer and assign it to `preimage`.
    - Advance the `preimage` pointer by the size of `fd_ed25519_sig_t` to skip the signature field.
    - Store the `kind` field of `msg` at the current `preimage` location using `FD_STORE`.
    - Calculate the preimage size by subtracting the size of `fd_ed25519_sig_t` from the serialized size of `msg` and store it in `preimage_sz`.
    - Return the `preimage` pointer.
- **Output**: A pointer to the preimage that can be signed, with the size of the preimage stored in `preimage_sz`.
- **Functions Called**:
    - [`fd_repair_sz`](<#fd_repair_sz>)


# Function Declarations (Public API)

---
### fd\_repair\_new<!-- {{#callable_declaration:fd_repair_new}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair.h#L206>)

Formats a memory region for use as a repair structure.
- **Description**: Use this function to initialize a memory region for the repair protocol, which is part of the Solana Repair protocol implementation. The memory region must be non-null, properly aligned, and have the required footprint. This function sets up the region with the provided identity key, which is necessary for the repair protocol operations. Ensure that the memory region is correctly aligned and has the necessary size before calling this function.
- **Inputs**:
    - `shmem`: A non-null pointer to a memory region with the required alignment and footprint. If null or misaligned, the function returns null.
    - `identity_key`: A pointer to an `fd_pubkey_t` structure containing the public identity key. The caller retains ownership of this key.
- **Output**: Returns a pointer to the initialized memory region on success, or null if the input is invalid.
- **See Also**: [`fd_repair_new`](<fd_repair.c.md#fd_repair_new>)  (Implementation)


---
### fd\_repair\_join<!-- {{#callable_declaration:fd_repair_join}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair.h#L214>)

Joins a caller to a repair instance.
- **Description**: Use this function to join a caller to a repair instance by providing a pointer to the memory region backing the repair. This function checks if the provided pointer is non-null, properly aligned, and part of a workspace. If any of these conditions are not met, it logs a warning and returns null. This function is typically called after initializing the repair instance with `fd_repair_new`.
- **Inputs**:
    - `shrepair`: A pointer to the memory region backing the repair. Must not be null, must be aligned according to `fd_repair_align`, and must be part of a workspace. If these conditions are not met, the function logs a warning and returns null.
- **Output**: Returns a pointer to the repair instance in the local address space on success, or null if the input is invalid.
- **See Also**: [`fd_repair_join`](<fd_repair.c.md#fd_repair_join>)  (Implementation)


---
### fd\_repair\_leave<!-- {{#callable_declaration:fd_repair_leave}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair.h#L221>)

Leaves a current local join of a repair.
- **Description**: Use this function to leave a current local join of a repair. It returns a pointer to the underlying shared memory region if successful. If the input is null, it logs a warning and returns null. This function is useful when you need to safely disconnect from a repair without losing access to the shared memory.
- **Inputs**:
    - `repair`: A pointer to a constant `fd_repair_t` structure. Must not be null. If null, the function logs a warning and returns null.
- **Output**: Returns a pointer to the underlying shared memory region on success, or null if the input is null.
- **See Also**: [`fd_repair_leave`](<fd_repair.c.md#fd_repair_leave>)  (Implementation)


---
### fd\_repair\_delete<!-- {{#callable_declaration:fd_repair_delete}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair.h#L230>)

Unformats a memory region used as a repair.
- **Description**: Use this function to unformat a memory region that was previously formatted for use as a repair. This function should be called when the memory region is no longer needed for repair operations. Ensure that no other processes are joined to the memory region before calling this function. The function returns a pointer to the underlying shared memory region, transferring ownership back to the caller. If the input is invalid, such as being null or misaligned, the function logs a warning and returns null.
- **Inputs**:
    - `repair`: A pointer to the memory region to unformat. Must not be null and must be aligned according to `fd_repair_align()`. If the pointer is null or misaligned, the function logs a warning and returns null.
- **Output**: Returns a pointer to the underlying shared memory region if successful, or null if the input is invalid.
- **See Also**: [`fd_repair_delete`](<fd_repair.c.md#fd_repair_delete>)  (Implementation)


---
### fd\_repair\_shred<!-- {{#callable_declaration:fd_repair_shred}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair.h#L243>)

Creates a request for a specific shred from a peer validator.
- **Description**: Use this function to request a specific shred from a peer validator in the Solana Repair protocol. This function prepares a message with the necessary details, including the sender and recipient public keys, a timestamp, a nonce, and the identifiers for the slot and shred. Ensure that the `repair` structure is properly initialized and that the `msg` field is available for use before calling this function. The function returns a pointer to the prepared message, which can then be sent to the peer validator.
- **Inputs**:
    - `repair`: A pointer to an `fd_repair_t` structure. This must be initialized and must not be null. The function will modify the `msg` field of this structure.
    - `to`: A pointer to a constant `fd_pubkey_t` representing the public key of the validator to which the request is sent. This must not be null.
    - `ts`: An unsigned long integer representing the timestamp in milliseconds since the Unix epoch. This is used to timestamp the request.
    - `nonce`: An unsigned integer used as a nonce in the request. The caller is responsible for managing the nonce value.
    - `slot`: An unsigned long integer representing the slot number for which the shred is requested.
    - `shred_idx`: An unsigned long integer representing the index of the shred within the specified slot.
- **Output**: Returns a pointer to an `fd_repair_msg_t` structure containing the prepared shred request message.
- **See Also**: [`fd_repair_shred`](<fd_repair.c.md#fd_repair_shred>)  (Implementation)


---
### fd\_repair\_highest\_shred<!-- {{#callable_declaration:fd_repair_highest_shred}} -->
[View Source →](<../../../../../src/discof/repair/fd_repair.h#L244>)

Creates a request for the highest shred in a slot.
- **Description**: Use this function to create a request message for the highest shred in a specified slot that is greater than or equal to a given shred index. This function initializes the message buffer within the `fd_repair_t` structure with the request details. Ensure that the `repair` structure is properly initialized and that the `msg` buffer is not currently in use before calling this function. The function does not handle memory allocation for the message buffer, as it uses a pre-allocated buffer within the `repair` structure.
- **Inputs**:
    - `repair`: A pointer to an `fd_repair_t` structure. Must not be null and should be properly initialized before use. The function modifies the `msg` field within this structure.
    - `to`: A pointer to a constant `fd_pubkey_t` structure representing the recipient's public key. Must not be null.
    - `ts`: An unsigned long integer representing the timestamp in milliseconds since the UNIX epoch. No specific range is enforced.
    - `nonce`: An unsigned integer representing a nonce value. The function does not enforce any specific value or range.
    - `slot`: An unsigned long integer representing the slot number. No specific range is enforced.
    - `shred_idx`: An unsigned long integer representing the shred index. No specific range is enforced.
- **Output**: Returns a pointer to the `fd_repair_msg_t` structure containing the request message.
- **See Also**: [`fd_repair_highest_shred`](<fd_repair.c.md#fd_repair_highest_shred>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)