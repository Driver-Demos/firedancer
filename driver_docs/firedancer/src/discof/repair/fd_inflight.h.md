<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tracks inflight repair requests to validators for metrics and reporting, using unique nonces for identification.

# Purpose
The code is a C header file that defines a module for tracking repair requests that are currently in progress, referred to as "inflight," to other validators. This module is part of a larger system but is not essential for the core repair protocol and strategy. Instead, it serves a supportive role by providing metrics and reporting capabilities. The module uses a unique nonce to key each request, and it is designed to handle situations where requests may not receive responses due to upstream deduplication of duplicates.

The file defines several key components, including the `fd_inflight` structure, which holds information about each request, such as a unique nonce, timestamp, and the public key of the peer. It also includes macros and templates for managing pools, maps, and doubly linked lists (DLLs) of inflight requests. The `fd_inflights` structure aggregates these components, providing a comprehensive interface for managing inflight requests. Functions are declared for creating and joining inflight tables, as well as inserting, removing, and querying requests. The module uses memory alignment and footprint calculations to optimize storage and access patterns.
# Imports and Dependencies

---
- `../../flamenco/types/fd_types.h`
- `../../util/tmpl/fd_pool.c`
- `../../util/tmpl/fd_map_chain.c`
- `../../util/tmpl/fd_dlist.c`


# Data Structures

---
### fd\_inflight
- **Type**: ``struct fd_inflight``
- **Members**:
    - ``nonce``: Unique identifier for the request.
    - ``next``: Reserved for internal use by `fd_pool` and `fd_map_chain`.
    - ``timestamp_ns``: Timestamp when request was created, in nanoseconds.
    - ``pubkey``: Public key of the peer.
    - ``prevll``: Pool index of previous element in DLL, reserved for DLL eviction.
    - ``nextll``: Pool index of next element in DLL, reserved for DLL eviction.
- **Description**: Tracks repair requests that are inflight to other validators, providing unique identification, timestamping, and peer association for each request. It includes fields reserved for internal use and DLL eviction, facilitating metrics and reporting without being critical to the repair protocol.


---
### fd\_inflight\_t
- **Type**: ``struct fd_inflight``
- **Members**:
    - ``nonce``: Unique identifier for the request.
    - ``next``: Reserved for internal use by `fd_pool` and `fd_map_chain`.
    - ``timestamp_ns``: Timestamp when the request was created, in nanoseconds.
    - ``pubkey``: Public key of the peer.
    - ``prevll``: Pool index of the previous element in the doubly linked list (DLL).
    - ``nextll``: Pool index of the next element in the doubly linked list (DLL).
- **Description**: Tracks repair requests that are inflight to other validators, useful for metrics and reporting, with requests uniquely identified by a `nonce`.


---
### fd\_inflights
- **Type**: ``struct fd_inflights``
- **Members**:
    - ``pool``: Pointer to a pool of `fd_inflight_t` structures.
    - ``map``: Pointer to a map structure for managing inflight requests by nonce.
    - ``dlist``: Pointer to a doubly linked list structure for managing inflight requests.
- **Description**: Tracks repair requests that are inflight to other validators, providing structures for managing these requests through a pool, a map, and a doubly linked list. The `pool` manages the storage of `fd_inflight_t` elements, the `map` provides a mechanism to access requests by their unique nonce, and the `dlist` allows for efficient eviction and management of requests in a doubly linked list format.


---
### fd\_inflights\_t
- **Type**: ``struct``
- **Members**:
    - `pool`: Pointer to a pool of `fd_inflight_t` structures.
    - `map`: Pointer to a map that uses `nonce` as the key for `fd_inflight_t` structures.
    - `dlist`: Pointer to a doubly linked list of `fd_inflight_t` structures.
- **Description**: Tracks repair requests that are in-flight to other validators, providing metrics and reporting capabilities. It uses a pool, map, and doubly linked list to manage `fd_inflight_t` structures, which represent individual requests identified by a unique nonce. The structure is aligned to 128 bytes for performance optimization.


# Functions

---
### fd\_inflights\_align<!-- {{#callable:fd_inflights_align}} -->
[View Source →](<../../../../../src/discof/repair/fd_inflight.h#L52>)

Returns the alignment size for `fd_inflights` structures.
- **Inputs**: None
- **Logic and Control Flow**:
    - The function is defined as `static inline` and `FD_FN_CONST`, indicating it is a constant expression and should be inlined by the compiler.
    - Returns a constant value of `128UL`, which represents the alignment size.
- **Output**: A constant unsigned long integer value `128UL`.


---
### fd\_inflights\_footprint<!-- {{#callable:fd_inflights_footprint}} -->
[View Source →](<../../../../../src/discof/repair/fd_inflight.h#L55>)

Calculates the memory footprint required for the `fd_inflights` structure and its components.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize the layout with `FD_LAYOUT_INIT`.
    - Append the alignment and size of `fd_inflights_t` to the layout.
    - Append the alignment and footprint of the inflight pool for `FD_INFLIGHT_REQ_MAX` requests.
    - Append the alignment and footprint of the inflight map for `FD_INFLIGHT_REQ_MAX` requests.
    - Append the alignment and footprint of the inflight doubly linked list.
    - Finalize the layout with the alignment of `fd_inflights`.
- **Output**: Returns an `ulong` representing the total memory footprint required.
- **Functions Called**:
    - [`fd_inflights_align`](<#fd_inflights_align>)


# Function Declarations (Public API)

---
### fd\_inflights\_new<!-- {{#callable_declaration:fd_inflights_new}} -->
[View Source →](<../../../../../src/discof/repair/fd_inflight.h#L70>)

Allocates and initializes a new inflight request tracking structure in shared memory.
- **Description**: Use this function to create a new inflight request tracking structure in a provided shared memory region. This structure helps track repair requests that are inflight to other validators, which is useful for metrics and reporting. The function must be called with a valid shared memory pointer, and it returns the same pointer if successful. If the provided shared memory pointer is null, the function logs a warning and returns null. Ensure that the shared memory region is large enough to accommodate the structure's footprint.
- **Inputs**:
    - `shmem`: Pointer to a shared memory region where the inflight request tracking structure will be allocated. Must not be null. If null, the function logs a warning and returns null. The caller retains ownership of the memory.
- **Output**: Returns the same pointer as the input `shmem` if successful, or null if the input is null.
- **See Also**: [`fd_inflights_new`](<fd_inflight.c.md#fd_inflights_new>)  (Implementation)


---
### fd\_inflights\_join<!-- {{#callable_declaration:fd_inflights_join}} -->
[View Source →](<../../../../../src/discof/repair/fd_inflight.h#L73>)

Joins a shared memory region as an inflight request tracking table.
- **Description**: Use this function to join a shared memory region as an `fd_inflights_t` table, which tracks inflight repair requests. The shared memory must be aligned to the alignment requirements of `fd_inflights_t` and must be part of a workspace. This function is useful for metrics and reporting in the context of repair requests to other validators. It is important to ensure that the shared memory is not null and is correctly aligned before calling this function.
- **Inputs**:
    - `shmem`: A pointer to the shared memory region to join as an inflight request tracking table. Must not be null and must be aligned to `fd_inflights_align()`. The memory must be part of a workspace.
- **Output**: Returns a pointer to the `fd_inflights_t` table if successful, or NULL if the input is invalid or the memory is not part of a workspace.
- **See Also**: [`fd_inflights_join`](<fd_inflight.c.md#fd_inflights_join>)  (Implementation)


---
### fd\_inflights\_request\_insert<!-- {{#callable_declaration:fd_inflights_request_insert}} -->
[View Source →](<../../../../../src/discof/repair/fd_inflight.h#L76>)

Inserts a new inflight request into the tracking table.
- **Description**: Use this function to add a new inflight request to the specified tracking table. This function is useful for monitoring repair requests sent to other validators. If the table is full, the function will evict the oldest request to make space for the new one. Ensure that the `table` is properly initialized and that the `pubkey` is valid before calling this function.
- **Inputs**:
    - `table`: A pointer to an `fd_inflights_t` structure representing the tracking table. Must not be null and must be initialized before use.
    - `nonce`: A unique identifier for the request. It must be unique within the context of the current strategy.
    - `pubkey`: A pointer to a `fd_pubkey_t` structure representing the public key of the peer. Must not be null and the caller retains ownership.
- **Output**: None
- **See Also**: [`fd_inflights_request_insert`](<fd_inflight.c.md#fd_inflights_request_insert>)  (Implementation)


---
### fd\_inflights\_request\_remove<!-- {{#callable_declaration:fd_inflights_request_remove}} -->
[View Source →](<../../../../../src/discof/repair/fd_inflight.h#L79>)

Removes a request from the inflight table and returns its round-trip time.
- **Description**: Use this function to remove a request identified by a unique nonce from the inflight table and obtain the round-trip time of the request. This function is useful for tracking and reporting metrics related to inflight requests. It must be called with a valid `fd_inflights_t` table and a valid nonce. The function will output the public key of the peer associated with the request through the `peer_out` parameter. If the request is not found, the function returns 0.
- **Inputs**:
    - `table`: A pointer to an `fd_inflights_t` structure representing the inflight table. Must not be null.
    - `nonce`: A unique identifier for the request to be removed. Must correspond to an existing request in the table.
    - `peer_out`: A pointer to an `fd_pubkey_t` where the function will store the public key of the peer associated with the removed request. Must not be null.
- **Output**: Returns the round-trip time of the removed request in nanoseconds, or 0 if the request was not found.
- **See Also**: [`fd_inflights_request_remove`](<fd_inflight.c.md#fd_inflights_request_remove>)  (Implementation)


---
### fd\_inflights\_request\_query<!-- {{#callable_declaration:fd_inflights_request_query}} -->
[View Source →](<../../../../../src/discof/repair/fd_inflight.h#L82>)

Queries an inflight request by its unique nonce.
- **Description**: Use this function to find an inflight request in the `fd_inflights_t` table using its unique nonce. This is useful for tracking and reporting purposes in the context of repair requests to other validators. The function returns a pointer to the request if found, or `NULL` if the request does not exist in the table. Ensure that the `table` is properly initialized before calling this function.
- **Inputs**:
    - `table`: A pointer to an `fd_inflights_t` structure representing the table of inflight requests. Must not be null and should be properly initialized.
    - `nonce`: A unique identifier for the request to query. Must correspond to a valid request in the table or the function will return `NULL`.
- **Output**: A pointer to the `fd_inflight_t` structure representing the request if found, or `NULL` if the request is not in the table.
- **See Also**: [`fd_inflights_request_query`](<fd_inflight.c.md#fd_inflights_request_query>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)