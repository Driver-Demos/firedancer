<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a gossip protocol tile with peer, ping, and stake management, including message parsing and verification.

# Purpose
The code is a C source file that implements a gossip protocol component for a distributed system. It is part of a larger software architecture, as indicated by the inclusion of multiple header files from different directories. The primary purpose of this code is to manage and process gossip messages, which are used for communication between nodes in a network. The code defines several data structures, such as `peer_t`, `ping_t`, and `stake_t`, which represent peers, pings, and stakes in the network, respectively. These structures are used to maintain information about network participants and their interactions.

The code includes functions for handling different types of gossip messages, such as pull requests, pull responses, pushes, prunes, pings, and pongs. It verifies message signatures, filters messages based on shred versions, and manages peer and ping updates. The `fd_gossvf_tile_ctx_t` structure is central to the code, maintaining the context for the gossip protocol, including metrics, peer and ping maps, and other state information. The code also includes functions for initializing the gossip context, handling network messages, and performing housekeeping tasks. The file is designed to be part of a larger system, as indicated by the use of macros and functions from included templates and libraries, and it defines a public API for running the gossip protocol as a tile in a distributed system.
# Imports and Dependencies

---
- `fd_gossip_tile.h`
- `../../disco/topo/fd_topo.h`
- `../../disco/fd_disco_base.h`
- `../../disco/keyguard/fd_keyswitch.h`
- `../../disco/keyguard/fd_keyload.h`
- `../../disco/metrics/fd_metrics.h`
- `../../disco/shred/fd_stake_ci.h`
- `../../flamenco/gossip/fd_gossip_private.h`
- `../../flamenco/gossip/fd_ping_tracker.h`
- `../../flamenco/leaders/fd_leaders_base.h`
- `../../util/net/fd_net_headers.h`
- `generated/fd_gossvf_tile_seccomp.h`
- `../../util/tmpl/fd_pool.c`
- `../../util/tmpl/fd_map_chain.c`
- `../../disco/stem/fd_stem.c`


# Global Variables

---
### fd\_tile\_gossvf
- **Type**: ``fd_topo_run_tile_t``
- **Description**: Defines a `fd_topo_run_tile_t` structure named `fd_tile_gossvf`. This structure is initialized with specific function pointers and parameters related to the operation of a gossip tile in a network topology.
- **Use**: Used to configure and manage the execution of a gossip tile within a network topology.


# Data Structures

---
### peer
- **Type**: ``struct``
- **Members**:
    - ``pubkey``: Stores the public key of the peer.
    - ``gossip_addr``: Holds the IP address and port for gossip communication.
    - ``shred_version``: Indicates the version of the shred protocol used by the peer.
    - ``map``: Contains two `ulong` values for previous and next mapping indices.
    - ``pool``: Contains a `ulong` value for the next pool index.
- **Description**: Defines a peer in a network with attributes for identification, communication, and versioning, along with mapping and pooling indices for managing peer relationships.


---
### peer\_t
- **Type**: ``struct``
- **Members**:
    - ``pubkey``: Stores the public key of the peer.
    - ``gossip_addr``: Holds the IP address and port for gossip communication.
    - ``shred_version``: Indicates the version of the shred protocol used by the peer.
    - ``map``: Contains `prev` and `next` fields for linked list navigation in a map.
    - ``pool``: Contains a `next` field for linked list navigation in a pool.
- **Description**: Defines a peer in a network with fields for public key, gossip address, shred version, and linked list navigation for map and pool structures.


---
### ping
- **Type**: ``struct``
- **Members**:
    - ``pubkey``: Stores the public key of the ping.
    - ``addr``: Stores the IP address and port of the ping.
    - ``map``: Contains `prev` and `next` fields for linked list navigation in a map.
    - ``pool``: Contains a `next` field for linked list navigation in a pool.
- **Description**: Defines a structure for managing ping information, including a public key, network address, and linked list pointers for integration into maps and pools.


---
### ping\_t
- **Type**: ``struct``
- **Members**:
    - ``pubkey``: Stores the public key of the ping.
    - ``addr``: Stores the IP address and port for the ping.
    - ``map``: Contains `prev` and `next` fields for mapping in a linked list.
    - ``pool``: Contains a `next` field for managing pool allocation.
- **Description**: Defines a structure for managing ping information, including a public key, network address, and fields for linked list mapping and pool management.


---
### stake
- **Type**: ``struct``
- **Members**:
    - ``pubkey``: Holds the public key of the stake.
    - ``stake``: Stores the amount of stake as an unsigned long integer.
    - ``map``: Contains two unsigned long integers, `prev` and `next`, for mapping purposes.
    - ``pool``: Contains an unsigned long integer `next` for pool management.
- **Description**: Defines a structure to represent a stake with a public key and a stake amount, along with mapping and pool management fields for organizing and accessing stake data efficiently.


---
### stake\_t
- **Type**: ``struct``
- **Members**:
    - ``pubkey``: A public key of type `fd_pubkey_t`.
    - ``stake``: An unsigned long integer representing the stake amount.
    - ``map``: A structure containing `prev` and `next` fields for mapping.
    - ``pool``: A structure containing a `next` field for pooling.
- **Description**: Defines a structure to represent a stake with a public key, a stake amount, and fields for mapping and pooling operations.


---
### fd\_gossvf\_tile\_ctx
- **Type**: ``struct``
- **Members**:
    - ``instance_creation_wallclock_nanos``: Stores the wallclock time in nanoseconds when the instance was created.
    - ``shred_version``: Holds the version of the shred.
    - ``allow_private_address``: Indicates if private addresses are allowed.
    - ``keyswitch``: Pointer to a `fd_keyswitch_t` structure.
    - ``identity_pubkey``: Array holding the identity public key.
    - ``entrypoints``: Array of entry points with a maximum of 16.
    - ``entrypoints_cnt``: Count of entry points.
    - ``peer_cnt``: Count of peers (only in debug mode).
    - ``ping_cnt``: Count of pings (only in debug mode).
    - ``peers``: Pointer to a list of peers.
    - ``peer_map``: Pointer to a map of peers.
    - ``pings``: Pointer to a list of pings.
    - ``ping_map``: Pointer to a map of pings.
    - ``stake``: Structure containing stake information, including count, pool, map, and message buffer.
    - ``payload``: Buffer for network payload data.
    - ``peer``: Stores the peer's IP and port.
    - ``_ping_update``: Array for storing ping updates.
    - ``_gossip_update``: Array for storing gossip updates.
    - ``ticks_per_ns``: Stores the number of ticks per nanosecond.
    - ``last_wallclock``: Stores the last recorded wallclock time.
    - ``last_tickcount``: Stores the last recorded tick count.
    - ``seed``: Random seed value.
    - ``round_robin_idx``: Index for round-robin processing.
    - ``round_robin_cnt``: Count for round-robin processing.
    - ``sha``: Array for SHA-512 context.
    - ``tcache``: Structure containing tcache information, including depth, map count, sync, ring, and map.
    - ``in``: Array of structures for input data, each containing kind, chunk0, wmark, memory pointer, and MTU.
    - ``out``: Structure for output data, containing chunk0, chunk, wmark, and memory pointer.
    - ``metrics``: Structure for storing metrics related to message and CRDS outcomes.
- **Description**: The `fd_gossvf_tile_ctx` structure is a complex data structure used in a gossip protocol implementation. It manages various aspects of the protocol, including peers, pings, stakes, and network communication. The structure contains fields for tracking instance creation time, shred version, and network entry points. It also includes pointers to key data structures like `keyswitch`, `peer_map`, and `ping_map`, as well as buffers for payloads and updates. The structure supports round-robin processing and maintains metrics for message handling. Debugging fields are conditionally included to track peer and ping counts.


---
### fd\_gossvf\_tile\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - `instance_creation_wallclock_nanos`: Stores the wallclock time in nanoseconds when the instance was created.
    - `shred_version`: Holds the version of the shred.
    - `allow_private_address`: Indicates if private addresses are allowed.
    - `keyswitch`: Pointer to a `fd_keyswitch_t` structure.
    - `identity_pubkey`: Array holding the identity public key.
    - `entrypoints`: Array of entry points with a maximum of 16 elements.
    - `entrypoints_cnt`: Count of entry points.
    - `peer_cnt`: Count of peers (only if `DEBUG_PEERS` is enabled).
    - `ping_cnt`: Count of pings (only if `DEBUG_PEERS` is enabled).
    - `peers`: Pointer to an array of `peer_t` structures.
    - `peer_map`: Pointer to a `peer_map_t` structure.
    - `pings`: Pointer to an array of `ping_t` structures.
    - `ping_map`: Pointer to a `ping_map_t` structure.
    - `stake`: Structure containing stake-related data including count, pool, map, and message buffer.
    - `payload`: Buffer for network payload data.
    - `peer`: Stores the IP and port of a peer.
    - `_ping_update`: Array for storing ping update data.
    - `_gossip_update`: Array for storing gossip update messages.
    - `ticks_per_ns`: Stores the number of ticks per nanosecond.
    - `last_wallclock`: Stores the last recorded wallclock time.
    - `last_tickcount`: Stores the last recorded tick count.
    - `seed`: Random seed value.
    - `round_robin_idx`: Index for round-robin processing.
    - `round_robin_cnt`: Count for round-robin processing.
    - `sha`: Array for SHA-512 context.
    - `tcache`: Structure containing tcache-related data including depth, map count, sync, ring, and map.
    - `in`: Array of structures for input data, each containing kind, chunk0, wmark, memory pointer, and MTU.
    - `out`: Structure for output data containing chunk0, chunk, wmark, and memory pointer.
    - `metrics`: Structure for storing various metrics related to message and CRDS outcomes.
- **Description**: Represents the context for a gossip tile in a distributed system, managing peers, pings, stakes, and network communication. It includes various fields for configuration, state tracking, and metrics collection, facilitating the processing and management of gossip messages and network interactions.


# Functions

---
### scratch\_align<!-- {{#callable:scratch_align}} -->
[View Source →](<../../../../../src/discof/gossip/fd_gossvf_tile.c#L201>)

Returns a constant alignment value of 128.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the constant value `128UL`.
- **Output**: The function outputs an unsigned long integer with the value `128UL`.


---
### scratch\_footprint<!-- {{#callable:scratch_footprint}} -->
[View Source →](<../../../../../src/discof/gossip/fd_gossvf_tile.c#L206>)

Calculates the memory footprint required for various data structures in a gossip tile context.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure that contains configuration details for the tile, including the `gossvf` field which specifies the `tcache_depth`.
- **Logic and Control Flow**:
    - Initialize `l` with `FD_LAYOUT_INIT`.
    - Append the layout for `fd_gossvf_tile_ctx_t` using `FD_LAYOUT_APPEND` with its alignment and size.
    - Append the layout for `peer_pool` using `FD_LAYOUT_APPEND` with its alignment and footprint based on `FD_CONTACT_INFO_TABLE_SIZE`.
    - Append the layout for `peer_map` using `FD_LAYOUT_APPEND` with its alignment and footprint based on twice `FD_CONTACT_INFO_TABLE_SIZE`.
    - Append the layout for `ping_pool` using `FD_LAYOUT_APPEND` with its alignment and footprint based on `FD_PING_TRACKER_MAX`.
    - Append the layout for `ping_map` using `FD_LAYOUT_APPEND` with its alignment and footprint based on twice `FD_PING_TRACKER_MAX`.
    - Append the layout for `stake_pool` using `FD_LAYOUT_APPEND` with its alignment and footprint based on `MAX_STAKED_LEADERS`.
    - Append the layout for `stake_map` using `FD_LAYOUT_APPEND` with its alignment and footprint based on the power of two up of `MAX_STAKED_LEADERS`.
    - Append the layout for `fd_tcache` using `FD_LAYOUT_APPEND` with its alignment and footprint based on `tile->gossvf.tcache_depth`.
    - Finalize the layout with `FD_LAYOUT_FINI` using `scratch_align()`.
- **Output**: Returns an `ulong` representing the total memory footprint required.
- **Functions Called**:
    - [`scratch_align`](<#scratch_align>)


---
### during\_housekeeping<!-- {{#callable:during_housekeeping}} -->
[View Source →](<../../../../../src/discof/gossip/fd_gossvf_tile.c#L220>)

Updates the `last_wallclock` and `last_tickcount` fields in the context and handles a pending keyswitch state if necessary.
- **Inputs**:
    - `ctx`: A pointer to a `fd_gossvf_tile_ctx_t` structure, which holds the context for the tile.
- **Logic and Control Flow**:
    - Set `ctx->last_wallclock` to the current wallclock time using `fd_log_wallclock()`.
    - Set `ctx->last_tickcount` to the current tick count using `fd_tickcount()`.
    - Check if the keyswitch state in `ctx->keyswitch` is `FD_KEYSWITCH_STATE_SWITCH_PENDING`.
    - If the keyswitch state is pending, copy 32 bytes from `ctx->keyswitch->bytes` to `ctx->identity_pubkey->uc`.
    - Set the keyswitch state to `FD_KEYSWITCH_STATE_COMPLETED` using `fd_keyswitch_state()`.
- **Output**: No return value; the function modifies the `ctx` structure in place.


---
### metrics\_write<!-- {{#callable:metrics_write}} -->
[View Source →](<../../../../../src/discof/gossip/fd_gossvf_tile.c#L231>)

Copies specific metrics from the `fd_gossvf_tile_ctx_t` structure to predefined metric counters using the `FD_MCNT_ENUM_COPY` macro.
- **Inputs**:
    - `ctx`: A pointer to a `fd_gossvf_tile_ctx_t` structure containing the metrics to be copied.
- **Logic and Control Flow**:
    - Copies the `message_rx` metrics from `ctx->metrics` to the `MESSAGE_RX_COUNT` counter using `FD_MCNT_ENUM_COPY`.
    - Copies the `message_rx_bytes` metrics from `ctx->metrics` to the `MESSAGE_RX_BYTES` counter using `FD_MCNT_ENUM_COPY`.
    - Copies the `crds_rx` metrics from `ctx->metrics` to the `CRDS_RX_COUNT` counter using `FD_MCNT_ENUM_COPY`.
    - Copies the `crds_rx_bytes` metrics from `ctx->metrics` to the `CRDS_RX_BYTES` counter using `FD_MCNT_ENUM_COPY`.
- **Output**: No return value; the function operates by side effect, updating metric counters.


---
### before\_frag<!-- {{#callable:before_frag}} -->
[View Source →](<../../../../../src/discof/gossip/fd_gossvf_tile.c#L239>)

Determines if a fragment should be processed based on the input kind and specific conditions.
- **Inputs**:
    - ``ctx``: A pointer to a `fd_gossvf_tile_ctx_t` structure that contains context information for the function.
    - ``in_idx``: An index of type `ulong` that specifies which input in the context to evaluate.
    - ``seq``: A sequence number of type `ulong` used for round-robin processing in the `IN_KIND_NET` case.
    - ``sig``: A signature of type `ulong` used to determine processing in the `IN_KIND_GOSSIP` case.
- **Logic and Control Flow**:
    - Checks if `ctx->shred_version` is zero and the input kind is not `IN_KIND_SHRED_VERSION`; if true, returns -1.
    - Uses a switch statement to handle different input kinds based on `ctx->in[in_idx].kind`.
    - For `IN_KIND_SHRED_VERSION`, returns 0.
    - For `IN_KIND_NET`, returns the result of a round-robin check using `seq`, `ctx->round_robin_cnt`, and `ctx->round_robin_idx`.
    - For `IN_KIND_REPLAY` and `IN_KIND_PINGS`, returns 0.
    - For `IN_KIND_GOSSIP`, checks if `sig` is not equal to `FD_GOSSIP_UPDATE_TAG_CONTACT_INFO` and `FD_GOSSIP_UPDATE_TAG_CONTACT_INFO_REMOVE`; returns the result of this check.
    - For any unexpected input kind, logs an error and returns -1.
- **Output**: Returns an integer indicating whether the fragment should be processed (0) or not (-1).


---
### during\_frag<!-- {{#callable:during_frag}} -->
[View Source →](<../../../../../src/discof/gossip/fd_gossvf_tile.c#L257>)

Processes incoming data fragments based on their type and updates the context accordingly.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_gossvf_tile_ctx_t` structure, which holds the context for processing.
    - ``in_idx``: An index indicating which input source to process from the `ctx->in` array.
    - ``seq``: A sequence number, marked as unused in this function.
    - ``sig``: A signature or identifier used for processing certain types of input.
    - ``chunk``: The chunk identifier within the input data to process.
    - ``sz``: The size of the data chunk to process.
    - ``ctl``: A control parameter, marked as unused in this function.
- **Logic and Control Flow**:
    - Checks if the `chunk` is within the valid range and if `sz` does not exceed the maximum transmission unit (`mtu`).
    - Logs an error if the `chunk` is out of range or `sz` exceeds `mtu`.
    - Switches based on the `kind` of input data (`ctx->in[in_idx].kind`).
    - For `IN_KIND_SHRED_VERSION`, updates the `shred_version` in the context with the `sig` value.
    - For `IN_KIND_NET`, copies data from the source memory to the `payload` in the context.
    - For `IN_KIND_REPLAY`, checks the stake count and copies the message to the `stake.msg_buf` if valid.
    - For `IN_KIND_PINGS`, copies data to the `_ping_update` buffer in the context.
    - For `IN_KIND_GOSSIP`, verifies the size and copies data to the `_gossip_update` buffer.
    - Logs an error if the `kind` is unexpected.
- **Output**: No return value; the function updates the context and logs errors as needed.


---
### handle\_stakes<!-- {{#callable:handle_stakes}} -->
[View Source →](<../../../../../src/discof/gossip/fd_gossvf_tile.c#L300>)

Updates the stake map and pool in the context with new stake weights from a message.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_gossvf_tile_ctx_t` structure, which contains the current state of the stake map and pool.
    - ``msg``: A pointer to a `fd_stake_weight_msg_t` structure containing the new stake weights and count.
- **Logic and Control Flow**:
    - Initialize an array `stake_weights` to hold the maximum number of staked leaders.
    - Compute new stake weights using `compute_id_weights_from_vote_weights` and store the count in `new_stakes_cnt`.
    - Remove all current entries from the stake map using `stake_map_idx_remove_fast`.
    - For each new stake weight, copy the public key and stake value into the stake pool and insert the entry into the stake map using `stake_map_idx_insert`.
    - Update the stake count in the context to `new_stakes_cnt`.
- **Output**: No return value; updates the stake map and pool in the provided context.


---
### verify\_prune<!-- {{#callable:verify_prune}} -->
[View Source →](<../../../../../src/discof/gossip/fd_gossvf_tile.c#L320>)

Verifies the signature of a prune message in a gossip protocol.
- **Inputs**:
    - `view`: A pointer to a `fd_gossip_view_prune_t` structure containing offsets and lengths for the prune message components.
    - `payload`: A pointer to an array of unsigned characters representing the message payload.
    - `sha`: A pointer to an `fd_sha512_t` structure used for SHA-512 hashing during signature verification.
- **Logic and Control Flow**:
    - Copies a predefined string and various components of the payload into a `sign_data` buffer.
    - Calculates the length of the `sign_data` buffer based on the number of origins.
    - Verifies the signature with and without a prefix using `fd_ed25519_verify`.
    - Returns 0 if either verification is successful, otherwise returns a constant indicating a dropped prune signature.
- **Output**: Returns 0 if the signature is valid, otherwise returns a specific error code indicating a dropped prune signature.


---
### verify\_crds\_value<!-- {{#callable:verify_crds_value}} -->
[View Source →](<../../../../../src/discof/gossip/fd_gossvf_tile.c#L340>)

Verifies the signature of a CRDS value using the Ed25519 algorithm.
- **Inputs**:
    - `value`: A pointer to a `fd_gossip_view_crds_value_t` structure that contains the CRDS value to verify.
    - `payload`: A pointer to an array of unsigned characters that contains the data to verify.
    - `sha`: A pointer to an `fd_sha512_t` structure used for SHA-512 hashing during verification.
- **Logic and Control Flow**:
    - Calls `fd_ed25519_verify` to verify the signature of the CRDS value.
    - The function calculates the offset and length of the signable data from the `payload` using `value->signature_off` and `value->length`.
    - The signable data starts after the signature and has a length of `value->length - 64UL`.
    - The function uses the signature and public key offsets from the `payload` to perform the verification.
- **Output**: Returns the result of the `fd_ed25519_verify` function, indicating success or failure of the signature verification.


---
### verify\_signatures<!-- {{#callable:verify_signatures}} -->
[View Source →](<../../../../../src/discof/gossip/fd_gossvf_tile.c#L351>)

Verifies the signatures of different types of gossip messages and updates metrics based on the verification outcome.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_gossvf_tile_ctx_t` structure, which contains context information and metrics for the gossip verification process.
    - ``view``: A pointer to the `fd_gossip_view_t` structure, which represents the gossip message to be verified.
    - ``payload``: A constant pointer to an unsigned character array containing the message payload data.
    - ``sha``: A pointer to the `fd_sha512_t` structure used for SHA-512 hashing during signature verification.
- **Logic and Control Flow**:
    - Switches on the `view->tag` to determine the type of gossip message.
    - For `FD_GOSSIP_MESSAGE_PULL_REQUEST`, verifies the CRDS value signature and returns a specific metric index if verification fails.
    - For `FD_GOSSIP_MESSAGE_PULL_RESPONSE`, iterates over CRDS values, checks for duplicates using a deduplication tag, verifies signatures, and updates metrics accordingly.
    - For `FD_GOSSIP_MESSAGE_PUSH`, iterates over CRDS values, verifies signatures, and updates metrics if verification fails.
    - For `FD_GOSSIP_MESSAGE_PRUNE`, calls [`verify_prune`](<#verify_prune>) to verify the prune message signature.
    - For `FD_GOSSIP_MESSAGE_PING` and `FD_GOSSIP_MESSAGE_PONG`, verifies the signature of the ping or pong message and returns a specific metric index if verification fails.
    - Uses `__builtin_unreachable()` for the default case, indicating that all possible message types are handled.
- **Output**: Returns 0 if all signatures are verified successfully; otherwise, returns a specific metric index indicating the type of verification failure.
- **Functions Called**:
    - [`verify_crds_value`](<#verify_crds_value>)
    - [`verify_prune`](<#verify_prune>)


---
### is\_entrypoint<!-- {{#callable:is_entrypoint}} -->
[View Source →](<../../../../../src/discof/gossip/fd_gossvf_tile.c#L433>)

Checks if a given IP address and port combination is an entry point in the context.
- **Inputs**:
    - `ctx`: A pointer to a `fd_gossvf_tile_ctx_t` structure that contains the context, including the list of entry points.
    - `addr`: An `fd_ip4_port_t` structure representing the IP address and port to check against the entry points.
- **Logic and Control Flow**:
    - Iterates over the `entrypoints` array in the `ctx` structure.
    - For each entry point, compares the `addr` and `port` fields with those of the `addr` parameter.
    - If a match is found, returns 1 indicating the address is an entry point.
    - If no match is found after checking all entry points, returns 0.
- **Output**: Returns 1 if the address is an entry point, otherwise returns 0.


---
### filter\_shred\_version\_crds<!-- {{#callable:filter_shred_version_crds}} -->
[View Source →](<../../../../../src/discof/gossip/fd_gossvf_tile.c#L442>)

Filters CRDS values based on shred version and updates metrics accordingly.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_gossvf_tile_ctx_t` structure, which contains context information and metrics.
    - ``tag``: An integer representing the type of gossip message, such as `FD_GOSSIP_MESSAGE_PULL_RESPONSE` or `FD_GOSSIP_MESSAGE_PUSH`.
    - ``container``: A pointer to the `fd_gossip_view_crds_container_t` structure, which holds CRDS values to be filtered.
    - ``payload``: A constant pointer to an unsigned character array containing the payload data.
- **Logic and Control Flow**:
    - Query the relayer from the peer map using the `payload` and determine if non-contact info (non-CI) values should be kept based on the relayer's shred version or if the peer is an entrypoint.
    - Iterate over each CRDS value in the `container`.
    - For each CRDS value, check if it is a contact info type (`FD_GOSSIP_VALUE_CONTACT_INFO`).
    - If not a contact info type and non-CI values should be kept, query the origin from the peer map and check its shred version.
    - If the CRDS value should not be kept, update the appropriate metrics based on the `tag` and whether the relayer or origin is missing or has a mismatched shred version.
    - Remove the CRDS value from the `container` by replacing it with the last value and decrement the length of `crds_values_len`.
    - Continue to the next CRDS value if the current one is removed, otherwise increment the index.
- **Output**: No return value; the function modifies the `container` and updates metrics in `ctx`.
- **Functions Called**:
    - [`is_entrypoint`](<#is_entrypoint>)


---
### filter\_shred\_version<!-- {{#callable:filter_shred_version}} -->
[View Source →](<../../../../../src/discof/gossip/fd_gossvf_tile.c#L507>)

Filters gossip messages based on the shred version and message type.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_gossvf_tile_ctx_t` structure, which contains context information for the gossip tile.
    - ``view``: A pointer to the `fd_gossip_view_t` structure, which represents the gossip message view.
    - ``payload``: A pointer to the payload data of the gossip message.
- **Logic and Control Flow**:
    - Switches on the `view->tag` to determine the type of gossip message.
    - For `FD_GOSSIP_MESSAGE_PING`, `FD_GOSSIP_MESSAGE_PONG`, and `FD_GOSSIP_MESSAGE_PRUNE`, returns 0 immediately.
    - For `FD_GOSSIP_MESSAGE_PUSH`, calls [`filter_shred_version_crds`](<#filter_shred_version_crds>) to filter CRDS values and checks if any valid CRDS values remain; returns a specific drop code if none remain, otherwise returns 0.
    - For `FD_GOSSIP_MESSAGE_PULL_RESPONSE`, calls [`filter_shred_version_crds`](<#filter_shred_version_crds>) to filter CRDS values and checks if any valid CRDS values remain; returns a specific drop code if none remain, otherwise returns 0.
    - For `FD_GOSSIP_MESSAGE_PULL_REQUEST`, verifies the shred version of the contact info and returns a specific drop code if it does not match the context's shred version, otherwise returns 0.
    - The default case is unreachable and should not occur.
- **Output**: Returns an integer indicating the outcome of the filtering process, with 0 for success and specific codes for different drop scenarios.
- **Functions Called**:
    - [`filter_shred_version_crds`](<#filter_shred_version_crds>)


---
### check\_duplicate\_instance<!-- {{#callable:check_duplicate_instance}} -->
[View Source →](<../../../../../src/discof/gossip/fd_gossvf_tile.c#L544>)

Checks for duplicate running instances of the same validator node based on the provided context and gossip view.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_gossvf_tile_ctx_t` structure containing the context of the gossip tile.
    - ``view``: A pointer to the `fd_gossip_view_t` structure representing the gossip view message.
    - ``payload``: A pointer to the unsigned character array containing the payload data.
- **Logic and Control Flow**:
    - Determine the type of gossip message using the `view->tag` and set the `container` pointer to the appropriate CRDS container based on the message type.
    - If the message type is `FD_GOSSIP_MESSAGE_PING`, `FD_GOSSIP_MESSAGE_PONG`, `FD_GOSSIP_MESSAGE_PRUNE`, or `FD_GOSSIP_MESSAGE_PULL_REQUEST`, return immediately as these do not require duplicate checks.
    - For `FD_GOSSIP_MESSAGE_PUSH`, set `container` to `view->push`; for `FD_GOSSIP_MESSAGE_PULL_RESPONSE`, set `container` to `view->pull_response`.
    - Iterate over each CRDS value in the `container->crds_values` array.
    - For each value, check if the `tag` is `FD_GOSSIP_VALUE_CONTACT_INFO`. If not, continue to the next value.
    - Compare the `instance_creation_wallclock_nanos` of the context with that of the contact info. If the context's timestamp is greater or equal, continue to the next value.
    - Compare the public key in the context with the public key in the payload using `memcmp`. If they do not match, continue to the next value.
    - If both the timestamp and public key checks fail, log an error indicating a duplicate instance of the validator node.
- **Output**: No return value; logs an error if a duplicate instance is detected.


---
### is\_ping\_active<!-- {{#callable:is_ping_active}} -->
[View Source →](<../../../../../src/discof/gossip/fd_gossvf_tile.c#L578>)

Determines if a node is active based on its entrypoint status, staked amount, or ping response.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_gossvf_tile_ctx_t` structure, which contains context information for the gossip tile.
    - ``contact_info``: A pointer to a constant `fd_contact_info_t` structure, which contains contact information for a node.
- **Logic and Control Flow**:
    - Retrieve the gossip address from the `contact_info` structure.
    - Check if the node is an entrypoint using the [`is_entrypoint`](<#is_entrypoint>) function; if true, return 1 indicating the node is active.
    - Query the stake map for the node's public key to check if the node has more than 1 SOL staked; if true, return 1 indicating the node is active.
    - Query the ping map for the node's public key to check if the node has responded to a ping; return 1 if a response is found, otherwise return 0.
- **Output**: Returns 1 if the node is active based on the criteria, otherwise returns 0.
- **Functions Called**:
    - [`is_entrypoint`](<#is_entrypoint>)


---
### ping\_if\_unponged\_contact\_info<!-- {{#callable:ping_if_unponged_contact_info}} -->
[View Source →](<../../../../../src/discof/gossip/fd_gossvf_tile.c#L595>)

Checks if a contact's gossip address is active and sends a ping request if it is not.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_gossvf_tile_ctx_t` structure, which contains context information for the gossip tile.
    - ``contact_info``: A pointer to a constant `fd_contact_info_t` structure, which contains the contact information of the node to check.
    - ``stem``: A pointer to the `fd_stem_context_t` structure, which is used for publishing messages.
- **Logic and Control Flow**:
    - Retrieve the gossip address from the `contact_info` structure.
    - Check if the gossip address is an IPv6 address by verifying if its length is zero; if true, return 1.
    - Determine if the IP address is non-public and not allowed by checking the `ctx->allow_private_address` flag and the public status of the IP address; if true, return 1.
    - Check if the contact is not active using the [`is_ping_active`](<#is_ping_active>) function; if true, proceed to send a ping request.
    - Allocate a `fd_gossip_pingreq_t` structure in the output memory and copy the contact's public key into it.
    - Publish the ping request using `fd_stem_publish` with the appropriate parameters.
    - Update the output chunk pointer to the next available chunk using `fd_dcache_compact_next`.
    - If `DEBUG_PEERS` is enabled, log the ping action and increment the ping count.
    - Return 1 after sending the ping request.
    - Return 0 if the contact is already active.
- **Output**: Returns 1 if a ping request is sent or if the address is invalid; returns 0 if the contact is already active.
- **Functions Called**:
    - [`is_ping_active`](<#is_ping_active>)
    - [`fd_gossvf_sig`](<fd_gossip_tile.h.md#fd_gossvf_sig>)


---
### verify\_addresses<!-- {{#callable:verify_addresses}} -->
[View Source →](<../../../../../src/discof/gossip/fd_gossvf_tile.c#L622>)

Verifies and processes CRDS values in a gossip view based on the message type and updates metrics accordingly.
- **Inputs**:
    - ``ctx``: A pointer to `fd_gossvf_tile_ctx_t`, which contains context information and metrics for the gossip view.
    - ``view``: A pointer to `fd_gossip_view_t`, representing the gossip message view to be verified.
    - ``stem``: A pointer to `fd_stem_context_t`, used for publishing ping requests if necessary.
- **Logic and Control Flow**:
    - Check the `view->tag` to determine the type of gossip message.
    - If the tag is `FD_GOSSIP_MESSAGE_PUSH`, set `container` to `view->push`; if `FD_GOSSIP_MESSAGE_PULL_RESPONSE`, set `container` to `view->pull_response`; otherwise, return 0 for other message types.
    - Iterate over the `crds_values` in the `container`.
    - For each `crds_value`, check if its `tag` is `FD_GOSSIP_VALUE_CONTACT_INFO`.
    - If the [`ping_if_unponged_contact_info`](<#ping_if_unponged_contact_info>) function returns true, update the metrics for dropped inactive CRDS values and remove the value from the container.
    - Continue iterating until all values are processed.
    - If no valid CRDS values remain in the container, return a specific outcome index based on the message type; otherwise, return 0.
- **Output**: Returns an integer indicating the outcome of the verification process, with specific values for different outcomes such as success or dropped messages.
- **Functions Called**:
    - [`ping_if_unponged_contact_info`](<#ping_if_unponged_contact_info>)


---
### handle\_ping\_update<!-- {{#callable:handle_ping_update}} -->
[View Source →](<../../../../../src/discof/gossip/fd_gossvf_tile.c#L680>)

Updates or removes a ping entry in the context based on the `ping_update` data.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_gossvf_tile_ctx_t` structure, which holds the context for the gossip tile.
    - ``ping_update``: A pointer to the `fd_gossip_ping_update_t` structure, which contains the update information for a ping, including whether to add or remove the ping.
- **Logic and Control Flow**:
    - If `ping_update->remove` is true, remove the ping entry from `ctx->ping_map` using `ping_update->pubkey` and release the ping from `ctx->pings` pool.
    - If `ping_update->remove` is false, acquire a new ping from `ctx->pings` pool, set its address and public key from `ping_update`, and insert it into `ctx->ping_map`.
- **Output**: No return value; the function modifies the `ctx` structure to reflect the updated ping state.


---
### handle\_peer\_update<!-- {{#callable:handle_peer_update}} -->
[View Source →](<../../../../../src/discof/gossip/fd_gossvf_tile.c#L712>)

Processes peer updates by adding, updating, or removing peer information based on the gossip update message tag.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_gossvf_tile_ctx_t` structure, which contains the context for the gossip tile, including peer maps and pools.
    - ``gossip_update``: A pointer to the `fd_gossip_update_message_t` structure, which contains the update message with information about the peer to be processed.
- **Logic and Control Flow**:
    - Check the `tag` of the `gossip_update` to determine the type of update.
    - If the tag is `FD_GOSSIP_UPDATE_TAG_CONTACT_INFO`, query the peer map for the peer using the `origin_pubkey` from the `gossip_update`.
    - If the peer exists, update its `shred_version` and `gossip_addr` with the new information from the `gossip_update`.
    - If the peer does not exist, acquire a new peer from the peer pool, set its `shred_version`, `gossip_addr`, and `pubkey`, and insert it into the peer map.
    - If the tag is `FD_GOSSIP_UPDATE_TAG_CONTACT_INFO_REMOVE`, remove the peer from the peer map using the `origin_pubkey` and release it back to the peer pool.
    - Log the actions taken if `DEBUG_PEERS` is enabled.
    - If the tag is not recognized, log an error.
- **Output**: No return value; the function modifies the peer map and pool in the context.


---
### handle\_net<!-- {{#callable:handle_net}} -->
[View Source →](<../../../../../src/discof/gossip/fd_gossvf_tile.c#L760>)

Processes network packets, extracts and verifies gossip messages, and updates metrics and state based on message type and validity.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_gossvf_tile_ctx_t` structure, which holds the context for the gossip tile, including metrics, peer information, and configuration.
    - ``sz``: The size of the incoming network packet.
    - ``tsorig``: The original timestamp of the packet.
    - ``stem``: A pointer to the `fd_stem_context_t` structure, which is used for publishing messages and managing the output data cache.
- **Logic and Control Flow**:
    - Extracts the IP and UDP headers from the incoming packet and updates the peer address and port in the context.
    - Calculates the current time based on the last recorded wallclock and tick count.
    - Parses the gossip message from the packet payload and checks for parsing errors.
    - Validates the message type and content, including checks for message tags, wallclock timestamps, and CRDS values.
    - Filters messages based on shred version and verifies addresses and signatures.
    - Checks for duplicate instances of the same validator node.
    - Updates the tcache with deduplication tags for `PULL_RESPONSE` and `PUSH` messages.
    - Updates metrics based on the message type and outcome.
    - Copies the parsed view and payload to the output memory and publishes the message using the stem context.
    - Returns a result code indicating the outcome of the message processing.
- **Output**: An integer result code indicating the outcome of the message processing, which can represent success or various types of message drops.
- **Functions Called**:
    - [`ping_if_unponged_contact_info`](<#ping_if_unponged_contact_info>)
    - [`filter_shred_version`](<#filter_shred_version>)
    - [`verify_addresses`](<#verify_addresses>)
    - [`verify_signatures`](<#verify_signatures>)
    - [`check_duplicate_instance`](<#check_duplicate_instance>)
    - [`fd_gossvf_sig`](<fd_gossip_tile.h.md#fd_gossvf_sig>)


---
### after\_frag<!-- {{#callable:after_frag}} -->
[View Source →](<../../../../../src/discof/gossip/fd_gossvf_tile.c#L889>)

Processes different types of input data in a gossip network context and updates metrics accordingly.
- **Inputs**:
    - ``ctx``: A pointer to a `fd_gossvf_tile_ctx_t` structure that holds the context for the gossip tile.
    - ``in_idx``: An index indicating which input source to process from the `ctx->in` array.
    - ``seq``: A sequence number, which is not used in this function.
    - ``sig``: A signature value, which is not used in this function.
    - ``sz``: The size of the data to process.
    - ``tsorig``: The original timestamp of the data.
    - ``_tspub``: A timestamp for publication, which is not used in this function.
    - ``stem``: A pointer to a `fd_stem_context_t` structure used for publishing data.
- **Logic and Control Flow**:
    - Ignores `seq`, `sig`, and `_tspub` as they are not used in the function.
    - Checks the `kind` of input data at `ctx->in[in_idx].kind`.
    - If `kind` is `IN_KIND_SHRED_VERSION`, does nothing.
    - If `kind` is `IN_KIND_PINGS`, calls [`handle_ping_update`](<#handle_ping_update>) to process ping updates.
    - If `kind` is `IN_KIND_GOSSIP`, calls [`handle_peer_update`](<#handle_peer_update>) to process peer updates.
    - If `kind` is `IN_KIND_REPLAY`, calls [`handle_stakes`](<#handle_stakes>) to process stake updates.
    - If `kind` is `IN_KIND_NET`, calls [`handle_net`](<#handle_net>) to process network data and updates message metrics based on the result.
    - Logs an error if `kind` is unexpected.
- **Output**: No return value; the function updates the context and metrics based on the input data.
- **Functions Called**:
    - [`handle_ping_update`](<#handle_ping_update>)
    - [`handle_peer_update`](<#handle_peer_update>)
    - [`handle_stakes`](<#handle_stakes>)
    - [`handle_net`](<#handle_net>)


---
### privileged\_init<!-- {{#callable:privileged_init}} -->
[View Source →](<../../../../../src/discof/gossip/fd_gossvf_tile.c#L917>)

Initializes a privileged context for a tile in a topology, setting up memory and loading identity keys.
- **Inputs**:
    - ``topo``: A pointer to an `fd_topo_t` structure representing the topology.
    - ``tile``: A pointer to an `fd_topo_tile_t` structure representing the tile to initialize.
- **Logic and Control Flow**:
    - Obtain a scratch memory address using `fd_topo_obj_laddr` with `topo` and `tile->tile_obj_id`.
    - Initialize a scratch allocator with `FD_SCRATCH_ALLOC_INIT`.
    - Allocate memory for a `fd_gossvf_tile_ctx_t` context using `FD_SCRATCH_ALLOC_APPEND`.
    - Generate a secure random seed for the context using `fd_rng_secure`.
    - Check if `tile->gossvf.identity_key_path` is set; log an error if it is not.
    - Load the identity public key from the specified path using `fd_keyload_load` and store it in `ctx->identity_pubkey`.
- **Output**: No return value; the function initializes the context in place.


---
### unprivileged\_init<!-- {{#callable:unprivileged_init}} -->
[View Source →](<../../../../../src/discof/gossip/fd_gossvf_tile.c#L931>)

Initializes the unprivileged context for a tile in a topology by allocating and setting up various pools, maps, and context parameters.
- **Inputs**:
    - ``topo``: A pointer to the `fd_topo_t` structure representing the topology.
    - ``tile``: A pointer to the `fd_topo_tile_t` structure representing the tile to initialize.
- **Logic and Control Flow**:
    - Allocate scratch memory for the tile context using `fd_topo_obj_laddr` and `FD_SCRATCH_ALLOC_INIT`.
    - Allocate and initialize various pools and maps for peers, pings, and stakes using `FD_SCRATCH_ALLOC_APPEND` and join them to the context.
    - Set up the round-robin index and count using `fd_topo_tile_name_cnt` and `tile->kind_id`.
    - Configure the context's `allow_private_address`, `keyswitch`, `shred_version`, `ticks_per_ns`, `last_wallclock`, and `last_tickcount`.
    - Initialize the SHA-512 context and tcache using `fd_sha512_join` and `fd_tcache_join`.
    - Set up entry points and initialize metrics to zero.
    - Configure input links by iterating over `tile->in_cnt` and setting up memory, chunk, watermark, and kind based on link names.
    - Configure the output link and check for scratch memory overflow using `FD_SCRATCH_ALLOC_FINI`.
- **Output**: No return value; the function initializes the context in place.
- **Functions Called**:
    - [`scratch_footprint`](<#scratch_footprint>)


---
### populate\_allowed\_seccomp<!-- {{#callable:populate_allowed_seccomp}} -->
[View Source →](<../../../../../src/discof/gossip/fd_gossvf_tile.c#L1042>)

Populates a seccomp filter policy for a gossip tile and returns the instruction count.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, which is not used in this function.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure, which is not used in this function.
    - ``out_cnt``: An unsigned long integer representing the count of output filters to populate.
    - ``out``: A pointer to a `struct sock_filter` array where the seccomp filter policy will be populated.
- **Logic and Control Flow**:
    - Ignore the `topo` and `tile` inputs as they are not used in the function.
    - Call [`populate_sock_filter_policy_fd_gossvf_tile`](<generated/fd_gossvf_tile_seccomp.h.md#populate_sock_filter_policy_fd_gossvf_tile>) with `out_cnt`, `out`, and the file descriptor from `fd_log_private_logfile_fd()` to populate the seccomp filter policy.
    - Return the value of `sock_filter_policy_fd_gossvf_tile_instr_cnt`, which represents the number of instructions in the seccomp filter policy.
- **Output**: Returns an unsigned long integer representing the number of instructions in the seccomp filter policy.
- **Functions Called**:
    - [`populate_sock_filter_policy_fd_gossvf_tile`](<generated/fd_gossvf_tile_seccomp.h.md#populate_sock_filter_policy_fd_gossvf_tile>)


---
### populate\_allowed\_fds<!-- {{#callable:populate_allowed_fds}} -->
[View Source →](<../../../../../src/discof/gossip/fd_gossvf_tile.c#L1054>)

Populates an array with file descriptors for `stderr` and optionally a logfile, returning the count of populated descriptors.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure, which is not used in this function.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure, which is not used in this function.
    - ``out_fds_cnt``: The maximum number of file descriptors that can be stored in the `out_fds` array.
    - ``out_fds``: An array of integers where the function will store the file descriptors.
- **Logic and Control Flow**:
    - Ignores the `topo` and `tile` parameters as they are not used in the function.
    - Checks if `out_fds_cnt` is less than 2; if so, logs an error and exits.
    - Initializes `out_cnt` to 0 to keep track of the number of file descriptors added.
    - Adds the file descriptor for `stderr` (which is 2) to the `out_fds` array and increments `out_cnt`.
    - Checks if the logfile file descriptor is valid (not -1) using `fd_log_private_logfile_fd()`; if valid, adds it to the `out_fds` array and increments `out_cnt`.
    - Returns the count of file descriptors added to the `out_fds` array.
- **Output**: Returns the number of file descriptors added to the `out_fds` array as an unsigned long integer.



---
Made with ❤️ by [Driver](https://www.driver.ai/)