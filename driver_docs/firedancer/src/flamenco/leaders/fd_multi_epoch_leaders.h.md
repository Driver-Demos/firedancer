<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

A wrapper for managing and querying leader schedules across multiple epochs, with lifecycle and stake update functions.

# Purpose
The code defines a C header file for managing leader schedules across multiple epochs in a distributed system. It provides a wrapper around multiple `fd_epoch_leaders` objects, allowing for the tracking and querying of leader schedules for different epochs. The primary structure, `fd_multi_epoch_leaders_t`, encapsulates the necessary data and methods to manage these schedules, including the current and next epoch's leader information. The code includes functions for object lifecycle management, such as [`fd_multi_epoch_leaders_new`](<#fd_multi_epoch_leaders_new>), [`fd_multi_epoch_leaders_join`](<#fd_multi_epoch_leaders_join>), and [`fd_multi_epoch_leaders_delete`](<#fd_multi_epoch_leaders_delete>), which handle the creation, joining, and deletion of leader schedule objects.

Additionally, the code provides functions to retrieve leader information, such as [`fd_multi_epoch_leaders_get_leader_for_slot`](<#fd_multi_epoch_leaders_get_leader_for_slot>), which returns the leader for a given slot, and [`fd_multi_epoch_leaders_get_sorted_lscheds`](<#fd_multi_epoch_leaders_get_sorted_lscheds>), which returns sorted leader schedules. It also includes methods for updating stake information, such as [`fd_multi_epoch_leaders_stake_msg_init`](<#fd_multi_epoch_leaders_stake_msg_init>) and [`fd_multi_epoch_leaders_stake_msg_fini`](<#fd_multi_epoch_leaders_stake_msg_fini>), which handle stake weight updates. The header file ensures that the leader schedule objects are correctly aligned and have the necessary memory footprint, facilitating efficient memory management and access.
# Imports and Dependencies

---
- `fd_leaders.h`


# Data Structures

---
### fd\_multi\_epoch\_leaders\_priv
- **Type**: ``struct``
- **Members**:
    - ``lsched``: An array of pointers to `fd_epoch_leaders_t` for each epoch.
    - ``vote_stake_weight``: An array of `fd_vote_stake_weight_t` representing the vote stake weights for leaders.
    - ``init_done``: An array of integers indicating if the epoch's memory has experienced a `stake_msg_fini`.
    - ``scratch``: A structure containing temporary data such as epoch, start slot, slot count, staked count, excluded stake, and vote keyed leader schedule.
    - ``_lsched``: An array of `_lsched_t` representing the leader schedule footprint for each epoch.
- **Description**: Manages leader schedules for multiple epochs, allowing tracking and querying of leader information for given slots, and preparing schedules for upcoming epochs.


---
### fd\_multi\_epoch\_leaders\_priv\_t
- **Type**: ``struct``
- **Members**:
    - ``lsched``: An array of pointers to `fd_epoch_leaders_t` for managing leader schedules across multiple epochs.
    - ``vote_stake_weight``: An array of `fd_vote_stake_weight_t` representing the stake weights for leaders.
    - ``init_done``: An array indicating whether the memory for each epoch has been initialized.
    - ``scratch``: A structure containing temporary data such as epoch, start slot, slot count, staked count, excluded stake, and vote keyed leader schedule.
    - ``_lsched``: An array of `_lsched_t` used internally for leader schedule management.
- **Description**: Manages leader schedules for multiple epochs, allowing for tracking and querying of leader information across different time periods. It maintains data for two epochs simultaneously, enabling preparation for upcoming epochs while managing the current one. The structure includes arrays for leader schedules, stake weights, initialization status, and temporary data storage for efficient leader schedule management.


---
### fd\_multi\_epoch\_leaders\_lsched\_sorted\_t
- **Type**: ``struct``
- **Members**:
    - ``lscheds``: An array of two pointers to `fd_epoch_leaders_t` objects.
- **Description**: Represents a structure that holds an array of two pointers to `fd_epoch_leaders_t` objects, which are sorted in increasing epoch order. This structure is used to manage leader schedules for multiple epochs, allowing for efficient tracking and querying of leader information across different epochs.


# Functions

---
### fd\_multi\_epoch\_leaders\_align<!-- {{#callable:fd_multi_epoch_leaders_align}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_multi_epoch_leaders.h#L55>)

Returns the alignment requirement for a multi-epoch leader schedule object.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the value of the macro `FD_MULTI_EPOCH_LEADERS_ALIGN`.
- **Output**: An `ulong` representing the alignment requirement for a multi-epoch leader schedule object.


---
### fd\_multi\_epoch\_leaders\_footprint<!-- {{#callable:fd_multi_epoch_leaders_footprint}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_multi_epoch_leaders.h#L60>)

Returns the memory footprint size of a `fd_multi_epoch_leaders_t` object.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the value of the macro `FD_MULTI_EPOCH_LEADERS_FOOTPRINT`, which is defined as the size of the `fd_multi_epoch_leaders_t` structure.
- **Output**: The function returns an `ulong` representing the size of the `fd_multi_epoch_leaders_t` structure.


---
### fd\_multi\_epoch\_leaders\_get\_stake\_weights<!-- {{#callable:fd_multi_epoch_leaders_get_stake_weights}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_multi_epoch_leaders.h#L96>)

Returns a pointer to the stake weights for the latest epoch if initialized, otherwise returns NULL.
- **Inputs**:
    - `mleaders`: A pointer to a `fd_multi_epoch_leaders_t` structure, which contains information about multiple epoch leaders.
- **Logic and Control Flow**:
    - Checks if either of the first two elements in the `init_done` array of `mleaders` is non-zero, indicating initialization.
    - If initialized, returns a pointer to the `vote_stake_weight` array in `mleaders`.
    - If not initialized, returns NULL.
- **Output**: A pointer to the `vote_stake_weight` array if initialized, otherwise NULL.


---
### fd\_multi\_epoch\_leaders\_get\_stake\_cnt<!-- {{#callable:fd_multi_epoch_leaders_get_stake_cnt}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_multi_epoch_leaders.h#L100>)

Retrieves the count of staked leaders from the `fd_multi_epoch_leaders_t` structure.
- **Inputs**:
    - `mleaders`: A pointer to a constant `fd_multi_epoch_leaders_t` structure, which contains information about multiple epoch leaders.
- **Logic and Control Flow**:
    - Accesses the `scratch` member of the `mleaders` structure.
    - Returns the value of the `staked_cnt` field from the `scratch` member.
- **Output**: The function returns an `ulong` representing the count of staked leaders.


# Function Declarations (Public API)

---
### fd\_multi\_epoch\_leaders\_new<!-- {{#callable_declaration:fd_multi_epoch_leaders_new}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_multi_epoch_leaders.h#L71>)

Formats a memory region for use as a multi-epoch leader schedule object.
- **Description**: Use this function to prepare a memory region to act as a multi-epoch leader schedule object. The memory region must meet specific alignment and footprint requirements before calling this function. If the provided memory pointer is null or misaligned, the function returns null. Otherwise, it returns a pointer to the formatted memory region. This function does not perform a join operation, so further steps are necessary to fully utilize the leader schedule object.
- **Inputs**:
    - `shmem`: A pointer to the first byte of a memory region that must meet alignment and footprint requirements. The caller retains ownership. If null or misaligned, the function returns null.
- **Output**: Returns a pointer to the formatted memory region if successful, or null if the input is null or misaligned.
- **See Also**: [`fd_multi_epoch_leaders_new`](<fd_multi_epoch_leaders.c.md#fd_multi_epoch_leaders_new>)  (Implementation)


---
### fd\_multi\_epoch\_leaders\_join<!-- {{#callable_declaration:fd_multi_epoch_leaders_join}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_multi_epoch_leaders.h#L77>)

Joins the caller to a multi-epoch leader schedule object.
- **Description**: Use this function to join a caller to an existing multi-epoch leader schedule object. This is necessary to interact with the leader schedule data. Ensure that the memory region pointed to by the input parameter is correctly formatted as a multi-epoch leader schedule object before calling this function. This function does not perform any validation on the input and directly returns the input pointer.
- **Inputs**:
    - `shleaders`: A pointer to a memory region that represents a multi-epoch leader schedule object. The pointer must not be null and should point to a properly formatted object. The caller retains ownership of the memory.
- **Output**: Returns a pointer to the multi-epoch leader schedule object, which is the same as the input pointer.
- **See Also**: [`fd_multi_epoch_leaders_join`](<fd_multi_epoch_leaders.c.md#fd_multi_epoch_leaders_join>)  (Implementation)


---
### fd\_multi\_epoch\_leaders\_leave<!-- {{#callable_declaration:fd_multi_epoch_leaders_leave}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_multi_epoch_leaders.h#L80>)

Leaves the multi-epoch leader schedule object.
- **Description**: Use this function to leave a previously joined multi-epoch leader schedule object. This is typically done when the caller no longer needs to interact with the leader schedule object. Ensure that the object was previously joined using the appropriate join function before calling this function. This function does not perform any operations other than returning the pointer to the caller.
- **Inputs**:
    - `mleaders`: A pointer to a `fd_multi_epoch_leaders_t` object that the caller has previously joined. The pointer must not be null, and the object must be in a valid state for leaving.
- **Output**: Returns the same pointer that was passed in, allowing the caller to confirm the object that was left.
- **See Also**: [`fd_multi_epoch_leaders_leave`](<fd_multi_epoch_leaders.c.md#fd_multi_epoch_leaders_leave>)  (Implementation)


---
### fd\_multi\_epoch\_leaders\_delete<!-- {{#callable_declaration:fd_multi_epoch_leaders_delete}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_multi_epoch_leaders.h#L86>)

Unformats a memory region and returns ownership to the caller.
- **Description**: Use this function to release a memory region previously formatted for a multi-epoch leader schedule object. It returns the ownership of the memory back to the caller, allowing for potential reuse or deallocation. This function should be called when the multi-epoch leader schedule object is no longer needed, ensuring that resources are properly managed.
- **Inputs**:
    - `shleaders`: A pointer to the memory region that was formatted as a multi-epoch leader schedule object. The pointer must not be null, and it should point to a valid memory region that was previously formatted using `fd_multi_epoch_leaders_new`. If the pointer is invalid, the behavior is undefined.
- **Output**: Returns the same pointer passed as input, allowing the caller to manage the memory region.
- **See Also**: [`fd_multi_epoch_leaders_delete`](<fd_multi_epoch_leaders.c.md#fd_multi_epoch_leaders_delete>)  (Implementation)


---
### fd\_multi\_epoch\_leaders\_get\_leader\_for\_slot<!-- {{#callable_declaration:fd_multi_epoch_leaders_get_leader_for_slot}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_multi_epoch_leaders.h#L112>)

Returns the leader's public key for a specified slot.
- **Description**: Use this function to find the leader's public key for a given slot within the tracked epochs of a multi-epoch leader object. It is important to ensure that the slot is within the range of epochs managed by the object. If the slot is not tracked, the function returns NULL. Additionally, if the leader for the slot is part of the excluded stake for that epoch, the function returns a pointer to a public key with the value `FD_INDETERMINATE_LEADER` instead of the actual leader's public key.
- **Inputs**:
    - `mleaders`: A pointer to a `fd_multi_epoch_leaders_t` object. This must not be null and should be properly initialized to track the desired epochs.
    - `slot`: An unsigned long integer representing the slot for which the leader's public key is requested. The slot must be within the range of epochs tracked by the `mleaders` object.
- **Output**: A pointer to the leader's public key for the specified slot, or NULL if the slot is not tracked. If the leader is part of the excluded stake, a pointer to a public key with value `FD_INDETERMINATE_LEADER` is returned.
- **See Also**: [`fd_multi_epoch_leaders_get_leader_for_slot`](<fd_multi_epoch_leaders.c.md#fd_multi_epoch_leaders_get_leader_for_slot>)  (Implementation)


---
### fd\_multi\_epoch\_leaders\_get\_lsched\_for\_epoch<!-- {{#callable_declaration:fd_multi_epoch_leaders_get_lsched_for_epoch}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_multi_epoch_leaders.h#L120>)

Retrieves the leader schedule for a specified epoch.
- **Description**: Use this function to obtain the leader schedule for a specific epoch from a multi-epoch leader object. It is important to ensure that the multi-epoch leader object has been properly initialized and contains data for the requested epoch. If the epoch is not tracked by the object, the function will return NULL. This function is useful for querying leader schedules when managing multiple epochs.
- **Inputs**:
    - `mleaders`: A pointer to a constant `fd_multi_epoch_leaders_t` object. This object must be initialized and must not be NULL. The caller retains ownership.
    - `epoch`: An unsigned long integer representing the epoch for which the leader schedule is requested. There are no specific constraints on the value, but it should correspond to an epoch tracked by the `mleaders` object.
- **Output**: A pointer to a constant `fd_epoch_leaders_t` object representing the leader schedule for the specified epoch, or NULL if the epoch is not tracked.
- **See Also**: [`fd_multi_epoch_leaders_get_lsched_for_epoch`](<fd_multi_epoch_leaders.c.md#fd_multi_epoch_leaders_get_lsched_for_epoch>)  (Implementation)


---
### fd\_multi\_epoch\_leaders\_get\_lsched\_for\_slot<!-- {{#callable_declaration:fd_multi_epoch_leaders_get_lsched_for_slot}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_multi_epoch_leaders.h#L123>)

Returns the leader schedule for the epoch containing the specified slot.
- **Description**: Use this function to obtain the leader schedule for the epoch that includes a given slot. This is useful when you need to determine the leader schedule for a specific time frame within the tracked epochs. The function returns a pointer to the leader schedule if the slot is within the epochs managed by the multi-epoch leader object. If the slot is not within the tracked epochs, the function returns NULL. Ensure that the multi-epoch leader object is properly initialized and contains the relevant epoch data before calling this function.
- **Inputs**:
    - `mleaders`: A pointer to a constant `fd_multi_epoch_leaders_t` object. This object must be initialized and must contain the epoch data for the slot in question. The caller retains ownership and must ensure it is not null.
    - `slot`: An unsigned long integer representing the slot for which the leader schedule is requested. The slot must be within the range of slots tracked by the `mleaders` object.
- **Output**: A pointer to a constant `fd_epoch_leaders_t` object representing the leader schedule for the epoch containing the specified slot, or NULL if the slot is not tracked by the `mleaders` object.
- **See Also**: [`fd_multi_epoch_leaders_get_lsched_for_slot`](<fd_multi_epoch_leaders.c.md#fd_multi_epoch_leaders_get_lsched_for_slot>)  (Implementation)


---
### fd\_multi\_epoch\_leaders\_get\_next\_slot<!-- {{#callable_declaration:fd_multi_epoch_leaders_get_next_slot}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_multi_epoch_leaders.h#L152>)

Finds the next slot for a specified leader starting from a given slot.
- **Description**: Use this function to find the next slot where a specified leader will be in charge, starting from a given slot. This function is useful when you need to determine the next occurrence of a leader's slot across multiple epochs. It requires that the multi-epoch leader object tracks the epoch containing the start slot. If the function cannot find a suitable slot, it returns `ULONG_MAX`. This can happen if the epoch containing the start slot is not tracked, if the leader does not have a slot in the tracked epochs, or if the leader is part of the excluded stake for that epoch.
- **Inputs**:
    - `mleaders`: A pointer to a `fd_multi_epoch_leaders_t` object. This object must be initialized and must track the epoch containing the `start_slot`. The caller retains ownership and must ensure it is not null.
    - `start_slot`: An unsigned long integer representing the slot number to start the search from. It must be within the range of slots tracked by the `mleaders` object.
    - `leader_q`: A pointer to a `fd_pubkey_t` object representing the leader's public key. The caller retains ownership and must ensure it is not null.
- **Output**: Returns the slot number as an unsigned long where the specified leader will be in charge, starting from `start_slot`. If no such slot is found, returns `ULONG_MAX`.
- **See Also**: [`fd_multi_epoch_leaders_get_next_slot`](<fd_multi_epoch_leaders.c.md#fd_multi_epoch_leaders_get_next_slot>)  (Implementation)


---
### fd\_multi\_epoch\_leaders\_stake\_msg\_init<!-- {{#callable_declaration:fd_multi_epoch_leaders_stake_msg_init}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_multi_epoch_leaders.h#L174>)

Initializes the multi-epoch leaders with stake weight data from a message.
- **Description**: Use this function to update the multi-epoch leaders with new stake weight information from a given message. This function must be called with a valid message containing stake weight data, and it is important to ensure that the number of stakes in the message does not exceed the maximum allowed. This function does not maintain any interest in the message after it returns, and it is expected to be called before any subsequent operations that depend on the updated stake information.
- **Inputs**:
    - `mleaders`: A pointer to a `fd_multi_epoch_leaders_t` structure that will be initialized with the stake weight data. The caller must ensure this pointer is valid and properly allocated.
    - `msg`: A pointer to a `fd_stake_weight_msg_t` structure containing the stake weight data. The `staked_cnt` field must not exceed `MAX_STAKED_LEADERS`. The caller retains ownership of this pointer, and it must not be null.
- **Output**: None
- **See Also**: [`fd_multi_epoch_leaders_stake_msg_init`](<fd_multi_epoch_leaders.c.md#fd_multi_epoch_leaders_stake_msg_init>)  (Implementation)


---
### fd\_multi\_epoch\_leaders\_stake\_msg\_fini<!-- {{#callable_declaration:fd_multi_epoch_leaders_stake_msg_fini}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_multi_epoch_leaders.h#L178>)

Finalizes the stake message for a multi-epoch leader schedule.
- **Description**: Use this function to finalize the stake message for a multi-epoch leader schedule object. It clears old leader schedule data for the current epoch and populates it with new data. This function must be called after initializing the stake message with `fd_multi_epoch_leaders_stake_msg_init`. It ensures that the leader schedule is updated and ready for the next epoch. This function modifies the internal state of the `fd_multi_epoch_leaders_t` object, so it should be used with care to maintain data integrity.
- **Inputs**:
    - `mleaders`: A pointer to a `fd_multi_epoch_leaders_t` object. This parameter must not be null, and the object must be properly initialized before calling this function. The function will modify the internal state of this object.
- **Output**: None
- **See Also**: [`fd_multi_epoch_leaders_stake_msg_fini`](<fd_multi_epoch_leaders.c.md#fd_multi_epoch_leaders_stake_msg_fini>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)