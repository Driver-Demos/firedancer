<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Manages multi-epoch leader schedules, including initialization, joining, and retrieval of leader data.

# Purpose
The code defines a set of functions for managing and interacting with a data structure called `fd_multi_epoch_leaders_t`. This structure is used to handle leader schedules across multiple epochs in a distributed system. The primary functionality includes creating, joining, leaving, and deleting instances of `fd_multi_epoch_leaders_t`, as well as retrieving leader schedules for specific epochs or slots. The code ensures that shared memory (`shmem`) is correctly aligned and initialized before use. It also provides mechanisms to update leader schedules based on stake weight messages, which are used to determine the leaders for different slots within an epoch.

The functions [`fd_multi_epoch_leaders_new`](<#fd_multi_epoch_leaders_new>), [`fd_multi_epoch_leaders_join`](<#fd_multi_epoch_leaders_join>), [`fd_multi_epoch_leaders_leave`](<#fd_multi_epoch_leaders_leave>), and [`fd_multi_epoch_leaders_delete`](<#fd_multi_epoch_leaders_delete>) manage the lifecycle of the `fd_multi_epoch_leaders_t` structure. The code also includes functions to retrieve leader schedules for specific epochs or slots, such as [`fd_multi_epoch_leaders_get_lsched_for_epoch`](<#fd_multi_epoch_leaders_get_lsched_for_epoch>) and [`fd_multi_epoch_leaders_get_lsched_for_slot`](<#fd_multi_epoch_leaders_get_lsched_for_slot>). Additionally, the code provides functionality to initialize and finalize stake weight messages, which are used to update the leader schedules. The [`fd_multi_epoch_leaders_get_next_slot`](<#fd_multi_epoch_leaders_get_next_slot>) function is used to find the next slot for a given leader, and [`fd_multi_epoch_leaders_get_leader_for_slot`](<#fd_multi_epoch_leaders_get_leader_for_slot>) retrieves the leader for a specific slot. The code also includes a function to get sorted leader schedules based on epoch order.
# Imports and Dependencies

---
- `fd_multi_epoch_leaders.h`


# Functions

---
### fd\_multi\_epoch\_leaders\_new<!-- {{#callable:fd_multi_epoch_leaders_new}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_multi_epoch_leaders.c#L3>)

Initializes a multi-epoch leaders structure in shared memory, ensuring alignment and setting up epoch leaders.
- **Inputs**:
    - `shmem`: A pointer to shared memory where the multi-epoch leaders structure will be initialized.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL; if so, log a warning and return NULL.
    - Check if `shmem` is aligned according to [`fd_multi_epoch_leaders_align`](<fd_multi_epoch_leaders.h.md#fd_multi_epoch_leaders_align>); if not, log a warning and return NULL.
    - Cast `shmem` to a `fd_multi_epoch_leaders_t` pointer and initialize `vote_keyed_lsched` to 0.
    - Create a dummy stake array with one element for initialization purposes.
    - Iterate over each epoch index up to `MULTI_EPOCH_LEADERS_EPOCH_CNT`.
    - For each epoch, initialize the leader schedule using [`fd_epoch_leaders_new`](<fd_leaders.c.md#fd_epoch_leaders_new>) and [`fd_epoch_leaders_join`](<fd_leaders.c.md#fd_epoch_leaders_join>), and store the result in `leaders->lsched[i]`.
    - Check if the leader schedule initialization was successful using `FD_TEST`.
    - Set `leaders->init_done[i]` to 0 for each epoch.
- **Output**: Returns the original `shmem` pointer if successful, or NULL if there is an error.
- **Functions Called**:
    - [`fd_multi_epoch_leaders_align`](<fd_multi_epoch_leaders.h.md#fd_multi_epoch_leaders_align>)
    - [`fd_epoch_leaders_join`](<fd_leaders.c.md#fd_epoch_leaders_join>)
    - [`fd_epoch_leaders_new`](<fd_leaders.c.md#fd_epoch_leaders_new>)


---
### fd\_multi\_epoch\_leaders\_join<!-- {{#callable:fd_multi_epoch_leaders_join}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_multi_epoch_leaders.c#L29>)

Returns the input pointer `shleaders` as a `fd_multi_epoch_leaders_t` pointer.
- **Inputs**:
    - `shleaders`: A pointer to a shared leaders structure, expected to be of type `fd_multi_epoch_leaders_t`.
- **Logic and Control Flow**:
    - The function takes a single input `shleaders` and returns it without any modification.
- **Output**: A pointer of type `fd_multi_epoch_leaders_t` that is the same as the input `shleaders`.


---
### fd\_multi\_epoch\_leaders\_leave<!-- {{#callable:fd_multi_epoch_leaders_leave}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_multi_epoch_leaders.c#L32>)

Returns the input pointer `mleaders` without modification.
- **Inputs**:
    - `mleaders`: A pointer to an `fd_multi_epoch_leaders_t` structure, representing the multi-epoch leaders to leave.
- **Logic and Control Flow**:
    - The function takes a pointer `mleaders` as input.
    - It returns the same pointer `mleaders` without any changes.
- **Output**: A pointer to `fd_multi_epoch_leaders_t`, which is the same as the input `mleaders`.


---
### fd\_multi\_epoch\_leaders\_delete<!-- {{#callable:fd_multi_epoch_leaders_delete}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_multi_epoch_leaders.c#L35>)

Returns the input pointer `shleaders` without modification.
- **Inputs**:
    - `shleaders`: A pointer to a shared leaders structure, which is expected to be deleted or cleaned up.
- **Logic and Control Flow**:
    - The function takes a single input pointer `shleaders`.
    - It returns the same pointer `shleaders` without performing any operations on it.
- **Output**: The function returns the input pointer `shleaders`.


---
### fd\_multi\_epoch\_leaders\_get\_lsched\_for\_epoch<!-- {{#callable:fd_multi_epoch_leaders_get_lsched_for_epoch}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_multi_epoch_leaders.c#L38>)

Retrieves the leader schedule for a specified epoch from a multi-epoch leaders structure.
- **Inputs**:
    - `mleaders`: A pointer to a `fd_multi_epoch_leaders_t` structure containing leader schedules for multiple epochs.
    - `epoch`: An unsigned long integer representing the epoch for which the leader schedule is requested.
- **Logic and Control Flow**:
    - Check if the leader schedule for the even index is initialized and matches the requested epoch using `fd_ptr_if` function.
    - Check if the leader schedule for the odd index is initialized and matches the requested epoch using `fd_ptr_if` function.
    - Return the even leader schedule if it is valid; otherwise, return the odd leader schedule.
- **Output**: A pointer to a `fd_epoch_leaders_t` structure representing the leader schedule for the specified epoch, or `NULL` if no valid schedule is found.


---
### fd\_multi\_epoch\_leaders\_get\_epoch\_idx<!-- {{#callable:fd_multi_epoch_leaders_get_epoch_idx}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_multi_epoch_leaders.c#L46>)

Determines the index of the epoch leader schedule that contains a given slot.
- **Inputs**:
    - `mleaders`: A pointer to a `fd_multi_epoch_leaders_t` structure that contains the epoch leader schedules.
    - `slot`: An unsigned long integer representing the slot number to check against the epoch leader schedules.
- **Logic and Control Flow**:
    - Retrieve the even and odd leader schedules from the `mleaders` structure.
    - Calculate `even_match` by checking if the even schedule is initialized and if the slot falls within the range of the even schedule's slots.
    - Calculate `odd_match` by checking if the odd schedule is initialized and if the slot falls within the range of the odd schedule's slots.
    - Return the index of the matching schedule (0 for even, 1 for odd) or `ULONG_MAX` if neither matches.
- **Output**: Returns an unsigned long integer representing the index of the epoch leader schedule that contains the slot, or `ULONG_MAX` if no schedule contains the slot.


---
### fd\_multi\_epoch\_leaders\_get\_lsched\_for\_slot<!-- {{#callable:fd_multi_epoch_leaders_get_lsched_for_slot}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_multi_epoch_leaders.c#L58>)

Retrieves the leader schedule for a given slot from a multi-epoch leaders structure.
- **Inputs**:
    - `mleaders`: A pointer to a `fd_multi_epoch_leaders_t` structure containing multiple epoch leader schedules.
    - `slot`: An unsigned long integer representing the slot for which the leader schedule is requested.
- **Logic and Control Flow**:
    - Call [`fd_multi_epoch_leaders_get_epoch_idx`](<#fd_multi_epoch_leaders_get_epoch_idx>) with `mleaders` and `slot` to get the index of the epoch that contains the slot.
    - Check if the returned `epoch_idx` is `ULONG_MAX`, indicating an invalid index, and return `NULL` if true.
    - Return the leader schedule at the index `epoch_idx` from the `mleaders->lsched` array.
- **Output**: A pointer to a `fd_epoch_leaders_t` structure representing the leader schedule for the specified slot, or `NULL` if the slot is not valid.
- **Functions Called**:
    - [`fd_multi_epoch_leaders_get_epoch_idx`](<#fd_multi_epoch_leaders_get_epoch_idx>)


---
### fd\_multi\_epoch\_leaders\_get\_next\_slot<!-- {{#callable:fd_multi_epoch_leaders_get_next_slot}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_multi_epoch_leaders.c#L66>)

Finds the next slot across multiple epochs where a specified leader is scheduled.
- **Inputs**:
    - `mleaders`: A pointer to a `fd_multi_epoch_leaders_t` structure containing the multi-epoch leader schedules.
    - `start_slot`: An unsigned long integer representing the starting slot from which to search for the next slot.
    - `leader_q`: A pointer to a `fd_pubkey_t` structure representing the public key of the leader to search for.
- **Logic and Control Flow**:
    - Call [`fd_multi_epoch_leaders_get_epoch_idx`](<#fd_multi_epoch_leaders_get_epoch_idx>) to find the epoch index containing `start_slot`.
    - If the epoch index is `ULONG_MAX`, return `ULONG_MAX` indicating no valid epoch was found.
    - Iterate over the epochs starting from the found epoch index, wrapping around using modulo operation with `MULTI_EPOCH_LEADERS_EPOCH_CNT`.
    - For each epoch, check if it is initialized by examining `mleaders->init_done[epoch_i]`. If not initialized, skip to the next epoch.
    - Determine the starting slot for iteration as the maximum of `start_slot` and the epoch's starting slot `slot0`.
    - Iterate over the slots in the current epoch from `start_slot_it` to `slot_end`.
    - For each slot, retrieve the leader's public key using [`fd_epoch_leaders_get`](<fd_leaders.h.md#fd_epoch_leaders_get>) and compare it with `leader_q` using `memcmp`.
    - If a match is found, return the current slot.
    - If no match is found after checking all epochs, return `ULONG_MAX`.
- **Output**: Returns the next slot number where the specified leader is scheduled, or `ULONG_MAX` if no such slot is found.
- **Functions Called**:
    - [`fd_multi_epoch_leaders_get_epoch_idx`](<#fd_multi_epoch_leaders_get_epoch_idx>)
    - [`fd_epoch_leaders_get`](<fd_leaders.h.md#fd_epoch_leaders_get>)


---
### fd\_multi\_epoch\_leaders\_stake\_msg\_init<!-- {{#callable:fd_multi_epoch_leaders_stake_msg_init}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_multi_epoch_leaders.c#L96>)

Initializes the `fd_multi_epoch_leaders_t` structure with data from a `fd_stake_weight_msg_t` message.
- **Inputs**:
    - `mleaders`: A pointer to an `fd_multi_epoch_leaders_t` structure that will be initialized.
    - `msg`: A constant pointer to an `fd_stake_weight_msg_t` structure containing the initialization data.
- **Logic and Control Flow**:
    - Checks if `msg->staked_cnt` exceeds `MAX_STAKED_LEADERS` and logs an error if true.
    - Copies the `epoch`, `start_slot`, `slot_cnt`, `staked_cnt`, `excluded_stake`, and `vote_keyed_lsched` from `msg` to `mleaders->scratch`.
    - Copies the `weights` array from `msg` to `mleaders->vote_stake_weight` using `fd_memcpy`.
- **Output**: No return value; the function modifies the `mleaders` structure in place.


---
### fd\_multi\_epoch\_leaders\_stake\_msg\_fini<!-- {{#callable:fd_multi_epoch_leaders_stake_msg_fini}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_multi_epoch_leaders.c#L113>)

Finalizes the leader schedule for a specific epoch by clearing old data and populating new schedule data.
- **Inputs**:
    - `mleaders`: A pointer to an `fd_multi_epoch_leaders_t` structure containing the leader schedule and related data.
- **Logic and Control Flow**:
    - Retrieve the current epoch, start slot, slot count, staked count, excluded stake, and vote keyed leader schedule from the `mleaders->scratch` structure.
    - Calculate the index of the current epoch using the modulus operation with `MULTI_EPOCH_LEADERS_EPOCH_CNT`.
    - Clear old leader schedule data by calling [`fd_epoch_leaders_delete`](<fd_leaders.c.md#fd_epoch_leaders_delete>) on the result of [`fd_epoch_leaders_leave`](<fd_leaders.c.md#fd_epoch_leaders_leave>) for the current epoch index.
    - Allocate memory for the new leader schedule using `mleaders->_lsched[epoch_idx]`.
    - Create a new leader schedule with [`fd_epoch_leaders_new`](<fd_leaders.c.md#fd_epoch_leaders_new>) using the retrieved parameters and join it to the `mleaders->lsched[epoch_idx]`.
    - Mark the initialization as done for the current epoch index by setting `mleaders->init_done[epoch_idx]` to 1.
- **Output**: None (void function).
- **Functions Called**:
    - [`fd_epoch_leaders_delete`](<fd_leaders.c.md#fd_epoch_leaders_delete>)
    - [`fd_epoch_leaders_leave`](<fd_leaders.c.md#fd_epoch_leaders_leave>)
    - [`fd_epoch_leaders_join`](<fd_leaders.c.md#fd_epoch_leaders_join>)
    - [`fd_epoch_leaders_new`](<fd_leaders.c.md#fd_epoch_leaders_new>)


---
### fd\_multi\_epoch\_leaders\_get\_leader\_for\_slot<!-- {{#callable:fd_multi_epoch_leaders_get_leader_for_slot}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_multi_epoch_leaders.c#L136>)

Retrieves the leader for a specified slot from a multi-epoch leader schedule.
- **Inputs**:
    - `mleaders`: A pointer to a `fd_multi_epoch_leaders_t` structure that contains the multi-epoch leader schedules.
    - `slot`: An unsigned long integer representing the slot for which the leader is to be retrieved.
- **Logic and Control Flow**:
    - Call [`fd_multi_epoch_leaders_get_epoch_idx`](<#fd_multi_epoch_leaders_get_epoch_idx>) to determine the epoch index for the given `slot` within the `mleaders` structure.
    - Check if the returned `epoch_idx` is `ULONG_MAX`, indicating an invalid epoch index, and return `NULL` if true.
    - If a valid `epoch_idx` is found, retrieve and return the leader for the specified `slot` from the leader schedule at `mleaders->lsched[epoch_idx]` using [`fd_epoch_leaders_get`](<fd_leaders.h.md#fd_epoch_leaders_get>).
- **Output**: A pointer to a `fd_pubkey_t` structure representing the leader for the specified slot, or `NULL` if no valid leader is found.
- **Functions Called**:
    - [`fd_multi_epoch_leaders_get_epoch_idx`](<#fd_multi_epoch_leaders_get_epoch_idx>)
    - [`fd_epoch_leaders_get`](<fd_leaders.h.md#fd_epoch_leaders_get>)


---
### fd\_multi\_epoch\_leaders\_get\_sorted\_lscheds<!-- {{#callable:fd_multi_epoch_leaders_get_sorted_lscheds}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_multi_epoch_leaders.c#L144>)

Sorts and returns the leader schedules based on epoch order, with null schedules prioritized first.
- **Inputs**:
    - `mleaders`: A pointer to a `fd_multi_epoch_leaders_t` structure containing leader schedules and initialization status.
- **Logic and Control Flow**:
    - Initialize `ret` with null leader schedules.
    - Determine `even_option` and `odd_option` based on the initialization status of the leader schedules in `mleaders`.
    - If both `even_option` and `odd_option` are non-null, compare their epochs and assign them to `ret.lscheds` in ascending order of epoch.
    - If only one of `even_option` or `odd_option` is non-null, assign the non-null option to `ret.lscheds[0]`.
    - Return the `ret` structure containing the sorted leader schedules.
- **Output**: A `fd_multi_epoch_leaders_lsched_sorted_t` structure containing the sorted leader schedules.



---
Made with ❤️ by [Driver](https://www.driver.ai/)