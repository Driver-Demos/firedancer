<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for managing epoch leaders, including sorting and memory alignment operations.

# Purpose
The code defines functionality for managing epoch leaders in a distributed system. It includes functions to create, join, leave, and delete epoch leader structures. The primary function, [`fd_epoch_leaders_new`](<#fd_epoch_leaders_new>), initializes a new epoch leader structure in shared memory. It sorts and deduplicates vote stake weights, generates a schedule of leaders using a weighted sampling method, and organizes the data into a specific memory layout. The code uses sorting templates to order vote weights by stake and ID, and it employs a ChaCha20 random number generator to seed the sampling process. The functions [`fd_epoch_leaders_join`](<#fd_epoch_leaders_join>), [`fd_epoch_leaders_leave`](<#fd_epoch_leaders_leave>), and [`fd_epoch_leaders_delete`](<#fd_epoch_leaders_delete>) manage the lifecycle of the epoch leader structures.

The code includes several macros and utility functions to handle memory alignment and footprint calculations. It uses the `fd_chacha_rng` and `fd_wsample` libraries for random number generation and weighted sampling, respectively. The [`fd_epoch_leaders_align`](<#fd_epoch_leaders_align>) and [`fd_epoch_leaders_footprint`](<#fd_epoch_leaders_footprint>) functions provide alignment and memory footprint information for the epoch leader structures. The code is designed to be used in a larger system where epoch leaders are determined based on vote stakes, and it ensures efficient memory usage by reusing memory for different purposes during the initialization process.
# Imports and Dependencies

---
- `fd_leaders.h`
- `../../ballet/chacha/fd_chacha_rng.h`
- `../../ballet/wsample/fd_wsample.h`
- `../../util/tmpl/fd_sort.c`


# Functions

---
### fd\_epoch\_leaders\_align<!-- {{#callable:fd_epoch_leaders_align}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_leaders.c#L15>)

Returns the alignment requirement for epoch leaders.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the value of the macro `FD_EPOCH_LEADERS_ALIGN`.
- **Output**: The function returns an `ulong` value representing the alignment requirement for epoch leaders.


---
### fd\_epoch\_leaders\_footprint<!-- {{#callable:fd_epoch_leaders_footprint}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_leaders.c#L20>)

Calculates the memory footprint required for epoch leaders based on the number of public keys and slots.
- **Inputs**:
    - `pub_cnt`: The number of public keys.
    - `slot_cnt`: The number of slots.
- **Logic and Control Flow**:
    - Checks if `pub_cnt` is zero, greater than `UINT_MAX-3`, or if `slot_cnt` is zero.
    - Returns 0 if any of the above conditions are true.
    - Otherwise, returns the result of `FD_EPOCH_LEADERS_FOOTPRINT(pub_cnt, slot_cnt)`.
- **Output**: Returns the calculated memory footprint as an unsigned long integer, or 0 if input conditions are not met.


---
### fd\_epoch\_leaders\_new<!-- {{#callable:fd_epoch_leaders_new}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_leaders.c#L30>)

Initializes and returns a new epoch leaders structure in shared memory, organizing and sampling vote stakes for leader scheduling.
- **Inputs**:
    - `shmem`: Pointer to shared memory where the epoch leaders structure will be created.
    - `epoch`: The epoch number for which the leaders are being scheduled.
    - `slot0`: The starting slot number for the epoch.
    - `slot_cnt`: The total number of slots in the epoch.
    - `pub_cnt`: The number of public keys (or vote stakes) provided.
    - `stakes`: Array of vote stake weights, each containing a public key and a stake value.
    - `excluded_stake`: The amount of stake to exclude from the sampling process.
    - `vote_keyed_lsched`: Flag indicating whether to use vote-keyed leader scheduling.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL and return NULL if true.
    - Check if `shmem` is aligned to `FD_EPOCH_LEADERS_ALIGN` and return NULL if not aligned.
    - If `vote_keyed_lsched` is 0, sort `stakes` by ID, deduplicate by aggregating stakes, and then sort by stake and ID.
    - Calculate `sched_cnt` as the number of schedule entries needed for the slots.
    - Align memory for `fd_epoch_leaders_t`, `sched`, and `pubkeys` within `shmem`.
    - Initialize a ChaCha20 random number generator with the `epoch` as the seed.
    - Create a weighted sample object using the stakes and excluded stake.
    - Generate schedule indices using the weighted sample, mapping indeterminate values to `pub_cnt`.
    - Clean up the weighted sample and random number generator.
    - Copy public keys from `stakes` to `pubkeys` and add an indeterminate leader key at the end.
    - Populate the `fd_epoch_leaders_t` structure with epoch, slot, public keys, and schedule information.
    - Return the pointer to the initialized shared memory.
- **Output**: Pointer to the initialized shared memory containing the epoch leaders structure, or NULL if initialization fails.
- **Functions Called**:
    - [`fd_epoch_leaders_footprint`](<#fd_epoch_leaders_footprint>)


---
### fd\_epoch\_leaders\_join<!-- {{#callable:fd_epoch_leaders_join}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_leaders.c#L150>)

Casts a generic pointer to a `fd_epoch_leaders_t` pointer.
- **Inputs**:
    - ``shleaders``: A pointer to a shared memory region that is expected to be of type `fd_epoch_leaders_t`.
- **Logic and Control Flow**:
    - Casts the input pointer `shleaders` to a `fd_epoch_leaders_t` pointer.
    - Returns the casted pointer.
- **Output**: A pointer of type `fd_epoch_leaders_t`.


---
### fd\_epoch\_leaders\_leave<!-- {{#callable:fd_epoch_leaders_leave}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_leaders.c#L155>)

Returns the input `fd_epoch_leaders_t` pointer cast to a `void` pointer.
- **Inputs**:
    - `leaders`: A pointer to an `fd_epoch_leaders_t` structure.
- **Logic and Control Flow**:
    - Cast the `leaders` pointer to a `void` pointer.
    - Return the casted pointer.
- **Output**: A `void` pointer that is the casted input `leaders` pointer.


---
### fd\_epoch\_leaders\_delete<!-- {{#callable:fd_epoch_leaders_delete}} -->
[View Source →](<../../../../../src/flamenco/leaders/fd_leaders.c#L160>)

Returns the input pointer `shleaders` without modification.
- **Inputs**:
    - `shleaders`: A pointer to a shared leaders structure that is to be deleted.
- **Logic and Control Flow**:
    - The function takes a single input parameter `shleaders`.
    - It returns the same `shleaders` pointer without performing any operations on it.
- **Output**: The same pointer `shleaders` that was passed as input.



---
Made with ❤️ by [Driver](https://www.driver.ai/)