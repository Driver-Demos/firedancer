<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions to create and initialize program cache records for SBPF programs.

# Purpose
The code defines functions for creating and initializing `fd_progcache_rec_t` objects, which are used to manage program cache records in a system that handles eBPF (extended Berkeley Packet Filter) programs. The primary function, [`fd_progcache_rec_new`](<#fd_progcache_rec_new>), initializes a new program cache record by allocating memory for various components such as call destinations and read-only data, based on the provided ELF (Executable and Linkable Format) information. It sets up an SBPF (Solana Berkeley Packet Filter) loader, registers system calls, and loads the ELF program into memory. The function also validates the bytecode using a virtual machine (`fd_vm_t`) to ensure it meets the required constraints before marking the record as executable.

The code also includes a simpler function, [`fd_progcache_rec_new_nx`](<#fd_progcache_rec_new_nx>), which initializes a non-executable program cache record. This function sets the `executable` flag to 0, indicating that the record is not intended to execute a program. Both functions use memory management macros and functions to allocate and initialize the necessary structures, ensuring that the program cache records are correctly set up for use in the system. The code relies on external components such as `fd_vm` for virtual machine operations and `fd_sbpf` for handling SBPF-specific tasks.
# Imports and Dependencies

---
- `fd_progcache_rec.h`
- `../vm/fd_vm.h`


# Functions

---
### fd\_progcache\_rec\_new<!-- {{#callable:fd_progcache_rec_new}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_rec.c#L4>)

Initializes and returns a new `fd_progcache_rec_t` object by setting up memory, loading an ELF program, and validating bytecode.
- **Inputs**:
    - `mem`: Pointer to memory where the `fd_progcache_rec_t` object will be allocated.
    - `elf_info`: Pointer to `fd_sbpf_elf_info_t` containing ELF file information.
    - `config`: Pointer to `fd_sbpf_loader_config_t` containing loader configuration.
    - `load_slot`: Unsigned long representing the load slot for the program.
    - `features`: Pointer to `fd_features_t` containing feature flags.
    - `progdata`: Pointer to the program data to be loaded.
    - `progdata_sz`: Unsigned long representing the size of the program data.
    - `scratch`: Pointer to scratch memory used during loading.
    - `scratch_sz`: Unsigned long representing the size of the scratch memory.
- **Logic and Control Flow**:
    - Check if call destinations are needed based on the SBPF version.
    - Initialize scratch memory allocation and allocate memory for `fd_progcache_rec_t`, call destinations, and read-only data.
    - Set offsets for call destinations and read-only data in the `fd_progcache_rec_t` object.
    - Initialize an `fd_sbpf_program_t` structure with ELF information and memory pointers.
    - If call destinations are needed and text count is greater than zero, initialize call destinations memory.
    - Create and join a syscall table, then register the syscall slot.
    - Load the ELF program using `fd_sbpf_program_load` and check for errors.
    - Set entry point and read-only data size in the `fd_progcache_rec_t` object.
    - Create and initialize a virtual machine for bytecode validation.
    - Validate the bytecode using `fd_vm_validate` and check for errors.
    - Set the load slot and executable flag in the `fd_progcache_rec_t` object.
    - Return the initialized `fd_progcache_rec_t` object.
- **Output**: A pointer to the initialized `fd_progcache_rec_t` object, or `NULL` if an error occurs during loading or validation.
- **Functions Called**:
    - [`fd_progcache_rec_align`](<fd_progcache_rec.h.md#fd_progcache_rec_align>)


---
### fd\_progcache\_rec\_new\_nx<!-- {{#callable:fd_progcache_rec_new_nx}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_rec.c#L102>)

Initializes a `fd_progcache_rec_t` structure with default values and a specified load slot.
- **Inputs**:
    - `mem`: A pointer to memory where the `fd_progcache_rec_t` structure will be initialized.
    - `load_slot`: An unsigned long integer representing the load slot to be assigned to the `fd_progcache_rec_t` structure.
- **Logic and Control Flow**:
    - Cast the `mem` pointer to a `fd_progcache_rec_t` pointer named `rec`.
    - Set all bytes of the `rec` structure to zero using `memset`.
    - Assign the `load_slot` value to the `slot` field of the `rec` structure.
    - Set the `executable` field of the `rec` structure to 0.
    - Return the pointer `rec`.
- **Output**: Returns a pointer to the initialized `fd_progcache_rec_t` structure.



---
Made with ❤️ by [Driver](https://www.driver.ai/)