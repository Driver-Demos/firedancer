<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for managing a program cache, including joining, leaving, loading forks, querying, inserting, and invalidating cache entries.

# Purpose
The code is a C module that manages a program cache, specifically designed to handle transactions and records within a forked transaction graph. It provides functions to join and leave a program cache, load forks, query cache entries, and manage cache records. The module is intended to be part of a larger system, as indicated by its inclusion of headers like `fd_prog_load.h`, `fd_progcache_user.h`, and `fd_progcache_rec.h`. It defines several functions that operate on a `fd_progcache_t` structure, which represents the program cache, and interacts with transaction and record maps to manage cache entries.

Key functions include [`fd_progcache_join`](<#fd_progcache_join>) and [`fd_progcache_leave`](<#fd_progcache_leave>), which manage the lifecycle of a cache instance, and [`fd_progcache_load_fork`](<#fd_progcache_load_fork>), which pivots the cache to a specific fork in the transaction graph. The module also provides functions like [`fd_progcache_peek`](<#fd_progcache_peek>) and [`fd_progcache_pull`](<#fd_progcache_pull>) to search for and retrieve cache entries, and [`fd_progcache_invalidate`](<#fd_progcache_invalidate>) to mark entries as invalid. The code uses various utility functions and macros, such as `FD_UNLIKELY` and `FD_LIKELY`, to optimize performance and handle error conditions. The module is designed to be thread-safe, with mechanisms to handle concurrent access and potential data races.
# Imports and Dependencies

---
- `fd_prog_load.h`
- `fd_progcache_user.h`
- `fd_progcache_rec.h`


# Functions

---
### fd\_progcache\_join<!-- {{#callable:fd_progcache_join}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_user.c#L7>)

Initializes and joins a `fd_progcache_t` structure with provided shared function and scratch space, ensuring alignment and validity of inputs.
- **Inputs**:
    - ``ljoin``: A pointer to a `fd_progcache_t` structure to initialize and join.
    - ``shfunk``: A pointer to a shared function object to join with the `fd_progcache_t` structure.
    - ``scratch``: A pointer to a scratch space used for temporary data storage, which must be aligned if `scratch_sz` is non-zero.
    - ``scratch_sz``: The size of the scratch space in bytes.
- **Logic and Control Flow**:
    - Check if `ljoin` is NULL; if so, log a warning and return NULL.
    - Check if `shfunk` is NULL; if so, log a warning and return NULL.
    - If `scratch_sz` is non-zero, check if `scratch` is NULL or misaligned; if so, log a warning and return NULL.
    - Initialize the `ljoin` structure to zero using `memset`.
    - Attempt to join the `shfunk` with `ljoin->funk` using `fd_funk_join`; if it fails, return NULL.
    - Set `ljoin->metrics` to point to `fd_progcache_metrics_default`.
    - Assign `scratch` and `scratch_sz` to `ljoin->scratch` and `ljoin->scratch_sz`, respectively.
    - Return the initialized `ljoin` structure.
- **Output**: Returns a pointer to the initialized `fd_progcache_t` structure, or NULL if any validation checks fail.


---
### fd\_progcache\_leave<!-- {{#callable:fd_progcache_leave}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_user.c#L40>)

Releases resources associated with a program cache and resets its state.
- **Inputs**:
    - ``cache``: A pointer to an `fd_progcache_t` structure representing the program cache to leave.
    - ``opt_shfunk``: An optional pointer to a `void*` that may be used to store additional information during the leave operation.
- **Logic and Control Flow**:
    - Checks if `cache` is NULL; if so, logs a warning and returns NULL.
    - Attempts to leave the `funk` associated with the `cache` using `fd_funk_leave`; if unsuccessful, returns NULL.
    - Sets `cache->scratch` to NULL and `cache->scratch_sz` to 0.
    - Returns the `cache` pointer.
- **Output**: Returns a pointer to the `fd_progcache_t` structure if successful, or NULL if an error occurs.


---
### fd\_progcache\_load\_fork\_slow<!-- {{#callable:fd_progcache_load_fork_slow}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_user.c#L62>)

Traverses a transaction graph to load a fork into the program cache, handling overruns and ensuring transactions are within the current epoch.
- **Inputs**:
    - ``cache``: A pointer to an `fd_progcache_t` structure representing the program cache to load the fork into.
    - ``xid``: A pointer to a `fd_funk_txn_xid_t` structure representing the transaction ID to start loading the fork from.
    - ``epoch_slot0``: An unsigned long integer representing the first slot of the bank's epoch, used to ensure transactions are within the current epoch.
- **Logic and Control Flow**:
    - Initialize `next_xid` with the value pointed to by `xid` and check if it predates `epoch_slot0`; log a critical error if it does.
    - Set `cache->fork_depth` to 0 and determine the maximum number of transactions in the pool using `fd_funk_txn_pool_ele_max`.
    - Iterate up to `FD_PROGCACHE_DEPTH_MAX` times to traverse the transaction graph.
    - In each iteration, attempt to query the transaction map for `next_xid` using `fd_funk_txn_map_query_try`; handle errors and retry if necessary.
    - Retrieve the candidate transaction and its parent index, then verify the transaction still exists in the map.
    - Check for memory corruption by comparing `found_xid` with `next_xid` and log a critical error if they do not match.
    - Store `next_xid` in `cache->fork` and check if the parent index is null or if `next_xid` predates `epoch_slot0`; if so, break the loop.
    - Update `next_xid` to `parent_xid` and continue the loop.
    - After the loop, set `cache->fork_depth` to the number of transactions traversed.
    - If the last published transaction is within the current epoch and the fork depth is less than `FD_PROGCACHE_DEPTH_MAX`, set the root of the fork.
- **Output**: No return value; the function modifies the `cache` structure to reflect the loaded fork.


---
### fd\_progcache\_load\_fork<!-- {{#callable:fd_progcache_load_fork}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_user.c#L151>)

Switches the program cache to a specified fork if it is not already on that fork.
- **Inputs**:
    - ``cache``: A pointer to an `fd_progcache_t` structure representing the program cache.
    - ``xid``: A pointer to a `fd_funk_txn_xid_t` structure representing the transaction ID of the fork to switch to.
    - ``epoch_slot0``: An unsigned long integer representing the starting slot of the epoch.
- **Logic and Control Flow**:
    - Checks if the cache is already on the correct fork by verifying if `cache->fork_depth` is non-zero and if the first element of `cache->fork` matches `xid`.
    - If the cache is on the correct fork, the function returns immediately.
    - If the cache is not on the correct fork, increments the `fork_switch_cnt` metric in `cache->metrics`.
    - Calls [`fd_progcache_load_fork_slow`](<#fd_progcache_load_fork_slow>) to switch the fork.
- **Output**: No output is returned as the function is `void`.
- **Functions Called**:
    - [`fd_progcache_load_fork_slow`](<#fd_progcache_load_fork_slow>)


---
### fd\_progcache\_fork\_has\_xid<!-- {{#callable:fd_progcache_fork_has_xid}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_user.c#L164>)

Checks if a given transaction ID (`rec_xid`) exists in the fork list of a program cache (`cache`).
- **Inputs**:
    - ``cache``: A pointer to a `fd_progcache_t` structure representing the program cache to search within.
    - ``rec_xid``: A pointer to a `fd_funk_txn_xid_t` structure representing the transaction ID to search for in the cache's fork list.
- **Logic and Control Flow**:
    - Retrieve the `fork_depth` from the `cache` structure, which indicates the number of transaction IDs in the fork list.
    - Iterate over the fork list up to `fork_depth`.
    - For each transaction ID in the fork list, check if it matches `rec_xid` using the `fd_funk_txn_xid_eq` function.
    - If a match is found, return 1 to indicate the presence of `rec_xid` in the fork list.
    - If no match is found after checking all entries, return 0.
- **Output**: Returns 1 if `rec_xid` is found in the fork list, otherwise returns 0.


---
### fd\_progcache\_search\_chain<!-- {{#callable:fd_progcache_search_chain}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_user.c#L175>)

Searches a chain in the program cache for a record matching a given key and epoch constraints, returning the best match.
- **Inputs**:
    - ``cache``: A pointer to a `fd_progcache_t` structure representing the program cache.
    - ``chain_idx``: An unsigned long integer representing the index of the chain to search within the cache.
    - ``key``: A pointer to a `fd_funk_rec_key_t` structure representing the key to search for in the chain.
    - ``epoch_slot0``: An unsigned long integer representing the minimum epoch slot for valid records.
    - ``out_rec``: A pointer to a pointer to a `fd_funk_rec_t` structure where the function will store the best matching record found.
- **Logic and Control Flow**:
    - Initialize `*out_rec` to `NULL` to indicate no record found initially.
    - Retrieve the shared memory map and chain table from the cache, and identify the specific chain to search using `chain_idx`.
    - Determine the maximum number of records and the root slot from the cache's record pool and last published record, respectively.
    - Check if the chain is locked by examining the version count; if locked, return `FD_MAP_ERR_AGAIN`.
    - Iterate over the records in the chain, checking each record's key, epoch slot, and fork membership against the search criteria.
    - Update the best matching record if a better match is found based on the epoch slot and fork membership.
    - Check for cycles and memory corruption in the chain during iteration, logging critical errors if detected.
    - If the chain's version count has changed during the search, indicating an overrun, return `FD_MAP_ERR_AGAIN`.
    - Set `*out_rec` to the best matching record found and return `FD_MAP_SUCCESS`.
- **Output**: Returns `FD_MAP_SUCCESS` if a matching record is found and `FD_MAP_ERR_AGAIN` if the chain is locked or an overrun occurs.
- **Functions Called**:
    - [`fd_progcache_fork_has_xid`](<#fd_progcache_fork_has_xid>)


---
### fd\_progcache\_query<!-- {{#callable:fd_progcache_query}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_user.c#L245>)

Searches for a program cache entry in the current fork, stopping before an epoch boundary.
- **Inputs**:
    - ``cache``: A pointer to the `fd_progcache_t` structure representing the program cache.
    - ``xid``: A constant pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``key``: A constant pointer to the `fd_funk_rec_key_t` structure representing the record key.
    - ``epoch_slot0``: An unsigned long integer representing the starting slot of the epoch.
- **Logic and Control Flow**:
    - Copy the transaction ID and record key into a `fd_funk_xid_key_pair_t` structure.
    - Calculate the hash of the key pair using the seed from the record map.
    - Determine the chain index by applying a bitmask to the hash value.
    - Initialize a loop to search the chain for a candidate record.
    - Call [`fd_progcache_search_chain`](<#fd_progcache_search_chain>) to search the chain for the record.
    - If the search is successful (`FD_MAP_SUCCESS`), break the loop.
    - Pause the execution if the search is not successful, indicating a retry is needed.
    - Return the found record.
- **Output**: Returns a pointer to the `fd_funk_rec_t` structure representing the found record, or `NULL` if not found.
- **Functions Called**:
    - [`fd_progcache_search_chain`](<#fd_progcache_search_chain>)


---
### fd\_progcache\_peek\_exact<!-- {{#callable:fd_progcache_peek_exact}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_user.c#L270>)

Searches for an exact program cache entry in the cache using a transaction ID and program address.
- **Inputs**:
    - ``cache``: A pointer to the `fd_progcache_t` structure representing the program cache.
    - ``xid``: A constant pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``prog_addr``: A constant pointer to the program address to search for in the cache.
- **Logic and Control Flow**:
    - Copy the transaction ID from `xid` to `key->xid` using `fd_funk_txn_xid_copy`.
    - Copy 32 bytes from `prog_addr` to `key->key->uc` using `memcpy`.
    - Enter an infinite loop to query the record map using `fd_funk_rec_map_query_try`.
    - If `query_err` is `FD_MAP_ERR_AGAIN`, call `FD_SPIN_PAUSE` and continue the loop.
    - If `query_err` is `FD_MAP_ERR_KEY`, return `NULL`.
    - If `query_err` is not `FD_MAP_SUCCESS`, log a critical error and exit.
    - If the query is successful, return the constant value of the record using `fd_funk_val_const`.
- **Output**: A constant pointer to `fd_progcache_rec_t` if the entry is found, otherwise `NULL`.


---
### fd\_progcache\_peek<!-- {{#callable:fd_progcache_peek}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_user.c#L293>)

Retrieves a program cache entry from a specified cache, transaction ID, program address, and epoch slot, updating metrics and handling cache misses.
- **Inputs**:
    - ``cache``: A pointer to an `fd_progcache_t` structure representing the program cache to query.
    - ``xid``: A pointer to an `fd_funk_txn_xid_t` structure representing the transaction ID to use for the query.
    - ``prog_addr``: A pointer to a memory location containing the program address to query.
    - ``epoch_slot0``: An unsigned long integer representing the starting slot of the epoch to consider for the query.
- **Logic and Control Flow**:
    - Checks if `cache` or `cache->funk->shmem` is NULL and logs a critical error if so.
    - Calls [`fd_progcache_load_fork`](<#fd_progcache_load_fork>) to ensure the cache is loaded with the correct fork based on `xid` and `epoch_slot0`.
    - Copies the program address from `prog_addr` into a `fd_funk_rec_key_t` structure.
    - Queries the cache using [`fd_progcache_query`](<#fd_progcache_query>) with the provided `xid`, key, and `epoch_slot0`.
    - If no record is found, returns NULL.
    - Retrieves a constant pointer to the cache entry using `fd_funk_val_const`.
    - Checks if the entry's slot is less than `epoch_slot0` and sets `entry` to NULL if true.
    - Increments the cache hit count metric if an entry is found.
    - Returns the cache entry.
- **Output**: A constant pointer to an `fd_progcache_rec_t` structure representing the cache entry, or NULL if no valid entry is found.
- **Functions Called**:
    - [`fd_progcache_load_fork`](<#fd_progcache_load_fork>)
    - [`fd_progcache_query`](<#fd_progcache_query>)


---
### fd\_funk\_rec\_push\_tail<!-- {{#callable:fd_funk_rec_push_tail}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_user.c#L312>)

Appends a record to the tail of a doubly linked list in a thread-safe manner.
- **Inputs**:
    - ``rec_pool``: A pointer to the pool of records, which is an array of `fd_funk_rec_t` structures.
    - ``rec``: A pointer to the record to append to the list.
    - ``rec_head_idx``: A pointer to the index of the head of the list.
    - ``rec_tail_idx``: A pointer to the index of the tail of the list.
- **Logic and Control Flow**:
    - Calculate the index of the record to append by subtracting the base address of `rec_pool` from `rec`.
    - Enter an infinite loop to attempt appending the record to the list.
    - Retrieve the current tail index using `FD_VOLATILE_CONST` to ensure memory consistency.
    - Set the `prev_idx` of the new record to the current tail index and `next_idx` to `FD_FUNK_REC_IDX_NULL`.
    - Use `FD_COMPILER_MFENCE` to ensure memory operations are completed before proceeding.
    - Determine the pointer to the `next_idx` of the current tail record or the head index if the list is empty.
    - Attempt to atomically set the `next_idx` of the current tail or head index to the new record index using `__sync_bool_compare_and_swap`.
    - If the compare-and-swap operation fails, pause and retry the loop.
    - Attempt to atomically update the tail index to the new record index using `__sync_bool_compare_and_swap`.
    - If the second compare-and-swap operation fails, log a critical error and exit.
    - Break the loop if both compare-and-swap operations succeed.
- **Output**: None (void function).


---
### fd\_progcache\_push<!-- {{#callable:fd_progcache_push}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_user.c#L355>)

Inserts a record into the program cache, ensuring atomicity and handling potential conflicts with other threads.
- **Inputs**:
    - ``cache``: A pointer to an `fd_progcache_t` structure representing the program cache.
    - ``txn``: A pointer to an `fd_funk_txn_t` structure representing the transaction, or `NULL` if no transaction is involved.
    - ``rec``: A pointer to an `fd_funk_rec_t` structure representing the record to be inserted.
    - ``prog_addr``: A constant pointer to the program address, used to determine the record's key.
- **Logic and Control Flow**:
    - Initialize the `funk` pointer from the `cache` structure.
    - Set the record's `tag`, `prev_idx`, and `next_idx` to initial values.
    - Copy the program address to the record's key.
    - If a transaction is provided, copy its XID to the record; otherwise, set the record's XID to root.
    - Initialize a transaction on the record map and add the record's key to it.
    - Attempt to lock the record map chain; log a critical error if unsuccessful.
    - Try to insert the record into the transaction's record list; if another thread has already inserted it, finalize the transaction and return 0.
    - If a transaction is provided, append the record to the transaction's record list.
    - Test and finalize the record map transaction, logging a critical error if the test fails.
    - Return 1 to indicate successful insertion.
- **Output**: Returns an integer indicating success (1) or failure (0) of the record insertion.
- **Functions Called**:
    - [`fd_funk_rec_push_tail`](<#fd_funk_rec_push_tail>)


---
### fd\_progcache\_txn\_try\_lock<!-- {{#callable:fd_progcache_txn_try_lock}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_user.c#L419>)

Attempts to acquire a read lock on a transaction by incrementing its lock value atomically.
- **Inputs**:
    - `txn`: A pointer to an `fd_funk_txn_t` structure representing the transaction to lock.
- **Logic and Control Flow**:
    - Enters an infinite loop to attempt locking the transaction.
    - Retrieves the current lock value from the transaction's lock field.
    - Checks if the lock value is greater than or equal to `0xFFFE`, indicating a write lock, and returns 0 if true.
    - Attempts to increment the lock value atomically using `FD_ATOMIC_CAS` and checks if the operation was successful.
    - Returns 1 if the lock was successfully incremented, indicating a read lock acquisition.
- **Output**: Returns 1 if the transaction is successfully read-locked, or 0 if it is write-locked.


---
### fd\_progcache\_txn\_unlock<!-- {{#callable:fd_progcache_txn_unlock}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_user.c#L431>)

Releases a read lock on a transaction if the transaction is not NULL.
- **Inputs**:
    - `txn`: A pointer to an `fd_funk_txn_t` structure representing the transaction to unlock.
- **Logic and Control Flow**:
    - Check if `txn` is NULL; if it is, return immediately without doing anything.
    - Call `fd_rwlock_unread` with `txn->lock` to release the read lock on the transaction.
- **Output**: No output is returned from this function.


---
### fd\_progcache\_lock\_best\_txn<!-- {{#callable:fd_progcache_lock_best_txn}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_user.c#L451>)

Locks the best transaction node in the fork graph for a given target slot to insert a program cache entry.
- **Inputs**:
    - ``cache``: A pointer to the `fd_progcache_t` structure representing the program cache.
    - ``target_slot``: An unsigned long integer representing the target slot for which the best transaction node is to be locked.
- **Logic and Control Flow**:
    - Load the last published transaction ID into `last_publish` using `fd_funk_txn_xid_ld_atomic` and `fd_funk_last_publish`.
    - Check if `target_slot` is less than or equal to the last published slot and if `last_publish` is not the root; if true, return `NULL`.
    - Initialize `target_xid_idx` to zero and iterate over the fork graph to find the oldest node with a slot greater than or equal to `target_slot`.
    - Backtrack through the fork graph nodes to find a node with a slot greater than or equal to the access slot.
    - For each node, query the transaction using `fd_funk_txn_query` and attempt to lock it using [`fd_progcache_txn_try_lock`](<#fd_progcache_txn_try_lock>).
    - If a transaction is successfully locked, return it; otherwise, continue to the next node.
    - If no suitable node is found, log a critical error message.
- **Output**: Returns a pointer to the locked `fd_funk_txn_t` transaction if successful, or `NULL` if no suitable transaction is found.
- **Functions Called**:
    - [`fd_progcache_txn_try_lock`](<#fd_progcache_txn_try_lock>)


---
### fd\_progcache\_insert<!-- {{#callable:fd_progcache_insert}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_user.c#L489>)

Inserts a program cache entry into the cache, ensuring it does not cross epoch boundaries or shadow invalidations, and handles potential race conditions with other threads.
- **Inputs**:
    - ``cache``: A pointer to the `fd_progcache_t` structure representing the program cache.
    - ``accdb``: A pointer to the `fd_funk_t` structure representing the access database.
    - ``load_xid``: A pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID of the fork currently being executed.
    - ``prog_addr``: A pointer to the program address to be inserted into the cache.
    - ``env``: A pointer to the `fd_prog_load_env_t` structure containing the environment settings for loading the program.
    - ``slot_min``: A long integer representing the minimum slot value to prevent cache entry shadowing.
- **Logic and Control Flow**:
    - Acquire a reference to the ELF binary data using [`fd_prog_load_elf`](<fd_prog_load.c.md#fd_prog_load_elf>) and determine the `target_slot` based on `modify_xid` and environment constraints.
    - Ensure the `target_slot` does not cross epoch boundaries or shadow invalidations by adjusting it with `fd_ulong_max` and `fd_long_max`.
    - Acquire a `funk_rec` from the record pool and initialize it.
    - Lock the best transaction for cache entry creation using [`fd_progcache_lock_best_txn`](<#fd_progcache_lock_best_txn>).
    - Load the program using `fd_sbpf_elf_peek` and, if successful, allocate memory for the cache record and create a new cache record with [`fd_progcache_rec_new`](<fd_progcache_rec.c.md#fd_progcache_rec_new>).
    - If loading fails, create a tombstone record with [`fd_progcache_rec_new_nx`](<fd_progcache_rec.c.md#fd_progcache_rec_new_nx>).
    - Publish the cache entry to the funk index using [`fd_progcache_push`](<#fd_progcache_push>).
    - Unlock the transaction with [`fd_progcache_txn_unlock`](<#fd_progcache_txn_unlock>).
    - If another thread published the same record faster, retrieve and return the existing record using [`fd_progcache_peek`](<#fd_progcache_peek>).
    - Update cache metrics for successful insertions or duplicate insertions.
- **Output**: Returns a pointer to the newly inserted `fd_progcache_rec_t` record, or an existing record if another thread published it first, or `NULL` if the operation fails.
- **Functions Called**:
    - [`fd_prog_load_elf`](<fd_prog_load.c.md#fd_prog_load_elf>)
    - [`fd_progcache_lock_best_txn`](<#fd_progcache_lock_best_txn>)
    - [`fd_prog_versions`](<fd_prog_load.h.md#fd_prog_versions>)
    - [`fd_progcache_rec_align`](<fd_progcache_rec.h.md#fd_progcache_rec_align>)
    - [`fd_progcache_rec_footprint`](<fd_progcache_rec.h.md#fd_progcache_rec_footprint>)
    - [`fd_progcache_rec_new`](<fd_progcache_rec.c.md#fd_progcache_rec_new>)
    - [`fd_progcache_rec_new_nx`](<fd_progcache_rec.c.md#fd_progcache_rec_new_nx>)
    - [`fd_progcache_push`](<#fd_progcache_push>)
    - [`fd_progcache_txn_unlock`](<#fd_progcache_txn_unlock>)
    - [`fd_progcache_peek`](<#fd_progcache_peek>)


---
### fd\_progcache\_pull<!-- {{#callable:fd_progcache_pull}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_user.c#L605>)

Retrieves a program cache entry for a given transaction ID and program address, or inserts a new entry if not found.
- **Inputs**:
    - ``cache``: A pointer to the `fd_progcache_t` structure representing the program cache.
    - ``accdb``: A pointer to the `fd_funk_t` structure representing the access database.
    - ``xid``: A pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``prog_addr``: A pointer to the program address to look up in the cache.
    - ``env``: A pointer to the `fd_prog_load_env_t` structure containing environment settings, including the epoch slot.
- **Logic and Control Flow**:
    - Checks if the `cache` or its shared memory is NULL and logs a critical error if so.
    - Calls [`fd_progcache_load_fork`](<#fd_progcache_load_fork>) to ensure the cache is aligned with the current transaction fork.
    - Attempts to find a cache entry using [`fd_progcache_peek`](<#fd_progcache_peek>) with the given `xid`, `prog_addr`, and epoch slot from `env`.
    - If a cache entry is found and is not invalidated, updates cache hit metrics and returns the entry.
    - If the entry is invalidated, calculates the minimum slot for a new entry and logs a critical error if the transaction ID is less than this slot.
    - If no valid entry is found, updates cache miss metrics and calls [`fd_progcache_insert`](<#fd_progcache_insert>) to create a new cache entry.
- **Output**: Returns a pointer to the `fd_progcache_rec_t` structure representing the found or newly inserted cache entry.
- **Functions Called**:
    - [`fd_progcache_load_fork`](<#fd_progcache_load_fork>)
    - [`fd_progcache_peek`](<#fd_progcache_peek>)
    - [`fd_progcache_insert`](<#fd_progcache_insert>)


---
### fd\_progcache\_invalidate<!-- {{#callable:fd_progcache_invalidate}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_user.c#L643>)

Invalidates a program cache entry by creating a tombstone record and publishing it to the cache.
- **Inputs**:
    - ``cache``: A pointer to the `fd_progcache_t` structure representing the program cache.
    - ``xid``: A pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``prog_addr``: A pointer to the program address to be invalidated.
    - ``slot``: An unsigned long integer representing the slot number for the tombstone record.
- **Logic and Control Flow**:
    - Check if `cache` or `funk->shmem` is NULL and log a critical error if true.
    - Query the transaction using `fd_funk_txn_query` with `xid` and `funk->txn_map`.
    - Attempt to lock the transaction using [`fd_progcache_txn_try_lock`](<#fd_progcache_txn_try_lock>). Log a critical error if the transaction is write-locked.
    - Acquire a new `fd_funk_rec_t` record from the record pool using `fd_funk_rec_pool_acquire`. Log an error if the pool is out of memory.
    - Initialize the acquired record with zero values and call `fd_funk_val_init`.
    - Create a tombstone by truncating the record's memory using `fd_funk_val_truncate` and initialize it with [`fd_progcache_rec_new_nx`](<fd_progcache_rec.c.md#fd_progcache_rec_new_nx>). Log an error if memory allocation fails.
    - Set the `invalidate` field of the record to 1.
    - Publish the cache entry to the funk index using [`fd_progcache_push`](<#fd_progcache_push>).
    - Unlock the transaction using [`fd_progcache_txn_unlock`](<#fd_progcache_txn_unlock>).
    - If another thread published the same record faster, use the existing record from [`fd_progcache_peek_exact`](<#fd_progcache_peek_exact>) and log a critical error if it is not found.
    - Increment the `dup_insert_cnt` metric if a duplicate insert occurred.
    - Increment the `invalidate_cnt` metric.
- **Output**: Returns a pointer to the `fd_progcache_rec_t` structure representing the invalidated cache entry.
- **Functions Called**:
    - [`fd_progcache_txn_try_lock`](<#fd_progcache_txn_try_lock>)
    - [`fd_progcache_rec_align`](<fd_progcache_rec.h.md#fd_progcache_rec_align>)
    - [`fd_progcache_rec_footprint`](<fd_progcache_rec.h.md#fd_progcache_rec_footprint>)
    - [`fd_progcache_rec_new_nx`](<fd_progcache_rec.c.md#fd_progcache_rec_new_nx>)
    - [`fd_progcache_push`](<#fd_progcache_push>)
    - [`fd_progcache_txn_unlock`](<#fd_progcache_txn_unlock>)
    - [`fd_progcache_peek_exact`](<#fd_progcache_peek_exact>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)