<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Single-threaded correctness tests for the progcache component, including various scenarios and edge cases.

# Purpose
The `test_progcache.c` file is a C source code file that contains a suite of single-threaded correctness tests for a program cache system, referred to as `progcache`. The file includes various test functions that validate the behavior of the `progcache` in different scenarios, such as loading valid and invalid programs, handling cache invalidations, and managing transactions. The tests are designed to ensure that the `progcache` correctly handles program data, transaction preparation, cancellation, and publishing, as well as garbage collection of stale entries.

The file imports several headers and binary data files necessary for the tests, including program data files and system identifiers. It defines a `test_env` structure to encapsulate the testing environment, which includes workspace pointers, program cache, account database, and feature sets. The test functions utilize this environment to simulate different conditions and verify the correctness of the `progcache` operations. The main function orchestrates the execution of these tests, allowing for selective test execution based on command-line arguments. The file is intended to be compiled and executed as a standalone test suite to validate the functionality of the `progcache` system.
# Imports and Dependencies

---
- `fd_progcache_admin.h`
- `fd_progcache_user.h`
- `../accdb/fd_accdb_admin.h`
- `../accdb/fd_accdb_user.h`
- `../runtime/fd_system_ids.h`
- `../runtime/fd_txn_account.h`
- `../features/fd_features.h`


# Data Structures

---
### test\_env
- **Type**: ``struct``
- **Members**:
    - ``wksp``: Pointer to a workspace of type `fd_wksp_t`.
    - ``progcache_admin``: Array of one `fd_progcache_admin_t` for program cache administration.
    - ``progcache``: Array of one `fd_progcache_t` for program cache management.
    - ``accdb_admin``: Array of one `fd_accdb_admin_t` for account database administration.
    - ``accdb``: Array of one `fd_accdb_user_t` for account database user management.
    - ``features``: Array of one `fd_features_t` for feature management.
    - ``scratch``: Aligned scratch space for temporary data storage with size `FD_PROGCACHE_SCRATCH_FOOTPRINT`.
- **Description**: Manages the environment for testing program caches and account databases, including administration and user access for both components, and provides a scratch space for temporary data storage.


---
### test\_env\_t
- **Type**: ``struct``
- **Members**:
    - ``wksp``: Pointer to a workspace of type `fd_wksp_t`.
    - ``progcache_admin``: Array of one `fd_progcache_admin_t` for program cache administration.
    - ``progcache``: Array of one `fd_progcache_t` for program cache management.
    - ``accdb_admin``: Array of one `fd_accdb_admin_t` for account database administration.
    - ``accdb``: Array of one `fd_accdb_user_t` for account database user operations.
    - ``features``: Array of one `fd_features_t` for feature management.
    - ``scratch``: Aligned scratch space for temporary data with size `FD_PROGCACHE_SCRATCH_FOOTPRINT`.
- **Description**: Manages the environment for testing program cache and account database operations, including workspace allocation, program cache and account database administration, and feature management. It provides the necessary structures and memory alignment for executing tests related to program cache and account database functionalities.


---
### test\_case
- **Type**: ``struct``
- **Members**:
    - ``name``: A pointer to a constant character string representing the name of the test case.
    - ``fn``: A pointer to a function that takes a `fd_wksp_t` pointer as an argument and returns void, representing the test function to execute.
- **Description**: Defines a test case structure with a name and a function pointer, used to execute specific test functions within a testing framework.


# Functions

---
### test\_env\_create<!-- {{#callable:test_env_create}} -->
[View Source →](<../../../../../src/flamenco/progcache/test_progcache.c#L35>)

Allocates and initializes a `test_env_t` structure with account database and program cache in a given workspace.
- **Inputs**:
    - `wksp`: A pointer to a `fd_wksp_t` workspace where memory allocations will occur.
- **Logic and Control Flow**:
    - Set maximum transaction, account database record, and program cache record limits.
    - Allocate memory for the account database and program cache using `fd_wksp_alloc_laddr` with specified alignment and footprint.
    - Initialize the account database and program cache using `fd_funk_new` and verify success with `FD_TEST`.
    - Allocate memory for the `test_env_t` structure and verify allocation success.
    - Initialize the `test_env_t` structure to zero using `memset`.
    - Assign the workspace pointer to the `wksp` field of the `test_env_t` structure.
    - Join admin and user clients to the program cache and account database using [`fd_progcache_admin_join`](<fd_progcache_admin.c.md#fd_progcache_admin_join>), [`fd_progcache_join`](<fd_progcache_user.c.md#fd_progcache_join>), `fd_accdb_admin_join`, and `fd_accdb_user_join`, verifying each operation with `FD_TEST`.
    - Return the initialized `test_env_t` structure.
- **Output**: A pointer to the newly created and initialized `test_env_t` structure.
- **Functions Called**:
    - [`fd_progcache_admin_join`](<fd_progcache_admin.c.md#fd_progcache_admin_join>)
    - [`fd_progcache_join`](<fd_progcache_user.c.md#fd_progcache_join>)


---
### test\_env\_destroy<!-- {{#callable:test_env_destroy}} -->
[View Source →](<../../../../../src/flamenco/progcache/test_progcache.c#L63>)

Releases resources associated with a `test_env_t` environment by leaving and deleting program cache and account database memory.
- **Inputs**:
    - `env`: A pointer to a `test_env_t` structure representing the environment to destroy.
- **Logic and Control Flow**:
    - Verify the program cache admin using [`fd_progcache_verify`](<fd_progcache_admin.c.md#fd_progcache_verify>) with `env->progcache_admin`.
    - Initialize `accdb_mem` to `NULL`.
    - Leave the program cache admin using [`fd_progcache_admin_leave`](<fd_progcache_admin.c.md#fd_progcache_admin_leave>), passing `env->progcache_admin` and `accdb_mem`.
    - Leave the program cache using [`fd_progcache_leave`](<fd_progcache_user.c.md#fd_progcache_leave>), passing `env->progcache` and `accdb_mem`.
    - Delete the account database memory using `fd_funk_delete` and free it using `fd_wksp_free_laddr`.
    - Initialize `progcache_mem` to `NULL`.
    - Leave the account database using `fd_funk_leave`, passing `env->accdb->funk` and `progcache_mem`.
    - Delete the program cache memory using `fd_funk_delete` and free it using `fd_wksp_free_laddr`.
    - Free the environment memory using `fd_wksp_free_laddr`.
- **Output**: No return value; the function performs cleanup operations.
- **Functions Called**:
    - [`fd_progcache_verify`](<fd_progcache_admin.c.md#fd_progcache_verify>)
    - [`fd_progcache_admin_leave`](<fd_progcache_admin.c.md#fd_progcache_admin_leave>)
    - [`fd_progcache_leave`](<fd_progcache_user.c.md#fd_progcache_leave>)


---
### test\_env\_txn\_prepare<!-- {{#callable:test_env_txn_prepare}} -->
[View Source →](<../../../../../src/flamenco/progcache/test_progcache.c#L82>)

Creates a new in-preparation transaction in both the account database and program cache, using a specified parent transaction ID and a new transaction ID.
- **Inputs**:
    - ``env``: A pointer to a `test_env_t` structure, which contains the environment for the transaction.
    - ``parent``: A pointer to a `fd_funk_txn_xid_t` structure representing the parent transaction ID. If `NULL`, the function uses the root transaction ID.
    - ``xid``: A pointer to a `fd_funk_txn_xid_t` structure representing the new transaction ID to be prepared.
- **Logic and Control Flow**:
    - Declare a local variable `root` of type `fd_funk_txn_xid_t` to store the root transaction ID if needed.
    - Check if `parent` is `NULL`. If it is, set `root` as the root transaction ID using `fd_funk_txn_xid_set_root` and assign `parent` to `root`.
    - Attach the new transaction ID `xid` as a child to the `parent` transaction ID in the account database using `fd_accdb_attach_child`.
    - Attach the new transaction ID `xid` as a child to the `parent` transaction ID in the program cache using [`fd_progcache_txn_attach_child`](<fd_progcache_admin.c.md#fd_progcache_txn_attach_child>).
- **Output**: No return value; the function modifies the state of the account database and program cache in the provided environment.
- **Functions Called**:
    - [`fd_progcache_txn_attach_child`](<fd_progcache_admin.c.md#fd_progcache_txn_attach_child>)


---
### test\_env\_txn\_cancel<!-- {{#callable:test_env_txn_cancel}} -->
[View Source →](<../../../../../src/flamenco/progcache/test_progcache.c#L98>)

Cancels a subtree of in-prep transactions with a specified root transaction ID in both the account database and program cache.
- **Inputs**:
    - ``env``: A pointer to a `test_env_t` structure, which contains the environment for the test, including the account database and program cache administrators.
    - ``xid``: A constant pointer to an `fd_funk_txn_xid_t` structure, representing the root transaction ID of the subtree to cancel.
- **Logic and Control Flow**:
    - Calls `fd_accdb_cancel` with the account database administrator and the transaction ID to cancel the transaction subtree in the account database.
    - Calls [`fd_progcache_txn_cancel`](<fd_progcache_admin.c.md#fd_progcache_txn_cancel>) with the program cache administrator and the transaction ID to cancel the transaction subtree in the program cache.
- **Output**: No return value; the function performs operations to cancel transactions in the provided environment.
- **Functions Called**:
    - [`fd_progcache_txn_cancel`](<fd_progcache_admin.c.md#fd_progcache_txn_cancel>)


---
### test\_env\_txn\_publish<!-- {{#callable:test_env_txn_publish}} -->
[View Source →](<../../../../../src/flamenco/progcache/test_progcache.c#L108>)

Publishes a subtree of in-prep transactions with a specified root `xid` in both the account database and program cache.
- **Inputs**:
    - ``env``: A pointer to a `test_env_t` structure representing the test environment.
    - ``xid``: A constant pointer to an `fd_funk_txn_xid_t` structure representing the root transaction ID of the subtree to publish.
- **Logic and Control Flow**:
    - Calls `fd_accdb_advance_root` to advance the root of the account database with the given `xid`.
    - Calls [`fd_progcache_txn_advance_root`](<fd_progcache_admin.c.md#fd_progcache_txn_advance_root>) to advance the root of the program cache with the given `xid`.
- **Output**: No return value (void function).
- **Functions Called**:
    - [`fd_progcache_txn_advance_root`](<fd_progcache_admin.c.md#fd_progcache_txn_advance_root>)


---
### test\_key<!-- {{#callable:test_key}} -->
[View Source →](<../../../../../src/flamenco/progcache/test_progcache.c#L115>)

Creates a `fd_funk_rec_key_t` structure with its first element set to the given unsigned long integer.
- **Inputs**:
    - `x`: An unsigned long integer used to set the first element of the `fd_funk_rec_key_t` structure.
- **Logic and Control Flow**:
    - Initialize a `fd_funk_rec_key_t` structure named `key` with all elements set to zero.
    - Assign the value of `x` to the first element of the `key.ul` array.
    - Return the `key` structure.
- **Output**: A `fd_funk_rec_key_t` structure with its first element set to the input value `x`.


---
### create\_test\_account<!-- {{#callable:create_test_account}} -->
[View Source →](<../../../../../src/flamenco/progcache/test_progcache.c#L124>)

Creates a test account in the account database with specified parameters.
- **Inputs**:
    - ``env``: A pointer to the `test_env_t` structure, which contains the account database and other environment settings.
    - ``xid``: A constant pointer to `fd_funk_txn_xid_t`, representing the transaction ID for the account creation.
    - ``pubkey_``: A constant pointer to the public key data for the account.
    - ``owner_``: A constant pointer to the owner key data for the account.
    - ``data``: A constant pointer to the data to be associated with the account, or `NULL` if no data is provided.
    - ``data_len``: An unsigned long integer representing the length of the data to be associated with the account.
    - ``executable``: An unsigned char indicating whether the account is executable (non-zero) or not (zero).
- **Logic and Control Flow**:
    - Load the public key and owner key from the provided pointers using `FD_LOAD` macro.
    - Initialize a transaction account using `fd_txn_account_init_from_funk_mutable`, setting the `do_create` flag to 1 to create the account.
    - Check if the initialization was successful using `FD_TEST`.
    - If `data` is not `NULL`, set the account data using `fd_txn_account_set_data`.
    - Set the account's starting lamports to 1 and the starting data length to `data_len`.
    - Set the account's lamports, executable flag, and owner using `fd_txn_account_set_lamports`, `fd_txn_account_set_executable`, and `fd_txn_account_set_owner`, respectively.
    - Finalize the mutable transaction account with `fd_txn_account_mutable_fini`.
- **Output**: No return value; the function operates by modifying the account database through the provided environment.


---
### query\_rec\_exact<!-- {{#callable:query_rec_exact}} -->
[View Source →](<../../../../../src/flamenco/progcache/test_progcache.c#L161>)

Fetches a funk record using a specific transaction ID and record key.
- **Inputs**:
    - `env`: A pointer to the `test_env_t` structure, which contains the environment for the query.
    - `xid`: A constant pointer to the `fd_funk_txn_xid_t` structure, representing the transaction ID.
    - `key`: A constant pointer to the `fd_funk_rec_key_t` structure, representing the record key.
- **Logic and Control Flow**:
    - Copies the transaction ID and record key into a `fd_funk_xid_key_pair_t` structure.
    - Attempts to query the record map using `fd_funk_rec_map_query_try` with the provided environment, transaction ID, and key.
    - If the query returns `FD_MAP_ERR_KEY`, the function returns `NULL`, indicating the record does not exist.
    - If the query returns an error other than `FD_MAP_SUCCESS`, logs a critical error and does not return a value.
    - If the query is successful, retrieves and returns a constant pointer to the record element using `fd_funk_rec_map_query_ele_const`.
- **Output**: A constant pointer to the `fd_funk_rec_t` structure if the record is found, or `NULL` if the record does not exist.


---
### test\_empty<!-- {{#callable:test_empty}} -->
[View Source →](<../../../../../src/flamenco/progcache/test_progcache.c#L180>)

Tests if querying an empty account database and program cache at the root transaction ID fails as expected.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used to allocate and manage resources for the test environment.
- **Logic and Control Flow**:
    - Create a test environment using [`test_env_create`](<#test_env_create>) with the provided workspace `wksp`.
    - Initialize a root transaction ID `xid` using `fd_funk_txn_xid_set_root`.
    - Generate a record key `key` using [`test_key`](<#test_key>) with a value of `1UL`.
    - Set up a `fd_prog_load_env_t` structure `load_env` with features from the test environment and default slot and epoch values.
    - Attempt to pull a record from the program cache using [`fd_progcache_pull`](<fd_progcache_user.c.md#fd_progcache_pull>) with the environment's program cache, account database, root transaction ID, key, and load environment.
    - Verify that the record `rec` is `NULL`, indicating that the query failed as expected for an empty database and cache.
    - Destroy the test environment using [`test_env_destroy`](<#test_env_destroy>).
- **Output**: No return value; the function performs assertions to validate the test conditions.
- **Functions Called**:
    - [`test_env_create`](<#test_env_create>)
    - [`test_key`](<#test_key>)
    - [`fd_progcache_pull`](<fd_progcache_user.c.md#fd_progcache_pull>)
    - [`test_env_destroy`](<#test_env_destroy>)


---
### test\_account\_does\_not\_exist<!-- {{#callable:test_account_does_not_exist}} -->
[View Source →](<../../../../../src/flamenco/progcache/test_progcache.c#L201>)

Tests the behavior when a program account is missing but queried at a fork.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for memory allocation and management.
- **Logic and Control Flow**:
    - Create a test environment using [`test_env_create`](<#test_env_create>) with the provided workspace `wksp`.
    - Initialize a transaction identifier `fork_a` with values `{ .ul = { 1UL, 1UL } }`.
    - Prepare a transaction in the test environment with [`test_env_txn_prepare`](<#test_env_txn_prepare>), using `fork_a` as the transaction ID.
    - Cancel the transaction using [`test_env_txn_cancel`](<#test_env_txn_cancel>) with `fork_a`.
    - Destroy the test environment using [`test_env_destroy`](<#test_env_destroy>).
- **Output**: No output is returned as the function is of type `void` and is used for testing purposes.
- **Functions Called**:
    - [`test_env_create`](<#test_env_create>)
    - [`test_env_txn_prepare`](<#test_env_txn_prepare>)
    - [`test_env_txn_cancel`](<#test_env_txn_cancel>)
    - [`test_env_destroy`](<#test_env_destroy>)


---
### test\_invalid\_owner<!-- {{#callable:test_invalid_owner}} -->
[View Source →](<../../../../../src/flamenco/progcache/test_progcache.c#L215>)

Tests if an account with an invalid owner (not a BPF loader) fails to load from the program cache.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for memory allocation and management.
- **Logic and Control Flow**:
    - Create a test environment using [`test_env_create`](<#test_env_create>) with the provided workspace `wksp`.
    - Initialize a transaction with ID `fork_a` using [`test_env_txn_prepare`](<#test_env_txn_prepare>).
    - Generate a record key using [`test_key`](<#test_key>) with a value of `1UL`.
    - Create a test account with the generated key and an invalid owner using [`create_test_account`](<#create_test_account>).
    - Set up a `fd_prog_load_env_t` structure with specific features, slot, epoch, and epoch_slot0 values.
    - Attempt to pull the program from the cache using [`fd_progcache_pull`](<fd_progcache_user.c.md#fd_progcache_pull>) and verify that it fails (returns false).
    - Cancel the transaction using [`test_env_txn_cancel`](<#test_env_txn_cancel>).
    - Destroy the test environment using [`test_env_destroy`](<#test_env_destroy>).
- **Output**: No return value; the function performs tests and assertions internally.
- **Functions Called**:
    - [`test_env_create`](<#test_env_create>)
    - [`test_env_txn_prepare`](<#test_env_txn_prepare>)
    - [`test_key`](<#test_key>)
    - [`create_test_account`](<#create_test_account>)
    - [`fd_progcache_pull`](<fd_progcache_user.c.md#fd_progcache_pull>)
    - [`test_env_txn_cancel`](<#test_env_txn_cancel>)
    - [`test_env_destroy`](<#test_env_destroy>)


---
### test\_invalid\_program<!-- {{#callable:test_invalid_program}} -->
[View Source →](<../../../../../src/flamenco/progcache/test_progcache.c#L242>)

Tests the behavior of the program cache when attempting to load an invalid program account.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for memory allocation and management.
- **Logic and Control Flow**:
    - Create a test environment using [`test_env_create`](<#test_env_create>) with the provided workspace `wksp`.
    - Initialize a transaction with a specific transaction ID `fork_a` using [`test_env_txn_prepare`](<#test_env_txn_prepare>).
    - Generate a key using [`test_key`](<#test_key>) and create a test account with invalid program data using [`create_test_account`](<#create_test_account>).
    - Verify that the program cache does not contain the invalid program using [`fd_progcache_peek`](<fd_progcache_user.c.md#fd_progcache_peek>).
    - Check the depth of the program cache fork and validate the transaction IDs using `fd_funk_txn_xid_eq`.
    - Set up a program load environment `load_env` and attempt to pull the program from the cache using [`fd_progcache_pull`](<fd_progcache_user.c.md#fd_progcache_pull>).
    - Verify that the pulled record exists but is not executable.
    - Ensure the program cache contains the pulled record using [`fd_progcache_peek`](<fd_progcache_user.c.md#fd_progcache_peek>).
    - Cancel the transaction using [`test_env_txn_cancel`](<#test_env_txn_cancel>) and destroy the test environment using [`test_env_destroy`](<#test_env_destroy>).
- **Output**: No output is returned as the function is void, but it performs several assertions to validate the behavior of the program cache with invalid program data.
- **Functions Called**:
    - [`test_env_create`](<#test_env_create>)
    - [`test_env_txn_prepare`](<#test_env_txn_prepare>)
    - [`test_key`](<#test_key>)
    - [`create_test_account`](<#create_test_account>)
    - [`fd_progcache_peek`](<fd_progcache_user.c.md#fd_progcache_peek>)
    - [`fd_progcache_pull`](<fd_progcache_user.c.md#fd_progcache_pull>)
    - [`test_env_txn_cancel`](<#test_env_txn_cancel>)
    - [`test_env_destroy`](<#test_env_destroy>)


---
### test\_valid\_program<!-- {{#callable:test_valid_program}} -->
[View Source →](<../../../../../src/flamenco/progcache/test_progcache.c#L277>)

Tests the loading and validation of a valid program account in a transactional environment.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for memory allocation and management.
- **Logic and Control Flow**:
    - Create a test environment using [`test_env_create`](<#test_env_create>) with the provided workspace `wksp`.
    - Initialize a transaction `fork_a` with ID `{ .ul = { 1UL, 1UL } }` and prepare it using [`test_env_txn_prepare`](<#test_env_txn_prepare>).
    - Generate a key using [`test_key`](<#test_key>) with the value `1UL`.
    - Create a test account with the generated key and valid program data using [`create_test_account`](<#create_test_account>).
    - Verify that the program cache does not initially contain the program using [`fd_progcache_peek`](<fd_progcache_user.c.md#fd_progcache_peek>).
    - Check that the program cache's fork depth is `2UL` and validate the transaction IDs using `fd_funk_txn_xid_eq`.
    - Set up a `fd_prog_load_env_t` structure for loading the program with specific slot and epoch values.
    - Pull the program from the cache using [`fd_progcache_pull`](<fd_progcache_user.c.md#fd_progcache_pull>) and verify its existence and executability.
    - Prepare a new transaction `fork_b` with ID `{ .ul = { 64UL, 2UL } }` and verify the cache state with [`fd_progcache_peek`](<fd_progcache_user.c.md#fd_progcache_peek>).
    - Update the load environment and pull the program again to verify consistency.
    - Cancel the transaction `fork_a`, which should also cancel `fork_b`, and destroy the test environment using [`test_env_destroy`](<#test_env_destroy>).
- **Output**: No output is returned as the function is of type `void` and is used for testing purposes.
- **Functions Called**:
    - [`test_env_create`](<#test_env_create>)
    - [`test_env_txn_prepare`](<#test_env_txn_prepare>)
    - [`test_key`](<#test_key>)
    - [`create_test_account`](<#create_test_account>)
    - [`fd_progcache_peek`](<fd_progcache_user.c.md#fd_progcache_peek>)
    - [`fd_progcache_pull`](<fd_progcache_user.c.md#fd_progcache_pull>)
    - [`test_env_txn_cancel`](<#test_env_txn_cancel>)
    - [`test_env_destroy`](<#test_env_destroy>)


---
### test\_epoch\_boundary<!-- {{#callable:test_epoch_boundary}} -->
[View Source →](<../../../../../src/flamenco/progcache/test_progcache.c#L326>)

Ensures that a valid program is re-verified after an epoch boundary in a test environment.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used to allocate and manage resources for the test environment.
- **Logic and Control Flow**:
    - Create a test environment using [`test_env_create`](<#test_env_create>) with the provided workspace `wksp`.
    - Initialize a transaction `fork_a` and prepare it using [`test_env_txn_prepare`](<#test_env_txn_prepare>).
    - Generate a key using [`test_key`](<#test_key>) and create a test account with [`create_test_account`](<#create_test_account>) using `fork_a` and the generated key.
    - Verify that the program cache does not initially contain the key using [`fd_progcache_peek`](<fd_progcache_user.c.md#fd_progcache_peek>).
    - Check the fork depth and transaction IDs in the program cache to ensure they match expectations.
    - Set up a `fd_prog_load_env_t` structure with initial slot and epoch values, and pull a program cache record using [`fd_progcache_pull`](<fd_progcache_user.c.md#fd_progcache_pull>).
    - Verify that the pulled record is executable and matches the expected record in the cache.
    - Prepare a new transaction `fork_b` and update the load environment to reflect a new epoch boundary.
    - Pull a new program cache record for `fork_b` and verify that it is different from the previous record and is executable.
    - Cancel the transactions `fork_b` and `fork_a` using [`test_env_txn_cancel`](<#test_env_txn_cancel>).
    - Destroy the test environment using [`test_env_destroy`](<#test_env_destroy>).
- **Output**: No return value; the function performs tests and assertions to validate program cache behavior across epoch boundaries.
- **Functions Called**:
    - [`test_env_create`](<#test_env_create>)
    - [`test_env_txn_prepare`](<#test_env_txn_prepare>)
    - [`test_key`](<#test_key>)
    - [`create_test_account`](<#create_test_account>)
    - [`fd_progcache_peek`](<fd_progcache_user.c.md#fd_progcache_peek>)
    - [`fd_progcache_pull`](<fd_progcache_user.c.md#fd_progcache_pull>)
    - [`test_env_txn_cancel`](<#test_env_txn_cancel>)
    - [`test_env_destroy`](<#test_env_destroy>)


---
### test\_invalidate<!-- {{#callable:test_invalidate}} -->
[View Source →](<../../../../../src/flamenco/progcache/test_progcache.c#L374>)

Tests the invalidation of a program cache entry and verifies the behavior of the cache before and after invalidation.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for memory allocation and management.
- **Logic and Control Flow**:
    - Create a test environment using [`test_env_create`](<#test_env_create>) with the given workspace `wksp`.
    - Prepare a transaction `fork_a` with ID `{1UL, 1UL}` using [`test_env_txn_prepare`](<#test_env_txn_prepare>).
    - Generate a key using [`test_key`](<#test_key>) with value `1UL`.
    - Create a test account with the generated key and valid program data using [`create_test_account`](<#create_test_account>).
    - Initialize a `fd_prog_load_env_t` structure with specific slot and epoch values.
    - Pull a program cache record using [`fd_progcache_pull`](<fd_progcache_user.c.md#fd_progcache_pull>) and verify its existence and executability.
    - Prepare a second transaction `fork_b` with ID `{2UL, 1UL}` and invalidate the cache entry using [`fd_progcache_invalidate`](<fd_progcache_user.c.md#fd_progcache_invalidate>).
    - Verify that the invalidated record is different from the original and is not executable.
    - Check that the cache entries for both `fork_a` and `fork_b` are as expected using [`fd_progcache_peek`](<fd_progcache_user.c.md#fd_progcache_peek>).
    - Cancel the transaction `fork_a` and destroy the test environment using [`test_env_destroy`](<#test_env_destroy>).
- **Output**: No return value; the function performs tests and assertions to validate cache invalidation behavior.
- **Functions Called**:
    - [`test_env_create`](<#test_env_create>)
    - [`test_env_txn_prepare`](<#test_env_txn_prepare>)
    - [`test_key`](<#test_key>)
    - [`create_test_account`](<#create_test_account>)
    - [`fd_progcache_pull`](<fd_progcache_user.c.md#fd_progcache_pull>)
    - [`fd_progcache_peek`](<fd_progcache_user.c.md#fd_progcache_peek>)
    - [`fd_progcache_invalidate`](<fd_progcache_user.c.md#fd_progcache_invalidate>)
    - [`test_env_txn_cancel`](<#test_env_txn_cancel>)
    - [`test_env_destroy`](<#test_env_destroy>)


---
### test\_invalidate\_nonexistent<!-- {{#callable:test_invalidate_nonexistent}} -->
[View Source →](<../../../../../src/flamenco/progcache/test_progcache.c#L415>)

Tests the invalidation of a non-existent cache entry in a program cache.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for memory allocation and management.
- **Logic and Control Flow**:
    - Create a test environment using [`test_env_create`](<#test_env_create>) with the given workspace `wksp`.
    - Initialize a transaction identifier `fork_a` with specific values.
    - Prepare a transaction in the test environment using [`test_env_txn_prepare`](<#test_env_txn_prepare>) with `fork_a`.
    - Generate a record key using [`test_key`](<#test_key>) with a specific value.
    - Call [`fd_progcache_invalidate`](<fd_progcache_user.c.md#fd_progcache_invalidate>) to invalidate a cache entry in the program cache with the generated key and transaction identifier `fork_a`.
    - Verify that the returned record is not executable using `FD_TEST`.
    - Cancel the prepared transaction using [`test_env_txn_cancel`](<#test_env_txn_cancel>).
    - Destroy the test environment using [`test_env_destroy`](<#test_env_destroy>).
- **Output**: A pointer to a `fd_progcache_rec_t` structure representing the invalidated cache entry, which is not executable.
- **Functions Called**:
    - [`test_env_create`](<#test_env_create>)
    - [`test_env_txn_prepare`](<#test_env_txn_prepare>)
    - [`test_key`](<#test_key>)
    - [`fd_progcache_invalidate`](<fd_progcache_user.c.md#fd_progcache_invalidate>)
    - [`test_env_txn_cancel`](<#test_env_txn_cancel>)
    - [`test_env_destroy`](<#test_env_destroy>)


---
### test\_invalidate\_pull<!-- {{#callable:test_invalidate_pull}} -->
[View Source →](<../../../../../src/flamenco/progcache/test_progcache.c#L433>)

Tests the ability of [`fd_progcache_pull`](<fd_progcache_user.c.md#fd_progcache_pull>) to recover from a previous [`fd_progcache_invalidate`](<fd_progcache_user.c.md#fd_progcache_invalidate>) call by creating new cache entries in future slots.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for memory allocation and management.
- **Logic and Control Flow**:
    - Create a test environment using [`test_env_create`](<#test_env_create>) with the given workspace `wksp`.
    - Prepare a transaction `fork_a` and create a test account with a valid program using [`create_test_account`](<#create_test_account>).
    - Create an initial cache entry by calling [`fd_progcache_pull`](<fd_progcache_user.c.md#fd_progcache_pull>) with `fork_a` and verify its properties.
    - Prepare a new transaction `fork_b`, invalidate the cache entry using [`fd_progcache_invalidate`](<fd_progcache_user.c.md#fd_progcache_invalidate>), and verify the invalidation.
    - Prepare another transaction `fork_c`, call [`fd_progcache_pull`](<fd_progcache_user.c.md#fd_progcache_pull>) to create a new cache entry, and verify its properties.
    - Cancel the transaction `fork_a` and destroy the test environment.
- **Output**: No return value; the function performs tests and uses assertions to verify behavior.
- **Functions Called**:
    - [`test_env_create`](<#test_env_create>)
    - [`test_env_txn_prepare`](<#test_env_txn_prepare>)
    - [`test_key`](<#test_key>)
    - [`create_test_account`](<#create_test_account>)
    - [`fd_progcache_pull`](<fd_progcache_user.c.md#fd_progcache_pull>)
    - [`fd_progcache_peek`](<fd_progcache_user.c.md#fd_progcache_peek>)
    - [`fd_progcache_invalidate`](<fd_progcache_user.c.md#fd_progcache_invalidate>)
    - [`test_env_txn_cancel`](<#test_env_txn_cancel>)
    - [`test_env_destroy`](<#test_env_destroy>)


---
### test\_invalidate\_dup<!-- {{#callable:test_invalidate_dup}} -->
[View Source →](<../../../../../src/flamenco/progcache/test_progcache.c#L488>)

Creates and invalidates cache entries in a program cache to test cache invalidation logic.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used to allocate and manage resources.
- **Logic and Control Flow**:
    - Create a test environment using [`test_env_create`](<#test_env_create>) with the given workspace `wksp`.
    - Prepare a transaction `fork_a` and create a test account with a specific key and valid program data.
    - Create an initial cache entry by pulling from the program cache using [`fd_progcache_pull`](<fd_progcache_user.c.md#fd_progcache_pull>) and verify its properties.
    - Prepare a new transaction `fork_b`, invalidate the cache entry using [`fd_progcache_invalidate`](<fd_progcache_user.c.md#fd_progcache_invalidate>), and verify the invalidation.
    - Prepare another transaction `fork_c`, invalidate the cache entry again, and verify the new invalidation entry.
    - Cancel the transaction `fork_a` and destroy the test environment using [`test_env_destroy`](<#test_env_destroy>).
- **Output**: No return value; the function performs tests and assertions to validate cache invalidation behavior.
- **Functions Called**:
    - [`test_env_create`](<#test_env_create>)
    - [`test_env_txn_prepare`](<#test_env_txn_prepare>)
    - [`test_key`](<#test_key>)
    - [`create_test_account`](<#create_test_account>)
    - [`fd_progcache_pull`](<fd_progcache_user.c.md#fd_progcache_pull>)
    - [`fd_progcache_peek`](<fd_progcache_user.c.md#fd_progcache_peek>)
    - [`fd_progcache_invalidate`](<fd_progcache_user.c.md#fd_progcache_invalidate>)
    - [`test_env_txn_cancel`](<#test_env_txn_cancel>)
    - [`test_env_destroy`](<#test_env_destroy>)


---
### test\_invalidate\_epoch\_boundary<!-- {{#callable:test_invalidate_epoch_boundary}} -->
[View Source →](<../../../../../src/flamenco/progcache/test_progcache.c#L539>)

Tests the invalidation of a program cache entry at an epoch boundary and ensures that a new cache entry is created after invalidation.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for memory allocation and management.
- **Logic and Control Flow**:
    - Create a test environment using [`test_env_create`](<#test_env_create>) with the provided workspace `wksp`.
    - Initialize a transaction `fork_a` and prepare it using [`test_env_txn_prepare`](<#test_env_txn_prepare>).
    - Generate a key using [`test_key`](<#test_key>) and create a test account with [`create_test_account`](<#create_test_account>).
    - Verify that the program cache does not contain the key initially using [`fd_progcache_peek`](<fd_progcache_user.c.md#fd_progcache_peek>).
    - Check the fork depth and transaction IDs in the program cache.
    - Set up a `fd_prog_load_env_t` structure and pull a program cache record using [`fd_progcache_pull`](<fd_progcache_user.c.md#fd_progcache_pull>).
    - Verify the record is executable and matches the expected cache entry.
    - Prepare a new transaction `fork_b` and update the load environment for a new epoch.
    - Invalidate the program cache entry using [`fd_progcache_invalidate`](<fd_progcache_user.c.md#fd_progcache_invalidate>) and verify the new entry is different from the previous one.
    - Cancel the transactions `fork_b` and `fork_a` using [`test_env_txn_cancel`](<#test_env_txn_cancel>).
    - Destroy the test environment using [`test_env_destroy`](<#test_env_destroy>).
- **Output**: No return value; the function performs tests and assertions to validate program cache behavior.
- **Functions Called**:
    - [`test_env_create`](<#test_env_create>)
    - [`test_env_txn_prepare`](<#test_env_txn_prepare>)
    - [`test_key`](<#test_key>)
    - [`create_test_account`](<#create_test_account>)
    - [`fd_progcache_peek`](<fd_progcache_user.c.md#fd_progcache_peek>)
    - [`fd_progcache_pull`](<fd_progcache_user.c.md#fd_progcache_pull>)
    - [`fd_progcache_invalidate`](<fd_progcache_user.c.md#fd_progcache_invalidate>)
    - [`test_env_txn_cancel`](<#test_env_txn_cancel>)
    - [`test_env_destroy`](<#test_env_destroy>)


---
### test\_publish\_gc<!-- {{#callable:test_publish_gc}} -->
[View Source →](<../../../../../src/flamenco/progcache/test_progcache.c#L585>)

Tests the garbage collection of stale entries in a program cache by publishing transactions and verifying the state of records.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for memory allocation and management.
- **Logic and Control Flow**:
    - Create a test environment using [`test_env_create`](<#test_env_create>) with the provided workspace.
    - Prepare a transaction `fork_a` and create a test account with a specific key and valid program data.
    - Pull a program cache record `rec_a` for `fork_a` and verify its executability.
    - Prepare a new transaction `fork_b`, invalidate the cache for this transaction, and verify the invalidation.
    - Prepare another transaction `fork_c`, pull a new cache record `rec_c`, and verify its executability.
    - Check that the cache records for `fork_a`, `fork_b`, and `fork_c` are correctly stored in the program cache.
    - Query exact records for `fork_a`, `fork_b`, and `fork_c` and verify they are distinct.
    - Publish transactions `fork_a`, `fork_b`, and `fork_c` sequentially, verifying that records are correctly moved to the root and that previous records are nullified.
    - Verify that only the record for `fork_c` remains in the funk record map after garbage collection.
    - Destroy the test environment using [`test_env_destroy`](<#test_env_destroy>).
- **Output**: No output is returned; the function performs tests and assertions to verify the correctness of the program cache's garbage collection.
- **Functions Called**:
    - [`test_env_create`](<#test_env_create>)
    - [`test_env_txn_prepare`](<#test_env_txn_prepare>)
    - [`test_key`](<#test_key>)
    - [`create_test_account`](<#create_test_account>)
    - [`fd_progcache_pull`](<fd_progcache_user.c.md#fd_progcache_pull>)
    - [`fd_progcache_invalidate`](<fd_progcache_user.c.md#fd_progcache_invalidate>)
    - [`fd_progcache_peek`](<fd_progcache_user.c.md#fd_progcache_peek>)
    - [`query_rec_exact`](<#query_rec_exact>)
    - [`test_env_txn_publish`](<#test_env_txn_publish>)
    - [`test_env_destroy`](<#test_env_destroy>)


---
### test\_publish\_trivial<!-- {{#callable:test_publish_trivial}} -->
[View Source →](<../../../../../src/flamenco/progcache/test_progcache.c#L660>)

Executes a sequence of prepare and publish operations on a program cache using a workspace.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` structure representing the workspace to use for the operations.
- **Logic and Control Flow**:
    - Create a test environment using [`test_env_create`](<#test_env_create>) with the provided workspace `wksp`.
    - Initialize a root transaction ID using `fd_funk_txn_xid_set_root`.
    - Define a child transaction ID `fork_368528500` with specific values.
    - Attach the child transaction `fork_368528500` to the root transaction using [`fd_progcache_txn_attach_child`](<fd_progcache_admin.c.md#fd_progcache_txn_attach_child>).
    - Advance the root transaction to the child transaction `fork_368528500` using [`fd_progcache_txn_advance_root`](<fd_progcache_admin.c.md#fd_progcache_txn_advance_root>).
    - Note: The function contains a placeholder comment indicating that more operations may be added.
- **Output**: No return value; the function performs operations on the program cache and modifies the state of the workspace.
- **Functions Called**:
    - [`test_env_create`](<#test_env_create>)
    - [`fd_progcache_txn_attach_child`](<fd_progcache_admin.c.md#fd_progcache_txn_attach_child>)
    - [`fd_progcache_txn_advance_root`](<fd_progcache_admin.c.md#fd_progcache_txn_advance_root>)


---
### test\_root\_nonroot\_prio<!-- {{#callable:test_root_nonroot_prio}} -->
[View Source →](<../../../../../src/flamenco/progcache/test_progcache.c#L678>)

Tests the priority of non-rooted records over rooted records in a transaction environment.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for memory allocation and management.
- **Logic and Control Flow**:
    - Create a test environment using [`test_env_create`](<#test_env_create>) with the given workspace `wksp`.
    - Initialize four transaction identifiers (`fork_1`, `fork_2`, `fork_3`, `fork_4`) with specific values to represent different transaction states.
    - Prepare a transaction with `fork_1` and create a test account associated with it using [`create_test_account`](<#create_test_account>).
    - Publish the transaction associated with `fork_1` using [`test_env_txn_publish`](<#test_env_txn_publish>).
    - Prepare transactions for `fork_2` and `fork_3`, and redeploy the account in `fork_3`.
    - Invalidate the program cache for `fork_3` using [`fd_progcache_invalidate`](<fd_progcache_user.c.md#fd_progcache_invalidate>).
    - Prepare a transaction for `fork_4`.
    - Pull records from the program cache for `fork_1` and `fork_4` using [`fd_progcache_pull`](<fd_progcache_user.c.md#fd_progcache_pull>) and verify their slots.
    - Cancel the transactions associated with `fork_4` and `fork_3` using [`test_env_txn_cancel`](<#test_env_txn_cancel>).
    - Destroy the test environment using [`test_env_destroy`](<#test_env_destroy>).
- **Output**: No return value; the function performs tests and assertions to verify the behavior of the system.
- **Functions Called**:
    - [`test_env_create`](<#test_env_create>)
    - [`test_env_txn_prepare`](<#test_env_txn_prepare>)
    - [`test_key`](<#test_key>)
    - [`create_test_account`](<#create_test_account>)
    - [`test_env_txn_publish`](<#test_env_txn_publish>)
    - [`fd_progcache_invalidate`](<fd_progcache_user.c.md#fd_progcache_invalidate>)
    - [`fd_progcache_pull`](<fd_progcache_user.c.md#fd_progcache_pull>)
    - [`test_env_txn_cancel`](<#test_env_txn_cancel>)
    - [`test_env_destroy`](<#test_env_destroy>)


---
### match\_test\_name<!-- {{#callable:match_test_name}} -->
[View Source →](<../../../../../src/flamenco/progcache/test_progcache.c#L737>)

Checks if a given test name matches any of the command-line arguments.
- **Inputs**:
    - ``test_name``: A constant character pointer representing the name of the test to match.
    - ``argc``: An integer representing the number of command-line arguments.
    - ``argv``: An array of character pointers representing the command-line arguments.
- **Logic and Control Flow**:
    - If `argc` is less than or equal to 1, return 1, indicating a match by default.
    - Iterate over the command-line arguments starting from index 1.
    - For each argument, check if it is a substring of `test_name` using `strstr`.
    - If a match is found, return 1.
    - If no matches are found after checking all arguments, return 0.
- **Output**: Returns 1 if `test_name` matches any of the command-line arguments, otherwise returns 0.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/flamenco/progcache/test_progcache.c#L748>)

Initializes the environment, parses command-line arguments, creates a workspace, and runs specified test cases.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Determines the CPU index using `fd_tile_cpu_id` and `fd_tile_idx`, and adjusts it if necessary.
    - Parses command-line arguments for `--page-sz`, `--page-cnt`, and `--numa-idx` using `fd_env_strip_cmdline_cstr` and `fd_env_strip_cmdline_ulong`.
    - Converts the page size string to an unsigned long using `fd_cstr_to_shmem_page_sz` and logs an error if the page size is unsupported.
    - Logs the creation of a workspace with the specified parameters and creates it using `fd_wksp_new_anonymous`.
    - Defines an array of test cases, each with a name and a function pointer.
    - Iterates over the test cases, running those that match the command-line arguments using [`match_test_name`](<#match_test_name>).
    - Deletes the workspace using `fd_wksp_delete_anonymous` after running the tests.
    - Logs a 'pass' message and calls `fd_halt` to terminate the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`match_test_name`](<#match_test_name>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)