<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for loading executable program content from different loader versions and managing program versions.

# Purpose
The code is a C source file that provides functionality for loading executable program content from different versions of program loaders. It includes functions to retrieve program data for various loader versions, specifically v1/v2, v3, and v4. The functions [`fd_get_executable_program_content_for_v4_loader`](<#fd_get_executable_program_content_for_v4_loader>), [`fd_get_executable_program_content_for_upgradeable_loader`](<#fd_get_executable_program_content_for_upgradeable_loader>), and [`fd_get_executable_program_content_for_v1_v2_loaders`](<#fd_get_executable_program_content_for_v1_v2_loaders>) are responsible for accessing and returning the program data from the respective loader versions. Each function handles the specific data structure and state checks required for its loader version, ensuring that the program data is correctly retrieved or returning `NULL` if retrieval fails due to issues like incorrect program state or insufficient data size.

The file also defines the [`fd_prog_load_elf`](<#fd_prog_load_elf>) function, which determines the appropriate loader version and retrieves the executable program content accordingly. It uses the program account's owner to identify the loader version and calls the corresponding function to get the program data. Additionally, the file includes the [`fd_prog_versions`](<#fd_prog_versions_tfd_prog_versions>) function, which determines the supported SBPF (Solana BPF) versions based on the active features and slot information. The [`fd_prog_load_env_from_bank`](<#fd_prog_load_env_from_bank>) function initializes a program load environment structure with data queried from a bank, such as features, slot, and epoch information. This code is intended to be part of a larger system that manages program loading and execution in a blockchain or similar environment.
# Imports and Dependencies

---
- `fd_prog_load.h`
- `../runtime/program/fd_bpf_loader_program.h`
- `../runtime/program/fd_loader_v4_program.h`
- `../runtime/sysvar/fd_sysvar_epoch_schedule.h`


# Functions

---
### fd\_get\_executable\_program\_content\_for\_v4\_loader<!-- {{#callable:fd_get_executable_program_content_for_v4_loader}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_prog_load.c#L13>)

Retrieves the executable program content from a v4 loader program account if it is not retracted.
- **Inputs**:
    - ``program_acc``: A pointer to a `fd_txn_account_t` structure representing the program account.
    - ``program_data_len``: A pointer to an `ulong` where the function will store the length of the program data.
- **Logic and Control Flow**:
    - Call `fd_loader_v4_get_state` with `program_acc` to get the current loader v4 state and check for errors.
    - If an error occurs, return `NULL`.
    - Check if the program state is retracted using `fd_loader_v4_status_is_retracted`; if it is, return `NULL`.
    - Calculate the program data length by subtracting `LOADER_V4_PROGRAM_DATA_OFFSET` from the total data length obtained from `fd_txn_account_get_data_len`.
    - Return a pointer to the program data, offset by `LOADER_V4_PROGRAM_DATA_OFFSET`.
- **Output**: A pointer to the executable program data on success, or `NULL` on failure.


---
### fd\_get\_executable\_program\_content\_for\_upgradeable\_loader<!-- {{#callable:fd_get_executable_program_content_for_upgradeable_loader}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_prog_load.c#L42>)

Retrieves the executable program content for a v3 loader by decoding the program account and its associated programdata account.
- **Inputs**:
    - ``funk``: A pointer to an `fd_funk_t` structure representing the database context.
    - ``xid``: A pointer to an `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``program_acc``: A pointer to an `fd_txn_account_t` structure representing the program account.
    - ``program_data_len``: A pointer to an `ulong` where the function will store the length of the program data.
    - ``out_xid``: A pointer to an `fd_funk_txn_xid_t` where the function will store the output transaction ID.
- **Logic and Control Flow**:
    - Decode the program account data into `program_account_state` using `fd_bincode_decode_static` and return `NULL` if decoding fails.
    - Check if the decoded state is a program using `fd_bpf_upgradeable_loader_state_is_program` and return `NULL` if it is not.
    - Retrieve the programdata address from `program_account_state`.
    - Get the account metadata for the programdata address using `fd_funk_get_acc_meta_readonly` and return `NULL` if it fails.
    - Create a new transaction account for the programdata using `fd_txn_account_new` and `fd_txn_account_join`, logging a critical error if it fails.
    - Initialize a decode context `ctx_programdata` for the programdata account data.
    - Check the footprint of the programdata using `fd_bpf_upgradeable_loader_state_decode_footprint` and return `NULL` if it fails.
    - Verify that the programdata account data length is sufficient and return `NULL` if it is less than `PROGRAMDATA_METADATA_SIZE`.
    - Calculate the program data length by subtracting `PROGRAMDATA_METADATA_SIZE` from the programdata account data length.
    - Return a pointer to the programdata, offset by `PROGRAMDATA_METADATA_SIZE`.
- **Output**: A pointer to the executable program data on success, or `NULL` on failure.


---
### fd\_get\_executable\_program\_content\_for\_v1\_v2\_loaders<!-- {{#callable:fd_get_executable_program_content_for_v1_v2_loaders}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_prog_load.c#L96>)

Returns a pointer to the program data for v1/v2 loader-owned accounts and sets the program data length.
- **Inputs**:
    - `program_acc`: A pointer to a `fd_txn_account_t` structure representing the program account.
    - `program_data_len`: A pointer to an `ulong` where the function will store the length of the program data.
- **Logic and Control Flow**:
    - Set `*program_data_len` to the length of the data in `program_acc` using `fd_txn_account_get_data_len` function.
    - Return a pointer to the data in `program_acc` using `fd_txn_account_get_data` function.
- **Output**: A pointer to the program data in the account specified by `program_acc`.


---
### fd\_prog\_load\_elf<!-- {{#callable:fd_prog_load_elf}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_prog_load.c#L103>)

Loads the executable program content from an ELF file based on the loader version and account metadata.
- **Inputs**:
    - `accdb`: A pointer to the `fd_funk_t` structure representing the account database.
    - `xid`: A pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID.
    - `_prog_addr`: A pointer to the program address data.
    - `out_sz`: A pointer to an `ulong` where the size of the program data will be stored.
    - `out_xid`: A pointer to an `fd_funk_txn_xid_t` structure where the output transaction ID will be stored.
- **Logic and Control Flow**:
    - Load the program address from `_prog_addr` into `prog_addr`.
    - Check if `out_xid` is NULL and assign a local variable `_out_xid` if necessary.
    - Retrieve account metadata using `fd_funk_get_acc_meta_readonly` with the provided `accdb`, `xid`, and `prog_addr`.
    - If metadata retrieval fails, return NULL.
    - Create a transaction account record using `fd_txn_account_new` and join it to the workspace using `fd_txn_account_join`.
    - Determine the owner of the transaction account using `fd_txn_account_get_owner`.
    - Based on the owner, call the appropriate function to get the executable program content for the loader version (v1/v2, v3, or v4).
    - If the executable program content is not found, set the root transaction ID using `fd_funk_txn_xid_set_root`.
    - Return the pointer to the ELF program content.
- **Output**: A pointer to the ELF program content on success, or NULL on failure.
- **Functions Called**:
    - [`fd_get_executable_program_content_for_upgradeable_loader`](<#fd_get_executable_program_content_for_upgradeable_loader>)
    - [`fd_get_executable_program_content_for_v4_loader`](<#fd_get_executable_program_content_for_v4_loader>)
    - [`fd_get_executable_program_content_for_v1_v2_loaders`](<#fd_get_executable_program_content_for_v1_v2_loaders>)


---
### fd\_prog\_versions<!-- {{#callable:fd_prog_versions_t::fd_prog_versions}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_prog_load.c#L147>)

Determines the minimum and maximum supported sBPF versions based on feature flags for a given slot.
- **Inputs**:
    - ``features``: A pointer to `fd_features_t`, which contains feature flags that determine the activation status of various sBPF versions.
    - ``slot``: An unsigned long integer representing the slot number for which the sBPF version support is being determined.
- **Logic and Control Flow**:
    - Check if `disable_sbpf_v0_execution` is active for the given slot and feature set.
    - Check if `reenable_sbpf_v0_execution` is active for the given slot and feature set.
    - Determine if sBPF version 0 is enabled based on the status of `disable_v0` and `reenable_v0`.
    - Check if `enable_sbpf_v1_deployment_and_execution` is active for the given slot and feature set.
    - Check if `enable_sbpf_v2_deployment_and_execution` is active for the given slot and feature set.
    - Check if `enable_sbpf_v3_deployment_and_execution` is active for the given slot and feature set.
    - Initialize `fd_prog_versions_t` structure with default values.
    - Set `min_sbpf_version` to `FD_SBPF_V0` if version 0 is enabled, otherwise set it to `FD_SBPF_V3`.
    - Set `max_sbpf_version` to the highest enabled version, checking in order from version 3 to version 0.
- **Output**: Returns an `fd_prog_versions_t` structure containing the minimum and maximum supported sBPF versions for the specified slot.
- **See also**: [`fd_prog_versions_t`](<fd_prog_load.h.md#fd_prog_versions_t>)  (Data Structure)


---
### fd\_prog\_load\_env\_from\_bank<!-- {{#callable:fd_prog_load_env_from_bank}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_prog_load.c#L172>)

Initializes an `fd_prog_load_env_t` structure with data from a given `fd_bank_t`.
- **Inputs**:
    - `env`: A pointer to an `fd_prog_load_env_t` structure to be initialized.
    - `bank`: A constant pointer to an `fd_bank_t` structure from which data is retrieved.
- **Logic and Control Flow**:
    - Retrieve features from the bank using `fd_bank_features_query` and assign to `env->features`.
    - Retrieve the slot from the bank using `fd_bank_slot_get` and assign to `env->slot`.
    - Retrieve the epoch from the bank using `fd_bank_epoch_get` and assign to `env->epoch`.
    - Retrieve the epoch schedule from the bank using `fd_bank_epoch_schedule_query`, then calculate `epoch_slot0` using `fd_epoch_slot0` and assign to `env->epoch_slot0`.
- **Output**: Returns a pointer to the initialized `fd_prog_load_env_t` structure.



---
Made with ❤️ by [Driver](https://www.driver.ai/)