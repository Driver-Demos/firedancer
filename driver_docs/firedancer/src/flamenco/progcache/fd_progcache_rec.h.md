<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines the structure and functions for managing program cache entries, including executable and non-executable types.

# Purpose
This C header file defines the structure and functions for managing program cache entries in a system that uses the SBPF (Solana Berkeley Packet Filter) framework. The `fd_progcache_rec_t` structure represents the fixed-size header of a program cache entry, which can be either executable or non-executable. The file includes accessor functions to retrieve specific segments of the cache entry, such as read-only data and call destinations. It also provides functions to calculate memory alignment and footprint requirements for these entries, as well as functions to create and delete both executable and non-executable cache entries. The header includes necessary dependencies and uses conditional compilation to prevent multiple inclusions.
# Imports and Dependencies

---
- `../fd_flamenco_base.h`
- `../../ballet/sbpf/fd_sbpf_loader.h`


# Data Structures

---
### fd\_progcache\_rec
- **Type**: ``struct``
- **Members**:
    - `slot`: Slot number at which this cache entry was created.
    - `entry_pc`: Program counter entry point.
    - `text_cnt`: Count of text segments.
    - `text_off`: Offset to the text segment.
    - `text_sz`: Size of the text segment.
    - `rodata_sz`: Size of the read-only data segment.
    - `calldests_off`: Offset to the `sbpf_calldests` map.
    - `rodata_off`: Offset to the read-only data segment.
    - `sbpf_version`: Version of the SBPF (SIMD-0161).
    - `executable`: Indicates if this is an executable entry.
    - `invalidate`: Limits visibility of this entry to this slot if set to 1.
- **Description**: Represents a fixed-size header for a program cache entry, which can be either executable or non-executable. Non-executable entries consist only of this header, while executable entries include additional structures beyond this header, such as read-only data segments and control flow metadata. The structure includes fields for managing program text and read-only data segments, as well as flags for execution status and visibility control.


---
### fd\_progcache\_rec\_t
- **Type**: ``struct``
- **Members**:
    - `slot`: Slot number at which this cache entry was created.
    - `entry_pc`: Program counter entry point.
    - `text_cnt`: Count of text segments.
    - `text_off`: Offset to the text segment.
    - `text_sz`: Size of the text segment.
    - `rodata_sz`: Size of the read-only data segment.
    - `calldests_off`: Offset to the `sbpf_calldests` map.
    - `rodata_off`: Offset to the read-only data segment.
    - `sbpf_version`: Version of the SBPF (SIMD-0161).
    - `executable`: Indicates if this is an executable entry.
    - `invalidate`: Limits visibility of this entry to this slot if set to 1.
- **Description**: Represents the fixed size header of a program cache entry object, which can be either non-executable or executable. Non-executable entries consist only of this header, while executable entries are variable-sized and include additional structures beyond this header, such as read-only data segments and control flow metadata.


# Functions

---
### fd\_progcache\_rec\_rodata<!-- {{#callable:fd_progcache_rec_rodata}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_rec.h#L38>)

Returns a pointer to the read-only data segment of a program cache entry.
- **Inputs**:
    - ``rec``: A pointer to a `fd_progcache_rec_t` structure representing a program cache entry.
- **Logic and Control Flow**:
    - Calculate the address of the read-only data segment by adding the `rodata_off` offset to the base address of the `rec` structure.
    - Cast the calculated address to a `uchar const *` type.
    - Return the calculated address.
- **Output**: A pointer to the read-only data segment (`rodata`) of the program cache entry.


---
### fd\_progcache\_rec\_calldests<!-- {{#callable:fd_progcache_rec_calldests}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_rec.h#L47>)

Retrieves the call destinations map from a program cache record.
- **Inputs**:
    - ``rec``: A pointer to a constant `fd_progcache_rec_t` structure, representing a program cache record.
- **Logic and Control Flow**:
    - Calculate the address of the call destinations map by adding the `calldests_off` offset to the base address of the `rec` structure.
    - Cast the calculated address to a `void *` pointer.
    - Call the `fd_sbpf_calldests_join` function with the casted pointer to obtain the call destinations map.
- **Output**: A pointer to a constant `fd_sbpf_calldests_t` structure, representing the call destinations map.


---
### fd\_progcache\_rec\_align<!-- {{#callable:fd_progcache_rec_align}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_rec.h#L58>)

Returns the alignment requirement of the `fd_progcache_rec_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls the `alignof` operator on the `fd_progcache_rec_t` type to determine its alignment requirement.
    - Returns the alignment value as an unsigned long integer.
- **Output**: The alignment requirement of the `fd_progcache_rec_t` structure as an unsigned long integer.


---
### fd\_progcache\_rec\_footprint<!-- {{#callable:fd_progcache_rec_footprint}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_rec.h#L63>)

Calculates the memory footprint required for a program cache record based on ELF information.
- **Inputs**:
    - `elf_info`: A pointer to `fd_sbpf_elf_info_t` structure containing ELF information; if NULL, the function assumes a non-executable entry.
- **Logic and Control Flow**:
    - Check if `elf_info` is NULL; if true, return the size of `fd_progcache_rec_t` for a non-executable entry.
    - Determine if call destinations are present by checking the SBPF version in `elf_info`.
    - Calculate the maximum program counter (`pc_max`) using `fd_ulong_max` with 1 and `elf_info->text_cnt`.
    - Initialize layout `l` with `FD_LAYOUT_INIT`.
    - Append the size and alignment of `fd_progcache_rec_t` to `l`.
    - If call destinations are present, append their alignment and footprint to `l`.
    - Append the binary size from `elf_info->bin_sz` to `l` with an alignment of 8 bytes.
    - Finalize and return the layout size using `FD_LAYOUT_FINI` with `fd_progcache_rec_align()`.
- **Output**: Returns the calculated memory footprint as an unsigned long integer.
- **Functions Called**:
    - [`fd_progcache_rec_align`](<#fd_progcache_rec_align>)


---
### fd\_progcache\_rec\_delete<!-- {{#callable:fd_progcache_rec_delete}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_rec.h#L106>)

Returns the memory address of a `fd_progcache_rec_t` object to the caller.
- **Inputs**:
    - ``rec``: A pointer to a `fd_progcache_rec_t` object that is to be deleted.
- **Logic and Control Flow**:
    - The function takes a pointer to a `fd_progcache_rec_t` object as input.
    - It returns the same pointer back to the caller, effectively providing the memory address of the object.
- **Output**: A pointer to the `fd_progcache_rec_t` object, which is the same as the input `rec`.


# Function Declarations (Public API)

---
### fd\_progcache\_rec\_new<!-- {{#callable_declaration:fd_progcache_rec_new}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_rec.h#L85>)

Creates a new executable program cache entry.
- **Description**: Use this function to create a new executable program cache entry from ELF program data. The function requires a memory region that matches the alignment and footprint specifications for the program cache entry. It loads and verifies the provided program data, returning a pointer to the newly created executable object on success. If the function fails, it returns NULL. Ensure that the memory region is correctly aligned and sized, and that all input parameters are valid before calling this function.
- **Inputs**:
    - `mem`: A pointer to a memory region that matches the alignment and footprint requirements for a program cache entry. The caller retains ownership and must ensure it is correctly aligned and sized.
    - `elf_info`: A pointer to a constant `fd_sbpf_elf_info_t` structure containing ELF information. Must not be null.
    - `config`: A pointer to a constant `fd_sbpf_loader_config_t` structure containing loader configuration. Must not be null.
    - `load_slot`: An unsigned long representing the slot number for the cache entry. Must be a valid slot number.
    - `features`: A pointer to a constant `fd_features_t` structure containing feature flags. Must not be null.
    - `progdata`: A pointer to the program data to load. Must not be null.
    - `progdata_sz`: An unsigned long representing the size of the program data. Must be greater than zero.
    - `scratch`: A pointer to a scratch memory area used during loading. The caller retains ownership and must ensure it is correctly sized.
    - `scratch_sz`: An unsigned long representing the size of the scratch memory area. Must be sufficient for the loading process.
- **Output**: Returns a pointer to the newly created `fd_progcache_rec_t` object on success, or NULL on failure.
- **See Also**: [`fd_progcache_rec_new`](<fd_progcache_rec.c.md#fd_progcache_rec_new>)  (Implementation)


---
### fd\_progcache\_rec\_new\_nx<!-- {{#callable_declaration:fd_progcache_rec_new_nx}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_rec.h#L99>)

Creates a non-executable program cache entry.
- **Description**: Use this function to initialize a non-executable program cache entry in a specified memory region. This function sets up the cache entry with a given slot number and marks it as non-executable. It is useful when you need to create a cache entry for programs that failed verification or are not intended to be executable. Ensure that the memory region provided is suitable for a `fd_progcache_rec_t` object.
- **Inputs**:
    - `mem`: Pointer to a memory region where the non-executable program cache entry will be created. Must be suitable for a `fd_progcache_rec_t` object. Caller retains ownership.
    - `load_slot`: Unsigned long integer representing the slot number at which this cache entry is created. It should match the XID's slot number for in-preparation transactions.
- **Output**: Returns a pointer to the newly created `fd_progcache_rec_t` object initialized as non-executable.
- **See Also**: [`fd_progcache_rec_new_nx`](<fd_progcache_rec.c.md#fd_progcache_rec_new_nx>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)