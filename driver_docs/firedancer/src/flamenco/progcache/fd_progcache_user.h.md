<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

API for managing a cache of Solana on-chain programs with fork management and cache policies.

# Purpose
The `fd_progcache_user.h` file provides an API for managing a cache of Solana on-chain programs. This header file defines the structures and functions necessary to handle the caching mechanism, which is designed to optimize the execution of Solana programs by reducing the need for repeated loading and verification. The cache is fork-aware, meaning it can handle different versions of programs across blockchain forks using transactions. The file includes definitions for cache entries, which consist of a `funk_rec` object and a variable-sized `fd_progcache_entry` struct, and outlines policies for cache filling, eviction, and garbage collection.

The file defines several key components, including the `fd_progcache` and `fd_progcache_metrics` structures, which store cache state and performance metrics, respectively. It provides functions for joining and leaving a cache instance, querying the cache for existing entries, loading programs into the cache, and invalidating cache entries when program content changes. The cache is lazily filled on reads and eagerly invalidated if underlying programs are modified. Eviction occurs when the cache cannot allocate new entries, and garbage collection is triggered by specific events such as fork cancellations or entry orphaning. The file also includes necessary includes and macros to support these operations.
# Imports and Dependencies

---
- `fd_progcache_rec.h`
- `fd_prog_load.h`
- `../../funk/fd_funk.h`
- `../runtime/fd_runtime_const.h`


# Global Variables

---
### fd\_progcache\_metrics\_default
- **Type**: `fd_progcache_metrics_t`
- **Description**: Represents the default metrics for the program cache, which includes counters for various cache operations such as fork switches, cache misses, hits, fills, and invalidations.
- **Use**: Used to track and report default metrics related to the program cache operations.


# Data Structures

---
### fd\_progcache\_metrics
- **Type**: ``struct``
- **Members**:
    - `fork_switch_cnt`: Counts the number of times the cache switches forks.
    - `miss_cnt`: Counts the number of cache misses.
    - `hit_cnt`: Counts the number of cache hits.
    - `hit_tot_sz`: Tracks the total size of data retrieved from cache hits.
    - `fill_cnt`: Counts the number of times the cache is filled.
    - `fill_tot_sz`: Tracks the total size of data added to the cache during fills.
    - `fill_fail_cnt`: Counts the number of times cache fills fail.
    - `dup_insert_cnt`: Counts the number of duplicate insertions into the cache.
    - `invalidate_cnt`: Counts the number of times cache entries are invalidated.
- **Description**: Tracks various metrics related to the performance and operations of a program cache, including counts of cache hits, misses, fills, and invalidations, as well as the total size of data involved in these operations.


---
### fd\_progcache\_metrics\_t
- **Type**: ``struct``
- **Members**:
    - `fork_switch_cnt`: Counts the number of times the fork has switched.
    - `miss_cnt`: Counts the number of cache misses.
    - `hit_cnt`: Counts the number of cache hits.
    - `hit_tot_sz`: Records the total size of all cache hits.
    - `fill_cnt`: Counts the number of times the cache has been filled.
    - `fill_tot_sz`: Records the total size of all cache fills.
    - `fill_fail_cnt`: Counts the number of times cache fill operations have failed.
    - `dup_insert_cnt`: Counts the number of duplicate insertions into the cache.
    - `invalidate_cnt`: Counts the number of times cache entries have been invalidated.
- **Description**: Collects various metrics related to the performance and operations of a program cache, including counts of cache hits, misses, fills, and invalidations, as well as the total sizes of hits and fills.


---
### fd\_progcache
- **Type**: ``struct``
- **Members**:
    - `funk`: An array of `fd_funk_t` representing the funk transaction instance.
    - `fork`: An array of `fd_funk_txn_xid_t` representing the current fork cache with a maximum depth defined by `FD_PROGCACHE_DEPTH_MAX`.
    - `fork_depth`: An `ulong` indicating the current depth of the fork cache.
    - `metrics`: A pointer to `fd_progcache_metrics_t` for tracking cache metrics.
    - `scratch`: A pointer to an `uchar` buffer used as a scratch space for temporary data.
    - `scratch_sz`: An `ulong` representing the size of the scratch buffer.
- **Description**: Manages a cache of loaded Solana on-chain programs, supporting fork-aware operations and tracking cache metrics. It includes a funk transaction instance, a fork cache with a defined maximum depth, and a scratch buffer for temporary data storage. The structure is designed to handle program cache entries, manage cache fills and evictions, and support garbage collection policies.


---
### fd\_progcache\_t
- **Type**: ``struct``
- **Members**:
    - ``funk``: An array of one `fd_funk_t` object representing the funk instance.
    - ``fork``: An array of `fd_funk_txn_xid_t` with a maximum depth defined by `FD_PROGCACHE_DEPTH_MAX`.
    - ``fork_depth``: An `ulong` indicating the current depth of the fork cache.
    - ``metrics``: A pointer to `fd_progcache_metrics_t` for tracking cache metrics.
    - ``scratch``: A pointer to a scratch buffer used for temporary storage.
    - ``scratch_sz``: An `ulong` representing the size of the scratch buffer.
- **Description**: `fd_progcache_t` is a data structure that acts as a thread-local client to a program cache funk instance, designed to manage a cache of loaded Solana on-chain programs. It includes a funk instance, a fork cache with a defined maximum depth, and metrics for tracking cache operations. The structure also contains a scratch buffer for temporary storage, which is used during cache operations. This structure is not suitable for local or stack declarations due to its large size.


# Functions

---
### fd\_progcache\_align<!-- {{#callable:fd_progcache_align}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_user.h#L99>)

Returns the alignment requirement of the `fd_progcache_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `alignof` to determine the alignment requirement of `fd_progcache_t`.
    - Returns the result of the `alignof` operation.
- **Output**: The alignment requirement of the `fd_progcache_t` structure as an `ulong`.


---
### fd\_progcache\_footprint<!-- {{#callable:fd_progcache_footprint}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_user.h#L104>)

Calculates the memory footprint of the `fd_progcache_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the size of the `fd_progcache_t` structure using the `sizeof` operator.
- **Output**: The function returns an `ulong` representing the size of the `fd_progcache_t` structure.


---
### fd\_progcache\_new<!-- {{#callable:fd_progcache_new}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_user.h#L109>)

Returns the input pointer `ljoin` as a `fd_progcache_t` pointer.
- **Inputs**:
    - `ljoin`: A pointer to a memory location that is expected to be a `fd_progcache_t` object.
- **Logic and Control Flow**:
    - The function takes a single input parameter `ljoin`.
    - It returns the `ljoin` pointer cast to a `fd_progcache_t` pointer.
- **Output**: A `fd_progcache_t` pointer that is the same as the input `ljoin` pointer.


---
### fd\_progcache\_delete<!-- {{#callable:fd_progcache_delete}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_user.h#L114>)

Returns the input pointer `ljoin` without modification.
- **Inputs**:
    - `ljoin`: A pointer to a memory location that is intended to be deleted or released.
- **Logic and Control Flow**:
    - The function takes a single input parameter `ljoin`.
    - It returns the same pointer `ljoin` without performing any operations on it.
- **Output**: The function returns the input pointer `ljoin` unchanged.


# Function Declarations (Public API)

---
### fd\_progcache\_join<!-- {{#callable_declaration:fd_progcache_join}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_user.h#L124>)

Joins a caller to a program cache funk instance.
- **Description**: Use this function to connect a caller to a program cache funk instance, which is necessary for managing Solana on-chain program caches. Ensure that the `ljoin` and `shfunk` parameters are not null before calling. If `scratch_sz` is non-zero, `scratch` must not be null and must be aligned to `FD_PROGCACHE_SCRATCH_ALIGN`. This function initializes the program cache structure and sets up necessary metrics and scratch space. It returns null if any preconditions are not met.
- **Inputs**:
    - `ljoin`: A pointer to an `fd_progcache_t` structure. Must not be null. Caller retains ownership.
    - `shfunk`: A pointer to a shared funk instance. Must not be null. Caller retains ownership.
    - `scratch`: A pointer to a scratch buffer. Must be aligned to `FD_PROGCACHE_SCRATCH_ALIGN` if `scratch_sz` is non-zero. Caller retains ownership.
    - `scratch_sz`: The size of the scratch buffer. Can be zero, in which case `scratch` is ignored.
- **Output**: Returns a pointer to the initialized `fd_progcache_t` structure on success, or null if any input validation fails.
- **See Also**: [`fd_progcache_join`](<fd_progcache_user.c.md#fd_progcache_join>)  (Implementation)


---
### fd\_progcache\_leave<!-- {{#callable_declaration:fd_progcache_leave}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_user.h#L135>)

Detaches from a program cache.
- **Description**: Use this function to detach from a program cache when it is no longer needed. This function must be called after successfully joining a program cache using `fd_progcache_join`. It resets the internal scratch buffer and its size to null and zero, respectively. If the `cache` parameter is null, the function logs a warning and returns null. This function also optionally updates the shared funk state if `opt_shfunk` is provided.
- **Inputs**:
    - `cache`: A pointer to the `fd_progcache_t` structure representing the program cache to detach from. Must not be null. If null, the function logs a warning and returns null.
    - `opt_shfunk`: An optional pointer to a location where the function can store the shared funk state upon detachment. Can be null if the caller does not need this information.
- **Output**: Returns a pointer to the `fd_progcache_t` structure if successful, or null if the `cache` parameter is null or if detachment fails.
- **See Also**: [`fd_progcache_leave`](<fd_progcache_user.c.md#fd_progcache_leave>)  (Implementation)


---
### fd\_progcache\_peek<!-- {{#callable_declaration:fd_progcache_peek}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_user.h#L146>)

Queries the program cache for an existing entry.
- **Description**: Use this function to check if a specific program is already present in the cache without modifying the cache. It is useful for read-only operations where you need to verify the existence of a program entry. The function requires a valid cache and a transaction ID. It returns a pointer to the cache entry if found and valid for the given epoch slot, or NULL if the entry is not found or invalid. Ensure the cache is properly initialized before calling this function.
- **Inputs**:
    - `cache`: A pointer to an `fd_progcache_t` structure representing the program cache. Must not be null and must point to a valid cache instance.
    - `xid`: A pointer to a `fd_funk_txn_xid_t` structure representing the transaction ID. Must not be null.
    - `prog_addr`: A pointer to the program address. Must not be null and should point to a valid memory location containing the program address.
    - `epoch_slot0`: An unsigned long representing the epoch slot. It is used to validate the cache entry against the current epoch.
- **Output**: A pointer to an `fd_progcache_rec_t` structure if the cache entry is found and valid; otherwise, NULL.
- **See Also**: [`fd_progcache_peek`](<fd_progcache_user.c.md#fd_progcache_peek>)  (Implementation)


---
### fd\_progcache\_pull<!-- {{#callable_declaration:fd_progcache_pull}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_user.h#L166>)

Loads a program from the cache, filling it if necessary.
- **Description**: Use this function to retrieve a program from the cache, loading it if it is not already present. It returns a cache entry if the program is found and either successfully loaded or failed verification. If the program is not deployed, it returns NULL. This function should be called when you need to ensure a program is available for execution, and it handles cache hits, fills, and invalidations automatically. Ensure the cache is properly initialized before calling this function.
- **Inputs**:
    - `cache`: A pointer to an `fd_progcache_t` structure representing the program cache. Must not be null and should be properly initialized.
    - `accdb`: A pointer to an `fd_funk_t` structure representing the account database. Must not be null.
    - `xid`: A pointer to an `fd_funk_txn_xid_t` structure representing the transaction ID. Must not be null.
    - `prog_addr`: A pointer to the program address. Must not be null.
    - `env`: A pointer to an `fd_prog_load_env_t` structure containing the environment settings. Must not be null.
- **Output**: Returns a pointer to an `fd_progcache_rec_t` structure if a cache entry is found or created, or NULL if the program is not deployed.
- **See Also**: [`fd_progcache_pull`](<fd_progcache_user.c.md#fd_progcache_pull>)  (Implementation)


---
### fd\_progcache\_invalidate<!-- {{#callable_declaration:fd_progcache_invalidate}} -->
[View Source →](<../../../../../src/flamenco/progcache/fd_progcache_user.h#L181>)

Marks a program cache entry as invalidated.
- **Description**: Use this function to mark a program cache entry as invalidated when the program content changes. This function creates a non-executable cache entry at the specified transaction ID (`xid`). After invalidation, it is not allowed to pull the same entry at the same transaction ID. Ensure that the cache is properly initialized and that the transaction is not write-locked before calling this function. This function updates the cache metrics to reflect the invalidation.
- **Inputs**:
    - `cache`: A pointer to an `fd_progcache_t` structure representing the program cache. Must not be null.
    - `xid`: A pointer to an `fd_funk_txn_xid_t` structure representing the transaction ID. Must not be null.
    - `prog_addr`: A pointer to the program address to be invalidated. Must not be null.
    - `slot`: An unsigned long integer representing the slot number associated with the cache entry.
- **Output**: Returns a pointer to the invalidated `fd_progcache_rec_t` cache entry. If another thread has already published the same record, returns a pointer to that existing record instead.
- **See Also**: [`fd_progcache_invalidate`](<fd_progcache_user.c.md#fd_progcache_invalidate>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)