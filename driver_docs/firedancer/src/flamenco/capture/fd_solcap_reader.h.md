<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines structures and functions for iterating and reading chunks in a solcap file.

# Purpose
The code is a C header file that defines an interface for reading and processing chunks of data from a "solcap" file, which is likely a specific file format used in the context of the application. The primary component is the `fd_solcap_chunk_iter_t` structure, which facilitates iteration over chunks within a solcap file. The file provides several functions to initialize the iterator, read the next chunk, check for errors, and find specific chunks based on a magic number. These functions allow users to navigate and extract data from solcap files efficiently.

The header file also includes functions for reading specific metadata from the solcap file, such as bank preimage metadata and account table metadata. Functions like [`fd_solcap_read_bank_preimage`](<#fd_solcap_read_bank_preimage>) and [`fd_solcap_find_account_table`](<#fd_solcap_find_account_table>) are used to parse and access specific sections of the file, while [`fd_solcap_includes_account_data`](<#fd_solcap_includes_account_data>) and [`fd_solcap_find_account`](<#fd_solcap_find_account>) help determine the presence of account data and locate specific account information. The file is intended to be included in other C source files, providing a public API for interacting with solcap files. It includes necessary dependencies and uses conditional compilation to ensure compatibility with hosted environments.
# Imports and Dependencies

---
- `fd_solcap.pb.h`
- `fd_solcap_proto.h`


# Data Structures

---
### fd\_solcap\_chunk\_iter
- **Type**: ``struct``
- **Members**:
    - `stream`: A pointer to a stream, typically a file handle, used for reading chunks.
    - `chunk`: An instance of `fd_solcap_chunk_t` representing the current chunk.
    - `err`: An integer storing the error code of the last operation.
    - `chunk_off`: An unsigned long representing the absolute file offset of the current chunk.
    - `chunk_end`: An unsigned long representing the absolute file offset of the next chunk.
- **Description**: Facilitates iteration through chunks in a solcap file by maintaining state information such as the current stream position, the current chunk, error status, and file offsets for the current and next chunks.


---
### fd\_solcap\_chunk\_iter\_t
- **Type**: ``struct``
- **Members**:
    - ``stream``: A pointer to the file stream being iterated.
    - ``chunk``: Holds the current chunk data of type `fd_solcap_chunk_t`.
    - ``err``: Stores the error code of the last operation.
    - ``chunk_off``: The absolute file offset of the current chunk.
    - ``chunk_end``: The absolute file offset of the next chunk.
- **Description**: Facilitates iteration through chunks in a solcap file, maintaining state information such as the current chunk, error status, and file offsets.


# Functions

---
### fd\_solcap\_chunk\_iter\_err<!-- {{#callable:fd_solcap_chunk_iter_err}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_reader.h#L55>)

Returns the error code from the last operation on the iterator.
- **Inputs**:
    - `iter`: A pointer to a constant `fd_solcap_chunk_iter_t` structure, which contains the state of the chunk iterator.
- **Logic and Control Flow**:
    - Accesses the `err` field of the `fd_solcap_chunk_iter_t` structure pointed to by `iter`.
    - Returns the value of the `err` field.
- **Output**: The function returns an integer representing the error code of the last operation performed by the iterator. If the last failure was due to end-of-file, it returns 0; otherwise, it returns a non-zero error code.


---
### fd\_solcap\_chunk\_iter\_item<!-- {{#callable:fd_solcap_chunk_iter_item}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_reader.h#L73>)

Returns a pointer to the last successfully read chunk header from the iterator.
- **Inputs**:
    - `iter`: A pointer to a `fd_solcap_chunk_iter_t` structure, which contains the current state of the chunk iteration.
- **Logic and Control Flow**:
    - Accesses the `chunk` field of the `iter` structure.
    - Returns a pointer to the `chunk` field.
- **Output**: A pointer to a `fd_solcap_chunk_t` structure representing the last successfully read chunk header.


---
### fd\_solcap\_chunk\_iter\_find<!-- {{#callable:fd_solcap_chunk_iter_find}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_reader.h#L82>)

Iterates through chunks to find a chunk with a specified magic number and returns its file offset.
- **Inputs**:
    - ``iter``: A pointer to an `fd_solcap_chunk_iter_t` structure used to iterate through the chunks.
    - ``magic``: An unsigned long integer representing the magic number to search for in the chunks.
- **Logic and Control Flow**:
    - Calls [`fd_solcap_chunk_iter_next`](<fd_solcap_reader.c.md#fd_solcap_chunk_iter_next>) to get the next chunk's file offset.
    - Checks if the returned file offset is less than 0, indicating an error or end-of-file, and returns -1L if true.
    - Checks if the iteration is done using [`fd_solcap_chunk_iter_done`](<fd_solcap_reader.c.md#fd_solcap_chunk_iter_done>), and returns -1L if true.
    - Compares the `magic` field of the current chunk with the input `magic` value using [`fd_solcap_chunk_iter_item`](<#fd_solcap_chunk_iter_item>).
    - Returns the file offset of the chunk if the magic numbers match.
- **Output**: Returns the absolute file offset of the chunk if found, or -1L if not found.
- **Functions Called**:
    - [`fd_solcap_chunk_iter_next`](<fd_solcap_reader.c.md#fd_solcap_chunk_iter_next>)
    - [`fd_solcap_chunk_iter_done`](<fd_solcap_reader.c.md#fd_solcap_chunk_iter_done>)
    - [`fd_solcap_chunk_iter_item`](<#fd_solcap_chunk_iter_item>)


---
### fd\_solcap\_includes\_account\_data<!-- {{#callable:fd_solcap_includes_account_data}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_reader.h#L123>)

Checks if a capture account chunk includes account data by verifying non-zero data offset and size.
- **Inputs**:
    - `meta`: A pointer to a constant `fd_solcap_AccountMeta` structure that contains metadata about the account.
- **Logic and Control Flow**:
    - Evaluate the logical NOT of `meta->data_coff` to check if the data offset is non-zero.
    - Evaluate the logical NOT of `meta->data_sz` to check if the data size is non-zero.
    - Perform a bitwise AND operation on the results of the two logical NOT evaluations.
    - Return the result of the bitwise AND operation, which is 1 if both data offset and size are non-zero, otherwise 0.
- **Output**: Returns 1 if both the data offset and data size in the account metadata are non-zero, indicating the presence of account data; otherwise, returns 0.


# Function Declarations (Public API)

---
### fd\_solcap\_chunk\_iter\_next<!-- {{#callable_declaration:fd_solcap_chunk_iter_next}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_reader.h#L48>)

Reads the next chunk header from the stream.
- **Description**: Use this function to read the next chunk header from a solcap file stream. It is safe to call even if the stream cursor was modified by the user. On success, it returns the file offset pointing to the first byte of the chunk. The stream cursor becomes undefined after the call, so use `fseek()` with `SEEK_SET` to navigate to the desired data. Call this function after initializing the iterator with `fd_solcap_chunk_iter_new`. It returns -1L on failure, which can occur due to end-of-file, I/O error, or parse error. Check the error code using `fd_solcap_chunk_iter_err` to determine the cause of failure.
- **Inputs**:
    - `iter`: A pointer to an `fd_solcap_chunk_iter_t` structure. This must be initialized and must not be null. The function updates this structure with the next chunk's information. If the input is invalid, the function returns -1L.
- **Output**: Returns the file offset of the first byte of the chunk on success, or -1L on failure. The `err` field in `iter` is updated with an error code if a failure occurs.
- **See Also**: [`fd_solcap_chunk_iter_next`](<fd_solcap_reader.c.md#fd_solcap_chunk_iter_next>)  (Implementation)


---
### fd\_solcap\_chunk\_iter\_done<!-- {{#callable_declaration:fd_solcap_chunk_iter_done}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_reader.h#L64>)

Checks if the iteration over chunks is complete.
- **Description**: Use this function to determine if there are more chunks to process in the iteration. It returns a non-zero value if the end of the file is reached or if there was a read failure during the last chunk operation. This function is useful to check the termination condition of a loop iterating over chunks. Ensure that the iterator is properly initialized and used with the appropriate functions before calling this function.
- **Inputs**:
    - `iter`: A pointer to a `fd_solcap_chunk_iter_t` structure. This must not be null and should point to a valid iterator that has been initialized and used with the appropriate functions. The function checks the state of this iterator to determine if iteration is complete.
- **Output**: Returns 1 if the end of the file is reached or a read failure occurred; otherwise, returns 0.
- **See Also**: [`fd_solcap_chunk_iter_done`](<fd_solcap_reader.c.md#fd_solcap_chunk_iter_done>)  (Implementation)


---
### fd\_solcap\_read\_bank\_preimage<!-- {{#callable_declaration:fd_solcap_read_bank_preimage}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_reader.h#L101>)

Reads and parses the bank preimage metadata blob.
- **Description**: Use this function to read and parse the bank preimage metadata from a specified chunk in a file stream. The function requires a valid file stream, a file offset indicating the start of the chunk, and a header that describes the chunk. It is important to ensure that the header's magic number matches the expected value before calling this function. The function will seek to the correct position in the file, read the metadata into a buffer, and decode it into the provided `preimage` structure. If any step fails, the function returns an error code indicating the type of failure.
- **Inputs**:
    - `stream`: A pointer to a file stream (e.g., `FILE *`). The stream must be open and valid. The caller retains ownership.
    - `chunk_goff`: An unsigned long integer representing the file offset of the chunk containing the bank preimage. Must be a valid offset within the file.
    - `preimage`: A pointer to an `fd_solcap_BankPreimage` structure where the decoded metadata will be stored. Must not be null. The caller provides this structure.
    - `hdr`: A pointer to a constant `fd_solcap_chunk_t` structure that contains the header of the chunk. The header must have a valid magic number and describe the chunk accurately. The caller retains ownership.
- **Output**: Returns 0 on success. On failure, returns an error code such as `EPROTO`, `ENOMEM`, or an `errno` value indicating the type of error.
- **See Also**: [`fd_solcap_read_bank_preimage`](<fd_solcap_reader.c.md#fd_solcap_read_bank_preimage>)  (Implementation)


---
### fd\_solcap\_find\_account\_table<!-- {{#callable_declaration:fd_solcap_find_account_table}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_reader.h#L113>)

Reads account table metadata and seeks to the first account table row.
- **Description**: Use this function to read the metadata of an account table from a file stream and position the stream cursor to the start of the account table rows. This function is useful when you need to process account table data from a file. It requires a valid file stream and a file offset pointing to the account table chunk. The function writes the account metadata to the provided `meta` structure. It returns an error code if it fails to read the metadata or seek to the correct position.
- **Inputs**:
    - `_file`: A pointer to a file stream (FILE *). Must not be null. The stream should be open and valid for reading.
    - `meta`: A pointer to an `fd_solcap_AccountTableMeta` structure where the function will store the account table metadata. Must not be null.
    - `acc_tbl_goff`: An unsigned long representing the file offset of the chunk containing the account table. Must be a valid offset within the file.
- **Output**: Returns 0 on success. On failure, returns an errno-like error code indicating the type of error encountered.
- **See Also**: [`fd_solcap_find_account_table`](<fd_solcap_reader.c.md#fd_solcap_find_account_table>)  (Implementation)


---
### fd\_solcap\_find\_account<!-- {{#callable_declaration:fd_solcap_find_account}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_reader.h#L134>)

Reads an account meta and optionally sets the file offset to account data.
- **Description**: Use this function to read account metadata from a file stream and optionally obtain the file offset to the account data. This function requires a valid file stream and an account table record. It writes the account metadata to the provided `meta` structure. If `opt_data_off` is not null and the account data is included, it sets `*opt_data_off` to the file offset of the account data. The function returns 0 on success or an error code on failure. Ensure that the file stream is correctly positioned before calling this function.
- **Inputs**:
    - `_file`: A pointer to a file stream (e.g., `FILE *`). Must not be null. The stream should be correctly positioned for reading.
    - `meta`: A pointer to an `fd_solcap_AccountMeta` structure where the account metadata will be stored. Must not be null.
    - `opt_data_off`: An optional pointer to a `ulong` where the file offset to the account data will be stored if account data is included. Can be null.
    - `rec`: A pointer to a constant `fd_solcap_account_tbl_t` structure representing the account table record. Must not be null.
    - `acc_tbl_goff`: An unsigned long representing the file offset of the account table chunk. Must be a valid offset within the file.
- **Output**: Returns 0 on success or an errno-like error code on failure. If `opt_data_off` is provided and account data is included, it sets `*opt_data_off` to the file offset of the account data.
- **See Also**: [`fd_solcap_find_account`](<fd_solcap_reader.c.md#fd_solcap_find_account>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)