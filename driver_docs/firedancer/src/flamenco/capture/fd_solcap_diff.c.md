<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

A C program for comparing Solana capture files, identifying differences in bank hashes, accounts, and transactions.

# Purpose
The code is a C program designed to compare two Solana capture files, which contain data about blockchain transactions and states. The program reads these files, processes the data, and identifies differences between them. It includes functionality to handle both account and transaction data, providing detailed output on mismatches. The program uses several custom data structures and functions to manage the capture data, including `fd_solcap_differ_t` and `fd_solcap_txn_differ_t` for handling account and transaction differences, respectively.

The program begins by setting up the environment and parsing command-line arguments to determine the files to compare and various options such as verbosity and memory settings. It then opens the capture files and initializes data structures for processing. The main functionality involves iterating through the capture data, comparing account tables and transaction results, and printing any discrepancies found. The program also supports generating human-readable output for differences, including YAML files for account data. The code is structured to handle both single and dual file inputs, allowing for flexible usage scenarios.
# Imports and Dependencies

---
- `../fd_flamenco.h`
- `fd_solcap_proto.h`
- `fd_solcap_reader.h`
- `fd_solcap.pb.h`
- `../../ballet/base58/fd_base58.h`
- `../types/fd_types.h`
- `../types/fd_types_yaml.h`
- `../../ballet/nanopb/pb_decode.h`
- `errno.h`
- `stdio.h`
- `sys/stat.h`
- `fcntl.h`
- `unistd.h`
- `../../util/tmpl/fd_sort.c`


# Global Variables

---
### \_vote\_program\_address
- **Type**: ``uchar[32]``
- **Description**: A static constant array of unsigned characters with a size of 32 bytes. It is initialized with a specific sequence of hexadecimal values.
- **Use**: Used to store a fixed 32-byte address for a vote program.


---
### \_stake\_program\_address
- **Type**: ``uchar[32]``
- **Description**: A static constant array of unsigned characters with a size of 32 bytes. It is initialized with a specific sequence of hexadecimal values.
- **Use**: Used to store a fixed 32-byte address for the stake program.


# Data Structures

---
### fd\_solcap\_differ
- **Type**: ``struct``
- **Members**:
    - ``iter``: An array of two `fd_solcap_chunk_iter_t` objects for iterating over chunks.
    - ``preimage``: An array of two `fd_solcap_BankPreimage` objects for storing bank preimage data.
    - ``verbose``: An integer indicating the verbosity level for logging.
    - ``dump_dir_fd``: An integer file descriptor for the directory where dumps are stored.
    - ``dump_dir``: A constant character pointer to the directory path for dumps.
    - ``file_paths``: An array of two constant character pointers to the file paths being compared.
- **Description**: Facilitates the comparison of two Solana capture files by iterating over their chunks and preimages, logging differences, and managing file paths and dump directories.


---
### fd\_solcap\_differ\_t
- **Type**: ``struct``
- **Members**:
    - ``iter``: An array of two `fd_solcap_chunk_iter_t` iterators.
    - ``preimage``: An array of two `fd_solcap_BankPreimage` structures.
    - ``verbose``: An integer indicating the verbosity level.
    - ``dump_dir_fd``: An integer file descriptor for the dump directory.
    - ``dump_dir``: A constant character pointer to the dump directory path.
    - ``file_paths``: An array of two constant character pointers to file paths.
- **Description**: `fd_solcap_differ_t` is a structure used to manage and compare two sets of Solana capture data. It contains iterators for navigating through chunks of data, preimage structures for storing bank preimage data, and configuration fields for verbosity and file management. The structure facilitates the synchronization and comparison of data from two different capture files, allowing for detailed analysis and reporting of differences.


---
### fd\_solcap\_txn\_differ
- **Type**: ``struct``
- **Members**:
    - ``file``: An array of two `FILE` pointers for file handling.
    - ``iter``: An array of two `fd_solcap_chunk_iter_t` iterators for iterating over chunks.
    - ``chunk_gaddr``: An array of two `long` integers representing global addresses of chunks.
    - ``transaction``: An array of two `fd_solcap_Transaction` structures for transaction data.
    - ``meta_buf``: A 2D array of `uchar` with dimensions [128][2] for storing metadata buffers.
- **Description**: The `fd_solcap_txn_differ` structure is used to manage and compare transaction data from two different sources. It contains file pointers, iterators for chunk processing, global addresses for chunk locations, transaction data structures, and buffers for metadata. This structure facilitates the synchronization and comparison of transaction data between two files.


---
### fd\_solcap\_txn\_differ\_t
- **Type**: ``struct``
- **Members**:
    - ``file``: Array of two `FILE` pointers for file operations.
    - ``iter``: Array of two `fd_solcap_chunk_iter_t` iterators for chunk iteration.
    - ``chunk_gaddr``: Array of two `long` values for storing chunk addresses.
    - ``transaction``: Array of two `fd_solcap_Transaction` structures for transaction data.
    - ``meta_buf``: 2D array of `uchar` for storing metadata buffers.
- **Description**: `fd_solcap_txn_differ_t` is a structure used to manage and compare transaction data from two different sources. It holds file pointers, iterators for chunk processing, addresses for chunks, transaction data, and metadata buffers. This structure facilitates the synchronization and comparison of transaction results between two files, allowing for detailed analysis and reporting of differences.


---
### account\_entry\_info\_t
- **Type**: ``struct``
- **Members**:
    - ``entry``: Pointer to a constant `fd_solcap_account_tbl_t` structure.
    - ``is_last_occurrence``: Integer indicating if this is the last occurrence of the account entry.
- **Description**: Holds information about an account entry, including a pointer to the account table entry and a flag indicating if it is the last occurrence of this entry in a sequence.


# Functions

---
### normalize\_filename<!-- {{#callable:normalize_filename}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_diff.c#L34>)

Normalizes a file name by either truncating or padding it to a fixed length, with a specified prefix.
- **Inputs**:
    - `original_str`: The original string from which the file name is derived.
    - `file_name`: The buffer where the normalized file name will be stored.
    - `prefix`: A character to be used as the prefix for the normalized file name.
- **Logic and Control Flow**:
    - Set the first character of `file_name` to `prefix`.
    - Calculate the length of `original_str` minus a constant suffix length, plus one.
    - If the calculated length is less than or equal to a constant file name length, copy the `original_str` into `file_name` starting from the second character, and pad the rest with spaces.
    - If the calculated length is greater than the constant file name length, copy a substring of `original_str` into `file_name` starting from the second character, ensuring the total length matches the constant file name length.
    - Terminate the `file_name` with a null character.
- **Output**: A normalized file name stored in the `file_name` buffer, with a fixed length and a specified prefix.


---
### fd\_solcap\_account\_tbl\_lt<!-- {{#callable:fd_solcap_account_tbl_lt}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_diff.c#L57>)

Compares the `key` fields of two `fd_solcap_account_tbl_t` structures to determine if the first is less than the second.
- **Inputs**:
    - `a`: A pointer to the first `fd_solcap_account_tbl_t` structure to compare.
    - `b`: A pointer to the second `fd_solcap_account_tbl_t` structure to compare.
- **Logic and Control Flow**:
    - Uses `memcmp` to compare the `key` fields of the structures pointed to by `a` and `b` for 32 bytes.
    - Returns the result of the comparison as an integer, indicating if `a->key` is less than `b->key`.
- **Output**: An integer that is less than zero if `a->key` is less than `b->key`, zero if they are equal, and greater than zero if `a->key` is greater than `b->key`.


---
### fd\_solcap\_differ\_new<!-- {{#callable:fd_solcap_differ_new}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_diff.c#L88>)

Initializes a `fd_solcap_differ_t` structure by attaching it to two capture files and preparing iterators for chunk processing.
- **Inputs**:
    - ``diff``: A pointer to a `fd_solcap_differ_t` structure that will be initialized.
    - ``streams``: An array of two `FILE` pointers representing the capture files to be processed.
    - ``cap_path``: An array of two `const char*` representing the file paths of the capture files.
- **Logic and Control Flow**:
    - Iterates over the two capture files using a loop with index `i` ranging from 0 to 1.
    - For each file, assigns the file path to `diff->file_paths[i]`.
    - Reads the file header into a `fd_solcap_fhdr_t` structure and checks for read errors.
    - Calculates the offset to the first chunk and seeks to that position in the file, checking for seek errors.
    - Initializes a chunk iterator for each file using `fd_solcap_chunk_iter_new` and checks for initialization errors.
- **Output**: Returns the initialized `fd_solcap_differ_t` structure on success, or `NULL` if an error occurs during file reading or seeking.


---
### fd\_solcap\_differ\_advance<!-- {{#callable:fd_solcap_differ_advance}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_diff.c#L127>)

Seeks an iterator to the next bank hash and reads the bank preimage if found.
- **Inputs**:
    - ``diff``: A pointer to an `fd_solcap_differ_t` structure that contains iterators and preimages.
    - ``idx``: An unsigned long integer that identifies which iterator and preimage to use, with a valid range of [0,2).
- **Logic and Control Flow**:
    - Retrieve the iterator and preimage from the `diff` structure using the `idx` index.
    - Call [`fd_solcap_chunk_iter_find`](<fd_solcap_reader.h.md#fd_solcap_chunk_iter_find>) to find the offset of the next bank hash using the iterator.
    - If the offset is negative, return the error code from [`fd_solcap_chunk_iter_err`](<fd_solcap_reader.h.md#fd_solcap_chunk_iter_err>).
    - Call [`fd_solcap_read_bank_preimage`](<fd_solcap_reader.c.md#fd_solcap_read_bank_preimage>) to read the bank preimage from the stream at the found offset.
    - If reading the bank preimage fails, return the negated error code.
    - Return 1 to indicate success.
- **Output**: Returns 1 on success, 0 if end-of-file is reached, or a negated error code on failure.
- **Functions Called**:
    - [`fd_solcap_chunk_iter_find`](<fd_solcap_reader.h.md#fd_solcap_chunk_iter_find>)
    - [`fd_solcap_chunk_iter_err`](<fd_solcap_reader.h.md#fd_solcap_chunk_iter_err>)
    - [`fd_solcap_read_bank_preimage`](<fd_solcap_reader.c.md#fd_solcap_read_bank_preimage>)


---
### fd\_solcap\_differ\_sync<!-- {{#callable:fd_solcap_differ_sync}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_diff.c#L148>)

Synchronizes two iterators to point to the lowest common slot number within a specified range.
- **Inputs**:
    - ``diff``: A pointer to an `fd_solcap_differ_t` structure that contains the iterators and preimage data.
    - ``start_slot``: The starting slot number for synchronization.
    - ``end_slot``: The ending slot number for synchronization.
- **Logic and Control Flow**:
    - Initialize both iterators to the first bank preimage object using [`fd_solcap_differ_advance`](<#fd_solcap_differ_advance>).
    - Enter an infinite loop to compare the slot numbers of the two iterators.
    - If a slot is skipped in one of the iterators, log a warning message.
    - If the slots are equal, check if the slot is within the specified range (`start_slot` to `end_slot`).
    - If the slot is less than `start_slot`, advance both iterators and continue.
    - If the slot is greater than `end_slot`, return 0 indicating no common slot found.
    - If the slot is within the range, return 1 indicating a common slot found.
    - If the slots are not equal, advance the iterator with the smaller slot number.
    - Update the previous slot numbers for the next iteration.
- **Output**: Returns 1 if a common slot is found within the specified range, 0 if no common slot is found, or a negative value if an error occurs.
- **Functions Called**:
    - [`fd_solcap_differ_advance`](<#fd_solcap_differ_advance>)


---
### fd\_solcap\_can\_pretty\_print<!-- {{#callable:fd_solcap_can_pretty_print}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_diff.c#L202>)

Checks if the given `owner` or `pubkey` matches specific hardcoded program addresses or system variables.
- **Inputs**:
    - `owner`: A 32-byte array representing the owner address to check.
    - `pubkey`: A 32-byte array representing the public key to check.
- **Logic and Control Flow**:
    - Decode four specific system variable addresses from Base58 strings into 32-byte arrays.
    - Compare the `owner` with two hardcoded program addresses (`_vote_program_address` and `_stake_program_address`).
    - If `owner` matches any of the program addresses, return 1.
    - Compare the `pubkey` with the decoded system variable addresses (`_sysvar_clock`, `_sysvar_rent`, `_sysvar_epoch_rewards`, `_sysvar_stake_history`).
    - If `pubkey` matches any of the system variable addresses, return 1.
    - If no matches are found, return 0.
- **Output**: Returns 1 if a match is found with any of the specified addresses, otherwise returns 0.


---
### fd\_solcap\_account\_pretty\_print<!-- {{#callable:fd_solcap_account_pretty_print}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_diff.c#L232>)

Formats and prints account data in YAML format based on the account's owner or public key.
- **Inputs**:
    - ``pubkey``: A 32-byte array representing the public key of the account.
    - ``owner``: A 32-byte array representing the owner of the account.
    - ``data``: A pointer to the account data to be processed.
    - ``data_sz``: The size of the account data in bytes.
    - ``file``: A file pointer where the formatted YAML output will be written.
- **Logic and Control Flow**:
    - Initialize a YAML formatter using `fd_flamenco_yaml_init` and `fd_flamenco_yaml_new` with a scratch allocator.
    - Decode several hardcoded system variables using `fd_base58_decode_32`.
    - Check if the `owner` matches `_vote_program_address` or `_stake_program_address`, or if `pubkey` matches any of the system variables.
    - Depending on the match, decode the account data using `fd_bincode_decode_scratch` into the appropriate structure (e.g., `fd_vote_state_versioned_t`, `fd_stake_state_v2_t`, etc.).
    - If decoding fails, return `-ENOMEM`.
    - Walk through the decoded structure using the corresponding walk function (e.g., `fd_vote_state_versioned_walk`) to format it into YAML.
    - Check for file errors using `ferror` and return the error code if any.
    - Delete the YAML formatter using `fd_flamenco_yaml_delete`.
    - Return 0 to indicate success.
- **Output**: Returns 0 on success, or a negative error code if an error occurs during processing.


---
### fd\_solcap\_dump\_account\_data<!-- {{#callable:fd_solcap_dump_account_data}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_diff.c#L296>)

Writes the account data to a binary file in the specified directory.
- **Inputs**:
    - ``diff``: A pointer to an `fd_solcap_differ_t` structure that contains information about the directory where the dump file will be created.
    - ``meta``: A constant pointer to an `fd_solcap_AccountMeta` structure that contains metadata about the account, including the size of the data to be written.
    - ``filename``: A constant character pointer representing the name of the file to be created.
    - ``acc_data``: A constant void pointer to the account data that will be written to the file.
- **Logic and Control Flow**:
    - Opens a file in the specified directory using `openat` with the given `filename` and flags for creating, writing, and truncating the file.
    - Checks if the file descriptor is valid; if not, logs an error and exits.
    - Converts the file descriptor to a `FILE` pointer using `fdopen` for binary writing.
    - Writes the account data to the file using `fwrite`, ensuring the written size matches the expected size from `meta->data_sz`.
    - Closes the file using `fclose`, which also closes the file descriptor.
- **Output**: No return value; writes account data to a file and logs errors if file operations fail.


---
### fd\_solcap\_diff\_account\_data<!-- {{#callable:fd_solcap_diff_account_data}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_diff.c#L313>)

Compares account data between two sources and outputs differences if any.
- **Inputs**:
    - ``diff``: A pointer to `fd_solcap_differ_t`, which contains the streams and configuration for the diff operation.
    - ``meta``: An array of two `fd_solcap_AccountMeta` structures, each containing metadata about the account data to compare.
    - ``entry``: An array of two pointers to `fd_solcap_account_tbl_t`, representing the account table entries for the accounts being compared.
    - ``data_goff``: An array of two unsigned long values indicating the offsets in the data streams where the account data begins.
- **Logic and Control Flow**:
    - Check if the data sizes in `meta[0]` and `meta[1]` are equal; if not, set `data_eq` to false.
    - If `data_eq` is true, seek to the data offsets in the streams for both accounts.
    - Read and compare chunks of data from both streams until a difference is found or all data is compared.
    - If data is equal, return without further action.
    - If data is not equal and verbosity is high (>= 4), allocate memory for account data and read the data from the streams.
    - Dump the account data to binary files and inform the user of the file paths.
    - If the accounts can be pretty-printed, create YAML files for the account data and inform the user of the file paths.
- **Output**: No return value; outputs differences to files and console.
- **Functions Called**:
    - [`fd_solcap_dump_account_data`](<#fd_solcap_dump_account_data>)
    - [`fd_solcap_can_pretty_print`](<#fd_solcap_can_pretty_print>)
    - [`fd_solcap_account_pretty_print`](<#fd_solcap_account_pretty_print>)


---
### fd\_solcap\_diff\_account<!-- {{#callable:fd_solcap_diff_account}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_diff.c#L424>)

Compares two account entries from different sources and logs differences in their metadata and data.
- **Inputs**:
    - ``diff``: A pointer to an `fd_solcap_differ_t` structure that contains the streams and file paths for comparison.
    - ``entry``: An array of two pointers to `fd_solcap_account_tbl_t` structures representing the account entries to compare.
    - ``acc_tbl_goff``: An array of two unsigned long integers representing the global offsets in the account table for each entry.
- **Logic and Control Flow**:
    - Store the current file offsets for both streams in `orig_off` array.
    - Iterate over the two account entries to read their metadata using [`fd_solcap_find_account`](<fd_solcap_reader.c.md#fd_solcap_find_account>) and store the results in `meta` and `data_goff`.
    - Compare the metadata fields (`owner`, `lamports`, `data_sz`, `slot`, `executable`) of the two accounts.
    - If any metadata fields differ, print the account key and the differing fields with their values from both sources.
    - If the data size is non-zero or includes account data, call [`fd_solcap_diff_account_data`](<#fd_solcap_diff_account_data>) to compare the account data.
    - Restore the original file offsets for both streams using `fseek`.
- **Output**: No return value; outputs differences to the standard output.
- **Functions Called**:
    - [`fd_solcap_find_account`](<fd_solcap_reader.c.md#fd_solcap_find_account>)
    - [`fd_solcap_includes_account_data`](<fd_solcap_reader.h.md#fd_solcap_includes_account_data>)
    - [`fd_solcap_diff_account_data`](<#fd_solcap_diff_account_data>)


---
### fd\_solcap\_diff\_missing\_account<!-- {{#callable:fd_solcap_diff_missing_account}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_diff.c#L493>)

Handles the case where an account is missing on one side of a comparison by reading its metadata and optionally dumping its data to a file.
- **Inputs**:
    - ``diff``: A pointer to an `fd_solcap_differ_t` structure that contains information about the current state of the diff operation, including verbosity level and dump directory.
    - ``entry``: A constant pointer to an `fd_solcap_account_tbl_t` structure representing the account entry to process.
    - ``acc_tbl_goff``: An unsigned long integer representing the offset in the account table where the account entry is located.
    - ``stream``: A pointer to a `FILE` object representing the stream from which to read the account data.
- **Logic and Control Flow**:
    - Store the current file offset using `ftell` and log an error if it fails.
    - Call [`fd_solcap_find_account`](<fd_solcap_reader.c.md#fd_solcap_find_account>) to read the account metadata and data offset, and ensure it succeeds using `FD_TEST`.
    - Print the account metadata including lamports, data size, owner, slot, and executable status.
    - If the verbosity level in `diff` is 4 or higher, proceed to dump the account data to a file.
    - Allocate memory for the account data using `fd_scratch_alloc` and rewind the stream to the data offset using `fseek`.
    - Read the account data from the stream into the allocated memory and ensure the read size matches the expected data size.
    - Generate a filename for the account data file using `snprintf` and ensure it is valid.
    - Call [`fd_solcap_dump_account_data`](<#fd_solcap_dump_account_data>) to write the account data to a binary file.
    - Print the location of the dumped data and provide a command to view it using `xxd`.
    - Check if the account can be pretty-printed using [`fd_solcap_can_pretty_print`](<#fd_solcap_can_pretty_print>), and if so, create a YAML file for the account data.
    - Generate a path for the YAML file using `snprintf` and ensure it is valid.
    - Open the YAML file for writing using `openat` and log an error if it fails.
    - Call [`fd_solcap_account_pretty_print`](<#fd_solcap_account_pretty_print>) to write the account data in a human-readable format to the YAML file.
    - Close the YAML file using `fclose` and print a command to view the YAML file using `cat`.
- **Output**: No return value; the function performs logging and file operations as side effects.
- **Functions Called**:
    - [`fd_solcap_find_account`](<fd_solcap_reader.c.md#fd_solcap_find_account>)
    - [`fd_solcap_dump_account_data`](<#fd_solcap_dump_account_data>)
    - [`fd_solcap_can_pretty_print`](<#fd_solcap_can_pretty_print>)
    - [`fd_solcap_account_pretty_print`](<#fd_solcap_account_pretty_print>)


---
### fd\_solcap\_diff\_account\_tbl<!-- {{#callable:fd_solcap_diff_account_tbl}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_diff.c#L580>)

Compares two account tables from different captures to identify mismatches and prints details of any discrepancies.
- **Inputs**:
    - ``diff``: A pointer to an `fd_solcap_differ_t` structure that contains information about the two captures being compared, including file streams, preimages, and verbosity level.
- **Logic and Control Flow**:
    - Initialize `has_mismatch` to 0 to track if any mismatches are found.
    - For each capture (two iterations), check if the account table offset is zero; if so, log a warning and return 1.
    - Calculate the global offset for the account table in each capture and read the table metadata.
    - Check if the number of accounts exceeds `INT_MAX`; if so, log a warning and return 1.
    - Allocate memory for the account tables and read the tables from the file streams.
    - For each capture, allocate memory for `account_entry_info_t` structures to store account entries and mark each entry as the last occurrence initially.
    - For each capture, iterate over the account entries to identify duplicate keys and mark non-last occurrences.
    - Sort the account entries in each capture by their keys using a simple bubble sort.
    - Initialize index counters for both tables and iterate over them in parallel to compare entries.
    - If keys match, call [`fd_solcap_diff_account`](<#fd_solcap_diff_account>) if verbosity is high enough, then increment both indices.
    - If a key in the first table is less than the key in the second, log the mismatch, call [`fd_solcap_diff_missing_account`](<#fd_solcap_diff_missing_account>) if verbosity is high enough, and increment the first index.
    - If a key in the second table is less than the key in the first, log the mismatch, call [`fd_solcap_diff_missing_account`](<#fd_solcap_diff_missing_account>) if verbosity is high enough, and increment the second index.
    - After parallel iteration, check remaining entries in both tables for mismatches and log them if found.
    - Return `has_mismatch` to indicate if any mismatches were detected.
- **Output**: Returns an integer indicating whether any mismatches were found (1 if mismatches exist, 0 otherwise).
- **Functions Called**:
    - [`fd_solcap_find_account_table`](<fd_solcap_reader.c.md#fd_solcap_find_account_table>)
    - [`fd_solcap_diff_account`](<#fd_solcap_diff_account>)
    - [`fd_solcap_diff_missing_account`](<#fd_solcap_diff_missing_account>)


---
### fd\_solcap\_diff\_bank<!-- {{#callable:fd_solcap_diff_bank}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_diff.c#L726>)

Compares two bank preimages for mismatches in various hash and count fields, and prints detailed information about any discrepancies found.
- **Inputs**:
    - ``diff``: A pointer to an `fd_solcap_differ_t` structure containing the bank preimages to compare and other related data.
- **Logic and Control Flow**:
    - Retrieve the bank preimages from the `diff` structure.
    - Verify that the slots of the two preimages are equal using `FD_TEST`.
    - Compare the `bank_hash` fields of the two preimages using `memcmp` to check for mismatches.
    - Initialize `has_any_mismatch` to the result of the `bank_hash` comparison.
    - Check other fields (`prev_bank_hash`, `account_delta_hash`, `accounts_lt_hash_checksum`, `poh_hash`, `signature_cnt`, `account_cnt`) for mismatches and update `has_any_mismatch` accordingly.
    - If `diff->verbose` is less than 2, print a message and return if there is a bank hash mismatch.
    - If `has_any_mismatch` is true, print detailed information about each mismatched field.
    - If `diff->verbose` is 3 or higher, call [`fd_solcap_diff_account_tbl`](<#fd_solcap_diff_account_tbl>) to check for account table mismatches.
    - Return the logical OR of `has_any_mismatch` and the result of [`fd_solcap_diff_account_tbl`](<#fd_solcap_diff_account_tbl>).
- **Output**: Returns an integer indicating whether any mismatches were found (1 if mismatches exist, 0 otherwise).
- **Functions Called**:
    - [`fd_solcap_diff_account_tbl`](<#fd_solcap_diff_account_tbl>)


---
### fd\_solcap\_transaction\_fd\_diff<!-- {{#callable:fd_solcap_transaction_fd_diff}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_diff.c#L814>)

Compares two transactions and logs differences in their signatures, errors, and resource usage.
- **Inputs**:
    - ``txn_differ``: A pointer to a `fd_solcap_txn_differ_t` structure containing two transactions to compare.
- **Logic and Control Flow**:
    - Check if the transaction signatures differ using `memcmp`; if they do, log a warning message indicating the signatures are different.
    - If the signatures match, compare the transaction error codes (`fd_txn_err`), the number of compute units used (`fd_cus_used`), and the instruction error index (`instr_err_idx`) between the two transactions.
    - If there are differences in transaction errors or compute units used, print the slot number and transaction signature.
    - If there is a difference in transaction errors, print the differing error codes.
    - If there is a difference in compute units used, print the differing compute unit usage.
    - If there is a difference in instruction error index, print the differing indices.
- **Output**: No return value; outputs differences to the console or logs.


---
### fd\_solcap\_transaction\_solana\_diff<!-- {{#callable:fd_solcap_transaction_solana_diff}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_diff.c#L863>)

Compares a Solana transaction's execution results with expected results within a specified slot range and prints differences if any.
- **Inputs**:
    - ``transaction``: A pointer to an `fd_solcap_Transaction` structure containing transaction details.
    - ``start_slot``: The starting slot number for the comparison range.
    - ``end_slot``: The ending slot number for the comparison range.
- **Logic and Control Flow**:
    - Check if the transaction's slot is outside the specified range (`start_slot` to `end_slot`); if so, return immediately.
    - Check if both `solana_txn_err` and `solana_cus_used` are unpopulated (`ULONG_MAX`); if so, return without printing a diff.
    - If `solana_txn_err` is unpopulated (`ULONG_MAX`), set it to 0, indicating the transaction executed successfully.
    - Compare `fd_txn_err` with `solana_txn_err` and `fd_cus_used` with `solana_cus_used`; if they differ, print the transaction details and differences.
- **Output**: No return value; outputs differences to the standard output if applicable.


---
### fd\_solcap\_get\_transaction\_from\_iter<!-- {{#callable:fd_solcap_get_transaction_from_iter}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_diff.c#L906>)

Retrieves a transaction from an iterator and decodes its metadata.
- **Inputs**:
    - ``differ``: A pointer to an `fd_solcap_txn_differ_t` structure that contains transaction iterators, file pointers, and buffers for transaction metadata.
    - ``idx``: An unsigned long integer representing the index of the iterator and file to use within the `differ` structure.
- **Logic and Control Flow**:
    - Check if the iterator at the given index is done using [`fd_solcap_chunk_iter_done`](<fd_solcap_reader.c.md#fd_solcap_chunk_iter_done>); if so, return immediately.
    - Retrieve the current chunk from the iterator using [`fd_solcap_chunk_iter_item`](<fd_solcap_reader.h.md#fd_solcap_chunk_iter_item>).
    - Seek to the position in the file where the transaction metadata is located using `fseek`.
    - Read the transaction metadata into the buffer using `fread`.
    - Create a protobuf input stream from the buffer using `pb_istream_from_buffer`.
    - Decode the transaction metadata using `pb_decode` and store it in the `transaction` array of the `differ` structure.
    - Log an error and exit if any of the file operations or decoding fails.
- **Output**: No output is returned; the function updates the `transaction` field in the `differ` structure with the decoded transaction metadata.
- **Functions Called**:
    - [`fd_solcap_chunk_iter_done`](<fd_solcap_reader.c.md#fd_solcap_chunk_iter_done>)
    - [`fd_solcap_chunk_iter_item`](<fd_solcap_reader.h.md#fd_solcap_chunk_iter_item>)


---
### fd\_solcap\_transaction\_iter<!-- {{#callable:fd_solcap_transaction_iter}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_diff.c#L927>)

Iterates over transaction chunks in a transaction differ, processing each transaction until all chunks are processed.
- **Inputs**:
    - ``txn_differ``: A pointer to an `fd_solcap_txn_differ_t` structure that holds transaction differ data.
    - ``idx``: An unsigned long integer representing the index of the iterator to process.
- **Logic and Control Flow**:
    - While the iterator at `idx` is not done, continue processing.
    - Find the next transaction chunk address using [`fd_solcap_chunk_iter_find`](<fd_solcap_reader.h.md#fd_solcap_chunk_iter_find>).
    - Retrieve the transaction from the iterator using [`fd_solcap_get_transaction_from_iter`](<#fd_solcap_get_transaction_from_iter>).
    - Compare the transaction with Solana's result using [`fd_solcap_transaction_solana_diff`](<#fd_solcap_transaction_solana_diff>).
- **Output**: No return value; the function processes transactions and may produce output through logging or other side effects.
- **Functions Called**:
    - [`fd_solcap_chunk_iter_done`](<fd_solcap_reader.c.md#fd_solcap_chunk_iter_done>)
    - [`fd_solcap_chunk_iter_find`](<fd_solcap_reader.h.md#fd_solcap_chunk_iter_find>)
    - [`fd_solcap_get_transaction_from_iter`](<#fd_solcap_get_transaction_from_iter>)
    - [`fd_solcap_transaction_solana_diff`](<#fd_solcap_transaction_solana_diff>)


---
### fd\_solcap\_txn\_differ\_advance<!-- {{#callable:fd_solcap_txn_differ_advance}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_diff.c#L936>)

Advances the transaction differencing process by comparing transactions from two iterators and updating their states.
- **Inputs**:
    - ``txn_differ``: A pointer to an `fd_solcap_txn_differ_t` structure that holds the state of the transaction differencing process, including iterators, transaction data, and chunk addresses.
- **Logic and Control Flow**:
    - While both iterators in `txn_differ` are not done, perform the following steps:
    - Call [`fd_solcap_transaction_fd_diff`](<#fd_solcap_transaction_fd_diff>) to compare transactions from the two iterators and log any differences.
    - Call [`fd_solcap_transaction_solana_diff`](<#fd_solcap_transaction_solana_diff>) to compare the first transaction with Solana's result and log any differences.
    - Update `chunk_gaddr[0]` and `chunk_gaddr[1]` by finding the next transaction chunk in each iterator using [`fd_solcap_chunk_iter_find`](<fd_solcap_reader.h.md#fd_solcap_chunk_iter_find>).
    - Retrieve the next transaction from each iterator using [`fd_solcap_get_transaction_from_iter`](<#fd_solcap_get_transaction_from_iter>).
- **Output**: No return value; the function updates the state of `txn_differ` and logs differences between transactions.
- **Functions Called**:
    - [`fd_solcap_chunk_iter_done`](<fd_solcap_reader.c.md#fd_solcap_chunk_iter_done>)
    - [`fd_solcap_transaction_fd_diff`](<#fd_solcap_transaction_fd_diff>)
    - [`fd_solcap_transaction_solana_diff`](<#fd_solcap_transaction_solana_diff>)
    - [`fd_solcap_chunk_iter_find`](<fd_solcap_reader.h.md#fd_solcap_chunk_iter_find>)
    - [`fd_solcap_get_transaction_from_iter`](<#fd_solcap_get_transaction_from_iter>)


---
### fd\_solcap\_txn\_differ\_sync<!-- {{#callable:fd_solcap_txn_differ_sync}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_diff.c#L950>)

Synchronizes two transaction iterators to generate diffs against Solana's transactions.
- **Inputs**:
    - ``txn_differ``: A pointer to a `fd_solcap_txn_differ_t` structure that contains transaction iterators and related data for synchronization.
- **Logic and Control Flow**:
    - Initialize the first transaction for both files by finding the first transaction chunk using [`fd_solcap_chunk_iter_find`](<fd_solcap_reader.h.md#fd_solcap_chunk_iter_find>) and handle errors if any occur.
    - Retrieve the first transaction from both iterators using [`fd_solcap_get_transaction_from_iter`](<#fd_solcap_get_transaction_from_iter>).
    - Enter an infinite loop to process transactions until one of the iterators is done.
    - If one iterator is done, iterate through the remaining transactions of the other iterator using [`fd_solcap_transaction_iter`](<#fd_solcap_transaction_iter>).
    - If both iterators have transactions, compare their slots.
    - If slots are equal, advance both iterators using [`fd_solcap_txn_differ_advance`](<#fd_solcap_txn_differ_advance>).
    - If the slot of the first transaction is less than the second, advance the first iterator and generate a Solana diff using [`fd_solcap_transaction_solana_diff`](<#fd_solcap_transaction_solana_diff>).
    - If the slot of the second transaction is less than the first, advance the second iterator and generate a Solana diff using [`fd_solcap_transaction_solana_diff`](<#fd_solcap_transaction_solana_diff>).
- **Output**: No explicit return value; the function operates on the `txn_differ` structure to synchronize iterators and generate diffs.
- **Functions Called**:
    - [`fd_solcap_chunk_iter_find`](<fd_solcap_reader.h.md#fd_solcap_chunk_iter_find>)
    - [`fd_solcap_chunk_iter_err`](<fd_solcap_reader.h.md#fd_solcap_chunk_iter_err>)
    - [`fd_solcap_get_transaction_from_iter`](<#fd_solcap_get_transaction_from_iter>)
    - [`fd_solcap_chunk_iter_done`](<fd_solcap_reader.c.md#fd_solcap_chunk_iter_done>)
    - [`fd_solcap_transaction_iter`](<#fd_solcap_transaction_iter>)
    - [`fd_solcap_txn_differ_advance`](<#fd_solcap_txn_differ_advance>)
    - [`fd_solcap_transaction_solana_diff`](<#fd_solcap_transaction_solana_diff>)


---
### fd\_solcap\_transaction\_diff<!-- {{#callable:fd_solcap_transaction_diff}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_diff.c#L993>)

Compares transactions from two files and identifies differences.
- **Inputs**:
    - ``file_zero``: A pointer to the first file to compare.
    - ``file_one``: A pointer to the second file to compare.
- **Logic and Control Flow**:
    - Seek to the start of both files using `fseek` and log an error if it fails.
    - Read the file headers from both files using `fread` and log an error if it fails.
    - Seek to the first chunk in both files using `fseek` based on the header information and log an error if it fails.
    - Initialize a `fd_solcap_txn_differ_t` structure to manage the transaction comparison.
    - Create iterators for both files using `fd_solcap_chunk_iter_new`.
    - Synchronize and compare transactions using [`fd_solcap_txn_differ_sync`](<#fd_solcap_txn_differ_sync>).
- **Output**: No direct output is returned; differences are logged or printed.
- **Functions Called**:
    - [`fd_solcap_txn_differ_sync`](<#fd_solcap_txn_differ_sync>)


---
### fd\_solcap\_one\_file\_transaction\_diff<!-- {{#callable:fd_solcap_one_file_transaction_diff}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_diff.c#L1035>)

Processes a single file to find and report differences in transaction results within a specified slot range.
- **Inputs**:
    - ``file``: A pointer to a `FILE` object representing the file to process.
    - ``start_slot``: The starting slot number for the range of transactions to process.
    - ``end_slot``: The ending slot number for the range of transactions to process.
- **Logic and Control Flow**:
    - Reads the file header using `fread` and checks for errors.
    - Seeks to the first chunk in the file using `fseek` and checks for errors.
    - Initializes a chunk iterator using `fd_solcap_chunk_iter_new`.
    - Iterates through the chunks using a while loop and [`fd_solcap_chunk_iter_done`](<fd_solcap_reader.c.md#fd_solcap_chunk_iter_done>).
    - Finds the transaction chunk using [`fd_solcap_chunk_iter_find`](<fd_solcap_reader.h.md#fd_solcap_chunk_iter_find>) and checks for errors.
    - Reads transaction metadata from the file and checks for errors.
    - Deserializes the transaction metadata using `pb_decode` and checks for errors.
    - Checks if the transaction slot is within the specified range (`start_slot` to `end_slot`).
    - Calls [`fd_solcap_transaction_solana_diff`](<#fd_solcap_transaction_solana_diff>) to process and report differences in transaction results.
- **Output**: No return value; outputs differences in transaction results to standard output.
- **Functions Called**:
    - [`fd_solcap_chunk_iter_done`](<fd_solcap_reader.c.md#fd_solcap_chunk_iter_done>)
    - [`fd_solcap_chunk_iter_find`](<fd_solcap_reader.h.md#fd_solcap_chunk_iter_find>)
    - [`fd_solcap_chunk_iter_err`](<fd_solcap_reader.h.md#fd_solcap_chunk_iter_err>)
    - [`fd_solcap_chunk_iter_item`](<fd_solcap_reader.h.md#fd_solcap_chunk_iter_item>)
    - [`fd_solcap_transaction_solana_diff`](<#fd_solcap_transaction_solana_diff>)


---
### usage<!-- {{#callable:usage}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_diff.c#L1092>)

Prints usage instructions for the `fd_solcap_diff` command-line tool.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `fprintf` to print usage instructions to `stderr`.
    - The usage instructions include the command name, a brief description, and a list of options with their descriptions.
- **Output**: No output is returned as the function is of type `void`.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_diff.c#L1110>)

Processes command-line arguments, sets up resources, and performs file operations to compare and analyze capture files.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Iterates over command-line arguments to check for the `--help` flag and displays usage information if found.
    - Extracts various command-line options using `fd_env_strip_cmdline_*` functions, with default values for page size, page count, scratch memory size, verbosity, dump directory, start slot, and end slot.
    - Converts the page size string to an unsigned long using `fd_cstr_to_shmem_page_sz` and logs an error if the conversion fails.
    - Initializes an array `cap_path` to store file paths and checks for the number of capture files provided, logging an error if the count is incorrect.
    - Creates a new anonymous workspace using `fd_wksp_new_anonymous` and logs an error if it fails.
    - Allocates scratch memory using `fd_wksp_alloc_laddr` and logs an error if it fails.
    - Opens capture files for reading and logs an error if file opening fails.
    - Creates a dump directory if it does not exist and logs an error if directory creation fails.
    - Handles the case where only one file is provided by calling [`fd_solcap_one_file_transaction_diff`](<#fd_solcap_one_file_transaction_diff>) and performs cleanup before exiting.
    - Initializes a `fd_solcap_differ_t` structure for file comparison and logs an error if initialization fails.
    - Synchronizes the differ to the start slot using [`fd_solcap_differ_sync`](<#fd_solcap_differ_sync>) and logs an error if synchronization fails.
    - Iterates over slots, calling [`fd_solcap_diff_bank`](<#fd_solcap_diff_bank>) to check for mismatches and logs errors if synchronization fails.
    - If verbosity is high, calls [`fd_solcap_transaction_diff`](<#fd_solcap_transaction_diff>) to print transaction differences.
    - Performs cleanup by closing files, freeing memory, and halting the program.
- **Output**: Returns 0 if no mismatches are found, or 1 if mismatches are detected.
- **Functions Called**:
    - [`usage`](<#usage>)
    - [`fd_solcap_one_file_transaction_diff`](<#fd_solcap_one_file_transaction_diff>)
    - [`normalize_filename`](<#normalize_filename>)
    - [`fd_solcap_differ_new`](<#fd_solcap_differ_new>)
    - [`fd_solcap_differ_sync`](<#fd_solcap_differ_sync>)
    - [`fd_solcap_diff_bank`](<#fd_solcap_diff_bank>)
    - [`fd_solcap_transaction_diff`](<#fd_solcap_transaction_diff>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)