<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a capture writer for Solana bank hash pre-images and account changes, with functions for writing and managing data chunks in a file.

# Purpose
The code defines a C module for managing a capture writer, specifically for handling Solana bank hash pre-images and account changes. The primary structure, `fd_solcap_writer`, maintains the state of the capture writer, including file pointers and offsets for writing data chunks. The module provides functions to initialize, manage, and finalize the writing process, ensuring data is correctly serialized and written to a file. It uses the nanopb library for protocol buffer encoding, which is evident from the inclusion of `pb_encode.h` and the use of `pb_ostream_t` for encoding data structures into protocol buffers.

The module includes several functions for writing different types of data, such as accounts, bank pre-images, and transaction data, to a file. It uses macros like `FTELL_BAIL`, `FSEEK_BAIL`, and `FWRITE_BAIL` to handle file operations safely, logging errors and returning appropriate error codes if operations fail. The code also includes functions for managing stake rewards and payouts, which are serialized and written using protocol buffers. The module is designed to be used in a hosted environment, as indicated by the preprocessor directive checking for `FD_HAS_HOSTED`.
# Imports and Dependencies

---
- `fd_solcap_writer.h`
- `fd_solcap.pb.h`
- `fd_solcap_proto.h`
- `../../ballet/nanopb/pb_encode.h`
- `../../ballet/blake3/fd_blake3.h`
- `errno.h`
- `stdio.h`


# Data Structures

---
### fd\_solcap\_writer
- **Type**: ``struct``
- **Members**:
    - ``file``: Pointer to a `FILE` object for file operations.
    - ``stream_goff``: Offset in bytes from the start of the file to the start of the stream.
    - ``slot``: Current slot number being processed.
    - ``accounts``: Array of account table entries with a fixed size of `FD_SOLCAP_ACC_TBL_CNT`.
    - ``account_idx``: Index indicating the current position in the accounts array.
    - ``account_table_goff``: Offset in bytes to the account table within the file.
    - ``first_slot``: Slot number of the first slot processed.
- **Description**: Manages the state of a capture writer for recording bank hash pre-images and changed accounts. It maintains file pointers, offsets, and account table information to facilitate writing data to a file in a structured format. The structure supports operations such as setting slots, writing account data, and flushing account tables to ensure data integrity and proper sequencing in the capture process.


# Functions

---
### \_skip\_file<!-- {{#callable:_skip_file}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_writer.c#L102>)

Writes a specified number of zero bytes to a file.
- **Inputs**:
    - `file`: A pointer to a `FILE` object where the zeros will be written.
    - `skip`: The number of zero bytes to write to the file.
- **Logic and Control Flow**:
    - Check if `skip` is zero; if so, return 0 immediately.
    - Declare an array `zero` of size `skip` and initialize it with zeros using `fd_memset`.
    - Use the `FWRITE_BAIL` macro to write the `zero` array to the file, handling any errors that occur during the write operation.
    - Return 0 after successfully writing the zeros.
- **Output**: Returns 0 after writing the specified number of zero bytes to the file.


---
### \_align\_file<!-- {{#callable:_align_file}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_writer.c#L123>)

Pads a file with zeros to align its position to a specified boundary.
- **Inputs**:
    - `file`: A pointer to a `FILE` object representing the file to align.
    - `align`: An unsigned long integer specifying the alignment boundary, which must be a positive power of two.
- **Logic and Control Flow**:
    - Get the current position in the file using `FTELL_BAIL` macro, which calls `ftell` and handles errors.
    - Calculate the number of bytes needed to align the file position using `fd_ulong_align_up` to find the next alignment boundary and subtracting the current position.
    - Call [`_skip_file`](<#_skip_file>) to write the calculated number of zero bytes to the file, effectively aligning the file position.
- **Output**: Returns an integer status code, where 0 indicates success and a non-zero value indicates an error.
- **Functions Called**:
    - [`_skip_file`](<#_skip_file>)


---
### fd\_solcap\_writer\_align<!-- {{#callable:fd_solcap_writer_align}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_writer.c#L138>)

Returns the alignment requirement of the `fd_solcap_writer_t` type.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls the `alignof` operator on `fd_solcap_writer_t` to determine its alignment requirement.
    - Returns the result of the `alignof` operation.
- **Output**: An `unsigned long` representing the alignment requirement of `fd_solcap_writer_t`.


---
### fd\_solcap\_writer\_footprint<!-- {{#callable:fd_solcap_writer_footprint}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_writer.c#L143>)

Calculates the memory footprint of the `fd_solcap_writer_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Return the size of the `fd_solcap_writer_t` structure using the `sizeof` operator.
- **Output**: Returns an `ulong` representing the size of the `fd_solcap_writer_t` structure.


---
### fd\_solcap\_writer\_new<!-- {{#callable:fd_solcap_writer_new}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_writer.c#L148>)

Initializes a memory block for a `fd_solcap_writer_t` structure and returns a pointer to it.
- **Inputs**:
    - `mem`: A pointer to a memory block where the `fd_solcap_writer_t` structure will be initialized.
- **Logic and Control Flow**:
    - Check if `mem` is NULL; if true, log a warning and return NULL.
    - Use `memset` to zero out the memory block pointed to by `mem` for the size of `fd_solcap_writer_t`.
    - Cast the `mem` pointer to `fd_solcap_writer_t *` and return it.
- **Output**: A pointer to the initialized `fd_solcap_writer_t` structure, or NULL if `mem` is NULL.


---
### fd\_solcap\_writer\_delete<!-- {{#callable:fd_solcap_writer_delete}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_writer.c#L160>)

Sets the `file` member of a `fd_solcap_writer_t` structure to `NULL` and returns the writer.
- **Inputs**:
    - `writer`: A pointer to a `fd_solcap_writer_t` structure that represents the writer to delete.
- **Logic and Control Flow**:
    - Check if `writer` is `NULL` using `FD_UNLIKELY`; if true, return `NULL`.
    - Set the `file` member of `writer` to `NULL`.
    - Return the `writer`.
- **Output**: Returns the `writer` pointer after setting its `file` member to `NULL`, or `NULL` if the input `writer` is `NULL`.


---
### fd\_solcap\_writer\_init<!-- {{#callable:fd_solcap_writer_init}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_writer.c#L170>)

Initializes a `fd_solcap_writer_t` structure for writing to a specified file by setting up file headers and storing the initial file position.
- **Inputs**:
    - `writer`: A pointer to a `fd_solcap_writer_t` structure that will be initialized.
    - `file`: A pointer to a file object where the writer will write data.
- **Logic and Control Flow**:
    - Check if `writer` is NULL; if so, log a warning and return NULL.
    - Check if `file` is NULL; if so, log a warning and return NULL.
    - Get the current position in the file using `ftell`; if it fails, log a warning and return NULL.
    - Write a zero-initialized header of size `FD_SOLCAP_FHDR_SZ` to the file; if it fails, log a warning and return NULL.
    - Set the `file` and `stream_goff` fields of the `writer` structure.
    - Return the initialized `writer`.
- **Output**: Returns a pointer to the initialized `fd_solcap_writer_t` structure, or NULL if an error occurs.


---
### fd\_solcap\_writer\_flush<!-- {{#callable:fd_solcap_writer_flush}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_writer.c#L208>)

Flushes the file stream, writes file headers, and restores the stream cursor for a given writer.
- **Inputs**:
    - `writer`: A pointer to an `fd_solcap_writer_t` structure that contains the state of the capture writer, including the file stream to flush and write headers to.
- **Logic and Control Flow**:
    - Check if `writer` is NULL and return NULL if true.
    - Flush the file stream associated with `writer`.
    - Get the current position of the file stream cursor using `ftell` and log a warning and return NULL if it fails.
    - Construct a `fd_solcap_FileMeta` structure with metadata about the file, including the first slot and slot count.
    - Encode the file metadata into a buffer using `pb_encode` and log a warning and return NULL if it fails.
    - Construct a `fd_solcap_fhdr_t` structure with file header information, including magic number, chunk offset, and metadata size.
    - Seek to the beginning of the stream offset in the file and log a warning and return NULL if it fails.
    - Write the file header to the file and log a warning and return NULL if it fails.
    - Write the encoded file metadata to the file and log a warning and return NULL if it fails.
    - Restore the file stream cursor to its original position and log a warning and return NULL if it fails.
    - Return the `writer` pointer.
- **Output**: Returns the `fd_solcap_writer_t` pointer if successful, or NULL if an error occurs.


---
### fd\_solcap\_flush\_account\_table<!-- {{#callable:fd_solcap_flush_account_table}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_writer.c#L275>)

Flushes the buffered account table to the file stream if there are accounts to write and handles chunk metadata serialization.
- **Inputs**:
    - `writer`: A pointer to `fd_solcap_writer_t`, which contains the state of the capture writer, including the file stream and account table information.
- **Logic and Control Flow**:
    - Check if `writer->account_idx` is zero; if so, return 0 as there are no accounts to flush.
    - Check if `writer->account_idx` exceeds or equals `FD_SOLCAP_ACC_TBL_CNT`; if so, log a warning, reset `writer->account_idx` to zero, and return 0.
    - Get the current file offset using `FTELL_BAIL` and skip space for the chunk header using `FSKIP_BAIL`.
    - Adjust each account's `acc_coff` in `writer->accounts` to be relative to the current chunk offset.
    - Write the account table to the file using `FWRITE_BAIL`.
    - Serialize the account chunk metadata into a buffer and write it to the file, aligning the file afterwards using `FALIGN_BAIL`.
    - Get the end offset of the chunk and prepare the chunk header with metadata offsets and sizes.
    - Write the chunk header to the file and restore the file cursor to the end of the chunk.
    - Reset `writer->account_table_goff` to the start of the chunk and `writer->account_idx` to zero for the next iteration.
- **Output**: Returns 0 on success, or an error code if any file operation fails.


---
### fd\_solcap\_write\_account<!-- {{#callable:fd_solcap_write_account}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_writer.c#L358>)

Writes an account record to a capture writer using provided metadata and data.
- **Inputs**:
    - ``writer``: A pointer to an `fd_solcap_writer_t` structure, representing the capture writer to which the account data will be written.
    - ``key``: A pointer to a constant memory location containing the account key, expected to be 32 bytes in size.
    - ``meta``: A pointer to a constant `fd_solana_account_meta_t` structure containing metadata about the account, such as lamports and executable status.
    - ``data``: A pointer to a constant memory location containing the account data to be written.
    - ``data_sz``: An unsigned long integer representing the size of the account data in bytes.
- **Logic and Control Flow**:
    - Check if `writer` is NULL; if so, return 0 immediately.
    - Initialize a local `fd_solcap_account_tbl_t` record and set its memory to zero.
    - Copy the 32-byte `key` into the `key` field of the local record.
    - Initialize a local `fd_solcap_AccountMeta` structure with values from `meta` and `data_sz`.
    - Copy the 32-byte `owner` from `meta` into the `owner` field of the local `meta_pb` structure.
    - Call [`fd_solcap_write_account2`](<#fd_solcap_write_account2>) with the initialized structures and data, returning its result.
- **Output**: Returns an integer status code, typically 0 for success or an error code if the operation fails.
- **Functions Called**:
    - [`fd_solcap_write_account2`](<#fd_solcap_write_account2>)


---
### fd\_solcap\_write\_account2<!-- {{#callable:fd_solcap_write_account2}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_writer.c#L381>)

Writes account data and metadata to a file, updating the writer's state accordingly.
- **Inputs**:
    - `writer`: A pointer to an `fd_solcap_writer_t` structure that manages the state of the capture writer.
    - `tbl`: A constant pointer to an `fd_solcap_account_tbl_t` structure containing account table information.
    - `meta_pb`: A pointer to an `fd_solcap_AccountMeta` structure that will be populated with metadata for the account.
    - `data`: A constant pointer to the data to be written to the file.
    - `data_sz`: The size of the data to be written, in bytes.
- **Logic and Control Flow**:
    - Check if `writer` is NULL and return 0 if true.
    - Get the current file offset using `FTELL_BAIL` and store it in `chunk_goff`.
    - Skip the size of `fd_solcap_chunk_t` in the file using `FSKIP_BAIL`.
    - Write the `data` to the file and align the file to an 8-byte boundary using `FALIGN_BAIL`.
    - Get the current file offset for metadata using `FTELL_BAIL` and store it in `meta_goff`.
    - Populate `meta_pb` with the current slot, data offset, and data size.
    - Encode `meta_pb` into a buffer and write it to the file, aligning again to an 8-byte boundary.
    - If the writer's account index is less than `FD_SOLCAP_ACC_TBL_CNT`, update the account table with the current account information and store the global offset.
    - Get the end file offset using `FTELL_BAIL` and calculate the chunk header information.
    - Write the chunk header to the file and restore the file cursor to the end of the chunk.
    - Increment the writer's account index by 1.
- **Output**: Returns 0 on success, or an error code if any file operation fails.


---
### fd\_solcap\_writer\_set\_slot<!-- {{#callable:fd_solcap_writer_set_slot}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_writer.c#L458>)

Sets the current slot for the writer and resets the account table buffer.
- **Inputs**:
    - ``writer``: A pointer to an `fd_solcap_writer_t` structure, representing the state of a capture writer.
    - ``slot``: An unsigned long integer representing the new slot number to set for the writer.
- **Logic and Control Flow**:
    - Checks if `writer` is not NULL using `FD_LIKELY`; if it is NULL, the function returns immediately.
    - Resets the `account_table_goff` and `account_idx` fields of the `writer` to 0, effectively discarding the current account table buffer.
    - Sets the `slot` field of the `writer` to the provided `slot` value.
- **Output**: No output is returned as the function has a void return type.


---
### fd\_solcap\_write\_bank\_preimage<!-- {{#callable:fd_solcap_write_bank_preimage}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_writer.c#L470>)

Writes a bank preimage to a writer object, including various hash values and a signature count.
- **Inputs**:
    - ``writer``: A pointer to an `fd_solcap_writer_t` structure, which manages the state of the capture writer.
    - ``bank_hash``: A pointer to a 32-byte hash representing the current bank state.
    - ``prev_bank_hash``: A pointer to a 32-byte hash representing the previous bank state.
    - ``account_delta_hash``: A pointer to a 32-byte hash representing the account delta, or `NULL` if not available.
    - ``accounts_lt_hash_checksum``: A pointer to a 32-byte hash checksum for accounts, or `NULL` if not available.
    - ``poh_hash``: A pointer to a 32-byte hash representing the Proof of History (PoH) state.
    - ``signature_cnt``: An unsigned long integer representing the number of signatures.
- **Logic and Control Flow**:
    - Check if `writer` is `NULL`; if so, return 0.
    - Initialize a `fd_solcap_BankPreimage` structure and set its `signature_cnt` and `account_cnt` fields.
    - Copy the `bank_hash`, `prev_bank_hash`, and `poh_hash` into the `preimage_pb` structure.
    - If `account_delta_hash` is not `NULL`, copy it into `preimage_pb`; otherwise, set the field to zero.
    - If `accounts_lt_hash_checksum` is not `NULL`, copy it into `preimage_pb`; otherwise, set the field to zero.
    - Call [`fd_solcap_write_bank_preimage2`](<#fd_solcap_write_bank_preimage2>) with `writer` and `preimage_pb` to write the preimage.
- **Output**: Returns the result of [`fd_solcap_write_bank_preimage2`](<#fd_solcap_write_bank_preimage2>), which is an integer status code.
- **Functions Called**:
    - [`fd_solcap_write_bank_preimage2`](<#fd_solcap_write_bank_preimage2>)


---
### fd\_solcap\_write\_bank\_preimage2<!-- {{#callable:fd_solcap_write_bank_preimage2}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_writer.c#L500>)

Writes a bank preimage to a file, including flushing the account table and serializing the preimage data.
- **Inputs**:
    - ``writer``: A pointer to an `fd_solcap_writer_t` structure, which manages the state of the capture writer.
    - ``preimage_pb``: A pointer to an `fd_solcap_BankPreimage` structure, which contains the bank preimage data to be written.
- **Logic and Control Flow**:
    - Check if `writer` is NULL; if so, return 0.
    - Call [`fd_solcap_flush_account_table`](<#fd_solcap_flush_account_table>) to flush the account table; if it returns an error, return that error.
    - Determine the current file offset using `FTELL_BAIL` and leave space for the chunk header using `FSKIP_BAIL`.
    - Update `preimage_pb` with the current slot and account table offset if applicable.
    - Serialize the `preimage_pb` structure into a buffer using `pb_encode`.
    - Write the serialized preimage data to the file using `FWRITE_BAIL` and align the file using `FALIGN_BAIL`.
    - Determine the end file offset using `FTELL_BAIL`.
    - Create a `fd_solcap_chunk_t` structure to represent the chunk header, including metadata offsets and sizes.
    - Write the chunk header to the file using `FSEEK_BAIL` and `FWRITE_BAIL`.
    - Restore the file cursor to the end of the chunk using `FSEEK_BAIL`.
- **Output**: Returns 0 on success or an error code if an operation fails.
- **Functions Called**:
    - [`fd_solcap_flush_account_table`](<#fd_solcap_flush_account_table>)


---
### fd\_solcap\_write\_transaction2<!-- {{#callable:fd_solcap_write_transaction2}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_writer.c#L554>)

Writes a serialized transaction to a file and updates the file with a chunk header.
- **Inputs**:
    - ``writer``: A pointer to an `fd_solcap_writer_t` structure that manages the file writing process.
    - ``txn``: A pointer to an `fd_solcap_Transaction` structure that contains the transaction data to be serialized and written.
- **Logic and Control Flow**:
    - Check if `writer` is NULL and return 0 if true.
    - Get the current file offset using `FTELL_BAIL` and store it in `chunk_goff`.
    - Skip space for the chunk header using `FSKIP_BAIL`.
    - Serialize the transaction using `pb_encode` and write it to the file using `FWRITE_BAIL`.
    - Align the file to an 8-byte boundary using `FALIGN_BAIL`.
    - Get the new file offset using `FTELL_BAIL` and store it in `chunk_end_goff`.
    - Create a `fd_solcap_chunk_t` structure with metadata about the transaction chunk.
    - Seek back to `chunk_goff` and write the chunk header using `FWRITE_BAIL`.
    - Restore the file cursor to `chunk_end_goff` using `FSEEK_BAIL`.
- **Output**: Returns 0 on success or an error code if any file operation fails.


---
### fd\_solcap\_writer\_stake\_rewards\_begin<!-- {{#callable:fd_solcap_writer_stake_rewards_begin}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_writer.c#L591>)

Begins the process of writing stake reward epoch data to a protobuf stream.
- **Inputs**:
    - `writer`: A pointer to an `fd_solcap_writer_t` structure that manages the state of the capture writer.
    - `payout_epoch`: An unsigned long integer representing the epoch in which the payout occurs.
    - `reward_epoch`: An unsigned long integer representing the epoch for which the reward is calculated.
    - `inflation_lamports`: An unsigned long integer representing the number of lamports generated by inflation.
    - `total_points`: A 128-bit unsigned integer representing the total points for the reward calculation.
- **Logic and Control Flow**:
    - Initializes a `fd_solcap_StakeRewardEpoch` structure with the provided `payout_epoch`, `reward_epoch`, and `inflation_lamports` values.
    - Stores the `total_points` value into the `points` field of the `epoch_pb` structure using the `FD_STORE` macro.
    - Calls [`fd_solcap_write_protobuf`](<#fd_solcap_write_protobuf>) to write the `epoch_pb` structure to the protobuf stream, using `fd_solcap_StakeRewardEpoch_fields` and `FD_SOLCAP_V1_REWARD_BEGIN_MAGIC` as parameters.
- **Output**: Returns the result of the [`fd_solcap_write_protobuf`](<#fd_solcap_write_protobuf>) function call, which is an integer indicating success or failure.
- **Functions Called**:
    - [`fd_solcap_write_protobuf`](<#fd_solcap_write_protobuf>)


---
### fd\_solcap\_write\_stake\_reward\_event<!-- {{#callable:fd_solcap_write_stake_reward_event}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_writer.c#L608>)

Writes a stake reward event to a protobuf stream using the provided writer and event details.
- **Inputs**:
    - ``writer``: A pointer to an `fd_solcap_writer_t` structure that manages the output stream.
    - ``stake_acc_addr``: A pointer to a `fd_pubkey_t` structure representing the stake account address.
    - ``vote_acc_addr``: A pointer to a `fd_pubkey_t` structure representing the vote account address.
    - ``commission``: An unsigned integer representing the commission percentage.
    - ``vote_rewards``: A long integer representing the vote rewards.
    - ``stake_rewards``: A long integer representing the stake rewards.
    - ``new_credits_observed``: A long integer representing the new credits observed.
- **Logic and Control Flow**:
    - Initializes an `fd_solcap_StakeRewardEvent` structure with the provided commission, vote rewards, stake rewards, and new credits observed.
    - Copies the `stake_acc_addr` and `vote_acc_addr` into the `stake_account_address` and `vote_account_address` fields of the event, respectively, using `memcpy`.
    - Calls [`fd_solcap_write_protobuf`](<#fd_solcap_write_protobuf>) to write the event to the protobuf stream, passing the writer, event, event fields descriptor, and a magic number `FD_SOLCAP_V1_REWARD_CALC_MAGIC`.
- **Output**: Returns the result of the [`fd_solcap_write_protobuf`](<#fd_solcap_write_protobuf>) function call, which is an integer indicating success or failure.
- **Functions Called**:
    - [`fd_solcap_write_protobuf`](<#fd_solcap_write_protobuf>)


---
### fd\_solcap\_write\_vote\_account\_payout<!-- {{#callable:fd_solcap_write_vote_account_payout}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_writer.c#L629>)

Writes a vote account payout to a protobuf stream using the provided writer and payout details.
- **Inputs**:
    - ``writer``: A pointer to an `fd_solcap_writer_t` structure that manages the output stream.
    - ``vote_acc_addr``: A pointer to a `fd_pubkey_t` structure representing the address of the vote account.
    - ``update_slot``: An unsigned long integer representing the slot number for the update.
    - ``lamports``: An unsigned long integer representing the number of lamports in the payout.
    - ``lamports_delta``: A long integer representing the change in lamports since the last update.
- **Logic and Control Flow**:
    - Initialize a `fd_solcap_VoteAccountPayout` structure with `update_slot`, `lamports`, and `lamports_delta`.
    - Copy the `vote_acc_addr` into the `address` field of the `payout` structure.
    - Call [`fd_solcap_write_protobuf`](<#fd_solcap_write_protobuf>) with the `writer`, `payout`, `fd_solcap_VoteAccountPayout_fields`, and `FD_SOLCAP_V1_REWARD_VOTE_MAGIC` to write the payout data to the protobuf stream.
- **Output**: Returns the result of the [`fd_solcap_write_protobuf`](<#fd_solcap_write_protobuf>) function call, which is an integer indicating success or failure.
- **Functions Called**:
    - [`fd_solcap_write_protobuf`](<#fd_solcap_write_protobuf>)


---
### fd\_solcap\_write\_stake\_account\_payout<!-- {{#callable:fd_solcap_write_stake_account_payout}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_writer.c#L646>)

Writes a stake account payout to a protobuf stream using the provided writer and payout details.
- **Inputs**:
    - ``writer``: A pointer to an `fd_solcap_writer_t` structure that manages the output stream.
    - ``stake_acc_addr``: A pointer to a `fd_pubkey_t` structure representing the stake account address.
    - ``update_slot``: An unsigned long integer representing the slot number for the update.
    - ``lamports``: An unsigned long integer representing the total lamports in the stake account.
    - ``lamports_delta``: A long integer representing the change in lamports since the last update.
    - ``credits_observed``: An unsigned long integer representing the credits observed in the stake account.
    - ``credits_observed_delta``: A long integer representing the change in credits observed since the last update.
    - ``delegation_stake``: An unsigned long integer representing the total delegation stake.
    - ``delegation_stake_delta``: A long integer representing the change in delegation stake since the last update.
- **Logic and Control Flow**:
    - Initializes a `fd_solcap_StakeAccountPayout` structure with the provided payout details.
    - Copies the `stake_acc_addr` into the `payout.address` field using `memcpy`.
    - Calls [`fd_solcap_write_protobuf`](<#fd_solcap_write_protobuf>) to write the `payout` structure to the protobuf stream, passing the writer, payout, field descriptor, and magic number.
- **Output**: Returns the result of the [`fd_solcap_write_protobuf`](<#fd_solcap_write_protobuf>) function call, which is an integer indicating success or failure.
- **Functions Called**:
    - [`fd_solcap_write_protobuf`](<#fd_solcap_write_protobuf>)


---
### fd\_solcap\_write\_protobuf<!-- {{#callable:fd_solcap_write_protobuf}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_writer.c#L671>)

Encodes a message into a protobuf format and writes it to a file with a specified magic number.
- **Inputs**:
    - `writer`: A pointer to an `fd_solcap_writer_t` structure that manages the file writing process.
    - `msg`: A pointer to the message data to encode and write.
    - `desc`: A pointer to a `pb_msgdesc_s` structure that describes the protobuf message format.
    - `magic`: An unsigned long integer representing a magic number to include in the written chunk.
- **Logic and Control Flow**:
    - Check if `writer` is NULL and return 0 if true.
    - Create a buffer `buf` of size 1MB to hold the encoded message.
    - Initialize a `pb_ostream_t` stream from the buffer.
    - Attempt to encode the message using `pb_encode`; if it fails, log a warning and return `EPROTO`.
    - Create a `fd_solcap_chunk_t` structure with the provided `magic` number, metadata offset, metadata size, and total size.
    - Write the `fd_solcap_chunk_t` structure to the file using `FWRITE_BAIL`.
    - Write the encoded message from the buffer to the file using `FWRITE_BAIL`.
    - Return 0 to indicate success.
- **Output**: Returns 0 on success or `EPROTO` if encoding fails.



---
Made with ❤️ by [Driver](https://www.driver.ai/)