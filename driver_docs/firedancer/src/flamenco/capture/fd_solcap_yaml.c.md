<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Converts runtime capture files to YAML format with options for verbosity and filtering by slot range.

# Purpose
The code is a C program designed to read and process a runtime capture file, converting its contents into a YAML format. The program is structured to handle different types of data chunks within the file, specifically focusing on account and transaction data. It includes functions to process individual accounts, account tables, banks, and transactions, each of which reads specific metadata and data from the file, decodes it using Protocol Buffers, and formats it for output. The program supports various verbosity levels, allowing users to control the amount of detail included in the YAML output.

The main function handles command-line arguments to configure the program's behavior, such as verbosity level and slot range for processing. It opens the specified file, reads its header, and iterates through the data chunks. Depending on the type of chunk, it calls the appropriate processing function. The program uses several external libraries and headers, such as `fd_solcap_proto.h` and `pb_decode.h`, to handle specific tasks like decoding Protocol Buffers and encoding data in Base64. The program is intended to be executed as a standalone application, providing a command-line interface for users to specify options and the file to process.
# Imports and Dependencies

---
- `fd_solcap_proto.h`
- `fd_solcap_reader.h`
- `fd_solcap.pb.h`
- `../runtime/fd_executor_err.h`
- `../../ballet/base64/fd_base64.h`
- `../../ballet/nanopb/pb_decode.h`
- `errno.h`
- `stdio.h`


# Data Structures

---
### account\_entry\_info\_t
- **Type**: ``struct``
- **Members**:
    - ``entry``: Holds an account table entry of type `fd_solcap_account_tbl_t`.
    - ``acc_coff``: Stores the account offset as a `long` integer.
    - ``is_last_occurrence``: Indicates if this is the last occurrence of the account with an `int` flag.
- **Description**: Encapsulates information about an account entry, including its table entry, offset, and a flag to denote if it is the last occurrence of the account in a sequence.


# Functions

---
### usage<!-- {{#callable:usage}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_yaml.c#L10>)

Prints usage instructions for the `fd_solcap_yaml` command to the standard error stream.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `fprintf` to print usage instructions to `stderr`.
    - Returns 0 to indicate successful execution.
- **Output**: Returns an integer value 0, indicating successful execution.


---
### process\_account<!-- {{#callable:process_account}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_yaml.c#L31>)

Reads and processes an account from a file, printing metadata and optionally the account data in Base64 format.
- **Inputs**:
    - ``file``: A pointer to a `FILE` object representing the file to read the account data from.
    - ``goff``: A `long` integer representing the offset in the file where the account data starts.
    - ``verbose``: An `int` that determines the verbosity level; if `verbose` is 4 or higher, the function will print the account data in Base64 format.
- **Logic and Control Flow**:
    - Store the current position of the file stream using `ftell` and log an error if it fails.
    - Seek to the specified offset `goff` in the file using `fseek` and log an error if it fails.
    - Read a chunk of data into a `fd_solcap_chunk_t` structure and verify its magic number; log an error if reading fails or the magic number is incorrect.
    - Read account metadata into a `fd_solcap_AccountMeta` structure, handling errors in size, seeking, reading, and decoding.
    - Print the account metadata including owner, lamports, slot, executable status, and data size.
    - If `verbose` is 4 or higher, seek to the account data, read it in parts, encode it in Base64, and print it.
    - Restore the file stream to its original position using `fseek` and log an error if it fails.
    - Return 1 to indicate success.
- **Output**: Returns an `int` value of 1 on success, or 0 if any error occurs during processing.


---
### process\_account\_table<!-- {{#callable:process_account_table}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_yaml.c#L160>)

Reads and processes an account table chunk from a file, optionally printing account metadata and data, and restores the file cursor to its original position.
- **Inputs**:
    - ``file``: A pointer to a `FILE` object representing the file to read the account table from.
    - ``slot``: An unsigned long integer representing the slot number for the account table.
    - ``verbose``: An integer that controls the verbosity level of the output, with higher values providing more detailed information.
    - ``show_duplicate_accounts``: An integer flag indicating whether to show duplicate accounts in the output.
- **Logic and Control Flow**:
    - Store the current position of the file cursor using `ftell` and check for errors.
    - Read a chunk from the file and verify its magic number to ensure it is an account table chunk.
    - Read the metadata associated with the chunk, checking for errors in size and decoding.
    - Seek to the account table position in the file using metadata offsets.
    - Allocate memory for account entries and read each entry from the file, storing its offset and marking it as the last occurrence by default.
    - Identify duplicate accounts by comparing keys and update the `is_last_occurrence` flag accordingly.
    - Iterate over the account entries, printing each entry's public key and explorer link in YAML format, and optionally process account details if verbosity is high.
    - Free the allocated memory for account entries.
    - Restore the file cursor to its original position using `fseek`.
- **Output**: Returns 0 on failure, indicating an error occurred during processing.
- **Functions Called**:
    - [`process_account`](<#process_account>)


---
### process\_bank<!-- {{#callable:process_bank}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_yaml.c#L307>)

Reads and processes a bank chunk from a file, deserializes its metadata, and optionally processes its account table based on verbosity and slot range.
- **Inputs**:
    - ``chunk``: A pointer to a `fd_solcap_chunk_t` structure containing metadata about the bank chunk.
    - ``file``: A pointer to a `FILE` object representing the open file from which to read the bank chunk.
    - ``verbose``: An integer indicating the verbosity level for output.
    - ``show_duplicate_accounts``: An integer flag indicating whether to show duplicate accounts.
    - ``chunk_gaddr``: A long integer representing the global address offset of the chunk in the file.
    - ``start_slot``: An unsigned long integer specifying the start slot for processing.
    - ``end_slot``: An unsigned long integer specifying the end slot for processing.
    - ``has_txns``: An integer flag indicating whether transactions are present.
- **Logic and Control Flow**:
    - Checks if the `meta_sz` of the chunk exceeds the defined footprint and logs an error if true.
    - Seeks to the position in the file where the bank preimage metadata is located and reads it into a buffer.
    - Deserializes the bank preimage metadata from the buffer using `pb_decode`.
    - Checks if the slot in the metadata is within the specified range (`start_slot` to `end_slot`); if not, returns 0.
    - Prints the slot and bank hash in YAML format if verbosity is less than 4 or if there are no transactions.
    - If verbosity is 2 or higher, prints additional metadata fields in YAML format.
    - If verbosity is 3 or higher, checks if account information is available and processes the account table if it is.
    - Returns 0 on successful completion or an error code if an error occurs during processing.
- **Output**: Returns 0 on success or an error code if an error occurs during processing.
- **Functions Called**:
    - [`process_account_table`](<#process_account_table>)


---
### process\_txn<!-- {{#callable:process_txn}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_yaml.c#L394>)

Processes a transaction chunk by reading, deserializing, and printing transaction metadata in YAML format if verbosity is high enough.
- **Inputs**:
    - `chunk`: A pointer to a `fd_solcap_chunk_t` structure containing transaction metadata.
    - `file`: A pointer to a `FILE` object representing the file from which to read transaction data.
    - `verbose`: An integer indicating the verbosity level for output.
    - `chunk_gaddr`: A long integer representing the global address offset for the chunk in the file.
    - `prev_slot`: An unsigned long integer representing the previous slot number processed.
    - `start_slot`: An unsigned long integer indicating the start slot for processing transactions.
    - `end_slot`: An unsigned long integer indicating the end slot for processing transactions.
- **Logic and Control Flow**:
    - Checks if `verbose` is less than 4; if so, returns 0 immediately.
    - Defines a constant `FD_SOLCAP_TRANSACTION_FOOTPRINT` for the maximum allowed transaction metadata size.
    - Checks if `chunk->meta_sz` exceeds `FD_SOLCAP_TRANSACTION_FOOTPRINT`; logs an error if true.
    - Seeks to the transaction metadata offset in the file and reads the metadata into `meta_buf`.
    - Deserializes the transaction metadata from `meta_buf` into a `fd_solcap_Transaction` structure.
    - Checks if the transaction's slot is outside the range `[start_slot, end_slot]`; returns the slot if true.
    - Prints transaction metadata in YAML format, including transaction signature, error codes, and resource usage.
    - Checks if `meta.fd_txn_err` equals `FD_EXECUTOR_INSTR_ERR_CUSTOM_ERR`; prints custom error if true.
    - If `verbose` is less than 4, returns the transaction slot.
    - Prints additional Solana-specific transaction error and resource usage if they are not `ULONG_MAX`.
    - Prints URLs for transaction explorers using the transaction signature.
    - Returns the transaction slot.
- **Output**: Returns the slot number of the processed transaction as an unsigned long integer.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_yaml.c#L480>)

Processes command-line arguments, reads a file, and processes its contents based on specified options.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Iterates over command-line arguments to check for the `--help` flag and calls [`usage`](<#usage>) if found.
    - Extracts verbosity level, duplicate account display option, start slot, and end slot from command-line arguments using `fd_env_strip_cmdline_*` functions.
    - Checks if the number of arguments is exactly 2, otherwise prints an error and calls [`usage`](<#usage>).
    - Opens the file specified in the command-line arguments for reading in binary mode.
    - Reads the file header into `fd_solcap_fhdr_t` structure and checks for read errors.
    - Seeks to the first chunk in the file using the offset from the file header.
    - Initializes a chunk iterator and iterates over chunks in the file.
    - Processes each chunk based on its magic number using [`process_bank`](<#process_bank>) or [`process_txn`](<#process_txn>) functions.
    - Logs completion notice, closes the file, and calls `fd_halt` to clean up.
- **Output**: Returns 0 on successful completion or an error code if an error occurs during execution.
- **Functions Called**:
    - [`usage`](<#usage>)
    - [`fd_solcap_chunk_iter_next`](<fd_solcap_reader.c.md#fd_solcap_chunk_iter_next>)
    - [`fd_solcap_chunk_iter_err`](<fd_solcap_reader.h.md#fd_solcap_chunk_iter_err>)
    - [`fd_solcap_chunk_iter_done`](<fd_solcap_reader.c.md#fd_solcap_chunk_iter_done>)
    - [`fd_solcap_chunk_iter_item`](<fd_solcap_reader.h.md#fd_solcap_chunk_iter_item>)
    - [`process_bank`](<#process_bank>)
    - [`process_txn`](<#process_txn>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)