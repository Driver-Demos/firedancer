<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for reading and decoding Solana capture data from files using Protobuf.

# Purpose
The code is a C source file that provides functionality for reading and processing data chunks from a file stream, specifically related to Solana's Solcap data structures. It includes functions to iterate over chunks, read specific data structures like bank preimages and account tables, and find account metadata within a file. The file uses Protobuf for data serialization and deserialization, as indicated by the inclusion of `pb_decode.h` and the use of `pb_decode` function calls.

The main components of the code include functions such as [`fd_solcap_chunk_iter_new`](<#fd_solcap_chunk_iter_new>), [`fd_solcap_chunk_iter_next`](<#fd_solcap_chunk_iter_next>), and [`fd_solcap_chunk_iter_done`](<#fd_solcap_chunk_iter_done>) for managing chunk iteration, as well as [`fd_solcap_read_bank_preimage`](<#fd_solcap_read_bank_preimage>), [`fd_solcap_find_account_table`](<#fd_solcap_find_account_table>), and [`fd_solcap_find_account`](<#fd_solcap_find_account>) for reading and decoding specific Solcap data structures. The code checks for errors during file operations and decoding processes, logging warnings when necessary. It also ensures that the data being processed conforms to expected formats by checking magic numbers and size constraints. The file is intended to be part of a larger system that processes Solcap data, and it relies on external headers and libraries for its functionality.
# Imports and Dependencies

---
- `fd_solcap_reader.h`
- `fd_solcap_proto.h`
- `../../ballet/nanopb/pb_decode.h`
- `errno.h`
- `stdio.h`


# Functions

---
### fd\_solcap\_chunk\_iter\_new<!-- {{#callable:fd_solcap_chunk_iter_new}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_reader.c#L12>)

Initializes a `fd_solcap_chunk_iter_t` iterator with a given file stream and sets its initial state.
- **Inputs**:
    - `iter`: A pointer to a `fd_solcap_chunk_iter_t` structure that will be initialized.
    - `_stream`: A pointer to a file stream (`void *`), which is cast to a `FILE *` for reading the current position.
- **Logic and Control Flow**:
    - Cast `_stream` to a `FILE *` named `stream`.
    - Get the current position in the file stream using `ftell`.
    - If `ftell` returns a negative value, set `iter->err` to `errno` and return `iter`.
    - Initialize the `iter` structure with the `stream`, an empty `chunk`, `chunk_off` set to 0, and `chunk_end` set to the current position in the stream.
    - Return the initialized `iter`.
- **Output**: Returns a pointer to the initialized `fd_solcap_chunk_iter_t` structure.


---
### fd\_solcap\_chunk\_iter\_next<!-- {{#callable:fd_solcap_chunk_iter_next}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_reader.c#L33>)

Advances the iterator to the next chunk in the stream and validates the chunk's integrity.
- **Inputs**:
    - ``iter``: A pointer to an `fd_solcap_chunk_iter_t` structure that contains the current state of the iteration, including the stream and chunk information.
- **Logic and Control Flow**:
    - Cast the `stream` member of `iter` to a `FILE` pointer.
    - Set `chunk_gaddr` to the current `chunk_end` value from `iter`.
    - Attempt to seek the file stream to the position `chunk_gaddr`. If `fseek` fails, log a warning, set the error code in `iter`, and return -1.
    - Update `chunk_off` in `iter` to the value of `chunk_gaddr`.
    - Read the next chunk from the stream into `iter->chunk`. If `fread` fails, log a warning, set the error code in `iter`, and return -1.
    - Check if the chunk's magic number is valid and if the total size is at least the size of `fd_solcap_chunk_t`. If not, log a warning, set the error code in `iter`, and return -1.
    - Update `chunk_end` in `iter` to the sum of `chunk_gaddr` and the chunk's total size.
    - Return the `chunk_gaddr` value.
- **Output**: Returns the global address of the current chunk if successful, or -1 if an error occurs.
- **Functions Called**:
    - [`fd_solcap_is_chunk_magic`](<fd_solcap_proto.h.md#fd_solcap_is_chunk_magic>)


---
### fd\_solcap\_chunk\_iter\_done<!-- {{#callable:fd_solcap_chunk_iter_done}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_reader.c#L70>)

Checks if the iteration over a file stream is complete or if an error has occurred.
- **Inputs**:
    - `iter`: A pointer to a constant `fd_solcap_chunk_iter_t` structure representing the current state of the file stream iteration.
- **Logic and Control Flow**:
    - Calls `feof` to check if the end of the file stream has been reached.
    - Calls [`fd_solcap_chunk_iter_err`](<fd_solcap_reader.h.md#fd_solcap_chunk_iter_err>) to check if an error has occurred during iteration.
    - Returns a non-zero value if either the end of the file is reached or an error is detected.
- **Output**: Returns a non-zero integer if the end of the file stream is reached or if an error has occurred; otherwise, returns zero.
- **Functions Called**:
    - [`fd_solcap_chunk_iter_err`](<fd_solcap_reader.h.md#fd_solcap_chunk_iter_err>)


---
### fd\_solcap\_read\_bank\_preimage<!-- {{#callable:fd_solcap_read_bank_preimage}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_reader.c#L76>)

Reads and decodes a bank preimage from a file stream using a specified header and offset.
- **Inputs**:
    - `_file`: A pointer to the file stream from which to read the bank preimage.
    - `chunk_goff`: The global offset in the file where the chunk starts.
    - `preimage`: A pointer to a `fd_solcap_BankPreimage` structure where the decoded preimage will be stored.
    - `hdr`: A constant pointer to a `fd_solcap_chunk_t` structure containing metadata about the chunk.
- **Logic and Control Flow**:
    - Check if the `magic` field in `hdr` matches `FD_SOLCAP_V1_BANK_MAGIC`; return `EPROTO` if not.
    - Cast `_file` to a `FILE` pointer and seek to the position in the file specified by `chunk_goff` and `hdr->meta_coff`; return `errno` if `fseek` fails.
    - Check if `hdr->meta_sz` exceeds `FD_SOLCAP_BANK_PREIMAGE_FOOTPRINT`; return `ENOMEM` if it does.
    - Read `hdr->meta_sz` bytes from the file into a buffer; return `ferror(file)` if `fread` does not read the expected number of bytes.
    - Create a `pb_istream_t` stream from the buffer and attempt to decode it into `preimage` using `pb_decode`; log a warning and return `EPROTO` if decoding fails.
    - Return 0 on successful completion.
- **Output**: Returns 0 on success, or an error code such as `EPROTO`, `ENOMEM`, or `errno` on failure.


---
### fd\_solcap\_find\_account\_table<!-- {{#callable:fd_solcap_find_account_table}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_reader.c#L107>)

Locates and decodes an account table from a file at a specified offset.
- **Inputs**:
    - `_file`: A pointer to the file from which to read the account table.
    - `meta`: A pointer to a `fd_solcap_AccountTableMeta` structure where the decoded metadata will be stored.
    - `_chunk_goff`: An unsigned long integer representing the offset in the file where the account table chunk starts.
- **Logic and Control Flow**:
    - Convert `_chunk_goff` to a long integer `chunk_goff`.
    - Cast `_file` to a `FILE` pointer `file`.
    - Seek to `chunk_goff` in the file and read the account table chunk header into `hdr`.
    - Check if the magic number in `hdr` matches `FD_SOLCAP_V1_ACTB_MAGIC`; return `EPROTO` if not.
    - Seek to the Protobuf metadata offset in the file using `hdr->meta_coff`.
    - Read the metadata into a buffer `buf` and check if its size exceeds `FD_SOLCAP_ACTB_META_FOOTPRINT`; return `ENOMEM` if it does.
    - Decode the metadata from `buf` into `meta` using `pb_decode`; log a warning and return `EPROTO` if decoding fails.
    - If `meta->account_table_coff` is non-zero, seek to the account table offset in the file.
- **Output**: Returns 0 on success, or an error code if an operation fails.


---
### fd\_solcap\_find\_account<!-- {{#callable:fd_solcap_find_account}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_reader.c#L150>)

Finds and decodes account metadata from a file stream based on a given account table record.
- **Inputs**:
    - `_file`: A pointer to a file stream from which to read the account data.
    - `meta`: A pointer to an `fd_solcap_AccountMeta` structure where the decoded account metadata will be stored.
    - `opt_data_off`: An optional pointer to a `ulong` where the offset to the account data will be stored if account data is included.
    - `rec`: A constant pointer to an `fd_solcap_account_tbl_t` structure that contains the account table record information.
    - `acc_tbl_goff`: An unsigned long representing the global offset in the account table from which to start reading.
- **Logic and Control Flow**:
    - Calculate the chunk offset by adding `acc_tbl_goff` and `rec->acc_coff`.
    - Open the file stream and seek to the calculated chunk offset.
    - Read the account chunk header into `hdr` and check for errors in seeking or reading.
    - Verify that the `magic` field in the header matches `FD_SOLCAP_V1_ACCT_MAGIC`; return `EPROTO` if it does not match.
    - Seek to the Protobuf metadata offset specified in the header.
    - Read the metadata into a buffer and check for size constraints and read errors.
    - Decode the Protobuf metadata from the buffer into the `meta` structure using `pb_decode`.
    - Log a warning and return `EPROTO` if decoding fails.
    - If the account metadata includes account data and `opt_data_off` is not null, calculate and store the data offset in `opt_data_off`.
    - Return 0 to indicate success.
- **Output**: Returns 0 on success, or an error code if an error occurs during file operations, reading, or decoding.
- **Functions Called**:
    - [`fd_solcap_includes_account_data`](<fd_solcap_reader.h.md#fd_solcap_includes_account_data>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)