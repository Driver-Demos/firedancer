<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Imports runtime capture directories from JSON and writes them to an output file using a Solcap writer.

# Purpose
The code is an executable C program designed to import runtime capture data from a directory of JSON files and write it to an output file. It uses several external libraries for JSON parsing, Base58 and Base64 encoding/decoding, and memory management. The program begins by handling command-line arguments to configure page size, page count, and scratch memory size. It then sets up a workspace and allocators for memory management. The main functionality involves reading JSON files from a specified input directory, parsing them to extract bank preimage and account data, and writing this data to an output file using a `fd_solcap_writer_t` writer.

The program defines several static functions to handle specific tasks, such as [`read_json_file`](<#read_json_file>) for reading and parsing JSON files, [`unmarshal_hash`](<#unmarshal_hash>) for decoding Base58-encoded strings, and [`unmarshal_bank_preimage`](<#unmarshal_bank_preimage>) and [`unmarshal_account`](<#unmarshal_account>) for extracting data from JSON objects. The [`write_slots`](<#write_slots>) function iterates through the input directory, processes each JSON file, and writes the extracted data to the output file. The program uses the `cJSON` library for JSON parsing and includes error handling to log warnings and errors during file operations and data processing. The main function orchestrates the setup, processing, and cleanup phases of the program.
# Imports and Dependencies

---
- `../fd_flamenco.h`
- `fd_solcap.pb.h`
- `fd_solcap_proto.h`
- `fd_solcap_writer.h`
- `../../ballet/base58/fd_base58.h`
- `../../ballet/base64/fd_base64.h`
- `../../ballet/json/cJSON.h`
- `errno.h`
- `fcntl.h`
- `stdio.h`
- `unistd.h`
- `sys/stat.h`
- `math.h`
- `dirent.h`


# Global Variables

---
### current\_alloc
- **Type**: ``fd_alloc_t *``
- **Description**: Points to the current memory allocator used for dynamic memory allocation operations. It is a static pointer to an `fd_alloc_t` structure, which is a type representing a memory allocator.
- **Use**: Used by the `my_malloc` and `my_free` functions to allocate and free memory using the current allocator.


# Functions

---
### usage<!-- {{#callable:usage}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_import.c#L21>)

Displays usage information for the `fd_solcap_import` command.
- **Inputs**: None
- **Logic and Control Flow**:
    - Prints usage instructions to the standard error stream using `fprintf`.
    - Returns 0 to indicate successful execution.
- **Output**: Returns an integer value 0, indicating successful execution.


---
### my\_malloc<!-- {{#callable:my_malloc}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_import.c#L39>)

Allocates memory of a specified size using the current memory allocator.
- **Inputs**:
    - `sz`: The size in bytes of the memory to allocate.
- **Logic and Control Flow**:
    - Calls `fd_alloc_malloc` with `current_alloc`, `1UL`, and `sz` as arguments.
    - Returns the result of `fd_alloc_malloc`.
- **Output**: A pointer to the allocated memory block, or `NULL` if the allocation fails.


---
### my\_free<!-- {{#callable:my_free}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_import.c#L40>)

Frees memory allocated by `fd_alloc_malloc` using the current allocator.
- **Inputs**:
    - `p`: Pointer to the memory block to free.
- **Logic and Control Flow**:
    - Calls `fd_alloc_free` with `current_alloc` and the pointer `p` to release the allocated memory.
- **Output**: No return value.


---
### read\_json\_file<!-- {{#callable:read_json_file}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_import.c#L42>)

Reads a JSON file from a specified path, parses its content, and returns a cJSON object representing the JSON data.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace used for memory allocation.
    - ``alloc``: A pointer to a `fd_alloc_t` allocator used for memory management.
    - ``path``: A constant character pointer representing the file path of the JSON file to read.
- **Logic and Control Flow**:
    - Set the global `current_alloc` to the provided `alloc` and initialize cJSON hooks with custom memory allocation functions `my_malloc` and `my_free`.
    - Open the file at the specified `path` in read-only mode and check for errors.
    - Use `fstat` to determine the size of the file and handle any errors.
    - Allocate a buffer in the workspace `wksp` to store the file content, checking for allocation failure.
    - Read the file content into the allocated buffer, handling read errors and unexpected EOF.
    - Parse the buffer content into a cJSON object using `cJSON_ParseWithLength`.
    - Free the allocated buffer and close the file descriptor.
    - Return the parsed cJSON object.
- **Output**: A pointer to a `cJSON` object representing the parsed JSON data, or `NULL` if an error occurs during file operations or parsing.


---
### unmarshal\_hash<!-- {{#callable:unmarshal_hash}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_import.c#L120>)

Interprets a JSON node as a Base58-encoded string of 32 bytes and decodes it into a buffer.
- **Inputs**:
    - `json`: A pointer to a `cJSON` object that represents the JSON node to interpret.
    - `out_buf`: A buffer of at least 32 bytes where the decoded bytes will be stored.
- **Logic and Control Flow**:
    - Retrieve the string value from the `json` object using `cJSON_GetStringValue`.
    - Check if the retrieved string is NULL; if so, return NULL.
    - Call `fd_base58_decode_32` to decode the Base58 string into `out_buf`.
    - Return the `out_buf` if decoding is successful.
- **Output**: Returns a pointer to `out_buf` on success, or NULL if the input is invalid or decoding fails.


---
### unmarshal\_bank\_preimage<!-- {{#callable:unmarshal_bank_preimage}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_import.c#L134>)

Reads and processes bank preimage data from a JSON object and populates a `fd_solcap_BankPreimage` structure with the extracted values.
- **Inputs**:
    - ``json``: A pointer to a `cJSON` object representing the JSON data containing bank preimage information.
    - ``out``: A pointer to a `fd_solcap_BankPreimage` structure where the function will store the extracted data.
- **Logic and Control Flow**:
    - Initialize `head` as a pointer to the input `json` object.
    - Retrieve the `slot` item from `head` and assign its value to `out->slot`, defaulting to 0 if not present.
    - Call [`unmarshal_hash`](<#unmarshal_hash>) to decode and assign the `bank_hash`, `parent_bank_hash`, `accounts_delta_hash`, `accounts_lt_hash_checksum`, and `last_blockhash` from `head` to the corresponding fields in `out`.
    - If [`unmarshal_hash`](<#unmarshal_hash>) fails for `accounts_delta_hash` or `accounts_lt_hash_checksum`, set the respective fields in `out` to zero using `fd_memset`.
    - Retrieve the `signature_count` from `head` and assign its value to `out->signature_cnt`, defaulting to 0 if not present.
    - Retrieve the `accounts` array from `head`, verify its presence, and assign its size to `out->account_cnt`.
- **Output**: Populates the `fd_solcap_BankPreimage` structure pointed to by `out` with data extracted from the JSON object.
- **Functions Called**:
    - [`unmarshal_hash`](<#unmarshal_hash>)


---
### unmarshal\_account<!-- {{#callable:unmarshal_account}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_import.c#L167>)

Reads account metadata and data from a JSON object, decodes Base64 data, and returns a pointer to the account data.
- **Inputs**:
    - ``json``: A pointer to a `cJSON` object representing the JSON dictionary containing account information.
    - ``rec``: A pointer to a `fd_solcap_account_tbl_t` structure where the function will store the account's public key.
    - ``meta``: A pointer to a `fd_solcap_AccountMeta` structure where the function will store account metadata such as lamports, executable status, owner, and data size.
- **Logic and Control Flow**:
    - Retrieve the 'lamports' value from the JSON object and store it in `meta->lamports`.
    - Retrieve the 'executable' value from the JSON object, verify it is a boolean, and store the result in `meta->executable`.
    - Call [`unmarshal_hash`](<#unmarshal_hash>) to decode the 'pubkey' and 'owner' fields from Base58 and store them in `rec->key` and `meta->owner`, respectively.
    - Retrieve the 'data' field from the JSON object, which is a Base64 encoded string, and calculate its length.
    - Allocate scratch memory for the decoded data using an approximate size calculation.
    - Decode the Base64 data into the allocated memory and store the size of the decoded data in `meta->data_sz`.
    - Return a pointer to the decoded account data.
- **Output**: A pointer to the decoded account data stored in scratch memory.
- **Functions Called**:
    - [`unmarshal_hash`](<#unmarshal_hash>)


---
### write\_slots<!-- {{#callable:write_slots}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_import.c#L210>)

Processes JSON files in a directory to extract and write bank preimage and account data using a specified writer.
- **Inputs**:
    - ``in_path``: A string representing the path to the directory containing JSON files.
    - ``writer``: A pointer to an `fd_solcap_writer_t` structure used to write the extracted data.
    - ``wksp``: A pointer to an `fd_wksp_t` structure used for workspace memory management.
    - ``alloc``: A pointer to an `fd_alloc_t` structure used for memory allocation.
- **Logic and Control Flow**:
    - Open the directory specified by `in_path` and check for errors.
    - Iterate over each file in the directory, skipping non-regular files.
    - Construct the full path for each file and log the file being read.
    - Read the JSON content of the file using [`read_json_file`](<#read_json_file>) and handle errors if the file cannot be read.
    - Check for the presence of `bank_hash_details` in the JSON and adjust the JSON object if present.
    - Unmarshal the bank preimage data from the JSON and set the slot in the writer using [`fd_solcap_writer_set_slot`](<fd_solcap_writer.c.md#fd_solcap_writer_set_slot>).
    - Retrieve the accounts array from the JSON and iterate over each account.
    - For each account, push a scratch frame, unmarshal the account data, and write it using [`fd_solcap_write_account2`](<fd_solcap_writer.c.md#fd_solcap_write_account2>).
    - Pop the scratch frame after processing each account.
    - Write the bank preimage data using [`fd_solcap_write_bank_preimage2`](<fd_solcap_writer.c.md#fd_solcap_write_bank_preimage2>).
    - Free the JSON object and close the directory after processing all files.
- **Output**: No return value; the function writes data to the specified writer and logs errors if they occur.
- **Functions Called**:
    - [`read_json_file`](<#read_json_file>)
    - [`unmarshal_bank_preimage`](<#unmarshal_bank_preimage>)
    - [`fd_solcap_writer_set_slot`](<fd_solcap_writer.c.md#fd_solcap_writer_set_slot>)
    - [`unmarshal_account`](<#unmarshal_account>)
    - [`fd_solcap_write_account2`](<fd_solcap_writer.c.md#fd_solcap_write_account2>)
    - [`fd_solcap_write_bank_preimage2`](<fd_solcap_writer.c.md#fd_solcap_write_bank_preimage2>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/flamenco/capture/fd_solcap_import.c#L275>)

Initializes the environment, processes command-line arguments, sets up memory workspaces and allocators, creates an output file, and writes data from an input directory to the output file using a solcap writer.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Iterates over command-line arguments to check for the `--help` flag and calls `usage()` if found.
    - Extracts command-line options `--page-sz`, `--page-cnt`, and `--scratch-mb` with default values if not provided.
    - Converts `_page_sz` to a memory page size using `fd_cstr_to_shmem_page_sz` and logs an error if unsupported.
    - Checks if the number of arguments is exactly 3, otherwise logs an error and calls `usage()`.
    - Creates a new anonymous workspace with `fd_wksp_new_anonymous` and logs an error if creation fails.
    - Allocates scratch memory and attaches it using `fd_scratch_attach`.
    - Creates a heap allocator using `fd_alloc_join` and logs an error if creation fails.
    - Opens the output file specified in `argv[2]` for writing and logs an error if it fails.
    - Allocates memory for a solcap writer and initializes it with `fd_solcap_writer_init`.
    - Calls [`write_slots`](<#write_slots>) to process the input directory and write data to the output file.
    - Frees allocated resources, closes the output file, and checks for memory leaks before halting the program.
- **Output**: Returns 0 on successful execution, or 1 if there is an error in the number of arguments.
- **Functions Called**:
    - [`usage`](<#usage>)
    - [`write_slots`](<#write_slots>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)