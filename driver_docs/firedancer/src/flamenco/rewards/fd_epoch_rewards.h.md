<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines data structures and functions for managing and distributing epoch rewards in a blockchain system.

# Purpose
The code is a C header file that defines the structure and functions for managing epoch rewards in a distributed system. The primary structure, `fd_epoch_rewards_t`, is responsible for storing and managing the distribution of rewards to stake accounts over multiple slots within an epoch. The rewards are partitioned and distributed based on the number of stake accounts, and the distribution process is initiated at the epoch boundary. The file includes definitions for calculating the maximum number of partitions and the memory footprint required for the rewards structure.

The header file provides several functions to initialize, manage, and manipulate the epoch rewards data. These include functions to create and delete the rewards structure, insert rewards for specific stake accounts, and hash accounts into partitions. Additionally, it defines an iterator API to traverse the rewards data, allowing for read-only access to the elements. The file also includes static assertions to ensure that the calculated maximum partitions and memory alignments are correct. The code is intended to be used as part of a larger system, likely involving a banking or financial application, where rewards are distributed based on stake contributions.
# Imports and Dependencies

---
- `../runtime/fd_runtime_const.h`
- `fd_rewards_base.h`
- `../../util/tmpl/fd_dlist.c`


# Data Structures

---
### fd\_epoch\_stake\_reward
- **Type**: ``struct``
- **Members**:
    - `stake_pubkey`: Holds the public key of the stake account.
    - `credits_observed`: Stores the number of credits observed for the stake account.
    - `lamports`: Represents the amount of lamports associated with the stake account.
    - `prev`: Points to the previous element in a pool, dlist, or map.
    - `next`: Points to the next element in a pool, dlist, or map.
    - `parent`: Points to the parent element in a pool, dlist, or map.
    - `next_map`: Points to the next element in a map.
- **Description**: Manages information related to stake rewards for a specific stake account, including its public key, observed credits, and lamports. It also includes internal pointers for managing the element's position within a pool, doubly linked list (dlist), or map, facilitating efficient data organization and retrieval.


---
### fd\_epoch\_stake\_reward\_t
- **Type**: ``struct``
- **Members**:
    - ``stake_pubkey``: Holds the public key of the stake account.
    - ``credits_observed``: Stores the number of credits observed for the stake account.
    - ``lamports``: Represents the amount of lamports associated with the stake account.
    - ``prev``: Points to the previous element in the pool or list.
    - ``next``: Points to the next element in the pool or list.
    - ``parent``: Points to the parent element in the pool or list.
    - ``next_map``: Points to the next element in the map.
- **Description**: Represents a structure used to store information about stake rewards for a specific stake account, including its public key, observed credits, and lamports. It also includes internal pointers for managing its position within a pool, doubly linked list, and map, facilitating efficient organization and retrieval of stake reward data.


---
### fd\_epoch\_rewards\_iter
- **Type**: ``struct``
- **Members**:
    - `pool`: A pointer to a `fd_epoch_stake_reward_t` structure, representing the pool of stake rewards.
    - `dlist`: A void pointer to a doubly linked list structure.
    - `iter`: An iterator of type `fd_epoch_stake_reward_dlist_iter_t` for traversing the doubly linked list.
- **Description**: Facilitates iteration over epoch stake rewards by encapsulating a pool of stake rewards, a doubly linked list, and an iterator for traversing the list.


---
### fd\_epoch\_rewards\_iter\_t
- **Type**: ``struct``
- **Members**:
    - ``pool``: A pointer to `fd_epoch_stake_reward_t`, representing the pool of stake rewards.
    - ``dlist``: A pointer to a doubly linked list structure used for iteration.
    - ``iter``: An iterator of type `fd_epoch_stake_reward_dlist_iter_t` for traversing the rewards.
- **Description**: Facilitates iteration over epoch rewards by encapsulating a pool of stake rewards, a doubly linked list, and an iterator. It provides an interface to traverse the rewards associated with different partitions in the epoch rewards system.


---
### fd\_epoch\_rewards
- **Type**: ``struct``
- **Members**:
    - `magic`: A unique identifier for the `fd_epoch_rewards` structure.
    - `stake_account_max`: The maximum number of stake accounts that can receive rewards.
    - `starting_block_height`: The block height at which the reward distribution starts.
    - `num_partitions`: The number of partitions for distributing rewards.
    - `partitions_lengths`: An array holding the lengths of each partition, with a size of `FD_REWARDS_MAX_PARTITIONS`.
    - `total_rewards`: The total rewards for the epoch, including both vote and stake rewards.
    - `distributed_rewards`: The total reward points calculated for the current epoch.
    - `total_points`: The stake rewards that still need to be distributed, grouped by partition.
    - `total_stake_rewards`: The total stake rewards to distribute as calculated during the epoch boundary.
    - `stake_rewards_cnt`: The total number of stake accounts that have rewards to distribute.
    - `pool_offset`: An internal pointer offset for the pool.
    - `map_offset`: An internal pointer offset for the map.
    - `dlists_offset`: An internal pointer offset for the doubly linked lists.
- **Description**: Manages the storage and distribution of stake account rewards over multiple slots within an epoch. The structure includes fields for tracking the total rewards, the number of partitions, and the distribution of rewards across these partitions. It also contains internal pointers for managing pools, maps, and doubly linked lists, which are used to efficiently handle the reward distribution process. The structure is primarily used by banks and is written to during the epoch boundary, after which it becomes read-only.


---
### fd\_epoch\_rewards\_t
- **Type**: ``struct``
- **Members**:
    - `magic`: A unique identifier for the `fd_epoch_rewards` structure.
    - `stake_account_max`: The maximum number of stake accounts that can be managed.
    - `starting_block_height`: The block height at which the rewards distribution starts.
    - `num_partitions`: The number of partitions for distributing rewards.
    - `partitions_lengths`: An array storing the length of each partition.
    - `total_rewards`: The total rewards for the epoch, including both vote and stake rewards.
    - `distributed_rewards`: The total reward points calculated for the current epoch.
    - `total_points`: The stake rewards that still need to be distributed, grouped by partition.
    - `total_stake_rewards`: The total stake rewards to distribute as calculated during the epoch boundary.
    - `stake_rewards_cnt`: The total number of stake accounts that have rewards to distribute.
    - `pool_offset`: The offset to the pool of `fd_epoch_stake_reward_t` structures.
    - `map_offset`: The offset to the map structure.
    - `dlists_offset`: The offset to the doubly linked lists structure.
- **Description**: Manages the distribution of stake account rewards over multiple slots within an epoch. The structure includes fields for managing partitions, total rewards, and internal pointers for handling pools and lists. It is primarily used by banks to manage rewards distribution, which occurs at the epoch boundary and is read-only afterward.


# Functions

---
### fd\_epoch\_rewards\_get\_exclusive\_ending\_block\_height<!-- {{#callable:fd_epoch_rewards_get_exclusive_ending_block_height}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_epoch_rewards.h#L198>)

Calculates the block height at which the last partition of epoch rewards ends.
- **Inputs**:
    - `epoch_rewards`: A pointer to a constant `fd_epoch_rewards_t` structure containing epoch rewards data.
- **Logic and Control Flow**:
    - Accesses the `starting_block_height` from the `epoch_rewards` structure.
    - Accesses the `num_partitions` from the `epoch_rewards` structure.
    - Adds `starting_block_height` and `num_partitions` to compute the exclusive ending block height.
- **Output**: Returns an `ulong` representing the block height at which the last partition ends.


# Function Declarations (Public API)

---
### fd\_epoch\_rewards\_align<!-- {{#callable_declaration:fd_epoch_rewards_align}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_epoch_rewards.h#L140>)

Returns the alignment requirement of the epoch rewards structure.
- **Description**: Use this function to obtain the alignment requirement for the `fd_epoch_rewards_t` structure. This information is necessary when allocating memory for the structure to ensure proper alignment. The function does not require any parameters and can be called at any time to retrieve the alignment value.
- **Inputs**: None
- **Output**: The function returns an `ulong` representing the alignment requirement of the epoch rewards structure.
- **See Also**: [`fd_epoch_rewards_align`](<fd_epoch_rewards.c.md#fd_epoch_rewards_align>)  (Implementation)


---
### fd\_epoch\_rewards\_footprint<!-- {{#callable_declaration:fd_epoch_rewards_footprint}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_epoch_rewards.h#L146>)

Calculates the memory footprint for epoch rewards.
- **Description**: Use this function to determine the memory size required for storing epoch rewards data based on the maximum number of stake accounts. This is useful for allocating sufficient memory resources before initializing the epoch rewards structure. Ensure that the input value is within the expected range of stake accounts to avoid incorrect memory calculations.
- **Inputs**:
    - `stake_account_max`: Specifies the maximum number of stake accounts. Must be a positive integer. The function uses this value to estimate the memory footprint. If the value is invalid, the function may return an incorrect footprint size.
- **Output**: Returns the calculated memory footprint in bytes as an unsigned long integer.
- **See Also**: [`fd_epoch_rewards_footprint`](<fd_epoch_rewards.c.md#fd_epoch_rewards_footprint>)  (Implementation)


---
### fd\_epoch\_rewards\_new<!-- {{#callable_declaration:fd_epoch_rewards_new}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_epoch_rewards.h#L150>)

Initializes the epoch rewards structure in shared memory.
- **Description**: Use this function to initialize an `fd_epoch_rewards_t` structure in a provided shared memory region. This function must be called with a valid, aligned memory pointer and a maximum number of stake accounts. It sets up the necessary internal structures for managing epoch rewards, including pools and maps for stake rewards. The function returns a pointer to the initialized memory or `NULL` if the input memory is `NULL`, misaligned, or if any internal allocation fails. Ensure that the shared memory is properly aligned and has sufficient space for the structure footprint.
- **Inputs**:
    - `shmem`: Pointer to the shared memory region where the epoch rewards structure will be initialized. Must not be null and must be aligned according to `fd_epoch_rewards_align()`. Caller retains ownership.
    - `stake_account_max`: Maximum number of stake accounts that the structure will support. Determines the size of internal allocations.
- **Output**: Returns a pointer to the initialized shared memory region, or `NULL` if initialization fails due to invalid input or internal allocation errors.
- **See Also**: [`fd_epoch_rewards_new`](<fd_epoch_rewards.c.md#fd_epoch_rewards_new>)  (Implementation)


---
### fd\_epoch\_rewards\_join<!-- {{#callable_declaration:fd_epoch_rewards_join}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_epoch_rewards.h#L156>)

Returns a pointer to the epoch rewards structure stored in shared memory.
- **Description**: Use this function to access the epoch rewards structure from shared memory. It is important to ensure that the shared memory pointer is not null and is properly aligned according to the alignment requirements of the epoch rewards structure. The function checks these conditions and logs warnings if they are not met, returning null in such cases. This function should be called after the shared memory has been initialized with the epoch rewards structure.
- **Inputs**:
    - `shmem`: A pointer to the shared memory where the epoch rewards structure is stored. Must not be null and must be aligned to the alignment requirements of the epoch rewards structure. If these conditions are not met, the function logs a warning and returns null.
- **Output**: A pointer to the `fd_epoch_rewards_t` structure if successful, or null if the input is invalid or if any internal checks fail.
- **See Also**: [`fd_epoch_rewards_join`](<fd_epoch_rewards.c.md#fd_epoch_rewards_join>)  (Implementation)


---
### fd\_epoch\_rewards\_leave<!-- {{#callable_declaration:fd_epoch_rewards_leave}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_epoch_rewards.h#L162>)

Returns a pointer to the epoch rewards struct.
- **Description**: Use this function to obtain a pointer to an `fd_epoch_rewards_t` struct that is stored in shared memory. This function is typically called when you need to access the epoch rewards data after it has been joined to shared memory. Ensure that the `epoch_rewards` parameter is a valid pointer to an `fd_epoch_rewards_t` struct before calling this function.
- **Inputs**:
    - `epoch_rewards`: A constant pointer to an `fd_epoch_rewards_t` struct. Must not be null. The function returns this pointer cast to a `void *`.
- **Output**: Returns a `void *` pointer to the `fd_epoch_rewards_t` struct provided in the input.
- **See Also**: [`fd_epoch_rewards_leave`](<fd_epoch_rewards.c.md#fd_epoch_rewards_leave>)  (Implementation)


---
### fd\_epoch\_rewards\_delete<!-- {{#callable_declaration:fd_epoch_rewards_delete}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_epoch_rewards.h#L168>)

Unformats the epoch rewards structure and its managed memory.
- **Description**: Use this function to unformat and prepare the epoch rewards structure for deletion. It must be called with a valid pointer to a formatted epoch rewards structure in shared memory. The function checks for null pointers, proper alignment, and a valid magic number to ensure the structure is correctly formatted before proceeding. If any of these checks fail, the function logs a warning and returns null. After successful unformatting, the function returns the original pointer.
- **Inputs**:
    - `epoch_rewards_shmem`: A pointer to the shared memory containing the epoch rewards structure. It must not be null, must be properly aligned, and must have a valid magic number. If these conditions are not met, the function returns null.
- **Output**: Returns the original pointer to the shared memory if successful, or null if the input is invalid.
- **See Also**: [`fd_epoch_rewards_delete`](<fd_epoch_rewards.c.md#fd_epoch_rewards_delete>)  (Implementation)


---
### fd\_epoch\_rewards\_insert<!-- {{#callable_declaration:fd_epoch_rewards_insert}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_epoch_rewards.h#L174>)

Stores rewards for a given stake account into the data structure.
- **Description**: Use this function to add rewards for a specific stake account to the epoch rewards data structure. This function must be called during the epoch boundary when the `fd_epoch_rewards_t` structure is writable. Ensure that the `pubkey` does not already exist in the data structure, as this will cause a critical error. The function updates the total stake rewards and the count of stake rewards in the `epoch_rewards` structure.
- **Inputs**:
    - `epoch_rewards`: A pointer to an `fd_epoch_rewards_t` structure where the rewards will be stored. Must not be null and must point to a valid, writable `fd_epoch_rewards_t` structure.
    - `pubkey`: A pointer to a `fd_pubkey_t` representing the public key of the stake account. Must not be null and must not already exist in the data structure.
    - `credits`: An unsigned long integer representing the credits observed for the stake account. Must be a valid credit value.
    - `lamports`: An unsigned long integer representing the lamports to be rewarded to the stake account. Must be a valid lamport value.
- **Output**: None
- **See Also**: [`fd_epoch_rewards_insert`](<fd_epoch_rewards.c.md#fd_epoch_rewards_insert>)  (Implementation)


---
### fd\_epoch\_rewards\_hash\_into\_partitions<!-- {{#callable_declaration:fd_epoch_rewards_hash_into_partitions}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_epoch_rewards.h#L183>)

Distributes stake account rewards into partitions based on a hash.
- **Description**: Use this function to distribute stake account rewards into a specified number of partitions. This process is based on a hash derived from the parent block hash and each stake account's public key. Call this function during the epoch boundary to prepare the rewards for distribution. Ensure that the `epoch_rewards` structure is properly initialized and that `num_partitions` is within valid bounds before calling. The function modifies the `epoch_rewards` structure to reflect the partitioning.
- **Inputs**:
    - `epoch_rewards`: A pointer to an `fd_epoch_rewards_t` structure that holds the epoch rewards data. Must not be null and should be properly initialized before calling.
    - `parent_blockhash`: A pointer to a constant `fd_hash_t` structure representing the parent block hash. Must not be null.
    - `num_partitions`: An unsigned long integer specifying the number of partitions. Must be a valid number within the bounds defined by the system constraints.
- **Output**: None
- **See Also**: [`fd_epoch_rewards_hash_into_partitions`](<fd_epoch_rewards.c.md#fd_epoch_rewards_hash_into_partitions>)  (Implementation)


---
### fd\_epoch\_rewards\_iter\_ele<!-- {{#callable_declaration:fd_epoch_rewards_iter_ele}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_epoch_rewards.h#L215>)

Retrieves the current element from an epoch rewards iterator.
- **Description**: Use this function to access the current stake reward element from an initialized epoch rewards iterator. This function is part of an iterator API that allows traversal over epoch rewards. Ensure that the iterator is properly initialized and not at the end of the iteration before calling this function. The function does not modify the iterator or the element returned.
- **Inputs**:
    - `iter`: A pointer to an `fd_epoch_rewards_iter_t` structure. This must be a valid, non-null pointer to an initialized iterator. The caller retains ownership and must ensure the iterator is not at the end of the iteration.
- **Output**: Returns a pointer to the current `fd_epoch_stake_reward_t` element in the iteration. The returned pointer is valid as long as the iterator remains unchanged.
- **See Also**: [`fd_epoch_rewards_iter_ele`](<fd_epoch_rewards.c.md#fd_epoch_rewards_iter_ele>)  (Implementation)


---
### fd\_epoch\_rewards\_iter\_init<!-- {{#callable_declaration:fd_epoch_rewards_iter_init}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_epoch_rewards.h#L218>)

Initializes an iterator for epoch rewards.
- **Description**: Use this function to initialize an iterator for traversing stake rewards within a specific partition of epoch rewards. The function requires a pre-allocated iterator structure and a reference to the epoch rewards data. It sets up the iterator to start at the beginning of the specified partition. Ensure that the `epoch_rewards` structure is valid and that the `partition_idx` is within the valid range of partitions. The caller is responsible for managing the memory of the iterator.
- **Inputs**:
    - `iter`: A pointer to a pre-allocated `fd_epoch_rewards_iter_t` structure. The caller must allocate this structure before calling the function. The function initializes this structure for iteration.
    - `epoch_rewards`: A pointer to a constant `fd_epoch_rewards_t` structure representing the epoch rewards data. This must not be null and should be properly initialized before use.
    - `partition_idx`: An unsigned long integer representing the index of the partition to iterate over. It must be within the valid range of partitions as defined by the epoch rewards data.
- **Output**: Returns a pointer to the initialized `fd_epoch_rewards_iter_t` structure, which is the same as the input `iter` parameter.
- **See Also**: [`fd_epoch_rewards_iter_init`](<fd_epoch_rewards.c.md#fd_epoch_rewards_iter_init>)  (Implementation)


---
### fd\_epoch\_rewards\_iter\_done<!-- {{#callable_declaration:fd_epoch_rewards_iter_done}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_epoch_rewards.h#L223>)

Checks if the epoch rewards iterator has completed.
- **Description**: Use this function to determine if the iteration over epoch rewards is complete. It is part of the iterator API for epoch rewards and should be called after initializing the iterator with `fd_epoch_rewards_iter_init`. This function is safe to call at any point during the iteration process to check if there are more elements to iterate over.
- **Inputs**:
    - `iter`: A pointer to an `fd_epoch_rewards_iter_t` structure. This must not be null and should be properly initialized before calling this function. The caller retains ownership of this pointer.
- **Output**: Returns a non-zero value if the iteration is complete, otherwise returns zero.
- **See Also**: [`fd_epoch_rewards_iter_done`](<fd_epoch_rewards.c.md#fd_epoch_rewards_iter_done>)  (Implementation)


---
### fd\_epoch\_rewards\_iter\_next<!-- {{#callable_declaration:fd_epoch_rewards_iter_next}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_epoch_rewards.h#L226>)

Advances the epoch rewards iterator to the next element.
- **Description**: Use this function to move the iterator to the next element in the epoch rewards list. This function should be called only if the iterator is not done, as determined by `fd_epoch_rewards_iter_done()`. It is part of the iterator API for traversing epoch rewards, and it is safe to call as long as the iterator has been properly initialized with `fd_epoch_rewards_iter_init()`. The caller must manage the memory for the iterator.
- **Inputs**:
    - `iter`: A pointer to an `fd_epoch_rewards_iter_t` structure. This must not be null and must be initialized with `fd_epoch_rewards_iter_init()`. The function assumes the iterator is valid and will not check for null pointers.
- **Output**: None
- **See Also**: [`fd_epoch_rewards_iter_next`](<fd_epoch_rewards.c.md#fd_epoch_rewards_iter_next>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)