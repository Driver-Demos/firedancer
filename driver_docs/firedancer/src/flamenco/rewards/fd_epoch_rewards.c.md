<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Manages epoch rewards, including memory alignment, creation, joining, deletion, and partitioning.

# Purpose
The code is a C module that manages epoch-based stake rewards in a blockchain or distributed ledger system. It provides functionality to allocate, initialize, and manage memory structures for storing and processing stake rewards. The module defines a pool and a map for managing stake reward entries, which are associated with public keys. It includes functions to create, join, leave, and delete these structures in shared memory, ensuring proper alignment and memory management.

The module also includes functions to insert new stake reward entries, hash them into partitions, and iterate over them. The [`fd_epoch_rewards_insert`](<#fd_epoch_rewards_insert>) function adds a new stake reward entry to the pool and map, while [`fd_epoch_rewards_hash_into_partitions`](<#fd_epoch_rewards_hash_into_partitions>) distributes the entries into partitions based on a hash of the parent blockhash and the stake public key. The iteration functions allow traversal of the stake reward entries within a specified partition. The code uses templates for pool and map management, and it relies on external utilities for hashing and memory alignment.
# Imports and Dependencies

---
- `fd_epoch_rewards.h`
- `../../ballet/siphash13/fd_siphash13.h`
- `../../util/tmpl/fd_pool.c`
- `../../util/tmpl/fd_map_chain.c`


# Functions

---
### fd\_epoch\_rewards\_align<!-- {{#callable:fd_epoch_rewards_align}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_epoch_rewards.c#L17>)

Returns the alignment requirement for epoch rewards.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the value of the macro `FD_EPOCH_REWARDS_ALIGN`.
- **Output**: The alignment requirement for epoch rewards as an unsigned long integer.


---
### fd\_epoch\_rewards\_footprint<!-- {{#callable:fd_epoch_rewards_footprint}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_epoch_rewards.c#L22>)

Calculates the memory footprint required for epoch rewards based on the maximum number of stake accounts.
- **Inputs**:
    - `stake_account_max`: The maximum number of stake accounts to consider for calculating the memory footprint.
- **Logic and Control Flow**:
    - Call `fd_epoch_stake_reward_map_chain_cnt_est` with `stake_account_max` to estimate the number of chains.
    - Initialize `l` with `FD_LAYOUT_INIT`.
    - Append the alignment and size of `fd_epoch_rewards_t` to `l` using `FD_LAYOUT_APPEND`.
    - Append the alignment and footprint of the stake reward pool to `l` using `FD_LAYOUT_APPEND`.
    - Append the alignment and footprint of the stake reward map to `l` using `FD_LAYOUT_APPEND`.
    - Append the alignment and footprint of the stake reward dlist multiplied by `FD_REWARDS_MAX_PARTITIONS` to `l` using `FD_LAYOUT_APPEND`.
    - Finalize the layout with `FD_LAYOUT_FINI` and return the result.
- **Output**: Returns the total memory footprint as an `ulong`.
- **Functions Called**:
    - [`fd_epoch_rewards_align`](<#fd_epoch_rewards_align>)


---
### fd\_epoch\_rewards\_new<!-- {{#callable:fd_epoch_rewards_new}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_epoch_rewards.c#L34>)

Initializes and allocates memory for epoch rewards, including pools, maps, and lists, using shared memory.
- **Inputs**:
    - `shmem`: Pointer to shared memory where the epoch rewards structure will be initialized.
    - `stake_account_max`: Maximum number of stake accounts to be managed.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL and log a warning if true, then return NULL.
    - Check if `shmem` is aligned according to `fd_epoch_rewards_align()` and log a warning if not, then return NULL.
    - Initialize scratch allocation with `FD_SCRATCH_ALLOC_INIT` using `shmem`.
    - Allocate and zero-initialize `fd_epoch_rewards_t` structure using `FD_SCRATCH_ALLOC_APPEND`.
    - Allocate memory for the stake reward pool and set `pool_offset` in `epoch_rewards`.
    - Initialize the stake reward pool with `fd_epoch_stake_reward_pool_new` and log a warning if it fails, then return NULL.
    - Estimate chain count and allocate memory for the stake reward map, setting `map_offset` in `epoch_rewards`.
    - Initialize the stake reward map with `fd_epoch_stake_reward_map_new` and log a warning if it fails, then return NULL.
    - Iterate over `FD_REWARDS_MAX_PARTITIONS` to allocate and initialize doubly linked lists, setting `dlists_offset` for the first list.
    - Finalize scratch allocation and check if the footprint matches the expected size, log a warning if not, then return NULL.
    - Set the `magic` field in `epoch_rewards` to `FD_EPOCH_REWARDS_MAGIC` with memory fences before and after.
    - Set `stake_account_max` in `epoch_rewards`.
- **Output**: Returns the pointer to the shared memory `shmem` if successful, or NULL if any error occurs during initialization.
- **Functions Called**:
    - [`fd_epoch_rewards_align`](<#fd_epoch_rewards_align>)
    - [`fd_epoch_rewards_footprint`](<#fd_epoch_rewards_footprint>)


---
### fd\_epoch\_rewards\_join<!-- {{#callable:fd_epoch_rewards_join}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_epoch_rewards.c#L90>)

Joins an existing epoch rewards structure from shared memory, ensuring proper alignment and initialization of its components.
- **Inputs**:
    - `shmem`: A pointer to shared memory where the epoch rewards structure is stored.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL; if so, log a warning and return NULL.
    - Verify if `shmem` is properly aligned using [`fd_epoch_rewards_align`](<#fd_epoch_rewards_align>); if not, log a warning and return NULL.
    - Initialize scratch allocation with `FD_SCRATCH_ALLOC_INIT`.
    - Allocate and append `fd_epoch_rewards_t` structure to the scratch allocator.
    - Retrieve `stake_account_max` from the `epoch_rewards` structure.
    - Allocate and append a stake reward pool to the scratch allocator, and join it using `fd_epoch_stake_reward_pool_join`; if joining fails, log a warning and return NULL.
    - Estimate chain count and allocate a stake reward map, then join it using `fd_epoch_stake_reward_map_join`; if joining fails, log a warning and return NULL.
    - Iterate over `FD_REWARDS_MAX_PARTITIONS` to allocate and join stake reward dlist structures; if joining any dlist fails, log a warning and return NULL.
    - Finalize the scratch allocation and check if the footprint matches the expected size; if not, log a warning and return NULL.
    - Verify the `magic` field of `epoch_rewards`; if it does not match `FD_EPOCH_REWARDS_MAGIC`, log a warning and return NULL.
- **Output**: Returns a pointer to the `fd_epoch_rewards_t` structure if successful, or NULL if any checks or joins fail.
- **Functions Called**:
    - [`fd_epoch_rewards_align`](<#fd_epoch_rewards_align>)
    - [`fd_epoch_rewards_footprint`](<#fd_epoch_rewards_footprint>)


---
### fd\_epoch\_rewards\_leave<!-- {{#callable:fd_epoch_rewards_leave}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_epoch_rewards.c#L140>)

Returns a pointer to the given `fd_epoch_rewards_t` structure.
- **Inputs**:
    - `epoch_rewards`: A constant pointer to an `fd_epoch_rewards_t` structure that represents the epoch rewards to leave.
- **Logic and Control Flow**:
    - Casts the `epoch_rewards` pointer to a `void *` type.
    - Returns the casted pointer.
- **Output**: A `void *` pointer to the `epoch_rewards` structure.


---
### fd\_epoch\_rewards\_delete<!-- {{#callable:fd_epoch_rewards_delete}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_epoch_rewards.c#L145>)

Validates and deletes an `fd_epoch_rewards_t` object from shared memory.
- **Inputs**:
    - `epoch_rewards_shmem`: A pointer to the shared memory location of the `fd_epoch_rewards_t` object to delete.
- **Logic and Control Flow**:
    - Cast `epoch_rewards_shmem` to `fd_epoch_rewards_t *` and store it in `epoch_rewards`.
    - Check if `epoch_rewards` is NULL; if true, log a warning and return NULL.
    - Check if `epoch_rewards` is misaligned; if true, log a warning and return NULL.
    - Check if `epoch_rewards->magic` is not equal to `FD_EPOCH_REWARDS_MAGIC`; if true, log a warning and return NULL.
    - Set `epoch_rewards->magic` to 0UL to mark it as deleted.
    - Return the original `epoch_rewards_shmem` pointer.
- **Output**: Returns the original `epoch_rewards_shmem` pointer if successful, or NULL if any validation fails.
- **Functions Called**:
    - [`fd_epoch_rewards_align`](<#fd_epoch_rewards_align>)


---
### fd\_epoch\_rewards\_get\_partition\_index<!-- {{#callable:fd_epoch_rewards_get_partition_index}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_epoch_rewards.c#L169>)

Retrieves the partition index for a given epoch reward index, returning the corresponding doubly linked list if the index is valid.
- **Inputs**:
    - `epoch_rewards`: A pointer to a constant `fd_epoch_rewards_t` structure containing epoch reward data.
    - `idx`: An unsigned long integer representing the index of the partition to retrieve.
- **Logic and Control Flow**:
    - Check if `idx` is greater than or equal to `epoch_rewards->num_partitions`; if true, log a warning and return `NULL`.
    - Calculate the base address of the doubly linked list (`dlist_idx_zero`) by adding `epoch_rewards->dlists_offset` to the `epoch_rewards` pointer.
    - Retrieve the partition doubly linked list by calling `fd_epoch_stake_reward_dlist_join` with the address of the list at the specified index (`dlist_idx_zero + idx`).
    - Return the pointer to the partition doubly linked list.
- **Output**: A pointer to the `fd_epoch_stake_reward_dlist_t` structure representing the partition doubly linked list, or `NULL` if the index is invalid.


---
### fd\_epoch\_rewards\_get\_stake\_reward\_pool<!-- {{#callable:fd_epoch_rewards_get_stake_reward_pool}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_epoch_rewards.c#L181>)

Retrieves the stake reward pool from the given epoch rewards structure.
- **Inputs**:
    - ``epoch_rewards``: A pointer to a constant `fd_epoch_rewards_t` structure, which contains information about the epoch rewards, including the offset to the stake reward pool.
- **Logic and Control Flow**:
    - Calculate the address of the stake reward pool by adding the `pool_offset` from the `epoch_rewards` structure to the base address of `epoch_rewards`.
    - Call `fd_epoch_stake_reward_pool_join` with the calculated address to obtain a pointer to the stake reward pool.
- **Output**: A pointer to an `fd_epoch_stake_reward_t` structure representing the stake reward pool.


---
### fd\_epoch\_rewards\_get\_stake\_reward\_map<!-- {{#callable:fd_epoch_rewards_get_stake_reward_map}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_epoch_rewards.c#L186>)

Retrieves the stake reward map from the given epoch rewards structure.
- **Inputs**:
    - `epoch_rewards`: A pointer to a constant `fd_epoch_rewards_t` structure that contains the epoch rewards data.
- **Logic and Control Flow**:
    - Calculate the address of the stake reward map by adding the `map_offset` from the `epoch_rewards` to the base address of `epoch_rewards`.
    - Call `fd_epoch_stake_reward_map_join` with the calculated address to retrieve the stake reward map.
- **Output**: A pointer to `fd_epoch_stake_reward_map_t`, which represents the stake reward map associated with the given epoch rewards.


---
### fd\_epoch\_rewards\_insert<!-- {{#callable:fd_epoch_rewards_insert}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_epoch_rewards.c#L191>)

Inserts a new stake reward entry into the epoch rewards structure, ensuring no duplicate entries exist.
- **Inputs**:
    - `epoch_rewards`: A pointer to the `fd_epoch_rewards_t` structure where the stake reward will be inserted.
    - `pubkey`: A constant pointer to the `fd_pubkey_t` structure representing the public key associated with the stake reward.
    - `credits`: An unsigned long integer representing the credits observed for the stake reward.
    - `lamports`: An unsigned long integer representing the lamports for the stake reward.
- **Logic and Control Flow**:
    - Retrieve the stake reward pool and map from the `epoch_rewards` structure.
    - Check if a stake reward entry with the given `pubkey` already exists in the map; if it does, log a critical error and exit.
    - Acquire a new stake reward element from the stake reward pool.
    - Set the `stake_pubkey`, `credits_observed`, and `lamports` fields of the acquired stake reward element.
    - Insert the new stake reward element into the stake reward map.
    - Update the `total_stake_rewards` and `stake_rewards_cnt` fields of the `epoch_rewards` structure.
- **Output**: No return value; the function modifies the `epoch_rewards` structure in place.
- **Functions Called**:
    - [`fd_epoch_rewards_get_stake_reward_pool`](<#fd_epoch_rewards_get_stake_reward_pool>)
    - [`fd_epoch_rewards_get_stake_reward_map`](<#fd_epoch_rewards_get_stake_reward_map>)


---
### fd\_epoch\_rewards\_hash\_into\_partitions<!-- {{#callable:fd_epoch_rewards_hash_into_partitions}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_epoch_rewards.c#L216>)

Distributes stake rewards into partitions based on a hash derived from the parent block hash and the stake public key.
- **Inputs**:
    - `epoch_rewards`: A pointer to `fd_epoch_rewards_t`, which contains the epoch rewards data structure.
    - `parent_blockhash`: A constant pointer to `fd_hash_t`, representing the hash of the parent block.
    - `num_partitions`: An unsigned long integer specifying the number of partitions to divide the rewards into.
- **Logic and Control Flow**:
    - Retrieve the stake reward pool and map from `epoch_rewards`.
    - Set the number of partitions in `epoch_rewards` to `num_partitions`.
    - Initialize an iterator for the stake reward map.
    - For each stake reward in the map, initialize a `fd_siphash13_t` hasher.
    - Append the `parent_blockhash` and the stake public key to the hasher.
    - Finalize the hash to get a 64-bit hash value.
    - Calculate the partition index using the hash value and `num_partitions`.
    - Retrieve the partition dlist using the calculated partition index.
    - Push the stake reward to the tail of the partition dlist.
- **Output**: No return value; the function modifies the `epoch_rewards` structure by distributing stake rewards into partitions.
- **Functions Called**:
    - [`fd_epoch_rewards_get_stake_reward_pool`](<#fd_epoch_rewards_get_stake_reward_pool>)
    - [`fd_epoch_rewards_get_stake_reward_map`](<#fd_epoch_rewards_get_stake_reward_map>)
    - [`fd_epoch_rewards_get_partition_index`](<#fd_epoch_rewards_get_partition_index>)


---
### fd\_epoch\_rewards\_iter\_ele<!-- {{#callable:fd_epoch_rewards_iter_ele}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_epoch_rewards.c#L247>)

Retrieves the current element from an epoch rewards iterator.
- **Inputs**:
    - ``iter``: A pointer to an `fd_epoch_rewards_iter_t` structure, which contains the iterator state, including the current position, the doubly linked list, and the pool of stake rewards.
- **Logic and Control Flow**:
    - Calls `fd_epoch_stake_reward_dlist_iter_ele` with the iterator's current position, doubly linked list, and pool to retrieve the current element.
- **Output**: Returns a pointer to an `fd_epoch_stake_reward_t` structure, representing the current stake reward element in the iteration.


---
### fd\_epoch\_rewards\_iter\_init<!-- {{#callable:fd_epoch_rewards_iter_init}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_epoch_rewards.c#L252>)

Initializes an iterator for iterating over stake rewards in a specific partition of epoch rewards.
- **Inputs**:
    - `iter`: A pointer to `fd_epoch_rewards_iter_t` that will be initialized.
    - `epoch_rewards`: A constant pointer to `fd_epoch_rewards_t` representing the epoch rewards data structure.
    - `partition_idx`: An unsigned long integer representing the index of the partition to iterate over.
- **Logic and Control Flow**:
    - Retrieve the stake reward pool from `epoch_rewards` and assign it to `iter->pool`.
    - Retrieve the partition index from `epoch_rewards` using `partition_idx` and assign it to `iter->dlist`.
    - Initialize a forward iterator for the dlist and assign it to `iter->iter`.
    - Return the initialized `iter`.
- **Output**: Returns the initialized `fd_epoch_rewards_iter_t` pointer.
- **Functions Called**:
    - [`fd_epoch_rewards_get_stake_reward_pool`](<#fd_epoch_rewards_get_stake_reward_pool>)
    - [`fd_epoch_rewards_get_partition_index`](<#fd_epoch_rewards_get_partition_index>)


---
### fd\_epoch\_rewards\_iter\_done<!-- {{#callable:fd_epoch_rewards_iter_done}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_epoch_rewards.c#L262>)

Checks if the iteration over the epoch rewards is complete.
- **Inputs**:
    - ``iter``: A pointer to an `fd_epoch_rewards_iter_t` structure, which contains the state of the current iteration over the epoch rewards.
- **Logic and Control Flow**:
    - Calls `fd_epoch_stake_reward_dlist_iter_done` with `iter->iter`, `iter->dlist`, and `iter->pool` as arguments.
    - Returns the result of the `fd_epoch_stake_reward_dlist_iter_done` function call.
- **Output**: An integer indicating whether the iteration is complete (non-zero if done, zero if not done).


---
### fd\_epoch\_rewards\_iter\_next<!-- {{#callable:fd_epoch_rewards_iter_next}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_epoch_rewards.c#L267>)

Advances the iterator to the next element in the doubly linked list of epoch stake rewards.
- **Inputs**:
    - `iter`: A pointer to an `fd_epoch_rewards_iter_t` structure, which contains the current state of the iteration, including the current position in the doubly linked list, the list itself, and the pool of stake rewards.
- **Logic and Control Flow**:
    - Calls `fd_epoch_stake_reward_dlist_iter_fwd_next` with the current iterator position, the doubly linked list, and the pool to get the next position in the list.
    - Updates the `iter->iter` field with the new position returned by `fd_epoch_stake_reward_dlist_iter_fwd_next`.
- **Output**: No output is returned; the function updates the iterator in place.



---
Made with ❤️ by [Driver](https://www.driver.ai/)