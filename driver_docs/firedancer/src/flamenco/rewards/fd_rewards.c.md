<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for calculating and distributing epoch rewards, including inflation, stake, and vote rewards, in a partitioned manner.

# Purpose
The code is a C module that manages the calculation and distribution of inflation rewards in a blockchain system. It includes functions to calculate inflation rates, determine the starting slot for inflation, and compute the number of slots for inflation. The module also handles the calculation of stake points and credits, which are essential for determining the rewards for validators and stakeholders. The functions [`calculate_stake_points_and_credits`](<#calculate_stake_points_and_credits>) and [`calculate_stake_points_and_credits_recalculation`](<#calculate_stake_points_and_credits_recalculation>) are responsible for computing the points earned by stake accounts based on their credits and stake amounts.

The module also includes functions for distributing rewards, such as [`redeem_rewards`](<#redeem_rewards>), which calculates the rewards for each stake account, and [`distribute_epoch_rewards_in_partition`](<#distribute_epoch_rewards_in_partition>), which processes reward credits for a partition of rewards. The code is designed to be integrated into a larger system, as indicated by the inclusion of various header files and the use of data structures like `fd_bank_t`, `fd_stake_delegation_t`, and `fd_vote_state_ele_t`. The module is not an executable but rather a library intended to be used by other parts of the system to manage reward distribution efficiently. It defines several static functions, indicating that these are internal to the module and not intended for external use.
# Imports and Dependencies

---
- `fd_rewards.h`
- `math.h`
- `../runtime/fd_acc_mgr.h`
- `../runtime/fd_executor_err.h`
- `../runtime/program/fd_vote_program.h`
- `../runtime/sysvar/fd_sysvar_epoch_rewards.h`
- `../runtime/sysvar/fd_sysvar_epoch_schedule.h`
- `../stakes/fd_stakes.h`
- `../runtime/program/fd_stake_program.h`
- `../runtime/sysvar/fd_sysvar_stake_history.h`
- `../runtime/context/fd_capture_ctx.h`
- `../runtime/fd_runtime_stack.h`
- `../runtime/fd_runtime.h`
- `fd_epoch_rewards.h`


# Functions

---
### total<!-- {{#callable:total}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_rewards.c#L18>)

Calculates the tapered inflation rate for a given year and returns the greater of the tapered rate or the terminal rate.
- **Inputs**:
    - ``inflation``: A pointer to a `fd_inflation_t` structure containing inflation parameters such as `initial`, `taper`, and `terminal` rates.
    - ``year``: A `double` representing the year for which the inflation rate is calculated.
- **Logic and Control Flow**:
    - Checks if `year` is 0.0 and logs an error if true.
    - Calculates the `tapered` inflation rate using the formula `inflation->initial * pow((1.0 - inflation->taper), year)`.
    - Compares the `tapered` rate with `inflation->terminal` and returns the greater value.
- **Output**: Returns a `double` representing the calculated inflation rate for the given year.


---
### foundation<!-- {{#callable:foundation}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_rewards.c#L28>)

Calculates the foundation rate for a given year based on inflation parameters.
- **Inputs**:
    - `inflation`: A pointer to a `fd_inflation_t` structure containing inflation parameters.
    - `year`: A `double` representing the year for which the foundation rate is calculated.
- **Logic and Control Flow**:
    - Checks if `year` is less than `inflation->foundation_term`.
    - If true, calculates the foundation rate by multiplying `inflation->foundation` with the result of `total(inflation, year)`.
    - If false, returns 0.0.
- **Output**: Returns a `double` representing the calculated foundation rate or 0.0 if the year is beyond the foundation term.
- **Functions Called**:
    - [`total`](<#total>)


---
### validator<!-- {{#callable:validator}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_rewards.c#L34>)

Calculates the validator rate by subtracting the foundation rate from the total inflation rate for a given year.
- **Inputs**:
    - ``inflation``: A pointer to a `fd_inflation_t` structure containing inflation parameters.
    - ``year``: A `double` representing the year for which the validator rate is calculated.
- **Logic and Control Flow**:
    - Logs the validator rate and related parameters using `FD_LOG_DEBUG` for debugging purposes.
    - Calls the [`total`](<#total>) function to calculate the total inflation rate for the given year.
    - Calls the [`foundation`](<#foundation>) function to calculate the foundation rate for the given year.
    - Subtracts the foundation rate from the total inflation rate to compute the validator rate.
    - Returns the computed validator rate.
- **Output**: Returns a `double` representing the validator rate for the specified year.
- **Functions Called**:
    - [`total`](<#total>)
    - [`foundation`](<#foundation>)


---
### get\_inflation\_start\_slot<!-- {{#callable:get_inflation_start_slot}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_rewards.c#L47>)

Calculates the starting slot for inflation based on the activation slots of specific features in the bank.
- **Inputs**:
    - ``bank``: A pointer to a `fd_bank_t` structure representing the bank from which to query feature activation slots.
- **Logic and Control Flow**:
    - Check if the `devnet_and_testnet` feature is active in the bank; if active, set `devnet_and_testnet` to its activation slot, otherwise set it to `ULONG_MAX`.
    - Initialize `enable` to `ULONG_MAX`.
    - If both `full_inflation_vote` and `full_inflation_enable` features are active, set `enable` to the activation slot of `full_inflation_enable`.
    - Calculate `min_slot` as the minimum of `enable` and `devnet_and_testnet`.
    - If `min_slot` is `ULONG_MAX`, check if the `pico_inflation` feature is active; if active, set `min_slot` to its activation slot, otherwise set it to 0.
    - Return `min_slot`.
- **Output**: Returns the calculated starting slot for inflation as an `ulong`.


---
### get\_inflation\_num\_slots<!-- {{#callable:get_inflation_num_slots}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_rewards.c#L71>)

Calculates the number of slots between the start of inflation and a given slot.
- **Inputs**:
    - ``bank``: A pointer to a `fd_bank_t` structure representing the bank state.
    - ``epoch_schedule``: A pointer to a `fd_epoch_schedule_t` structure representing the epoch schedule.
    - ``slot``: An unsigned long integer representing the current slot number.
- **Logic and Control Flow**:
    - Call [`get_inflation_start_slot`](<#get_inflation_start_slot>) with `bank` to get the `inflation_activation_slot`.
    - Calculate `inflation_start_slot` by converting the epoch of `inflation_activation_slot` to a slot number and subtracting one epoch's worth of slots.
    - Convert the input `slot` to its corresponding epoch.
    - Calculate the difference between the slot number of the input `slot`'s epoch start and `inflation_start_slot`.
- **Output**: Returns the number of slots as an unsigned long integer.
- **Functions Called**:
    - [`get_inflation_start_slot`](<#get_inflation_start_slot>)


---
### slot\_in\_year\_for\_inflation<!-- {{#callable:slot_in_year_for_inflation}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_rewards.c#L87>)

Calculates the fraction of slots in a year that have passed since the start of inflation for a given bank.
- **Inputs**:
    - ``bank``: A pointer to a `fd_bank_t` structure representing the bank for which the calculation is performed.
- **Logic and Control Flow**:
    - Query the epoch schedule for the given `bank` using `fd_bank_epoch_schedule_query`.
    - Calculate the number of slots since the start of inflation using [`get_inflation_num_slots`](<#get_inflation_num_slots>), passing the `bank`, the queried epoch schedule, and the current slot from `fd_bank_slot_get`.
    - Divide the number of slots by the total number of slots per year obtained from `fd_bank_slots_per_year_get`.
- **Output**: Returns a `double` representing the fraction of the year that has passed in terms of slots since the start of inflation.
- **Functions Called**:
    - [`get_inflation_num_slots`](<#get_inflation_num_slots>)


---
### get\_vote\_credits<!-- {{#callable:get_vote_credits}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_rewards.c#L94>)

Decodes vote state versioned data from account data and assigns the corresponding epoch credits to the provided pointer.
- **Inputs**:
    - ``account_data``: Pointer to the account data to decode.
    - ``account_data_len``: Length of the account data.
    - ``buf``: Buffer to store the decoded vote state versioned data.
    - ``credits``: Pointer to a pointer where the function will store the address of the epoch credits.
- **Logic and Control Flow**:
    - Initialize a `fd_bincode_decode_ctx_t` structure with `account_data` and `account_data_len` to set up the decoding context.
    - Call `fd_vote_state_versioned_decode` with `buf` and the decoding context to decode the vote state versioned data.
    - Check if the decoded vote state versioned data (`vsv`) is `NULL`, and log a critical error if it is.
    - Use a switch statement on `vsv->discriminant` to determine the version of the vote state and assign the corresponding `epoch_credits` to `*credits`.
    - Handle different versions: `fd_vote_state_versioned_enum_v0_23_5`, `fd_vote_state_versioned_enum_v1_14_11`, and `fd_vote_state_versioned_enum_current`.
    - Use `__builtin_unreachable()` for the default case, indicating that all possible cases are covered.
- **Output**: The function does not return a value but assigns the address of the epoch credits to the `credits` pointer.


---
### calculate\_stake\_points\_and\_credits\_recalculation<!-- {{#callable:calculate_stake_points_and_credits_recalculation}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_rewards.c#L125>)

Calculates stake points and updates credits based on the comparison of observed credits between stake and vote accounts.
- **Inputs**:
    - `stake_history`: A pointer to `fd_stake_history_t` containing the history of stake activations and deactivations.
    - `stake`: A pointer to `fd_stake_delegation_t` representing the current stake delegation details.
    - `new_rate_activation_epoch`: A pointer to an `ulong` where the function may store the new rate activation epoch.
    - `recalc_vote_state_credits`: A pointer to `fd_vote_state_credits_t` containing the credits information for recalculation.
    - `result`: A pointer to `fd_calculated_stake_points_t` where the function will store the calculated stake points and updated credits.
- **Logic and Control Flow**:
    - Initialize `credits_in_stake` and `credits_in_vote` from the stake and vote state credits respectively.
    - If `credits_in_vote` is less than `credits_in_stake`, set `result->points` to 0, update `result->new_credits_observed` to `credits_in_vote`, set `result->force_credits_update_with_skipped_reward` to 1, and return.
    - If `credits_in_vote` equals `credits_in_stake`, set `result->points` to 0, update `result->new_credits_observed` to `credits_in_vote`, set `result->force_credits_update_with_skipped_reward` to 0, and return.
    - Initialize `points` to 0 and `new_credits_observed` to `credits_in_stake`.
    - Iterate over each credit in `recalc_vote_state_credits->credits` and calculate `earned_credits` based on the comparison with `credits_in_stake`.
    - Update `new_credits_observed` to the maximum of itself and `final_epoch_credits`.
    - Create a `fd_delegation_t` structure with details from `stake`.
    - Calculate `stake_amount` using `fd_stake_activating_and_deactivating` and add the product of `stake_amount` and `earned_credits` to `points`.
    - After the loop, update `result->points`, `result->new_credits_observed`, and set `result->force_credits_update_with_skipped_reward` to 0.
- **Output**: Updates the `result` structure with calculated stake points, new credits observed, and a flag indicating if a forced credits update is needed.


---
### calculate\_stake\_points\_and\_credits<!-- {{#callable:calculate_stake_points_and_credits}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_rewards.c#L199>)

Calculates the stake points and credits for a given stake and vote state, updating the result with the calculated points and credits observed.
- **Inputs**:
    - ``funk``: A pointer to the `fd_funk_t` structure, representing the current state of the system.
    - ``xid``: A constant pointer to the `fd_funk_txn_xid_t` structure, representing the transaction ID.
    - ``stake_history``: A constant pointer to the `fd_stake_history_t` structure, representing the history of stake changes.
    - ``stake``: A constant pointer to the `fd_stake_delegation_t` structure, representing the stake delegation details.
    - ``vote_state``: A constant pointer to the `fd_vote_state_ele_t` structure, representing the vote state information.
    - ``new_rate_activation_epoch``: A pointer to an unsigned long, representing the new rate activation epoch.
    - ``result``: A pointer to the `fd_calculated_stake_points_t` structure, where the calculated stake points and credits will be stored.
- **Logic and Control Flow**:
    - Initialize a `vote_rec` account and attempt to read the vote account data using `fd_txn_account_init_from_funk_readonly`; log an error if unsuccessful.
    - Retrieve vote credits using [`get_vote_credits`](<#get_vote_credits>) and store them in `epoch_credits`.
    - Compare `credits_in_vote` from the vote account with `credits_in_stake` from the stake account.
    - If `credits_in_vote` is less than `credits_in_stake`, set `result->points` to 0, update `result->new_credits_observed`, set `result->force_credits_update_with_skipped_reward` to 1, and return.
    - If `credits_in_vote` equals `credits_in_stake`, set `result->points` to 0, update `result->new_credits_observed`, set `result->force_credits_update_with_skipped_reward` to 0, and return.
    - Iterate over each epoch credit in `epoch_credits` to calculate earned credits and update `new_credits_observed`.
    - For each epoch credit, calculate the effective stake amount using `fd_stake_activating_and_deactivating` and accumulate the points.
    - Update `result->points`, `result->new_credits_observed`, and set `result->force_credits_update_with_skipped_reward` to 0.
- **Output**: The function updates the `result` structure with the calculated stake points, new credits observed, and a flag indicating if a credits update with skipped reward is forced.
- **Functions Called**:
    - [`get_vote_credits`](<#get_vote_credits>)


---
### redeem\_rewards<!-- {{#callable:redeem_rewards}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_rewards.c#L293>)

Calculates and distributes rewards for a given stake and vote state based on earned points and total rewards.
- **Inputs**:
    - ``funk``: Pointer to `fd_funk_t`, representing the transaction context.
    - ``xid``: Pointer to `fd_funk_txn_xid_t`, representing the transaction ID.
    - ``stake_history``: Pointer to `fd_stake_history_t`, representing the history of stake changes.
    - ``stake``: Pointer to `fd_stake_delegation_t`, representing the stake delegation details.
    - ``vote_state``: Pointer to `fd_vote_state_ele_t`, representing the vote state information.
    - ``rewarded_epoch``: Unsigned long integer representing the epoch for which rewards are being calculated.
    - ``total_rewards``: Unsigned long integer representing the total rewards available for distribution.
    - ``total_points``: 128-bit unsigned integer representing the total points earned by all stakes.
    - ``new_rate_activation_epoch``: Pointer to an unsigned long integer, used to store the new rate activation epoch.
    - ``recalc_vote_state_credits``: Pointer to `fd_vote_state_credits_t`, used for recalculating vote state credits if necessary.
    - ``result``: Pointer to `fd_calculated_stake_rewards_t`, used to store the calculated rewards for the stake.
- **Logic and Control Flow**:
    - Initialize `fd_calculated_stake_points_t` structure to store stake points results.
    - Check if `recalc_vote_state_credits` is NULL; if so, call [`calculate_stake_points_and_credits`](<#calculate_stake_points_and_credits>), otherwise call [`calculate_stake_points_and_credits_recalculation`](<#calculate_stake_points_and_credits_recalculation>).
    - If `total_rewards` is zero or the stake's activation epoch matches `rewarded_epoch`, set `force_credits_update_with_skipped_reward` to 1.
    - If `force_credits_update_with_skipped_reward` is set, set `staker_rewards` and `voter_rewards` to 0, update `new_credits_observed`, and return 0.
    - If `stake_points_result.points` or `total_points` is zero, return 1.
    - Calculate `rewards` by dividing the product of `stake_points_result.points` and `total_rewards` by `total_points`.
    - If `rewards` is zero, return 1.
    - Call `fd_vote_commission_split` to split `rewards` into `staker_portion` and `voter_portion`.
    - If the split results in zero for either portion, return 1.
    - Update `result` with calculated `staker_rewards`, `voter_rewards`, and `new_credits_observed`.
    - Return 0 to indicate successful reward calculation.
- **Output**: Returns 0 on success, or 1 if there is an error in reward calculation.
- **Functions Called**:
    - [`calculate_stake_points_and_credits`](<#calculate_stake_points_and_credits>)
    - [`calculate_stake_points_and_credits_recalculation`](<#calculate_stake_points_and_credits_recalculation>)


---
### get\_slots\_in\_epoch<!-- {{#callable:get_slots_in_epoch}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_rewards.c#L367>)

Calculates the number of slots in a given epoch based on the epoch schedule.
- **Inputs**:
    - ``epoch``: The epoch number for which to calculate the number of slots.
    - ``epoch_schedule``: A pointer to a constant `fd_epoch_schedule_t` structure that contains the schedule information for epochs.
- **Logic and Control Flow**:
    - Check if `epoch` is less than `epoch_schedule->first_normal_epoch`.
    - If true, calculate the number of slots as `1UL << fd_ulong_sat_add(epoch, FD_EPOCH_LEN_MIN_TRAILING_ZERO)`.
    - If false, return `epoch_schedule->slots_per_epoch`.
- **Output**: Returns the number of slots in the specified epoch as an unsigned long integer.


---
### epoch\_duration\_in\_years<!-- {{#callable:epoch_duration_in_years}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_rewards.c#L376>)

Calculates the duration of a given epoch in years based on the number of slots in the epoch and the number of slots per year.
- **Inputs**:
    - `bank`: A pointer to a `fd_bank_t` structure representing the bank context.
    - `prev_epoch`: An unsigned long integer representing the previous epoch number.
- **Logic and Control Flow**:
    - Call `fd_bank_epoch_schedule_query` with `bank` to get the epoch schedule.
    - Call [`get_slots_in_epoch`](<#get_slots_in_epoch>) with `prev_epoch` and the retrieved epoch schedule to get the number of slots in the epoch.
    - Call `fd_bank_slots_per_year_get` with `bank` to get the number of slots per year.
    - Divide the number of slots in the epoch by the number of slots per year to calculate the epoch duration in years.
- **Output**: Returns a double representing the duration of the epoch in years.
- **Functions Called**:
    - [`get_slots_in_epoch`](<#get_slots_in_epoch>)


---
### calculate\_previous\_epoch\_inflation\_rewards<!-- {{#callable:calculate_previous_epoch_inflation_rewards}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_rewards.c#L384>)

Calculates the inflation rewards for the previous epoch based on the bank's inflation parameters and previous epoch's capitalization.
- **Inputs**:
    - ``bank``: A pointer to the `fd_bank_t` structure representing the bank context.
    - ``prev_epoch_capitalization``: An unsigned long representing the capitalization of the previous epoch.
    - ``prev_epoch``: An unsigned long representing the previous epoch number.
    - ``rewards``: A pointer to the `fd_prev_epoch_inflation_rewards_t` structure where the calculated rewards will be stored.
- **Logic and Control Flow**:
    - Calculate the number of slots in a year for inflation using [`slot_in_year_for_inflation`](<#slot_in_year_for_inflation>) function.
    - Query the validator and foundation rates using the [`validator`](<#validator>) and [`foundation`](<#foundation>) functions with the bank's inflation parameters and slots in a year.
    - Calculate the duration of the previous epoch in years using [`epoch_duration_in_years`](<#epoch_duration_in_years>).
    - Compute the validator rewards by multiplying the validator rate, previous epoch capitalization, and previous epoch duration in years.
    - Log the calculated rewards, rates, duration, capitalization, and slots in a year for debugging purposes.
- **Output**: Stores the calculated validator rate, foundation rate, previous epoch duration in years, and validator rewards in the `rewards` structure.
- **Functions Called**:
    - [`slot_in_year_for_inflation`](<#slot_in_year_for_inflation>)
    - [`validator`](<#validator>)
    - [`foundation`](<#foundation>)
    - [`epoch_duration_in_years`](<#epoch_duration_in_years>)


---
### get\_minimum\_stake\_delegation<!-- {{#callable:get_minimum_stake_delegation}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_rewards.c#L399>)

Determines the minimum stake delegation required for rewards based on active bank features.
- **Inputs**:
    - `bank`: A pointer to an `fd_bank_t` structure representing the bank context.
- **Logic and Control Flow**:
    - Check if the feature `stake_minimum_delegation_for_rewards` is active in the bank.
    - If the feature is not active, return 0.
    - If the feature `stake_raise_minimum_delegation_to_1_sol` is active, return `LAMPORTS_PER_SOL`.
    - If neither feature is active, return 1.
- **Output**: Returns an `ulong` representing the minimum stake delegation required.


---
### calculate\_reward\_points\_partitioned<!-- {{#callable:calculate_reward_points_partitioned}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_rewards.c#L414>)

Calculates the total reward points for stake delegations that meet the minimum stake requirement by iterating through each delegation and computing points based on vote states and stake history.
- **Inputs**:
    - ``bank``: A pointer to the `fd_bank_t` structure, representing the bank context.
    - ``funk``: A pointer to the `fd_funk_t` structure, representing the transaction context.
    - ``xid``: A constant pointer to the `fd_funk_txn_xid_t` structure, representing the transaction ID.
    - ``stake_delegations``: A constant pointer to the `fd_stake_delegations_t` structure, representing the stake delegations to process.
    - ``stake_history``: A constant pointer to the `fd_stake_history_t` structure, representing the stake history data.
- **Logic and Control Flow**:
    - Retrieve the minimum stake delegation value using [`get_minimum_stake_delegation`](<#get_minimum_stake_delegation>) function.
    - Initialize variables for error handling and warmup/cooldown rate epoch calculation.
    - Query the bank for vote states and initialize an iterator for the stake delegations.
    - Iterate over each stake delegation using `fd_stake_delegations_iter_init`, `fd_stake_delegations_iter_done`, and `fd_stake_delegations_iter_next`.
    - For each stake delegation, check if the stake is below the minimum required; if so, skip to the next delegation.
    - Query the vote state for the current stake delegation's vote account; if not found, skip to the next delegation.
    - Calculate stake points and credits using [`calculate_stake_points_and_credits`](<#calculate_stake_points_and_credits>) function and add the result to `total_points`.
    - Release the lock on vote states with `fd_bank_vote_states_end_locking_query`.
- **Output**: Returns the total reward points as a `uint128` value.
- **Functions Called**:
    - [`get_minimum_stake_delegation`](<#get_minimum_stake_delegation>)
    - [`calculate_stake_points_and_credits`](<#calculate_stake_points_and_credits>)


---
### calculate\_stake\_vote\_rewards<!-- {{#callable:calculate_stake_vote_rewards}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_rewards.c#L487>)

Calculates and distributes stake and vote rewards for each stake account based on the current and previous epoch states.
- **Inputs**:
    - ``bank``: Pointer to the `fd_bank_t` structure representing the bank state.
    - ``funk``: Pointer to the `fd_funk_t` structure representing the transaction context.
    - ``xid``: Pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``stake_delegations``: Pointer to the `fd_stake_delegations_t` structure containing stake delegations.
    - ``capture_ctx``: Pointer to the `fd_capture_ctx_t` structure for capturing events, can be NULL.
    - ``stake_history``: Pointer to the `fd_stake_history_t` structure containing stake history.
    - ``rewarded_epoch``: Unsigned long representing the epoch for which rewards are calculated.
    - ``total_rewards``: Unsigned long representing the total rewards available for distribution.
    - ``total_points``: 128-bit unsigned integer representing the total points calculated for rewards distribution.
    - ``runtime_stack``: Pointer to the `fd_runtime_stack_t` structure used for runtime operations.
- **Logic and Control Flow**:
    - Initialize variables for error handling and warmup/cooldown rate epoch calculation.
    - Determine the minimum stake delegation required for rewards using [`get_minimum_stake_delegation`](<#get_minimum_stake_delegation>).
    - Get the count of stake delegations using `fd_stake_delegations_cnt`.
    - Select the appropriate vote states based on `runtime_stack->stakes.prev_vote_credits_used`.
    - Join and initialize epoch rewards using [`fd_epoch_rewards_join`](<fd_epoch_rewards.c.md#fd_epoch_rewards_join>) and [`fd_epoch_rewards_new`](<fd_epoch_rewards.c.md#fd_epoch_rewards_new>).
    - Reset vote rewards in `runtime_stack->stakes.vote_rewards` to zero.
    - Iterate over each stake delegation using `fd_stake_delegations_iter_init`, `fd_stake_delegations_iter_done`, and `fd_stake_delegations_iter_next`.
    - For each stake delegation, check if it meets the minimum stake requirement and query the corresponding vote state.
    - Calculate rewards using [`redeem_rewards`](<#redeem_rewards>) and handle errors if any occur.
    - If `capture_ctx` is provided, write stake reward events using `fd_solcap_write_stake_reward_event`.
    - Update `runtime_stack->stakes.vote_rewards` with calculated voter rewards.
    - Insert calculated rewards into epoch rewards using [`fd_epoch_rewards_insert`](<fd_epoch_rewards.c.md#fd_epoch_rewards_insert>).
    - End epoch rewards modification using `fd_bank_epoch_rewards_end_locking_modify`.
    - End vote states modification based on `runtime_stack->stakes.prev_vote_credits_used`.
- **Output**: No return value; the function modifies the bank state and runtime stack to reflect calculated rewards.
- **Functions Called**:
    - [`get_minimum_stake_delegation`](<#get_minimum_stake_delegation>)
    - [`fd_epoch_rewards_join`](<fd_epoch_rewards.c.md#fd_epoch_rewards_join>)
    - [`fd_epoch_rewards_new`](<fd_epoch_rewards.c.md#fd_epoch_rewards_new>)
    - [`redeem_rewards`](<#redeem_rewards>)
    - [`fd_epoch_rewards_insert`](<fd_epoch_rewards.c.md#fd_epoch_rewards_insert>)


---
### calculate\_validator\_rewards<!-- {{#callable:calculate_validator_rewards}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_rewards.c#L589>)

Calculates epoch reward points and distributes stake and vote rewards for validators.
- **Inputs**:
    - ``bank``: Pointer to the `fd_bank_t` structure representing the bank state.
    - ``funk``: Pointer to the `fd_funk_t` structure representing the funk state.
    - ``xid``: Pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``runtime_stack``: Pointer to the `fd_runtime_stack_t` structure used for runtime operations.
    - ``stake_delegations``: Pointer to the `fd_stake_delegations_t` structure containing stake delegations.
    - ``capture_ctx``: Pointer to the `fd_capture_ctx_t` structure for capturing context, can be NULL.
    - ``rewarded_epoch``: Unsigned long integer representing the epoch for which rewards are calculated.
    - ``rewards_out``: Pointer to an unsigned long integer where the calculated rewards will be stored.
- **Logic and Control Flow**:
    - Reads the stake history using `fd_sysvar_stake_history_read` and logs an error if it fails.
    - Calculates reward points using [`calculate_reward_points_partitioned`](<#calculate_reward_points_partitioned>) with the given bank, funk, xid, stake delegations, and stake history.
    - Sets `rewards_out` to 0 if no points are calculated, otherwise retains its value.
    - If `capture_ctx` is not NULL, begins capturing stake rewards using `fd_solcap_writer_stake_rewards_begin`.
    - Calls [`calculate_stake_vote_rewards`](<#calculate_stake_vote_rewards>) to calculate and distribute stake and vote rewards for each account.
- **Output**: Returns a `uint128` value representing the total reward points calculated for the epoch.
- **Functions Called**:
    - [`calculate_reward_points_partitioned`](<#calculate_reward_points_partitioned>)
    - [`calculate_stake_vote_rewards`](<#calculate_stake_vote_rewards>)


---
### get\_reward\_distribution\_num\_blocks<!-- {{#callable:get_reward_distribution_num_blocks}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_rewards.c#L645>)

Calculates the number of blocks needed to distribute rewards to all stake accounts based on the epoch schedule and total stake accounts.
- **Inputs**:
    - ``epoch_schedule``: A pointer to a `fd_epoch_schedule_t` structure that contains information about the epoch schedule.
    - ``slot``: An unsigned long integer representing the current slot number.
    - ``total_stake_accounts``: An unsigned long integer representing the total number of stake accounts.
- **Logic and Control Flow**:
    - Check if the `epoch_schedule` is in warmup phase and if the current epoch is before the first normal epoch; if true, return 1 block.
    - Calculate `num_chunks` as the number of stake accounts divided by `STAKE_ACCOUNT_STORES_PER_BLOCK`, adding 1 if there is a remainder.
    - Ensure `num_chunks` is at least 1 using `fd_ulong_max`.
    - Limit `num_chunks` to a maximum value based on the slots per epoch divided by `MAX_FACTOR_OF_REWARD_BLOCKS_IN_EPOCH`, using `fd_ulong_min`.
    - Return the calculated `num_chunks`.
- **Output**: Returns an unsigned long integer representing the number of blocks required for reward distribution.


---
### calculate\_rewards\_for\_partitioning<!-- {{#callable:calculate_rewards_for_partitioning}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_rewards.c#L665>)

Calculates rewards from the previous epoch to prepare for partitioned distribution.
- **Inputs**:
    - ``bank``: A pointer to the `fd_bank_t` structure representing the bank.
    - ``funk``: A pointer to the `fd_funk_t` structure representing the funk.
    - ``xid``: A pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``runtime_stack``: A pointer to the `fd_runtime_stack_t` structure representing the runtime stack.
    - ``stake_delegations``: A pointer to the `fd_stake_delegations_t` structure representing the stake delegations.
    - ``capture_ctx``: A pointer to the `fd_capture_ctx_t` structure representing the capture context.
    - ``prev_epoch``: An unsigned long integer representing the previous epoch.
    - ``result``: A pointer to the `fd_partitioned_rewards_calculation_t` structure where the result will be stored.
- **Logic and Control Flow**:
    - Initialize `fd_prev_epoch_inflation_rewards_t` structure `rewards`.
    - Call [`calculate_previous_epoch_inflation_rewards`](<#calculate_previous_epoch_inflation_rewards>) to compute inflation rewards for the previous epoch and store in `rewards`.
    - Set `total_rewards` to `rewards.validator_rewards`.
    - Call [`calculate_validator_rewards`](<#calculate_validator_rewards>) to compute validator rewards and points, updating `total_rewards`.
    - Store the calculated points, rewards, rates, and capitalization in the `result` structure.
- **Output**: The function does not return a value but populates the `result` structure with calculated rewards and related data.
- **Functions Called**:
    - [`calculate_previous_epoch_inflation_rewards`](<#calculate_previous_epoch_inflation_rewards>)
    - [`calculate_validator_rewards`](<#calculate_validator_rewards>)


---
### calculate\_rewards\_and\_distribute\_vote\_rewards<!-- {{#callable:calculate_rewards_and_distribute_vote_rewards}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_rewards.c#L705>)

Calculates rewards for the previous epoch and distributes vote rewards to vote accounts.
- **Inputs**:
    - ``bank``: A pointer to the `fd_bank_t` structure representing the bank where rewards and vote states are stored.
    - ``accdb``: A pointer to the `fd_accdb_user_t` structure representing the account database user.
    - ``xid``: A constant pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``runtime_stack``: A pointer to the `fd_runtime_stack_t` structure used for runtime operations and storing vote rewards.
    - ``stake_delegations``: A constant pointer to the `fd_stake_delegations_t` structure representing the stake delegations.
    - ``capture_ctx``: A pointer to the `fd_capture_ctx_t` structure used for capturing context during operations.
    - ``prev_epoch``: An unsigned long integer representing the previous epoch number.
- **Logic and Control Flow**:
    - Calculate stake and vote rewards for the completed epoch using [`calculate_rewards_for_partitioning`](<#calculate_rewards_for_partitioning>) and store results in `rewards_calc_result`.
    - Query the vote states from the bank using `fd_bank_vote_states_locking_query`.
    - Iterate over each vote state using `fd_vote_states_iter_init` and `fd_vote_states_iter_next`.
    - For each vote state, retrieve the vote rewards from `runtime_stack` and check if rewards are non-zero.
    - Initialize a mutable transaction account for the vote account using `fd_txn_account_init_from_funk_mutable`.
    - Calculate the previous hash of the vote account using `fd_hashes_account_lthash`.
    - Set the slot for the vote account using `fd_txn_account_set_slot`.
    - Add the calculated rewards to the vote account using `fd_txn_account_checked_add_lamports`.
    - Update the hash of the vote account using `fd_hashes_update_lthash`.
    - Finalize the mutable transaction account using `fd_txn_account_mutable_fini`.
    - Accumulate the distributed rewards using `fd_ulong_sat_add`.
    - If `capture_ctx` is provided, log the vote account payout using `fd_solcap_write_vote_account_payout`.
    - End the vote states query using `fd_bank_vote_states_end_locking_query`.
    - Verify that the distributed rewards do not exceed the calculated validator rewards.
    - Update the bank's capitalization with the distributed rewards using `fd_bank_capitalization_set`.
    - Modify the epoch rewards in the bank to reflect the distributed rewards and total rewards using `fd_bank_epoch_rewards_locking_modify` and `fd_bank_epoch_rewards_end_locking_modify`.
- **Output**: No return value; the function modifies the bank and runtime stack structures to reflect the distributed rewards.
- **Functions Called**:
    - [`calculate_rewards_for_partitioning`](<#calculate_rewards_for_partitioning>)


---
### distribute\_epoch\_reward\_to\_stake\_acc<!-- {{#callable:distribute_epoch_reward_to_stake_acc}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_rewards.c#L807>)

Distributes a specified reward to a stake account and updates the account's state and bank records accordingly.
- **Inputs**:
    - ``bank``: Pointer to the `fd_bank_t` structure representing the bank where the stake account is managed.
    - ``accdb``: Pointer to the `fd_accdb_user_t` structure representing the account database user.
    - ``xid``: Pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``capture_ctx``: Pointer to the `fd_capture_ctx_t` structure used for capturing context, can be `NULL`.
    - ``stake_pubkey``: Pointer to the `fd_pubkey_t` structure representing the public key of the stake account.
    - ``reward_lamports``: Unsigned long integer representing the amount of reward in lamports to distribute.
    - ``new_credits_observed``: Unsigned long integer representing the new credits observed value to update in the stake account.
- **Logic and Control Flow**:
    - Initialize a mutable transaction account record for the stake account using `fd_txn_account_init_from_funk_mutable` and check for errors.
    - Calculate the previous hash of the account using `fd_hashes_account_lthash`.
    - Set the slot of the stake account record to the current bank slot using `fd_txn_account_set_slot`.
    - Retrieve the stake state using `fd_stake_get_state` and check if it is a valid stake account using `fd_stake_state_v2_is_stake`.
    - Add the reward lamports to the stake account using `fd_txn_account_checked_add_lamports` and check for errors.
    - Update the credits observed and delegation stake in the stake state.
    - Update the stake delegations in the bank using `fd_stake_delegations_update`.
    - If `capture_ctx` is provided, log the stake account payout using `fd_solcap_write_stake_account_payout`.
    - Write the updated stake state back to the account using `write_stake_state` and check for errors.
    - Update the hash of the account using `fd_hashes_update_lthash`.
    - Finalize the mutable transaction account record using `fd_txn_account_mutable_fini`.
- **Output**: Returns 0 on success, or 1 if an error occurs during the process.


---
### distribute\_epoch\_rewards\_in\_partition<!-- {{#callable:distribute_epoch_rewards_in_partition}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_rewards.c#L896>)

Distributes epoch rewards to stake accounts within a specified partition, updating the bank's capitalization and logging the results.
- **Inputs**:
    - ``epoch_rewards``: A pointer to `fd_epoch_rewards_t` containing the epoch rewards data.
    - ``partition_idx``: An unsigned long integer representing the index of the partition to process.
    - ``bank``: A pointer to `fd_bank_t` representing the bank where rewards are distributed.
    - ``accdb``: A pointer to `fd_accdb_user_t` representing the account database user.
    - ``xid``: A pointer to `fd_funk_txn_xid_t` representing the transaction ID.
    - ``capture_ctx``: A pointer to `fd_capture_ctx_t` used for capturing context during the distribution process.
- **Logic and Control Flow**:
    - Initialize `lamports_distributed` and `lamports_burned` to zero.
    - Initialize an iterator for the epoch rewards using [`fd_epoch_rewards_iter_init`](<fd_epoch_rewards.c.md#fd_epoch_rewards_iter_init>) with the given `partition_idx`.
    - Iterate over each stake reward in the partition using a loop with [`fd_epoch_rewards_iter_done`](<fd_epoch_rewards.c.md#fd_epoch_rewards_iter_done>) and [`fd_epoch_rewards_iter_next`](<fd_epoch_rewards.c.md#fd_epoch_rewards_iter_next>).
    - For each stake reward, attempt to distribute it to the stake account using [`distribute_epoch_reward_to_stake_acc`](<#distribute_epoch_reward_to_stake_acc>).
    - If distribution is successful, add the reward's lamports to `lamports_distributed`; otherwise, add them to `lamports_burned`.
    - Update the epoch rewards sysvar with the total amount of lamports distributed and burned using `fd_sysvar_epoch_rewards_distribute`.
    - Log the number of lamports burned and distributed using `FD_LOG_DEBUG`.
    - Update the bank's capitalization by adding `lamports_distributed` to the current capitalization.
- **Output**: No return value; the function operates by side effects on the bank and logs the results.
- **Functions Called**:
    - [`fd_epoch_rewards_iter_init`](<fd_epoch_rewards.c.md#fd_epoch_rewards_iter_init>)
    - [`fd_epoch_rewards_iter_done`](<fd_epoch_rewards.c.md#fd_epoch_rewards_iter_done>)
    - [`fd_epoch_rewards_iter_next`](<fd_epoch_rewards.c.md#fd_epoch_rewards_iter_next>)
    - [`fd_epoch_rewards_iter_ele`](<fd_epoch_rewards.c.md#fd_epoch_rewards_iter_ele>)
    - [`distribute_epoch_reward_to_stake_acc`](<#distribute_epoch_reward_to_stake_acc>)


---
### fd\_distribute\_partitioned\_epoch\_rewards<!-- {{#callable:fd_distribute_partitioned_epoch_rewards}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_rewards.c#L937>)

Distributes partitioned epoch rewards to stake accounts based on the current block height and epoch schedule.
- **Inputs**:
    - ``bank``: A pointer to the `fd_bank_t` structure representing the bank context.
    - ``accdb``: A pointer to the `fd_accdb_user_t` structure representing the account database user context.
    - ``xid``: A constant pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``capture_ctx``: A pointer to the `fd_capture_ctx_t` structure used for capturing context during the distribution process.
- **Logic and Control Flow**:
    - Query the current epoch rewards using `fd_bank_epoch_rewards_locking_query`.
    - If no epoch rewards are found, end the query and return.
    - Retrieve the current block height and distribution block heights from the bank and epoch rewards.
    - Query the current epoch schedule and epoch from the bank.
    - Check if the number of slots in the current epoch is less than or equal to the number of partitions; log a critical error if true.
    - If the current block height is within the distribution range, calculate the partition index and distribute rewards for that partition using [`distribute_epoch_rewards_in_partition`](<#distribute_epoch_rewards_in_partition>).
    - If the distribution is complete, set the epoch rewards status to inactive using `fd_sysvar_epoch_rewards_set_inactive`.
    - End the epoch rewards query with `fd_bank_epoch_rewards_end_locking_query`.
- **Output**: No return value; the function performs operations on the bank and account database to distribute rewards.
- **Functions Called**:
    - [`fd_epoch_rewards_get_exclusive_ending_block_height`](<fd_epoch_rewards.h.md#fd_epoch_rewards_get_exclusive_ending_block_height>)
    - [`get_slots_in_epoch`](<#get_slots_in_epoch>)
    - [`distribute_epoch_rewards_in_partition`](<#distribute_epoch_rewards_in_partition>)


---
### fd\_begin\_partitioned\_rewards<!-- {{#callable:fd_begin_partitioned_rewards}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_rewards.c#L979>)

Initializes the process of calculating and distributing partitioned rewards for a given epoch in a blockchain system.
- **Inputs**:
    - ``bank``: A pointer to the `fd_bank_t` structure representing the current state of the bank.
    - ``accdb``: A pointer to the `fd_accdb_user_t` structure representing the account database user.
    - ``xid``: A pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``runtime_stack``: A pointer to the `fd_runtime_stack_t` structure used for runtime operations.
    - ``capture_ctx``: A pointer to the `fd_capture_ctx_t` structure used for capturing context during operations.
    - ``stake_delegations``: A pointer to the `fd_stake_delegations_t` structure representing the stake delegations.
    - ``parent_blockhash``: A pointer to the `fd_hash_t` structure representing the hash of the parent block.
    - ``parent_epoch``: An unsigned long integer representing the parent epoch.
- **Logic and Control Flow**:
    - Calls [`calculate_rewards_and_distribute_vote_rewards`](<#calculate_rewards_and_distribute_vote_rewards>) to compute and distribute rewards for vote accounts and calculate stake account rewards.
    - Queries the epoch schedule from the bank using `fd_bank_epoch_schedule_query`.
    - Locks and joins the epoch rewards structure for modification using `fd_bank_epoch_rewards_locking_modify` and [`fd_epoch_rewards_join`](<fd_epoch_rewards.c.md#fd_epoch_rewards_join>).
    - Calculates the number of partitions for reward distribution using [`get_reward_distribution_num_blocks`](<#get_reward_distribution_num_blocks>).
    - Hashes the epoch rewards into partitions using [`fd_epoch_rewards_hash_into_partitions`](<fd_epoch_rewards.c.md#fd_epoch_rewards_hash_into_partitions>).
    - Sets the starting block height for distribution and initializes the epoch rewards sysvar using `fd_sysvar_epoch_rewards_init`.
    - Ends the modification of the epoch rewards structure using `fd_bank_epoch_rewards_end_locking_modify`.
- **Output**: No return value; the function modifies the state of the bank and related structures to prepare for reward distribution.
- **Functions Called**:
    - [`calculate_rewards_and_distribute_vote_rewards`](<#calculate_rewards_and_distribute_vote_rewards>)
    - [`fd_epoch_rewards_join`](<fd_epoch_rewards.c.md#fd_epoch_rewards_join>)
    - [`get_reward_distribution_num_blocks`](<#get_reward_distribution_num_blocks>)
    - [`fd_epoch_rewards_hash_into_partitions`](<fd_epoch_rewards.c.md#fd_epoch_rewards_hash_into_partitions>)


---
### fd\_rewards\_recalculate\_partitioned\_rewards<!-- {{#callable:fd_rewards_recalculate_partitioned_rewards}} -->
[View Source →](<../../../../../src/flamenco/rewards/fd_rewards.c#L1042>)

Recalculates partitioned stake rewards and updates the epoch reward status with the recalculated partitions.
- **Inputs**:
    - `banks`: A pointer to `fd_banks_t`, representing the collection of banks.
    - `bank`: A pointer to `fd_bank_t`, representing the current bank.
    - `funk`: A pointer to `fd_funk_t`, representing the function context.
    - `xid`: A constant pointer to `fd_funk_txn_xid_t`, representing the transaction ID.
    - `runtime_stack`: A pointer to `fd_runtime_stack_t`, representing the runtime stack.
    - `capture_ctx`: A pointer to `fd_capture_ctx_t`, representing the capture context.
- **Logic and Control Flow**:
    - Reads the epoch rewards sysvar using `fd_sysvar_epoch_rewards_read` and checks if it is active.
    - Logs a debug message indicating the start of recalculating partitioned rewards.
    - If the epoch rewards sysvar is inactive, logs a debug message and returns.
    - Sets `runtime_stack->stakes.prev_vote_credits_used` to 1 to indicate recalculation in the middle of rewards distribution.
    - Retrieves the current slot and epoch from the bank, and calculates the rewarded epoch as the previous epoch.
    - Attempts to determine the new warmup cooldown rate epoch using `fd_new_warmup_cooldown_rate_epoch`.
    - Reads the stake history sysvar using `fd_sysvar_stake_history_read` and logs an error if it fails.
    - Queries the stake delegations from the bank and logs a critical error if it is NULL.
    - Calls [`calculate_stake_vote_rewards`](<#calculate_stake_vote_rewards>) to recalculate the stake vote rewards for the previous epoch.
    - Joins the epoch rewards and hashes them into partitions using [`fd_epoch_rewards_hash_into_partitions`](<fd_epoch_rewards.c.md#fd_epoch_rewards_hash_into_partitions>).
    - Updates the epoch reward status with the recalculated partitions and ends the locking modification.
    - Resets `runtime_stack->stakes.prev_vote_credits_used` to 0.
- **Output**: No return value; the function updates the epoch reward status in the bank.
- **Functions Called**:
    - [`calculate_stake_vote_rewards`](<#calculate_stake_vote_rewards>)
    - [`fd_epoch_rewards_join`](<fd_epoch_rewards.c.md#fd_epoch_rewards_join>)
    - [`fd_epoch_rewards_hash_into_partitions`](<fd_epoch_rewards.c.md#fd_epoch_rewards_hash_into_partitions>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)