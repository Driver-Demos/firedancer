<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Auto-generates C header and source files from a JSON feature map using base58 encoding.

# Purpose
The code is a Python script designed to auto-generate C header and source files from a JSON feature map. It reads a JSON file, `feature_map.json`, which contains feature definitions, and produces two files: `fd_features_generated.h` and `fd_features_generated.c`. The script uses the `argparse` module to handle command-line arguments, allowing users to specify paths for the input JSON file and the output C files. The script processes each feature in the JSON file, extracting information such as public keys and feature names, and encodes these into C structures and arrays. The generated C code includes a union `fd_features` that organizes feature data and a function `fd_feature_id_query` that maps feature identifiers to their corresponding data.

The script is intended to be executed as a standalone program, as indicated by the `if __name__ == "__main__":` block. It uses the `struct` and `base58` modules to decode public keys and convert them into a format suitable for C code. The generated C files include preprocessor directives and static assertions to ensure correct layout and offset calculations. The script is useful for automating the creation of C code that interfaces with a feature map, ensuring consistency and reducing manual coding errors.
# Imports and Dependencies

---
- `argparse`
- `json`
- `pathlib.Path`
- `struct`
- `base58`


# Functions

---
### generate<!-- {{#callable:firedancer/src/flamenco/features/gen_features.generate}} -->
[View Source →](<../../../../../src/flamenco/features/gen_features.py#L13>)

Generates C header and body files from a JSON feature map.
- **Inputs**:
    - `feature_map_path`: Path to the JSON file containing the feature map.
    - `header_path`: Path to the output C header file.
    - `body_path`: Path to the output C body file.
- **Logic and Control Flow**:
    - Open the JSON file at `feature_map_path` and load its content into `feature_map`.
    - Open the files at `header_path` and `body_path` for writing.
    - Initialize `fd_features_t_params` as an empty list and `rmap` as an empty dictionary.
    - Iterate over each feature in `feature_map`, decode the `pubkey` using Base58, and calculate a short ID.
    - Append a formatted string with the short ID and feature name to `fd_features_t_params`.
    - Map each `pubkey` to its corresponding feature name in `rmap`.
    - Join all entries in `fd_features_t_params` into a single string separated by newlines.
    - Write the C header file content to `header` using the formatted `fd_features_t_params`.
    - Define a helper function `pubkey_to_c_array` to convert a `pubkey` to a C array string.
    - Write the initial part of the C body file content to `body`.
    - Iterate over each feature in `feature_map` to write its details to `body`, including index, ID, name, and optional fields like `cleaned_up`, `reverted`, and `hardcode_for_fuzzing`.
    - Write a default entry with `ULONG_MAX` index to `body`.
    - Write a function `fd_feature_id_query` to map a prefix to a feature ID using a switch-case structure.
    - Write static assertions to verify offset calculations in `body`.
- **Output**: C header and body files with feature definitions and mappings.


---
### main<!-- {{#callable:firedancer/src/flamenco/features/gen_features.main}} -->
[View Source →](<../../../../../src/flamenco/features/gen_features.py#L106>)

Parses command-line arguments and calls the [`generate`](<#generate>) function to create feature map and header files.
- **Inputs**: None
- **Logic and Control Flow**:
    - Gets the directory of the current script using `Path(__file__).parent`.
    - Creates an `ArgumentParser` object to handle command-line arguments.
    - Adds three arguments to the parser: `--feature_map`, `--header`, and `--body`, each with a default file path.
    - Parses the command-line arguments using `parser.parse_args()`.
    - Calls the [`generate`](<#generate>) function with the parsed arguments to generate the necessary files.
- **Output**: Does not return a value; it performs file generation as a side effect.
- **Functions Called**:
    - [`firedancer/src/flamenco/features/gen_features.generate`](<#generate>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)