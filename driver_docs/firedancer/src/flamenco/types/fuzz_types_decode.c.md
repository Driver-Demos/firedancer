<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements fuzz testing for type encoding and decoding with blacklist handling and custom mutator logic.

# Purpose
The code is a C source file designed for fuzz testing, specifically using LLVM's libFuzzer. It includes functions to initialize the fuzzer, process input data, and mutate input data for testing purposes. The file begins by checking for the `FD_HAS_HOSTED` macro, ensuring that the target environment supports hosted execution. It includes several headers for necessary functionality, such as dynamic linking, standard I/O, and custom utilities for fuzzing and type reflection.

The main components of the code are functions for encoding and decoding data types, which are used to test the robustness of data serialization and deserialization processes. The [`encode_type`](<#encode_type>) and [`decode_type`](<#decode_type>) functions handle the conversion of data between different formats, while [`fd_decode_fuzz_data`](<#fd_decode_fuzz_data>) performs a decode-encode cycle to verify data integrity. The [`LLVMFuzzerTestOneInput`](<#llvmfuzzertestoneinput>) function is the entry point for processing each input provided by the fuzzer, and it uses a blacklist to exclude certain types from testing. The [`LLVMFuzzerCustomMutator`](<#llvmfuzzercustommutator>) function generates and mutates input data to explore different execution paths and identify potential vulnerabilities. The code also manages memory allocation using a scratch memory system to optimize performance during fuzz testing.
# Imports and Dependencies

---
- `dlfcn.h`
- `stdio.h`
- `stdlib.h`
- `string.h`
- `assert.h`
- `../../util/sanitize/fd_fuzz.h`
- `fd_types_reflect.h`
- `../fd_flamenco.h`
- `fd_fuzz_types.h`


# Global Variables

---
### blacklist
- **Type**: ``const char *` array`
- **Description**: Contains a list of type names that are excluded from certain operations. The array includes type names such as `fd_pubkey`, `fd_tower_sync`, and `fd_tower_sync_switch`. These types are not processed by certain functions in the code.
- **Use**: Used to check if a type name is in the blacklist to prevent its processing.


# Functions

---
### is\_blacklisted<!-- {{#callable:is_blacklisted}} -->
[View Source →](<../../../../../src/flamenco/types/fuzz_types_decode.c#L27>)

Checks if a given type name is in a predefined blacklist.
- **Inputs**:
    - `type_name`: A constant character pointer representing the type name to check against the blacklist.
- **Logic and Control Flow**:
    - If `type_name` is NULL, return 1 indicating it is blacklisted.
    - Iterate over the `blacklist` array to compare each entry with `type_name`.
    - If a match is found using `strcmp`, return 1 indicating `type_name` is blacklisted.
    - If no match is found after checking all entries, return 0 indicating `type_name` is not blacklisted.
- **Output**: Returns an integer: 1 if `type_name` is blacklisted or NULL, otherwise 0.


---
### encode\_type<!-- {{#callable:encode_type}} -->
[View Source →](<../../../../../src/flamenco/types/fuzz_types_decode.c#L37>)

Encodes data from a source buffer to a destination buffer using a specified encoding function and updates the number of bytes written.
- **Inputs**:
    - `type_meta`: A pointer to a `fd_types_vt_t` structure that contains metadata and an encoding function for the data type.
    - `from`: A pointer to the source buffer containing the data to encode.
    - `to`: A pointer to the destination buffer where the encoded data will be written.
    - `capacity`: The maximum number of bytes that can be written to the destination buffer.
    - `written`: A pointer to a `size_t` variable where the function will store the number of bytes written to the destination buffer.
- **Logic and Control Flow**:
    - Initialize an `fd_bincode_encode_ctx_t` structure with `data` pointing to the `to` buffer and `dataend` pointing to the end of the buffer based on the `capacity`.
    - Call the `encode` function from `type_meta` with `from` and the initialized `encode_ctx` as arguments.
    - Calculate the number of bytes written by subtracting the starting address of `to` from the current position of `encode_ctx.data`.
    - Store the calculated number of bytes written in the `written` variable.
    - Return the error code from the `encode` function.
- **Output**: Returns an integer error code from the `encode` function, indicating success or failure of the encoding process.


---
### decode\_type<!-- {{#callable:decode_type}} -->
[View Source →](<../../../../../src/flamenco/types/fuzz_types_decode.c#L53>)

Decodes binary data into a structured format using type metadata and allocates memory for the decoded data.
- **Inputs**:
    - `type_meta`: A pointer to `fd_types_vt_t` structure containing metadata for the type to decode.
    - `from`: A pointer to the binary data to decode.
    - `to`: A pointer to a pointer where the function will store the address of the allocated and decoded data.
    - `capacity`: The size of the binary data buffer pointed to by `from`.
    - `written`: A pointer to a `size_t` where the function will store the size of the decoded data.
- **Logic and Control Flow**:
    - Initialize a `fd_bincode_decode_ctx_t` structure with `from` as the data source and `from + capacity` as the data end.
    - Call `type_meta->decode_footprint` to determine the size of the decoded data and store it in `total_sz`.
    - If `decode_footprint` returns an error, return the error code.
    - Store `total_sz` in `*written`.
    - Check if the allocation of `total_sz` bytes with alignment `type_meta->align` is safe using `fd_scratch_alloc_is_safe`. If not, return error code `-1004`.
    - Allocate memory for the decoded data using `fd_scratch_alloc` with alignment `type_meta->align` and size `total_sz`.
    - Decode the data using `type_meta->decode` and store the result in `*to`.
    - Return `FD_BINCODE_SUCCESS` to indicate successful decoding.
- **Output**: Returns an integer status code, `FD_BINCODE_SUCCESS` on success or an error code on failure.


---
### fd\_scratch\_detach\_null<!-- {{#callable:fd_scratch_detach_null}} -->
[View Source →](<../../../../../src/flamenco/types/fuzz_types_decode.c#L82>)

Calls `fd_scratch_detach` with a `NULL` argument.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls the function `fd_scratch_detach` with `NULL` as its argument.
- **Output**: No output is returned as the function is `void`.


---
### LLVMFuzzerInitialize<!-- {{#callable:LLVMFuzzerInitialize}} -->
[View Source →](<../../../../../src/flamenco/types/fuzz_types_decode.c#L87>)

Initializes the fuzzer environment by setting up environment variables, memory, and exit handlers.
- **Inputs**:
    - `argc`: A pointer to the argument count, typically from the command line.
    - `argv`: A pointer to the argument vector, typically from the command line.
- **Logic and Control Flow**:
    - Sets the environment variable `FD_LOG_BACKTRACE` to `0` to disable backtraces in logs.
    - Calls `fd_boot` with `argc` and `argv` to initialize the system.
    - Allocates a static 1 GB memory buffer `scratch_mem` and a static `scratch_fmem` array with 4 elements, aligned by `FD_SCRATCH_FMEM_ALIGN`.
    - Attaches the scratch memory using `fd_scratch_attach` with the allocated buffers.
    - Registers `fd_halt` and `fd_scratch_detach_null` to be called at program exit using `atexit`.
    - Returns `0` to indicate successful initialization.
- **Output**: Returns `0` to indicate successful initialization.


---
### fd\_decode\_fuzz\_data<!-- {{#callable:fd_decode_fuzz_data}} -->
[View Source →](<../../../../../src/flamenco/types/fuzz_types_decode.c#L103>)

Performs a decode-encode-decode-encode cycle on input data to verify data integrity and consistency.
- **Inputs**:
    - ``type_meta``: A pointer to `fd_types_vt_t` structure containing metadata about the type to decode and encode.
    - ``data``: A pointer to the input data to decode.
    - ``size``: The size of the input data in bytes.
- **Logic and Control Flow**:
    - Begin a scratch memory scope using `FD_SCRATCH_SCOPE_BEGIN` and `FD_SCRATCH_SCOPE_END` to manage temporary memory allocations.
    - Decode the input `data` using [`decode_type`](<#decode_type>), storing the result in `decoded` and the number of bytes written in `written`.
    - If decoding fails, return immediately.
    - Allocate memory for `encoded_buffer` and encode the `decoded` data using [`encode_type`](<#encode_type>).
    - If encoding fails, log a critical error and exit.
    - Decode the `encoded_buffer` back into `decoded_normalized` to verify the encoding process.
    - If decoding fails, return immediately.
    - Allocate memory for `encoded_buffer_normalized` and encode the `decoded_normalized` data.
    - If encoding fails, log a critical error and exit.
    - Compare the size of `written_normalized` and `written`; if `written_normalized` is larger, log a warning and a critical error.
    - Compare the contents of `encoded_buffer` and `encoded_buffer_normalized`; if they differ, log a warning and a critical error.
- **Output**: No output is returned; the function logs errors and warnings if data integrity checks fail.
- **Functions Called**:
    - [`decode_type`](<#decode_type>)
    - [`encode_type`](<#encode_type>)


---
### LLVMFuzzerTestOneInput<!-- {{#callable:LLVMFuzzerTestOneInput}} -->
[View Source →](<../../../../../src/flamenco/types/fuzz_types_decode.c#L154>)

Processes input data for fuzz testing by validating and decoding it based on type metadata.
- **Inputs**:
    - `data`: A pointer to the input data to be processed.
    - `size`: The size of the input data in bytes.
- **Logic and Control Flow**:
    - Check if `size` is zero; if true, return 0 immediately.
    - Assert that `fd_types_vt_list_cnt` is less than 256 to ensure valid indexing.
    - Check if the first byte of `data` is greater than or equal to `fd_types_vt_list_cnt`; if true, return -1.
    - Retrieve the type metadata from `fd_types_vt_list` using the first byte of `data` as an index.
    - Increment `data` pointer and decrement `size` by 1 to adjust for the type metadata byte.
    - Check if the type name is 'fd_pubkey'; if true, return -1.
    - Check if the type name is 'fd_vote_instruction' and `size` is at least the size of `uint`; if true, check the discriminant value and return -1 if it is 14 or 15.
    - Check if the type name is blacklisted using [`is_blacklisted`](<#is_blacklisted>); if true, return -1.
    - Call [`fd_decode_fuzz_data`](<#fd_decode_fuzz_data>) with the type metadata, adjusted `data`, and `size`.
- **Output**: Returns 0 if processing is successful, or -1 if any validation checks fail.
- **Functions Called**:
    - [`is_blacklisted`](<#is_blacklisted>)
    - [`fd_decode_fuzz_data`](<#fd_decode_fuzz_data>)


---
### LLVMFuzzerCustomMutator<!-- {{#callable:LLVMFuzzerCustomMutator}} -->
[View Source →](<../../../../../src/flamenco/types/fuzz_types_decode.c#L186>)

Mutates or generates new data for fuzz testing based on a random seed and type metadata.
- **Inputs**:
    - `data`: A pointer to the data buffer to mutate or generate new data into.
    - `size`: The current size of the data buffer.
    - `max_size`: The maximum allowable size for the data buffer.
    - `seed`: A seed for the random number generator to ensure variability in mutations or generations.
- **Logic and Control Flow**:
    - Initialize a random number generator with the given seed.
    - Determine whether to mutate existing data or generate new data based on a random decision.
    - If mutating, call [`LLVMFuzzerMutate`](<../../util/sanitize/fd_fuzz_stub.c.md#llvmfuzzermutate>) to mutate the data and adjust the first byte to select a type from `fd_types_vt_list`.
    - Check if the selected type is blacklisted or requires special handling, and decide whether to generate new data instead.
    - If generating new data, repeatedly select a type and attempt to find a corresponding generation function using `dlsym`.
    - Allocate scratch memory and use the generation function to create a new data payload.
    - Encode the generated data into the buffer, handling any encoding errors, especially overflow.
    - Return the size of the mutated or newly generated data.
- **Output**: The size of the mutated or newly generated data in the buffer.
- **Functions Called**:
    - [`LLVMFuzzerMutate`](<../../util/sanitize/fd_fuzz_stub.c.md#llvmfuzzermutate>)
    - [`is_blacklisted`](<#is_blacklisted>)
    - [`encode_type`](<#encode_type>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)