<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Unit tests for verifying the correctness of the `fd_flamenco_yaml` serializer with various type tree inputs.

# Purpose
The code is a C program designed to test the functionality of a YAML serializer, specifically the `fd_flamenco_yaml` serializer. It includes a series of unit tests that verify the correct conversion of various data structures into YAML format. The program defines a set of test cases, each represented by a `fd_flamenco_yaml_test_t` structure, which contains a sequence of type steps (`fd_flamenco_type_step_t`) and the expected YAML output. These type steps simulate a walk through a data structure, specifying the type and value of each element, such as integers, maps, and arrays.

The main function initializes the testing environment, allocates necessary memory, and iterates over the list of unit tests. For each test, it calls the [`fd_flamenco_yaml_unit_test`](<#fd_flamenco_yaml_unit_test>) function, which performs the serialization and compares the actual output with the expected YAML string. If the output does not match the expected result, the program logs a warning and an error message. The program uses a scratch memory allocator for temporary storage during the tests and ensures that all resources are properly cleaned up after the tests are completed. The code is structured to be executed as a standalone program, with the [`main`](<#main>) function serving as the entry point.
# Imports and Dependencies

---
- `fd_bincode.h`
- `fd_types_meta.h`
- `fd_types_yaml.h`
- `fd_types.h`
- `stdio.h`


# Global Variables

---
### test0\_walk
- **Type**: ``fd_flamenco_type_step_t[]``
- **Description**: An array of `fd_flamenco_type_step_t` structures that represents a type walk for a unit test. Each element in the array describes a step in the type walk, with the first element specifying a primitive type at the root level.
- **Use**: Used in unit test 0 to verify that a bincode AST walk results in the correct YAML stream.


---
### test0\_expected
- **Type**: ``char[]``
- **Description**: A static constant character array that contains the expected YAML output for unit test 0. The array holds the string "3\n" which represents a primitive unsigned integer value at the root level in YAML format.
- **Use**: Used to verify that the YAML serialization of a primitive unsigned integer matches the expected output in unit test 0.


---
### test1\_walk
- **Type**: ``fd_flamenco_type_step_t[]``
- **Description**: An array of `fd_flamenco_type_step_t` structures that represents a sequence of steps for a type walk. Each element in the array describes a level, type, and optional name and value for a step in a type hierarchy.
- **Use**: Used to define a simple object structure for testing the YAML serialization process.


---
### test1\_expected
- **Type**: ``const char[]``
- **Description**: Contains the expected YAML output for a unit test that verifies the serialization of a simple object with three key-value pairs. The keys are 'a', 'b', and 'c', and their corresponding values are 3, 4, and 5.
- **Use**: Used to compare against the actual output of the YAML serialization process in a unit test.


---
### test2\_walk
- **Type**: ``fd_flamenco_type_step_t[]``
- **Description**: An array of `fd_flamenco_type_step_t` structures that represents a simple array type walk. Each element in the array specifies a step in the type walk, including the level and type of the element, and for some elements, an unsigned integer value (`ui`).
- **Use**: Used to define a sequence of steps for a type walk in a unit test for the `fd_flamenco_yaml` serializer.


---
### test2\_expected
- **Type**: ``char[]``
- **Description**: Contains the expected YAML output for unit test 2, which tests a simple array structure. The array consists of three unsigned integers, each represented as a separate line prefixed with a dash.
- **Use**: Used to verify the correctness of the YAML serialization for a simple array structure in unit test 2.


---
### test3\_walk
- **Type**: ``fd_flamenco_type_step_t[]``
- **Description**: An array of `fd_flamenco_type_step_t` structures that represents a sequence of type steps for a YAML serialization test. Each element in the array specifies a level, type, and optionally a name and a value, which are used to simulate a type walk through a data structure.
- **Use**: Used in unit test 3 to verify the correct serialization of an array containing maps into a YAML format.


---
### test3\_expected
- **Type**: ``char[]``
- **Description**: A static constant character array that contains the expected YAML output for unit test 3. The YAML output represents an array with two maps, where the first map contains a key 'a' with a value of 3, and the second map contains keys 'b' and 'c' with values 3 and 4, respectively.
- **Use**: Used to verify the correctness of the YAML serialization in unit test 3 by comparing it against the actual output.


---
### test4\_walk
- **Type**: ``fd_flamenco_type_step_t[]``
- **Description**: An array of `fd_flamenco_type_step_t` structures that represents a nested map structure with arrays. Each element in the array specifies a level, type, and optionally a name, which together define a step in a type walk for a YAML serialization test.
- **Use**: Used in a unit test to verify the correct serialization of a nested map structure with arrays into a YAML stream.


---
### test4\_expected
- **Type**: ``char[]``
- **Description**: Contains a YAML formatted string that represents a nested map structure with keys 'a', 'b', and 'c', where 'c' is an empty array. This string is used as the expected output for a unit test that verifies the correct serialization of a nested map structure into YAML format.
- **Use**: Used as the expected YAML output in a unit test to validate the serialization of a nested map structure.


---
### test5\_walk
- **Type**: ``fd_flamenco_type_step_t[]``
- **Description**: An array of `fd_flamenco_type_step_t` structures that represents a nested array structure with various levels. Each element in the array specifies a level and a type, with one element containing a `uint` value of 3.
- **Use**: Used to define a sequence of steps for a type walk in a unit test for YAML serialization.


---
### test5\_expected
- **Type**: ``char[]``
- **Description**: A static constant character array that contains a YAML representation of nested arrays with a single integer and an empty array at the deepest level.
- **Use**: Used as the expected output for a unit test to verify the correct serialization of nested arrays in YAML format.


---
### test6\_walk
- **Type**: ``fd_flamenco_type_step_t[]``
- **Description**: Defines a sequence of steps for a type walk, representing a mix of objects and arrays. Each step specifies a level, type, and optional name and value, forming a hierarchical structure.
- **Use**: Used to test the `fd_flamenco_yaml` serializer by providing a complex type tree walk input.


---
### test6\_expected
- **Type**: ``char[]``
- **Description**: A static constant character array that contains a YAML formatted string. The string represents a structure with 'authorized_voters' and 'prior_voters' sections, each containing nested elements.
- **Use**: Used as the expected output for a unit test to verify the correctness of YAML serialization.


---
### test7\_walk
- **Type**: ``fd_flamenco_type_step_t[]``
- **Description**: An array of `fd_flamenco_type_step_t` structures that represents a type walk for a YAML serialization test. Each element in the array specifies a step in the type walk, including the level, type, and optionally a name.
- **Use**: Used in a unit test to verify the correct serialization of a map with a null option in YAML format.


---
### test7\_expected
- **Type**: ``char[]``
- **Description**: A static constant character array that contains the expected YAML output for unit test 7. The YAML output represents a map with a single key 'option' and a null value.
- **Use**: Used to verify the correctness of the YAML serialization in unit test 7.


---
### fd\_flamenco\_yaml\_tests
- **Type**: ``fd_flamenco_yaml_test_t[]``
- **Description**: An array of `fd_flamenco_yaml_test_t` structures, each containing a type walk and the expected YAML output for unit testing the YAML serializer.
- **Use**: Used to store and iterate over test cases for validating the correctness of the YAML serialization process.


# Data Structures

---
### fd\_flamenco\_type\_step
- **Type**: ``struct``
- **Members**:
    - ``level``: Indicates the depth level in a type tree walk.
    - ``type``: Specifies the type of the current step in the type walk.
    - ``name``: Holds the name of the step, used as a map key if applicable.
    - ``uc``: Stores an unsigned char value.
    - ``sc``: Stores a signed char value.
    - ``us``: Stores an unsigned short value.
    - ``ss``: Stores a signed short value.
    - ``ui``: Stores an unsigned int value.
    - ``si``: Stores a signed int value.
    - ``ul``: Stores an unsigned long value.
    - ``sl``: Stores a signed long value.
    - ``hash``: Stores a 32-byte hash value.
- **Description**: Represents a step in a type tree walk, used in the context of serializing or deserializing data structures, with fields to indicate the level, type, and name of the step, and a union to store various data types or a hash.


---
### fd\_flamenco\_type\_step\_t
- **Type**: ``struct``
- **Members**:
    - ``level``: Indicates the depth level of the current step in the type walk.
    - ``type``: Specifies the type of the current step, such as a map or array.
    - ``name``: Holds the name of the map key if the step is part of a map.
    - ``uc``: Stores an unsigned char value.
    - ``sc``: Stores a signed char value.
    - ``us``: Stores an unsigned short value.
    - ``ss``: Stores a signed short value.
    - ``ui``: Stores an unsigned int value.
    - ``si``: Stores a signed int value.
    - ``ul``: Stores an unsigned long value.
    - ``sl``: Stores a signed long value.
    - ``hash``: Stores a 32-byte hash value.
- **Description**: Represents a step in a type walk, used for serializing data structures into YAML format. Each step contains information about its level in the hierarchy, its type, and optionally a name if it is part of a map. The union allows storing different types of data, such as integers and hash values, depending on the type of the step.


---
### fd\_flamenco\_yaml\_test
- **Type**: ``struct``
- **Members**:
    - ``walk``: Pointer to a constant `fd_flamenco_type_step_t` structure that represents a type walk.
    - ``expected``: Pointer to a constant character string that represents the expected YAML output.
- **Description**: Defines a structure used for unit testing the `fd_flamenco_yaml` serializer by comparing a type walk (`walk`) with the expected YAML output (`expected`).


---
### fd\_flamenco\_yaml\_test\_t
- **Type**: ``struct``
- **Members**:
    - ``walk``: Pointer to a constant `fd_flamenco_type_step_t` structure that represents the steps of a type walk.
    - ``expected``: Pointer to a constant character string that represents the expected YAML output.
- **Description**: Defines a YAML unit test structure that contains a type walk and the expected YAML output for that walk. It is used to verify that the `fd_flamenco_yaml` serializer produces the correct YAML stream from a given type tree walk input.


# Functions

---
### fd\_flamenco\_yaml\_unit\_test<!-- {{#callable:fd_flamenco_yaml_unit_test}} -->
[View Source →](<../../../../../src/flamenco/types/test_types_yaml.c#L219>)

Executes a unit test for the YAML serialization of a type tree walk and compares the result to an expected output.
- **Inputs**:
    - `test`: A pointer to a `fd_flamenco_yaml_test_t` structure containing the type tree walk and the expected YAML output.
- **Logic and Control Flow**:
    - Initialize a static buffer `yaml_buf` to store the YAML output.
    - Open a memory stream `file` using `fmemopen` to write to `yaml_buf`.
    - Allocate memory for YAML processing using `fd_scratch_alloc` and initialize a `fd_flamenco_yaml_t` object with [`fd_flamenco_yaml_init`](<fd_types_yaml.c.md#fd_flamenco_yaml_init>).
    - Iterate over the `walk` array in `test` and call [`fd_flamenco_yaml_walk`](<fd_types_yaml.c.md#fd_flamenco_yaml_walk>) for each step to process the type tree.
    - Write a null terminator to `file` and check if the write was successful using `FD_TEST`.
    - Get the current position in `file` using `ftell` and ensure it is greater than zero.
    - Close the `file` and verify the operation was successful.
    - Compare the content of `yaml_buf` with `test->expected` using `strcmp`.
    - If the comparison fails, log warnings and an error indicating the test failure.
    - Delete the YAML object using [`fd_flamenco_yaml_delete`](<fd_types_yaml.c.md#fd_flamenco_yaml_delete>).
- **Output**: No return value; the function logs errors and warnings if the test fails.
- **Functions Called**:
    - [`fd_flamenco_yaml_align`](<fd_types_yaml.h.md#fd_flamenco_yaml_align>)
    - [`fd_flamenco_yaml_footprint`](<fd_types_yaml.h.md#fd_flamenco_yaml_footprint>)
    - [`fd_flamenco_yaml_init`](<fd_types_yaml.c.md#fd_flamenco_yaml_init>)
    - [`fd_flamenco_yaml_new`](<fd_types_yaml.c.md#fd_flamenco_yaml_new>)
    - [`fd_flamenco_yaml_walk`](<fd_types_yaml.c.md#fd_flamenco_yaml_walk>)
    - [`fd_flamenco_yaml_delete`](<fd_types_yaml.c.md#fd_flamenco_yaml_delete>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/flamenco/types/test_types_yaml.c#L249>)

Initializes the environment, runs a series of YAML serialization unit tests, and performs cleanup operations.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Allocates a static memory buffer `scratch_mem` of 32 MiB and a static memory frame `scratch_fmem` aligned to `FD_SCRATCH_FMEM_ALIGN`.
    - Attaches the scratch memory using `fd_scratch_attach`.
    - Iterates over the `fd_flamenco_yaml_tests` array, executing each test using [`fd_flamenco_yaml_unit_test`](<#fd_flamenco_yaml_unit_test>) within a `FD_SCRATCH_SCOPE_BEGIN` and `FD_SCRATCH_SCOPE_END` block.
    - Logs a notice message "pass" if all tests succeed.
    - Checks that no scratch memory is used with `fd_scratch_frame_used`.
    - Detaches the scratch memory using `fd_scratch_detach`.
    - Calls `fd_halt` to perform any necessary cleanup before exiting.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`fd_flamenco_yaml_unit_test`](<#fd_flamenco_yaml_unit_test>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)