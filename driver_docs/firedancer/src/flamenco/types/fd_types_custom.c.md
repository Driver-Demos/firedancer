<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Custom encoding and decoding functions for `fd_tower_sync_t` and related structures, including error handling and duration normalization.

# Purpose
The code is a C source file that provides functionality for encoding and decoding data structures related to a "tower sync" process. It includes functions for encoding and decoding operations, specifically for the `fd_tower_sync_t` data type, using a custom binary encoding context (`fd_bincode_encode_ctx_t` and `fd_bincode_decode_ctx_t`). The file contains functions such as [`fd_tower_sync_encode`](<#fd_tower_sync_encode>), [`fd_tower_sync_decode`](<#fd_tower_sync_decode>), and [`fd_tower_sync_decode_footprint`](<#fd_tower_sync_decode_footprint>), which handle the serialization and deserialization of data structures, ensuring that data is correctly encoded or decoded according to the specified format. The code also includes functions for handling specific data types like `fd_rust_duration_t`, ensuring that durations are normalized and validated for overflow during encoding.

The file includes several static functions that perform internal decoding operations, such as [`fd_hash_decode_inner`](<#fd_hash_decode_inner>) and [`fd_lockout_offset_decode_inner`](<#fd_lockout_offset_decode_inner>), which are used to process specific parts of the data structure. Additionally, the code references external dependencies through included headers like `fd_types_custom.h` and `fd_bincode.h`, indicating that it is part of a larger system. The file also includes a red-black tree implementation for managing `fd_stake_weight_t_mapnode_t` elements, which suggests that it handles some form of data organization or lookup. The presence of error handling and overflow checks indicates that the code is designed to manage data integrity during the encoding and decoding processes.
# Imports and Dependencies

---
- `fd_types_custom.h`
- `fd_bincode.h`
- `fd_types.h`
- `fd_types_meta.h`
- `stdio.h`
- `../../util/tmpl/fd_redblack.c`


# Functions

---
### fd\_tower\_sync\_encode<!-- {{#callable:fd_tower_sync_encode}} -->
[View Source →](<../../../../../src/flamenco/types/fd_types_custom.c#L11>)

Logs an error message indicating that the function is not yet implemented.
- **Inputs**:
    - ``self``: A pointer to a constant `fd_tower_sync_t` structure that represents the data to encode.
    - ``ctx``: A pointer to an `fd_bincode_encode_ctx_t` structure that provides the context for encoding.
- **Logic and Control Flow**:
    - Logs an error message using `FD_LOG_ERR` with the message "todo".
- **Output**: Returns an integer, but the function currently only logs an error and does not return a meaningful value.


---
### fd\_tower\_sync\_decode\_footprint\_inner<!-- {{#callable:fd_tower_sync_decode_footprint_inner}} -->
[View Source →](<../../../../../src/flamenco/types/fd_types_custom.c#L20>)

Decodes a footprint from a binary context while handling potential overflow and updating the total size.
- **Inputs**:
    - `ctx`: A pointer to a `fd_bincode_decode_ctx_t` structure that contains the binary data to decode.
    - `total_sz`: A pointer to an `ulong` that accumulates the total size of the decoded footprint.
- **Logic and Control Flow**:
    - Initialize error variable `err` to 0.
    - Check if `ctx->data` exceeds `ctx->dataend` and return `FD_BINCODE_ERR_OVERFLOW` if true.
    - Call `fd_bincode_uint64_decode_footprint` to decode a 64-bit unsigned integer footprint.
    - Initialize `root` to 0 and set up a `root_ctx` for decoding the root value.
    - Decode the root value using `fd_bincode_uint64_decode_unsafe` and handle potential overflow.
    - Check for errors after decoding the root and return if any.
    - Decode `lockout_offsets_len` using [`fd_bincode_compact_u16_decode`](<fd_bincode.h.md#fd_bincode_compact_u16_decode>).
    - Calculate `lockout_offsets_max` and update `total_sz` with alignment and footprint size.
    - Iterate over `lockout_offsets_len` to decode each lockout offset footprint.
    - For each lockout offset, decode it and perform a checked addition with `root`.
    - Handle potential overflow during the addition and return error if it occurs.
    - Decode a hash footprint using [`fd_hash_decode_footprint_inner`](<fd_types.c.md#fd_hash_decode_footprint_inner>).
    - Decode a boolean value `o` and, if true, decode an additional 64-bit integer footprint.
    - Decode another hash footprint using [`fd_hash_decode_footprint_inner`](<fd_types.c.md#fd_hash_decode_footprint_inner>).
    - Return 0 if all operations are successful.
- **Output**: Returns 0 on success or an error code if an overflow or decoding error occurs.
- **Functions Called**:
    - [`fd_bincode_compact_u16_decode`](<fd_bincode.h.md#fd_bincode_compact_u16_decode>)
    - [`fd_lockout_offset_decode_footprint_inner`](<fd_types.c.md#fd_lockout_offset_decode_footprint_inner>)
    - [`fd_lockout_offset_decode_inner`](<fd_types.c.md#fd_lockout_offset_decode_inner>)
    - [`fd_hash_decode_footprint_inner`](<fd_types.c.md#fd_hash_decode_footprint_inner>)
    - [`fd_bincode_bool_decode`](<fd_bincode.h.md#fd_bincode_bool_decode>)


---
### fd\_tower\_sync\_decode\_footprint<!-- {{#callable:fd_tower_sync_decode_footprint}} -->
[View Source →](<../../../../../src/flamenco/types/fd_types_custom.c#L82>)

Calculates the memory footprint required for decoding a `fd_tower_sync_t` structure and resets the context data pointer after processing.
- **Inputs**:
    - `ctx`: A pointer to a `fd_bincode_decode_ctx_t` structure that contains the data and data end pointers for decoding.
    - `total_sz`: A pointer to an `ulong` that accumulates the total size of the memory footprint required for decoding.
- **Logic and Control Flow**:
    - Add the size of `fd_tower_sync_t` to `*total_sz`.
    - Store the current data pointer from `ctx` in `start_data`.
    - Call [`fd_tower_sync_decode_footprint_inner`](<#fd_tower_sync_decode_footprint_inner>) with `ctx` and `total_sz` to calculate the additional footprint required.
    - Reset the `ctx->data` pointer to `start_data` to restore the original data pointer.
    - Return the error code from [`fd_tower_sync_decode_footprint_inner`](<#fd_tower_sync_decode_footprint_inner>).
- **Output**: Returns an integer error code indicating the success or failure of the footprint calculation.
- **Functions Called**:
    - [`fd_tower_sync_decode_footprint_inner`](<#fd_tower_sync_decode_footprint_inner>)


---
### fd\_tower\_sync\_decode\_inner<!-- {{#callable:fd_tower_sync_decode_inner}} -->
[View Source →](<../../../../../src/flamenco/types/fd_types_custom.c#L90>)

Decodes a `fd_tower_sync_t` structure from a binary context, updating its fields based on the decoded data.
- **Inputs**:
    - `struct_mem`: A pointer to the memory where the `fd_tower_sync_t` structure is stored.
    - `alloc_mem`: A pointer to a memory allocation pointer, used for dynamic memory allocation during decoding.
    - `ctx`: A pointer to the `fd_bincode_decode_ctx_t` context, which contains the binary data to decode.
- **Logic and Control Flow**:
    - Cast `struct_mem` to a `fd_tower_sync_t` pointer and set `has_root` to 1.
    - Decode a 64-bit unsigned integer from `ctx` into `self->root` and update `has_root` based on whether `root` equals `ULONG_MAX`.
    - Decode a compact 16-bit unsigned integer from `ctx` into `lockout_offsets_len`.
    - Calculate `lockout_offsets_max` as the maximum of `lockout_offsets_len` and 32.
    - Allocate memory for `self->lockouts` using [`deq_fd_vote_lockout_t_join_new`](<fd_types.h.md#deq_fd_vote_lockout_t_join_new>) with `alloc_mem` and `lockout_offsets_max`.
    - Initialize `last_slot` to 0 if `root` is `ULONG_MAX`, otherwise to `root`.
    - Iterate over `lockout_offsets_len`, decoding each `fd_lockout_offset_t` and updating `self->lockouts` with the decoded data.
    - Decode `self->hash` using [`fd_hash_decode_inner`](<fd_types.c.md#fd_hash_decode_inner>).
    - Decode a boolean from `ctx` into `o`, set `has_timestamp` based on `o`, and decode `timestamp` if `o` is true.
    - Decode `self->block_id` using [`fd_hash_decode_inner`](<fd_types.c.md#fd_hash_decode_inner>).
- **Output**: The function does not return a value; it modifies the `fd_tower_sync_t` structure pointed to by `struct_mem`.
- **Functions Called**:
    - [`fd_bincode_compact_u16_decode_unsafe`](<fd_bincode.h.md#fd_bincode_compact_u16_decode_unsafe>)
    - [`deq_fd_vote_lockout_t_join_new`](<fd_types.h.md#deq_fd_vote_lockout_t_join_new>)
    - [`fd_lockout_offset_decode_inner`](<fd_types.c.md#fd_lockout_offset_decode_inner>)
    - [`fd_hash_decode_inner`](<fd_types.c.md#fd_hash_decode_inner>)
    - [`fd_bincode_bool_decode_unsafe`](<fd_bincode.h.md#fd_bincode_bool_decode_unsafe>)


---
### fd\_tower\_sync\_decode<!-- {{#callable:fd_tower_sync_decode}} -->
[View Source →](<../../../../../src/flamenco/types/fd_types_custom.c#L131>)

Decodes a `fd_tower_sync_t` structure from a memory region using a binary decoding context.
- **Inputs**:
    - `mem`: A pointer to the memory region where the `fd_tower_sync_t` structure will be decoded.
    - `ctx`: A pointer to the `fd_bincode_decode_ctx_t` structure that provides the context for decoding.
- **Logic and Control Flow**:
    - Cast `mem` to a `fd_tower_sync_t` pointer and assign it to `self`.
    - Initialize the `fd_tower_sync_t` structure by calling [`fd_tower_sync_new`](<fd_types.c.md#fd_tower_sync_new>) with `self`.
    - Calculate the allocation region starting after the `fd_tower_sync_t` structure and store it in `alloc_region`.
    - Create a pointer `alloc_mem` pointing to `alloc_region`.
    - Call [`fd_tower_sync_decode_inner`](<#fd_tower_sync_decode_inner>) with `mem`, `alloc_mem`, and `ctx` to perform the actual decoding of the structure.
    - Return the pointer `self` which now contains the decoded `fd_tower_sync_t` structure.
- **Output**: A pointer to the decoded `fd_tower_sync_t` structure.
- **Functions Called**:
    - [`fd_tower_sync_new`](<fd_types.c.md#fd_tower_sync_new>)
    - [`fd_tower_sync_decode_inner`](<#fd_tower_sync_decode_inner>)


---
### fd\_tower\_sync\_decode\_inner\_global<!-- {{#callable:fd_tower_sync_decode_inner_global}} -->
[View Source →](<../../../../../src/flamenco/types/fd_types_custom.c#L140>)

Logs an error indicating that the function is not yet implemented.
- **Inputs**:
    - ``struct_mem``: A pointer to a memory structure where decoded data will be stored.
    - ``alloc_mem``: A pointer to a memory allocation pointer, used for dynamic memory allocation during decoding.
    - ``ctx``: A pointer to a `fd_bincode_decode_ctx_t` structure, which provides context for the decoding process.
- **Logic and Control Flow**:
    - Logs an error message using `FD_LOG_ERR` to indicate that the function is not implemented.
- **Output**: There is no output as the function only logs an error message.


---
### fd\_rust\_duration\_normalize<!-- {{#callable:fd_rust_duration_normalize}} -->
[View Source →](<../../../../../src/flamenco/types/fd_types_custom.c#L149>)

Normalizes a duration by converting excess nanoseconds into seconds.
- **Inputs**:
    - `self`: A pointer to an `fd_rust_duration_t` structure containing `nanoseconds` and `seconds` fields.
- **Logic and Control Flow**:
    - Check if `self->nanoseconds` is less than 1,000,000,000; if true, return immediately.
    - Calculate the number of seconds in `self->nanoseconds` by dividing by 1,000,000,000.
    - Add the calculated seconds to `self->seconds`.
    - Subtract the equivalent nanoseconds of the added seconds from `self->nanoseconds`.
- **Output**: No return value; modifies the `fd_rust_duration_t` structure in place.


---
### fd\_rust\_duration\_footprint\_validator<!-- {{#callable:fd_rust_duration_footprint_validator}} -->
[View Source →](<../../../../../src/flamenco/types/fd_types_custom.c#L162>)

Validates the footprint of a Rust duration by checking for overflow in the conversion of nanoseconds to seconds.
- **Inputs**:
    - `ctx`: A pointer to a `fd_bincode_decode_ctx_t` structure that contains the data to validate.
- **Logic and Control Flow**:
    - Cast the `ctx->data` to a `fd_rust_duration_t` pointer `d`.
    - Check if `d->nanoseconds` is less than 1,000,000,000; if true, return `FD_BINCODE_SUCCESS`.
    - Calculate the number of seconds from `d->nanoseconds` and check for overflow when adding to `d->seconds` using `__builtin_uaddl_overflow`.
    - If overflow occurs, return `FD_BINCODE_ERR_ENCODING`.
    - If no overflow occurs, return `FD_BINCODE_SUCCESS`.
- **Output**: Returns `FD_BINCODE_SUCCESS` if the duration is valid and `FD_BINCODE_ERR_ENCODING` if there is an overflow error.


---
### fd\_stake\_weight\_t\_map\_compare<!-- {{#callable:fd_stake_weight_t_map_compare}} -->
[View Source →](<../../../../../src/flamenco/types/fd_types_custom.c#L177>)

Compares two `fd_stake_weight_t_mapnode_t` nodes based on their key values.
- **Inputs**:
    - `left`: A pointer to the first `fd_stake_weight_t_mapnode_t` node to compare.
    - `right`: A pointer to the second `fd_stake_weight_t_mapnode_t` node to compare.
- **Logic and Control Flow**:
    - Uses `memcmp` to compare the `uc` field of the `key` element in the `left` and `right` nodes.
    - The comparison is based on the size of the `key` in the `right` node.
- **Output**: Returns a long integer indicating the result of the comparison: a negative value if `left` is less than `right`, zero if they are equal, and a positive value if `left` is greater than `right`.


# Function Declarations (Public API)

---
### fd\_hash\_decode\_inner<!-- {{#callable_declaration:fd_hash_decode_inner}} -->
[View Source →](<../../../../../src/flamenco/types/fd_types_custom.c#L15>)

Decodes a hash from a binary context into a structure.
- **Description**: Use this function to decode a hash from a binary context and store it in a provided memory structure. This function is typically called during deserialization processes where binary data needs to be interpreted as a hash. Ensure that the `struct_mem` parameter points to a valid memory location with enough space to store the decoded hash. The `ctx` parameter must be a valid decoding context that contains the binary data to decode. This function does not return a value and assumes that the provided memory locations are valid and sufficient for the operation.
- **Inputs**:
    - `struct_mem`: A pointer to the memory location where the decoded hash will be stored. Must not be null and must have enough space to store a `fd_hash_t`.
    - `alloc_mem`: A pointer to a pointer for allocation purposes. This parameter is not used in this function, but must be provided.
    - `ctx`: A pointer to a `fd_bincode_decode_ctx_t` structure that contains the binary data to decode. Must not be null and must be properly initialized with valid data.
- **Output**: None
- **See Also**: [`fd_hash_decode_inner`](<fd_types.c.md#fd_hash_decode_inner>)  (Implementation)


---
### fd\_hash\_decode\_footprint\_inner<!-- {{#callable_declaration:fd_hash_decode_footprint_inner}} -->
[View Source →](<../../../../../src/flamenco/types/fd_types_custom.c#L16>)

Calculates the footprint of a hash decode operation.
- **Description**: Use this function to calculate the memory footprint required for decoding a hash. It must be called with a valid decode context. The function checks if the context's data pointer has reached or exceeded the data end, returning an overflow error if so. This function is typically used in scenarios where memory allocation needs to be determined before performing the actual decode operation.
- **Inputs**:
    - `ctx`: A pointer to a `fd_bincode_decode_ctx_t` structure that contains the current state of the decode operation. Must not be null and must have valid data and dataend pointers.
    - `total_sz`: A pointer to an `ulong` where the function will store the calculated footprint size. The caller must ensure this pointer is valid and writable.
- **Output**: Returns an integer status code. Returns `FD_BINCODE_ERR_OVERFLOW` if the data pointer exceeds the data end, otherwise returns the result of `fd_bincode_bytes_decode_footprint`.
- **See Also**: [`fd_hash_decode_footprint_inner`](<fd_types.c.md#fd_hash_decode_footprint_inner>)  (Implementation)


---
### fd\_lockout\_offset\_decode\_inner<!-- {{#callable_declaration:fd_lockout_offset_decode_inner}} -->
[View Source →](<../../../../../src/flamenco/types/fd_types_custom.c#L17>)

Decodes a lockout offset structure from a binary context.
- **Description**: Use this function to decode a `fd_lockout_offset_t` structure from a binary context. It reads the offset and confirmation count from the provided context and stores them in the structure pointed to by `struct_mem`. This function must be called with valid pointers for `struct_mem` and `ctx`. The `alloc_mem` parameter is not used in this function and can be set to `NULL`. Ensure that the context has sufficient data to decode the required fields to avoid undefined behavior.
- **Inputs**:
    - `struct_mem`: A pointer to a memory location where the decoded `fd_lockout_offset_t` structure will be stored. Must not be null.
    - `alloc_mem`: A pointer to a memory allocation pointer, which is not used in this function. Can be set to `NULL`.
    - `ctx`: A pointer to a `fd_bincode_decode_ctx_t` structure that provides the binary data context for decoding. Must not be null and must have sufficient data for decoding.
- **Output**: None
- **See Also**: [`fd_lockout_offset_decode_inner`](<fd_types.c.md#fd_lockout_offset_decode_inner>)  (Implementation)


---
### fd\_lockout\_offset\_decode\_footprint\_inner<!-- {{#callable_declaration:fd_lockout_offset_decode_footprint_inner}} -->
[View Source →](<../../../../../src/flamenco/types/fd_types_custom.c#L18>)

Decodes the footprint of a lockout offset from a binary context.
- **Description**: Use this function to decode the footprint of a lockout offset from a binary context. It reads data from the context and updates the total size. This function must be called with a valid decode context and a pointer to a size variable. Ensure that the context's data pointer does not exceed its data end to avoid overflow errors. The function returns an error code if decoding fails.
- **Inputs**:
    - `ctx`: A pointer to a `fd_bincode_decode_ctx_t` structure representing the binary decode context. Must not be null and must have valid data and dataend pointers.
    - `total_sz`: A pointer to an `ulong` where the function will store the total size of the decoded footprint. Must not be null.
- **Output**: Returns an integer error code. Returns 0 on success, or a non-zero error code if decoding fails.
- **See Also**: [`fd_lockout_offset_decode_footprint_inner`](<fd_types.c.md#fd_lockout_offset_decode_footprint_inner>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)