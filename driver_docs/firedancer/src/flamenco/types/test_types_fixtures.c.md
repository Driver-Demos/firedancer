<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for verifying type encoding and decoding against predefined fixtures using bincode and YAML formats.

# Purpose
The code is a test suite designed to verify the encoding and decoding of data types against predefined fixtures. It includes test vectors that are defined using the `TEST_VECTOR` macro, which specifies the name, type, and properties of each test fixture. These fixtures are sourced from binary and YAML files located in the `src/flamenco/types/fixtures/` directory. The test suite checks the correctness of the encoding and decoding processes by comparing the actual output against expected YAML representations and ensuring idempotency, meaning that data can be decoded and then re-encoded to match the original input.

The code defines a structure `test_fixture_t` that holds information about each test fixture, including function pointers for encoding and decoding operations. The [`main`](<#main>) function iterates over the test fixtures, executing the [`test_yaml`](<#test_yaml>) and [`test_idempotent`](<#test_idempotent>) functions for each fixture. These functions perform the actual testing by decoding binary data, encoding it into YAML, and verifying the results. The code uses a scratch memory area to manage temporary data during the tests, ensuring that memory is safely allocated and deallocated. The test suite is intended to be executed as a standalone program, as indicated by the presence of the [`main`](<#main>) function.
# Imports and Dependencies

---
- `fd_types.h`
- `fd_types_yaml.h`
- `stdio.h`


# Data Structures

---
### test\_fixture
- **Type**: ``struct``
- **Members**:
    - ``name``: Pointer to a constant character string representing the name of the test fixture.
    - ``dump_path``: Pointer to a constant character string representing the path to dump the YAML output.
    - ``bin``: Pointer to a constant unsigned character array containing binary data.
    - ``bin_sz``: Pointer to a constant unsigned long representing the size of the binary data.
    - ``yml``: Pointer to a constant character array containing YAML data.
    - ``yml_sz``: Pointer to a constant unsigned long representing the size of the YAML data.
    - ``struct_sz``: Unsigned long representing the size of the outer structure.
    - ``check_idem``: Unsigned character indicating if idempotency checks are required.
    - ``decode_footprint``: Function pointer for decoding the footprint of the binary data.
    - ``decode``: Function pointer for decoding the binary data.
    - ``decode_global``: Function pointer for globally decoding the binary data.
    - ``encode``: Function pointer for encoding the data into binary format.
    - ``encode_global``: Function pointer for globally encoding the data into binary format.
    - ``walk``: Function pointer for walking through the data structure.
    - ``align``: Function pointer for aligning the data structure.
- **Description**: Represents a test fixture used to verify the decoding and encoding of types against captured binary and YAML data. It includes pointers to binary and YAML data, their sizes, and function pointers for various operations such as decoding, encoding, and alignment. The structure also contains metadata such as the name of the fixture, the path for dumping YAML output, and a flag for idempotency checks.


---
### test\_fixture\_t
- **Type**: `struct`
- **Members**:
    - `name`: Pointer to a constant character string representing the name of the test fixture.
    - `dump_path`: Pointer to a constant character string representing the path to the YAML dump file.
    - `bin`: Pointer to a constant unsigned character array containing the binary data of the test fixture.
    - `bin_sz`: Pointer to a constant unsigned long representing the size of the binary data.
    - `yml`: Pointer to a constant character string containing the YAML representation of the test fixture.
    - `yml_sz`: Pointer to a constant unsigned long representing the size of the YAML data.
    - `struct_sz`: Unsigned long representing the size of the outer structure.
    - `check_idem`: Unsigned character indicating whether to check idempotency.
    - `decode_footprint`: Function pointer to a function that calculates the decode footprint.
    - `decode`: Function pointer to a function that decodes the binary data.
    - `decode_global`: Function pointer to a function that decodes the binary data globally.
    - `encode`: Function pointer to a function that encodes the data.
    - `encode_global`: Function pointer to a function that encodes the data globally.
    - `walk`: Function pointer to a function that walks through the data structure.
    - `align`: Function pointer to a function that returns the alignment of the data structure.
- **Description**: Represents a test fixture used to verify the decoding and encoding of types against captured bincode data. It includes metadata such as the name, paths to binary and YAML files, and function pointers for encoding and decoding operations. The structure also contains size information and a flag to check idempotency, facilitating the testing of data serialization and deserialization processes.


# Functions

---
### test\_yaml<!-- {{#callable:test_yaml}} -->
[View Source →](<../../../../../src/flamenco/types/test_types_fixtures.c#L132>)

Deserializes a binary code blob and verifies its YAML representation against an expected YAML output.
- **Inputs**:
    - `t`: A pointer to a `test_fixture_t` structure containing test data and function pointers for decoding and encoding operations.
- **Logic and Control Flow**:
    - Initialize `bin_sz` with the size of the binary data from `t->bin_sz` and set up a decode context `decode` with the binary data and its end.
    - Check if the scratch memory is safe to prepare using `fd_scratch_prepare_is_safe` and allocate memory for `decoded` using `fd_scratch_prepare`.
    - Call `t->decode_footprint` to determine the total size of the decoded data and check for errors; log an error and exit if decoding fails.
    - Verify the safety of publishing the decoded data using `fd_scratch_publish_is_safe`, decode the binary data into `decoded`, and publish it using `fd_scratch_publish`.
    - Prepare a buffer `yaml_buf` for YAML encoding and open a memory stream `file` for writing YAML data.
    - Initialize a YAML context `yaml` using [`fd_flamenco_yaml_init`](<fd_types_yaml.c.md#fd_flamenco_yaml_init>) and [`fd_flamenco_yaml_new`](<fd_types_yaml.c.md#fd_flamenco_yaml_new>), then walk through the decoded data to encode it into YAML format using `t->walk`.
    - Check for errors in the file stream, ensure the file size is greater than zero, and close the file stream.
    - Compare the size and content of the generated YAML with the expected YAML size and content from `t->yml_sz` and `t->yml`; log a warning and dump the actual YAML to a file if they do not match.
- **Output**: No return value; logs errors and warnings if the test fails.
- **Functions Called**:
    - [`fd_flamenco_yaml_init`](<fd_types_yaml.c.md#fd_flamenco_yaml_init>)
    - [`fd_flamenco_yaml_new`](<fd_types_yaml.c.md#fd_flamenco_yaml_new>)


---
### test\_idempotent<!-- {{#callable:test_idempotent}} -->
[View Source →](<../../../../../src/flamenco/types/test_types_fixtures.c#L188>)

Verifies that the deserialized and re-serialized binary data from a test fixture is identical to the original binary data.
- **Inputs**:
    - `t`: A pointer to a `test_fixture_t` structure containing the test fixture data and functions for encoding and decoding.
- **Logic and Control Flow**:
    - Check if `t->check_idem` is true; if not, return immediately.
    - Initialize a `fd_bincode_decode_ctx_t` structure with the binary data from the fixture.
    - Prepare a scratch space for decoding using `fd_scratch_prepare` and verify its safety with `fd_scratch_prepare_is_safe`.
    - Decode the binary data using `t->decode_footprint` and check for errors.
    - Publish the decoded data to the scratch space and verify its safety with `fd_scratch_publish_is_safe`.
    - Allocate a buffer for encoding using `fd_scratch_alloc` and verify its safety with `fd_scratch_alloc_is_safe`.
    - Encode the decoded data back into binary format using `t->encode` and check for errors.
    - Compare the re-encoded data with the original binary data using `memcmp` and log an error if they do not match.
    - If `t->decode_global` is available, reset the decoded data, decode the global structure, encode it back, and compare it to the original binary data, logging an error if they do not match.
- **Output**: No return value; logs errors if the re-encoded data does not match the original binary data.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/flamenco/types/test_types_fixtures.c#L259>)

Initializes the environment, runs a series of tests on data fixtures, and ensures memory is properly managed.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Allocates and attaches a 32 MiB scratch memory using `fd_scratch_attach`.
    - Iterates over each test fixture in `test_vector`.
    - For each fixture, pushes the current scratch state, runs [`test_yaml`](<#test_yaml>), and pops the scratch state.
    - Pushes the scratch state again, runs [`test_idempotent`](<#test_idempotent>), and pops the scratch state.
    - Checks that no scratch memory is used with `FD_TEST(fd_scratch_frame_used()==0UL)`.
    - Detaches the scratch memory using `fd_scratch_detach`.
    - Logs a notice indicating the tests passed with `FD_LOG_NOTICE`.
    - Calls `fd_halt` to terminate the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`test_yaml`](<#test_yaml>)
    - [`test_idempotent`](<#test_idempotent>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)