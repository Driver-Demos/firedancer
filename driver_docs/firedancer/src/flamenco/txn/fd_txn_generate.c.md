<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for generating and managing transaction metadata and payloads in a blockchain context.

# Purpose
The code defines a set of functions and structures for generating and managing transaction metadata and payloads in a financial or blockchain-related application. It includes the definition of a packed structure `fd_txn_message_hdr` to represent a message header with fields for the number of signatures and readonly signatures. The function [`fd_txn_base_generate`](<#fd_txn_base_generate>) initializes transaction metadata and payload, setting up the message header, account information, and optionally a recent blockhash. It ensures constraints such as the maximum number of signatures and account addresses are not exceeded.

The code also provides functions to add instructions to a transaction ([`fd_txn_add_instr`](<#fd_txn_add_instr>)) and to reset instructions ([`fd_txn_reset_instrs`](<#fd_txn_reset_instrs>)). The [`fd_txn_add_instr`](<#fd_txn_add_instr>) function appends a new instruction to the transaction payload, updating the metadata with the program ID, account information, and instruction data. The [`fd_txn_reset_instrs`](<#fd_txn_reset_instrs>) function clears the instructions from the transaction metadata and payload. These functions work together to construct and manage transaction data, ensuring that the transaction structure adheres to predefined limits and formats.
# Imports and Dependencies

---
- `fd_txn_generate.h`


# Data Structures

---
### fd\_txn\_message\_hdr
- **Type**: ``struct``
- **Members**:
    - `num_signatures`: Stores the number of signatures in the transaction.
    - `num_readonly_signatures`: Stores the number of readonly signatures in the transaction.
    - `num_readonly_unsigned`: Stores the number of readonly unsigned accounts in the transaction.
- **Description**: Defines a packed structure that represents the header of a transaction message, containing fields for the number of signatures, readonly signatures, and readonly unsigned accounts.


---
### fd\_txn\_message\_hdr\_t
- **Type**: ``struct``
- **Members**:
    - ``num_signatures``: Stores the number of signatures in the transaction.
    - ``num_readonly_signatures``: Stores the number of readonly signatures in the transaction.
    - ``num_readonly_unsigned``: Stores the number of readonly unsigned accounts in the transaction.
- **Description**: Defines a packed structure that represents the header of a transaction message, containing fields for the number of signatures, readonly signatures, and readonly unsigned accounts.


# Functions

---
### fd\_txn\_instr\_meta\_generate<!-- {{#callable:fd_txn_instr_meta_generate}} -->
[View Source →](<../../../../../src/flamenco/txn/fd_txn_generate.c#L12>)

Initializes a `fd_txn_instr_t` structure with given transaction instruction metadata and returns a pointer to it.
- **Inputs**:
    - `out_buf`: A pointer to a buffer where the `fd_txn_instr_t` structure will be stored.
    - `program_id`: The program identifier for the transaction instruction.
    - `acct_cnt`: The number of accounts involved in the transaction instruction.
    - `data_sz`: The size of the data associated with the transaction instruction.
    - `acct_off`: The offset for the accounts in the transaction instruction.
    - `data_off`: The offset for the data in the transaction instruction.
- **Logic and Control Flow**:
    - Cast `out_buf` to a `fd_txn_instr_t` pointer and assign it to `out_instr`.
    - Set the `program_id` field of `out_instr` to the input `program_id`.
    - Set the `acct_cnt` field of `out_instr` to the input `acct_cnt`.
    - Set the `data_sz` field of `out_instr` to the input `data_sz`.
    - Set the `acct_off` field of `out_instr` to the input `acct_off`.
    - Set the `data_off` field of `out_instr` to the input `data_off`.
    - Return the pointer `out_instr`.
- **Output**: A pointer to the initialized `fd_txn_instr_t` structure.


---
### fd\_txn\_base\_generate<!-- {{#callable:fd_txn_base_generate}} -->
[View Source →](<../../../../../src/flamenco/txn/fd_txn_generate.c#L28>)

Generates a transaction metadata and payload based on the given number of signatures, account details, and an optional recent blockhash.
- **Inputs**:
    - `out_txn_meta`: A buffer to store the generated transaction metadata, with a size of at least `FD_TXN_MAX_SZ`.
    - `out_txn_payload`: A buffer to store the generated transaction payload, with a size of at least `FD_TXN_MTU`.
    - `num_signatures`: The number of signatures for the transaction, which must not exceed 127.
    - `accounts`: A pointer to an `fd_txn_accounts_t` structure containing account details such as account count and signature counts.
    - `opt_recent_blockhash`: An optional pointer to a recent blockhash, which can be `NULL`.
- **Logic and Control Flow**:
    - Check that `num_signatures` does not exceed `FD_TXN_SIG_MAX` and store it in the first byte of `out_txn_payload`.
    - Initialize the transaction metadata structure `txn_meta` using `out_txn_meta` and populate it with account and signature information from `accounts`.
    - Calculate offsets for message, signature, account addresses, and recent blockhash within the transaction metadata.
    - Write the message header to the transaction payload at the calculated message offset.
    - Write the number of accounts to the transaction payload.
    - Copy account addresses for signers and non-signers into the transaction payload, updating the write pointer accordingly.
    - Verify that the write pointer matches the expected offset for the recent blockhash.
    - Write the recent blockhash to the transaction payload, using `opt_recent_blockhash` if provided, or zeroing the space if not.
    - Return the total size of the generated transaction payload.
- **Output**: Returns the size of the generated transaction payload as an `ulong`.


---
### fd\_txn\_add\_instr<!-- {{#callable:fd_txn_add_instr}} -->
[View Source →](<../../../../../src/flamenco/txn/fd_txn_generate.c#L93>)

Adds an instruction to a transaction payload and updates transaction metadata.
- **Inputs**:
    - `txn_meta_ptr`: A pointer to the transaction metadata structure.
    - `out_txn_payload`: An array to store the transaction payload, with a minimum size defined by `FD_TXN_MTU`.
    - `program_id`: The identifier of the program to which the instruction belongs.
    - `accounts`: A pointer to an array of account identifiers used by the instruction.
    - `accounts_sz`: The size of the `accounts` array.
    - `instr_buf`: A pointer to the buffer containing the instruction data.
    - `instr_buf_sz`: The size of the `instr_buf` buffer.
- **Logic and Control Flow**:
    - Cast `txn_meta_ptr` to a `fd_txn_t` pointer and store it in `txn_meta`.
    - Check that the instruction count in `txn_meta` is less than `FD_TXN_INSTR_MAX` and that `recent_blockhash_off` is not zero.
    - Calculate the starting point for the new instruction in `out_txn_payload` using `recent_blockhash_off` and `FD_TXN_BLOCKHASH_SZ`.
    - Increment the instruction count in `txn_meta`.
    - Encode the new instruction count as a compact unsigned 16-bit integer and store it in `out_txn_payload`.
    - If there is more than one instruction, calculate the offset for the new instruction based on the previous instruction's data offset and size.
    - Store the `program_id` in `out_txn_payload`.
    - Encode the size of the `accounts` array as a compact unsigned 16-bit integer and store it in `out_txn_payload`.
    - Copy the `accounts` array into `out_txn_payload` and update the write pointer.
    - Encode the size of the `instr_buf` as a compact unsigned 16-bit integer and store it in `out_txn_payload`.
    - Copy the `instr_buf` into `out_txn_payload` and update the write pointer.
    - Generate instruction metadata using [`fd_txn_instr_meta_generate`](<#fd_txn_instr_meta_generate>) and update the instruction metadata in `txn_meta`.
- **Output**: Returns the total number of bytes written to `out_txn_payload` as an unsigned long integer.
- **Functions Called**:
    - [`fd_txn_instr_meta_generate`](<#fd_txn_instr_meta_generate>)


---
### fd\_txn\_reset\_instrs<!-- {{#callable:fd_txn_reset_instrs}} -->
[View Source →](<../../../../../src/flamenco/txn/fd_txn_generate.c#L148>)

Resets the instruction count and clears the instruction data in the transaction payload.
- **Inputs**:
    - `txn_meta_ptr`: A pointer to the transaction metadata structure (`fd_txn_t`).
    - `out_txn_payload`: An array representing the transaction payload with a static size defined by `FD_TXN_MTU`.
- **Logic and Control Flow**:
    - Cast `txn_meta_ptr` to a `fd_txn_t` pointer named `txn_meta`.
    - Check if `txn_meta->instr_cnt` is zero; if true, return immediately.
    - Calculate `instr_start` as the sum of `txn_meta->recent_blockhash_off` and `FD_TXN_BLOCKHASH_SZ`.
    - Set the byte at `out_txn_payload + instr_start` to zero.
    - Set `txn_meta->instr_cnt` to zero.
- **Output**: No return value; the function modifies the transaction metadata and payload in place.



---
Made with ❤️ by [Driver](https://www.driver.ai/)