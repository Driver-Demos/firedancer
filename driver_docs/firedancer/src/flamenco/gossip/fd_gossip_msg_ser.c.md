<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements serialization and encoding functions for gossip messages in the Firedancer codebase.

# Purpose
The code is a C source file that provides functionality for encoding and processing gossip protocol messages, specifically related to contact information and voting within a network. It includes functions for encoding version information, converting socket data into a specific format, and initializing pull requests. The file defines several macros and inline functions to facilitate the serialization of data into a buffer, ensuring that the data is encoded in a compact and efficient manner. The [`varint_encode`](<#varint_encode>) function is used to encode integers in a variable-length format, which is useful for minimizing the size of the encoded data.

The file also defines structures such as `socket_entry_t` and `socket_ctx_t` to represent socket entries and their context, respectively. The [`contact_info_convert_sockets`](<#contact_info_convert_sockets>) function processes socket information from a `fd_contact_info_t` structure, sorting and encoding it into a format suitable for transmission. The [`fd_gossip_contact_info_encode`](<#fd_gossip_contact_info_encode>) and [`fd_gossip_crds_vote_encode`](<#fd_gossip_crds_vote_encode>) functions handle the encoding of contact information and votes, respectively, into a buffer for network communication. These functions ensure that the encoded data adheres to the expected format of the gossip protocol, including handling of signatures, public keys, and timestamps. The code is intended to be part of a larger system that manages network communication and data exchange using a gossip protocol.
# Imports and Dependencies

---
- `fd_gossip_types.h`
- `fd_gossip_private.h`
- `../../util/bits/fd_bits.h`
- `../../util/tmpl/fd_sort.c`


# Data Structures

---
### socket\_entry
- **Type**: ``struct``
- **Members**:
    - ``port_offset``: Stores the offset of the port relative to the previous socket entry's port value.
    - ``tag``: Identifies the type or category of the socket entry.
    - ``addr_index``: Indexes into a list of unique IP addresses.
- **Description**: The `socket_entry` structure is used to represent a socket in a compact form by storing the port as an offset from the previous socket's port, a tag to identify the socket type, and an index to a list of unique IP addresses. This structure is part of a system that encodes contact information for network communication, where sockets are sorted by port values and IP addresses are stored separately to reduce redundancy.


---
### socket\_entry\_t
- **Type**: ``struct``
- **Members**:
    - `port_offset`: Stores the offset of the port relative to the previous socket entry's port value.
    - `tag`: Identifies the type or category of the socket entry.
    - `addr_index`: Indexes into a list of unique IP addresses.
- **Description**: The `socket_entry_t` structure is used to represent a socket entry in a gossip protocol encoding. It contains information about the port offset, a tag to identify the socket type, and an index to a list of unique IP addresses. This structure helps in organizing and encoding socket information efficiently by using offsets and indices, which reduces redundancy and optimizes storage.


---
### socket\_ctx
- **Type**: ``struct``
- **Members**:
    - `socket`: A field of type `fd_ip4_port_t` that stores socket information including IP and port.
    - `socket_tag`: A field of type `uchar` that stores a tag associated with the socket.
- **Description**: Represents a context for a socket, containing both the socket information and an associated tag. The `socket` field holds the IP and port details, while the `socket_tag` field is used to store a tag that can be used to identify or categorize the socket.


---
### socket\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - `socket`: Stores the socket information as a `fd_ip4_port_t` type.
    - `socket_tag`: Stores a tag for the socket as an `uchar` type.
- **Description**: Represents a context for a socket, containing the socket information and a tag to identify the socket. This structure is used to manage and sort socket information based on their port values, facilitating operations like encoding and conversion of contact information in a network communication context.


# Functions

---
### varint\_encode<!-- {{#callable:varint_encode}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip_msg_ser.c#L20>)

Encodes a 64-bit unsigned integer into a variable-length byte sequence using a modified LEB128 encoding.
- **Inputs**:
    - `u64`: The 64-bit unsigned integer to encode.
    - `out_buf`: A pointer to the output buffer where the encoded bytes will be stored.
- **Logic and Control Flow**:
    - Initialize a counter `i` to 0 to track the number of bytes written.
    - Enter a do-while loop that continues until `u64` becomes zero.
    - In each iteration, extract the least significant 7 bits of `u64` and store them in `byte`.
    - Shift `u64` right by 7 bits to process the next 7 bits in the next iteration.
    - If `u64` is not zero after the shift, set the most significant bit of `byte` to 1 to indicate more bytes follow.
    - Store `byte` in the `out_buf` at the current index `i` using the `FD_STORE` macro.
    - Increment `i` to move to the next position in the output buffer.
    - Exit the loop when `u64` becomes zero, indicating all bits have been processed.
    - Return `i`, the number of bytes written to `out_buf`.
- **Output**: Returns the number of bytes written to the `out_buf`.


---
### encode\_version<!-- {{#callable:encode_version}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip_msg_ser.c#L33>)

Encodes version information from a `fd_contact_info_t` structure into a buffer using variable-length encoding for certain fields.
- **Inputs**:
    - `contact_info`: A pointer to a `fd_contact_info_t` structure containing version information to encode.
    - `out_buf`: A pointer to an output buffer where the encoded version information will be stored.
    - `out_buf_sz`: The size of the output buffer in bytes.
    - `start_offset`: The starting offset in the output buffer where encoding will begin.
- **Logic and Control Flow**:
    - Initialize the serialization process with `SER_INIT`, setting up the buffer and offset variables.
    - Encode the `major`, `minor`, and `patch` version numbers from `contact_info` using [`varint_encode`](<#varint_encode>) and increment the cursor position accordingly.
    - Store the `commit` and `feature_set` fields directly into the buffer as 4-byte unsigned integers and increment the cursor position by 4 bytes for each.
    - Encode the `client` field using [`varint_encode`](<#varint_encode>) and increment the cursor position.
    - Return the total number of bytes consumed during the encoding process.
- **Output**: Returns the number of bytes consumed in the output buffer after encoding the version information.
- **Functions Called**:
    - [`varint_encode`](<#varint_encode>)


---
### contact\_info\_convert\_sockets<!-- {{#callable:contact_info_convert_sockets}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip_msg_ser.c#L105>)

Converts socket information from a contact info structure into sorted socket entries and unique address lists.
- **Inputs**:
    - `contact_info`: A pointer to a `fd_contact_info_t` structure containing socket information to convert.
    - `out_sockets_entries`: An array of `socket_entry_t` to store the converted and sorted socket entries.
    - `out_socket_entries_cnt`: A pointer to a `uchar` to store the count of socket entries.
    - `out_addrs`: An array of `uint` to store the unique IP addresses.
    - `out_addrs_cnt`: A pointer to a `uchar` to store the count of unique addresses.
- **Logic and Control Flow**:
    - Check if `contact_info`, `out_socket_entries_cnt`, or `out_addrs_cnt` are NULL; if so, log a warning and return -1.
    - Initialize an array `filled_up` to store non-zero socket entries from `contact_info`.
    - Iterate over `contact_info->sockets` to populate `filled_up` with non-zero sockets, converting port numbers to host order and storing socket tags.
    - Sort the `filled_up` array by port numbers using `sort_socket_port_stable_fast`.
    - Initialize counters `addrs_cnt` and `socket_entries_cnt` to zero.
    - Add the first sorted socket's address to `out_addrs` and create the first socket entry in `out_sockets_entries`.
    - Iterate over the remaining sorted sockets, checking if each address is already in `out_addrs`; if not, add it.
    - For each socket, calculate the port offset relative to the previous socket and store it in `out_sockets_entries`.
    - Update `out_addrs_cnt` and `out_socket_entries_cnt` with the final counts.
    - Return 0 to indicate successful conversion.
- **Output**: Returns 0 on success, or -1 if any input pointers are NULL.


---
### fd\_gossip\_pull\_request\_init<!-- {{#callable:fd_gossip_pull_request_init}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip_msg_ser.c#L171>)

Initializes a gossip pull request payload with specified parameters and outputs pointers to bloom filter components.
- **Inputs**:
    - `payload`: A pointer to the buffer where the payload will be initialized.
    - `payload_sz`: The size of the payload buffer.
    - `num_keys`: The number of keys for the bloom filter.
    - `num_bits`: The number of bits for the bloom filter.
    - `mask`: A mask value used in the payload.
    - `mask_bits`: The number of bits in the mask.
    - `contact_info_crds`: A pointer to the contact information to be included in the payload.
    - `contact_info_crds_sz`: The size of the contact information data.
    - `out_bloom_keys`: A pointer to store the address of the bloom keys in the payload.
    - `out_bloom_bits`: A pointer to store the address of the bloom bits in the payload.
    - `out_bits_set`: A pointer to store the address of the bits set in the payload.
    - `out_payload_sz`: A pointer to store the size of the initialized payload.
- **Logic and Control Flow**:
    - Check if `payload_sz` is less than or equal to `FD_GOSSIP_MTU`.
    - Initialize the payload with `SER_INIT` macro.
    - Store the pull request message type and increment the cursor by 4 bytes.
    - Store `num_keys` and increment the cursor by 8 bytes.
    - Set `out_bloom_keys` to the current cursor position and increment by `num_keys * 8` bytes.
    - If `num_bits` is non-zero, calculate `bloom_vec_len`, store a flag indicating presence of bits, store `bloom_vec_len`, set `out_bloom_bits` to the current cursor, and increment by `bloom_vec_len * 8` bytes.
    - If `num_bits` is zero, store a flag indicating absence of bits and set `out_bloom_bits` to NULL.
    - Store `num_bits` and set `out_bits_set` to the current cursor, then increment by 8 bytes.
    - Store `mask` and `mask_bits`, incrementing the cursor by 8 and 4 bytes respectively.
    - Check if remaining bytes are sufficient for `contact_info_crds_sz`; if not, log a warning and return -1.
    - Copy `contact_info_crds` to the current cursor position and increment by `contact_info_crds_sz`.
    - Set `out_payload_sz` to the number of bytes consumed and return 0.
- **Output**: Returns 0 on success, or -1 if there is not enough space for the contact information.


---
### fd\_gossip\_contact\_info\_encode<!-- {{#callable:fd_gossip_contact_info_encode}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip_msg_ser.c#L216>)

Encodes contact information into a buffer for gossip protocol communication.
- **Inputs**:
    - ``contact_info``: A pointer to a `fd_contact_info_t` structure containing the contact information to encode.
    - ``out_buf``: A pointer to a buffer where the encoded contact information will be stored.
    - ``out_buf_sz``: The size of the `out_buf` buffer.
    - ``opt_encoded_sz``: An optional pointer to a `ulong` where the function will store the size of the encoded data.
- **Logic and Control Flow**:
    - Check if `out_buf_sz` is less than or equal to `FD_GOSSIP_MTU` using `FD_TEST` macro.
    - Convert contact information sockets to address and socket entries using [`contact_info_convert_sockets`](<#contact_info_convert_sockets>).
    - Initialize serialization with `SER_INIT` macro.
    - Reserve 64 bytes in the buffer for a signature.
    - Store the contact info type identifier `FD_GOSSIP_VALUE_CONTACT_INFO` and increment the buffer cursor.
    - Copy the public key from `contact_info` to the buffer and increment the cursor.
    - Convert `wallclock_nanos` to milliseconds and encode it as a varint in the buffer.
    - Store `instance_creation_wallclock_nanos` as microseconds and `shred_version` in the buffer.
    - Encode the version information using [`encode_version`](<#encode_version>) and increment the cursor.
    - Store the count of addresses and encode each address with a discriminant in the buffer.
    - Store the count of socket entries and encode each entry's tag, address index, and port offset as a varint.
    - Store a zero-length extension due to a quirk in `short_vec`.
    - If `opt_encoded_sz` is not null, store the total bytes consumed in it.
- **Output**: Returns 0 on successful encoding of contact information.
- **Functions Called**:
    - [`contact_info_convert_sockets`](<#contact_info_convert_sockets>)
    - [`varint_encode`](<#varint_encode>)
    - [`encode_version`](<#encode_version>)


---
### fd\_gossip\_crds\_vote\_encode<!-- {{#callable:fd_gossip_crds_vote_encode}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip_msg_ser.c#L281>)

Encodes a CRDS vote into a buffer with a specific format.
- **Inputs**:
    - `out_buf`: A pointer to the output buffer where the encoded vote will be stored.
    - `out_buf_sz`: The size of the output buffer.
    - `txn`: A pointer to the transaction data to be included in the vote.
    - `txn_sz`: The size of the transaction data.
    - `identity_pubkey`: A pointer to the identity public key to be included in the vote.
    - `now`: The current time in nanoseconds, used to timestamp the vote.
    - `opt_encoded_sz`: An optional pointer to store the size of the encoded vote.
- **Logic and Control Flow**:
    - Initialize the serialization process with `SER_INIT`, setting up the buffer and offset.
    - Reserve 64 bytes in the buffer for a signature.
    - Store the constant `FD_GOSSIP_VALUE_VOTE` in the buffer and increment the cursor by 4 bytes.
    - Store a placeholder byte for the vote tower index and increment the cursor by 1 byte.
    - Copy the `identity_pubkey` into the buffer and increment the cursor by 32 bytes.
    - Copy the transaction data `txn` into the buffer and increment the cursor by the size of the transaction.
    - Convert the current time `now` from nanoseconds to milliseconds and store it in the buffer, incrementing the cursor by 8 bytes.
    - If `opt_encoded_sz` is provided, store the total number of bytes consumed in the buffer into `opt_encoded_sz`.
- **Output**: Returns 0 to indicate successful encoding.



---
Made with ❤️ by [Driver](https://www.driver.ai/)