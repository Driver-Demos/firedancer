<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Unit tests for the ping tracker functionality in the Firedancer codebase, including tests for basic operations, registration, address changes, invalid transitions, and random scenarios.

# Purpose
The code is a C test suite for a ping tracker system, which is part of a larger software framework. It includes several test functions that validate the behavior of the `fd_ping_tracker` component. The test suite checks various functionalities such as tracking peers, handling state changes, and managing ping-pong interactions. The code uses random number generation to simulate peer data and network conditions, ensuring that the ping tracker can handle a variety of scenarios.

The test suite is organized into multiple functions, each focusing on a specific aspect of the ping tracker. These functions include [`test_basic`](<#test_basic>), [`test_register`](<#test_register>), [`test_change_address`](<#test_change_address>), [`test_invalid_transitions`](<#test_invalid_transitions>), and [`test_random`](<#test_random>). Each function sets up a test environment, executes operations on the ping tracker, and verifies the outcomes using assertions. The code also includes utility functions like [`generate_random_peer`](<#generate_random_peer>) to create random peer data and [`test_change`](<#test_change>) to track changes in the ping tracker state. The [`main`](<#main>) function orchestrates the execution of all test cases and logs the results.
# Imports and Dependencies

---
- `fd_gossip_types.h`
- `fd_ping_tracker.h`
- `../../ballet/sha256/fd_sha256.h`
- `../../util/fd_util.h`
- `test_crds_utils.c`


# Data Structures

---
### ping\_tracker\_change\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``last``: Stores the last known state of a peer, including public key, address, timestamp, and change type.
    - ``invoke_cnt``: Counts the number of times the change function was invoked.
- **Description**: Manages the context for tracking changes in peer states, specifically for a ping tracker system. It keeps track of the last known state of a peer and the number of times a change function has been invoked, which is useful for monitoring and responding to changes in peer connectivity or status.


---
### peer\_t
- **Type**: `struct`
- **Members**:
    - ``pubkey``: An array of 32 unsigned characters representing the public key of the peer.
    - ``address``: A `fd_ip4_port_t` structure representing the IP address and port of the peer.
- **Description**: Represents a peer in a network with a public key and an associated IP address and port. The `peer_t` structure is used to store and manage information about network peers, including their public keys and network addresses, which are essential for communication and identification in network operations.


# Functions

---
### generate\_random\_peer<!-- {{#callable:generate_random_peer}} -->
[View Source →](<../../../../../src/flamenco/gossip/test_ping_tracker.c#L26>)

Generates a random `peer_t` structure with a random public key and address using the provided random number generator.
- **Inputs**:
    - `rng`: A pointer to an `fd_rng_t` structure used to generate random values.
- **Logic and Control Flow**:
    - Initialize a `peer_t` structure `p` with zero values.
    - Iterate 32 times to fill the `pubkey` array of `p` with random unsigned characters generated by `fd_rng_uchar`.
    - Assign a random unsigned integer to `p.address.addr` using `fd_rng_uint`.
    - Assign a random unsigned short to `p.address.port` using `fd_rng_ushort`.
    - Return the populated `peer_t` structure `p`.
- **Output**: Returns a `peer_t` structure with a randomly generated public key and address.


---
### test\_change<!-- {{#callable:test_change}} -->
[View Source →](<../../../../../src/flamenco/gossip/test_ping_tracker.c#L35>)

Updates the context with the latest peer information and increments the invocation count.
- **Inputs**:
    - ``ctx``: A pointer to a `ping_tracker_change_ctx_t` structure that stores the last change details and invocation count.
    - ``peer_pubkey``: A constant pointer to an array of unsigned characters representing the peer's public key, with a length of 32 bytes.
    - ``peer_address``: A `fd_ip4_port_t` structure representing the peer's IP address and port.
    - ``now``: A long integer representing the current time.
    - ``change_type``: An integer representing the type of change that occurred.
- **Logic and Control Flow**:
    - Cast the `ctx` pointer to a `ping_tracker_change_ctx_t` pointer and store it in `c`.
    - Copy the `peer_pubkey` into `c->last.pubkey` using `memcpy` with a size of 32 bytes.
    - Assign `peer_address` to `c->last.address`.
    - Assign `now` to `c->last.now`.
    - Assign `change_type` to `c->last.change_type`.
    - Increment `c->invoke_cnt` by 1.
- **Output**: No return value; the function modifies the context pointed to by `ctx`.


---
### seconds<!-- {{#callable:seconds}} -->
[View Source →](<../../../../../src/flamenco/gossip/test_ping_tracker.c#L49>)

Converts seconds to nanoseconds by multiplying the input by 1,000,000,000.
- **Inputs**:
    - `s`: The number of seconds to convert to nanoseconds.
- **Logic and Control Flow**:
    - Multiplies the input `s` by 1,000,000,000 to convert seconds to nanoseconds.
    - Returns the result of the multiplication.
- **Output**: A `long` integer representing the equivalent time in nanoseconds.


---
### test\_basic<!-- {{#callable:test_basic}} -->
[View Source →](<../../../../../src/flamenco/gossip/test_ping_tracker.c#L54>)

Tests the basic functionality of the ping tracker system by simulating node tracking and request popping.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize a random number generator `rng` and verify its creation with `FD_TEST`.
    - Define an array `entrypoints` with a single random IP address and port generated using `rng`.
    - Allocate memory for the ping tracker using `aligned_alloc` and verify allocation with `FD_TEST`.
    - Create and join a new ping tracker instance with [`fd_ping_tracker_new`](<fd_ping_tracker.c.md#fd_ping_tracker_new>) and [`fd_ping_tracker_join`](<fd_ping_tracker.c.md#fd_ping_tracker_join>), and verify with `FD_TEST`.
    - Get the current time using `fd_log_wallclock`.
    - Attempt to pop requests from the ping tracker 100 times, expecting none to be available initially.
    - Generate a random public key `random_pubkey` using `rng`.
    - Track a high stake node and verify that no requests are popped after 10 seconds.
    - Track an entrypoint and verify that no requests are popped after 10 seconds.
    - Generate a random peer and track it with the ping tracker.
    - Pop a request from the ping tracker after 10 seconds and verify the peer's public key and address match the tracked peer.
    - Continue popping requests at various intervals, verifying the state and ensuring no change function invocations occur.
    - Free the allocated memory for the ping tracker.
- **Output**: No output is returned as the function is a void type and primarily performs tests with assertions.
- **Functions Called**:
    - [`fd_ping_tracker_align`](<fd_ping_tracker.c.md#fd_ping_tracker_align>)
    - [`fd_ping_tracker_footprint`](<fd_ping_tracker.c.md#fd_ping_tracker_footprint>)
    - [`fd_ping_tracker_join`](<fd_ping_tracker.c.md#fd_ping_tracker_join>)
    - [`fd_ping_tracker_new`](<fd_ping_tracker.c.md#fd_ping_tracker_new>)
    - [`fd_ping_tracker_pop_request`](<fd_ping_tracker.c.md#fd_ping_tracker_pop_request>)
    - [`fd_ping_tracker_track`](<fd_ping_tracker.c.md#fd_ping_tracker_track>)
    - [`seconds`](<#seconds>)
    - [`generate_random_peer`](<#generate_random_peer>)


---
### test\_register<!-- {{#callable:test_register}} -->
[View Source →](<../../../../../src/flamenco/gossip/test_ping_tracker.c#L121>)

Tests the registration and state change functionality of a ping tracker system using various scenarios and conditions.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initializes a random number generator `rng` and verifies its creation.
    - Defines an array `entrypoints` with a single random IP address and port, and allocates memory for the ping tracker using `aligned_alloc`.
    - Initializes a `ping_tracker_change_ctx_t` structure to track changes and joins a new ping tracker instance with the allocated memory and entrypoints.
    - Sets the current time `now` and verifies that no ping requests are pending initially by calling [`fd_ping_tracker_pop_request`](<fd_ping_tracker.c.md#fd_ping_tracker_pop_request>) in a loop.
    - Generates two random peers `p1` and `p2` using [`generate_random_peer`](<#generate_random_peer>).
    - Tracks peer `p1` twice with a 1-second interval using [`fd_ping_tracker_track`](<fd_ping_tracker.c.md#fd_ping_tracker_track>).
    - Pops a ping request and verifies the output matches `p1`'s public key and address.
    - Generates a valid pong token using SHA-256 hashing and the popped token.
    - Attempts to register `p1` with a different address, a wrong token, and as an unknown peer, verifying no state changes occur.
    - Registers `p1` with the correct token and verifies a state change to active occurs, updating the change context.
    - Attempts a second registration with the correct token and verifies no additional state change occurs.
    - Frees the allocated memory for the ping tracker.
- **Output**: No return value; the function performs tests and assertions to verify the behavior of the ping tracker system.
- **Functions Called**:
    - [`fd_ping_tracker_align`](<fd_ping_tracker.c.md#fd_ping_tracker_align>)
    - [`fd_ping_tracker_footprint`](<fd_ping_tracker.c.md#fd_ping_tracker_footprint>)
    - [`fd_ping_tracker_join`](<fd_ping_tracker.c.md#fd_ping_tracker_join>)
    - [`fd_ping_tracker_new`](<fd_ping_tracker.c.md#fd_ping_tracker_new>)
    - [`fd_ping_tracker_pop_request`](<fd_ping_tracker.c.md#fd_ping_tracker_pop_request>)
    - [`generate_random_peer`](<#generate_random_peer>)
    - [`fd_ping_tracker_track`](<fd_ping_tracker.c.md#fd_ping_tracker_track>)
    - [`seconds`](<#seconds>)
    - [`fd_ping_tracker_register`](<fd_ping_tracker.c.md#fd_ping_tracker_register>)


---
### test\_change\_address<!-- {{#callable:test_change_address}} -->
[View Source →](<../../../../../src/flamenco/gossip/test_ping_tracker.c#L191>)

Tests the functionality of changing a peer's address in a ping tracker system and verifies the correct invocation of change context.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize a random number generator `rng` and verify its creation.
    - Define an array `entrypoints` with a single random IP address and port.
    - Allocate memory for `fd_ping_tracker` and verify the allocation.
    - Initialize a `ping_tracker_change_ctx_t` structure to track changes.
    - Create and join a `fd_ping_tracker` instance with the allocated memory, random number generator, entrypoints, and change context.
    - Get the current time using `fd_log_wallclock()`.
    - Generate a random peer using `generate_random_peer()` and track it with `fd_ping_tracker_track()`.
    - Pop a request from the ping tracker and verify the output values.
    - Create a valid pong token using SHA-256 hashing and register the peer with `fd_ping_tracker_register()`.
    - Verify that the change context is updated correctly after registration.
    - Change the peer's address and track it again, verifying the change context updates.
- **Output**: No return value; the function performs tests and uses assertions to verify behavior.
- **Functions Called**:
    - [`fd_ping_tracker_align`](<fd_ping_tracker.c.md#fd_ping_tracker_align>)
    - [`fd_ping_tracker_footprint`](<fd_ping_tracker.c.md#fd_ping_tracker_footprint>)
    - [`fd_ping_tracker_join`](<fd_ping_tracker.c.md#fd_ping_tracker_join>)
    - [`fd_ping_tracker_new`](<fd_ping_tracker.c.md#fd_ping_tracker_new>)
    - [`generate_random_peer`](<#generate_random_peer>)
    - [`fd_ping_tracker_track`](<fd_ping_tracker.c.md#fd_ping_tracker_track>)
    - [`fd_ping_tracker_pop_request`](<fd_ping_tracker.c.md#fd_ping_tracker_pop_request>)
    - [`seconds`](<#seconds>)
    - [`fd_ping_tracker_register`](<fd_ping_tracker.c.md#fd_ping_tracker_register>)


---
### test\_random<!-- {{#callable:test_random}} -->
[View Source →](<../../../../../src/flamenco/gossip/test_ping_tracker.c#L243>)

Simulates random operations on a ping tracker to test its functionality.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize a random number generator `rng` and verify its creation with `FD_TEST`.
    - Define an array `entrypoints` with a single random IP address and port, and allocate memory for `bytes` using `aligned_alloc`.
    - Create a `ping_tracker` using [`fd_ping_tracker_new`](<fd_ping_tracker.c.md#fd_ping_tracker_new>) and [`fd_ping_tracker_join`](<fd_ping_tracker.c.md#fd_ping_tracker_join>), and verify its creation with `FD_TEST`.
    - Get the current time using `fd_log_wallclock` and store it in `now`.
    - Iterate 100,000 times, each time generating a random option `opt` between 0 and 3 using `fd_rng_uchar_roll`.
    - If `opt` is 0, generate a random peer and stake, update `now` with a random increment, and track the peer using [`fd_ping_tracker_track`](<fd_ping_tracker.c.md#fd_ping_tracker_track>).
    - If `opt` is 1, update `now` with a random increment and repeatedly call [`fd_ping_tracker_pop_request`](<fd_ping_tracker.c.md#fd_ping_tracker_pop_request>) until no more requests are available.
    - Free the allocated memory for `bytes`.
- **Output**: No return value; the function performs operations to test the ping tracker.
- **Functions Called**:
    - [`fd_ping_tracker_align`](<fd_ping_tracker.c.md#fd_ping_tracker_align>)
    - [`fd_ping_tracker_footprint`](<fd_ping_tracker.c.md#fd_ping_tracker_footprint>)
    - [`fd_ping_tracker_join`](<fd_ping_tracker.c.md#fd_ping_tracker_join>)
    - [`fd_ping_tracker_new`](<fd_ping_tracker.c.md#fd_ping_tracker_new>)
    - [`generate_random_peer`](<#generate_random_peer>)
    - [`fd_ping_tracker_track`](<fd_ping_tracker.c.md#fd_ping_tracker_track>)
    - [`fd_ping_tracker_pop_request`](<fd_ping_tracker.c.md#fd_ping_tracker_pop_request>)


---
### test\_invalid\_transitions<!-- {{#callable:test_invalid_transitions}} -->
[View Source →](<../../../../../src/flamenco/gossip/test_ping_tracker.c#L281>)

Tests the state transitions of a ping tracker for invalid scenarios.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize a random number generator `rng` and verify its creation.
    - Allocate memory for `fd_ping_tracker` and verify allocation success.
    - Create a `ping_tracker` instance with a single entry point and verify its creation.
    - Get the current time `now` and generate a random peer `p`.
    - Track the peer `p` using [`fd_ping_tracker_track`](<fd_ping_tracker.c.md#fd_ping_tracker_track>) and simulate a state transition from unpinged to invalid.
    - Generate a valid pong token using SHA-256 and register the peer to transition from invalid to valid.
    - Refresh the peer's state to simulate a valid to valid refreshing transition.
    - Simulate a transition from valid refreshing to invalid by tracking the peer after a time delay.
    - Verify the peer's state and address after each transition using [`fd_ping_tracker_pop_request`](<fd_ping_tracker.c.md#fd_ping_tracker_pop_request>).
    - Simulate the peer being dropped after 20 seconds of no reception.
    - Free the allocated memory for `bytes`.
- **Output**: No return value; the function uses assertions to verify state transitions.
- **Functions Called**:
    - [`fd_ping_tracker_align`](<fd_ping_tracker.c.md#fd_ping_tracker_align>)
    - [`fd_ping_tracker_footprint`](<fd_ping_tracker.c.md#fd_ping_tracker_footprint>)
    - [`fd_ping_tracker_join`](<fd_ping_tracker.c.md#fd_ping_tracker_join>)
    - [`fd_ping_tracker_new`](<fd_ping_tracker.c.md#fd_ping_tracker_new>)
    - [`generate_random_peer`](<#generate_random_peer>)
    - [`fd_ping_tracker_track`](<fd_ping_tracker.c.md#fd_ping_tracker_track>)
    - [`fd_ping_tracker_pop_request`](<fd_ping_tracker.c.md#fd_ping_tracker_pop_request>)
    - [`seconds`](<#seconds>)
    - [`fd_ping_tracker_register`](<fd_ping_tracker.c.md#fd_ping_tracker_register>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/flamenco/gossip/test_ping_tracker.c#L348>)

Executes a series of test functions to validate different aspects of a ping tracker system and logs the results.
- **Inputs**:
    - `argc`: The number of command-line arguments passed to the program.
    - `argv`: An array of strings representing the command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the system with command-line arguments.
    - Executes [`test_basic`](<#test_basic>) to perform basic tests on the ping tracker system.
    - Logs the result of [`test_basic`](<#test_basic>) using `FD_LOG_NOTICE`.
    - Executes [`test_register`](<#test_register>) to test the registration functionality of the ping tracker.
    - Logs the result of [`test_register`](<#test_register>) using `FD_LOG_NOTICE`.
    - Executes [`test_change_address`](<#test_change_address>) to test address change handling in the ping tracker.
    - Logs the result of [`test_change_address`](<#test_change_address>) using `FD_LOG_NOTICE`.
    - Executes [`test_invalid_transitions`](<#test_invalid_transitions>) to test invalid state transitions in the ping tracker.
    - Logs the result of [`test_invalid_transitions`](<#test_invalid_transitions>) using `FD_LOG_NOTICE`.
    - Executes [`test_random`](<#test_random>) to perform random tests on the ping tracker system.
    - Logs the result of [`test_random`](<#test_random>) using `FD_LOG_NOTICE`.
- **Output**: No return value; the function performs tests and logs results.
- **Functions Called**:
    - [`test_basic`](<#test_basic>)
    - [`test_register`](<#test_register>)
    - [`test_change_address`](<#test_change_address>)
    - [`test_invalid_transitions`](<#test_invalid_transitions>)
    - [`test_random`](<#test_random>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)