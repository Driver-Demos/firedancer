<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a Bloom filter with functions for initialization, insertion, and membership testing.

# Purpose
The code provides functionality for a Bloom filter, which is a probabilistic data structure used to test whether an element is a member of a set. It is designed to efficiently handle large datasets with a configurable false positive rate. The code includes functions to create, initialize, and manipulate a Bloom filter. The [`fd_bloom_new`](<#fd_bloom_new>) function allocates and initializes a new Bloom filter in shared memory, while [`fd_bloom_join`](<#fd_bloom_join>) allows a process to attach to an existing Bloom filter. The [`fd_bloom_initialize`](<#fd_bloom_initialize>) function sets up the filter with a specified number of items, and [`fd_bloom_insert`](<#fd_bloom_insert>) adds elements to the filter. The [`fd_bloom_contains`](<#fd_bloom_contains>) function checks if an element is likely in the set, returning a false positive with a probability defined by the false positive rate.

The code also includes utility functions such as [`fd_bloom_align`](<#fd_bloom_align>) and [`fd_bloom_footprint`](<#fd_bloom_footprint>) to manage memory alignment and calculate the memory footprint of the Bloom filter, respectively. The [`fnv_hasher`](<#fnv_hasher>) function implements a hash function used in the filter's operations. The [`fd_bloom_init_inplace`](<#fd_bloom_init_inplace>) function initializes a Bloom filter with pre-allocated memory, allowing for more control over memory management. The code uses several macros and functions from external headers, such as `fd_log.h` for logging and `fd_rng_t` for random number generation, indicating that it is part of a larger library or application.
# Imports and Dependencies

---
- `fd_bloom.h`
- `../../util/log/fd_log.h`
- `math.h`


# Global Variables

---
### FD\_BLOOM\_LN\_2
- **Type**: ``double``
- **Description**: Represents the natural logarithm of 2, which is approximately 0.6931471805599453. This constant is used in calculations related to Bloom filters.
- **Use**: Used to calculate the number of keys in a Bloom filter based on the maximum number of bits.


# Functions

---
### fnv\_hasher<!-- {{#callable:fnv_hasher}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_bloom.c#L8>)

Computes a hash value using the FNV-1a hash algorithm for a given byte array and initial key.
- **Inputs**:
    - `ele`: A pointer to the byte array to hash.
    - `ele_sz`: The size of the byte array.
    - `key`: The initial hash value or key to use in the hash computation.
- **Logic and Control Flow**:
    - Iterates over each byte in the input array `ele`.
    - For each byte, applies the XOR operation with the current `key`.
    - Multiplies the result by the FNV prime `1099511628211UL`.
    - Returns the final computed hash value.
- **Output**: The final hash value as an unsigned long integer.


---
### fd\_bloom\_align<!-- {{#callable:fd_bloom_align}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_bloom.c#L19>)

Returns the alignment requirement for a Bloom filter.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the constant `FD_BLOOM_ALIGN`.
- **Output**: The function returns an `ulong` value representing the alignment requirement for a Bloom filter.


---
### fd\_bloom\_footprint<!-- {{#callable:fd_bloom_footprint}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_bloom.c#L24>)

Calculates the memory footprint required for a Bloom filter based on the false positive rate and maximum number of bits.
- **Inputs**:
    - `false_positive_rate`: The desired false positive rate for the Bloom filter, must be between 0.0 and 1.0 exclusive.
    - `max_bits`: The maximum number of bits the Bloom filter can use, must be between 1 and 32768 inclusive.
- **Logic and Control Flow**:
    - Check if `false_positive_rate` is less than or equal to 0.0 or greater than or equal to 1.0; if so, return 0.
    - Check if `max_bits` is less than 1 or greater than 32768; if so, return 0.
    - Calculate `num_keys` as the rounded product of `max_bits` and `FD_BLOOM_LN_2`.
    - Initialize `l` with `FD_LAYOUT_INIT`.
    - Append the size of `fd_bloom_t` to `l` with alignment `FD_BLOOM_ALIGN`.
    - Append the size of the keys array to `l` with alignment 8, calculated as `num_keys` times the size of `ulong`.
    - Append the size of the bits array to `l` with alignment 8, calculated as `(max_bits+7)/8`.
    - Return the final layout size using `FD_LAYOUT_FINI` with alignment `FD_BLOOM_ALIGN`.
- **Output**: Returns the calculated memory footprint as an `ulong`, or 0 if input parameters are invalid.


---
### fd\_bloom\_new<!-- {{#callable:fd_bloom_new}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_bloom.c#L42>)

Allocates and initializes a new Bloom filter in shared memory with specified parameters.
- **Inputs**:
    - `shmem`: Pointer to shared memory where the Bloom filter will be allocated.
    - `rng`: Pointer to a random number generator used for initializing the Bloom filter.
    - `false_positive_rate`: Desired false positive rate for the Bloom filter.
    - `max_bits`: Maximum number of bits to allocate for the Bloom filter.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL; if so, log a warning and return NULL.
    - Check if `shmem` is aligned according to [`fd_bloom_align`](<#fd_bloom_align>); if not, log a warning and return NULL.
    - Check if `false_positive_rate` is within the range (0.0, 1.0); if not, return NULL.
    - Check if `max_bits` is within the range [1, 32768]; if not, return NULL.
    - Check if `rng` is NULL; if so, return NULL.
    - Calculate `num_keys` based on `max_bits` and a constant `FD_BLOOM_LN_2`.
    - Initialize scratch memory allocation with `shmem`.
    - Allocate memory for `fd_bloom_t`, keys, and bits using scratch memory allocation.
    - Verify the final memory allocation size matches the expected footprint.
    - Initialize the Bloom filter structure with allocated memory and input parameters.
    - Set the `magic` field to `FD_BLOOM_MAGIC` to indicate successful initialization.
    - Return a pointer to the initialized Bloom filter.
- **Output**: Pointer to the initialized `fd_bloom_t` structure, or NULL if initialization fails.
- **Functions Called**:
    - [`fd_bloom_align`](<#fd_bloom_align>)
    - [`fd_bloom_footprint`](<#fd_bloom_footprint>)


---
### fd\_bloom\_join<!-- {{#callable:fd_bloom_join}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_bloom.c#L91>)

Validates and returns a pointer to a `fd_bloom_t` structure if the input shared memory is correctly aligned and initialized.
- **Inputs**:
    - `shbloom`: A pointer to the shared memory region that is expected to contain a `fd_bloom_t` structure.
- **Logic and Control Flow**:
    - Check if `shbloom` is NULL; if true, log a warning and return NULL.
    - Verify if `shbloom` is aligned according to `fd_bloom_align()`; if not, log a warning and return NULL.
    - Cast `shbloom` to a `fd_bloom_t` pointer and store it in `bloom`.
    - Check if the `magic` field of `bloom` equals `FD_BLOOM_MAGIC`; if not, log a warning and return NULL.
    - Return the `bloom` pointer.
- **Output**: A pointer to a `fd_bloom_t` structure if successful, otherwise NULL.
- **Functions Called**:
    - [`fd_bloom_align`](<#fd_bloom_align>)


---
### fd\_bloom\_initialize<!-- {{#callable:fd_bloom_initialize}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_bloom.c#L113>)

Initializes a Bloom filter with a specified number of items, setting up its keys and bit array.
- **Inputs**:
    - `bloom`: A pointer to an `fd_bloom_t` structure that represents the Bloom filter to initialize.
    - `num_items`: The number of items that the Bloom filter is expected to handle.
- **Logic and Control Flow**:
    - Calculate the number of bits required for the Bloom filter using the false positive rate and the number of items.
    - Clamp the number of bits to be at least 1 and at most the maximum allowed by the Bloom filter.
    - Determine the number of keys based on the number of items; if `num_items` is zero, set `num_keys` to zero.
    - Generate random keys using the provided random number generator and store them in the Bloom filter's `keys` array.
    - Set the `keys_len` and `bits_len` fields of the Bloom filter to the calculated number of keys and bits, respectively.
    - Initialize the Bloom filter's bit array to zero.
- **Output**: The function does not return a value; it initializes the `bloom` structure in place.


---
### fd\_bloom\_insert<!-- {{#callable:fd_bloom_insert}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_bloom.c#L132>)

Inserts a key into a Bloom filter by setting specific bits in the filter's bit array.
- **Inputs**:
    - `bloom`: A pointer to the `fd_bloom_t` structure representing the Bloom filter.
    - `key`: A pointer to the key data to insert into the Bloom filter.
    - `key_sz`: The size of the key data in bytes.
- **Logic and Control Flow**:
    - Iterates over each key in the Bloom filter's `keys` array.
    - For each key, computes a hash value using the [`fnv_hasher`](<#fnv_hasher>) function with the provided key data and the current key from the `keys` array.
    - Calculates the bit position in the `bits` array by taking the modulus of the hash value with `bloom->bits_len`.
    - Sets the corresponding bit in the `bits` array to 1 by using bitwise OR operation.
- **Output**: No return value; the function modifies the Bloom filter in place.
- **Functions Called**:
    - [`fnv_hasher`](<#fnv_hasher>)


---
### fd\_bloom\_contains<!-- {{#callable:fd_bloom_contains}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_bloom.c#L142>)

Checks if a given key is present in the Bloom filter by verifying if all corresponding bits are set.
- **Inputs**:
    - `bloom`: A pointer to the `fd_bloom_t` structure representing the Bloom filter.
    - `key`: A pointer to the key data to check for presence in the Bloom filter.
    - `key_sz`: The size of the key data in bytes.
- **Logic and Control Flow**:
    - Iterates over each key in the Bloom filter's `keys` array.
    - For each key, computes a hash value using the [`fnv_hasher`](<#fnv_hasher>) function and the current key from the `keys` array.
    - Calculates the bit position in the `bits` array by taking the modulus of the hash value with `bloom->bits_len`.
    - Checks if the bit at the calculated position is set in the `bits` array.
    - If any bit is not set, returns 0 indicating the key is not present.
    - If all bits are set, returns 1 indicating the key is present.
- **Output**: Returns 1 if the key is present in the Bloom filter, otherwise returns 0.
- **Functions Called**:
    - [`fnv_hasher`](<#fnv_hasher>)


---
### fd\_bloom\_init\_inplace<!-- {{#callable:fd_bloom_init_inplace}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_bloom.c#L155>)

Initializes a Bloom filter in place with specified parameters and random keys.
- **Inputs**:
    - `keys`: Pointer to an array of unsigned long integers to store the keys.
    - `bits`: Pointer to an array of unsigned long integers to store the bits of the Bloom filter.
    - `keys_len`: Number of keys to generate and store in the Bloom filter.
    - `bits_len`: Number of bits in the Bloom filter.
    - `hash_seed`: Seed value for the hash function.
    - `rng`: Pointer to a random number generator used to generate keys.
    - `false_positive_rate`: Desired false positive rate for the Bloom filter.
    - `out_bloom`: Pointer to the `fd_bloom_t` structure to initialize.
- **Logic and Control Flow**:
    - Check if `keys`, `bits`, or `out_bloom` is NULL; if so, log an error and return -1.
    - Assign the `keys` pointer to `out_bloom->keys`.
    - Generate random keys using `fd_rng_ulong` and store them in `out_bloom->keys`.
    - Set `out_bloom->keys_len` to `keys_len`.
    - Assign the `bits` pointer to `out_bloom->bits`.
    - Set `out_bloom->bits_len` to `bits_len`.
    - Set `out_bloom->hash_seed` to `hash_seed`.
    - Assign the `rng` pointer to `out_bloom->rng`.
    - Set `out_bloom->false_positive_rate` to `false_positive_rate`.
    - Set `out_bloom->max_bits` to `bits_len`.
    - Return 0 to indicate successful initialization.
- **Output**: Returns 0 on successful initialization, or -1 if any input pointers are NULL.



---
Made with ❤️ by [Driver](https://www.driver.ai/)