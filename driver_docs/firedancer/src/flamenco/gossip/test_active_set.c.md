<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for the active set functionality in the Firedancer codebase, including stake bucket and active set operations.

# Purpose
The code is a test suite for validating the functionality of an active set management system. It includes two main test functions: [`test_get_stake_bucket`](<#test_get_stake_bucket>) and [`test_push_active_set`](<#test_push_active_set>). The [`test_get_stake_bucket`](<#test_get_stake_bucket>) function verifies the correct mapping of stake values to their respective bucket indices using the `fd_active_set_stake_bucket` function. It checks predefined stake values against expected bucket indices to ensure the function's accuracy.

The [`test_push_active_set`](<#test_push_active_set>) function tests the process of creating and managing an active set. It allocates memory for an active set, initializes a random number generator, and creates a test CRDS (Conflict-free Replicated Data Store) with peers. The function then verifies the initialization of the active set and tests the `fd_active_set_rotate` function to ensure that nodes are correctly rotated within the active set. It also tests the `fd_active_set_nodes` function to verify the retrieval of nodes based on given public keys and stakes. The [`main`](<#main>) function initializes the test environment and executes these test functions, logging a notice upon successful completion.
# Imports and Dependencies

---
- `fd_active_set.h`
- `fd_active_set_private.h`
- `test_crds_utils.c`


# Functions

---
### test\_get\_stake\_bucket<!-- {{#callable:test_get_stake_bucket}} -->
[View Source →](<../../../../../src/flamenco/gossip/test_active_set.c#L9>)

Tests the [`fd_active_set_stake_bucket`](<fd_active_set_private.h.md#fd_active_set_stake_bucket>) function to ensure it returns the correct bucket index for given stake values.
- **Inputs**: None
- **Logic and Control Flow**:
    - Defines an array `buckets` with expected bucket indices for stake values from 0 to 15 billion.
    - Iterates over the first 16 stake values, multiplying each by 1 billion, and checks if [`fd_active_set_stake_bucket`](<fd_active_set_private.h.md#fd_active_set_stake_bucket>) returns the expected bucket index from `buckets`.
    - Defines arrays `stake1` and `buckets1` with specific stake values and their expected bucket indices.
    - Iterates over the `stake1` array, multiplies each value by 1 billion, and checks if [`fd_active_set_stake_bucket`](<fd_active_set_private.h.md#fd_active_set_stake_bucket>) returns the expected bucket index from `buckets1`.
    - Checks if [`fd_active_set_stake_bucket`](<fd_active_set_private.h.md#fd_active_set_stake_bucket>) returns 24 for the maximum possible unsigned long value (`ULONG_MAX`).
- **Output**: No output is returned; the function uses assertions to validate behavior.
- **Functions Called**:
    - [`fd_active_set_stake_bucket`](<fd_active_set_private.h.md#fd_active_set_stake_bucket>)


---
### test\_push\_active\_set<!-- {{#callable:test_push_active_set}} -->
[View Source →](<../../../../../src/flamenco/gossip/test_active_set.c#L25>)

Tests the functionality of the active set operations, including creation, rotation, and node retrieval, using a test CRDS and random data.
- **Inputs**: None
- **Logic and Control Flow**:
    - Allocate memory for the active set using `aligned_alloc` and verify allocation with `FD_TEST`.
    - Initialize a random number generator `rng` and verify its creation with `FD_TEST`.
    - Create a test CRDS with 50 peers using [`create_test_crds_with_ci`](<test_crds_utils.c.md#create_test_crds_with_ci>) and verify its creation with `FD_TEST`.
    - Generate a random `identity_pubkey` and `identity_stake`.
    - Create and join a new active set using [`fd_active_set_new`](<fd_active_set.c.md#fd_active_set_new>) and [`fd_active_set_join`](<fd_active_set.c.md#fd_active_set_join>), then verify with `FD_TEST`.
    - Verify that each entry in the active set initially has zero nodes.
    - Rotate the active set using [`fd_active_set_rotate`](<fd_active_set.c.md#fd_active_set_rotate>) with the CRDS and verify that each entry has no more than 12 nodes and that each node's public key is in its bloom filter.
    - Generate a random `target_pubkey` and `target_stake`.
    - Retrieve nodes from the active set using [`fd_active_set_nodes`](<fd_active_set.c.md#fd_active_set_nodes>) and store the count in `out_cnt`.
    - Free the test CRDS and allocated memory.
- **Output**: No output is returned; the function performs tests and validations internally.
- **Functions Called**:
    - [`fd_active_set_align`](<fd_active_set.c.md#fd_active_set_align>)
    - [`fd_active_set_footprint`](<fd_active_set.c.md#fd_active_set_footprint>)
    - [`create_test_crds_with_ci`](<test_crds_utils.c.md#create_test_crds_with_ci>)
    - [`fd_active_set_join`](<fd_active_set.c.md#fd_active_set_join>)
    - [`fd_active_set_new`](<fd_active_set.c.md#fd_active_set_new>)
    - [`fd_active_set_rotate`](<fd_active_set.c.md#fd_active_set_rotate>)
    - [`fd_bloom_contains`](<fd_bloom.c.md#fd_bloom_contains>)
    - [`fd_active_set_nodes`](<fd_active_set.c.md#fd_active_set_nodes>)
    - [`free_test_crds`](<test_crds_utils.c.md#free_test_crds>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/flamenco/gossip/test_active_set.c#L72>)

Initializes the environment, runs two test functions, and logs a success message.
- **Inputs**:
    - `argc`: The count of command-line arguments.
    - `argv`: The array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Executes [`test_get_stake_bucket`](<#test_get_stake_bucket>) to test the stake bucket functionality.
    - Executes [`test_push_active_set`](<#test_push_active_set>) to test the active set functionality.
    - Logs a notice message indicating the tests passed.
- **Output**: No return value; the function logs a message and exits.
- **Functions Called**:
    - [`test_get_stake_bucket`](<#test_get_stake_bucket>)
    - [`test_push_active_set`](<#test_push_active_set>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)