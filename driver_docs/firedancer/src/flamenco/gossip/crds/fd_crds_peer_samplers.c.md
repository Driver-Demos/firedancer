<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements stake-weighted peer samplers for CRDS tables with functions for managing sampler entries.

# Purpose
The code defines a system for managing and sampling peers based on their weights, which are derived from their stake and activity status. It is part of a larger system that interacts with a CRDS (Contact Replication and Dissemination Service) table. The primary components are the `wpeer_sampler` and `crds_samplers` structures. The `wpeer_sampler` structure maintains cumulative weights for peers and tracks whether each peer is enabled. The `crds_samplers` structure contains multiple `wpeer_sampler` instances, each representing different sampling strategies, and manages the association of peers with these samplers.

The code provides functions to initialize, update, enable, disable, and remove peers from the samplers. It ensures that the peer entries in the samplers are consistent with the CRDS contact info table. The `wpeer_sampler` functions handle the weight calculations and peer management, while the `crds_samplers` functions manage the overall collection of samplers and their interactions with the CRDS entries. The code is designed to maintain a tight coupling between the peer samplers and the CRDS table, ensuring that changes in the contact info table are reflected in the sampling logic.
# Imports and Dependencies

---
- `fd_crds.h`
- `../fd_active_set_private.h`
- `../../../util/tmpl/fd_set.c`


# Data Structures

---
### wpeer\_sampler
- **Type**: ``struct``
- **Members**:
    - ``cumul_weight``: Stores the cumulative weight for each peer, allowing individual peer weight calculation by subtracting the previous cumulative weight.
    - ``peer_enabled``: Indicates if a peer is enabled, affecting whether it is scored and its weight is considered.
- **Description**: Manages peer sampling with cumulative weights and enables or disables peers without removing them, ensuring consistency with the CRDS Contact Info table.


---
### wpeer\_sampler\_t
- **Type**: ``struct``
- **Members**:
    - ``cumul_weight``: An array that stores the cumulative weight for each peer.
    - ``peer_enabled``: An array that indicates if a peer is enabled or disabled.
- **Description**: Manages peer sampling with cumulative weights and enables or disables peers based on their status in the CRDS contact info table. The structure maintains an array of cumulative weights for peers, allowing for efficient sampling and weight updates. It also includes a mechanism to enable or disable peers without removing them, ensuring synchronization with the CRDS contact info table.


---
### crds\_samplers
- **Type**: ``struct``
- **Members**:
    - ``pr_sampler``: An array of one `wpeer_sampler_t` used for stake-weighted peer sampling.
    - ``bucket_samplers``: An array of 25 `wpeer_sampler_t` used for bucket-based peer sampling.
    - ``ele``: An array of pointers to `fd_crds_entry_t` representing elements in the CRDS contact info table.
    - ``ele_cnt``: An `ulong` representing the count of elements in the `ele` array.
- **Description**: Manages peer sampling for a CRDS table, using a primary sampler and multiple bucket samplers to track and update peer weights and statuses based on the CRDS contact info table.


---
### crds\_samplers\_t
- **Type**: ``struct``
- **Members**:
    - ``pr_sampler``: An array of one `wpeer_sampler_t` used for primary sampling.
    - ``bucket_samplers``: An array of 25 `wpeer_sampler_t` used for bucket sampling.
    - ``ele``: An array of pointers to `fd_crds_entry_t` representing the elements being sampled.
    - ``ele_cnt``: A count of the elements in the `ele` array.
- **Description**: Manages a collection of peer samplers, each with different weight scoring implementations, to track and update peer information in relation to the CRDS contact info table. It includes a primary sampler and multiple bucket samplers, each maintaining cumulative weights and enabled status for peers, allowing for efficient sampling and updates.


# Functions

---
### wpeer\_sampler\_init<!-- {{#callable:wpeer_sampler_init}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds_peer_samplers.c#L66>)

Initializes a `wpeer_sampler_t` structure by setting all cumulative weights to zero and enabling all peers.
- **Inputs**:
    - `ps`: A pointer to a `wpeer_sampler_t` structure that will be initialized.
- **Logic and Control Flow**:
    - Check if the input pointer `ps` is NULL; if so, return -1 to indicate an error.
    - Iterate over the `cumul_weight` array of the `wpeer_sampler_t` structure and set each element to zero.
    - Call the `peer_enabled_full` function to enable all peers in the `peer_enabled` array of the `wpeer_sampler_t` structure.
    - Return 0 to indicate successful initialization.
- **Output**: Returns 0 on successful initialization, or -1 if the input pointer `ps` is NULL.


---
### wpeer\_sampler\_sample<!-- {{#callable:wpeer_sampler_sample}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds_peer_samplers.c#L77>)

Selects a peer index based on a weighted random sampling from a cumulative weight array.
- **Inputs**:
    - ``ps``: A pointer to a `wpeer_sampler_t` structure containing the cumulative weights of peers.
    - ``rng``: A pointer to an `fd_rng_t` structure used for generating random numbers.
    - ``ele_cnt``: The number of elements in the cumulative weight array.
- **Logic and Control Flow**:
    - Check if `ele_cnt` is zero or if the last cumulative weight is zero; if so, return `SAMPLE_IDX_SENTINEL`.
    - Generate a random number using `fd_rng_ulong_roll` with the maximum value as the last cumulative weight.
    - Increment the random number by 1 to avoid sampling zero and ensure it does not exceed the last cumulative weight.
    - Perform a binary search on the cumulative weight array to find the smallest index where the cumulative weight is greater than or equal to the sampled value.
    - Return the index found by the binary search.
- **Output**: Returns the index of the selected peer based on the weighted random sampling, or `SAMPLE_IDX_SENTINEL` if sampling is not possible.


---
### wpeer\_sampler\_upd<!-- {{#callable:wpeer_sampler_upd}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds_peer_samplers.c#L103>)

Updates the cumulative weight of a peer in the sampler based on its new weight and index.
- **Inputs**:
    - ``ps``: A pointer to a `wpeer_sampler_t` structure representing the peer sampler.
    - ``weight``: The new weight to assign to the peer at the specified index.
    - ``idx``: The index of the peer in the sampler whose weight is to be updated.
    - ``ele_cnt``: The total number of elements in the sampler.
- **Logic and Control Flow**:
    - Check if the `ps` pointer is NULL; if so, return -1.
    - Multiply the `weight` by the result of `peer_enabled_test` to ensure disabled peers are not scored.
    - Calculate the `old_weight` of the peer at the specified index.
    - If the `old_weight` is equal to the new `weight`, return 0 as no update is needed.
    - If the new `weight` is greater than `old_weight`, increment the cumulative weights from `idx` to `ele_cnt` by the difference.
    - If the new `weight` is less than `old_weight`, decrement the cumulative weights from `idx` to `ele_cnt` by the difference.
    - Return 0 after updating the weights.
- **Output**: Returns 0 on successful update or -1 if the `ps` pointer is NULL.


---
### wpeer\_sampler\_disable<!-- {{#callable:wpeer_sampler_disable}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds_peer_samplers.c#L128>)

Disables a peer in the weighted peer sampler by setting its weight to zero and removing it from the enabled set.
- **Inputs**:
    - ``ps``: A pointer to a `wpeer_sampler_t` structure representing the peer sampler.
    - ``idx``: The index of the peer to disable within the sampler.
    - ``ele_cnt``: The total number of elements in the sampler.
- **Logic and Control Flow**:
    - Check if the `ps` pointer is NULL or if `idx` is greater than or equal to `ele_cnt`; if so, return -1.
    - Call [`wpeer_sampler_upd`](<#wpeer_sampler_upd>) to set the peer's weight to zero; if this call returns a negative value, return -1.
    - Call `peer_enabled_remove` to remove the peer from the enabled set.
    - Return 0 to indicate success.
- **Output**: Returns 0 on success, or -1 if the input parameters are invalid or if updating the peer's weight fails.
- **Functions Called**:
    - [`wpeer_sampler_upd`](<#wpeer_sampler_upd>)


---
### wpeer\_sampler\_enable<!-- {{#callable:wpeer_sampler_enable}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds_peer_samplers.c#L142>)

Enables a peer in the `peer_enabled` set of a `wpeer_sampler_t` structure if the peer index is valid.
- **Inputs**:
    - `ps`: A pointer to a `wpeer_sampler_t` structure, which contains the peer sampling data.
    - `idx`: An unsigned long integer representing the index of the peer to enable.
    - `ele_cnt`: An unsigned long integer representing the total number of elements in the peer sampling data.
- **Logic and Control Flow**:
    - Check if the `ps` pointer is NULL or if `idx` is greater than or equal to `ele_cnt`; if so, return -1 to indicate an error.
    - Call `peer_enabled_insert` to enable the peer at the specified `idx` in the `peer_enabled` set.
    - Return 0 to indicate success.
- **Output**: Returns 0 on success, or -1 if the input pointer is NULL or the index is out of bounds.


---
### wpeer\_sampler\_rem<!-- {{#callable:wpeer_sampler_rem}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds_peer_samplers.c#L153>)

Removes a peer from the sampler by adjusting cumulative weights and updating the enabled status of peers.
- **Inputs**:
    - ``ps``: A pointer to a `wpeer_sampler_t` structure representing the peer sampler.
    - ``idx``: The index of the peer to remove from the sampler.
    - ``ele_cnt``: The total number of elements in the sampler.
- **Logic and Control Flow**:
    - Calculate the score of the peer at index `idx` by subtracting the previous peer's weight from the current cumulative weight.
    - Iterate over the peers starting from `idx + 1` to `ele_cnt - 1`.
    - For each peer, subtract the calculated score from its cumulative weight and shift the cumulative weight to the previous index.
    - Update the enabled status of each peer by inserting or removing it from the `peer_enabled` set based on its current status.
    - Insert the last peer in the `peer_enabled` set to maintain consistency.
- **Output**: Returns 0 to indicate successful removal of the peer.


---
### wpeer\_sampler\_peer\_score<!-- {{#callable:wpeer_sampler_peer_score}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds_peer_samplers.c#L172>)

Calculates a score for a peer based on its activity status, stake, and last active time.
- **Inputs**:
    - ``peer``: A pointer to a `fd_crds_entry_t` structure representing the peer whose score is to be calculated.
    - ``now``: A long integer representing the current time in nanoseconds.
- **Logic and Control Flow**:
    - Check if the peer is active using `peer->contact_info.is_active`; if not, return a score of 0.
    - Initialize the score with a base weight defined by `BASE_WEIGHT`.
    - Add the peer's stake to the score.
    - Check if the peer's last active time (`peer->wallclock_nanos`) is more than 60 seconds ago compared to `now`; if so, divide the score by 100.
- **Output**: Returns an unsigned long integer representing the calculated score for the peer.


---
### wpeer\_sampler\_bucket\_score<!-- {{#callable:wpeer_sampler_bucket_score}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds_peer_samplers.c#L183>)

Calculates a score for a peer based on its stake bucket and a given bucket value.
- **Inputs**:
    - `peer`: A pointer to a `fd_crds_entry_t` structure representing the peer whose score is to be calculated.
    - `bucket`: An unsigned long integer representing the bucket value to be used in the score calculation.
- **Logic and Control Flow**:
    - Retrieve the peer's stake bucket using `fd_active_set_stake_bucket` with the peer's stake.
    - Calculate the minimum of the input `bucket` and the `peer_bucket`.
    - Add 1 to the result of the minimum calculation using `fd_ulong_sat_add`.
    - Square the result of the addition to compute the final score.
    - Return the squared score.
- **Output**: Returns an unsigned long integer representing the squared score of the peer based on the bucket values.


---
### crds\_samplers\_new<!-- {{#callable:crds_samplers_new}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds_peer_samplers.c#L194>)

Initializes a `crds_samplers_t` structure by setting up its samplers and resetting its elements.
- **Inputs**:
    - `ps`: A pointer to a `crds_samplers_t` structure that will be initialized.
- **Logic and Control Flow**:
    - Check if the input pointer `ps` is NULL; if so, return immediately.
    - Call [`wpeer_sampler_init`](<#wpeer_sampler_init>) to initialize the `pr_sampler` within the `crds_samplers_t` structure.
    - Iterate over the `bucket_samplers` array, calling [`wpeer_sampler_init`](<#wpeer_sampler_init>) for each of the 25 samplers.
    - Set `ele_cnt` to 0, indicating no elements are currently in the sampler.
    - Iterate over the `ele` array, setting each element to NULL to indicate they are uninitialized.
- **Output**: No output is returned as the function is of type `void`.
- **Functions Called**:
    - [`wpeer_sampler_init`](<#wpeer_sampler_init>)


---
### crds\_samplers\_upd\_peer\_at\_idx<!-- {{#callable:crds_samplers_upd_peer_at_idx}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds_peer_samplers.c#L208>)

Updates a peer's information and scores in the samplers at a specified index.
- **Inputs**:
    - `ps`: A pointer to a `crds_samplers_t` structure, which contains the samplers and peer elements.
    - `peer`: A pointer to a `fd_crds_entry_t` structure representing the peer to update.
    - `idx`: An unsigned long integer representing the index at which to update the peer.
    - `now`: A long integer representing the current time, used for scoring the peer.
- **Logic and Control Flow**:
    - Check if `idx` is greater than or equal to `ps->ele_cnt`; if true, log a warning and return -1.
    - Assign the `peer` to `ps->ele[idx]` and update `peer->contact_info.sampler_idx` to `idx`.
    - Calculate the peer's score using [`wpeer_sampler_peer_score`](<#wpeer_sampler_peer_score>) and update the primary sampler with [`wpeer_sampler_upd`](<#wpeer_sampler_upd>); return -1 if the update fails.
    - Iterate over 25 bucket samplers, calculate the bucket score using [`wpeer_sampler_bucket_score`](<#wpeer_sampler_bucket_score>), and update each bucket sampler with [`wpeer_sampler_upd`](<#wpeer_sampler_upd>); log an error if the bucket score is zero and return -1 if any update fails.
    - Return 0 to indicate success.
- **Output**: Returns 0 on success, or -1 if an error occurs during the update process.
- **Functions Called**:
    - [`wpeer_sampler_peer_score`](<#wpeer_sampler_peer_score>)
    - [`wpeer_sampler_upd`](<#wpeer_sampler_upd>)
    - [`wpeer_sampler_bucket_score`](<#wpeer_sampler_bucket_score>)


---
### crds\_samplers\_swap\_peer\_at\_idx<!-- {{#callable:crds_samplers_swap_peer_at_idx}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds_peer_samplers.c#L231>)

Swaps a peer at a specified index in the samplers with a new peer.
- **Inputs**:
    - `ps`: A pointer to a `crds_samplers_t` structure, which contains the samplers and their associated data.
    - `new_peer`: A pointer to a `fd_crds_entry_t` structure representing the new peer to be inserted at the specified index.
    - `idx`: An unsigned long integer representing the index at which the peer swap will occur.
- **Logic and Control Flow**:
    - Check if `idx` is greater than or equal to `ps->ele_cnt`; if true, log a warning and return -1.
    - Retrieve the old peer at the specified index `idx` from `ps->ele`.
    - Check if `old_peer` is NULL; if true, log an error.
    - Replace the old peer at `ps->ele[idx]` with `new_peer`.
    - Set `new_peer->contact_info.sampler_idx` to `idx`.
    - Set `old_peer->contact_info.sampler_idx` to `SAMPLE_IDX_SENTINEL`.
    - Return 0 to indicate success.
- **Output**: Returns 0 on success, or -1 if the index is invalid or if there is no peer at the specified index.


---
### crds\_samplers\_add\_peer<!-- {{#callable:crds_samplers_add_peer}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds_peer_samplers.c#L250>)

Adds a peer to the CRDS samplers and updates its information.
- **Inputs**:
    - `ps`: A pointer to a `crds_samplers_t` structure representing the CRDS samplers.
    - `peer`: A pointer to a `fd_crds_entry_t` structure representing the peer to add.
    - `now`: A long integer representing the current time in nanoseconds.
- **Logic and Control Flow**:
    - Calculate the index `idx` as the minimum of `ps->ele_cnt` and `CRDS_MAX_CONTACT_INFO - 1`.
    - Increment the `ele_cnt` field of `ps`.
    - Call [`crds_samplers_upd_peer_at_idx`](<#crds_samplers_upd_peer_at_idx>) to update the peer at the calculated index.
    - If [`crds_samplers_upd_peer_at_idx`](<#crds_samplers_upd_peer_at_idx>) returns a non-zero value, log a warning, decrement `ele_cnt`, set `ps->ele[idx]` to `NULL`, and return -1.
    - If successful, return 0.
- **Output**: Returns 0 on success, or -1 if updating the peer fails.
- **Functions Called**:
    - [`crds_samplers_upd_peer_at_idx`](<#crds_samplers_upd_peer_at_idx>)


---
### crds\_samplers\_rem\_peer<!-- {{#callable:crds_samplers_rem_peer}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds_peer_samplers.c#L265>)

Removes a peer from the CRDS samplers and updates the internal data structures accordingly.
- **Inputs**:
    - ``ps``: A pointer to a `crds_samplers_t` structure, which contains the samplers and peer information.
    - ``peer``: A pointer to a `fd_crds_entry_t` structure representing the peer to be removed.
- **Logic and Control Flow**:
    - Retrieve the index of the peer from `peer->contact_info.sampler_idx`.
    - Check if the index is valid by comparing it with `ps->ele_cnt`; return -1 if invalid.
    - Call [`wpeer_sampler_rem`](<#wpeer_sampler_rem>) to remove the peer from `ps->pr_sampler` and check for errors.
    - Iterate over `ps->bucket_samplers` to remove the peer from each sampler using [`wpeer_sampler_rem`](<#wpeer_sampler_rem>) and check for errors.
    - Shift elements in `ps->ele` array down to fill the gap left by the removed peer, updating their `sampler_idx` values.
    - Decrement `ps->ele_cnt` to reflect the removal of the peer.
    - Return 0 to indicate successful removal.
- **Output**: Returns 0 on successful removal of the peer, or -1 if an error occurs.
- **Functions Called**:
    - [`wpeer_sampler_rem`](<#wpeer_sampler_rem>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)