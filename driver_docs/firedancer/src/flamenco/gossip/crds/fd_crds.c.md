<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a CRDS (Conflict-free Replicated Data Store) for managing and updating gossip messages with structures for handling message expiration, eviction, and sampling.

# Purpose
The code defines a module for managing a CRDS (Conflict-free Replicated Data Store) system, which is used to handle messages received over a gossip protocol. The CRDS maintains a list of messages, known as CRDS values, which conform to a specific schema. The primary operation of the CRDS is to "upsert" messages, meaning it updates or inserts messages based on their originator's public key, ensuring only the most recent message of each type is stored. The code includes structures and functions to manage these messages, including their insertion, eviction, and expiration.

Key components of the code include the `fd_crds_entry_private` structure, which represents individual CRDS entries, and various data structures like hash tables, treaps, and doubly linked lists to efficiently manage and query these entries. The code also defines functions for creating and managing CRDS instances, handling message expiration, and updating metrics. Additionally, it includes mechanisms for handling purged messages and failed insertions, ensuring the CRDS can maintain its state and perform necessary operations efficiently. The module is designed to be integrated into a larger system, providing a structured way to manage and query gossip messages.
# Imports and Dependencies

---
- `fd_crds.h`
- `fd_crds_contact_info.c`
- `../fd_gossip_types.h`
- `../../../ballet/sha256/fd_sha256.h`
- `../../../funk/fd_funk_base.h`
- `string.h`
- `../../../util/tmpl/fd_pool.c`
- `../../../util/tmpl/fd_treap.c`
- `../../../util/tmpl/fd_dlist.c`
- `../../../util/tmpl/fd_map_chain.c`
- `fd_crds_peer_samplers.c`


# Data Structures

---
### fd\_crds\_key
- **Type**: ``struct``
- **Members**:
    - ``tag``: Stores a tag as an unsigned character to identify the type of CRDS key.
    - ``pubkey``: Holds a 32-byte public key as an array of unsigned characters.
    - ``vote_index``: Represents the index of a vote as an unsigned character within a union.
    - ``epoch_slots_index``: Represents the index of epoch slots as an unsigned character within a union.
    - ``duplicate_shred_index``: Represents the index of a duplicate shred as an unsigned short within a union.
- **Description**: The `fd_crds_key` structure is used to define a key for CRDS (Cluster Replicated Data Store) entries. It includes a `tag` to specify the type of key, a `pubkey` to store the public key associated with the CRDS entry, and a union to store different types of indices (`vote_index`, `epoch_slots_index`, or `duplicate_shred_index`) depending on the `tag`. This structure is essential for identifying and managing CRDS entries in a gossip-based distributed system.


---
### fd\_crds\_key\_t
- **Type**: ``struct``
- **Members**:
    - ``tag``: Stores a tag that identifies the type of CRDS key.
    - ``pubkey``: Holds a 32-byte public key associated with the CRDS key.
    - ``vote_index``: Stores the index of a vote when the tag is `FD_GOSSIP_VALUE_VOTE`.
    - ``epoch_slots_index``: Stores the index of epoch slots when the tag is `FD_GOSSIP_VALUE_EPOCH_SLOTS`.
    - ``duplicate_shred_index``: Stores the index of a duplicate shred when the tag is `FD_GOSSIP_VALUE_DUPLICATE_SHRED`.
- **Description**: The `fd_crds_key_t` structure represents a key used in the CRDS (Conflict-free Replicated Data Structures) system. It includes a `tag` to identify the type of key, a `pubkey` for the public key, and a union to store specific indices depending on the type of CRDS value, such as `vote_index`, `epoch_slots_index`, or `duplicate_shred_index`. This structure is used to uniquely identify and manage CRDS values in a gossip protocol.


---
### fd\_crds\_entry\_private
- **Type**: ``struct``
- **Members**:
    - ``key``: Key for the hash table, used to identify CRDS messages.
    - ``contact_info``: Contains contact information and related metadata for a CRDS entry.
    - ``node_instance``: Contains a token for node instance identification.
    - ``wallclock_nanos``: Local wallclock time in nanoseconds when the CRDS message was created.
    - ``value_bytes``: Byte array storing the value of the CRDS message.
    - ``value_sz``: Size of the value stored in `value_bytes`.
    - ``value_hash``: SHA-256 hash of the `value_bytes`, used for bloom filter generation and as a tiebreaker.
    - ``num_duplicates``: Count of duplicate messages.
    - ``stake``: Stake associated with the CRDS entry, used for priority and eviction.
    - ``pool``: Links to the next element in the pool.
    - ``lookup``: Links for the lookup map, enabling key-value mapping.
    - ``evict``: Links and priority for eviction treap, used to manage message capacity.
    - ``expire``: Links and wallclock time for expiration management.
    - ``hash``: Links and priority for hash-based treap, used for querying by hash.
- **Description**: Manages CRDS (Cluster Replicated Data Store) entries, which are messages received over gossip, keyed by the originator's public key. It supports operations like upsertion, eviction, and expiration of messages, using various data structures like hash tables, treaps, and linked lists to efficiently manage and query the messages. The structure includes fields for message metadata, such as creation time, value size, and hash, as well as mechanisms for handling duplicates and prioritizing messages based on stake.


---
### fd\_crds\_purged
- **Type**: ``struct``
- **Members**:
    - ``hash``: An array of 32 unsigned characters used to store a hash value.
    - ``pool``: Contains a single member `next` of type `ulong` for pool management.
    - ``treap``: Contains members for managing a treap structure: `parent`, `left`, `right`, `next`, `prev`, and `prio`, all of type `ulong`.
    - ``expire``: Contains `wallclock_nanos` of type `long` and `next` and `prev` of type `ulong` for managing expiration times.
- **Description**: The `fd_crds_purged` structure is used to manage purged CRDS entries, allowing for querying and iteration by hash. It includes a hash value, a pool for managing linked list nodes, a treap for organizing entries by priority, and an expiration list to track when entries should be removed based on wallclock time. The structure supports two mutually exclusive lists for purged entries and failed inserts, each with different expiration durations.


---
### fd\_crds\_purged\_t
- **Type**: ``struct``
- **Members**:
    - ``hash``: An array of 32 unsigned characters representing the hash value.
    - ``pool``: A structure containing a single `ulong` member `next` for pool management.
    - ``treap``: A structure for treap management with members for parent, left, right, next, prev, and priority.
    - ``expire``: A structure for managing expiration with a wallclock time in nanoseconds and pointers for next and previous elements.
- **Description**: `fd_crds_purged_t` is a data structure used to manage purged CRDS entries. It includes a hash for identifying entries, a pool for managing the allocation of entries, a treap for efficient querying and iteration by hash, and an expiration list to manage the lifecycle of entries based on insertion time. The structure supports two mutually exclusive lists for purged entries and failed inserts, each with different expiration times.


---
### fd\_crds\_private
- **Type**: ``struct``
- **Members**:
    - ``gossip_update``: Pointer to a `fd_gossip_out_ctx_t` structure for gossip updates.
    - ``sha256``: Array of one `fd_sha256_t` for SHA-256 hashing.
    - ``has_staked_node``: Integer indicating if there is a staked node.
    - ``pool``: Pointer to a `fd_crds_entry_t` pool for CRDS entries.
    - ``evict_treap``: Pointer to an `evict_treap_t` for eviction management.
    - ``staked_expire_dlist``: Pointer to a `staked_expire_dlist_t` for managing staked node expiration.
    - ``unstaked_expire_dlist``: Pointer to an `unstaked_expire_dlist_t` for managing unstaked node expiration.
    - ``hash_treap``: Pointer to a `hash_treap_t` for hash-based operations.
    - ``lookup_map``: Pointer to a `lookup_map_t` for key-value lookups.
    - ``purged``: Nested structure for managing purged CRDS entries.
    - ``contact_info``: Nested structure for managing contact information entries.
    - ``samplers``: Array of one `crds_samplers_t` for sampling operations.
    - ``metrics``: Array of one `fd_crds_metrics_t` for metrics tracking.
    - ``magic``: Unsigned long for magic number verification.
- **Description**: Manages the internal state and operations of a CRDS (Conflict-free Replicated Data Store) system, including gossip updates, entry pools, eviction and expiration management, hash operations, and contact information handling. It uses various data structures like treaps and doubly linked lists to efficiently manage and query CRDS entries, while also tracking metrics and supporting sampling operations.


---
### fd\_crds\_mask\_iter\_private
- **Type**: ``struct``
- **Members**:
    - ``idx``: Stores the current index for iteration.
    - ``end_hash``: Stores the hash value at which iteration should stop.
- **Description**: Facilitates iteration over a collection of CRDS entries, using `idx` to track the current position and `end_hash` to determine when to stop.


# Functions

---
### lookup\_hash<!-- {{#callable:lookup_hash}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L221>)

Computes a hash value for a given CRDS key and seed, using different indices based on the key's tag.
- **Inputs**:
    - `key`: A pointer to a `fd_crds_key_t` structure, which contains a tag, a public key, and an index specific to the tag.
    - `seed`: An unsigned long integer used as a seed in the hash computation.
- **Logic and Control Flow**:
    - Initialize `hash_fn` by shifting the `tag` of `key` 16 bits to the left.
    - Use a switch statement to modify `hash_fn` based on the `tag` of `key`.
    - If `tag` is `FD_GOSSIP_VALUE_VOTE`, XOR `hash_fn` with `key->vote_index`.
    - If `tag` is `FD_GOSSIP_VALUE_EPOCH_SLOTS`, XOR `hash_fn` with `key->epoch_slots_index`.
    - If `tag` is `FD_GOSSIP_VALUE_DUPLICATE_SHRED`, XOR `hash_fn` with `key->duplicate_shred_index`.
    - Return the result of `fd_funk_rec_key_hash1` using `key->pubkey`, `hash_fn`, and `seed`.
- **Output**: Returns an unsigned long integer representing the computed hash value.


---
### lookup\_eq<!-- {{#callable:lookup_eq}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L241>)

Compares two `fd_crds_key_t` keys for equality based on their `tag`, `pubkey`, and specific index fields.
- **Inputs**:
    - `key0`: A pointer to the first `fd_crds_key_t` structure to compare.
    - `key1`: A pointer to the second `fd_crds_key_t` structure to compare.
- **Logic and Control Flow**:
    - Check if the `tag` fields of `key0` and `key1` are different; if so, return 0 (not equal).
    - Compare the `pubkey` fields of `key0` and `key1` using `memcmp`; if they differ, return 0 (not equal).
    - Use a `switch` statement on `key0->tag` to determine which index field to compare: `vote_index`, `epoch_slots_index`, or `duplicate_shred_index`.
    - Return 1 (equal) if the relevant index fields are equal; otherwise, return 0 (not equal).
- **Output**: Returns 1 if the keys are equal, otherwise returns 0.


---
### fd\_crds\_align<!-- {{#callable:fd_crds_align}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L376>)

Returns the constant `FD_CRDS_ALIGN`.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the value of `FD_CRDS_ALIGN`.
- **Output**: The function returns an unsigned long integer representing the alignment constant `FD_CRDS_ALIGN`.


---
### fd\_crds\_footprint<!-- {{#callable:fd_crds_footprint}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L381>)

Calculates the memory footprint required for a CRDS structure based on the maximum number of elements and purged elements.
- **Inputs**:
    - `ele_max`: The maximum number of elements that the CRDS can hold.
    - `purged_max`: The maximum number of purged elements that the CRDS can hold.
- **Logic and Control Flow**:
    - Initialize the layout with `FD_LAYOUT_INIT`.
    - Append the size of `fd_crds_t` to the layout with alignment `FD_CRDS_ALIGN`.
    - Append the footprint of the CRDS pool with alignment from `crds_pool_align()` and size from `crds_pool_footprint(ele_max)`.
    - Append the footprint of the eviction treap with alignment from `evict_treap_align()` and size from `evict_treap_footprint(ele_max)`.
    - Append the footprint of the staked expire doubly linked list with alignment from `staked_expire_dlist_align()` and size from `staked_expire_dlist_footprint()`.
    - Append the footprint of the unstaked expire doubly linked list with alignment from `unstaked_expire_dlist_align()` and size from `unstaked_expire_dlist_footprint()`.
    - Append the footprint of the hash treap with alignment from `hash_treap_align()` and size from `hash_treap_footprint(ele_max)`.
    - Append the footprint of the lookup map with alignment from `lookup_map_align()` and size from `lookup_map_footprint(ele_max)`.
    - Append the footprint of the purged pool with alignment from `purged_pool_align()` and size from `purged_pool_footprint(purged_max)`.
    - Append the footprint of the purged treap with alignment from `purged_treap_align()` and size from `purged_treap_footprint(purged_max)`.
    - Append the footprint of the purged doubly linked list with alignment from `purged_dlist_align()` and size from `purged_dlist_footprint()`.
    - Append the footprint of the failed inserts doubly linked list with alignment from `failed_inserts_dlist_align()` and size from `failed_inserts_dlist_footprint()`.
    - Append the footprint of the CRDS contact info pool with alignment from `crds_contact_info_pool_align()` and size from `crds_contact_info_pool_footprint(CRDS_MAX_CONTACT_INFO)`.
    - Append the footprint of the CRDS contact info fresh list with alignment from `crds_contact_info_fresh_list_align()` and size from `crds_contact_info_fresh_list_footprint()`.
    - Append the footprint of the CRDS contact info evict list with alignment from `crds_contact_info_evict_dlist_align()` and size from `crds_contact_info_evict_dlist_footprint()`.
    - Finalize the layout with `FD_LAYOUT_FINI` using alignment `FD_CRDS_ALIGN`.
- **Output**: Returns the total memory footprint in bytes as an unsigned long integer.


---
### fd\_crds\_new<!-- {{#callable:fd_crds_new}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L403>)

Initializes a new CRDS (Conflict-free Replicated Data Store) structure in shared memory with specified parameters and returns a pointer to it.
- **Inputs**:
    - `shmem`: A pointer to the shared memory where the CRDS structure will be initialized.
    - `rng`: A pointer to a random number generator used for seeding various components of the CRDS.
    - `ele_max`: The maximum number of elements the CRDS can hold, which must be a power of 2.
    - `purged_max`: The maximum number of purged elements the CRDS can hold, which must be a power of 2.
    - `gossip_update_out`: A pointer to a gossip update context used for CRDS updates.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL or misaligned, returning NULL if true.
    - Check if `ele_max` and `purged_max` are powers of 2, returning NULL if not.
    - Check if `rng` and `gossip_update_out` are NULL, returning NULL if true.
    - Initialize scratch memory allocation with `shmem`.
    - Allocate and align memory for various CRDS components such as pools, treaps, and lists.
    - Join and initialize each component, seeding them with random values where necessary.
    - Set the `gossip_update` pointer and initialize other CRDS fields.
    - Set the `magic` field to indicate successful initialization.
    - Return a pointer to the initialized `fd_crds_t` structure.
- **Output**: A pointer to the initialized `fd_crds_t` structure, or NULL if initialization fails.
- **Functions Called**:
    - [`fd_crds_align`](<#fd_crds_align>)
    - [`fd_crds_footprint`](<#fd_crds_footprint>)
    - [`crds_samplers_new`](<fd_crds_peer_samplers.c.md#crds_samplers_new>)


---
### fd\_crds\_join<!-- {{#callable:fd_crds_join}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L514>)

Validates and returns a pointer to a `fd_crds_t` structure if the input `shcrds` is non-null, properly aligned, and has a valid magic number.
- **Inputs**:
    - `shcrds`: A pointer to a shared memory region that is expected to contain a `fd_crds_t` structure.
- **Logic and Control Flow**:
    - Check if `shcrds` is NULL; if so, log a warning and return NULL.
    - Check if `shcrds` is aligned according to [`fd_crds_align`](<#fd_crds_align>); if not, log a warning and return NULL.
    - Cast `shcrds` to a `fd_crds_t` pointer and store it in `crds`.
    - Check if `crds->magic` matches `FD_CRDS_MAGIC`; if not, log a warning and return NULL.
    - Return the `crds` pointer.
- **Output**: A pointer to a `fd_crds_t` structure if all checks pass, otherwise NULL.
- **Functions Called**:
    - [`fd_crds_align`](<#fd_crds_align>)


---
### fd\_crds\_metrics<!-- {{#callable:fd_crds_metrics}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L536>)

Returns the `metrics` field from a given `fd_crds_t` structure.
- **Inputs**:
    - `crds`: A pointer to a constant `fd_crds_t` structure from which the `metrics` field is retrieved.
- **Logic and Control Flow**:
    - Access the `metrics` field of the `crds` structure.
    - Return the `metrics` field.
- **Output**: A constant pointer to an `fd_crds_metrics_t` structure, which is the `metrics` field of the input `crds`.


---
### remove\_contact\_info<!-- {{#callable:remove_contact_info}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L541>)

Removes a contact information entry from the CRDS and updates related metrics and structures.
- **Inputs**:
    - ``crds``: A pointer to the `fd_crds_t` structure representing the CRDS table.
    - ``ci``: A pointer to the `fd_crds_entry_t` structure representing the contact information entry to remove.
    - ``now``: A long integer representing the current wallclock time in nanoseconds.
    - ``stem``: A pointer to the `fd_stem_context_t` structure used for publishing gossip updates.
- **Logic and Control Flow**:
    - Check if `stem` is NULL; if so, return immediately.
    - Retrieve a gossip update message chunk and set its tag to `FD_GOSSIP_UPDATE_TAG_CONTACT_INFO_REMOVE`.
    - Set the message's wallclock time to `now` and copy the public key from `ci` to the message.
    - Determine the index of the contact info to remove and publish the gossip update message.
    - Update the CRDS metrics by decrementing the staked or unstaked peer count and reducing the visible stake by the entry's stake.
    - If the contact info is in the fresh list, remove it from the list.
    - Remove the contact info from the eviction list and release the pool element.
    - Remove the peer from any samplers.
- **Output**: No return value; the function operates by side effects on the input structures.
- **Functions Called**:
    - [`crds_samplers_rem_peer`](<fd_crds_peer_samplers.c.md#crds_samplers_rem_peer>)


---
### fd\_crds\_len<!-- {{#callable:fd_crds_len}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L573>)

Returns the number of used entries in the CRDS pool.
- **Inputs**:
    - ``crds``: A pointer to a constant `fd_crds_t` structure representing the CRDS instance.
- **Logic and Control Flow**:
    - Calls the function `crds_pool_used` with the `pool` member of the `crds` structure.
    - Returns the result of `crds_pool_used`.
- **Output**: An unsigned long integer representing the number of used entries in the CRDS pool.


---
### fd\_crds\_purged\_len<!-- {{#callable:fd_crds_purged_len}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L578>)

Returns the number of used entries in the purged pool of a CRDS structure.
- **Inputs**:
    - `crds`: A pointer to a constant `fd_crds_t` structure, representing the CRDS instance to query.
- **Logic and Control Flow**:
    - Calls the `purged_pool_used` function with the `purged.pool` member of the `crds` structure.
    - Returns the result of the `purged_pool_used` function call.
- **Output**: An unsigned long integer representing the number of used entries in the purged pool.


---
### fd\_crds\_release<!-- {{#callable:fd_crds_release}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L583>)

Releases a CRDS entry from the pool and decrements the count of entries for the specific tag in the metrics.
- **Inputs**:
    - ``crds``: A pointer to the `fd_crds_t` structure representing the CRDS system.
    - ``value``: A pointer to the `fd_crds_entry_t` structure representing the CRDS entry to be released.
- **Logic and Control Flow**:
    - Calls `crds_pool_ele_release` to release the `value` entry back to the pool associated with `crds`.
    - Decrements the count of entries for the tag specified in `value->key.tag` in the `crds->metrics->count` array.
- **Output**: No return value (void function).


---
### expire<!-- {{#callable:expire}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L590>)

Removes expired entries from various lists in the CRDS structure based on the current time.
- **Inputs**:
    - ``crds``: A pointer to the `fd_crds_t` structure, which contains the CRDS data and associated lists.
    - ``now``: The current time in nanoseconds, used to determine expiration.
    - ``stem``: A pointer to the `fd_stem_context_t` structure, used for context in certain operations like removing contact info.
- **Logic and Control Flow**:
    - Define constants for slot duration and expiration durations for staked and unstaked nodes.
    - Iterate over the `staked_expire_dlist` to remove entries that have expired based on `STAKED_EXPIRE_DURATION_NANOS`.
    - For each expired entry, remove it from various data structures (`hash_treap`, `lookup_map`, `evict_treap`) and update metrics.
    - If the entry is of type `FD_GOSSIP_VALUE_CONTACT_INFO`, call [`remove_contact_info`](<#remove_contact_info>).
    - Repeat similar steps for `unstaked_expire_dlist` using `unstaked_expire_duration_nanos` calculated based on whether there is a staked node.
    - Iterate over `purged_dlist` and `failed_inserts_dlist` to remove expired entries based on their respective expiration durations (60 seconds and 20 seconds).
    - Update metrics for purged entries as they are removed.
- **Output**: No return value; the function modifies the `crds` structure in place.
- **Functions Called**:
    - [`remove_contact_info`](<#remove_contact_info>)
    - [`fd_crds_release`](<#fd_crds_release>)


---
### unfresh<!-- {{#callable:unfresh}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L661>)

Removes expired entries from the 'fresh' contact info list in the CRDS structure.
- **Inputs**:
    - ``crds``: A pointer to the `fd_crds_t` structure, which contains the CRDS data and associated lists.
    - ``now``: A long integer representing the current time in nanoseconds.
- **Logic and Control Flow**:
    - While the 'fresh' contact info list is not empty, check the head entry's expiration time.
    - If the head entry's expiration time is greater than `now` minus 60 seconds, exit the loop.
    - Otherwise, remove the head entry from the 'fresh' list and update its status to not in the list.
    - Update the peer's sampler index with the current time.
- **Output**: No return value; the function modifies the CRDS structure in place.
- **Functions Called**:
    - [`crds_samplers_upd_peer_at_idx`](<fd_crds_peer_samplers.c.md#crds_samplers_upd_peer_at_idx>)


---
### fd\_crds\_advance<!-- {{#callable:fd_crds_advance}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L675>)

Advances the state of the CRDS by expiring outdated entries and updating the freshness of contact information.
- **Inputs**:
    - ``crds``: A pointer to the `fd_crds_t` structure representing the CRDS state.
    - ``now``: The current time in nanoseconds, used to determine expiration and freshness.
    - ``stem``: A pointer to the `fd_stem_context_t` structure, used for context in operations like removing contact information.
- **Logic and Control Flow**:
    - Calls the [`expire`](<#expire>) function to remove expired entries from the CRDS based on the current time `now` and updates metrics accordingly.
    - Calls the [`unfresh`](<#unfresh>) function to update the freshness status of contact information entries, removing them from the fresh list if they exceed the freshness threshold.
- **Output**: No return value; the function modifies the CRDS state in place.
- **Functions Called**:
    - [`expire`](<#expire>)
    - [`unfresh`](<#unfresh>)


---
### fd\_crds\_acquire<!-- {{#callable:fd_crds_acquire}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L683>)

Acquires a CRDS entry from the pool, evicting an entry if necessary.
- **Inputs**:
    - ``crds``: A pointer to the `fd_crds_t` structure, representing the CRDS system.
    - ``now``: A long integer representing the current time in nanoseconds.
    - ``stem``: A pointer to the `fd_stem_context_t` structure, used for context in the CRDS system.
- **Logic and Control Flow**:
    - Check if the CRDS pool has free entries using `crds_pool_free`.
    - If the pool is not free, initialize an eviction iterator `head` using `evict_treap_fwd_iter_init`.
    - Ensure the iterator is not done using `evict_treap_fwd_iter_done`.
    - Retrieve the entry to evict using `evict_treap_fwd_iter_ele`.
    - Remove the entry from the appropriate expire list based on its stake using `unstaked_expire_dlist_ele_remove` or `staked_expire_dlist_ele_remove`.
    - Remove the entry from the hash treap, lookup map, and eviction treap using `hash_treap_ele_remove`, `lookup_map_ele_remove`, and `evict_treap_ele_remove`.
    - If the entry's key tag is `FD_GOSSIP_VALUE_CONTACT_INFO`, call [`remove_contact_info`](<#remove_contact_info>).
    - Increment the evicted count in the CRDS metrics.
    - Return the evicted entry.
    - If the pool is free, acquire a new entry using `crds_pool_ele_acquire` and return it.
- **Output**: A pointer to the acquired or evicted `fd_crds_entry_t`.
- **Functions Called**:
    - [`remove_contact_info`](<#remove_contact_info>)


---
### fd\_crds\_has\_staked\_node<!-- {{#callable:fd_crds_has_staked_node}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L708>)

Returns the value of the `has_staked_node` field from the `fd_crds_t` structure.
- **Inputs**:
    - `crds`: A pointer to a constant `fd_crds_t` structure, which contains the `has_staked_node` field.
- **Logic and Control Flow**:
    - Access the `has_staked_node` field of the `crds` structure.
    - Return the value of the `has_staked_node` field.
- **Output**: An integer representing whether there is a staked node (`1` if true, `0` if false).


---
### generate\_key<!-- {{#callable:generate_key}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L713>)

Generates a CRDS key based on the provided view and payload.
- **Inputs**:
    - `view`: A pointer to a `fd_gossip_view_crds_value_t` structure containing the CRDS value view information.
    - `payload`: A pointer to an unsigned character array containing the payload data.
    - `out_key`: A pointer to a `fd_crds_key_t` structure where the generated key will be stored.
- **Logic and Control Flow**:
    - Set the `tag` of `out_key` to the `tag` from `view`.
    - Copy 32 bytes from `payload` starting at the offset `view->pubkey_off` to `out_key->pubkey`.
    - Use a switch statement on `out_key->tag` to determine which index to set in `out_key`.
    - If `out_key->tag` is `FD_GOSSIP_VALUE_VOTE`, set `out_key->vote_index` to `view->vote->index`.
    - If `out_key->tag` is `FD_GOSSIP_VALUE_EPOCH_SLOTS`, set `out_key->epoch_slots_index` to `view->epoch_slots->index`.
    - If `out_key->tag` is `FD_GOSSIP_VALUE_DUPLICATE_SHRED`, set `out_key->duplicate_shred_index` to `view->duplicate_shred->index`.
    - If `out_key->tag` does not match any case, do nothing.
- **Output**: The function does not return a value; it modifies the `out_key` structure in place.


---
### fd\_crds\_generate\_hash<!-- {{#callable:fd_crds_generate_hash}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L735>)

Generates a SHA-256 hash for a given CRDS value.
- **Inputs**:
    - `sha`: A pointer to an `fd_sha256_t` structure used for SHA-256 hashing operations.
    - `crds_value`: A pointer to the CRDS value data to hash.
    - `crds_value_sz`: The size of the CRDS value data in bytes.
    - `out_hash`: An array of 32 bytes where the resulting hash will be stored.
- **Logic and Control Flow**:
    - Initialize the SHA-256 context using `fd_sha256_init` with the provided `sha` pointer.
    - Append the CRDS value data to the SHA-256 context using `fd_sha256_append`, passing `crds_value` and `crds_value_sz`.
    - Finalize the SHA-256 hash computation and store the result in `out_hash` using `fd_sha256_fini`.
- **Output**: The function does not return a value; it outputs the hash directly into the `out_hash` array.


---
### crds\_entry\_init<!-- {{#callable:crds_entry_init}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L745>)

Initializes a `fd_crds_entry_t` structure with a key, wallclock time, stake, and hash based on the provided view and payload.
- **Inputs**:
    - `view`: A pointer to a `fd_gossip_view_crds_value_t` structure containing the CRDS value view information.
    - `sha`: A pointer to a `fd_sha256_t` structure used for generating the hash.
    - `payload`: A pointer to an unsigned character array containing the payload data.
    - `stake`: An unsigned long integer representing the stake value.
    - `out_value`: A pointer to a `fd_crds_entry_t` structure where the initialized entry will be stored.
- **Logic and Control Flow**:
    - Generate a key for the `out_value` using the `view` and `payload` by calling [`generate_key`](<#generate_key>) function.
    - Set the `wallclock_nanos` and `stake` fields of `out_value` from the `view` and `stake` parameters respectively.
    - Generate a hash for the `out_value` using the [`fd_crds_generate_hash`](<#fd_crds_generate_hash>) function with `sha`, `payload`, and `view` parameters.
    - Store the first 8 bytes of the generated hash in `out_value->hash.hash`.
    - If the `view->tag` is `FD_GOSSIP_VALUE_NODE_INSTANCE`, set the `node_instance.token` in `out_value` from `view->node_instance->token`.
    - If the `key->tag` is `FD_GOSSIP_VALUE_CONTACT_INFO`, set the `contact_info.instance_creation_wallclock_nanos` and `contact_info.sampler_idx` in `out_value` from `view->ci_view->contact_info->instance_creation_wallclock_nanos` and `SAMPLE_IDX_SENTINEL` respectively.
- **Output**: The function does not return a value; it initializes the `out_value` structure with the provided data.
- **Functions Called**:
    - [`generate_key`](<#generate_key>)
    - [`fd_crds_generate_hash`](<#fd_crds_generate_hash>)


---
### purged\_init<!-- {{#callable:purged_init}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L770>)

Initializes a `fd_crds_purged_t` structure with a given hash and expiration time.
- **Inputs**:
    - ``purged``: A pointer to a `fd_crds_purged_t` structure to initialize.
    - ``hash``: A constant pointer to an array of unsigned characters representing the hash to be copied into the `purged` structure.
    - ``now``: A long integer representing the current wallclock time in nanoseconds to set as the expiration time.
- **Logic and Control Flow**:
    - Copies the 32-byte hash from the `hash` input into the `hash` field of the `purged` structure.
    - Sets the `expire.wallclock_nanos` field of the `purged` structure to the value of `now`.
- **Output**: No return value; the function modifies the `purged` structure in place.


---
### insert\_purged<!-- {{#callable:insert_purged}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L778>)

Inserts a purged entry into the CRDS purged data structures if it does not already exist.
- **Inputs**:
    - ``crds``: A pointer to the `fd_crds_t` structure, which contains the CRDS data and associated structures.
    - ``hash``: A pointer to a constant unsigned character array representing the hash of the entry to be inserted.
    - ``now``: A long integer representing the current time in nanoseconds.
- **Logic and Control Flow**:
    - Checks if the hash already exists in the `purged_treap` using `purged_treap_ele_query`; if it exists, the function returns immediately.
    - If the `purged_pool` has no free elements, it pops the head of the `purged_dlist`, removes it from the `purged_treap`, and increments the `purged_evicted_cnt` metric if metrics are enabled.
    - If the `purged_pool` has free elements, it acquires a new element from the pool and increments the `purged_cnt` metric if metrics are enabled.
    - Initializes the purged entry with the given hash and current time using [`purged_init`](<#purged_init>).
    - Inserts the purged entry into the `purged_treap` and pushes it to the tail of the `purged_dlist`.
- **Output**: No return value; the function modifies the CRDS purged data structures in place.
- **Functions Called**:
    - [`purged_init`](<#purged_init>)


---
### overrides\_fast<!-- {{#callable:overrides_fast}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L807>)

Determines if a candidate CRDS value should override an existing incumbent value based on specific criteria.
- **Inputs**:
    - `incumbent`: A pointer to the existing CRDS entry that the candidate is compared against.
    - `candidate`: A pointer to the candidate CRDS value that is being evaluated for overriding the incumbent.
    - `payload`: A pointer to the payload data associated with the candidate CRDS value.
- **Logic and Control Flow**:
    - Extracts wallclock times and instance creation times from both the incumbent and candidate.
    - Checks the candidate's tag to determine the type of CRDS value (e.g., contact info or node instance).
    - For `FD_GOSSIP_VALUE_CONTACT_INFO`, compares instance creation times and wallclock times to decide if the candidate overrides the incumbent.
    - For `FD_GOSSIP_VALUE_NODE_INSTANCE`, checks if the tokens match or if the public keys differ, then compares wallclock times and tokens to decide if the candidate overrides the incumbent.
    - If none of the specific cases apply, compares wallclock times as a final check.
    - Returns 1 if the candidate should override, 0 if it should not, and -1 if further checks are needed.
- **Output**: Returns an integer: 1 if the candidate overrides the incumbent, 0 if it does not, and -1 if further checks are needed.


---
### fd\_crds\_insert\_failed\_insert<!-- {{#callable:fd_crds_insert_failed_insert}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L840>)

Handles the insertion of a failed CRDS entry into the purged data structures.
- **Inputs**:
    - ``crds``: A pointer to the `fd_crds_t` structure, which contains the CRDS data and associated structures.
    - ``hash``: A pointer to a constant unsigned character array representing the hash of the CRDS entry to be inserted.
    - ``now``: A long integer representing the current time in nanoseconds.
- **Logic and Control Flow**:
    - Checks if the hash already exists in the `purged.treap` using `purged_treap_ele_query`; if it does, the function returns immediately.
    - If the `purged.pool` has no free elements, it pops the head of the `failed_inserts_dlist` and removes it from the `purged.treap`.
    - If `crds->metrics` is not NULL, increments the `purged_evicted_cnt` metric when an element is evicted.
    - If there are free elements in the `purged.pool`, acquires a new element from the pool and increments the `purged_cnt` metric if `crds->metrics` is not NULL.
    - Initializes the `failed` element with the given `hash` and `now` using [`purged_init`](<#purged_init>).
    - Inserts the `failed` element into the `purged.treap` and pushes it to the tail of the `failed_inserts_dlist`.
- **Output**: No return value; the function modifies the CRDS structure in place.
- **Functions Called**:
    - [`purged_init`](<#purged_init>)


---
### fd\_crds\_checks\_fast<!-- {{#callable:fd_crds_checks_fast}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L865>)

Checks if a candidate CRDS value should upsert, duplicate, or fail against an incumbent value in the CRDS table.
- **Inputs**:
    - ``crds``: A pointer to the `fd_crds_t` structure representing the CRDS table.
    - ``candidate``: A constant pointer to the `fd_gossip_view_crds_value_t` structure representing the candidate CRDS value to check.
    - ``payload``: A constant pointer to an array of unsigned characters representing the payload data associated with the candidate.
    - ``from_push_msg``: An unsigned character indicating if the candidate is from a push message (non-zero) or not (zero).
- **Logic and Control Flow**:
    - Generate a key for the candidate using [`generate_key`](<#generate_key>) and look up the incumbent entry in the CRDS table using `lookup_map_ele_query`.
    - If no incumbent is found, return `FD_CRDS_UPSERT_CHECK_UPSERTS` to indicate an upsert is needed.
    - If the incumbent's value matches the candidate's value, increment the incumbent's duplicate count and return it.
    - Call [`overrides_fast`](<#overrides_fast>) to determine if the candidate overrides the incumbent; if it does, return `FD_CRDS_UPSERT_CHECK_UPSERTS`.
    - Generate a hash for the candidate's value using [`fd_crds_generate_hash`](<#fd_crds_generate_hash>).
    - If [`overrides_fast`](<#overrides_fast>) returns -1, compare the candidate's hash with the incumbent's hash to determine if an upsert is needed.
    - If the candidate's hash is greater, return `FD_CRDS_UPSERT_CHECK_UPSERTS`; otherwise, handle the candidate as a failed insert or purged entry based on `from_push_msg`.
    - Return `FD_CRDS_UPSERT_CHECK_FAILS` if the candidate does not override the incumbent.
- **Output**: An integer indicating the result of the check: upsert, duplicate count, or fail.
- **Functions Called**:
    - [`generate_key`](<#generate_key>)
    - [`overrides_fast`](<#overrides_fast>)
    - [`fd_crds_generate_hash`](<#fd_crds_generate_hash>)
    - [`insert_purged`](<#insert_purged>)
    - [`fd_crds_insert_failed_insert`](<#fd_crds_insert_failed_insert>)


---
### publish\_update\_msg<!-- {{#callable:publish_update_msg}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L905>)

Publishes a gossip update message based on the type of CRDS entry and its associated data.
- **Inputs**:
    - ``crds``: A pointer to the `fd_crds_t` structure, which contains the gossip update context.
    - ``entry``: A pointer to the `fd_crds_entry_t` structure, representing the CRDS entry to be processed.
    - ``entry_view``: A constant pointer to the `fd_gossip_view_crds_value_t` structure, providing a view of the CRDS entry data.
    - ``payload``: A constant pointer to an unsigned character array containing additional data for the message.
    - ``now``: A long integer representing the current time in nanoseconds.
    - ``stem``: A pointer to the `fd_stem_context_t` structure, used for publishing the message.
- **Logic and Control Flow**:
    - Check if `stem` is NULL; if so, return immediately.
    - Verify if the `entry`'s tag is one of the specified types (`FD_GOSSIP_VALUE_CONTACT_INFO`, `FD_GOSSIP_VALUE_LOWEST_SLOT`, `FD_GOSSIP_VALUE_VOTE`, `FD_GOSSIP_VALUE_DUPLICATE_SHRED`, `FD_GOSSIP_VALUE_INC_SNAPSHOT_HASHES`); if not, return immediately.
    - Retrieve a chunk from the gossip update context using `fd_gossip_out_get_chunk`.
    - Set the `wallclock_nanos` field of the message to `now`.
    - Copy the `origin_pubkey` from the `entry` to the message.
    - Determine the message tag and size based on the `entry`'s tag, and populate the message fields accordingly.
    - For `FD_GOSSIP_VALUE_CONTACT_INFO`, copy contact info and set the index.
    - For `FD_GOSSIP_VALUE_LOWEST_SLOT`, set the lowest slot value.
    - For `FD_GOSSIP_VALUE_VOTE`, set the vote tower index and transaction size, and copy the transaction data.
    - For `FD_GOSSIP_VALUE_DUPLICATE_SHRED`, set the duplicate shred fields and copy the chunk data.
    - For `FD_GOSSIP_VALUE_INC_SNAPSHOT_HASHES`, set the snapshot hashes fields and copy the hash data.
    - Publish the message using `fd_gossip_tx_publish_chunk` with the determined tag and size.
- **Output**: No output is returned as the function is `void`.


---
### fd\_crds\_insert<!-- {{#callable:fd_crds_insert}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L985>)

Inserts or updates a CRDS entry with a candidate view, handling potential replacements and updating metrics.
- **Inputs**:
    - ``crds``: A pointer to the CRDS structure where the entry will be inserted or updated.
    - ``candidate_view``: A pointer to the candidate view structure containing the CRDS value to be inserted.
    - ``payload``: A pointer to the payload data associated with the candidate view.
    - ``origin_stake``: The stake value associated with the origin of the candidate view.
    - ``is_from_me``: A flag indicating if the candidate view is from the local node.
    - ``now``: The current wallclock time in nanoseconds.
    - ``stem``: A pointer to the stem context used for publishing update messages.
- **Logic and Control Flow**:
    - Acquire a new CRDS entry from the pool using [`fd_crds_acquire`](<#fd_crds_acquire>).
    - Initialize the candidate entry with [`crds_entry_init`](<#crds_entry_init>) using the candidate view, payload, and origin stake.
    - Increment the metric count for the candidate's key tag.
    - Check if an incumbent entry exists in the lookup map for the candidate's key.
    - If an incumbent exists, mark it for purging and update metrics, then remove it from various data structures.
    - If the candidate is a contact info and the pool is full, evict the oldest entry and update metrics.
    - Set the candidate's duplicate count, expiration time, and value size, then copy the payload data.
    - Update the `has_staked_node` flag based on the candidate's stake.
    - Insert the candidate into various data structures like treaps and lists based on its stake.
    - If the candidate is a contact info, copy contact info data, set it as active, and update lists and samplers.
    - Publish an update message using [`publish_update_msg`](<#publish_update_msg>).
- **Output**: Returns a pointer to the inserted or updated CRDS entry.
- **Functions Called**:
    - [`fd_crds_acquire`](<#fd_crds_acquire>)
    - [`crds_entry_init`](<#crds_entry_init>)
    - [`insert_purged`](<#insert_purged>)
    - [`crds_samplers_upd_peer_at_idx`](<fd_crds_peer_samplers.c.md#crds_samplers_upd_peer_at_idx>)
    - [`crds_samplers_swap_peer_at_idx`](<fd_crds_peer_samplers.c.md#crds_samplers_swap_peer_at_idx>)
    - [`fd_crds_release`](<#fd_crds_release>)
    - [`remove_contact_info`](<#remove_contact_info>)
    - [`crds_samplers_add_peer`](<fd_crds_peer_samplers.c.md#crds_samplers_add_peer>)
    - [`publish_update_msg`](<#publish_update_msg>)


---
### fd\_crds\_entry\_value<!-- {{#callable:fd_crds_entry_value}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L1100>)

Retrieves the value bytes and size from a CRDS entry.
- **Inputs**:
    - `entry`: A pointer to a constant `fd_crds_entry_t` structure from which the value bytes and size are retrieved.
    - `value_bytes`: A pointer to a pointer to `uchar` where the function will store the address of the value bytes from the entry.
    - `value_sz`: A pointer to `ulong` where the function will store the size of the value bytes from the entry.
- **Logic and Control Flow**:
    - Assigns the `value_bytes` field of the `entry` to the location pointed to by `value_bytes`.
    - Assigns the `value_sz` field of the `entry` to the location pointed to by `value_sz`.
- **Output**: No return value; the function modifies the data pointed to by `value_bytes` and `value_sz`.


---
### fd\_crds\_entry\_hash<!-- {{#callable:fd_crds_entry_hash}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L1108>)

Returns the SHA-256 hash of the value stored in a CRDS entry.
- **Inputs**:
    - `entry`: A pointer to a constant `fd_crds_entry_t` structure, representing a CRDS entry.
- **Logic and Control Flow**:
    - Access the `value_hash` field of the `entry` structure.
    - Return the `value_hash` field.
- **Output**: A pointer to an unsigned character array representing the SHA-256 hash of the entry's value.


---
### make\_contact\_info\_key<!-- {{#callable:make_contact_info_key}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L1113>)

Creates a contact info key by setting the tag and copying the public key into the output key structure.
- **Inputs**:
    - ``pubkey``: A pointer to a 32-byte array representing the public key.
    - ``key_out``: A pointer to an `fd_crds_key_t` structure where the function will store the generated contact info key.
- **Logic and Control Flow**:
    - Set the `tag` field of `key_out` to `FD_GOSSIP_VALUE_CONTACT_INFO`.
    - Copy 32 bytes from `pubkey` to the `pubkey` field of `key_out`.
- **Output**: No return value; the function modifies the `key_out` structure in place.


---
### fd\_crds\_entry\_is\_contact\_info<!-- {{#callable:fd_crds_entry_is_contact_info}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L1120>)

Checks if the `key.tag` of a given `fd_crds_entry_t` is equal to `FD_GOSSIP_VALUE_CONTACT_INFO`.
- **Inputs**:
    - `entry`: A pointer to a constant `fd_crds_entry_t` structure, representing an entry in the CRDS table.
- **Logic and Control Flow**:
    - Access the `key.tag` field of the `entry` structure.
    - Compare the `key.tag` field with the constant `FD_GOSSIP_VALUE_CONTACT_INFO`.
    - Return 1 if they are equal, otherwise return 0.
- **Output**: Returns an integer: 1 if the `key.tag` is `FD_GOSSIP_VALUE_CONTACT_INFO`, otherwise 0.


---
### fd\_crds\_entry\_contact\_info<!-- {{#callable:fd_crds_entry_contact_info}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L1125>)

Returns the contact information from a given CRDS entry.
- **Inputs**:
    - ``entry``: A pointer to a constant `fd_crds_entry_t` structure, representing the CRDS entry from which to retrieve the contact information.
- **Logic and Control Flow**:
    - Accesses the `contact_info` field of the `entry` structure.
    - Returns the `contact_info` field from the `ci` pointer within the `contact_info` structure.
- **Output**: A pointer to an `fd_contact_info_t` structure containing the contact information.


---
### fd\_crds\_contact\_info\_lookup<!-- {{#callable:fd_crds_contact_info_lookup}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L1131>)

Looks up contact information for a given public key in the CRDS structure.
- **Inputs**:
    - ``crds``: A pointer to a constant `fd_crds_t` structure, representing the CRDS from which to look up contact information.
    - ``pubkey``: A pointer to a constant unsigned character array representing the public key to look up.
- **Logic and Control Flow**:
    - Create a `fd_crds_key_t` key using the `pubkey` by calling [`make_contact_info_key`](<#make_contact_info_key>).
    - Query the `lookup_map` in the `crds` structure using the generated key to find the corresponding `fd_crds_entry_t` entry.
    - Check if the `peer_ci` (peer contact info) is NULL; if so, return NULL.
    - If `peer_ci` is not NULL, return the contact information from the `peer_ci` entry.
- **Output**: Returns a pointer to a constant `fd_contact_info_t` structure if the contact information is found, otherwise returns NULL.
- **Functions Called**:
    - [`make_contact_info_key`](<#make_contact_info_key>)


---
### fd\_crds\_peer\_count<!-- {{#callable:fd_crds_peer_count}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L1145>)

Returns the number of used entries in the contact information pool of a CRDS structure.
- **Inputs**:
    - `crds`: A pointer to a constant `fd_crds_t` structure, which contains the contact information pool to be queried.
- **Logic and Control Flow**:
    - Calls the function `crds_contact_info_pool_used` with the contact information pool from the `crds` structure.
    - Returns the result of the `crds_contact_info_pool_used` function call.
- **Output**: An unsigned long integer representing the number of used entries in the contact information pool.


---
### set\_peer\_active\_status<!-- {{#callable:set_peer_active_status}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L1150>)

Updates the active status of a peer in the CRDS and triggers a sampler update if the status changes.
- **Inputs**:
    - ``crds``: A pointer to the `fd_crds_t` structure representing the CRDS.
    - ``peer_pubkey``: A constant pointer to an array of unsigned characters representing the public key of the peer.
    - ``status``: An unsigned character representing the new active status of the peer.
    - ``now``: A long integer representing the current time in nanoseconds.
- **Logic and Control Flow**:
    - Create a `fd_crds_key_t` key using the `peer_pubkey` by calling [`make_contact_info_key`](<#make_contact_info_key>).
    - Query the `lookup_map` in the `crds` to find the `fd_crds_entry_t` for the peer using the generated key.
    - If the peer entry is not found, return immediately.
    - Retrieve the current active status of the peer from `peer_ci->contact_info.is_active`.
    - Update the peer's active status to the new `status`.
    - If the old status is different from the new status, call [`crds_samplers_upd_peer_at_idx`](<fd_crds_peer_samplers.c.md#crds_samplers_upd_peer_at_idx>) to update the sampler with the new status.
- **Output**: None (void function).
- **Functions Called**:
    - [`make_contact_info_key`](<#make_contact_info_key>)
    - [`crds_samplers_upd_peer_at_idx`](<fd_crds_peer_samplers.c.md#crds_samplers_upd_peer_at_idx>)


---
### fd\_crds\_peer\_active<!-- {{#callable:fd_crds_peer_active}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L1173>)

Sets the active status of a peer in the CRDS to active.
- **Inputs**:
    - ``crds``: A pointer to the `fd_crds_t` structure representing the CRDS.
    - ``peer_pubkey``: A constant pointer to an unsigned character array representing the public key of the peer.
    - ``now``: A long integer representing the current time in nanoseconds.
- **Logic and Control Flow**:
    - Calls the [`set_peer_active_status`](<#set_peer_active_status>) function with the `crds`, `peer_pubkey`, a status of `1` (indicating active), and `now`.
- **Output**: No return value (void function).
- **Functions Called**:
    - [`set_peer_active_status`](<#set_peer_active_status>)


---
### fd\_crds\_peer\_inactive<!-- {{#callable:fd_crds_peer_inactive}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L1180>)

Sets a peer's active status to inactive in the CRDS system.
- **Inputs**:
    - ``crds``: A pointer to the `fd_crds_t` structure representing the CRDS system.
    - ``peer_pubkey``: A constant pointer to an unsigned character array representing the public key of the peer.
    - ``now``: A long integer representing the current time in nanoseconds.
- **Logic and Control Flow**:
    - Calls the [`set_peer_active_status`](<#set_peer_active_status>) function with the `crds`, `peer_pubkey`, `0` (indicating inactive), and `now` as arguments.
- **Output**: No return value (void function).
- **Functions Called**:
    - [`set_peer_active_status`](<#set_peer_active_status>)


---
### fd\_crds\_peer\_sample<!-- {{#callable:fd_crds_peer_sample}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L1187>)

Samples a peer from the CRDS using a weighted peer sampler and returns its contact information.
- **Inputs**:
    - ``crds``: A pointer to a constant `fd_crds_t` structure, representing the CRDS from which to sample a peer.
    - ``rng``: A pointer to an `fd_rng_t` structure, used for random number generation in the sampling process.
- **Logic and Control Flow**:
    - Call [`wpeer_sampler_sample`](<fd_crds_peer_samplers.c.md#wpeer_sampler_sample>) with the CRDS's peer sampler, the random number generator, and the element count to get an index.
    - Check if the returned index is equal to `SAMPLE_IDX_SENTINEL`, indicating no valid sample; if so, return `NULL`.
    - Otherwise, return the contact information of the peer at the sampled index using [`fd_crds_entry_contact_info`](<#fd_crds_entry_contact_info>).
- **Output**: A pointer to a constant `fd_contact_info_t` structure containing the contact information of the sampled peer, or `NULL` if no valid peer is sampled.
- **Functions Called**:
    - [`wpeer_sampler_sample`](<fd_crds_peer_samplers.c.md#wpeer_sampler_sample>)
    - [`fd_crds_entry_contact_info`](<#fd_crds_entry_contact_info>)


---
### fd\_crds\_bucket\_sample\_and\_remove<!-- {{#callable:fd_crds_bucket_sample_and_remove}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L1197>)

Samples and removes a peer from a specified bucket in the CRDS samplers.
- **Inputs**:
    - ``crds``: A pointer to the `fd_crds_t` structure, which contains the CRDS data and samplers.
    - ``rng``: A pointer to the `fd_rng_t` structure, used for random number generation.
    - ``bucket``: An unsigned long integer representing the index of the bucket from which to sample and remove a peer.
- **Logic and Control Flow**:
    - Call [`wpeer_sampler_sample`](<fd_crds_peer_samplers.c.md#wpeer_sampler_sample>) to sample an index from the specified bucket's sampler using the provided random number generator and element count.
    - Check if the sampled index is equal to `SAMPLE_IDX_SENTINEL`, indicating no valid sample, and return `NULL` if true.
    - Call [`wpeer_sampler_disable`](<fd_crds_peer_samplers.c.md#wpeer_sampler_disable>) to disable the sampled peer in the bucket's sampler to prevent future sampling until re-added.
    - Return the contact information of the sampled peer using [`fd_crds_entry_contact_info`](<#fd_crds_entry_contact_info>).
- **Output**: Returns a pointer to the `fd_contact_info_t` structure of the sampled peer, or `NULL` if no valid peer is sampled.
- **Functions Called**:
    - [`wpeer_sampler_sample`](<fd_crds_peer_samplers.c.md#wpeer_sampler_sample>)
    - [`wpeer_sampler_disable`](<fd_crds_peer_samplers.c.md#wpeer_sampler_disable>)
    - [`fd_crds_entry_contact_info`](<#fd_crds_entry_contact_info>)


---
### fd\_crds\_bucket\_add<!-- {{#callable:fd_crds_bucket_add}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L1214>)

Adds a peer's contact information back to a specified bucket sampler in the CRDS system.
- **Inputs**:
    - ``crds``: A pointer to the `fd_crds_t` structure, representing the CRDS system.
    - ``bucket``: An unsigned long integer representing the index of the bucket to which the peer should be added.
    - ``pubkey``: A constant pointer to an unsigned character array representing the public key of the peer.
- **Logic and Control Flow**:
    - Generate a contact info key from the given `pubkey` using [`make_contact_info_key`](<#make_contact_info_key>) function.
    - Query the `lookup_map` in the `crds` structure to find the `fd_crds_entry_t` associated with the generated key.
    - If the peer's contact info is not found, log a debug message and return.
    - Retrieve the `bucket_sampler` for the specified `bucket` from the `crds` samplers.
    - Enable the peer in the `bucket_sampler` using [`wpeer_sampler_enable`](<fd_crds_peer_samplers.c.md#wpeer_sampler_enable>) with the peer's sampler index and the total element count.
    - Calculate the peer's score for the bucket using [`wpeer_sampler_bucket_score`](<fd_crds_peer_samplers.c.md#wpeer_sampler_bucket_score>).
    - Update the `bucket_sampler` with the new score using [`wpeer_sampler_upd`](<fd_crds_peer_samplers.c.md#wpeer_sampler_upd>).
- **Output**: None (void function).
- **Functions Called**:
    - [`make_contact_info_key`](<#make_contact_info_key>)
    - [`wpeer_sampler_enable`](<fd_crds_peer_samplers.c.md#wpeer_sampler_enable>)
    - [`wpeer_sampler_bucket_score`](<fd_crds_peer_samplers.c.md#wpeer_sampler_bucket_score>)
    - [`wpeer_sampler_upd`](<fd_crds_peer_samplers.c.md#wpeer_sampler_upd>)


---
### fd\_crds\_mask\_iter\_init<!-- {{#callable:fd_crds_mask_iter_init}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L1242>)

Initializes a CRDS mask iterator to iterate over entries in a hash treap that match a given mask and mask bits.
- **Inputs**:
    - ``crds``: A pointer to a constant `fd_crds_t` structure representing the CRDS data.
    - ``mask``: An unsigned long integer representing the mask to apply to the hash values.
    - ``mask_bits``: An unsigned integer specifying the number of bits in the mask.
    - ``iter_mem``: A static array of 16 unsigned characters to store the iterator state.
- **Logic and Control Flow**:
    - Cast `iter_mem` to a pointer of type `fd_crds_mask_iter_t` and assign it to `it`.
    - Initialize `start_hash` to 0.
    - If `mask_bits` is greater than 0, calculate `start_hash` by applying the mask to the least significant bits of the hash.
    - Set `it->end_hash` to `mask`.
    - Set `it->idx` to the index of the first entry in the hash treap that is greater than or equal to `start_hash`.
    - Return the iterator `it`.
- **Output**: Returns a pointer to the initialized `fd_crds_mask_iter_t` iterator.


---
### fd\_crds\_mask\_iter\_next<!-- {{#callable:fd_crds_mask_iter_next}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L1257>)

Advances the iterator to the next element in the CRDS hash treap.
- **Inputs**:
    - ``it``: A pointer to an `fd_crds_mask_iter_t` structure representing the current iterator state.
    - ``crds``: A pointer to a constant `fd_crds_t` structure representing the CRDS data structure.
- **Logic and Control Flow**:
    - Retrieve the current element from the hash treap using `it->idx` and `crds->pool`.
    - Update `it->idx` to the `next` index of the current element in the hash treap.
- **Output**: Returns the updated iterator `it`.


---
### fd\_crds\_mask\_iter\_done<!-- {{#callable:fd_crds_mask_iter_done}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L1264>)

Checks if the current iterator position in a CRDS mask iteration is done by comparing the iterator index and hash values.
- **Inputs**:
    - ``it``: A pointer to an `fd_crds_mask_iter_t` structure representing the current state of the CRDS mask iterator.
    - ``crds``: A pointer to a constant `fd_crds_t` structure representing the CRDS data structure being iterated over.
- **Logic and Control Flow**:
    - Retrieve the CRDS entry at the current iterator index using `hash_treap_ele_fast_const` function.
    - Check if the iterator index is null using `hash_treap_idx_is_null`.
    - Compare the `end_hash` of the iterator with the hash of the current CRDS entry.
    - Return true if the iterator index is null or if `end_hash` is less than the current entry's hash, indicating the iteration is done.
- **Output**: Returns an integer indicating whether the iteration is complete (non-zero) or not (zero).


---
### fd\_crds\_mask\_iter\_entry<!-- {{#callable:fd_crds_mask_iter_entry}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L1271>)

Retrieves a constant pointer to a CRDS entry from a hash treap using an iterator index.
- **Inputs**:
    - `it`: A pointer to an `fd_crds_mask_iter_t` structure, which contains the current index in the hash treap.
    - `crds`: A constant pointer to an `fd_crds_t` structure, which contains the hash treap and other CRDS data.
- **Logic and Control Flow**:
    - Call `hash_treap_ele_fast_const` with the current index from `it` and the pool from `crds` to retrieve the CRDS entry.
- **Output**: A constant pointer to an `fd_crds_entry_t` structure, representing the CRDS entry at the current iterator index.


---
### fd\_crds\_purged\_mask\_iter\_init<!-- {{#callable:fd_crds_purged_mask_iter_init}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L1276>)

Initializes an iterator for traversing purged CRDS entries that match a given hash mask.
- **Inputs**:
    - ``crds``: A pointer to a constant `fd_crds_t` structure representing the CRDS data.
    - ``mask``: An unsigned long integer representing the hash mask to filter purged entries.
    - ``mask_bits``: An unsigned integer specifying the number of significant bits in the mask.
    - ``iter_mem``: A static array of 16 unsigned characters used to store the iterator state.
- **Logic and Control Flow**:
    - Cast `iter_mem` to a pointer of type `fd_crds_mask_iter_t` and assign it to `it`.
    - Initialize `start_hash` to 0.
    - If `mask_bits` is greater than 0, calculate `start_hash` by applying the mask to the most significant bits of `mask`.
    - Set `it->end_hash` to `mask`.
    - Set `it->idx` to the index of the first purged entry in the treap that is greater than or equal to `start_hash`.
    - Return the iterator `it`.
- **Output**: Returns a pointer to the initialized `fd_crds_mask_iter_t` iterator.


---
### fd\_crds\_purged\_mask\_iter\_next<!-- {{#callable:fd_crds_purged_mask_iter_next}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L1290>)

Advances the iterator to the next element in the purged mask treap and returns the updated iterator.
- **Inputs**:
    - ``it``: A pointer to an `fd_crds_mask_iter_t` structure representing the current state of the iterator.
    - ``crds``: A constant pointer to an `fd_crds_t` structure containing the purged mask treap.
- **Logic and Control Flow**:
    - Retrieve the current element from the purged mask treap using `it->idx` and `crds->purged.pool`.
    - Update `it->idx` to the `next` index of the current element in the treap.
- **Output**: Returns the updated iterator `it`.


---
### fd\_crds\_purged\_mask\_iter\_done<!-- {{#callable:fd_crds_purged_mask_iter_done}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L1298>)

Checks if the current index in a purged mask iterator has reached the end or if the hash value is less than a specified end hash.
- **Inputs**:
    - ``it``: A pointer to an `fd_crds_mask_iter_t` structure representing the current state of the purged mask iterator.
    - ``crds``: A pointer to a constant `fd_crds_t` structure representing the CRDS data structure containing the purged entries.
- **Logic and Control Flow**:
    - Retrieve the purged entry at the current index of the iterator using `purged_treap_ele_fast_const` function.
    - Check if the current index is null using `purged_treap_idx_is_null`.
    - Compare the `end_hash` of the iterator with the hash value of the current purged entry using `fd_ulong_load_8`.
    - Return true if the index is null or if the `end_hash` is less than the hash value of the current purged entry.
- **Output**: Returns an integer indicating whether the iteration is done (non-zero) or not (zero).


---
### fd\_crds\_purged\_mask\_iter\_hash<!-- {{#callable:fd_crds_purged_mask_iter_hash}} -->
[View Source →](<../../../../../../src/flamenco/gossip/crds/fd_crds.c#L1308>)

Returns the hash of the current entry in the purged mask iterator.
- **Inputs**:
    - ``it``: A pointer to an `fd_crds_mask_iter_t` structure representing the current state of the purged mask iterator.
    - ``crds``: A pointer to a constant `fd_crds_t` structure representing the CRDS data structure containing the purged entries.
- **Logic and Control Flow**:
    - Retrieve the purged entry corresponding to the current index in the iterator using `purged_treap_ele_fast_const`.
    - Return the `hash` field of the retrieved purged entry.
- **Output**: A constant pointer to an unsigned character array representing the hash of the current purged entry.



---
Made with ❤️ by [Driver](https://www.driver.ai/)