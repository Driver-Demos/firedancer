<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Manages peer metadata for ping tracking to prevent DDoS attacks in a gossip network.

# Purpose
The code defines a C header file for a module that manages a ping tracking system within a gossip network. The primary purpose of this module is to prevent potential Distributed Denial of Service (DDoS) attacks by ensuring that data is only sent to peers that have responded to a ping request. This is achieved by maintaining metadata about peers, including which peers have been pinged and which have responded. The module includes functionality to track peers, register pong responses, and determine when a ping request should be sent. It also provides metrics to monitor the status of the ping tracking process.

Key components of the module include the `fd_ping_tracker_t` structure, which represents the ping tracker, and the `fd_ping_tracker_metrics_t` structure, which holds various metrics related to the tracking process. The module defines several functions, such as [`fd_ping_tracker_new`](<#fd_ping_tracker_new>), [`fd_ping_tracker_track`](<#fd_ping_tracker_track>), [`fd_ping_tracker_register`](<#fd_ping_tracker_register>), and [`fd_ping_tracker_pop_request`](<#fd_ping_tracker_pop_request>), which manage the lifecycle and operations of the ping tracker. The module also defines constants and types related to the alignment, magic number, and change types for the ping tracker. This header file is intended to be included in other C source files that require the functionality of the ping tracking system.
# Imports and Dependencies

---
- `../../util/rng/fd_rng.h`
- `../../util/net/fd_net_headers.h`


# Data Structures

---
### fd\_ping\_tracker\_t
- **Type**: ``fd_ping_tracker_t``
- **Members**:
    - ``fd_ping_tracker_private``: An opaque structure used internally to manage ping tracking details.
- **Description**: `fd_ping_tracker_t` is a typedef for a structure that manages metadata about peers in a gossip network, specifically tracking which peers have been pinged and have responded. This data structure helps prevent DDoS attacks by ensuring that data is only sent to peers that have responded to a ping request. It maintains information about peers eligible for pinging, tracks responses, and manages the state of peers to determine if they should be pinged again. The structure is opaque, meaning its internal details are hidden from the user, and it is manipulated through a set of functions provided in the API.


---
### fd\_ping\_tracker\_metrics
- **Type**: ``struct``
- **Members**:
    - ``unpinged_cnt``: Counts peers that have not been pinged.
    - ``invalid_cnt``: Counts peers with invalid responses.
    - ``valid_cnt``: Counts peers with valid responses.
    - ``refreshing_cnt``: Counts peers currently being refreshed.
    - ``peers_evicted``: Counts peers that have been evicted.
    - ``tracked_cnt``: Counts peers currently being tracked.
    - ``stake_changed_cnt``: Counts peers whose stake has changed.
    - ``address_changed_cnt``: Counts peers whose address has changed.
    - ``pong_result``: Stores results of pong responses in an array of size 6.
- **Description**: Tracks various metrics related to the pinging and validation of peers in a gossip network, including counts of unpinged, invalid, valid, and refreshing peers, as well as changes in stake and address, and results of pong responses.


---
### fd\_ping\_tracker\_metrics\_t
- **Type**: ``struct``
- **Members**:
    - ``unpinged_cnt``: Counts the number of peers that have not been pinged.
    - ``invalid_cnt``: Counts the number of peers that are considered invalid.
    - ``valid_cnt``: Counts the number of peers that are considered valid.
    - ``refreshing_cnt``: Counts the number of peers that are in the process of being refreshed.
    - ``peers_evicted``: Counts the number of peers that have been evicted from tracking.
    - ``tracked_cnt``: Counts the total number of peers being tracked.
    - ``stake_changed_cnt``: Counts the number of peers whose stake has changed.
    - ``address_changed_cnt``: Counts the number of peers whose address has changed.
    - ``pong_result``: Stores results of pong responses in an array of size 6.
- **Description**: The `fd_ping_tracker_metrics_t` structure holds various counters and metrics related to the tracking of peers in a gossip network. It includes counts for unpinged, invalid, valid, and refreshing peers, as well as the number of peers evicted, tracked, and those with changed stake or address. Additionally, it maintains an array to store pong response results.


# Function Declarations (Public API)

---
### fd\_ping\_tracker\_align<!-- {{#callable_declaration:fd_ping_tracker_align}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_ping_tracker.h#L70>)

Returns the alignment requirement for a ping tracker.
- **Description**: Use this function to obtain the alignment requirement for a ping tracker. This is necessary when allocating memory for a ping tracker to ensure proper alignment. The function does not require any parameters and can be called at any time to retrieve the alignment value.
- **Inputs**: None
- **Output**: Returns an unsigned long integer representing the alignment requirement for a ping tracker.
- **See Also**: [`fd_ping_tracker_align`](<fd_ping_tracker.c.md#fd_ping_tracker_align>)  (Implementation)


---
### fd\_ping\_tracker\_footprint<!-- {{#callable_declaration:fd_ping_tracker_footprint}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_ping_tracker.h#L75>)

Calculates the memory footprint required for a ping tracker.
- **Description**: Use this function to determine the amount of memory needed to store a ping tracker, which manages metadata about peers in a network. This is useful for allocating sufficient memory before initializing a ping tracker. Ensure that the `entrypoints_len` parameter accurately reflects the number of entry points you plan to track, as this affects the calculated footprint.
- **Inputs**:
    - `entrypoints_len`: Specifies the number of entry points to track. Must be a non-negative integer. The function uses this value to calculate the memory footprint, and invalid values may lead to incorrect memory allocation.
- **Output**: Returns the calculated memory footprint in bytes as an unsigned long integer.
- **See Also**: [`fd_ping_tracker_footprint`](<fd_ping_tracker.c.md#fd_ping_tracker_footprint>)  (Implementation)


---
### fd\_ping\_tracker\_new<!-- {{#callable_declaration:fd_ping_tracker_new}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_ping_tracker.h#L78>)

Creates a new ping tracker instance.
- **Description**: Use this function to create and initialize a new ping tracker instance, which manages metadata about peers in a gossip network. This function must be called with valid shared memory and random number generator pointers. It sets up the necessary data structures to track peers, their ping status, and responses. Ensure that the shared memory is properly aligned and that the entrypoints array is correctly sized and populated. The function also requires a callback function to handle changes in peer status, along with a context for this callback. If any input is invalid, the function returns NULL.
- **Inputs**:
    - `shmem`: Pointer to shared memory for the ping tracker. Must not be null and must be aligned according to `fd_ping_tracker_align()`.
    - `rng`: Pointer to a random number generator. Must not be null.
    - `entrypoints_len`: Number of entrypoints in the `entrypoints` array. Must be a valid size.
    - `entrypoints`: Array of entrypoints to initialize the ping tracker. Must not be null and must have at least `entrypoints_len` elements.
    - `change_fn`: Callback function to handle changes in peer status. Can be null if no callback is needed.
    - `change_fn_ctx`: Context for the `change_fn` callback. Can be null if no context is needed.
- **Output**: Returns a pointer to the newly created ping tracker instance, or NULL if an error occurs.
- **See Also**: [`fd_ping_tracker_new`](<fd_ping_tracker.c.md#fd_ping_tracker_new>)  (Implementation)


---
### fd\_ping\_tracker\_join<!-- {{#callable_declaration:fd_ping_tracker_join}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_ping_tracker.h#L86>)

Joins a shared memory region as a ping tracker.
- **Description**: Use this function to join a shared memory region that contains a ping tracker. This function checks if the provided pointer is valid, aligned, and points to a correctly initialized ping tracker. It returns a pointer to the ping tracker if successful. Ensure that the shared memory pointer is not null, is properly aligned, and has been initialized with the correct magic number before calling this function.
- **Inputs**:
    - `shpt`: A pointer to the shared memory region to join. Must not be null, must be aligned according to `fd_ping_tracker_align()`, and must point to a region initialized with the correct magic number. If these conditions are not met, the function returns null.
- **Output**: Returns a pointer to the `fd_ping_tracker_t` if successful, or null if the input is invalid.
- **See Also**: [`fd_ping_tracker_join`](<fd_ping_tracker.c.md#fd_ping_tracker_join>)  (Implementation)


---
### fd\_ping\_tracker\_track<!-- {{#callable_declaration:fd_ping_tracker_track}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_ping_tracker.h#L99>)

Marks a peer for ping tracking.
- **Description**: Use this function to start tracking a peer for pinging purposes when a valid gossip contact info message is received from the peer. It updates the tracker's internal state to reflect the peer's current status, including stake and address changes. This function is idempotent, meaning it can be called multiple times for the same peer without adverse effects. It is important to call this function whenever a peer sends a new message to ensure the tracker has the most up-to-date information.
- **Inputs**:
    - `ping_tracker`: A pointer to an `fd_ping_tracker_t` structure. Must not be null. The caller retains ownership.
    - `peer_pubkey`: A pointer to a 32-byte array representing the peer's public key. Must not be null. The caller retains ownership.
    - `peer_stake`: An unsigned long representing the peer's stake. Values less than 1,000,000,000 are considered low stake.
    - `peer_address`: An `fd_ip4_port_t` structure representing the peer's IP address and port. The caller retains ownership.
    - `now`: A long integer representing the current time in nanoseconds. Used to update the tracker's timing information.
- **Output**: None
- **See Also**: [`fd_ping_tracker_track`](<fd_ping_tracker.c.md#fd_ping_tracker_track>)  (Implementation)


---
### fd\_ping\_tracker\_register<!-- {{#callable_declaration:fd_ping_tracker_register}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_ping_tracker.h#L112>)

Registers a pong response from a peer to validate them.
- **Description**: Use this function to register a pong response from a peer, which allows the peer to be considered valid. This function should be called whenever a peer sends a pong that appears valid. The function will verify the pong against the expected token and update the peer's status accordingly. It is important to ensure that the peer's stake is below a certain threshold and that the peer is not an entry point before calling this function. The function updates internal metrics based on the validation result.
- **Inputs**:
    - `ping_tracker`: A pointer to an `fd_ping_tracker_t` structure. Must not be null. The caller retains ownership.
    - `peer_pubkey`: A pointer to the peer's public key. Must not be null. The caller retains ownership.
    - `peer_stake`: The stake of the peer. Must be less than 1,000,000,000 to proceed with registration.
    - `peer_address`: The IP address and port of the peer. Used to verify the peer's identity.
    - `pong_token`: A pointer to the pong token received from the peer. Must not be null. The function will validate this token.
    - `now`: The current time in nanoseconds. Used to update the peer's validity period.
- **Output**: None
- **See Also**: [`fd_ping_tracker_register`](<fd_ping_tracker.c.md#fd_ping_tracker_register>)  (Implementation)


---
### fd\_ping\_tracker\_pop\_request<!-- {{#callable_declaration:fd_ping_tracker_pop_request}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_ping_tracker.h#L134>)

Checks if a ping request should be sent to a peer.
- **Description**: Use this function to determine if a ping request needs to be sent to a peer. It updates the internal state of the tracker to assume the ping will be sent. Call this function when you need to manage ping requests for peers in a gossip network. Ensure that the `ping_tracker` is properly initialized before calling this function. The function returns information about the peer to ping if a request is needed. The returned peer information is only valid if the function indicates a ping is needed and should be used immediately. Subsequent calls to the tracker may invalidate this information.
- **Inputs**:
    - `ping_tracker`: A pointer to an `fd_ping_tracker_t` structure. Must not be null. Represents the ping tracker to query.
    - `now`: A `long` integer representing the current time in nanoseconds. Used to determine if a ping is needed.
    - `out_peer_pubkey`: A pointer to a `uchar const *` where the function will store the peer's public key if a ping is needed. Must not be null.
    - `out_peer_address`: A pointer to a `fd_ip4_port_t const *` where the function will store the peer's address if a ping is needed. Must not be null.
    - `out_token`: A pointer to a `uchar const *` where the function will store the ping token if a ping is needed. Must not be null.
- **Output**: Returns 1 if a ping request is needed and updates the output parameters with the peer's information. Returns 0 if no ping request is needed. The output parameters are only valid if the return value is 1.
- **See Also**: [`fd_ping_tracker_pop_request`](<fd_ping_tracker.c.md#fd_ping_tracker_pop_request>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)