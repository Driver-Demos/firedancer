<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a gossip protocol for node communication, including message handling, stake management, and network metrics.

# Purpose
The code is a C implementation of a gossip protocol module, which is part of a larger distributed system. The module is responsible for managing and disseminating information across a network of nodes using a gossip protocol. It includes functionalities for handling different types of gossip messages such as pull requests, pull responses, pushes, prunes, pings, and pongs. The module defines structures and functions to manage the state of the gossip protocol, including maintaining a list of active peers, tracking stakes, and managing cryptographic operations for message signing and verification.

Key components of the code include the `fd_gossip_t` structure, which encapsulates the state of the gossip protocol, and various functions for initializing, joining, and advancing the gossip state. The code also includes mechanisms for handling message transmission and reception, updating stakes, and managing active sets of peers. The module uses several external dependencies, such as cryptographic functions and data structures for managing peer information and message metrics. The code is designed to be integrated into a larger system, providing a public API for interacting with the gossip protocol and facilitating communication between distributed nodes.
# Imports and Dependencies

---
- `fd_gossip.h`
- `fd_bloom.h`
- `fd_gossip_private.h`
- `fd_gossip_txbuild.h`
- `fd_active_set.h`
- `fd_ping_tracker.h`
- `crds/fd_crds.h`
- `../../disco/keyguard/fd_keyguard.h`
- `../../ballet/sha256/fd_sha256.h`
- `math.h`
- `../../util/tmpl/fd_pool.c`
- `../../util/tmpl/fd_map_chain.c`
- `fd_push_set_private.c`


# Data Structures

---
### stake
- **Type**: ``struct``
- **Members**:
    - ``pubkey``: Holds the public key of the stake.
    - ``stake``: Stores the amount of stake as an unsigned long integer.
    - ``map.prev``: Stores the previous index in the map as an unsigned long integer.
    - ``map.next``: Stores the next index in the map as an unsigned long integer.
    - ``pool.next``: Stores the next index in the pool as an unsigned long integer.
- **Description**: Defines a data structure to represent a stake with a public key and a stake amount, along with mapping and pooling indices for managing linked data structures.


---
### stake\_t
- **Type**: ``struct``
- **Members**:
    - ``pubkey``: Holds the public key of the stake.
    - ``stake``: Stores the amount of stake as an unsigned long integer.
    - ``map.prev``: Stores the previous index in a mapping structure.
    - ``map.next``: Stores the next index in a mapping structure.
    - ``pool.next``: Stores the next index in a pool structure.
- **Description**: Defines a structure to represent a stake with a public key and a stake amount, along with mapping and pooling indices for managing linked data structures.


---
### fd\_gossip\_private
- **Type**: ``struct``
- **Members**:
    - ``identity_pubkey``: An array of 32 unsigned characters representing the public key of the identity.
    - ``identity_stake``: An unsigned long integer representing the stake associated with the identity.
    - ``metrics``: An array of `fd_gossip_metrics_t` structures for tracking gossip metrics.
    - ``crds``: A pointer to an `fd_crds_t` structure for managing CRDS (Conflict-free Replicated Data Structures).
    - ``active_set``: A pointer to an `fd_active_set_t` structure for managing the active set of peers.
    - ``ping_tracker``: A pointer to an `fd_ping_tracker_t` structure for tracking ping status.
    - ``sha256``: An array of `fd_sha256_t` structures for SHA-256 hashing.
    - ``sha512``: An array of `fd_sha512_t` structures for SHA-512 hashing.
    - ``entrypoints_cnt``: An unsigned long integer representing the count of entry points.
    - ``entrypoints``: An array of 16 `fd_ip4_port_t` structures representing entry points.
    - ``rng``: A pointer to an `fd_rng_t` structure for random number generation.
    - ``stake``: A nested structure containing a count, a pool of `stake_t`, and a map of `stake_map_t`.
    - ``timers``: A nested structure containing timers for various operations.
    - ``sign_fn``: A function pointer for signing operations.
    - ``sign_ctx``: A void pointer to the context for the sign function.
    - ``send_fn``: A function pointer for sending operations.
    - ``send_ctx``: A void pointer to the context for the send function.
    - ``ping_tracker_change_fn``: A function pointer for handling changes in the ping tracker.
    - ``ping_tracker_change_fn_ctx``: A void pointer to the context for the ping tracker change function.
    - ``my_contact_info``: A nested structure containing CRDS values, their size, and contact information.
    - ``active_pset``: A pointer to a `push_set_t` structure for managing push state for peers.
    - ``gossip_net_out``: A pointer to an `fd_gossip_out_ctx_t` structure for gossip network output.
- **Description**: The `fd_gossip_private` structure is a comprehensive data structure used in a gossip protocol implementation. It manages various components such as identity, metrics, CRDS, active sets, and ping tracking. It also includes cryptographic elements like SHA-256 and SHA-512 hashing, entry points for network communication, and random number generation. The structure contains nested structures for managing stakes and timers, and it supports callback functions for signing, sending, and handling ping tracker changes. Additionally, it maintains contact information and push state for peers in the active set.


# Functions

---
### fd\_gossip\_align<!-- {{#callable:fd_gossip_align}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L116>)

Returns a constant alignment value of 128.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the constant value `128uL`.
- **Output**: An unsigned long integer with the value 128.


---
### fd\_gossip\_footprint<!-- {{#callable:fd_gossip_footprint}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L121>)

Calculates the memory footprint required for a gossip protocol structure based on input parameters.
- **Inputs**:
    - `max_values`: The maximum number of values that the gossip protocol can handle.
    - `entrypoints_len`: The number of entry points in the gossip protocol.
- **Logic and Control Flow**:
    - Initialize a variable `l` with `FD_LAYOUT_INIT` to start the layout calculation.
    - Append the size and alignment of `fd_gossip_t` to `l` using `FD_LAYOUT_APPEND`.
    - Append the size and alignment of `fd_crds_t` using [`fd_crds_footprint`](<crds/fd_crds.c.md#fd_crds_footprint>) with `max_values` as parameters.
    - Append the size and alignment of `fd_active_set_t` using [`fd_active_set_footprint`](<fd_active_set.c.md#fd_active_set_footprint>).
    - Append the size and alignment of `fd_ping_tracker_t` using [`fd_ping_tracker_footprint`](<fd_ping_tracker.c.md#fd_ping_tracker_footprint>) with `entrypoints_len` as a parameter.
    - Append the size and alignment of `stake_pool` using `stake_pool_footprint` with `CRDS_MAX_CONTACT_INFO` as a parameter.
    - Append the size and alignment of `stake_map` using `stake_map_footprint` with the estimated chain count from `stake_map_chain_cnt_est`.
    - Append the size and alignment of `push_set` using [`push_set_footprint`](<fd_push_set_private.c.md#push_set_footprint>) with `FD_ACTIVE_SET_MAX_PEERS` as a parameter.
    - Finalize the layout calculation with `FD_LAYOUT_FINI` using [`fd_gossip_align`](<#fd_gossip_align>).
    - Return the calculated layout size `l`.
- **Output**: Returns the total memory footprint as an unsigned long integer.
- **Functions Called**:
    - [`fd_crds_align`](<crds/fd_crds.c.md#fd_crds_align>)
    - [`fd_crds_footprint`](<crds/fd_crds.c.md#fd_crds_footprint>)
    - [`fd_active_set_align`](<fd_active_set.c.md#fd_active_set_align>)
    - [`fd_active_set_footprint`](<fd_active_set.c.md#fd_active_set_footprint>)
    - [`fd_ping_tracker_align`](<fd_ping_tracker.c.md#fd_ping_tracker_align>)
    - [`fd_ping_tracker_footprint`](<fd_ping_tracker.c.md#fd_ping_tracker_footprint>)
    - [`push_set_align`](<fd_push_set_private.c.md#push_set_align>)
    - [`push_set_footprint`](<fd_push_set_private.c.md#push_set_footprint>)
    - [`fd_gossip_align`](<#fd_gossip_align>)


---
### ping\_tracker\_change<!-- {{#callable:ping_tracker_change}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L137>)

Updates the status of a peer in the gossip network based on the change type and notifies a callback function.
- **Inputs**:
    - `_ctx`: A pointer to the context, which is cast to `fd_gossip_t *`.
    - `peer_pubkey`: A constant pointer to the public key of the peer, represented as an array of unsigned characters.
    - `peer_address`: The IP address and port of the peer, represented as `fd_ip4_port_t`.
    - `now`: The current time, represented as a long integer.
    - `change_type`: An integer representing the type of change in the peer's status.
- **Logic and Control Flow**:
    - Cast `_ctx` to `fd_gossip_t *` and store it in `ctx`.
    - Check if `peer_pubkey` matches `ctx->identity_pubkey`; if so, return immediately.
    - Use a switch statement to handle different `change_type` values:
    - If `change_type` is `FD_PING_TRACKER_CHANGE_TYPE_ACTIVE`, call [`fd_crds_peer_active`](<crds/fd_crds.c.md#fd_crds_peer_active>) with `ctx->crds`, `peer_pubkey`, and `now`.
    - If `change_type` is `FD_PING_TRACKER_CHANGE_TYPE_INACTIVE`, call [`fd_crds_peer_inactive`](<crds/fd_crds.c.md#fd_crds_peer_inactive>) with `ctx->crds`, `peer_pubkey`, and `now`.
    - If `change_type` is `FD_PING_TRACKER_CHANGE_TYPE_INACTIVE_STAKED`, do nothing.
    - For any other `change_type`, log an error and return.
    - Call `ctx->ping_tracker_change_fn` with `ctx->ping_tracker_change_fn_ctx`, `peer_pubkey`, `peer_address`, `now`, and `change_type`.
- **Output**: No return value (void function).
- **Functions Called**:
    - [`fd_crds_peer_active`](<crds/fd_crds.c.md#fd_crds_peer_active>)
    - [`fd_crds_peer_inactive`](<crds/fd_crds.c.md#fd_crds_peer_inactive>)


---
### fd\_gossip\_new<!-- {{#callable:fd_gossip_new}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L157>)

Initializes a new gossip instance with specified parameters and returns a pointer to it.
- **Inputs**:
    - `shmem`: A pointer to shared memory where the gossip instance will be allocated.
    - `rng`: A pointer to a random number generator used for various operations within the gossip instance.
    - `max_values`: The maximum number of values the gossip instance can handle, which must be a power of 2.
    - `entrypoints_len`: The number of entry points provided, which must not exceed 16.
    - `entrypoints`: A pointer to an array of entry points, each represented by an `fd_ip4_port_t` structure.
    - `my_contact_info`: A pointer to the contact information of the current node.
    - `now`: The current time in nanoseconds.
    - `send_fn`: A function pointer for sending messages.
    - `send_ctx`: A context pointer for the send function.
    - `sign_fn`: A function pointer for signing messages.
    - `sign_ctx`: A context pointer for the sign function.
    - `ping_tracker_change_fn`: A function pointer for handling changes in the ping tracker.
    - `ping_tracker_change_fn_ctx`: A context pointer for the ping tracker change function.
    - `gossip_update_out`: A pointer to an output context for gossip updates.
    - `gossip_net_out`: A pointer to an output context for network gossip.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL and return NULL if true.
    - Check if `shmem` is aligned according to `fd_gossip_align()` and return NULL if not.
    - Check if `entrypoints_len` is greater than 16 and return NULL if true.
    - Check if `max_values` is a power of 2 and return NULL if not.
    - Estimate the stake map chain count using `stake_map_chain_cnt_est()` with `CRDS_MAX_CONTACT_INFO`.
    - Initialize scratch memory allocation with `FD_SCRATCH_ALLOC_INIT`.
    - Allocate memory for various components like `fd_gossip_t`, `crds`, `active_set`, `ping_tracker`, `stake_pool`, `stake_weights`, and `active_ps` using `FD_SCRATCH_ALLOC_APPEND`.
    - Verify the final memory allocation with `FD_SCRATCH_ALLOC_FINI`.
    - Set `gossip_net_out` and copy `entrypoints` into the gossip structure.
    - Initialize and join various components like `crds`, `active_set`, `ping_tracker`, `stake.pool`, `stake.map`, and `active_pset`.
    - Initialize SHA256 and SHA512 components.
    - Set timers for various operations to zero.
    - Assign function pointers and contexts for sending, signing, and ping tracker change handling.
    - Set the contact information using `fd_gossip_set_my_contact_info()`.
    - Clear the metrics structure with `fd_memset()`.
    - Return the initialized `gossip` pointer.
- **Output**: A pointer to the newly created `fd_gossip_t` instance, or NULL if initialization fails.
- **Functions Called**:
    - [`fd_gossip_align`](<#fd_gossip_align>)
    - [`fd_crds_align`](<crds/fd_crds.c.md#fd_crds_align>)
    - [`fd_crds_footprint`](<crds/fd_crds.c.md#fd_crds_footprint>)
    - [`fd_active_set_align`](<fd_active_set.c.md#fd_active_set_align>)
    - [`fd_active_set_footprint`](<fd_active_set.c.md#fd_active_set_footprint>)
    - [`fd_ping_tracker_align`](<fd_ping_tracker.c.md#fd_ping_tracker_align>)
    - [`fd_ping_tracker_footprint`](<fd_ping_tracker.c.md#fd_ping_tracker_footprint>)
    - [`push_set_align`](<fd_push_set_private.c.md#push_set_align>)
    - [`push_set_footprint`](<fd_push_set_private.c.md#push_set_footprint>)
    - [`fd_gossip_footprint`](<#fd_gossip_footprint>)
    - [`fd_crds_join`](<crds/fd_crds.c.md#fd_crds_join>)
    - [`fd_crds_new`](<crds/fd_crds.c.md#fd_crds_new>)
    - [`fd_active_set_join`](<fd_active_set.c.md#fd_active_set_join>)
    - [`fd_active_set_new`](<fd_active_set.c.md#fd_active_set_new>)
    - [`fd_ping_tracker_join`](<fd_ping_tracker.c.md#fd_ping_tracker_join>)
    - [`fd_ping_tracker_new`](<fd_ping_tracker.c.md#fd_ping_tracker_new>)
    - [`push_set_join`](<fd_push_set_private.c.md#push_set_join>)
    - [`push_set_new`](<fd_push_set_private.c.md#push_set_new>)
    - [`fd_gossip_set_my_contact_info`](<#fd_gossip_set_my_contact_info>)


---
### fd\_gossip\_join<!-- {{#callable:fd_gossip_join}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L252>)

Validates and joins a shared memory region as a `fd_gossip_t` structure if it is non-null and properly aligned.
- **Inputs**:
    - `shgossip`: A pointer to a shared memory region intended to be used as a `fd_gossip_t` structure.
- **Logic and Control Flow**:
    - Check if `shgossip` is NULL; if so, log a warning and return NULL.
    - Check if `shgossip` is aligned according to [`fd_gossip_align`](<#fd_gossip_align>); if not, log a warning and return NULL.
    - Cast `shgossip` to a `fd_gossip_t` pointer and return it.
- **Output**: Returns a pointer to `fd_gossip_t` if `shgossip` is valid and aligned, otherwise returns NULL.
- **Functions Called**:
    - [`fd_gossip_align`](<#fd_gossip_align>)


---
### fd\_gossip\_metrics<!-- {{#callable:fd_gossip_metrics}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L267>)

Returns the `metrics` field from a given `fd_gossip_t` structure.
- **Inputs**:
    - `gossip`: A pointer to a constant `fd_gossip_t` structure from which the metrics are to be retrieved.
- **Logic and Control Flow**:
    - Accesses the `metrics` field of the `gossip` structure.
    - Returns the `metrics` field.
- **Output**: A pointer to a constant `fd_gossip_metrics_t` structure, which contains the metrics of the given `gossip` instance.


---
### fd\_gossip\_crds\_metrics<!-- {{#callable:fd_gossip_crds_metrics}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L272>)

Retrieves the CRDS metrics from a given gossip instance.
- **Inputs**:
    - `gossip`: A pointer to a constant `fd_gossip_t` structure, which contains the gossip instance from which to retrieve the CRDS metrics.
- **Logic and Control Flow**:
    - Calls the [`fd_crds_metrics`](<crds/fd_crds.h.md#fd_crds_metrics>) function with the `crds` member of the `gossip` structure.
    - Returns the result of the [`fd_crds_metrics`](<crds/fd_crds.h.md#fd_crds_metrics>) function call.
- **Output**: A pointer to a constant `fd_crds_metrics_t` structure containing the CRDS metrics.
- **Functions Called**:
    - [`fd_crds_metrics`](<crds/fd_crds.h.md#fd_crds_metrics>)


---
### fd\_gossip\_ping\_tracker\_metrics<!-- {{#callable:fd_gossip_ping_tracker_metrics}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L277>)

Retrieves the ping tracker metrics from a given gossip instance.
- **Inputs**:
    - `gossip`: A pointer to a constant `fd_gossip_t` structure, which contains the gossip instance from which to retrieve the ping tracker metrics.
- **Logic and Control Flow**:
    - Calls the function [`fd_ping_tracker_metrics`](<fd_ping_tracker.h.md#fd_ping_tracker_metrics>) with the `ping_tracker` member of the `gossip` structure.
    - Returns the result of the [`fd_ping_tracker_metrics`](<fd_ping_tracker.h.md#fd_ping_tracker_metrics>) function call.
- **Output**: A pointer to a constant `fd_ping_tracker_metrics_t` structure containing the ping tracker metrics.
- **Functions Called**:
    - [`fd_ping_tracker_metrics`](<fd_ping_tracker.h.md#fd_ping_tracker_metrics>)


---
### random\_entrypoint<!-- {{#callable:random_entrypoint}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L282>)

Selects a random entry point from the list of entry points in the `gossip` structure.
- **Inputs**:
    - `gossip`: A pointer to a constant `fd_gossip_t` structure containing the entry points and random number generator.
- **Logic and Control Flow**:
    - Generate a random index using `fd_rng_ulong_roll` with the random number generator and the count of entry points from the `gossip` structure.
    - Return the entry point at the generated random index from the `gossip` structure's entry points array.
- **Output**: Returns a `fd_ip4_port_t` representing the randomly selected entry point.


---
### txbuild\_flush<!-- {{#callable:txbuild_flush}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L288>)

Flushes the transaction build buffer by sending its contents and updating metrics.
- **Inputs**:
    - ``gossip``: A pointer to the `fd_gossip_t` structure, which contains the gossip context and metrics.
    - ``txbuild``: A pointer to the `fd_gossip_txbuild_t` structure, which contains the transaction build data to be flushed.
    - ``stem``: A pointer to the `fd_stem_context_t` structure, which is used in the sending function.
    - ``dest_addr``: The destination address of type `fd_ip4_port_t` where the transaction data will be sent.
    - ``now``: A `long` integer representing the current time, used for timestamping the transaction.
- **Logic and Control Flow**:
    - Check if `txbuild->crds_len` is zero; if so, return immediately without doing anything.
    - Call the `send_fn` function from the `gossip` structure to send the transaction data (`txbuild->bytes`) to the `dest_addr` with the current timestamp `now`.
    - Increment the `message_tx` and `message_tx_bytes` metrics in the `gossip` structure for the transaction tag `txbuild->tag`.
    - Iterate over each CRDS entry in `txbuild->crds` and update the corresponding metrics based on whether the message tag is `FD_GOSSIP_MESSAGE_PUSH` or not.
    - Reinitialize the `txbuild` structure using [`fd_gossip_txbuild_init`](<fd_gossip_txbuild.c.md#fd_gossip_txbuild_init>) with the `gossip` identity public key and the transaction tag.
- **Output**: No return value; the function operates by side effects on the input structures.
- **Functions Called**:
    - [`fd_gossip_txbuild_init`](<fd_gossip_txbuild.c.md#fd_gossip_txbuild_init>)


---
### active\_push\_set\_flush<!-- {{#callable:active_push_set_flush}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L318>)

Flushes a push set entry by either sending a transaction build to a peer or reinitializing it if the peer's contact info is unavailable.
- **Inputs**:
    - ``gossip``: A pointer to the `fd_gossip_t` structure, which contains the gossip protocol state and configuration.
    - ``pset``: A pointer to the `push_set_t` structure, which manages the state of push sets for peers.
    - ``idx``: An unsigned long integer representing the index of the push set entry to flush.
    - ``stem``: A pointer to the `fd_stem_context_t` structure, which provides context for the transaction build.
    - ``now``: A long integer representing the current time in nanoseconds.
- **Logic and Control Flow**:
    - Look up the contact information for the peer at the given index in the active set using [`fd_crds_contact_info_lookup`](<crds/fd_crds.c.md#fd_crds_contact_info_lookup>) and [`fd_active_set_node_pubkey`](<fd_active_set.c.md#fd_active_set_node_pubkey>).
    - Retrieve the push set entry from the pool using `pset_entry_pool_ele`.
    - If the contact information (`ci`) is available, call [`txbuild_flush`](<#txbuild_flush>) to send the transaction build to the peer's gossip socket.
    - If the contact information is not available, reinitialize the transaction build using [`fd_gossip_txbuild_init`](<fd_gossip_txbuild.c.md#fd_gossip_txbuild_init>).
    - Append the push set entry to the push set's last-hit queue using [`push_set_pop_append`](<fd_push_set_private.c.md#push_set_pop_append>).
- **Output**: No return value; the function operates by side effects on the provided structures.
- **Functions Called**:
    - [`fd_crds_contact_info_lookup`](<crds/fd_crds.c.md#fd_crds_contact_info_lookup>)
    - [`fd_active_set_node_pubkey`](<fd_active_set.c.md#fd_active_set_node_pubkey>)
    - [`txbuild_flush`](<#txbuild_flush>)
    - [`fd_contact_info_gossip_socket`](<fd_gossip_private.h.md#fd_contact_info_gossip_socket>)
    - [`fd_gossip_txbuild_init`](<fd_gossip_txbuild.c.md#fd_gossip_txbuild_init>)
    - [`push_set_pop_append`](<fd_push_set_private.c.md#push_set_pop_append>)


---
### active\_push\_set\_insert<!-- {{#callable:active_push_set_insert}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L334>)

Inserts a CRDS value into the active push set and manages the push set entries for nodes in the active set.
- **Inputs**:
    - ``gossip``: A pointer to the `fd_gossip_t` structure, which contains the gossip protocol state.
    - ``crds_val``: A pointer to the CRDS value to insert.
    - ``crds_sz``: The size of the CRDS value.
    - ``origin_pubkey``: A pointer to the origin public key.
    - ``origin_stake``: The stake of the origin.
    - ``stem``: A pointer to the `fd_stem_context_t` structure, which provides context for the operation.
    - ``now``: The current time in nanoseconds.
    - ``flush_immediately``: An integer flag indicating whether to flush the push set immediately.
- **Logic and Control Flow**:
    - Calls [`fd_active_set_nodes`](<fd_active_set.c.md#fd_active_set_nodes>) to get the list of nodes in the active set and stores them in `out_nodes`.
    - Iterates over each node in `out_nodes`.
    - For each node, retrieves the corresponding push set entry using `pset_entry_pool_ele`.
    - Checks if the CRDS value can fit in the entry's transaction build using [`fd_gossip_txbuild_can_fit`](<fd_gossip_txbuild.c.md#fd_gossip_txbuild_can_fit>).
    - If the CRDS value cannot fit, calls [`active_push_set_flush`](<#active_push_set_flush>) to flush the entry.
    - Appends the CRDS value to the entry's transaction build using [`fd_gossip_txbuild_append`](<fd_gossip_txbuild.c.md#fd_gossip_txbuild_append>).
    - Updates the entry's last hit time using [`push_set_pop_append`](<fd_push_set_private.c.md#push_set_pop_append>).
    - If `flush_immediately` is true, calls [`active_push_set_flush`](<#active_push_set_flush>) to flush the entry immediately.
- **Output**: No return value (void function).
- **Functions Called**:
    - [`fd_active_set_nodes`](<fd_active_set.c.md#fd_active_set_nodes>)
    - [`fd_gossip_txbuild_can_fit`](<fd_gossip_txbuild.c.md#fd_gossip_txbuild_can_fit>)
    - [`active_push_set_flush`](<#active_push_set_flush>)
    - [`fd_gossip_txbuild_append`](<fd_gossip_txbuild.c.md#fd_gossip_txbuild_append>)
    - [`push_set_pop_append`](<fd_push_set_private.c.md#push_set_pop_append>)


---
### push\_my\_contact\_info<!-- {{#callable:push_my_contact_info}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L366>)

Inserts the current node's contact information into the active push set for gossip dissemination.
- **Inputs**:
    - ``gossip``: A pointer to the `fd_gossip_t` structure containing the gossip protocol state and configuration.
    - ``stem``: A pointer to the `fd_stem_context_t` structure used for context in the gossip protocol.
    - ``now``: A long integer representing the current time in nanoseconds.
- **Logic and Control Flow**:
    - Calls [`active_push_set_insert`](<#active_push_set_insert>) with the current node's contact information (`crds_val` and `crds_val_sz`) from the `gossip` structure.
    - Passes the node's public key and stake, along with the `stem` context and current time `now`, to [`active_push_set_insert`](<#active_push_set_insert>).
    - Sets the `flush_immediately` parameter to 0, indicating that the push set should not be flushed immediately.
- **Output**: No return value; the function operates by side effect, modifying the active push set within the `gossip` structure.
- **Functions Called**:
    - [`active_push_set_insert`](<#active_push_set_insert>)


---
### refresh\_contact\_info<!-- {{#callable:refresh_contact_info}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L380>)

Updates the contact information in the gossip structure and prepares it for the next refresh cycle.
- **Inputs**:
    - ``gossip``: A pointer to an `fd_gossip_t` structure that contains the gossip state and contact information.
    - ``now``: A long integer representing the current time in nanoseconds.
- **Logic and Control Flow**:
    - Set the `wallclock_nanos` field of `my_contact_info.ci` in the `gossip` structure to the current time `now`.
    - Call [`fd_gossip_contact_info_encode`](<fd_gossip_msg_ser.c.md#fd_gossip_contact_info_encode>) to encode the contact information into `crds_val` and update `crds_val_sz`.
    - Use the `sign_fn` callback to sign the encoded contact information starting from the 64th byte, using the ED25519 signature type.
    - Update the `next_contact_info_refresh` timer in the `gossip` structure to the current time `now`.
- **Output**: No return value; the function updates the `gossip` structure in place.
- **Functions Called**:
    - [`fd_gossip_contact_info_encode`](<fd_gossip_msg_ser.c.md#fd_gossip_contact_info_encode>)


---
### fd\_gossip\_set\_my\_contact\_info<!-- {{#callable:fd_gossip_set_my_contact_info}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L399>)

Updates the gossip structure with the provided contact information and refreshes the contact info timestamp.
- **Inputs**:
    - ``gossip``: A pointer to an `fd_gossip_t` structure that holds the gossip state and data.
    - ``contact_info``: A pointer to a constant `fd_contact_info_t` structure containing the new contact information to set.
    - ``now``: A long integer representing the current time in nanoseconds.
- **Logic and Control Flow**:
    - Copies the public key from `contact_info` to `gossip->identity_pubkey` using `fd_memcpy` with a fixed size of 32 bytes.
    - Assigns the `contact_info` to `gossip->my_contact_info.ci`.
    - Calls [`refresh_contact_info`](<#refresh_contact_info>) to update the contact info timestamp and encode the contact information.
- **Output**: This function does not return a value; it updates the `gossip` structure in place.
- **Functions Called**:
    - [`refresh_contact_info`](<#refresh_contact_info>)


---
### get\_stake<!-- {{#callable:get_stake}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L409>)

Retrieves the stake value associated with a given public key from a gossip structure.
- **Inputs**:
    - `gossip`: A pointer to a constant `fd_gossip_t` structure that contains the stake map and pool.
    - `pubkey`: A pointer to a constant `uchar` array representing the public key for which the stake is queried.
- **Logic and Control Flow**:
    - Queries the stake map using the provided public key to find the corresponding stake entry.
    - Checks if the entry is found; if not, returns 0.
    - If the entry is found, returns the stake value from the entry.
- **Output**: Returns the stake value as an `ulong` for the given public key, or 0 if the public key is not found in the stake map.


---
### fd\_gossip\_stakes\_update<!-- {{#callable:fd_gossip_stakes_update}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L417>)

Updates the stake information in the gossip structure with new stake weights.
- **Inputs**:
    - ``gossip``: A pointer to an `fd_gossip_t` structure that holds the gossip state and stake information.
    - ``stake_weights``: A pointer to an array of `fd_stake_weight_t` structures containing the new stake weights to update.
    - ``stake_weights_cnt``: The number of elements in the `stake_weights` array.
- **Logic and Control Flow**:
    - Checks if `stake_weights_cnt` exceeds `CRDS_MAX_CONTACT_INFO` and logs an error if true.
    - Iterates over the current stake map and removes each entry using `stake_map_idx_remove_fast`.
    - Iterates over the `stake_weights` array, copies each entry's public key and stake into the corresponding position in the stake pool, and inserts it into the stake map using `stake_map_idx_insert`.
    - Updates the `identity_stake` by calling [`get_stake`](<#get_stake>) with the `identity_pubkey`.
    - Sets `gossip->stake.count` to `stake_weights_cnt`.
- **Output**: No return value; updates the `gossip` structure in place.
- **Functions Called**:
    - [`get_stake`](<#get_stake>)


---
### rx\_pull\_request<!-- {{#callable:rx_pull_request}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L443>)

Processes a pull request by filtering and appending CRDS entries to a pull response, then sends the response to a peer.
- **Inputs**:
    - ``gossip``: A pointer to the `fd_gossip_t` structure, which contains the gossip protocol state.
    - ``pr_view``: A pointer to the `fd_gossip_view_pull_request_t` structure, which contains the view of the pull request.
    - ``payload``: A pointer to the payload data associated with the pull request.
    - ``peer_addr``: The IP address and port of the peer that sent the pull request.
    - ``stem``: A pointer to the `fd_stem_context_t` structure, which is used for context in the gossip protocol.
    - ``now``: The current time in nanoseconds.
- **Logic and Control Flow**:
    - Initialize a Bloom filter using the keys and bits from the `payload` based on offsets and lengths specified in `pr_view`.
    - Initialize a pull response using [`fd_gossip_txbuild_init`](<fd_gossip_txbuild.c.md#fd_gossip_txbuild_init>) with the identity public key and message type `FD_GOSSIP_MESSAGE_PULL_RESPONSE`.
    - Iterate over CRDS entries using a mask iterator initialized with `pr_view`'s mask and mask bits.
    - For each CRDS entry, check if it is contained in the Bloom filter using [`fd_bloom_contains`](<fd_bloom.c.md#fd_bloom_contains>).
    - If the entry is not in the Bloom filter, skip to the next entry.
    - Retrieve the CRDS entry value and size using [`fd_crds_entry_value`](<crds/fd_crds.c.md#fd_crds_entry_value>).
    - Check if the pull response can fit the CRDS entry size using [`fd_gossip_txbuild_can_fit`](<fd_gossip_txbuild.c.md#fd_gossip_txbuild_can_fit>); if not, flush the current response using [`txbuild_flush`](<#txbuild_flush>).
    - Append the CRDS entry to the pull response using [`fd_gossip_txbuild_append`](<fd_gossip_txbuild.c.md#fd_gossip_txbuild_append>).
    - After iterating, flush the pull response to the peer using [`txbuild_flush`](<#txbuild_flush>).
- **Output**: No return value; the function sends a pull response to the peer.
- **Functions Called**:
    - [`fd_gossip_txbuild_init`](<fd_gossip_txbuild.c.md#fd_gossip_txbuild_init>)
    - [`fd_crds_mask_iter_init`](<crds/fd_crds.c.md#fd_crds_mask_iter_init>)
    - [`fd_crds_mask_iter_done`](<crds/fd_crds.c.md#fd_crds_mask_iter_done>)
    - [`fd_crds_mask_iter_next`](<crds/fd_crds.c.md#fd_crds_mask_iter_next>)
    - [`fd_crds_mask_iter_entry`](<crds/fd_crds.c.md#fd_crds_mask_iter_entry>)
    - [`fd_bloom_contains`](<fd_bloom.c.md#fd_bloom_contains>)
    - [`fd_crds_entry_hash`](<crds/fd_crds.c.md#fd_crds_entry_hash>)
    - [`fd_crds_entry_value`](<crds/fd_crds.c.md#fd_crds_entry_value>)
    - [`fd_gossip_txbuild_can_fit`](<fd_gossip_txbuild.c.md#fd_gossip_txbuild_can_fit>)
    - [`txbuild_flush`](<#txbuild_flush>)
    - [`fd_gossip_txbuild_append`](<fd_gossip_txbuild.c.md#fd_gossip_txbuild_append>)


---
### rx\_pull\_response<!-- {{#callable:rx_pull_response}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L486>)

Processes a pull response by validating and inserting CRDS values into the gossip system.
- **Inputs**:
    - ``gossip``: A pointer to the `fd_gossip_t` structure, which contains the gossip system's state and metrics.
    - ``pull_response``: A pointer to the `fd_gossip_view_pull_response_t` structure, which contains the CRDS values received in the pull response.
    - ``payload``: A pointer to the payload data associated with the pull response.
    - ``stem``: A pointer to the `fd_stem_context_t` structure, which is used for context in the gossip system.
    - ``now``: A long integer representing the current time in nanoseconds.
- **Logic and Control Flow**:
    - Iterates over each CRDS value in the `pull_response`.
    - For each value, performs a fast check using [`fd_crds_checks_fast`](<crds/fd_crds.c.md#fd_crds_checks_fast>) to determine if the value is valid.
    - If the check fails, increments the appropriate metric counter and continues to the next value.
    - Determines the `origin_pubkey` and `origin_stake` from the payload and checks if the value should be accepted based on the current time and stake information.
    - If the value is not accepted, increments the wallclock drop metric, generates a hash, and records the failed insert.
    - If the value is accepted, inserts it into the CRDS using [`fd_crds_insert`](<crds/fd_crds.c.md#fd_crds_insert>) and increments the upserted metric counter.
    - If the inserted value is contact information, updates the ping tracker and increments additional metrics related to contact information.
    - Inserts the value into the active push set for further processing.
- **Output**: No direct output; updates the gossip system's state and metrics based on the processed pull response.
- **Functions Called**:
    - [`fd_crds_checks_fast`](<crds/fd_crds.c.md#fd_crds_checks_fast>)
    - [`get_stake`](<#get_stake>)
    - [`fd_crds_has_staked_node`](<crds/fd_crds.c.md#fd_crds_has_staked_node>)
    - [`fd_crds_contact_info_lookup`](<crds/fd_crds.c.md#fd_crds_contact_info_lookup>)
    - [`fd_crds_generate_hash`](<crds/fd_crds.c.md#fd_crds_generate_hash>)
    - [`fd_crds_insert_failed_insert`](<crds/fd_crds.c.md#fd_crds_insert_failed_insert>)
    - [`fd_crds_insert`](<crds/fd_crds.c.md#fd_crds_insert>)
    - [`fd_crds_entry_is_contact_info`](<crds/fd_crds.c.md#fd_crds_entry_is_contact_info>)
    - [`fd_crds_entry_contact_info`](<crds/fd_crds.c.md#fd_crds_entry_contact_info>)
    - [`fd_contact_info_gossip_socket`](<fd_gossip_private.h.md#fd_contact_info_gossip_socket>)
    - [`fd_ping_tracker_track`](<fd_ping_tracker.c.md#fd_ping_tracker_track>)
    - [`active_push_set_insert`](<#active_push_set_insert>)


---
### process\_push\_crds<!-- {{#callable:process_push_crds}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L548>)

Processes a CRDS push message by checking for duplicates, updating metrics, and inserting the CRDS entry if valid.
- **Inputs**:
    - ``gossip``: A pointer to the `fd_gossip_t` structure, which contains the gossip protocol state and metrics.
    - ``value``: A pointer to the `fd_gossip_view_crds_value_t` structure, representing the CRDS value to be processed.
    - ``payload``: A pointer to the payload data associated with the CRDS value.
    - ``now``: A long integer representing the current time in nanoseconds.
    - ``stem``: A pointer to the `fd_stem_context_t` structure, used for context in the gossip protocol.
- **Logic and Control Flow**:
    - Call [`fd_crds_checks_fast`](<crds/fd_crds.c.md#fd_crds_checks_fast>) to check the CRDS value for duplicates or staleness.
    - If [`fd_crds_checks_fast`](<crds/fd_crds.c.md#fd_crds_checks_fast>) returns a non-zero result, update the appropriate metrics for dropped messages and return the result.
    - If the check passes, update the metric for upserted push messages.
    - Extract the origin public key from the payload and determine if it matches the local identity.
    - Retrieve the stake associated with the origin public key using [`get_stake`](<#get_stake>).
    - Insert the CRDS entry using [`fd_crds_insert`](<crds/fd_crds.c.md#fd_crds_insert>) and verify the insertion with `FD_TEST`.
    - If the entry is contact information, update the ping tracker and additional metrics related to contact information.
    - Insert the CRDS value into the active push set using [`active_push_set_insert`](<#active_push_set_insert>).
    - Return 0 to indicate successful processing.
- **Output**: Returns an integer indicating the result of processing: 0 for success, or a positive value indicating the count of duplicate entries.
- **Functions Called**:
    - [`fd_crds_checks_fast`](<crds/fd_crds.c.md#fd_crds_checks_fast>)
    - [`get_stake`](<#get_stake>)
    - [`fd_crds_insert`](<crds/fd_crds.c.md#fd_crds_insert>)
    - [`fd_crds_entry_is_contact_info`](<crds/fd_crds.c.md#fd_crds_entry_is_contact_info>)
    - [`fd_crds_entry_contact_info`](<crds/fd_crds.c.md#fd_crds_entry_contact_info>)
    - [`fd_ping_tracker_track`](<fd_ping_tracker.c.md#fd_ping_tracker_track>)
    - [`active_push_set_insert`](<#active_push_set_insert>)


---
### rx\_push<!-- {{#callable:rx_push}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L596>)

Processes a series of CRDS values from a push message and handles duplicates.
- **Inputs**:
    - ``gossip``: A pointer to the `fd_gossip_t` structure, which contains the gossip protocol state.
    - ``push``: A pointer to the `fd_gossip_view_push_t` structure, which contains the push message details including CRDS values.
    - ``payload``: A pointer to the payload data associated with the push message.
    - ``now``: A long integer representing the current time in nanoseconds.
    - ``stem``: A pointer to the `fd_stem_context_t` structure, which is used for context in the gossip protocol.
- **Logic and Control Flow**:
    - Iterates over each CRDS value in the `push` message.
    - Calls [`process_push_crds`](<#process_push_crds>) for each CRDS value to process it and check for duplicates.
    - If [`process_push_crds`](<#process_push_crds>) returns a positive error code, indicating duplicates, a placeholder for a prune finder implementation is noted but not executed.
- **Output**: No direct output is returned; the function processes data and updates the gossip state.
- **Functions Called**:
    - [`process_push_crds`](<#process_push_crds>)


---
### rx\_prune<!-- {{#callable:rx_prune}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L618>)

Prunes nodes from the active set in a gossip network based on a list of origin public keys and their stakes.
- **Inputs**:
    - ``gossip``: A pointer to an `fd_gossip_t` structure representing the gossip network state.
    - ``payload``: A pointer to a constant unsigned character array containing the payload data.
    - ``prune``: A pointer to a constant `fd_gossip_view_prune_t` structure containing information about which nodes to prune.
- **Logic and Control Flow**:
    - Calculate the destination public key for the push operation by adding `prune->pubkey_off` to `payload`.
    - Calculate the starting point of the origins list by adding `prune->origins_off` to `payload`.
    - Iterate over each origin in the list, using `prune->origins_len` to determine the number of origins.
    - For each origin, calculate the public key and retrieve the stake using [`get_stake`](<#get_stake>).
    - Call [`fd_active_set_prune`](<fd_active_set.c.md#fd_active_set_prune>) to prune the origin from the active set using the destination public key, origin public key, origin stake, and the gossip node's identity public key and stake.
- **Output**: No return value; the function modifies the active set in the `gossip` structure.
- **Functions Called**:
    - [`get_stake`](<#get_stake>)
    - [`fd_active_set_prune`](<fd_active_set.c.md#fd_active_set_prune>)


---
### rx\_ping<!-- {{#callable:rx_ping}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L637>)

Handles an incoming ping message by creating and sending a pong response with a signed hash of the ping token.
- **Inputs**:
    - ``gossip``: A pointer to the `fd_gossip_t` structure, which contains the gossip protocol state and functions.
    - ``ping``: A pointer to the `fd_gossip_view_ping_t` structure, which contains the ping message data.
    - ``peer_address``: The IP address and port of the peer that sent the ping message.
    - ``stem``: A pointer to the `fd_stem_context_t` structure, which is used for sending messages.
    - ``now``: The current time in nanoseconds.
- **Logic and Control Flow**:
    - Allocate a buffer `out_payload` for the pong message, including space for a header.
    - Store the `FD_GOSSIP_MESSAGE_PONG` identifier in the first part of `out_payload`.
    - Cast the remaining part of `out_payload` to a `fd_gossip_view_pong_t` structure pointer `out_pong`.
    - Copy the public key from `gossip->identity_pubkey` to `out_pong->pubkey`.
    - Create a `pre_image` buffer and copy the string "SOLANA_PING_PONG" and the `ping->ping_token` into it.
    - Hash the `pre_image` using SHA-256 and store the result in `out_pong->ping_hash`.
    - Sign the `pre_image` using the `gossip->sign_fn` function and store the signature in `out_pong->signature`.
    - Send the `out_payload` using the `gossip->send_fn` function to the `peer_address`.
    - Increment the `message_tx` and `message_tx_bytes` metrics for `FD_GOSSIP_MESSAGE_PONG`.
- **Output**: No return value; the function sends a pong message to the peer.


---
### rx\_pong<!-- {{#callable:rx_pong}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L669>)

Registers a pong message in the ping tracker with the associated stake and peer address.
- **Inputs**:
    - ``gossip``: A pointer to the `fd_gossip_t` structure, which contains the gossip protocol state.
    - ``pong``: A pointer to the `fd_gossip_view_pong_t` structure, which contains the pong message details including the public key and ping hash.
    - ``peer_address``: The IP address and port of the peer that sent the pong message.
    - ``now``: The current time in nanoseconds.
- **Logic and Control Flow**:
    - Retrieve the stake associated with the public key in the pong message using the [`get_stake`](<#get_stake>) function.
    - Register the pong message in the ping tracker by calling [`fd_ping_tracker_register`](<fd_ping_tracker.c.md#fd_ping_tracker_register>) with the public key, stake, peer address, ping hash, and current time.
- **Output**: No return value; the function operates by side effect, updating the ping tracker state.
- **Functions Called**:
    - [`get_stake`](<#get_stake>)
    - [`fd_ping_tracker_register`](<fd_ping_tracker.c.md#fd_ping_tracker_register>)


---
### fd\_gossip\_rx<!-- {{#callable:fd_gossip_rx}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L678>)

Processes incoming gossip messages based on their type and updates the gossip state accordingly.
- **Inputs**:
    - ``gossip``: A pointer to the `fd_gossip_t` structure representing the gossip state.
    - ``peer``: The IP4 port of the peer from which the message was received.
    - ``data``: A pointer to the incoming data buffer containing the gossip message.
    - ``data_sz``: The size of the incoming data buffer.
    - ``now``: The current time in nanoseconds.
    - ``stem``: A pointer to the `fd_stem_context_t` structure used for context in processing.
- **Logic and Control Flow**:
    - Check if `data_sz` is at least the size of `fd_gossip_view_t` to ensure the data is valid.
    - Cast the `data` to a `fd_gossip_view_t` pointer to access the message view.
    - Determine the message type using `view->tag` and execute the corresponding case in the switch statement.
    - For `FD_GOSSIP_MESSAGE_PULL_REQUEST`, call [`rx_pull_request`](<#rx_pull_request>) to handle pull request messages.
    - For `FD_GOSSIP_MESSAGE_PULL_RESPONSE`, call [`rx_pull_response`](<#rx_pull_response>) to handle pull response messages.
    - For `FD_GOSSIP_MESSAGE_PUSH`, call [`rx_push`](<#rx_push>) to handle push messages.
    - For `FD_GOSSIP_MESSAGE_PRUNE`, call [`rx_prune`](<#rx_prune>) to handle prune messages.
    - For `FD_GOSSIP_MESSAGE_PING`, call [`rx_ping`](<#rx_ping>) to handle ping messages.
    - For `FD_GOSSIP_MESSAGE_PONG`, call [`rx_pong`](<#rx_pong>) to handle pong messages.
    - Log a critical error if the message type is unknown.
- **Output**: No return value; the function updates the gossip state based on the message type.
- **Functions Called**:
    - [`rx_pull_request`](<#rx_pull_request>)
    - [`rx_pull_response`](<#rx_pull_response>)
    - [`rx_push`](<#rx_push>)
    - [`rx_prune`](<#rx_prune>)
    - [`rx_ping`](<#rx_ping>)
    - [`rx_pong`](<#rx_pong>)


---
### fd\_gossip\_push\_vote<!-- {{#callable:fd_gossip_push_vote}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L715>)

Encodes and signs a vote transaction, checks its validity, inserts it into the CRDS, and pushes it to the active set.
- **Inputs**:
    - ``gossip``: A pointer to the `fd_gossip_t` structure, which contains the gossip protocol state and configuration.
    - ``txn``: A pointer to the transaction data to be encoded and pushed as a vote.
    - ``txn_sz``: The size of the transaction data in bytes.
    - ``stem``: A pointer to the `fd_stem_context_t` structure, which provides context for the operation.
    - ``now``: The current time in nanoseconds, used for timestamping the operation.
- **Logic and Control Flow**:
    - Encodes the transaction into a CRDS value using [`fd_gossip_crds_vote_encode`](<fd_gossip_msg_ser.c.md#fd_gossip_crds_vote_encode>) and stores it in `crds_val` with its size in `crds_val_sz`.
    - Signs the CRDS value using the `sign_fn` callback from the `gossip` structure.
    - Initializes a `fd_gossip_view_crds_value_t` structure with the encoded CRDS value details, including setting the tag to `FD_GOSSIP_VALUE_VOTE`.
    - Checks the validity of the CRDS value using [`fd_crds_checks_fast`](<crds/fd_crds.c.md#fd_crds_checks_fast>); if invalid, returns -1.
    - Inserts the CRDS value into the CRDS using [`fd_crds_insert`](<crds/fd_crds.c.md#fd_crds_insert>); if insertion fails, returns -1.
    - Calls [`active_push_set_insert`](<#active_push_set_insert>) to push the CRDS value to the active set, with the `flush_immediately` flag set to 1.
- **Output**: Returns 0 on success, or -1 if the CRDS value is invalid or insertion fails.
- **Functions Called**:
    - [`fd_gossip_crds_vote_encode`](<fd_gossip_msg_ser.c.md#fd_gossip_crds_vote_encode>)
    - [`fd_crds_checks_fast`](<crds/fd_crds.c.md#fd_crds_checks_fast>)
    - [`fd_crds_insert`](<crds/fd_crds.c.md#fd_crds_insert>)
    - [`active_push_set_insert`](<#active_push_set_insert>)


---
### tx\_ping<!-- {{#callable:tx_ping}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L767>)

Sends a ping message to peers from the ping tracker and updates metrics.
- **Inputs**:
    - ``gossip``: A pointer to the `fd_gossip_t` structure containing gossip protocol state and functions.
    - ``stem``: A pointer to the `fd_stem_context_t` structure used for sending messages.
    - ``now``: A long integer representing the current time in nanoseconds.
- **Logic and Control Flow**:
    - Initialize an output payload buffer to store the ping message.
    - Store the `FD_GOSSIP_MESSAGE_PING` identifier in the payload buffer.
    - Cast a portion of the payload buffer to a `fd_gossip_view_ping_t` structure and copy the identity public key from `gossip` into the `pubkey` field of this structure.
    - Enter a loop that continues as long as [`fd_ping_tracker_pop_request`](<fd_ping_tracker.c.md#fd_ping_tracker_pop_request>) returns true, indicating there are pending ping requests.
    - Inside the loop, copy the `ping_token` from the ping tracker request into the `ping_token` field of the `out_ping` structure.
    - Sign the `ping_token` using the `sign_fn` callback from `gossip` and store the signature in the `signature` field of the `out_ping` structure.
    - Send the constructed ping message using the `send_fn` callback from `gossip`, passing the `stem`, `out_payload`, and `peer_address` from the ping tracker request.
    - Increment the `message_tx` and `message_tx_bytes` metrics for `FD_GOSSIP_MESSAGE_PING` in the `metrics` field of `gossip`.
- **Output**: No return value; the function operates by sending messages and updating metrics.
- **Functions Called**:
    - [`fd_ping_tracker_pop_request`](<fd_ping_tracker.c.md#fd_ping_tracker_pop_request>)


---
### tx\_pull\_request<!-- {{#callable:tx_pull_request}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L796>)

Sends a pull request to a peer in the gossip network to request updates on the current state of the cluster.
- **Inputs**:
    - ``gossip``: A pointer to the `fd_gossip_t` structure, which contains the state and configuration of the gossip protocol.
    - ``stem``: A pointer to the `fd_stem_context_t` structure, which provides context for the current operation.
    - ``now``: A `long` integer representing the current time in nanoseconds.
- **Logic and Control Flow**:
    - Calculate the total number of CRDS values and determine the number of items to include in the pull request.
    - Compute the maximum number of bits and items for the Bloom filter based on the gossip protocol's parameters.
    - Determine the number of bits for the Bloom filter and calculate a mask for selecting CRDS entries.
    - Initialize a payload buffer and set up pointers for keys, bits, and bits set in the Bloom filter.
    - Initialize the Bloom filter in-place using the calculated parameters.
    - Iterate over the CRDS entries and purged entries, inserting their hashes into the Bloom filter.
    - Count the number of bits set in the Bloom filter and store this count.
    - Select a peer to send the pull request to, either by sampling from the CRDS or choosing a random entry point if no peers are available.
    - Send the pull request payload to the selected peer using the gossip protocol's send function.
    - Update the gossip metrics to reflect the transmission of the pull request message.
- **Output**: No return value; the function sends a pull request message to a peer in the gossip network.
- **Functions Called**:
    - [`fd_crds_len`](<crds/fd_crds.c.md#fd_crds_len>)
    - [`fd_crds_purged_len`](<crds/fd_crds.c.md#fd_crds_purged_len>)
    - [`fd_gossip_pull_request_max_filter_bits`](<fd_gossip_private.h.md#fd_gossip_pull_request_max_filter_bits>)
    - [`fd_bloom_max_items`](<fd_bloom.h.md#fd_bloom_max_items>)
    - [`fd_bloom_num_bits`](<fd_bloom.h.md#fd_bloom_num_bits>)
    - [`fd_gossip_pull_request_init`](<fd_gossip_msg_ser.c.md#fd_gossip_pull_request_init>)
    - [`fd_bloom_init_inplace`](<fd_bloom.c.md#fd_bloom_init_inplace>)
    - [`fd_crds_mask_iter_init`](<crds/fd_crds.c.md#fd_crds_mask_iter_init>)
    - [`fd_crds_mask_iter_done`](<crds/fd_crds.c.md#fd_crds_mask_iter_done>)
    - [`fd_crds_mask_iter_next`](<crds/fd_crds.c.md#fd_crds_mask_iter_next>)
    - [`fd_bloom_insert`](<fd_bloom.c.md#fd_bloom_insert>)
    - [`fd_crds_entry_hash`](<crds/fd_crds.c.md#fd_crds_entry_hash>)
    - [`fd_crds_mask_iter_entry`](<crds/fd_crds.c.md#fd_crds_mask_iter_entry>)
    - [`fd_crds_purged_mask_iter_init`](<crds/fd_crds.c.md#fd_crds_purged_mask_iter_init>)
    - [`fd_crds_purged_mask_iter_done`](<crds/fd_crds.c.md#fd_crds_purged_mask_iter_done>)
    - [`fd_crds_purged_mask_iter_next`](<crds/fd_crds.c.md#fd_crds_purged_mask_iter_next>)
    - [`fd_crds_purged_mask_iter_hash`](<crds/fd_crds.c.md#fd_crds_purged_mask_iter_hash>)
    - [`fd_crds_peer_sample`](<crds/fd_crds.c.md#fd_crds_peer_sample>)
    - [`random_entrypoint`](<#random_entrypoint>)
    - [`fd_contact_info_gossip_socket`](<fd_gossip_private.h.md#fd_contact_info_gossip_socket>)


---
### next\_pull\_request<!-- {{#callable:next_pull_request}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L868>)

Calculates the next time a pull request should be sent based on the current time.
- **Inputs**:
    - ``gossip``: A pointer to a constant `fd_gossip_t` structure, which is not used in the current implementation.
    - ``now``: A long integer representing the current time in nanoseconds.
- **Logic and Control Flow**:
    - The function currently ignores the `gossip` parameter.
    - It returns the value of `now` plus 1,600,000,000 nanoseconds (or 1.6 seconds).
- **Output**: Returns a long integer representing the next scheduled time for a pull request, which is 1.6 seconds after the current time.


---
### rotate\_active\_set<!-- {{#callable:rotate_active_set}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L880>)

Rotates the active set in the gossip protocol and updates the push set entry based on its usage status.
- **Inputs**:
    - ``gossip``: A pointer to the `fd_gossip_t` structure, which contains the gossip protocol state.
    - ``stem``: A pointer to the `fd_stem_context_t` structure, which provides context for the stem operations.
    - ``now``: A long integer representing the current time in nanoseconds.
- **Logic and Control Flow**:
    - Retrieve the active push set from the `gossip` structure.
    - Call [`fd_active_set_rotate`](<fd_active_set.c.md#fd_active_set_rotate>) to rotate the active set and get the index of the replaced entry.
    - If the replaced index is `ULONG_MAX`, exit the function as no rotation occurred.
    - Retrieve the push set entry from the pool using the replaced index.
    - If the entry is in use, call [`active_push_set_flush`](<#active_push_set_flush>) to flush the entry.
    - If the entry is not in use, mark it as in use, update its last hit time, and push it to the tail of the last hit queue.
    - Initialize the transaction build for the entry with the identity public key and message type `FD_GOSSIP_MESSAGE_PUSH`.
- **Output**: None (void function).
- **Functions Called**:
    - [`fd_active_set_rotate`](<fd_active_set.c.md#fd_active_set_rotate>)
    - [`active_push_set_flush`](<#active_push_set_flush>)
    - [`fd_gossip_txbuild_init`](<fd_gossip_txbuild.c.md#fd_gossip_txbuild_init>)


---
### flush\_stale\_push\_states<!-- {{#callable:flush_stale_push_states}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L901>)

Flushes stale entries from the active push set based on a specified time threshold.
- **Inputs**:
    - ``gossip``: A pointer to the `fd_gossip_t` structure, which contains the active push set and other gossip-related data.
    - ``stem``: A pointer to the `fd_stem_context_t` structure, used in the flushing process.
    - ``now``: A long integer representing the current time in nanoseconds.
- **Logic and Control Flow**:
    - Calculate `stale_if_before` as `now` minus one million nanoseconds (1 millisecond).
    - Retrieve the active push set from the `gossip` structure.
    - Check if the last hit list in the push set is empty; if so, return immediately.
    - Enter a loop to process entries in the last hit list of the push set.
    - Peek at the head entry of the last hit list and get its index in the pool.
    - Check if the entry's `last_hit.wallclock_nanos` is greater than `stale_if_before`; if true, break the loop.
    - Call [`active_push_set_flush`](<#active_push_set_flush>) to flush the entry from the active push set.
- **Output**: No output is returned; the function operates by modifying the state of the `gossip` and `stem` structures.
- **Functions Called**:
    - [`active_push_set_flush`](<#active_push_set_flush>)


---
### fd\_gossip\_advance<!-- {{#callable:fd_gossip_advance}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L917>)

Advances the state of the gossip protocol by updating CRDS, sending pings, flushing stale states, and managing timers for pull requests, contact info refresh, and active set rotation.
- **Inputs**:
    - ``gossip``: A pointer to an `fd_gossip_t` structure representing the gossip protocol state.
    - ``now``: A long integer representing the current time in nanoseconds.
    - ``stem``: A pointer to an `fd_stem_context_t` structure used for context in the gossip operations.
- **Logic and Control Flow**:
    - Calls [`fd_crds_advance`](<crds/fd_crds.c.md#fd_crds_advance>) to update the CRDS state with the current time and context.
    - Calls [`tx_ping`](<#tx_ping>) to send ping messages to peers.
    - Calls [`flush_stale_push_states`](<#flush_stale_push_states>) to remove stale push states from the active set.
    - Checks if the current time is greater than or equal to `gossip->timers.next_pull_request`; if true, calls [`tx_pull_request`](<#tx_pull_request>) and updates `gossip->timers.next_pull_request` with the next scheduled pull request time.
    - Checks if the current time is greater than or equal to `gossip->timers.next_contact_info_refresh`; if true, calls [`refresh_contact_info`](<#refresh_contact_info>) and [`push_my_contact_info`](<#push_my_contact_info>), then updates `gossip->timers.next_contact_info_refresh` with the next scheduled contact info refresh time.
    - Checks if the current time is greater than or equal to `gossip->timers.next_active_set_refresh`; if true, calls [`rotate_active_set`](<#rotate_active_set>) and updates `gossip->timers.next_active_set_refresh` with the next scheduled active set refresh time.
- **Output**: This function does not return a value; it updates the state of the `gossip` structure in place.
- **Functions Called**:
    - [`fd_crds_advance`](<crds/fd_crds.c.md#fd_crds_advance>)
    - [`tx_ping`](<#tx_ping>)
    - [`flush_stale_push_states`](<#flush_stale_push_states>)
    - [`tx_pull_request`](<#tx_pull_request>)
    - [`next_pull_request`](<#next_pull_request>)
    - [`refresh_contact_info`](<#refresh_contact_info>)
    - [`push_my_contact_info`](<#push_my_contact_info>)
    - [`rotate_active_set`](<#rotate_active_set>)


---
### fd\_gossip\_ping\_tracker\_track<!-- {{#callable:fd_gossip_ping_tracker_track}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_gossip.c#L940>)

Tracks a peer's ping activity in the gossip network using the peer's public key and address.
- **Inputs**:
    - ``gossip``: A pointer to an `fd_gossip_t` structure representing the gossip network context.
    - ``peer_pubkey``: A constant pointer to an unsigned character array representing the public key of the peer.
    - ``peer_address``: An `fd_ip4_port_t` value representing the IP address and port of the peer.
    - ``now``: A long integer representing the current time in nanoseconds.
- **Logic and Control Flow**:
    - Retrieve the stake associated with the peer's public key using the [`get_stake`](<#get_stake>) function.
    - Call the [`fd_ping_tracker_track`](<fd_ping_tracker.c.md#fd_ping_tracker_track>) function with the gossip's ping tracker, peer's public key, retrieved stake, peer's address, and current time.
- **Output**: No return value; the function updates the ping tracker state.
- **Functions Called**:
    - [`get_stake`](<#get_stake>)
    - [`fd_ping_tracker_track`](<fd_ping_tracker.c.md#fd_ping_tracker_track>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)