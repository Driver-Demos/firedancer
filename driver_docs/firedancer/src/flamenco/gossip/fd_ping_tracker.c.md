<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a ping tracker for managing peer connections and states in a network, including functions for tracking, registering, and requesting pings.

# Purpose
The code is a C module that implements a ping tracker system for monitoring network peers. It manages a collection of peers, each identified by a public key and an IP address, and tracks their state using a ping-pong mechanism. The module defines several states for peers, such as `FD_PING_TRACKER_STATE_UNPINGED`, `FD_PING_TRACKER_STATE_INVALID`, `FD_PING_TRACKER_STATE_VALID`, and `FD_PING_TRACKER_STATE_VALID_REFRESHING`, to represent the status of the ping process. The code includes functions to initialize and manage the ping tracker, track peers, register pong responses, and generate ping requests. It uses data structures like pools, doubly linked lists, and hash maps to efficiently manage and access peer information.

The module provides functions such as [`fd_ping_tracker_new`](<#fd_ping_tracker_new>), [`fd_ping_tracker_track`](<#fd_ping_tracker_track>), [`fd_ping_tracker_register`](<#fd_ping_tracker_register>), and [`fd_ping_tracker_pop_request`](<#fd_ping_tracker_pop_request>) to handle the lifecycle of peers in the ping tracking process. It also includes utility functions for hashing ping tokens and managing peer states. The code is designed to be part of a larger system, as indicated by the inclusion of external headers and templates for data structures. The module is intended to be used in environments where tracking the availability and responsiveness of network peers is necessary, such as in distributed systems or network monitoring applications.
# Imports and Dependencies

---
- `fd_ping_tracker.h`
- `../../ballet/sha256/fd_sha256.h`
- `../../util/log/fd_log.h`
- `../../util/tmpl/fd_pool.c`
- `../../util/tmpl/fd_dlist.c`
- `../../util/tmpl/fd_map_chain.c`


# Data Structures

---
### pubkey\_private
- **Type**: ``struct``
- **Members**:
    - ``b``: An array of 32 unsigned characters (`uchar`) used to store private key data.
- **Description**: Defines a structure named `pubkey_private` that contains a single member, `b`, which is an array of 32 unsigned characters. This structure is used to store private key data, likely for cryptographic purposes, as part of a larger system that involves peer tracking and communication.


---
### pubkey\_private\_t
- **Type**: ``struct``
- **Members**:
    - ``b``: An array of 32 unsigned characters (`uchar`) representing the private key data.
- **Description**: Defines a structure to store a private key as an array of 32 bytes. This structure is used to represent the private key data in a compact form, suitable for cryptographic operations or identity management within the system.


---
### fd\_ping\_peer
- **Type**: ``struct``
- **Members**:
    - ``address``: Stores the IP address and port of the peer.
    - ``identity_pubkey``: Holds the public key of the peer's identity.
    - ``ping_token``: Contains a 32-byte token used for ping operations.
    - ``expected_pong_hash``: Stores a 32-byte hash expected in the pong response.
    - ``state``: Indicates the current state of the peer in the ping process.
    - ``next_ping_nanos``: Specifies the time in nanoseconds for the next ping attempt.
    - ``valid_until_nanos``: Indicates the validity period of the peer in nanoseconds.
    - ``last_rx_nanos``: Records the last received time in nanoseconds.
    - ``pool_next``: Links to the next element in the pool.
    - ``lru_prev``: Links to the previous element in the LRU list.
    - ``lru_next``: Links to the next element in the LRU list.
    - ``map_next``: Links to the next element in the map.
    - ``map_prev``: Links to the previous element in the map.
    - ``unpinged_next``: Links to the next unpinged element.
    - ``unpinged_prev``: Links to the previous unpinged element.
    - ``waiting_next``: Links to the next waiting element.
    - ``waiting_prev``: Links to the previous waiting element.
    - ``refreshing_next``: Links to the next refreshing element.
    - ``refreshing_prev``: Links to the previous refreshing element.
- **Description**: Manages the state and tracking information of a peer in a ping-pong protocol. It includes fields for the peer's address, identity, and various states and timestamps related to the ping process. The structure also contains links for managing the peer in different lists and maps, such as unpinged, waiting, and refreshing lists, as well as a pool and LRU list. The union within the structure allows for flexible linking in different contexts, depending on the peer's current state.


---
### fd\_ping\_peer\_t
- **Type**: ``struct``
- **Members**:
    - ``address``: Stores the IP address and port of the peer.
    - ``identity_pubkey``: Holds the public key of the peer's identity.
    - ``ping_token``: Contains a 32-byte token used for pinging the peer.
    - ``expected_pong_hash``: Stores the expected hash of the pong response.
    - ``state``: Indicates the current state of the peer in the ping tracker.
    - ``next_ping_nanos``: Specifies the time in nanoseconds for the next ping attempt.
    - ``valid_until_nanos``: Indicates the validity period of the peer in nanoseconds.
    - ``last_rx_nanos``: Records the last received time in nanoseconds from the peer.
    - ``pool_next``: Links to the next element in the pool.
    - ``lru_prev``: Links to the previous element in the least recently used list.
    - ``lru_next``: Links to the next element in the least recently used list.
    - ``map_next``: Links to the next element in the map.
    - ``map_prev``: Links to the previous element in the map.
    - ``unpinged_next``: Links to the next element in the unpinged list.
    - ``unpinged_prev``: Links to the previous element in the unpinged list.
    - ``waiting_next``: Links to the next element in the waiting list.
    - ``waiting_prev``: Links to the previous element in the waiting list.
    - ``refreshing_next``: Links to the next element in the refreshing list.
    - ``refreshing_prev``: Links to the previous element in the refreshing list.
- **Description**: Manages the state and tracking information of a peer in a ping tracker system. It includes fields for the peer's network address, identity, and various states and timestamps related to ping operations. The structure also contains links for managing the peer in different lists and maps, facilitating operations like tracking, pinging, and refreshing the peer's status.


---
### fd\_ping\_tracker\_private
- **Type**: ``struct``
- **Members**:
    - ``rng``: Pointer to a random number generator.
    - ``sha``: Array of SHA-256 hash structures.
    - ``entrypoints_cnt``: Count of entry points.
    - ``entrypoints``: Pointer to an array of entry points.
    - ``metrics``: Array of ping tracker metrics.
    - ``pool``: Pointer to a pool of ping peers.
    - ``lru``: Pointer to a least recently used list.
    - ``unpinged``: Pointer to a list of unpinged peers.
    - ``waiting``: Pointer to a list of waiting peers.
    - ``refreshing``: Pointer to a list of refreshing peers.
    - ``peers``: Pointer to a map of peers.
    - ``change_fn``: Function pointer for change notifications.
    - ``change_fn_ctx``: Context for the change function.
    - ``magic``: Magic number for validation.
- **Description**: Aligns with `FD_PING_TRACKER_ALIGN`, this structure manages the state and operations of a ping tracker, including random number generation, SHA-256 hashing, entry point management, peer tracking, and change notifications. It uses various lists and maps to organize peers based on their ping status and provides metrics for tracking performance.


# Functions

---
### fd\_ping\_tracker\_align<!-- {{#callable:fd_ping_tracker_align}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_ping_tracker.c#L122>)

Returns the alignment requirement for the `fd_ping_tracker` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the value of the macro `FD_PING_TRACKER_ALIGN`.
- **Output**: The function returns an `ulong` representing the alignment requirement for the `fd_ping_tracker` structure.


---
### fd\_ping\_tracker\_footprint<!-- {{#callable:fd_ping_tracker_footprint}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_ping_tracker.c#L127>)

Calculates the memory footprint required for a ping tracker based on the number of entry points.
- **Inputs**:
    - `entrypoints_len`: The number of entry points for which the memory footprint is calculated.
- **Logic and Control Flow**:
    - Initialize a variable `l` with `FD_LAYOUT_INIT` to start the layout calculation.
    - Append the size of `fd_ping_tracker_t` to `l` with alignment `FD_PING_TRACKER_ALIGN`.
    - Append the size of the entry points array to `l` with alignment based on `fd_ip4_port_t`.
    - Append the memory footprint of the pool with alignment from `pool_align()` and size from `pool_footprint(FD_PING_TRACKER_MAX)`.
    - Append the memory footprint of the LRU list with alignment from `lru_list_align()` and size from `lru_list_footprint()`.
    - Append the memory footprint of the unpinged list with alignment from `unpinged_list_align()` and size from `unpinged_list_footprint()`.
    - Append the memory footprint of the waiting list with alignment from `waiting_list_align()` and size from `waiting_list_footprint()`.
    - Append the memory footprint of the refreshing list with alignment from `refreshing_list_align()` and size from `refreshing_list_footprint()`.
    - Append the memory footprint of the peer map with alignment from `peer_map_align()` and size from `peer_map_footprint(8192UL)`.
    - Finalize the layout calculation with `FD_LAYOUT_FINI(l, FD_PING_TRACKER_ALIGN)` and return the result.
- **Output**: Returns the total memory footprint as an unsigned long integer.


---
### fd\_ping\_tracker\_new<!-- {{#callable:fd_ping_tracker_new}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_ping_tracker.c#L142>)

Initializes and returns a new `fd_ping_tracker_t` object using shared memory and other parameters.
- **Inputs**:
    - `shmem`: Pointer to shared memory for allocation.
    - `rng`: Pointer to a random number generator.
    - `entrypoints_len`: Number of entrypoints.
    - `entrypoints`: Pointer to an array of entrypoints of type `fd_ip4_port_t`.
    - `change_fn`: Function pointer for handling changes in peer state.
    - `change_fn_ctx`: Context for the change function.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL; if so, log a warning and return NULL.
    - Check if `rng` is NULL; if so, log a warning and return NULL.
    - Check if `shmem` is aligned; if not, log a warning and return NULL.
    - Initialize scratch memory allocation with `shmem`.
    - Allocate memory for `fd_ping_tracker_t` and various lists and maps using `FD_SCRATCH_ALLOC_APPEND`.
    - Initialize the `ping_tracker` structure with the allocated memory and join the lists and maps.
    - Copy the `entrypoints` array into the allocated memory for entrypoints.
    - Set the `change_fn` and `change_fn_ctx` in the `ping_tracker`.
    - Initialize SHA-256 context and metrics in `ping_tracker`.
    - Set the `magic` field to `FD_PING_TRACKER_MAGIC` to indicate successful initialization.
    - Return the pointer to the initialized `fd_ping_tracker_t` object.
- **Output**: Returns a pointer to the newly created `fd_ping_tracker_t` object, or NULL if initialization fails.
- **Functions Called**:
    - [`fd_ping_tracker_align`](<#fd_ping_tracker_align>)


---
### fd\_ping\_tracker\_join<!-- {{#callable:fd_ping_tracker_join}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_ping_tracker.c#L206>)

Validates and returns a pointer to a `fd_ping_tracker_t` structure if the input pointer is non-null, properly aligned, and has a valid magic number.
- **Inputs**:
    - `shpt`: A pointer to a memory location that is expected to contain a `fd_ping_tracker_t` structure.
- **Logic and Control Flow**:
    - Check if `shpt` is NULL; if so, log a warning and return NULL.
    - Check if `shpt` is aligned according to [`fd_ping_tracker_align`](<#fd_ping_tracker_align>); if not, log a warning and return NULL.
    - Cast `shpt` to a `fd_ping_tracker_t` pointer and store it in `ping_tracker`.
    - Check if `ping_tracker->magic` equals `FD_PING_TRACKER_MAGIC`; if not, log a warning and return NULL.
    - Return the `ping_tracker` pointer.
- **Output**: A pointer to a `fd_ping_tracker_t` structure if all checks pass, otherwise NULL.
- **Functions Called**:
    - [`fd_ping_tracker_align`](<#fd_ping_tracker_align>)


---
### hash\_ping\_token<!-- {{#callable:hash_ping_token}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_ping_tracker.c#L228>)

Generates a SHA-256 hash for a given ping token and stores the result in an expected pong token.
- **Inputs**:
    - ``ping_token``: A pointer to a 32-byte array representing the ping token to hash.
    - ``expected_pong_token``: A pointer to a 32-byte array where the resulting hash will be stored.
    - ``sha``: A pointer to an `fd_sha256_t` structure used for SHA-256 hashing operations.
- **Logic and Control Flow**:
    - Initialize the SHA-256 context using `fd_sha256_init` with the provided `sha` pointer.
    - Append the string "SOLANA_PING_PONG" to the SHA-256 context using `fd_sha256_append`.
    - Append the `ping_token` to the SHA-256 context using `fd_sha256_append`.
    - Finalize the SHA-256 hash and store the result in `expected_pong_token` using `fd_sha256_fini`.
- **Output**: The function does not return a value; it outputs the hash result directly into the `expected_pong_token` array.


---
### remove\_tracking<!-- {{#callable:remove_tracking}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_ping_tracker.c#L238>)

Removes a `peer` from the appropriate list in the `ping_tracker` based on the `peer`'s state.
- **Inputs**:
    - `ping_tracker`: A pointer to an `fd_ping_tracker_t` structure that manages the lists and pool of peers.
    - `peer`: A pointer to an `fd_ping_peer_t` structure representing the peer to be removed from tracking.
- **Logic and Control Flow**:
    - Check if the `peer`'s state is `FD_PING_TRACKER_STATE_UNPINGED`; if true, remove the `peer` from the `unpinged` list using `unpinged_list_ele_remove`.
    - If the `peer`'s state is `FD_PING_TRACKER_STATE_VALID`, remove the `peer` from the `waiting` list using `waiting_list_ele_remove`.
    - For any other state, remove the `peer` from the `refreshing` list using `refreshing_list_ele_remove`.
- **Output**: No return value; the function modifies the lists within `ping_tracker` by removing the specified `peer`.


---
### generate\_ping\_token<!-- {{#callable:generate_ping_token}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_ping_tracker.c#L246>)

Generates a 32-byte ping token for a peer by copying a fixed string and appending random bytes.
- **Inputs**:
    - `peer`: A pointer to an `fd_ping_peer_t` structure where the ping token will be stored.
    - `rng`: A pointer to an `fd_rng_t` structure used to generate random bytes for the ping token.
- **Logic and Control Flow**:
    - Copy the string `"SOLANA_PING_PONG"` into the first 16 bytes of the `ping_token` array in the `peer` structure.
    - Use a loop to fill the remaining 16 bytes of the `ping_token` array with random bytes generated by `fd_rng_uchar` using the `rng` pointer.
- **Output**: The function does not return a value; it modifies the `ping_token` field of the `peer` structure in place.


---
### is\_entrypoint<!-- {{#callable:is_entrypoint}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_ping_tracker.c#L253>)

Checks if a given `peer_addr` is listed as an entrypoint in the `ping_tracker`.
- **Inputs**:
    - `ping_tracker`: A pointer to a `fd_ping_tracker_t` structure that contains the list of entrypoints.
    - `peer_addr`: An `fd_ip4_port_t` structure representing the address and port of the peer to check.
- **Logic and Control Flow**:
    - Iterates over the `entrypoints` array in `ping_tracker` using a loop.
    - Compares the `addr` and `port` of `peer_addr` with each entry in the `entrypoints` array.
    - If a match is found, returns 1 immediately.
    - If no match is found after checking all entrypoints, returns 0.
- **Output**: Returns 1 if `peer_addr` matches an entrypoint, otherwise returns 0.


---
### fd\_ping\_tracker\_track<!-- {{#callable:fd_ping_tracker_track}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_ping_tracker.c#L262>)

Tracks and manages the state of a peer in a ping tracker system, updating its status based on stake and address changes.
- **Inputs**:
    - ``ping_tracker``: A pointer to the `fd_ping_tracker_t` structure that manages the ping tracking system.
    - ``peer_pubkey``: A constant pointer to an array of unsigned characters representing the public key of the peer.
    - ``peer_stake``: An unsigned long integer representing the stake of the peer.
    - ``peer_address``: An `fd_ip4_port_t` structure representing the IP address and port of the peer.
    - ``now``: A long integer representing the current time in nanoseconds.
- **Logic and Control Flow**:
    - Query the peer map for the peer using the public key.
    - If the peer is not found and the stake is less than 1 SOL, check if the peer is an entrypoint; if not, proceed to add the peer.
    - If the pool is full, evict the least recently used peer, update metrics, and remove it from tracking.
    - Acquire a new peer from the pool, initialize its fields, and insert it into the tracking structures.
    - If the peer is found and its stake is now 1 SOL or it is an entrypoint, remove it from tracking and update metrics.
    - If the peer's address has changed, update the address, reset validity, and update metrics.
    - Update the peer's last received time and adjust its position in the LRU list.
- **Output**: No return value; the function updates the state and metrics of the `ping_tracker` and its peers.
- **Functions Called**:
    - [`is_entrypoint`](<#is_entrypoint>)
    - [`remove_tracking`](<#remove_tracking>)
    - [`generate_ping_token`](<#generate_ping_token>)
    - [`hash_ping_token`](<#hash_ping_token>)


---
### fd\_ping\_tracker\_register<!-- {{#callable:fd_ping_tracker_register}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_ping_tracker.c#L361>)

Registers a peer's pong response and updates the ping tracker state and metrics accordingly.
- **Inputs**:
    - ``ping_tracker``: A pointer to the `fd_ping_tracker_t` structure that manages the ping tracking state.
    - ``peer_pubkey``: A constant pointer to the peer's public key, used to identify the peer.
    - ``peer_stake``: An unsigned long representing the peer's stake, used to determine if the peer should be tracked.
    - ``peer_address``: A `fd_ip4_port_t` structure representing the peer's IP address and port.
    - ``pong_token``: A constant pointer to the pong token received from the peer, used to verify the pong response.
    - ``now``: A long integer representing the current time in nanoseconds.
- **Logic and Control Flow**:
    - Check if `peer_stake` is greater than or equal to 1,000,000,000; if true, increment `pong_result[0]` and return.
    - Check if `peer_address` is an entrypoint; if true, increment `pong_result[1]` and return.
    - Query the peer map for the peer using `peer_pubkey`; if not found, increment `pong_result[2]` and return.
    - Verify if `peer_address` matches the peer's stored address; if not, increment `pong_result[3]` and return.
    - Compare `pong_token` with the peer's expected pong hash; if they do not match, increment `pong_result[4]` and return.
    - Remove the peer from its current tracking list using [`remove_tracking`](<#remove_tracking>).
    - Update the peer's `valid_until_nanos` and `next_ping_nanos` to extend its validity and schedule the next ping.
    - If the peer's state is `FD_PING_TRACKER_STATE_INVALID` or `FD_PING_TRACKER_STATE_UNPINGED`, call the change function to mark the peer as active.
    - Adjust the metrics by decrementing the count of the peer's previous state and incrementing the `valid_cnt`.
    - Set the peer's state to `FD_PING_TRACKER_STATE_VALID` and add it to the waiting list.
    - Increment `pong_result[5]` to indicate a successful pong registration.
- **Output**: No return value; the function updates the state and metrics of the `ping_tracker`.
- **Functions Called**:
    - [`is_entrypoint`](<#is_entrypoint>)
    - [`remove_tracking`](<#remove_tracking>)


---
### fd\_ping\_tracker\_pop\_request<!-- {{#callable:fd_ping_tracker_pop_request}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_ping_tracker.c#L411>)

Manages and processes ping requests for peers, updating their states and metrics based on their activity and timing.
- **Inputs**:
    - ``ping_tracker``: A pointer to the `fd_ping_tracker_t` structure that manages the state and metrics of pinged peers.
    - ``now``: The current time in nanoseconds, used to determine the timing for ping requests.
    - ``out_peer_pubkey``: A pointer to a location where the function will store the public key of the peer to be pinged.
    - ``out_peer_address``: A pointer to a location where the function will store the address of the peer to be pinged.
    - ``out_token``: A pointer to a location where the function will store the ping token for the peer to be pinged.
- **Logic and Control Flow**:
    - Check if the `unpinged` list is not empty; if so, pop the head element, update its state to `FD_PING_TRACKER_STATE_INVALID`, and move it to the `refreshing` list.
    - If the `unpinged` list is empty, enter a loop to find the next peer to ping from the `refreshing` or `waiting` lists.
    - Select the next peer based on the earliest `next_ping_nanos` value between `peer_refreshing` and `peer_waiting`.
    - If the selected peer's `last_rx_nanos` is too old, remove it from tracking and update metrics accordingly.
    - If the next ping time is in the future, return 0 to indicate no action is needed.
    - If the peer is ready to be pinged, update its state and metrics, move it to the back of the `refreshing` list, and set the next ping time to one second later.
    - Store the peer's public key, address, and ping token in the provided output pointers and return 1 to indicate a ping request was made.
- **Output**: Returns 1 if a ping request is made, with the peer's public key, address, and token stored in the output pointers; returns 0 if no ping request is made.
- **Functions Called**:
    - [`remove_tracking`](<#remove_tracking>)


---
### fd\_ping\_tracker\_metrics<!-- {{#callable:fd_ping_tracker_metrics}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_ping_tracker.c#L505>)

Returns a pointer to the `metrics` field of a given `fd_ping_tracker_t` structure.
- **Inputs**:
    - `ping_tracker`: A pointer to a constant `fd_ping_tracker_t` structure from which to retrieve the metrics.
- **Logic and Control Flow**:
    - Accesses the `metrics` field of the `ping_tracker` structure.
    - Returns the `metrics` field.
- **Output**: A pointer to a constant `fd_ping_tracker_metrics_t` structure.



---
Made with ❤️ by [Driver](https://www.driver.ai/)