<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for Bloom filter functionality, including initialization, insertion, and containment checks.

# Purpose
The code is a test suite for a Bloom filter implementation. It includes three main test functions: [`test_filters`](<#test_filters>), [`test_add_contains`](<#test_add_contains>), and [`test_keys_oob`](<#test_keys_oob>). These functions verify the correct behavior of the Bloom filter operations such as initialization, insertion, and membership testing. The [`test_filters`](<#test_filters>) function checks the initialization of the Bloom filter with different numbers of keys and ensures that the internal structure is set up correctly. The [`test_add_contains`](<#test_add_contains>) function tests the ability to add elements to the Bloom filter and subsequently check for their presence. The [`test_keys_oob`](<#test_keys_oob>) function ensures that the keys region is correctly sized to prevent overlap with the filter bits, which could lead to undefined behavior.

The code uses static assertions to verify that the alignment and footprint of the Bloom filter match expected values. It also includes memory allocation and deallocation for the Bloom filter's internal data structures. The [`main`](<#main>) function initializes the test environment, runs each test function, and logs the results. The code relies on external functions and types such as `fd_bloom_t`, `fd_rng_t`, and various `fd_bloom_*` functions, which are likely defined in the included headers `fd_bloom.h` and `fd_util.h`. The test suite is designed to ensure the reliability and correctness of the Bloom filter implementation.
# Imports and Dependencies

---
- `../../util/fd_util.h`
- `fd_bloom.h`
- `stdlib.h`
- `string.h`


# Functions

---
### test\_filters<!-- {{#callable:test_filters}} -->
[View Source →](<../../../../../src/flamenco/gossip/test_bloom.c#L13>)

Tests the initialization and configuration of a Bloom filter with different key lengths and bit lengths.
- **Inputs**: None
- **Logic and Control Flow**:
    - Allocate memory for the Bloom filter using `aligned_alloc` with alignment and footprint calculated by [`fd_bloom_align`](<fd_bloom.c.md#fd_bloom_align>) and [`fd_bloom_footprint`](<fd_bloom.c.md#fd_bloom_footprint>) respectively.
    - Check if the memory allocation was successful using `FD_TEST`.
    - Create and join a random number generator (`fd_rng_t`) using `fd_rng_new` and `fd_rng_join`, and verify its creation with `FD_TEST`.
    - Create and join a Bloom filter (`fd_bloom_t`) using [`fd_bloom_new`](<fd_bloom.c.md#fd_bloom_new>) and [`fd_bloom_join`](<fd_bloom.c.md#fd_bloom_join>), and verify its creation with `FD_TEST`.
    - Initialize the Bloom filter with a key length of 0 using [`fd_bloom_initialize`](<fd_bloom.c.md#fd_bloom_initialize>), and verify that `keys_len` is 0 and `bits_len` is 1 using `FD_TEST`.
    - Re-initialize the Bloom filter with a key length of 10, and verify that `keys_len` is 3 and `bits_len` is 48 using `FD_TEST`.
    - Re-initialize the Bloom filter with a key length of 100, and verify that `keys_len` is 1 and `bits_len` is 100 using `FD_TEST`.
    - Free the allocated memory for the Bloom filter.
- **Output**: No output is returned; the function performs tests and uses assertions to verify conditions.
- **Functions Called**:
    - [`fd_bloom_align`](<fd_bloom.c.md#fd_bloom_align>)
    - [`fd_bloom_footprint`](<fd_bloom.c.md#fd_bloom_footprint>)
    - [`fd_bloom_join`](<fd_bloom.c.md#fd_bloom_join>)
    - [`fd_bloom_new`](<fd_bloom.c.md#fd_bloom_new>)
    - [`fd_bloom_initialize`](<fd_bloom.c.md#fd_bloom_initialize>)


---
### test\_add\_contains<!-- {{#callable:test_add_contains}} -->
[View Source →](<../../../../../src/flamenco/gossip/test_bloom.c#L39>)

Tests the addition and verification of elements in a Bloom filter.
- **Inputs**: None
- **Logic and Control Flow**:
    - Allocate memory for the Bloom filter using `aligned_alloc` with alignment and footprint calculated for a false positive rate of 0.1 and 800 bits.
    - Check if the memory allocation was successful using `FD_TEST`.
    - Initialize a random number generator `rng` and verify its creation with `FD_TEST`.
    - Create and join a new Bloom filter using [`fd_bloom_new`](<fd_bloom.c.md#fd_bloom_new>) and [`fd_bloom_join`](<fd_bloom.c.md#fd_bloom_join>), then verify its creation with `FD_TEST`.
    - Initialize the Bloom filter with 100 elements using [`fd_bloom_initialize`](<fd_bloom.c.md#fd_bloom_initialize>).
    - Check that the string "hello" is not in the Bloom filter using [`fd_bloom_contains`](<fd_bloom.c.md#fd_bloom_contains>) and `FD_TEST`.
    - Insert the string "hello" into the Bloom filter using [`fd_bloom_insert`](<fd_bloom.c.md#fd_bloom_insert>).
    - Verify that the string "hello" is now in the Bloom filter using [`fd_bloom_contains`](<fd_bloom.c.md#fd_bloom_contains>) and `FD_TEST`.
    - Check that the string "world" is not in the Bloom filter using [`fd_bloom_contains`](<fd_bloom.c.md#fd_bloom_contains>) and `FD_TEST`.
    - Insert the string "world" into the Bloom filter using [`fd_bloom_insert`](<fd_bloom.c.md#fd_bloom_insert>).
    - Verify that the string "world" is now in the Bloom filter using [`fd_bloom_contains`](<fd_bloom.c.md#fd_bloom_contains>) and `FD_TEST`.
    - Free the allocated memory for the Bloom filter.
- **Output**: No output is returned; the function performs tests and uses assertions to validate behavior.
- **Functions Called**:
    - [`fd_bloom_align`](<fd_bloom.c.md#fd_bloom_align>)
    - [`fd_bloom_footprint`](<fd_bloom.c.md#fd_bloom_footprint>)
    - [`fd_bloom_join`](<fd_bloom.c.md#fd_bloom_join>)
    - [`fd_bloom_new`](<fd_bloom.c.md#fd_bloom_new>)
    - [`fd_bloom_initialize`](<fd_bloom.c.md#fd_bloom_initialize>)
    - [`fd_bloom_contains`](<fd_bloom.c.md#fd_bloom_contains>)
    - [`fd_bloom_insert`](<fd_bloom.c.md#fd_bloom_insert>)


---
### test\_keys\_oob<!-- {{#callable:test_keys_oob}} -->
[View Source →](<../../../../../src/flamenco/gossip/test_bloom.c#L66>)

Tests if the keys region in a Bloom filter is correctly sized to prevent overlap with filter bits.
- **Inputs**: None
- **Logic and Control Flow**:
    - Allocate memory for Bloom filter bits using `aligned_alloc` with alignment and footprint based on a very low false positive rate and maximum bits.
    - Initialize a random number generator `rng` and join it to the Bloom filter.
    - Create and join a new Bloom filter `bloom` with the allocated memory, `rng`, false positive rate, and maximum bits.
    - Initialize the Bloom filter with one key.
    - Allocate memory for a copy of the Bloom filter bits and copy the bits from the Bloom filter to this memory.
    - Set all keys in the Bloom filter to `ULONG_MAX`.
    - Compare the copied bits with the Bloom filter bits to ensure they are identical, indicating no overlap.
    - Free the allocated memory for the bits copy and the Bloom filter bytes.
- **Output**: No output is returned, but the function uses assertions (`FD_TEST`) to validate that memory allocations and operations are successful and that the bits do not change after setting keys.
- **Functions Called**:
    - [`fd_bloom_align`](<fd_bloom.c.md#fd_bloom_align>)
    - [`fd_bloom_footprint`](<fd_bloom.c.md#fd_bloom_footprint>)
    - [`fd_bloom_join`](<fd_bloom.c.md#fd_bloom_join>)
    - [`fd_bloom_new`](<fd_bloom.c.md#fd_bloom_new>)
    - [`fd_bloom_initialize`](<fd_bloom.c.md#fd_bloom_initialize>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/flamenco/gossip/test_bloom.c#L92>)

Initializes the environment, runs a series of Bloom filter tests, and logs the results.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Verifies the alignment of the Bloom filter using `FD_TEST` and [`fd_bloom_align`](<fd_bloom.c.md#fd_bloom_align>).
    - Executes [`test_filters`](<#test_filters>) to test Bloom filter initialization and logs the result.
    - Executes [`test_add_contains`](<#test_add_contains>) to test Bloom filter insertion and membership checking, then logs the result.
    - Executes [`test_keys_oob`](<#test_keys_oob>) to test out-of-bounds key handling in the Bloom filter and logs the result.
- **Output**: No return value; the function returns an integer status code to the operating system, typically 0 for successful execution.
- **Functions Called**:
    - [`fd_bloom_align`](<fd_bloom.c.md#fd_bloom_align>)
    - [`test_filters`](<#test_filters>)
    - [`test_add_contains`](<#test_add_contains>)
    - [`test_keys_oob`](<#test_keys_oob>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)