<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

APIs for managing an active set of nodes in a Solana gossip network, with peer selection and pruning.

# Purpose
The `fd_active_set` module provides APIs for managing the active set of nodes in a gossip network, specifically tailored for the Solana gossip protocol. This module is responsible for selecting and maintaining a list of up to 300 peer nodes to which messages are sent. The selection process involves two main considerations: ensuring a good distribution of stakes among peers to avoid low-stake peer saturation and respecting peer requests to prune certain message origins. The module achieves this by organizing peers into 25 stake-based buckets, each containing up to 12 peers, and using bloom filters to track pruned origins for each peer.

The module defines several key structures and functions. The `fd_active_set_peer` structure represents a peer with a public key and an associated bloom filter. The `fd_active_set_entry` structure manages a set of peers within a stake bucket. The `fd_active_set_private` structure, aligned to 64 bytes, encapsulates the entire active set, including random number generation and a magic number for validation. Key functions include [`fd_active_set_new`](<#fd_active_set_new>) for creating a new active set, [`fd_active_set_nodes`](<#fd_active_set_nodes>) for retrieving the list of nodes to push messages to, [`fd_active_set_prune`](<#fd_active_set_prune>) for handling prune requests, and [`fd_active_set_rotate`](<#fd_active_set_rotate>) for rotating peers within the active set. These functions facilitate the dynamic management of peer nodes in the gossip network, ensuring efficient message dissemination and compliance with peer preferences.
# Imports and Dependencies

---
- `fd_bloom.h`
- `crds/fd_crds.h`


# Data Structures

---
### fd\_active\_set\_peer
- **Type**: ``struct``
- **Members**:
    - ``pubkey``: An array of 32 unsigned characters representing the public key of the peer.
    - ``bloom``: A pointer to a `fd_bloom_t` structure used to track pruned origins for the peer.
- **Description**: Represents a peer in the active set of a gossip network, containing a public key and a bloom filter to manage message forwarding restrictions.


---
### fd\_active\_set\_peer\_t
- **Type**: ``struct``
- **Members**:
    - ``pubkey``: An array of 32 unsigned characters representing the public key of the peer.
    - ``bloom``: A pointer to a `fd_bloom_t` structure used to track pruned origins for the peer.
- **Description**: `fd_active_set_peer_t` is a structure that represents a peer in the active set of a gossip network, containing a public key and a bloom filter to manage message forwarding restrictions.


---
### fd\_active\_set\_entry
- **Type**: ``struct``
- **Members**:
    - `nodes_idx`: Points to the oldest entry in the set.
    - `nodes_len`: Stores the length of the nodes array.
    - `nodes`: Holds an array of `fd_active_set_peer_t` structures, with a fixed size defined by `FD_ACTIVE_SET_PEERS_PER_ENTRY`.
- **Description**: Manages a set of active nodes in a gossip network, where each entry tracks a group of peers, their order, and their count, facilitating the selection and rotation of peers for message dissemination.


---
### fd\_active\_set\_entry\_t
- **Type**: ``struct``
- **Members**:
    - ``nodes_idx``: Points to the oldest entry in the set.
    - ``nodes_len``: Indicates the number of nodes in the set.
    - ``nodes``: An array of `fd_active_set_peer_t` structures, each representing a peer in the active set.
- **Description**: Manages a set of active peers in a gossip network, allowing for efficient message distribution and peer rotation based on stake distribution and pruning requests.


---
### fd\_active\_set\_private
- **Type**: ``struct fd_active_set_private``
- **Members**:
    - ``entries``: An array of `fd_active_set_entry_t` structures, each representing a set of peers sorted by stake.
    - ``rng``: A pointer to a random number generator used for selecting peers.
    - ``magic``: A magic number used to verify the integrity of the structure.
- **Description**: Aligns to `FD_ACTIVE_SET_ALIGN` and manages the active set of nodes in a gossip network, ensuring a good distribution of stakes and handling peer pruning requests.


---
### fd\_active\_set\_t
- **Type**: ``struct``
- **Members**:
    - `entries`: An array of `fd_active_set_entry_t` structures, each representing a stake bucket with peers.
    - `rng`: A pointer to a random number generator used for selecting peers.
    - `magic`: A magic number used to verify the integrity of the data structure.
- **Description**: `fd_active_set_t` is a data structure used in a gossip network to manage an active set of peers for message dissemination. It organizes peers into stake-based buckets, each containing a list of peers sorted by stake, and uses bloom filters to track pruned origins. The structure supports operations like rotating peers and pruning message paths, ensuring efficient and balanced message distribution across the network.


# Function Declarations (Public API)

---
### fd\_active\_set\_align<!-- {{#callable_declaration:fd_active_set_align}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_active_set.h#L69>)

Returns the alignment requirement for an active set.
- **Description**: Use this function to obtain the alignment requirement for data structures related to the active set in a gossip network. This alignment value is necessary when allocating memory for these structures to ensure proper memory access and performance. The function does not require any parameters and can be called at any time to retrieve the alignment value.
- **Inputs**: None
- **Output**: The function returns an unsigned long integer representing the alignment requirement in bytes.
- **See Also**: [`fd_active_set_align`](<fd_active_set.c.md#fd_active_set_align>)  (Implementation)


---
### fd\_active\_set\_footprint<!-- {{#callable_declaration:fd_active_set_footprint}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_active_set.h#L74>)

Calculates the memory footprint required for an active set.
- **Description**: Use this function to determine the amount of memory needed to store an active set in a gossip network. This is useful for allocating the correct amount of shared memory before initializing an active set. The function does not require any parameters and can be called at any time to retrieve the footprint size.
- **Inputs**: None
- **Output**: Returns the size in bytes of the memory footprint required for an active set.
- **See Also**: [`fd_active_set_footprint`](<fd_active_set.c.md#fd_active_set_footprint>)  (Implementation)


---
### fd\_active\_set\_new<!-- {{#callable_declaration:fd_active_set_new}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_active_set.h#L77>)

Creates a new active set for a gossip network.
- **Description**: Use this function to initialize a new active set in shared memory for tracking nodes in a gossip network. The function requires a pointer to a shared memory region and a random number generator. The shared memory must be aligned according to the alignment requirements of the active set. If the shared memory is null or misaligned, the function returns null. The function sets up bloom filters for each peer to manage message forwarding constraints.
- **Inputs**:
    - `shmem`: Pointer to a shared memory region where the active set will be created. Must not be null and must be aligned according to `fd_active_set_align()`. If null or misaligned, the function returns null.
    - `rng`: Pointer to a random number generator used for initializing bloom filters. The caller retains ownership.
- **Output**: Returns a pointer to the newly created active set, or null if the input is invalid or an error occurs during initialization.
- **See Also**: [`fd_active_set_new`](<fd_active_set.c.md#fd_active_set_new>)  (Implementation)


---
### fd\_active\_set\_join<!-- {{#callable_declaration:fd_active_set_join}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_active_set.h#L81>)

Validates and returns a pointer to an active set structure.
- **Description**: Use this function to obtain a pointer to an `fd_active_set_t` structure from a given memory address. The function checks if the provided memory address is non-null, properly aligned, and contains a valid active set structure by verifying a magic number. Call this function when you need to work with an active set structure that is already allocated and initialized. Ensure that the memory address is correctly aligned and initialized before calling this function to avoid warnings and a null return.
- **Inputs**:
    - `shas`: A pointer to a memory location that is expected to contain an `fd_active_set_t` structure. The pointer must not be null and must be aligned according to `fd_active_set_align()`. The memory must contain a valid active set structure with the correct magic number. If these conditions are not met, the function logs a warning and returns null.
- **Output**: Returns a pointer to the `fd_active_set_t` structure if the input is valid; otherwise, returns null.
- **See Also**: [`fd_active_set_join`](<fd_active_set.c.md#fd_active_set_join>)  (Implementation)


---
### fd\_active\_set\_nodes<!-- {{#callable_declaration:fd_active_set_nodes}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_active_set.h#L97>)

Retrieve a list of nodes to push messages to from the origin.
- **Description**: Use this function to get a list of peer nodes that should receive messages from a specified origin in a gossip network. The function considers pruning requests from peers, unless `ignore_prunes_if_peer_is_origin` is non-zero, in which case it includes peers whose public key matches the origin's public key. The function returns up to 12 peer nodes in `out_nodes`, which are internal indices valid only for the current active set. Do not use these indices after calling `fd_active_set_rotate` or `fd_active_set_prune`.
- **Inputs**:
    - `active_set`: Pointer to an `fd_active_set_t` structure representing the active set. Must not be null.
    - `identity_pubkey`: Pointer to a 32-byte array representing the public key of the identity. Must not be null.
    - `identity_stake`: Unsigned long representing the stake of the identity. No specific range is enforced.
    - `origin`: Pointer to a 32-byte array representing the public key of the origin. Must not be null.
    - `origin_stake`: Unsigned long representing the stake of the origin. No specific range is enforced.
    - `ignore_prunes_if_peer_is_origin`: Integer flag indicating whether to ignore pruning if the peer is the origin. Non-zero to ignore, zero otherwise.
    - `out_nodes`: Array of unsigned long with a static size of 12. Used to store the indices of the selected peer nodes. Must not be null.
- **Output**: Returns the number of nodes written to `out_nodes`, up to a maximum of 12.
- **See Also**: [`fd_active_set_nodes`](<fd_active_set.c.md#fd_active_set_nodes>)  (Implementation)


---
### fd\_active\_set\_node\_pubkey<!-- {{#callable_declaration:fd_active_set_node_pubkey}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_active_set.h#L106>)

Retrieves the public key of a specified peer node.
- **Description**: Use this function to get the public key of a peer node from an active set, given its index. This function is useful when you need to identify or communicate with a specific peer in the gossip network. Ensure that the `peer_idx` is within the valid range of the active set, as an out-of-range index will result in an error. The function assumes that the active set is properly initialized and populated with peer entries.
- **Inputs**:
    - `active_set`: A pointer to an `fd_active_set_t` structure representing the active set. Must not be null and should be properly initialized.
    - `peer_idx`: An unsigned long integer representing the index of the peer node within the active set. Must be within the range of valid peer indices; otherwise, an error is logged.
- **Output**: A pointer to an unsigned char array representing the public key of the specified peer node.
- **See Also**: [`fd_active_set_node_pubkey`](<fd_active_set.c.md#fd_active_set_node_pubkey>)  (Implementation)


---
### fd\_active\_set\_prune<!-- {{#callable_declaration:fd_active_set_prune}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_active_set.h#L110>)

Updates the bloom filter for a peer in the active set to prune messages from a specific origin.
- **Description**: Use this function to update the bloom filter of a peer in the active set to prevent forwarding messages from a specified origin. This function is part of the mechanism to manage message propagation in a gossip network by respecting prune requests from peers. It must be called with valid parameters, and it will not perform any action if the `identity_pubkey` matches the `origin`. Ensure that the `active_set` is properly initialized before calling this function.
- **Inputs**:
    - `active_set`: A pointer to an `fd_active_set_t` structure representing the active set. Must not be null and must be initialized.
    - `push_dest`: A pointer to a 32-byte array representing the public key of the peer to which the message is intended to be pushed. Must not be null.
    - `origin`: A pointer to a 32-byte array representing the public key of the origin node. Must not be null.
    - `origin_stake`: An unsigned long representing the stake of the origin node. Must be a valid stake value.
    - `identity_pubkey`: A pointer to a 32-byte array representing the public key of the identity node. Must not be null.
    - `identity_stake`: An unsigned long representing the stake of the identity node. Must be a valid stake value.
- **Output**: None
- **See Also**: [`fd_active_set_prune`](<fd_active_set.c.md#fd_active_set_prune>)  (Implementation)


---
### fd\_active\_set\_rotate<!-- {{#callable_declaration:fd_active_set_rotate}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_active_set.h#L126>)

Selects and replaces a peer in the active set.
- **Description**: Use this function to randomly select an entry from the active set and replace one of its peers with a new peer sampled from the `crds` distribution. This operation helps maintain a dynamic and well-distributed set of peers in a gossip network. The function returns the index of the replaced peer within the 300-peer set, which can be used to update related data structures. If no replacement is possible, it returns `ULONG_MAX`. Ensure that `active_set` and `crds` are properly initialized before calling this function.
- **Inputs**:
    - `active_set`: A pointer to an `fd_active_set_t` structure representing the active set. Must not be null and should be initialized.
    - `crds`: A pointer to an `fd_crds_t` structure used to sample new peers. Must not be null and should be initialized.
- **Output**: Returns the index of the replaced peer within the 300-peer set, or `ULONG_MAX` if no replacement is found.
- **See Also**: [`fd_active_set_rotate`](<fd_active_set.c.md#fd_active_set_rotate>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)