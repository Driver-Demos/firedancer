<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a system for managing and recording prune origins using pools, doubly linked lists, and maps.

# Purpose
The code defines a data structure and associated operations for managing a collection of `fd_prune_origin_t` elements, which are identified by a `pubkey_private_t` structure. The `fd_prune_origin_t` structure includes fields for managing linked list pointers, a unique identity public key, and a counter for the number of upserts. The code uses templates to include functionality for a pool, a doubly linked list (DLIST), and a map, which are used to manage the `fd_prune_origin_t` elements efficiently.

The [`fd_prune_finder_record`](<#fd_prune_finder_record>) function is a key component of this code. It records an origin identified by a public key, managing its presence in a map and a least-recently-used (LRU) list. If the origin is not already present, it is either acquired from a pool or removed from the head of the LRU list if the pool is full. The function updates the LRU list to ensure the most recently accessed origins are kept at the tail. The code is designed to handle operations on origins efficiently, optimizing for random access and removal.
# Imports and Dependencies

---
- `fd_prune_finder.h`
- `../../util/tmpl/fd_pool.c`
- `../../util/tmpl/fd_dlist.c`
- `../../util/tmpl/fd_map_chain.c`


# Data Structures

---
### pubkey\_private
- **Type**: ``struct``
- **Members**:
    - `b`: An array of 32 unsigned characters (`uchar`) that stores the private key data.
- **Description**: Stores a private key as an array of 32 unsigned characters, which is typically used in cryptographic operations to represent a private key in a compact form.


---
### pubkey\_private\_t
- **Type**: ``pubkey_private_t``
- **Members**:
    - ``b``: An array of 32 unsigned characters.
- **Description**: Defines a structure with a single member `b`, which is an array of 32 unsigned characters, typically used to store a private key in a cryptographic context.


---
### fd\_prune\_origin
- **Type**: ``struct``
- **Members**:
    - `identity_pubkey`: Stores the public key of the identity as a `pubkey_private_t` type.
    - `num_upserts`: Counts the number of upsert operations performed.
    - `pool_next`: Points to the next element in the pool.
    - `map_next`: Points to the next element in the map.
    - `map_prev`: Points to the previous element in the map.
    - `lru_prev`: Points to the previous element in the least recently used (LRU) list.
    - `lru_next`: Points to the next element in the least recently used (LRU) list.
- **Description**: Manages the state and relationships of an origin in a data structure that includes pool, map, and LRU list functionalities. It uses a public key to identify the origin and tracks the number of upsert operations. The structure also maintains pointers for navigating through a pool, a map, and an LRU list, facilitating efficient data management and retrieval.


---
### fd\_prune\_origin\_t
- **Type**: ``struct``
- **Members**:
    - `identity_pubkey`: Stores a public key as a `pubkey_private_t` structure.
    - `num_upserts`: Tracks the number of upsert operations as an unsigned long integer.
    - `pool_next`: Holds the index of the next element in the pool as an unsigned long integer.
    - `map_next`: Holds the index of the next element in the map as an unsigned long integer.
    - `map_prev`: Holds the index of the previous element in the map as an unsigned long integer.
    - `lru_prev`: Holds the index of the previous element in the LRU list as an unsigned long integer.
    - `lru_next`: Holds the index of the next element in the LRU list as an unsigned long integer.
- **Description**: Represents an origin in a prune finder system, containing a public key, counters for upsert operations, and indices for managing linked list and map structures.


---
### fd\_prune\_finder\_private
- **Type**: ``struct``
- **Members**:
    - `pool`: A pointer to a pool of `fd_prune_origin_t` structures.
    - `origins`: A pointer to an `origin_map_t` structure that maps origins.
    - `lru`: A pointer to an `lru_list_t` structure that manages a least-recently-used list.
- **Description**: Manages a collection of origins using a pool, a map for origin lookup, and a least-recently-used list for efficient removal and access.


# Functions

---
### fd\_prune\_finder\_record<!-- {{#callable:fd_prune_finder_record}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_prune_finder.c#L55>)

Manages the insertion and update of origin records in a prune finder structure, handling duplicates and maintaining an LRU list.
- **Inputs**:
    - `pf`: A pointer to the `fd_prune_finder_t` structure, which contains the pool, origin map, and LRU list.
    - `origin_pubkey`: A constant pointer to an array of unsigned characters representing the public key of the origin.
    - `relayer_pubkey`: A constant pointer to an array of unsigned characters representing the public key of the relayer.
    - `num_dups`: An unsigned long integer indicating the number of duplicates for the origin.
- **Logic and Control Flow**:
    - Query the `origin_map` for an existing record with the given `origin_pubkey`.
    - If the origin does not exist, check if there is free space in the pool; if so, acquire a new element, otherwise pop the head of the LRU list.
    - Initialize the new origin's `num_upserts` to 0 and copy the `origin_pubkey` into the origin's identity public key.
    - Insert the new origin into the `origin_map` and push it to the tail of the LRU list.
    - If the origin exists, remove it from its current position in the LRU list and push it to the tail.
    - If `num_dups` is zero, increment the `num_upserts` of the origin.
- **Output**: No return value; the function modifies the prune finder structure in place.



---
Made with ❤️ by [Driver](https://www.driver.ai/)