<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Bloom filter implementation with functions for initialization, insertion, and membership testing.

# Purpose
The code defines a C header file for a Bloom filter implementation, which is a probabilistic data structure used to test whether an element is a member of a set. The file provides the structure `fd_bloom_t` and several functions to manage and operate on Bloom filters. The `fd_bloom_t` structure includes fields for keys, bits, a hash seed, a random number generator, and parameters for the maximum number of bits and the false positive rate. The `FD_BLOOM_MAGIC` constant is used to verify the integrity of the Bloom filter structure.

The header file declares functions for creating and managing Bloom filters, such as [`fd_bloom_new`](<#fd_bloom_new>), [`fd_bloom_join`](<#fd_bloom_join>), [`fd_bloom_initialize`](<#fd_bloom_initialize>), [`fd_bloom_insert`](<#fd_bloom_insert>), and [`fd_bloom_contains`](<#fd_bloom_contains>). These functions allow for the creation of a new Bloom filter, joining an existing one, initializing it with a specified number of items, inserting keys, and checking for the presence of keys. Additionally, the file provides inline functions to calculate the maximum number of items and the number of bits required for a given false positive rate. The file is intended to be included in other C source files to provide Bloom filter functionality.
# Imports and Dependencies

---
- `../../util/rng/fd_rng.h`
- `math.h`


# Data Structures

---
### fd\_bloom\_private
- **Type**: ``struct``
- **Members**:
    - ``keys``: Pointer to an array of keys used in the Bloom filter.
    - ``keys_len``: Length of the `keys` array.
    - ``bits``: Pointer to an array of bits representing the Bloom filter.
    - ``bits_len``: Length of the `bits` array.
    - ``hash_seed``: Seed value for hash functions used in the Bloom filter.
    - ``rng``: Pointer to a random number generator used for hash function initialization.
    - ``max_bits``: Maximum number of bits allowed in the Bloom filter.
    - ``false_positive_rate``: Desired false positive rate for the Bloom filter.
    - ``magic``: Magic number used to verify the integrity of the Bloom filter structure.
- **Description**: Defines a private data structure for a Bloom filter, which is a probabilistic data structure used to test whether an element is a member of a set, allowing for false positives but not false negatives. The structure includes arrays for keys and bits, a hash seed, a random number generator, and parameters for maximum bits and false positive rate. The `magic` field is used to ensure the structure's integrity.


---
### fd\_bloom\_t
- **Type**: ``struct``
- **Members**:
    - ``keys``: Pointer to an array of unsigned long integers used for storing hash keys.
    - ``keys_len``: Length of the `keys` array.
    - ``bits``: Pointer to an array of unsigned long integers representing the bit array of the Bloom filter.
    - ``bits_len``: Length of the `bits` array.
    - ``hash_seed``: Seed value for the hash function.
    - ``rng``: Pointer to a random number generator used for hash function randomness.
    - ``max_bits``: Maximum number of bits allowed in the Bloom filter.
    - ``false_positive_rate``: Desired false positive rate for the Bloom filter.
    - ``magic``: Magic number used to verify the integrity of the Bloom filter structure.
- **Description**: Defines a Bloom filter data structure with fields for managing hash keys, bit arrays, and configuration parameters such as false positive rate and maximum bits. The structure includes a magic number for integrity checks and uses a random number generator for hash function randomness.


# Functions

---
### fd\_bloom\_max\_items<!-- {{#callable:fd_bloom_max_items}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_bloom.h#L73>)

Calculates the maximum number of items that can be inserted into a Bloom filter given the maximum number of bits, number of hash functions, and desired false positive rate.
- **Inputs**:
    - `max_bits`: The maximum number of bits available for the Bloom filter.
    - `num_keys`: The number of hash functions used in the Bloom filter.
    - `false_positive_rate`: The desired false positive rate for the Bloom filter.
- **Logic and Control Flow**:
    - Calculate the logarithm of the false positive rate divided by the number of keys.
    - Compute the exponential of the result from the previous step and subtract it from 1.0.
    - Take the logarithm of the result from the previous step.
    - Divide the negative number of keys by the result from the previous step.
    - Divide the maximum number of bits by the result from the previous step.
    - Apply the ceiling function to the result to get the maximum number of items.
- **Output**: Returns the maximum number of items that can be inserted into the Bloom filter without exceeding the specified false positive rate.


---
### fd\_bloom\_num\_bits<!-- {{#callable:fd_bloom_num_bits}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_bloom.h#L80>)

Calculates the optimal number of bits for a Bloom filter based on the number of items, desired false positive rate, and maximum allowable bits.
- **Inputs**:
    - `num_items`: The expected number of items to be inserted into the Bloom filter.
    - `false_positive_rate`: The desired probability of false positives in the Bloom filter.
    - `max_bits`: The maximum number of bits that can be used in the Bloom filter.
- **Logic and Control Flow**:
    - Calculate `num_bits` using the formula: `ceil(((double)num_items * log(false_positive_rate)) / log(1.0 / pow(2.0, log(2.0))))`.
    - Use `fmin` to ensure `num_bits` does not exceed `max_bits`.
    - Use `fmax` to ensure `num_bits` is at least 1.
    - Return the calculated number of bits as an unsigned long integer.
- **Output**: Returns the number of bits as an unsigned long integer (`ulong`) to be used in the Bloom filter.


# Function Declarations (Public API)

---
### fd\_bloom\_align<!-- {{#callable_declaration:fd_bloom_align}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_bloom.h#L31>)

Returns the alignment requirement for a Bloom filter.
- **Description**: Use this function to obtain the alignment requirement for a Bloom filter structure. This alignment value is necessary when allocating memory for a Bloom filter to ensure proper memory access and performance. The function does not require any parameters and can be called at any time to retrieve the alignment value.
- **Inputs**: None
- **Output**: Returns the alignment requirement as an unsigned long integer.
- **See Also**: [`fd_bloom_align`](<fd_bloom.c.md#fd_bloom_align>)  (Implementation)


---
### fd\_bloom\_footprint<!-- {{#callable_declaration:fd_bloom_footprint}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_bloom.h#L36>)

Calculates the memory footprint for a Bloom filter configuration.
- **Description**: Use this function to determine the memory size needed for a Bloom filter given a desired false positive rate and a maximum number of bits. This function is useful when planning memory allocation for Bloom filters. It returns zero if the false positive rate is not between 0 and 1, or if the maximum number of bits is outside the range of 1 to 32,768. Ensure that the false positive rate is a valid probability and that the maximum bits are within the specified range before calling this function.
- **Inputs**:
    - `false_positive_rate`: A double representing the desired false positive rate for the Bloom filter. Must be greater than 0.0 and less than 1.0. If outside this range, the function returns 0.
    - `max_bits`: An unsigned long representing the maximum number of bits available for the Bloom filter. Must be between 1 and 32,768 inclusive. If outside this range, the function returns 0.
- **Output**: Returns an unsigned long representing the memory footprint in bytes for the specified Bloom filter configuration, or 0 if inputs are invalid.
- **See Also**: [`fd_bloom_footprint`](<fd_bloom.c.md#fd_bloom_footprint>)  (Implementation)


---
### fd\_bloom\_new<!-- {{#callable_declaration:fd_bloom_new}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_bloom.h#L40>)

Creates a new Bloom filter in shared memory.
- **Description**: Use this function to create a Bloom filter in a specified shared memory region. The function requires a random number generator, a desired false positive rate, and a maximum number of bits for the filter. Ensure that the shared memory is aligned according to `fd_bloom_align()` and is not null. The false positive rate must be between 0.0 and 1.0, exclusive, and `max_bits` must be between 1 and 32768, inclusive. If any of these conditions are not met, the function returns null. The caller must ensure that the random number generator is valid and initialized.
- **Inputs**:
    - `shmem`: Pointer to the shared memory region where the Bloom filter will be created. Must not be null and must be aligned according to `fd_bloom_align()`. Caller retains ownership.
    - `rng`: Pointer to a random number generator used for initializing the Bloom filter. Must not be null. Caller retains ownership.
    - `false_positive_rate`: Desired false positive rate for the Bloom filter. Must be greater than 0.0 and less than 1.0.
    - `max_bits`: Maximum number of bits for the Bloom filter. Must be between 1 and 32768, inclusive.
- **Output**: Returns a pointer to the newly created Bloom filter on success, or null if any input validation fails.
- **See Also**: [`fd_bloom_new`](<fd_bloom.c.md#fd_bloom_new>)  (Implementation)


---
### fd\_bloom\_join<!-- {{#callable_declaration:fd_bloom_join}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_bloom.h#L46>)

Joins a shared memory region to a Bloom filter.
- **Description**: Use this function to join a shared memory region that represents a Bloom filter. The shared memory must be correctly aligned and initialized with the expected magic number. This function checks for null pointers, alignment, and the magic number to ensure the memory region is valid. If any of these checks fail, the function returns null and logs a warning. This function is typically used after creating or initializing a Bloom filter in shared memory.
- **Inputs**:
    - `shbloom`: A pointer to a shared memory region that represents a Bloom filter. Must not be null and must be aligned to `FD_BLOOM_ALIGN`. The memory region must have been initialized with the correct magic number `FD_BLOOM_MAGIC`. If these conditions are not met, the function returns null and logs a warning.
- **Output**: Returns a pointer to an `fd_bloom_t` structure if successful, or null if the input is invalid.
- **See Also**: [`fd_bloom_join`](<fd_bloom.c.md#fd_bloom_join>)  (Implementation)


---
### fd\_bloom\_initialize<!-- {{#callable_declaration:fd_bloom_initialize}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_bloom.h#L49>)

Initializes a Bloom filter with specified parameters.
- **Description**: Use this function to set up a Bloom filter with a given number of expected items. It prepares the filter by calculating the necessary number of bits and keys based on the false positive rate and maximum bits specified in the `fd_bloom_t` structure. This function must be called before inserting items into the Bloom filter. Ensure that the `bloom` parameter is a valid pointer to an `fd_bloom_t` structure that has been properly allocated and configured with a random number generator and other necessary parameters.
- **Inputs**:
    - `bloom`: A pointer to an `fd_bloom_t` structure. This must not be null and should be properly allocated and initialized with a random number generator and other necessary parameters before calling this function.
    - `num_items`: The expected number of items to be inserted into the Bloom filter. It must be a non-negative value. If zero, the function will set the number of keys to zero.
- **Output**: None
- **See Also**: [`fd_bloom_initialize`](<fd_bloom.c.md#fd_bloom_initialize>)  (Implementation)


---
### fd\_bloom\_insert<!-- {{#callable_declaration:fd_bloom_insert}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_bloom.h#L53>)

Inserts a key into the Bloom filter.
- **Description**: Use this function to add a key to the Bloom filter, which is represented by the `bloom` parameter. This operation allows the Bloom filter to recognize the key in future membership tests. Ensure that the Bloom filter is properly initialized before calling this function. The function does not handle invalid input parameters, so the caller must ensure that the `bloom` pointer is valid and that `key` is not null.
- **Inputs**:
    - `bloom`: A pointer to an `fd_bloom_t` structure representing the Bloom filter. Must be a valid, initialized Bloom filter.
    - `key`: A pointer to the key data to insert into the Bloom filter. Must not be null.
    - `key_sz`: The size of the key in bytes. Must accurately represent the length of the data pointed to by `key`.
- **Output**: None
- **See Also**: [`fd_bloom_insert`](<fd_bloom.c.md#fd_bloom_insert>)  (Implementation)


---
### fd\_bloom\_contains<!-- {{#callable_declaration:fd_bloom_contains}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_bloom.h#L58>)

Checks if a key is present in the Bloom filter.
- **Description**: Use this function to verify if a given key is likely present in the Bloom filter. It returns a non-zero value if the key is possibly in the filter, and zero if the key is definitely not in the filter. This function must be called with a valid Bloom filter that has been properly initialized. The function does not modify the Bloom filter or the key.
- **Inputs**:
    - `bloom`: A pointer to a `fd_bloom_t` structure representing the Bloom filter. Must not be null and must point to a valid, initialized Bloom filter.
    - `key`: A pointer to the key data to check for presence in the Bloom filter. Must not be null.
    - `key_sz`: The size of the key in bytes. Must be a valid size for the key data provided.
- **Output**: Returns 1 if the key is possibly in the Bloom filter, or 0 if the key is definitely not in the Bloom filter.
- **See Also**: [`fd_bloom_contains`](<fd_bloom.c.md#fd_bloom_contains>)  (Implementation)


---
### fd\_bloom\_init\_inplace<!-- {{#callable_declaration:fd_bloom_init_inplace}} -->
[View Source →](<../../../../../src/flamenco/gossip/fd_bloom.h#L63>)

Initializes a Bloom filter in place with specified parameters.
- **Description**: Use this function to set up a Bloom filter directly in the provided memory locations for keys and bits. It requires valid pointers for `keys`, `bits`, and `out_bloom`, and initializes the Bloom filter with the given parameters. Ensure that `keys` and `bits` are not null and have sufficient length as specified by `keys_len` and `bits_len`. The function also requires a random number generator `rng` to populate the keys. The `false_positive_rate` parameter determines the expected rate of false positives in the filter. This function returns an error code if any of the required pointers are null.
- **Inputs**:
    - `keys`: Pointer to an array of unsigned long integers where the keys will be stored. Must not be null.
    - `bits`: Pointer to an array of unsigned long integers where the bits will be stored. Must not be null.
    - `keys_len`: Number of keys to generate and store in the `keys` array. Must be a positive integer.
    - `bits_len`: Length of the `bits` array. Must be a positive integer.
    - `hash_seed`: Seed value for the hash function used in the Bloom filter.
    - `rng`: Pointer to a random number generator used to populate the keys. Must not be null.
    - `false_positive_rate`: Desired false positive rate for the Bloom filter. Must be a positive double.
    - `out_bloom`: Pointer to a `fd_bloom_t` structure where the initialized Bloom filter will be stored. Must not be null.
- **Output**: Returns 0 on success or -1 if any of the required pointers are null.
- **See Also**: [`fd_bloom_init_inplace`](<fd_bloom.c.md#fd_bloom_init_inplace>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)