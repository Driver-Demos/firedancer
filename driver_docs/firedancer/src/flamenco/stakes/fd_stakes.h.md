<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions and macros for managing stake weights, activation, history, and vote state updates.

# Purpose
The code is a C header file that defines functions and macros related to managing and processing stake and vote data in a blockchain or distributed ledger system. It includes several function prototypes that handle operations such as converting stake data into ordered lists, activating stakes for a specific epoch, and updating in-memory caches for stake delegations and vote states. The header file also includes necessary dependencies from other modules, such as `fd_flamenco_base.h`, `fd_types.h`, `fd_stake_delegations.h`, and `fd_vote_states.h`, indicating that it is part of a larger system.

The primary functionality of this code revolves around managing stake weights and vote accounts, which are crucial for maintaining the integrity and operation of a blockchain network. Functions like [`fd_stake_weights_by_node`](<#fd_stake_weights_by_node>) and [`fd_stakes_activate_epoch`](<#fd_stakes_activate_epoch>) are designed to process and update stake-related data, ensuring that the system accurately reflects the current state of stakes and votes. The code also includes mechanisms for maintaining an in-memory cache of stake delegations and vote states, which are updated at epoch boundaries. This header file is intended to be included in other C source files that require access to these stake management functionalities.
# Imports and Dependencies

---
- `../fd_flamenco_base.h`
- `../types/fd_types.h`
- `fd_stake_delegations.h`
- `fd_vote_states.h`


# Function Declarations (Public API)

---
### fd\_stake\_weights\_by\_node<!-- {{#callable_declaration:fd_stake_weights_by_node}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stakes.h#L25>)

Converts and sorts vote states into a list of stake weights.
- **Description**: Use this function to convert an unordered list of vote accounts and their active stakes into an ordered list of stake weights. The output list is sorted by stake in descending order, and by vote public key in descending order when stakes are equal. Ensure that the `weights` array is large enough to hold all potential entries, as determined by the size of the vote accounts pool and root. The function returns the number of entries in the `weights` array, which will be less than or equal to the number of vote accounts.
- **Inputs**:
    - `vote_states`: A pointer to a `fd_vote_states_t` structure containing the vote states to process. Must not be null.
    - `weights`: A pointer to an array of `fd_vote_stake_weight_t` structures where the function will store the ordered list of stake weights. The array must be large enough to hold all entries as specified by the vote accounts pool and root. Caller retains ownership.
- **Output**: Returns the number of items in the `weights` array, which is less than or equal to the number of vote accounts.
- **See Also**: [`fd_stake_weights_by_node`](<fd_stakes.c.md#fd_stake_weights_by_node>)  (Implementation)


---
### fd\_stakes\_activate\_epoch<!-- {{#callable_declaration:fd_stakes_activate_epoch}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stakes.h#L29>)

Activates stakes for a new epoch.
- **Description**: Use this function to activate stakes for a new epoch in the given bank. It updates the stake history and refreshes the stake values for vote accounts. This function must be called with valid bank, account database, transaction ID, capture context, and stake delegations. Ensure that the stake history sysvar is present in the system variable cache before calling this function.
- **Inputs**:
    - `bank`: A pointer to an `fd_bank_t` structure representing the bank where the epoch activation occurs. Must not be null.
    - `accdb`: A pointer to an `fd_accdb_user_t` structure representing the account database. Must not be null.
    - `xid`: A pointer to a `fd_funk_txn_xid_t` constant representing the transaction ID. Must not be null.
    - `capture_ctx`: A pointer to an `fd_capture_ctx_t` structure used for capturing context during the operation. Must not be null.
    - `stake_delegations`: A pointer to a constant `fd_stake_delegations_t` structure containing the stake delegations to process. Must not be null.
    - `new_rate_activation_epoch`: A pointer to an `ulong` where the function writes the new rate activation epoch. Must not be null.
- **Output**: None
- **See Also**: [`fd_stakes_activate_epoch`](<fd_stakes.c.md#fd_stakes_activate_epoch>)  (Implementation)


---
### stake\_and\_activating<!-- {{#callable_declaration:stake_and_activating}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stakes.h#L37>)

Calculates effective and activating stake for a given delegation and epoch.
- **Description**: Use this function to determine the effective and activating stake for a specific delegation at a given target epoch. This function requires a delegation, a target epoch, and optionally a stake history. It calculates the effective and activating stake based on the delegation's activation and deactivation epochs, as well as the provided stake history. If the delegation is not yet activated or is already deactivated, the function returns zero for both effective and activating stakes. If the target epoch is before the activation epoch, both values are also zero. The function updates the `new_rate_activation_epoch` to reflect the epoch at which a new rate becomes effective.
- **Inputs**:
    - `delegation`: A pointer to a `fd_delegation_t` structure representing the delegation. Must not be null.
    - `target_epoch`: An unsigned long representing the epoch for which to calculate the stake. Must be a valid epoch number.
    - `stake_history`: A pointer to a `fd_stake_history_t` structure containing the stake history. Can be null if no history is available.
    - `new_rate_activation_epoch`: A pointer to an unsigned long where the function will store the epoch at which a new rate becomes effective. Must not be null.
- **Output**: Returns an `fd_stake_history_entry_t` structure containing the effective and activating stake for the given delegation and epoch.
- **See Also**: [`stake_and_activating`](<../runtime/program/fd_stake_program.c.md#stake_and_activating>)  (Implementation)


---
### stake\_activating\_and\_deactivating<!-- {{#callable_declaration:stake_activating_and_deactivating}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stakes.h#L43>)

Calculate the effective, activating, and deactivating stake for a given epoch.
- **Description**: Use this function to determine the stake status for a specific epoch based on the delegation and stake history. It calculates the effective, activating, and deactivating stake amounts. This function is useful when you need to understand how stake changes over time, especially during epoch transitions. Ensure that the `delegation` parameter is valid and that `stake_history` is provided if historical stake data is needed. The function handles cases where the target epoch is before, at, or after the deactivation epoch, and it returns a structure with the calculated stake values.
- **Inputs**:
    - `delegation`: A pointer to a `fd_delegation_t` structure representing the stake delegation. Must not be null.
    - `target_epoch`: An unsigned long integer representing the epoch for which to calculate the stake status.
    - `stake_history`: A pointer to a `fd_stake_history_t` structure containing historical stake data. Can be null if historical data is not needed.
    - `new_rate_activation_epoch`: A pointer to an unsigned long integer where the function may store the epoch of new rate activation. Must not be null.
- **Output**: Returns a `fd_stake_history_entry_t` structure containing the effective, activating, and deactivating stake values for the specified epoch.
- **See Also**: [`stake_activating_and_deactivating`](<../runtime/program/fd_stake_program.c.md#stake_activating_and_deactivating>)  (Implementation)


---
### write\_stake\_state<!-- {{#callable_declaration:write_stake_state}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stakes.h#L49>)

Encodes and writes stake state data to a transaction account.
- **Description**: Use this function to encode the stake state data and write it to the specified transaction account. This function requires a valid transaction account and stake state object. It is important to ensure that the transaction account has sufficient space to store the encoded stake state data. The function does not handle errors internally, so the caller must ensure that the input parameters are valid and that the transaction account is prepared to receive the data.
- **Inputs**:
    - `stake_acc_rec`: A pointer to a `fd_txn_account_t` structure representing the transaction account where the stake state will be written. Must not be null and must point to a valid transaction account with sufficient space for the encoded data.
    - `stake_state`: A pointer to a `fd_stake_state_v2_t` structure containing the stake state data to encode and write. Must not be null and must point to a valid stake state object.
- **Output**: Returns 0 on successful encoding and writing of the stake state data.
- **See Also**: [`write_stake_state`](<fd_stakes.c.md#write_stake_state>)  (Implementation)


---
### fd\_refresh\_vote\_accounts<!-- {{#callable_declaration:fd_refresh_vote_accounts}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stakes.h#L53>)

Refreshes vote account stakes based on current stake delegations.
- **Description**: Use this function to update the stakes of vote accounts in a bank with the most current stake delegation values. It must be called with a valid bank object and current stake delegations. The function recalculates the stakes for each vote account and updates the total stake for the current epoch. It also caches stakes from two epochs prior for optimization purposes. Ensure that the bank and stake delegations are properly initialized before calling this function.
- **Inputs**:
    - `bank`: A pointer to an `fd_bank_t` object representing the bank where vote account stakes will be refreshed. Must not be null.
    - `stake_delegations`: A pointer to a constant `fd_stake_delegations_t` object containing the current stake delegations. Must not be null.
    - `history`: A pointer to a constant `fd_stake_history_t` object representing the stake history. Must not be null.
    - `new_rate_activation_epoch`: A pointer to an `ulong` where the function will store the new rate activation epoch. Must not be null.
- **Output**: None
- **See Also**: [`fd_refresh_vote_accounts`](<fd_stakes.c.md#fd_refresh_vote_accounts>)  (Implementation)


---
### fd\_stakes\_update\_stake\_delegation<!-- {{#callable_declaration:fd_stakes_update_stake_delegation}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stakes.h#L64>)

Updates the in-memory cache of stake delegations based on the stake account state.
- **Description**: Use this function to maintain the in-memory cache of stake delegations at the epoch boundary. It updates, inserts, or removes entries in the cache depending on the state of the provided stake account. The function must be called with a mutable stake account and a valid bank reference. If the stake account is not mutable, the function will return immediately without making any changes. Ensure that the stake account and bank are correctly initialized before calling this function.
- **Inputs**:
    - `stake_account`: A pointer to a `fd_txn_account_t` structure representing the stake account. The account must be mutable, and the caller retains ownership. If the account is not mutable, the function will return immediately.
    - `bank`: A pointer to a `fd_bank_t` structure representing the bank. The caller retains ownership, and the bank must be valid and initialized before calling this function.
- **Output**: None
- **See Also**: [`fd_stakes_update_stake_delegation`](<fd_stakes.c.md#fd_stakes_update_stake_delegation>)  (Implementation)


---
### fd\_stakes\_update\_vote\_state<!-- {{#callable_declaration:fd_stakes_update_vote_state}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stakes.h#L73>)

Maintains the in-memory cache of vote states based on the vote account state.
- **Description**: Use this function to update the in-memory cache of vote states at the epoch boundary. It modifies the cache by inserting, updating, or removing entries based on the current state of the provided vote account. This function must be called with a mutable vote account and a valid bank. If the vote account is not mutable, the function will return immediately without making any changes. The function also handles cases where the vote account has zero lamports or is not correctly initialized, removing the corresponding entry from the cache in such cases.
- **Inputs**:
    - `vote_account`: A pointer to a `fd_txn_account_t` structure representing the vote account. The account must be mutable. If the account is not mutable, the function will return immediately without making changes. The function expects the account to have a valid state and non-zero lamports to update the cache.
    - `bank`: A pointer to a `fd_bank_t` structure representing the bank. This parameter is used to access and modify the vote states cache. The caller must ensure that the bank is valid and properly initialized before calling this function.
- **Output**: None
- **See Also**: [`fd_stakes_update_vote_state`](<fd_stakes.c.md#fd_stakes_update_vote_state>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)