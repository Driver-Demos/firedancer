<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Manages stake delegations with functions for creation, updating, querying, and iteration.

# Purpose
The code defines a C module for managing stake delegations in a blockchain or distributed ledger system. It provides functionality to create, update, query, and delete stake delegations, which are associations between stake accounts and vote accounts. The module uses a pool and a map to manage these delegations, allowing efficient storage and retrieval. The pool is used to allocate and manage memory for the stake delegations, while the map provides a way to quickly look up delegations by their associated stake account public keys.

Key components of the module include functions for initializing and joining the stake delegation structures ([`fd_stake_delegations_new`](<#fd_stake_delegations_new>), [`fd_stake_delegations_join`](<#fd_stake_delegations_join>)), updating and removing delegations ([`fd_stake_delegations_update`](<#fd_stake_delegations_update>), [`fd_stake_delegations_remove`](<#fd_stake_delegations_remove>)), and querying the current state of delegations ([`fd_stake_delegations_query`](<#fd_stake_delegations_query>), [`fd_stake_delegations_cnt`](<#fd_stake_delegations_cnt>)). The module also includes functions for iterating over the delegations ([`fd_stake_delegations_iter_init`](<#fd_stake_delegations_iter_init>), [`fd_stake_delegations_iter_next`](<#fd_stake_delegations_iter_next>), [`fd_stake_delegations_iter_done`](<#fd_stake_delegations_iter_done>)). The code is designed to be integrated into a larger system, as indicated by the inclusion of other header files and the use of macros for configuration.
# Imports and Dependencies

---
- `fd_stake_delegations.h`
- `../../funk/fd_funk_base.h`
- `../runtime/fd_txn_account.h`
- `../runtime/program/fd_stake_program.h`
- `../../util/tmpl/fd_pool.c`
- `../../util/tmpl/fd_map_chain.c`


# Functions

---
### fd\_stake\_delegations\_get\_pool<!-- {{#callable:fd_stake_delegations_get_pool}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.c#L20>)

Retrieves a pointer to the stake delegation pool from a given stake delegations structure.
- **Inputs**:
    - `stake_delegations`: A pointer to a constant `fd_stake_delegations_t` structure, which contains information about the stake delegations.
- **Logic and Control Flow**:
    - Calculate the memory address of the stake delegation pool by adding the `pool_offset_` to the base address of `stake_delegations`.
    - Call `fd_stake_delegation_pool_join` with the calculated address to obtain a pointer to the stake delegation pool.
- **Output**: Returns a pointer to the `fd_stake_delegation_t` structure representing the stake delegation pool.


---
### fd\_stake\_delegations\_get\_map<!-- {{#callable:fd_stake_delegations_get_map}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.c#L25>)

Retrieves a pointer to the stake delegation map from a given stake delegations structure.
- **Inputs**:
    - `stake_delegations`: A pointer to a constant `fd_stake_delegations_t` structure, which contains information about stake delegations.
- **Logic and Control Flow**:
    - Calculate the address of the stake delegation map by adding the `map_offset_` to the base address of `stake_delegations`.
    - Call `fd_stake_delegation_map_join` with the calculated address to obtain a pointer to the stake delegation map.
- **Output**: A pointer to an `fd_stake_delegation_map_t` structure, representing the stake delegation map.


---
### fd\_stake\_delegations\_align<!-- {{#callable:fd_stake_delegations_align}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.c#L30>)

Calculates the alignment requirement for the `fd_stake_delegations_t` structure based on the maximum alignment of its contained data structures.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `fd_stake_delegation_map_align()` to get the alignment of the map structure.
    - Calls `fd_stake_delegation_pool_align()` to get the alignment of the pool structure.
    - Uses `alignof(fd_stake_delegations_t)` to get the alignment of the `fd_stake_delegations_t` structure itself.
    - Applies `fd_ulong_max` to determine the maximum alignment among the map, pool, and the structure itself.
    - Returns the maximum alignment value.
- **Output**: Returns an `ulong` representing the maximum alignment requirement for the `fd_stake_delegations_t` structure.


---
### fd\_stake\_delegations\_footprint<!-- {{#callable:fd_stake_delegations_footprint}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.c#L39>)

Calculates the memory footprint required for stake delegations based on the maximum number of stake accounts.
- **Inputs**:
    - `max_stake_accounts`: The maximum number of stake accounts to consider for the footprint calculation.
- **Logic and Control Flow**:
    - Call `fd_stake_delegation_map_chain_cnt_est` with `max_stake_accounts` to estimate the number of map chains needed.
    - Initialize `l` with `FD_LAYOUT_INIT`.
    - Append the alignment and size of `fd_stake_delegations_t` to `l` using `FD_LAYOUT_APPEND`.
    - Append the alignment and footprint of the stake delegation pool to `l` using `FD_LAYOUT_APPEND`.
    - Append the alignment and footprint of the stake delegation map to `l` using `FD_LAYOUT_APPEND`.
    - Finalize the layout with `FD_LAYOUT_FINI` and return the result.
- **Output**: Returns the total memory footprint in bytes required for the stake delegations.
- **Functions Called**:
    - [`fd_stake_delegations_align`](<#fd_stake_delegations_align>)


---
### fd\_stake\_delegations\_new<!-- {{#callable:fd_stake_delegations_new}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.c#L51>)

Initializes a new stake delegations structure in the provided memory space, setting up a pool and map for managing stake accounts.
- **Inputs**:
    - `mem`: A pointer to the memory space where the stake delegations structure will be initialized.
    - `max_stake_accounts`: The maximum number of stake accounts that the structure can manage.
    - `leave_tombstones`: A flag indicating whether to leave tombstones for removed stake delegations.
- **Logic and Control Flow**:
    - Check if `mem` is NULL and log a warning if true, then return NULL.
    - Check if `max_stake_accounts` is zero and log a warning if true, then return NULL.
    - Check if `mem` is aligned according to `fd_stake_delegations_align()` and log a warning if not, then return NULL.
    - Estimate the number of map chains needed using `fd_stake_delegation_map_chain_cnt_est()` with `max_stake_accounts`.
    - Initialize a scratch allocator with `FD_SCRATCH_ALLOC_INIT` using `mem`.
    - Allocate memory for `fd_stake_delegations_t`, pool, and map using `FD_SCRATCH_ALLOC_APPEND`.
    - Check if the final layout of allocations matches the expected footprint and log a warning if not, then return NULL.
    - Create a new stake delegations pool with `fd_stake_delegation_pool_new()` and log a warning if it fails, then return NULL.
    - Create a new stake delegations map with `fd_stake_delegation_map_new()` using a hardcoded seed and log a warning if it fails, then return NULL.
    - Set offsets and parameters in the `stake_delegations` structure.
    - Use memory fences to ensure memory operations are completed before setting the magic number.
    - Set the magic number in `stake_delegations` to `FD_STAKE_DELEGATIONS_MAGIC`.
    - Return the `mem` pointer.
- **Output**: Returns a pointer to the initialized memory space if successful, or NULL if any error occurs during initialization.
- **Functions Called**:
    - [`fd_stake_delegations_align`](<#fd_stake_delegations_align>)
    - [`fd_stake_delegations_footprint`](<#fd_stake_delegations_footprint>)


---
### fd\_stake\_delegations\_join<!-- {{#callable:fd_stake_delegations_join}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.c#L105>)

Initializes and validates a `fd_stake_delegations_t` structure from a given memory block, ensuring proper alignment and integrity before joining associated pool and map structures.
- **Inputs**:
    - `mem`: A pointer to a memory block that is expected to contain a `fd_stake_delegations_t` structure.
- **Logic and Control Flow**:
    - Check if `mem` is NULL and log a warning if true, then return NULL.
    - Verify if `mem` is properly aligned using `fd_stake_delegations_align()`; log a warning and return NULL if not aligned.
    - Cast `mem` to a `fd_stake_delegations_t` pointer and check if the `magic` field matches `FD_STAKE_DELEGATIONS_MAGIC`; log a warning and return NULL if it does not match.
    - Estimate the map chain count using `fd_stake_delegation_map_chain_cnt_est()` based on `max_stake_accounts_`.
    - Initialize a scratch allocator with `FD_SCRATCH_ALLOC_INIT` and append allocations for the `fd_stake_delegations_t`, pool, and map structures using `FD_SCRATCH_ALLOC_APPEND`.
    - Finalize the scratch allocation with `FD_SCRATCH_ALLOC_FINI` and check if the layout is correct; log a warning and return NULL if the layout is incorrect.
    - Attempt to join the pool using `fd_stake_delegation_pool_join()`; log a warning and return NULL if it fails.
    - Attempt to join the map using `fd_stake_delegation_map_join()`; log a warning and return NULL if it fails.
    - Return the `stake_delegations` pointer if all checks and joins are successful.
- **Output**: Returns a pointer to the initialized `fd_stake_delegations_t` structure if successful, or NULL if any validation or joining step fails.
- **Functions Called**:
    - [`fd_stake_delegations_align`](<#fd_stake_delegations_align>)
    - [`fd_stake_delegations_footprint`](<#fd_stake_delegations_footprint>)


---
### fd\_stake\_delegations\_leave<!-- {{#callable:fd_stake_delegations_leave}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.c#L149>)

Validates and returns a pointer to a `fd_stake_delegations_t` structure if it is correctly aligned and has a valid magic number.
- **Inputs**:
    - `self`: A pointer to a `fd_stake_delegations_t` structure to validate and return.
- **Logic and Control Flow**:
    - Check if `self` is NULL; if true, log a warning and return NULL.
    - Check if `self` is aligned according to `fd_stake_delegations_align()`; if not, log a warning and return NULL.
    - Cast `self` to a `fd_stake_delegations_t` pointer and store it in `stake_delegations`.
    - Check if `stake_delegations->magic` equals `FD_STAKE_DELEGATIONS_MAGIC`; if not, log a warning and return NULL.
    - Return `self` cast to a `void *`.
- **Output**: Returns a `void *` pointer to the validated `fd_stake_delegations_t` structure, or NULL if validation fails.
- **Functions Called**:
    - [`fd_stake_delegations_align`](<#fd_stake_delegations_align>)


---
### fd\_stake\_delegations\_delete<!-- {{#callable:fd_stake_delegations_delete}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.c#L171>)

Deletes a stake delegation by validating and resetting its magic number.
- **Inputs**:
    - ``mem``: A pointer to the memory location of the stake delegation to delete.
- **Logic and Control Flow**:
    - Check if `mem` is NULL and log a warning if true, then return NULL.
    - Check if `mem` is aligned according to `fd_stake_delegations_align()` and log a warning if not, then return NULL.
    - Cast `mem` to a `fd_stake_delegations_t` pointer named `stake_delegations`.
    - Check if `stake_delegations->magic` is equal to `FD_STAKE_DELEGATIONS_MAGIC` and log a warning if not, then return NULL.
    - Set `stake_delegations->magic` to 0UL to mark it as deleted.
    - Return the `mem` pointer.
- **Output**: Returns the original `mem` pointer if successful, or NULL if any validation fails.
- **Functions Called**:
    - [`fd_stake_delegations_align`](<#fd_stake_delegations_align>)


---
### fd\_stake\_delegations\_update<!-- {{#callable:fd_stake_delegations_update}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.c#L195>)

Updates or adds a stake delegation entry in the stake delegation pool and map.
- **Inputs**:
    - `stake_delegations`: A pointer to the `fd_stake_delegations_t` structure that contains the stake delegation pool and map.
    - `stake_account`: A constant pointer to the `fd_pubkey_t` structure representing the stake account public key.
    - `vote_account`: A constant pointer to the `fd_pubkey_t` structure representing the vote account public key.
    - `stake`: An unsigned long integer representing the amount of stake.
    - `activation_epoch`: An unsigned long integer representing the epoch when the stake becomes active.
    - `deactivation_epoch`: An unsigned long integer representing the epoch when the stake becomes inactive.
    - `credits_observed`: An unsigned long integer representing the credits observed for the stake.
    - `warmup_cooldown_rate`: A double representing the rate of warmup or cooldown for the stake.
- **Logic and Control Flow**:
    - Retrieve the stake delegation pool and map from `stake_delegations`.
    - Check if the stake delegation already exists by querying the map with `stake_account`.
    - If the delegation exists, update its fields with the provided values and set `is_tombstone` to 0.
    - If the delegation does not exist, check if there is a free slot in the pool.
    - Acquire a new stake delegation element from the pool and populate it with the provided values.
    - Insert the new stake delegation into the map.
- **Output**: No return value; the function updates the stake delegation pool and map in place.
- **Functions Called**:
    - [`fd_stake_delegations_get_pool`](<#fd_stake_delegations_get_pool>)
    - [`fd_stake_delegations_get_map`](<#fd_stake_delegations_get_map>)


---
### fd\_stake\_delegations\_remove<!-- {{#callable:fd_stake_delegations_remove}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.c#L271>)

Removes a stake delegation from the map and pool, optionally leaving a tombstone entry.
- **Inputs**:
    - `stake_delegations`: A pointer to the `fd_stake_delegations_t` structure that contains the stake delegations.
    - `stake_account`: A constant pointer to the `fd_pubkey_t` structure representing the stake account to remove.
- **Logic and Control Flow**:
    - Retrieve the stake delegation pool using [`fd_stake_delegations_get_pool`](<#fd_stake_delegations_get_pool>) and check for errors.
    - Retrieve the stake delegation map using [`fd_stake_delegations_get_map`](<#fd_stake_delegations_get_map>) and check for errors.
    - Query the index of the stake delegation in the map using `fd_stake_delegation_map_idx_query`.
    - If `leave_tombstones_` is set to 1, update the `is_tombstone` flag of the existing entry or insert a new entry with the flag set.
    - If `leave_tombstones_` is not set, remove the entry from the map and release it from the pool, ensuring the `next_` pointer is set to null.
- **Output**: No return value; the function modifies the stake delegations in place.
- **Functions Called**:
    - [`fd_stake_delegations_get_pool`](<#fd_stake_delegations_get_pool>)
    - [`fd_stake_delegations_get_map`](<#fd_stake_delegations_get_map>)


---
### fd\_stake\_delegations\_refresh<!-- {{#callable:fd_stake_delegations_refresh}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.c#L332>)

Refreshes the stake delegations by iterating through each stake account, checking its validity, and updating or removing it as necessary.
- **Inputs**:
    - `stake_delegations`: A pointer to the `fd_stake_delegations_t` structure that contains the stake delegations to refresh.
    - `funk`: A pointer to the `fd_funk_t` structure used for reading account data.
    - `xid`: A constant pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID for the read operation.
- **Logic and Control Flow**:
    - Retrieve the stake delegation map and pool using [`fd_stake_delegations_get_map`](<#fd_stake_delegations_get_map>) and [`fd_stake_delegations_get_pool`](<#fd_stake_delegations_get_pool>) functions.
    - Iterate over each stake account in the `stake_delegations` up to `max_stake_accounts_`.
    - For each stake account, check if it exists in the map using `fd_stake_delegation_map_ele_query_const`. If not, skip to the next account.
    - Initialize a transaction account record using `fd_txn_account_init_from_funk_readonly`. If an error occurs or the account has zero lamports, remove the stake delegation from the map and release it from the pool.
    - Retrieve the stake state using `fd_stake_get_state`. If an error occurs or the state is not a stake, remove the stake delegation from the map and release it from the pool.
    - Update the stake delegations using [`fd_stake_delegations_update`](<#fd_stake_delegations_update>) with the retrieved stake state information.
- **Output**: No direct output is returned, but the function updates the `stake_delegations` structure by refreshing its entries.
- **Functions Called**:
    - [`fd_stake_delegations_get_map`](<#fd_stake_delegations_get_map>)
    - [`fd_stake_delegations_get_pool`](<#fd_stake_delegations_get_pool>)
    - [`fd_stake_delegations_update`](<#fd_stake_delegations_update>)


---
### fd\_stake\_delegations\_query<!-- {{#callable:fd_stake_delegations_query}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.c#L398>)

Queries a stake delegation for a given stake account from a set of stake delegations.
- **Inputs**:
    - `stake_delegations`: A pointer to a `fd_stake_delegations_t` structure representing the set of stake delegations to query.
    - `stake_account`: A pointer to a `fd_pubkey_t` structure representing the public key of the stake account to query.
- **Logic and Control Flow**:
    - Check if `stake_delegations` is NULL; if so, log a critical error and return NULL.
    - Check if `stake_account` is NULL; if so, log a critical error and return NULL.
    - Retrieve the stake delegation pool using [`fd_stake_delegations_get_pool`](<#fd_stake_delegations_get_pool>); log a critical error if retrieval fails.
    - Retrieve the stake delegation map using [`fd_stake_delegations_get_map`](<#fd_stake_delegations_get_map>); log a critical error if retrieval fails.
    - Query the stake delegation map for the given `stake_account` using `fd_stake_delegation_map_ele_query_const` and return the result.
- **Output**: A pointer to a `fd_stake_delegation_t` structure representing the queried stake delegation, or NULL if an error occurs.
- **Functions Called**:
    - [`fd_stake_delegations_get_pool`](<#fd_stake_delegations_get_pool>)
    - [`fd_stake_delegations_get_map`](<#fd_stake_delegations_get_map>)


---
### fd\_stake\_delegations\_cnt<!-- {{#callable:fd_stake_delegations_cnt}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.c#L429>)

Counts the number of used stake delegations in a given stake delegation pool.
- **Inputs**:
    - `stake_delegations`: A pointer to a `fd_stake_delegations_t` structure representing the stake delegations to be counted.
- **Logic and Control Flow**:
    - Checks if `stake_delegations` is NULL and logs a critical error if true.
    - Retrieves the stake delegation pool using [`fd_stake_delegations_get_pool`](<#fd_stake_delegations_get_pool>).
    - Checks if the retrieved stake delegation pool is NULL and logs a critical error if true.
    - Returns the number of used stake delegations by calling `fd_stake_delegation_pool_used` with the retrieved pool.
- **Output**: Returns an unsigned long integer representing the count of used stake delegations.
- **Functions Called**:
    - [`fd_stake_delegations_get_pool`](<#fd_stake_delegations_get_pool>)


---
### fd\_stake\_delegations\_iter\_ele<!-- {{#callable:fd_stake_delegations_iter_ele}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.c#L443>)

Retrieves the current element from a stake delegation iterator.
- **Inputs**:
    - `iter`: A pointer to an `fd_stake_delegations_iter_t` structure, which contains the state of the iteration over stake delegations.
- **Logic and Control Flow**:
    - Call `fd_stake_delegation_map_iter_idx` with `iter->iter`, `iter->map`, and `iter->pool` to get the current index of the iteration.
    - Use the index to retrieve the corresponding element from the pool by calling `fd_stake_delegation_pool_ele` with `iter->pool` and the index.
- **Output**: A pointer to an `fd_stake_delegation_t` structure representing the current element in the iteration.


---
### fd\_stake\_delegations\_iter\_init<!-- {{#callable:fd_stake_delegations_iter_init}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.c#L449>)

Initializes an iterator for iterating over stake delegations.
- **Inputs**:
    - ``iter``: A pointer to an `fd_stake_delegations_iter_t` structure that will be initialized.
    - ``stake_delegations``: A constant pointer to an `fd_stake_delegations_t` structure containing the stake delegations to iterate over.
- **Logic and Control Flow**:
    - Check if `stake_delegations` is NULL and log a critical error if it is.
    - Retrieve the map from `stake_delegations` using [`fd_stake_delegations_get_map`](<#fd_stake_delegations_get_map>) and assign it to `iter->map`.
    - Retrieve the pool from `stake_delegations` using [`fd_stake_delegations_get_pool`](<#fd_stake_delegations_get_pool>) and assign it to `iter->pool`.
    - Initialize the iterator using `fd_stake_delegation_map_iter_init` with the map and pool, and assign it to `iter->iter`.
- **Output**: Returns the initialized `fd_stake_delegations_iter_t` pointer.
- **Functions Called**:
    - [`fd_stake_delegations_get_map`](<#fd_stake_delegations_get_map>)
    - [`fd_stake_delegations_get_pool`](<#fd_stake_delegations_get_pool>)


---
### fd\_stake\_delegations\_iter\_next<!-- {{#callable:fd_stake_delegations_iter_next}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.c#L463>)

Advances the iterator to the next element in the stake delegation map.
- **Inputs**:
    - `iter`: A pointer to an `fd_stake_delegations_iter_t` structure, which contains the current state of the iteration over the stake delegation map.
- **Logic and Control Flow**:
    - Calls `fd_stake_delegation_map_iter_next` with the current iterator, map, and pool from the `iter` structure.
    - Updates the `iter` structure's `iter` field with the result from `fd_stake_delegation_map_iter_next`.
- **Output**: No return value; the function updates the `iter` structure in place.


---
### fd\_stake\_delegations\_iter\_done<!-- {{#callable:fd_stake_delegations_iter_done}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.c#L468>)

Checks if the iteration over stake delegations is complete.
- **Inputs**:
    - ``iter``: A pointer to an `fd_stake_delegations_iter_t` structure, which holds the current state of the iteration over stake delegations.
- **Logic and Control Flow**:
    - Calls `fd_stake_delegation_map_iter_done` with the current iterator, map, and pool from the `iter` structure.
    - Returns the result of `fd_stake_delegation_map_iter_done`, indicating whether the iteration is complete.
- **Output**: An integer indicating whether the iteration is complete (non-zero if done, zero if not done).



---
Made with ❤️ by [Driver](https://www.driver.ai/)