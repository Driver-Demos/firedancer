<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines a hash map-based cache for managing stake delegations, including functions for creation, update, and iteration.

# Purpose
The code defines a C header file for managing stake delegations in a system, likely related to a blockchain or distributed ledger. The primary data structure, `fd_stake_delegations_t`, is a cache that maps public keys of stake accounts to various attributes such as stake amount, activation and deactivation epochs, and associated vote accounts. This cache is implemented as a hash map backed by a memory pool, allowing for efficient iteration and updates during epoch boundary reward calculations. The code provides functions to create, update, remove, and query stake delegations, as well as to manage the memory footprint of these operations. The header also defines constants and macros to calculate the maximum number of stake accounts that can be modified in a transaction or slot, based on computational unit (CU) consumption.

The file includes several forward declarations and function prototypes for managing the lifecycle of the `fd_stake_delegations_t` structure, including creating new instances, joining and leaving memory regions, and refreshing the cache. It also provides an iterator API for traversing the stake delegations. The code supports two modes of operation: with and without tombstones, which are used to mark entries for future reference without removing them from the map. This functionality is crucial for maintaining consistency and efficiency in systems where stake accounts are frequently updated, such as during transaction execution or rewards distribution.
# Imports and Dependencies

---
- `../rewards/fd_rewards_base.h`
- `../runtime/fd_cost_tracker.h`
- `../../disco/pack/fd_pack.h`
- `../../disco/pack/fd_pack_cost.h`
- `../../util/tmpl/fd_map.h`


# Data Structures

---
### fd\_stake\_delegation
- **Type**: ``struct``
- **Members**:
    - `stake_account`: Holds the public key of the stake account.
    - `vote_account`: Holds the public key of the vote account.
    - `next_`: Used internally for pool/map operations.
    - `stake`: Represents the amount of stake.
    - `activation_epoch`: Indicates the epoch when the stake becomes active.
    - `deactivation_epoch`: Indicates the epoch when the stake becomes inactive.
    - `credits_observed`: Tracks the credits observed for the stake account.
    - `warmup_cooldown_rate`: Specifies the rate of warmup or cooldown for the stake.
    - `is_tombstone`: Indicates if the entry is a tombstone.
- **Description**: Represents a stake delegation, containing information about the stake and vote accounts, stake amount, activation and deactivation epochs, credits observed, warmup/cooldown rate, and a tombstone flag for internal management.


---
### fd\_stake\_delegation\_t
- **Type**: ``struct``
- **Members**:
    - ``stake_account``: Holds the public key of the stake account.
    - ``vote_account``: Holds the public key of the vote account.
    - ``next_``: Used internally for pool/map operations.
    - ``stake``: Represents the amount of stake.
    - ``activation_epoch``: Indicates the epoch when the stake becomes active.
    - ``deactivation_epoch``: Indicates the epoch when the stake becomes inactive.
    - ``credits_observed``: Tracks the credits observed for the stake account.
    - ``warmup_cooldown_rate``: Specifies the rate of warmup or cooldown for the stake.
    - ``is_tombstone``: Flags if the entry is a tombstone.
- **Description**: Represents a stake delegation entry in a system that manages stake accounts, mapping each stake account's public key to its associated vote account, stake amount, activation and deactivation epochs, credits observed, and warmup/cooldown rate. The `is_tombstone` field indicates if the entry is marked as a tombstone, which is used for delta updates without removing the entry from the map.


---
### fd\_stake\_delegations
- **Type**: ``struct``
- **Members**:
    - `magic`: A unique identifier for the `fd_stake_delegations` structure.
    - `map_offset_`: The offset to the map within the memory pool.
    - `pool_offset_`: The offset to the pool within the memory pool.
    - `max_stake_accounts_`: The maximum number of stake accounts that can be managed.
    - `leave_tombstones_`: A flag indicating whether to leave tombstones in the map when entries are removed.
- **Description**: The `fd_stake_delegations` structure is a hash map backed by a memory pool, used to cache stake accounts and map their public keys to various information such as stake, activation/deactivation epoch, and vote account. It supports operations like insertion, replacement, and removal of entries, and can operate in two modes: with or without tombstones. The structure is used to efficiently iterate through stake delegations during epoch boundary reward calculations and is updated during bootup, transaction execution, and rewards distribution.


---
### fd\_stake\_delegations\_t
- **Type**: ``struct``
- **Members**:
    - `magic`: A unique identifier for the `fd_stake_delegations` structure.
    - `map_offset_`: The offset to the hash map within the memory pool.
    - `pool_offset_`: The offset to the memory pool for stake delegations.
    - `max_stake_accounts_`: The maximum number of stake accounts that can be managed.
    - `leave_tombstones_`: A flag indicating if tombstones should be left in the map when entries are removed.
- **Description**: Caches stake accounts by mapping their public keys to various information such as stake, activation/deactivation epochs, and vote accounts. It uses a hash map backed by a memory pool and supports operations like insertion, replacement, and removal of entries. The structure can operate in two modes: with or without tombstones, which affects how entries are removed. It is used to efficiently iterate through stake delegations during epoch boundary reward calculations and is updated during bootup, transaction execution, and rewards distribution.


---
### fd\_stake\_delegation\_map\_t
- **Type**: ``fd_stake_delegation_map_t``
- **Members**:
    - ``fd_stake_delegation_map_private``: A private structure used to define `fd_stake_delegation_map_t`.
- **Description**: `fd_stake_delegation_map_t` is a typedef for a private structure `fd_stake_delegation_map_private`, which is part of the implementation of a hash map used to manage stake delegations. This data structure is used internally to handle the mapping of stake accounts to their respective delegations, allowing for efficient insertion, replacement, and removal of entries. It is a key component in managing stake delegations within the system, particularly during epoch boundary reward calculations.


---
### fd\_stake\_delegation\_map\_iter\_t
- **Type**: `typedef struct`
- **Members**:
    - `map`: Pointer to a `fd_stake_delegation_map_t` structure.
    - `pool`: Pointer to a `fd_stake_delegation_t` structure.
    - `iter`: Instance of `fd_stake_delegation_map_iter_t` for iteration.
- **Description**: Facilitates iteration over stake delegations by wrapping an iterator from `fd_map_chain.c`. It holds pointers to the map and pool of stake delegations and uses an internal iterator to traverse the data structure.


---
### fd\_stake\_delegations\_iter
- **Type**: ``struct``
- **Members**:
    - `map`: A pointer to a `fd_stake_delegation_map_t` structure.
    - `pool`: A pointer to a `fd_stake_delegation_t` structure.
    - `iter`: An instance of `fd_stake_delegation_map_iter_t` used for iteration.
- **Description**: Facilitates iteration over stake delegations by encapsulating a map, a pool, and an iterator. It is used to traverse the stake delegations stored in a `fd_stake_delegations_t` structure, allowing access to each delegation entry in the map.


---
### fd\_stake\_delegations\_iter\_t
- **Type**: ``struct``
- **Members**:
    - `map`: Pointer to a `fd_stake_delegation_map_t` structure.
    - `pool`: Pointer to a `fd_stake_delegation_t` structure.
    - `iter`: Instance of `fd_stake_delegation_map_iter_t` for iteration.
- **Description**: Facilitates iteration over stake delegations by encapsulating a map, a pool, and an iterator. It is used to traverse the stake delegations stored in a `fd_stake_delegations_t` structure, allowing access to each stake delegation entry. The iterator is initialized with a call to `fd_stake_delegations_iter_init` and can be used to navigate through the entries using `fd_stake_delegations_iter_next` and `fd_stake_delegations_iter_ele` functions.


# Functions

---
### fd\_stake\_delegations\_max<!-- {{#callable:fd_stake_delegations_max}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.h#L303>)

Returns the maximum number of stake accounts that can be managed by the given `fd_stake_delegations_t` structure.
- **Inputs**:
    - `stake_delegations`: A pointer to a constant `fd_stake_delegations_t` structure, which holds information about stake delegations.
- **Logic and Control Flow**:
    - Checks if the `stake_delegations` pointer is NULL using the `FD_UNLIKELY` macro.
    - Logs a critical error message if `stake_delegations` is NULL using `FD_LOG_CRIT`.
    - Returns the `max_stake_accounts_` field from the `stake_delegations` structure.
- **Output**: The function returns an unsigned long integer representing the maximum number of stake accounts.


# Function Declarations (Public API)

---
### fd\_stake\_delegations\_align<!-- {{#callable_declaration:fd_stake_delegations_align}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.h#L181>)

Returns the alignment requirement of the stake delegations structure.
- **Description**: Use this function to obtain the alignment requirement for the `fd_stake_delegations_t` structure. This is useful when allocating memory for this structure to ensure proper alignment, which is necessary for correct operation on many platforms. The function does not require any parameters and can be called at any time to retrieve the alignment value.
- **Inputs**: None
- **Output**: The function returns an `ulong` representing the alignment requirement of the `fd_stake_delegations_t` structure.
- **See Also**: [`fd_stake_delegations_align`](<fd_stake_delegations.c.md#fd_stake_delegations_align>)  (Implementation)


---
### fd\_stake\_delegations\_footprint<!-- {{#callable_declaration:fd_stake_delegations_footprint}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.h#L192>)

Calculates the memory footprint for stake delegations.
- **Description**: Use this function to determine the memory size required for a stake delegations structure based on the maximum number of stake accounts. This is useful for allocating memory before creating a new stake delegations structure. Ensure that the input value is within the expected range for the number of stake accounts to avoid incorrect memory calculations.
- **Inputs**:
    - `max_stake_accounts`: Specifies the maximum number of stake accounts. Must be a positive integer. If the value is invalid, the function may return an incorrect footprint size.
- **Output**: Returns the calculated memory footprint in bytes as an unsigned long integer.
- **See Also**: [`fd_stake_delegations_footprint`](<fd_stake_delegations.c.md#fd_stake_delegations_footprint>)  (Implementation)


---
### fd\_stake\_delegations\_new<!-- {{#callable_declaration:fd_stake_delegations_new}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.h#L201>)

Creates a new stake delegations structure in a specified memory region.
- **Description**: Use this function to initialize a stake delegations structure in a pre-allocated memory region. The function requires the memory to be aligned according to the alignment requirements of the stake delegations structure. It also requires a non-zero maximum number of stake accounts. The function can configure the structure to leave tombstones, which is useful for delta updates. If any precondition is not met, the function returns NULL and logs a warning.
- **Inputs**:
    - `mem`: A pointer to a pre-allocated memory region where the stake delegations structure will be created. Must not be null and must be aligned according to `fd_stake_delegations_align()`.
    - `max_stake_accounts`: The maximum number of stake accounts the structure can handle. Must be greater than zero.
    - `leave_tombstones`: An integer flag indicating whether to leave tombstones in the map. Non-zero values enable tombstones.
- **Output**: Returns a pointer to the initialized memory region if successful, or NULL if any precondition is not met.
- **See Also**: [`fd_stake_delegations_new`](<fd_stake_delegations.c.md#fd_stake_delegations_new>)  (Implementation)


---
### fd\_stake\_delegations\_join<!-- {{#callable_declaration:fd_stake_delegations_join}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.h#L211>)

Joins a stake delegations structure from a memory region.
- **Description**: Use this function to access a stake delegations structure that is stored in a specified memory region. Ensure that the memory region is properly aligned and initialized with a valid stake delegations structure before calling this function. The function checks for a valid magic number to confirm the integrity of the structure. If the memory is null, misaligned, or contains an invalid structure, the function returns null. This function does not handle thread safety, so ensure that memory access is managed appropriately in concurrent environments.
- **Inputs**:
    - `mem`: A pointer to the memory region containing the stake delegations structure. Must not be null and must be aligned according to `fd_stake_delegations_align()`. The memory must contain a valid stake delegations structure with the correct magic number.
- **Output**: Returns a pointer to the `fd_stake_delegations_t` structure if successful, or null if the memory is invalid or misaligned.
- **See Also**: [`fd_stake_delegations_join`](<fd_stake_delegations.c.md#fd_stake_delegations_join>)  (Implementation)


---
### fd\_stake\_delegations\_leave<!-- {{#callable_declaration:fd_stake_delegations_leave}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.h#L217>)

Returns a pointer to a stake delegations struct if valid.
- **Description**: Use this function to obtain a pointer to a stake delegations struct from a memory region. Ensure that the input pointer is not null, is properly aligned, and that the struct has a valid magic number before calling this function. This function is useful when you need to access the stake delegations struct after it has been joined from memory. If any of these conditions are not met, the function will return null and log a warning.
- **Inputs**:
    - `self`: A pointer to a `fd_stake_delegations_t` struct. Must not be null, must be aligned according to `fd_stake_delegations_align()`, and must have a valid magic number (`FD_STAKE_DELEGATIONS_MAGIC`). If these conditions are not met, the function returns null and logs a warning.
- **Output**: Returns a pointer to the `fd_stake_delegations_t` struct if the input is valid; otherwise, returns null.
- **See Also**: [`fd_stake_delegations_leave`](<fd_stake_delegations.c.md#fd_stake_delegations_leave>)  (Implementation)


---
### fd\_stake\_delegations\_delete<!-- {{#callable_declaration:fd_stake_delegations_delete}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.h#L223>)

Unformats a memory region previously formatted by `fd_stake_delegations_new`.
- **Description**: Use this function to unformat a memory region that was previously formatted by `fd_stake_delegations_new`. This function checks if the provided memory pointer is non-null, properly aligned, and contains a valid stake delegations structure. If any of these conditions are not met, the function logs a warning and returns `NULL`. If successful, it resets the magic number of the stake delegations structure to zero and returns the original memory pointer. Ensure that the memory region is correctly formatted and aligned before calling this function.
- **Inputs**:
    - `mem`: A pointer to the memory region to unformat. Must not be null, must be aligned according to `fd_stake_delegations_align`, and must contain a valid stake delegations structure. If these conditions are not met, the function returns `NULL`.
- **Output**: Returns the original memory pointer if successful, or `NULL` if the input is invalid.
- **See Also**: [`fd_stake_delegations_delete`](<fd_stake_delegations.c.md#fd_stake_delegations_delete>)  (Implementation)


---
### fd\_stake\_delegations\_update<!-- {{#callable_declaration:fd_stake_delegations_update}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.h#L234>)

Updates or inserts a stake delegation entry.
- **Description**: Use this function to update an existing stake delegation entry or insert a new one if it does not exist. This function requires a valid `fd_stake_delegations_t` structure that has been properly initialized and joined. It can be called while iterating over the map, but only for keys that already exist. Ensure that the `stake_delegations` parameter is not null and represents a valid local join. The function will override any existing data for the specified `stake_account`.
- **Inputs**:
    - `stake_delegations`: A pointer to a `fd_stake_delegations_t` structure. Must not be null and must be a valid local join.
    - `stake_account`: A pointer to a `fd_pubkey_t` representing the stake account's public key. Must not be null.
    - `vote_account`: A pointer to a `fd_pubkey_t` representing the vote account's public key. Must not be null.
    - `stake`: An unsigned long representing the amount of stake. No specific range is enforced.
    - `activation_epoch`: An unsigned long representing the epoch when the stake becomes active. No specific range is enforced.
    - `deactivation_epoch`: An unsigned long representing the epoch when the stake becomes inactive. No specific range is enforced.
    - `credits_observed`: An unsigned long representing the credits observed. No specific range is enforced.
    - `warmup_cooldown_rate`: A double representing the rate of warmup or cooldown. No specific range is enforced.
- **Output**: None
- **See Also**: [`fd_stake_delegations_update`](<fd_stake_delegations.c.md#fd_stake_delegations_update>)  (Implementation)


---
### fd\_stake\_delegations\_remove<!-- {{#callable_declaration:fd_stake_delegations_remove}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.h#L254>)

Removes a stake delegation for a given stake account.
- **Description**: Use this function to remove a stake delegation associated with a specific stake account's public key from the stake delegations structure. This function must be called on a valid local join of `fd_stake_delegations_t`. If the `leave_tombstones` flag is set, the function will not remove the entry but will mark it as a tombstone instead. If the delegation does not exist, a tombstone is inserted. If the flag is not set and the delegation does not exist, the function does nothing.
- **Inputs**:
    - `stake_delegations`: A pointer to a `fd_stake_delegations_t` structure. This must be a valid local join and must not be null.
    - `stake_account`: A pointer to a `fd_pubkey_t` representing the public key of the stake account. This must not be null.
- **Output**: None
- **See Also**: [`fd_stake_delegations_remove`](<fd_stake_delegations.c.md#fd_stake_delegations_remove>)  (Implementation)


---
### fd\_stake\_delegations\_query<!-- {{#callable_declaration:fd_stake_delegations_query}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.h#L263>)

Retrieves a stake delegation for a given stake account public key.
- **Description**: Use this function to obtain the stake delegation associated with a specific stake account public key from a given stake delegations structure. This function is useful when you need to access the details of a stake delegation, such as during reward calculations or account management. Ensure that the `stake_delegations` structure is a valid local join before calling this function. If the specified stake account does not exist in the structure, the function returns `NULL`. Handle `NULL` returns appropriately to avoid dereferencing null pointers.
- **Inputs**:
    - `stake_delegations`: A pointer to a `fd_stake_delegations_t` structure representing the collection of stake delegations. Must not be null. The structure must be a valid local join.
    - `stake_account`: A pointer to a `fd_pubkey_t` representing the public key of the stake account to query. Must not be null.
- **Output**: Returns a pointer to a `fd_stake_delegation_t` structure if the stake account exists in the delegations; otherwise, returns `NULL`.
- **See Also**: [`fd_stake_delegations_query`](<fd_stake_delegations.c.md#fd_stake_delegations_query>)  (Implementation)


---
### fd\_stake\_delegations\_refresh<!-- {{#callable_declaration:fd_stake_delegations_refresh}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.h#L287>)

Refreshes the stake delegations by removing invalid entries.
- **Description**: Use this function to update the state of stake delegations by removing entries that are no longer valid. This function should be called after the snapshot has finished loading and before any slots are executed. It ensures that the stake delegations do not contain any invalid entries, such as those with zero balance or incorrect state. The function does not add new entries to the stake delegations.
- **Inputs**:
    - `stake_delegations`: A pointer to an `fd_stake_delegations_t` structure. This must be a valid local join and must not be null. The caller retains ownership.
    - `funk`: A pointer to an `fd_funk_t` structure representing the database handle. This must not be null. The caller retains ownership.
    - `xid`: A pointer to a constant `fd_funk_txn_xid_t` structure. This must not be null. The caller retains ownership.
- **Output**: None
- **See Also**: [`fd_stake_delegations_refresh`](<fd_stake_delegations.c.md#fd_stake_delegations_refresh>)  (Implementation)


---
### fd\_stake\_delegations\_cnt<!-- {{#callable_declaration:fd_stake_delegations_cnt}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.h#L300>)

Returns the number of stake delegations in the given structure.
- **Description**: Use this function to get the count of stake delegations present in a `fd_stake_delegations_t` structure. This count includes entries marked as tombstones if the `leave_tombstones` flag is set. Ensure that the `fd_stake_delegations_t` structure is a valid local join before calling this function. The function will log a critical error if the input is null.
- **Inputs**:
    - `stake_delegations`: A pointer to a `fd_stake_delegations_t` structure. Must not be null. The caller retains ownership of the structure.
- **Output**: Returns the number of stake delegations in the structure, including tombstones if applicable.
- **See Also**: [`fd_stake_delegations_cnt`](<fd_stake_delegations.c.md#fd_stake_delegations_cnt>)  (Implementation)


---
### fd\_stake\_delegations\_iter\_ele<!-- {{#callable_declaration:fd_stake_delegations_iter_ele}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.h#L336>)

Retrieves the current stake delegation from the iterator.
- **Description**: Use this function to access the current stake delegation pointed to by the iterator. It is typically called within an iteration loop to process each stake delegation in a collection. Ensure that the iterator is properly initialized and not at the end of the collection before calling this function. The caller can modify the returned stake delegation, but must not alter the `next_` field.
- **Inputs**:
    - `iter`: A pointer to an `fd_stake_delegations_iter_t` structure. This must be a valid and initialized iterator. The function assumes the iterator is not null and is within valid bounds of the collection.
- **Output**: Returns a pointer to the current `fd_stake_delegation_t` structure in the iteration. The caller can modify the returned structure, except for the `next_` field.
- **See Also**: [`fd_stake_delegations_iter_ele`](<fd_stake_delegations.c.md#fd_stake_delegations_iter_ele>)  (Implementation)


---
### fd\_stake\_delegations\_iter\_init<!-- {{#callable_declaration:fd_stake_delegations_iter_init}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.h#L339>)

Initialize an iterator for stake delegations.
- **Description**: Use this function to prepare an iterator for traversing stake delegations. It must be called before using the iterator to access or modify stake delegations. Ensure that `stake_delegations` is not null before calling this function, as a null value will result in a critical error. The caller is responsible for managing the memory of the iterator.
- **Inputs**:
    - `iter`: A pointer to an `fd_stake_delegations_iter_t` structure that will be initialized. The caller must allocate this structure before calling the function.
    - `stake_delegations`: A pointer to a constant `fd_stake_delegations_t` structure representing the stake delegations to iterate over. Must not be null.
- **Output**: Returns a pointer to the initialized `fd_stake_delegations_iter_t` structure.
- **See Also**: [`fd_stake_delegations_iter_init`](<fd_stake_delegations.c.md#fd_stake_delegations_iter_init>)  (Implementation)


---
### fd\_stake\_delegations\_iter\_next<!-- {{#callable_declaration:fd_stake_delegations_iter_next}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.h#L343>)

Advances the iterator to the next stake delegation.
- **Description**: Use this function to move the iterator to the next element in the stake delegations map. This function is part of the iteration process over stake delegations and should be called repeatedly until the iteration is complete. Ensure that the iterator is properly initialized and not at the end of the collection before calling this function.
- **Inputs**:
    - `iter`: A pointer to an `fd_stake_delegations_iter_t` structure. This must be a valid iterator that has been initialized with `fd_stake_delegations_iter_init`. The caller retains ownership and must ensure it is not null.
- **Output**: None
- **See Also**: [`fd_stake_delegations_iter_next`](<fd_stake_delegations.c.md#fd_stake_delegations_iter_next>)  (Implementation)


---
### fd\_stake\_delegations\_iter\_done<!-- {{#callable_declaration:fd_stake_delegations_iter_done}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stake_delegations.h#L346>)

Checks if the stake delegations iterator has completed.
- **Description**: Use this function to determine if the iteration over stake delegations is complete. It is typically called within a loop to check the termination condition for iterating over stake delegations. The function requires a valid iterator, which must be initialized before use. It is safe to call this function repeatedly to check the iteration status.
- **Inputs**:
    - `iter`: A pointer to a `fd_stake_delegations_iter_t` structure. This must be a valid and initialized iterator. The function does not modify the iterator, and the caller retains ownership.
- **Output**: Returns a non-zero value if the iteration is complete, otherwise returns zero.
- **See Also**: [`fd_stake_delegations_iter_done`](<fd_stake_delegations.c.md#fd_stake_delegations_iter_done>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)