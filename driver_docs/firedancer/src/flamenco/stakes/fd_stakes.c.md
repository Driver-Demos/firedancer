<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for managing stake weights, refreshing vote accounts, activating epochs, and updating stake and vote states in a bank system.

# Purpose
The code is a C module that manages and updates stake and vote states within a financial or blockchain system. It includes functions to calculate and sort stake weights by node, refresh vote accounts based on the latest stake delegations, activate stakes for a new epoch, and update stake and vote states. The module interacts with various components such as `fd_bank_t`, `fd_stake_delegations_t`, and `fd_vote_states_t` to perform these operations. It uses iterators to traverse stake delegations and vote states, updating them according to the current epoch and stake history. The module also handles encoding and writing of stake states, ensuring that the stake delegation and vote state data are correctly updated and stored.

The primary functions include [`fd_stake_weights_by_node`](<#fd_stake_weights_by_node>), which calculates the stake weights for nodes, and [`fd_refresh_vote_accounts`](<#fd_refresh_vote_accounts>), which updates the stake amounts for vote accounts after the stake history is updated. The [`fd_stakes_activate_epoch`](<#fd_stakes_activate_epoch>) function manages the transition of stakes to a new epoch, updating the stake history and refreshing vote accounts. Additionally, [`fd_stakes_update_stake_delegation`](<#fd_stakes_update_stake_delegation>) and [`fd_stakes_update_vote_state`](<#fd_stakes_update_vote_state>) functions handle the modification of stake and vote states based on account changes. The module relies on external dependencies such as `fd_bank.h`, `fd_system_ids.h`, and others, indicating that it is part of a larger system managing financial transactions or blockchain operations.
# Imports and Dependencies

---
- `fd_stakes.h`
- `../runtime/fd_bank.h`
- `../runtime/fd_system_ids.h`
- `../runtime/program/fd_stake_program.h`
- `../runtime/program/fd_vote_program.h`
- `../runtime/sysvar/fd_sysvar_stake_history.h`
- `fd_stake_delegations.h`


# Functions

---
### fd\_stake\_weights\_by\_node<!-- {{#callable:fd_stake_weights_by_node}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stakes.c#L9>)

Calculates and sorts the stake weights for each node based on the provided vote states.
- **Inputs**:
    - `vote_states`: A pointer to a constant `fd_vote_states_t` structure containing the vote states to process.
    - `weights`: A pointer to an `fd_vote_stake_weight_t` array where the function will store the calculated stake weights.
- **Logic and Control Flow**:
    - Initialize `weights_cnt` to zero to keep track of the number of valid weights.
    - Create an iterator `iter_` for the `vote_states`.
    - Iterate over each vote state using the iterator.
    - For each vote state, check if the `stake` is non-zero; if zero, skip to the next vote state.
    - Copy the `vote_account` and `node_account` from the vote state to the corresponding fields in the `weights` array.
    - Assign the `stake` from the vote state to the `stake` field in the `weights` array.
    - Increment `weights_cnt` for each valid vote state processed.
    - Sort the `weights` array in place by stake and vote using `sort_vote_weights_by_stake_vote_inplace`.
- **Output**: Returns the number of valid stake weights processed, as an unsigned long integer.
- **Functions Called**:
    - [`fd_vote_states_iter_init`](<fd_vote_states.c.md#fd_vote_states_iter_init>)
    - [`fd_vote_states_iter_done`](<fd_vote_states.c.md#fd_vote_states_iter_done>)
    - [`fd_vote_states_iter_next`](<fd_vote_states.c.md#fd_vote_states_iter_next>)
    - [`fd_vote_states_iter_ele`](<fd_vote_states.c.md#fd_vote_states_iter_ele>)


---
### fd\_refresh\_vote\_accounts<!-- {{#callable:fd_refresh_vote_accounts}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stakes.c#L34>)

Updates the stake values for vote accounts based on the current epoch's stake delegations and history.
- **Inputs**:
    - ``bank``: A pointer to the `fd_bank_t` structure representing the bank context.
    - ``stake_delegations``: A pointer to the `fd_stake_delegations_t` structure containing the current stake delegations.
    - ``history``: A pointer to the `fd_stake_history_t` structure representing the stake history.
    - ``new_rate_activation_epoch``: A pointer to an unsigned long where the function stores the new rate activation epoch.
- **Logic and Control Flow**:
    - Retrieve the current epoch from the bank using `fd_bank_epoch_get`.
    - Initialize `total_stake` to zero.
    - Lock and modify the vote states in the bank using `fd_bank_vote_states_locking_modify`.
    - Check if `vote_states` is NULL and log a critical error if true.
    - Reset the vote stakes using [`fd_vote_states_reset_stakes`](<fd_vote_states.c.md#fd_vote_states_reset_stakes>).
    - Initialize an iterator for the stake delegations and iterate through each delegation.
    - For each delegation, create a `fd_delegation_t` structure and calculate the new stake entry using `fd_stake_activating_and_deactivating`.
    - Query the vote state for the current delegation's vote account and update the total and individual stakes if the vote state exists.
    - Set the total epoch stake in the bank using `fd_bank_total_epoch_stake_set`.
    - Query the previous vote states for optimization purposes and iterate through the current vote states if the bank slot is not zero.
    - For each vote state, update the `stake_t_2` field with the previous stake value if available.
    - End the locking queries and modifications for the vote states.
- **Output**: None (the function modifies the bank and vote states in place).
- **Functions Called**:
    - [`fd_vote_states_reset_stakes`](<fd_vote_states.c.md#fd_vote_states_reset_stakes>)
    - [`fd_stake_delegations_iter_init`](<fd_stake_delegations.c.md#fd_stake_delegations_iter_init>)
    - [`fd_stake_delegations_iter_done`](<fd_stake_delegations.c.md#fd_stake_delegations_iter_done>)
    - [`fd_stake_delegations_iter_next`](<fd_stake_delegations.c.md#fd_stake_delegations_iter_next>)
    - [`fd_stake_delegations_iter_ele`](<fd_stake_delegations.c.md#fd_stake_delegations_iter_ele>)
    - [`fd_vote_states_query`](<fd_vote_states.c.md#fd_vote_states_query>)
    - [`fd_vote_states_iter_init`](<fd_vote_states.c.md#fd_vote_states_iter_init>)
    - [`fd_vote_states_iter_done`](<fd_vote_states.c.md#fd_vote_states_iter_done>)
    - [`fd_vote_states_iter_next`](<fd_vote_states.c.md#fd_vote_states_iter_next>)
    - [`fd_vote_states_iter_ele`](<fd_vote_states.c.md#fd_vote_states_iter_ele>)


---
### fd\_stakes\_activate\_epoch<!-- {{#callable:fd_stakes_activate_epoch}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stakes.c#L104>)

Activates stakes for a new epoch by updating stake history and refreshing vote account stakes.
- **Inputs**:
    - ``bank``: A pointer to `fd_bank_t`, representing the bank state for the current operation.
    - ``accdb``: A pointer to `fd_accdb_user_t`, representing the account database user context.
    - ``xid``: A constant pointer to `fd_funk_txn_xid_t`, representing the transaction ID.
    - ``capture_ctx``: A pointer to `fd_capture_ctx_t`, used for capturing context during the operation.
    - ``stake_delegations``: A constant pointer to `fd_stake_delegations_t`, representing the stake delegations to process.
    - ``new_rate_activation_epoch``: A pointer to `ulong`, representing the new rate activation epoch.
- **Logic and Control Flow**:
    - Read the current stake history from the sysvar cache using `fd_sysvar_stake_history_read`.
    - Initialize a new stake history entry for the current epoch with zeroed effective, activating, and deactivating stakes.
    - Iterate over each stake delegation using [`fd_stake_delegations_iter_init`](<fd_stake_delegations.c.md#fd_stake_delegations_iter_init>) and update the new stake history entry with effective, activating, and deactivating stakes calculated by `fd_stake_activating_and_deactivating`.
    - Update the stake history sysvar with the new entry using `fd_sysvar_stake_history_update`.
    - Read the updated stake history again to ensure it is present in the sysvar cache.
    - Increment the epoch in the bank using `fd_bank_epoch_set`.
    - Refresh the vote account stakes for the new epoch using [`fd_refresh_vote_accounts`](<#fd_refresh_vote_accounts>).
- **Output**: No return value; the function updates the bank's stake history and vote account stakes for the new epoch.
- **Functions Called**:
    - [`fd_stake_delegations_iter_init`](<fd_stake_delegations.c.md#fd_stake_delegations_iter_init>)
    - [`fd_stake_delegations_iter_done`](<fd_stake_delegations.c.md#fd_stake_delegations_iter_done>)
    - [`fd_stake_delegations_iter_next`](<fd_stake_delegations.c.md#fd_stake_delegations_iter_next>)
    - [`fd_stake_delegations_iter_ele`](<fd_stake_delegations.c.md#fd_stake_delegations_iter_ele>)
    - [`fd_refresh_vote_accounts`](<#fd_refresh_vote_accounts>)


---
### write\_stake\_state<!-- {{#callable:write_stake_state}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stakes.c#L174>)

Encodes a stake state into a transaction account's mutable data buffer.
- **Inputs**:
    - `stake_acc_rec`: A pointer to a `fd_txn_account_t` structure representing the transaction account where the stake state will be written.
    - `stake_state`: A pointer to a `fd_stake_state_v2_t` structure containing the stake state to encode.
- **Logic and Control Flow**:
    - Calculate the size of the encoded stake state using `fd_stake_state_v2_size` and store it in `encoded_stake_state_size`.
    - Initialize a `fd_bincode_encode_ctx_t` structure `ctx` with `data` pointing to the mutable data of `stake_acc_rec` and `dataend` pointing to the end of the data buffer based on `encoded_stake_state_size`.
    - Attempt to encode `stake_state` into the context `ctx` using `fd_stake_state_v2_encode`.
    - If encoding fails (i.e., the return value is not `FD_BINCODE_SUCCESS`), log an error message using `FD_LOG_ERR`.
    - Return 0 to indicate successful execution.
- **Output**: Returns 0 to indicate successful execution, but logs an error if encoding fails.


---
### fd\_stakes\_update\_stake\_delegation<!-- {{#callable:fd_stakes_update_stake_delegation}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stakes.c#L191>)

Updates the stake delegation for a given stake account in the bank's stake delegation delta.
- **Inputs**:
    - `stake_account`: A pointer to an `fd_txn_account_t` structure representing the stake account to update.
    - `bank`: A pointer to an `fd_bank_t` structure representing the bank where the stake delegation delta is modified.
- **Logic and Control Flow**:
    - Check if `stake_account` is mutable; if not, return immediately.
    - Retrieve the stake delegation delta from the bank for modification; log a critical error if retrieval fails.
    - Check if the stake account has zero lamports; if so, remove the stake delegation and end modification, then return.
    - Get the stake state of the account; if retrieval fails, remove the stake delegation and end modification, then return.
    - Check if the stake state is valid and initialized; if not, remove the stake delegation and end modification, then return.
    - Check if the stake amount in the delegation is zero; if so, remove the stake delegation and end modification, then return.
    - Update the stake delegation with the current stake state details.
    - End the modification of the stake delegation delta in the bank.
- **Output**: No explicit output is returned; the function modifies the bank's stake delegation delta based on the stake account's state.
- **Functions Called**:
    - [`fd_stake_delegations_remove`](<fd_stake_delegations.c.md#fd_stake_delegations_remove>)
    - [`fd_stake_delegations_update`](<fd_stake_delegations.c.md#fd_stake_delegations_update>)


---
### fd\_stakes\_update\_vote\_state<!-- {{#callable:fd_stakes_update_vote_state}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_stakes.c#L246>)

Updates the vote state of a given vote account in the bank if the account is mutable and valid.
- **Inputs**:
    - `vote_account`: A pointer to an `fd_txn_account_t` structure representing the vote account to update.
    - `bank`: A pointer to an `fd_bank_t` structure representing the bank where the vote state is updated.
- **Logic and Control Flow**:
    - Check if `vote_account` is mutable; if not, return immediately.
    - Lock and modify the vote states in the `bank`.
    - Check if the `vote_account` has zero lamports; if true, remove the vote state and end the modification lock, then return.
    - Verify if the vote state version of `vote_account` is correct and initialized; if not, remove the vote state and end the modification lock, then return.
    - Update the vote state from the `vote_account` data and end the modification lock.
- **Output**: No output is returned; the function updates the vote state in the bank as a side effect.
- **Functions Called**:
    - [`fd_vote_states_remove`](<fd_vote_states.c.md#fd_vote_states_remove>)
    - [`fd_vote_states_update_from_account`](<fd_vote_states.c.md#fd_vote_states_update_from_account>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)