<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Manages vote state pools and maps, including creation, updating, querying, and iteration of vote states.

# Purpose
The code defines a module for managing vote states in a C program. It provides functionality to create, update, query, and remove vote states associated with public keys (`fd_pubkey_t`). The module uses a pool and a map to manage vote state elements (`fd_vote_state_ele_t`). The pool is used to allocate and manage memory for vote state elements, while the map provides a way to associate public keys with these elements, allowing for efficient lookup and management.

The module includes functions to initialize and join vote states, calculate memory alignment and footprint, and manage the lifecycle of vote state elements. It also provides functions to update vote states from account data, reset stakes, and iterate over vote states. The code uses macros to include template-based implementations for the pool and map, ensuring that the data structures are efficiently managed. The module is designed to be part of a larger system, as indicated by the inclusion of header files and the use of logging for error handling.
# Imports and Dependencies

---
- `fd_vote_states.h`
- `../types/fd_types.h`
- `../runtime/program/fd_vote_program.h`
- `../../util/tmpl/fd_pool.c`
- `../../util/tmpl/fd_map_chain.c`


# Functions

---
### fd\_vote\_states\_get\_pool<!-- {{#callable:fd_vote_states_get_pool}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_vote_states.c#L19>)

Retrieves the pool of vote state elements from the given vote states structure.
- **Inputs**:
    - `vote_states`: A pointer to a constant `fd_vote_states_t` structure, which contains the vote states information.
- **Logic and Control Flow**:
    - Calculate the address of the pool by adding the `pool_offset_` from the `vote_states` to the base address of `vote_states`.
    - Call `fd_vote_state_pool_join` with the calculated address to retrieve the pool of vote state elements.
- **Output**: Returns a pointer to the `fd_vote_state_ele_t` structure representing the pool of vote state elements.


---
### fd\_vote\_states\_get\_map<!-- {{#callable:fd_vote_states_get_map}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_vote_states.c#L24>)

Retrieves a pointer to the vote state map from the given vote states structure.
- **Inputs**:
    - `vote_states`: A pointer to a `fd_vote_states_t` structure from which the vote state map is retrieved.
- **Logic and Control Flow**:
    - Calculate the address of the vote state map by adding the `map_offset_` to the base address of `vote_states`.
    - Call `fd_vote_state_map_join` with the calculated address to retrieve the vote state map.
- **Output**: A pointer to the `fd_vote_state_map_t` structure associated with the given `vote_states`.


---
### fd\_vote\_states\_align<!-- {{#callable:fd_vote_states_align}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_vote_states.c#L29>)

Calculates the alignment requirement for the `fd_vote_states_t` structure based on the maximum alignment of its contained data structures.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `fd_vote_state_map_align()` to get the alignment of the map structure.
    - Calls `fd_vote_state_pool_align()` to get the alignment of the pool structure.
    - Uses `alignof(fd_vote_states_t)` to get the alignment of the `fd_vote_states_t` structure itself.
    - Applies `fd_ulong_max()` to determine the maximum alignment among the map, pool, and the structure itself.
    - Returns the maximum alignment value.
- **Output**: Returns an `ulong` representing the maximum alignment requirement for the `fd_vote_states_t` structure.


---
### fd\_vote\_states\_footprint<!-- {{#callable:fd_vote_states_footprint}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_vote_states.c#L38>)

Calculates the memory footprint required for vote states based on the maximum number of vote accounts.
- **Inputs**:
    - `max_vote_accounts`: The maximum number of vote accounts to consider for calculating the footprint.
- **Logic and Control Flow**:
    - Calculate `map_chain_cnt` using `fd_vote_state_map_chain_cnt_est` with `max_vote_accounts`.
    - Initialize `l` with `FD_LAYOUT_INIT`.
    - Append the alignment and size of `fd_vote_states_t` to `l` using `FD_LAYOUT_APPEND`.
    - Append the alignment and footprint of the vote state pool to `l` using `FD_LAYOUT_APPEND`.
    - Append the alignment and footprint of the vote state map to `l` using `FD_LAYOUT_APPEND`.
    - Finalize the layout with `FD_LAYOUT_FINI` and return the result.
- **Output**: Returns the total memory footprint as an unsigned long integer.
- **Functions Called**:
    - [`fd_vote_states_align`](<#fd_vote_states_align>)


---
### fd\_vote\_states\_new<!-- {{#callable:fd_vote_states_new}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_vote_states.c#L50>)

Initializes a new vote states structure in the provided memory, setting up a pool and map for managing vote accounts.
- **Inputs**:
    - `mem`: A pointer to the memory where the vote states structure will be initialized.
    - `max_vote_accounts`: The maximum number of vote accounts that the structure can manage.
    - `seed`: A seed value used for initializing the vote state map.
- **Logic and Control Flow**:
    - Check if `mem` is NULL and log a warning if true, then return NULL.
    - Check if `max_vote_accounts` is zero and log a warning if true, then return NULL.
    - Check if `mem` is aligned according to `fd_vote_states_align()` and log a warning if not, then return NULL.
    - Estimate the number of map chains needed using `fd_vote_state_map_chain_cnt_est()`.
    - Initialize scratch memory allocation with `FD_SCRATCH_ALLOC_INIT`.
    - Allocate memory for `fd_vote_states_t`, the pool, and the map using `FD_SCRATCH_ALLOC_APPEND`.
    - Check if the final memory layout is correct using `FD_SCRATCH_ALLOC_FINI` and log a warning if not, then return NULL.
    - Set the `max_vote_accounts_`, `pool_offset_`, and `map_offset_` fields in the `vote_states` structure.
    - Create and join a new vote states pool using `fd_vote_state_pool_new` and `fd_vote_state_pool_join`, log a warning if it fails, then return NULL.
    - Initialize each vote state element in the pool with its index.
    - Create and join a new vote states map using `fd_vote_state_map_new` and `fd_vote_state_map_join`, log a warning if it fails, then return NULL.
    - Set the `magic` field in `vote_states` to `FD_VOTE_STATES_MAGIC` using memory fences for synchronization.
    - Return the `mem` pointer.
- **Output**: A pointer to the initialized memory if successful, or NULL if any error occurs.
- **Functions Called**:
    - [`fd_vote_states_align`](<#fd_vote_states_align>)
    - [`fd_vote_states_footprint`](<#fd_vote_states_footprint>)


---
### fd\_vote\_states\_join<!-- {{#callable:fd_vote_states_join}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_vote_states.c#L108>)

Joins a memory block to a `fd_vote_states_t` structure, ensuring proper alignment and initialization of its components.
- **Inputs**:
    - `mem`: A pointer to the memory block to be joined as a `fd_vote_states_t` structure.
- **Logic and Control Flow**:
    - Check if `mem` is NULL and log a warning if true, then return NULL.
    - Verify if `mem` is aligned according to `fd_vote_states_align()`; log a warning and return NULL if not aligned.
    - Cast `mem` to a `fd_vote_states_t` pointer and check if its `magic` field matches `FD_VOTE_STATES_MAGIC`; log a warning and return NULL if it does not match.
    - Estimate the number of map chains using `fd_vote_state_map_chain_cnt_est()` based on `vote_states->max_vote_accounts_`.
    - Initialize a scratch allocator with `vote_states` and append memory for `fd_vote_states_t`, pool, and map components.
    - Check if the final layout of the scratch allocator matches the expected footprint; log a warning and return NULL if it does not match.
    - Attempt to join the vote states pool and map using `fd_vote_state_pool_join()` and `fd_vote_state_map_join()`; log a warning and return NULL if either fails.
    - Return the `vote_states` pointer if all checks and joins are successful.
- **Output**: A pointer to the `fd_vote_states_t` structure if successful, or NULL if any checks or joins fail.
- **Functions Called**:
    - [`fd_vote_states_align`](<#fd_vote_states_align>)
    - [`fd_vote_states_footprint`](<#fd_vote_states_footprint>)


---
### fd\_vote\_states\_update<!-- {{#callable:fd_vote_states_update}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_vote_states.c#L151>)

Updates or creates a vote state entry for a given vote account in the vote states data structure.
- **Inputs**:
    - `vote_states`: A pointer to the `fd_vote_states_t` structure, which contains the vote state pool and map.
    - `vote_account`: A constant pointer to the `fd_pubkey_t` structure representing the vote account to update or add.
- **Logic and Control Flow**:
    - Retrieve the vote state pool and map from the `vote_states` structure.
    - Check if the vote state pool and map are successfully retrieved; log a critical error if not.
    - Query the map for the index of the vote account using `fd_vote_state_map_idx_query_const`.
    - If the index is valid (not `ULONG_MAX`), retrieve the vote state from the pool using the index and return it.
    - If the index is invalid, check if there is a free vote state in the pool; log a critical error if not.
    - Acquire a new vote state element from the pool and initialize it with the vote account and default stake values.
    - Insert the new vote state into the map; log a critical error if insertion fails.
    - Return the newly created or updated vote state.
- **Output**: A pointer to the `fd_vote_state_ele_t` structure representing the updated or newly created vote state.
- **Functions Called**:
    - [`fd_vote_states_get_pool`](<#fd_vote_states_get_pool>)
    - [`fd_vote_states_get_map`](<#fd_vote_states_get_map>)


---
### fd\_vote\_states\_remove<!-- {{#callable:fd_vote_states_remove}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_vote_states.c#L213>)

Removes a vote state associated with a given vote account from the vote states data structure.
- **Inputs**:
    - ``vote_states``: A pointer to the `fd_vote_states_t` structure that contains the vote states.
    - ``vote_account``: A constant pointer to the `fd_pubkey_t` structure representing the vote account to remove.
- **Logic and Control Flow**:
    - Retrieve the vote state pool and map using [`fd_vote_states_get_pool`](<#fd_vote_states_get_pool>) and [`fd_vote_states_get_map`](<#fd_vote_states_get_map>) functions.
    - Check if the vote state pool or map retrieval fails and log a critical error if so.
    - Query the index of the vote state associated with `vote_account` using `fd_vote_state_map_idx_query_const`.
    - If the vote state index is `ULONG_MAX`, indicating the vote state was not found, return immediately.
    - Retrieve the vote state element from the pool using `fd_vote_state_pool_ele`.
    - If the vote state element retrieval fails, log a critical error.
    - Remove the vote state from the map using `fd_vote_state_map_idx_remove`.
    - If the removal fails, log a critical error.
    - Set the `next_` pointer of the vote state to the null index using `fd_vote_state_pool_idx_null`.
    - Release the vote state index back to the pool using `fd_vote_state_pool_idx_release`.
- **Output**: No output is returned; the function performs operations on the provided data structures.
- **Functions Called**:
    - [`fd_vote_states_get_pool`](<#fd_vote_states_get_pool>)
    - [`fd_vote_states_get_map`](<#fd_vote_states_get_map>)


---
### fd\_vote\_states\_update\_from\_account<!-- {{#callable:fd_vote_states_update_from_account}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_vote_states.c#L251>)

Updates a vote state element from account data and returns the updated element.
- **Inputs**:
    - `vote_states`: A pointer to `fd_vote_states_t`, representing the collection of vote states to update.
    - `vote_account`: A constant pointer to `fd_pubkey_t`, representing the public key of the vote account to update.
    - `account_data`: A constant pointer to `uchar`, representing the raw account data to decode and update the vote state.
    - `account_data_len`: An `ulong` representing the length of the account data.
- **Logic and Control Flow**:
    - Initializes a `fd_bincode_decode_ctx_t` context with `account_data` and its length.
    - Decodes the account data into a `fd_vote_state_versioned_t` structure using `fd_vote_state_versioned_decode`.
    - Checks the `discriminant` of the decoded vote state versioned structure to extract the `node_account`, `commission`, `last_vote_timestamp`, and `last_vote_slot`.
    - Calls [`fd_vote_states_update`](<#fd_vote_states_update>) to get or create a vote state element for the given `vote_account`.
    - Updates the vote state element with the extracted `node_account`, `commission`, `last_vote_timestamp`, and `last_vote_slot`.
- **Output**: Returns a pointer to the updated `fd_vote_state_ele_t`.
- **Functions Called**:
    - [`fd_vote_states_update`](<#fd_vote_states_update>)


---
### fd\_vote\_states\_reset\_stakes<!-- {{#callable:fd_vote_states_reset_stakes}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_vote_states.c#L311>)

Resets the stakes of all vote states in the given `fd_vote_states_t` structure to zero.
- **Inputs**:
    - `vote_states`: A pointer to an `fd_vote_states_t` structure containing the vote states to reset.
- **Logic and Control Flow**:
    - Retrieve the vote state pool using [`fd_vote_states_get_pool`](<#fd_vote_states_get_pool>) and the vote state map using [`fd_vote_states_get_map`](<#fd_vote_states_get_map>).
    - Check if `vote_state_pool` or `vote_state_map` is NULL and log a critical error if so.
    - Initialize an iterator for the vote state map using `fd_vote_state_map_iter_init`.
    - Iterate over each vote state using a loop that continues until `fd_vote_state_map_iter_done` returns true.
    - For each vote state, retrieve its index using `fd_vote_state_map_iter_idx`.
    - Access the vote state element from the pool using `fd_vote_state_pool_ele`.
    - Check if the retrieved vote state is NULL and log a critical error if so.
    - Set the `stake` and `stake_t_2` fields of the vote state to zero.
- **Output**: No return value; the function operates directly on the `vote_states` structure.
- **Functions Called**:
    - [`fd_vote_states_get_pool`](<#fd_vote_states_get_pool>)
    - [`fd_vote_states_get_map`](<#fd_vote_states_get_map>)


---
### fd\_vote\_states\_query<!-- {{#callable:fd_vote_states_query}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_vote_states.c#L337>)

Retrieves a vote state element associated with a given vote account from a collection of vote states.
- **Inputs**:
    - ``vote_states``: A pointer to a `fd_vote_states_t` structure that contains the collection of vote states.
    - ``vote_account``: A pointer to a `fd_pubkey_t` structure representing the public key of the vote account to query.
- **Logic and Control Flow**:
    - Call [`fd_vote_states_get_map`](<#fd_vote_states_get_map>) to get the map from `vote_states`.
    - Call [`fd_vote_states_get_pool`](<#fd_vote_states_get_pool>) to get the pool from `vote_states`.
    - Use `fd_vote_state_map_idx_query_const` to find the index of the vote state element associated with `vote_account` in the map.
    - Check if the index is `ULONG_MAX`, indicating the vote state element was not found, and return `NULL` if so.
    - Retrieve the vote state element from the pool using the index.
    - Log a critical error if the vote state element cannot be retrieved.
    - Return the retrieved vote state element.
- **Output**: A pointer to the `fd_vote_state_ele_t` structure associated with the given vote account, or `NULL` if not found.
- **Functions Called**:
    - [`fd_vote_states_get_map`](<#fd_vote_states_get_map>)
    - [`fd_vote_states_get_pool`](<#fd_vote_states_get_pool>)


---
### fd\_vote\_states\_query\_const<!-- {{#callable:fd_vote_states_query_const}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_vote_states.c#L365>)

Queries a constant vote state element from a map using a vote account key.
- **Inputs**:
    - `vote_states`: A pointer to a constant `fd_vote_states_t` structure that contains the vote states.
    - `vote_account`: A pointer to a constant `fd_pubkey_t` structure representing the vote account key to query.
- **Logic and Control Flow**:
    - Calls [`fd_vote_states_get_map`](<#fd_vote_states_get_map>) to retrieve the map from `vote_states`.
    - Calls [`fd_vote_states_get_pool`](<#fd_vote_states_get_pool>) to retrieve the pool from `vote_states`.
    - Invokes `fd_vote_state_map_ele_query_const` with the retrieved map, `vote_account`, a null pointer, and the retrieved pool to query the vote state element.
- **Output**: Returns a constant pointer to an `fd_vote_state_ele_t` structure representing the queried vote state element, or `NULL` if not found.
- **Functions Called**:
    - [`fd_vote_states_get_map`](<#fd_vote_states_get_map>)
    - [`fd_vote_states_get_pool`](<#fd_vote_states_get_pool>)


---
### fd\_vote\_states\_max<!-- {{#callable:fd_vote_states_max}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_vote_states.c#L375>)

Retrieves the maximum number of vote accounts allowed in the `fd_vote_states_t` structure.
- **Inputs**:
    - `vote_states`: A pointer to a constant `fd_vote_states_t` structure from which to retrieve the maximum number of vote accounts.
- **Logic and Control Flow**:
    - Accesses the `max_vote_accounts_` member of the `vote_states` structure.
    - Returns the value of `max_vote_accounts_`.
- **Output**: Returns an unsigned long integer representing the maximum number of vote accounts.


---
### fd\_vote\_states\_cnt<!-- {{#callable:fd_vote_states_cnt}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_vote_states.c#L380>)

Counts the number of used vote state elements in the vote state pool.
- **Inputs**:
    - `vote_states`: A pointer to a `fd_vote_states_t` structure, which contains the vote state pool and map.
- **Logic and Control Flow**:
    - Calls [`fd_vote_states_get_pool`](<#fd_vote_states_get_pool>) to retrieve the vote state pool from the `vote_states` structure.
    - Calls `fd_vote_state_pool_used` with the retrieved pool to get the count of used vote state elements.
- **Output**: Returns the number of used vote state elements as an unsigned long integer.
- **Functions Called**:
    - [`fd_vote_states_get_pool`](<#fd_vote_states_get_pool>)


---
### fd\_vote\_states\_iter\_ele<!-- {{#callable:fd_vote_states_iter_ele}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_vote_states.c#L385>)

Retrieves the current element from a vote state iterator.
- **Inputs**:
    - `iter`: A pointer to an `fd_vote_states_iter_t` structure, which contains the state of the iteration over vote states.
- **Logic and Control Flow**:
    - Call `fd_vote_state_map_iter_idx` with `iter->iter`, `iter->map`, and `iter->pool` to get the current index of the iterator.
    - Use the index to retrieve the corresponding element from the vote state pool by calling `fd_vote_state_pool_ele` with `iter->pool` and the index.
- **Output**: Returns a pointer to the `fd_vote_state_ele_t` element at the current iterator position.


---
### fd\_vote\_states\_iter\_init<!-- {{#callable:fd_vote_states_iter_init}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_vote_states.c#L391>)

Initializes a vote states iterator with the given vote states.
- **Inputs**:
    - `iter`: A pointer to an `fd_vote_states_iter_t` structure that will be initialized.
    - `vote_states`: A constant pointer to an `fd_vote_states_t` structure containing the vote states to iterate over.
- **Logic and Control Flow**:
    - Check if `iter` is NULL and log a critical error if true.
    - Check if `vote_states` is NULL and log a critical error if true.
    - Retrieve the map from `vote_states` using [`fd_vote_states_get_map`](<#fd_vote_states_get_map>) and assign it to `iter->map`.
    - Retrieve the pool from `vote_states` using [`fd_vote_states_get_pool`](<#fd_vote_states_get_pool>) and assign it to `iter->pool`.
    - Initialize the iterator using `fd_vote_state_map_iter_init` with the retrieved map and pool, and assign it to `iter->iter`.
- **Output**: Returns the initialized `fd_vote_states_iter_t` pointer.
- **Functions Called**:
    - [`fd_vote_states_get_map`](<#fd_vote_states_get_map>)
    - [`fd_vote_states_get_pool`](<#fd_vote_states_get_pool>)


---
### fd\_vote\_states\_iter\_done<!-- {{#callable:fd_vote_states_iter_done}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_vote_states.c#L408>)

Checks if the iteration over vote states is complete.
- **Inputs**:
    - ``iter``: A pointer to an `fd_vote_states_iter_t` structure, which contains the current state of the iteration over vote states.
- **Logic and Control Flow**:
    - Calls `fd_vote_state_map_iter_done` with `iter->iter`, `iter->map`, and `iter->pool` as arguments.
    - Returns the result of `fd_vote_state_map_iter_done`, indicating whether the iteration is complete.
- **Output**: An integer indicating if the iteration is done (non-zero if done, zero if not done).


---
### fd\_vote\_states\_iter\_next<!-- {{#callable:fd_vote_states_iter_next}} -->
[View Source →](<../../../../../src/flamenco/stakes/fd_vote_states.c#L413>)

Advances the iterator to the next element in the vote state map.
- **Inputs**:
    - ``iter``: A pointer to an `fd_vote_states_iter_t` structure, which contains the current state of the iteration, including the current iterator position, map, and pool.
- **Logic and Control Flow**:
    - Calls `fd_vote_state_map_iter_next` with the current iterator, map, and pool from `iter`.
    - Updates `iter->iter` with the result from `fd_vote_state_map_iter_next`.
- **Output**: No return value; the function updates the iterator in place.



---
Made with ❤️ by [Driver](https://www.driver.ai/)