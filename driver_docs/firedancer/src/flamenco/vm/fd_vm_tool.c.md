<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a virtual machine tool for disassembling, validating, tracing, and running programs.

# Purpose
The code is an executable C program that provides functionality for working with eBPF (extended Berkeley Packet Filter) programs. It includes several command-line commands: `disasm`, `validate`, `trace`, and `run`, each of which operates on a specified binary file. The program uses a structure `fd_vm_tool_prog_t` to manage the loading and execution of eBPF programs, including handling the binary data, program structure, and associated syscalls. The [`fd_vm_tool_prog_create`](<#fd_vm_tool_prog_create>) function initializes this structure by reading a binary file, extracting ELF information, and preparing the program for execution.

The main function of the program parses command-line arguments to determine which operation to perform. Each command corresponds to a function that sets up the necessary environment and executes the specified operation. For example, [`cmd_disasm`](<#cmd_disasm>) disassembles the eBPF program, [`cmd_validate`](<#cmd_validate>) checks the validity of the program, [`cmd_trace`](<#cmd_trace>) executes the program while tracing its execution, and [`cmd_run`](<#cmd_run>) simply runs the program. The program uses various helper functions and structures to manage memory, handle errors, and perform operations on the eBPF program, such as [`fd_vm_tool_prog_free`](<#fd_vm_tool_prog_free>) for cleanup and [`read_input_file`](<#read_input_file>) for reading input data.
# Imports and Dependencies

---
- `fd_vm_base.h`
- `fd_vm_private.h`
- `stdio.h`
- `stdlib.h`
- `errno.h`
- `sys/stat.h`


# Data Structures

---
### fd\_vm\_tool\_prog
- **Type**: ``struct``
- **Members**:
    - `bin_buf`: A pointer to a buffer that holds the binary data of the program.
    - `prog`: A pointer to an `fd_sbpf_program_t` structure representing the loaded program.
    - `syscalls`: A pointer to an `fd_sbpf_syscalls_t` structure representing the system calls available to the program.
- **Description**: Holds information about a virtual machine tool program, including its binary data, the loaded program, and the system calls it can use. This structure is used to manage and execute programs in a virtual machine environment, providing the necessary components for program execution and interaction with system resources.


---
### fd\_vm\_tool\_prog\_t
- **Type**: ``struct``
- **Members**:
    - ``bin_buf``: A pointer to a buffer that holds the binary data of the program.
    - ``prog``: A pointer to an `fd_sbpf_program_t` structure representing the loaded program.
    - ``syscalls``: A pointer to an `fd_sbpf_syscalls_t` structure that manages the system calls for the program.
- **Description**: Manages the state and resources needed to load and execute a program, including its binary data, the program structure, and associated system calls.


# Functions

---
### fd\_vm\_tool\_prog\_create<!-- {{#callable:fd_vm_tool_prog_create}} -->
[View Source →](<../../../../../src/flamenco/vm/fd_vm_tool.c#L19>)

Creates and initializes a `fd_vm_tool_prog_t` structure by loading and preparing an SBPF program from a binary file.
- **Inputs**:
    - `tool_prog`: A pointer to a `fd_vm_tool_prog_t` structure that will be initialized.
    - `bin_path`: A constant character pointer to the path of the binary file to be loaded.
- **Logic and Control Flow**:
    - Open the binary file specified by `bin_path` for reading.
    - Check if the file is a regular file using `fstat`.
    - Allocate a buffer to hold the file contents and read the file into this buffer.
    - Extract ELF information from the binary buffer using `fd_sbpf_elf_peek`.
    - Allocate memory for the read-only data segment and the program buffer.
    - Create a new SBPF program using `fd_sbpf_program_new` with the allocated buffers.
    - Allocate and initialize syscalls using `fd_sbpf_syscalls_new` and [`fd_vm_syscall_register_all`](<fd_vm_base.h.md#fd_vm_syscall_register_all>).
    - Load the program into memory using `fd_sbpf_program_load`.
    - Assign the allocated buffers and program to the `tool_prog` structure.
- **Output**: Returns a pointer to the initialized `fd_vm_tool_prog_t` structure.
- **Functions Called**:
    - [`fd_vm_syscall_register_all`](<fd_vm_base.h.md#fd_vm_syscall_register_all>)


---
### fd\_vm\_tool\_prog\_free<!-- {{#callable:fd_vm_tool_prog_free}} -->
[View Source →](<../../../../../src/flamenco/vm/fd_vm_tool.c#L91>)

Releases memory allocated for a `fd_vm_tool_prog_t` structure and its associated components.
- **Inputs**:
    - `prog`: A pointer to a `fd_vm_tool_prog_t` structure whose resources are to be freed.
- **Logic and Control Flow**:
    - Free the `rodata` segment of the program using `free(prog->prog->rodata)`.
    - Free the binary buffer using `free(prog->bin_buf)`.
    - Delete and free the program using `fd_sbpf_program_delete(prog->prog)` and `free` the result.
    - Delete and free the syscalls using `fd_sbpf_syscalls_delete(prog->syscalls)` and `free` the result.
- **Output**: No return value; the function performs memory deallocation.


---
### cmd\_disasm<!-- {{#callable:cmd_disasm}} -->
[View Source →](<../../../../../src/flamenco/vm/fd_vm_tool.c#L99>)

Disassembles a binary file and prints the disassembled output.
- **Inputs**:
    - `bin_path`: A constant character pointer to the path of the binary file to disassemble.
- **Logic and Control Flow**:
    - Create a `fd_vm_tool_prog_t` structure named `tool_prog` and initialize it using [`fd_vm_tool_prog_create`](<#fd_vm_tool_prog_create>) with the provided `bin_path`.
    - Calculate `out_max` as 128 times the `text_cnt` from `tool_prog.prog->info` to determine the maximum size of the output buffer.
    - Allocate memory for the output buffer `out` with size `out_max` and check for successful allocation.
    - Initialize the first character of `out` to the null terminator to prepare for string operations.
    - Call [`fd_vm_disasm_program`](<fd_vm_disasm.c.md#fd_vm_disasm_program>) to disassemble the program text, passing the program text, text count, syscalls, output buffer, maximum output size, and a pointer to `out_len` to store the length of the disassembled output.
    - Print the disassembled output stored in `out` using `puts`.
    - Free the allocated memory for `out` to prevent memory leaks.
    - Free resources associated with `tool_prog` using [`fd_vm_tool_prog_free`](<#fd_vm_tool_prog_free>).
    - Return the error code from [`fd_vm_disasm_program`](<fd_vm_disasm.c.md#fd_vm_disasm_program>).
- **Output**: Returns an integer error code from the disassembly process, where 0 typically indicates success.
- **Functions Called**:
    - [`fd_vm_tool_prog_create`](<#fd_vm_tool_prog_create>)
    - [`fd_vm_disasm_program`](<fd_vm_disasm.c.md#fd_vm_disasm_program>)
    - [`fd_vm_tool_prog_free`](<#fd_vm_tool_prog_free>)


---
### cmd\_validate<!-- {{#callable:cmd_validate}} -->
[View Source →](<../../../../../src/flamenco/vm/fd_vm_tool.c#L125>)

Validates a binary program by creating a virtual machine (VM) environment and checking the program's validity.
- **Inputs**:
    - `bin_path`: A constant character pointer to the path of the binary file to validate.
- **Logic and Control Flow**:
    - Create a `fd_vm_tool_prog_t` structure named `tool_prog`.
    - Call [`fd_vm_tool_prog_create`](<#fd_vm_tool_prog_create>) to initialize `tool_prog` with the binary program located at `bin_path`.
    - Initialize a `fd_vm_t` structure named `vm` using the program data from `tool_prog`.
    - Call [`fd_vm_validate`](<fd_vm.c.md#fd_vm_validate>) with the `vm` structure to validate the program.
    - Free the resources allocated for `tool_prog` using [`fd_vm_tool_prog_free`](<#fd_vm_tool_prog_free>).
    - Return the result of the validation process.
- **Output**: Returns an integer error code from the [`fd_vm_validate`](<fd_vm.c.md#fd_vm_validate>) function, indicating the success or failure of the validation process.
- **Functions Called**:
    - [`fd_vm_tool_prog_create`](<#fd_vm_tool_prog_create>)
    - [`fd_vm_validate`](<fd_vm.c.md#fd_vm_validate>)
    - [`fd_vm_tool_prog_free`](<#fd_vm_tool_prog_free>)


---
### read\_input\_file<!-- {{#callable:read_input_file}} -->
[View Source →](<../../../../../src/flamenco/vm/fd_vm_tool.c#L150>)

Reads the contents of a file specified by `input_path` into a buffer and returns the buffer while updating the size of the file in `_input_sz`.
- **Inputs**:
    - `input_path`: A constant character pointer to the path of the input file to read.
    - `_input_sz`: A pointer to an unsigned long where the function will store the size of the input file.
- **Logic and Control Flow**:
    - Checks if `_input_sz` is NULL and logs an error if it is.
    - Opens the file at `input_path` for reading and logs an error if the file cannot be opened.
    - Retrieves the file status using `fstat` and logs an error if it fails or if the file is not a regular file.
    - Allocates a buffer of size equal to the file size and logs an error if memory allocation fails.
    - Reads the entire file into the allocated buffer and logs an error if reading fails.
    - Closes the file and updates `_input_sz` with the size of the file.
- **Output**: Returns a pointer to the buffer containing the file's contents.


---
### cmd\_trace<!-- {{#callable:cmd_trace}} -->
[View Source →](<../../../../../src/flamenco/vm/fd_vm_tool.c#L184>)

Executes a virtual machine program with tracing and logs execution details.
- **Inputs**:
    - `bin_path`: Path to the binary file containing the program to execute.
    - `input_path`: Path to the input file to be used by the program.
- **Logic and Control Flow**:
    - Create a `fd_vm_tool_prog_t` structure and initialize it with the binary file specified by `bin_path`.
    - Read the input file specified by `input_path` into memory and store its size.
    - Create a memory region for the input data with write permissions.
    - Allocate and initialize a trace object for logging execution details.
    - Initialize a SHA-256 context for hashing purposes.
    - Set up a virtual machine (`fd_vm_t`) with the program's text, data, and input memory regions, and associate it with the trace and SHA-256 contexts.
    - Set specific registers in the virtual machine for memory mapping purposes.
    - Execute the virtual machine program and measure the execution time.
    - Log the execution results, including the return value, instruction count, and execution time.
    - Free the trace object and return the error code from the trace logging operation.
- **Output**: Returns an integer error code from the trace logging operation, indicating success or failure.
- **Functions Called**:
    - [`fd_vm_tool_prog_create`](<#fd_vm_tool_prog_create>)
    - [`read_input_file`](<#read_input_file>)
    - [`fd_vm_trace_join`](<fd_vm_trace.c.md#fd_vm_trace_join>)
    - [`fd_vm_trace_new`](<fd_vm_trace.c.md#fd_vm_trace_new>)
    - [`fd_vm_trace_align`](<fd_vm_trace.c.md#fd_vm_trace_align>)
    - [`fd_vm_trace_footprint`](<fd_vm_trace.c.md#fd_vm_trace_footprint>)
    - [`fd_vm_exec`](<fd_vm.h.md#fd_vm_exec>)
    - [`fd_vm_trace_printf`](<fd_vm_trace.c.md#fd_vm_trace_printf>)
    - [`fd_vm_strerror`](<fd_vm.c.md#fd_vm_strerror>)
    - [`fd_vm_trace_delete`](<fd_vm_trace.c.md#fd_vm_trace_delete>)
    - [`fd_vm_trace_leave`](<fd_vm_trace.c.md#fd_vm_trace_leave>)


---
### cmd\_run<!-- {{#callable:cmd_run}} -->
[View Source →](<../../../../../src/flamenco/vm/fd_vm_tool.c#L256>)

Executes a virtual machine program using a binary file and input data, and logs execution results.
- **Inputs**:
    - `bin_path`: Path to the binary file containing the program to execute.
    - `input_path`: Path to the input file containing data for the program.
- **Logic and Control Flow**:
    - Create a `fd_vm_tool_prog_t` structure and initialize it with the binary file specified by `bin_path` using [`fd_vm_tool_prog_create`](<#fd_vm_tool_prog_create>).
    - Read the input file specified by `input_path` into memory and store its size in `input_sz`.
    - Create a `fd_vm_input_region_t` structure to represent the input data as a memory region.
    - Initialize a SHA-256 context for hashing using `fd_sha256_join` and `fd_sha256_new`.
    - Set up a `fd_vm_t` structure to configure the virtual machine with program data, input memory region, and other parameters.
    - Set specific registers in the virtual machine (`vm.reg[1]` and `vm.reg[10]`) to predefined memory map start addresses.
    - Measure the execution time by logging the wall clock time before and after calling [`fd_vm_exec`](<fd_vm.h.md#fd_vm_exec>) to execute the virtual machine.
    - Log the execution result, return value, instruction counter, and execution time using `printf`.
    - Return `FD_VM_SUCCESS` to indicate successful execution.
- **Output**: Returns `FD_VM_SUCCESS` to indicate successful execution of the virtual machine program.
- **Functions Called**:
    - [`fd_vm_tool_prog_create`](<#fd_vm_tool_prog_create>)
    - [`read_input_file`](<#read_input_file>)
    - [`fd_vm_exec`](<fd_vm.h.md#fd_vm_exec>)
    - [`fd_vm_strerror`](<fd_vm.c.md#fd_vm_strerror>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/flamenco/vm/fd_vm_tool.c#L311>)

Executes a command specified by the user, such as 'disasm', 'validate', 'trace', or 'run', using command-line arguments.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of strings representing the command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with `argc` and `argv`.
    - Retrieves the command specified by the `--cmd` argument using `fd_env_strip_cmdline_cstr`.
    - If no command is specified, logs an error and exits.
    - Checks if the command is 'disasm', 'validate', 'trace', or 'run'.
    - For 'disasm' and 'validate', retrieves the `--program-file` argument and calls [`cmd_disasm`](<#cmd_disasm>) or [`cmd_validate`](<#cmd_validate>) respectively, logging success or failure.
    - For 'trace' and 'run', retrieves both `--program-file` and `--input-file` arguments and calls [`cmd_trace`](<#cmd_trace>) or [`cmd_run`](<#cmd_run>) respectively, logging success or failure.
    - If the command is unknown, logs an error and exits.
    - Calls `fd_halt` to clean up before exiting.
- **Output**: Returns 0 upon successful execution of the specified command.
- **Functions Called**:
    - [`cmd_disasm`](<#cmd_disasm>)
    - [`fd_vm_strerror`](<fd_vm.c.md#fd_vm_strerror>)
    - [`cmd_validate`](<#cmd_validate>)
    - [`cmd_trace`](<#cmd_trace>)
    - [`cmd_run`](<#cmd_run>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)