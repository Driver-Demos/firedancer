<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Utility functions for virtual machine syscalls, including memory operations and logging.

# Purpose
The code defines a set of system call functions for a virtual machine (`fd_vm_t`) that are used to perform various operations such as logging, memory management, and error handling. These functions are part of a C library that interfaces with a virtual machine environment, likely for a blockchain or smart contract platform, as indicated by references to Solana and Agave. The functions include [`fd_vm_syscall_abort`](<#fd_vm_syscall_abort>), [`fd_vm_syscall_sol_panic`](<#fd_vm_syscall_sol_panic>), [`fd_vm_syscall_sol_log`](<#fd_vm_syscall_sol_log>), and others, each implementing specific system call functionality. The code also includes memory operations like [`fd_vm_syscall_sol_memmove`](<#fd_vm_syscall_sol_memmove>), [`fd_vm_syscall_sol_memcpy`](<#fd_vm_syscall_sol_memcpy>), [`fd_vm_syscall_sol_memcmp`](<#fd_vm_syscall_sol_memcmp>), and [`fd_vm_syscall_sol_memset`](<#fd_vm_syscall_sol_memset>), which handle memory manipulation tasks within the virtual machine.

The code is structured to handle system calls by translating virtual addresses to host addresses, performing the necessary operations, and returning results or error codes. It includes error handling mechanisms and logging capabilities, which are crucial for debugging and monitoring the virtual machine's operations. The code also references external libraries for base64 and UTF-8 handling, indicating that it deals with string and data encoding tasks. The functions are designed to be used within the context of a virtual machine, providing a public API for interacting with the virtual machine's memory and logging systems. The code is intended to be part of a larger system, as it includes references to external resources and follows specific conventions for memory alignment and error handling.
# Imports and Dependencies

---
- `fd_vm_syscall.h`
- `../../../ballet/base64/fd_base64.h`
- `../../../ballet/utf8/fd_utf8.h`


# Functions

---
### fd\_vm\_syscall\_abort<!-- {{#callable:fd_vm_syscall_abort}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_util.c#L6>)

Triggers an abort syscall and returns an abort error code.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine instance.
    - `r1`: Unused parameter.
    - `r2`: Unused parameter.
    - `r3`: Unused parameter.
    - `r4`: Unused parameter.
    - `r5`: Unused parameter.
    - `_ret`: Unused parameter.
- **Logic and Control Flow**:
    - Cast `_vm` to a `fd_vm_t` pointer and store it in `vm`.
    - Call `FD_VM_ERR_FOR_LOG_SYSCALL` with `vm` and `FD_VM_SYSCALL_ERR_ABORT` to log the abort error.
    - Return `FD_VM_SYSCALL_ERR_ABORT` as the function result.
- **Output**: Returns the error code `FD_VM_SYSCALL_ERR_ABORT`.


---
### fd\_vm\_syscall\_sol\_panic<!-- {{#callable:fd_vm_syscall_sol_panic}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_util.c#L36>)

Handles a panic syscall by validating a string and returning a panic error code.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine context.
    - `file_vaddr`: The virtual address of the file name string.
    - `file_sz`: The size of the file name string.
    - `line`: The line number in the source code where the panic occurred.
    - `column`: The column number in the source code where the panic occurred.
    - `r5`: An unused parameter.
    - `_ret`: An unused pointer to store the return value.
- **Logic and Control Flow**:
    - Cast `_vm` to a `fd_vm_t` pointer named `vm`.
    - Update the compute units of `vm` using `file_sz` with `FD_VM_CU_UPDATE`.
    - Validate the string at `file_vaddr` with size `file_sz` using `FD_TRANSLATE_STRING`.
    - Ignore `line` and `column` as they are not used in the log.
    - Log a panic error using `FD_VM_ERR_FOR_LOG_SYSCALL` with `FD_VM_SYSCALL_ERR_PANIC`.
    - Return the error code `FD_VM_SYSCALL_ERR_PANIC`.
- **Output**: Returns the error code `FD_VM_SYSCALL_ERR_PANIC`.


---
### fd\_vm\_syscall\_sol\_log<!-- {{#callable:fd_vm_syscall_sol_log}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_util.c#L66>)

Logs a message from a virtual machine to a log collector after translating the message address and size.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine instance.
    - `msg_vaddr`: The virtual address of the message to log.
    - `msg_sz`: The size of the message to log.
    - `r3`: Unused parameter.
    - `r4`: Unused parameter.
    - `r5`: Unused parameter.
    - `_ret`: A pointer to store the return value of the function.
- **Logic and Control Flow**:
    - Cast `_vm` to a `fd_vm_t` pointer and store it in `vm`.
    - Update the compute units of the virtual machine using the maximum of `msg_sz` and `FD_VM_SYSCALL_BASE_COST`.
    - Translate the message from its virtual address to a host address using `FD_TRANSLATE_STRING`.
    - Log the translated message using `fd_log_collector_program_log`.
    - Set the return value pointed by `_ret` to `0UL`.
    - Return `FD_VM_SUCCESS`.
- **Output**: Returns `FD_VM_SUCCESS` to indicate successful execution.


---
### fd\_vm\_syscall\_sol\_log\_64<!-- {{#callable:fd_vm_syscall_sol_log_64}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_util.c#L89>)

Logs five 64-bit unsigned integers as a formatted message using a virtual machine context.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine context (`fd_vm_t`).
    - `r1`: The first 64-bit unsigned integer to log.
    - `r2`: The second 64-bit unsigned integer to log.
    - `r3`: The third 64-bit unsigned integer to log.
    - `r4`: The fourth 64-bit unsigned integer to log.
    - `r5`: The fifth 64-bit unsigned integer to log.
    - `_ret`: A pointer to a 64-bit unsigned integer where the function stores the return value.
- **Logic and Control Flow**:
    - Cast the `_vm` pointer to a `fd_vm_t` pointer named `vm`.
    - Update the compute units of the virtual machine using `FD_VM_CU_UPDATE` with `FD_VM_LOG_64_UNITS`.
    - Log the formatted message containing the five 64-bit unsigned integers using `fd_log_collector_printf_dangerous_max_127`.
    - Set the value pointed to by `_ret` to `0UL`.
    - Return `FD_VM_SUCCESS`.
- **Output**: Returns `FD_VM_SUCCESS` and sets the value pointed to by `_ret` to `0UL`.


---
### fd\_vm\_syscall\_sol\_log\_compute\_units<!-- {{#callable:fd_vm_syscall_sol_log_compute_units}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_util.c#L111>)

Logs the remaining compute units for a virtual machine program and updates the compute unit usage.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine instance.
    - `r1`: Unused parameter.
    - `r2`: Unused parameter.
    - `r3`: Unused parameter.
    - `r4`: Unused parameter.
    - `r5`: Unused parameter.
    - `_ret`: A pointer to store the return value, which is set to 0.
- **Logic and Control Flow**:
    - Cast the `_vm` pointer to a `fd_vm_t` type and store it in `vm`.
    - Update the compute unit usage of the virtual machine by calling `FD_VM_CU_UPDATE` with `FD_VM_SYSCALL_BASE_COST`.
    - Log the remaining compute units using `fd_log_collector_printf_dangerous_max_127`, which prints a message with the remaining compute units from `vm->cu`.
    - Set the value pointed to by `_ret` to 0.
    - Return `FD_VM_SUCCESS` to indicate successful execution.
- **Output**: Returns `FD_VM_SUCCESS` to indicate successful execution and sets the value pointed to by `_ret` to 0.


---
### fd\_vm\_syscall\_sol\_log\_pubkey<!-- {{#callable:fd_vm_syscall_sol_log_pubkey}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_util.c#L133>)

Logs a public key by encoding it in Base58 and sending it to a log collector.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine context.
    - `pubkey_vaddr`: The virtual address of the public key to log.
    - `r2`: Unused parameter.
    - `r3`: Unused parameter.
    - `r4`: Unused parameter.
    - `r5`: Unused parameter.
    - `_ret`: A pointer to store the return value of the function.
- **Logic and Control Flow**:
    - Cast `_vm` to a `fd_vm_t` pointer and store it in `vm`.
    - Update the compute units of the virtual machine using `FD_VM_CU_UPDATE` with `FD_VM_LOG_PUBKEY_UNITS`.
    - Load the public key from the virtual address `pubkey_vaddr` using `FD_VM_MEM_HADDR_LD`.
    - Encode the public key in Base58 format using `fd_base58_encode_32`.
    - If encoding fails, return `FD_VM_SYSCALL_ERR_INVALID_STRING`.
    - Log the encoded public key using `fd_log_collector_program_log`.
    - Set the return value pointed by `_ret` to `0UL`.
    - Return `FD_VM_SUCCESS`.
- **Output**: Returns `FD_VM_SUCCESS` on success or `FD_VM_SYSCALL_ERR_INVALID_STRING` if the public key encoding fails.


---
### fd\_vm\_syscall\_sol\_log\_data<!-- {{#callable:fd_vm_syscall_sol_log_data}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_util.c#L160>)

Logs data slices by encoding them in base64 and appending them to a log message.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine context.
    - `slice_vaddr`: The virtual address of the data slice to log.
    - `slice_cnt`: The number of slices to process.
    - `r3`: Unused parameter.
    - `r4`: Unused parameter.
    - `r5`: Unused parameter.
    - `_ret`: A pointer to store the return value of the function.
- **Logic and Control Flow**:
    - Cast `_vm` to `fd_vm_t` type.
    - Update compute units using `FD_VM_CU_UPDATE` with base cost.
    - Load the memory slice using `FD_VM_MEM_SLICE_HADDR_LD` and calculate its size.
    - Update compute units for each slice based on its length.
    - Calculate the total message size needed for logging, including base64 encoding and spaces.
    - Check if the log collector can accommodate the message size using `fd_log_collector_check_and_truncate`.
    - If space is available, prepare the log message by copying 'Program data: ' and encoding each slice in base64.
    - Log the message using `fd_log_collector_msg`.
    - Set the return value to 0 and return `FD_VM_SUCCESS`.
- **Output**: Returns `FD_VM_SUCCESS` and sets `*_ret` to 0 on successful logging.


---
### fd\_vm\_syscall\_sol\_alloc\_free<!-- {{#callable:fd_vm_syscall_sol_alloc_free}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_util.c#L231>)

Allocates or frees memory in a virtual machine using a bump allocator.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine instance.
    - `sz`: The size of memory to allocate.
    - `free_vaddr`: The virtual address to free, if non-zero.
    - `r3`: Unused parameter.
    - `r4`: Unused parameter.
    - `r5`: Unused parameter.
    - `_ret`: A pointer to store the result of the allocation or free operation.
- **Logic and Control Flow**:
    - Check if `free_vaddr` is non-zero, indicating a free operation; if so, set `*_ret` to 0 and return success.
    - Determine the alignment based on whether alignment checks are enabled in the VM.
    - Align the current heap size to the determined alignment.
    - Calculate the new heap virtual address and size after allocation.
    - Check if the new heap size exceeds the maximum allowed; if so, set `*_ret` to 0 and return success.
    - Update the VM's heap size to the new size.
    - Set `*_ret` to the calculated heap virtual address and return success.
- **Output**: Returns `FD_VM_SUCCESS` and sets `*_ret` to the allocated memory address or 0 if freeing or if allocation fails.


---
### fd\_vm\_memmove<!-- {{#callable:fd_vm_memmove}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_util.c#L338>)

Moves a block of memory from a source virtual address to a destination virtual address within a virtual machine.
- **Inputs**:
    - `vm`: A pointer to the `fd_vm_t` structure representing the virtual machine context.
    - `dst_vaddr`: The destination virtual address where the memory block will be moved.
    - `src_vaddr`: The source virtual address from where the memory block will be copied.
    - `sz`: The size of the memory block to move, in bytes.
- **Logic and Control Flow**:
    - Check if `sz` is zero; if so, return `FD_VM_SUCCESS` immediately as there is nothing to move.
    - Initialize a `fd_vm_haddr_query_t` structure for the destination address with the given virtual address, alignment, size, and slice flag.
    - Create an array of queries containing the destination query and call `FD_VM_TRANSLATE_MUT` to translate the virtual address to a host address.
    - Load the source memory block using `FD_VM_MEM_HADDR_LD` with the source virtual address, alignment, and size.
    - Use `memmove` to move the memory block from the source to the destination host address.
    - Return `FD_VM_SUCCESS` to indicate successful completion.
- **Output**: Returns `FD_VM_SUCCESS` to indicate the memory move operation was successful.


---
### fd\_vm\_syscall\_sol\_memmove<!-- {{#callable:fd_vm_syscall_sol_memmove}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_util.c#L365>)

Performs a memory move operation from a source virtual address to a destination virtual address within a virtual machine context.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine context (`fd_vm_t`).
    - `dst_vaddr`: The destination virtual address where data will be moved.
    - `src_vaddr`: The source virtual address from where data will be moved.
    - `sz`: The size of the data to move, in bytes.
    - `r4`: Unused parameter.
    - `r5`: Unused parameter.
    - `_ret`: A pointer to a `ulong` where the function will store the return value, set to 0 in this function.
- **Logic and Control Flow**:
    - Cast the `_vm` pointer to a `fd_vm_t` pointer named `vm`.
    - Call `FD_VM_CU_MEM_OP_UPDATE` to update the compute units for the memory operation with the size `sz`.
    - Set the value pointed to by `_ret` to 0.
    - Call [`fd_vm_memmove`](<#fd_vm_memmove>) with `vm`, `dst_vaddr`, `src_vaddr`, and `sz` to perform the memory move operation.
    - Return the result of [`fd_vm_memmove`](<#fd_vm_memmove>).
- **Output**: Returns the result of the [`fd_vm_memmove`](<#fd_vm_memmove>) function, which indicates the success or failure of the memory move operation.
- **Functions Called**:
    - [`fd_vm_memmove`](<#fd_vm_memmove>)


---
### fd\_vm\_syscall\_sol\_memcpy<!-- {{#callable:fd_vm_syscall_sol_memcpy}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_util.c#L384>)

Copies memory from a source virtual address to a destination virtual address with overlap checking.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine context.
    - `dst_vaddr`: The destination virtual address where the memory will be copied to.
    - `src_vaddr`: The source virtual address from where the memory will be copied.
    - `sz`: The size of the memory to copy.
    - `r4`: Unused parameter.
    - `r5`: Unused parameter.
    - `_ret`: A pointer to store the return value, set to 0 on success.
- **Logic and Control Flow**:
    - Cast `_vm` to a `fd_vm_t` pointer and store it in `vm`.
    - Call `FD_VM_CU_MEM_OP_UPDATE` to update memory operation statistics with the size `sz`.
    - Set the value pointed by `_ret` to 0, indicating success.
    - Call `FD_VM_MEM_CHECK_NON_OVERLAPPING` to ensure that the source and destination memory regions do not overlap.
    - Call [`fd_vm_memmove`](<#fd_vm_memmove>) to perform the memory copy operation from `src_vaddr` to `dst_vaddr` with size `sz`.
- **Output**: Returns the result of [`fd_vm_memmove`](<#fd_vm_memmove>), which is typically 0 for success.
- **Functions Called**:
    - [`fd_vm_memmove`](<#fd_vm_memmove>)


---
### fd\_vm\_syscall\_sol\_memcmp<!-- {{#callable:fd_vm_syscall_sol_memcmp}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_util.c#L405>)

Compares two memory regions byte by byte and stores the result in a specified memory location.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine context.
    - `m0_vaddr`: The virtual address of the first memory region to compare.
    - `m1_vaddr`: The virtual address of the second memory region to compare.
    - `sz`: The size in bytes of the memory regions to compare.
    - `out_vaddr`: The virtual address where the comparison result will be stored.
    - `r5`: An unused parameter.
    - `_ret`: A pointer to store the return value of the function.
- **Logic and Control Flow**:
    - Initialize the return value to 0.
    - Cast the virtual machine context pointer to `fd_vm_t`.
    - Update the compute units for the memory operation using `FD_VM_CU_MEM_OP_UPDATE`.
    - Load the host addresses of the memory regions `m0` and `m1` using `FD_VM_MEM_SLICE_HADDR_LD`.
    - Prepare a query for the output address with alignment and size specifications.
    - Translate the output address to a host address using `FD_VM_TRANSLATE_MUT`.
    - Iterate over the memory regions byte by byte, comparing each byte.
    - If a difference is found, calculate the difference and store it in `out`.
    - Copy the result to the specified output address using `fd_memcpy`.
    - Return `FD_VM_SUCCESS` to indicate successful execution.
- **Output**: Returns `FD_VM_SUCCESS` to indicate successful execution and stores the comparison result at the specified output address.


---
### fd\_vm\_syscall\_sol\_memset<!-- {{#callable:fd_vm_syscall_sol_memset}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_util.c#L458>)

Fills a specified memory region with a given byte value.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine context.
    - `dst_vaddr`: The virtual address of the destination memory region to fill.
    - `c`: The byte value to set in the memory region, only the least significant byte is used.
    - `sz`: The size of the memory region to fill.
    - `r4`: Unused parameter.
    - `r5`: Unused parameter.
    - `_ret`: A pointer to store the return value, set to 0.
- **Logic and Control Flow**:
    - Cast `_vm` to `fd_vm_t *` and store in `vm`.
    - Set `*_ret` to 0.
    - Update memory operation cost using `FD_VM_CU_MEM_OP_UPDATE` with `sz`.
    - If `sz` is 0, return `FD_VM_SUCCESS`.
    - Convert `c` to an integer `b` using only the least significant byte.
    - Create a `fd_vm_haddr_query_t` structure `haddr_query` with `dst_vaddr`, alignment, size, and slice flag.
    - Create an array `queries` containing `&haddr_query`.
    - Translate the virtual address to a host address using `FD_VM_TRANSLATE_MUT`.
    - Use `fd_memset` to fill the memory at the translated address with `b` for `sz` bytes.
    - Return `FD_VM_SUCCESS`.
- **Output**: Returns `FD_VM_SUCCESS` on successful execution.



---
Made with ❤️ by [Driver](https://www.driver.ai/)