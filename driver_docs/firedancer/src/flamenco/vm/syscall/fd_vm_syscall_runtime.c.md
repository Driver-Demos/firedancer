<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements various system call functions for a virtual machine, handling sysvar retrieval and instruction processing.

# Purpose
The code defines a set of system call functions for a virtual machine (VM) that interacts with the Solana blockchain runtime. These functions provide access to various system variables (sysvars) and other runtime data. The sysvars include clock, epoch schedule, rent, last restart slot, epoch rewards, and others. Each function retrieves specific data from the VM's context or cache and writes it to a specified virtual address. The functions handle errors related to invalid pointers, runtime constraints, and unsupported sysvars.

The code is organized into several functions, each responsible for a specific syscall. These functions include [`fd_vm_syscall_sol_get_clock_sysvar`](<#fd_vm_syscall_sol_get_clock_sysvar>), [`fd_vm_syscall_sol_get_epoch_schedule_sysvar`](<#fd_vm_syscall_sol_get_epoch_schedule_sysvar>), [`fd_vm_syscall_sol_get_rent_sysvar`](<#fd_vm_syscall_sol_get_rent_sysvar>), and others. Each function checks if the VM is running within the Solana runtime and updates the compute unit cost based on the operation performed. The functions use helper structures and macros to manage memory alignment and data translation. The code also includes error handling to ensure that invalid operations do not crash the VM. This code is intended to be part of a larger system that interfaces with the Solana blockchain, providing essential runtime data to programs executed within the VM.
# Imports and Dependencies

---
- `fd_vm_syscall.h`
- `../../runtime/program/fd_vote_program.h`
- `../../runtime/context/fd_exec_txn_ctx.h`
- `../../runtime/context/fd_exec_instr_ctx.h`
- `../../runtime/fd_system_ids.h`
- `fd_vm_syscall_macros.h`


# Data Structures

---
### fd\_vm\_syscall\_processed\_sibling\_instruction
- **Type**: ``struct``
- **Members**:
    - ``data_len``: Specifies the length of the instruction data.
    - ``accounts_len``: Indicates the number of accounts.
- **Description**: Defines a structure to store metadata about a sibling instruction, including the length of the instruction data and the number of accounts involved. This structure is used to query and convey information about sibling instructions in a virtual machine context.


---
### fd\_vm\_syscall\_processed\_sibling\_instruction\_t
- **Type**: ``struct``
- **Members**:
    - ``data_len``: Length of the instruction data.
    - ``accounts_len``: Number of accounts.
- **Description**: Used to query and convey information about a sibling instruction, `fd_vm_syscall_processed_sibling_instruction_t` contains two members: `data_len`, which specifies the length of the instruction data, and `accounts_len`, which indicates the number of accounts involved. This structure is part of the system for handling virtual machine syscalls related to sibling instructions in a transaction context.


# Functions

---
### fd\_vm\_syscall\_sol\_get\_clock\_sysvar<!-- {{#callable:fd_vm_syscall_sol_get_clock_sysvar}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_runtime.c#L15>)

Retrieves the current clock system variable and stores it at a specified virtual address in the VM's memory.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine instance.
    - `out_vaddr`: The virtual address where the clock system variable will be stored.
    - `r2`: Unused parameter.
    - `r3`: Unused parameter.
    - `r4`: Unused parameter.
    - `r5`: Unused parameter.
    - `_ret`: A pointer to a variable where the function will store the return status.
- **Logic and Control Flow**:
    - Cast `_vm` to `fd_vm_t *` and assign it to `vm`.
    - Retrieve the instruction context from `vm` and check if it is valid; return `FD_VM_SYSCALL_ERR_OUTSIDE_RUNTIME` if not.
    - Update the compute unit cost using `FD_VM_CU_UPDATE`.
    - Check if `out_vaddr` is valid under stricter ABI and runtime constraints; log an error and return `FD_VM_ERR_INVAL` if not.
    - Initialize a `fd_vm_haddr_query_t` structure for the clock system variable with the specified virtual address, alignment, and size.
    - Translate the virtual address to a hardware address using `FD_VM_TRANSLATE_MUT`.
    - Read the clock system variable from the system variable cache using `fd_sysvar_cache_clock_read_nofail`.
    - Copy the clock data to the translated hardware address using `memcpy`.
    - Set the return value pointed by `_ret` to `0UL` and return `FD_VM_SUCCESS`.
- **Output**: Returns `FD_VM_SUCCESS` on success, or an error code if the operation fails.


---
### fd\_vm\_syscall\_sol\_get\_epoch\_schedule\_sysvar<!-- {{#callable:fd_vm_syscall_sol_get_epoch_schedule_sysvar}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_runtime.c#L51>)

Retrieves the epoch schedule system variable and writes it to a specified virtual address in the VM memory.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine instance.
    - `out_vaddr`: The virtual address where the epoch schedule should be written.
    - `r2`: Unused parameter.
    - `r3`: Unused parameter.
    - `r4`: Unused parameter.
    - `r5`: Unused parameter.
    - `_ret`: A pointer to a variable where the function will store the return status.
- **Logic and Control Flow**:
    - Cast `_vm` to `fd_vm_t *` and retrieve the instruction context from the VM.
    - Check if the instruction context is NULL; if so, return `FD_VM_SYSCALL_ERR_OUTSIDE_RUNTIME`.
    - Update the compute unit cost using `FD_VM_CU_UPDATE`.
    - Check if `out_vaddr` is within a restricted memory region; if so, log an error and return `FD_VM_ERR_INVAL`.
    - Create a `fd_vm_haddr_query_t` structure for the epoch schedule with the specified virtual address, alignment, and size.
    - Translate the virtual address to a hardware address using `FD_VM_TRANSLATE_MUT`.
    - Attempt to read the epoch schedule from the system variable cache; if unsuccessful, log an error and return `FD_VM_ERR_INVAL`.
    - Copy the epoch schedule to the hardware address specified in the query.
    - Set the return value pointed to by `_ret` to `0UL` and return `FD_VM_SUCCESS`.
- **Output**: Returns `FD_VM_SUCCESS` on success, or an error code on failure, and sets `_ret` to `0UL` on success.


---
### fd\_vm\_syscall\_sol\_get\_rent\_sysvar<!-- {{#callable:fd_vm_syscall_sol_get_rent_sysvar}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_runtime.c#L91>)

Retrieves the rent system variable and writes it to a specified virtual address in the VM's memory.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine instance.
    - `out_vaddr`: The virtual address where the rent system variable will be written.
    - `r2`: Unused parameter.
    - `r3`: Unused parameter.
    - `r4`: Unused parameter.
    - `r5`: Unused parameter.
    - `_ret`: A pointer to a variable where the function will store the return status.
- **Logic and Control Flow**:
    - Cast `_vm` to `fd_vm_t *` and assign it to `vm`.
    - Check if `instr_ctx` is NULL; if so, return `FD_VM_SYSCALL_ERR_OUTSIDE_RUNTIME`.
    - Update the compute unit cost using `FD_VM_CU_UPDATE`.
    - Check if `vm->stricter_abi_and_runtime_constraints` is true and `out_vaddr` is greater than or equal to `FD_VM_MEM_MAP_INPUT_REGION_START`; if so, log an error and return `FD_VM_ERR_INVAL`.
    - Create a `fd_vm_haddr_query_t` structure `var_query` with the specified virtual address, alignment, size, and slice flag.
    - Translate the virtual address to a hardware address using `FD_VM_TRANSLATE_MUT`.
    - Read the rent system variable from the cache using `fd_sysvar_cache_rent_read_nofail`.
    - Copy the rent data to the hardware address specified in `var_query`.
    - Set `*_ret` to `0UL` and return `FD_VM_SUCCESS`.
- **Output**: Returns `FD_VM_SUCCESS` on success and writes `0UL` to `_ret`; returns an error code if an error occurs.


---
### fd\_vm\_syscall\_sol\_get\_last\_restart\_slot\_sysvar<!-- {{#callable:fd_vm_syscall_sol_get_last_restart_slot_sysvar}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_runtime.c#L131>)

Retrieves the last restart slot system variable and stores it at a specified virtual address.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine instance.
    - `out_vaddr`: The virtual address where the last restart slot system variable will be stored.
    - `r2`: Unused parameter.
    - `r3`: Unused parameter.
    - `r4`: Unused parameter.
    - `r5`: Unused parameter.
    - `_ret`: A pointer to store the return status of the function.
- **Logic and Control Flow**:
    - Cast `_vm` to `fd_vm_t *` and assign it to `vm`.
    - Retrieve the instruction context from `vm` and check if it is valid; return `FD_VM_SYSCALL_ERR_OUTSIDE_RUNTIME` if not.
    - Update the compute unit cost using `FD_VM_CU_UPDATE`.
    - Check if `out_vaddr` is valid under stricter ABI and runtime constraints; log an error and return `FD_VM_ERR_INVAL` if not.
    - Initialize a `fd_vm_haddr_query_t` structure for the last restart slot system variable with the specified `out_vaddr`.
    - Translate the virtual address to a hardware address using `FD_VM_TRANSLATE_MUT`.
    - Read the last restart slot from the system variable cache; log an error and return `FD_VM_ERR_INVAL` if reading fails.
    - Copy the last restart slot data to the hardware address specified in `var_query`.
    - Set the return value pointed by `_ret` to `0UL` and return `FD_VM_SUCCESS`.
- **Output**: Returns `FD_VM_SUCCESS` on success, or an error code on failure, and sets `_ret` to `0UL` on success.


---
### fd\_vm\_syscall\_sol\_get\_sysvar<!-- {{#callable:fd_vm_syscall_sol_get_sysvar}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_runtime.c#L173>)

Retrieves a specified system variable from the virtual machine's cache and copies it to a designated memory address.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine instance.
    - `sysvar_id_vaddr`: The virtual address of the system variable identifier.
    - `out_vaddr`: The virtual address where the system variable data will be copied.
    - `offset`: The offset within the system variable data to start copying from.
    - `sz`: The size of the data to copy.
    - `r5`: An unused parameter.
    - `_ret`: A pointer to store the result of the syscall.
- **Logic and Control Flow**:
    - Check if the instruction context is valid; return an error if not.
    - Calculate the cost of accessing the system variable and update the compute units.
    - Verify if the output address is valid under stricter ABI constraints; return an error if invalid.
    - Prepare a query for translating the virtual address to a hardware address.
    - Load the system variable identifier from memory.
    - Check for arithmetic overflow when adding offset and size; return an error if overflow occurs.
    - Compare the system variable identifier against known identifiers; set return value to 2 if no match is found.
    - Query the system variable cache for the data; set return value to 2 if not found.
    - Check if the offset plus size exceeds the buffer length; set return value to 1 if it does.
    - If size is zero, set return value to 0 and return success.
    - Copy the system variable data to the output address and set return value to 0.
- **Output**: Returns `FD_VM_SUCCESS` on success, with `_ret` set to 0, 1, or 2 depending on the outcome of the checks and operations.


---
### fd\_vm\_syscall\_sol\_get\_epoch\_stake<!-- {{#callable:fd_vm_syscall_sol_get_epoch_stake}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_runtime.c#L259>)

Retrieves the stake for a given vote address or the total active stake on the cluster if the address is zero.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine context.
    - `var_addr`: The address of the variable; if zero, the function returns the total active stake on the cluster.
    - `r2`: Unused parameter.
    - `r3`: Unused parameter.
    - `r4`: Unused parameter.
    - `r5`: Unused parameter.
    - `_ret`: A pointer to store the result of the syscall.
- **Logic and Control Flow**:
    - Cast `_vm` to `fd_vm_t` pointer `vm`.
    - Check if `var_addr` is zero; if true, update compute units and set `_ret` to the total active stake using `fd_bank_total_epoch_stake_get`.
    - If `var_addr` is not zero, update compute units with memory operation and syscall base cost.
    - Load the vote address from memory using `FD_VM_MEM_HADDR_LD`.
    - Query the previous vote states using `fd_bank_vote_states_prev_locking_query`.
    - Find the vote state element for the vote address using `fd_vote_states_query_const`.
    - Set `_ret` to the stake of the vote state element if found, otherwise set it to zero.
    - End the locking query with `fd_bank_vote_states_prev_end_locking_query`.
    - Return `FD_VM_SUCCESS`.
- **Output**: Returns `FD_VM_SUCCESS` and sets `_ret` to the stake value or total active stake.


---
### fd\_vm\_syscall\_sol\_get\_stack\_height<!-- {{#callable:fd_vm_syscall_sol_get_stack_height}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_runtime.c#L299>)

Retrieves the current stack height from the virtual machine's instruction context.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine instance (`fd_vm_t`).
    - `r1`: Unused parameter.
    - `r2`: Unused parameter.
    - `r3`: Unused parameter.
    - `r4`: Unused parameter.
    - `r5`: Unused parameter.
    - `_ret`: A pointer to a `ulong` where the function will store the stack height.
- **Logic and Control Flow**:
    - Cast `_vm` to a `fd_vm_t` pointer and store it in `vm`.
    - Update the compute unit cost using `FD_VM_CU_UPDATE` with `FD_VM_SYSCALL_BASE_COST`.
    - Retrieve the stack height from `vm->instr_ctx->txn_ctx->instr_stack_sz` and store it in `_ret`.
    - Return `FD_VM_SUCCESS` to indicate successful execution.
- **Output**: Returns `FD_VM_SUCCESS` and stores the stack height in the location pointed to by `_ret`.


---
### fd\_vm\_syscall\_sol\_get\_return\_data<!-- {{#callable:fd_vm_syscall_sol_get_return_data}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_runtime.c#L316>)

Retrieves return data and program ID from a virtual machine context and copies them to specified memory addresses.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine context.
    - `return_data_vaddr`: The virtual address where the return data should be copied.
    - `sz`: The maximum size of the return data to copy.
    - `program_id_vaddr`: The virtual address where the program ID should be copied.
    - `r4`: Unused parameter.
    - `r5`: Unused parameter.
    - `_ret`: A pointer to store the length of the return data.
- **Logic and Control Flow**:
    - Cast `_vm` to `fd_vm_t` type.
    - Update the compute unit cost using `FD_VM_CU_UPDATE` with `FD_VM_SYSCALL_BASE_COST`.
    - Retrieve the return data from the transaction context of the instruction context.
    - Calculate the minimum of the return data length and `sz` to determine the length to copy.
    - If the length is non-zero, update the compute unit cost based on the length and size of `fd_pubkey_t`.
    - Create `fd_vm_haddr_query_t` structures for return data and program ID with specified virtual addresses and sizes.
    - Translate the virtual addresses to hardware addresses using `FD_VM_TRANSLATE_MUT`.
    - Copy the return data and program ID to the translated hardware addresses using `memcpy`.
    - Store the length of the return data in `_ret`.
    - Return `FD_VM_SUCCESS` to indicate successful execution.
- **Output**: Returns `FD_VM_SUCCESS` and sets `_ret` to the length of the return data.


---
### fd\_vm\_syscall\_sol\_set\_return\_data<!-- {{#callable:fd_vm_syscall_sol_set_return_data}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_runtime.c#L369>)

Sets the return data for a virtual machine (VM) execution context in the Solana runtime.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine instance.
    - `src_vaddr`: The source virtual address from which to copy the return data.
    - `src_sz`: The size of the data to copy from the source address.
    - `r3`: Unused parameter.
    - `r4`: Unused parameter.
    - `r5`: Unused parameter.
    - `_ret`: A pointer to store the result of the syscall execution.
- **Logic and Control Flow**:
    - Cast `_vm` to `fd_vm_t` type and check if the VM is attached to an instruction context; return `FD_VM_SYSCALL_ERR_OUTSIDE_RUNTIME` if not.
    - Update the compute units (CU) used by the VM based on the base cost and the size of the data to be copied.
    - Check if `src_sz` exceeds `FD_VM_RETURN_DATA_MAX`; if so, log the error and return `FD_VM_SYSCALL_ERR_RETURN_DATA_TOO_LARGE`.
    - Load the source data from the VM memory using `src_vaddr` and `src_sz`.
    - Retrieve the last program key from the instruction context; log and return the error if retrieval fails.
    - Set the length of the return data in the transaction context to `src_sz`.
    - If `src_sz` is not zero, copy the data from the source to the return data buffer.
    - Set the program ID in the return data to the retrieved program ID.
    - Set the result pointer `_ret` to 0 and return `FD_VM_SUCCESS`.
- **Output**: Returns `FD_VM_SUCCESS` on success, or an error code if an error occurs. The result of the syscall execution is stored in `_ret`.


---
### fd\_vm\_syscall\_sol\_get\_processed\_sibling\_instruction<!-- {{#callable:fd_vm_syscall_sol_get_processed_sibling_instruction}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_runtime.c#L439>)

Retrieves and processes a sibling instruction from the instruction trace based on the given index and stack height, and stores the result in specified memory addresses.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine instance.
    - `index`: The index of the sibling instruction to retrieve.
    - `result_meta_vaddr`: The virtual address where the result metadata will be stored.
    - `result_program_id_vaddr`: The virtual address where the result program ID will be stored.
    - `result_data_vaddr`: The virtual address where the result data will be stored.
    - `result_accounts_vaddr`: The virtual address where the result accounts will be stored.
    - `_ret`: A pointer to a ulong where the function will store the result status (1 if a sibling instruction is found, 0 otherwise).
- **Logic and Control Flow**:
    - Update the compute cost using `FD_VM_CU_UPDATE` with `FD_VM_SYSCALL_BASE_COST`.
    - Retrieve the current instruction stack height from the virtual machine's transaction context.
    - Iterate through the instruction trace in reverse, checking for instructions at the same stack height.
    - If a matching instruction is found at the specified index, store its context and break the loop.
    - If a matching instruction context is found, translate the result addresses and copy the instruction data, program ID, and account information to the specified addresses.
    - If the data length and account count do not match, update the result metadata with the actual sizes.
    - Set `_ret` to 1 if a sibling instruction is found, otherwise set it to 0.
    - Return `FD_VM_SUCCESS` to indicate successful execution.
- **Output**: Returns `FD_VM_SUCCESS` and sets `_ret` to 1 if a sibling instruction is found, otherwise sets `_ret` to 0.


---
### fd\_vm\_syscall\_sol\_get\_epoch\_rewards\_sysvar<!-- {{#callable:fd_vm_syscall_sol_get_epoch_rewards_sysvar}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_runtime.c#L583>)

Retrieves the epoch rewards system variable and writes it to a specified memory address in the virtual machine.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine instance.
    - `out_vaddr`: The virtual address where the epoch rewards data will be written.
    - `r2`: Unused parameter.
    - `r3`: Unused parameter.
    - `r4`: Unused parameter.
    - `r5`: Unused parameter.
    - `_ret`: A pointer to a variable where the function will store the return status.
- **Logic and Control Flow**:
    - Cast `_vm` to `fd_vm_t` and retrieve the instruction context from it.
    - Check if the instruction context is NULL; if so, return `FD_VM_SYSCALL_ERR_OUTSIDE_RUNTIME`.
    - Update the compute unit cost using `FD_VM_CU_UPDATE`.
    - Check if `out_vaddr` is within a restricted memory region; if so, log an error and return `FD_VM_ERR_INVAL`.
    - Calculate the host address for the output using `FD_VM_MEM_HADDR_ST`.
    - Attempt to read the epoch rewards from the system variable cache; if unsuccessful, log an error and return `FD_VM_ERR_INVAL`.
    - Copy the epoch rewards data to the calculated host address.
    - Add padding to the copied data.
    - Set the return value to 0 and return `FD_VM_SUCCESS`.
- **Output**: Returns `FD_VM_SUCCESS` on success, or an error code on failure, and sets `_ret` to 0 on success.



---
Made with ❤️ by [Driver](https://www.driver.ai/)