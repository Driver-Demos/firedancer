<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for virtual machine syscalls, including memory operations and logging, with direct mapping toggling.

# Purpose
The code is a C program designed to test various system call functionalities within a virtual machine context. It includes a series of test functions that validate memory operations such as `memset`, `memcpy`, `memmove`, and `memcmp`, as well as logging operations like `log`, `log_64`, and `log_data`. These tests are executed with different configurations, including enabling and disabling direct memory mapping. The program uses a virtual machine (`fd_vm_t`) to simulate these operations and checks for expected results and errors, ensuring that the system calls behave as intended under various conditions.

The program initializes a virtual machine environment, sets up memory regions, and executes tests to verify the correct implementation of system calls. It includes a [`main`](<#main>) function that orchestrates the setup and execution of these tests, logging the results and any errors encountered. The code also includes a function to dump the syscall table, which provides a list of registered system calls and their associated keys. This program is intended to be run as an executable, and it serves as a test suite to ensure the reliability and correctness of system call implementations in a virtual machine environment.
# Imports and Dependencies

---
- `fd_vm_syscall.h`
- `../test_vm_util.h`


# Functions

---
### set\_memory\_region<!-- {{#callable:set_memory_region}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/test_vm_syscalls.c#L4>)

Initializes a memory region with a sequence of bytes where each byte is the lower 8 bits of its index.
- **Inputs**:
    - ``mem``: A pointer to the start of the memory region to initialize.
    - ``sz``: The size of the memory region to initialize, in bytes.
- **Logic and Control Flow**:
    - Iterates over each byte in the memory region from index 0 to `sz-1`.
    - For each index `i`, assigns the byte at `mem[i]` to the value of `i & 0xffUL`, which is the lower 8 bits of `i`.
- **Output**: No return value; the function modifies the memory region pointed to by `mem` in place.


---
### test\_vm\_syscall\_toggle\_direct\_mapping<!-- {{#callable:test_vm_syscall_toggle_direct_mapping}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/test_vm_syscalls.c#L6>)

Toggles the direct mapping and stricter ABI/runtime constraints for a virtual machine context based on the enable flag.
- **Inputs**:
    - ``vm_ctx``: A pointer to the `fd_vm_t` structure representing the virtual machine context.
    - ``enable``: An integer flag indicating whether to enable (1) or disable (0) direct mapping and stricter ABI/runtime constraints.
- **Logic and Control Flow**:
    - Determine the `slot` value based on the `enable` flag; set to `0UL` if enabled, otherwise `FD_FEATURE_DISABLED`.
    - Define an array `one_offs` with two constant string values.
    - Call `fd_features_enable_one_offs` to enable or disable specific features in the virtual machine's transaction context based on the `slot` value.
    - Set `vm_ctx->direct_mapping` to the value of `enable`.
    - Set `vm_ctx->stricter_abi_and_runtime_constraints` to the value of `enable`.
- **Output**: No return value; modifies the `vm_ctx` structure in place.


---
### test\_vm\_syscall\_sol\_memset<!-- {{#callable:test_vm_syscall_sol_memset}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/test_vm_syscalls.c#L15>)

Tests the `fd_vm_syscall_sol_memset` function by setting a memory region in a virtual machine and verifying the result.
- **Inputs**:
    - `test_case_name`: A string that describes the test case.
    - `vm`: A pointer to the virtual machine (`fd_vm_t`) where the memory operation will occur.
    - `dst_vaddr`: The virtual address in the VM where the memory will be set.
    - `dst_haddr`: The host address corresponding to the virtual address where the memory will be set.
    - `val`: The value to set in the memory region.
    - `sz`: The size of the memory region to set.
    - `expected_ret`: The expected return value from the `fd_vm_syscall_sol_memset` function.
    - `expected_err`: The expected error code from the `fd_vm_syscall_sol_memset` function.
- **Logic and Control Flow**:
    - Initializes the memory region of the VM's heap using [`set_memory_region`](<#set_memory_region>).
    - Calls `fd_vm_syscall_sol_memset` to set the memory region and stores the return value and error code.
    - Verifies that the return value and error code match the expected values using `FD_TEST`.
    - If the return value and error code indicate success, creates an expected memory block with the specified value and size, and verifies that the memory at the host address matches this block using `FD_TEST`.
    - Clears the transaction context error using `test_vm_clear_txn_ctx_err`.
    - Logs a notice indicating the test case passed.
- **Output**: No direct output; the function logs a notice if the test passes and uses assertions to verify correctness.
- **Functions Called**:
    - [`set_memory_region`](<#set_memory_region>)


---
### test\_vm\_syscall\_sol\_memcpy<!-- {{#callable:test_vm_syscall_sol_memcpy}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/test_vm_syscalls.c#L41>)

Tests the `fd_vm_syscall_sol_memcpy` function by setting up memory regions, performing a memory copy operation, and verifying the results against expected values.
- **Inputs**:
    - ``test_case_name``: A string representing the name of the test case.
    - ``vm``: A pointer to the virtual machine context (`fd_vm_t`).
    - ``src_vaddr``: The source virtual address for the memory copy.
    - ``dst_vaddr``: The destination virtual address for the memory copy.
    - ``src_haddr``: The source host address for the memory copy.
    - ``dst_haddr``: The destination host address for the memory copy.
    - ``sz``: The size of the memory to copy.
    - ``expected_ret``: The expected return value from the `fd_vm_syscall_sol_memcpy` function.
    - ``expected_err``: The expected error code from the `fd_vm_syscall_sol_memcpy` function.
- **Logic and Control Flow**:
    - Initializes the memory region of the virtual machine's heap using [`set_memory_region`](<#set_memory_region>).
    - Calls `fd_vm_syscall_sol_memcpy` to perform the memory copy operation from `src_vaddr` to `dst_vaddr` with the specified size `sz`.
    - Checks if the return value `ret` matches `expected_ret` and if the error code `err` matches `expected_err` using `FD_TEST`.
    - If the return value and error code are both zero, verifies that the memory content at `dst_haddr` matches `src_haddr` using `memcmp`.
    - Clears the transaction context error using `test_vm_clear_txn_ctx_err`.
    - Logs a notice indicating the test case has passed.
- **Output**: No direct output is returned; the function logs the result of the test case and performs assertions to validate the memory copy operation.
- **Functions Called**:
    - [`set_memory_region`](<#set_memory_region>)


---
### test\_vm\_syscall\_sol\_memcmp<!-- {{#callable:test_vm_syscall_sol_memcmp}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/test_vm_syscalls.c#L64>)

Tests the `fd_vm_syscall_sol_memcmp` function by comparing memory regions in a virtual machine and verifying the results against expected values.
- **Inputs**:
    - ``test_case_name``: A string representing the name of the test case.
    - ``vm``: A pointer to the virtual machine context (`fd_vm_t`).
    - ``vaddr_1``: The first virtual address for memory comparison.
    - ``vaddr_2``: The second virtual address for memory comparison.
    - ``vm_cmp_result_addr``: The virtual address where the comparison result is stored.
    - ``haddr_1``: The first host address for memory comparison.
    - ``haddr_2``: The second host address for memory comparison.
    - ``host_cmp_result_addr``: The host address where the comparison result is stored.
    - ``sz``: The size of the memory regions to compare.
    - ``expected_ret``: The expected return value from the `fd_vm_syscall_sol_memcmp` function.
    - ``expected_err``: The expected error code from the `fd_vm_syscall_sol_memcmp` function.
- **Logic and Control Flow**:
    - Initialize `ret` to 0 and `err` to the result of `fd_vm_syscall_sol_memcmp` with the provided virtual machine and addresses.
    - Verify that the return value `ret` matches `expected_ret` and the error code `err` matches `expected_err` using `FD_TEST`.
    - If `ret` and `err` are both zero, perform a host memory comparison using `memcmp` and verify the result against the value at `host_cmp_result_addr`.
    - Clear any transaction context errors using `test_vm_clear_txn_ctx_err`.
    - Log a notice indicating the test case passed using `FD_LOG_NOTICE`.
- **Output**: No direct output is returned; the function uses assertions to validate behavior and logs the test result.


---
### test\_vm\_syscall\_sol\_memmove<!-- {{#callable:test_vm_syscall_sol_memmove}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/test_vm_syscalls.c#L87>)

Tests the `fd_vm_syscall_sol_memmove` function by setting up memory regions, performing a memory move operation, and verifying the results against expected values.
- **Inputs**:
    - `test_case_name`: A string that names the test case.
    - `vm`: A pointer to the virtual machine context (`fd_vm_t`).
    - `src_vaddr`: The source virtual address for the memory move.
    - `dst_vaddr`: The destination virtual address for the memory move.
    - `src_haddr`: The source host address for the memory move.
    - `dst_haddr`: The destination host address for the memory move.
    - `sz`: The size of the memory block to move.
    - `expected_ret`: The expected return value from the syscall.
    - `expected_err`: The expected error code from the syscall.
- **Logic and Control Flow**:
    - Calls [`set_memory_region`](<#set_memory_region>) to initialize the memory region of the virtual machine's heap.
    - Allocates a temporary buffer `temp` of size `sz` and checks if the allocation is successful.
    - Copies data from `src_haddr` to `temp` using `memcpy`.
    - Calls `fd_vm_syscall_sol_memmove` to perform the memory move operation from `src_vaddr` to `dst_vaddr` and stores the result in `ret` and `err`.
    - Verifies that `ret` matches `expected_ret` and `err` matches `expected_err` using `FD_TEST`.
    - If `ret` and `err` are zero, verifies that the data at `dst_haddr` matches `temp` using `memcmp`.
    - Frees the temporary buffer `temp`.
    - Clears the transaction context error using `test_vm_clear_txn_ctx_err`.
    - Logs a notice indicating the test case passed.
- **Output**: No direct output is returned; the function logs the result of the test case and performs assertions to verify correctness.
- **Functions Called**:
    - [`set_memory_region`](<#set_memory_region>)


---
### test\_vm\_syscall\_sol\_log<!-- {{#callable:test_vm_syscall_sol_log}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/test_vm_syscalls.c#L115>)

Tests the `fd_vm_syscall_sol_log` function by verifying its return value, error code, and log output against expected values.
- **Inputs**:
    - `test_case_name`: A string that identifies the test case.
    - `vm`: A pointer to the virtual machine context (`fd_vm_t`).
    - `msg_vaddr`: The virtual address of the message to log.
    - `msg_len`: The length of the message to log.
    - `expected_ret`: The expected return value from the syscall.
    - `expected_err`: The expected error code from the syscall.
    - `expected_log`: A pointer to the expected log message.
    - `expected_log_sz`: The size of the expected log message.
- **Logic and Control Flow**:
    - Retrieve the log collector from the virtual machine's transaction context.
    - Get the current length of the log vector using `fd_log_collector_debug_len`.
    - Call `fd_vm_syscall_sol_log` with the provided parameters and store the return value and error code.
    - Verify that the return value and error code match the expected values using `FD_TEST`.
    - If the syscall succeeds (no error and return value is zero), verify that the log vector length has increased by one.
    - Retrieve the logged message and its size using `fd_log_collector_debug_get`.
    - Verify that the logged message matches the expected log and size using `FD_TEST`.
    - Clear any transaction context errors using `test_vm_clear_txn_ctx_err`.
    - Log a notice indicating the test case passed.
- **Output**: No return value; the function uses assertions to validate behavior and logs a notice upon successful completion.


---
### test\_vm\_syscall\_sol\_log\_64<!-- {{#callable:test_vm_syscall_sol_log_64}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/test_vm_syscalls.c#L141>)

Tests the `fd_vm_syscall_sol_log_64` function by verifying its return value, error code, and log output against expected values.
- **Inputs**:
    - ``test_case_name``: A string representing the name of the test case.
    - ``vm``: A pointer to the `fd_vm_t` structure representing the virtual machine context.
    - ``r1``: An unsigned long integer representing the first register value to log.
    - ``r2``: An unsigned long integer representing the second register value to log.
    - ``r3``: An unsigned long integer representing the third register value to log.
    - ``r4``: An unsigned long integer representing the fourth register value to log.
    - ``r5``: An unsigned long integer representing the fifth register value to log.
    - ``expected_ret``: An unsigned long integer representing the expected return value from the syscall.
    - ``expected_err``: An integer representing the expected error code from the syscall.
    - ``expected_log``: A pointer to an array of unsigned characters representing the expected log message.
    - ``expected_log_sz``: An unsigned long integer representing the expected size of the log message.
- **Logic and Control Flow**:
    - Initialize a pointer to the log collector from the virtual machine's transaction context.
    - Get the current length of the log vector using `fd_log_collector_debug_len`.
    - Call `fd_vm_syscall_sol_log_64` with the provided register values and store the return value and error code.
    - Verify that the return value and error code match the expected values using `FD_TEST`.
    - If the return value and error code are both zero, indicating success, verify that the log vector length has increased by one.
    - Retrieve the new log message and its size using `fd_log_collector_debug_get`.
    - Verify that the size of the retrieved log message matches the expected size and that the message content matches the expected log using `memcmp`.
    - Clear any transaction context errors using `test_vm_clear_txn_ctx_err`.
    - Log a notice indicating the test case has passed.
- **Output**: No return value; the function performs tests and logs results.


---
### test\_vm\_syscall\_sol\_log\_data<!-- {{#callable:test_vm_syscall_sol_log_data}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/test_vm_syscalls.c#L170>)

Tests the `fd_vm_syscall_sol_log_data` function by verifying its return value, error code, and log output against expected values.
- **Inputs**:
    - `test_case_name`: A string that identifies the test case.
    - `vm`: A pointer to the `fd_vm_t` structure representing the virtual machine context.
    - `data_vaddr`: The virtual address of the data to log.
    - `data_len`: The length of the data to log.
    - `expected_ret`: The expected return value from the syscall.
    - `expected_err`: The expected error code from the syscall.
    - `expected_log`: A pointer to the expected log data.
    - `expected_log_sz`: The size of the expected log data.
- **Logic and Control Flow**:
    - Initialize a pointer to the log collector from the virtual machine's transaction context.
    - Get the current length of the log vector using `fd_log_collector_debug_len`.
    - Call `fd_vm_syscall_sol_log_data` with the provided virtual machine context and data parameters, storing the return value and error code.
    - Verify that the return value and error code match the expected values using `FD_TEST`.
    - If the return value and error code indicate success, verify that the log vector length has increased by one.
    - Retrieve the logged message and its size using `fd_log_collector_debug_get`.
    - Verify that the logged message size and content match the expected log data using `FD_TEST`.
    - Clear any transaction context errors using `test_vm_clear_txn_ctx_err`.
    - Log a notice indicating the test case has passed.
- **Output**: No return value; the function performs tests and logs results.


---
### dump\_syscall\_table<!-- {{#callable:dump_syscall_table}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/test_vm_syscalls.c#L197>)

Logs the registered system calls in the system call table.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize a local array `_syscalls` to store system call entries.
    - Create a pointer `syscalls` by joining the newly created system call table from `_syscalls`.
    - Verify that `syscalls` is not null using `FD_TEST`.
    - Register all system calls to `syscalls` and check for success using `FD_TEST`.
    - Log the message 'Syscall table' to indicate the start of the table dump.
    - Iterate over each slot in the system call table, checking if the `func` field of each entry is not null.
    - For each valid entry, log the key and name of the system call.
    - Delete the system call table by leaving and deleting `syscalls`.
- **Output**: No return value; outputs are logged to the system log.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/test_vm_syscalls.c#L216>)

Initializes and tests a virtual machine environment with various memory operations and logging functionalities.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: The array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Creates and joins a random number generator (`fd_rng_t`), SHA-256 context (`fd_sha256_t`), and virtual machine (`fd_vm_t`).
    - Initializes a read-only data region (`rodata`) and sets its memory.
    - Sets up multiple input memory regions with specific sizes and properties.
    - Initializes instruction and transaction contexts for the virtual machine.
    - Calls `fd_vm_init` to initialize the virtual machine with various parameters including memory regions and constraints.
    - Runs a series of tests on the virtual machine, including memory set (`memset`), copy (`memcpy`), move (`memmove`), compare (`memcmp`), and logging operations (`log`, `log_64`, `log_data`).
    - Tests are conducted with direct mapping both enabled and disabled.
    - Deletes and leaves the virtual machine, SHA-256 context, and random number generator.
    - Calls [`dump_syscall_table`](<#dump_syscall_table>) to log the syscall table.
    - Logs a notice indicating the tests passed and halts the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`set_memory_region`](<#set_memory_region>)
    - [`test_vm_syscall_toggle_direct_mapping`](<#test_vm_syscall_toggle_direct_mapping>)
    - [`test_vm_syscall_sol_memset`](<#test_vm_syscall_sol_memset>)
    - [`test_vm_syscall_sol_memcpy`](<#test_vm_syscall_sol_memcpy>)
    - [`test_vm_syscall_sol_memmove`](<#test_vm_syscall_sol_memmove>)
    - [`test_vm_syscall_sol_memcmp`](<#test_vm_syscall_sol_memcmp>)
    - [`test_vm_syscall_sol_log`](<#test_vm_syscall_sol_log>)
    - [`test_vm_syscall_sol_log_64`](<#test_vm_syscall_sol_log_64>)
    - [`test_vm_syscall_sol_log_data`](<#test_vm_syscall_sol_log_data>)
    - [`dump_syscall_table`](<#dump_syscall_table>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)