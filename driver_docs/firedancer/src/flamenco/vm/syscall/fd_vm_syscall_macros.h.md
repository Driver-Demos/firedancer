<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Macros for managing virtual machine compute units and memory address translations in syscall implementations.

# Purpose
The code is a C header file that defines a set of macros and a structure to facilitate virtual memory management and system call handling in a virtual machine (VM) environment. The primary focus of the code is to manage compute units and memory address translations within the VM, ensuring that operations conform to the VM-syscall ABI interface. The macros provided in the file are intended for use by syscall implementations, allowing them to charge compute units, translate virtual addresses to host addresses, and handle memory operations with checks for alignment and overlapping regions.

Key components include the `FD_VM_CU_UPDATE` and `FD_VM_CU_MEM_OP_UPDATE` macros, which manage compute unit consumption, and the `FD_VM_MEM_HADDR_LD` and `FD_VM_MEM_HADDR_ST` macros, which handle memory address translations for read and write operations, respectively. The `fd_vm_haddr_query` structure is used to store information about virtual addresses and their corresponding host addresses. The file also includes macros for checking non-overlapping memory regions and translating multiple memory queries, ensuring robust memory management within the VM. The code is designed to be integrated into a larger system, providing essential functionality for managing virtual memory and compute resources in a VM environment.
# Imports and Dependencies

---
- `../fd_vm_private.h`


# Data Structures

---
### fd\_vm\_haddr\_query
- **Type**: ``struct``
- **Members**:
    - ``vaddr``: Virtual address to be queried.
    - ``align``: Alignment requirement for the virtual address.
    - ``sz``: Size of the memory region to be queried.
    - ``is_slice``: Indicates if the query is for a slice.
    - ``haddr``: Host address corresponding to the virtual address, set on success.
- **Description**: Contains information for querying a virtual address translation, including the virtual address, alignment, size, and whether it is a slice. The `haddr` field is used to store the resulting host address after translation. This structure is used in memory translation operations, particularly by the `FD_VM_TRANSLATE_MUT` macro, to facilitate the mapping of virtual addresses to host addresses in a virtual machine environment.


---
### fd\_vm\_haddr\_query\_t
- **Type**: ``struct``
- **Members**:
    - ``vaddr``: Virtual address to be queried.
    - ``align``: Alignment requirement for the virtual address.
    - ``sz``: Size of the memory region to be queried.
    - ``is_slice``: Indicates if the query is for a slice.
    - ``haddr``: Host address corresponding to the virtual address, set on success.
- **Description**: Contains information about a virtual address (`vaddr`), its alignment (`align`), size (`sz`), and whether it is a slice (`is_slice`). The `haddr` field is used to store the translated host address on successful translation. This structure is primarily used by the `FD_VM_TRANSLATE_MUT` macro to facilitate memory address translation in a virtual machine environment.


# Functions

---
### FD\_VM\_MEM\_HADDR\_ST\_<!-- {{#callable:FD_VM_MEM_HADDR_ST_}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_macros.h#L125>)

Translates a virtual address to a host address for a virtual machine, ensuring alignment and size constraints are met, and returns an error code if any checks fail.
- **Inputs**:
    - `vm`: A pointer to the `fd_vm_t` structure representing the virtual machine context.
    - `vaddr`: The virtual address to be translated.
    - `align`: The required alignment for the host address.
    - `sz`: The size of the memory region to be accessed.
    - `err`: A pointer to an integer where the function will store an error code if an error occurs.
- **Logic and Control Flow**:
    - Initialize local variables `_vm`, `_vaddr`, and `_haddr` using the input parameters and a call to `fd_vm_mem_haddr` to translate the virtual address to a host address.
    - Check if the size `sz` exceeds `LONG_MAX`. If true, log an invalid length error, set `*err` to `FD_VM_SYSCALL_ERR_SEGFAULT`, and return `0`.
    - Check if `_haddr` is `0` (indicating a failed address translation). If true, log an access violation error, set `*err` to `FD_VM_SYSCALL_ERR_SEGFAULT`, and return `0`.
    - Check if `_sigbus` is true (indicating an alignment issue). If true, log an unaligned pointer error, set `*err` to `FD_VM_SYSCALL_ERR_SEGFAULT`, and return `0`.
    - Return the translated host address `_haddr` cast to a `void *`.
- **Output**: Returns a `void *` pointer to the translated host address if successful, or `0` if an error occurs, with the error code stored in `*err`.



---
Made with ❤️ by [Driver](https://www.driver.ai/)