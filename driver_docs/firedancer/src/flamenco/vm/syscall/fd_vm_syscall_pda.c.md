<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for deriving and validating program-derived addresses (PDAs) using seeds and program IDs in a virtual machine environment.

# Purpose
The code provides functionality for deriving and validating Program Derived Addresses (PDAs) within a virtual machine (VM) environment. It includes several functions that handle the translation and validation of input data, such as seeds and program IDs, and perform the necessary cryptographic operations to derive PDAs. The primary functions are [`fd_vm_derive_pda`](<#fd_vm_derive_pda>), [`fd_vm_translate_and_check_program_address_inputs`](<#fd_vm_translate_and_check_program_address_inputs>), [`fd_vm_syscall_sol_create_program_address`](<#fd_vm_syscall_sol_create_program_address>), and [`fd_vm_syscall_sol_try_find_program_address`](<#fd_vm_syscall_sol_try_find_program_address>). These functions are responsible for checking input constraints, performing SHA-256 hashing, and validating the resulting PDAs against the ed25519 curve.

The code is structured to handle both direct PDA creation and iterative attempts to find a valid PDA using a bump seed. It includes error handling for various failure scenarios, such as invalid seeds or memory access issues. The functions are designed to be used as part of a larger system, likely involving a VM that executes programs requiring secure address derivation. The code also references external libraries for cryptographic operations and includes specific checks and translations to ensure compatibility with the VM's memory model.
# Imports and Dependencies

---
- `fd_vm_syscall.h`
- `../../../ballet/ed25519/fd_curve25519.h`


# Functions

---
### fd\_vm\_derive\_pda<!-- {{#callable:fd_vm_derive_pda}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_pda.c#L20>)

Derives a Program Derived Address (PDA) using seeds, a program ID, and an optional bump seed, while performing various checks and validations.
- **Inputs**:
    - `vm`: A pointer to the virtual machine (`fd_vm_t`) used for logging and SHA-256 operations.
    - `program_id`: A constant pointer to the program ID (`fd_pubkey_t`) used in the PDA derivation.
    - `seed_haddrs`: An array of constant pointers to seed addresses in host memory.
    - `seed_szs`: An array of unsigned long integers representing the sizes of each seed.
    - `seeds_cnt`: An unsigned long integer representing the count of seeds.
    - `bump_seed`: An optional pointer to a bump seed (`uchar`) used in the PDA derivation.
    - `out`: A pointer to the output location (`fd_pubkey_t`) where the derived PDA will be stored.
- **Logic and Control Flow**:
    - Checks if `seeds_cnt` exceeds `FD_VM_PDA_SEEDS_MAX` and returns an error if true.
    - Checks if the total number of seeds plus the bump seed exceeds `FD_VM_PDA_SEEDS_MAX` and returns an error if true.
    - Iterates over each seed to check if its size exceeds `FD_VM_PDA_SEED_MEM_MAX` and returns an error if true.
    - Initializes SHA-256 hashing context using `fd_sha256_init`.
    - Appends each non-zero length seed to the SHA-256 context using `fd_sha256_append`.
    - Appends the bump seed to the SHA-256 context if it exists.
    - Appends the program ID to the SHA-256 context if it is provided, otherwise logs an error.
    - Appends the string "ProgramDerivedAddress" to the SHA-256 context.
    - Finalizes the SHA-256 hash and stores the result in `out`.
    - Validates the derived PDA to ensure it is not a valid ed25519 curve point and returns an error if it is.
    - Returns `FD_VM_SUCCESS` if the PDA is valid.
- **Output**: Returns an integer status code: `FD_VM_SUCCESS` on success, `FD_VM_SYSCALL_ERR_BAD_SEEDS` if seed checks fail, or `FD_VM_SYSCALL_ERR_INVALID_PDA` if the derived PDA is a valid ed25519 curve point.


---
### fd\_vm\_translate\_and\_check\_program\_address\_inputs<!-- {{#callable:fd_vm_translate_and_check_program_address_inputs}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_pda.c#L100>)

Performs preflight checks and translates seeds and program ID for program address derivation.
- **Inputs**:
    - ``vm``: A pointer to the virtual machine context (`fd_vm_t`).
    - ``seeds_vaddr``: The virtual address of the seeds array.
    - ``seeds_cnt``: The number of seeds in the array.
    - ``program_id_vaddr``: The virtual address of the program ID.
    - ``out_seed_haddrs``: An output array to store translated host addresses of seeds.
    - ``out_seed_szs``: An output array to store sizes of each seed.
    - ``out_program_id``: An optional output pointer to store the translated program ID.
    - ``is_syscall``: A flag indicating if the function is called from a syscall.
- **Logic and Control Flow**:
    - Loads untranslated seeds from virtual memory using `FD_VM_MEM_SLICE_HADDR_LD` with alignment and size checks.
    - Checks if `seeds_cnt` exceeds `FD_VM_PDA_SEEDS_MAX`; logs an error and returns if true, with different error codes for syscall and non-syscall contexts.
    - Iterates over each seed, checking if its size exceeds `FD_VM_PDA_SEED_MEM_MAX` when `is_syscall` is true; logs an error and returns if true.
    - Translates each seed's address to a host address and stores it in `out_seed_haddrs`; stores each seed's size in `out_seed_szs`.
    - If `out_program_id` is not null, translates the program ID address to a host address and stores it in `out_program_id`.
- **Output**: Returns `FD_VM_SUCCESS` on successful translation and checks, or an error code if a check fails.


---
### fd\_vm\_syscall\_sol\_create\_program\_address<!-- {{#callable:fd_vm_syscall_sol_create_program_address}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_pda.c#L178>)

Creates a program-derived address (PDA) by hashing seeds and a program ID, and checks if the result is a valid ed25519 curve point.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine (VM) context.
    - `seeds_vaddr`: The virtual address of the first element of a seed byte array in the VM address space.
    - `seeds_cnt`: The number of elements in the seed array.
    - `program_id_vaddr`: The virtual address of the program ID public key in the VM address space.
    - `out_vaddr`: The virtual address where the resulting derived PDA will be written if the syscall is successful.
    - `r5`: An unused parameter.
    - `_ret`: A pointer to the return value of the syscall.
- **Logic and Control Flow**:
    - Cast the `_vm` pointer to a `fd_vm_t` type.
    - Update the VM's compute units using `FD_VM_CU_UPDATE`.
    - Translate and check the program address inputs using [`fd_vm_translate_and_check_program_address_inputs`](<#fd_vm_translate_and_check_program_address_inputs>).
    - If translation fails, set `*_ret` to 0 and return the error code.
    - Call [`fd_vm_derive_pda`](<#fd_vm_derive_pda>) to derive the PDA.
    - If PDA derivation fails with `FD_VM_SYSCALL_ERR_INVALID_PDA`, set `*_ret` to 1 and return `FD_VM_SUCCESS`.
    - If any other error occurs during PDA derivation, return the error code.
    - Prepare a `fd_vm_haddr_query_t` structure for the output address.
    - Translate the output address using `FD_VM_TRANSLATE_MUT`.
    - Copy the derived PDA to the output address.
    - Set `*_ret` to 0 and return `FD_VM_SUCCESS`.
- **Output**: Returns an integer status code indicating success or failure, and sets `*_ret` to 0 or 1 based on the outcome.
- **Functions Called**:
    - [`fd_vm_translate_and_check_program_address_inputs`](<#fd_vm_translate_and_check_program_address_inputs>)
    - [`fd_vm_derive_pda`](<#fd_vm_derive_pda>)


---
### fd\_vm\_syscall\_sol\_try\_find\_program\_address<!-- {{#callable:fd_vm_syscall_sol_try_find_program_address}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_pda.c#L253>)

Attempts to find a valid program-derived address (PDA) by iterating through possible bump seeds.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine instance.
    - `seeds_vaddr`: The virtual address of the seed array.
    - `seeds_cnt`: The number of seeds in the seed array.
    - `program_id_vaddr`: The virtual address of the program ID.
    - `out_vaddr`: The virtual address where the resulting PDA will be stored.
    - `out_bump_seed_vaddr`: The virtual address where the bump seed used to derive the PDA will be stored.
    - `_ret`: A pointer to store the return value of the syscall.
- **Logic and Control Flow**:
    - Cast `_vm` to `fd_vm_t *` and store it in `vm`.
    - Update the compute units using `FD_VM_CU_UPDATE` with `FD_VM_CREATE_PROGRAM_ADDRESS_UNITS`.
    - Initialize `bump_seed` array to store the current bump seed value.
    - Translate and check program address inputs using [`fd_vm_translate_and_check_program_address_inputs`](<#fd_vm_translate_and_check_program_address_inputs>).
    - If translation fails, set `*_ret` to `0UL` and return the error code.
    - Iterate over possible bump seeds from 255 down to 1.
    - For each bump seed, call [`fd_vm_derive_pda`](<#fd_vm_derive_pda>) to derive a PDA.
    - If a valid PDA is found, prepare queries for `out_bump_seed_vaddr` and `out_vaddr`.
    - Translate the queries using `FD_VM_TRANSLATE_MUT`.
    - Copy the derived PDA and bump seed to their respective output addresses.
    - Set `*_ret` to `0UL` and return `FD_VM_SUCCESS`.
    - If [`fd_vm_derive_pda`](<#fd_vm_derive_pda>) returns an error other than `FD_VM_SYSCALL_ERR_INVALID_PDA`, return the error code.
    - Update the compute units again for each iteration.
    - If no valid PDA is found after all iterations, set `*_ret` to `1UL` and return `FD_VM_SUCCESS`.
- **Output**: Returns `FD_VM_SUCCESS` if a valid PDA is found or after all iterations; otherwise, returns an error code.
- **Functions Called**:
    - [`fd_vm_translate_and_check_program_address_inputs`](<#fd_vm_translate_and_check_program_address_inputs>)
    - [`fd_vm_derive_pda`](<#fd_vm_derive_pda>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)