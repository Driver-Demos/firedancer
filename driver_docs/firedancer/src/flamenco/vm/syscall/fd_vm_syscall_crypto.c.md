<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements cryptographic syscalls for BN254 operations, Poseidon hashing, and secp256k1 recovery.

# Purpose
The code defines a set of system call functions for a virtual machine (`fd_vm_t`) that perform cryptographic operations using the BN254 curve, Poseidon hash function, and secp256k1 elliptic curve. The file includes functions for group operations ([`fd_vm_syscall_sol_alt_bn128_group_op`](<#fd_vm_syscall_sol_alt_bn128_group_op>)), compression and decompression of elliptic curve points ([`fd_vm_syscall_sol_alt_bn128_compression`](<#fd_vm_syscall_sol_alt_bn128_compression>)), Poseidon hashing ([`fd_vm_syscall_sol_poseidon`](<#fd_vm_syscall_sol_poseidon>)), and secp256k1 public key recovery ([`fd_vm_syscall_sol_secp256k1_recover`](<#fd_vm_syscall_sol_secp256k1_recover>)). Each function is designed to handle specific cryptographic tasks, updating the virtual machine's compute cost and translating memory addresses as needed.

The functions use various constants and helper functions to perform their tasks, such as `fd_bn254_g1_add_syscall` for elliptic curve addition and `fd_poseidon_init` for initializing the Poseidon hash function. The code handles different cases for each operation, checking for errors and returning appropriate status codes. The functions are intended to be used within a larger system that requires cryptographic operations, providing a modular interface for these tasks. The code also includes error handling and logging to ensure that invalid inputs or operations are managed correctly.
# Imports and Dependencies

---
- `fd_vm_syscall.h`
- `../../../ballet/bn254/fd_bn254.h`
- `../../../ballet/bn254/fd_poseidon.h`
- `../../../ballet/secp256k1/fd_secp256k1.h`


# Functions

---
### fd\_vm\_syscall\_sol\_alt\_bn128\_group\_op<!-- {{#callable:fd_vm_syscall_sol_alt_bn128_group_op}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_crypto.c#L7>)

Performs BN128 group operations such as addition, multiplication, and pairing based on the specified operation type.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine context.
    - `group_op`: An unsigned long indicating the type of group operation to perform (addition, multiplication, or pairing).
    - `input_addr`: An unsigned long representing the address of the input data in memory.
    - `input_sz`: An unsigned long representing the size of the input data.
    - `result_addr`: An unsigned long representing the address where the result should be stored.
    - `r5`: An unused parameter.
    - `_ret`: A pointer to an unsigned long where the function will store the result status (0 for success, 1 for error).
- **Logic and Control Flow**:
    - Initialize the virtual machine context and set the default return value to 1 (error).
    - Determine the operation type using the `group_op` parameter and set the corresponding output size and cost.
    - If the operation type is invalid, log an error and return an invalid attribute error code.
    - Update the virtual machine's compute units with the calculated cost.
    - Translate the result address to a hardware address and load the input data from memory.
    - Perform the specified group operation (addition, multiplication, or pairing) using the input data and store the result in the specified memory location.
    - Set the return value to 0 if the operation is successful.
    - Store the return status in the `_ret` pointer and return a success code.
- **Output**: Returns an integer status code indicating success (`FD_VM_SUCCESS`) or an error code if an invalid attribute is encountered. The result of the operation is stored in the memory location specified by `result_addr`, and the status of the operation is stored in the location pointed to by `_ret`.


---
### fd\_vm\_syscall\_sol\_alt\_bn128\_compression<!-- {{#callable:fd_vm_syscall_sol_alt_bn128_compression}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_crypto.c#L101>)

Handles compression and decompression operations for BN128 elliptic curve points in a virtual machine environment.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine context.
    - `op`: An operation code indicating the specific compression or decompression operation to perform.
    - `input_addr`: The memory address of the input data.
    - `input_sz`: The size of the input data.
    - `result_addr`: The memory address where the result should be stored.
    - `r5`: An unused parameter.
    - `_ret`: A pointer to store the return status of the operation.
- **Logic and Control Flow**:
    - Initialize the virtual machine context and set the default return value to indicate an error.
    - Determine the output size and cost based on the operation code using a switch statement.
    - Add the base cost to the operation cost and update the virtual machine's compute units.
    - Translate the result address to a host address and load the input data from the virtual machine memory.
    - Use a buffer to handle potential aliasing between input and result memory locations.
    - Perform the specified compression or decompression operation based on the operation code.
    - Check input size validity for each operation and perform the operation if valid, copying the result to the result address.
    - Set the return value to indicate success if the operation is successful.
    - Store the return status in the provided pointer and return a success code.
- **Output**: Returns an integer status code indicating success or error, and updates the provided return pointer with the operation result status.


---
### fd\_vm\_syscall\_sol\_poseidon<!-- {{#callable:fd_vm_syscall_sol_poseidon}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_crypto.c#L216>)

Computes the Poseidon hash for a given set of input values, handling various error conditions and updating the virtual machine's compute cost.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine context (`fd_vm_t`).
    - `params`: A parameter that must be zero, otherwise an error is returned.
    - `endianness`: Specifies the byte order; must be 0 for big endian or 1 for little endian.
    - `vals_addr`: The address of the input values in memory.
    - `vals_len`: The number of input values to process.
    - `result_addr`: The address where the result of the Poseidon hash will be stored.
    - `_ret`: A pointer to store the return status of the function.
- **Logic and Control Flow**:
    - Initialize the virtual machine context and set the default return value to 1 (indicating an error).
    - Check if `params` is not zero; if so, log an error and return an invalid parameters error code.
    - Check if `endianness` is not 0 or 1; if so, log an error and return an invalid endianness error code.
    - Check if `vals_len` exceeds the maximum allowed values; if so, log an error and return an invalid length error code.
    - Calculate the compute cost based on `vals_len` and update the virtual machine's compute units.
    - Translate the result address to a hardware address for storing the hash result.
    - If `vals_len` is zero, set the return value to 1 and jump to the soft error handling section.
    - Load the input values from memory and prepare them for hashing.
    - Initialize the Poseidon hash context with the specified endianness.
    - Append each input value to the Poseidon hash context; if any append fails, jump to the soft error handling section.
    - Finalize the Poseidon hash and store the result at the translated hardware address.
    - In the soft error handling section, set the return status and return success.
- **Output**: Returns `FD_VM_SUCCESS` with the result status stored in `_ret`, indicating success or a specific error.


---
### fd\_vm\_syscall\_sol\_secp256k1\_recover<!-- {{#callable:fd_vm_syscall_sol_secp256k1_recover}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_crypto.c#L333>)

Performs a secp256k1 public key recovery from a given hash, recovery ID, and signature, storing the result in a specified memory address.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine context.
    - `hash_vaddr`: The virtual address of the hash to use for recovery.
    - `recovery_id_val`: The recovery ID value, which must be less than 4.
    - `signature_vaddr`: The virtual address of the signature to use for recovery.
    - `result_vaddr`: The virtual address where the recovered public key will be stored.
    - `r5`: An unused parameter.
    - `_ret`: A pointer to a variable where the function will store the result code.
- **Logic and Control Flow**:
    - Cast `_vm` to `fd_vm_t` type and update the compute unit cost using `FD_VM_CU_UPDATE` with `FD_VM_SECP256K1_RECOVER_COST`.
    - Initialize a `fd_vm_haddr_query_t` structure for the result address and translate it using `FD_VM_TRANSLATE_MUT`.
    - Load the hash and signature from their respective virtual addresses using `FD_VM_MEM_HADDR_LD`.
    - Check if `recovery_id_val` is greater than or equal to 4; if so, set `*_ret` to 2 and return `FD_VM_SUCCESS`.
    - Attempt to recover the public key using `fd_secp256k1_recover`; if it fails, set `*_ret` to 3 and return `FD_VM_SUCCESS`.
    - Copy the recovered public key to the result address using `memcpy`.
    - Set `*_ret` to 0 to indicate success and return `FD_VM_SUCCESS`.
- **Output**: Returns `FD_VM_SUCCESS` and sets `*_ret` to 0 on success, or an error code (1, 2, or 3) on failure.



---
Made with ❤️ by [Driver](https://www.driver.ai/)