<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Common logic for C and Rust CPI syscalls, including macros to handle ABI differences and functions for translating and updating accounts.

# Purpose
The code is a C source file that implements common logic for Cross-Program Invocation (CPI) syscalls in both C and Rust environments. It abstracts the differences in Application Binary Interface (ABI) data layouts between C and Rust, allowing for a unified implementation of CPI syscalls. The file uses macros to handle ABI differences, ensuring that the core logic remains consistent across both languages. The entry point for these syscalls is defined by the macro [`VM_SYSCALL_CPI_ENTRYPOINT`](<#vm_syscall_cpi_entrypoint>).

The file contains several key functions and macros that facilitate the translation and execution of CPI instructions. These include [`VM_SYSCALL_CPI_INSTRUCTION_TO_INSTR_FUNC`](<#vm_syscall_cpi_instruction_to_instr_func>), which translates CPI ABI structures into a format executable by the runtime, and `VM_SYSCALL_CPI_UPDATE_CALLEE_ACC_FUNC`, which updates the callee's account view with changes made by the caller. Additionally, the file defines functions to update caller accounts after CPI execution and to translate and update accounts before execution. The code is closely aligned with the Solana codebase to ensure auditability and equivalence in execution, with references to specific lines in the Solana source code for clarity.
# Functions

---
### VM\_SYSCALL\_CPI\_INSTRUCTION\_TO\_INSTR\_FUNC<!-- {{#callable:VM_SYSCALL_CPI_INSTRUCTION_TO_INSTR_FUNC}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_cpi_common.c#L55>)

Converts a CPI instruction and its associated metadata into an internal instruction format for execution.
- **Inputs**:
    - `vm`: A pointer to the virtual machine handle.
    - `cpi_instr`: A constant pointer to the CPI instruction in the CPI ABI format.
    - `cpi_acct_metas`: A constant pointer to the list of account metadata in the CPI ABI format.
    - `program_id`: A constant pointer to the program ID public key.
    - `cpi_instr_data`: A constant pointer to the instruction data in host address space.
    - `out_instr`: A pointer to the output instruction structure to populate.
    - `out_instr_acct_keys`: An array to store the output instruction account keys.
- **Logic and Control Flow**:
    - Initialize `out_instr` with default values and set its data size and account count based on `cpi_instr`.
    - Find the index of the program account in the transaction context and update `out_instr->program_id` if found.
    - Initialize an array `acc_idx_seen` to track seen account indices.
    - Iterate over each account in `cpi_instr`, retrieve its metadata, and populate `out_instr_acct_keys` and `out_instr->accounts`.
    - For each account, find its index in the transaction and caller contexts, and set up the instruction account using `fd_instr_info_setup_instr_account`.
    - Return `FD_VM_SUCCESS` to indicate successful execution.
- **Output**: Returns an integer status code, `FD_VM_SUCCESS`, indicating successful execution.


---
### VM\_SYCALL\_CPI\_UPDATE\_CALLEE\_ACC\_FUNC<!-- {{#callable:VM_SYCALL_CPI_UPDATE_CALLEE_ACC_FUNC}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_cpi_common.c#L130>)

Updates the callee account's view with changes made by the caller before executing a CPI instruction.
- **Inputs**:
    - ``vm``: Pointer to the virtual machine handle.
    - ``caller_account``: Pointer to the caller account structure containing account details.
    - ``instr_acc_idx``: Index of the instruction account in the virtual machine's instruction context.
- **Logic and Control Flow**:
    - Borrow the callee account using `fd_exec_instr_ctx_try_borrow_instr_account` and check for errors.
    - If the callee account is missing from the borrowed accounts cache, return `FD_VM_SUCCESS`.
    - Compare the lamports of the callee account with the caller account; if different, update the callee account's lamports.
    - If `stricter_abi_and_runtime_constraints` is enabled, validate and update account length changes, ensuring they do not exceed reserved space.
    - If direct mapping is not enabled, copy the account data from the VM's serialized buffer back to the borrowed account.
    - If the owner of the callee account differs from the caller account, update the callee account's owner.
- **Output**: Returns `FD_VM_SUCCESS` on success or `-1` on error.


---
### VM\_SYSCALL\_CPI\_TRANSLATE\_AND\_UPDATE\_ACCOUNTS\_FUNC<!-- {{#callable:VM_SYSCALL_CPI_TRANSLATE_AND_UPDATE_ACCOUNTS_FUNC}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_cpi_common.c#L260>)

Translates caller accounts to the host address space and updates callee accounts with any changes made by the caller before a CPI call.
- **Inputs**:
    - `vm`: Pointer to the virtual machine handle.
    - `instruction_accounts`: Array of instruction accounts.
    - `instruction_accounts_cnt`: Length of the `instruction_accounts` array.
    - `acct_infos_va`: Virtual address of the account infos.
    - `account_info_keys`: Array of pointers to account info keys, same length as `account_infos_length`.
    - `account_infos`: Array of account infos.
    - `account_infos_length`: Length of the `account_infos` array.
    - `out_callee_indices`: Array to store indices of the callee accounts in the transaction.
    - `out_caller_indices`: Array to store indices of the caller accounts in the `account_infos` array.
    - `caller_accounts`: Array to store caller account information.
    - `out_len`: Pointer to store the length of the `out_callee_indices` and `out_caller_indices` arrays.
- **Logic and Control Flow**:
    - Iterates over each instruction account to check for duplicates and skips them.
    - For each unique account, borrows the account and checks if it is executable; if so, updates compute units and continues.
    - Drops the borrowed account to avoid double borrowing.
    - Finds the indices of the account in the caller and callee instructions.
    - If the account is writable, records the indices in `out_callee_indices` and `out_caller_indices` and increments `out_len`.
    - Performs checks on account info pointers and updates caller account metadata.
    - Calls [`VM_SYCALL_CPI_UPDATE_CALLEE_ACC_FUNC`](<#vm_sycall_cpi_update_callee_acc_func>) to update the callee account with any changes made by the caller.
    - If an account is not found, logs an error and returns an error code.
- **Output**: Returns an integer status code, `FD_VM_SUCCESS` on success or an error code on failure.
- **Functions Called**:
    - [`VM_SYCALL_CPI_UPDATE_CALLEE_ACC_FUNC`](<#vm_sycall_cpi_update_callee_acc_func>)


---
### VM\_SYSCALL\_CPI\_UPDATE\_CALLER\_ACC\_FUNC<!-- {{#callable:VM_SYSCALL_CPI_UPDATE_CALLER_ACC_FUNC}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_cpi_common.c#L521>)

Updates the caller account with changes made by the callee during a CPI instruction execution.
- **Inputs**:
    - `vm`: Pointer to the virtual machine handle.
    - `caller_acc_info`: Caller account info object, which should be updated.
    - `caller_account`: Pointer to the caller account structure to be updated.
    - `instr_acc_idx`: Index of the instruction account, marked as unused.
    - `pubkey`: Pointer to the public key of the account.
- **Logic and Control Flow**:
    - Attempt to borrow the callee account using the provided public key.
    - If borrowing fails with an error other than `FD_ACC_MGR_ERR_UNKNOWN_ACCOUNT`, return 1.
    - Retrieve the callee account from the borrowed account structure.
    - Update the caller account's lamports with the callee account's lamports.
    - Update the caller account's owner with the callee account's owner, or zero it if the owner is not available.
    - Retrieve the previous and post-update data lengths of the caller account.
    - Calculate the address space reserved for the account based on ABI constraints and loader status.
    - If the post-update length exceeds the reserved space and certain conditions are met, log an error and return `FD_EXECUTOR_INSTR_ERR_INVALID_REALLOC`.
    - If the data length has changed, adjust the serialized data buffer if direct mapping is not enabled.
    - If the account has shrunk, zero out the unused memory.
    - Set the serialized data length to the post-update length.
    - Update the reference to the length in the VM and the caller length.
    - If direct mapping is not enabled, copy the updated account data from the callee to the caller's serialized data buffer.
    - Return `FD_VM_SUCCESS` on successful completion.
- **Output**: Returns an integer status code, `FD_VM_SUCCESS` on success, or an error code on failure.


---
### VM\_SYSCALL\_CPI\_ENTRYPOINT<!-- {{#callable:VM_SYSCALL_CPI_ENTRYPOINT}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_cpi_common.c#L665>)

Executes a Cross-Program Invocation (CPI) instruction in a virtual machine environment, handling translation, validation, and execution of the instruction and its associated account data.
- **Inputs**:
    - `_vm`: Pointer to the virtual machine handle.
    - `instruction_va`: Virtual address of the instruction to execute, in the language-specific ABI format.
    - `acct_infos_va`: Virtual address of the account infos, in the language-specific ABI format.
    - `acct_info_cnt`: Number of account infos.
    - `signers_seeds_va`: Virtual address of the signers seeds.
    - `signers_seeds_cnt`: Number of signers seeds.
    - `_ret`: Pointer to the return value.
- **Logic and Control Flow**:
    - Cast `_vm` to `fd_vm_t` pointer `vm`.
    - Update compute units using `FD_VM_CU_UPDATE`.
    - Translate the CPI instruction using `FD_VM_MEM_HADDR_LD`.
    - Translate CPI account metas and instruction data.
    - Check instruction validity with `fd_vm_syscall_cpi_check_instruction`.
    - Update compute units if `loosen_cpi_size_restriction` feature is active.
    - Perform final checks on CPI account metas for validity.
    - Derive PDA signers if `signers_seeds_cnt` is greater than zero.
    - Create the instruction to execute using [`VM_SYSCALL_CPI_INSTRUCTION_TO_INSTR_FUNC`](<#vm_syscall_cpi_instruction_to_instr_func>).
    - Check if the program is authorized using `fd_vm_syscall_cpi_check_authorized_program`.
    - Prepare the instruction for execution with `fd_vm_prepare_instruction`.
    - Translate account infos and check for pointer validity.
    - Update callee accounts with changes made by the caller using [`VM_SYSCALL_CPI_TRANSLATE_AND_UPDATE_ACCOUNTS_FUNC`](<#vm_syscall_cpi_translate_and_update_accounts_func>).
    - Set transaction compute meter to match VM's compute meter.
    - Execute the CPI instruction using `fd_execute_instr`.
    - Update caller accounts with changes made by the callee during execution.
    - Update caller's memory regions to reflect changes if `stricter_abi_and_runtime_constraints` is enabled.
    - Return `FD_VM_SUCCESS` if execution completes without errors.
- **Output**: Returns an integer status code, with `FD_VM_SUCCESS` indicating successful execution, and updates the value pointed to by `_ret` with the execution result.
- **Functions Called**:
    - [`VM_SYSCALL_CPI_INSTRUCTION_TO_INSTR_FUNC`](<#vm_syscall_cpi_instruction_to_instr_func>)
    - [`VM_SYSCALL_CPI_TRANSLATE_AND_UPDATE_ACCOUNTS_FUNC`](<#vm_syscall_cpi_translate_and_update_accounts_func>)
    - [`VM_SYSCALL_CPI_UPDATE_CALLER_ACC_FUNC`](<#vm_syscall_cpi_update_caller_acc_func>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)