<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements syscalls for validating points, performing group operations, and multi-scalar multiplication on Curve25519 and Ristretto255 curves.

# Purpose
The code provides a set of system call functions for validating and performing operations on elliptic curve points, specifically for the Curve25519 Edwards and Ristretto255 curves. It includes functions to validate points on these curves, perform group operations such as addition, subtraction, and multiplication, and execute multi-scalar multiplication. The functions are designed to be used within a virtual machine context, as indicated by the `fd_vm_t` type and the use of virtual memory address translation functions like `FD_VM_MEM_HADDR_LD` and `FD_VM_TRANSLATE_MUT`.

The code defines several key functions: [`fd_vm_syscall_sol_curve_validate_point`](<#fd_vm_syscall_sol_curve_validate_point>), [`fd_vm_syscall_sol_curve_group_op`](<#fd_vm_syscall_sol_curve_group_op>), and [`fd_vm_syscall_sol_curve_multiscalar_mul`](<#fd_vm_syscall_sol_curve_multiscalar_mul>). These functions handle different elliptic curve operations by switching on the curve type and operation type, and they use helper functions from the `fd_curve25519.h` and `fd_ristretto255.h` headers to perform the actual mathematical computations. The code also includes static helper functions [`multi_scalar_mul_edwards`](<#multi_scalar_mul_edwards>) and [`multi_scalar_mul_ristretto`](<#multi_scalar_mul_ristretto>) to perform multi-scalar multiplication on the respective curves. The functions are designed to return error codes and update a result pointer, `_ret`, to indicate success or failure of the operations.
# Imports and Dependencies

---
- `fd_vm_syscall.h`
- `../../runtime/fd_bank.h`
- `../../../ballet/ed25519/fd_curve25519.h`
- `../../../ballet/ed25519/fd_ristretto255.h`


# Functions

---
### fd\_vm\_syscall\_sol\_curve\_validate\_point<!-- {{#callable:fd_vm_syscall_sol_curve_validate_point}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_curve.c#L6>)

Validates a point on a specified elliptic curve and returns a status code indicating validity.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine context (`fd_vm_t`).
    - `curve_id`: An unsigned long integer representing the identifier of the elliptic curve to validate against.
    - `point_addr`: An unsigned long integer representing the memory address of the point to validate.
    - `r3`: An unused parameter.
    - `r4`: An unused parameter.
    - `r5`: An unused parameter.
    - `_ret`: A pointer to an unsigned long where the function will store the result of the validation (0 for valid, 1 for invalid).
- **Logic and Control Flow**:
    - Initialize `ret` to 1, indicating an error by default.
    - Cast `_vm` to a `fd_vm_t` pointer and store it in `vm`.
    - Use a switch statement to handle different `curve_id` values.
    - For `FD_VM_SYSCALL_SOL_CURVE_CURVE25519_EDWARDS`, update the computation cost, load the point from memory, and validate it using `fd_ed25519_point_validate`.
    - For `FD_VM_SYSCALL_SOL_CURVE_CURVE25519_RISTRETTO`, update the computation cost, load the point from memory, and validate it using `fd_ristretto255_point_validate`.
    - If the `curve_id` is not recognized and the `abort_on_invalid_curve` feature is active, log an error and return `FD_VM_SYSCALL_ERR_INVALID_ATTRIBUTE`.
    - Store the validation result in `_ret` and return `FD_VM_SUCCESS`.
- **Output**: Returns `FD_VM_SUCCESS` if the function executes without errors, and stores the validation result (0 for valid, 1 for invalid) in the location pointed to by `_ret`. If an invalid curve is detected and the feature is active, returns `FD_VM_SYSCALL_ERR_INVALID_ATTRIBUTE`.


---
### fd\_vm\_syscall\_sol\_curve\_group\_op<!-- {{#callable:fd_vm_syscall_sol_curve_group_op}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_curve.c#L47>)

Performs group operations (addition, subtraction, multiplication) on elliptic curve points for specified curve types (Edwards or Ristretto) and updates the result in memory.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine context.
    - `curve_id`: An unsigned long representing the identifier of the elliptic curve (Edwards or Ristretto).
    - `group_op`: An unsigned long representing the group operation to perform (addition, subtraction, or multiplication).
    - `left_input_addr`: An unsigned long representing the memory address of the left input operand.
    - `right_input_addr`: An unsigned long representing the memory address of the right input operand.
    - `result_point_addr`: An unsigned long representing the memory address where the result will be stored.
    - `_ret`: A pointer to an unsigned long where the function will store the return status.
- **Logic and Control Flow**:
    - Initialize the return value to 1UL, indicating an error by default.
    - Determine the cost of the operation based on the `curve_id` and `group_op` using nested switch statements.
    - Update the virtual machine's computational unit cost using `FD_VM_CU_UPDATE`.
    - Load the left and right input operands from memory using `FD_VM_MEM_HADDR_LD`.
    - Use a switch statement with `MATCH_ID_OP` to perform the specified group operation on the curve points.
    - For each operation, validate the input points or scalars and perform the operation (add, subtract, or multiply) using the appropriate function for the curve type.
    - Store the result in memory and set the return value to 0UL if successful.
    - Handle invalid operations by jumping to `invalid_error` and returning an error code if necessary.
    - Handle soft errors by setting the return value and returning success.
- **Output**: Returns an integer status code indicating success or failure, and updates `_ret` with the operation result status.


---
### multi\_scalar\_mul\_edwards<!-- {{#callable:multi_scalar_mul_edwards}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_curve.c#L322>)

Performs a multi-scalar multiplication (MSM) on the Curve25519 Edwards curve using given scalars and points.
- **Inputs**:
    - `r`: A pointer to an `fd_ed25519_point_t` structure where the result of the MSM will be stored.
    - `scalars`: A pointer to an array of unsigned characters representing the scalars for the MSM.
    - `points`: A pointer to an array of unsigned characters representing the points for the MSM.
    - `cnt`: An unsigned long integer representing the number of scalars and points to process.
- **Logic and Control Flow**:
    - Iterates over each scalar to validate it using `fd_curve25519_scalar_validate` function.
    - Initializes the result point `r` to zero using `fd_ed25519_point_set_zero`.
    - Processes the scalars and points in batches of size `FD_BALLET_CURVE25519_MSM_BATCH_SZ`.
    - For each batch, decompresses and validates the points using `fd_ed25519_point_frombytes`.
    - Performs the multi-scalar multiplication for the batch using `fd_ed25519_multi_scalar_mul`.
    - Adds the result of the batch multiplication to the accumulated result `r` using `fd_ed25519_point_add`.
    - Updates the pointers for scalars and points to process the next batch.
- **Output**: Returns a pointer to the `fd_ed25519_point_t` structure `r` containing the result of the MSM, or `NULL` if validation fails.


---
### multi\_scalar\_mul\_ristretto<!-- {{#callable:multi_scalar_mul_ristretto}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_curve.c#L362>)

Computes a multi-scalar multiplication (MSM) on the Ristretto255 curve using given scalars and points.
- **Inputs**:
    - `r`: A pointer to an `fd_ristretto255_point_t` structure where the result of the MSM will be stored.
    - `scalars`: A constant pointer to an array of unsigned characters representing the scalars for the MSM.
    - `points`: A constant pointer to an array of unsigned characters representing the points for the MSM.
    - `cnt`: An unsigned long integer representing the number of scalars and points to process.
- **Logic and Control Flow**:
    - Iterates over each scalar to validate it using `fd_curve25519_scalar_validate` function.
    - Allocates static memory for a batch of decompressed points and initializes the result point `r` to zero.
    - Processes the scalars and points in batches defined by `FD_BALLET_CURVE25519_MSM_BATCH_SZ`.
    - For each batch, decompresses and validates the points using `fd_ristretto255_point_frombytes`.
    - Performs the multi-scalar multiplication for the batch using `fd_ristretto255_multi_scalar_mul`.
    - Adds the result of the batch multiplication to the cumulative result `r` using `fd_ristretto255_point_add`.
    - Updates the pointers for scalars and points to process the next batch.
- **Output**: Returns a pointer to the `fd_ristretto255_point_t` structure containing the result of the MSM, or `NULL` if validation fails.


---
### fd\_vm\_syscall\_sol\_curve\_multiscalar\_mul<!-- {{#callable:fd_vm_syscall_sol_curve_multiscalar_mul}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_curve.c#L401>)

Performs a multi-scalar multiplication on elliptic curve points using specified scalars and stores the result.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine context.
    - `curve_id`: An identifier for the elliptic curve to use (e.g., Curve25519 Edwards or Ristretto).
    - `scalars_addr`: The memory address where the scalars are stored.
    - `points_addr`: The memory address where the points are stored.
    - `points_len`: The number of points and scalars to process.
    - `result_point_addr`: The memory address where the result point will be stored.
    - `_ret`: A pointer to store the return status of the operation.
- **Logic and Control Flow**:
    - Initialize the return value to indicate an error by default.
    - Check if `points_len` exceeds 512 and return an error if true.
    - Determine the base and incremental costs based on the `curve_id`.
    - Calculate the total cost and update the virtual machine's computational unit usage.
    - Handle the edge case where `points_len` is zero by setting the result to the point at infinity.
    - Load scalars and points from memory using their respective addresses.
    - Perform multi-scalar multiplication based on the `curve_id` using either the Edwards or Ristretto curve.
    - Translate the result point address to a hardware address and store the result.
    - Return success or error status based on the operation outcome.
- **Output**: Returns an integer status code indicating success or a specific error, and updates `_ret` with the operation result.
- **Functions Called**:
    - [`multi_scalar_mul_edwards`](<#multi_scalar_mul_edwards>)
    - [`multi_scalar_mul_ristretto`](<#multi_scalar_mul_ristretto>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)