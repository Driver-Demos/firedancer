<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements cross-program invocation logic for a virtual machine, including account management and privilege checks.

# Purpose
The code is a C implementation for handling cross-program invocations (CPI) in a virtual machine (VM) environment, specifically tailored for a Solana-like blockchain runtime. It includes functions and macros to manage instruction accounts, check permissions, and handle account data during CPI calls. The primary function, [`fd_vm_prepare_instruction`](<#fd_vm_prepare_instruction>), prepares instruction accounts for execution by de-duplicating account references, normalizing permissions, and performing privilege checks. This function ensures that each account referenced in a transaction has consistent permissions and that necessary signatures are present.

The code also defines several constants and inline functions to manage constraints and checks related to CPI, such as maximum signer counts, account info limits, and instruction data sizes. It includes logic to verify if a program ID is authorized to execute a CPI call and checks if a program ID corresponds to a precompiled program. The code is structured to support both C and Rust ABI (Application Binary Interface) conventions, with specific sections dedicated to each ABI. This allows the VM to handle different types of account metadata and instruction formats, ensuring compatibility with various program execution environments.
# Imports and Dependencies

---
- `fd_vm_syscall.h`
- `../../runtime/fd_borrowed_account.h`
- `../../runtime/fd_system_ids.h`
- `fd_vm_syscall_cpi_common.c`


# Global Variables

---
### decl
- **Type**: `uchar *`
- **Description**: A pointer to an unsigned character array that represents a memory slice in the virtual machine's address space.
- **Use**: Used to access a specific memory region in the virtual machine, with alignment and length defined by the associated `acc_info` structure.


# Functions

---
### fd\_vm\_syscall\_cpi\_is\_signer<!-- {{#callable:fd_vm_syscall_cpi_is_signer}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_cpi.c#L6>)

Checks if a given account is among the list of signers.
- **Inputs**:
    - ``account``: A pointer to an `fd_pubkey_t` structure representing the account to check.
    - ``signers``: A pointer to an array of `fd_pubkey_t` structures representing the list of signer accounts.
    - ``signers_cnt``: The number of signers in the `signers` array.
- **Logic and Control Flow**:
    - Iterates over each signer in the `signers` array up to `signers_cnt`.
    - Compares the `uc` field of the `account` with the `uc` field of each signer using `memcmp`.
    - If a match is found, returns 1 indicating the account is a signer.
    - If no match is found after checking all signers, returns 0.
- **Output**: Returns 1 if the account is a signer, otherwise returns 0.


---
### fd\_vm\_prepare\_instruction<!-- {{#callable:fd_vm_prepare_instruction}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_cpi.c#L57>)

Prepares instruction accounts for execution by de-duplicating accounts, normalizing permissions, and checking for privilege escalations.
- **Inputs**:
    - `callee_instr`: A pointer to `fd_instr_info_t` containing the callee instruction details.
    - `instr_ctx`: A pointer to `fd_exec_instr_ctx_t` representing the execution context of the instruction.
    - `callee_program_id_pubkey`: A constant pointer to `fd_pubkey_t` representing the public key of the callee program ID.
    - `instr_acct_keys`: An array of `fd_pubkey_t` representing the instruction account keys.
    - `instruction_accounts`: An array of `fd_instruction_account_t` to be populated with the prepared instruction accounts.
    - `instruction_accounts_cnt`: A pointer to `ulong` to store the count of prepared instruction accounts.
    - `signers`: A constant pointer to an array of `fd_pubkey_t` representing the signers.
    - `signers_cnt`: An `ulong` representing the count of signers.
- **Logic and Control Flow**:
    - Initialize counters and arrays for deduplicated accounts and duplicate indices.
    - Iterate over each account in `callee_instr` to check if it is known and to de-duplicate accounts.
    - For each account, check if it is a duplicate by comparing transaction indices.
    - If duplicate, update the account flags to include all flags from all references.
    - If not duplicate, initialize a new deduplicated account entry.
    - Check for privilege escalations by comparing account permissions between caller and callee.
    - Copy deduplicated accounts to the final `instruction_accounts` array and update `callee_instr` account flags.
    - Find the program account index and check if it is executable.
    - Set the count of prepared instruction accounts in `instruction_accounts_cnt`.
- **Output**: Returns 0 on success, or an error code if an error occurs during processing.
- **Functions Called**:
    - [`fd_vm_syscall_cpi_is_signer`](<#fd_vm_syscall_cpi_is_signer>)


---
### get\_cpi\_max\_account\_infos<!-- {{#callable:get_cpi_max_account_infos}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_cpi.c#L246>)

Determines the maximum number of account information structures that can be used in a cross-program invocation based on transaction context features.
- **Inputs**:
    - `txn_ctx`: A pointer to a constant `fd_exec_txn_ctx_t` structure that contains the transaction context, including the slot and features.
- **Logic and Control Flow**:
    - Checks if the feature `increase_tx_account_lock_limit` is active using `FD_FEATURE_ACTIVE` with the slot and features from `txn_ctx`.
    - If the feature is active, returns `FD_CPI_MAX_ACCOUNT_INFOS` (128).
    - If the feature is not active, returns 64UL.
- **Output**: Returns an unsigned long integer representing the maximum number of account information structures allowed.


---
### fd\_vm\_syscall\_cpi\_check\_instruction<!-- {{#callable:fd_vm_syscall_cpi_check_instruction}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_cpi.c#L273>)

Checks if the instruction data size and account count are within allowed limits based on feature flags.
- **Inputs**:
    - ``vm``: A pointer to a constant `fd_vm_t` structure that contains the virtual machine context.
    - ``acct_cnt``: An unsigned long integer representing the number of accounts involved in the instruction.
    - ``data_sz``: An unsigned long integer representing the size of the instruction data.
- **Logic and Control Flow**:
    - Check if the feature `loosen_cpi_size_restriction` is active using `FD_FEATURE_ACTIVE` with the current slot and features from `vm`.
    - If the feature is active, check if `data_sz` exceeds `FD_CPI_MAX_INSTRUCTION_DATA_LEN`. If true, log a warning and return `FD_VM_SYSCALL_ERR_MAX_INSTRUCTION_DATA_LEN_EXCEEDED`.
    - If the feature is active, check if `acct_cnt` exceeds `FD_CPI_MAX_INSTRUCTION_ACCOUNTS`. If true, log a warning and return `FD_VM_SYSCALL_ERR_MAX_INSTRUCTION_ACCOUNTS_EXCEEDED`.
    - If the feature is not active, calculate `tot_sz` as the sum of the product of `FD_VM_RUST_ACCOUNT_META_SIZE` and `acct_cnt`, and `data_sz`.
    - Check if `tot_sz` exceeds `FD_VM_MAX_CPI_INSTRUCTION_SIZE`. If true, log a warning and return `FD_VM_SYSCALL_ERR_INSTRUCTION_TOO_LARGE`.
    - If none of the conditions are met, return `FD_VM_SUCCESS`.
- **Output**: Returns an integer status code indicating success or a specific error related to instruction size or account count limits.


---
### fd\_vm\_cpi\_update\_caller\_account\_region<!-- {{#callable:fd_vm_cpi_update_caller_account_region}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_cpi.c#L303>)

Updates the memory region metadata for a caller account in a virtual machine context.
- **Inputs**:
    - ``vm``: A pointer to the `fd_vm_t` structure representing the virtual machine context.
    - ``instr_acc_idx``: An unsigned long integer representing the index of the instruction account.
    - ``caller_account``: A pointer to the `fd_vm_cpi_caller_account_t` structure representing the caller account.
    - ``borrowed_account``: A pointer to the `fd_borrowed_account_t` structure representing the borrowed account.
- **Logic and Control Flow**:
    - Calculate `address_space_reserved_for_account` based on `vm` constraints and `caller_account->orig_data_len`.
    - If `address_space_reserved_for_account` is greater than 0, proceed to update the memory region metadata.
    - Retrieve the `acc_region_meta` and `region` structures using `instr_acc_idx`.
    - Set `region->region_sz` to the data length of `borrowed_account`.
    - Determine if the data in `borrowed_account` can be changed and update `region->is_writable` accordingly.
- **Output**: Returns `FD_VM_SUCCESS` to indicate successful execution.


---
### fd\_vm\_syscall\_cpi\_check\_id<!-- {{#callable:fd_vm_syscall_cpi_check_id}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_cpi.c#L347>)

Compares a given `program_id` with a `loader` to check if they are identical.
- **Inputs**:
    - `program_id`: A pointer to a `fd_pubkey_t` structure representing the program ID to check.
    - `loader`: A pointer to an `uchar` array representing the loader to compare against.
- **Logic and Control Flow**:
    - Uses `memcmp` to compare the memory content of `program_id` and `loader` for a length of `sizeof(fd_pubkey_t)`.
    - Returns the negation of the result from `memcmp`, which means it returns 1 if the contents are identical and 0 otherwise.
- **Output**: Returns an integer value: 1 if `program_id` and `loader` are identical, 0 otherwise.


---
### fd\_vm\_syscall\_cpi\_is\_precompile<!-- {{#callable:fd_vm_syscall_cpi_is_precompile}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_cpi.c#L360>)

Determines if a given `program_id` corresponds to a precompiled program by checking against a list of known precompiles.
- **Inputs**:
    - `program_id`: A pointer to a `fd_pubkey_t` structure representing the program ID to check.
    - `txn_ctx`: A pointer to a `fd_exec_txn_ctx_t` structure containing transaction context information.
- **Logic and Control Flow**:
    - Calls [`fd_vm_syscall_cpi_check_id`](<#fd_vm_syscall_cpi_check_id>) to check if `program_id` matches `fd_solana_keccak_secp_256k_program_id.key` or `fd_solana_ed25519_sig_verify_program_id.key`.
    - Performs a bitwise OR operation on the results of the above checks.
    - Calls [`fd_vm_syscall_cpi_check_id`](<#fd_vm_syscall_cpi_check_id>) to check if `program_id` matches `fd_solana_secp256r1_program_id.key`.
    - Checks if the feature `enable_secp256r1_precompile` is active using `FD_FEATURE_ACTIVE` with `txn_ctx->slot` and `txn_ctx->features`.
    - Performs a logical AND operation between the result of the [`fd_vm_syscall_cpi_check_id`](<#fd_vm_syscall_cpi_check_id>) for `fd_solana_secp256r1_program_id.key` and the feature check.
    - Performs a bitwise OR operation on all the results to determine if `program_id` is a precompile.
- **Output**: Returns an integer that is non-zero if `program_id` is a precompile, otherwise returns zero.
- **Functions Called**:
    - [`fd_vm_syscall_cpi_check_id`](<#fd_vm_syscall_cpi_check_id>)


---
### fd\_vm\_syscall\_cpi\_check\_authorized\_program<!-- {{#callable:fd_vm_syscall_cpi_check_authorized_program}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_cpi.c#L376>)

Checks if a given `program_id` is authorized to execute a Cross-Program Invocation (CPI) call based on specific criteria.
- **Inputs**:
    - `program_id`: A pointer to a `fd_pubkey_t` structure representing the program ID to check.
    - `txn_ctx`: A pointer to a `fd_exec_txn_ctx_t` structure containing the transaction context.
    - `instruction_data`: A pointer to an array of unsigned characters representing the instruction data.
    - `instruction_data_len`: An unsigned long integer representing the length of the instruction data.
- **Logic and Control Flow**:
    - Checks if `program_id` matches any of the predefined loader IDs using [`fd_vm_syscall_cpi_check_id`](<#fd_vm_syscall_cpi_check_id>) function.
    - If `program_id` matches `fd_solana_bpf_loader_upgradeable_program_id.key`, checks if the instruction data does not match any of the restricted instructions unless certain features are active in `txn_ctx`.
    - Checks if `program_id` corresponds to a precompile using [`fd_vm_syscall_cpi_is_precompile`](<#fd_vm_syscall_cpi_is_precompile>).
- **Output**: Returns a non-zero value if the `program_id` is authorized, otherwise returns zero.
- **Functions Called**:
    - [`fd_vm_syscall_cpi_check_id`](<#fd_vm_syscall_cpi_check_id>)
    - [`fd_vm_syscall_cpi_is_precompile`](<#fd_vm_syscall_cpi_is_precompile>)


---
### vm\_syscall\_cpi\_acc\_info\_rc\_refcell\_as\_ptr<!-- {{#callable:vm_syscall_cpi_acc_info_rc_refcell_as_ptr}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_cpi.c#L401>)

Converts a virtual address of a reference-counted refcell to a pointer to its payload.
- **Inputs**:
    - `rc_refcell_vaddr`: A virtual address of a reference-counted refcell of type `fd_vm_rc_refcell_t`.
- **Logic and Control Flow**:
    - Cast the input `rc_refcell_vaddr` to a pointer of type `fd_vm_rc_refcell_t`.
    - Access the `payload` member of the `fd_vm_rc_refcell_t` structure.
    - Return the address of the `payload` member as an unsigned long integer.
- **Output**: An unsigned long integer representing the pointer to the payload of the refcell.


---
### vm\_syscall\_cpi\_data\_len\_vaddr\_c<!-- {{#callable:vm_syscall_cpi_data_len_vaddr_c}} -->
[View Source →](<../../../../../../src/flamenco/vm/syscall/fd_vm_syscall_cpi.c#L408>)

Calculates the virtual address of the data length in a cross-program invocation by adjusting the account information virtual address with the data length and account information host addresses.
- **Inputs**:
    - `acct_info_vaddr`: The virtual address of the account information.
    - `data_len_haddr`: The host address of the data length.
    - `acct_info_haddr`: The host address of the account information.
- **Logic and Control Flow**:
    - Add `acct_info_vaddr` and `data_len_haddr` using `fd_ulong_sat_add` to handle potential overflow.
    - Subtract `acct_info_haddr` from the result using `fd_ulong_sat_sub` to handle potential underflow.
    - Return the computed virtual address.
- **Output**: The function returns an unsigned long integer representing the calculated virtual address of the data length.



---
Made with ❤️ by [Driver](https://www.driver.ai/)