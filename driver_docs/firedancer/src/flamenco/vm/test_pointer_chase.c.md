<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests pointer chasing performance with sequential and random memory access patterns.

# Purpose
The code is an executable C program designed to perform pointer chasing tests with different memory access patterns. It includes functionality to generate sequential and random memory access patterns using the [`pattern_seq`](<#pattern_seq>) and [`pattern_random`](<#pattern_random>) functions, respectively. These functions populate an array with memory addresses that are either sequentially or randomly ordered. The program uses a Fisher-Yates shuffle algorithm to create random permutations of memory addresses.

The main function handles command-line arguments to configure the test parameters, such as the size of the memory to be tested, the pattern type, and the number of iterations for the pointer chasing test. It initializes a workspace for memory allocation, either by attaching to an existing workspace or creating a new anonymous one. The program then executes the selected memory access pattern and measures the time taken to complete the pointer chasing test. The results, including elapsed time and iteration period, are logged for performance analysis. The program also includes error handling for invalid input parameters and ensures proper cleanup of resources before termination.
# Imports and Dependencies

---
- `../../util/fd_util.h`
- `stdio.h`


# Global Variables

---
### patterns
- **Type**: `static const struct`
- **Description**: An array of structures that define different random number generation patterns. Each structure contains a name, a help description, and a function pointer to the pattern implementation.
- **Use**: Used to select and execute a specific random number generation pattern based on user input.


# Functions

---
### pattern\_seq<!-- {{#callable:pattern_seq}} -->
[View Source →](<../../../../../src/flamenco/vm/test_pointer_chase.c#L11>)

Initializes an array with sequential memory addresses based on a given pointer and size.
- **Inputs**:
    - ``ptr``: A pointer to an array of unsigned long integers where the function will store the sequential addresses.
    - ``n``: The number of elements in the array to initialize.
    - ``rng``: A pointer to a random number generator, which is not used in this function.
- **Logic and Control Flow**:
    - Ignores the `rng` parameter as it is not used in the function.
    - Iterates over the range from 0 to `n-1`.
    - For each index `i`, calculates the address by adding `8*i` to the base address of `ptr` and stores it in `ptr[i]`.
- **Output**: No return value; the function modifies the array pointed to by `ptr` in place.


---
### pattern\_random<!-- {{#callable:pattern_random}} -->
[View Source →](<../../../../../src/flamenco/vm/test_pointer_chase.c#L18>)

Generates a random permutation of memory addresses using the Fisher-Yates shuffle algorithm.
- **Inputs**:
    - ``ptr``: A pointer to an array of unsigned long integers that will be permuted.
    - ``n``: The number of elements in the array pointed to by `ptr`.
    - ``rng``: A pointer to a random number generator context used for generating random numbers.
- **Logic and Control Flow**:
    - Initialize each element of the array `ptr` with its corresponding memory address offset by 8 times its index.
    - Iterate over the array from the first element to the second-to-last element.
    - For each element, generate a random index `j` using the `fd_rng_ulong_roll` function, which selects a random index from the current position to the end of the array.
    - Swap the current element with the element at the random index `j` using the `fd_swap` function.
- **Output**: The function does not return a value; it modifies the array `ptr` in place to contain a random permutation of its original elements.


---
### ptr\_chase\_block<!-- {{#callable:ptr_chase_block}} -->
[View Source →](<../../../../../src/flamenco/vm/test_pointer_chase.c#L51>)

Performs pointer chasing by dereferencing a pointer 512 times in a loop.
- **Inputs**:
    - `x`: An unsigned long integer representing a memory address to dereference.
- **Logic and Control Flow**:
    - Defines a constant `ITER_BLOCK` with a value of 512.
    - Uses a `#pragma GCC unroll 512` directive to suggest loop unrolling for optimization.
    - Initializes a loop counter `i` to 0 and iterates 512 times.
    - In each iteration, dereferences the pointer stored in `x` and assigns the result back to `x`.
    - Returns the final value of `x` after 512 dereferences.
- **Output**: Returns an unsigned long integer which is the result of the final pointer dereference.


---
### ptr\_chase<!-- {{#callable:ptr_chase}} -->
[View Source →](<../../../../../src/flamenco/vm/test_pointer_chase.c#L61>)

Performs pointer chasing on a memory block for a specified number of iterations.
- **Inputs**:
    - ``ptr``: A pointer to the start of a memory block of type `ulong`.
    - ``iter``: The number of iterations to perform pointer chasing.
- **Logic and Control Flow**:
    - Initialize `x` with the address of `ptr` cast to `ulong`.
    - While `iter` is greater than or equal to `ITER_BLOCK`, call [`ptr_chase_block`](<#ptr_chase_block>) with `x`, update `x` with the result, and decrease `iter` by `ITER_BLOCK`.
    - For the remaining iterations, dereference `x` as a pointer to `ulong` and update `x` with the dereferenced value.
    - Return the final value of `x`.
- **Output**: Returns the final `ulong` value obtained after performing the pointer chasing operations.
- **Functions Called**:
    - [`ptr_chase_block`](<#ptr_chase_block>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/flamenco/vm/test_pointer_chase.c#L74>)

Processes command-line arguments to configure and execute a pointer chasing benchmark with specified parameters.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
- **Logic and Control Flow**:
    - Checks if '--help' is requested and displays usage information if true, then exits.
    - Initializes the environment using `fd_boot`.
    - Parses command-line arguments for workspace name, page size, CPU affinity, size, pattern, and iteration count.
    - Validates the parsed size and page size, logging errors if invalid.
    - Initializes a random number generator.
    - Attaches to an existing workspace or creates a new anonymous workspace based on the presence of a workspace name.
    - Allocates memory for a scratch buffer in the workspace.
    - Selects a pattern function based on the specified pattern name, logging an error if unsupported.
    - Logs the parameters and executes the selected pattern function on the scratch buffer.
    - Measures and logs the time taken to execute the pattern function.
    - Executes the pointer chasing benchmark using [`ptr_chase`](<#ptr_chase>) and logs the elapsed time and iteration period.
    - Detaches from or deletes the workspace based on its type (named or anonymous).
    - Cleans up the random number generator and halts the environment.
- **Output**: Returns 0 after successful execution or after displaying help information.
- **Functions Called**:
    - [`ptr_chase`](<#ptr_chase>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)