<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements error handling, validation, and memory management for a virtual machine in the Firedancer codebase.

# Purpose
The code defines a set of functions and structures for managing a virtual machine (VM) environment, specifically for handling error messages and validating instructions within the VM. The primary functions [`fd_vm_syscall_strerror`](<#fd_vm_syscall_strerror>), [`fd_vm_ebpf_strerror`](<#fd_vm_ebpf_strerror>), and [`fd_vm_strerror`](<#fd_vm_strerror>) are responsible for returning human-readable error messages corresponding to various error codes. These functions are used to facilitate logging and debugging by translating error codes into descriptive strings. The [`fd_vm_validate`](<#fd_vm_validate>) function is a critical component that validates the instructions executed by the VM, ensuring they adhere to specific criteria based on the sBPF (Solana Berkeley Packet Filter) version. This validation process includes checking for valid opcodes, jump instructions, and register usage.

Additionally, the code provides functions for managing the lifecycle of a VM instance, such as [`fd_vm_new`](<#fd_vm_new>), [`fd_vm_join`](<#fd_vm_join>), [`fd_vm_leave`](<#fd_vm_leave>), and [`fd_vm_delete`](<#fd_vm_delete>), which handle the creation, joining, leaving, and deletion of VM instances, respectively. The [`fd_vm_init`](<#fd_vm_init>) function initializes a VM with various parameters, setting up its execution environment. The [`fd_vm_setup_state_for_execution`](<#fd_vm_setup_state_for_execution>) function configures the VM's state for execution, including memory and register initialization. These functions collectively support the setup, execution, and management of a VM environment, focusing on error handling, instruction validation, and memory management.
# Imports and Dependencies

---
- `fd_vm_private.h`


# Functions

---
### fd\_vm\_syscall\_strerror<!-- {{#callable:fd_vm_syscall_strerror}} -->
[View Source →](<../../../../../src/flamenco/vm/fd_vm.c#L8>)

Maps an error code to its corresponding error message string for logging purposes.
- **Inputs**:
    - `err`: An integer representing the error code to be translated into a string message.
- **Logic and Control Flow**:
    - Use a `switch` statement to match the input `err` with predefined error codes.
    - For each case, return a specific error message string corresponding to the error code.
    - If the error code does not match any predefined case, return an empty string.
- **Output**: A constant character pointer to the error message string corresponding to the input error code, or an empty string if the error code is not recognized.


---
### fd\_vm\_ebpf\_strerror<!-- {{#callable:fd_vm_ebpf_strerror}} -->
[View Source →](<../../../../../src/flamenco/vm/fd_vm.c#L55>)

Maps an eBPF error code to its corresponding error message string.
- **Inputs**:
    - `err`: An integer representing the eBPF error code.
- **Logic and Control Flow**:
    - Uses a `switch` statement to match the input `err` with predefined eBPF error codes.
    - For each matched error code, returns a specific error message string.
    - If the error code is `FD_VM_ERR_EBPF_SYSCALL_ERROR`, returns an empty string as it is handled by `fd_vm_syscall_strerror()`.
    - If no case matches, returns an empty string by default.
- **Output**: A constant character pointer to the error message string corresponding to the input error code, or an empty string if the error code is not recognized or should be omitted.


---
### fd\_vm\_strerror<!-- {{#callable:fd_vm_strerror}} -->
[View Source →](<../../../../../src/flamenco/vm/fd_vm.c#L89>)

Maps an error code to its corresponding error message string.
- **Inputs**:
    - ``err``: An integer representing the error code to be translated into a message.
- **Logic and Control Flow**:
    - Use a `switch` statement to match the input error code `err` against predefined error codes.
    - Return a specific error message string for each matched error code.
    - If the error code does not match any predefined codes, return the string "UNKNOWN probably not a FD_VM_ERR code".
- **Output**: A constant character pointer to the error message string corresponding to the input error code.


---
### fd\_vm\_validate<!-- {{#callable:fd_vm_validate}} -->
[View Source →](<../../../../../src/flamenco/vm/fd_vm.c#L137>)

Validates the instructions in a virtual machine's text segment based on the sBPF version and opcode validation criteria.
- **Inputs**:
    - `vm`: A pointer to a constant `fd_vm_t` structure representing the virtual machine to validate.
- **Logic and Control Flow**:
    - Retrieve the `sbpf_version` from the `vm` structure.
    - Define validation criteria for opcodes using constants like `FD_VALID`, `FD_CHECK_JMP_V3`, etc.
    - Initialize a `validation_map` array to map opcodes to their validation criteria.
    - Adjust the `validation_map` based on the `sbpf_version` using various feature checks like `FD_VM_SBPF_ENABLE_LDDW`, `FD_VM_SBPF_ENABLE_LE`, etc.
    - Perform initial checks on the `vm` structure for text size alignment, text count, and memory boundaries.
    - Iterate over each instruction in the `text` segment of the `vm`.
    - For each instruction, determine its validation code from the `validation_map`.
    - Perform specific validation checks based on the validation code, such as jump bounds, division by zero, and register validity.
    - Return specific error codes if any validation checks fail.
    - Return `FD_VM_SUCCESS` if all instructions are valid.
- **Output**: Returns an integer status code indicating success or a specific error if validation fails.


---
### fd\_vm\_align<!-- {{#callable:fd_vm_align}} -->
[View Source →](<../../../../../src/flamenco/vm/fd_vm.c#L481>)

Returns the constant `FD_VM_ALIGN`.
- **Inputs**: None
- **Logic and Control Flow**:
    - Return the value of `FD_VM_ALIGN`.
- **Output**: The function returns an `ulong` which is the value of `FD_VM_ALIGN`.


---
### fd\_vm\_footprint<!-- {{#callable:fd_vm_footprint}} -->
[View Source →](<../../../../../src/flamenco/vm/fd_vm.c#L486>)

Returns the constant value `FD_VM_FOOTPRINT`.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the value of the constant `FD_VM_FOOTPRINT`.
- **Output**: The output is an unsigned long integer representing the constant `FD_VM_FOOTPRINT`.


---
### fd\_vm\_new<!-- {{#callable:fd_vm_new}} -->
[View Source →](<../../../../../src/flamenco/vm/fd_vm.c#L491>)

Initializes a virtual machine structure in shared memory if the memory is valid and aligned.
- **Inputs**:
    - `shmem`: A pointer to shared memory where the virtual machine structure will be initialized.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL; if so, log a warning and return NULL.
    - Check if `shmem` is aligned according to [`fd_vm_align`](<#fd_vm_align>); if not, log a warning and return NULL.
    - Cast `shmem` to a `fd_vm_t` pointer and zero out the memory using `fd_memset`.
    - Set the `magic` field of the `fd_vm_t` structure to `FD_VM_MAGIC` using memory fences to ensure proper ordering.
    - Return the `shmem` pointer.
- **Output**: Returns the `shmem` pointer if successful, or NULL if there is an error.
- **Functions Called**:
    - [`fd_vm_align`](<#fd_vm_align>)
    - [`fd_vm_footprint`](<#fd_vm_footprint>)


---
### fd\_vm\_join<!-- {{#callable:fd_vm_join}} -->
[View Source →](<../../../../../src/flamenco/vm/fd_vm.c#L514>)

Validates and returns a pointer to a `fd_vm_t` structure from shared memory if the memory is correctly aligned and initialized.
- **Inputs**:
    - `shmem`: A pointer to shared memory that is expected to contain a `fd_vm_t` structure.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL; if true, log a warning and return NULL.
    - Check if `shmem` is aligned according to [`fd_vm_align`](<#fd_vm_align>); if not, log a warning and return NULL.
    - Cast `shmem` to a `fd_vm_t` pointer and store it in `vm`.
    - Check if `vm->magic` equals `FD_VM_MAGIC`; if not, log a warning and return NULL.
    - Return the `vm` pointer.
- **Output**: A pointer to a `fd_vm_t` structure if successful, or NULL if any validation fails.
- **Functions Called**:
    - [`fd_vm_align`](<#fd_vm_align>)


---
### fd\_vm\_leave<!-- {{#callable:fd_vm_leave}} -->
[View Source →](<../../../../../src/flamenco/vm/fd_vm.c#L537>)

Returns the input `fd_vm_t` pointer as a `void` pointer after checking for null.
- **Inputs**:
    - `vm`: A pointer to an `fd_vm_t` structure, representing a virtual machine instance.
- **Logic and Control Flow**:
    - Check if the input `vm` is null using `FD_UNLIKELY` macro.
    - If `vm` is null, log a warning message 'NULL vm' and return `NULL`.
    - If `vm` is not null, cast `vm` to a `void` pointer and return it.
- **Output**: A `void` pointer to the `fd_vm_t` structure if `vm` is not null, otherwise `NULL`.


---
### fd\_vm\_delete<!-- {{#callable:fd_vm_delete}} -->
[View Source →](<../../../../../src/flamenco/vm/fd_vm.c#L548>)

Deletes a virtual machine instance by validating and clearing its magic number in shared memory.
- **Inputs**:
    - `shmem`: A pointer to the shared memory location of the virtual machine instance to delete.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL; if true, log a warning and return NULL.
    - Check if `shmem` is aligned according to [`fd_vm_align`](<#fd_vm_align>); if not, log a warning and return NULL.
    - Cast `shmem` to a `fd_vm_t` pointer named `vm`.
    - Check if `vm->magic` equals `FD_VM_MAGIC`; if not, log a warning and return NULL.
    - Use memory fence operations to ensure memory ordering, then set `vm->magic` to 0.
    - Return the `vm` pointer cast back to a `void` pointer.
- **Output**: Returns a pointer to the shared memory location if successful, or NULL if any validation fails.
- **Functions Called**:
    - [`fd_vm_align`](<#fd_vm_align>)


---
### fd\_vm\_init<!-- {{#callable:fd_vm_init}} -->
[View Source →](<../../../../../src/flamenco/vm/fd_vm.c#L575>)

Initializes a virtual machine (`vm`) with specified parameters and prepares it for execution.
- **Inputs**:
    - `vm`: A pointer to an `fd_vm_t` structure that represents the virtual machine to initialize.
    - `instr_ctx`: A pointer to an `fd_exec_instr_ctx_t` structure that provides the instruction context for the virtual machine.
    - `heap_max`: The maximum heap size allowed for the virtual machine.
    - `entry_cu`: The entry compute unit for the virtual machine.
    - `rodata`: A pointer to a read-only data segment.
    - `rodata_sz`: The size of the read-only data segment.
    - `text`: A pointer to the text segment containing executable instructions.
    - `text_cnt`: The number of instructions in the text segment.
    - `text_off`: The offset of the text segment.
    - `text_sz`: The size of the text segment.
    - `entry_pc`: The entry program counter for the virtual machine.
    - `calldests`: A pointer to an array of call destinations, which can be NULL for certain tests.
    - `sbpf_version`: The version of the SBPF (Solana Berkeley Packet Filter) to use.
    - `syscalls`: A pointer to an `fd_sbpf_syscalls_t` structure that defines the system calls available to the virtual machine.
    - `trace`: A pointer to an `fd_vm_trace_t` structure for tracing execution.
    - `sha`: A pointer to an `fd_sha256_t` structure for SHA-256 operations.
    - `mem_regions`: A pointer to an array of `fd_vm_input_region_t` structures defining memory regions.
    - `mem_regions_cnt`: The number of memory regions.
    - `acc_region_metas`: A pointer to an array of `fd_vm_acc_region_meta_t` structures for access region metadata.
    - `is_deprecated`: A flag indicating if the virtual machine is deprecated.
    - `direct_mapping`: A flag indicating if direct memory mapping is enabled.
    - `stricter_abi_and_runtime_constraints`: A flag indicating if stricter ABI and runtime constraints are enforced.
    - `dump_syscall_to_pb`: A flag indicating if syscalls should be dumped to protobuf.
- **Logic and Control Flow**:
    - Check if `vm` is NULL and log a warning if true, then return NULL.
    - Verify if `vm->magic` matches `FD_VM_MAGIC` and log a warning if not, then return NULL.
    - Ensure `heap_max` does not exceed `FD_VM_HEAP_MAX` and log a warning if it does, then return NULL.
    - Check if `calldests` is not NULL and `sbpf_version` requires stricter ELF headers, return NULL if true.
    - Assign input parameters to the corresponding fields in the `vm` structure.
    - Set `vm->segv_vaddr` to `ULONG_MAX`, `vm->segv_access_len` to 0, and `vm->segv_access_type` to 0.
    - Call `fd_vm_setup_state_for_execution(vm)` to configure the virtual machine for execution.
    - Return NULL if [`fd_vm_setup_state_for_execution`](<#fd_vm_setup_state_for_execution>) does not return `FD_VM_SUCCESS`.
    - Return the initialized `vm` pointer.
- **Output**: A pointer to the initialized `fd_vm_t` structure, or NULL if initialization fails.
- **Functions Called**:
    - [`fd_vm_setup_state_for_execution`](<#fd_vm_setup_state_for_execution>)


---
### fd\_vm\_setup\_state\_for\_execution<!-- {{#callable:fd_vm_setup_state_for_execution}} -->
[View Source →](<../../../../../src/flamenco/vm/fd_vm.c#L660>)

Prepares the virtual machine state for execution by configuring memory, initializing registers, and setting execution parameters.
- **Inputs**:
    - ``vm``: A pointer to an `fd_vm_t` structure representing the virtual machine to set up.
- **Logic and Control Flow**:
    - Check if `vm` is NULL; if so, log a warning and return `FD_VM_ERR_INVAL`.
    - Call `fd_vm_mem_cfg(vm)` to unpack input and read-only data memory configuration.
    - Initialize all registers in `vm->reg` to zero using `fd_memset`.
    - Set `vm->reg[1]` to `FD_VM_MEM_MAP_INPUT_REGION_START`.
    - Set `vm->reg[10]` to the start of the stack region, adjusted for dynamic stack frames if applicable.
    - Set the program counter `vm->pc` to `vm->entry_pc`.
    - Set the instruction count `vm->ic` to 0.
    - Set the compute units `vm->cu` to `vm->entry_cu`.
    - Set the frame count `vm->frame_cnt` to 0.
    - Set the heap size `vm->heap_sz` to 0.
    - Do not reset any logs.
    - Return `FD_VM_SUCCESS` to indicate successful setup.
- **Output**: Returns `FD_VM_SUCCESS` on successful setup, or `FD_VM_ERR_INVAL` if the input `vm` is NULL.
- **Functions Called**:
    - [`fd_vm_mem_cfg`](<fd_vm_private.h.md#fd_vm_mem_cfg>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)