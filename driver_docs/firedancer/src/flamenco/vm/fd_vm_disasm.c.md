<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Disassembles and formats SBPF virtual machine instructions into human-readable assembly code.

# Purpose
The code is a C source file that provides functionality for disassembling a virtual machine's instruction set, specifically for a system using the SBPF (Solana Berkeley Packet Filter) instruction set. The primary function, [`fd_vm_disasm_program`](<#fd_vm_disasm_program>), takes a sequence of machine code instructions and translates them into a human-readable assembly format. It handles various instruction classes such as load, store, arithmetic logic unit (ALU), and jump instructions, and formats them into a string buffer. The code includes error handling for buffer overflows and invalid instructions, ensuring that the output buffer is properly terminated and that errors are reported with specific error codes.

The file defines several static functions, such as [`fd_vm_disasm_instr_alu`](<#fd_vm_disasm_instr_alu>), [`fd_vm_disasm_instr_jmp`](<#fd_vm_disasm_instr_jmp>), [`fd_vm_disasm_instr_ldx`](<#fd_vm_disasm_instr_ldx>), and [`fd_vm_disasm_instr_stx`](<#fd_vm_disasm_instr_stx>), which are responsible for disassembling specific types of instructions. These functions use a macro, `OUT_PRINTF`, to append formatted strings to the output buffer while checking for errors. The code also includes logic to manage program counter (PC) labels and function labels, which are used to annotate the disassembled output with meaningful identifiers. The file does not define a public API but provides internal functions and macros that are likely intended to be used within a larger system for disassembling and analyzing SBPF programs.
# Imports and Dependencies

---
- `fd_vm_private.h`
- `stdio.h`
- `stdarg.h`


# Functions

---
### fd\_vm\_disasm\_printf<!-- {{#callable:fd_vm_disasm_printf}} -->
[View Source →](<../../../../../src/flamenco/vm/fd_vm_disasm.c#L31>)

Appends formatted output to a buffer, updating the buffer length, and handles errors related to buffer overflow and format parsing.
- **Inputs**:
    - ``buf``: A character buffer where the formatted output will be appended.
    - ``max``: The maximum size of the buffer `buf`.
    - ``_len``: A pointer to the current length of the string in `buf`, which will be updated.
    - ``fmt``: A format string that specifies how to format the output.
    - ``...``: Additional arguments to be formatted according to `fmt`.
- **Logic and Control Flow**:
    - Initialize `len` with the value pointed to by `_len` and calculate `rem` as the remaining space in the buffer.
    - Start a variable argument list with `va_start` and use `vsnprintf` to format the output into the buffer starting at `buf + len`, with a maximum of `rem` characters.
    - End the variable argument list with `va_end`.
    - If `vsnprintf` returns a negative value, indicating a format error, terminate the string at `buf[len]` and return `FD_VM_ERR_IO`.
    - Calculate `append_len` as the number of characters written by `vsnprintf`.
    - If `append_len` is greater than or equal to `rem`, indicating truncation, terminate the string at `buf[max-1]`, set `*_len` to `max-1`, and return `FD_VM_ERR_FULL`.
    - Update `*_len` to `len + append_len` and return `FD_VM_SUCCESS`.
- **Output**: Returns `FD_VM_SUCCESS` on success, `FD_VM_ERR_FULL` if the buffer is too small, or `FD_VM_ERR_IO` if there is a format parsing error.


---
### fd\_vm\_disasm\_instr\_alu<!-- {{#callable:fd_vm_disasm_instr_alu}} -->
[View Source →](<../../../../../src/flamenco/vm/fd_vm_disasm.c#L74>)

Disassembles an ALU instruction and formats it into a human-readable string.
- **Inputs**:
    - `instr`: The `fd_sbpf_instr_t` structure representing the instruction to disassemble.
    - `suffix`: A constant character string to append to the operation name.
    - `out`: A character buffer to store the formatted output string.
    - `out_max`: The maximum number of characters that can be written to the `out` buffer.
    - `_out_len`: A pointer to an `ulong` that tracks the current length of the string in `out`.
- **Logic and Control Flow**:
    - Determine the operation name based on `instr.opcode.normal.op_mode` using a switch statement.
    - If the operation mode is `FD_SBPF_OPCODE_ALU_OP_MODE_NEG`, format the output string with the operation name, suffix, and destination register, then return success.
    - For other operation modes, check the source mode using another switch statement.
    - If the source mode is `FD_SBPF_OPCODE_SOURCE_MODE_IMM`, format the output string with the operation name, suffix, destination register, and immediate value, then return success.
    - If the source mode is `FD_SBPF_OPCODE_SOURCE_MODE_REG`, format the output string with the operation name, suffix, destination register, and source register, then return success.
    - If none of the cases match, return an invalid error code.
- **Output**: Returns `FD_VM_SUCCESS` on successful formatting, or an error code such as `FD_VM_ERR_INVAL` if the operation mode or source mode is invalid.


---
### fd\_vm\_disasm\_instr\_jmp<!-- {{#callable:fd_vm_disasm_instr_jmp}} -->
[View Source →](<../../../../../src/flamenco/vm/fd_vm_disasm.c#L118>)

Disassembles a jump instruction and formats it into a human-readable string representation.
- **Inputs**:
    - `instr`: The instruction to disassemble, represented as a `fd_sbpf_instr_t` structure.
    - `pc`: The current program counter, represented as an unsigned long integer.
    - `suffix`: A string suffix to append to the operation name in the output.
    - `syscalls`: A pointer to a `fd_sbpf_syscalls_t` structure containing syscall information, or NULL if not applicable.
    - `out`: A character buffer to store the formatted output string.
    - `out_max`: The maximum size of the output buffer.
    - `_out_len`: A pointer to an unsigned long integer that tracks the current length of the output string.
- **Logic and Control Flow**:
    - Determine the operation name based on the `op_mode` of the instruction's opcode.
    - If the operation mode is `CALL`, handle the source mode to format the output for syscalls or function calls.
    - If the operation mode is `EXIT`, format the output with the operation name and suffix.
    - If the operation mode is `JA`, calculate the target label and format the output accordingly.
    - For other jump operations, handle the source mode to format the output with registers and immediate values.
    - Return `FD_VM_ERR_INVAL` if the operation mode or source mode is invalid.
- **Output**: Returns `FD_VM_SUCCESS` on successful formatting, or an error code such as `FD_VM_ERR_INVAL` if the instruction is invalid.


---
### fd\_vm\_disasm\_instr\_ldx<!-- {{#callable:fd_vm_disasm_instr_ldx}} -->
[View Source →](<../../../../../src/flamenco/vm/fd_vm_disasm.c#L193>)

Disassembles a load instruction with index addressing and formats it into a human-readable string.
- **Inputs**:
    - `instr`: The instruction to disassemble, of type `fd_sbpf_instr_t`, containing opcode and addressing information.
    - `out`: A character buffer where the disassembled instruction string will be stored.
    - `out_max`: The maximum number of characters that can be written to the `out` buffer.
    - `_out_len`: A pointer to a variable that holds the current length of the string in `out` and will be updated with the new length after the operation.
- **Logic and Control Flow**:
    - Determine the operation name based on the `op_size` field of the instruction's opcode.
    - If the `op_size` is `FD_SBPF_OPCODE_SIZE_MODE_WORD`, set `op_name` to "ldxw".
    - If the `op_size` is `FD_SBPF_OPCODE_SIZE_MODE_HALF`, set `op_name` to "ldxh".
    - If the `op_size` is `FD_SBPF_OPCODE_SIZE_MODE_BYTE`, set `op_name` to "ldxb".
    - If the `op_size` is `FD_SBPF_OPCODE_SIZE_MODE_DOUB`, set `op_name` to "ldxdw".
    - If the `op_size` is not recognized, return `FD_VM_ERR_INVAL`.
    - Check if the `offset` in the instruction is negative.
    - If `offset` is negative, format the string as `"%s r%d, [r%d-0x%x]"` using `op_name`, `dst_reg`, `src_reg`, and the absolute value of `offset`.
    - If `offset` is non-negative, format the string as `"%s r%d, [r%d+0x%x]"` using `op_name`, `dst_reg`, `src_reg`, and `offset`.
    - Use the `OUT_PRINTF` macro to append the formatted string to the `out` buffer, handling any errors that occur.
    - Return `FD_VM_SUCCESS` if the operation completes successfully.
- **Output**: Returns `FD_VM_SUCCESS` on success or `FD_VM_ERR_INVAL` if the opcode size is invalid.


---
### fd\_vm\_disasm\_instr\_stx<!-- {{#callable:fd_vm_disasm_instr_stx}} -->
[View Source →](<../../../../../src/flamenco/vm/fd_vm_disasm.c#L213>)

Disassembles a store instruction and formats it into a human-readable string representation.
- **Inputs**:
    - `instr`: The `fd_sbpf_instr_t` structure representing the instruction to disassemble.
    - `out`: A character buffer where the disassembled instruction string will be written.
    - `out_max`: The maximum number of characters that can be written to the `out` buffer.
    - `_out_len`: A pointer to an `ulong` that tracks the current length of the string in the `out` buffer.
- **Logic and Control Flow**:
    - Determine the operation name based on the `op_size` field of the instruction's opcode.
    - If `op_size` is `FD_SBPF_OPCODE_SIZE_MODE_WORD`, set `op_name` to "stxw".
    - If `op_size` is `FD_SBPF_OPCODE_SIZE_MODE_HALF`, set `op_name` to "stxh".
    - If `op_size` is `FD_SBPF_OPCODE_SIZE_MODE_BYTE`, set `op_name` to "stxb".
    - If `op_size` is `FD_SBPF_OPCODE_SIZE_MODE_DOUB`, set `op_name` to "stxdw".
    - If `op_size` does not match any known size, return `FD_VM_ERR_INVAL`.
    - Check if the `offset` field of the instruction is negative.
    - If `offset` is negative, format the instruction as `"<op_name> [r<dst_reg>-0x<offset>], r<src_reg>"` and append it to the `out` buffer using `OUT_PRINTF`.
    - If `offset` is non-negative, format the instruction as `"<op_name> [r<dst_reg>+0x<offset>], r<src_reg>"` and append it to the `out` buffer using `OUT_PRINTF`.
    - Return `FD_VM_SUCCESS` if the operation is successful.
- **Output**: Returns `FD_VM_SUCCESS` on success or `FD_VM_ERR_INVAL` if the opcode size is invalid.


---
### fd\_vm\_disasm\_instr<!-- {{#callable:fd_vm_disasm_instr}} -->
[View Source →](<../../../../../src/flamenco/vm/fd_vm_disasm.c#L233>)

Disassembles a single instruction from a given text buffer and writes the result to an output buffer.
- **Inputs**:
    - `text`: A pointer to an array of unsigned long integers representing the instruction text to disassemble.
    - `text_cnt`: The number of instructions in the text array.
    - `pc`: The program counter indicating the current instruction's position in the text.
    - `syscalls`: A pointer to a structure containing system call information, used for disassembling jump instructions.
    - `out`: A pointer to a character buffer where the disassembled instruction will be written.
    - `out_max`: The maximum number of characters that can be written to the output buffer.
    - `_out_len`: A pointer to an unsigned long that tracks the current length of the output buffer.
- **Logic and Control Flow**:
    - Checks if any of the input pointers are null or if the output buffer is already full, returning an error if so.
    - Retrieves the first instruction from the text and determines its operation class.
    - For `FD_SBPF_OPCODE_CLASS_LD`, checks if there are at least two instructions, then disassembles a load instruction and writes it to the output buffer.
    - For `FD_SBPF_OPCODE_CLASS_ST`, writes a placeholder message to the output buffer indicating a store instruction.
    - For other operation classes, delegates the disassembly to specific helper functions based on the operation class, such as [`fd_vm_disasm_instr_ldx`](<#fd_vm_disasm_instr_ldx>), [`fd_vm_disasm_instr_stx`](<#fd_vm_disasm_instr_stx>), [`fd_vm_disasm_instr_alu`](<#fd_vm_disasm_instr_alu>), and [`fd_vm_disasm_instr_jmp`](<#fd_vm_disasm_instr_jmp>).
    - Returns an error if the operation class is not recognized.
- **Output**: Returns an integer status code indicating success or an error, such as `FD_VM_SUCCESS` for success or `FD_VM_ERR_INVAL` for invalid input.
- **Functions Called**:
    - [`fd_vm_disasm_instr_ldx`](<#fd_vm_disasm_instr_ldx>)
    - [`fd_vm_disasm_instr_stx`](<#fd_vm_disasm_instr_stx>)
    - [`fd_vm_disasm_instr_alu`](<#fd_vm_disasm_instr_alu>)
    - [`fd_vm_disasm_instr_jmp`](<#fd_vm_disasm_instr_jmp>)


---
### fd\_vm\_disasm\_program<!-- {{#callable:fd_vm_disasm_program}} -->
[View Source →](<../../../../../src/flamenco/vm/fd_vm_disasm.c#L273>)

Disassembles a program into a human-readable format by mapping program counters to labels and functions, and printing instructions.
- **Inputs**:
    - `text`: A pointer to an array of unsigned long integers representing the program instructions.
    - `text_cnt`: The number of instructions in the `text` array.
    - `syscalls`: A pointer to a structure containing system call information for disassembly.
    - `out`: A character buffer where the disassembled program will be written.
    - `out_max`: The maximum number of characters that can be written to the `out` buffer.
    - `_out_len`: A pointer to an unsigned long that tracks the current length of the output in the `out` buffer.
- **Logic and Control Flow**:
    - Checks for invalid input parameters and returns `FD_VM_ERR_INVAL` if any are found.
    - Initializes arrays `func_pc` and `label_pc` to store program counters for functions and labels, respectively.
    - Iterates over the instructions to count the number of function and label targets, updating `func_cnt` and `label_cnt`.
    - Checks if the number of functions or labels exceeds the maximum allowed and returns `FD_VM_ERR_UNSUP` if so.
    - Resets `func_cnt` and `label_cnt` and populates `func_pc` and `label_pc` with the actual program counters for functions and labels.
    - Outputs the initial function label `function_0:` to the `out` buffer.
    - Iterates over the instructions again, printing labels and functions as they are encountered, and disassembling each instruction using [`fd_vm_disasm_instr`](<#fd_vm_disasm_instr>).
    - Handles multiword instructions by checking for truncated instructions at the end of the text and returns `FD_VM_ERR_INVAL` if found.
    - Prints any trailing function labels if necessary.
- **Output**: Returns `FD_VM_SUCCESS` on successful disassembly, or an error code such as `FD_VM_ERR_INVAL` or `FD_VM_ERR_UNSUP` on failure.
- **Functions Called**:
    - [`fd_vm_disasm_instr`](<#fd_vm_disasm_instr>)


# Function Declarations (Public API)

---
### fd\_vm\_disasm\_printf<!-- {{#callable_declaration:fd_vm_disasm_printf}} -->
[View Source →](<../../../../../src/flamenco/vm/fd_vm_disasm.c#L25>)

Appends formatted output to a buffer with length tracking.
- **Description**: Use this function to append formatted text to a buffer while keeping track of the buffer's current length. It is important to ensure that the initial length of the buffer, as pointed to by `_len`, is within the range [0, `max`). The function guarantees that the buffer is null-terminated even in error cases. It returns specific error codes if the buffer is too small to hold the formatted output or if there is a format parsing error. This function is useful when you need to build a string incrementally and want to handle potential buffer overflows gracefully.
- **Inputs**:
    - `buf`: A pointer to the character buffer where the formatted output will be appended. The buffer must have a size of at least `max` bytes. The caller retains ownership and must ensure it is not null.
    - `max`: The maximum number of bytes that `buf` can hold. Must be greater than the initial value of `_len`.
    - `_len`: A pointer to an unsigned long that indicates the current length of the string in `buf`. On input, it must be in the range [0, `max`). On output, it is updated to reflect the new length of the string.
    - `fmt`: A format string that specifies how to format the remaining arguments. It must not be null and should follow the same rules as standard `printf` format strings.
- **Output**: Returns `FD_VM_SUCCESS` on success, `FD_VM_ERR_FULL` if the buffer is too small, or `FD_VM_ERR_IO` if there is a format parsing error. The buffer is always null-terminated.
- **See Also**: [`fd_vm_disasm_printf`](<#fd_vm_disasm_printf>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)