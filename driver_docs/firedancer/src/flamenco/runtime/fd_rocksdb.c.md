<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for initializing, creating, destroying, and manipulating RocksDB databases with column families.

# Purpose
The code is a C module that provides an interface for interacting with a RocksDB database. It includes functions to initialize, create, and destroy a RocksDB instance, as well as to perform operations on the database. The module defines several column families, each identified by an index, to organize different types of data within the database. The function [`fd_rocksdb_init`](<#fd_rocksdb_init>) initializes a RocksDB instance for read-only access, while [`fd_rocksdb_new`](<#fd_rocksdb_new>) creates a new database instance with the option to create missing databases. The [`fd_rocksdb_destroy`](<#fd_rocksdb_destroy>) function cleans up resources associated with a RocksDB instance.

The module also includes functions for iterating over and accessing specific data within the database. Functions like [`fd_rocksdb_last_slot`](<#fd_rocksdb_last_slot>) and [`fd_rocksdb_first_slot`](<#fd_rocksdb_first_slot>) retrieve the last and first slots from a specific column family, respectively. The [`fd_rocksdb_get_meta`](<#fd_rocksdb_get_meta>) function retrieves metadata for a given slot. Additionally, the module provides iterator functions such as [`fd_rocksdb_root_iter_new`](<#fd_rocksdb_root_iter_new>), [`fd_rocksdb_root_iter_seek`](<#fd_rocksdb_root_iter_seek>), and [`fd_rocksdb_root_iter_next`](<#fd_rocksdb_root_iter_next>) to navigate through the database entries. The module also includes utility functions for inserting entries and copying data over a range of slots. The code is designed to be used as part of a larger system that requires database operations with RocksDB, and it defines a public API for these operations.
# Imports and Dependencies

---
- `fd_rocksdb.h`
- `stdbool.h`
- `stdlib.h`
- `stdio.h`
- `unistd.h`
- `../../util/bits/fd_bits.h`


# Functions

---
### fd\_rocksdb\_init<!-- {{#callable:fd_rocksdb_init}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_rocksdb.c#L8>)

Initializes a RocksDB instance for read-only access with predefined column families.
- **Inputs**:
    - ``db``: A pointer to an `fd_rocksdb_t` structure that will be initialized.
    - ``db_name``: A constant character pointer representing the name of the database to open.
- **Logic and Control Flow**:
    - Set all bytes of the `db` structure to zero using `fd_memset`.
    - Create RocksDB options using `rocksdb_options_create` and assign to `db->opts`.
    - Initialize the `db->cfgs` array with predefined column family names.
    - Create an array `cf_options` and set each element to `db->opts`.
    - Initialize a `char *err` to `NULL` to capture any error messages.
    - Open the RocksDB database in read-only mode with column families using `rocksdb_open_for_read_only_column_families`.
    - If an error occurs during database opening, return the error message.
    - Create read options using `rocksdb_readoptions_create` and assign to `db->ro`.
    - Return `NULL` to indicate successful initialization.
- **Output**: Returns `NULL` on success or a pointer to an error message if the initialization fails.


---
### fd\_rocksdb\_new<!-- {{#callable:fd_rocksdb_new}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_rocksdb.c#L59>)

Initializes a new RocksDB instance with specified column families and options, and opens the database for writing.
- **Inputs**:
    - ``db``: A pointer to an `fd_rocksdb_t` structure that will be initialized and used to manage the RocksDB instance.
    - ``db_name``: A constant character pointer representing the name of the database to open or create.
- **Logic and Control Flow**:
    - Set all bytes of the `fd_rocksdb_t` structure pointed to by `db` to zero using `fd_memset`.
    - Create RocksDB options using `rocksdb_options_create` and store them in `db->opts`.
    - Set the option to create the database if it does not exist using `rocksdb_options_set_create_if_missing`.
    - Initialize the `cfgs` array in `db` with predefined column family names.
    - Attempt to open the RocksDB database with the specified name using `rocksdb_open`, storing any error message in `err`.
    - If an error occurs during database opening, log the error message and terminate the function.
    - Create write options for the database using `rocksdb_writeoptions_create` and store them in `db->wo`.
    - Iterate over the column family indices, starting from 1, and create each column family using `rocksdb_create_column_family`, storing any error message in `err`.
    - Set the compression option for the database to LZ4 using `rocksdb_options_set_compression`.
- **Output**: This function does not return a value; it initializes the `fd_rocksdb_t` structure and sets up the RocksDB instance for use.


---
### fd\_rocksdb\_destroy<!-- {{#callable:fd_rocksdb_destroy}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_rocksdb.c#L106>)

Releases resources associated with a RocksDB instance and sets pointers to NULL.
- **Inputs**:
    - ``db``: A pointer to an `fd_rocksdb_t` structure representing the RocksDB instance to destroy.
- **Logic and Control Flow**:
    - Iterates over each column family handle in `db->cf_handles` and destroys it if it is not NULL, then sets the handle to NULL.
    - Checks if `db->ro` (read options) is not NULL, destroys it, and sets it to NULL.
    - Checks if `db->opts` (options) is not NULL, destroys it, and sets it to NULL.
    - Checks if `db->db` (database) is not NULL, closes it, and sets it to NULL.
    - Checks if `db->wo` (write options) is not NULL and destroys it.
- **Output**: No return value; the function operates directly on the `fd_rocksdb_t` structure pointed to by `db`.


---
### fd\_rocksdb\_last\_slot<!-- {{#callable:fd_rocksdb_last_slot}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_rocksdb.c#L135>)

Retrieves the last slot number from the 'root' column family in a RocksDB database.
- **Inputs**:
    - ``db``: A pointer to an `fd_rocksdb_t` structure representing the RocksDB database.
    - ``err``: A pointer to a character pointer for storing error messages, if any.
- **Logic and Control Flow**:
    - Create an iterator for the 'root' column family using `rocksdb_create_iterator_cf`.
    - Seek to the last entry in the column family using `rocksdb_iter_seek_to_last`.
    - Check if the iterator is valid using `rocksdb_iter_valid`.
    - If the iterator is not valid, destroy the iterator, set the error message to 'db column for root is empty', and return 0.
    - If the iterator is valid, retrieve the key using `rocksdb_iter_key`.
    - Convert the key to an unsigned long using `fd_ulong_bswap`.
    - Destroy the iterator and return the converted slot number.
- **Output**: Returns the last slot number as an unsigned long, or 0 if the column family is empty.


---
### fd\_rocksdb\_first\_slot<!-- {{#callable:fd_rocksdb_first_slot}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_rocksdb.c#L151>)

Retrieves the first slot from the 'root' column family in a RocksDB database.
- **Inputs**:
    - ``db``: A pointer to an `fd_rocksdb_t` structure representing the RocksDB database.
    - ``err``: A pointer to a character pointer for storing an error message if the function fails.
- **Logic and Control Flow**:
    - Create an iterator for the 'root' column family using `rocksdb_create_iterator_cf`.
    - Seek the iterator to the first entry using `rocksdb_iter_seek_to_first`.
    - Check if the iterator is valid using `rocksdb_iter_valid`.
    - If the iterator is not valid, destroy the iterator, set the error message to "db column for root is empty", and return 0.
    - If the iterator is valid, retrieve the key using `rocksdb_iter_key`.
    - Convert the key to a slot number using `fd_ulong_bswap`.
    - Destroy the iterator and return the slot number.
- **Output**: Returns the first slot number as an unsigned long integer, or 0 if the 'root' column family is empty.


---
### fd\_rocksdb\_get\_meta<!-- {{#callable:fd_rocksdb_get_meta}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_rocksdb.c#L170>)

Retrieves and decodes metadata for a given slot from a RocksDB database.
- **Inputs**:
    - ``db``: A pointer to an `fd_rocksdb_t` structure representing the database.
    - ``slot``: An unsigned long integer representing the slot number for which metadata is retrieved.
- **Logic and Control Flow**:
    - Convert `slot` to big-endian format using `fd_ulong_bswap` and store it in `ks`.
    - Initialize `vallen` to 0 and `err` to NULL.
    - Call `rocksdb_get_cf` to retrieve metadata for the given slot from the 'meta' column family, storing the result in `meta` and any error in `err`.
    - If `err` is not NULL, log a warning, free `err`, and return NULL.
    - If `vallen` is 0, return NULL.
    - Initialize a `fd_bincode_decode_ctx_t` structure `ctx` with `meta` and its end address.
    - Call `fd_slot_meta_decode_footprint` to determine the total size of the metadata, storing it in `total_sz`.
    - If `fd_slot_meta_decode_footprint` fails, log an error and terminate the program.
    - Allocate memory for `fd_slot_meta_t` using `aligned_alloc` with the alignment and size determined.
    - If memory allocation fails, log an error and terminate the program.
    - Decode the metadata into the allocated memory using `fd_slot_meta_decode`.
    - Free the `meta` buffer.
    - Return the pointer to the decoded `fd_slot_meta_t` structure.
- **Output**: A pointer to an `fd_slot_meta_t` structure containing the decoded metadata, or NULL if an error occurs or no metadata is found.


---
### fd\_rocksdb\_root\_iter\_new<!-- {{#callable:fd_rocksdb_root_iter_new}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_rocksdb.c#L215>)

Initializes a `fd_rocksdb_root_iter_t` structure to zero and returns the pointer.
- **Inputs**:
    - `ptr`: A pointer to a memory location where the `fd_rocksdb_root_iter_t` structure will be initialized.
- **Logic and Control Flow**:
    - Calls `fd_memset` to set the memory at `ptr` to zero for the size of `fd_rocksdb_root_iter_t`.
    - Returns the `ptr` after initialization.
- **Output**: Returns the input pointer `ptr` after setting its memory to zero.


---
### fd\_rocksdb\_root\_iter\_join<!-- {{#callable:fd_rocksdb_root_iter_join}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_rocksdb.c#L221>)

Casts a generic pointer to a `fd_rocksdb_root_iter_t` pointer.
- **Inputs**:
    - `ptr`: A generic pointer to be cast to a `fd_rocksdb_root_iter_t` pointer.
- **Logic and Control Flow**:
    - Casts the input pointer `ptr` to a `fd_rocksdb_root_iter_t` pointer.
    - Returns the cast pointer.
- **Output**: A pointer of type `fd_rocksdb_root_iter_t *`.


---
### fd\_rocksdb\_root\_iter\_leave<!-- {{#callable:fd_rocksdb_root_iter_leave}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_rocksdb.c#L226>)

Returns the pointer to the `fd_rocksdb_root_iter_t` structure passed as an argument.
- **Inputs**:
    - `ptr`: A pointer to an `fd_rocksdb_root_iter_t` structure.
- **Logic and Control Flow**:
    - Return the input pointer `ptr`.
- **Output**: A pointer to the `fd_rocksdb_root_iter_t` structure that was passed as an argument.


---
### fd\_rocksdb\_root\_iter\_seek<!-- {{#callable:fd_rocksdb_root_iter_seek}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_rocksdb.c#L231>)

Seeks a specific slot in the RocksDB root column family and retrieves its metadata if found.
- **Inputs**:
    - ``self``: A pointer to an `fd_rocksdb_root_iter_t` structure, representing the iterator state.
    - ``db``: A pointer to an `fd_rocksdb_t` structure, representing the RocksDB database instance.
    - ``slot``: An unsigned long integer representing the slot number to seek in the database.
- **Logic and Control Flow**:
    - Assigns the `db` parameter to the `self->db` field.
    - Checks if `self->iter` is NULL; if so, creates a new iterator for the root column family using `rocksdb_create_iterator_cf`.
    - Converts the `slot` to big-endian format using `fd_ulong_bswap`.
    - Seeks the iterator to the key corresponding to the big-endian `slot` using `rocksdb_iter_seek`.
    - Checks if the iterator is valid using `rocksdb_iter_valid`; returns NULL if not valid.
    - Retrieves the key from the iterator using `rocksdb_iter_key` and converts it back to host-endian format.
    - Compares the retrieved slot with the requested `slot`; logs a warning and returns NULL if they do not match.
    - Calls [`fd_rocksdb_get_meta`](<#fd_rocksdb_get_meta>) to retrieve and return the metadata for the slot.
- **Output**: Returns a pointer to an `fd_slot_meta_t` structure containing the metadata for the specified slot, or NULL if the slot is not found or an error occurs.
- **Functions Called**:
    - [`fd_rocksdb_get_meta`](<#fd_rocksdb_get_meta>)


---
### fd\_rocksdb\_root\_iter\_slot<!-- {{#callable:fd_rocksdb_root_iter_slot}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_rocksdb.c#L259>)

Retrieves the slot number from the current position of a RocksDB iterator and stores it in the provided slot variable.
- **Inputs**:
    - `self`: A pointer to an `fd_rocksdb_root_iter_t` structure, which contains the RocksDB database and iterator.
    - `slot`: A pointer to an `ulong` where the function will store the slot number retrieved from the iterator.
- **Logic and Control Flow**:
    - Check if `self->db` or `self->iter` is `NULL`; if so, return -1.
    - Check if the iterator `self->iter` is valid using `rocksdb_iter_valid`; if not, return -2.
    - Retrieve the key from the iterator using `rocksdb_iter_key` and store its length in `klen`.
    - Convert the key to an `unsigned long`, byte-swap it using `fd_ulong_bswap`, and store the result in `*slot`.
    - Return 0 to indicate success.
- **Output**: Returns 0 on success, -1 if the database or iterator is `NULL`, and -2 if the iterator is not valid.


---
### fd\_rocksdb\_root\_iter\_next<!-- {{#callable:fd_rocksdb_root_iter_next}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_rocksdb.c#L273>)

Retrieves the next valid slot metadata from a RocksDB iterator if available.
- **Inputs**:
    - `self`: A pointer to an `fd_rocksdb_root_iter_t` structure, representing the iterator state.
- **Logic and Control Flow**:
    - Check if `self->db` or `self->iter` is `NULL`; if so, return `NULL`.
    - Verify if the iterator `self->iter` is valid using `rocksdb_iter_valid`; if not, return `NULL`.
    - Advance the iterator to the next position using `rocksdb_iter_next`.
    - Check again if the iterator is valid; if not, return `NULL`.
    - Retrieve the key from the current iterator position using `rocksdb_iter_key`.
    - Convert the key to an unsigned long using `fd_ulong_bswap`.
    - Call [`fd_rocksdb_get_meta`](<#fd_rocksdb_get_meta>) with the database and the converted key to get the slot metadata.
- **Output**: A pointer to `fd_slot_meta_t` containing the metadata of the next valid slot, or `NULL` if no valid slot is found.
- **Functions Called**:
    - [`fd_rocksdb_get_meta`](<#fd_rocksdb_get_meta>)


---
### fd\_rocksdb\_root\_iter\_destroy<!-- {{#callable:fd_rocksdb_root_iter_destroy}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_rocksdb.c#L292>)

Releases resources associated with a RocksDB iterator and resets its state.
- **Inputs**:
    - `self`: A pointer to an `fd_rocksdb_root_iter_t` structure representing the iterator to be destroyed.
- **Logic and Control Flow**:
    - Check if `self->iter` is not `NULL`.
    - If `self->iter` is not `NULL`, call `rocksdb_iter_destroy` to destroy the iterator and set `self->iter` to `0`.
    - Set `self->db` to `NULL`.
- **Output**: No return value; the function operates directly on the `fd_rocksdb_root_iter_t` structure pointed to by `self`.


---
### fd\_rocksdb\_get\_slot<!-- {{#callable:fd_rocksdb_get_slot}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_rocksdb.c#L301>)

Extracts and returns the slot number from a given key based on the column family index.
- **Inputs**:
    - `cf_idx`: An unsigned long integer representing the column family index.
    - `key`: A constant character pointer representing the key from which to extract the slot number.
- **Logic and Control Flow**:
    - Check the value of `cf_idx` to determine the position of the slot number in the `key`.
    - If `cf_idx` is `FD_ROCKSDB_CFIDX_TRANSACTION_STATUS`, extract the slot number from the 72nd byte of `key`.
    - If `cf_idx` is `FD_ROCKSDB_CFIDX_ADDRESS_SIGNATURES`, extract the slot number from the 40th byte of `key`.
    - For all other values of `cf_idx`, extract the slot number from the start of `key`.
    - Use `fd_ulong_bswap` to convert the extracted slot number from big-endian to host byte order before returning it.
- **Output**: Returns the slot number as an unsigned long integer after converting it from big-endian to host byte order.


---
### fd\_rocksdb\_iter\_seek\_to\_slot\_if\_possible<!-- {{#callable:fd_rocksdb_iter_seek_to_slot_if_possible}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_rocksdb.c#L315>)

Seeks a RocksDB iterator to a specific slot if the column family allows it, otherwise seeks to the first entry.
- **Inputs**:
    - ``iter``: A pointer to a `rocksdb_iterator_t` object, which is the iterator to seek.
    - ``cf_idx``: An unsigned long representing the column family index to determine the seek behavior.
    - ``slot``: An unsigned long representing the slot number to seek to.
- **Logic and Control Flow**:
    - Convert `slot` to big-endian format using `fd_ulong_bswap` and store it in `k`.
    - Check the value of `cf_idx` to determine the seek behavior.
    - If `cf_idx` is `FD_ROCKSDB_CFIDX_TRANSACTION_STATUS` or `FD_ROCKSDB_CFIDX_ADDRESS_SIGNATURES`, call `rocksdb_iter_seek_to_first` to seek to the first entry.
    - For all other column families, call `rocksdb_iter_seek` with the big-endian slot value to seek based on the slot prefix.
- **Output**: This function does not return a value; it modifies the position of the iterator `iter`.


---
### fd\_rocksdb\_copy\_over\_slot\_indexed\_range<!-- {{#callable:fd_rocksdb_copy_over_slot_indexed_range}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_rocksdb.c#L330>)

Copies entries from a source RocksDB database to a destination database within a specified slot-indexed range, excluding certain column families.
- **Inputs**:
    - ``src``: Pointer to the source `fd_rocksdb_t` database structure.
    - ``dst``: Pointer to the destination `fd_rocksdb_t` database structure.
    - ``cf_idx``: Index of the column family to copy from.
    - ``start_slot``: Starting slot number for the range to copy.
    - ``end_slot``: Ending slot number for the range to copy.
- **Logic and Control Flow**:
    - Logs the start of the copy operation with the column family index.
    - Checks if the column family index is one of the non-slot-indexed types (`FD_ROCKSDB_CFIDX_TRANSACTION_MEMOS`, `FD_ROCKSDB_CFIDX_TRANSACTION_STATUS`, `FD_ROCKSDB_CFIDX_ADDRESS_SIGNATURES`) and skips copying if true.
    - Creates an iterator for the specified column family in the source database.
    - Logs an error and exits if the iterator creation fails.
    - Seeks the iterator to the starting slot if possible.
    - Iterates over the entries in the column family, checking if the slot is within the specified range.
    - Copies each valid entry from the source to the destination database using [`fd_rocksdb_insert_entry`](<#fd_rocksdb_insert_entry>).
    - Destroys the iterator after the operation is complete.
- **Output**: Returns 0 after completing the copy operation or if the column family is skipped.
- **Functions Called**:
    - [`fd_rocksdb_iter_seek_to_slot_if_possible`](<#fd_rocksdb_iter_seek_to_slot_if_possible>)
    - [`fd_rocksdb_get_slot`](<#fd_rocksdb_get_slot>)
    - [`fd_rocksdb_insert_entry`](<#fd_rocksdb_insert_entry>)


---
### fd\_rocksdb\_insert\_entry<!-- {{#callable:fd_rocksdb_insert_entry}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_rocksdb.c#L371>)

Inserts a key-value pair into a specified column family in a RocksDB database.
- **Inputs**:
    - ``db``: A pointer to an `fd_rocksdb_t` structure representing the RocksDB database.
    - ``cf_idx``: An unsigned long integer representing the index of the column family in which to insert the entry.
    - ``key``: A pointer to a constant character array representing the key to insert.
    - ``klen``: An unsigned long integer representing the length of the key.
    - ``value``: A pointer to a constant character array representing the value to insert.
    - ``vlen``: An unsigned long integer representing the length of the value.
- **Logic and Control Flow**:
    - Initialize a character pointer `err` to `NULL` to store any error message from the RocksDB operation.
    - Call `rocksdb_put_cf` to insert the key-value pair into the specified column family using the provided database handle, write options, column family handle, key, key length, value, and value length.
    - Check if `err` is not `NULL`, indicating an error occurred during the insertion.
    - If an error occurred, log a warning message with the error details and return `-1`.
    - If no error occurred, return `0` to indicate success.
- **Output**: Returns `0` on successful insertion, or `-1` if an error occurs during the insertion process.



---
Made with ❤️ by [Driver](https://www.driver.ai/)