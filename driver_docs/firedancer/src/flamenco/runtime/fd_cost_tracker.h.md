<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Block-level cost tracker for transaction limits, including CU consumption and account data size, with error handling for limit violations.

# Purpose
The `fd_cost_tracker.h` file is a C header file that defines a cost tracking system for managing block-level limits in a transaction processing environment. It provides functionality to track and calculate costs associated with transactions, such as compute unit (CU) consumption, writable account usage, and account data size. The file defines constants for various limits, such as maximum writable account units and block units, which are used to ensure that transactions do not exceed predefined thresholds. If a block's limits are exceeded, it is marked as dead, preventing further transactions from being processed within that block.

The file includes the definition of the `fd_cost_tracker_t` structure, which holds information about the current block cost, vote cost, and allocated account data size, along with their respective limits. It also provides function prototypes for initializing and managing the cost tracker, such as [`fd_cost_tracker_new`](<#fd_cost_tracker_new>), [`fd_cost_tracker_join`](<#fd_cost_tracker_join>), and [`fd_cost_tracker_init`](<#fd_cost_tracker_init>). The function [`fd_cost_tracker_calculate_cost_and_add`](<#fd_cost_tracker_calculate_cost_and_add>) is responsible for calculating the cost of a transaction and updating the cost tracker if the transaction fits within the block's limits. The header file also includes several macros and constants that define the alignment, footprint, and magic number for the cost tracker, ensuring proper memory management and identification.
# Imports and Dependencies

---
- `fd_executor.h`
- `../../disco/pack/fd_pack.h`
- `../../disco/pack/fd_pack_cost.h`


# Data Structures

---
### fd\_cost\_tracker
- **Type**: ``struct``
- **Members**:
    - `block_cost`: Stores the accumulated cost of the block.
    - `vote_cost`: Stores the accumulated cost related to votes.
    - `allocated_accounts_data_size`: Stores the size of data allocated for accounts.
    - `block_cost_limit`: Defines the maximum allowable cost for a block.
    - `vote_cost_limit`: Defines the maximum allowable cost related to votes.
    - `account_cost_limit`: Defines the maximum allowable cost for account usage.
- **Description**: Tracks various costs and limits at the block level, including block cost, vote cost, and allocated account data size, with corresponding limits to ensure that these do not exceed predefined thresholds.


---
### fd\_cost\_tracker\_t
- **Type**: ``struct``
- **Members**:
    - ``block_cost``: Stores the accumulated cost of transactions in a block.
    - ``vote_cost``: Stores the cost associated with voting transactions.
    - ``allocated_accounts_data_size``: Tracks the size of data allocated for accounts.
    - ``block_cost_limit``: Defines the maximum allowable cost for a block.
    - ``vote_cost_limit``: Defines the maximum allowable cost for voting transactions.
    - ``account_cost_limit``: Defines the maximum allowable cost for account-related operations.
- **Description**: `fd_cost_tracker_t` is a data structure used to track and manage costs at the block level, including computation unit consumption, writable account usage, and account data size. It accumulates transaction costs and checks against predefined limits to determine if a block exceeds its allowable resources, marking it as dead if limits are surpassed.


# Functions

---
### fd\_cost\_tracker\_calculate\_loaded\_accounts\_data\_size\_cost<!-- {{#callable:fd_cost_tracker_calculate_loaded_accounts_data_size_cost}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_cost_tracker.h#L109>)

Calculates the cost of loaded account data size for a transaction context.
- **Inputs**:
    - `txn_ctx`: A pointer to a `fd_exec_txn_ctx_t` structure that contains the transaction context, including the loaded accounts data size.
- **Logic and Control Flow**:
    - Add `txn_ctx->loaded_accounts_data_size` to `FD_ACCOUNT_DATA_COST_PAGE_SIZE` using `fd_ulong_sat_add`.
    - Subtract 1 from the result using `fd_ulong_sat_sub`.
    - Divide the result by `FD_ACCOUNT_DATA_COST_PAGE_SIZE`.
    - Multiply the result by `FD_VM_HEAP_COST` using `fd_ulong_sat_mul`.
    - Return the final calculated cost.
- **Output**: Returns the calculated cost as an unsigned long integer (`ulong`).


# Function Declarations (Public API)

---
### fd\_cost\_tracker\_align<!-- {{#callable_declaration:fd_cost_tracker_align}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_cost_tracker.h#L85>)

Returns the alignment requirement for a cost tracker.
- **Description**: Use this function to obtain the alignment requirement for a `fd_cost_tracker_t` structure. This is necessary when allocating memory for a cost tracker to ensure proper alignment. The function does not require any parameters and can be called at any time to retrieve the alignment value.
- **Inputs**: None
- **Output**: Returns an unsigned long integer representing the alignment requirement in bytes.
- **See Also**: [`fd_cost_tracker_align`](<fd_cost_tracker.c.md#fd_cost_tracker_align>)  (Implementation)


---
### fd\_cost\_tracker\_footprint<!-- {{#callable_declaration:fd_cost_tracker_footprint}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_cost_tracker.h#L90>)

Calculates the memory footprint required for a cost tracker.
- **Description**: Use this function to determine the amount of memory needed to store a cost tracker, which is used to track various limits such as compute unit consumption and account usage. This function is useful when allocating memory for a cost tracker to ensure that sufficient space is available. It does not require any parameters and can be called at any time to retrieve the current memory footprint requirement.
- **Inputs**: None
- **Output**: Returns the size in bytes required to store a cost tracker.
- **See Also**: [`fd_cost_tracker_footprint`](<fd_cost_tracker.c.md#fd_cost_tracker_footprint>)  (Implementation)


---
### fd\_cost\_tracker\_new<!-- {{#callable_declaration:fd_cost_tracker_new}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_cost_tracker.h#L93>)

Creates a new cost tracker in shared memory.
- **Description**: Use this function to initialize a new cost tracker in a specified shared memory region. The shared memory must be properly aligned according to the alignment requirements of the cost tracker. This function is typically called during the setup phase of a system that tracks costs associated with transactions. Ensure that the shared memory pointer is not null and is correctly aligned before calling this function. If these conditions are not met, the function will log a warning and return null.
- **Inputs**:
    - `shmem`: A pointer to the shared memory region where the cost tracker will be created. Must not be null and must be aligned to the required boundary. If null or misaligned, the function logs a warning and returns null.
    - `seed`: An unsigned long integer used to seed internal data structures. There are no specific constraints on its value.
- **Output**: Returns a pointer to the initialized shared memory region if successful, or null if the input conditions are not met.
- **See Also**: [`fd_cost_tracker_new`](<fd_cost_tracker.c.md#fd_cost_tracker_new>)  (Implementation)


---
### fd\_cost\_tracker\_join<!-- {{#callable_declaration:fd_cost_tracker_join}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_cost_tracker.h#L97>)

Joins a shared memory cost tracker.
- **Description**: Use this function to access a cost tracker from shared memory. It checks if the provided memory is non-null, properly aligned, and contains a valid cost tracker magic number. If any of these conditions are not met, it returns null. This function is typically called after initializing shared memory to ensure the cost tracker is ready for use.
- **Inputs**:
    - `shct`: A pointer to shared memory that should contain a cost tracker. Must not be null, must be aligned to `fd_cost_tracker_align()`, and must contain a valid magic number. If these conditions are not met, the function returns null.
- **Output**: Returns a pointer to `fd_cost_tracker_t` if successful, or null if the input is invalid.
- **See Also**: [`fd_cost_tracker_join`](<fd_cost_tracker.c.md#fd_cost_tracker_join>)  (Implementation)


---
### fd\_cost\_tracker\_init<!-- {{#callable_declaration:fd_cost_tracker_init}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_cost_tracker.h#L100>)

Initializes a cost tracker with specified limits based on features and slot.
- **Description**: Use this function to set up a `fd_cost_tracker_t` structure with initial cost limits and zeroed cost values. It configures the block, vote, and account cost limits based on the active features for a given slot. This function must be called before using the cost tracker to ensure it is properly initialized. The caller must ensure that `cost_tracker` is a valid pointer to a `fd_cost_tracker_t` structure and that `features` is a valid pointer to a `fd_features_t` structure. The function does not return a value and does not handle invalid pointers.
- **Inputs**:
    - `cost_tracker`: A pointer to a `fd_cost_tracker_t` structure that will be initialized. Must not be null.
    - `features`: A pointer to a `fd_features_t` structure that contains feature flags. Must not be null.
    - `slot`: An unsigned long integer representing the slot for which the cost tracker is being initialized. Used to determine active features.
- **Output**: None
- **See Also**: [`fd_cost_tracker_init`](<fd_cost_tracker.c.md#fd_cost_tracker_init>)  (Implementation)


---
### fd\_cost\_tracker\_block\_cost\_limit<!-- {{#callable_declaration:fd_cost_tracker_block_cost_limit}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_cost_tracker.h#L105>)

Determines the block cost limit based on active features.
- **Description**: Use this function to get the block cost limit for a given bank, which depends on the active features for the current slot. This function is useful when you need to know the maximum allowable block cost for transaction processing. Ensure that the `bank` parameter is valid and properly initialized before calling this function.
- **Inputs**:
    - `bank`: A pointer to a `fd_bank_t` structure representing the bank for which the block cost limit is queried. Must not be null and should be properly initialized. Invalid or null input will lead to undefined behavior.
- **Output**: Returns an unsigned long integer representing the block cost limit, which is determined by the active features for the current slot.
- **See Also**: [`fd_cost_tracker_block_cost_limit`](<fd_cost_tracker.c.md#fd_cost_tracker_block_cost_limit>)  (Implementation)


---
### fd\_cost\_tracker\_calculate\_cost\_and\_add<!-- {{#callable_declaration:fd_cost_tracker_calculate_cost_and_add}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_cost_tracker.h#L136>)

Calculates transaction cost and updates the cost tracker.
- **Description**: Use this function to calculate the cost of a transaction and add it to a block-level cost tracker. It checks if the transaction can fit within the block's limits. If the transaction fits, the function updates the cost tracker and returns success. If the transaction exceeds any block limits, it returns an error code indicating which limit was violated. Ensure that concurrent access to the cost tracker is managed externally, as this function does not handle concurrency.
- **Inputs**:
    - `cost_tracker`: A pointer to an `fd_cost_tracker_t` structure that tracks block-level costs. Must not be null. The caller is responsible for ensuring thread safety when accessing this structure.
    - `txn_ctx`: A pointer to a constant `fd_exec_txn_ctx_t` structure representing the transaction context. If null, the function returns success without modifying the cost tracker.
- **Output**: Returns an integer status code. `FD_COST_TRACKER_SUCCESS` indicates success, while other codes indicate specific block limit violations.
- **See Also**: [`fd_cost_tracker_calculate_cost_and_add`](<fd_cost_tracker.c.md#fd_cost_tracker_calculate_cost_and_add>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)