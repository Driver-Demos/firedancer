<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for creating and deriving program-derived addresses (PDAs) using SHA-256 hashing and validation.

# Purpose
The code provides functionality for creating and managing public keys, specifically focusing on operations related to Program Derived Addresses (PDAs) in a blockchain context. It includes three main functions: [`fd_pubkey_create_with_seed`](<#fd_pubkey_create_with_seed>), [`fd_pubkey_derive_pda`](<#fd_pubkey_derive_pda>), and [`fd_pubkey_find_program_address`](<#fd_pubkey_find_program_address>). These functions are designed to handle the creation of public keys using a seed, derive PDAs from a set of seeds, and find a valid program address by iterating over possible bump seeds, respectively. The code uses SHA-256 hashing to combine inputs such as seeds, base keys, and owner identifiers to produce unique public keys or PDAs.

The code imports several headers, indicating dependencies on external utilities for public key operations, error handling, and system calls. It defines error handling mechanisms to manage conditions such as exceeding maximum seed lengths or encountering invalid seeds. The functions are designed to be part of a larger system, likely a blockchain or cryptographic application, where they provide specific utilities for managing cryptographic identities. The code does not define public APIs or external interfaces directly but is intended to be integrated into a larger system where these functions are called as part of the execution flow.
# Imports and Dependencies

---
- `fd_pubkey_utils.h`
- `fd_executor_err.h`
- `../vm/syscall/fd_vm_syscall.h`
- `../../ballet/ed25519/fd_curve25519.h`


# Functions

---
### fd\_pubkey\_create\_with\_seed<!-- {{#callable:fd_pubkey_create_with_seed}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_pubkey_utils.c#L6>)

Generates a public key by hashing a base, seed, and owner, with error checks for seed length and owner legality.
- **Inputs**:
    - `ctx`: A pointer to a `fd_exec_instr_ctx_t` structure that provides context for the execution, including error handling.
    - `base`: A 32-byte array that serves as the base input for the hash function.
    - `seed`: A pointer to a character array that represents the seed input for the hash function.
    - `seed_sz`: An unsigned long integer representing the size of the seed.
    - `owner`: A 32-byte array that represents the owner input for the hash function.
    - `out`: A 32-byte array where the resulting public key will be stored.
- **Logic and Control Flow**:
    - Check if `seed_sz` exceeds `MAX_SEED_LEN`; if true, set a custom error in `ctx` and return an error code.
    - Check if the `owner` contains the string 'ProgramDerivedAddress' starting from the 12th byte; if true, set a custom error in `ctx` and return an error code.
    - Initialize a SHA-256 context using `fd_sha256_init`.
    - Append the `base`, `seed`, and `owner` to the SHA-256 context using `fd_sha256_append`.
    - Finalize the SHA-256 hash and store the result in `out` using `fd_sha256_fini`.
    - Return a success code.
- **Output**: Returns an integer status code indicating success or a specific error.


---
### fd\_pubkey\_derive\_pda<!-- {{#callable:fd_pubkey_derive_pda}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_pubkey_utils.c#L39>)

Derives a Program Derived Address (PDA) using a set of seeds and a program ID, and validates the result.
- **Inputs**:
    - `program_id`: A pointer to the program ID used in the derivation process.
    - `seeds_cnt`: The number of seed elements provided.
    - `seeds`: An array of pointers to seed data used in the derivation.
    - `seed_szs`: An array of sizes corresponding to each seed in the seeds array.
    - `bump_seed`: An optional pointer to a bump seed used to modify the derivation process.
    - `out`: A pointer to the output location where the derived PDA will be stored.
    - `custom_err`: A pointer to a variable where custom error codes will be stored if an error occurs.
- **Logic and Control Flow**:
    - Check if the total number of seeds, including the bump seed if present, exceeds `MAX_SEEDS`; if so, set `custom_err` to `FD_PUBKEY_ERR_MAX_SEED_LEN_EXCEEDED` and return `FD_EXECUTOR_INSTR_ERR_CUSTOM_ERR`.
    - Initialize a SHA-256 context and append each seed to it, breaking if a null seed is encountered.
    - If a `bump_seed` is provided, append it to the SHA-256 context.
    - Append the `program_id` and the string "ProgramDerivedAddress" to the SHA-256 context.
    - Finalize the SHA-256 hash and store the result in `out`.
    - Validate the derived PDA by checking if it is not a valid ed25519 curve point; if it is valid, set `custom_err` to `FD_PUBKEY_ERR_INVALID_SEEDS` and return `FD_EXECUTOR_INSTR_ERR_CUSTOM_ERR`.
    - Return `FD_PUBKEY_SUCCESS` if the PDA is successfully derived and validated.
- **Output**: Returns `FD_PUBKEY_SUCCESS` on successful derivation and validation of the PDA, or an error code if a failure occurs.


---
### fd\_pubkey\_find\_program\_address<!-- {{#callable:fd_pubkey_find_program_address}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_pubkey_utils.c#L86>)

Finds a valid program-derived address (PDA) by iterating over possible bump seeds.
- **Inputs**:
    - `program_id`: A pointer to the program ID used in the PDA derivation.
    - `seeds_cnt`: The number of seed elements provided.
    - `seeds`: An array of pointers to seed data used in the PDA derivation.
    - `seed_szs`: An array of sizes corresponding to each seed in the seeds array.
    - `out`: A pointer to store the resulting valid PDA.
    - `out_bump_seed`: A pointer to store the bump seed that results in a valid PDA.
    - `custom_err`: A pointer to store any custom error code encountered during execution.
- **Logic and Control Flow**:
    - Initialize a `bump_seed` array to store the current bump seed value.
    - Iterate over possible bump seed values from 255 to 0.
    - For each bump seed, call [`fd_pubkey_derive_pda`](<#fd_pubkey_derive_pda>) to attempt to derive a PDA.
    - If [`fd_pubkey_derive_pda`](<#fd_pubkey_derive_pda>) returns `FD_PUBKEY_SUCCESS`, copy the derived PDA and bump seed to the output pointers and break the loop.
    - If [`fd_pubkey_derive_pda`](<#fd_pubkey_derive_pda>) returns a custom error that is not `FD_PUBKEY_ERR_INVALID_SEEDS`, return the error code.
    - Set `custom_err` to `UINT_MAX` before returning `FD_PUBKEY_SUCCESS`.
- **Output**: Returns `FD_PUBKEY_SUCCESS` if a valid PDA is found, otherwise returns an error code from [`fd_pubkey_derive_pda`](<#fd_pubkey_derive_pda>).
- **Functions Called**:
    - [`fd_pubkey_derive_pda`](<#fd_pubkey_derive_pda>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)