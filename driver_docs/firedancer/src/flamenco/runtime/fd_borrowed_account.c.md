<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for managing and modifying borrowed account data, ownership, lamports, and executable status.

# Purpose
The code provides a set of functions for managing and manipulating `fd_borrowed_account_t` structures, which represent borrowed accounts in a transaction context. The functions allow for operations such as retrieving and modifying account data, setting account ownership, adjusting the number of lamports (a unit of currency), and changing account properties like executability. Each function includes checks to ensure that operations are valid, such as verifying account ownership, writability, and other constraints before making changes. These checks help maintain the integrity of the account data and ensure compliance with the rules defined in the associated transaction context.

The functions in this code are designed to interact with `fd_txn_account_t` structures, which are part of the transaction system. They provide a controlled interface for modifying account attributes, ensuring that changes are only made under specific conditions. The code references external functions and constants, such as `fd_txn_account_get_data_mut`, `fd_txn_account_set_owner`, and error codes like `FD_EXECUTOR_INSTR_SUCCESS`, indicating that it is part of a larger system. The functions also include references to external documentation or specifications, suggesting that they are implemented to conform to a predefined protocol or standard.
# Imports and Dependencies

---
- `fd_borrowed_account.h`


# Functions

---
### fd\_borrowed\_account\_get\_data\_mut<!-- {{#callable:fd_borrowed_account_get_data_mut}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_borrowed_account.c#L3>)

Retrieves mutable data and its length from a borrowed account if the data can be changed.
- **Inputs**:
    - `borrowed_acct`: A pointer to an `fd_borrowed_account_t` structure representing the borrowed account.
    - `data_out`: A pointer to a pointer to `uchar` where the function will store the address of the mutable data, if not NULL.
    - `dlen_out`: A pointer to `ulong` where the function will store the length of the data, if not NULL.
- **Logic and Control Flow**:
    - Retrieve the `fd_txn_account_t` account from the `borrowed_acct` structure.
    - Call [`fd_borrowed_account_can_data_be_changed`](<fd_borrowed_account.h.md#fd_borrowed_account_can_data_be_changed>) to check if the data can be changed, storing the result in `err`.
    - If `err` indicates an error, return the error code.
    - If `data_out` is not NULL, set `*data_out` to the mutable data of the account using `fd_txn_account_get_data_mut`.
    - If `dlen_out` is not NULL, set `*dlen_out` to the length of the data using `fd_txn_account_get_data_len`.
    - Return `FD_EXECUTOR_INSTR_SUCCESS` to indicate success.
- **Output**: Returns an integer status code, `FD_EXECUTOR_INSTR_SUCCESS` on success or an error code if the data cannot be changed.
- **Functions Called**:
    - [`fd_borrowed_account_can_data_be_changed`](<fd_borrowed_account.h.md#fd_borrowed_account_can_data_be_changed>)


---
### fd\_borrowed\_account\_set\_owner<!-- {{#callable:fd_borrowed_account_set_owner}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_borrowed_account.c#L24>)

Sets a new owner for a borrowed account if specific conditions are met.
- **Inputs**:
    - `borrowed_acct`: A pointer to the `fd_borrowed_account_t` structure representing the borrowed account.
    - `owner`: A constant pointer to the `fd_pubkey_t` structure representing the new owner's public key.
- **Logic and Control Flow**:
    - Retrieve the account from the `borrowed_acct` structure.
    - Check if the current program owns the account; if not, return `FD_EXECUTOR_INSTR_ERR_MODIFIED_PROGRAM_ID`.
    - Check if the account is writable; if not, return `FD_EXECUTOR_INSTR_ERR_MODIFIED_PROGRAM_ID`.
    - Check if the account is executable; if it is, return `FD_EXECUTOR_INSTR_ERR_MODIFIED_PROGRAM_ID`.
    - Check if the account data is zero-initialized or empty; if not, return `FD_EXECUTOR_INSTR_ERR_MODIFIED_PROGRAM_ID`.
    - Compare the current owner with the new owner; if they are the same, return `FD_EXECUTOR_INSTR_SUCCESS`.
    - Set the new owner for the account.
    - Return `FD_EXECUTOR_INSTR_SUCCESS` after successfully setting the new owner.
- **Output**: Returns `FD_EXECUTOR_INSTR_SUCCESS` if the owner is successfully set or unchanged, otherwise returns `FD_EXECUTOR_INSTR_ERR_MODIFIED_PROGRAM_ID` if any condition is not met.
- **Functions Called**:
    - [`fd_borrowed_account_is_owned_by_current_program`](<fd_borrowed_account.h.md#fd_borrowed_account_is_owned_by_current_program>)
    - [`fd_borrowed_account_is_writable`](<fd_borrowed_account.h.md#fd_borrowed_account_is_writable>)
    - [`fd_borrowed_account_is_executable_internal`](<fd_borrowed_account.h.md#fd_borrowed_account_is_executable_internal>)
    - [`fd_borrowed_account_is_zeroed`](<fd_borrowed_account.h.md#fd_borrowed_account_is_zeroed>)


---
### fd\_borrowed\_account\_set\_lamports<!-- {{#callable:fd_borrowed_account_set_lamports}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_borrowed_account.c#L69>)

Sets the number of lamports for a borrowed account, ensuring compliance with ownership, writability, and executability constraints.
- **Inputs**:
    - `borrowed_acct`: A pointer to the `fd_borrowed_account_t` structure representing the borrowed account.
    - `lamports`: The new number of lamports to set for the account.
- **Logic and Control Flow**:
    - Retrieve the `fd_txn_account_t` account from the `borrowed_acct` structure.
    - Check if the account is not owned by the current program and if the new lamports value is less than the current balance; if true, return `FD_EXECUTOR_INSTR_ERR_EXTERNAL_ACCOUNT_LAMPORT_SPEND`.
    - Check if the account is not writable; if true, return `FD_EXECUTOR_INSTR_ERR_READONLY_LAMPORT_CHANGE`.
    - Check if the account is executable; if true, return `FD_EXECUTOR_INSTR_ERR_EXECUTABLE_LAMPORT_CHANGE`.
    - Check if the current lamports value is equal to the new lamports value; if true, return `FD_EXECUTOR_INSTR_SUCCESS`.
    - Set the new lamports value for the account using `fd_txn_account_set_lamports`.
    - Return `FD_EXECUTOR_INSTR_SUCCESS` after setting the lamports.
- **Output**: Returns an integer status code indicating success or a specific error condition.
- **Functions Called**:
    - [`fd_borrowed_account_is_owned_by_current_program`](<fd_borrowed_account.h.md#fd_borrowed_account_is_owned_by_current_program>)
    - [`fd_borrowed_account_is_writable`](<fd_borrowed_account.h.md#fd_borrowed_account_is_writable>)
    - [`fd_borrowed_account_is_executable_internal`](<fd_borrowed_account.h.md#fd_borrowed_account_is_executable_internal>)


---
### fd\_borrowed\_account\_set\_data\_from\_slice<!-- {{#callable:fd_borrowed_account_set_data_from_slice}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_borrowed_account.c#L105>)

Sets the data of a borrowed account from a given data slice after verifying and updating necessary conditions.
- **Inputs**:
    - ``borrowed_acct``: A pointer to the `fd_borrowed_account_t` structure representing the borrowed account.
    - ``data``: A constant pointer to an array of unsigned characters representing the data to set.
    - ``data_sz``: An unsigned long integer representing the size of the data to set.
- **Logic and Control Flow**:
    - Retrieve the `fd_txn_account_t` account from the `borrowed_acct` structure.
    - Check if the data size can be resized using [`fd_borrowed_account_can_data_be_resized`](<fd_borrowed_account.h.md#fd_borrowed_account_can_data_be_resized>); return error if not possible.
    - Check if the data can be changed using [`fd_borrowed_account_can_data_be_changed`](<fd_borrowed_account.h.md#fd_borrowed_account_can_data_be_changed>); return error if not possible.
    - Update the account's resize delta using [`fd_borrowed_account_update_accounts_resize_delta`](<#fd_borrowed_account_update_accounts_resize_delta>); return error if update fails.
    - Set the account's data using `fd_txn_account_set_data`.
- **Output**: Returns an integer status code, `FD_EXECUTOR_INSTR_SUCCESS` on success or an error code if any checks fail.
- **Functions Called**:
    - [`fd_borrowed_account_can_data_be_resized`](<fd_borrowed_account.h.md#fd_borrowed_account_can_data_be_resized>)
    - [`fd_borrowed_account_can_data_be_changed`](<fd_borrowed_account.h.md#fd_borrowed_account_can_data_be_changed>)
    - [`fd_borrowed_account_update_accounts_resize_delta`](<#fd_borrowed_account_update_accounts_resize_delta>)


---
### fd\_borrowed\_account\_set\_data\_length<!-- {{#callable:fd_borrowed_account_set_data_length}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_borrowed_account.c#L135>)

Adjusts the data length of a borrowed account if conditions allow resizing.
- **Inputs**:
    - `borrowed_acct`: A pointer to the `fd_borrowed_account_t` structure representing the borrowed account.
    - `new_len`: The new desired length for the account's data.
- **Logic and Control Flow**:
    - Retrieve the account from the `borrowed_acct` structure.
    - Initialize the error code `err` to `FD_EXECUTOR_INSTR_SUCCESS`.
    - Check if the account's data can be resized to `new_len` using [`fd_borrowed_account_can_data_be_resized`](<fd_borrowed_account.h.md#fd_borrowed_account_can_data_be_resized>). If not, return the error code.
    - Check if the account's data can be changed using [`fd_borrowed_account_can_data_be_changed`](<fd_borrowed_account.h.md#fd_borrowed_account_can_data_be_changed>). If not, return the error code.
    - Get the current data length of the account using `fd_txn_account_get_data_len`.
    - If the current length is equal to `new_len`, return `FD_EXECUTOR_INSTR_SUCCESS` without making changes.
    - Update the account's resize delta using [`fd_borrowed_account_update_accounts_resize_delta`](<#fd_borrowed_account_update_accounts_resize_delta>). If this fails, return the error code.
    - Resize the account's data to `new_len` using `fd_txn_account_resize`.
    - Return `FD_EXECUTOR_INSTR_SUCCESS` to indicate successful completion.
- **Output**: Returns an integer status code, `FD_EXECUTOR_INSTR_SUCCESS` on success or an error code if resizing is not possible.
- **Functions Called**:
    - [`fd_borrowed_account_can_data_be_resized`](<fd_borrowed_account.h.md#fd_borrowed_account_can_data_be_resized>)
    - [`fd_borrowed_account_can_data_be_changed`](<fd_borrowed_account.h.md#fd_borrowed_account_can_data_be_changed>)
    - [`fd_borrowed_account_update_accounts_resize_delta`](<#fd_borrowed_account_update_accounts_resize_delta>)


---
### fd\_borrowed\_account\_set\_executable<!-- {{#callable:fd_borrowed_account_set_executable}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_borrowed_account.c#L172>)

Sets the executable flag of a borrowed account if certain conditions are met.
- **Inputs**:
    - `borrowed_acct`: A pointer to the `fd_borrowed_account_t` structure representing the borrowed account.
    - `is_executable`: An integer indicating whether the account should be set as executable (non-zero) or not (zero).
- **Logic and Control Flow**:
    - Retrieve the account from the `borrowed_acct` structure.
    - Query the rent information from the bank using `fd_bank_rent_query`.
    - Check if the account has enough lamports to be rent exempt using `fd_txn_account_get_lamports` and [`fd_rent_exempt_minimum_balance`](<sysvar/fd_sysvar_rent1.c.md#fd_rent_exempt_minimum_balance>). If not, return `FD_EXECUTOR_INSTR_ERR_EXECUTABLE_ACCOUNT_NOT_RENT_EXEMPT`.
    - Verify if the account is owned by the current program using [`fd_borrowed_account_is_owned_by_current_program`](<fd_borrowed_account.h.md#fd_borrowed_account_is_owned_by_current_program>). If not, return `FD_EXECUTOR_INSTR_ERR_EXECUTABLE_MODIFIED`.
    - Check if the account is writable using [`fd_borrowed_account_is_writable`](<fd_borrowed_account.h.md#fd_borrowed_account_is_writable>). If not, return `FD_EXECUTOR_INSTR_ERR_EXECUTABLE_MODIFIED`.
    - Ensure the executable flag cannot be cleared if it is already set using [`fd_borrowed_account_is_executable_internal`](<fd_borrowed_account.h.md#fd_borrowed_account_is_executable_internal>). If attempted, return `FD_EXECUTOR_INSTR_ERR_EXECUTABLE_MODIFIED`.
    - If the executable flag is already set to the desired state, return `FD_EXECUTOR_INSTR_SUCCESS`.
    - Set the executable flag using `fd_txn_account_set_executable`.
    - Return `FD_EXECUTOR_INSTR_SUCCESS`.
- **Output**: Returns an integer status code indicating success (`FD_EXECUTOR_INSTR_SUCCESS`) or an error code if any condition is not met.
- **Functions Called**:
    - [`fd_rent_exempt_minimum_balance`](<sysvar/fd_sysvar_rent1.c.md#fd_rent_exempt_minimum_balance>)
    - [`fd_borrowed_account_is_owned_by_current_program`](<fd_borrowed_account.h.md#fd_borrowed_account_is_owned_by_current_program>)
    - [`fd_borrowed_account_is_writable`](<fd_borrowed_account.h.md#fd_borrowed_account_is_writable>)
    - [`fd_borrowed_account_is_executable_internal`](<fd_borrowed_account.h.md#fd_borrowed_account_is_executable_internal>)
    - [`fd_borrowed_account_is_executable`](<fd_borrowed_account.h.md#fd_borrowed_account_is_executable>)


---
### fd\_borrowed\_account\_update\_accounts\_resize\_delta<!-- {{#callable:fd_borrowed_account_update_accounts_resize_delta}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_borrowed_account.c#L216>)

Updates the `accounts_resize_delta` field in the transaction context by calculating the size difference between the new and current account data lengths.
- **Inputs**:
    - `borrowed_acct`: A pointer to an `fd_borrowed_account_t` structure representing the borrowed account.
    - `new_len`: An unsigned long integer representing the new length of the account data.
    - `err`: A pointer to an integer where the function will store the success status of the operation.
- **Logic and Control Flow**:
    - Retrieve the instruction context from the `borrowed_acct` structure.
    - Retrieve the account from the `borrowed_acct` structure.
    - Calculate the size difference (`size_delta`) between `new_len` and the current data length of the account using `fd_ulong_sat_sub`.
    - Add `size_delta` to the `accounts_resize_delta` field in the transaction context using `fd_ulong_sat_add`.
    - Set the value pointed to by `err` to `FD_EXECUTOR_INSTR_SUCCESS`.
    - Return 1 to indicate successful execution.
- **Output**: Returns 1 to indicate successful execution and updates the `err` pointer with `FD_EXECUTOR_INSTR_SUCCESS`.



---
Made with ❤️ by [Driver](https://www.driver.ai/)