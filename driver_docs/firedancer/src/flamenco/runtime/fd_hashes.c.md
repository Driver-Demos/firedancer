<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for hashing account data and updating ledger hashes using BLAKE3 and SHA-256 algorithms.

# Purpose
The code provides functionality for hashing and updating account data within a banking context. It includes three main functions: [`fd_hashes_account_lthash`](<#fd_hashes_account_lthash>), [`fd_hashes_hash_bank`](<#fd_hashes_hash_bank>), and [`fd_hashes_update_lthash`](<#fd_hashes_update_lthash>). The [`fd_hashes_account_lthash`](<#fd_hashes_account_lthash>) function calculates a hash for an account using the BLAKE3 hashing algorithm, considering the account's lamports, data, executable status, owner, and public key. The [`fd_hashes_hash_bank`](<#fd_hashes_hash_bank>) function computes a bank hash for a slot using the SHA-256 algorithm, which involves hashing the previous bank hash, signature count, last block hash, and the account's lthash. The [`fd_hashes_update_lthash`](<#fd_hashes_update_lthash>) function updates the bank's lthash by subtracting the previous account hash and adding the new account hash, and it also writes the new account state to a capture file if certain conditions are met.

The code imports several header files, indicating dependencies on other modules for hashing algorithms and account management. It uses BLAKE3 and SHA-256 for cryptographic operations, and it interacts with account metadata and transaction data structures. The code is part of a larger system, likely related to financial transactions or blockchain technology, where maintaining and updating secure hashes of account data is crucial. The functions defined in this code are intended to be used within a broader application, possibly as part of a library for managing account states and ensuring data integrity through cryptographic hashing.
# Imports and Dependencies

---
- `fd_hashes.h`
- `fd_acc_mgr.h`
- `fd_bank.h`
- `context/fd_capture_ctx.h`
- `../capture/fd_solcap_writer.h`
- `../../ballet/blake3/fd_blake3.h`
- `../../ballet/lthash/fd_lthash.h`
- `../../ballet/sha256/fd_sha256.h`
- `fd_txn_account.h`


# Functions

---
### fd\_hashes\_account\_lthash<!-- {{#callable:fd_hashes_account_lthash}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_hashes.c#L11>)

Computes a hash for an account using its metadata and public key, excluding accounts with zero lamports.
- **Inputs**:
    - ``pubkey``: A pointer to the public key of the account.
    - ``account``: A pointer to the account metadata, which includes lamports, executable flag, owner, and data length.
    - ``data``: A pointer to the account data to be included in the hash.
    - ``lthash_out``: A pointer to the output location where the computed hash will be stored.
- **Logic and Control Flow**:
    - Initialize the output hash to zero using `fd_lthash_zero`.
    - Check if the account's lamports are zero; if so, return immediately as such accounts are not included in the hash.
    - Extract the executable flag from the account metadata and mask it with `0x1`.
    - Initialize a Blake3 hash context using `fd_blake3_init`.
    - Append the account's lamports, data, executable flag, owner, and public key to the Blake3 hash context using `fd_blake3_append`.
    - Finalize the Blake3 hash computation and store the result in `lthash_out` using `fd_blake3_fini_2048`.
- **Output**: The function outputs a hash value stored in `lthash_out`, representing the account's state.


---
### fd\_hashes\_hash\_bank<!-- {{#callable:fd_hashes_hash_bank}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_hashes.c#L35>)

Computes a bank hash for a slot using SHA-256 hashing of previous bank hash, signature count, last block hash, and the lthash of modified accounts.
- **Inputs**:
    - `lthash`: Pointer to `fd_lthash_value_t` representing the hash of the accounts modified in the current slot.
    - `prev_bank_hash`: Pointer to `fd_hash_t` representing the hash of the previous bank.
    - `last_blockhash`: Pointer to `fd_hash_t` representing the hash of the last Proof of History (PoH) block.
    - `signature_count`: Unsigned long integer representing the count of signatures.
    - `hash_out`: Pointer to `fd_hash_t` where the resulting bank hash will be stored.
- **Logic and Control Flow**:
    - Initialize a SHA-256 context `sha`.
    - Append `prev_bank_hash`, `signature_count`, and `last_blockhash` to `sha`.
    - Finalize the SHA-256 hash and store the result in `hash_out->hash`.
    - Reinitialize the SHA-256 context `sha`.
    - Append the previously computed hash (`hash_out->hash`) and `lthash->bytes` to `sha`.
    - Finalize the SHA-256 hash and store the result in `hash_out->hash`.
- **Output**: The function outputs the computed bank hash in the `hash_out` parameter.


---
### fd\_hashes\_update\_lthash<!-- {{#callable:fd_hashes_update_lthash}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_hashes.c#L61>)

Updates the bank's lthash by replacing the old account hash with a new one and optionally writes the new account state to a capture file.
- **Inputs**:
    - `account`: A pointer to the `fd_txn_account_t` structure representing the account to update.
    - `prev_account_hash`: A pointer to the `fd_lthash_value_t` structure containing the previous hash of the account.
    - `bank`: A pointer to the `fd_bank_t` structure representing the bank where the account is held.
    - `capture_ctx`: A pointer to the `fd_capture_ctx_t` structure used for capturing the account state, or `NULL` if capturing is not needed.
- **Logic and Control Flow**:
    - Compute the new hash of the account using [`fd_hashes_account_lthash`](<#fd_hashes_account_lthash>) and store it in `new_hash`.
    - Retrieve the bank's lthash for modification using `fd_bank_lthash_locking_modify`.
    - Subtract the previous account hash from the bank's lthash using `fd_lthash_sub`.
    - Add the new account hash to the bank's lthash using `fd_lthash_add`.
    - End the modification of the bank's lthash with `fd_bank_lthash_end_locking_modify`.
    - If `capture_ctx` is not `NULL`, the bank slot is greater than or equal to `capture_ctx->solcap_start_slot`, and the new hash differs from the previous hash, write the new account state to the capture file using `fd_solcap_write_account`.
    - Log an error if writing to the capture file fails.
- **Output**: No return value; the function operates by modifying the bank's lthash and potentially writing to a capture file.
- **Functions Called**:
    - [`fd_txn_account_get_meta`](<fd_txn_account.c.md#fd_txn_account_get_meta>)
    - [`fd_hashes_account_lthash`](<#fd_hashes_account_lthash>)
    - [`fd_txn_account_get_data`](<fd_txn_account.c.md#fd_txn_account_get_data>)
    - [`fd_txn_account_get_solana_meta`](<fd_txn_account.c.md#fd_txn_account_get_solana_meta>)
    - [`fd_txn_account_get_data_len`](<fd_txn_account.c.md#fd_txn_account_get_data_len>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)