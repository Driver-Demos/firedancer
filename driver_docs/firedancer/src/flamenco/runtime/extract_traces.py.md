<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Processes and compares trace logs from Firedancer and Solana to find matching traces.

# Purpose
The code is a script designed to compare and analyze trace logs from two different sources, specifically Firedancer and Solana. It reads trace data from log files, processes the traces, and attempts to find matching traces between the two sources. The script uses regular expressions to parse trace lines and extract relevant information such as instruction counts and register values. It then compares these traces to identify the best matches based on specific criteria, such as matching program counters and register values.

The script defines a command-line interface using the `argparse` module, allowing users to specify the paths to the Firedancer and Solana log files, the maximum number of traces to process, and the number of traces to skip. The main functions include [`read_traces_from_file`](<#read_traces_from_file>) for reading and parsing trace logs, [`check_strict_match`](<#check_strict_match>) for verifying strict matches between trace lines, and [`traces_diff`](<#traces_diff>) for comparing traces and identifying matches. The script outputs the results of the comparison, including the number of good matches found, and writes the matched traces to separate log files for further analysis.
# Imports and Dependencies

---
- `argparse`
- `collections.Counter`
- `re`
- `typing.Callable`
- `typing.List`
- `typing.Tuple`
- `difflib`
- `sys`
- `time`
- `multiprocessing`
- `os`
- `string`


# Global Variables

---
### reg\_val\_pattern
- **Type**: ``Callable[[int], str]``
- **Description**: Defines a lambda function that takes an integer `x` and returns a formatted string. The string is a regular expression pattern with a named group `r{x}` that matches a 16-character hexadecimal number.
- **Use**: Used to generate parts of a regular expression pattern for parsing trace lines.


---
### trace\_line\_pattern
- **Type**: ``str``
- **Description**: A regular expression pattern string that matches a specific format of trace lines. The pattern includes placeholders for instruction count (`ic`), program counter (`pc`), and instruction details (`instr`), as well as register values (`r0` to `r10`) formatted using the `reg_val_pattern` function.
- **Use**: Used to match and extract information from trace lines in log files.


---
### fast\_trace\_line\_pattern
- **Type**: ``str``
- **Description**: A regular expression pattern that matches lines in a trace log file. It captures two named groups: `ic` for instruction count and `pc` for program counter.
- **Use**: Used to match and extract specific information from lines in trace log files.


---
### trace\_start\_line\_pattern
- **Type**: ``str``
- **Description**: A regular expression pattern that matches lines starting with zero, possibly preceded by spaces. It is used to identify the start of a trace in a log file.
- **Use**: Used to match and identify the beginning of a trace in log files by checking if a line starts with zero.


---
### trace\_line\_regex
- **Type**: ``re.Pattern``
- **Description**: Compiles a regular expression pattern defined by `trace_line_pattern` into a regex object. This regex object can be used to match strings against the pattern, which is designed to parse trace lines with specific format requirements.
- **Use**: Used to match and extract data from trace lines in the `check_strict_match` function.


# Functions

---
### read\_traces\_from\_file<!-- {{#callable:firedancer/src/flamenco/runtime/extract_traces.read_traces_from_file}} -->
[View Source →](<../../../../../src/flamenco/runtime/extract_traces.py#L34>)

Reads and processes trace data from a log file, storing it in a structured format.
- **Inputs**:
    - `log_path`: The file path to the log file from which to read trace data.
    - `max_traces`: The maximum number of traces to read and process from the log file.
- **Logic and Control Flow**:
    - Initialize empty lists `traces` and `trace` to store processed trace data.
    - Record the start time in `dt` and `dt2` for performance measurement.
    - Open the log file specified by `log_path` for reading.
    - Iterate over each line in the log file.
    - Use a regular expression to match each line against `fast_trace_line_pattern`.
    - If the number of traces equals `max_traces`, stop processing further lines.
    - If a line does not match the pattern, skip to the next line.
    - Extract matched groups from the line using `groupdict()`.
    - If the instruction count (`ic`) is '0' and `trace` is not empty, append `trace` to `traces`, reset `trace`, and print progress to `stderr`.
    - Append the current line and its matched groups to `trace`.
    - After processing all lines, if `trace` is not empty, append it to `traces`.
    - Calculate the total processing time and print it to `stderr`.
- **Output**: A list of traces, where each trace is a list of tuples containing the line and its matched groups.


---
### check\_strict\_match<!-- {{#callable:firedancer/src/flamenco/runtime/extract_traces.check_strict_match}} -->
[View Source →](<../../../../../src/flamenco/runtime/extract_traces.py#L62>)

Compares two trace lines for strict equality based on specific keys.
- **Inputs**:
    - `fd_line`: A string representing a trace line from the Firedancer log.
    - `sl_line`: A string representing a trace line from the Solana log.
- **Logic and Control Flow**:
    - Use the `re.match` function to match `fd_line` and `sl_line` against the `trace_line_pattern` regular expression.
    - Store the match objects for `fd_line` and `sl_line` in `fd_strict_match` and `sl_strict_match`, respectively.
    - Define a list `checked_keys` containing the keys 'r0' to 'r10' and 'ic'.
    - Iterate over each key in `checked_keys`.
    - For each key, compare the corresponding values in `fd_strict_match` and `sl_strict_match`.
    - If any value does not match, return `False`.
    - If all values match, return `True`.
- **Output**: Returns `True` if all specified keys in the matched trace lines are equal; otherwise, returns `False`.


---
### traces\_diff<!-- {{#callable:firedancer/src/flamenco/runtime/extract_traces.traces_diff}} -->
[View Source →](<../../../../../src/flamenco/runtime/extract_traces.py#L72>)

Compares traces from two sources and identifies the best matching trace pairs.
- **Inputs**:
    - `fd_traces`: A list of traces from the Firedancer log file, where each trace is a list of tuples containing a line and its match data.
    - `sl_traces`: A list of traces from the Solana log file, where each trace is a list of tuples containing a line and its match data.
    - `skip_traces`: An integer indicating the number of initial traces in the Solana log to skip during comparison.
- **Logic and Control Flow**:
    - Initialize a set `used_sl_idxs` to track used Solana trace indices and a counter `n_good_matches` for good matches.
    - Iterate over each trace in `fd_traces` using its index `fd_idx`.
    - For each `fd_trace`, initialize `best_n_matches` to zero and `best_sl_idx` to -1 to track the best match found.
    - Iterate over each trace in `sl_traces` using its index `sl_idx`, skipping indices less than `skip_traces` and those already in `used_sl_idxs`.
    - For each pair of `fd_trace` and `sl_trace`, compare corresponding lines and matches; increment `n_matches` if they match strictly using [`check_strict_match`](<#check_strict_match>).
    - Update `best_n_matches` and `best_sl_idx` if a better match is found, and break if a perfect match is achieved.
    - If no match is found for `fd_trace`, print 'NO MATCH' with the index and continue to the next trace.
    - If a match is found, extract lines from both traces, check if it is a good match, and update `used_sl_idxs` and `n_good_matches` accordingly.
    - Print details of the best match found, including indices, number of matches, and percentage match.
    - Write the lines of the matched traces to separate log files for Firedancer and Solana.
    - After processing all traces, print the total number of traces and good matches.
- **Output**: None, but prints match results and writes matched trace lines to log files.
- **Functions Called**:
    - [`firedancer/src/flamenco/runtime/extract_traces.check_strict_match`](<#check_strict_match>)


---
### cache\_sl<!-- {{#callable:firedancer/src/flamenco/runtime/extract_traces.cache_sl}} -->
[View Source →](<../../../../../src/flamenco/runtime/extract_traces.py#L128>)

Writes each trace from the Solana traces list to a separate log file.
- **Inputs**:
    - `sl_traces`: A list of traces, where each trace is a list of tuples containing trace data.
- **Logic and Control Flow**:
    - Iterates over each trace in the `sl_traces` list with its index.
    - Opens a new log file named `traces/sl_trace_{i}.log` for each trace, where `i` is the index of the trace.
    - Writes the first element of each tuple in the trace to the log file as a single concatenated string.
- **Output**: No return value; writes data to log files.


---
### main<!-- {{#callable:firedancer/src/flamenco/runtime/extract_traces.main}} -->
[View Source →](<../../../../../src/flamenco/runtime/extract_traces.py#L133>)

Parses command-line arguments, reads trace data from specified log files, and compares the traces.
- **Inputs**: None
- **Logic and Control Flow**:
    - Creates an argument parser using `argparse.ArgumentParser()` and adds four arguments: `-f`/`--fd-log-path`, `-s`/`--sl-log-path`, `-n`/`--max-traces`, and `-m`/`--skip-traces`.
    - Parses the command-line arguments using `arg_parser.parse_args()`.
    - Calls `read_traces_from_file()` with `args.fd_log_path` and `args.max_traces` to read Firedancer traces and stores the result in `fd_traces`.
    - Prints the number of Firedancer traces read.
    - Calls `read_traces_from_file()` with `args.sl_log_path` and `args.max_traces` to read Solana traces and stores the result in `sl_traces`.
    - Calls `cache_sl()` with `sl_traces` to cache the Solana traces.
    - Prints the number of Solana traces read.
    - Calls `traces_diff()` with `fd_traces`, `sl_traces`, and `args.skip_traces` to compare the traces.
- **Output**: No return value; outputs are printed to the console.
- **Functions Called**:
    - [`firedancer/src/flamenco/runtime/extract_traces.read_traces_from_file`](<#read_traces_from_file>)
    - [`firedancer/src/flamenco/runtime/extract_traces.cache_sl`](<#cache_sl>)
    - [`firedancer/src/flamenco/runtime/extract_traces.traces_diff`](<#traces_diff>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)