<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Manages blockhashes with functions to initialize, push, pop, and check their age in a deque structure.

# Purpose
The code provides functionality for managing a collection of block hashes using a deque and a map. It is part of a C library that handles block hash operations, likely for a blockchain or similar system. The primary data structure is `fd_blockhashes_t`, which contains a deque and a map to store and manage block hashes. The code includes functions to initialize the block hash structure, add new or old block hashes, and remove the oldest or newest block hashes from the collection. It also includes a function to check the age of a block hash against a specified maximum age.

The [`fd_blockhashes_init`](<#fd_blockhashes_init>) function initializes the block hash structure with a given memory location and seed. The [`fd_blockhashes_push_new`](<#fd_blockhashes_push_new>) and [`fd_blockhashes_push_old`](<#fd_blockhashes_push_old>) functions add new or old block hashes to the deque, ensuring no duplicates are registered. The [`fd_blockhashes_pop_old`](<#fd_blockhashes_pop_old>) and [`fd_blockhashes_pop_new`](<#fd_blockhashes_pop_new>) functions remove the oldest or newest block hashes, respectively. The [`fd_blockhashes_check_age`](<#fd_blockhashes_check_age>) function checks if a block hash is within a specified age limit. The code uses macros like `FD_UNLIKELY` and `FD_LOG_CRIT` for error handling and logging, and it ensures data integrity by checking for conditions like full deques or duplicate hashes.
# Imports and Dependencies

---
- `fd_blockhashes.h`


# Functions

---
### fd\_blockhashes\_init<!-- {{#callable:fd_blockhashes_init}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_blockhashes.c#L3>)

Initializes a `fd_blockhashes_t` structure with a deque and map, using a given seed.
- **Inputs**:
    - `mem`: A pointer to a `fd_blockhashes_t` structure to initialize.
    - `seed`: An unsigned long integer used to seed the blockhash map.
- **Logic and Control Flow**:
    - Check if `mem` is NULL; if so, log a warning and return NULL.
    - Initialize the deque within `mem` by calling `fd_blockhash_deq_new` and `fd_blockhash_deq_join`.
    - Set all elements in the deque to the value `0x5a`.
    - Initialize the blockhash map within `mem` by calling `fd_blockhash_map_new` and `fd_blockhash_map_join`.
    - Return the initialized `mem` pointer.
- **Output**: Returns a pointer to the initialized `fd_blockhashes_t` structure, or NULL if `mem` is NULL.


---
### fd\_blockhashes\_pop\_old<!-- {{#callable:fd_blockhashes_pop_old}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_blockhashes.c#L16>)

Removes the oldest blockhash from the deque and updates the map accordingly.
- **Inputs**:
    - `blockhashes`: A pointer to an `fd_blockhashes_t` structure, which contains the deque and map of blockhashes.
- **Logic and Control Flow**:
    - Checks if the deque in `blockhashes` is empty using `fd_blockhash_deq_empty`; if it is empty, the function returns immediately.
    - Calls `fd_blockhash_deq_pop_head_nocopy` to remove the oldest blockhash from the head of the deque without copying it.
    - Sets the `exists` field of the removed blockhash info to 0, indicating it no longer exists.
    - Calls `fd_blockhash_map_ele_remove` to remove the blockhash from the map, using the hash from the removed blockhash info.
- **Output**: No output is returned as the function is of type `void`.


---
### fd\_blockhashes\_pop\_new<!-- {{#callable:fd_blockhashes_pop_new}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_blockhashes.c#L24>)

Removes the newest blockhash from the deque and updates the map to reflect its removal.
- **Inputs**:
    - `blockhashes`: A pointer to an `fd_blockhashes_t` structure that contains the deque and map of blockhashes.
- **Logic and Control Flow**:
    - Checks if the deque in `blockhashes` is empty using `fd_blockhash_deq_empty`; if it is empty, the function returns immediately.
    - Calls `fd_blockhash_deq_pop_tail_nocopy` to remove the newest blockhash from the tail of the deque without copying it.
    - Sets the `exists` field of the removed blockhash info to 0, indicating it no longer exists.
    - Calls `fd_blockhash_map_ele_remove` to remove the blockhash from the map, using the hash from the removed blockhash info.
- **Output**: No output is returned as the function has a `void` return type.


---
### fd\_blockhashes\_push\_new<!-- {{#callable:fd_blockhashes_push_new}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_blockhashes.c#L32>)

Adds a new blockhash to the deque and map, ensuring no duplicates and removing the oldest if the deque is full.
- **Inputs**:
    - `blockhashes`: A pointer to `fd_blockhashes_t`, which contains the deque and map for blockhash management.
    - `hash`: A constant pointer to `fd_hash_t`, representing the blockhash to be added.
- **Logic and Control Flow**:
    - Check if the deque in `blockhashes` is full using `fd_blockhash_deq_full`; if true, call [`fd_blockhashes_pop_old`](<#fd_blockhashes_pop_old>) to remove the oldest blockhash.
    - Query the map in `blockhashes` with `fd_blockhash_map_idx_query` to check if `hash` already exists; if it does, log a critical error and do not proceed.
    - Push a new blockhash info structure to the tail of the deque using `fd_blockhash_deq_push_tail_nocopy`.
    - Initialize the new blockhash info with the given `hash` and set `exists` to 1.
    - Insert the new blockhash info into the map using `fd_blockhash_map_ele_insert`.
- **Output**: Returns a pointer to the newly added `fd_blockhash_info_t` structure.
- **Functions Called**:
    - [`fd_blockhashes_pop_old`](<#fd_blockhashes_pop_old>)


---
### fd\_blockhashes\_push\_old<!-- {{#callable:fd_blockhashes_push_old}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_blockhashes.c#L51>)

Adds a new blockhash to the head of the deque if it is not full and the blockhash is not a duplicate.
- **Inputs**:
    - `blockhashes`: A pointer to the `fd_blockhashes_t` structure that contains the deque and map for blockhash management.
    - `hash`: A constant pointer to the `fd_hash_t` structure representing the blockhash to be added.
- **Logic and Control Flow**:
    - Check if the deque in `blockhashes` is full using `fd_blockhash_deq_full`; if full, return `NULL`.
    - Check if the `hash` already exists in the map using `fd_blockhash_map_idx_query`; if it exists, log a critical error and do not proceed.
    - Push the `hash` to the head of the deque using `fd_blockhash_deq_push_head_nocopy`.
    - Initialize the deque element with the `hash` and set `exists` to 1.
    - Insert the new element into the map using `fd_blockhash_map_ele_insert`.
- **Output**: Returns a pointer to the `fd_blockhash_info_t` structure containing the added blockhash, or `NULL` if the deque is full.


---
### fd\_blockhashes\_check\_age<!-- {{#callable:fd_blockhashes_check_age}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_blockhashes.c#L71>)

Checks if a given blockhash is within a specified maximum age in the blockhashes deque.
- **Inputs**:
    - `blockhashes`: A pointer to a constant `fd_blockhashes_t` structure that contains the blockhashes and their associated data.
    - `blockhash`: A pointer to a constant `fd_hash_t` structure representing the blockhash to check.
    - `max_age`: An unsigned long integer representing the maximum allowable age for the blockhash.
- **Logic and Control Flow**:
    - Query the index of the `blockhash` in the `blockhashes` map using `fd_blockhash_map_idx_query_const`.
    - If the index is `ULONG_MAX`, return 0 indicating the blockhash is not found or too old.
    - Calculate the maximum index of the deque using `fd_blockhash_deq_max`.
    - Determine the end index of the deque using bitwise operations.
    - Calculate the age of the blockhash by considering its position relative to the end of the deque.
    - Return 1 if the calculated age is less than or equal to `max_age`, otherwise return 0.
- **Output**: Returns 1 if the blockhash is within the specified maximum age, otherwise returns 0.



---
Made with ❤️ by [Driver](https://www.driver.ai/)