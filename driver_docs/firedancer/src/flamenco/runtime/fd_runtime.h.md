<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Header file for the Firedancer runtime, defining constants, data structures, and functions for transaction execution and block management.

# Purpose
The `fd_runtime.h` file is a C header file that defines constants, data structures, and function prototypes for a runtime system. This system appears to be part of a larger software architecture, possibly related to blockchain or distributed ledger technology, given the terminology used such as "transaction", "block", "epoch", and "account". The file includes several other headers, indicating dependencies on various components like error handling, initialization, database management, and context management.

The file defines a series of constants that are used throughout the runtime, such as `MICRO_LAMPORTS_PER_LAMPORT` and `FD_RUNTIME_TRACE_NONE`, which are likely used for configuration and control of the runtime's behavior. It also defines data structures like `fd_block_entry_batch_t` and `fd_account_rec_t`, which are used to manage block entries and account records, respectively. The file provides function prototypes for managing transactions, preparing and finalizing block execution, and handling epoch boundaries. These functions are essential for the execution and management of transactions within the runtime, ensuring that the system operates correctly and efficiently. The file also includes macros to calculate memory footprints for various operations, which are crucial for resource management in the runtime environment.
# Imports and Dependencies

---
- `stdarg.h`
- `fd_runtime_err.h`
- `fd_runtime_init.h`
- `fd_rocksdb.h`
- `fd_acc_mgr.h`
- `fd_hashes.h`
- `../features/fd_features.h`
- `context/fd_capture_ctx.h`
- `context/fd_exec_txn_ctx.h`
- `info/fd_instr_info.h`
- `../../disco/pack/fd_microblock.h`
- `../../ballet/sbpf/fd_sbpf_loader.h`
- `../vm/fd_vm_base.h`


# Data Structures

---
### fd\_block\_entry\_batch
- **Type**: ``struct``
- **Members**:
    - ``end_off``: Stores the exclusive end offset of the batch.
- **Description**: Represents a microblock or entry batch within a block, where `end_off` indicates the exclusive end offset of the batch relative to the start of the block's data region. The end offset of one batch is the start offset of the next batch, with the first batch starting at offset 0. This structure is used to align batch ends with shred ends and batch starts with shred starts, facilitating bincode deserialization on a per-batch basis.


---
### fd\_block\_entry\_batch\_t
- **Type**: ``struct``
- **Members**:
    - ``end_off``: The exclusive end offset of the batch within the block's data region.
- **Description**: Represents a microblock or entry batch within a block, where the `end_off` indicates the exclusive end offset of the batch relative to the start of the block's data region. The structure aligns batch ends with shred ends and batch starts with shred starts, facilitating bincode deserialization on a per-batch basis. Each batch typically contains multiple shreds, and a block contains multiple batches, with trailing bytes in each batch ignored by default.


---
### fd\_account\_rec
- **Type**: ``struct``
- **Members**:
    - ``meta``: Contains metadata of type `fd_account_meta_t`.
    - ``data``: An array of unsigned characters aligned to 8 bytes.
- **Description**: Encodes the layout of an account record with metadata followed by account data, ensuring alignment requirements are met.


---
### fd\_account\_rec\_t
- **Type**: ``struct``
- **Members**:
    - ``meta``: Contains metadata for the account.
    - ``data``: Holds the account's data with an alignment of 8 bytes.
- **Description**: Encodes the layout of an account record with metadata followed by account data, ensuring alignment requirements are met.


# Function Declarations (Public API)

---
### fd\_runtime\_compute\_max\_tick\_height<!-- {{#callable_declaration:fd_runtime_compute_max_tick_height}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.h#L199>)

Calculates the maximum tick height for a given slot.
- **Description**: Use this function to calculate the maximum tick height for a specified slot based on the number of ticks per slot. It is important to ensure that `ticks_per_slot` is greater than zero to avoid undefined behavior. The function will not modify the output parameter if an error occurs, such as an overflow during calculations. This function returns zero on success and a non-zero value if an error occurs, indicating that the output parameter remains unchanged.
- **Inputs**:
    - `ticks_per_slot`: The number of ticks in each slot. Must be greater than zero. If zero, the function will not perform calculations and will return an error.
    - `slot`: The current slot number for which the maximum tick height is calculated. Must be a valid unsigned long value.
    - `out_max_tick_height`: A pointer to an unsigned long where the function will store the calculated maximum tick height. Must not be null. The function does not modify this value if an error occurs.
- **Output**: Returns 0 on success, indicating that `out_max_tick_height` contains the calculated value. Returns a non-zero value on error, indicating that `out_max_tick_height` is not modified.
- **See Also**: [`fd_runtime_compute_max_tick_height`](<fd_runtime.c.md#fd_runtime_compute_max_tick_height>)  (Implementation)


---
### fd\_runtime\_update\_leaders<!-- {{#callable_declaration:fd_runtime_update_leaders}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.h#L212>)

Updates the leader schedule for the current epoch.
- **Description**: Use this function to update the leader schedule for the current epoch based on the bank's state and the runtime stack. It must be called with a valid bank and runtime stack. The function calculates the leader schedule using the epoch's slot information and the previous vote states. It handles cases where the stake weight count or slot count exceeds predefined maximums by logging errors. Ensure that the bank and runtime stack are properly initialized before calling this function.
- **Inputs**:
    - `bank`: A pointer to an `fd_bank_t` structure representing the bank. Must not be null. The function queries and modifies the bank's state.
    - `runtime_stack`: A pointer to an `fd_runtime_stack_t` structure representing the runtime stack. Must not be null. The function uses this to access stake weights.
- **Output**: None
- **See Also**: [`fd_runtime_update_leaders`](<fd_runtime.c.md#fd_runtime_update_leaders>)  (Implementation)


---
### fd\_runtime\_load\_txn\_address\_lookup\_tables<!-- {{#callable_declaration:fd_runtime_load_txn_address_lookup_tables}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.h#L229>)

Load accounts from transaction address lookup tables into an output array.
- **Description**: Use this function to load accounts from the address lookup tables of a transaction into a specified output array. This function is useful when you need to access or manipulate account data based on transaction address lookup tables. It must be called with a valid transaction object and other required parameters. The function returns immediately with success if the transaction version is not `FD_TXN_V0`. Ensure that the output array is properly allocated to hold the account addresses. Handle any errors returned by the function, which indicate issues such as missing address lookup tables.
- **Inputs**:
    - `txn`: A pointer to a constant `fd_txn_t` structure representing the transaction. Must not be null.
    - `payload`: A pointer to a constant unsigned character array containing the transaction payload. Must not be null.
    - `funk`: A pointer to an `fd_funk_t` structure used for account initialization. Must not be null.
    - `xid`: A pointer to a constant `fd_funk_txn_xid_t` structure representing the transaction ID. Must not be null.
    - `slot`: An unsigned long integer representing the slot number. Must be a valid slot number.
    - `hashes`: A pointer to a constant `fd_slot_hash_t` structure representing the slot hashes. Must not be null.
    - `out_accts_alt`: A pointer to an `fd_acct_addr_t` array where the function will store the loaded account addresses. Must be allocated by the caller and large enough to hold the account addresses.
- **Output**: Returns 0 on success, or a non-zero error code if an error occurs, such as when address lookup tables are not found.
- **See Also**: [`fd_runtime_load_txn_address_lookup_tables`](<fd_runtime.c.md#fd_runtime_load_txn_address_lookup_tables>)  (Implementation)


---
### fd\_runtime\_block\_execute\_prepare<!-- {{#callable_declaration:fd_runtime_block_execute_prepare}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.h#L240>)

Prepares a bank for block execution.
- **Description**: Use this function to prepare a bank for block execution by resetting execution fees, priority fees, signature counts, and compute units. It must be called before executing a block to ensure the bank is in a consistent state. The function updates system variables and restores the system variable cache. It returns a success code or an error code if the preparation fails.
- **Inputs**:
    - `bank`: A pointer to an `fd_bank_t` structure representing the bank to prepare. Must not be null.
    - `accdb`: A pointer to an `fd_accdb_user_t` structure representing the account database user. Must not be null.
    - `xid`: A pointer to a constant `fd_funk_txn_xid_t` structure representing the transaction ID. Must not be null.
    - `runtime_stack`: A pointer to an `fd_runtime_stack_t` structure representing the runtime stack. Must not be null.
    - `capture_ctx`: A pointer to an `fd_capture_ctx_t` structure representing the capture context. Must not be null.
- **Output**: Returns 0 on success, or a non-zero error code if preparation fails.
- **See Also**: [`fd_runtime_block_execute_prepare`](<fd_runtime.c.md#fd_runtime_block_execute_prepare>)  (Implementation)


---
### fd\_runtime\_block\_execute\_finalize<!-- {{#callable_declaration:fd_runtime_block_execute_finalize}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.h#L247>)

Finalize the execution of a block in the runtime environment.
- **Description**: Use this function to finalize the execution of a block after all transactions have been processed. It freezes the current state of the block, preventing further modifications, and updates the bank's hash to reflect the final state. This function should be called after all necessary transactions have been executed and before the block is considered complete. It is important to ensure that the `bank`, `accdb`, `xid`, and `capture_ctx` parameters are valid and properly initialized before calling this function.
- **Inputs**:
    - `bank`: A pointer to an `fd_bank_t` structure representing the bank where the block execution is finalized. Must not be null.
    - `accdb`: A pointer to an `fd_accdb_user_t` structure representing the account database user context. Must not be null.
    - `xid`: A pointer to a constant `fd_funk_txn_xid_t` structure representing the transaction ID. Must not be null.
    - `capture_ctx`: A pointer to an `fd_capture_ctx_t` structure used for capturing execution context. Must not be null.
    - `silent`: An integer flag indicating whether to suppress output during the update of the bank's hash. Non-zero values suppress output.
- **Output**: None
- **See Also**: [`fd_runtime_block_execute_finalize`](<fd_runtime.c.md#fd_runtime_block_execute_finalize>)  (Implementation)


---
### fd\_runtime\_pre\_execute\_check<!-- {{#callable_declaration:fd_runtime_pre_execute_check}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.h#L256>)

Performs pre-execution checks on a transaction context.
- **Description**: Use this function to perform necessary checks and preparations on a transaction context before execution. It verifies the transaction, resolves account keys, sets up transaction accounts, and validates account locks. It also checks transactions and validates the transaction fee payer. If any step fails, it returns a non-zero error code and resets the transaction context flags. This function must be called before executing a transaction to ensure all preconditions are met.
- **Inputs**:
    - `txn_ctx`: A pointer to a `fd_exec_txn_ctx_t` structure representing the transaction context. Must not be null. The function modifies this context during the checks and setup process.
- **Output**: Returns 0 on success, indicating all checks passed. Returns a non-zero error code if any check fails, and the transaction context flags are reset.
- **See Also**: [`fd_runtime_pre_execute_check`](<fd_runtime.c.md#fd_runtime_pre_execute_check>)  (Implementation)


---
### fd\_runtime\_prepare\_and\_execute\_txn<!-- {{#callable_declaration:fd_runtime_prepare_and_execute_txn}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.h#L263>)

Prepares and executes a transaction on a specified bank.
- **Description**: Use this function to prepare and execute a transaction within a specified bank context. It requires a valid bank index and transaction context, and it modifies the transaction context with execution details. Ensure that the bank index is valid and that the transaction context is properly initialized before calling this function. The function returns an integer indicating the success or failure of the transaction execution.
- **Inputs**:
    - `banks`: A pointer to `fd_banks_t`, representing the collection of banks. Must not be null.
    - `bank_idx`: An unsigned long representing the index of the bank within `banks`. Must be a valid index.
    - `txn_ctx`: A pointer to `fd_exec_txn_ctx_t`, representing the transaction context. Must not be null and should be initialized before use.
    - `txn`: A pointer to `fd_txn_p_t`, representing the transaction to execute. Must not be null.
    - `capture_ctx`: A pointer to `fd_capture_ctx_t`, representing the capture context. Must not be null.
- **Output**: Returns an integer indicating the result of the transaction execution: 0 on success, non-zero on failure.
- **See Also**: [`fd_runtime_prepare_and_execute_txn`](<fd_runtime.c.md#fd_runtime_prepare_and_execute_txn>)  (Implementation)


---
### fd\_runtime\_finalize\_txn<!-- {{#callable_declaration:fd_runtime_finalize_txn}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.h#L270>)

Finalizes a transaction by updating bank and cache states.
- **Description**: Use this function to complete the processing of a transaction by updating the bank's state, handling fees, and managing account rollbacks or updates based on transaction success or failure. It must be called after a transaction has been executed to ensure all related states are correctly finalized. This function also manages program cache invalidation and transaction cache updates, ensuring that all necessary data is consistent and up-to-date.
- **Inputs**:
    - `funk`: A pointer to an `fd_funk_t` structure. The caller retains ownership and it must not be null.
    - `progcache`: A pointer to an `fd_progcache_t` structure. The caller retains ownership and it must not be null.
    - `txncache`: A pointer to an `fd_txncache_t` structure. The caller retains ownership and it must not be null.
    - `xid`: A pointer to a constant `fd_funk_txn_xid_t` structure representing the transaction ID. The caller retains ownership and it must not be null.
    - `txn_ctx`: A pointer to an `fd_exec_txn_ctx_t` structure containing the transaction context. The caller retains ownership and it must not be null.
    - `bank`: A pointer to an `fd_bank_t` structure representing the bank state. The caller retains ownership and it must not be null.
    - `capture_ctx`: A pointer to an `fd_capture_ctx_t` structure used for capturing context. The caller retains ownership and it must not be null.
- **Output**: None
- **See Also**: [`fd_runtime_finalize_txn`](<fd_runtime.c.md#fd_runtime_finalize_txn>)  (Implementation)


---
### fd\_runtime\_block\_pre\_execute\_process\_new\_epoch<!-- {{#callable_declaration:fd_runtime_block_pre_execute_process_new_epoch}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.h#L286>)

Processes a new epoch boundary for a block.
- **Description**: Use this function to handle the transition to a new epoch when processing a block in the runtime. It checks if the current block marks the start of a new epoch and processes it accordingly. This function must be called with valid bank and account database contexts. It sets the epoch boundary flag to indicate whether a new epoch has started. Ensure that the bank slot is non-zero before calling this function to avoid unnecessary processing.
- **Inputs**:
    - `banks`: A pointer to `fd_banks_t`, representing the collection of banks. The caller retains ownership and must ensure it is valid.
    - `bank`: A pointer to `fd_bank_t`, representing the current bank being processed. Must not be null and must be valid.
    - `accdb`: A pointer to `fd_accdb_user_t`, representing the account database. Must be valid and not null.
    - `xid`: A pointer to `fd_funk_txn_xid_t`, representing the transaction ID. Must be valid and not null.
    - `capture_ctx`: A pointer to `fd_capture_ctx_t`, representing the capture context. Must be valid and not null.
    - `runtime_stack`: A pointer to `fd_runtime_stack_t`, representing the runtime stack. Must be valid and not null.
    - `is_epoch_boundary`: A pointer to an integer where the function will store 1 if a new epoch boundary is detected, or 0 otherwise. Must not be null.
- **Output**: None
- **See Also**: [`fd_runtime_block_pre_execute_process_new_epoch`](<fd_runtime.c.md#fd_runtime_block_pre_execute_process_new_epoch>)  (Implementation)


---
### fd\_runtime\_read\_genesis<!-- {{#callable_declaration:fd_runtime_read_genesis}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.h#L297>)

Initializes the bank and account database from a genesis block.
- **Description**: Use this function to initialize the bank and account database with data from a genesis block. This function sets up the bank state, including vote and stake caches, and writes native programs to the account database. It must be called with valid pointers to the bank, account database, and other required structures. Ensure that the genesis block and related data are correctly populated before calling this function. The function does not return a value, but it logs a critical error if the genesis block execution fails.
- **Inputs**:
    - `banks`: Pointer to `fd_banks_t` structure representing the banks. Must not be null.
    - `bank`: Pointer to `fd_bank_t` structure representing the bank to initialize. Must not be null.
    - `accdb`: Pointer to `fd_accdb_user_t` structure representing the account database. Must not be null.
    - `xid`: Pointer to `fd_funk_txn_xid_t` representing the transaction ID. Must not be null.
    - `capture_ctx`: Pointer to `fd_capture_ctx_t` structure for capturing context. Must not be null.
    - `genesis_hash`: Pointer to `fd_hash_t` representing the genesis hash. Must not be null.
    - `genesis_lthash`: Pointer to `fd_lthash_value_t` representing the genesis ledger hash. Must not be null.
    - `genesis_block`: Pointer to `fd_genesis_solana_global_t` structure representing the genesis block. Must not be null.
    - `runtime_stack`: Pointer to `fd_runtime_stack_t` structure for runtime stack management. Must not be null.
- **Output**: None
- **See Also**: [`fd_runtime_read_genesis`](<fd_runtime.c.md#fd_runtime_read_genesis>)  (Implementation)


---
### fd\_runtime\_should\_use\_vote\_keyed\_leader\_schedule<!-- {{#callable_declaration:fd_runtime_should_use_vote_keyed_leader_schedule}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.h#L314>)

Determines if the vote account keyed leader schedule should be used.
- **Description**: Use this function to check if the current epoch should use the vote account keyed leader schedule instead of the validator identity keyed leader schedule. This decision is based on the activation status of the `enable_vote_address_leader_schedule` feature in the given bank. The function must be called with a valid bank object, and it returns an integer indicating the schedule type to use.
- **Inputs**:
    - `bank`: A pointer to an `fd_bank_t` structure representing the bank to query. Must not be null. The function checks the activation status of a specific feature within this bank.
- **Output**: Returns 1 if the vote account keyed leader schedule should be used, or 0 if the validator identity keyed leader schedule should be used.
- **See Also**: [`fd_runtime_should_use_vote_keyed_leader_schedule`](<fd_runtime.c.md#fd_runtime_should_use_vote_keyed_leader_schedule>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)