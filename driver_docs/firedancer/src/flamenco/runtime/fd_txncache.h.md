<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Header file for a concurrent transaction cache that stores and queries transaction message hashes to prevent double execution.

# Purpose
The `fd_txncache.h` file defines the interface for a transaction cache system used in a concurrent environment. This system is designed to store and manage the message hashes of transactions that have already been executed, ensuring that transactions are not executed more than once. The cache is keyed by message hash rather than signature to prevent double spending due to signature malleability. The primary operations supported by this cache are insertion and query, both of which are designed to be fast and concurrent, allowing for high throughput of transactions, potentially over one million per second.

The transaction cache is implemented as a multi-level map structure, which efficiently handles the storage and retrieval of transaction hashes. It uses a `multi_map<blockhash, hash_map<txnhash, vec<fork_idx>>>` structure to manage transactions, allowing for the handling of rare cases where a block is equivocated but transactions remain the same. The file provides several functions to manage the cache, including [`fd_txncache_new`](<#fd_txncache_new>), [`fd_txncache_join`](<#fd_txncache_join>), [`fd_txncache_insert`](<#fd_txncache_insert>), and [`fd_txncache_query`](<#fd_txncache_query>), among others. These functions facilitate the creation, joining, insertion, and querying of the transaction cache, ensuring that the system can handle concurrent operations efficiently. The file also includes mechanisms to manage memory efficiently, such as using pages of transactions to support fast removal and insertion operations.
# Imports and Dependencies

---
- `fd_txncache_shmem.h`


# Data Structures

---
### fd\_txncache\_t
- **Type**: ``struct``
- **Members**:
    - ``fd_txncache_private``: A private structure used to define `fd_txncache_t`.
- **Description**: `fd_txncache_t` is a concurrent data structure used to store message hashes of executed transactions, keyed by message hash to prevent double spending due to signature malleability. It supports fast insertion and query operations, which are concurrent and lockless, assuming no other operations occur on the cache. The structure is sensitive to CPU and memory, storing message hashes in a multi-map format to handle rare cases of block equivocation. It uses pages of transactions to support fast removal and has mechanisms to handle nonce transactions, ensuring they are not inserted into the cache.


# Function Declarations (Public API)

---
### fd\_txncache\_align<!-- {{#callable_declaration:fd_txncache_align}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_txncache.h#L119>)

Return the required memory alignment for a transaction cache.
- **Description**: Use this function to obtain the memory alignment requirement for a transaction cache. This alignment is necessary when allocating memory for a transaction cache to ensure proper access and performance. Call this function before allocating memory to determine the correct alignment value.
- **Inputs**: None
- **Output**: Returns an unsigned long integer representing the required memory alignment for a transaction cache.
- **See Also**: [`fd_txncache_align`](<fd_txncache.c.md#fd_txncache_align>)  (Implementation)


---
### fd\_txncache\_footprint<!-- {{#callable_declaration:fd_txncache_footprint}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_txncache.h#L152>)

Calculates the memory footprint required for a transaction cache.
- **Description**: Use this function to determine the size of the memory region needed to store a transaction cache, based on the maximum number of live slots. This is important for allocating sufficient memory to hold the transaction cache data structures. Ensure that the `max_live_slots` parameter reflects the maximum number of active forks, including unrooted banks and the most recent root bank, to avoid memory allocation issues.
- **Inputs**:
    - `max_live_slots`: Specifies the maximum number of live slots, including unrooted banks and the most recent root bank. Must be a positive integer. If the value is invalid, the function may not calculate the correct memory footprint.
- **Output**: Returns the size in bytes of the memory footprint required for the transaction cache.
- **See Also**: [`fd_txncache_footprint`](<fd_txncache.c.md#fd_txncache_footprint>)  (Implementation)


---
### fd\_txncache\_new<!-- {{#callable_declaration:fd_txncache_new}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_txncache.h#L155>)

Formats a memory region for a transaction cache.
- **Description**: Use this function to initialize a memory region for a transaction cache with the required alignment and footprint. The function requires a valid memory region pointer and a shared memory structure. It returns a pointer to the initialized transaction cache on success or NULL on failure, logging details of any errors. Ensure the memory region is properly aligned and the shared memory structure is correctly configured before calling this function.
- **Inputs**:
    - `ljoin`: Pointer to the memory region to format. Must not be null and must be aligned according to `fd_txncache_align()`. Caller retains ownership.
    - `shmem`: Pointer to a `fd_txncache_shmem_t` structure that provides configuration for the transaction cache. Must not be null. Caller retains ownership.
- **Output**: Returns a pointer to the initialized transaction cache on success, or NULL on failure.
- **See Also**: [`fd_txncache_new`](<fd_txncache.c.md#fd_txncache_new>)  (Implementation)


---
### fd\_txncache\_join<!-- {{#callable_declaration:fd_txncache_join}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_txncache.h#L159>)

Joins a caller to a transaction cache.
- **Description**: Use this function to join a caller to a transaction cache by providing a pointer to the memory region holding the state. This function is essential for accessing the transaction cache operations. Ensure that the memory region is properly aligned and not null before calling this function. If the alignment is incorrect or the pointer is null, the function will log a warning and return null.
- **Inputs**:
    - `ljoin`: A pointer to the first byte of the memory region holding the transaction cache state. Must not be null and must be aligned according to `fd_txncache_align()`. If null or misaligned, the function logs a warning and returns null.
- **Output**: Returns a local handle to the transaction cache on success, or null on failure.
- **See Also**: [`fd_txncache_join`](<fd_txncache.c.md#fd_txncache_join>)  (Implementation)


---
### fd\_txncache\_reset<!-- {{#callable_declaration:fd_txncache_reset}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_txncache.h#L162>)

Resets the transaction cache to its initial state.
- **Description**: Use this function to clear all transaction data from the cache and reset it to its initial state. This operation locks the entire structure, preventing concurrent insertions and queries, and should be used sparingly, typically once per slot. Ensure that no other operations are being performed on the cache when calling this function to avoid conflicts.
- **Inputs**:
    - `tc`: A pointer to an `fd_txncache_t` structure representing the transaction cache. Must not be null. The caller retains ownership of the memory.
- **Output**: None
- **See Also**: [`fd_txncache_reset`](<fd_txncache.c.md#fd_txncache_reset>)  (Implementation)


---
### fd\_txncache\_attach\_child<!-- {{#callable_declaration:fd_txncache_attach_child}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_txncache.h#L180>)

Notifies the transaction cache of a new child bank creation.
- **Description**: Use this function to inform the transaction cache that a new child bank has been created from a specified parent. This function must be called before inserting any transactions executed on the new child fork. The parent fork ID must be a valid fork ID previously returned from this function and still active as the current root bank or a child of it. Ensure that the number of active unrooted banks does not exceed the maximum allowed before calling this function. The function takes a write lock on the entire structure, which can stall other concurrent operations, but this is acceptable due to the infrequent nature of this operation.
- **Inputs**:
    - `tc`: A pointer to the transaction cache structure. Must not be null. The caller retains ownership.
    - `parent_fork_id`: A fork ID representing the parent bank. Must be a valid fork ID previously returned from this function and still active as the current root bank or a child of it.
- **Output**: Returns a fork ID for the newly created child bank.
- **See Also**: [`fd_txncache_attach_child`](<fd_txncache.c.md#fd_txncache_attach_child>)  (Implementation)


---
### fd\_txncache\_attach\_blockhash<!-- {{#callable_declaration:fd_txncache_attach_blockhash}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_txncache.h#L184>)

Associates a blockhash with a specific fork in the transaction cache.
- **Description**: Use this function to link a blockhash to a specific fork within the transaction cache. This operation must be performed before any transactions associated with the blockhash are inserted into the cache. The function requires a write lock on the transaction cache, which may temporarily block other operations. Ensure that the fork is not frozen before calling this function, as it will freeze the fork upon execution.
- **Inputs**:
    - `tc`: A pointer to an `fd_txncache_t` structure representing the transaction cache. Must not be null.
    - `fork_id`: An `fd_txncache_fork_id_t` identifying the fork to which the blockhash will be attached. The fork must be valid and not frozen.
    - `blockhash`: A pointer to a 32-byte array containing the blockhash to attach. Must not be null.
- **Output**: None
- **See Also**: [`fd_txncache_attach_blockhash`](<fd_txncache.c.md#fd_txncache_attach_blockhash>)  (Implementation)


---
### fd\_txncache\_finalize\_fork<!-- {{#callable_declaration:fd_txncache_finalize_fork}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_txncache.h#L189>)

Finalize a fork in the transaction cache.
- **Description**: Use this function to finalize a fork in the transaction cache by setting its transaction hash offset and block hash. This function must be called after all transactions for the fork have been inserted. It locks the transaction cache for writing, updates the fork's transaction hash offset and block hash, and marks the fork as frozen. Ensure that the fork is not already frozen before calling this function.
- **Inputs**:
    - `tc`: A pointer to the transaction cache (`fd_txncache_t`). Must not be null. The caller retains ownership.
    - `fork_id`: An identifier for the fork (`fd_txncache_fork_id_t`). Must be a valid fork ID within the transaction cache.
    - `txnhash_offset`: An unsigned long integer representing the transaction hash offset. Must be a valid offset for the fork.
    - `blockhash`: A pointer to a 32-byte array containing the block hash. Must not be null. The caller retains ownership.
- **Output**: None
- **See Also**: [`fd_txncache_finalize_fork`](<fd_txncache.c.md#fd_txncache_finalize_fork>)  (Implementation)


---
### fd\_txncache\_advance\_root<!-- {{#callable_declaration:fd_txncache_advance_root}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_txncache.h#L205>)

Advances the root slot in the transaction cache.
- **Description**: Use this function to update the root slot of the transaction cache when the chain's root has advanced. This operation allows the removal of old message hashes that reference blockhashes which are no longer valid. It takes a write lock on the structure, which can stall other concurrent operations, but this is acceptable as the function is called infrequently (approximately once every 400 milliseconds). Ensure that the `fork_id` provided is valid and corresponds to a fork that can be advanced to the root.
- **Inputs**:
    - `tc`: A pointer to an `fd_txncache_t` structure representing the transaction cache. Must not be null. The caller retains ownership.
    - `fork_id`: An `fd_txncache_fork_id_t` representing the fork to advance to the root. Must be a valid fork ID.
- **Output**: None
- **See Also**: [`fd_txncache_advance_root`](<fd_txncache.c.md#fd_txncache_advance_root>)  (Implementation)


---
### fd\_txncache\_insert<!-- {{#callable_declaration:fd_txncache_insert}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_txncache.h#L221>)

Insert a transaction hash into the transaction cache for a specified fork.
- **Description**: Use this function to add a transaction hash to the transaction cache associated with a specific fork. This operation is concurrent and can occur alongside other insertions and queries. The function assumes that the caller respects the structure's invariants, and it will abort the program if there is no space to insert another transaction. The function does not retain any interest in the memory of the provided hashes after the call returns.
- **Inputs**:
    - `tc`: A pointer to the transaction cache (`fd_txncache_t`). Must not be null. The caller retains ownership.
    - `fork_id`: An identifier for the fork (`fd_txncache_fork_id_t`) where the transaction hash will be inserted. Must be valid and correspond to an existing fork.
    - `blockhash`: A pointer to a 32-byte array representing the block hash. Must not be null. The function copies the data, so the caller retains ownership.
    - `txnhash`: A pointer to a 32-byte array representing the transaction hash. Must not be null. The function copies the data, so the caller retains ownership.
- **Output**: None
- **See Also**: [`fd_txncache_insert`](<fd_txncache.c.md#fd_txncache_insert>)  (Implementation)


---
### fd\_txncache\_query<!-- {{#callable_declaration:fd_txncache_query}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_txncache.h#L237>)

Checks if a transaction hash exists on a specified fork.
- **Description**: Use this function to verify if a transaction hash, associated with a specific block hash, exists on a given fork in the transaction cache. This function is designed for high performance and can be used concurrently with other queries and insertions. It is important to ensure that the transaction cache is properly initialized and that the fork ID is valid before calling this function. The function will return an error if the block hash does not exist on the specified fork.
- **Inputs**:
    - `tc`: A pointer to a `fd_txncache_t` structure representing the transaction cache. Must not be null and should be properly initialized.
    - `fork_id`: An identifier of type `fd_txncache_fork_id_t` representing the fork to query. Must be a valid fork ID.
    - `blockhash`: A pointer to an array of unsigned characters representing the block hash. Must not be null and should point to a valid block hash.
    - `txnhash`: A pointer to an array of unsigned characters representing the transaction hash. Must not be null and should point to a valid transaction hash.
- **Output**: Returns 1 if the transaction exists on the specified fork, and 0 if it does not.
- **See Also**: [`fd_txncache_query`](<fd_txncache.c.md#fd_txncache_query>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)