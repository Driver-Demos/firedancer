<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Header file for managing bank states in Solana, including structures, functions, and concurrency controls.

# Purpose
The code defines a C header file for managing the state of banks in a Solana blockchain validator. It provides structures and functions to handle the bank state, which is crucial for executing transactions and maintaining the blockchain's ledger. The primary structures are `fd_bank_t` and `fd_banks_t`. `fd_bank_t` represents the state of a bank for a specific block, including fields for transaction counts, slot information, and various caches. `fd_banks_t` manages multiple `fd_bank_t` instances, supporting operations like cloning banks from parent states, advancing the root bank, and managing fork trees.

The code includes mechanisms for Copy-on-Write (CoW) to optimize memory usage, especially for large fields that are not frequently modified. It also uses read-write locks to ensure thread-safe access to bank fields that can be concurrently read and written. The header file defines macros and inline functions to facilitate the creation, modification, and querying of bank states, ensuring that the bank management system is both efficient and scalable. The file also outlines the usage patterns for creating and managing banks, including initializing, cloning, and advancing banks within the fork tree.
# Imports and Dependencies

---
- `../types/fd_types.h`
- `../leaders/fd_leaders.h`
- `../features/fd_features.h`
- `../rewards/fd_epoch_rewards.h`
- `../stakes/fd_stake_delegations.h`
- `../stakes/fd_vote_states.h`
- `../fd_rwlock.h`
- `fd_blockhashes.h`
- `sysvar/fd_sysvar_cache.h`
- `../../ballet/lthash/fd_lthash.h`
- `../../util/tmpl/fd_pool.c`


# Data Structures

---
### fd\_banks
- **Type**: ``struct``
- **Members**:
    - ``magic``: A unique identifier for the `fd_banks` structure, set to `FD_BANKS_MAGIC`.
    - ``max_total_banks``: Specifies the maximum number of banks that can be managed.
    - ``max_fork_width``: Defines the maximum fork width that can execute through any given slot.
    - ``root_idx``: Index of the root bank in the bank pool.
    - ``rwlock``: A read-write lock used to serialize fork tree operations.
    - ``pool_offset``: Offset of the bank pool from the `fd_banks` structure.
    - ``cost_tracker_pool_offset``: Offset of the cost tracker pool from the `fd_banks` structure.
    - ``stake_delegations_root``: Stores the full state of stake delegations for the current root.
    - ``stake_delegations_frontier``: Reserved memory for the full state of stake delegations for the current frontier.
    - ``name##_pool_offset``: Offset of the CoW pool from banks for each CoW field.
    - ``name##_pool_lock``: Lock for each CoW pool to manage concurrent access.
- **Description**: Manages the state of multiple banks in a fork-aware manner, using a pool of `fd_bank_t` structures to track parent-child relationships in a fork tree. It supports operations like querying, modifying, cloning, and publishing bank states, while ensuring synchronization through read-write locks. The structure also handles Copy-on-Write (CoW) semantics for certain fields to optimize memory usage and performance, especially for large data like stake delegations. The `fd_banks` structure is designed to manage a dynamic set of banks, allowing for efficient state management and resource allocation in a blockchain environment.


---
### fd\_banks\_t
- **Type**: ``struct``
- **Members**:
    - `magic`: A unique identifier for the `fd_banks_t` structure, set to `FD_BANKS_MAGIC`.
    - `max_total_banks`: The maximum number of banks that can be managed.
    - `max_fork_width`: The maximum fork width that can execute through any given slot.
    - `root_idx`: The index of the root bank in the pool.
    - `rwlock`: A read-write lock used to serialize fork tree operations.
    - `pool_offset`: The offset of the bank pool from the `fd_banks_t` structure.
    - `cost_tracker_pool_offset`: The offset of the cost tracker pool from the `fd_banks_t` structure.
    - `stake_delegations_root`: The full state of stake delegations for the current root bank.
    - `stake_delegations_frontier`: Reserved memory for the full state of stake delegations for the current frontier.
    - `block_hash_queue_pool_offset`: Offset of the block hash queue pool from banks.
    - `epoch_rewards_pool_offset`: Offset of the epoch rewards pool from banks.
    - `epoch_leaders_pool_offset`: Offset of the epoch leaders pool from banks.
    - `vote_states_pool_offset`: Offset of the vote states pool from banks.
    - `vote_states_prev_pool_offset`: Offset of the previous vote states pool from banks.
    - `vote_states_prev_prev_pool_offset`: Offset of the previous previous vote states pool from banks.
    - `cost_tracker_pool_lock`: Lock for the cost tracker pool.
    - `block_hash_queue_pool_lock`: Lock for the block hash queue pool.
    - `epoch_rewards_pool_lock`: Lock for the epoch rewards pool.
    - `epoch_leaders_pool_lock`: Lock for the epoch leaders pool.
    - `vote_states_pool_lock`: Lock for the vote states pool.
    - `vote_states_prev_pool_lock`: Lock for the previous vote states pool.
    - `vote_states_prev_prev_pool_lock`: Lock for the previous previous vote states pool.
- **Description**: Manages the state of banks in a Solana validator, supporting operations like querying, modifying, cloning, and publishing bank states. It maintains a pool of `fd_bank_t` structures and uses a left-child, right-sibling n-ary tree to track parent-child relationships in the fork tree. The structure includes metadata for managing banks, pointers to copy-on-write (CoW) pools, and locks for synchronizing access to the fork tree. It supports fork-awareness, allowing for efficient management of bank states across different forks and epochs.


# Functions

---
### fd\_bank\_set\_cost\_tracker\_pool<!-- {{#callable:fd_bank_set_cost_tracker_pool}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L474>)

Sets the cost tracker pool for a given bank and updates the bank's cost tracker pool offset.
- **Inputs**:
    - ``bank``: A pointer to an `fd_bank_t` structure representing the bank for which the cost tracker pool is being set.
    - ``cost_tracker_pool``: A pointer to an `fd_bank_cost_tracker_t` structure representing the cost tracker pool to be associated with the bank.
- **Logic and Control Flow**:
    - Calls `fd_bank_cost_tracker_pool_leave` with `cost_tracker_pool` to obtain a memory address for the cost tracker pool.
    - Checks if the memory address obtained is NULL using `FD_UNLIKELY`.
    - Logs a critical error message if the memory address is NULL.
    - Calculates the offset of the cost tracker pool memory from the bank's base address and assigns it to `bank->cost_tracker_pool_offset`.
- **Output**: No return value; the function updates the `cost_tracker_pool_offset` field of the `bank` structure.


---
### fd\_bank\_get\_cost\_tracker\_pool<!-- {{#callable:fd_bank_get_cost_tracker_pool}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L483>)

Retrieves the cost tracker pool for a given bank.
- **Inputs**:
    - `bank`: A pointer to an `fd_bank_t` structure representing the bank from which to retrieve the cost tracker pool.
- **Logic and Control Flow**:
    - Calculate the address of the cost tracker pool by adding the `cost_tracker_pool_offset` to the base address of the `bank` structure.
    - Call `fd_bank_cost_tracker_pool_join` with the calculated address to retrieve the cost tracker pool.
- **Output**: Returns a pointer to an `fd_bank_cost_tracker_t` structure representing the cost tracker pool for the specified bank.


---
### fd\_bank\_cost\_tracker\_locking\_modify<!-- {{#callable:fd_bank_cost_tracker_locking_modify}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L594>)

Modifies the cost tracker of a bank with write-lock protection.
- **Inputs**:
    - ``bank``: A pointer to an `fd_bank_t` structure representing the bank whose cost tracker is to be modified.
- **Logic and Control Flow**:
    - Retrieve the cost tracker pool associated with the bank using [`fd_bank_get_cost_tracker_pool`](<#fd_bank_get_cost_tracker_pool>) function.
    - Check if the bank's `cost_tracker_pool_idx` is not equal to the null index of the cost tracker pool using `FD_TEST`.
    - Retrieve the memory location of the cost tracker element using `fd_bank_cost_tracker_pool_ele` and verify it is not null using `FD_TEST`.
    - Acquire a write lock on the bank's cost tracker using `fd_rwlock_write`.
    - Return a pointer to the cost tracker memory, cast to `fd_cost_tracker_t` using `fd_type_pun`.
- **Output**: A pointer to the `fd_cost_tracker_t` structure representing the cost tracker of the bank.
- **Functions Called**:
    - [`fd_bank_get_cost_tracker_pool`](<#fd_bank_get_cost_tracker_pool>)


---
### fd\_bank\_cost\_tracker\_end\_locking\_modify<!-- {{#callable:fd_bank_cost_tracker_end_locking_modify}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L604>)

Releases the write lock on the `cost_tracker_lock` of a given `fd_bank_t` structure.
- **Inputs**:
    - `bank`: A pointer to an `fd_bank_t` structure, which represents the bank state and contains the `cost_tracker_lock` to be released.
- **Logic and Control Flow**:
    - Calls `fd_rwlock_unwrite` to release the write lock on the `cost_tracker_lock` of the `bank` structure.
- **Output**: No return value; the function operates directly on the `fd_bank_t` structure pointed to by `bank`.


---
### fd\_bank\_cost\_tracker\_locking\_query<!-- {{#callable:fd_bank_cost_tracker_locking_query}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L609>)

Queries the cost tracker of a bank with read-locking to ensure thread safety.
- **Inputs**:
    - `bank`: A pointer to an `fd_bank_t` structure representing the bank whose cost tracker is being queried.
- **Logic and Control Flow**:
    - Retrieve the cost tracker pool associated with the bank using [`fd_bank_get_cost_tracker_pool`](<#fd_bank_get_cost_tracker_pool>) function.
    - Check that the `cost_tracker_pool_idx` of the bank is not null using `FD_TEST`.
    - Access the memory location of the cost tracker element using `fd_bank_cost_tracker_pool_ele` and verify it is not null with `FD_TEST`.
    - Acquire a read lock on the bank's cost tracker using `fd_rwlock_read`.
    - Return a constant pointer to the cost tracker memory, cast to `fd_cost_tracker_t` type using `fd_type_pun_const`.
- **Output**: A constant pointer to the `fd_cost_tracker_t` structure representing the cost tracker of the bank.
- **Functions Called**:
    - [`fd_bank_get_cost_tracker_pool`](<#fd_bank_get_cost_tracker_pool>)


---
### fd\_bank\_cost\_tracker\_end\_locking\_query<!-- {{#callable:fd_bank_cost_tracker_end_locking_query}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L619>)

Releases the read lock on the `cost_tracker_lock` of a given `fd_bank_t` structure.
- **Inputs**:
    - `bank`: A pointer to an `fd_bank_t` structure, which represents the bank state on Solana for a given block.
- **Logic and Control Flow**:
    - Calls `fd_rwlock_unread` to release the read lock on the `cost_tracker_lock` associated with the `bank` parameter.
- **Output**: No return value; the function operates directly on the `fd_bank_t` structure pointed to by `bank`.


---
### fd\_bank\_stake\_delegations\_delta\_locking\_modify<!-- {{#callable:fd_bank_stake_delegations_delta_locking_modify}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L643>)

Modifies the stake delegations delta of a bank by acquiring a write lock, initializing the delta if not dirty, and returning a joined stake delegations object.
- **Inputs**:
    - ``bank``: A pointer to an `fd_bank_t` structure representing the bank whose stake delegations delta is to be modified.
- **Logic and Control Flow**:
    - Acquire a write lock on the `stake_delegations_delta_lock` of the `bank`.
    - Check if `stake_delegations_delta_dirty` is false; if so, set it to true and initialize `stake_delegations_delta` using `fd_stake_delegations_new`.
    - Return the result of `fd_stake_delegations_join` on `stake_delegations_delta`.
- **Output**: Returns a pointer to an `fd_stake_delegations_t` object representing the joined stake delegations.


---
### fd\_bank\_stake\_delegations\_delta\_end\_locking\_modify<!-- {{#callable:fd_bank_stake_delegations_delta_end_locking_modify}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L653>)

Releases the write lock on the `stake_delegations_delta_lock` of the `fd_bank_t` structure.
- **Inputs**:
    - `bank`: A pointer to an `fd_bank_t` structure, which represents the bank state.
- **Logic and Control Flow**:
    - Calls `fd_rwlock_unwrite` to release the write lock on the `stake_delegations_delta_lock` of the `bank` structure.
- **Output**: No return value; the function operates directly on the `bank` structure.


---
### fd\_bank\_stake\_delegations\_delta\_locking\_query<!-- {{#callable:fd_bank_stake_delegations_delta_locking_query}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L658>)

Queries the stake delegations delta of a bank with read-locking and returns it if it is marked as dirty.
- **Inputs**:
    - `bank`: A pointer to an `fd_bank_t` structure representing the bank whose stake delegations delta is being queried.
- **Logic and Control Flow**:
    - Acquires a read lock on the `stake_delegations_delta_lock` of the `bank`.
    - Checks if the `stake_delegations_delta_dirty` flag of the `bank` is set.
    - If the `stake_delegations_delta_dirty` flag is set, calls `fd_stake_delegations_join` with `bank->stake_delegations_delta` and returns the result.
    - If the `stake_delegations_delta_dirty` flag is not set, returns `NULL`.
- **Output**: Returns a pointer to `fd_stake_delegations_t` if the stake delegations delta is dirty, otherwise returns `NULL`.


---
### fd\_bank\_stake\_delegations\_delta\_end\_locking\_query<!-- {{#callable:fd_bank_stake_delegations_delta_end_locking_query}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L664>)

Releases the read lock on the `stake_delegations_delta_lock` of a given `fd_bank_t` structure.
- **Inputs**:
    - `bank`: A pointer to an `fd_bank_t` structure, representing the bank whose `stake_delegations_delta_lock` read lock is to be released.
- **Logic and Control Flow**:
    - Calls `fd_rwlock_unread` to release the read lock on the `stake_delegations_delta_lock` associated with the `bank` parameter.
- **Output**: No return value; the function operates directly on the `fd_bank_t` structure pointed to by `bank`.


---
### fd\_banks\_get\_bank\_pool<!-- {{#callable:fd_banks_get_bank_pool}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L693>)

Retrieves the bank pool from a given `fd_banks_t` structure.
- **Inputs**:
    - `banks`: A pointer to a constant `fd_banks_t` structure from which the bank pool is retrieved.
- **Logic and Control Flow**:
    - Calculate the address of the bank pool by adding the `pool_offset` to the base address of `banks`.
    - Call `fd_banks_pool_join` with the calculated address to retrieve the bank pool.
- **Output**: Returns a pointer to the `fd_bank_t` structure representing the bank pool.


---
### fd\_banks\_set\_bank\_pool<!-- {{#callable:fd_banks_set_bank_pool}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L698>)

Sets the pool offset for a bank pool in the `fd_banks_t` structure.
- **Inputs**:
    - `banks`: A pointer to an `fd_banks_t` structure where the pool offset will be set.
    - `bank_pool`: A pointer to an `fd_bank_t` structure representing the bank pool to be set.
- **Logic and Control Flow**:
    - Calls `fd_banks_pool_leave` with `bank_pool` to get the memory address of the bank pool.
    - Checks if the returned memory address is NULL using `FD_UNLIKELY`.
    - Logs a critical error message if the memory address is NULL.
    - Calculates the pool offset by subtracting the base address of `banks` from the memory address of the bank pool.
    - Sets the `pool_offset` field of `banks` to the calculated offset.
- **Output**: No return value; modifies the `pool_offset` field of the `fd_banks_t` structure.


---
### fd\_banks\_get\_cost\_tracker\_pool<!-- {{#callable:fd_banks_get_cost_tracker_pool}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L731>)

Retrieves the cost tracker pool from a given `fd_banks_t` structure.
- **Inputs**:
    - `banks`: A pointer to an `fd_banks_t` structure from which to retrieve the cost tracker pool.
- **Logic and Control Flow**:
    - Calculates the memory address of the cost tracker pool by adding the `cost_tracker_pool_offset` to the base address of `banks`.
    - Calls `fd_bank_cost_tracker_pool_join` with the calculated address to obtain the cost tracker pool.
- **Output**: Returns a pointer to an `fd_bank_cost_tracker_t` structure representing the cost tracker pool.


---
### fd\_banks\_set\_cost\_tracker\_pool<!-- {{#callable:fd_banks_set_cost_tracker_pool}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L736>)

Sets the cost tracker pool for a given `fd_banks_t` structure by calculating and storing the memory offset of the pool.
- **Inputs**:
    - `banks`: A pointer to an `fd_banks_t` structure where the cost tracker pool offset will be set.
    - `cost_tracker_pool`: A pointer to an `fd_bank_cost_tracker_t` structure representing the cost tracker pool to be set.
- **Logic and Control Flow**:
    - Call `fd_bank_cost_tracker_pool_leave` with `cost_tracker_pool` to get the memory address of the pool.
    - Check if the returned memory address is NULL using `FD_UNLIKELY`.
    - If the memory address is NULL, log a critical error message using `FD_LOG_CRIT`.
    - Calculate the offset of the cost tracker pool memory from the `banks` pointer and store it in `banks->cost_tracker_pool_offset`.
- **Output**: No return value; the function modifies the `banks` structure in place.


---
### fd\_banks\_root\_const<!-- {{#callable:fd_banks_root_const}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L749>)

Returns a constant pointer to the root bank from a given `fd_banks_t` structure.
- **Inputs**:
    - `banks`: A constant pointer to an `fd_banks_t` structure, which manages the bank state and contains metadata and pointers to pools.
- **Logic and Control Flow**:
    - Calls [`fd_banks_get_bank_pool`](<#fd_banks_get_bank_pool>) with `banks` to retrieve the bank pool.
    - Uses `fd_banks_pool_ele_const` to get a constant pointer to the bank at the index `banks->root_idx` in the pool.
- **Output**: A constant pointer to an `fd_bank_t` structure representing the root bank.
- **Functions Called**:
    - [`fd_banks_get_bank_pool`](<#fd_banks_get_bank_pool>)


---
### fd\_banks\_root<!-- {{#callable:fd_banks_root}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L754>)

Retrieves the root bank from a given bank manager.
- **Inputs**:
    - `banks`: A pointer to an `fd_banks_t` structure representing the bank manager.
- **Logic and Control Flow**:
    - Calls [`fd_banks_get_bank_pool`](<#fd_banks_get_bank_pool>) to obtain the bank pool from the `banks` structure.
    - Uses `fd_banks_pool_ele` to retrieve the bank at the index specified by `banks->root_idx`.
- **Output**: Returns a pointer to the `fd_bank_t` structure representing the root bank.
- **Functions Called**:
    - [`fd_banks_get_bank_pool`](<#fd_banks_get_bank_pool>)


---
### fd\_banks\_bank\_mem\_query<!-- {{#callable:fd_banks_bank_mem_query}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L819>)

Retrieves a bank from a pool of banks using a specified index.
- **Inputs**:
    - ``banks``: A pointer to an `fd_banks_t` structure, which manages the state of multiple banks.
    - ``bank_idx``: An unsigned long integer representing the index of the bank to retrieve from the pool.
- **Logic and Control Flow**:
    - Calls [`fd_banks_get_bank_pool`](<#fd_banks_get_bank_pool>) to obtain the pool of banks from the `banks` structure.
    - Uses `fd_banks_pool_ele` to retrieve the bank at the specified `bank_idx` from the pool.
- **Output**: Returns a pointer to the `fd_bank_t` structure at the specified index in the bank pool.
- **Functions Called**:
    - [`fd_banks_get_bank_pool`](<#fd_banks_get_bank_pool>)


---
### fd\_banks\_bank\_query<!-- {{#callable:fd_banks_bank_query}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L825>)

Queries a bank from a pool by its index and checks if it is initialized.
- **Inputs**:
    - ``banks``: A pointer to an `fd_banks_t` structure, representing the bank manager.
    - ``bank_idx``: An unsigned long integer representing the index of the bank to query.
- **Logic and Control Flow**:
    - Calls [`fd_banks_get_bank_pool`](<#fd_banks_get_bank_pool>) to retrieve the bank pool from `banks`.
    - Uses `fd_banks_pool_ele` to get the bank at the specified `bank_idx` from the pool.
    - Checks if the bank's `flags` field has the `FD_BANK_FLAGS_INIT` flag set.
    - Returns the bank if it is initialized; otherwise, returns `NULL`.
- **Output**: Returns a pointer to the `fd_bank_t` structure if the bank is initialized, otherwise returns `NULL`.
- **Functions Called**:
    - [`fd_banks_get_bank_pool`](<#fd_banks_get_bank_pool>)


---
### fd\_banks\_get\_parent<!-- {{#callable:fd_banks_get_parent}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L832>)

Retrieves the parent bank of a given bank from a pool of banks.
- **Inputs**:
    - ``banks``: A pointer to an `fd_banks_t` structure, representing the pool of banks.
    - ``bank``: A pointer to an `fd_bank_t` structure, representing the bank whose parent is to be retrieved.
- **Logic and Control Flow**:
    - Call [`fd_banks_get_bank_pool`](<#fd_banks_get_bank_pool>) with `banks` to get the bank pool.
    - Access the `parent_idx` of the `bank` to get the index of the parent bank.
    - Call `fd_banks_pool_ele` with the bank pool and `parent_idx` to retrieve the parent bank.
- **Output**: Returns a pointer to the parent `fd_bank_t` structure of the given `bank`.
- **Functions Called**:
    - [`fd_banks_get_bank_pool`](<#fd_banks_get_bank_pool>)


---
### fd\_banks\_is\_full<!-- {{#callable:fd_banks_is_full}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L941>)

Checks if the bank pool in `fd_banks_t` is full by verifying if there are no free slots available.
- **Inputs**:
    - ``banks``: A pointer to an `fd_banks_t` structure representing the bank manager.
- **Logic and Control Flow**:
    - Call [`fd_banks_get_bank_pool`](<#fd_banks_get_bank_pool>) with `banks` to retrieve the bank pool.
    - Call `fd_banks_pool_free` with the retrieved bank pool to get the number of free slots.
    - Compare the result to `0UL` to determine if the pool is full.
- **Output**: Returns `1` if the bank pool is full (no free slots), otherwise returns `0`.
- **Functions Called**:
    - [`fd_banks_get_bank_pool`](<#fd_banks_get_bank_pool>)


# Function Declarations (Public API)

---
### fd\_bank\_align<!-- {{#callable_declaration:fd_bank_align}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L490>)

Returns the alignment requirement of the `fd_bank_t` structure.
- **Description**: Use this function to obtain the alignment requirement for the `fd_bank_t` structure. This is useful when allocating memory for `fd_bank_t` instances to ensure proper alignment, which is necessary for correct operation on some hardware architectures. The function does not require any parameters and can be called at any time.
- **Inputs**: None
- **Output**: The function returns an `ulong` representing the alignment requirement of the `fd_bank_t` structure.
- **See Also**: [`fd_bank_align`](<fd_bank.c.md#fd_bank_align>)  (Implementation)


---
### fd\_bank\_footprint<!-- {{#callable_declaration:fd_bank_footprint}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L496>)

Calculates the memory footprint of a bank state.
- **Description**: Use this function to determine the memory size required for a bank state, excluding the copy-on-write (CoW) state. This is useful for memory allocation and management when working with bank states in the system. Ensure that the system is prepared to handle the calculated footprint size before proceeding with operations that involve bank states.
- **Inputs**: None
- **Output**: Returns the size in bytes as an unsigned long integer, representing the memory footprint of a bank state.
- **See Also**: [`fd_bank_footprint`](<fd_bank.c.md#fd_bank_footprint>)  (Implementation)


---
### fd\_bank\_stake\_delegations\_frontier\_query<!-- {{#callable_declaration:fd_bank_stake_delegations_frontier_query}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L678>)

Queries the full stake delegations for the current frontier.
- **Description**: Use this function to obtain the complete stake delegations for the current frontier by applying all deltas from the specified bank and its ancestors to the rooted state. This function must be called when no other threads are reading or writing to the stake delegations, as it involves copying and modifying shared data. Ensure that the `fd_banks_t` and `fd_bank_t` structures are properly initialized before calling this function.
- **Inputs**:
    - `banks`: A pointer to an `fd_banks_t` structure representing the bank manager. Must not be null and must be properly initialized.
    - `bank`: A pointer to an `fd_bank_t` structure representing the bank for which the stake delegations are queried. Must not be null and must be properly initialized.
- **Output**: Returns a pointer to an `fd_stake_delegations_t` structure containing the full stake delegations for the current frontier.
- **See Also**: [`fd_bank_stake_delegations_frontier_query`](<fd_bank.c.md#fd_bank_stake_delegations_frontier_query>)  (Implementation)


---
### fd\_banks\_stake\_delegations\_root\_query<!-- {{#callable_declaration:fd_banks_stake_delegations_root_query}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L686>)

Returns the full stake delegations for the current root.
- **Description**: Use this function to obtain a pointer to the complete set of stake delegations associated with the current root bank. This function is intended to be called only during the boot process. It provides access to the root's stake delegations, which are crucial for understanding the current state of stake allocations in the system.
- **Inputs**:
    - `banks`: A pointer to an `fd_banks_t` structure representing the bank manager. This parameter must not be null, and the caller retains ownership. The function assumes that the `banks` structure is properly initialized and valid.
- **Output**: A pointer to an `fd_stake_delegations_t` structure representing the full stake delegations for the current root. The caller does not own the returned pointer and should not attempt to free it.
- **See Also**: [`fd_banks_stake_delegations_root_query`](<fd_bank.c.md#fd_banks_stake_delegations_root_query>)  (Implementation)


---
### fd\_banks\_align<!-- {{#callable_declaration:fd_banks_align}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L761>)

Returns the alignment requirement for bank structures.
- **Description**: Use this function to obtain the alignment requirement for bank structures managed by the system. This is necessary when allocating memory for bank structures to ensure proper alignment, which can affect performance and correctness. The function does not require any parameters and can be called at any time to retrieve the alignment value.
- **Inputs**: None
- **Output**: Returns an unsigned long integer representing the alignment requirement in bytes.
- **See Also**: [`fd_banks_align`](<fd_bank.c.md#fd_banks_align>)  (Implementation)


---
### fd\_banks\_footprint<!-- {{#callable_declaration:fd_banks_footprint}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L781>)

Calculates the memory footprint for managing bank states.
- **Description**: Use this function to determine the memory size required to manage a specified number of banks and fork width in a bank management system. This is important for allocating sufficient memory resources when initializing or configuring the system. Ensure that the values for the maximum number of banks and fork width are correctly set according to the expected workload and system constraints.
- **Inputs**:
    - `max_total_banks`: Specifies the maximum number of banks that can be managed. Must be a positive integer. Invalid values may lead to incorrect memory calculations.
    - `max_fork_width`: Specifies the maximum fork width that can be executed through any given slot. Must be a positive integer. Invalid values may lead to incorrect memory calculations.
- **Output**: Returns the calculated memory footprint in bytes as an unsigned long integer.
- **See Also**: [`fd_banks_footprint`](<fd_bank.c.md#fd_banks_footprint>)  (Implementation)


---
### fd\_banks\_new<!-- {{#callable_declaration:fd_banks_new}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L790>)

Creates a new bank management structure in shared memory.
- **Description**: Use this function to initialize a new bank management structure in a given shared memory region. This function sets up the necessary memory layout for managing banks and their associated pools, based on the specified maximum number of banks and fork width. Ensure that the `shmem` pointer is not null and is properly aligned according to the required alignment for bank structures. The function returns a pointer to the initialized memory region or null if initialization fails due to invalid input or memory layout issues.
- **Inputs**:
    - `shmem`: Pointer to the shared memory region where the bank management structure will be created. Must not be null and must be aligned according to the required alignment for bank structures. Caller retains ownership.
    - `max_total_banks`: Maximum number of banks that can be managed. Must be a positive integer.
    - `max_fork_width`: Maximum fork width that can be executed through any given slot. Must be a positive integer.
- **Output**: Returns a pointer to the initialized shared memory region if successful, or null if initialization fails.
- **See Also**: [`fd_banks_new`](<fd_bank.c.md#fd_banks_new>)  (Implementation)


---
### fd\_banks\_join<!-- {{#callable_declaration:fd_banks_join}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L797>)

Joins a memory region to a bank management structure.
- **Description**: Use this function to associate a memory region with a `fd_banks_t` structure, which manages bank states. This function checks if the memory is correctly aligned and contains valid data before joining. It must be called with a valid memory region that has been previously initialized for bank management. If the memory is null, misaligned, or contains invalid data, the function returns null and logs a warning.
- **Inputs**:
    - `mem`: A pointer to a memory region intended for use with a `fd_banks_t` structure. The memory must be aligned according to `fd_banks_align()` and must not be null. If the memory is misaligned or null, the function returns null and logs a warning.
- **Output**: Returns a pointer to a `fd_banks_t` structure if successful, or null if the input is invalid.
- **See Also**: [`fd_banks_join`](<fd_bank.c.md#fd_banks_join>)  (Implementation)


---
### fd\_banks\_leave<!-- {{#callable_declaration:fd_banks_leave}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L802>)

Leaves a bank and returns a pointer to it.
- **Description**: Use this function to leave a bank and obtain a pointer to it. This function checks if the `banks` parameter is null and logs a warning if it is. If `banks` is null, the function returns null. Otherwise, it returns a pointer to the `banks` object. Ensure that the `banks` parameter is not null before calling this function to avoid unexpected null returns.
- **Inputs**:
    - `banks`: A pointer to an `fd_banks_t` object. Must not be null. If null, the function logs a warning and returns null.
- **Output**: Returns a pointer to the `fd_banks_t` object if `banks` is not null; otherwise, returns null.
- **See Also**: [`fd_banks_leave`](<fd_bank.c.md#fd_banks_leave>)  (Implementation)


---
### fd\_banks\_delete<!-- {{#callable_declaration:fd_banks_delete}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L807>)

Deletes a bank from shared memory.
- **Description**: Use this function to delete a bank from shared memory. It requires a valid pointer to the shared memory region representing the bank. The function checks if the pointer is null or misaligned and logs a warning if so, returning null in these cases. If the pointer is valid and properly aligned, the function sets the bank's magic number to zero, effectively marking it as deleted, and returns the original pointer.
- **Inputs**:
    - `shmem`: Pointer to the shared memory region representing the bank. Must not be null and must be aligned according to the bank's alignment requirements. If null or misaligned, the function logs a warning and returns null.
- **Output**: Returns the original pointer if the bank is successfully marked as deleted, or null if the input is invalid.
- **See Also**: [`fd_banks_delete`](<fd_bank.c.md#fd_banks_delete>)  (Implementation)


---
### fd\_banks\_init\_bank<!-- {{#callable_declaration:fd_banks_init_bank}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L814>)

Initializes a new bank in the bank manager.
- **Description**: Use this function to initialize a new bank within the bank manager during the system bootup process. It sets up an initial bank with a bank index of 0, preparing it for further operations. This function must be called only once during the initialization phase to ensure the bank manager is ready for managing bank states.
- **Inputs**:
    - `banks`: A pointer to an `fd_banks_t` structure representing the bank manager. Must not be null. If null, the function logs a warning and returns null.
- **Output**: Returns a pointer to the initialized `fd_bank_t` structure if successful, or null if the input is invalid or if the bank pool is full.
- **See Also**: [`fd_banks_init_bank`](<fd_bank.c.md#fd_banks_init_bank>)  (Implementation)


---
### fd\_banks\_clone\_from\_parent<!-- {{#callable_declaration:fd_banks_clone_from_parent}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L851>)

Clones a bank from its parent bank.
- **Description**: Use this function to create a new bank by copying data from a parent bank to a child bank. The parent bank must be frozen, and the child bank must be initialized but not yet used. This function links the child bank to its parent and copies necessary data, excluding copy-on-write (CoW) fields, which are handled separately. Ensure both banks are allocated before calling this function.
- **Inputs**:
    - `banks`: A pointer to an `fd_banks_t` structure representing the bank manager. Must not be null.
    - `child_bank_idx`: An unsigned long representing the index of the child bank in the bank pool. Must refer to an initialized bank.
    - `parent_bank_idx`: An unsigned long representing the index of the parent bank in the bank pool. Must refer to a frozen bank.
- **Output**: Returns a pointer to the cloned `fd_bank_t` structure representing the child bank.
- **See Also**: [`fd_banks_clone_from_parent`](<fd_bank.c.md#fd_banks_clone_from_parent>)  (Implementation)


---
### fd\_banks\_advance\_root<!-- {{#callable_declaration:fd_banks_advance_root}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L865>)

Advances the root bank to a specified bank index.
- **Description**: Use this function to update the root bank to a new bank specified by the given index. This operation is necessary when the current root bank is no longer needed and has no active references. The function ensures that the new root bank is a direct child of the current root bank. It prunes banks that are not direct descendants of the new root, releasing their resources back to the pool. This function must be called with a valid bank index that is a child of the current root bank.
- **Inputs**:
    - `banks`: A pointer to an `fd_banks_t` structure representing the bank manager. Must not be null and must be properly initialized.
    - `root_bank_idx`: An unsigned long integer representing the index of the new root bank. Must be a valid index of a bank that is a direct child of the current root bank.
- **Output**: Returns a pointer to the new root bank as a constant `fd_bank_t` structure.
- **See Also**: [`fd_banks_advance_root`](<fd_bank.c.md#fd_banks_advance_root>)  (Implementation)


---
### fd\_banks\_clear\_bank<!-- {{#callable_declaration:fd_banks_clear_bank}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L877>)

Clears the contents of a specified bank.
- **Description**: Use this function to reset a bank's state, ensuring it has no children and is only used in testing or fuzzing scenarios. It sets all non-CoW fields to zero and resets CoW field indices to match the parent bank. This function must be called when the bank is not in use by any other operations.
- **Inputs**:
    - `banks`: A pointer to an `fd_banks_t` structure representing the bank manager. Must not be null.
    - `bank`: A pointer to an `fd_bank_t` structure representing the bank to clear. Must not be null and must not have any child banks.
- **Output**: None
- **See Also**: [`fd_banks_clear_bank`](<fd_bank.c.md#fd_banks_clear_bank>)  (Implementation)


---
### fd\_banks\_advance\_root\_prepare<!-- {{#callable_declaration:fd_banks_advance_root_prepare}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L903>)

Determines the highest bank that can be advanced safely.
- **Description**: Use this function to find the highest bank index that can be safely advanced between the current root and a specified target bank in a fork tree. This function assumes the target bank is rooted by consensus and marks all blocks on the rooted fork as rooted, while marking minority forks as dead. It writes the highest advanceable bank index to the provided output pointer. Call this function repeatedly to advance to the target bank. It returns 1 if an advanceable block is found beyond the current root, otherwise returns 0.
- **Inputs**:
    - `banks`: A pointer to an `fd_banks_t` structure representing the bank manager. Must not be null.
    - `target_bank_idx`: An unsigned long representing the index of the target bank. Must be a valid index in the bank pool.
    - `advanceable_bank_idx_out`: A pointer to an unsigned long where the function will store the index of the highest advanceable bank. Must not be null.
- **Output**: Returns 1 if an advanceable block is found beyond the current root, otherwise returns 0.
- **See Also**: [`fd_banks_advance_root_prepare`](<fd_bank.c.md#fd_banks_advance_root_prepare>)  (Implementation)


---
### fd\_banks\_mark\_bank\_dead<!-- {{#callable_declaration:fd_banks_mark_bank_dead}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L912>)

Marks a bank and its descendants as dead.
- **Description**: Use this function to mark a specific bank and all its descendant banks as dead. This is typically done when a bank is associated with an invalid block or when it is no longer needed. Ensure that the bank is correctly handled after marking it as dead, as this function does not manage the behavior of dead banks beyond marking them.
- **Inputs**:
    - `banks`: A pointer to an `fd_banks_t` structure representing the bank manager. Must not be null. The caller retains ownership.
    - `bank`: A pointer to an `fd_bank_t` structure representing the bank to be marked as dead. Must not be null. The caller retains ownership.
- **Output**: None
- **See Also**: [`fd_banks_mark_bank_dead`](<fd_bank.c.md#fd_banks_mark_bank_dead>)  (Implementation)


---
### fd\_banks\_mark\_bank\_frozen<!-- {{#callable_declaration:fd_banks_mark_bank_frozen}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L922>)

Marks a bank as frozen and releases its cost tracker resources.
- **Description**: Use this function to mark a bank as frozen when it is no longer being updated, typically at the end of a slot. This action ensures that no further tasks are dispatched to the bank and releases the memory associated with the cost tracker, which is only needed from the start to the end of a slot. The function must be called only if the bank is not already marked as frozen, as attempting to freeze an already frozen bank will result in a critical error.
- **Inputs**:
    - `banks`: A pointer to an `fd_banks_t` structure that manages the bank states. The caller retains ownership and must ensure it is valid and properly initialized.
    - `bank`: A pointer to an `fd_bank_t` structure representing the bank to be marked as frozen. The bank must not be null and must not already be marked as frozen, as this will cause a critical error.
- **Output**: None
- **See Also**: [`fd_banks_mark_bank_frozen`](<fd_bank.c.md#fd_banks_mark_bank_frozen>)  (Implementation)


---
### fd\_banks\_new\_bank<!-- {{#callable_declaration:fd_banks_new_bank}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L933>)

Creates a new bank and links it to a parent bank.
- **Description**: Use this function to create a new bank within the bank manager and link it to an existing parent bank. This function reserves a bank index for the new bank and initializes it, but the bank is not yet replayable. Ensure that a valid parent bank exists and that there are available bank indices in the bank pool before calling this function. The function must be called with a write lock on the bank manager to ensure thread safety.
- **Inputs**:
    - `banks`: A pointer to the `fd_banks_t` structure representing the bank manager. Must not be null, and the caller retains ownership.
    - `parent_bank_idx`: The index of the parent bank in the bank pool. Must refer to a valid, initialized, and frozen parent bank.
    - `now`: A timestamp in nanoseconds representing the current time. Used to set the `first_fec_set_received_nanos` field of the new bank.
- **Output**: Returns a pointer to the newly created `fd_bank_t` structure. The bank is initialized and linked to its parent but not yet replayable.
- **See Also**: [`fd_banks_new_bank`](<fd_bank.c.md#fd_banks_new_bank>)  (Implementation)


---
### fd\_banks\_validate<!-- {{#callable_declaration:fd_banks_validate}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.h#L956>)

Validates the integrity of the bank structure.
- **Description**: Use this function to check the integrity of the `fd_banks_t` structure, ensuring that no corruption or invariant violations exist. It is important to call this function to verify that the number of elements acquired by Copy-on-Write (CoW) pools does not exceed the number of elements in the bank pool. This function is useful for maintaining the consistency and correctness of the bank's state.
- **Inputs**:
    - `banks`: A pointer to an `fd_banks_t` structure. This parameter must not be null, and the caller retains ownership. The function will handle any invalid input by returning an error code.
- **Output**: Returns 0 if the bank structure is valid and 1 if any issues are detected.
- **See Also**: [`fd_banks_validate`](<fd_bank.c.md#fd_banks_validate>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)