<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines structures and functions for capturing Solana account updates and transaction execution context.

# Purpose
The code defines a C header file that provides structures and functions for managing a capture context in a transaction execution environment. The primary structure, `fd_capture_ctx_t`, is used to maintain the context needed for capturing transaction data during execution. This includes fields for managing solcap capture, checkpointing, and various types of data capture such as instructions, transactions, blocks, syscalls, and ELF files. The context also includes a buffer for account updates, which are sent over an execution-replay link.

The file defines several constants and macros, such as `FD_CAPTURE_CTX_MAX_ACCOUNT_UPDATES` and `FD_CAPTURE_CTX_MAGIC`, which are used to configure the capture context. It also provides inline functions to calculate alignment and footprint sizes for memory management. The header declares functions for creating, joining, leaving, and deleting a capture context, as well as functions for managing transaction status locks. These functions are intended to be used in conjunction with the `fd_capture_ctx_t` structure to facilitate the capture and management of transaction-related data in a runtime environment.
# Imports and Dependencies

---
- `../../capture/fd_solcap_writer.h`
- `../fd_runtime_const.h`


# Data Structures

---
### fd\_capture\_ctx\_account\_update\_msg
- **Type**: ``struct``
- **Members**:
    - ``pubkey``: Holds the public key of the account.
    - ``info``: Contains metadata about the Solana account.
    - ``data_sz``: Specifies the size of the account data.
    - ``hash``: Stores the hash value related to the account update.
    - ``bank_idx``: Indicates the index of the bank where the account update occurred.
- **Description**: Notifies the Solcap writer of an account update from the exec tile to the replay tile. The structure is packed and includes fields for the public key, account metadata, data size, hash, and bank index. Account data follows immediately after this structure in memory.


---
### fd\_capture\_ctx\_account\_update\_msg\_t
- **Type**: ``struct fd_capture_ctx_account_update_msg``
- **Members**:
    - ``pubkey``: Holds the public key of the account being updated.
    - ``info``: Contains metadata about the Solana account.
    - ``data_sz``: Specifies the size of the account data.
    - ``hash``: Stores the hash value related to the account update.
    - ``bank_idx``: Indicates the bank index associated with the account update.
- **Description**: Notifies the Solcap writer of an account update by sending a message from the execution tile to the replay tile. The structure is packed and includes fields for the public key, account metadata, data size, hash, and bank index. Account data follows immediately after this structure in memory.


---
### fd\_capture\_ctx
- **Type**: ``struct``
- **Members**:
    - `magic`: Stores a magic number to identify the structure.
    - `solcap_start_slot`: Indicates the starting slot for Solcap.
    - `trace_dirfd`: File descriptor for trace directory.
    - `trace_mode`: Mode for tracing operations.
    - `capture`: Pointer to a `fd_solcap_writer_t` for capturing data.
    - `capture_txns`: Indicates if capturing transactions is enabled.
    - `checkpt_freq`: Frequency of checkpointing, must be a rooted slot.
    - `checkpt_path`: Path for workspace checkpoint format.
    - `checkpt_archive`: Path for Funk archive format.
    - `dump_proto_output_dir`: Directory for protobuf output.
    - `dump_proto_sig_filter`: Filter for protobuf signature.
    - `dump_proto_start_slot`: Starting slot for protobuf dump.
    - `dump_instr_to_pb`: Flag to dump instructions to protobuf.
    - `dump_txn_to_pb`: Flag to dump transactions to protobuf.
    - `dump_block_to_pb`: Flag to dump blocks to protobuf.
    - `dump_syscall_to_pb`: Flag to dump syscalls to protobuf.
    - `dump_elf_to_pb`: Flag to dump ELF files to protobuf.
    - `account_updates_buffer`: Buffer for account updates to be sent over exec_replay link.
    - `account_updates_buffer_ptr`: Pointer to the current position in the account updates buffer.
    - `account_updates_len`: Length of the account updates buffer.
- **Description**: The `fd_capture_ctx` structure is used to manage the context for capturing data during transaction execution. It includes fields for Solcap configuration, checkpointing, protobuf dumping, and various capture flags. The structure also contains a buffer for account updates, which are sent over the exec_replay link. This buffer is intended to avoid passing data into the runtime and is subject to future optimization and removal.


---
### fd\_capture\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - `magic`: A unique identifier for the context, set to `FD_CAPTURE_CTX_MAGIC`.
    - `solcap_start_slot`: The starting slot for solcap capture.
    - `trace_dirfd`: File descriptor for the trace directory.
    - `trace_mode`: Mode for tracing operations.
    - `capture`: Pointer to the `fd_solcap_writer_t` used for capturing.
    - `capture_txns`: Flag indicating if transaction capturing is enabled.
    - `checkpt_freq`: Frequency of checkpointing, must be a rooted slot.
    - `checkpt_path`: Path for workspace checkpoint format.
    - `checkpt_archive`: Path for funk archive format.
    - `dump_proto_output_dir`: Directory for dumping protobuf output.
    - `dump_proto_sig_filter`: Filter for protobuf signature dumping.
    - `dump_proto_start_slot`: Starting slot for protobuf dumping.
    - `dump_instr_to_pb`: Flag for dumping instructions to protobuf.
    - `dump_txn_to_pb`: Flag for dumping transactions to protobuf.
    - `dump_block_to_pb`: Flag for dumping blocks to protobuf.
    - `dump_syscall_to_pb`: Flag for dumping syscalls to protobuf.
    - `dump_elf_to_pb`: Flag for dumping ELF files to protobuf.
    - `account_updates_buffer`: Buffer for account updates to be sent over the exec_replay link.
    - `account_updates_buffer_ptr`: Pointer to the current position in the account updates buffer.
    - `account_updates_len`: Length of the account updates in the buffer.
- **Description**: `fd_capture_ctx_t` is a context structure used for capturing solcap data during transaction execution. It includes fields for managing solcap capture, checkpointing, protobuf dumping, and account update buffering. The structure is designed to facilitate efficient data capture and management in a runtime environment, with specific fields for controlling various aspects of the capture process, such as tracing, checkpointing, and data dumping.


# Functions

---
### fd\_capture\_ctx\_align<!-- {{#callable:fd_capture_ctx_align}} -->
[View Source →](<../../../../../../src/flamenco/runtime/context/fd_capture_ctx.h#L74>)

Calculates the alignment requirement for the `fd_capture_ctx_t` structure and related components.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `fd_ulong_max` to determine the maximum alignment requirement among `alignof(fd_capture_ctx_t)`, `fd_solcap_writer_align()`, and `FD_CAPTURE_CTX_ACCOUNT_UPDATE_BUFFER_ALIGN`.
- **Output**: Returns the maximum alignment requirement as an `ulong` value.


---
### fd\_capture\_ctx\_footprint<!-- {{#callable:fd_capture_ctx_footprint}} -->
[View Source →](<../../../../../../src/flamenco/runtime/context/fd_capture_ctx.h#L80>)

Calculates the memory footprint required for a `fd_capture_ctx_t` structure and its associated components.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize `l` with `FD_LAYOUT_INIT`.
    - Append the alignment and size of `fd_capture_ctx_t` to `l` using `FD_LAYOUT_APPEND`.
    - Append the alignment and footprint of `fd_solcap_writer_t` to `l` using `FD_LAYOUT_APPEND`.
    - Append the alignment and size of the account update buffer to `l` using `FD_LAYOUT_APPEND`.
    - Finalize the layout with `FD_LAYOUT_FINI` using the alignment of `fd_capture_ctx_t` and return the result.
- **Output**: Returns the total memory footprint as an `ulong` value.
- **Functions Called**:
    - [`fd_capture_ctx_align`](<#fd_capture_ctx_align>)


# Function Declarations (Public API)

---
### fd\_capture\_ctx\_new<!-- {{#callable_declaration:fd_capture_ctx_new}} -->
[View Source →](<../../../../../../src/flamenco/runtime/context/fd_capture_ctx.h#L91>)

Creates a new capture context in the provided memory.
- **Description**: Use this function to initialize a capture context in a pre-allocated memory region. The memory must be aligned according to the alignment requirements of the capture context. This function sets up the context for capturing transaction data and initializes internal structures. It must be called before using the context for any capture operations. If the memory is null or misaligned, the function returns null and logs a warning.
- **Inputs**:
    - `mem`: A pointer to a pre-allocated memory region where the capture context will be initialized. The memory must be aligned to the value returned by `fd_capture_ctx_align()`. The caller retains ownership of the memory. If the pointer is null or the memory is misaligned, the function returns null.
- **Output**: Returns a pointer to the initialized memory region if successful, or null if the input is invalid.
- **See Also**: [`fd_capture_ctx_new`](<fd_capture_ctx.c.md#fd_capture_ctx_new>)  (Implementation)


---
### fd\_capture\_ctx\_join<!-- {{#callable_declaration:fd_capture_ctx_join}} -->
[View Source →](<../../../../../../src/flamenco/runtime/context/fd_capture_ctx.h#L96>)

Validates and returns a capture context from a memory block.
- **Description**: Use this function to obtain a valid `fd_capture_ctx_t` pointer from a memory block that contains a capture context. The memory block must have been previously initialized with a valid capture context. This function checks if the memory block is non-null and if it contains the correct magic number to ensure it is a valid capture context. If these conditions are not met, the function returns `NULL`. This function is typically used when you need to access a capture context that has been stored in a shared memory region or similar.
- **Inputs**:
    - `mem`: A pointer to a memory block that is expected to contain a valid `fd_capture_ctx_t` structure. Must not be null. The memory block must have been initialized with a valid capture context, including the correct magic number. If the pointer is null or the magic number is incorrect, the function returns `NULL`.
- **Output**: Returns a pointer to `fd_capture_ctx_t` if the memory block is valid; otherwise, returns `NULL`.
- **See Also**: [`fd_capture_ctx_join`](<fd_capture_ctx.c.md#fd_capture_ctx_join>)  (Implementation)


---
### fd\_capture\_ctx\_leave<!-- {{#callable_declaration:fd_capture_ctx_leave}} -->
[View Source →](<../../../../../../src/flamenco/runtime/context/fd_capture_ctx.h#L99>)

Exits a capture context.
- **Description**: Use this function to exit a capture context that was previously joined. It checks if the provided context is valid by verifying that it is not null and that it has the correct magic number. If the context is invalid, it logs a warning and returns null. This function should be called when you are done with a capture context to ensure proper cleanup and resource management.
- **Inputs**:
    - `ctx`: A pointer to a `fd_capture_ctx_t` structure representing the capture context to leave. Must not be null and must have a valid magic number. If invalid, the function logs a warning and returns null.
- **Output**: Returns a pointer to the context if it is valid, otherwise returns null.
- **See Also**: [`fd_capture_ctx_leave`](<fd_capture_ctx.c.md#fd_capture_ctx_leave>)  (Implementation)


---
### fd\_capture\_ctx\_delete<!-- {{#callable_declaration:fd_capture_ctx_delete}} -->
[View Source →](<../../../../../../src/flamenco/runtime/context/fd_capture_ctx.h#L102>)

Deletes a capture context and releases associated resources.
- **Description**: Use this function to delete a capture context previously created with `fd_capture_ctx_new`. It checks if the provided memory is non-null, properly aligned, and contains a valid capture context. If any of these conditions are not met, the function logs a warning and returns `NULL`. This function also ensures that the associated solcap writer is deleted successfully. After deletion, the function sets the magic number to zero to indicate that the context is no longer valid. Call this function when you need to clean up resources associated with a capture context.
- **Inputs**:
    - `mem`: A pointer to the memory location of the capture context to delete. Must not be null, must be aligned according to `fd_capture_ctx_align`, and must contain a valid capture context with the correct magic number. If these conditions are not met, the function logs a warning and returns `NULL`.
- **Output**: Returns the original memory pointer if the deletion is successful, or `NULL` if any validation checks fail.
- **See Also**: [`fd_capture_ctx_delete`](<fd_capture_ctx.c.md#fd_capture_ctx_delete>)  (Implementation)


---
### fd\_capture\_ctx\_txn\_status\_start\_read<!-- {{#callable_declaration:fd_capture_ctx_txn_status_start_read}} -->
[View Source →](<../../../../../../src/flamenco/runtime/context/fd_capture_ctx.h#L107>)

Starts a read lock on the transaction status.
- **Description**: Use this function to begin a read operation on the transaction status, ensuring that the data remains consistent during the read. This function is typically used in a multi-threaded environment where transaction status data is shared among threads. It must be paired with a corresponding call to `fd_capture_ctx_txn_status_end_read` to release the lock after the read operation is complete.
- **Inputs**: None
- **Output**: None
- **See Also**: [`fd_capture_ctx_txn_status_start_read`](<fd_capture_ctx.c.md#fd_capture_ctx_txn_status_start_read>)  (Implementation)


---
### fd\_capture\_ctx\_txn\_status\_end\_read<!-- {{#callable_declaration:fd_capture_ctx_txn_status_end_read}} -->
[View Source →](<../../../../../../src/flamenco/runtime/context/fd_capture_ctx.h#L110>)

Ends a read operation on the transaction status lock.
- **Description**: Use this function to signal the end of a read operation on the transaction status lock. It must be called after `fd_capture_ctx_txn_status_start_read` to release the lock and allow other operations to proceed. This function is part of a locking mechanism to ensure safe concurrent access to transaction status data.
- **Inputs**: None
- **Output**: None
- **See Also**: [`fd_capture_ctx_txn_status_end_read`](<fd_capture_ctx.c.md#fd_capture_ctx_txn_status_end_read>)  (Implementation)


---
### fd\_capture\_ctx\_txn\_status\_start\_write<!-- {{#callable_declaration:fd_capture_ctx_txn_status_start_write}} -->
[View Source →](<../../../../../../src/flamenco/runtime/context/fd_capture_ctx.h#L113>)

Starts a write lock on the transaction status.
- **Description**: Use this function to begin a write operation on the transaction status. It must be called before any modifications to the transaction status to ensure thread safety. This function is part of a locking mechanism and should be paired with a corresponding unlock function to release the lock after the write operation is complete. Ensure that the lock is not already held by the current thread to avoid deadlocks.
- **Inputs**: None
- **Output**: None
- **See Also**: [`fd_capture_ctx_txn_status_start_write`](<fd_capture_ctx.c.md#fd_capture_ctx_txn_status_start_write>)  (Implementation)


---
### fd\_capture\_ctx\_txn\_status\_end\_write<!-- {{#callable_declaration:fd_capture_ctx_txn_status_end_write}} -->
[View Source →](<../../../../../../src/flamenco/runtime/context/fd_capture_ctx.h#L116>)

Releases a write lock on the transaction status.
- **Description**: Use this function to release a previously acquired write lock on the transaction status. It must be called after `fd_capture_ctx_txn_status_start_write` to ensure proper lock management. This function is essential for maintaining synchronization and preventing data races when multiple threads access the transaction status. Ensure that the write lock is held before calling this function to avoid undefined behavior.
- **Inputs**: None
- **Output**: None
- **See Also**: [`fd_capture_ctx_txn_status_end_write`](<fd_capture_ctx.c.md#fd_capture_ctx_txn_status_end_write>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)