<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements shared memory management for transaction caching, including alignment, footprint calculation, and initialization functions.

# Purpose
The code is a C source file that manages shared memory for a transaction cache system. It includes several components that work together to allocate, initialize, and manage memory structures used to store transaction data. The file defines a pool, a map, and a singly linked list (slist) to organize and access transaction data efficiently. These components are implemented using templates from external files, which are included in the code.

The primary functions in the code calculate the memory footprint required for the transaction cache, align the shared memory, and initialize the shared memory structures. The [`fd_txncache_shmem_new`](<#fd_txncache_shmem_new>) function allocates and sets up the shared memory for the transaction cache, while [`fd_txncache_shmem_join`](<#fd_txncache_shmem_join>) is used to access an existing shared memory transaction cache. The code ensures that the memory is correctly aligned and initialized, and it uses various constants and macros to manage the transaction pages and blockhashes. The functions also include error handling to ensure that the shared memory is correctly configured and aligned before use.
# Imports and Dependencies

---
- `fd_txncache_shmem.h`
- `fd_txncache_private.h`
- `../../util/tmpl/fd_pool.c`
- `../../util/tmpl/fd_map_chain.c`
- `../../util/tmpl/fd_slist.c`


# Functions

---
### fd\_txncache\_max\_txnpages\_per\_blockhash<!-- {{#callable:fd_txncache_max_txnpages_per_blockhash}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_txncache_shmem.c#L31>)

Calculates the maximum number of transaction pages needed to store all transactions associated with a single blockhash.
- **Inputs**:
    - `max_active_slots`: The maximum number of active slots that can be live at the same time.
    - `max_txn_per_slot`: The maximum number of transactions that can occur in a single slot.
- **Logic and Control Flow**:
    - Calculate `result` as `1UL + (max_txn_per_slot * max_active_slots) / FD_TXNCACHE_TXNS_PER_PAGE` to determine the number of transaction pages needed.
    - Check if `result` exceeds `USHORT_MAX` using `FD_UNLIKELY`; if true, return 0.
    - Otherwise, cast `result` to `ushort` and return it.
- **Output**: Returns the maximum number of transaction pages as a `ushort`, or 0 if the calculated number exceeds `USHORT_MAX`.


---
### fd\_txncache\_max\_txnpages<!-- {{#callable:fd_txncache_max_txnpages}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_txncache_shmem.c#L45>)

Calculates the maximum number of transaction pages needed to store all transactions in active slots, considering potential page wastage.
- **Inputs**:
    - `max_active_slots`: The maximum number of active slots that can be live at the same time.
    - `max_txn_per_slot`: The maximum number of transactions that can be stored in each slot.
- **Logic and Control Flow**:
    - Calculate the total number of transactions as `max_active_slots * max_txn_per_slot`.
    - Determine the maximum page wastage scenario where all blockhashes except one have one transaction, and the remaining blockhash has all other transactions.
    - Calculate the number of pages needed for the full blockhash as `(max_active_slots * max_txn_per_slot) / FD_TXNCACHE_TXNS_PER_PAGE`.
    - Add one page for each of the other blockhashes, resulting in `max_active_slots - 1` additional pages.
    - Compute the total number of pages as `max_active_slots - 1 + max_active_slots * (1 + (max_txn_per_slot - 1) / FD_TXNCACHE_TXNS_PER_PAGE)`.
    - Check if the result exceeds `USHORT_MAX`, and return 0 if it does.
    - Return the result cast to `ushort`.
- **Output**: The maximum number of transaction pages as a `ushort`, or 0 if the result exceeds `USHORT_MAX`.


---
### fd\_txncache\_shmem\_align<!-- {{#callable:fd_txncache_shmem_align}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_txncache_shmem.c#L69>)

Returns the alignment requirement for shared memory used by the transaction cache.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the constant `FD_TXNCACHE_SHMEM_ALIGN`.
- **Output**: The function returns an `ulong` representing the alignment requirement for shared memory.


---
### fd\_txncache\_shmem\_footprint<!-- {{#callable:fd_txncache_shmem_footprint}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_txncache_shmem.c#L74>)

Calculates the memory footprint required for a transaction cache shared memory structure based on the maximum number of live slots and transactions per slot.
- **Inputs**:
    - `max_live_slots`: The maximum number of live slots that the transaction cache can handle.
    - `max_txn_per_slot`: The maximum number of transactions that can be stored per slot.
- **Logic and Control Flow**:
    - Check if `max_live_slots` or `max_txn_per_slot` is less than 1; if so, return 0.
    - Calculate `max_active_slots` as the sum of `FD_TXNCACHE_MAX_BLOCKHASH_DISTANCE` and `max_live_slots`.
    - Calculate `blockhash_map_chains` as the next power of two greater than or equal to twice `max_active_slots`.
    - Calculate `_max_txnpages` using [`fd_txncache_max_txnpages`](<#fd_txncache_max_txnpages>); if it is 0, return 0.
    - Calculate `_max_txnpages_per_blockhash` using [`fd_txncache_max_txnpages_per_blockhash`](<#fd_txncache_max_txnpages_per_blockhash>); if it is 0, return 0.
    - Calculate `_descends_footprint` using `descends_set_footprint`; if it is 0, return 0.
    - Initialize `l` with `FD_LAYOUT_INIT`.
    - Append various memory layout components to `l` using `FD_LAYOUT_APPEND`, including alignments and sizes for `fd_txncache_shmem_t`, blockhash map, blockcache pool, and transaction pages.
    - Return the final memory layout size using `FD_LAYOUT_FINI`.
- **Output**: The function returns the calculated memory footprint as an unsigned long integer.
- **Functions Called**:
    - [`fd_txncache_max_txnpages`](<#fd_txncache_max_txnpages>)
    - [`fd_txncache_max_txnpages_per_blockhash`](<#fd_txncache_max_txnpages_per_blockhash>)


---
### fd\_txncache\_shmem\_new<!-- {{#callable:fd_txncache_shmem_new}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_txncache_shmem.c#L107>)

Initializes a new shared memory transaction cache with specified parameters and returns a pointer to it.
- **Inputs**:
    - `shmem`: Pointer to the shared memory region to initialize.
    - `max_live_slots`: Maximum number of live slots to be managed by the transaction cache.
    - `max_txn_per_slot`: Maximum number of transactions per slot.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL or misaligned; if so, log a warning and return NULL.
    - Check if `max_live_slots` or `max_txn_per_slot` is zero; if so, return NULL.
    - Calculate `max_active_slots` and `blockhash_map_chains` based on `max_live_slots`.
    - Determine `_max_txnpages` and `_max_txnpages_per_blockhash` using helper functions; return NULL if either is zero.
    - Calculate `_descends_footprint` and return NULL if it is zero.
    - Initialize scratch memory allocation with `shmem`.
    - Allocate and initialize various components of the transaction cache, including blockhash map, blockcache pool, and descends set.
    - Initialize the transaction cache structure `tc` with calculated parameters and set initial values.
    - Set up free transaction pages and initialize them.
    - Use memory fences to ensure memory operations are completed before setting the magic number.
    - Set the magic number to indicate successful initialization and return the pointer to the transaction cache.
- **Output**: Returns a pointer to the initialized `fd_txncache_shmem_t` structure, or NULL if initialization fails.
- **Functions Called**:
    - [`fd_txncache_shmem_align`](<#fd_txncache_shmem_align>)
    - [`fd_txncache_max_txnpages`](<#fd_txncache_max_txnpages>)
    - [`fd_txncache_max_txnpages_per_blockhash`](<#fd_txncache_max_txnpages_per_blockhash>)


---
### fd\_txncache\_shmem\_join<!-- {{#callable:fd_txncache_shmem_join}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_txncache_shmem.c#L178>)

Validates and joins a shared memory transaction cache structure.
- **Inputs**:
    - `shtc`: A pointer to the shared memory transaction cache structure to join.
- **Logic and Control Flow**:
    - Check if `shtc` is NULL; if true, log a warning and return NULL.
    - Check if `shtc` is aligned according to [`fd_txncache_shmem_align`](<#fd_txncache_shmem_align>); if not, log a warning and return NULL.
    - Cast `shtc` to a `fd_txncache_shmem_t` pointer and store it in `tc`.
    - Check if `tc->magic` equals `FD_TXNCACHE_SHMEM_MAGIC`; if not, log a warning and return NULL.
    - Return the `tc` pointer.
- **Output**: A pointer to the `fd_txncache_shmem_t` structure if successful, otherwise NULL.
- **Functions Called**:
    - [`fd_txncache_shmem_align`](<#fd_txncache_shmem_align>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)