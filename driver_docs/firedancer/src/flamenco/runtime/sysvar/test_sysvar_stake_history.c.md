<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for the sysvar stake history functionality, including boundary checks and update operations.

# Purpose
The code is a test suite for verifying the functionality of the stake history system variable in a financial or blockchain-related application. It includes tests to ensure that the binary encoding of the stake history matches expected sizes and alignments, as well as tests to validate the update mechanism of the stake history within a simulated bank environment. The code imports necessary headers and a binary file, `example_stake_history`, which is used as a reference for testing.

The main components of the code are the functions [`test_sysvar_stake_history_bounds`](<#test_sysvar_stake_history_bounds>) and [`test_sysvar_stake_history_update`](<#test_sysvar_stake_history_update>). The [`test_sysvar_stake_history_bounds`](<#test_sysvar_stake_history_bounds>) function checks that the size and alignment of the stake history binary data are correct. The [`test_sysvar_stake_history_update`](<#test_sysvar_stake_history_update>) function tests the update process of the stake history, ensuring that it behaves correctly under different conditions, such as when the epoch boundary is reached. The code uses a test environment to simulate bank operations and validate the stake history cache's validity. The [`test_sysvar_stake_history`](<#test_sysvar_stake_history>) function orchestrates these tests, ensuring that both boundary and update tests are executed.
# Imports and Dependencies

---
- `fd_sysvar_stake_history.h`
- `../../types/fd_types.h`
- `test_sysvar_cache_util.h`
- `../fd_bank.h`
- `../fd_system_ids.h`


# Functions

---
### test\_sysvar\_stake\_history\_bounds<!-- {{#callable:test_sysvar_stake_history_bounds}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/test_sysvar_stake_history.c#L9>)

Validates the size, footprint, and alignment of the stake history binary data against expected constants.
- **Inputs**: None
- **Logic and Control Flow**:
    - Check if `example_stake_history_sz` equals `FD_SYSVAR_STAKE_HISTORY_BINCODE_SZ` using `FD_TEST`.
    - Initialize a `fd_bincode_decode_ctx_t` structure `ctx` with `data` pointing to `example_stake_history` and `dataend` pointing to the end of the data.
    - Declare `obj_sz` and initialize it to 0.
    - Verify that `fd_stake_history_decode_footprint` returns `FD_BINCODE_SUCCESS` and updates `obj_sz` correctly using `FD_TEST`.
    - Check if `obj_sz` equals `FD_SYSVAR_STAKE_HISTORY_FOOTPRINT` using `FD_TEST`.
    - Verify that `fd_stake_history_align` returns `FD_SYSVAR_STAKE_HISTORY_ALIGN` using `FD_TEST`.
- **Output**: No output is returned; the function uses assertions to validate conditions.


---
### test\_sysvar\_stake\_history\_update<!-- {{#callable:test_sysvar_stake_history_update}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/test_sysvar_stake_history.c#L22>)

Tests the update of the sysvar stake history in a simulated environment.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for the test environment.
- **Logic and Control Flow**:
    - Create a test environment using `test_sysvar_cache_env_create` and verify the sysvar cache is initially invalid.
    - Set the rent parameters using `fd_bank_rent_set` to ensure sysvar creation is possible.
    - Define and set the epoch schedule using `fd_bank_epoch_schedule_set`.
    - Set the bank slot and parent slot to simulate a non-epoch boundary and perform a no-op update on the stake history.
    - Initialize and update the sysvar stake history with [`fd_sysvar_stake_history_init`](<fd_sysvar_stake_history.c.md#fd_sysvar_stake_history_init>) and [`fd_sysvar_stake_history_update`](<fd_sysvar_stake_history.c.md#fd_sysvar_stake_history_update>).
    - Restore the sysvar cache and verify its validity with [`fd_sysvar_cache_restore`](<fd_sysvar_cache_db.c.md#fd_sysvar_cache_restore>) and `FD_TEST`.
    - Change the bank slot and parent slot to simulate an epoch boundary and perform another update on the stake history.
    - Query the sysvar cache data and verify its size matches `FD_SYSVAR_STAKE_HISTORY_BINCODE_SZ`.
    - Destroy the test environment with [`test_sysvar_cache_env_destroy`](<test_sysvar_cache.c.md#test_sysvar_cache_env_destroy>).
- **Output**: No direct output; the function uses assertions (`FD_TEST`) to validate the correctness of the sysvar stake history update process.
- **Functions Called**:
    - [`fd_sysvar_cache_stake_history_is_valid`](<fd_sysvar_cache.h.md#fd_sysvar_cache_stake_history_is_valid>)
    - [`fd_sysvar_stake_history_init`](<fd_sysvar_stake_history.c.md#fd_sysvar_stake_history_init>)
    - [`fd_sysvar_stake_history_update`](<fd_sysvar_stake_history.c.md#fd_sysvar_stake_history_update>)
    - [`fd_sysvar_cache_restore`](<fd_sysvar_cache_db.c.md#fd_sysvar_cache_restore>)
    - [`fd_sysvar_cache_data_query`](<fd_sysvar_cache.c.md#fd_sysvar_cache_data_query>)
    - [`test_sysvar_cache_env_destroy`](<test_sysvar_cache.c.md#test_sysvar_cache_env_destroy>)


---
### test\_sysvar\_stake\_history<!-- {{#callable:test_sysvar_stake_history}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/test_sysvar_stake_history.c#L76>)

Tests the stake history system variable by verifying its bounds and updating it within a workspace.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` structure, representing the workspace where the stake history update will occur.
- **Logic and Control Flow**:
    - Calls [`test_sysvar_stake_history_bounds`](<#test_sysvar_stake_history_bounds>) to verify the size and alignment of the stake history binary code.
    - Calls [`test_sysvar_stake_history_update`](<#test_sysvar_stake_history_update>) with the provided workspace to test the update mechanism of the stake history system variable.
- **Output**: No direct output; the function performs tests and validations on the stake history system variable.
- **Functions Called**:
    - [`test_sysvar_stake_history_bounds`](<#test_sysvar_stake_history_bounds>)
    - [`test_sysvar_stake_history_update`](<#test_sysvar_stake_history_update>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)