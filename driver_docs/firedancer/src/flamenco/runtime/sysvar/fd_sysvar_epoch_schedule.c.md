<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for managing and calculating epoch schedules in a distributed system.

# Purpose
The code defines functions related to the management and manipulation of epoch schedules within a system, likely for a blockchain or distributed ledger environment. The primary data structure used is `fd_epoch_schedule_t`, which holds information about the number of slots per epoch, the offset for the leader schedule, and whether a warmup period is active. The functions provided allow for the derivation, writing, reading, and initialization of epoch schedules, as well as calculations related to slot and epoch conversions.

Key functions include [`fd_epoch_schedule_derive`](<#fd_epoch_schedule_derive>), which initializes an epoch schedule based on given parameters, and [`fd_sysvar_epoch_schedule_write`](<#fd_sysvar_epoch_schedule_write>) and [`fd_sysvar_epoch_schedule_read`](<#fd_sysvar_epoch_schedule_read>), which handle the encoding and decoding of epoch schedules to and from a system's account database. The code also includes utility functions such as [`fd_epoch_slot_cnt`](<#fd_epoch_slot_cnt>), [`fd_epoch_slot0`](<#fd_epoch_slot0>), [`fd_slot_to_epoch`](<#fd_slot_to_epoch>), and [`fd_slot_to_leader_schedule_epoch`](<#fd_slot_to_leader_schedule_epoch>), which perform calculations to determine the number of slots in an epoch, the starting slot of an epoch, and conversions between slots and epochs. These functions are essential for managing the timing and scheduling of operations within the system.
# Imports and Dependencies

---
- `fd_sysvar_epoch_schedule.h`
- `fd_sysvar.h`
- `../fd_system_ids.h`
- `../fd_acc_mgr.h`
- `../fd_txn_account.h`


# Functions

---
### fd\_epoch\_schedule\_derive<!-- {{#callable:fd_epoch_schedule_derive}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_epoch_schedule.c#L7>)

Initializes an `fd_epoch_schedule_t` structure based on the given parameters and calculates additional fields if warmup is enabled.
- **Inputs**:
    - ``schedule``: A pointer to an `fd_epoch_schedule_t` structure to initialize.
    - ``epoch_len``: The number of slots per epoch.
    - ``leader_schedule_slot_offset``: The offset for the leader schedule slot.
    - ``warmup``: A flag indicating whether to perform warmup calculations.
- **Logic and Control Flow**:
    - Check if `epoch_len` is less than `FD_EPOCH_LEN_MIN`; if true, log a warning and return `NULL`.
    - Initialize the `schedule` structure with `epoch_len`, `leader_schedule_slot_offset`, and the boolean value of `warmup`.
    - If `warmup` is true, calculate `ceil_log2_epoch` and `ceil_log2_len_min` using `fd_ulong_find_msb`.
    - Set `schedule->first_normal_epoch` to the difference between `ceil_log2_epoch` and `ceil_log2_len_min`.
    - Set `schedule->first_normal_slot` to `(1UL << ceil_log2_epoch) - FD_EPOCH_LEN_MIN`.
    - Return the initialized `schedule` structure.
- **Output**: Returns a pointer to the initialized `fd_epoch_schedule_t` structure, or `NULL` if `epoch_len` is too small.


---
### fd\_sysvar\_epoch\_schedule\_write<!-- {{#callable:fd_sysvar_epoch_schedule_write}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_epoch_schedule.c#L35>)

Writes an encoded epoch schedule to a system variable account.
- **Inputs**:
    - ``bank``: A pointer to an `fd_bank_t` structure representing the bank where the epoch schedule will be written.
    - ``accdb``: A pointer to an `fd_accdb_user_t` structure representing the account database user.
    - ``xid``: A pointer to a constant `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``capture_ctx``: A pointer to an `fd_capture_ctx_t` structure representing the capture context.
    - ``epoch_schedule``: A pointer to a constant `fd_epoch_schedule_t` structure representing the epoch schedule to be written.
- **Logic and Control Flow**:
    - Calculate the size of the encoded epoch schedule using `fd_epoch_schedule_size` and store it in `sz`.
    - Allocate a buffer `enc` of size `sz` and initialize it to zero using `memset`.
    - Create an `fd_bincode_encode_ctx_t` structure `ctx` with `data` pointing to `enc` and `dataend` pointing to the end of `enc`.
    - Encode the `epoch_schedule` into `enc` using `fd_epoch_schedule_encode` and `ctx`.
    - If encoding fails, log an error message using `FD_LOG_ERR`.
    - Call [`fd_sysvar_account_update`](<fd_sysvar.c.md#fd_sysvar_account_update>) to update the system variable account with the encoded epoch schedule.
- **Output**: No return value; the function performs an update operation.
- **Functions Called**:
    - [`fd_sysvar_account_update`](<fd_sysvar.c.md#fd_sysvar_account_update>)


---
### fd\_sysvar\_epoch\_schedule\_read<!-- {{#callable:fd_sysvar_epoch_schedule_read}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_epoch_schedule.c#L56>)

Reads the epoch schedule from a sysvar account in a read-only transaction context.
- **Inputs**:
    - ``funk``: A pointer to an `fd_funk_t` structure representing the transaction context.
    - ``xid``: A pointer to a constant `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``out``: A pointer to an `fd_epoch_schedule_t` structure where the function will store the decoded epoch schedule.
- **Logic and Control Flow**:
    - Initialize a transaction account in read-only mode using `fd_txn_account_init_from_funk_readonly` with the sysvar epoch schedule ID, `funk`, and `xid`.
    - Check if the initialization was successful; if not, return `NULL`.
    - Check if the account has zero lamports, indicating non-existence in a fuzzer environment, and return `NULL` if true.
    - Decode the epoch schedule data from the account using `fd_bincode_decode_static` and store it in `out`.
- **Output**: A pointer to the `fd_epoch_schedule_t` structure containing the decoded epoch schedule, or `NULL` if an error occurs.


---
### fd\_sysvar\_epoch\_schedule\_init<!-- {{#callable:fd_sysvar_epoch_schedule_init}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_epoch_schedule.c#L82>)

Initializes the epoch schedule for a given bank and writes it to the system variables.
- **Inputs**:
    - ``bank``: A pointer to an `fd_bank_t` structure representing the bank for which the epoch schedule is initialized.
    - ``accdb``: A pointer to an `fd_accdb_user_t` structure representing the account database user.
    - ``xid``: A pointer to a constant `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``capture_ctx``: A pointer to an `fd_capture_ctx_t` structure representing the capture context.
- **Logic and Control Flow**:
    - Query the epoch schedule from the bank using `fd_bank_epoch_schedule_query` and store the result in `epoch_schedule`.
    - Call [`fd_sysvar_epoch_schedule_write`](<#fd_sysvar_epoch_schedule_write>) with the bank, account database, transaction ID, capture context, and the queried epoch schedule to write the schedule to the system variables.
- **Output**: This function does not return a value.
- **Functions Called**:
    - [`fd_sysvar_epoch_schedule_write`](<#fd_sysvar_epoch_schedule_write>)


---
### fd\_epoch\_slot\_cnt<!-- {{#callable:fd_epoch_slot_cnt}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_epoch_schedule.c#L93>)

Calculates the number of slots in a given epoch based on the epoch schedule.
- **Inputs**:
    - ``schedule``: A pointer to a `fd_epoch_schedule_t` structure that contains the epoch schedule details.
    - ``epoch``: An unsigned long integer representing the epoch number for which the slot count is calculated.
- **Logic and Control Flow**:
    - Check if `epoch` is less than `schedule->first_normal_epoch` using `FD_UNLIKELY` macro.
    - If true, calculate `exp` by adding `epoch` to the least significant bit position of `FD_EPOCH_LEN_MIN`.
    - Return `1UL<<exp` if `exp` is less than 64, otherwise return `ULONG_MAX` to handle overflow (saturating power calculation).
    - If `epoch` is not less than `schedule->first_normal_epoch`, return `schedule->slots_per_epoch`.
- **Output**: Returns an unsigned long integer representing the number of slots in the specified epoch.


---
### fd\_epoch\_slot0<!-- {{#callable:fd_epoch_slot0}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_epoch_schedule.c#L107>)

Calculates the starting slot number for a given epoch based on the epoch schedule.
- **Inputs**:
    - ``schedule``: A pointer to a `fd_epoch_schedule_t` structure that contains the epoch schedule details.
    - ``epoch``: An unsigned long integer representing the epoch number for which the starting slot is calculated.
- **Logic and Control Flow**:
    - Check if `epoch` is less than or equal to `schedule->first_normal_epoch`.
    - If true, calculate `power` as `1UL << epoch` if `epoch` is less than 64, otherwise set `power` to `ULONG_MAX`.
    - Return the result of `fd_ulong_sat_mul(power-1UL, FD_EPOCH_LEN_MIN)`.
    - If false, calculate the difference between `epoch` and `schedule->first_normal_epoch`.
    - Multiply the result by `schedule->slots_per_epoch`.
    - Add `schedule->first_normal_slot` to the result and return it.
- **Output**: Returns an unsigned long integer representing the starting slot number for the specified epoch.


---
### fd\_slot\_to\_epoch<!-- {{#callable:fd_slot_to_epoch}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_epoch_schedule.c#L126>)

Converts a given slot number to its corresponding epoch and calculates the offset within that epoch.
- **Inputs**:
    - `schedule`: A pointer to a `fd_epoch_schedule_t` structure that contains epoch scheduling information.
    - `slot`: An unsigned long integer representing the slot number to convert to an epoch.
    - `out_offset_opt`: An optional pointer to an unsigned long integer where the function will store the offset within the epoch.
- **Logic and Control Flow**:
    - Check if `slots_per_epoch` in `schedule` is zero; if so, log a warning and return 0.
    - Initialize `epoch` and `offset` variables.
    - If `slot` is less than `first_normal_slot`, calculate `epoch` using logarithmic operations and determine `offset` based on the calculated epoch length.
    - If `slot` is greater than or equal to `first_normal_slot`, calculate `epoch` and `offset` using normal slot calculations based on `slots_per_epoch`.
    - Determine the output pointer for `offset`, using `out_offset_opt` if provided, otherwise use a dummy variable.
    - Store the calculated `offset` in the determined output pointer.
    - Return the calculated `epoch`.
- **Output**: Returns the epoch number as an unsigned long integer corresponding to the given slot.


---
### fd\_slot\_to\_leader\_schedule\_epoch<!-- {{#callable:fd_slot_to_leader_schedule_epoch}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_epoch_schedule.c#L172>)

Calculates the leader schedule epoch for a given slot based on the epoch schedule.
- **Inputs**:
    - `schedule`: A pointer to a `fd_epoch_schedule_t` structure that contains the epoch schedule details.
    - `slot`: An unsigned long integer representing the slot number for which the leader schedule epoch is to be calculated.
- **Logic and Control Flow**:
    - Check if `slot` is less than `schedule->first_normal_slot`.
    - If true, call [`fd_slot_to_epoch`](<#fd_slot_to_epoch>) with `schedule`, `slot`, and `NULL`, then add 1 to the result and return it.
    - If false, calculate `new_slots_since_first_normal_slot` as `slot - schedule->first_normal_slot`.
    - Calculate `new_first_normal_leader_schedule_slot` as `new_slots_since_first_normal_slot + schedule->leader_schedule_slot_offset`.
    - Calculate `new_epochs_since_first_normal_leader_schedule` as `new_first_normal_leader_schedule_slot / schedule->slots_per_epoch`.
    - Return `schedule->first_normal_epoch + new_epochs_since_first_normal_leader_schedule`.
- **Output**: Returns an unsigned long integer representing the leader schedule epoch for the given slot.
- **Functions Called**:
    - [`fd_slot_to_epoch`](<#fd_slot_to_epoch>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)