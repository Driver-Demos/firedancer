<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for managing and updating system variable clocks, including timestamp estimation and epoch calculations.

# Purpose
The code is a C module that manages the system variable clock for a blockchain environment. It provides functions to read, write, initialize, and update the system clock, which is crucial for maintaining the timing and scheduling of operations within the blockchain. The module includes functions such as [`fd_sysvar_clock_write`](<#fd_sysvar_clock_write>), [`fd_sysvar_clock_read`](<#fd_sysvar_clock_read>), [`fd_sysvar_clock_init`](<#fd_sysvar_clock_init>), and [`fd_sysvar_clock_update`](<#fd_sysvar_clock_update>), which handle the encoding, decoding, and updating of clock data in the system's accounts database. The clock data includes information such as the current slot, epoch, epoch start timestamp, leader schedule epoch, and Unix timestamp.

The module also includes a function [`get_timestamp_estimate`](<#get_timestamp_estimate>) that calculates a timestamp estimate based on the most recent vote states of validators, using a stake-weighted median approach. This function ensures that the timestamp is within allowable drift limits from the start of the epoch. The code uses several constants and macros to define these limits and perform calculations with nanosecond precision. The module is intended to be integrated into a larger system, as indicated by the inclusion of various header files and the use of external functions and data structures.
# Imports and Dependencies

---
- `fd_sysvar.h`
- `fd_sysvar_clock.h`
- `fd_sysvar_epoch_schedule.h`
- `../fd_runtime_stack.h`
- `../fd_acc_mgr.h`
- `../fd_system_ids.h`
- `../program/fd_program_util.h`
- `../../../util/tmpl/fd_sort.c`


# Functions

---
### unix\_timestamp\_from\_genesis<!-- {{#callable:unix_timestamp_from_genesis}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_clock.c#L50>)

Calculates the Unix timestamp from the genesis creation time and the current slot duration in a bank.
- **Inputs**:
    - ``bank``: A pointer to an `fd_bank_t` structure that contains the bank's state and data.
- **Logic and Control Flow**:
    - Retrieve the genesis creation time from the bank using `fd_bank_genesis_creation_time_get` and cast it to a `long`.
    - Retrieve the current slot from the bank using `fd_bank_slot_get` and the nanoseconds per slot using `fd_bank_ns_per_slot_get`.
    - Multiply the current slot by the nanoseconds per slot using `fd_uint128_sat_mul` and divide the result by `NS_IN_S` to convert nanoseconds to seconds.
    - Add the genesis creation time and the calculated slot duration in seconds using `fd_long_sat_add`.
    - Return the calculated Unix timestamp.
- **Output**: Returns a `long` representing the Unix timestamp calculated from the genesis creation time and the current slot duration.


---
### fd\_sysvar\_clock\_write<!-- {{#callable:fd_sysvar_clock_write}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_clock.c#L58>)

Encodes a `fd_sol_sysvar_clock_t` structure and updates the sysvar account with the encoded data.
- **Inputs**:
    - `bank`: A pointer to an `fd_bank_t` structure representing the bank context.
    - `accdb`: A pointer to an `fd_accdb_user_t` structure representing the account database user context.
    - `xid`: A pointer to a `fd_funk_txn_xid_t` structure representing the transaction ID.
    - `capture_ctx`: A pointer to an `fd_capture_ctx_t` structure representing the capture context.
    - `clock`: A pointer to an `fd_sol_sysvar_clock_t` structure representing the clock data to encode and write.
- **Logic and Control Flow**:
    - Initializes an array `enc` to hold the encoded data of size `fd_sol_sysvar_clock_t`.
    - Sets up an encoding context `ctx` with `data` pointing to `enc` and `dataend` pointing to the end of `enc`.
    - Calls `fd_sol_sysvar_clock_encode` to encode the `clock` data into `enc` using `ctx`.
    - If encoding fails, logs an error message using `FD_LOG_ERR`.
    - Calls [`fd_sysvar_account_update`](<fd_sysvar.c.md#fd_sysvar_account_update>) to update the sysvar account with the encoded data `enc`.
- **Output**: No return value; the function updates the sysvar account with the encoded clock data.
- **Functions Called**:
    - [`fd_sysvar_account_update`](<fd_sysvar.c.md#fd_sysvar_account_update>)


---
### fd\_sysvar\_clock\_read<!-- {{#callable:fd_sysvar_clock_read}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_clock.c#L77>)

Reads the system variable clock data from a transaction account and decodes it into a provided structure.
- **Inputs**:
    - ``funk``: A pointer to an `fd_funk_t` structure, representing the transaction context.
    - ``xid``: A pointer to a constant `fd_funk_txn_xid_t` structure, representing the transaction identifier.
    - ``clock``: A pointer to an `fd_sol_sysvar_clock_t` structure where the decoded clock data will be stored.
- **Logic and Control Flow**:
    - Initialize a transaction account in read-only mode using `fd_txn_account_init_from_funk_readonly` with the provided `funk` and `xid`.
    - Check if the account initialization was successful; if not, return `NULL`.
    - Check if the account has any lamports; if not, return `NULL` as the account is considered non-existent in this context.
    - Decode the account data into the `clock` structure using `fd_bincode_decode_static` and return the pointer to `clock`.
- **Output**: A pointer to the `fd_sol_sysvar_clock_t` structure containing the decoded clock data, or `NULL` if an error occurs.


---
### fd\_sysvar\_clock\_init<!-- {{#callable:fd_sysvar_clock_init}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_clock.c#L102>)

Initializes the system variable clock with the current slot and timestamp information.
- **Inputs**:
    - `bank`: A pointer to `fd_bank_t`, representing the bank context from which to retrieve slot and timestamp information.
    - `accdb`: A pointer to `fd_accdb_user_t`, representing the account database user context.
    - `xid`: A pointer to `fd_funk_txn_xid_t`, representing the transaction identifier.
    - `capture_ctx`: A pointer to `fd_capture_ctx_t`, representing the capture context for the operation.
- **Logic and Control Flow**:
    - Calculate the current timestamp using [`unix_timestamp_from_genesis`](<#unix_timestamp_from_genesis>) with the `bank` parameter.
    - Create a `fd_sol_sysvar_clock_t` structure named `clock` and initialize its fields: `slot` with the current slot from `fd_bank_slot_get`, `epoch` to 0, `epoch_start_timestamp` and `unix_timestamp` with the calculated timestamp, and `leader_schedule_epoch` to 1.
    - Call [`fd_sysvar_clock_write`](<#fd_sysvar_clock_write>) to write the initialized `clock` structure to the system variable clock using the provided `bank`, `accdb`, `xid`, and `capture_ctx`.
- **Output**: No return value; the function initializes and writes the system variable clock.
- **Functions Called**:
    - [`unix_timestamp_from_genesis`](<#unix_timestamp_from_genesis>)
    - [`fd_sysvar_clock_write`](<#fd_sysvar_clock_write>)


---
### get\_timestamp\_estimate<!-- {{#callable:get_timestamp_estimate}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_clock.c#L132>)

Calculates a stake-weighted median timestamp estimate based on recent vote states of validators.
- **Inputs**:
    - `bank`: A pointer to `fd_bank_t`, representing the bank context from which epoch schedule, slot duration, and vote states are queried.
    - `clock`: A pointer to `fd_sol_sysvar_clock_t`, representing the system clock information including the current epoch and epoch start timestamp.
    - `runtime_stack`: A pointer to `fd_runtime_stack_t`, used to store intermediate timestamp estimates and stakes.
- **Logic and Control Flow**:
    - Query the epoch schedule, slot duration, and current slot from the bank.
    - Initialize an array to store timestamp estimates and stakes, and set the total stake to zero.
    - Lock and iterate over vote states from the bank, filtering out invalid or outdated vote accounts.
    - For each valid vote account, calculate a timestamp estimate based on the last vote timestamp and slot delta, and accumulate the stake from epoch E-2.
    - Store each timestamp and its corresponding stake in the runtime stack array.
    - If no valid stakes are found, return zero as the estimate.
    - Sort the timestamp estimates by timestamp value.
    - Calculate the stake-weighted median timestamp by accumulating stakes until the total exceeds half of the total stake.
    - Determine if the estimate needs to be adjusted based on the maximum allowable drift since the start of the epoch.
    - Return the final timestamp estimate.
- **Output**: Returns a `long` integer representing the calculated timestamp estimate.
- **Functions Called**:
    - [`fd_epoch_slot0`](<fd_sysvar_epoch_schedule.c.md#fd_epoch_slot0>)


---
### fd\_sysvar\_clock\_update<!-- {{#callable:fd_sysvar_clock_update}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_clock.c#L263>)

Updates the system variable clock with the current slot, epoch, and timestamp information.
- **Inputs**:
    - ``bank``: A pointer to the `fd_bank_t` structure, which contains information about the bank state.
    - ``accdb``: A pointer to the `fd_accdb_user_t` structure, which represents the account database user.
    - ``xid``: A constant pointer to the `fd_funk_txn_xid_t` structure, which is the transaction identifier.
    - ``capture_ctx``: A pointer to the `fd_capture_ctx_t` structure, used for capturing context during the update.
    - ``runtime_stack``: A pointer to the `fd_runtime_stack_t` structure, used for runtime operations and calculations.
    - ``parent_epoch``: A constant pointer to an unsigned long integer representing the parent epoch, or NULL if not applicable.
- **Logic and Control Flow**:
    - Reads the current clock state using [`fd_sysvar_clock_read`](<#fd_sysvar_clock_read>) and checks for errors.
    - Queries the epoch schedule and retrieves the current slot and epoch.
    - Calculates a timestamp estimate using [`get_timestamp_estimate`](<#get_timestamp_estimate>) and updates the `unix_timestamp` if the estimate is valid.
    - Ensures the `unix_timestamp` is not less than the `ancestor_timestamp`.
    - Determines the `epoch_start_timestamp` based on the `parent_epoch` and current epoch.
    - Handles the special case where the current slot is 0 by setting the timestamp from genesis.
    - Updates the `clock` structure with the current slot, epoch, leader schedule epoch, and timestamps.
    - Writes the updated clock state back using [`fd_sysvar_clock_write`](<#fd_sysvar_clock_write>).
- **Output**: The function does not return a value; it updates the system variable clock state in the provided bank and account database.
- **Functions Called**:
    - [`fd_sysvar_clock_read`](<#fd_sysvar_clock_read>)
    - [`fd_slot_to_epoch`](<fd_sysvar_epoch_schedule.c.md#fd_slot_to_epoch>)
    - [`get_timestamp_estimate`](<#get_timestamp_estimate>)
    - [`unix_timestamp_from_genesis`](<#unix_timestamp_from_genesis>)
    - [`fd_slot_to_leader_schedule_epoch`](<fd_sysvar_epoch_schedule.c.md#fd_slot_to_leader_schedule_epoch>)
    - [`fd_sysvar_clock_write`](<#fd_sysvar_clock_write>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)