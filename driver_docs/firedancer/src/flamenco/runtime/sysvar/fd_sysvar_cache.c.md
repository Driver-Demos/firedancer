<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for managing and accessing a system variable cache, including creation, joining, and querying.

# Purpose
The code provides functionality for managing a system variable cache, which is a data structure used to store and retrieve system variables efficiently. The primary components include functions for creating, joining, leaving, and deleting a system variable cache, as well as querying and restoring system variable data. The code ensures memory alignment and integrity by checking for null pointers, misaligned memory, and validating a magic number that identifies a valid cache structure.

The code defines several functions that operate on a `fd_sysvar_cache_t` type, which represents the system variable cache. Functions like [`fd_sysvar_cache_new`](<#fd_sysvar_cache_new>), [`fd_sysvar_cache_join`](<#fd_sysvar_cache_join>), and [`fd_sysvar_cache_delete`](<#fd_sysvar_cache_delete>) manage the lifecycle of the cache. The code also includes macros to generate accessor functions for reading system variables stored in the cache. These accessors are used to retrieve specific system variables, such as recent block hashes, slot hashes, and stake history, by joining and leaving the cache. The code is intended to be part of a larger system where it interacts with other components through these defined interfaces.
# Imports and Dependencies

---
- `fd_sysvar_cache.h`
- `fd_sysvar_cache_private.h`
- `errno.h`


# Functions

---
### fd\_sysvar\_cache\_new<!-- {{#callable:fd_sysvar_cache_new}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_cache.c#L5>)

Initializes a new `fd_sysvar_cache_t` structure in the provided memory if it is valid and aligned.
- **Inputs**:
    - `mem`: A pointer to the memory location where the `fd_sysvar_cache_t` structure will be initialized.
- **Logic and Control Flow**:
    - Check if `mem` is NULL; if true, log a warning and return NULL.
    - Check if `mem` is aligned to the alignment requirements of `fd_sysvar_cache_t`; if not, log a warning and return NULL.
    - Cast `mem` to a `fd_sysvar_cache_t` pointer and set its `magic` field to 0.
    - Initialize the `desc` array in `sysvar_cache` to zero using `memset`.
    - Use `FD_COMPILER_MFENCE` to ensure memory operations are completed before setting `magic`.
    - Set the `magic` field of `sysvar_cache` to `FD_SYSVAR_CACHE_MAGIC`.
    - Use `FD_COMPILER_MFENCE` again to ensure the `magic` field update is visible to other threads.
    - Return the initialized `sysvar_cache` pointer.
- **Output**: A pointer to the initialized `fd_sysvar_cache_t` structure, or NULL if the input memory is invalid or misaligned.


---
### fd\_sysvar\_cache\_join<!-- {{#callable:fd_sysvar_cache_join}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_cache.c#L28>)

Casts a memory pointer to a `fd_sysvar_cache_t` pointer by calling [`fd_sysvar_cache_join_const`](<#fd_sysvar_cache_join_const>).
- **Inputs**:
    - `mem`: A pointer to memory that is expected to be aligned and contain a valid `fd_sysvar_cache_t` structure.
- **Logic and Control Flow**:
    - Calls [`fd_sysvar_cache_join_const`](<#fd_sysvar_cache_join_const>) with the `mem` argument.
    - Casts the result of [`fd_sysvar_cache_join_const`](<#fd_sysvar_cache_join_const>) to a non-const `fd_sysvar_cache_t` pointer.
    - Returns the casted pointer.
- **Output**: A pointer to `fd_sysvar_cache_t` if successful, otherwise `NULL` if [`fd_sysvar_cache_join_const`](<#fd_sysvar_cache_join_const>) fails.
- **Functions Called**:
    - [`fd_sysvar_cache_join_const`](<#fd_sysvar_cache_join_const>)


---
### fd\_sysvar\_cache\_join\_const<!-- {{#callable:fd_sysvar_cache_join_const}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_cache.c#L34>)

Validates and returns a constant pointer to a `fd_sysvar_cache_t` structure if the input memory is non-null, properly aligned, and contains the correct magic number.
- **Inputs**:
    - `mem`: A constant pointer to memory that is expected to contain a `fd_sysvar_cache_t` structure.
- **Logic and Control Flow**:
    - Check if `mem` is NULL; if true, log a warning and return NULL.
    - Check if `mem` is aligned to the alignment requirements of `fd_sysvar_cache_t`; if not, log a warning and return NULL.
    - Cast `mem` to a `fd_sysvar_cache_t` constant pointer and store it in `sysvar_cache`.
    - Check if the `magic` field of `sysvar_cache` matches `FD_SYSVAR_CACHE_MAGIC`; if not, log a warning and return NULL.
    - Return the `sysvar_cache` pointer.
- **Output**: A constant pointer to a `fd_sysvar_cache_t` structure if all checks pass, otherwise NULL.


---
### fd\_sysvar\_cache\_leave<!-- {{#callable:fd_sysvar_cache_leave}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_cache.c#L54>)

Returns the input `fd_sysvar_cache_t` pointer without modification.
- **Inputs**:
    - `sysvar_cache`: A pointer to an `fd_sysvar_cache_t` structure.
- **Logic and Control Flow**:
    - The function takes a single argument, `sysvar_cache`, which is a pointer to an `fd_sysvar_cache_t` structure.
    - The function returns the `sysvar_cache` pointer without performing any operations on it.
- **Output**: The function returns the same `fd_sysvar_cache_t` pointer that it receives as input.


---
### fd\_sysvar\_cache\_leave\_const<!-- {{#callable:fd_sysvar_cache_leave_const}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_cache.c#L59>)

Returns a constant pointer to the given `fd_sysvar_cache_t` object.
- **Inputs**:
    - `sysvar_cache`: A constant pointer to an `fd_sysvar_cache_t` object.
- **Logic and Control Flow**:
    - Return the input `sysvar_cache` as a constant pointer.
- **Output**: A constant pointer to the `fd_sysvar_cache_t` object provided as input.


---
### fd\_sysvar\_cache\_delete<!-- {{#callable:fd_sysvar_cache_delete}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_cache.c#L64>)

Deletes a system variable cache by clearing its memory and validating its magic number.
- **Inputs**:
    - `mem`: A pointer to the memory location of the system variable cache to delete.
- **Logic and Control Flow**:
    - Check if `mem` is NULL; if true, log a warning and return NULL.
    - Cast `mem` to a `fd_sysvar_cache_t` pointer named `sysvar_cache`.
    - Check if `sysvar_cache->magic` is not equal to `FD_SYSVAR_CACHE_MAGIC`; if true, log a warning and return NULL.
    - Clear the memory of `sysvar_cache` using `memset` to set all bytes to zero.
    - Return the original `mem` pointer.
- **Output**: Returns the original memory pointer if successful, or NULL if an error occurs.


---
### fd\_sysvar\_cache\_data\_query<!-- {{#callable:fd_sysvar_cache_data_query}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_cache.c#L82>)

Queries the system variable cache for data associated with a given address and updates the size of the data if valid.
- **Inputs**:
    - `sysvar_cache`: A pointer to a constant `fd_sysvar_cache_t` structure representing the system variable cache.
    - `address`: A constant pointer to a 32-byte address used to identify the system variable.
    - `psz`: A pointer to an unsigned long where the function will store the size of the data if found and valid.
- **Logic and Control Flow**:
    - Initialize `*psz` to 0.
    - Load the public key from the given `address` using `FD_LOAD`.
    - Query the system variable map with the public key using `sysvar_map_query`.
    - If the query returns `NULL`, indicating the address is not a system variable, return `NULL`.
    - Retrieve the system variable description and position using the index from the query result.
    - Check if the system variable data is valid by examining the `flags` field in the description.
    - If the data is not valid, return `NULL`.
    - Update `*psz` with the size of the data from the description.
    - Return a pointer to the data in the cache, offset by the data offset from the position.
- **Output**: A constant pointer to an unsigned character array representing the data associated with the address, or `NULL` if the address is not a valid system variable or the data is invalid.


---
### fd\_sysvar\_cache\_recent\_hashes\_join\_const<!-- {{#callable:fd_sysvar_cache_recent_hashes_join_const}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_cache.c#L119>)

Returns a constant pointer to a deque of recent block hash entries if the cache is valid.
- **Inputs**:
    - `cache`: A constant pointer to an `fd_sysvar_cache_t` structure, which contains the system variable cache.
- **Logic and Control Flow**:
    - Check if the cache is valid using [`fd_sysvar_cache_recent_hashes_is_valid`](<fd_sysvar_cache.h.md#fd_sysvar_cache_recent_hashes_is_valid>); return `NULL` if not valid.
    - Cast `cache->obj_recent_hashes` to a `fd_recent_block_hashes_global_t` pointer and store it in `var`.
    - Calculate the address of the deque by adding `var->hashes_offset` to `var` and join it using `deq_fd_block_block_hash_entry_t_join`.
    - If the join operation fails, log a critical error indicating corruption in the recent blockhashes sysvar.
    - Return the deque pointer, demoted to a constant pointer.
- **Output**: A constant pointer to an `fd_block_block_hash_entry_t` deque, or `NULL` if the cache is invalid or corruption is detected.
- **Functions Called**:
    - [`fd_sysvar_cache_recent_hashes_is_valid`](<fd_sysvar_cache.h.md#fd_sysvar_cache_recent_hashes_is_valid>)


---
### fd\_sysvar\_cache\_recent\_hashes\_leave\_const<!-- {{#callable:fd_sysvar_cache_recent_hashes_leave_const}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_cache.c#L130>)

Does nothing with the provided `sysvar_cache` and `hashes_deque` arguments.
- **Inputs**:
    - `sysvar_cache`: A pointer to a constant `fd_sysvar_cache_t` structure, which is not used in the function.
    - `hashes_deque`: A pointer to a constant `fd_block_block_hash_entry_t` structure, which is not used in the function.
- **Logic and Control Flow**:
    - The function takes two arguments, `sysvar_cache` and `hashes_deque`, both of which are marked as unused with `(void)` casts.
    - No operations or logic are performed within the function body.
- **Output**: No output is produced as the function body is empty.


---
### fd\_sysvar\_cache\_slot\_hashes\_join\_const<!-- {{#callable:fd_sysvar_cache_slot_hashes_join_const}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_cache.c#L138>)

Joins a slot hashes sysvar from the cache and returns a constant pointer to it.
- **Inputs**:
    - `cache`: A constant pointer to an `fd_sysvar_cache_t` structure representing the sysvar cache.
- **Logic and Control Flow**:
    - Check if the slot hashes sysvar in the cache is valid using [`fd_sysvar_cache_slot_hashes_is_valid`](<fd_sysvar_cache.h.md#fd_sysvar_cache_slot_hashes_is_valid>).
    - If the sysvar is not valid, return `NULL`.
    - Cast `cache->obj_slot_hashes` to a `fd_slot_hashes_global_t` pointer and store it in `var`.
    - Join the slot hashes deque using `deq_fd_slot_hash_t_join` with the offset from `var->hashes_offset`.
    - If the join operation fails, log a critical error indicating sysvar corruption.
    - Return the joined deque, demoted to a constant pointer.
- **Output**: A constant pointer to an `fd_slot_hash_t` structure representing the joined slot hashes deque, or `NULL` if the sysvar is invalid.
- **Functions Called**:
    - [`fd_sysvar_cache_slot_hashes_is_valid`](<fd_sysvar_cache.h.md#fd_sysvar_cache_slot_hashes_is_valid>)


---
### fd\_sysvar\_cache\_slot\_hashes\_leave\_const<!-- {{#callable:fd_sysvar_cache_slot_hashes_leave_const}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_cache.c#L150>)

Does nothing with the provided `sysvar_cache` and `slot_hashes` arguments.
- **Inputs**:
    - `sysvar_cache`: A pointer to a constant `fd_sysvar_cache_t` structure.
    - `slot_hashes`: A pointer to a constant `fd_slot_hash_t` structure.
- **Logic and Control Flow**:
    - The function takes two arguments, `sysvar_cache` and `slot_hashes`, and explicitly does nothing with them by casting them to void.
- **Output**: No output or return value; the function is a no-op.


---
### fd\_sysvar\_cache\_slot\_history\_join\_const<!-- {{#callable:fd_sysvar_cache_slot_history_join_const}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_cache.c#L158>)

Returns a constant pointer to the slot history object in the cache if the cache is valid.
- **Inputs**:
    - `cache`: A constant pointer to a `fd_sysvar_cache_t` structure, which contains the slot history object to be accessed.
- **Logic and Control Flow**:
    - Check if the slot history in the `cache` is valid using [`fd_sysvar_cache_slot_history_is_valid`](<fd_sysvar_cache.h.md#fd_sysvar_cache_slot_history_is_valid>) function.
    - If the slot history is not valid, return `NULL`.
    - If the slot history is valid, return a constant pointer to the `obj_slot_history` member of the `cache`.
- **Output**: A constant pointer to `fd_slot_history_global_t` if the cache is valid, otherwise `NULL`.
- **Functions Called**:
    - [`fd_sysvar_cache_slot_history_is_valid`](<fd_sysvar_cache.h.md#fd_sysvar_cache_slot_history_is_valid>)


---
### fd\_sysvar\_cache\_slot\_history\_leave\_const<!-- {{#callable:fd_sysvar_cache_slot_history_leave_const}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_cache.c#L166>)

Does nothing with the provided `sysvar_cache` and `slot_history` arguments.
- **Inputs**:
    - `sysvar_cache`: A pointer to a constant `fd_sysvar_cache_t` structure.
    - `slot_history`: A pointer to a constant `fd_slot_history_global_t` structure.
- **Logic and Control Flow**:
    - The function takes two constant pointers as arguments: `sysvar_cache` and `slot_history`.
    - Both arguments are cast to void to indicate they are unused within the function body.
- **Output**: No output is produced as the function does not perform any operations.


---
### fd\_sysvar\_cache\_stake\_history\_join\_const<!-- {{#callable:fd_sysvar_cache_stake_history_join_const}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_cache.c#L174>)

Returns a constant pointer to the stake history object from the system variable cache if it is valid.
- **Inputs**:
    - `cache`: A constant pointer to an `fd_sysvar_cache_t` structure, which contains system variable data.
- **Logic and Control Flow**:
    - Check if the stake history in the `cache` is valid using [`fd_sysvar_cache_stake_history_is_valid`](<fd_sysvar_cache.h.md#fd_sysvar_cache_stake_history_is_valid>) function.
    - If the stake history is not valid, return `NULL`.
    - If the stake history is valid, return a constant pointer to the `obj_stake_history` member of the `cache`.
- **Output**: A constant pointer to an `fd_stake_history_t` structure if the stake history is valid, otherwise `NULL`.
- **Functions Called**:
    - [`fd_sysvar_cache_stake_history_is_valid`](<fd_sysvar_cache.h.md#fd_sysvar_cache_stake_history_is_valid>)


---
### fd\_sysvar\_cache\_stake\_history\_leave\_const<!-- {{#callable:fd_sysvar_cache_stake_history_leave_const}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_cache.c#L182>)

Does nothing with the provided `sysvar_cache` and `stake_history` pointers.
- **Inputs**:
    - `sysvar_cache`: A pointer to a constant `fd_sysvar_cache_t` structure.
    - `stake_history`: A pointer to a constant `fd_stake_history_t` structure.
- **Logic and Control Flow**:
    - The function takes two constant pointers as arguments: `sysvar_cache` and `stake_history`.
    - Both pointers are cast to void to indicate that they are unused within the function body.
- **Output**: No output is produced as the function does not perform any operations.


---
### fd\_sysvar\_obj\_restore<!-- {{#callable:fd_sysvar_obj_restore}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_cache.c#L190>)

Restores a system variable object from a cache, handling both direct storage and deserialization cases.
- **Inputs**:
    - `cache`: A pointer to the `fd_sysvar_cache_t` structure where the system variable data is stored.
    - `desc`: A pointer to the `fd_sysvar_desc_t` structure that describes the system variable.
    - `pos`: A constant pointer to the `fd_sysvar_pos_t` structure that provides position and decoding information for the system variable.
- **Logic and Control Flow**:
    - Clear the `FD_SYSVAR_FLAG_VALID` flag in `desc->flags` to mark the system variable as invalid initially.
    - Calculate the data pointer and size from the cache and position offset.
    - Check if `pos->obj_max` is zero, indicating direct storage without deserialization; if so, set the `FD_SYSVAR_FLAG_VALID` flag and log the restoration.
    - Initialize a decoding context `ctx` with the data and its end pointer.
    - Attempt to decode the footprint of the object using `pos->decode_footprint`; if it fails, log the failure and return `EINVAL`.
    - Check if the decoded object size `obj_sz` exceeds `pos->obj_max`; if so, log a warning and return `ENOMEM`.
    - Decode the object into the cache at the specified offset using `pos->decode`.
    - Set the `FD_SYSVAR_FLAG_VALID` flag in `desc->flags` to mark the system variable as valid.
    - Log the successful restoration of the system variable.
- **Output**: Returns 0 on success, `EINVAL` if decoding fails, or `ENOMEM` if the object size exceeds the maximum allowed size.



---
Made with ❤️ by [Driver](https://www.driver.ai/)