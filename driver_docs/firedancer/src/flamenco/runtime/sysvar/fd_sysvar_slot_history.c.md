<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Manages slot history for a system, including setting, writing, updating, reading, and finding slots.

# Purpose
The code is a C implementation for managing a slot history system, which is part of a larger system likely related to blockchain or distributed ledger technology. It provides functionality to initialize, update, write, and read slot history data. The slot history tracks the presence of slots over time, using a bit vector to efficiently store and manage slot information. The code includes several functions such as [`fd_sysvar_slot_history_set`](<#fd_sysvar_slot_history_set>), [`fd_sysvar_slot_history_write_history`](<#fd_sysvar_slot_history_write_history>), [`fd_sysvar_slot_history_init`](<#fd_sysvar_slot_history_init>), [`fd_sysvar_slot_history_update`](<#fd_sysvar_slot_history_update>), [`fd_sysvar_slot_history_read`](<#fd_sysvar_slot_history_read>), and [`fd_sysvar_slot_history_find_slot`](<#fd_sysvar_slot_history_find_slot>), each serving specific roles in managing the slot history.

The code defines constants for managing the size and structure of the slot history, such as `FD_SLOT_HISTORY_MIN_ACCOUNT_SIZE`, `FD_SLOT_HISTORY_DECODED_SIZE`, and `FD_SLOT_HISTORY_MAX_ENTRIES`. It uses these constants to allocate memory and manage the bit vector that represents the slot history. The functions interact with other components like `fd_bank_t`, `fd_accdb_user_t`, and `fd_funk_txn_xid_t`, indicating integration with a broader system for account and transaction management. The code also includes error handling and logging to manage potential issues during execution. The slot history system is designed to be part of a larger application, possibly related to the Solana blockchain, as indicated by the comments referencing Solana's GitHub repository.
# Imports and Dependencies

---
- `fd_sysvar_slot_history.h`
- `fd_sysvar.h`
- `fd_sysvar_rent.h`
- `../fd_system_ids.h`
- `../fd_txn_account.h`
- `../../../funk/fd_funk_txn.h`


# Functions

---
### fd\_sysvar\_slot\_history\_set<!-- {{#callable:fd_sysvar_slot_history_set}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_slot_history.c#L22>)

Updates the slot history by marking a specific slot as present and clearing skipped slots.
- **Inputs**:
    - ``history``: A pointer to a `fd_slot_history_global_t` structure that contains the slot history data.
    - ``i``: An unsigned long integer representing the slot index to set in the history.
- **Logic and Control Flow**:
    - Check if the slot index `i` is out of bounds by comparing it with `history->next_slot` and `FD_SLOT_HISTORY_MAX_ENTRIES`; if out of bounds, log a warning and return.
    - Calculate the pointer to the blocks of the bit vector using `history->bits_bitvec_offset` and determine the length of the blocks using `history->bits_bitvec_len`.
    - If `blocks_len` is zero, return immediately as there are no blocks to update.
    - Iterate over the range from `history->next_slot` to `i`, and for each skipped slot, clear the corresponding bit in the bit vector to remove it from the history.
    - Set the bit corresponding to the slot index `i` in the bit vector to mark it as present.
- **Output**: No output is returned; the function modifies the slot history in place.


---
### fd\_sysvar\_slot\_history\_write\_history<!-- {{#callable:fd_sysvar_slot_history_write_history}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_slot_history.c#L44>)

Writes the encoded slot history to the sysvar account.
- **Inputs**:
    - ``bank``: Pointer to the `fd_bank_t` structure representing the bank.
    - ``accdb``: Pointer to the `fd_accdb_user_t` structure representing the account database user.
    - ``xid``: Pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``capture_ctx``: Pointer to the `fd_capture_ctx_t` structure representing the capture context.
    - ``history``: Pointer to the `fd_slot_history_global_t` structure representing the slot history to encode and write.
- **Logic and Control Flow**:
    - Initialize a memory buffer `slot_history_mem` aligned to `FD_SLOT_HISTORY_GLOBAL_ALIGN` and sized to `FD_SLOT_HISTORY_MIN_ACCOUNT_SIZE`.
    - Set up a `fd_bincode_encode_ctx_t` context `ctx` with `data` pointing to `slot_history_mem` and `dataend` pointing to the end of `slot_history_mem`.
    - Call `fd_slot_history_encode_global` to encode the `history` into the `ctx` context.
    - Check if the encoding was successful; if not, log an error and terminate.
    - Call [`fd_sysvar_account_update`](<fd_sysvar.c.md#fd_sysvar_account_update>) to update the sysvar account with the encoded slot history data.
- **Output**: No return value; the function updates the sysvar account with the encoded slot history.
- **Functions Called**:
    - [`fd_sysvar_account_update`](<fd_sysvar.c.md#fd_sysvar_account_update>)


---
### fd\_sysvar\_slot\_history\_init<!-- {{#callable:fd_sysvar_slot_history_init}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_slot_history.c#L62>)

Initializes a new slot history instance and writes it to the system.
- **Inputs**:
    - ``bank``: A pointer to an `fd_bank_t` structure representing the bank context.
    - ``accdb``: A pointer to an `fd_accdb_user_t` structure representing the account database user context.
    - ``xid``: A pointer to a constant `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``capture_ctx``: A pointer to an `fd_capture_ctx_t` structure representing the capture context.
- **Logic and Control Flow**:
    - Allocate memory for a slot history object aligned to `FD_SLOT_HISTORY_GLOBAL_ALIGN` and initialize it to zero.
    - Cast the allocated memory to a `fd_slot_history_global_t` pointer and calculate the aligned address for the blocks array.
    - Set the `next_slot` to the current bank slot plus one.
    - Calculate and set the `bits_bitvec_offset`, `bits_len`, `bits_bitvec_len`, and `has_bits` fields of the slot history object.
    - Call [`fd_sysvar_slot_history_set`](<#fd_sysvar_slot_history_set>) to set the current bank slot in the slot history.
    - Call [`fd_sysvar_slot_history_write_history`](<#fd_sysvar_slot_history_write_history>) to write the initialized slot history to the system.
- **Output**: No return value; the function operates by side effects on the provided contexts and writes the slot history to the system.
- **Functions Called**:
    - [`fd_sysvar_slot_history_set`](<#fd_sysvar_slot_history_set>)
    - [`fd_sysvar_slot_history_write_history`](<#fd_sysvar_slot_history_write_history>)


---
### fd\_sysvar\_slot\_history\_update<!-- {{#callable:fd_sysvar_slot_history_update}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_slot_history.c#L86>)

Updates the slot history in the system variables by setting the current slot and updating the next slot.
- **Inputs**:
    - `bank`: A pointer to `fd_bank_t`, representing the bank context.
    - `accdb`: A pointer to `fd_accdb_user_t`, representing the account database user context.
    - `xid`: A pointer to `fd_funk_txn_xid_t`, representing the transaction ID.
    - `capture_ctx`: A pointer to `fd_capture_ctx_t`, representing the capture context.
- **Logic and Control Flow**:
    - Initialize a `fd_pubkey_t` pointer `key` to the system variable slot history ID.
    - Initialize a `fd_txn_account_t` array `rec` and call `fd_txn_account_init_from_funk_readonly` to initialize it with the slot history data from the account database using the transaction ID `xid`.
    - Check for errors in the initialization and log a critical error if it fails.
    - Set up a `fd_bincode_decode_ctx_t` structure `ctx` to decode the slot history data from the transaction account.
    - Allocate memory for `slot_history_mem` and decode the global slot history into `history` using `fd_slot_history_decode_global`.
    - Call [`fd_sysvar_slot_history_set`](<#fd_sysvar_slot_history_set>) to update the slot history with the current slot from the bank.
    - Update `history->next_slot` to the next slot value by incrementing the current slot by one.
    - Write the updated slot history back to the system variables using [`fd_sysvar_slot_history_write_history`](<#fd_sysvar_slot_history_write_history>).
    - Return 0 to indicate successful completion.
- **Output**: Returns 0 to indicate successful completion of the slot history update.
- **Functions Called**:
    - [`fd_sysvar_slot_history_set`](<#fd_sysvar_slot_history_set>)
    - [`fd_sysvar_slot_history_write_history`](<#fd_sysvar_slot_history_write_history>)


---
### fd\_sysvar\_slot\_history\_read<!-- {{#callable:fd_sysvar_slot_history_read}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_slot_history.c#L115>)

Reads and decodes the slot history sysvar from a transaction account.
- **Inputs**:
    - ``funk``: A pointer to an `fd_funk_t` structure representing the transaction context.
    - ``xid``: A constant pointer to an `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``out_mem``: A memory buffer with a size of `FD_SYSVAR_SLOT_HISTORY_FOOTPRINT` to store the decoded slot history.
- **Logic and Control Flow**:
    - Initialize a `fd_pubkey_t` pointer to the slot history sysvar ID.
    - Initialize a `fd_txn_account_t` record and attempt to read the account data using `fd_txn_account_init_from_funk_readonly`.
    - If the account initialization fails, log a critical error and exit.
    - Check if the account has zero lamports; if true, return `NULL` as the account does not exist.
    - Retrieve the data length of the account and check if it exceeds `FD_SYSVAR_SLOT_HISTORY_BINCODE_SZ`; if true, log an error and exit.
    - Initialize a `fd_bincode_decode_ctx_t` structure with the account data and its end pointer.
    - Decode the slot history using `fd_slot_history_decode_global` and return the result.
- **Output**: A pointer to an `fd_slot_history_global_t` structure containing the decoded slot history, or `NULL` if the account does not exist.


---
### fd\_sysvar\_slot\_history\_find\_slot<!-- {{#callable:fd_sysvar_slot_history_find_slot}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_slot_history.c#L150>)

Finds the status of a given slot in the slot history.
- **Inputs**:
    - ``history``: A pointer to a `fd_slot_history_global_t` structure that contains the slot history data.
    - ``slot``: An unsigned long integer representing the slot number to find in the history.
- **Logic and Control Flow**:
    - Calculate the pointer to the blocks array using the `bits_bitvec_offset` from the `history` structure.
    - Check if the `blocks` pointer is NULL and log an error if it is.
    - Retrieve the length of the blocks array from `history->bits_bitvec_len`.
    - Check if the `slot` is greater than the last recorded slot (`history->next_slot - 1`). If true, return `FD_SLOT_HISTORY_SLOT_FUTURE`.
    - Check if the `slot` is less than the oldest slot in history (`history->next_slot - FD_SLOT_HISTORY_MAX_ENTRIES`). If true, return `FD_SLOT_HISTORY_SLOT_TOO_OLD`.
    - Calculate the index of the block that might contain the `slot` using `(slot / FD_SLOT_HISTORY_BITS_PER_BLOCK) % blocks_len`.
    - Check if the bit corresponding to the `slot` is set in the calculated block. If set, return `FD_SLOT_HISTORY_SLOT_FOUND`; otherwise, return `FD_SLOT_HISTORY_SLOT_NOT_FOUND`.
- **Output**: An integer indicating the status of the slot: `FD_SLOT_HISTORY_SLOT_FUTURE`, `FD_SLOT_HISTORY_SLOT_TOO_OLD`, `FD_SLOT_HISTORY_SLOT_FOUND`, or `FD_SLOT_HISTORY_SLOT_NOT_FOUND`.



---
Made with ❤️ by [Driver](https://www.driver.ai/)