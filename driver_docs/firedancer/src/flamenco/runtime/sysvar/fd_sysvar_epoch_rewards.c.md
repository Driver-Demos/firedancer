<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Manages epoch rewards sysvar operations, including initialization, reading, writing, and distribution.

# Purpose
The code manages the epoch rewards system variable in a financial or blockchain context. It provides functions to initialize, read, update, and deactivate the epoch rewards data structure. The primary components include functions such as [`fd_sysvar_epoch_rewards_init`](<#fd_sysvar_epoch_rewards_init>), [`fd_sysvar_epoch_rewards_read`](<#fd_sysvar_epoch_rewards_read>), [`fd_sysvar_epoch_rewards_distribute`](<#fd_sysvar_epoch_rewards_distribute>), and [`fd_sysvar_epoch_rewards_set_inactive`](<#fd_sysvar_epoch_rewards_set_inactive>). These functions interact with a database of accounts and transactions, using identifiers and contexts to manage the state of epoch rewards. The code ensures that the rewards are correctly distributed and updated in the system, handling potential errors and overflow conditions.

The code is part of a larger system, as indicated by the inclusion of headers like `fd_sysvar_epoch_rewards.h` and `fd_sysvar.h`, and it interacts with other components such as `fd_bank_t`, `fd_accdb_user_t`, and `fd_funk_txn_xid_t`. The functions use encoding and decoding mechanisms to manage the data, ensuring that the epoch rewards are accurately represented and stored. The code is designed to handle multiple updates within a single slot, maintaining the cache's consistency. This module is likely intended to be part of a library or system that manages financial transactions or blockchain operations, providing a specific functionality related to epoch rewards.
# Imports and Dependencies

---
- `fd_sysvar_epoch_rewards.h`
- `fd_sysvar.h`
- `../fd_acc_mgr.h`
- `../fd_txn_account.h`
- `../fd_system_ids.h`


# Functions

---
### write\_epoch\_rewards<!-- {{#callable:write_epoch_rewards}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_epoch_rewards.c#L7>)

Encodes and updates epoch rewards data in the system's account database.
- **Inputs**:
    - `bank`: A pointer to the `fd_bank_t` structure representing the bank where the account update will occur.
    - `accdb`: A pointer to the `fd_accdb_user_t` structure representing the account database user.
    - `xid`: A pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID.
    - `capture_ctx`: A pointer to the `fd_capture_ctx_t` structure used for capturing context during the update.
    - `epoch_rewards`: A pointer to the `fd_sysvar_epoch_rewards_t` structure containing the epoch rewards data to encode and update.
- **Logic and Control Flow**:
    - Calculate the size of the encoded epoch rewards using `fd_sysvar_epoch_rewards_size` and store it in `sz`.
    - Initialize an array `enc` of size `sz` and set all its elements to zero using `fd_memset`.
    - Create a `fd_bincode_encode_ctx_t` structure `ctx` with `data` pointing to `enc` and `dataend` pointing to the end of `enc`.
    - Encode the `epoch_rewards` data into `enc` using `fd_sysvar_epoch_rewards_encode`. If encoding fails, log an error and exit.
    - Update the system's account database with the encoded epoch rewards data using [`fd_sysvar_account_update`](<fd_sysvar.c.md#fd_sysvar_account_update>).
- **Output**: No return value; the function updates the system's account database with the encoded epoch rewards data.
- **Functions Called**:
    - [`fd_sysvar_account_update`](<fd_sysvar.c.md#fd_sysvar_account_update>)


---
### fd\_sysvar\_epoch\_rewards\_read<!-- {{#callable:fd_sysvar_epoch_rewards_read}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_epoch_rewards.c#L27>)

Reads the epoch rewards sysvar from a transaction account and decodes it into a provided output structure.
- **Inputs**:
    - ``funk``: A pointer to an `fd_funk_t` structure representing the transaction context.
    - ``xid``: A pointer to a constant `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``out``: A pointer to an `fd_sysvar_epoch_rewards_t` structure where the decoded epoch rewards will be stored.
- **Logic and Control Flow**:
    - Initialize a transaction account in read-only mode using `fd_txn_account_init_from_funk_readonly` with the provided `funk` and `xid`.
    - Check if the initialization was successful; if not, return `NULL`.
    - Check if the account has any lamports using `fd_txn_account_get_lamports`; if it has zero lamports, return `NULL`.
    - Decode the sysvar epoch rewards data from the account using `fd_bincode_decode_static` and store it in the `out` structure.
- **Output**: Returns a pointer to the `fd_sysvar_epoch_rewards_t` structure containing the decoded epoch rewards, or `NULL` if an error occurs.


---
### fd\_sysvar\_epoch\_rewards\_distribute<!-- {{#callable:fd_sysvar_epoch_rewards_distribute}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_epoch_rewards.c#L55>)

Distributes a specified amount of rewards for the current epoch and updates the system variables accordingly.
- **Inputs**:
    - ``bank``: A pointer to the `fd_bank_t` structure representing the bank where the rewards distribution will be recorded.
    - ``accdb``: A pointer to the `fd_accdb_user_t` structure representing the account database user context.
    - ``xid``: A constant pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID for the operation.
    - ``capture_ctx``: A pointer to the `fd_capture_ctx_t` structure used for capturing the context of the operation.
    - ``distributed``: An unsigned long integer representing the amount of rewards to distribute.
- **Logic and Control Flow**:
    - Initialize a `fd_sysvar_epoch_rewards_t` structure to store epoch rewards data.
    - Attempt to read the current epoch rewards using [`fd_sysvar_epoch_rewards_read`](<#fd_sysvar_epoch_rewards_read>); log an error if it fails.
    - Check if the epoch rewards are active; log an error if not active.
    - Check if adding the distributed rewards would exceed the total rewards using `fd_ulong_sat_add`; log an error if it would overflow.
    - Add the distributed rewards to the current distributed rewards.
    - Call [`write_epoch_rewards`](<#write_epoch_rewards>) to update the epoch rewards in the system.
- **Output**: No return value; the function updates the system state by modifying the epoch rewards.
- **Functions Called**:
    - [`fd_sysvar_epoch_rewards_read`](<#fd_sysvar_epoch_rewards_read>)
    - [`write_epoch_rewards`](<#write_epoch_rewards>)


---
### fd\_sysvar\_epoch\_rewards\_set\_inactive<!-- {{#callable:fd_sysvar_epoch_rewards_set_inactive}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_epoch_rewards.c#L79>)

Sets the `active` status of epoch rewards to inactive and updates the system with this change.
- **Inputs**:
    - `bank`: A pointer to `fd_bank_t`, representing the bank where the epoch rewards are managed.
    - `accdb`: A pointer to `fd_accdb_user_t`, representing the account database user context.
    - `xid`: A constant pointer to `fd_funk_txn_xid_t`, representing the transaction ID for the operation.
    - `capture_ctx`: A pointer to `fd_capture_ctx_t`, representing the capture context for the operation.
- **Logic and Control Flow**:
    - Reads the current epoch rewards using [`fd_sysvar_epoch_rewards_read`](<#fd_sysvar_epoch_rewards_read>) function.
    - Checks if reading the epoch rewards was successful; logs an error if not.
    - Verifies that `total_rewards` is not less than `distributed_rewards`; logs an error if this condition is violated.
    - Sets the `active` field of `epoch_rewards` to 0, marking it as inactive.
    - Calls [`write_epoch_rewards`](<#write_epoch_rewards>) to update the system with the modified epoch rewards.
- **Output**: No return value; the function performs operations and logs errors if conditions are not met.
- **Functions Called**:
    - [`fd_sysvar_epoch_rewards_read`](<#fd_sysvar_epoch_rewards_read>)
    - [`write_epoch_rewards`](<#write_epoch_rewards>)


---
### fd\_sysvar\_epoch\_rewards\_init<!-- {{#callable:fd_sysvar_epoch_rewards_init}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_epoch_rewards.c#L101>)

Initializes the epoch rewards structure and writes it to the system.
- **Inputs**:
    - `bank`: A pointer to the `fd_bank_t` structure representing the bank.
    - `accdb`: A pointer to the `fd_accdb_user_t` structure representing the account database.
    - `xid`: A pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID.
    - `capture_ctx`: A pointer to the `fd_capture_ctx_t` structure representing the capture context.
    - `distributed_rewards`: An unsigned long integer representing the rewards already distributed.
    - `distribution_starting_block_height`: An unsigned long integer representing the starting block height for distribution.
    - `num_partitions`: An unsigned long integer representing the number of partitions.
    - `total_rewards`: An unsigned long integer representing the total rewards available.
    - `total_points`: A 128-bit unsigned integer representing the total points.
    - `last_blockhash`: A pointer to the `fd_hash_t` structure representing the last block hash.
- **Logic and Control Flow**:
    - Initialize an `fd_sysvar_epoch_rewards_t` structure with the provided parameters.
    - Check if `total_rewards` is less than `distributed_rewards` and log an error if true.
    - Call [`write_epoch_rewards`](<#write_epoch_rewards>) to write the initialized `epoch_rewards` structure to the system.
- **Output**: No return value; the function performs operations and logs errors if conditions are not met.
- **Functions Called**:
    - [`write_epoch_rewards`](<#write_epoch_rewards>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)