<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for the recent hashes system variable, including initialization, updating, and validation.

# Purpose
The code is a test suite for validating the functionality of the `fd_sysvar_recent_hashes` component within a system. It includes several static functions that test different aspects of the recent hashes system variable, such as its initialization, update, and boundary conditions. The code imports necessary headers and binary data required for testing, and it defines a function [`fd_mem_iszero8`](<#fd_mem_iszero8>) to check if a memory region is zeroed. The test functions ensure that the recent hashes system variable behaves correctly when initialized, updated, and queried, and they verify the integrity of the data stored in the system variable.

The test suite is organized into several static functions: [`test_sysvar_recent_hashes_bounds`](<#test_sysvar_recent_hashes_bounds>), [`test_sysvar_recent_hashes_init`](<#test_sysvar_recent_hashes_init>), and [`test_sysvar_recent_hashes_update`](<#test_sysvar_recent_hashes_update>). Each function focuses on a specific aspect of the recent hashes system variable. The [`test_sysvar_recent_hashes_bounds`](<#test_sysvar_recent_hashes_bounds>) function checks the size and alignment of the decoded data. The [`test_sysvar_recent_hashes_init`](<#test_sysvar_recent_hashes_init>) function tests the initialization process, ensuring that the system variable is correctly set up and validated. The [`test_sysvar_recent_hashes_update`](<#test_sysvar_recent_hashes_update>) function verifies the update mechanism by adding new block hashes and checking the integrity of the queue. The main function [`test_sysvar_recent_hashes`](<#test_sysvar_recent_hashes>) orchestrates the execution of these tests, ensuring comprehensive coverage of the recent hashes system variable's functionality.
# Imports and Dependencies

---
- `test_sysvar_cache_util.h`
- `fd_sysvar_base.h`
- `fd_sysvar_recent_hashes.h`
- `../fd_bank.h`
- `../fd_system_ids.h`
- `../../types/fd_types.h`


# Functions

---
### fd\_mem\_iszero8<!-- {{#callable:fd_mem_iszero8}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/test_sysvar_recent_hashes.c#L10>)

Checks if a memory region of a specified size is filled with zeroes by using XOR operations on 8-byte chunks.
- **Inputs**:
    - ``mem``: A pointer to the memory region to check.
    - ``sz``: The size of the memory region in bytes, which must be a multiple of 8.
- **Logic and Control Flow**:
    - Initialize a variable `xor` to 0.
    - Check if `sz` is aligned to the size of `ulong` using `fd_ulong_is_aligned`.
    - Iterate over the memory region in 8-byte increments, loading each chunk as a `ulong` and XORing it with `xor`.
    - Return 1 if `xor` is 0, indicating the memory region is zeroed; otherwise, return 0.
- **Output**: Returns 1 if the memory region is zeroed, otherwise returns 0.


---
### test\_sysvar\_recent\_hashes\_bounds<!-- {{#callable:test_sysvar_recent_hashes_bounds}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/test_sysvar_recent_hashes.c#L20>)

Validates the size, footprint, and alignment of the recent block hashes system variable against expected constants.
- **Inputs**: None
- **Logic and Control Flow**:
    - Check if `example_recent_hashes_sz` equals `FD_SYSVAR_RECENT_HASHES_BINCODE_SZ` using `FD_TEST`.
    - Initialize a `fd_bincode_decode_ctx_t` structure `ctx` with `data` pointing to `example_recent_hashes` and `dataend` pointing to the end of `example_recent_hashes`.
    - Declare `obj_sz` and initialize it to 0.
    - Verify that `fd_recent_block_hashes_decode_footprint` returns `FD_BINCODE_SUCCESS` and that `obj_sz` equals `FD_SYSVAR_RECENT_HASHES_FOOTPRINT` using `FD_TEST`.
    - Check if `fd_recent_block_hashes_align` equals `FD_SYSVAR_RECENT_HASHES_ALIGN` using `FD_TEST`.
- **Output**: No output is returned; the function uses assertions to validate conditions.


---
### test\_sysvar\_recent\_hashes\_init<!-- {{#callable:test_sysvar_recent_hashes_init}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/test_sysvar_recent_hashes.c#L33>)

Initializes and validates the recent hashes system variable in a test environment.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for the test environment.
- **Logic and Control Flow**:
    - Create a `test_sysvar_cache_env_t` environment and validate its creation.
    - Check that the recent hashes system variable cache is initially invalid.
    - Define a `fd_rent_t` structure with specific rent parameters and set it in the bank environment.
    - Initialize an empty recent hashes system variable using [`fd_sysvar_recent_hashes_init`](<fd_sysvar_recent_hashes.c.md#fd_sysvar_recent_hashes_init>).
    - Restore the system variable cache and validate that it is now valid.
    - Set the bank's proof of history (PoH) to zero and query the system variable cache data.
    - Verify that the queried data size matches `FD_SYSVAR_RECENT_HASHES_BINCODE_SZ` and contains zero blockhashes.
    - Check that the memory following the blockhashes is zeroed out.
    - Destroy the test environment.
- **Output**: No return value; the function performs initialization and validation within the test environment.
- **Functions Called**:
    - [`fd_sysvar_cache_recent_hashes_is_valid`](<fd_sysvar_cache.h.md#fd_sysvar_cache_recent_hashes_is_valid>)
    - [`fd_sysvar_recent_hashes_init`](<fd_sysvar_recent_hashes.c.md#fd_sysvar_recent_hashes_init>)
    - [`fd_sysvar_cache_restore`](<fd_sysvar_cache_db.c.md#fd_sysvar_cache_restore>)
    - [`fd_sysvar_cache_data_query`](<fd_sysvar_cache.c.md#fd_sysvar_cache_data_query>)
    - [`fd_mem_iszero8`](<#fd_mem_iszero8>)
    - [`test_sysvar_cache_env_destroy`](<test_sysvar_cache.c.md#test_sysvar_cache_env_destroy>)


---
### test\_sysvar\_recent\_hashes\_update<!-- {{#callable:test_sysvar_recent_hashes_update}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/test_sysvar_recent_hashes.c#L63>)

Tests the update mechanism of the recent blockhashes system variable in a simulated environment.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace structure used for the test environment.
- **Logic and Control Flow**:
    - Create a test environment using `test_sysvar_cache_env_create` and verify the initial state of the sysvar cache.
    - Set the rent parameters using `fd_bank_rent_set` to ensure sysvar creation is possible.
    - Initialize the blockhash queue with `fd_blockhashes_init` and verify its creation.
    - Register a new blockhash by setting the `poh` and lamports per signature, then update the sysvar cache and verify its validity.
    - Query the sysvar cache data and verify the contents, including the blockhash and fee calculator values.
    - Iterate to add 149 more blockhashes, updating the sysvar cache each time and verifying the count and contents.
    - Verify the final state of the blockhash queue, ensuring the correct order and values of blockhashes and fee calculators.
    - Destroy the test environment using [`test_sysvar_cache_env_destroy`](<test_sysvar_cache.c.md#test_sysvar_cache_env_destroy>).
- **Output**: No direct output; the function performs tests and uses assertions to validate the behavior of the sysvar update process.
- **Functions Called**:
    - [`fd_sysvar_cache_recent_hashes_is_valid`](<fd_sysvar_cache.h.md#fd_sysvar_cache_recent_hashes_is_valid>)
    - [`fd_sysvar_recent_hashes_update`](<fd_sysvar_recent_hashes.c.md#fd_sysvar_recent_hashes_update>)
    - [`fd_sysvar_cache_restore`](<fd_sysvar_cache_db.c.md#fd_sysvar_cache_restore>)
    - [`fd_sysvar_cache_data_query`](<fd_sysvar_cache.c.md#fd_sysvar_cache_data_query>)
    - [`fd_mem_iszero8`](<#fd_mem_iszero8>)
    - [`test_sysvar_cache_env_destroy`](<test_sysvar_cache.c.md#test_sysvar_cache_env_destroy>)


---
### test\_sysvar\_recent\_hashes<!-- {{#callable:test_sysvar_recent_hashes}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/test_sysvar_recent_hashes.c#L137>)

Executes a series of tests on the recent hashes system variable, including boundary checks, initialization, and updates.
- **Inputs**:
    - ``wksp``: A pointer to an `fd_wksp_t` workspace structure used in the tests.
- **Logic and Control Flow**:
    - Calls [`test_sysvar_recent_hashes_bounds`](<#test_sysvar_recent_hashes_bounds>) to verify the size and alignment of the recent hashes binary code and footprint.
    - Calls [`test_sysvar_recent_hashes_init`](<#test_sysvar_recent_hashes_init>) with `wksp` to initialize the recent hashes system variable and verify its validity.
    - Calls [`test_sysvar_recent_hashes_update`](<#test_sysvar_recent_hashes_update>) with `wksp` to update the recent hashes system variable and verify the integrity of the blockhash queue.
- **Output**: No return value; the function performs tests and assertions to validate the recent hashes system variable.
- **Functions Called**:
    - [`test_sysvar_recent_hashes_bounds`](<#test_sysvar_recent_hashes_bounds>)
    - [`test_sysvar_recent_hashes_init`](<#test_sysvar_recent_hashes_init>)
    - [`test_sysvar_recent_hashes_update`](<#test_sysvar_recent_hashes_update>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)