<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for the sysvar cache functionality, including environment setup, cache operations, and data validation.

# Purpose
The code is a C test suite for a system variable cache, which is part of a larger system involving workspace management and account databases. It includes functions to create and destroy a test environment for the system variable cache, as well as several static functions to test various aspects of the cache's functionality. The [`test_sysvar_cache_env_create`](<#test_sysvar_cache_env_create>) function initializes a test environment by allocating memory for various components such as `fd_funk`, `fd_accdb_user`, and `fd_bank`, and sets up a system variable cache. The [`test_sysvar_cache_env_destroy`](<#test_sysvar_cache_env_destroy>) function cleans up the environment by deallocating resources and resetting the environment structure.

The test suite includes functions like [`test_sysvar_map`](<#test_sysvar_map>), [`test_sysvar_cache_empty`](<#test_sysvar_cache_empty>), and [`test_sysvar_cache_read`](<#test_sysvar_cache_read>), which verify the behavior of the system variable cache. These functions test the creation, joining, and validation of the cache, as well as the ability to query and read system variables. The [`sysvar_inject`](<#sysvar_inject>) function is used to place serialized system variables into the cache for testing purposes. The suite ensures that the cache correctly handles valid and invalid data, and that it can accurately read and restore system variables. The code is structured to test the integrity and functionality of the system variable cache in isolation from the rest of the system.
# Imports and Dependencies

---
- `fd_sysvar_cache.h`
- `fd_sysvar_cache_private.h`
- `test_sysvar_cache_util.h`
- `../fd_system_ids.h`
- `../fd_bank.h`
- `../../accdb/fd_accdb_admin.h`
- `errno.h`


# Global Variables

---
### sysvar\_cache\_
- **Type**: ``fd_sysvar_cache_t` array`
- **Description**: A static array of type `fd_sysvar_cache_t` with a single element. This array is used to store and manage system variable cache data.
- **Use**: Used to initialize, join, and manage system variable cache operations in the test functions.


# Functions

---
### test\_sysvar\_cache\_env\_create<!-- {{#callable:test_sysvar_cache_env_create}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/test_sysvar_cache.c#L9>)

Initializes a `test_sysvar_cache_env_t` environment by allocating and setting up necessary resources in a workspace.
- **Inputs**:
    - `env`: A pointer to a `test_sysvar_cache_env_t` structure that will be initialized.
    - `wksp`: A pointer to a `fd_wksp_t` workspace where resources will be allocated.
- **Logic and Control Flow**:
    - Set all bytes in `env` to zero using `memset`.
    - Define constants `funk_tag`, `wksp_tag`, `funk_seed`, `txn_max`, and `rec_max` for configuration.
    - Allocate memory for `funk_mem` in the workspace using `fd_wksp_alloc_laddr` with alignment and footprint based on `txn_max` and `rec_max`.
    - Check if `funk_mem` is successfully allocated using `FD_TEST`.
    - Initialize `funk_mem` with `fd_funk_new` and verify success with `FD_TEST`.
    - Create and join an `fd_accdb_user_t` instance using `fd_accdb_user_new` and `fd_accdb_user_join`, and verify success with `FD_TEST`.
    - Allocate memory for `fd_bank_t` in the workspace using `fd_wksp_alloc_laddr`.
    - Assign `funk_mem` to `env->shfunk`, `bank` to `env->bank`, and initialize `env->xid` with zero values.
    - Create and join a `sysvar_cache` using [`fd_sysvar_cache_new`](<fd_sysvar_cache.c.md#fd_sysvar_cache_new>) and [`fd_sysvar_cache_join`](<fd_sysvar_cache.c.md#fd_sysvar_cache_join>), assigning it to `env->sysvar_cache`.
    - Create an `fd_accdb_admin_t` instance, join it using `fd_accdb_admin_join`, and verify success with `FD_TEST`.
    - Attach a child to the admin using `fd_accdb_attach_child` with the last published funk and `env->xid`.
    - Leave the admin using `fd_accdb_admin_leave`.
    - Return the initialized `env`.
- **Output**: Returns a pointer to the initialized `test_sysvar_cache_env_t` structure.
- **Functions Called**:
    - [`fd_sysvar_cache_join`](<fd_sysvar_cache.c.md#fd_sysvar_cache_join>)
    - [`fd_sysvar_cache_new`](<fd_sysvar_cache.c.md#fd_sysvar_cache_new>)


---
### test\_sysvar\_cache\_env\_destroy<!-- {{#callable:test_sysvar_cache_env_destroy}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/test_sysvar_cache.c#L40>)

Releases resources and resets the `test_sysvar_cache_env_t` environment structure.
- **Inputs**:
    - `env`: A pointer to a `test_sysvar_cache_env_t` structure that represents the environment to destroy.
- **Logic and Control Flow**:
    - Check if `env` is not NULL using `FD_TEST` macro.
    - Leave and delete the `sysvar_cache` associated with `env` using [`fd_sysvar_cache_leave`](<fd_sysvar_cache.c.md#fd_sysvar_cache_leave>) and [`fd_sysvar_cache_delete`](<fd_sysvar_cache.c.md#fd_sysvar_cache_delete>).
    - Free the memory allocated for `env->bank` using `fd_wksp_free_laddr`.
    - Leave and delete the `accdb` user associated with `env` using `fd_accdb_user_leave` and `fd_accdb_user_delete`.
    - Delete the `shfunk` resource associated with `env` using `fd_funk_delete_fast`.
    - Reset the memory of `env` to zero using `memset`.
- **Output**: No return value; the function operates directly on the `env` pointer to release resources and reset its memory.
- **Functions Called**:
    - [`fd_sysvar_cache_delete`](<fd_sysvar_cache.c.md#fd_sysvar_cache_delete>)
    - [`fd_sysvar_cache_leave`](<fd_sysvar_cache.c.md#fd_sysvar_cache_leave>)


---
### test\_sysvar\_map<!-- {{#callable:test_sysvar_map}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/test_sysvar_cache.c#L50>)

Validates the mapping of system variable identifiers to their corresponding description indices and checks for invalid mappings.
- **Inputs**: None
- **Logic and Control Flow**:
    - Queries the system variable map for various predefined system variable identifiers using `sysvar_map_query` and checks if the returned description index matches the expected index using `FD_TEST`.
    - Iterates over 256 public keys, initializes each key with a sequence of bytes, and verifies that querying the system variable map with these keys returns `NULL`, indicating no mapping exists.
- **Output**: No output is returned; the function performs validation checks using assertions.


---
### test\_sysvar\_cache\_empty<!-- {{#callable:test_sysvar_cache_empty}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/test_sysvar_cache.c#L90>)

Tests the creation, joining, validation, querying, and deletion of an empty system variable cache.
- **Inputs**: None
- **Logic and Control Flow**:
    - Tests the creation of a new system variable cache with [`fd_sysvar_cache_new`](<fd_sysvar_cache.c.md#fd_sysvar_cache_new>), ensuring it returns `NULL` for invalid inputs and correctly initializes for valid inputs.
    - Tests the joining of a system variable cache with [`fd_sysvar_cache_join`](<fd_sysvar_cache.c.md#fd_sysvar_cache_join>), checking for `NULL` returns on invalid inputs and ensuring proper joining for valid inputs.
    - Increments and decrements the `magic` field to test invalid and valid cache joining scenarios.
    - Tests the [`fd_sysvar_cache_leave`](<fd_sysvar_cache.c.md#fd_sysvar_cache_leave>) function to ensure it returns the correct memory address.
    - Tests the constant joining of a system variable cache with [`fd_sysvar_cache_join_const`](<fd_sysvar_cache.c.md#fd_sysvar_cache_join_const>), similar to the non-const join tests.
    - Validates various system variable cache entries using `fd_sysvar_cache_*_is_valid` functions, ensuring all return `false` for an empty cache.
    - Queries the cache with [`fd_sysvar_cache_data_query`](<fd_sysvar_cache.c.md#fd_sysvar_cache_data_query>) for each entry and a specific public key, ensuring all return `NULL` and size `0`.
    - Tests reading of system variables using `fd_sysvar_cache_*_read` functions, ensuring all return `false` for an empty cache.
    - Tests constant joining of system variable cache entries with `fd_sysvar_cache_*_join_const`, ensuring all return `false`.
    - Tests the constant leave operation with [`fd_sysvar_cache_leave_const`](<fd_sysvar_cache.c.md#fd_sysvar_cache_leave_const>), ensuring it returns the correct memory address.
    - Tests the deletion of a system variable cache with [`fd_sysvar_cache_delete`](<fd_sysvar_cache.c.md#fd_sysvar_cache_delete>), ensuring it returns `NULL` for invalid inputs and the correct address for valid inputs.
- **Output**: No output is returned; the function performs tests and uses assertions to validate behavior.
- **Functions Called**:
    - [`fd_sysvar_cache_new`](<fd_sysvar_cache.c.md#fd_sysvar_cache_new>)
    - [`fd_sysvar_cache_join`](<fd_sysvar_cache.c.md#fd_sysvar_cache_join>)
    - [`fd_sysvar_cache_leave`](<fd_sysvar_cache.c.md#fd_sysvar_cache_leave>)
    - [`fd_sysvar_cache_join_const`](<fd_sysvar_cache.c.md#fd_sysvar_cache_join_const>)
    - [`fd_sysvar_cache_clock_is_valid`](<fd_sysvar_cache.h.md#fd_sysvar_cache_clock_is_valid>)
    - [`fd_sysvar_cache_epoch_rewards_is_valid`](<fd_sysvar_cache.h.md#fd_sysvar_cache_epoch_rewards_is_valid>)
    - [`fd_sysvar_cache_epoch_schedule_is_valid`](<fd_sysvar_cache.h.md#fd_sysvar_cache_epoch_schedule_is_valid>)
    - [`fd_sysvar_cache_last_restart_slot_is_valid`](<fd_sysvar_cache.h.md#fd_sysvar_cache_last_restart_slot_is_valid>)
    - [`fd_sysvar_cache_recent_hashes_is_valid`](<fd_sysvar_cache.h.md#fd_sysvar_cache_recent_hashes_is_valid>)
    - [`fd_sysvar_cache_rent_is_valid`](<fd_sysvar_cache.h.md#fd_sysvar_cache_rent_is_valid>)
    - [`fd_sysvar_cache_slot_hashes_is_valid`](<fd_sysvar_cache.h.md#fd_sysvar_cache_slot_hashes_is_valid>)
    - [`fd_sysvar_cache_slot_history_is_valid`](<fd_sysvar_cache.h.md#fd_sysvar_cache_slot_history_is_valid>)
    - [`fd_sysvar_cache_stake_history_is_valid`](<fd_sysvar_cache.h.md#fd_sysvar_cache_stake_history_is_valid>)
    - [`fd_sysvar_cache_data_query`](<fd_sysvar_cache.c.md#fd_sysvar_cache_data_query>)
    - [`fd_sysvar_cache_slot_history_join_const`](<fd_sysvar_cache.c.md#fd_sysvar_cache_slot_history_join_const>)
    - [`fd_sysvar_cache_slot_hashes_join_const`](<fd_sysvar_cache.c.md#fd_sysvar_cache_slot_hashes_join_const>)
    - [`fd_sysvar_cache_stake_history_join_const`](<fd_sysvar_cache.c.md#fd_sysvar_cache_stake_history_join_const>)
    - [`fd_sysvar_cache_leave_const`](<fd_sysvar_cache.c.md#fd_sysvar_cache_leave_const>)
    - [`fd_sysvar_cache_delete`](<fd_sysvar_cache.c.md#fd_sysvar_cache_delete>)


---
### sysvar\_inject<!-- {{#callable:sysvar_inject}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/test_sysvar_cache.c#L174>)

Injects a serialized sysvar into the sysvar cache at a specified index, bypassing the database.
- **Inputs**:
    - ``cache``: A pointer to the `fd_sysvar_cache_t` structure where the sysvar will be injected.
    - ``idx``: An unsigned long integer representing the index in the sysvar cache where the sysvar will be injected.
    - ``data``: A pointer to the constant unsigned character array containing the serialized sysvar data to be injected.
    - ``data_sz``: An unsigned long integer representing the size of the `data` array.
- **Logic and Control Flow**:
    - Check if `idx` is greater than or equal to `FD_SYSVAR_CACHE_ENTRY_CNT`; if true, log a critical error and terminate.
    - Retrieve the sysvar descriptor and position from the cache and position table using `idx`.
    - Verify that `data_sz` does not exceed the maximum allowed size for the sysvar data at the given index.
    - Copy the `data` into the cache at the offset specified by the position table.
    - Set the `data_sz` and `flags` fields of the descriptor to the size of the data and zero, respectively.
    - Call [`fd_sysvar_obj_restore`](<fd_sysvar_cache.c.md#fd_sysvar_obj_restore>) to restore the sysvar object in the cache and return its result.
- **Output**: Returns the result of [`fd_sysvar_obj_restore`](<fd_sysvar_cache.c.md#fd_sysvar_obj_restore>), which is an integer indicating success or failure of the restore operation.
- **Functions Called**:
    - [`fd_sysvar_obj_restore`](<fd_sysvar_cache.c.md#fd_sysvar_obj_restore>)


---
### test\_sysvar\_cache\_read<!-- {{#callable:test_sysvar_cache_read}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/test_sysvar_cache.c#L189>)

Tests the reading and validation of sysvar cache data, specifically focusing on the clock sysvar.
- **Inputs**: None
- **Logic and Control Flow**:
    - Join a new sysvar cache using [`fd_sysvar_cache_join`](<fd_sysvar_cache.c.md#fd_sysvar_cache_join>) and [`fd_sysvar_cache_new`](<fd_sysvar_cache.c.md#fd_sysvar_cache_new>).
    - Check if the clock sysvar is initially invalid using [`fd_sysvar_cache_clock_is_valid`](<fd_sysvar_cache.h.md#fd_sysvar_cache_clock_is_valid>).
    - Set the clock sysvar descriptor to valid with a specific data size.
    - Inject a predefined valid clock sysvar data into the cache using [`sysvar_inject`](<#sysvar_inject>).
    - Verify the clock sysvar is now valid.
    - Query the cache for the clock sysvar data and verify it matches the injected data using [`fd_sysvar_cache_data_query`](<fd_sysvar_cache.c.md#fd_sysvar_cache_data_query>) and `fd_memeq`.
    - Read the clock sysvar data using `fd_sysvar_cache_clock_read_nofail` and verify its fields match expected values.
    - Inject invalid sysvar data and verify the cache correctly identifies it as invalid.
    - Delete the sysvar cache using [`fd_sysvar_cache_delete`](<fd_sysvar_cache.c.md#fd_sysvar_cache_delete>) and [`fd_sysvar_cache_leave`](<fd_sysvar_cache.c.md#fd_sysvar_cache_leave>).
- **Output**: No output is returned; the function performs tests and uses assertions to validate behavior.
- **Functions Called**:
    - [`fd_sysvar_cache_join`](<fd_sysvar_cache.c.md#fd_sysvar_cache_join>)
    - [`fd_sysvar_cache_new`](<fd_sysvar_cache.c.md#fd_sysvar_cache_new>)
    - [`fd_sysvar_cache_clock_is_valid`](<fd_sysvar_cache.h.md#fd_sysvar_cache_clock_is_valid>)
    - [`sysvar_inject`](<#sysvar_inject>)
    - [`fd_sysvar_cache_data_query`](<fd_sysvar_cache.c.md#fd_sysvar_cache_data_query>)
    - [`fd_sysvar_cache_delete`](<fd_sysvar_cache.c.md#fd_sysvar_cache_delete>)
    - [`fd_sysvar_cache_leave`](<fd_sysvar_cache.c.md#fd_sysvar_cache_leave>)


---
### test\_sysvar\_cache<!-- {{#callable:test_sysvar_cache}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/test_sysvar_cache.c#L227>)

Executes a series of tests on the system variable cache, including mapping, empty cache operations, and cache reading.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `test_sysvar_map()` to test the mapping of system variables to their descriptors.
    - Calls `test_sysvar_cache_empty()` to test operations on an empty system variable cache, including creation, joining, validation, querying, and deletion.
    - Calls `test_sysvar_cache_read()` to test reading operations from the system variable cache, including injecting and validating system variables.
- **Output**: No output is returned as the function is void and primarily used for testing purposes.
- **Functions Called**:
    - [`test_sysvar_map`](<#test_sysvar_map>)
    - [`test_sysvar_cache_empty`](<#test_sysvar_cache_empty>)
    - [`test_sysvar_cache_read`](<#test_sysvar_cache_read>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)