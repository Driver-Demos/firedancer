<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for managing slot hashes in a bank system, including creation, update, and deletion operations.

# Purpose
The code provides functionality for managing and updating slot hashes within a system, likely related to a blockchain or distributed ledger environment. It includes functions to write, read, update, and manage memory for slot hashes. The primary components include functions such as [`fd_sysvar_slot_hashes_write`](<#fd_sysvar_slot_hashes_write>), [`fd_sysvar_slot_hashes_read`](<#fd_sysvar_slot_hashes_read>), [`fd_sysvar_slot_hashes_update`](<#fd_sysvar_slot_hashes_update>), and memory management functions like [`fd_sysvar_slot_hashes_new`](<#fd_sysvar_slot_hashes_new>), [`fd_sysvar_slot_hashes_join`](<#fd_sysvar_slot_hashes_join>), [`fd_sysvar_slot_hashes_leave`](<#fd_sysvar_slot_hashes_leave>), and [`fd_sysvar_slot_hashes_delete`](<#fd_sysvar_slot_hashes_delete>). These functions interact with data structures such as `fd_slot_hashes_global_t` and `fd_slot_hash_t`, which are used to store and manipulate slot hash data.

The code is part of a larger system, as indicated by the inclusion of headers like `fd_sysvar.h` and `fd_acc_mgr.h`, and it appears to be designed for integration with other components. It defines a set of operations for handling slot hashes, including encoding and decoding operations, memory alignment checks, and error logging. The code also references external systems or libraries, as seen in the use of functions like `fd_txn_account_init_from_funk_readonly` and `fd_bank_bank_hash_query`. The functions are designed to ensure data integrity and proper memory management, which are critical in environments where data consistency and performance are important.
# Imports and Dependencies

---
- `fd_sysvar_slot_hashes.h`
- `fd_sysvar.h`
- `../fd_acc_mgr.h`
- `../fd_system_ids.h`


# Functions

---
### fd\_sysvar\_slot\_hashes\_write<!-- {{#callable:fd_sysvar_slot_hashes_write}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_slot_hashes.c#L7>)

Encodes global slot hashes and updates the system variable account with the encoded data.
- **Inputs**:
    - ``bank``: A pointer to the `fd_bank_t` structure representing the bank context.
    - ``accdb``: A pointer to the `fd_accdb_user_t` structure representing the account database user context.
    - ``xid``: A pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``capture_ctx``: A pointer to the `fd_capture_ctx_t` structure representing the capture context.
    - ``slot_hashes_global``: A pointer to the `fd_slot_hashes_global_t` structure containing the global slot hashes to encode.
- **Logic and Control Flow**:
    - Initialize an aligned buffer `enc` to store encoded data.
    - Set up a `fd_bincode_encode_ctx_t` context `ctx` with `enc` as the data buffer.
    - Call `fd_slot_hashes_encode_global` to encode `slot_hashes_global` into `ctx`.
    - If encoding fails, log an error message and exit.
    - Call [`fd_sysvar_account_update`](<fd_sysvar.c.md#fd_sysvar_account_update>) to update the system variable account with the encoded data in `enc`.
- **Output**: No return value; the function updates the system variable account with encoded slot hashes.
- **Functions Called**:
    - [`fd_sysvar_account_update`](<fd_sysvar.c.md#fd_sysvar_account_update>)


---
### fd\_sysvar\_slot\_hashes\_footprint<!-- {{#callable:fd_sysvar_slot_hashes_footprint}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_slot_hashes.c#L24>)

Calculates the memory footprint required for slot hashes based on a given capacity.
- **Inputs**:
    - `slot_hashes_cap`: The capacity of slot hashes for which the memory footprint is calculated.
- **Logic and Control Flow**:
    - Calculate the size of `fd_slot_hashes_global_t`.
    - Calculate the footprint of `deq_fd_slot_hash_t` using the provided `slot_hashes_cap`.
    - Calculate the alignment requirement of `deq_fd_slot_hash_t`.
    - Return the sum of the above three values as the total memory footprint.
- **Output**: Returns the total memory footprint in bytes as an unsigned long integer.


---
### fd\_sysvar\_slot\_hashes\_new<!-- {{#callable:fd_sysvar_slot_hashes_new}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_slot_hashes.c#L30>)

Initializes a new `fd_slot_hashes_global_t` structure in the provided memory, ensuring alignment and setting up slot hashes.
- **Inputs**:
    - `mem`: A pointer to the memory where the `fd_slot_hashes_global_t` structure will be initialized.
    - `slot_hashes_cap`: The capacity for the slot hashes to be initialized.
- **Logic and Control Flow**:
    - Check if `mem` is NULL and log an error if true.
    - Check if `mem` is aligned to `FD_SYSVAR_SLOT_HASHES_ALIGN` and log an error if not aligned.
    - Cast `mem` to a `fd_slot_hashes_global_t` pointer and store it in `slot_hashes_global`.
    - Calculate the aligned memory address for slot hashes and store it in `slot_hash_mem`.
    - Initialize the slot hashes using `deq_fd_slot_hash_t_new` with `slot_hash_mem` and `slot_hashes_cap`.
    - Set the `hashes_offset` in `slot_hashes_global` to the offset of `slot_hash_mem` from `slot_hashes_global`.
- **Output**: Returns a pointer to the initialized `fd_slot_hashes_global_t` structure.


---
### fd\_sysvar\_slot\_hashes\_join<!-- {{#callable:fd_sysvar_slot_hashes_join}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_slot_hashes.c#L49>)

Joins a shared memory region to a slot hash structure and returns a pointer to the global slot hashes structure.
- **Inputs**:
    - `shmem`: A pointer to the shared memory region containing the slot hashes.
    - `slot_hash`: A double pointer to a `fd_slot_hash_t` structure where the function will store the joined slot hash.
- **Logic and Control Flow**:
    - Cast the `shmem` pointer to a `fd_slot_hashes_global_t` pointer and store it in `slot_hashes_global`.
    - Calculate the address of the slot hash by adding `hashes_offset` from `slot_hashes_global` to `shmem`.
    - Join the slot hash using `deq_fd_slot_hash_t_join` and store the result in `*slot_hash`.
    - Return the `slot_hashes_global` pointer.
- **Output**: Returns a pointer to the `fd_slot_hashes_global_t` structure.


---
### fd\_sysvar\_slot\_hashes\_leave<!-- {{#callable:fd_sysvar_slot_hashes_leave}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_slot_hashes.c#L58>)

Releases resources associated with a slot hash and returns the global slot hashes structure.
- **Inputs**:
    - `slot_hashes_global`: A pointer to the `fd_slot_hashes_global_t` structure representing the global slot hashes.
    - `slot_hash`: A pointer to the `fd_slot_hash_t` structure representing the specific slot hash to leave.
- **Logic and Control Flow**:
    - Calls `deq_fd_slot_hash_t_leave` to release resources associated with the `slot_hash`.
    - Returns the `slot_hashes_global` pointer.
- **Output**: Returns a pointer to the `fd_slot_hashes_global_t` structure.


---
### fd\_sysvar\_slot\_hashes\_delete<!-- {{#callable:fd_sysvar_slot_hashes_delete}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_slot_hashes.c#L66>)

Deletes the slot hash memory associated with a given memory block and returns the original memory pointer.
- **Inputs**:
    - `mem`: A pointer to the memory block that contains the slot hash data to delete.
- **Logic and Control Flow**:
    - Aligns the memory pointer `mem` to the required alignment for `deq_fd_slot_hash_t` after accounting for the size of `fd_slot_hashes_global_t`.
    - Calls `deq_fd_slot_hash_t_delete` to delete the slot hash memory at the aligned memory location.
    - Returns the original memory pointer `mem`.
- **Output**: Returns the original memory pointer `mem` after deleting the slot hash memory.


---
### fd\_sysvar\_slot\_hashes\_update<!-- {{#callable:fd_sysvar_slot_hashes_update}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_slot_hashes.c#L75>)

Updates the slot hashes in the system variable by reading, modifying, and writing back the slot hash data.
- **Inputs**:
    - ``bank``: A pointer to `fd_bank_t`, representing the bank context.
    - ``accdb``: A pointer to `fd_accdb_user_t`, representing the account database user context.
    - ``xid``: A constant pointer to `fd_funk_txn_xid_t`, representing the transaction ID.
    - ``capture_ctx``: A pointer to `fd_capture_ctx_t`, representing the capture context.
- **Logic and Control Flow**:
    - Allocate memory for slot hashes with alignment.
    - Read existing slot hashes using [`fd_sysvar_slot_hashes_read`](<#fd_sysvar_slot_hashes_read>).
    - If no slot hashes exist, initialize a new slot hash structure using [`fd_sysvar_slot_hashes_new`](<#fd_sysvar_slot_hashes_new>).
    - Join the slot hashes to get a pointer to the hash list using [`fd_sysvar_slot_hashes_join`](<#fd_sysvar_slot_hashes_join>).
    - Iterate over the slot hashes to find a hash matching the parent slot of the bank.
    - If a matching slot is found, update its hash with the bank's hash.
    - If no matching slot is found, create a new slot hash with the bank's parent slot and hash.
    - If the hash list is full, remove the oldest hash using `deq_fd_slot_hash_t_pop_tail_nocopy`.
    - Add the new slot hash to the head of the list using `deq_fd_slot_hash_t_push_head`.
    - Write the updated slot hashes back to the system variable using [`fd_sysvar_slot_hashes_write`](<#fd_sysvar_slot_hashes_write>).
    - Leave the slot hashes using [`fd_sysvar_slot_hashes_leave`](<#fd_sysvar_slot_hashes_leave>).
- **Output**: No return value; the function updates the slot hashes in the system variable.
- **Functions Called**:
    - [`fd_sysvar_slot_hashes_read`](<#fd_sysvar_slot_hashes_read>)
    - [`fd_sysvar_slot_hashes_new`](<#fd_sysvar_slot_hashes_new>)
    - [`fd_sysvar_slot_hashes_join`](<#fd_sysvar_slot_hashes_join>)
    - [`fd_sysvar_slot_hashes_write`](<#fd_sysvar_slot_hashes_write>)
    - [`fd_sysvar_slot_hashes_leave`](<#fd_sysvar_slot_hashes_leave>)


---
### fd\_sysvar\_slot\_hashes\_read<!-- {{#callable:fd_sysvar_slot_hashes_read}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_slot_hashes.c#L118>)

Reads and decodes slot hashes from a sysvar account in a read-only transaction context.
- **Inputs**:
    - ``funk``: A pointer to an `fd_funk_t` structure representing the transaction context.
    - ``xid``: A constant pointer to an `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``slot_hashes_mem``: A pointer to a memory location where the decoded slot hashes will be stored.
- **Logic and Control Flow**:
    - Initialize a transaction account record `rec` using `fd_txn_account_init_from_funk_readonly` with the sysvar slot hashes ID, `funk`, and `xid`.
    - Check if the initialization was successful; if not, return `NULL`.
    - Check if the account has zero lamports, indicating non-existence in a fuzzer context, and return `NULL` if true.
    - Set up a `fd_bincode_decode_ctx_t` structure `decode` with the account data and its length.
    - Decode the slot hashes using `fd_slot_hashes_decode_global` with `slot_hashes_mem` and `decode`, and return the result.
- **Output**: A pointer to an `fd_slot_hashes_global_t` structure containing the decoded slot hashes, or `NULL` if an error occurs.



---
Made with ❤️ by [Driver](https://www.driver.ai/)