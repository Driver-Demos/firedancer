<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Database interactions between the sysvar cache and the account database.

# Purpose
The `fd_sysvar_cache_db.c` file manages interactions between a system variable cache and an account database. It is part of a larger system that handles database operations related to system variables, which are likely stored in a cache for efficient access. The file includes several header files, such as `fd_sysvar.h`, `fd_sysvar_cache.h`, and others, indicating its reliance on predefined structures and functions for system variable and account management.

The primary functionality of this file is to populate and restore the system variable cache from the account database. The function [`sysvar_data_fill`](<#sysvar_data_fill>) reads account data from the database and fills the cache with this data. It checks for errors during the read operation and logs them if necessary. The function [`fd_sysvar_cache_restore1`](<#fd_sysvar_cache_restore1>) iterates over all cache entries, calling [`sysvar_data_fill`](<#sysvar_data_fill>) for each entry to restore the cache. The public function [`fd_sysvar_cache_restore`](<#fd_sysvar_cache_restore>) provides an interface to restore the cache with logging enabled, while [`fd_sysvar_cache_restore_fuzz`](<#fd_sysvar_cache_restore_fuzz>) does the same without logging. These functions facilitate the synchronization of the cache with the database, ensuring that the cache reflects the current state of the system variables stored in the database.
# Imports and Dependencies

---
- `fd_sysvar.h`
- `fd_sysvar_cache.h`
- `fd_sysvar_cache_private.h`
- `../fd_txn_account.h`
- `../fd_acc_mgr.h`
- `errno.h`


# Functions

---
### sysvar\_data\_fill<!-- {{#callable:sysvar_data_fill}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_cache_db.c#L11>)

Fills a sysvar cache entry with data from a database account, handling errors and special conditions.
- **Inputs**:
    - ``cache``: A pointer to the `fd_sysvar_cache_t` structure where the sysvar data will be stored.
    - ``funk``: A pointer to the `fd_funk_t` structure representing the database context.
    - ``xid``: A constant pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``idx``: An unsigned long integer representing the index of the sysvar in the cache.
    - ``log_fails``: An integer flag indicating whether to log failures (non-zero to log, zero to not log).
- **Logic and Control Flow**:
    - Retrieve the sysvar position and key from the global tables using the index `idx`.
    - Initialize a `fd_txn_account_t` record from the database using the key, `funk`, and `xid`.
    - If the account is unknown and `log_fails` is set, log a debug message and return 0.
    - If there is an error other than unknown account, log an error message and return `EIO`.
    - Check if the account balance is zero; if so, log a warning if `log_fails` is set and return 0.
    - Determine the size of the data to copy, ensuring it does not exceed the maximum allowed size.
    - Copy the account data into the cache at the specified offset and update the descriptor with the data size.
    - Call [`fd_sysvar_obj_restore`](<fd_sysvar_cache.c.md#fd_sysvar_obj_restore>) to recover the object cache entry from the data cache entry and return its result.
- **Output**: Returns 0 on success or `EIO` on error, with logging behavior controlled by `log_fails`.
- **Functions Called**:
    - [`fd_sysvar_obj_restore`](<fd_sysvar_cache.c.md#fd_sysvar_obj_restore>)


---
### fd\_sysvar\_cache\_restore1<!-- {{#callable:fd_sysvar_cache_restore1}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_cache_db.c#L49>)

Restores the system variable cache by filling it with data from the account database and returns success status.
- **Inputs**:
    - ``bank``: A pointer to an `fd_bank_t` structure, representing the bank to modify the system variable cache.
    - ``funk``: A pointer to an `fd_funk_t` structure, representing the funk context for reading account data.
    - ``xid``: A pointer to a constant `fd_funk_txn_xid_t` structure, representing the transaction ID for the operation.
    - ``log_fails``: An integer flag indicating whether to log failures (1 to log, 0 not to log).
- **Logic and Control Flow**:
    - Create a new system variable cache by modifying the bank's cache and joining it.
    - Initialize `saw_err` to 0 to track if any errors occur during the process.
    - Iterate over each entry in the system variable cache (`FD_SYSVAR_CACHE_ENTRY_CNT` times).
    - For each entry, call [`sysvar_data_fill`](<#sysvar_data_fill>) to fill the cache with data from the account database.
    - If [`sysvar_data_fill`](<#sysvar_data_fill>) returns an error, set `saw_err` to 1.
    - Leave the system variable cache after processing all entries.
    - Return the negation of `saw_err`, indicating success if no errors were encountered.
- **Output**: Returns an integer indicating success (1) if no errors occurred during the cache restoration, otherwise returns 0.
- **Functions Called**:
    - [`fd_sysvar_cache_join`](<fd_sysvar_cache.c.md#fd_sysvar_cache_join>)
    - [`fd_sysvar_cache_new`](<fd_sysvar_cache.c.md#fd_sysvar_cache_new>)
    - [`sysvar_data_fill`](<#sysvar_data_fill>)
    - [`fd_sysvar_cache_leave`](<fd_sysvar_cache.c.md#fd_sysvar_cache_leave>)


---
### fd\_sysvar\_cache\_restore<!-- {{#callable:fd_sysvar_cache_restore}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_cache_db.c#L68>)

Calls [`fd_sysvar_cache_restore1`](<#fd_sysvar_cache_restore1>) to restore the system variable cache with logging enabled.
- **Inputs**:
    - ``bank``: A pointer to an `fd_bank_t` structure representing the bank where the system variable cache is stored.
    - ``funk``: A pointer to an `fd_funk_t` structure representing the funk context used for database operations.
    - ``xid``: A pointer to a constant `fd_funk_txn_xid_t` structure representing the transaction ID for the operation.
- **Logic and Control Flow**:
    - Calls the [`fd_sysvar_cache_restore1`](<#fd_sysvar_cache_restore1>) function with the provided `bank`, `funk`, and `xid` arguments.
    - Passes the value `1` for the `log_fails` parameter to enable logging of failures.
- **Output**: Returns the result of the [`fd_sysvar_cache_restore1`](<#fd_sysvar_cache_restore1>) function, which is an integer indicating success or failure of the cache restoration process.
- **Functions Called**:
    - [`fd_sysvar_cache_restore1`](<#fd_sysvar_cache_restore1>)


---
### fd\_sysvar\_cache\_restore\_fuzz<!-- {{#callable:fd_sysvar_cache_restore_fuzz}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_cache_db.c#L75>)

Calls [`fd_sysvar_cache_restore1`](<#fd_sysvar_cache_restore1>) with logging disabled to restore the sysvar cache from the database.
- **Inputs**:
    - ``bank``: A pointer to an `fd_bank_t` structure representing the bank where the sysvar cache will be restored.
    - ``funk``: A pointer to an `fd_funk_t` structure representing the funk context used for the restoration process.
    - ``xid``: A constant pointer to an `fd_funk_txn_xid_t` structure representing the transaction ID for the restoration process.
- **Logic and Control Flow**:
    - Calls the function [`fd_sysvar_cache_restore1`](<#fd_sysvar_cache_restore1>) with the provided `bank`, `funk`, and `xid` parameters.
    - Passes `0` as the `log_fails` argument to [`fd_sysvar_cache_restore1`](<#fd_sysvar_cache_restore1>), indicating that logging of failures is disabled.
- **Output**: No output is returned as the function has a `void` return type.
- **Functions Called**:
    - [`fd_sysvar_cache_restore1`](<#fd_sysvar_cache_restore1>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)