<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for initializing, reading, writing, and updating the stake history sysvar in a bank system.

# Purpose
The code provides functionality for managing and updating the stake history system variable in a financial or blockchain-related application. It includes functions to initialize, read, and update the stake history data. The [`write_stake_history`](<#write_stake_history>) function encodes the stake history data and updates the system variable account with the encoded data. The [`fd_sysvar_stake_history_read`](<#fd_sysvar_stake_history_read>) function reads the stake history from the system variable account, ensuring that the account is valid and contains data. The [`fd_sysvar_stake_history_init`](<#fd_sysvar_stake_history_init>) function initializes a new stake history and writes it to the system variable account. The [`fd_sysvar_stake_history_update`](<#fd_sysvar_stake_history_update>) function updates the stake history with new epoch data, adjusting the offset and length of the history as needed, and writes the updated history back to the system variable account.

The code is part of a larger system that interacts with accounts and transactions, as indicated by the inclusion of headers such as `fd_sysvar.h`, `fd_system_ids.h`, and `fd_txn_account.h`. It defines internal functions for encoding and managing stake history data, which are likely used by other components of the system to maintain accurate records of stake changes over time. The code does not define public APIs or external interfaces, but rather provides specific functionality related to the stake history system variable within the context of the application.
# Imports and Dependencies

---
- `fd_sysvar_stake_history.h`
- `fd_sysvar.h`
- `../fd_system_ids.h`
- `../fd_txn_account.h`
- `../fd_acc_mgr.h`


# Functions

---
### write\_stake\_history<!-- {{#callable:write_stake_history}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_stake_history.c#L10>)

Encodes the stake history and updates the sysvar account with the encoded data.
- **Inputs**:
    - ``bank``: A pointer to the `fd_bank_t` structure, representing the bank context.
    - ``accdb``: A pointer to the `fd_accdb_user_t` structure, representing the account database user context.
    - ``xid``: A constant pointer to the `fd_funk_txn_xid_t` structure, representing the transaction ID.
    - ``capture_ctx``: A pointer to the `fd_capture_ctx_t` structure, representing the capture context.
    - ``stake_history``: A pointer to the `fd_stake_history_t` structure, representing the stake history to encode and update.
- **Logic and Control Flow**:
    - Aligns and initializes an array `enc` to store the encoded stake history data.
    - Initializes an `fd_bincode_encode_ctx_t` structure `encode` with `enc` as the data buffer.
    - Calls `fd_stake_history_encode` to encode the `stake_history` into the `encode` context.
    - Logs an error and exits if encoding fails.
    - Calls [`fd_sysvar_account_update`](<fd_sysvar.c.md#fd_sysvar_account_update>) to update the sysvar account with the encoded data.
- **Output**: No return value; the function updates the sysvar account with the encoded stake history data.
- **Functions Called**:
    - [`fd_sysvar_account_update`](<fd_sysvar.c.md#fd_sysvar_account_update>)


---
### fd\_sysvar\_stake\_history\_read<!-- {{#callable:fd_sysvar_stake_history_read}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_stake_history.c#L27>)

Reads the stake history from a sysvar account and decodes it into a provided structure.
- **Inputs**:
    - ``funk``: A pointer to an `fd_funk_t` structure, representing the context from which to read the sysvar account.
    - ``xid``: A constant pointer to an `fd_funk_txn_xid_t` structure, representing the transaction ID for the read operation.
    - ``stake_history``: A pointer to an `fd_stake_history_t` structure where the decoded stake history will be stored.
- **Logic and Control Flow**:
    - Initialize a transaction account record `stake_rec` using `fd_txn_account_init_from_funk_readonly` with the sysvar stake history ID, `funk`, and `xid`.
    - Check if the initialization was successful; if not, return `NULL`.
    - Check if the account has zero lamports, indicating non-existence in a real environment; if so, return `NULL`.
    - Decode the data from the account into `stake_history` using `fd_bincode_decode_static` and return the result.
- **Output**: Returns a pointer to the `fd_stake_history_t` structure with the decoded stake history, or `NULL` if an error occurs.


---
### fd\_sysvar\_stake\_history\_init<!-- {{#callable:fd_sysvar_stake_history_init}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_stake_history.c#L52>)

Initializes a new stake history and writes it to the system variables.
- **Inputs**:
    - ``bank``: A pointer to an `fd_bank_t` structure, representing the bank where the stake history will be written.
    - ``accdb``: A pointer to an `fd_accdb_user_t` structure, representing the account database user context.
    - ``xid``: A pointer to a constant `fd_funk_txn_xid_t` structure, representing the transaction ID for the operation.
    - ``capture_ctx``: A pointer to an `fd_capture_ctx_t` structure, representing the capture context for the operation.
- **Logic and Control Flow**:
    - Declare a variable `stake_history` of type `fd_stake_history_t`.
    - Call `fd_stake_history_new` to initialize `stake_history`.
    - Call [`write_stake_history`](<#write_stake_history>) with the provided inputs and the initialized `stake_history` to write the stake history to the system variables.
- **Output**: No return value; the function performs its operations as a side effect.
- **Functions Called**:
    - [`write_stake_history`](<#write_stake_history>)


---
### fd\_sysvar\_stake\_history\_update<!-- {{#callable:fd_sysvar_stake_history_update}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_stake_history.c#L62>)

Updates the stake history sysvar with a new epoch stake history entry.
- **Inputs**:
    - `bank`: A pointer to `fd_bank_t`, representing the bank context.
    - `accdb`: A pointer to `fd_accdb_user_t`, representing the account database user context.
    - `xid`: A pointer to `fd_funk_txn_xid_t`, representing the transaction ID context.
    - `capture_ctx`: A pointer to `fd_capture_ctx_t`, representing the capture context.
    - `pair`: A pointer to `fd_epoch_stake_history_entry_pair_t`, representing the epoch stake history entry pair to update.
- **Logic and Control Flow**:
    - Reads the current stake history using [`fd_sysvar_stake_history_read`](<#fd_sysvar_stake_history_read>) function.
    - Checks if the read operation was successful; logs a critical error if not.
    - Updates the `fd_stake_history_offset` to point to the previous entry, wrapping around if necessary.
    - Increments the `fd_stake_history_len` if it is less than `fd_stake_history_size`.
    - Calculates the index for the new entry using the updated offset.
    - Updates the stake history at the calculated index with the new epoch, activating, effective, and deactivating values from `pair`.
    - Writes the updated stake history back using [`write_stake_history`](<#write_stake_history>) function.
- **Output**: No return value; updates the stake history sysvar in place.
- **Functions Called**:
    - [`fd_sysvar_stake_history_read`](<#fd_sysvar_stake_history_read>)
    - [`write_stake_history`](<#write_stake_history>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)