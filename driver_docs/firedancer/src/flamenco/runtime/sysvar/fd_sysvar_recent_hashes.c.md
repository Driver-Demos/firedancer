<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Handles serialization and management of recent blockhashes for the sysvar account in the Firedancer runtime.

# Purpose
The code manages the serialization and updating of recent blockhashes in a system variable (sysvar) account. It provides functions to encode a queue of blockhashes into a binary format, update the sysvar account with this data, and read the recent blockhashes from the sysvar account. The [`encode_rbh_from_blockhash_queue`](<#encode_rbh_from_blockhash_queue>) function serializes the blockhash queue into a buffer, skipping preflight checks for efficiency. The [`fd_sysvar_recent_hashes_init`](<#fd_sysvar_recent_hashes_init>) and [`fd_sysvar_recent_hashes_update`](<#fd_sysvar_recent_hashes_update>) functions update the sysvar account with the serialized blockhash data, ensuring that the account reflects the latest state of the blockhash queue. The [`register_blockhash`](<#register_blockhash>) function adds a new blockhash to the queue, and the [`fd_sysvar_recent_hashes_read`](<#fd_sysvar_recent_hashes_read>) function reads and decodes the recent blockhashes from the sysvar account, handling potential errors and memory allocation.

The code is part of a larger system that manages blockchain data, specifically focusing on the recent blockhashes sysvar. It interacts with other components such as `fd_bank_t`, `fd_accdb_user_t`, and `fd_funk_txn_xid_t` to perform its operations. The code is designed to be consistent with another implementation, as noted in the comments, and includes error handling for scenarios that may occur during testing or fuzzing but are unlikely in a real execution environment. The functions defined in this code are intended to be used within a larger application, providing a specific functionality related to the management of recent blockhashes.
# Imports and Dependencies

---
- `fd_sysvar_recent_hashes.h`
- `../fd_acc_mgr.h`
- `fd_sysvar.h`
- `../fd_system_ids.h`


# Functions

---
### encode\_rbh\_from\_blockhash\_queue<!-- {{#callable:encode_rbh_from_blockhash_queue}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_recent_hashes.c#L10>)

Serializes the recent blockhashes from a blockhash queue into a specified memory buffer.
- **Inputs**:
    - ``bank``: A pointer to an `fd_bank_t` structure representing the bank from which the blockhash queue is queried.
    - ``out_mem``: An array of unsigned characters with a size of `FD_SYSVAR_RECENT_HASHES_BINCODE_SZ` where the encoded blockhashes will be stored.
- **Logic and Control Flow**:
    - Query the blockhash queue from the given `bank` using `fd_bank_block_hash_queue_query`.
    - Determine the size of the blockhash queue using `fd_blockhash_deq_cnt`.
    - Calculate the maximum number of blockhashes to encode using `fd_ulong_min` with the queue size and `FD_SYSVAR_RECENT_HASHES_CAP`.
    - Copy the maximum number of blockhashes to encode into the `out_mem` buffer using `fd_memcpy`.
    - Iterate over the blockhash queue in reverse order using `fd_blockhash_deq_iter_init_rev` and `fd_blockhash_deq_iter_prev`.
    - For each blockhash, copy the hash and fee calculator data into the `out_mem` buffer using `fd_memcpy` and `FD_STORE`.
    - Increment the buffer pointer `enc` by 40 bytes for each blockhash encoded.
- **Output**: The function does not return a value; it directly modifies the `out_mem` buffer to contain the serialized blockhash data.


---
### fd\_sysvar\_recent\_hashes\_init<!-- {{#callable:fd_sysvar_recent_hashes_init}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_recent_hashes.c#L39>)

Initializes the recent block hashes system variable by encoding the blockhash queue and updating the sysvar account.
- **Inputs**:
    - `bank`: A pointer to an `fd_bank_t` structure representing the bank from which the blockhash queue is queried.
    - `accdb`: A pointer to an `fd_accdb_user_t` structure representing the account database user.
    - `xid`: A pointer to a constant `fd_funk_txn_xid_t` structure representing the transaction ID.
    - `capture_ctx`: A pointer to an `fd_capture_ctx_t` structure representing the capture context.
- **Logic and Control Flow**:
    - Declare an array `enc` of size `FD_SYSVAR_RECENT_HASHES_BINCODE_SZ` and initialize it to zero.
    - Call [`encode_rbh_from_blockhash_queue`](<#encode_rbh_from_blockhash_queue>) with `bank` and `enc` to encode the blockhash queue into the `enc` buffer.
    - Call [`fd_sysvar_account_update`](<fd_sysvar.c.md#fd_sysvar_account_update>) with `bank`, `accdb`, `xid`, `capture_ctx`, a reference to `fd_sysvar_recent_block_hashes_id`, `enc`, and `FD_SYSVAR_RECENT_HASHES_BINCODE_SZ` to update the sysvar account with the encoded data.
- **Output**: No return value; the function updates the sysvar account with the recent blockhashes data.
- **Functions Called**:
    - [`encode_rbh_from_blockhash_queue`](<#encode_rbh_from_blockhash_queue>)
    - [`fd_sysvar_account_update`](<fd_sysvar.c.md#fd_sysvar_account_update>)


---
### register\_blockhash<!-- {{#callable:register_blockhash}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_recent_hashes.c#L50>)

Adds a new block hash to the bank's block hash queue and sets its fee calculator.
- **Inputs**:
    - ``bank``: A pointer to an `fd_bank_t` structure representing the bank where the block hash will be registered.
    - ``hash``: A pointer to a constant `fd_hash_t` structure representing the block hash to register.
- **Logic and Control Flow**:
    - Modify the block hash queue of the given bank using `fd_bank_block_hash_queue_modify` and store the result in `bhq`.
    - Push a new block hash into the queue using `fd_blockhashes_push_new`, passing `bhq` and `hash`, and store the result in `bh`.
    - Set the `fee_calculator` of the new block hash to a structure with `lamports_per_signature` obtained from `fd_bank_lamports_per_signature_get`.
- **Output**: No output is returned as the function is of type `void`.


---
### fd\_sysvar\_recent\_hashes\_update<!-- {{#callable:fd_sysvar_recent_hashes_update}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_recent_hashes.c#L65>)

Updates the recent blockhashes sysvar by registering the latest blockhash and encoding the blockhash queue into the sysvar account.
- **Inputs**:
    - `bank`: A pointer to the `fd_bank_t` structure representing the bank where the blockhash queue is managed.
    - `accdb`: A pointer to the `fd_accdb_user_t` structure representing the account database user.
    - `xid`: A pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID.
    - `capture_ctx`: A pointer to the `fd_capture_ctx_t` structure used for capturing context during the update.
- **Logic and Control Flow**:
    - Call [`register_blockhash`](<#register_blockhash>) to update the blockhash queue with the latest proof of history (poh) from the bank.
    - Initialize an array `enc` to store the encoded blockhash queue data.
    - Call [`encode_rbh_from_blockhash_queue`](<#encode_rbh_from_blockhash_queue>) to serialize the blockhash queue into the `enc` array.
    - Call [`fd_sysvar_account_update`](<fd_sysvar.c.md#fd_sysvar_account_update>) to update the sysvar account with the new encoded blockhash data.
- **Output**: No return value; the function updates the sysvar account with the recent blockhashes.
- **Functions Called**:
    - [`register_blockhash`](<#register_blockhash>)
    - [`encode_rbh_from_blockhash_queue`](<#encode_rbh_from_blockhash_queue>)
    - [`fd_sysvar_account_update`](<fd_sysvar.c.md#fd_sysvar_account_update>)


---
### fd\_sysvar\_recent\_hashes\_read<!-- {{#callable:fd_sysvar_recent_hashes_read}} -->
[View Source →](<../../../../../../src/flamenco/runtime/sysvar/fd_sysvar_recent_hashes.c#L77>)

Reads and decodes recent block hashes from a sysvar account in a transaction.
- **Inputs**:
    - ``funk``: A pointer to an `fd_funk_t` structure representing the transaction context.
    - ``xid``: A constant pointer to an `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``spad``: A pointer to an `fd_spad_t` structure used for memory allocation.
- **Logic and Control Flow**:
    - Initialize a transaction account in read-only mode using `fd_txn_account_init_from_funk_readonly` with the sysvar recent block hashes ID.
    - Check if the initialization was successful; if not, return `NULL`.
    - Set up a `fd_bincode_decode_ctx_t` context with data from the transaction account.
    - Check if the account has zero lamports, indicating non-existence in a fuzzer environment, and return `NULL` if true.
    - Decode the footprint of recent block hashes to determine the total size needed for allocation.
    - Allocate memory using `fd_spad_alloc` with the determined size and alignment; log a critical error if allocation fails.
    - Check again for zero lamports as a workaround for fuzzer-generated cases and return `NULL` if true.
    - Decode the recent block hashes into the allocated memory and return the result.
- **Output**: A pointer to an `fd_recent_block_hashes_t` structure containing the decoded recent block hashes, or `NULL` if an error occurs.



---
Made with ❤️ by [Driver](https://www.driver.ai/)