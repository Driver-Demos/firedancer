<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Runtime helpers for transaction execution, epoch processing, and bank initialization in the Firedancer codebase.

# Purpose
The code is a C module that provides runtime functionalities for a financial system, likely a blockchain or distributed ledger technology. It includes various components for managing and executing transactions, updating system variables, and handling epoch transitions. The module is structured to handle both public and private runtime helpers, with functions that manage transaction execution, fee validation, leader schedule updates, and account state finalization.

Key components include functions for checking and executing transactions ([`fd_runtime_pre_execute_check`](<#fd_runtime_pre_execute_check>), [`fd_runtime_prepare_and_execute_txn`](<#fd_runtime_prepare_and_execute_txn>)), updating leader schedules ([`fd_runtime_update_leaders`](<#fd_runtime_update_leaders>)), and managing epoch transitions ([`fd_runtime_process_new_epoch`](<#fd_runtime_process_new_epoch>)). The code also includes mechanisms for handling fee collection and distribution, updating system variables like clock and rent, and managing account states in a database ([`fd_runtime_finalize_account`](<#fd_runtime_finalize_account>), [`fd_runtime_save_account`](<#fd_runtime_save_account>)). Additionally, the module supports genesis block processing and initialization of system programs and features, ensuring the system's state is correctly set up from the start. The code is designed to be integrated into a larger system, providing essential runtime operations for transaction processing and system state management.
# Imports and Dependencies

---
- `fd_runtime.h`
- `context/fd_capture_ctx.h`
- `fd_acc_mgr.h`
- `fd_alut_interp.h`
- `fd_bank.h`
- `fd_hashes.h`
- `fd_runtime_err.h`
- `fd_runtime_init.h`
- `fd_runtime_stack.h`
- `fd_executor.h`
- `sysvar/fd_sysvar_cache.h`
- `sysvar/fd_sysvar_clock.h`
- `sysvar/fd_sysvar_epoch_schedule.h`
- `sysvar/fd_sysvar_recent_hashes.h`
- `sysvar/fd_sysvar_stake_history.h`
- `../stakes/fd_stakes.h`
- `../rewards/fd_rewards.h`
- `../progcache/fd_progcache_user.h`
- `context/fd_exec_txn_ctx.h`
- `program/fd_stake_program.h`
- `program/fd_builtin_programs.h`
- `sysvar/fd_sysvar_last_restart_slot.h`
- `sysvar/fd_sysvar_rent.h`
- `sysvar/fd_sysvar_slot_hashes.h`
- `sysvar/fd_sysvar_slot_history.h`
- `tests/fd_dump_pb.h`
- `fd_system_ids.h`
- `../../disco/pack/fd_pack.h`
- `unistd.h`
- `sys/stat.h`
- `sys/types.h`
- `fcntl.h`


# Functions

---
### fd\_runtime\_should\_use\_vote\_keyed\_leader\_schedule<!-- {{#callable:fd_runtime_should_use_vote_keyed_leader_schedule}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.c#L48>)

Determines if the vote-keyed leader schedule should be used based on the activation status and current epoch.
- **Inputs**:
    - ``bank``: A pointer to an `fd_bank_t` structure representing the bank context.
- **Logic and Control Flow**:
    - Check if the feature `enable_vote_address_leader_schedule` is active in the bank using `FD_FEATURE_ACTIVE_BANK`.
    - If the feature is active, retrieve the activation slot using `fd_bank_features_query`.
    - If the activation slot is 0, return 1, indicating the feature was activated at genesis.
    - Otherwise, calculate the activation epoch using [`fd_slot_to_epoch`](<sysvar/fd_sysvar_epoch_schedule.c.md#fd_slot_to_epoch>) and the effective epoch as the next epoch after activation.
    - Retrieve the current epoch using `fd_bank_epoch_get`.
    - Return 1 if the current epoch is greater than or equal to the effective epoch, otherwise return 0.
    - If the feature is not active, return 0 by default.
- **Output**: Returns an integer indicating whether the vote-keyed leader schedule should be used (1 for yes, 0 for no).
- **Functions Called**:
    - [`fd_slot_to_epoch`](<sysvar/fd_sysvar_epoch_schedule.c.md#fd_slot_to_epoch>)


---
### fd\_runtime\_compute\_max\_tick\_height<!-- {{#callable:fd_runtime_compute_max_tick_height}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.c#L83>)

Calculates the maximum tick height for a given slot and ticks per slot, handling potential overflow conditions.
- **Inputs**:
    - `ticks_per_slot`: The number of ticks in each slot, represented as an unsigned long integer.
    - `slot`: The current slot number, represented as an unsigned long integer.
    - `out_max_tick_height`: A pointer to an unsigned long integer where the function will store the calculated maximum tick height.
- **Logic and Control Flow**:
    - Initialize `max_tick_height` to 0.
    - Check if `ticks_per_slot` is greater than 0.
    - Calculate `next_slot` by adding 1 to `slot` using `fd_ulong_sat_add` to handle potential overflow.
    - If `next_slot` equals `slot`, log a warning about overflow and return -1.
    - Check if multiplying `next_slot` by `ticks_per_slot` would overflow by comparing with `ULONG_MAX`.
    - If overflow is detected, log a warning and return -1.
    - Calculate `max_tick_height` by multiplying `next_slot` and `ticks_per_slot` using `fd_ulong_sat_mul`.
    - Store the calculated `max_tick_height` in the location pointed to by `out_max_tick_height`.
    - Return `FD_RUNTIME_EXECUTE_SUCCESS` to indicate successful execution.
- **Output**: Returns `FD_RUNTIME_EXECUTE_SUCCESS` on success, or -1 if an overflow condition is detected.


---
### fd\_runtime\_update\_leaders<!-- {{#callable:fd_runtime_update_leaders}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.c#L104>)

Updates the leader schedule for the current epoch based on the previous epoch's vote states and stake weights.
- **Inputs**:
    - ``bank``: A pointer to an `fd_bank_t` structure representing the bank for which the leader schedule is being updated.
    - ``runtime_stack``: A pointer to an `fd_runtime_stack_t` structure that contains runtime data, including stake weights.
- **Logic and Control Flow**:
    - Query the epoch schedule from the bank using `fd_bank_epoch_schedule_query`.
    - Determine the current epoch and its starting slot and slot count using [`fd_slot_to_epoch`](<sysvar/fd_sysvar_epoch_schedule.c.md#fd_slot_to_epoch>), [`fd_epoch_slot0`](<sysvar/fd_sysvar_epoch_schedule.c.md#fd_epoch_slot0>), and [`fd_epoch_slot_cnt`](<sysvar/fd_sysvar_epoch_schedule.c.md#fd_epoch_slot_cnt>).
    - Lock and query the previous previous vote states using `fd_bank_vote_states_prev_prev_locking_query`.
    - Calculate the stake weights for the current epoch using `fd_stake_weights_by_node` and store them in `runtime_stack->stakes.stake_weights`.
    - End the locking query for the previous previous vote states using `fd_bank_vote_states_prev_prev_end_locking_query`.
    - Calculate the footprint for the epoch leaders using `fd_epoch_leaders_footprint`.
    - Check if the calculated footprint is valid and if the stake weight count and slot count do not exceed their respective maximums.
    - Determine if a vote-keyed leader schedule should be used with [`fd_runtime_should_use_vote_keyed_leader_schedule`](<#fd_runtime_should_use_vote_keyed_leader_schedule>).
    - Lock and modify the epoch leaders in the bank using `fd_bank_epoch_leaders_locking_modify`.
    - Create and join a new epoch leaders structure using `fd_epoch_leaders_new` and `fd_epoch_leaders_join`.
    - Check if the leaders structure was successfully created and joined, logging an error if not.
    - End the locking modification for the epoch leaders using `fd_bank_epoch_leaders_end_locking_modify`.
- **Output**: The function does not return a value; it updates the leader schedule in the bank's data structures.
- **Functions Called**:
    - [`fd_slot_to_epoch`](<sysvar/fd_sysvar_epoch_schedule.c.md#fd_slot_to_epoch>)
    - [`fd_epoch_slot0`](<sysvar/fd_sysvar_epoch_schedule.c.md#fd_epoch_slot0>)
    - [`fd_epoch_slot_cnt`](<sysvar/fd_sysvar_epoch_schedule.c.md#fd_epoch_slot_cnt>)
    - [`fd_runtime_should_use_vote_keyed_leader_schedule`](<#fd_runtime_should_use_vote_keyed_leader_schedule>)


---
### fd\_runtime\_validate\_fee\_collector<!-- {{#callable:fd_runtime_validate_fee_collector}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.c#L155>)

Validates a fee collector account and fee amount for a transaction, ensuring the fee is greater than zero, the account is owned by the system program, and the account is not rent-paying.
- **Inputs**:
    - ``bank``: A pointer to the `fd_bank_t` structure representing the bank context.
    - ``collector``: A pointer to a constant `fd_txn_account_t` structure representing the fee collector account.
    - ``fee``: An unsigned long integer representing the fee amount to be validated.
- **Logic and Control Flow**:
    - Check if the `fee` is less than or equal to zero; if so, log an error and terminate the program.
    - Compare the owner of the `collector` account with the system program ID; if they do not match, log a warning and return the `fee`.
    - Query the rent information from the `bank` and calculate the minimum balance required for rent exemption for the `collector` account.
    - Check if the sum of the `collector` account's lamports and the `fee` is less than the minimum balance; if so, log a warning and return the `fee`.
    - If all checks pass, return 0 indicating successful validation.
- **Output**: Returns 0 if validation succeeds, otherwise returns the `fee` amount to indicate failure.
- **Functions Called**:
    - [`fd_txn_account_get_owner`](<fd_txn_account.c.md#fd_txn_account_get_owner>)
    - [`fd_rent_exempt_minimum_balance`](<sysvar/fd_sysvar_rent1.c.md#fd_rent_exempt_minimum_balance>)
    - [`fd_txn_account_get_data_len`](<fd_txn_account.c.md#fd_txn_account_get_data_len>)
    - [`fd_txn_account_get_lamports`](<fd_txn_account.c.md#fd_txn_account_get_lamports>)


---
### fd\_runtime\_run\_incinerator<!-- {{#callable:fd_runtime_run_incinerator}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.c#L202>)

Executes the incineration process for a transaction account, updating the bank's capitalization and account state.
- **Inputs**:
    - ``bank``: A pointer to an `fd_bank_t` structure representing the bank where the transaction occurs.
    - ``accdb``: A pointer to an `fd_accdb_user_t` structure representing the account database user context.
    - ``xid``: A pointer to a constant `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``capture_ctx``: A pointer to an `fd_capture_ctx_t` structure used for capturing context during the transaction.
- **Logic and Control Flow**:
    - Initialize a transaction account record and a preparation structure.
    - Call [`fd_txn_account_init_from_funk_mutable`](<fd_txn_account.c.md#fd_txn_account_init_from_funk_mutable>) to initialize the transaction account from the incinerator ID.
    - If initialization fails, return -1, indicating no error but a non-execution state.
    - Compute the previous hash of the account using [`fd_hashes_account_lthash`](<fd_hashes.c.md#fd_hashes_account_lthash>).
    - Calculate the new bank capitalization by subtracting the account's lamports from the current capitalization.
    - Set the account's lamports to zero using [`fd_txn_account_set_lamports`](<fd_txn_account.c.md#fd_txn_account_set_lamports>).
    - Update the account's hash in the ledger using [`fd_hashes_update_lthash`](<fd_hashes.c.md#fd_hashes_update_lthash>).
    - Finalize the transaction account using [`fd_txn_account_mutable_fini`](<fd_txn_account.c.md#fd_txn_account_mutable_fini>).
    - Return 0 to indicate successful execution.
- **Output**: Returns 0 on successful execution, or -1 if the account initialization fails (not considered an error).
- **Functions Called**:
    - [`fd_txn_account_init_from_funk_mutable`](<fd_txn_account.c.md#fd_txn_account_init_from_funk_mutable>)
    - [`fd_hashes_account_lthash`](<fd_hashes.c.md#fd_hashes_account_lthash>)
    - [`fd_txn_account_get_meta`](<fd_txn_account.c.md#fd_txn_account_get_meta>)
    - [`fd_txn_account_get_data`](<fd_txn_account.c.md#fd_txn_account_get_data>)
    - [`fd_txn_account_get_lamports`](<fd_txn_account.c.md#fd_txn_account_get_lamports>)
    - [`fd_txn_account_set_lamports`](<fd_txn_account.c.md#fd_txn_account_set_lamports>)
    - [`fd_hashes_update_lthash`](<fd_hashes.c.md#fd_hashes_update_lthash>)
    - [`fd_txn_account_mutable_fini`](<fd_txn_account.c.md#fd_txn_account_mutable_fini>)


---
### fd\_runtime\_freeze<!-- {{#callable:fd_runtime_freeze}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.c#L236>)

Freezes the state of a bank by updating system variables, calculating and distributing fees, and running the incinerator.
- **Inputs**:
    - `bank`: A pointer to `fd_bank_t`, representing the bank whose state is to be frozen.
    - `accdb`: A pointer to `fd_accdb_user_t`, representing the account database user context.
    - `xid`: A constant pointer to `fd_funk_txn_xid_t`, representing the transaction ID.
    - `capture_ctx`: A pointer to `fd_capture_ctx_t`, representing the capture context for logging and debugging.
- **Logic and Control Flow**:
    - Checks if the bank slot is non-zero and updates recent hashes if true.
    - Updates the slot history system variable.
    - Retrieves execution and priority fees from the bank.
    - Calculates the burn amount and total fees to be distributed.
    - If fees are non-zero, attempts to distribute them to the leader account.
    - Locks and queries the current epoch leaders; logs critical errors if not found.
    - Initializes a transaction account for the leader and logs warnings if initialization fails.
    - Validates the fee collector account if the feature is active, and adjusts burn if validation fails.
    - Adds fees to the leader's account and updates the account's slot and hash.
    - Updates the bank's capitalization by subtracting the burn amount.
    - Resets execution and priority fees in the bank to zero.
    - Runs the incinerator to finalize the freezing process.
- **Output**: No direct output; modifies the state of the bank and logs relevant information.
- **Functions Called**:
    - [`fd_sysvar_recent_hashes_update`](<sysvar/fd_sysvar_recent_hashes.c.md#fd_sysvar_recent_hashes_update>)
    - [`fd_sysvar_slot_history_update`](<sysvar/fd_sysvar_slot_history.c.md#fd_sysvar_slot_history_update>)
    - [`fd_txn_account_init_from_funk_mutable`](<fd_txn_account.c.md#fd_txn_account_init_from_funk_mutable>)
    - [`fd_hashes_account_lthash`](<fd_hashes.c.md#fd_hashes_account_lthash>)
    - [`fd_txn_account_get_meta`](<fd_txn_account.c.md#fd_txn_account_get_meta>)
    - [`fd_txn_account_get_data`](<fd_txn_account.c.md#fd_txn_account_get_data>)
    - [`fd_runtime_validate_fee_collector`](<#fd_runtime_validate_fee_collector>)
    - [`fd_txn_account_checked_add_lamports`](<fd_txn_account.c.md#fd_txn_account_checked_add_lamports>)
    - [`fd_txn_account_set_slot`](<fd_txn_account.c.md#fd_txn_account_set_slot>)
    - [`fd_hashes_update_lthash`](<fd_hashes.c.md#fd_hashes_update_lthash>)
    - [`fd_txn_account_mutable_fini`](<fd_txn_account.c.md#fd_txn_account_mutable_fini>)
    - [`fd_runtime_run_incinerator`](<#fd_runtime_run_incinerator>)


---
### fd\_runtime\_new\_fee\_rate\_governor\_derived<!-- {{#callable:fd_runtime_new_fee_rate_governor_derived}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.c#L338>)

Calculates and updates the new fee rate governor and lamports per signature based on the latest signatures per slot.
- **Inputs**:
    - ``bank``: A pointer to an `fd_bank_t` structure representing the bank where the fee rate governor and lamports per signature will be updated.
    - ``latest_signatures_per_slot``: An unsigned long integer representing the latest number of signatures per slot.
- **Logic and Control Flow**:
    - Query the current base fee rate governor from the bank using `fd_bank_fee_rate_governor_query`.
    - Retrieve the old lamports per signature using `fd_bank_lamports_per_signature_get`.
    - Initialize a new fee rate governor structure `me` with values from the base fee rate governor.
    - If `me.target_signatures_per_slot` is greater than 0, calculate `min_lamports_per_signature` and `max_lamports_per_signature` based on the target values.
    - Calculate `desired_lamports_per_signature` using the minimum and maximum constraints and the ratio of `latest_signatures_per_slot` to `target_signatures_per_slot`.
    - Determine the gap between `desired_lamports_per_signature` and `old_lamports_per_signature`.
    - If the gap is zero, set `new_lamports_per_signature` to `desired_lamports_per_signature`.
    - If the gap is not zero, adjust `new_lamports_per_signature` by a calculated `gap_adjust` value, ensuring it remains within the min and max constraints.
    - If `me.target_signatures_per_slot` is zero, set `new_lamports_per_signature` to `base_fee_rate_governor->target_lamports_per_signature` and adjust min and max lamports per signature accordingly.
    - Set the previous lamports per signature in the bank using `fd_bank_prev_lamports_per_signature_set`, depending on whether the old value was zero.
    - Update the bank's fee rate governor with the new values using `fd_bank_fee_rate_governor_set`.
    - Set the new lamports per signature in the bank using `fd_bank_lamports_per_signature_set`.
- **Output**: The function does not return a value; it updates the bank's fee rate governor and lamports per signature in place.


---
### fd\_runtime\_block\_sysvar\_update\_pre\_execute<!-- {{#callable:fd_runtime_block_sysvar_update_pre_execute}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.c#L399>)

Updates system variables and fee rate governor before executing a block.
- **Inputs**:
    - ``bank``: Pointer to the `fd_bank_t` structure representing the bank.
    - ``accdb``: Pointer to the `fd_accdb_user_t` structure representing the account database.
    - ``xid``: Pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``runtime_stack``: Pointer to the `fd_runtime_stack_t` structure representing the runtime stack.
    - ``capture_ctx``: Pointer to the `fd_capture_ctx_t` structure representing the capture context.
- **Logic and Control Flow**:
    - Calls [`fd_runtime_new_fee_rate_governor_derived`](<#fd_runtime_new_fee_rate_governor_derived>) to update the fee rate governor based on the parent bank's signature count.
    - Queries the epoch schedule from the bank and calculates the parent epoch using [`fd_slot_to_epoch`](<sysvar/fd_sysvar_epoch_schedule.c.md#fd_slot_to_epoch>).
    - Updates the system variable clock using [`fd_sysvar_clock_update`](<sysvar/fd_sysvar_clock.c.md#fd_sysvar_clock_update>) with the parent epoch.
    - Checks if the current bank slot is not zero; if true, updates the slot hashes using [`fd_sysvar_slot_hashes_update`](<sysvar/fd_sysvar_slot_hashes.c.md#fd_sysvar_slot_hashes_update>).
    - Updates the last restart slot system variable using [`fd_sysvar_last_restart_slot_update`](<sysvar/fd_sysvar_last_restart_slot.c.md#fd_sysvar_last_restart_slot_update>).
    - Returns 0 to indicate successful execution.
- **Output**: Returns an integer, always 0, indicating successful execution.
- **Functions Called**:
    - [`fd_runtime_new_fee_rate_governor_derived`](<#fd_runtime_new_fee_rate_governor_derived>)
    - [`fd_slot_to_epoch`](<sysvar/fd_sysvar_epoch_schedule.c.md#fd_slot_to_epoch>)
    - [`fd_sysvar_clock_update`](<sysvar/fd_sysvar_clock.c.md#fd_sysvar_clock_update>)
    - [`fd_sysvar_slot_hashes_update`](<sysvar/fd_sysvar_slot_hashes.c.md#fd_sysvar_slot_hashes_update>)
    - [`fd_sysvar_last_restart_slot_update`](<sysvar/fd_sysvar_last_restart_slot.c.md#fd_sysvar_last_restart_slot_update>)


---
### fd\_runtime\_load\_txn\_address\_lookup\_tables<!-- {{#callable:fd_runtime_load_txn_address_lookup_tables}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.c#L425>)

Loads transaction address lookup tables and processes them for a given transaction.
- **Inputs**:
    - ``txn``: A pointer to a `fd_txn_t` structure representing the transaction to process.
    - ``payload``: A pointer to an array of unsigned characters representing the transaction payload.
    - ``funk``: A pointer to a `fd_funk_t` structure used for database operations.
    - ``xid``: A pointer to a `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``slot``: An unsigned long integer representing the slot number.
    - ``hashes``: A pointer to a `fd_slot_hash_t` structure representing a deque of slot hashes.
    - ``out_accts_alt``: A pointer to a `fd_acct_addr_t` structure where the output account addresses will be stored.
- **Logic and Control Flow**:
    - Check if the transaction version is not `FD_TXN_V0`; if true, return `FD_RUNTIME_EXECUTE_SUCCESS` immediately.
    - Initialize an `fd_alut_interp_t` structure and call [`fd_alut_interp_new`](<fd_alut_interp.h.md#fd_alut_interp_new>) to set up the interpreter with the provided parameters.
    - Retrieve the address lookup tables from the transaction using `fd_txn_get_address_tables_const`.
    - Iterate over each address lookup table in the transaction.
    - For each address lookup table, load the public key from the payload and initialize a transaction account record using [`fd_txn_account_init_from_funk_readonly`](<fd_txn_account.c.md#fd_txn_account_init_from_funk_readonly>).
    - If the account initialization fails, return `FD_RUNTIME_TXN_ERR_ADDRESS_LOOKUP_TABLE_NOT_FOUND`.
    - Call [`fd_alut_interp_next`](<fd_alut_interp.h.md#fd_alut_interp_next>) to process the next address lookup table entry with the interpreter.
    - If an error occurs during processing, return the error code.
    - If all address lookup tables are processed successfully, return `FD_RUNTIME_EXECUTE_SUCCESS`.
- **Output**: Returns an integer status code indicating success or a specific error related to address lookup table processing.
- **Functions Called**:
    - [`fd_alut_interp_new`](<fd_alut_interp.h.md#fd_alut_interp_new>)
    - [`fd_txn_account_init_from_funk_readonly`](<fd_txn_account.c.md#fd_txn_account_init_from_funk_readonly>)
    - [`fd_alut_interp_next`](<fd_alut_interp.h.md#fd_alut_interp_next>)
    - [`fd_txn_account_get_owner`](<fd_txn_account.c.md#fd_txn_account_get_owner>)
    - [`fd_txn_account_get_data`](<fd_txn_account.c.md#fd_txn_account_get_data>)
    - [`fd_txn_account_get_data_len`](<fd_txn_account.c.md#fd_txn_account_get_data_len>)


---
### fd\_runtime\_block\_execute\_prepare<!-- {{#callable:fd_runtime_block_execute_prepare}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.c#L471>)

Prepares the execution environment for a block by resetting bank metrics, updating system variables, and restoring the system variable cache.
- **Inputs**:
    - `bank`: A pointer to the `fd_bank_t` structure representing the bank to prepare for execution.
    - `accdb`: A pointer to the `fd_accdb_user_t` structure representing the account database user context.
    - `xid`: A pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID.
    - `runtime_stack`: A pointer to the `fd_runtime_stack_t` structure representing the runtime stack.
    - `capture_ctx`: A pointer to the `fd_capture_ctx_t` structure representing the capture context.
- **Logic and Control Flow**:
    - Set execution fees, priority fees, signature count, and total compute units used in the bank to zero.
    - Check if the bank slot is non-zero; if so, lock and modify the cost tracker, initialize it with bank features and slot, and then end the locking modification.
    - Call [`fd_runtime_block_sysvar_update_pre_execute`](<#fd_runtime_block_sysvar_update_pre_execute>) to update system variables before execution; if it fails, log a warning and return the result.
    - Attempt to restore the system variable cache; if it fails, log an error message.
- **Output**: Returns an integer status code, `FD_RUNTIME_EXECUTE_SUCCESS` on success, or an error code if a failure occurs during preparation.
- **Functions Called**:
    - [`fd_bank_cost_tracker_locking_modify`](<fd_bank.h.md#fd_bank_cost_tracker_locking_modify>)
    - [`fd_bank_cost_tracker_end_locking_modify`](<fd_bank.h.md#fd_bank_cost_tracker_end_locking_modify>)
    - [`fd_runtime_block_sysvar_update_pre_execute`](<#fd_runtime_block_sysvar_update_pre_execute>)
    - [`fd_sysvar_cache_restore`](<sysvar/fd_sysvar_cache_db.c.md#fd_sysvar_cache_restore>)


---
### fd\_runtime\_update\_bank\_hash<!-- {{#callable:fd_runtime_update_bank_hash}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.c#L502>)

Updates the bank hash by computing a new hash based on the current state of the bank and optionally logs the update if not in silent mode.
- **Inputs**:
    - ``bank``: A pointer to the `fd_bank_t` structure representing the bank whose hash is to be updated.
    - ``capture_ctx``: A pointer to the `fd_capture_ctx_t` structure used for capturing context, which may be used for writing bank preimage if applicable.
    - ``silent``: An integer flag indicating whether to suppress logging output (non-zero value) or not (zero value).
- **Logic and Control Flow**:
    - Check if the bank slot is not zero; if true, query the current bank hash and set it as the previous bank hash.
    - Set the parent signature count of the bank to the current signature count.
    - Query the locking hash (`lthash`) of the bank and compute a new bank hash using the [`fd_hashes_hash_bank`](<fd_hashes.c.md#fd_hashes_hash_bank>) function with the `lthash`, previous bank hash, and other parameters.
    - Set the computed new bank hash as the current bank hash of the bank.
    - If `silent` is zero, log the bank's slot, new bank hash, parent bank hash, `lthash`, signature count, and last block hash.
    - If `capture_ctx` is not NULL and the bank slot is greater than or equal to `capture_ctx->solcap_start_slot`, compute a hash of the `lthash` and write the bank preimage using `fd_solcap_write_bank_preimage`.
    - End the locking query on the bank's `lthash`.
- **Output**: The function does not return a value; it updates the bank's hash and may log information or write a bank preimage based on the input parameters.
- **Functions Called**:
    - [`fd_hashes_hash_bank`](<fd_hashes.c.md#fd_hashes_hash_bank>)


---
### fd\_runtime\_pre\_execute\_check<!-- {{#callable:fd_runtime_pre_execute_check}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.c#L572>)

Conducts pre-execution checks and setup for a transaction, including verification, account key resolution, and fee validation.
- **Inputs**:
    - `txn_ctx`: A pointer to `fd_exec_txn_ctx_t`, which contains the transaction context and metadata for execution.
- **Logic and Control Flow**:
    - Check if transaction dumping to protobuf is enabled and perform the dump if necessary.
    - Verify the transaction by processing compute budget instructions; if verification fails, set flags to 0 and return the error.
    - Resolve and verify ALUT-referenced account keys; if verification fails, set flags to 0 and return the error.
    - Set up transaction accounts and other metadata in the transaction context.
    - Perform post-sanitization checks, including account locking and basic validations; if checks fail, set flags to 0 and return the error.
    - Check transactions for validity; if checks fail, set flags to 0 and return the error.
    - Validate the transaction fee payer; if validation fails, set flags to 0 and return the error.
    - Load transaction accounts; if loading fails, set flags to indicate fees-only processing and adjust loaded accounts data size accordingly.
    - Return the final error code from the checks.
- **Output**: Returns an integer error code indicating the success or failure of the pre-execution checks.
- **Functions Called**:
    - [`fd_dump_txn_to_protobuf`](<tests/fd_dump_pb.c.md#fd_dump_txn_to_protobuf>)
    - [`fd_executor_verify_transaction`](<fd_executor.c.md#fd_executor_verify_transaction>)
    - [`fd_executor_setup_txn_alut_account_keys`](<fd_executor.c.md#fd_executor_setup_txn_alut_account_keys>)
    - [`fd_executor_setup_accounts_for_txn`](<fd_executor.c.md#fd_executor_setup_accounts_for_txn>)
    - [`fd_executor_validate_account_locks`](<fd_executor.c.md#fd_executor_validate_account_locks>)
    - [`fd_executor_check_transactions`](<fd_executor.c.md#fd_executor_check_transactions>)
    - [`fd_executor_validate_transaction_fee_payer`](<fd_executor.c.md#fd_executor_validate_transaction_fee_payer>)
    - [`fd_executor_load_transaction_accounts`](<fd_executor.c.md#fd_executor_load_transaction_accounts>)
    - [`fd_txn_account_get_data_len`](<fd_txn_account.c.md#fd_txn_account_get_data_len>)


---
### fd\_runtime\_finalize\_account<!-- {{#callable:fd_runtime_finalize_account}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.c#L704>)

Finalizes an account by updating its record in the database and publishing changes if necessary.
- **Inputs**:
    - ``funk``: A pointer to the `fd_funk_t` structure representing the database context.
    - ``xid``: A constant pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``acc``: A pointer to the `fd_txn_account_t` structure representing the account to finalize.
    - ``prev_rec``: A pointer to the `fd_funk_rec_t` structure representing the previous record of the account, or `NULL` if there is no previous record.
- **Logic and Control Flow**:
    - Checks if the account is mutable using [`fd_txn_account_is_mutable`](<fd_txn_account.c.md#fd_txn_account_is_mutable>); logs a critical error if not.
    - Retrieves the account's public key, metadata, and record size.
    - Initializes an error variable `err` to `FD_FUNK_SUCCESS`.
    - If `prev_rec` is `NULL` or its transaction ID does not match `xid`, prepares a new record using `fd_funk_rec_prepare`.
    - If record preparation fails, logs an error and exits.
    - Truncates the record's value to the correct size using `fd_funk_val_truncate`; logs an error if truncation fails.
    - Copies the account's metadata to the record's value using `fd_memcpy`.
    - Publishes the prepared record using `fd_funk_rec_publish`.
    - If `prev_rec` is valid and its transaction ID matches `xid`, truncates its value and copies the account's metadata to it.
- **Output**: No return value; the function operates by side effects on the provided pointers.
- **Functions Called**:
    - [`fd_txn_account_is_mutable`](<fd_txn_account.c.md#fd_txn_account_is_mutable>)
    - [`fd_txn_account_get_meta`](<fd_txn_account.c.md#fd_txn_account_get_meta>)
    - [`fd_account_meta_get_record_sz`](<fd_acc_mgr.h.md#fd_account_meta_get_record_sz>)
    - [`fd_funk_rec_key_t::fd_funk_acc_key`](<fd_acc_mgr.h.md#fd_funk_rec_key_tfd_funk_acc_key>)


---
### fd\_runtime\_buffer\_solcap\_account\_update<!-- {{#callable:fd_runtime_buffer_solcap_account_update}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.c#L766>)

Buffers an account update event message in the capture context for later transmission.
- **Inputs**:
    - ``account``: A pointer to an `fd_txn_account_t` structure representing the account to update.
    - ``bank``: A pointer to an `fd_bank_t` structure representing the bank associated with the account.
    - ``capture_ctx``: A pointer to an `fd_capture_ctx_t` structure representing the capture context where the update will be buffered.
- **Logic and Control Flow**:
    - Check if `capture_ctx` is valid and if the bank's slot is greater than or equal to `capture_ctx->solcap_start_slot`; if not, return immediately.
    - Retrieve the account's metadata and data using [`fd_txn_account_get_meta`](<fd_txn_account.c.md#fd_txn_account_get_meta>) and [`fd_txn_account_get_data`](<fd_txn_account.c.md#fd_txn_account_get_data>).
    - Calculate the account hash using [`fd_hashes_account_lthash`](<fd_hashes.c.md#fd_hashes_account_lthash>) and store it in `lthash`.
    - Check if the number of account updates in `capture_ctx` has reached `FD_CAPTURE_CTX_MAX_ACCOUNT_UPDATES`; if so, log a critical error and return.
    - Write the account update message to the buffer, including the account's public key, Solana metadata, data size, bank index, and hash.
    - Increment the buffer pointer by the size of the account update message.
    - Copy the account data to the buffer and increment the buffer pointer by the data size.
    - Increment the account updates length in `capture_ctx`.
- **Output**: None (the function returns void).
- **Functions Called**:
    - [`fd_txn_account_get_meta`](<fd_txn_account.c.md#fd_txn_account_get_meta>)
    - [`fd_txn_account_get_data`](<fd_txn_account.c.md#fd_txn_account_get_data>)
    - [`fd_hashes_account_lthash`](<fd_hashes.c.md#fd_hashes_account_lthash>)
    - [`fd_txn_account_get_solana_meta`](<fd_txn_account.c.md#fd_txn_account_get_solana_meta>)


---
### fd\_runtime\_save\_account<!-- {{#callable:fd_runtime_save_account}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.c#L831>)

Saves the current state of a transaction account to the Funk database, updates the bank hash, and notifies the replay tile of the account update.
- **Inputs**:
    - ``funk``: A pointer to the `fd_funk_t` structure representing the Funk database handle.
    - ``xid``: A pointer to the `fd_funk_txn_xid_t` structure representing the transaction context to query.
    - ``account``: A pointer to the `fd_txn_account_t` structure representing the modified account.
    - ``bank``: A pointer to the `fd_bank_t` structure representing the bank where the account is being updated.
    - ``acc_data_wksp``: A pointer to the `fd_wksp_t` structure representing the workspace for account data.
    - ``capture_ctx``: A pointer to the `fd_capture_ctx_t` structure used for capturing context for solcap writing.
- **Logic and Control Flow**:
    - Join the transaction account using [`fd_txn_account_join`](<fd_txn_account.c.md#fd_txn_account_join>) and `acc_data_wksp`.
    - If joining the account fails, log a critical error and exit.
    - Retrieve the previous version of the account from Funk using [`fd_funk_get_acc_meta_readonly`](<fd_acc_mgr.c.md#fd_funk_get_acc_meta_readonly>).
    - If the account is not unknown, compute the hash of the previous account version using [`fd_hashes_account_lthash`](<fd_hashes.c.md#fd_hashes_account_lthash>).
    - Update the bank hash by mixing in the account hash using [`fd_hashes_update_lthash`](<fd_hashes.c.md#fd_hashes_update_lthash>).
    - Publish the account update to the replay tile for solcap writing using [`fd_runtime_buffer_solcap_account_update`](<#fd_runtime_buffer_solcap_account_update>).
    - Save the new version of the account to Funk using [`fd_runtime_finalize_account`](<#fd_runtime_finalize_account>).
- **Output**: No return value; the function performs operations on the provided pointers and logs errors if necessary.
- **Functions Called**:
    - [`fd_txn_account_join`](<fd_txn_account.c.md#fd_txn_account_join>)
    - [`fd_funk_get_acc_meta_readonly`](<fd_acc_mgr.c.md#fd_funk_get_acc_meta_readonly>)
    - [`fd_hashes_account_lthash`](<fd_hashes.c.md#fd_hashes_account_lthash>)
    - [`fd_hashes_update_lthash`](<fd_hashes.c.md#fd_hashes_update_lthash>)
    - [`fd_runtime_buffer_solcap_account_update`](<#fd_runtime_buffer_solcap_account_update>)
    - [`fd_runtime_finalize_account`](<#fd_runtime_finalize_account>)


---
### fd\_runtime\_finalize\_txn<!-- {{#callable:fd_runtime_finalize_txn}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.c#L883>)

Finalizes a transaction by collecting fees, handling account rollbacks or updates, and updating caches and counters.
- **Inputs**:
    - ``funk``: A pointer to the `fd_funk_t` structure, representing the database handle for account management.
    - ``progcache``: A pointer to the `fd_progcache_t` structure, used for managing program cache.
    - ``txncache``: A pointer to the `fd_txncache_t` structure, used for managing transaction cache.
    - ``xid``: A constant pointer to the `fd_funk_txn_xid_t` structure, representing the transaction context identifier.
    - ``txn_ctx``: A pointer to the `fd_exec_txn_ctx_t` structure, representing the execution context of the transaction.
    - ``bank``: A pointer to the `fd_bank_t` structure, representing the bank where the transaction is executed.
    - ``capture_ctx``: A pointer to the `fd_capture_ctx_t` structure, used for capturing execution context.
- **Logic and Control Flow**:
    - Collects transaction fees and updates the bank's fee counters.
    - Checks if there was an execution error in the transaction context.
    - If there is an execution error, saves the state of the fee payer and nonce account if applicable.
    - If there is no execution error, iterates over accounts in the transaction context to save writable accounts and update vote or stake states if necessary.
    - Reclaims accounts with zero lamports after cache updates.
    - Invalidates program cache entries for programs that need reverification.
    - Determines if the transaction is a vote transaction and updates non-vote transaction counters accordingly.
    - Updates the total compute units used in the bank.
    - Calculates and adds the transaction cost to the cost tracker.
    - If applicable, inserts the transaction into the transaction cache.
- **Output**: No return value; the function operates by modifying the state of the provided structures.
- **Functions Called**:
    - [`fd_runtime_save_account`](<#fd_runtime_save_account>)
    - [`fd_exec_txn_ctx_account_is_writable_idx`](<context/fd_exec_txn_ctx.c.md#fd_exec_txn_ctx_account_is_writable_idx>)
    - [`fd_txn_account_join`](<fd_txn_account.c.md#fd_txn_account_join>)
    - [`fd_txn_account_get_owner`](<fd_txn_account.c.md#fd_txn_account_get_owner>)
    - [`fd_executor_reclaim_account`](<fd_executor.c.md#fd_executor_reclaim_account>)
    - [`fd_bank_cost_tracker_locking_modify`](<fd_bank.h.md#fd_bank_cost_tracker_locking_modify>)
    - [`fd_bank_cost_tracker_end_locking_modify`](<fd_bank.h.md#fd_bank_cost_tracker_end_locking_modify>)


---
### fd\_runtime\_prepare\_and\_execute\_txn<!-- {{#callable:fd_runtime_prepare_and_execute_txn}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.c#L1003>)

Prepares and executes a transaction in a specified bank context, performing necessary setup, checks, and execution steps.
- **Inputs**:
    - `banks`: A pointer to `fd_banks_t`, representing the collection of banks where the transaction will be executed.
    - `bank_idx`: An unsigned long integer representing the index of the bank within `banks` where the transaction will be executed.
    - `txn_ctx`: A pointer to `fd_exec_txn_ctx_t`, which is the execution context for the transaction, containing necessary metadata and state.
    - `txn`: A pointer to `fd_txn_p_t`, representing the transaction to be executed.
    - `capture_ctx`: A pointer to `fd_capture_ctx_t`, which is the context for capturing execution details, if applicable.
- **Logic and Control Flow**:
    - Initialize `exec_res` to 0 to store the result of execution.
    - Query the bank from `banks` using `bank_idx` and log a critical error if the bank is not found.
    - Retrieve the current slot from the bank and store it in `slot`.
    - Set up the transaction context `txn_ctx` with bank details, slot, bank index, features, execution recording flag, transaction ID, capture context, and transaction data.
    - Set the `txn_ctx` flags to `FD_TXN_P_FLAGS_SANITIZE_SUCCESS` and call [`fd_exec_txn_ctx_setup_basic`](<context/fd_exec_txn_ctx.c.md#fd_exec_txn_ctx_setup_basic>) to perform basic setup.
    - Set up the core account keys for the transaction using [`fd_executor_setup_txn_account_keys`](<fd_executor.c.md#fd_executor_setup_txn_account_keys>).
    - Perform pre-execution checks using [`fd_runtime_pre_execute_check`](<#fd_runtime_pre_execute_check>) and return `exec_res` if sanitization fails.
    - If the transaction is not fees-only, execute the transaction using [`fd_execute_txn`](<fd_executor.c.md#fd_execute_txn>) and update `exec_res`.
    - Return the result of the transaction execution stored in `exec_res`.
- **Output**: Returns an integer `exec_res`, which indicates the result of the transaction execution process.
- **Functions Called**:
    - [`fd_banks_bank_query`](<fd_bank.h.md#fd_banks_bank_query>)
    - [`fd_exec_txn_ctx_setup_basic`](<context/fd_exec_txn_ctx.c.md#fd_exec_txn_ctx_setup_basic>)
    - [`fd_executor_setup_txn_account_keys`](<fd_executor.c.md#fd_executor_setup_txn_account_keys>)
    - [`fd_runtime_pre_execute_check`](<#fd_runtime_pre_execute_check>)
    - [`fd_execute_txn`](<fd_executor.c.md#fd_execute_txn>)


---
### fd\_update\_vote\_states\_prev\_prev<!-- {{#callable:fd_update_vote_states_prev_prev}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.c#L1093>)

Updates the vote states for the previous-previous epoch with the vote states from the previous epoch.
- **Inputs**:
    - ``bank``: A pointer to an `fd_bank_t` structure representing the bank whose vote states are to be updated.
- **Logic and Control Flow**:
    - Locks and modifies the vote states for the previous-previous epoch using `fd_bank_vote_states_prev_prev_locking_modify`.
    - Queries the vote states for the previous epoch using `fd_bank_vote_states_prev_locking_query`.
    - Copies the vote states from the previous epoch to the previous-previous epoch using `fd_memcpy`.
    - Ends the modification lock on the previous-previous vote states using `fd_bank_vote_states_prev_prev_end_locking_modify`.
    - Ends the query lock on the previous vote states using `fd_bank_vote_states_prev_end_locking_query`.
- **Output**: No return value; the function operates directly on the `bank` structure to update its state.


---
### fd\_update\_vote\_states\_prev<!-- {{#callable:fd_update_vote_states_prev}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.c#L1106>)

Updates the previous vote states with the current vote states in the bank.
- **Inputs**:
    - `bank`: A pointer to an `fd_bank_t` structure representing the bank whose vote states are to be updated.
- **Logic and Control Flow**:
    - Lock and modify the previous vote states using `fd_bank_vote_states_prev_locking_modify`.
    - Query the current vote states using `fd_bank_vote_states_locking_query`.
    - Copy the current vote states to the previous vote states using `fd_memcpy`.
    - End the modification of the previous vote states with `fd_bank_vote_states_prev_end_locking_modify`.
    - End the query of the current vote states with `fd_bank_vote_states_end_locking_query`.
- **Output**: None (void function).


---
### fd\_apply\_builtin\_program\_feature\_transitions<!-- {{#callable:fd_apply_builtin_program_feature_transitions}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.c#L1116>)

Applies feature transitions for built-in programs, migrating them to core BPF if necessary, and enabling features based on activation status.
- **Inputs**:
    - ``bank``: A pointer to `fd_bank_t`, representing the bank state.
    - ``accdb``: A pointer to `fd_accdb_user_t`, representing the account database user context.
    - ``xid``: A constant pointer to `fd_funk_txn_xid_t`, representing the transaction ID.
    - ``runtime_stack``: A pointer to `fd_runtime_stack_t`, representing the runtime stack.
    - ``capture_ctx``: A pointer to `fd_capture_ctx_t`, representing the capture context.
- **Logic and Control Flow**:
    - Retrieve the list of built-in programs using `fd_builtins()` and iterate over them.
    - For each built-in program, check if it has a core BPF migration configuration and if the feature is active using `FD_FEATURE_ACTIVE_OFFSET`.
    - If the feature is active, log the migration and call [`fd_migrate_builtin_to_core_bpf`](<fd_core_bpf_migration.c.md#fd_migrate_builtin_to_core_bpf>) to migrate the program to core BPF.
    - Check if the built-in program has an `enable_feature_offset` and if the feature was just activated using `FD_FEATURE_JUST_ACTIVATED_OFFSET`.
    - If the feature was just activated, log the enabling and call [`fd_write_builtin_account`](<program/fd_builtin_programs.c.md#fd_write_builtin_account>) to enable the built-in program.
    - Retrieve the list of stateless built-in programs using `fd_stateless_builtins()` and iterate over them.
    - For each stateless built-in program, check if it has a core BPF migration configuration and if the feature is active using `FD_FEATURE_ACTIVE_OFFSET`.
    - If the feature is active, log the migration and call [`fd_migrate_builtin_to_core_bpf`](<fd_core_bpf_migration.c.md#fd_migrate_builtin_to_core_bpf>) to migrate the stateless program to core BPF.
    - Retrieve the list of precompile programs using `fd_precompiles()` and iterate over them.
    - For each precompile program, check if it has a `feature_offset` and if the feature was just activated using `FD_FEATURE_JUST_ACTIVATED_OFFSET`.
    - If the feature was just activated, call [`fd_write_builtin_account`](<program/fd_builtin_programs.c.md#fd_write_builtin_account>) to enable the precompile program.
- **Output**: This function does not return a value; it performs operations on the provided bank and account database contexts.
- **Functions Called**:
    - [`fd_builtins`](<program/fd_builtin_programs.c.md#fd_builtins>)
    - [`fd_num_builtins`](<program/fd_builtin_programs.c.md#fd_num_builtins>)
    - [`fd_migrate_builtin_to_core_bpf`](<fd_core_bpf_migration.c.md#fd_migrate_builtin_to_core_bpf>)
    - [`fd_write_builtin_account`](<program/fd_builtin_programs.c.md#fd_write_builtin_account>)
    - [`fd_stateless_builtins`](<program/fd_builtin_programs.c.md#fd_stateless_builtins>)
    - [`fd_num_stateless_builtins`](<program/fd_builtin_programs.c.md#fd_num_stateless_builtins>)
    - [`fd_precompiles`](<program/fd_builtin_programs.c.md#fd_precompiles>)
    - [`fd_num_precompiles`](<program/fd_builtin_programs.c.md#fd_num_precompiles>)


---
### fd\_feature\_activate<!-- {{#callable:fd_feature_activate}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.c#L1161>)

Activates a feature in the bank if it is not already activated, updating the feature account and bank state accordingly.
- **Inputs**:
    - ``bank``: A pointer to the `fd_bank_t` structure representing the bank where the feature activation will occur.
    - ``accdb``: A pointer to the `fd_accdb_user_t` structure representing the account database user context.
    - ``xid``: A pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID context.
    - ``capture_ctx``: A pointer to the `fd_capture_ctx_t` structure used for capturing context during the operation.
    - ``id``: A pointer to the `fd_feature_id_t` structure representing the feature ID to be activated.
    - ``addr``: A pointer to the `fd_pubkey_t` structure representing the public key address of the feature account.
- **Logic and Control Flow**:
    - Retrieve the modifiable features from the bank using `fd_bank_features_modify`.
    - Check if the feature ID is marked as reverted; if so, exit the function.
    - Initialize a transaction account record for the feature account using [`fd_txn_account_init_from_funk_readonly`](<fd_txn_account.c.md#fd_txn_account_init_from_funk_readonly>).
    - If the account initialization fails, exit the function.
    - Decode the feature account data using `fd_bincode_decode_static`.
    - If decoding fails, log a warning and exit the function.
    - Check if the feature is already activated; if so, log a debug message and update the bank features with the activation slot.
    - If the feature is not activated, log a debug message indicating activation.
    - Initialize a mutable transaction account record for modification using [`fd_txn_account_init_from_funk_mutable`](<fd_txn_account.c.md#fd_txn_account_init_from_funk_mutable>).
    - If initialization fails, exit the function.
    - Compute the previous hash of the account using [`fd_hashes_account_lthash`](<fd_hashes.c.md#fd_hashes_account_lthash>).
    - Set the feature's activation status and slot using `fd_bank_slot_get`.
    - Encode the updated feature data using `fd_feature_encode`.
    - If encoding fails, log an error and exit the function.
    - Update the account's hash in the bank using [`fd_hashes_update_lthash`](<fd_hashes.c.md#fd_hashes_update_lthash>).
    - Finalize the mutable transaction account using [`fd_txn_account_mutable_fini`](<fd_txn_account.c.md#fd_txn_account_mutable_fini>).
- **Output**: No return value; the function modifies the bank and feature account state directly.
- **Functions Called**:
    - [`fd_txn_account_init_from_funk_readonly`](<fd_txn_account.c.md#fd_txn_account_init_from_funk_readonly>)
    - [`fd_txn_account_get_data`](<fd_txn_account.c.md#fd_txn_account_get_data>)
    - [`fd_txn_account_get_data_len`](<fd_txn_account.c.md#fd_txn_account_get_data_len>)
    - [`fd_txn_account_init_from_funk_mutable`](<fd_txn_account.c.md#fd_txn_account_init_from_funk_mutable>)
    - [`fd_hashes_account_lthash`](<fd_hashes.c.md#fd_hashes_account_lthash>)
    - [`fd_txn_account_get_meta`](<fd_txn_account.c.md#fd_txn_account_get_meta>)
    - [`fd_txn_account_get_data_mut`](<fd_txn_account.c.md#fd_txn_account_get_data_mut>)
    - [`fd_hashes_update_lthash`](<fd_hashes.c.md#fd_hashes_update_lthash>)
    - [`fd_txn_account_mutable_fini`](<fd_txn_account.c.md#fd_txn_account_mutable_fini>)


---
### fd\_features\_activate<!-- {{#callable:fd_features_activate}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.c#L1220>)

Activates features in a bank by iterating over feature IDs and calling [`fd_feature_activate`](<#fd_feature_activate>) for each.
- **Inputs**:
    - ``bank``: A pointer to an `fd_bank_t` structure representing the bank where features will be activated.
    - ``accdb``: A pointer to an `fd_accdb_user_t` structure representing the account database user context.
    - ``xid``: A pointer to a constant `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``capture_ctx``: A pointer to an `fd_capture_ctx_t` structure used for capturing context during feature activation.
- **Logic and Control Flow**:
    - Initialize a feature ID iterator using `fd_feature_iter_init`.
    - Loop through each feature ID until `fd_feature_iter_done` returns true.
    - For each feature ID, call [`fd_feature_activate`](<#fd_feature_activate>) with the current feature ID and its address.
- **Output**: No return value; the function operates by side effects on the bank and account database.
- **Functions Called**:
    - [`fd_feature_activate`](<#fd_feature_activate>)


---
### fd\_runtime\_process\_new\_epoch<!-- {{#callable:fd_runtime_process_new_epoch}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.c#L1247>)

Processes the start of a new epoch by activating features, updating stake delegations, distributing rewards, and updating leader schedules.
- **Inputs**:
    - ``banks``: Pointer to `fd_banks_t`, representing the collection of banks.
    - ``bank``: Pointer to `fd_bank_t`, representing the current bank being processed.
    - ``accdb``: Pointer to `fd_accdb_user_t`, representing the account database user context.
    - ``xid``: Pointer to `fd_funk_txn_xid_t`, representing the transaction ID.
    - ``capture_ctx``: Pointer to `fd_capture_ctx_t`, representing the capture context.
    - ``parent_epoch``: Unsigned long integer representing the parent epoch.
    - ``runtime_stack``: Pointer to `fd_runtime_stack_t`, representing the runtime stack.
- **Logic and Control Flow**:
    - Logs the start of the new epoch with the current epoch and slot information.
    - Initializes `prev_vote_credits_used` to 0 in the runtime stack.
    - Queries stake delegations from the bank and logs a critical error if it is NULL.
    - Records the start time using `fd_log_wallclock()`.
    - Activates new features and restores features using [`fd_features_activate`](<#fd_features_activate>) and [`fd_features_restore`](<fd_runtime_init.c.md#fd_features_restore>).
    - Applies builtin program feature transitions using [`fd_apply_builtin_program_feature_transitions`](<#fd_apply_builtin_program_feature_transitions>).
    - Calculates the new rate activation epoch using [`fd_new_warmup_cooldown_rate_epoch`](<program/fd_stake_program.c.md#fd_new_warmup_cooldown_rate_epoch>) and handles the case where it is not available.
    - Activates epoch stakes and updates stake delegations using `fd_stakes_activate_epoch`.
    - Distributes rewards by calculating them for each vote and stake account using `fd_begin_partitioned_rewards`.
    - Updates vote states for previous epochs using [`fd_update_vote_states_prev_prev`](<#fd_update_vote_states_prev_prev>) and [`fd_update_vote_states_prev`](<#fd_update_vote_states_prev>).
    - Calculates the leader schedule for the upcoming epoch using [`fd_runtime_update_leaders`](<#fd_runtime_update_leaders>).
    - Records the end time and logs the duration of the epoch processing.
- **Output**: No return value; the function operates through side effects on the provided data structures.
- **Functions Called**:
    - [`fd_bank_stake_delegations_frontier_query`](<fd_bank.c.md#fd_bank_stake_delegations_frontier_query>)
    - [`fd_features_activate`](<#fd_features_activate>)
    - [`fd_features_restore`](<fd_runtime_init.c.md#fd_features_restore>)
    - [`fd_apply_builtin_program_feature_transitions`](<#fd_apply_builtin_program_feature_transitions>)
    - [`fd_new_warmup_cooldown_rate_epoch`](<program/fd_stake_program.c.md#fd_new_warmup_cooldown_rate_epoch>)
    - [`fd_blockhashes_peek_last`](<fd_blockhashes.h.md#fd_blockhashes_peek_last>)
    - [`fd_update_vote_states_prev_prev`](<#fd_update_vote_states_prev_prev>)
    - [`fd_update_vote_states_prev`](<#fd_update_vote_states_prev>)
    - [`fd_runtime_update_leaders`](<#fd_runtime_update_leaders>)


---
### fd\_runtime\_genesis\_init\_program<!-- {{#callable:fd_runtime_genesis_init_program}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.c#L1344>)

Initializes various system variables and programs for a given bank during the genesis phase.
- **Inputs**:
    - ``bank``: A pointer to an `fd_bank_t` structure representing the bank to initialize.
    - ``accdb``: A pointer to an `fd_accdb_user_t` structure representing the account database user context.
    - ``xid``: A pointer to a constant `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``capture_ctx``: A pointer to an `fd_capture_ctx_t` structure representing the capture context.
- **Logic and Control Flow**:
    - Calls [`fd_sysvar_clock_init`](<sysvar/fd_sysvar_clock.c.md#fd_sysvar_clock_init>) to initialize the clock system variable.
    - Calls [`fd_sysvar_rent_init`](<sysvar/fd_sysvar_rent.c.md#fd_sysvar_rent_init>) to initialize the rent system variable.
    - Calls [`fd_sysvar_slot_history_init`](<sysvar/fd_sysvar_slot_history.c.md#fd_sysvar_slot_history_init>) to initialize the slot history system variable.
    - Calls [`fd_sysvar_epoch_schedule_init`](<sysvar/fd_sysvar_epoch_schedule.c.md#fd_sysvar_epoch_schedule_init>) to initialize the epoch schedule system variable.
    - Calls [`fd_sysvar_recent_hashes_init`](<sysvar/fd_sysvar_recent_hashes.c.md#fd_sysvar_recent_hashes_init>) to initialize the recent hashes system variable.
    - Calls [`fd_sysvar_stake_history_init`](<sysvar/fd_sysvar_stake_history.c.md#fd_sysvar_stake_history_init>) to initialize the stake history system variable.
    - Calls [`fd_sysvar_last_restart_slot_init`](<sysvar/fd_sysvar_last_restart_slot.c.md#fd_sysvar_last_restart_slot_init>) to initialize the last restart slot system variable.
    - Calls [`fd_builtin_programs_init`](<program/fd_builtin_programs.c.md#fd_builtin_programs_init>) to initialize built-in programs.
    - Calls [`fd_stake_program_config_init`](<program/fd_stake_program.c.md#fd_stake_program_config_init>) to initialize the stake program configuration.
- **Output**: No return value; the function operates by side effects on the provided structures.
- **Functions Called**:
    - [`fd_sysvar_clock_init`](<sysvar/fd_sysvar_clock.c.md#fd_sysvar_clock_init>)
    - [`fd_sysvar_rent_init`](<sysvar/fd_sysvar_rent.c.md#fd_sysvar_rent_init>)
    - [`fd_sysvar_slot_history_init`](<sysvar/fd_sysvar_slot_history.c.md#fd_sysvar_slot_history_init>)
    - [`fd_sysvar_epoch_schedule_init`](<sysvar/fd_sysvar_epoch_schedule.c.md#fd_sysvar_epoch_schedule_init>)
    - [`fd_sysvar_recent_hashes_init`](<sysvar/fd_sysvar_recent_hashes.c.md#fd_sysvar_recent_hashes_init>)
    - [`fd_sysvar_stake_history_init`](<sysvar/fd_sysvar_stake_history.c.md#fd_sysvar_stake_history_init>)
    - [`fd_sysvar_last_restart_slot_init`](<sysvar/fd_sysvar_last_restart_slot.c.md#fd_sysvar_last_restart_slot_init>)
    - [`fd_builtin_programs_init`](<program/fd_builtin_programs.c.md#fd_builtin_programs_init>)
    - [`fd_stake_program_config_init`](<program/fd_stake_program.c.md#fd_stake_program_config_init>)


---
### fd\_runtime\_init\_bank\_from\_genesis<!-- {{#callable:fd_runtime_init_bank_from_genesis}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.c#L1363>)

Initializes a bank from a genesis block by setting various bank parameters and processing accounts for vote and stake states.
- **Inputs**:
    - ``banks``: Pointer to `fd_banks_t`, representing the collection of banks.
    - ``bank``: Pointer to `fd_bank_t`, representing the bank to initialize.
    - ``funk``: Pointer to `fd_funk_t`, representing the database handle for account data.
    - ``xid``: Pointer to `fd_funk_txn_xid_t`, representing the transaction context identifier.
    - ``genesis_block``: Pointer to `fd_genesis_solana_global_t`, representing the genesis block data.
    - ``genesis_hash``: Pointer to `fd_hash_t`, representing the hash of the genesis block.
- **Logic and Control Flow**:
    - Set the bank's Proof of History (PoH) using `genesis_hash`.
    - Initialize the bank's hash to zero using `memset`.
    - Calculate the target tick duration from the PoH configuration in `genesis_block`.
    - Set various bank parameters such as epoch schedule, rent, block height, inflation, fee rate governor, and tick-related settings using data from `genesis_block`.
    - Initialize the block hash queue and push the `genesis_hash` into it with a fee calculator set to zero.
    - Query and join stake delegations and vote states, logging critical errors if they fail.
    - Iterate over accounts in `genesis_block`, updating capitalization and processing vote, stake, and feature accounts accordingly.
    - Update vote states with active delegated stake using `fd_refresh_vote_accounts`.
    - Propagate vote states to previous epochs to simplify edge cases.
    - Set the bank's epoch and capitalization.
- **Output**: No return value; the function modifies the `bank` and related structures in place.
- **Functions Called**:
    - [`fd_blockhashes_push_new`](<fd_blockhashes.c.md#fd_blockhashes_push_new>)
    - [`fd_banks_stake_delegations_root_query`](<fd_bank.c.md#fd_banks_stake_delegations_root_query>)
    - [`fd_sysvar_stake_history_read`](<sysvar/fd_sysvar_stake_history.c.md#fd_sysvar_stake_history_read>)


---
### fd\_runtime\_process\_genesis\_block<!-- {{#callable:fd_runtime_process_genesis_block}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.c#L1556>)

Processes the genesis block by initializing the bank's state, updating various counters, and computing the bank hash.
- **Inputs**:
    - ``bank``: A pointer to the `fd_bank_t` structure representing the bank to process.
    - ``accdb``: A pointer to the `fd_accdb_user_t` structure representing the account database.
    - ``xid``: A constant pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``capture_ctx``: A pointer to the `fd_capture_ctx_t` structure used for capturing context.
    - ``runtime_stack``: A pointer to the `fd_runtime_stack_t` structure used for runtime operations.
- **Logic and Control Flow**:
    - Modify the bank's Proof of History (PoH) by hashing it multiple times based on the number of hashes per tick and ticks per slot.
    - Set various bank counters such as execution fees, priority fees, signature count, transaction count, failed transaction count, non-vote failed transaction count, and total compute units used to zero.
    - Initialize the bank's programs and system variables for the genesis block using [`fd_runtime_genesis_init_program`](<#fd_runtime_genesis_init_program>).
    - Update the slot history system variable using [`fd_sysvar_slot_history_update`](<sysvar/fd_sysvar_slot_history.c.md#fd_sysvar_slot_history_update>).
    - Update the bank's leader schedule using [`fd_runtime_update_leaders`](<#fd_runtime_update_leaders>).
    - Freeze the bank's state using [`fd_runtime_freeze`](<#fd_runtime_freeze>).
    - Query the bank's last transaction hash and previous bank hash.
    - Compute the new bank hash using [`fd_hashes_hash_bank`](<fd_hashes.c.md#fd_hashes_hash_bank>) with the last transaction hash, previous bank hash, and PoH.
    - End the locking query for the last transaction hash.
- **Output**: Returns `FD_RUNTIME_EXECUTE_SUCCESS` to indicate successful execution.
- **Functions Called**:
    - [`fd_runtime_genesis_init_program`](<#fd_runtime_genesis_init_program>)
    - [`fd_sysvar_slot_history_update`](<sysvar/fd_sysvar_slot_history.c.md#fd_sysvar_slot_history_update>)
    - [`fd_runtime_update_leaders`](<#fd_runtime_update_leaders>)
    - [`fd_runtime_freeze`](<#fd_runtime_freeze>)
    - [`fd_hashes_hash_bank`](<fd_hashes.c.md#fd_hashes_hash_bank>)


---
### fd\_runtime\_read\_genesis<!-- {{#callable:fd_runtime_read_genesis}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.c#L1608>)

Initializes the bank state from the genesis configuration and processes the genesis block.
- **Inputs**:
    - ``banks``: Pointer to `fd_banks_t`, representing the collection of banks.
    - ``bank``: Pointer to `fd_bank_t`, representing the specific bank to initialize and process.
    - ``accdb``: Pointer to `fd_accdb_user_t`, representing the accounts database.
    - ``xid``: Pointer to `fd_funk_txn_xid_t`, representing the transaction ID.
    - ``capture_ctx``: Pointer to `fd_capture_ctx_t`, representing the capture context.
    - ``genesis_hash``: Pointer to `fd_hash_t`, representing the hash of the genesis block.
    - ``genesis_lthash``: Pointer to `fd_lthash_value_t`, representing the lthash of the genesis block.
    - ``genesis_block``: Pointer to `fd_genesis_solana_global_t`, representing the genesis block configuration.
    - ``runtime_stack``: Pointer to `fd_runtime_stack_t`, representing the runtime stack.
- **Logic and Control Flow**:
    - Locks and modifies the bank's lthash with the provided `genesis_lthash`.
    - Initializes the bank state from the genesis configuration using [`fd_runtime_init_bank_from_genesis`](<#fd_runtime_init_bank_from_genesis>).
    - Joins the native instruction processors from the genesis block and writes them to the accounts database.
    - Restores features from the accounts database using [`fd_features_restore`](<fd_runtime_init.c.md#fd_features_restore>).
    - Processes the genesis block using [`fd_runtime_process_genesis_block`](<#fd_runtime_process_genesis_block>), updating bank fields like poh and bank hash.
    - Logs a critical error if processing the genesis block fails.
- **Output**: No return value; the function operates by modifying the state of the provided bank and related structures.
- **Functions Called**:
    - [`fd_runtime_init_bank_from_genesis`](<#fd_runtime_init_bank_from_genesis>)
    - [`fd_write_builtin_account`](<program/fd_builtin_programs.c.md#fd_write_builtin_account>)
    - [`fd_features_restore`](<fd_runtime_init.c.md#fd_features_restore>)
    - [`fd_runtime_process_genesis_block`](<#fd_runtime_process_genesis_block>)


---
### fd\_runtime\_block\_pre\_execute\_process\_new\_epoch<!-- {{#callable:fd_runtime_block_pre_execute_process_new_epoch}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.c#L1660>)

Processes a new epoch boundary and distributes rewards if applicable.
- **Inputs**:
    - ``banks``: Pointer to `fd_banks_t`, representing the collection of banks.
    - ``bank``: Pointer to `fd_bank_t`, representing the current bank being processed.
    - ``accdb``: Pointer to `fd_accdb_user_t`, representing the account database user context.
    - ``xid``: Pointer to `fd_funk_txn_xid_t`, representing the transaction ID context.
    - ``capture_ctx``: Pointer to `fd_capture_ctx_t`, representing the capture context for logging or debugging.
    - ``runtime_stack``: Pointer to `fd_runtime_stack_t`, representing the runtime stack used for processing.
    - ``is_epoch_boundary``: Pointer to an integer that will be set to 1 if an epoch boundary is detected, otherwise 0.
- **Logic and Control Flow**:
    - Retrieve the current slot from the `bank` using `fd_bank_slot_get`.
    - If the slot is not zero, query the epoch schedule using `fd_bank_epoch_schedule_query`.
    - Determine the previous epoch and the new epoch using [`fd_slot_to_epoch`](<sysvar/fd_sysvar_epoch_schedule.c.md#fd_slot_to_epoch>).
    - If the slot index is 1 and the new epoch is 0, set the block height to 1.
    - If a new epoch is detected or the slot index is zero, log the epoch boundary and call [`fd_runtime_process_new_epoch`](<#fd_runtime_process_new_epoch>) to process the new epoch.
    - Set `is_epoch_boundary` to 1 if a new epoch is processed, otherwise set it to 0.
    - If the slot is not zero, call `fd_distribute_partitioned_epoch_rewards` to distribute rewards.
- **Output**: No return value; modifies `is_epoch_boundary` to indicate if an epoch boundary was processed.
- **Functions Called**:
    - [`fd_slot_to_epoch`](<sysvar/fd_sysvar_epoch_schedule.c.md#fd_slot_to_epoch>)
    - [`fd_runtime_process_new_epoch`](<#fd_runtime_process_new_epoch>)


---
### fd\_runtime\_block\_execute\_finalize<!-- {{#callable:fd_runtime_block_execute_finalize}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_runtime.c#L1695>)

Finalizes the execution of a block by freezing the current state and updating the bank hash.
- **Inputs**:
    - ``bank``: A pointer to the `fd_bank_t` structure representing the bank to finalize.
    - ``accdb``: A pointer to the `fd_accdb_user_t` structure representing the account database user context.
    - ``xid``: A pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``capture_ctx``: A pointer to the `fd_capture_ctx_t` structure representing the capture context.
    - ``silent``: An integer flag indicating whether to suppress logging output (non-zero value) or not (zero value).
- **Logic and Control Flow**:
    - Calls [`fd_runtime_freeze`](<#fd_runtime_freeze>) to freeze the current state of the bank, preventing further changes.
    - Calls [`fd_runtime_update_bank_hash`](<#fd_runtime_update_bank_hash>) to compute and update the bank hash based on the current state and capture context.
- **Output**: This function does not return a value; it performs operations to finalize the block execution.
- **Functions Called**:
    - [`fd_runtime_freeze`](<#fd_runtime_freeze>)
    - [`fd_runtime_update_bank_hash`](<#fd_runtime_update_bank_hash>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)