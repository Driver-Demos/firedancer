<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for transaction cache functionality, including memory management and query operations.

# Purpose
The code is a C program that tests the functionality of a transaction cache system. It includes several test functions that validate different aspects of the transaction cache, such as creating and joining shared memory segments, inserting and querying transactions, and advancing the root of the transaction cache. The program uses a series of assertions to ensure that the transaction cache behaves as expected under various conditions. The main function initializes the environment, allocates necessary memory, and executes the test functions.

The program includes several header files that provide necessary utilities and definitions, such as `fd_txncache.h`, `fd_pack.h`, and `fd_util.h`. It defines macros for creating block and transaction hashes and uses a static assertion to ensure alignment requirements. The test functions, such as [`test0`](<#test0>), [`test_new_join`](<#test_new_join>), and [`test_advance_root`](<#test_advance_root>), perform operations on the transaction cache and verify the results using assertions. The program is structured to be executed as a standalone application, with the [`main`](<#main>) function serving as the entry point.
# Imports and Dependencies

---
- `fd_txncache.h`
- `../../disco/pack/fd_pack.h`
- `../../disco/pack/fd_pack_cost.h`
- `../../util/fd_util.h`
- `fd_txncache_shmem.h`


# Functions

---
### test0<!-- {{#callable:test0}} -->
[View Source →](<../../../../../src/flamenco/runtime/test_txncache.c#L26>)

Tests the functionality of transaction cache operations including creation, insertion, and querying of transactions.
- **Inputs**:
    - `scratch0`: A pointer to a memory buffer used for shared memory operations.
    - `scratch1`: A pointer to a memory buffer used for local transaction cache operations.
- **Logic and Control Flow**:
    - Logs the start of the test with the message 'TEST 0'.
    - Creates a shared memory transaction cache using `scratch0` and joins it, storing the result in `shtc`.
    - Asserts that `shtc` is not NULL using `FD_TEST`.
    - Creates a transaction cache using `scratch1` and `shtc`, and joins it, storing the result in `tc`.
    - Asserts that `tc` is not NULL using `FD_TEST`.
    - Attaches a child fork to the transaction cache with a NULL parent fork, storing the fork ID in `root`.
    - Finalizes the fork `root` with a block hash of `BLOCKHASH(1UL)`.
    - Attaches another child fork to the transaction cache with `root` as the parent, storing the fork ID in `slot1`.
    - Inserts three transactions with different transaction hashes into `slot1` with the same block hash `BLOCKHASH(1UL)`.
    - Finalizes the fork `slot1` with a block hash of `BLOCKHASH(3UL)`.
    - Queries the transaction cache for specific transaction hashes in `slot1` and asserts the expected presence or absence of each transaction using `FD_TEST`.
- **Output**: No return value; the function performs tests and logs results.
- **Functions Called**:
    - [`fd_txncache_shmem_join`](<fd_txncache_shmem.c.md#fd_txncache_shmem_join>)
    - [`fd_txncache_shmem_new`](<fd_txncache_shmem.c.md#fd_txncache_shmem_new>)
    - [`fd_txncache_join`](<fd_txncache.c.md#fd_txncache_join>)
    - [`fd_txncache_new`](<fd_txncache.c.md#fd_txncache_new>)
    - [`fd_txncache_attach_child`](<fd_txncache.c.md#fd_txncache_attach_child>)
    - [`fd_txncache_finalize_fork`](<fd_txncache.c.md#fd_txncache_finalize_fork>)
    - [`fd_txncache_insert`](<fd_txncache.c.md#fd_txncache_insert>)
    - [`fd_txncache_query`](<fd_txncache.c.md#fd_txncache_query>)


---
### test\_new\_join<!-- {{#callable:test_new_join}} -->
[View Source →](<../../../../../src/flamenco/runtime/test_txncache.c#L54>)

Tests the creation and joining of transaction cache shared memory segments with various parameters.
- **Inputs**:
    - ``scratch0``: A pointer to a memory area used for shared memory operations.
- **Logic and Control Flow**:
    - Logs the start of the 'TEST NEW' phase.
    - Tests [`fd_txncache_shmem_new`](<fd_txncache_shmem.c.md#fd_txncache_shmem_new>) with invalid parameters (NULL, misaligned, zero slots, zero transactions per slot) and expects NULL returns.
    - Tests [`fd_txncache_shmem_new`](<fd_txncache_shmem.c.md#fd_txncache_shmem_new>) with valid parameters and expects successful creation of shared memory segments.
    - Logs the start of the 'TEST JOIN' phase.
    - Tests [`fd_txncache_join`](<fd_txncache.c.md#fd_txncache_join>) with invalid parameters (NULL, misaligned) and expects NULL returns.
    - Tests [`fd_txncache_join`](<fd_txncache.c.md#fd_txncache_join>) with a valid shared memory segment and expects a successful join.
- **Output**: No return value; the function performs tests and logs results.
- **Functions Called**:
    - [`fd_txncache_shmem_new`](<fd_txncache_shmem.c.md#fd_txncache_shmem_new>)
    - [`fd_txncache_join`](<fd_txncache.c.md#fd_txncache_join>)


---
### test\_advance\_root<!-- {{#callable:test_advance_root}} -->
[View Source →](<../../../../../src/flamenco/runtime/test_txncache.c#L78>)

Tests the functionality of advancing the root in a transaction cache by creating and finalizing forks, inserting transactions, and verifying queries.
- **Inputs**:
    - `scratch0`: A pointer to a memory area used for shared memory operations.
    - `scratch1`: A pointer to a memory area used for local transaction cache operations.
- **Logic and Control Flow**:
    - Logs the start of the test with 'TEST ADVANCE ROOT'.
    - Creates and joins a shared memory transaction cache using `scratch0`.
    - Creates and joins a local transaction cache using `scratch1` and the shared memory cache.
    - Attaches a child fork to the transaction cache with `NULL_FORK` and finalizes it with a block hash of 0.
    - Iterates 8192 times, each time attaching a child fork, inserting a transaction, finalizing the fork with the next block hash, and advancing the root.
    - Performs several queries to verify the presence or absence of specific transactions in the cache.
    - Attaches another child fork, finalizes it with a block hash of 8193, and advances the root again.
- **Output**: No return value; the function performs tests and logs results.
- **Functions Called**:
    - [`fd_txncache_shmem_join`](<fd_txncache_shmem.c.md#fd_txncache_shmem_join>)
    - [`fd_txncache_shmem_new`](<fd_txncache_shmem.c.md#fd_txncache_shmem_new>)
    - [`fd_txncache_join`](<fd_txncache.c.md#fd_txncache_join>)
    - [`fd_txncache_new`](<fd_txncache.c.md#fd_txncache_new>)
    - [`fd_txncache_attach_child`](<fd_txncache.c.md#fd_txncache_attach_child>)
    - [`fd_txncache_finalize_fork`](<fd_txncache.c.md#fd_txncache_finalize_fork>)
    - [`fd_txncache_insert`](<fd_txncache.c.md#fd_txncache_insert>)
    - [`fd_txncache_advance_root`](<fd_txncache.c.md#fd_txncache_advance_root>)
    - [`fd_txncache_query`](<fd_txncache.c.md#fd_txncache_query>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/flamenco/runtime/test_txncache.c#L111>)

Initializes the environment, calculates memory footprints, allocates shared memory, and runs a series of tests on transaction cache operations.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of strings representing the command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Calculates `max_footprint_shmem` using [`fd_txncache_shmem_footprint`](<fd_txncache_shmem.c.md#fd_txncache_shmem_footprint>) with parameters `4096UL` and `FD_MAX_TXN_PER_SLOT`.
    - Calculates `max_footprint_local` using [`fd_txncache_footprint`](<fd_txncache.c.md#fd_txncache_footprint>) with parameter `FD_MAX_TXN_PER_SLOT`.
    - Computes `max_footprint` by aligning `max_footprint_shmem` to `4096UL` and adding `max_footprint_local`.
    - Acquires shared memory `scratch0` using `fd_shmem_acquire` with parameters `4096UL`, `1UL+(max_footprint/4096UL)`, and `0UL`.
    - Checks if `scratch0` is successfully acquired using `FD_TEST`.
    - Calculates `scratch1` as an offset from `scratch0` by aligning `max_footprint_shmem` to `4096UL`.
    - Executes [`test0`](<#test0>) with `scratch0` and `scratch1` to perform initial transaction cache tests.
    - Executes [`test_new_join`](<#test_new_join>) with `scratch0` to test new and join operations on transaction cache.
    - Executes [`test_advance_root`](<#test_advance_root>) with `scratch0` and `scratch1` to test advancing the root in transaction cache.
    - Logs a notice message "pass" using `FD_LOG_NOTICE`.
    - Calls `fd_halt` to terminate the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`fd_txncache_shmem_footprint`](<fd_txncache_shmem.c.md#fd_txncache_shmem_footprint>)
    - [`fd_txncache_footprint`](<fd_txncache.c.md#fd_txncache_footprint>)
    - [`test0`](<#test0>)
    - [`test_new_join`](<#test_new_join>)
    - [`test_advance_root`](<#test_advance_root>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)