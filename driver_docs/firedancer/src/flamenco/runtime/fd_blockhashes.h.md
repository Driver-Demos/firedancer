<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

A blockhash queue API for managing consensus-relevant data structures in a slot bank.

# Purpose
The code defines a C header file that provides an API for managing a "blockhash queue," which is a data structure relevant to consensus mechanisms in a slot bank. The primary components of this file include the definition of a `fd_blockhash_info` structure, which holds information about blockhashes, and the `fd_blockhashes` structure, which represents the blockhash queue itself. The `fd_blockhashes` structure is implemented as a static size container that combines a double-ended queue and a separately-chained hash map. This design allows for efficient insertion and retrieval of blockhash entries.

The file also declares several functions for interacting with the blockhash queue. These include `fd_blockhashes_init` for initializing the queue, [`fd_blockhashes_push_new`](<#fd_blockhashes_push_new>) and [`fd_blockhashes_push_old`](<#fd_blockhashes_push_old>) for adding new entries, and [`fd_blockhashes_pop_new`](<#fd_blockhashes_pop_new>) for removing the newest entry. Additionally, the file provides utility functions such as [`fd_blockhashes_check_age`](<#fd_blockhashes_check_age>) to verify the age of a blockhash and [`fd_blockhashes_peek_last`](<#fd_blockhashes_peek_last>) to access the last blockhash in the queue. The header file is intended to be included in other C source files, providing a consistent interface for managing blockhash queues in a consensus-related context.
# Imports and Dependencies

---
- `../types/fd_types.h`
- `../../funk/fd_funk_base.h`
- `../../util/tmpl/fd_deque.c`
- `../../util/tmpl/fd_map_chain.c`


# Data Structures

---
### fd\_blockhash\_info
- **Type**: ``struct``
- **Members**:
    - ``hash``: Stores the hash value of the block.
    - ``fee_calculator``: Holds the fee calculation information.
    - ``next``: Indicates the index of the next element in the queue.
    - ``exists``: Flags whether the blockhash information exists.
- **Description**: Represents information about a blockhash in a blockhash queue, including its hash, fee calculation details, and its position in the queue.


---
### fd\_blockhash\_info\_t
- **Type**: ``struct``
- **Members**:
    - ``hash``: A hash value of type `fd_hash_t`.
    - ``fee_calculator``: An instance of `fd_fee_calculator_t` used for fee calculations.
    - ``next``: An unsigned short integer used for chaining in a hash map.
    - ``exists``: A 1-bit flag indicating the existence of the blockhash.
- **Description**: Defines a structure that holds information about a blockhash, including its hash value, fee calculation details, and metadata for managing its position in a hash map.


---
### fd\_blockhashes
- **Type**: ``struct``
- **Members**:
    - ``map``: A union member that can be either a single-element array of `fd_blockhash_map_t` or a memory buffer of size `FD_BLOCKHASH_MAP_FOOTPRINT`.
    - ``d``: An instance of `fd_blockhash_deq_private_t` used for managing the blockhash queue.
- **Description**: The `fd_blockhashes` structure is a static size container that represents a blockhash queue, which is a consensus-relevant data structure used in the slot bank. It combines a double-ended queue and a separately-chained hash index to manage blockhash entries. The structure is self-contained, position-independent, and can be safely declared as a local variable. It allows for the insertion of new entries at the tail of the queue and manages memory efficiently through its union member.


---
### fd\_blockhashes\_t
- **Type**: ``struct``
- **Members**:
    - ``map``: A union member that can be accessed as an array of `fd_blockhash_map_t` or as a memory block of size `FD_BLOCKHASH_MAP_FOOTPRINT`.
    - ``map_mem``: A union member that provides raw memory storage for the map.
    - ``d``: An instance of `fd_blockhash_deq_private_t` used for managing the deque operations.
- **Description**: A static size container that represents a blockhash queue, combining a double-ended queue and a separately-chained hash index. It is designed to be self-contained and position-independent, allowing for safe cloning and mapping into different address spaces. The structure supports operations to add new or old entries, remove the newest entry, and check the age of blockhashes.


# Functions

---
### fd\_blockhashes\_peek\_last<!-- {{#callable:fd_blockhashes_peek_last}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_blockhashes.h#L108>)

Retrieves the last blockhash from the blockhash queue if it is not empty.
- **Inputs**:
    - `blockhashes`: A pointer to a `fd_blockhashes_t` structure representing the blockhash queue.
- **Logic and Control Flow**:
    - Check if the blockhash queue is empty using `fd_blockhash_deq_empty` on `blockhashes->d.deque`.
    - If the queue is empty, return `0`.
    - If the queue is not empty, return a pointer to the `hash` of the last element in the queue using `fd_blockhash_deq_peek_tail_const`.
- **Output**: A pointer to the last `fd_hash_t` in the blockhash queue, or `0` if the queue is empty.


# Function Declarations (Public API)

---
### fd\_blockhashes\_push\_new<!-- {{#callable_declaration:fd_blockhashes_push_new}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_blockhashes.h#L86>)

Adds a new blockhash to the queue.
- **Description**: Use this function to add a new blockhash to the blockhash queue. It is typically called during regular runtime processing. If the queue is full, the function removes the oldest entry to make space for the new blockhash. The function ensures that the blockhash is unique within the queue and logs a critical error if a duplicate is detected. It always returns a valid pointer to the newly added blockhash information.
- **Inputs**:
    - `blockhashes`: A pointer to an `fd_blockhashes_t` structure representing the blockhash queue. Must not be null. The caller retains ownership.
    - `hash`: A pointer to an `fd_hash_t` structure representing the blockhash to add. Must not be null. The function checks for duplicates and logs an error if the hash already exists in the queue.
- **Output**: Returns a pointer to an `fd_blockhash_info_t` structure containing the new blockhash information.
- **See Also**: [`fd_blockhashes_push_new`](<fd_blockhashes.c.md#fd_blockhashes_push_new>)  (Implementation)


---
### fd\_blockhashes\_push\_old<!-- {{#callable_declaration:fd_blockhashes_push_old}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_blockhashes.h#L94>)

Adds a new oldest entry to the blockhash queue.
- **Description**: Use this function to add a new blockhash entry to the start of the blockhash queue. This function is useful for testing purposes. It returns NULL if the queue is full, indicating that no more entries can be added. Ensure that the blockhash is not already present in the queue to avoid critical errors.
- **Inputs**:
    - `blockhashes`: A pointer to an `fd_blockhashes_t` structure representing the blockhash queue. Must not be null.
    - `hash`: A pointer to an `fd_hash_t` structure representing the blockhash to add. Must not be null and must not already exist in the queue.
- **Output**: Returns a pointer to the newly added `fd_blockhash_info_t` if successful, or NULL if the queue is full.
- **See Also**: [`fd_blockhashes_push_old`](<fd_blockhashes.c.md#fd_blockhashes_push_old>)  (Implementation)


---
### fd\_blockhashes\_pop\_new<!-- {{#callable_declaration:fd_blockhashes_pop_new}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_blockhashes.h#L100>)

Removes the newest entry from the blockhash queue.
- **Description**: Use this function to remove the most recently added entry from a blockhash queue. This function is typically called when the newest blockhash is no longer needed. It must be called only when the blockhash queue is not empty, as it will have no effect if the queue is empty. The function updates the internal state to reflect the removal of the entry.
- **Inputs**:
    - `blockhashes`: A pointer to an `fd_blockhashes_t` structure representing the blockhash queue. The pointer must not be null, and the queue should be initialized before calling this function.
- **Output**: None
- **See Also**: [`fd_blockhashes_pop_new`](<fd_blockhashes.c.md#fd_blockhashes_pop_new>)  (Implementation)


---
### fd\_blockhashes\_check\_age<!-- {{#callable_declaration:fd_blockhashes_check_age}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_blockhashes.h#L103>)

Checks if a blockhash is within a specified age limit.
- **Description**: Use this function to verify if a given blockhash is not older than a specified maximum age within the blockhash queue. This is useful for ensuring that blockhashes are still valid according to age constraints. The function requires a valid blockhash queue and a blockhash to check. It returns a boolean indicating whether the blockhash is within the allowed age. Ensure that the blockhash queue is properly initialized before calling this function.
- **Inputs**:
    - `blockhashes`: A pointer to a constant `fd_blockhashes_t` structure representing the blockhash queue. Must not be null and must be initialized before use.
    - `blockhash`: A pointer to a constant `fd_hash_t` representing the blockhash to check. Must not be null.
    - `max_age`: An unsigned long integer specifying the maximum allowable age for the blockhash. Must be a non-negative value.
- **Output**: Returns an integer value: 1 if the blockhash is within the specified age limit, or 0 if it is not or if the blockhash is not found in the queue.
- **See Also**: [`fd_blockhashes_check_age`](<fd_blockhashes.c.md#fd_blockhashes_check_age>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)