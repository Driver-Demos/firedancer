<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines data structures and functions for bank hash comparison, including locking and insertion operations.

# Purpose
This C header file defines data structures and functions for managing and comparing hash entries in a bank hash comparison system. It includes the definition of `fd_bank_hash_cmp_entry_t`, which represents an entry with a slot, hash values, and associated stakes. The `fd_bank_hash_cmp_t` structure manages a collection of these entries, including metadata such as count, watermark, total stake, and a lock for synchronization. The file provides inline functions for setting and retrieving the map offset, aligning data, and calculating the memory footprint. It also declares functions for creating, joining, leaving, and deleting a bank hash comparison instance, as well as locking, unlocking, inserting entries, and checking hash matches. The header includes necessary dependencies and a template for map operations.
# Imports and Dependencies

---
- `../fd_flamenco_base.h`
- `../types/fd_types_custom.h`
- `../../util/tmpl/fd_map.c`


# Data Structures

---
### fd\_bank\_hash\_cmp\_entry
- **Type**: ``struct``
- **Members**:
    - `slot`: Stores the slot number as an unsigned long integer.
    - `hash`: Stores the hash value as an unsigned integer.
    - `ours`: Stores the hash value of the current entity as `fd_hash_t`.
    - `theirs`: Stores an array of hash values from other entities as `fd_hash_t`.
    - `stakes`: Stores an array of stake values as unsigned long integers.
    - `cnt`: Stores the count of valid entries as an unsigned long integer.
    - `overflow`: Indicates if there is an overflow with an integer flag.
- **Description**: Represents an entry in a hash comparison map, containing information about a specific slot, including hash values, stakes, and overflow status. It is used to compare hash values between the current entity and others, and to track the number of valid entries and any overflow conditions.


---
### fd\_bank\_hash\_cmp\_entry\_t
- **Type**: ``struct``
- **Members**:
    - `slot`: Stores the slot number for the hash comparison entry.
    - `hash`: Stores the hash value associated with the entry.
    - `ours`: Stores the hash value that represents 'our' data.
    - `theirs`: An array of hash values representing 'their' data for comparison.
    - `stakes`: An array of stake values corresponding to each 'theirs' hash.
    - `cnt`: Stores the count of valid entries in the 'theirs' and 'stakes' arrays.
    - `overflow`: Indicates if there is an overflow in the hash comparison entry.
- **Description**: `fd_bank_hash_cmp_entry_t` is a structure used to store and manage hash comparison data for a specific slot in a bank hash comparison map. It includes fields for the slot number, a hash value, and arrays for comparing 'our' hash against multiple 'theirs' hashes, along with corresponding stake values. The structure also tracks the count of valid entries and an overflow indicator.


---
### fd\_bank\_hash\_cmp
- **Type**: ``struct``
- **Members**:
    - `map_offset`: Stores the offset to the map memory from the start of the structure.
    - `cnt`: Holds the count of entries or elements.
    - `watermark`: Represents a threshold or limit for processing.
    - `total_stake`: Accumulates the total stake value.
    - `lock`: Indicates a volatile lock for synchronization.
- **Description**: The `fd_bank_hash_cmp` structure is used to manage and compare hash entries in a bank hash map. It includes fields for managing the map's memory offset, counting entries, tracking a processing watermark, accumulating total stakes, and a volatile lock for thread synchronization. This structure is part of a larger system for handling hash comparisons and synchronization in a concurrent environment.


---
### fd\_bank\_hash\_cmp\_t
- **Type**: ``struct``
- **Members**:
    - `map_offset`: Stores the offset to the map memory from the start of the structure.
    - `cnt`: Holds the count of entries in the map.
    - `watermark`: Tracks the highest point reached in the map.
    - `total_stake`: Accumulates the total stake of all entries.
    - `lock`: Provides a volatile integer for locking mechanisms.
- **Description**: Manages a hash comparison map for bank entries, including metadata such as entry count, total stake, and synchronization lock.


# Functions

---
### fd\_bank\_hash\_cmp\_set\_map\_offset<!-- {{#callable:fd_bank_hash_cmp_set_map_offset}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank_hash_cmp.h#L34>)

Sets the `map_offset` field of a `fd_bank_hash_cmp_t` structure to the offset between `map_mem` and the `fd_bank_hash_cmp` structure.
- **Inputs**:
    - `bank_hash_cmp`: A pointer to a `fd_bank_hash_cmp_t` structure whose `map_offset` field will be set.
    - `map_mem`: A pointer to a memory location that represents the map memory.
- **Logic and Control Flow**:
    - Calculate the offset by subtracting the address of `bank_hash_cmp` from the address of `map_mem`.
    - Assign the calculated offset to the `map_offset` field of the `fd_bank_hash_cmp` structure.
- **Output**: No return value; the function modifies the `map_offset` field of the `fd_bank_hash_cmp` structure in place.


---
### fd\_bank\_hash\_cmp\_get\_map<!-- {{#callable:fd_bank_hash_cmp_get_map}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank_hash_cmp.h#L42>)

Retrieves the map entry from a `fd_bank_hash_cmp_t` structure using its map offset.
- **Inputs**:
    - `bank_hash_cmp`: A pointer to a `fd_bank_hash_cmp_t` structure from which to retrieve the map entry.
- **Logic and Control Flow**:
    - Calculate the address of the map entry by adding the `map_offset` of `bank_hash_cmp` to the base address of `bank_hash_cmp`.
    - Call `fd_bank_hash_cmp_map_join` with the calculated address to retrieve the map entry.
- **Output**: A pointer to a `fd_bank_hash_cmp_entry_t` structure, representing the map entry.


---
### fd\_bank\_hash\_cmp\_align<!-- {{#callable:fd_bank_hash_cmp_align}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank_hash_cmp.h#L47>)

Returns the alignment size for the bank hash comparison structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the constant value `128UL`.
- **Output**: The function outputs an unsigned long integer (`ulong`) with the value `128UL`, representing the alignment size.


---
### fd\_bank\_hash\_cmp\_footprint<!-- {{#callable:fd_bank_hash_cmp_footprint}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank_hash_cmp.h#L52>)

Calculates the memory footprint required for a `fd_bank_hash_cmp` structure and its associated map.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize the layout with `FD_LAYOUT_INIT`.
    - Append the alignment and size of `fd_bank_hash_cmp_t` to the layout using `FD_LAYOUT_APPEND`.
    - Append the alignment and footprint of the map to the layout using `FD_LAYOUT_APPEND`.
    - Finalize the layout with `FD_LAYOUT_FINI` to calculate the total footprint.
- **Output**: Returns an `ulong` representing the total memory footprint required.
- **Functions Called**:
    - [`fd_bank_hash_cmp_align`](<#fd_bank_hash_cmp_align>)


# Function Declarations (Public API)

---
### fd\_bank\_hash\_cmp\_new<!-- {{#callable_declaration:fd_bank_hash_cmp_new}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank_hash_cmp.h#L62>)

Initializes a new bank hash comparison structure in the provided memory.
- **Description**: Use this function to initialize a bank hash comparison structure in a pre-allocated memory region. The memory must be aligned to the required boundary and have sufficient size to accommodate the structure. This function sets up the internal map and prepares the structure for use. It returns a pointer to the initialized structure or NULL if the memory is null or misaligned.
- **Inputs**:
    - `mem`: A pointer to a pre-allocated memory region where the structure will be initialized. The memory must be aligned to the boundary specified by `fd_bank_hash_cmp_align()` and must not be null. If these conditions are not met, the function returns NULL.
- **Output**: Returns a pointer to the initialized bank hash comparison structure, or NULL if the input memory is null or misaligned.
- **See Also**: [`fd_bank_hash_cmp_new`](<fd_bank_hash_cmp.c.md#fd_bank_hash_cmp_new>)  (Implementation)


---
### fd\_bank\_hash\_cmp\_join<!-- {{#callable_declaration:fd_bank_hash_cmp_join}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank_hash_cmp.h#L65>)

Joins a bank hash comparison structure.
- **Description**: Use this function to join a bank hash comparison structure, which is necessary before performing operations on it. Ensure that the input pointer is not null and is aligned according to the required alignment. This function checks for null and misaligned inputs, logging warnings and returning null in such cases. It also verifies the validity of the entry map, returning null if the map is invalid.
- **Inputs**:
    - `bank_hash_cmp`: A pointer to a bank hash comparison structure. Must not be null and must be aligned to the boundary specified by `fd_bank_hash_cmp_align()`. If the pointer is null or misaligned, the function logs a warning and returns null.
- **Output**: Returns a pointer to the joined bank hash comparison structure if successful, or null if the input is invalid or the entry map is invalid.
- **See Also**: [`fd_bank_hash_cmp_join`](<fd_bank_hash_cmp.c.md#fd_bank_hash_cmp_join>)  (Implementation)


---
### fd\_bank\_hash\_cmp\_leave<!-- {{#callable_declaration:fd_bank_hash_cmp_leave}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank_hash_cmp.h#L68>)

Releases a bank hash comparison context.
- **Description**: Use this function to release a previously joined bank hash comparison context. It is important to ensure that the `bank_hash_cmp` parameter is not null before calling this function, as passing a null pointer will result in a warning and the function will return null. This function is typically called when the bank hash comparison context is no longer needed, allowing for cleanup and resource management.
- **Inputs**:
    - `bank_hash_cmp`: A pointer to a `fd_bank_hash_cmp_t` structure representing the bank hash comparison context. Must not be null. If null, the function logs a warning and returns null.
- **Output**: Returns a void pointer to the bank hash comparison context if successful, or null if the input is null.
- **See Also**: [`fd_bank_hash_cmp_leave`](<fd_bank_hash_cmp.c.md#fd_bank_hash_cmp_leave>)  (Implementation)


---
### fd\_bank\_hash\_cmp\_delete<!-- {{#callable_declaration:fd_bank_hash_cmp_delete}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank_hash_cmp.h#L71>)

Deletes a bank hash comparison object.
- **Description**: Use this function to delete a bank hash comparison object when it is no longer needed. The input must be a valid pointer to a bank hash comparison object that is correctly aligned. If the input is null or misaligned, the function logs a warning and returns null. Ensure that the object is not in use by other operations before calling this function to avoid undefined behavior.
- **Inputs**:
    - `bank_hash_cmp`: A pointer to the bank hash comparison object to delete. Must not be null and must be aligned to the alignment requirements of `fd_bank_hash_cmp_align()`. If null or misaligned, the function logs a warning and returns null.
- **Output**: Returns the input pointer if it is valid and aligned; otherwise, returns null.
- **See Also**: [`fd_bank_hash_cmp_delete`](<fd_bank_hash_cmp.c.md#fd_bank_hash_cmp_delete>)  (Implementation)


---
### fd\_bank\_hash\_cmp\_lock<!-- {{#callable_declaration:fd_bank_hash_cmp_lock}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank_hash_cmp.h#L74>)

Locks the bank hash comparison structure for exclusive access.
- **Description**: Use this function to acquire a lock on the `fd_bank_hash_cmp_t` structure to ensure exclusive access in a multi-threaded environment. This function is necessary when you need to perform operations on the structure that must not be interrupted or accessed concurrently by other threads. It is important to call this function before any critical section of code that modifies or reads shared data within the `fd_bank_hash_cmp_t` structure. The function will block until the lock is successfully acquired. Ensure that `fd_bank_hash_cmp_unlock` is called after the critical section to release the lock and allow other threads to proceed.
- **Inputs**:
    - `bank_hash_cmp`: A pointer to an `fd_bank_hash_cmp_t` structure. This parameter must not be null. The caller retains ownership of the structure. The function will attempt to acquire a lock on this structure.
- **Output**: None
- **See Also**: [`fd_bank_hash_cmp_lock`](<fd_bank_hash_cmp.c.md#fd_bank_hash_cmp_lock>)  (Implementation)


---
### fd\_bank\_hash\_cmp\_unlock<!-- {{#callable_declaration:fd_bank_hash_cmp_unlock}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank_hash_cmp.h#L77>)

Releases the lock on a bank hash comparison structure.
- **Description**: Use this function to release a lock previously acquired on a `fd_bank_hash_cmp_t` structure. This function is typically called after completing operations that require exclusive access to the structure. Ensure that the lock was previously acquired using `fd_bank_hash_cmp_lock` to maintain proper synchronization. This function does not return a value and does not handle errors related to unlocking an already unlocked structure.
- **Inputs**:
    - `bank_hash_cmp`: A pointer to a `fd_bank_hash_cmp_t` structure. Must not be null. The caller retains ownership of the structure. The function assumes that the lock is currently held and will release it.
- **Output**: None
- **See Also**: [`fd_bank_hash_cmp_unlock`](<fd_bank_hash_cmp.c.md#fd_bank_hash_cmp_unlock>)  (Implementation)


---
### fd\_bank\_hash\_cmp\_insert<!-- {{#callable_declaration:fd_bank_hash_cmp_insert}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank_hash_cmp.h#L80>)

Inserts a hash entry into the bank hash comparison structure.
- **Description**: Use this function to add a hash entry to the specified bank hash comparison structure for a given slot. This function must be called with a valid `fd_bank_hash_cmp_t` structure that has been properly initialized. The function will not insert an entry if the slot is less than or equal to the current watermark. If the slot is new and the map is full, it will clear old entries to make room. If the `ours` parameter is set, the hash is stored as 'ours'; otherwise, it is stored in the 'theirs' array with an associated stake. The function handles duplicate hashes by increasing the stake and logs a warning if the maximum number of hashes per slot is exceeded.
- **Inputs**:
    - `bank_hash_cmp`: A pointer to an `fd_bank_hash_cmp_t` structure. Must not be null and must be initialized before use. The caller retains ownership.
    - `slot`: An unsigned long integer representing the slot for the hash entry. Must be greater than the current watermark to be inserted.
    - `hash`: A pointer to a constant `fd_hash_t` structure representing the hash to insert. Must not be null. The caller retains ownership.
    - `ours`: An integer flag indicating if the hash is 'ours'. If non-zero, the hash is stored as 'ours'; otherwise, it is stored in the 'theirs' array.
    - `stake`: An unsigned long integer representing the stake associated with the hash. Used only if `ours` is zero.
- **Output**: None
- **See Also**: [`fd_bank_hash_cmp_insert`](<fd_bank_hash_cmp.c.md#fd_bank_hash_cmp_insert>)  (Implementation)


---
### fd\_bank\_hash\_cmp\_check<!-- {{#callable_declaration:fd_bank_hash_cmp_check}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank_hash_cmp.h#L90>)

Checks if the bank hash matches for a given slot.
- **Description**: Use this function to verify if the bank hash for a specified slot matches the expected value. It requires a valid `fd_bank_hash_cmp_t` structure and a slot number. The function returns 1 if the hash matches, -1 if there is a mismatch, and 0 if the comparison cannot be made yet. Ensure that the `fd_bank_hash_cmp_t` structure is properly initialized and contains valid data before calling this function. This function also logs detailed information about the comparison result.
- **Inputs**:
    - `bank_hash_cmp`: A pointer to an `fd_bank_hash_cmp_t` structure. Must not be null and should be properly initialized before use. The caller retains ownership.
    - `slot`: An unsigned long integer representing the slot number to check. Must be a valid slot present in the `fd_bank_hash_cmp_t` structure.
- **Output**: Returns 1 if the bank hash matches, -1 if there is a mismatch, and 0 if the comparison cannot be made yet.
- **See Also**: [`fd_bank_hash_cmp_check`](<fd_bank_hash_cmp.c.md#fd_bank_hash_cmp_check>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)