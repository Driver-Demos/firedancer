<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions and structures for migrating built-in programs to core BPF in a runtime environment.

# Purpose
The code is a C module that facilitates the migration of built-in programs to core BPF (Berkeley Packet Filter) programs within a blockchain environment. It includes functions for managing temporary accounts, reading and storing account data, and handling the migration process. The module defines several structures, such as `target_core_bpf_t` and `target_builtin_t`, which represent the state and configuration of the migration targets. The primary function, [`fd_migrate_builtin_to_core_bpf`](<#fd_migrate_builtin_to_core_bpf>), orchestrates the migration by invoking [`migrate_builtin_to_core_bpf1`](<#migrate_builtin_to_core_bpf1>), which performs the detailed steps of the migration process.

The module interacts with various components, such as accounts, banks, and runtime stacks, to ensure the correct transfer and transformation of program data. It uses functions like [`tmp_account_new`](<#tmp_account_new>), [`tmp_account_read`](<#tmp_account_read>), and [`tmp_account_store`](<#tmp_account_store>) to manage account data during the migration. The code also includes error handling to manage potential issues, such as account existence and ownership verification. The module is designed to be integrated into a larger system, as indicated by its use of external functions and structures, and it does not define public APIs or external interfaces directly.
# Imports and Dependencies

---
- `sysvar/fd_sysvar_rent.h`
- `program/fd_bpf_loader_program.h`
- `program/fd_builtin_programs.h`
- `fd_runtime_stack.h`
- `fd_pubkey_utils.h`
- `fd_system_ids.h`
- `assert.h`


# Data Structures

---
### target\_core\_bpf
- **Type**: ``struct``
- **Members**:
    - `program_address`: Holds the public key of the program.
    - `program_data_account`: Points to a temporary account structure for program data.
    - `upgrade_authority_address`: Holds the public key of the upgrade authority.
    - `has_upgrade_authority_address`: Indicates if the upgrade authority address is set (1 if true, 0 if false).
- **Description**: Defines a structure for managing BPF (Berkeley Packet Filter) program-related data, including the program's public key, associated data account, and upgrade authority information. It includes a flag to indicate the presence of an upgrade authority address.


---
### target\_core\_bpf\_t
- **Type**: ``struct``
- **Members**:
    - `program_address`: Holds the public key of the program.
    - `program_data_account`: Points to the temporary account for program data.
    - `upgrade_authority_address`: Holds the public key of the upgrade authority.
    - `has_upgrade_authority_address`: Indicates if the upgrade authority address is present with a 1-bit flag.
- **Description**: Manages the core BPF program's address, associated data account, and upgrade authority information. It includes a flag to indicate the presence of an upgrade authority address.


---
### target\_builtin
- **Type**: ``struct``
- **Members**:
    - `program_account`: A pointer to a `fd_tmp_account_t` structure representing the program account.
    - `program_data_address`: A `fd_pubkey_t` structure representing the address of the program data.
- **Description**: The `target_builtin` structure is used to represent a built-in target in the context of BPF (Berkeley Packet Filter) migration. It contains a pointer to a temporary account structure for the program account and a public key structure for the program data address. This structure is part of a system that manages the migration of built-in programs to core BPF programs, ensuring that the program account and its associated data are correctly handled during the migration process.


---
### target\_builtin\_t
- **Type**: ``struct``
- **Members**:
    - ``program_account``: Pointer to a `fd_tmp_account_t` representing the program account.
    - ``program_data_address``: Holds a `fd_pubkey_t` representing the program data address.
- **Description**: Defines a structure that holds information about a built-in program, including a pointer to the program account and the program data address. This structure is used in the context of migrating built-in programs to core BPF programs, facilitating the management and access of program-related data.


# Functions

---
### get\_program\_data\_address<!-- {{#callable:get_program_data_address}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_core_bpf_migration.c#L9>)

Calculates and returns the program data address for a given program address using a specific BPF loader program ID.
- **Inputs**:
    - `program_addr`: A pointer to a `fd_pubkey_t` structure representing the program address for which the data address is to be calculated.
- **Logic and Control Flow**:
    - Extracts the seed from the `program_addr` by accessing its `uc` member.
    - Sets the seed size to 32 bytes.
    - Calls [`fd_pubkey_find_program_address`](<fd_pubkey_utils.c.md#fd_pubkey_find_program_address>) with the BPF loader program ID, the seed, and the seed size to find the program data address.
    - Stores the result in the `out` variable.
    - Returns the `out` variable containing the calculated program data address.
- **Output**: Returns a `fd_pubkey_t` structure representing the calculated program data address.
- **Functions Called**:
    - [`fd_pubkey_find_program_address`](<fd_pubkey_utils.c.md#fd_pubkey_find_program_address>)


---
### tmp\_account\_new<!-- {{#callable:tmp_account_new}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_core_bpf_migration.c#L20>)

Initializes a temporary account structure with a specified data size and zeroes out its data.
- **Inputs**:
    - ``acc``: A pointer to an `fd_tmp_account_t` structure that will be initialized.
    - ``acc_sz``: An unsigned long integer representing the size of the data to be allocated for the account.
- **Logic and Control Flow**:
    - Set the `data_sz` field of the `acc` structure to `acc_sz`.
    - Call `fd_memset` to fill the `data` field of `acc` with zeros, up to `acc_sz` bytes.
    - Return the pointer to the initialized `acc` structure.
- **Output**: A pointer to the initialized `fd_tmp_account_t` structure.


---
### tmp\_account\_read<!-- {{#callable:tmp_account_read}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_core_bpf_migration.c#L28>)

Reads account metadata and data into a temporary account structure.
- **Inputs**:
    - ``acc``: A pointer to an `fd_tmp_account_t` structure where the account data will be stored.
    - ``funk``: A pointer to an `fd_funk_t` structure representing the database context.
    - ``xid``: A constant pointer to an `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``addr``: A constant pointer to an `fd_pubkey_t` structure representing the account address.
- **Logic and Control Flow**:
    - Initialize `opt_err` to 0.
    - Call `fd_funk_get_acc_meta_readonly` to retrieve account metadata, passing `funk`, `xid`, `addr`, and `&opt_err` as arguments.
    - Check if `opt_err` is not equal to `FD_ACC_MGR_SUCCESS`. If true, check if `opt_err` is equal to `FD_ACC_MGR_ERR_UNKNOWN_ACCOUNT`. If true, return `NULL`. Otherwise, log a critical error and exit.
    - Call [`tmp_account_new`](<#tmp_account_new>) to initialize the temporary account `acc` with the data length from `meta->dlen`.
    - Copy the metadata from `meta` to `acc->meta`.
    - Copy the address from `addr` to `acc->addr`.
    - Copy the account data from `meta` to `acc->data` using `fd_memcpy`.
    - Set `acc->data_sz` to `meta->dlen`.
    - Return the pointer `acc`.
- **Output**: A pointer to the `fd_tmp_account_t` structure `acc` with the account data, or `NULL` if the account is unknown.
- **Functions Called**:
    - [`tmp_account_new`](<#tmp_account_new>)


---
### tmp\_account\_store<!-- {{#callable:tmp_account_store}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_core_bpf_migration.c#L53>)

Stores a temporary account's data into a transaction account, updates its hash, and finalizes the transaction account.
- **Inputs**:
    - ``acc``: A pointer to an `fd_tmp_account_t` structure representing the temporary account to store.
    - ``accdb``: A pointer to an `fd_accdb_user_t` structure representing the account database user.
    - ``xid``: A pointer to a constant `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``bank``: A pointer to an `fd_bank_t` structure representing the bank context.
    - ``capture_ctx``: A pointer to an `fd_capture_ctx_t` structure representing the capture context.
- **Logic and Control Flow**:
    - Checks if the account address is equal to the system program ID and logs an error if true.
    - Initializes a transaction account record from the temporary account using `fd_txn_account_init_from_funk_mutable` and logs a critical error if initialization fails.
    - Calculates the previous hash of the account using `fd_hashes_account_lthash`.
    - Sets the executable flag, owner, lamports, and data of the transaction account from the temporary account's metadata and data.
    - Updates the hash of the transaction account using `fd_hashes_update_lthash`.
    - Finalizes the transaction account using `fd_txn_account_mutable_fini`.
- **Output**: No return value; the function operates on the provided pointers and logs errors if necessary.


---
### target\_builtin\_new\_checked<!-- {{#callable:target_builtin_new_checked}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_core_bpf_migration.c#L112>)

Initializes a `target_builtin_t` structure by checking the existence and ownership of a program account and ensuring a program data account does not exist, based on the specified migration target.
- **Inputs**:
    - `target_builtin`: A pointer to a `target_builtin_t` structure to initialize.
    - `program_address`: A constant pointer to a `fd_pubkey_t` representing the program's public key address.
    - `migration_target`: An integer specifying the migration target type, either `FD_CORE_BPF_MIGRATION_TARGET_BUILTIN` or `FD_CORE_BPF_MIGRATION_TARGET_STATELESS`.
    - `funk`: A pointer to an `fd_funk_t` structure representing the database context.
    - `xid`: A constant pointer to an `fd_funk_txn_xid_t` representing the transaction ID.
    - `runtime_stack`: A pointer to an `fd_runtime_stack_t` structure used for runtime operations.
- **Logic and Control Flow**:
    - Retrieve the program account from the `runtime_stack`.
    - Check the `migration_target` value to determine the operation.
    - If `migration_target` is `FD_CORE_BPF_MIGRATION_TARGET_BUILTIN`, read the program account and verify its owner is `fd_solana_native_loader_id`; return `NULL` if not found or incorrect owner.
    - If `migration_target` is `FD_CORE_BPF_MIGRATION_TARGET_STATELESS`, ensure the program account does not exist; log an error if it does or if another error occurs.
    - Log an error if `migration_target` is invalid.
    - Calculate the program data address using [`get_program_data_address`](<#get_program_data_address>).
    - Ensure the program data account does not exist; log an error if it does or if another error occurs.
    - Initialize the `target_builtin` structure with the program account and program data address.
    - Return the initialized `target_builtin` pointer.
- **Output**: A pointer to the initialized `target_builtin_t` structure, or `NULL` if an error occurs.
- **Functions Called**:
    - [`tmp_account_read`](<#tmp_account_read>)
    - [`get_program_data_address`](<#get_program_data_address>)


---
### source\_buffer\_new\_checked<!-- {{#callable:source_buffer_new_checked}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_core_bpf_migration.c#L191>)

Validates and initializes a temporary account for a source buffer in a BPF upgradeable loader context.
- **Inputs**:
    - ``acc``: A pointer to an `fd_tmp_account_t` structure that represents the temporary account to be initialized.
    - ``funk``: A pointer to an `fd_funk_t` structure that represents the database context for account operations.
    - ``xid``: A pointer to an `fd_funk_txn_xid_t` structure that represents the transaction identifier.
    - ``pubkey``: A pointer to an `fd_pubkey_t` structure that represents the public key of the account to be read.
- **Logic and Control Flow**:
    - Attempts to read the account data into `acc` using [`tmp_account_read`](<#tmp_account_read>); returns `NULL` if the account is not found.
    - Checks if the account owner matches `fd_solana_bpf_loader_upgradeable_program_id`; returns `NULL` if it does not match.
    - Verifies that the account data size is at least 37 bytes; returns `NULL` if it is smaller.
    - Decodes the BPF upgradeable loader state from the account data using `fd_bincode_decode_static`; returns `NULL` if decoding fails.
    - Returns the initialized `acc` if all checks pass.
- **Output**: Returns a pointer to the initialized `fd_tmp_account_t` structure if successful, or `NULL` if any validation step fails.
- **Functions Called**:
    - [`tmp_account_read`](<#tmp_account_read>)


---
### new\_target\_program\_account<!-- {{#callable:new_target_program_account}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_core_bpf_migration.c#L226>)

Initializes a temporary account for a target program with specific metadata and ownership details.
- **Inputs**:
    - ``acc``: A pointer to an `fd_tmp_account_t` structure that will be initialized as the target program account.
    - ``target``: A constant pointer to a `target_builtin_t` structure containing the program data address.
    - ``rent``: A constant pointer to an `fd_rent_t` structure used to calculate the minimum balance for rent exemption.
- **Logic and Control Flow**:
    - Initialize a `fd_bpf_upgradeable_loader_state_t` structure `state` with a discriminant for a program and set its `programdata_address` to the address from `target->program_data_address`.
    - Call [`tmp_account_new`](<#tmp_account_new>) to initialize `acc` with the size of the `state` structure.
    - Set `acc->meta.lamports` to the minimum balance required for rent exemption using [`fd_rent_exempt_minimum_balance`](<sysvar/fd_sysvar_rent1.c.md#fd_rent_exempt_minimum_balance>) with `rent` and `SIZE_OF_PROGRAM`.
    - Set `acc->meta.executable` to 1, indicating the account is executable.
    - Copy the `fd_solana_bpf_loader_upgradeable_program_id` into `acc->meta.owner` to set the account's owner.
- **Output**: Returns a pointer to the initialized `fd_tmp_account_t` structure `acc`.
- **Functions Called**:
    - [`tmp_account_new`](<#tmp_account_new>)
    - [`fd_rent_exempt_minimum_balance`](<sysvar/fd_sysvar_rent1.c.md#fd_rent_exempt_minimum_balance>)


---
### new\_target\_program\_data\_account<!-- {{#callable:new_target_program_data_account}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_core_bpf_migration.c#L249>)

Creates a new target program data account by validating and processing the source account data and setting up the account metadata.
- **Inputs**:
    - ``acc``: A pointer to the `fd_tmp_account_t` structure where the new account data will be stored.
    - ``source``: A pointer to the `fd_tmp_account_t` structure containing the source account data.
    - ``upgrade_authority_address``: A pointer to the `fd_pubkey_t` structure representing the upgrade authority address, or `NULL` if not applicable.
    - ``rent``: A pointer to the `fd_rent_t` structure used to calculate the minimum balance required for rent exemption.
    - ``slot``: An unsigned long integer representing the slot number for the program data.
- **Logic and Control Flow**:
    - Check if the source account's data size is less than the buffer metadata size; return `NULL` if true.
    - Decode the source account's data into a `fd_bpf_upgradeable_loader_state_t` structure and return `NULL` if decoding fails.
    - Verify that the state discriminant is `fd_bpf_upgradeable_loader_state_enum_buffer`; return `NULL` if not.
    - Check if the presence of an upgrade authority address matches the state; return `NULL` if there is a mismatch.
    - If an upgrade authority address is provided, verify it matches the state's authority address; return `NULL` if there is a mismatch.
    - Calculate the size of the ELF data and the total space required for the new account.
    - Determine the minimum balance required for rent exemption using the [`fd_rent_exempt_minimum_balance`](<sysvar/fd_sysvar_rent1.c.md#fd_rent_exempt_minimum_balance>) function.
    - Initialize a `fd_bpf_upgradeable_loader_state_t` structure for the program data metadata.
    - Create a new temporary account with the calculated space using [`tmp_account_new`](<#tmp_account_new>).
    - Set the account's lamports and owner fields.
    - Encode the program data metadata into the account's data using `fd_bpf_upgradeable_loader_state_encode`; log an error if encoding fails.
    - Copy the ELF data into the account's data buffer after the metadata.
- **Output**: Returns a pointer to the newly created `fd_tmp_account_t` structure, or `NULL` if any validation or processing step fails.
- **Functions Called**:
    - [`fd_rent_exempt_minimum_balance`](<sysvar/fd_sysvar_rent1.c.md#fd_rent_exempt_minimum_balance>)
    - [`tmp_account_new`](<#tmp_account_new>)


---
### migrate\_builtin\_to\_core\_bpf1<!-- {{#callable:migrate_builtin_to_core_bpf1}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_core_bpf_migration.c#L309>)

Migrates a built-in program to a core BPF program by creating new target accounts, handling data size calculations, and updating bank capitalization.
- **Inputs**:
    - `config`: A pointer to `fd_core_bpf_migration_config_t` containing migration configuration details.
    - `accdb`: A pointer to `fd_accdb_user_t` representing the account database user.
    - `xid`: A pointer to `fd_funk_txn_xid_t` representing the transaction ID.
    - `bank`: A pointer to `fd_bank_t` representing the bank where the migration occurs.
    - `runtime_stack`: A pointer to `fd_runtime_stack_t` used for temporary storage during migration.
    - `builtin_program_id`: A pointer to `fd_pubkey_t` representing the ID of the built-in program to migrate.
    - `capture_ctx`: A pointer to `fd_capture_ctx_t` used for capturing context during migration.
- **Logic and Control Flow**:
    - Initialize a `target_builtin_t` structure and check if the new target can be created using [`target_builtin_new_checked`](<#target_builtin_new_checked>).
    - Create a source buffer account using [`source_buffer_new_checked`](<#source_buffer_new_checked>) and check for success.
    - Query rent and slot information from the bank.
    - Create new target program and program data accounts using [`new_target_program_account`](<#new_target_program_account>) and [`new_target_program_data_account`](<#new_target_program_data_account>), respectively, and check for success.
    - Calculate old and new data sizes and check for overflow using `__builtin_uaddl_overflow`.
    - Invoke the loader to deploy the new program data using [`fd_directly_invoke_loader_v3_deploy`](<program/fd_bpf_loader_program.c.md#fd_directly_invoke_loader_v3_deploy>) and check for success.
    - Calculate lamports to burn and fund, checking for overflow.
    - Adjust bank capitalization based on lamports calculations and check for overflow.
    - Store the new target program and program data accounts back to the account database.
    - Create an empty account to replace the source account and store it back to the account database.
    - Note the need to remove the built-in program from the bank's list and update account data size delta (marked as FIXME).
- **Output**: No explicit output is returned; the function performs operations on the provided data structures and logs errors if any issues occur.
- **Functions Called**:
    - [`target_builtin_new_checked`](<#target_builtin_new_checked>)
    - [`source_buffer_new_checked`](<#source_buffer_new_checked>)
    - [`new_target_program_account`](<#new_target_program_account>)
    - [`new_target_program_data_account`](<#new_target_program_data_account>)
    - [`fd_directly_invoke_loader_v3_deploy`](<program/fd_bpf_loader_program.c.md#fd_directly_invoke_loader_v3_deploy>)
    - [`tmp_account_store`](<#tmp_account_store>)
    - [`tmp_account_new`](<#tmp_account_new>)


---
### fd\_migrate\_builtin\_to\_core\_bpf<!-- {{#callable:fd_migrate_builtin_to_core_bpf}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_core_bpf_migration.c#L429>)

Calls [`migrate_builtin_to_core_bpf1`](<#migrate_builtin_to_core_bpf1>) to migrate a built-in program to a core BPF program using the provided configuration and context.
- **Inputs**:
    - ``bank``: A pointer to an `fd_bank_t` structure representing the bank where the migration occurs.
    - ``accdb``: A pointer to an `fd_accdb_user_t` structure representing the account database user context.
    - ``xid``: A pointer to an `fd_funk_txn_xid_t` structure representing the transaction ID for the migration.
    - ``runtime_stack``: A pointer to an `fd_runtime_stack_t` structure used for runtime operations during the migration.
    - ``config``: A pointer to an `fd_core_bpf_migration_config_t` structure containing the configuration for the migration.
    - ``capture_ctx``: A pointer to an `fd_capture_ctx_t` structure used for capturing context during the migration.
- **Logic and Control Flow**:
    - Calls the function [`migrate_builtin_to_core_bpf1`](<#migrate_builtin_to_core_bpf1>) with the provided arguments and the `builtin_program_id` from the `config`.
- **Output**: No return value; the function performs its operations through side effects on the provided structures and context.
- **Functions Called**:
    - [`migrate_builtin_to_core_bpf1`](<#migrate_builtin_to_core_bpf1>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)