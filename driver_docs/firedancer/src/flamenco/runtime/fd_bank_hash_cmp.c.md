<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for managing and comparing bank hash data structures, including insertion and validation.

# Purpose
The code provides functionality for managing and comparing bank hash entries in a data structure. It includes functions to create, join, leave, and delete a bank hash comparison object, as well as to lock and unlock it for thread safety. The primary purpose of this code is to manage a collection of hash entries, allowing for the insertion of new entries, checking for hash mismatches, and handling potential conflicts by comparing the stake associated with each hash. The code ensures that memory alignment and integrity checks are performed before operations, and it logs warnings for any anomalies encountered during execution.

The code defines a set of functions that operate on a data structure represented by `fd_bank_hash_cmp_t`. The [`fd_bank_hash_cmp_new`](<#fd_bank_hash_cmp_new>) function initializes a new bank hash comparison object in a given memory space, while [`fd_bank_hash_cmp_join`](<#fd_bank_hash_cmp_join>) and [`fd_bank_hash_cmp_leave`](<#fd_bank_hash_cmp_leave>) manage the lifecycle of the object. The [`fd_bank_hash_cmp_insert`](<#fd_bank_hash_cmp_insert>) function adds new hash entries to the structure, and [`fd_bank_hash_cmp_check`](<#fd_bank_hash_cmp_check>) verifies the consistency of the hashes, logging any mismatches. The code uses atomic operations and memory fences to ensure thread safety when locking and unlocking the data structure. The functions are designed to be used in a multi-threaded environment, as indicated by the conditional compilation directives for thread support.
# Imports and Dependencies

---
- `fd_bank_hash_cmp.h`
- `unistd.h`


# Functions

---
### fd\_bank\_hash\_cmp\_new<!-- {{#callable:fd_bank_hash_cmp_new}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank_hash_cmp.c#L4>)

Initializes a memory region for a bank hash comparison structure, ensuring alignment and setting up internal components.
- **Inputs**:
    - `mem`: A pointer to the memory region to initialize for the bank hash comparison structure.
- **Logic and Control Flow**:
    - Check if `mem` is NULL; if so, log a warning and return NULL.
    - Check if `mem` is aligned according to [`fd_bank_hash_cmp_align`](<fd_bank_hash_cmp.h.md#fd_bank_hash_cmp_align>); if not, log a warning and return NULL.
    - Calculate the footprint size using [`fd_bank_hash_cmp_footprint`](<fd_bank_hash_cmp.h.md#fd_bank_hash_cmp_footprint>).
    - Set the memory region to zero using `fd_memset`.
    - Calculate the starting address for the map component by adding the size of `fd_bank_hash_cmp_t` to `mem`.
    - Align the map starting address using `fd_ulong_align_up` with `fd_bank_hash_cmp_map_align`.
    - Initialize the map component at the aligned address using `fd_bank_hash_cmp_map_new`.
    - Set the map offset in the bank hash comparison structure using [`fd_bank_hash_cmp_set_map_offset`](<fd_bank_hash_cmp.h.md#fd_bank_hash_cmp_set_map_offset>).
    - Increment the address by the map's footprint size using `fd_bank_hash_cmp_map_footprint`.
    - Align the final address using `fd_ulong_align_up` with [`fd_bank_hash_cmp_align`](<fd_bank_hash_cmp.h.md#fd_bank_hash_cmp_align>).
    - Verify that the final address matches the expected end of the footprint using `FD_TEST`.
    - Return the initialized memory region `mem`.
- **Output**: Returns the initialized memory region `mem` if successful, or NULL if there is an error.
- **Functions Called**:
    - [`fd_bank_hash_cmp_align`](<fd_bank_hash_cmp.h.md#fd_bank_hash_cmp_align>)
    - [`fd_bank_hash_cmp_footprint`](<fd_bank_hash_cmp.h.md#fd_bank_hash_cmp_footprint>)
    - [`fd_bank_hash_cmp_set_map_offset`](<fd_bank_hash_cmp.h.md#fd_bank_hash_cmp_set_map_offset>)


---
### fd\_bank\_hash\_cmp\_join<!-- {{#callable:fd_bank_hash_cmp_join}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank_hash_cmp.c#L35>)

Validates and joins a `fd_bank_hash_cmp_t` structure if it is non-null and properly aligned, and verifies the associated entry map.
- **Inputs**:
    - `bank_hash_cmp`: A pointer to a `fd_bank_hash_cmp_t` structure to be validated and joined.
- **Logic and Control Flow**:
    - Check if `bank_hash_cmp` is NULL; if so, log a warning and return NULL.
    - Check if `bank_hash_cmp` is aligned according to [`fd_bank_hash_cmp_align`](<fd_bank_hash_cmp.h.md#fd_bank_hash_cmp_align>); if not, log a warning and return NULL.
    - Calculate the address `laddr` by adding the size of `fd_bank_hash_cmp_t` to `bank_hash_cmp`.
    - Attempt to join the entry map using `fd_bank_hash_cmp_map_join` with the calculated address `laddr`.
    - If the entry map is invalid (NULL), log a warning and return NULL.
    - Return the original `bank_hash_cmp` pointer if all checks pass.
- **Output**: Returns the original `bank_hash_cmp` pointer if it is valid and properly aligned, otherwise returns NULL.
- **Functions Called**:
    - [`fd_bank_hash_cmp_align`](<fd_bank_hash_cmp.h.md#fd_bank_hash_cmp_align>)


---
### fd\_bank\_hash\_cmp\_leave<!-- {{#callable:fd_bank_hash_cmp_leave}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank_hash_cmp.c#L59>)

Returns the input `bank_hash_cmp` pointer if it is not NULL, otherwise logs a warning and returns NULL.
- **Inputs**:
    - `bank_hash_cmp`: A pointer to a constant `fd_bank_hash_cmp_t` structure that the function will check for NULL.
- **Logic and Control Flow**:
    - Check if `bank_hash_cmp` is NULL using `FD_UNLIKELY`.
    - If `bank_hash_cmp` is NULL, log a warning message 'NULL bank_hash_cmp' and return NULL.
    - If `bank_hash_cmp` is not NULL, cast it to a `void *` and return it.
- **Output**: A `void *` pointer to the `bank_hash_cmp` if it is not NULL, otherwise NULL.


---
### fd\_bank\_hash\_cmp\_delete<!-- {{#callable:fd_bank_hash_cmp_delete}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank_hash_cmp.c#L70>)

Validates and returns a pointer to `bank_hash_cmp` if it is non-null and properly aligned, otherwise logs a warning and returns NULL.
- **Inputs**:
    - `bank_hash_cmp`: A pointer to the bank hash comparison structure to be validated and potentially deleted.
- **Logic and Control Flow**:
    - Check if `bank_hash_cmp` is NULL; if true, log a warning and return NULL.
    - Check if `bank_hash_cmp` is aligned according to [`fd_bank_hash_cmp_align`](<fd_bank_hash_cmp.h.md#fd_bank_hash_cmp_align>); if not, log a warning and return NULL.
    - Return the `bank_hash_cmp` pointer if it passes the above checks.
- **Output**: Returns the `bank_hash_cmp` pointer if it is valid and aligned, otherwise returns NULL.
- **Functions Called**:
    - [`fd_bank_hash_cmp_align`](<fd_bank_hash_cmp.h.md#fd_bank_hash_cmp_align>)


---
### fd\_bank\_hash\_cmp\_lock<!-- {{#callable:fd_bank_hash_cmp_lock}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank_hash_cmp.c#L86>)

Locks the `fd_bank_hash_cmp_t` structure for thread-safe operations.
- **Inputs**:
    - `bank_hash_cmp`: A pointer to the `fd_bank_hash_cmp_t` structure to lock.
- **Logic and Control Flow**:
    - Declare a volatile integer pointer `lock` pointing to the `lock` member of `bank_hash_cmp`.
    - If `FD_HAS_THREADS` is defined, enter an infinite loop.
    - In the loop, use `FD_ATOMIC_CAS` to attempt to set `lock` from 0 to 1 atomically.
    - If the atomic compare-and-swap is successful, break the loop.
    - If not, call `FD_SPIN_PAUSE` to yield the processor and retry.
    - If `FD_HAS_THREADS` is not defined, directly set `lock` to 1.
    - Call `FD_COMPILER_MFENCE` to ensure memory operations are completed before proceeding.
- **Output**: No return value; the function locks the `fd_bank_hash_cmp_t` structure for exclusive access.


---
### fd\_bank\_hash\_cmp\_unlock<!-- {{#callable:fd_bank_hash_cmp_unlock}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank_hash_cmp.c#L100>)

Releases the lock on a `fd_bank_hash_cmp_t` structure by setting its lock variable to zero.
- **Inputs**:
    - ``bank_hash_cmp``: A pointer to a `fd_bank_hash_cmp_t` structure whose lock is to be released.
- **Logic and Control Flow**:
    - Retrieve the address of the lock variable from the `bank_hash_cmp` structure.
    - Execute a memory fence operation to ensure memory operations are completed in order.
    - Set the lock variable to zero, indicating the lock is released.
- **Output**: No return value.


---
### fd\_bank\_hash\_cmp\_insert<!-- {{#callable:fd_bank_hash_cmp_insert}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank_hash_cmp.c#L107>)

Inserts a hash into a bank hash comparison map, handling potential overflow and updating stakes.
- **Inputs**:
    - ``bank_hash_cmp``: A pointer to the `fd_bank_hash_cmp_t` structure representing the bank hash comparison map.
    - ``slot``: An unsigned long integer representing the slot number for the hash entry.
    - ``hash``: A pointer to a constant `fd_hash_t` structure representing the hash to insert.
    - ``ours``: An integer flag indicating if the hash is 'ours' (non-zero) or 'theirs' (zero).
    - ``stake``: An unsigned long integer representing the stake associated with the hash.
- **Logic and Control Flow**:
    - Retrieve the map from `bank_hash_cmp` using [`fd_bank_hash_cmp_get_map`](<fd_bank_hash_cmp.h.md#fd_bank_hash_cmp_get_map>).
    - Check if `slot` is less than or equal to the `watermark` of `bank_hash_cmp`; if so, return immediately.
    - Query the map for an entry at `slot` using `fd_bank_hash_cmp_map_query`; if no entry exists, proceed to insert a new one.
    - If the map is full, log a warning and remove entries below the `watermark` to make room.
    - Insert a new entry for `slot` using `fd_bank_hash_cmp_map_insert` and increment the count.
    - If `ours` is non-zero, set the `ours` field of the entry to the provided `hash` and return.
    - Iterate over existing entries in `theirs` to check for a matching hash using `memcmp`; if found, update the corresponding stake and return.
    - Check if the entry's count has reached its maximum; if so, log a warning about overflow and set the `overflow` flag.
    - If no matching hash is found, add the new hash and stake to the entry, increment the count, and log a warning if there are multiple entries.
- **Output**: No return value; the function modifies the `bank_hash_cmp` structure in place.
- **Functions Called**:
    - [`fd_bank_hash_cmp_get_map`](<fd_bank_hash_cmp.h.md#fd_bank_hash_cmp_get_map>)


---
### fd\_bank\_hash\_cmp\_check<!-- {{#callable:fd_bank_hash_cmp_check}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank_hash_cmp.c#L177>)

Checks if the bank hash comparison for a given slot results in a match or mismatch based on stake percentages.
- **Inputs**:
    - ``bank_hash_cmp``: A pointer to the `fd_bank_hash_cmp_t` structure that contains the bank hash comparison data.
    - ``slot``: An unsigned long integer representing the slot number to check in the bank hash comparison map.
- **Logic and Control Flow**:
    - Retrieve the map from `bank_hash_cmp` using [`fd_bank_hash_cmp_get_map`](<fd_bank_hash_cmp.h.md#fd_bank_hash_cmp_get_map>).
    - Query the map for the entry corresponding to `slot` using `fd_bank_hash_cmp_map_query`.
    - If the entry is not found, return 0.
    - Initialize a null hash and check if `cmp->ours` is equal to the null hash; if so, return 0.
    - If `cmp->cnt` is zero, return 0.
    - Find the hash with the highest stake in `cmp->theirs` and store it in `theirs`.
    - Calculate the percentage of the highest stake relative to `bank_hash_cmp->total_stake`.
    - If the percentage is greater than 52%, compare `cmp->ours` with `theirs`.
    - If they do not match, log a warning and return -1.
    - If they match, log an info message, remove the entry from the map, decrement `bank_hash_cmp->cnt`, and return 1.
    - If the percentage is not greater than 52%, return 0.
- **Output**: Returns 1 if a match is found, -1 if a mismatch is found, and 0 if no valid comparison can be made.
- **Functions Called**:
    - [`fd_bank_hash_cmp_get_map`](<fd_bank_hash_cmp.h.md#fd_bank_hash_cmp_get_map>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)