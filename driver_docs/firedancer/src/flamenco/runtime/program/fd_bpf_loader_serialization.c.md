<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Serialization and deserialization of BPF virtual machine input regions, supporting multiple modes and direct mapping.

# Purpose
The code is responsible for handling the serialization and deserialization of the input region for a BPF (Berkeley Packet Filter) virtual machine. This input region includes instruction information, account metadata, and account data. The code defines three serialization modes based on two feature flags: `stricter_abi_and_runtime_constraints` and `account_data_direct_mapping`. These modes determine how the memory layout is organized and how data is serialized and deserialized. The modes range from using a single contiguous buffer to more sophisticated memory translation protocols that allow direct mapping of account data into the VM's virtual address space. This approach aims to optimize memory usage and performance, especially when dealing with large account data and nested CPI (Cross-Program Invocation) calls.

The code includes functions for both aligned and unaligned serialization and deserialization processes. It manages memory regions, ensuring that account data is correctly serialized into a buffer and deserialized back into the borrowed account structures. The functions handle different scenarios, such as whether direct mapping is enabled and whether alignment is required. The code also includes error handling for various conditions, such as exceeding the maximum number of accounts or invalid memory operations. The functions [`fd_bpf_loader_input_serialize_parameters`](<#fd_bpf_loader_input_serialize_parameters>) and [`fd_bpf_loader_input_deserialize_parameters`](<#fd_bpf_loader_input_deserialize_parameters>) serve as entry points for the serialization and deserialization processes, respectively, and they determine the appropriate method to use based on the `is_deprecated` flag.
# Imports and Dependencies

---
- `fd_bpf_loader_serialization.h`
- `../fd_borrowed_account.h`
- `../fd_runtime.h`


# Functions

---
### new\_input\_mem\_region<!-- {{#callable:new_input_mem_region}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_bpf_loader_serialization.c#L118>)

Adds a new memory region to the input memory regions array with specified properties.
- **Inputs**:
    - ``input_mem_regions``: An array of `fd_vm_input_region_t` structures representing the input memory regions.
    - ``input_mem_regions_cnt``: A pointer to a `uint` that holds the current count of input memory regions.
    - ``buffer``: A pointer to an `uchar` buffer representing the host address of the new memory region.
    - ``region_sz``: An `ulong` representing the size of the new memory region.
    - ``address_space_reserved``: An `ulong` representing the reserved address space for the new memory region.
    - ``is_writable``: An `uchar` indicating if the new memory region is writable (1 for writable, 0 for read-only).
    - ``acc_region_meta_idx``: An `ulong` representing the index of the account region metadata associated with the new memory region.
- **Logic and Control Flow**:
    - Calculate the virtual address offset for the new region based on the previous region's offset and reserved address space, or set to 0 if it is the first region.
    - Set the properties of the new memory region in the `input_mem_regions` array, including writability, host address, region size, reserved address space, virtual address offset, and account region metadata index.
    - Increment the count of input memory regions.
- **Output**: No return value; the function modifies the `input_mem_regions` array and updates `input_mem_regions_cnt`.


---
### write\_account<!-- {{#callable:write_account}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_bpf_loader_serialization.c#L149>)

Serializes account data and metadata into a buffer, handling different serialization modes based on constraints and mapping options.
- **Inputs**:
    - `account`: Pointer to the `fd_borrowed_account_t` structure representing the account to serialize.
    - `instr_acc_idx`: Index of the account in the instruction's account list.
    - `serialized_params`: Pointer to the current position in the serialized parameters buffer.
    - `serialized_params_start`: Pointer to the start of the serialized parameters buffer.
    - `input_mem_regions`: Array of `fd_vm_input_region_t` structures representing input memory regions.
    - `input_mem_regions_cnt`: Pointer to the count of input memory regions.
    - `acc_region_metas`: Array of `fd_vm_acc_region_meta_t` structures for account region metadata.
    - `is_loader_v1`: Flag indicating if the loader version is 1.
    - `stricter_abi_and_runtime_constraints`: Flag indicating if stricter ABI and runtime constraints are applied.
    - `direct_mapping`: Flag indicating if direct mapping is enabled.
- **Logic and Control Flow**:
    - Retrieve account data and its length if the account is not NULL.
    - Store the original data length and account reference in `acc_region_metas` for the given index.
    - If `stricter_abi_and_runtime_constraints` is false, copy account data into the buffer and handle padding and alignment if `is_loader_v1` is false.
    - If `stricter_abi_and_runtime_constraints` is true, set up account region metadata and add a new input memory region for the serialized metadata.
    - If `direct_mapping` is false, copy account data into the buffer and handle padding and alignment if `is_loader_v1` is false.
    - Calculate the address space reserved for the account, considering data length and potential realloc space.
    - If the reserved address space is greater than zero, determine if the account data can be changed and create a new input memory region pointing to the data, either copied or directly mapped.
    - Update `serialized_params_start` to the current position in the buffer.
    - Return the total size of the serialized region and reserved address space if `stricter_abi_and_runtime_constraints` is true, otherwise return 0.
- **Output**: Returns the size of the serialized region and reserved address space if stricter constraints are applied, otherwise returns 0.
- **Functions Called**:
    - [`new_input_mem_region`](<#new_input_mem_region>)


---
### fd\_bpf\_loader\_input\_serialize\_aligned<!-- {{#callable:fd_bpf_loader_input_serialize_aligned}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_bpf_loader_serialization.c#L257>)

Serializes input data for a BPF virtual machine, aligning it to 16-byte boundaries and handling account metadata and data.
- **Inputs**:
    - `ctx`: A pointer to `fd_exec_instr_ctx_t`, which contains the execution context including transaction and instruction details.
    - `sz`: A pointer to an `ulong` where the function will store the size of the serialized data.
    - `pre_lens`: A pointer to an `ulong` array where the function will store the pre-serialization lengths of account data.
    - `input_mem_regions`: A pointer to an array of `fd_vm_input_region_t` structures to store memory region metadata.
    - `input_mem_regions_cnt`: A pointer to a `uint` that tracks the count of input memory regions.
    - `acc_region_metas`: A pointer to an array of `fd_vm_acc_region_meta_t` structures to store account region metadata.
    - `stricter_abi_and_runtime_constraints`: An `int` flag indicating whether stricter ABI and runtime constraints are applied.
    - `direct_mapping`: An `int` flag indicating whether direct mapping of account data is enabled.
- **Logic and Control Flow**:
    - Initialize arrays `acc_idx_seen` and `dup_acc_idx` to track seen account indices and duplicates.
    - Calculate the total serialized size by iterating over accounts, considering alignment and metadata size.
    - Allocate a 16-byte aligned buffer for serialized parameters using `fd_spad_alloc`.
    - Store the account count in the buffer and iterate over accounts to serialize metadata and data.
    - For duplicate accounts, store a marker and index; for new accounts, serialize metadata and data, updating offsets in `acc_region_metas`.
    - Call [`write_account`](<#write_account>) to handle account data serialization, considering constraints and mapping options.
    - Store instruction data and program ID in the buffer.
    - Create a new input memory region for the serialized data and update `input_mem_regions` and `input_mem_regions_cnt`.
    - Set the output size `sz` to the calculated serialized size.
- **Output**: Returns a pointer to the start of the serialized parameters buffer.
- **Functions Called**:
    - [`write_account`](<#write_account>)
    - [`new_input_mem_region`](<#new_input_mem_region>)


---
### fd\_bpf\_loader\_input\_deserialize\_aligned<!-- {{#callable:fd_bpf_loader_input_deserialize_aligned}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_bpf_loader_serialization.c#L447>)

Deserializes account data from a buffer into a BPF virtual machine context, handling account metadata and data integrity checks.
- **Inputs**:
    - `ctx`: A pointer to `fd_exec_instr_ctx_t`, which contains the execution context for the instruction.
    - `pre_lens`: A pointer to an array of unsigned long integers representing the pre-serialization lengths of account data.
    - `buffer`: A pointer to an unsigned char array that contains the serialized account data.
    - `buffer_sz`: An unsigned long integer representing the size of the buffer.
    - `stricter_abi_and_runtime_constraints`: An integer flag indicating whether stricter ABI and runtime constraints are applied.
    - `direct_mapping`: An integer flag indicating whether direct mapping is enabled.
- **Logic and Control Flow**:
    - Initialize `start` to 0 and `acc_idx_seen` array to track seen account indices.
    - Increment `start` by the size of an unsigned long to skip the number of accounts.
    - Iterate over each account in the instruction context (`ctx->instr->acct_cnt`).
    - For each account, retrieve the account index and increment `start` by 1 for position tracking.
    - Check if the account index has been seen before; if so, increment `start` by 7 to maintain alignment.
    - If the account index is new, mark it as seen and increment `start` by the sizes of various metadata fields (e.g., `is_signer`, `is_writable`, `executable`, `original_data_len`, `key`).
    - Retrieve the account owner from the buffer and update `start` accordingly.
    - Load the lamports from the buffer and compare with the current account's lamports; update if necessary.
    - Load the post-serialization data length from the buffer and calculate alignment offset.
    - Check if the post-serialization data length exceeds permitted limits; return an error if so.
    - If stricter constraints are not applied, check if the buffer size is sufficient and if the account data can be resized or changed; update the account data if possible.
    - If stricter constraints are applied but direct mapping is not enabled, check if the account data can be changed and update it if possible.
    - If the account data length differs from the post-serialization length, update the data length.
    - Adjust `start` based on alignment and permitted data increase, or by a fixed alignment size if stricter constraints and direct mapping are both enabled.
    - Load the rent epoch from the buffer and update `start`.
    - Compare the current account owner with the owner from the buffer; update if different.
- **Output**: Returns an integer status code, `FD_EXECUTOR_INSTR_SUCCESS` on success or an error code on failure.


---
### fd\_bpf\_loader\_input\_serialize\_unaligned<!-- {{#callable:fd_bpf_loader_input_serialize_unaligned}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_bpf_loader_serialization.c#L576>)

Serializes account and instruction data into a contiguous buffer for a BPF virtual machine, considering constraints and mapping options.
- **Inputs**:
    - `ctx`: A pointer to `fd_exec_instr_ctx_t`, which contains the execution context including transaction and instruction details.
    - `sz`: A pointer to an `ulong` where the function will store the size of the serialized data.
    - `pre_lens`: A pointer to an array of `ulong` where the function will store the lengths of account data before serialization.
    - `input_mem_regions`: A pointer to an array of `fd_vm_input_region_t` where the function will store metadata about input memory regions.
    - `input_mem_regions_cnt`: A pointer to a `uint` where the function will store the count of input memory regions.
    - `acc_region_metas`: A pointer to an array of `fd_vm_acc_region_meta_t` where the function will store metadata about account regions.
    - `stricter_abi_and_runtime_constraints`: An `int` flag indicating whether stricter ABI and runtime constraints are applied.
    - `direct_mapping`: An `int` flag indicating whether direct mapping of account data is enabled.
- **Logic and Control Flow**:
    - Initialize `serialized_size` to zero and retrieve transaction account keys from `ctx`.
    - Iterate over each account in the instruction context to calculate the serialized size, considering duplicate accounts and constraints.
    - Allocate a 16-byte aligned buffer for serialized parameters using `fd_spad_alloc`.
    - Store the account count in the buffer and iterate over each account again to serialize account metadata and data.
    - For each account, check if it is a duplicate and handle accordingly by storing a marker or serializing full metadata and data.
    - Serialize account metadata including signer status, writability, public key, lamports, data length, owner, and executable status.
    - If direct mapping is not enabled, copy account data into the buffer; otherwise, handle direct mapping logic.
    - Serialize instruction data and program ID into the buffer.
    - Verify the serialized size matches the expected size and update the size pointer `sz`.
    - Add a new input memory region using [`new_input_mem_region`](<#new_input_mem_region>) to represent the serialized data.
- **Output**: Returns a pointer to the start of the serialized parameters buffer.
- **Functions Called**:
    - [`write_account`](<#write_account>)
    - [`new_input_mem_region`](<#new_input_mem_region>)


---
### fd\_bpf\_loader\_input\_deserialize\_unaligned<!-- {{#callable:fd_bpf_loader_input_deserialize_unaligned}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_bpf_loader_serialization.c#L721>)

Deserializes unaligned input data for BPF loader, updating account metadata and data based on constraints and mapping options.
- **Inputs**:
    - ``ctx``: A pointer to `fd_exec_instr_ctx_t`, which contains the execution context and instruction information.
    - ``pre_lens``: A pointer to an array of unsigned long integers representing the pre-serialization lengths of account data.
    - ``input``: A pointer to an unsigned character array containing the serialized input data.
    - ``input_sz``: An unsigned long integer representing the size of the input data.
    - ``stricter_abi_and_runtime_constraints``: An integer flag indicating whether stricter ABI and runtime constraints are applied.
    - ``direct_mapping``: An integer flag indicating whether direct mapping is enabled.
- **Logic and Control Flow**:
    - Initialize `input_cursor` to point to the start of the `input` data and an array `acc_idx_seen` to track seen account indices.
    - Skip the first `ulong` in the input data, which represents the number of accounts.
    - Iterate over each account in the instruction context (`ctx->instr->acct_cnt`).
    - For each account, check if the account index has been seen before using `acc_idx_seen`. If seen, skip processing for this account.
    - If not seen, mark the account index as seen and proceed to update the `input_cursor` to skip over metadata fields such as `is_signer`, `is_writable`, and `key`.
    - Borrow the account using `FD_TRY_BORROW_INSTR_ACCOUNT_DEFAULT_ERR_CHECK` and load the `lamports` value from the input data.
    - If the loaded `lamports` value differs from the current account's `lamports`, update the account's `lamports` using `fd_borrowed_account_set_lamports`.
    - Load the `post_len` (data length) from the input data and calculate the `pre_len` from `pre_lens`.
    - Check if the account data can be resized and changed based on the constraints and mapping options, and update the account data accordingly.
    - If the `stricter_abi_and_runtime_constraints` and `direct_mapping` flags are not both set, advance the `input_cursor` by `pre_len`.
    - Advance the `input_cursor` by the size of the `owner`, `executable`, and `rent_epoch` fields.
    - Check if the `input_cursor` exceeds the `input` size (`input_sz`) and return an error if it does.
- **Output**: Returns 0 on success or an error code if deserialization fails or constraints are violated.


---
### fd\_bpf\_loader\_input\_serialize\_parameters<!-- {{#callable:fd_bpf_loader_input_serialize_parameters}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_bpf_loader_serialization.c#L811>)

Serializes input parameters for a BPF loader based on alignment and deprecation status.
- **Inputs**:
    - ``instr_ctx``: A pointer to the instruction context containing execution details.
    - ``sz``: A pointer to a variable where the size of the serialized data will be stored.
    - ``pre_lens``: A pointer to an array storing the lengths of pre-serialized data for each account.
    - ``input_mem_regions``: A pointer to an array of memory regions for input data.
    - ``input_mem_regions_cnt``: A pointer to a variable storing the count of input memory regions.
    - ``acc_region_metas``: A pointer to an array of metadata for account regions.
    - ``stricter_abi_and_runtime_constraints``: An integer flag indicating if stricter ABI and runtime constraints are applied.
    - ``direct_mapping``: An integer flag indicating if direct mapping is enabled.
    - ``is_deprecated``: A flag indicating if the deprecated serialization method should be used.
    - ``out``: A pointer to a pointer where the serialized output will be stored.
- **Logic and Control Flow**:
    - Retrieve the number of instruction accounts from `instr_ctx` and check if it exceeds `FD_INSTR_ACCT_MAX`; return an error if exceeded.
    - Check if `is_deprecated` is true; if so, call [`fd_bpf_loader_input_serialize_unaligned`](<#fd_bpf_loader_input_serialize_unaligned>) to serialize using the unaligned method.
    - If `is_deprecated` is false, call [`fd_bpf_loader_input_serialize_aligned`](<#fd_bpf_loader_input_serialize_aligned>) to serialize using the aligned method.
    - Store the result of the serialization function in `out`.
    - Return `FD_EXECUTOR_INSTR_SUCCESS` to indicate successful serialization.
- **Output**: Returns an integer status code indicating success or an error if the maximum number of accounts is exceeded.
- **Functions Called**:
    - [`fd_bpf_loader_input_serialize_unaligned`](<#fd_bpf_loader_input_serialize_unaligned>)
    - [`fd_bpf_loader_input_serialize_aligned`](<#fd_bpf_loader_input_serialize_aligned>)


---
### fd\_bpf\_loader\_input\_deserialize\_parameters<!-- {{#callable:fd_bpf_loader_input_deserialize_parameters}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_bpf_loader_serialization.c#L848>)

Deserializes input parameters for a BPF loader, choosing between aligned and unaligned deserialization based on the `is_deprecated` flag.
- **Inputs**:
    - `ctx`: A pointer to the `fd_exec_instr_ctx_t` context structure, which contains execution context information.
    - `pre_lens`: A pointer to an array of unsigned long integers representing the pre-serialized lengths of account data.
    - `input`: A pointer to an unsigned character array containing the serialized input data.
    - `input_sz`: An unsigned long integer representing the size of the input data.
    - `stricter_abi_and_runtime_constraints`: An integer flag indicating whether stricter ABI and runtime constraints are applied.
    - `direct_mapping`: An integer flag indicating whether direct mapping is enabled.
    - `is_deprecated`: An unsigned character flag indicating whether the deprecated deserialization method should be used.
- **Logic and Control Flow**:
    - Checks if `is_deprecated` is true.
    - If `is_deprecated` is true, calls [`fd_bpf_loader_input_deserialize_unaligned`](<#fd_bpf_loader_input_deserialize_unaligned>) with the provided parameters.
    - If `is_deprecated` is false, calls [`fd_bpf_loader_input_deserialize_aligned`](<#fd_bpf_loader_input_deserialize_aligned>) with the provided parameters.
- **Output**: Returns an integer status code from the deserialization function called, indicating success or failure.
- **Functions Called**:
    - [`fd_bpf_loader_input_deserialize_unaligned`](<#fd_bpf_loader_input_deserialize_unaligned>)
    - [`fd_bpf_loader_input_deserialize_aligned`](<#fd_bpf_loader_input_deserialize_aligned>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)