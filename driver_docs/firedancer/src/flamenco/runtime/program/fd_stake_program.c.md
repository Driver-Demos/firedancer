<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a stake program with functions for account management, delegation, merging, and error handling.

# Purpose
The code is a C implementation of a stake program, which is part of a larger system for managing and executing stake-related operations. It provides a comprehensive set of functionalities for handling stake accounts, including initialization, authorization, delegation, splitting, merging, withdrawing, and deactivating stakes. The code defines various data structures, constants, and functions to manage the state and behavior of stake accounts, ensuring that operations adhere to specific rules and constraints.

Key components include error definitions, constants for stake management, and structures for representing different states and operations related to stakes. The code also includes functions for encoding and decoding stake states, validating operations, and executing instructions. It defines a public API for executing stake program instructions, which are processed based on their type, such as initializing a stake account, authorizing a new authority, delegating stake, and more. The code ensures that operations are performed safely and correctly, with checks for conditions like sufficient funds, valid signatures, and correct account states.
# Imports and Dependencies

---
- `limits.h`
- `../../../util/bits/fd_sat.h`
- `../../../util/bits/fd_uwide.h`
- `../fd_borrowed_account.h`
- `../fd_executor.h`
- `../fd_pubkey_utils.h`
- `../fd_system_ids.h`
- `fd_stake_program.h`
- `fd_vote_program.h`
- `../sysvar/fd_sysvar_epoch_schedule.h`
- `../sysvar/fd_sysvar_rent.h`
- `../sysvar/fd_sysvar.h`


# Data Structures

---
### merge\_kind\_inactive
- **Type**: ``struct``
- **Members**:
    - ``meta``: Contains metadata of type `fd_stake_meta_t`.
    - ``active_stake``: Stores the active stake amount as an unsigned long integer.
    - ``stake_flags``: Holds flags related to stake status of type `fd_stake_flags_t`.
- **Description**: Represents an inactive merge kind in a stake program, encapsulating metadata, active stake amount, and stake flags to manage inactive stake states.


---
### merge\_kind\_inactive\_t
- **Type**: ``struct``
- **Members**:
    - ``meta``: Contains metadata related to the stake.
    - ``active_stake``: Represents the amount of active stake.
    - ``stake_flags``: Holds flags that indicate the state of the stake.
- **Description**: Defines a structure for managing inactive stake in a staking program. It includes metadata, the amount of active stake, and flags that describe the stake's state. This structure is part of a larger system for handling different kinds of stake states, such as inactive, activation epoch, and fully active states.


---
### merge\_kind\_activation\_epoch
- **Type**: ``struct``
- **Members**:
    - ``meta``: Contains metadata related to the stake.
    - ``stake``: Represents the stake amount and related information.
    - ``stake_flags``: Holds flags that indicate the status or properties of the stake.
- **Description**: Defines a structure that encapsulates metadata, stake information, and flags for a stake in the context of an activation epoch. This structure is used to manage and track the state of a stake during its activation phase, providing necessary details for processing and decision-making in stake management operations.


---
### merge\_kind\_activation\_epoch\_t
- **Type**: ``struct``
- **Members**:
    - ``meta``: Contains metadata related to the stake.
    - ``stake``: Represents the stake associated with the activation epoch.
    - ``stake_flags``: Holds flags related to the stake's status.
- **Description**: Defines a structure for managing stake information during an activation epoch, including metadata, the stake itself, and any associated flags.


---
### merge\_kind\_fully\_active
- **Type**: ``struct``
- **Members**:
    - ``meta``: Contains metadata related to the stake.
    - ``stake``: Holds the stake information.
- **Description**: Represents a fully active merge kind in a staking program, encapsulating metadata and stake details for a fully active state.


---
### merge\_kind\_fully\_active\_t
- **Type**: ``struct``
- **Members**:
    - ``meta``: Contains metadata related to the stake.
    - ``stake``: Represents the stake associated with the fully active merge kind.
- **Description**: The `merge_kind_fully_active_t` structure is part of a union that represents different states of a stake in a staking program. This specific structure is used when the stake is fully active, meaning it is neither activating nor deactivating. It contains metadata about the stake and the stake itself, which is used in operations related to merging stakes in a staking program.


---
### merge\_kind\_inner
- **Type**: ``union``
- **Members**:
    - `inactive`: Holds a `merge_kind_inactive_t` structure representing an inactive merge kind.
    - `activation_epoch`: Holds a `merge_kind_activation_epoch_t` structure representing a merge kind with an activation epoch.
    - `fully_active`: Holds a `merge_kind_fully_active_t` structure representing a fully active merge kind.
- **Description**: The `merge_kind_inner` union is a data structure that can store one of three different types of merge kinds: inactive, activation epoch, or fully active. Each member of the union corresponds to a specific state of a merge operation, allowing the program to handle different scenarios of stake merging in a flexible manner. The union provides a way to manage these different states using a single variable, optimizing memory usage by sharing the same memory location for all possible states.


---
### merge\_kind\_inner\_t
- **Type**: ``union``
- **Members**:
    - `inactive`: Contains a `merge_kind_inactive_t` structure.
    - `activation_epoch`: Contains a `merge_kind_activation_epoch_t` structure.
    - `fully_active`: Contains a `merge_kind_fully_active_t` structure.
- **Description**: The `merge_kind_inner_t` union can store one of three different types of merge kind structures: `merge_kind_inactive_t`, `merge_kind_activation_epoch_t`, or `merge_kind_fully_active_t`. Each of these structures represents a different state of a stake in a staking program, with `inactive` representing a stake that is not currently active, `activation_epoch` representing a stake that is in the process of being activated, and `fully_active` representing a stake that is fully active. This union allows for efficient storage and manipulation of these different stake states within the same memory space.


---
### merge\_kind
- **Type**: ``struct``
- **Members**:
    - ``discriminant``: An unsigned integer that indicates the type of `merge_kind_inner` being used.
    - ``inner``: A union of type `merge_kind_inner_t` that holds the specific data structure variant.
- **Description**: Defines a structure that represents a kind of merge operation, with a `discriminant` to specify the type of merge and an `inner` union to hold the specific data for that merge type. The `merge_kind` structure is used to manage different states of a stake, such as inactive, activation epoch, or fully active, by utilizing the `merge_kind_inner` union to store the relevant data for each state.


---
### merge\_kind\_t
- **Type**: ``struct``
- **Members**:
    - ``discriminant``: An unsigned integer that indicates the type of merge kind.
    - ``inner``: A union `merge_kind_inner_t` that holds the specific merge kind data.
- **Description**: `merge_kind_t` is a structure that represents different types of merge states for a stake account in a staking program. It uses a `discriminant` to identify the specific type of merge state, which can be inactive, activation epoch, or fully active. The `inner` union holds the data specific to the identified merge state, allowing the program to handle different merge scenarios efficiently.


---
### effective\_activating
- **Type**: ``struct``
- **Members**:
    - `effective`: Stores the effective stake as an unsigned long integer.
    - `activating`: Stores the activating stake as an unsigned long integer.
- **Description**: Represents a data structure that holds two unsigned long integers, `effective` and `activating`, which are used to track the effective and activating stake values respectively. This structure is typically used in contexts where stake management and activation status need to be monitored or calculated.


---
### effective\_activating\_t
- **Type**: ``struct``
- **Members**:
    - `effective`: Stores the effective stake amount.
    - `activating`: Stores the activating stake amount.
- **Description**: The `effective_activating_t` structure holds two `ulong` values: `effective` and `activating`. These values represent the effective and activating stake amounts, respectively, in a staking system. This structure is used to track the current state of stake activation and effectiveness.


---
### validated\_delegated\_info
- **Type**: ``struct``
- **Members**:
    - ``stake_amount``: Holds the amount of stake as an unsigned long integer.
- **Description**: Represents information about a validated delegated stake, specifically storing the amount of stake in the `stake_amount` field. This data structure is used to manage and validate the amount of stake that has been delegated in a staking program.


---
### validated\_delegated\_info\_t
- **Type**: ``struct``
- **Members**:
    - `stake_amount`: Holds the amount of stake that has been validated and delegated.
- **Description**: Represents information about a validated and delegated stake amount. It contains a single member, `stake_amount`, which stores the amount of stake that has been validated and delegated. This structure is used to manage and track the stake amount in the context of a staking program.


---
### validated\_split\_info
- **Type**: ``struct``
- **Members**:
    - ``source_remaining_balance``: Represents the remaining balance of the source account after a split operation.
    - ``destination_rent_exempt_reserve``: Represents the rent-exempt reserve required for the destination account in a split operation.
- **Description**: Holds information about the balance and rent-exempt reserve when splitting funds between accounts. It is used to ensure that the source account retains enough balance and the destination account meets the rent-exempt requirement.


---
### validated\_split\_info\_t
- **Type**: ``struct``
- **Members**:
    - ``source_remaining_balance``: The remaining balance in the source account after a split.
    - ``destination_rent_exempt_reserve``: The rent-exempt reserve amount for the destination account.
- **Description**: Holds information about the balance and rent-exempt reserve when splitting a stake account. It is used to validate and manage the split operation, ensuring that the source account retains enough balance and the destination account meets rent-exemption requirements.


# Functions

---
### get\_state<!-- {{#callable:get_state}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L127>)

Decodes the state of a stake account from its binary representation.
- **Inputs**:
    - `self`: Pointer to a constant `fd_txn_account_t` structure representing the transaction account.
    - `out`: Pointer to a `fd_stake_state_v2_t` structure where the decoded state will be stored.
- **Logic and Control Flow**:
    - Initialize a `fd_bincode_decode_ctx_t` structure with data from the account.
    - Call `fd_stake_state_v2_decode_footprint` to check the validity of the data and get the total size.
    - If the decoding fails, return an error code.
    - Call `fd_stake_state_v2_decode` to decode the actual state into the `out` structure.
    - Return 0 to indicate success.
- **Output**: Returns 0 on success or an error code if the decoding fails.


---
### set\_state<!-- {{#callable:set_state}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L148>)

Sets the state of a borrowed account to a serialized representation of a stake state.
- **Inputs**:
    - `borrowed_acct`: Pointer to a `fd_borrowed_account_t` structure representing the account to be modified.
    - `state`: Pointer to a constant `fd_stake_state_v2_t` structure containing the new state to set.
- **Logic and Control Flow**:
    - Retrieve mutable data and length from the `borrowed_acct` using `fd_borrowed_account_get_data_mut`.
    - Check for errors in retrieving data; return error if any.
    - Calculate the serialized size of the `state` using `fd_stake_state_v2_size`.
    - Check if the serialized size exceeds the length of the mutable data; return an error if it does.
    - Prepare an encoding context for the data.
    - Encode the `state` into the data using `fd_stake_state_v2_encode`.
    - Log an error if the encoding fails.
- **Output**: Returns 0 on success or an error code if any operation fails.


---
### get\_minimum\_delegation<!-- {{#callable:get_minimum_delegation}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L179>)

Returns the minimum delegation amount based on the feature set.
- **Inputs**:
    - `txn_ctx`: Pointer to a constant `fd_exec_txn_ctx_t` structure that contains the feature set.
- **Logic and Control Flow**:
    - Checks if the feature `stake_raise_minimum_delegation_to_1_sol` is active for the bank in `txn_ctx`.
    - If the feature is active, returns `MINIMUM_DELEGATION_SOL` multiplied by `LAMPORTS_PER_SOL`.
    - If the feature is not active, returns 1.
- **Output**: Returns an unsigned long value representing the minimum delegation amount.


---
### warmup\_cooldown\_rate<!-- {{#callable:warmup_cooldown_rate}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L191>)

Calculates the warmup or cooldown rate based on the current epoch and a new rate activation epoch.
- **Inputs**:
    - `current_epoch`: The current epoch represented as an unsigned long integer.
    - `new_rate_activation_epoch`: A pointer to an unsigned long integer that indicates the epoch when the new rate becomes active.
- **Logic and Control Flow**:
    - Checks if `current_epoch` is less than `new_rate_activation_epoch` if it is not NULL.
    - If `new_rate_activation_epoch` is NULL, it uses `ULONG_MAX` as the comparison value.
    - Returns `DEFAULT_WARMUP_COOLDOWN_RATE` if the condition is true, otherwise returns `NEW_WARMUP_COOLDOWN_RATE`.
- **Output**: Returns a double value representing the warmup or cooldown rate.


---
### validate\_delegated\_amount<!-- {{#callable:validate_delegated_amount}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L209>)

Validates the delegated amount for a stake account.
- **Inputs**:
    - `account`: Pointer to a `fd_borrowed_account_t` structure representing the stake account.
    - `meta`: Pointer to a constant `fd_stake_meta_t` structure containing metadata about the stake.
    - `txn_ctx`: Pointer to a constant `fd_exec_txn_ctx_t` structure representing the transaction context.
    - `out`: Pointer to a `validated_delegated_info_t` structure to store the validated stake amount.
    - `custom_err`: Pointer to a `uint` variable to store a custom error code.
- **Logic and Control Flow**:
    - Calculates the `stake_amount` by subtracting the `rent_exempt_reserve` from the total lamports in the account.
    - Checks if the `stake_amount` is less than the minimum delegation amount obtained from [`get_minimum_delegation`](<#get_minimum_delegation>).
    - If the `stake_amount` is insufficient, sets the `custom_err` to `FD_STAKE_ERR_INSUFFICIENT_DELEGATION` and returns an error code.
    - If the validation is successful, assigns the `stake_amount` to the `out` structure and returns 0.
- **Output**: Returns 0 on successful validation or an error code if validation fails.
- **Functions Called**:
    - [`get_minimum_delegation`](<#get_minimum_delegation>)


---
### validate\_split\_amount<!-- {{#callable:validate_split_amount}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L232>)

Validates the amount to be split between two accounts in a staking context.
- **Inputs**:
    - `invoke_context`: A pointer to the execution context containing information about the current transaction.
    - `source_account_index`: The index of the source account from which lamports will be deducted.
    - `destination_account_index`: The index of the destination account to which lamports will be sent.
    - `lamports`: The amount of lamports to split from the source account.
    - `source_meta`: A pointer to metadata associated with the source account.
    - `additional_required_lamports`: Additional lamports required for the destination account to meet rent-exempt requirements.
    - `source_is_active`: An integer indicating whether the source account is active.
    - `out`: A pointer to a structure where the results of the validation will be stored.
- **Logic and Control Flow**:
    - Borrow the source account and retrieve its lamports.
    - Check if the requested `lamports` is zero or exceeds the available `source_lamports`.
    - Calculate the minimum balance required for the source account after the split.
    - Check if the remaining balance after the split meets the minimum balance requirement.
    - Borrow the destination account and retrieve its lamports and data length.
    - Check if the destination account meets the rent-exempt reserve requirements.
    - Store the results in the output structure.
- **Output**: Returns 0 on success or an error code indicating insufficient funds or other validation failures.


---
### lockup\_is\_in\_force<!-- {{#callable:lockup_is_in_force}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L318>)

Checks if a lockup period is currently in effect for a stake account.
- **Inputs**:
    - `self`: Pointer to a `fd_stake_lockup_t` structure representing the lockup details.
    - `clock`: Pointer to a `fd_sol_sysvar_clock_t` structure providing the current system clock information.
    - `custodian`: Pointer to a `fd_pubkey_t` structure representing the public key of the custodian.
- **Logic and Control Flow**:
    - Checks if the `custodian` is not NULL and if it matches the custodian in `self`.
    - If the custodian matches, returns 0 indicating no lockup is in force.
    - Compares the `unix_timestamp` and `epoch` from `self` with those from `clock`.
    - Returns 1 if the lockup is in effect, otherwise returns 0.
- **Output**: Returns 0 if no lockup is in force, 1 if a lockup is in effect based on the timestamps and epochs.


---
### authorized\_check<!-- {{#callable:authorized_check}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L334>)

Checks if the provided signers are authorized based on the stake authorization type.
- **Inputs**:
    - `self`: Pointer to a constant `fd_stake_authorized_t` structure that contains the authorized staker and withdrawer public keys.
    - `signers`: Array of pointers to `fd_pubkey_t` representing the public keys of the signers for the transaction.
    - `stake_authorize`: A `fd_stake_authorize_t` structure that indicates whether the check is for the staker or withdrawer.
- **Logic and Control Flow**:
    - The function uses a switch statement to determine the type of authorization being checked based on the `stake_authorize.discriminant` value.
    - If the type is `fd_stake_authorize_enum_staker`, it checks if the `self->staker` public key is present in the `signers` array.
    - If the type is `fd_stake_authorize_enum_withdrawer`, it checks if the `self->withdrawer` public key is present in the `signers` array.
    - If the public key is found, the function returns 0, indicating success.
    - If the public key is not found, it returns an error code indicating a missing required signature.
    - If the discriminant does not match any known types, it returns an error code for a missing required signature.
- **Output**: Returns 0 if the authorization check passes, or an error code if it fails.


---
### authorized\_authorize<!-- {{#callable:authorized_authorize}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L359>)

Processes authorization of a new staker or withdrawer in a staking context.
- **Inputs**:
    - `self`: Pointer to a `fd_stake_authorized_t` structure representing the current authorization state.
    - `signers`: Array of pointers to `fd_pubkey_t` representing the public keys of the signers for the transaction.
    - `new_authorized`: Pointer to a `fd_pubkey_t` representing the new authorized public key.
    - `stake_authorize`: Pointer to a `fd_stake_authorize_t` structure indicating whether the new authorization is for a staker or withdrawer.
    - `lockup_custodian_args`: Pointer to a `fd_stake_lockup_custodian_args_t` structure containing lockup information.
    - `custom_err`: Pointer to a `uint` where custom error codes can be stored.
- **Logic and Control Flow**:
    - Checks the `discriminant` of `stake_authorize` to determine if the authorization is for a staker or withdrawer.
    - For a staker, it verifies that at least one of the signers is the current staker or withdrawer.
    - If the authorization is for a withdrawer, it checks if lockup conditions are in force and validates the presence of a custodian.
    - If lockup is in force, it checks for the custodian's signature and ensures that the lockup is not active.
    - Calls [`authorized_check`](<#authorized_check>) to validate the authorization against the signers.
    - Updates the `staker` or `withdrawer` field in `self` with the `new_authorized` value.
- **Output**: Returns 0 on success or an error code indicating the type of failure.
- **Functions Called**:
    - [`lockup_is_in_force`](<#lockup_is_in_force>)
    - [`authorized_check`](<#authorized_check>)


---
### set\_lockup\_meta<!-- {{#callable:set_lockup_meta}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L415>)

Sets the lockup metadata for a stake account.
- **Inputs**:
    - `self`: Pointer to the `fd_stake_meta_t` structure that holds the stake metadata.
    - `lockup`: Pointer to the `fd_lockup_args_t` structure containing new lockup parameters.
    - `signers`: Array of pointers to public keys of signers required for authorization.
    - `clock`: Pointer to the `fd_sol_sysvar_clock_t` structure providing the current clock information.
- **Logic and Control Flow**:
    - Check if the lockup is currently in force using [`lockup_is_in_force`](<#lockup_is_in_force>) function.
    - If the lockup is in force, verify that the `signers` array contains the lockup custodian's signature.
    - If the lockup is not in force, verify that the `signers` array contains the withdrawer's signature.
    - Update the `self->lockup` fields with values from the `lockup` structure if they are provided.
- **Output**: Returns 0 on success or an error code indicating the type of failure.
- **Functions Called**:
    - [`lockup_is_in_force`](<#lockup_is_in_force>)


---
### fd\_stake\_history\_ele\_binary\_search\_const<!-- {{#callable:fd_stake_history_ele_binary_search_const}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L442>)

Performs a binary search on the `fd_stake_history` array to find a stake history entry for a given epoch.
- **Inputs**:
    - `history`: A pointer to a constant `fd_stake_history_t` structure that contains the stake history data.
    - `epoch`: An unsigned long integer representing the epoch to search for in the stake history.
- **Logic and Control Flow**:
    - Initializes `start` to 0 and `end` to the length of the stake history minus one.
    - Enters a while loop that continues as long as `start` is less than or equal to `end`.
    - Calculates the midpoint `mid` of the current search range.
    - Checks if the epoch at `mid` matches the input epoch; if it does, returns a pointer to the corresponding entry.
    - If the epoch at `mid` is less than the input epoch, adjusts `end` to `mid - 1`.
    - If the epoch at `mid` is greater than the input epoch, adjusts `start` to `mid + 1`.
    - If no match is found, returns `NULL`.
- **Output**: Returns a pointer to the `fd_stake_history_entry_t` corresponding to the input epoch, or `NULL` if not found.


---
### fd\_stake\_history\_ele\_query\_const<!-- {{#callable:fd_stake_history_ele_query_const}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L462>)

Queries the stake history for a specific epoch.
- **Inputs**:
    - `history`: A pointer to a constant `fd_stake_history_t` structure that contains the stake history data.
    - `epoch`: An unsigned long integer representing the epoch to query.
- **Logic and Control Flow**:
    - Check if the length of the stake history is zero; if so, return NULL.
    - Check if the requested epoch is greater than the most recent epoch in the history; if so, return NULL.
    - Calculate the offset from the most recent epoch to the requested epoch.
    - If the offset is greater than or equal to the length of the stake history, perform a binary search for the epoch.
    - Calculate the index for the epoch entry in the history.
    - If the epoch at the calculated index matches the requested epoch, return the corresponding entry.
    - If the epoch does not match, perform a binary search for the epoch.
- **Output**: Returns a pointer to a constant `fd_stake_history_entry_t` structure corresponding to the requested epoch, or NULL if not found.
- **Functions Called**:
    - [`fd_stake_history_ele_binary_search_const`](<#fd_stake_history_ele_binary_search_const>)


---
### stake\_and\_activating<!-- {{#callable:stake_and_activating}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L489>)

Calculates effective and activating stake based on the target epoch and stake history.
- **Inputs**:
    - `self`: Pointer to a `fd_delegation_t` structure representing the current stake delegation.
    - `target_epoch`: The epoch for which the effective and activating stake is calculated.
    - `history`: Pointer to a `fd_stake_history_t` structure containing historical stake data.
    - `new_rate_activation_epoch`: Pointer to a variable that will store the new rate activation epoch.
- **Logic and Control Flow**:
    - Retrieve the delegated stake from `self->stake`.
    - Check if `self->activation_epoch` is `ULONG_MAX`, return the delegated stake as effective and zero activating.
    - Check if `self->activation_epoch` equals `self->deactivation_epoch`, return zero for both effective and activating.
    - If `target_epoch` equals `self->activation_epoch`, return zero effective and the delegated stake as activating.
    - If `target_epoch` is less than `self->activation_epoch`, return zero for both effective and activating.
    - If `history` is not null, query the stake history for the cluster stake at the activation epoch.
    - Iterate through epochs starting from the activation epoch until the target epoch or deactivation epoch is reached.
    - Calculate the weight of the remaining activating stake and the warmup/cooldown rate.
    - Update the current effective stake based on the calculated values.
    - Return the final effective and activating stake.
- **Output**: Returns an `effective_activating_t` structure containing the calculated effective and activating stake.
- **Functions Called**:
    - [`fd_stake_history_ele_query_const`](<#fd_stake_history_ele_query_const>)
    - [`warmup_cooldown_rate`](<#warmup_cooldown_rate>)


---
### stake\_activating\_and\_deactivating<!-- {{#callable:stake_activating_and_deactivating}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L567>)

Processes stake activation and deactivation based on the target epoch and stake history.
- **Inputs**:
    - `self`: Pointer to a `fd_delegation_t` structure representing the current stake delegation.
    - `target_epoch`: An unsigned long integer representing the epoch at which the stake activation or deactivation is targeted.
    - `stake_history`: Pointer to a `fd_stake_history_t` structure containing historical stake data.
    - `new_rate_activation_epoch`: Pointer to an unsigned long integer that will be updated with the new rate activation epoch.
- **Logic and Control Flow**:
    - Calls [`stake_and_activating`](<#stake_and_activating>) to determine effective and activating stakes.
    - Checks if the target epoch is less than the deactivation epoch.
    - Handles bootstrap case where activating stake is zero.
    - Handles case where target epoch equals the deactivation epoch.
    - If the target epoch is greater than the deactivation epoch, it queries the stake history for the cluster stake at the deactivation epoch.
    - Iterates through epochs to calculate the current effective stake until the target epoch is reached or the effective stake becomes zero.
    - Returns the appropriate `fd_stake_history_entry_t` structure based on the calculated stakes.
- **Output**: Returns a `fd_stake_history_entry_t` structure containing the effective, activating, and deactivating stakes.
- **Functions Called**:
    - [`stake_and_activating`](<#stake_and_activating>)
    - [`fd_stake_history_ele_query_const`](<#fd_stake_history_ele_query_const>)
    - [`warmup_cooldown_rate`](<#warmup_cooldown_rate>)


---
### delegation\_stake<!-- {{#callable:delegation_stake}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L644>)

Returns the effective stake for a given delegation at a specified epoch.
- **Inputs**:
    - `self`: Pointer to a `fd_delegation_t` structure representing the delegation.
    - `epoch`: An unsigned long integer representing the target epoch.
    - `history`: Pointer to a `fd_stake_history_t` structure containing the stake history.
    - `new_rate_activation_epoch`: Pointer to an unsigned long integer to store the new rate activation epoch.
- **Logic and Control Flow**:
    - Calls the [`stake_activating_and_deactivating`](<#stake_activating_and_deactivating>) function with the provided parameters.
    - Returns the effective stake from the result of the [`stake_activating_and_deactivating`](<#stake_activating_and_deactivating>) function.
- **Output**: Returns an unsigned long integer representing the effective stake.
- **Functions Called**:
    - [`stake_activating_and_deactivating`](<#stake_activating_and_deactivating>)


---
### acceptable\_reference\_epoch\_credits<!-- {{#callable:acceptable_reference_epoch_credits}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L658>)

Determines if the reference epoch credits are acceptable for a given epoch.
- **Inputs**:
    - `epoch_credits`: Pointer to a `fd_vote_epoch_credits_t` structure containing the epoch credits.
    - `current_epoch`: The current epoch represented as an unsigned long integer.
- **Logic and Control Flow**:
    - Calculate the length of the `epoch_credits` using `deq_fd_vote_epoch_credits_t_cnt`.
    - Check if the length minus `MINIMUM_DELINQUENT_EPOCHS_FOR_DEACTIVATION` does not cause an underflow.
    - If the check passes, iterate from the last index of `epoch_credits` down to the calculated index.
    - For each index, compare the `vote_epoch` with the `current_epoch`.
    - If any `vote_epoch` does not match `current_epoch`, return 0.
    - If all epochs match, return 1.
- **Output**: Returns 1 if the reference epoch credits are acceptable, otherwise returns 0.


---
### eligible\_for\_deactivate\_delinquent<!-- {{#callable:eligible_for_deactivate_delinquent}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L679>)

Determines if a `fd_vote_epoch_credits_t` structure is eligible for deactivation based on the current epoch.
- **Inputs**:
    - `epoch_credits`: Pointer to a `fd_vote_epoch_credits_t` structure containing voting credits for epochs.
    - `current_epoch`: Current epoch number as an unsigned long integer.
- **Logic and Control Flow**:
    - Checks if the `epoch_credits` structure is empty using `deq_fd_vote_epoch_credits_t_empty`.
    - If empty, returns 1 indicating eligibility for deactivation.
    - Retrieves the last entry in `epoch_credits` using `deq_fd_vote_epoch_credits_t_peek_tail`.
    - If the last entry is NULL, returns 1 indicating eligibility for deactivation.
    - Calculates the minimum epoch for deactivation by subtracting `MINIMUM_DELINQUENT_EPOCHS_FOR_DEACTIVATION` from `current_epoch`.
    - If the subtraction is successful, checks if the last epoch is less than or equal to the minimum epoch.
    - Returns 1 if eligible for deactivation, otherwise returns 0.
- **Output**: Returns 1 if eligible for deactivation, otherwise returns 0.


---
### stake\_split<!-- {{#callable:stake_split}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L716>)

Splits the stake by adjusting the remaining stake and creating a new stake with a specified amount.
- **Inputs**:
    - `self`: Pointer to the `fd_stake_t` structure representing the current stake.
    - `remaining_stake_delta`: Amount to be deducted from the current stake.
    - `split_stake_amount`: Amount to be assigned to the new stake.
    - `custom_err`: Pointer to a variable to store custom error codes.
    - `out`: Pointer to an `fd_stake_t` structure to store the new stake created.
- **Logic and Control Flow**:
    - Check if `remaining_stake_delta` exceeds the current stake; if so, set an error code and return an error.
    - Deduct `remaining_stake_delta` from the current stake.
    - Create a new `fd_stake_t` structure and copy the current stake's data.
    - Set the new stake's amount to `split_stake_amount`.
    - Assign the new stake to the output pointer.
- **Output**: Returns 0 on success, or an error code if the operation fails.


---
### stake\_deactivate<!-- {{#callable:stake_deactivate}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L735>)

Deactivates a stake by setting its `deactivation_epoch` to the specified epoch.
- **Inputs**:
    - `stake`: Pointer to a `fd_stake_t` structure representing the stake to deactivate.
    - `epoch`: The epoch at which the stake should be deactivated.
    - `custom_err`: Pointer to a `uint` where a custom error code can be stored if an error occurs.
- **Logic and Control Flow**:
    - Checks if the `deactivation_epoch` of the stake is not equal to `ULONG_MAX`.
    - If it is not, sets the `custom_err` to `FD_STAKE_ERR_ALREADY_DEACTIVATED` and returns an error code.
    - If it is equal to `ULONG_MAX`, sets the `deactivation_epoch` to the provided `epoch` and returns 0.
- **Output**: Returns 0 on success or an error code if the stake is already deactivated.


---
### stake\_state\_v2\_size\_of<!-- {{#callable:stake_state_v2_size_of}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L776>)

Returns the size of the stake state version 2.
- **Inputs**: None
- **Logic and Control Flow**:
    - The function directly returns a constant value of 200.
- **Output**: Returns a constant value of 200, representing the size of the stake state version 2.


---
### active\_stake<!-- {{#callable:active_stake}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L799>)

Returns the active stake based on the `merge_kind_t` discriminant.
- **Inputs**:
    - `self`: A pointer to a constant `merge_kind_t` structure that indicates the type of merge kind.
- **Logic and Control Flow**:
    - Checks the `discriminant` field of the `merge_kind_t` structure.
    - If the `discriminant` is `merge_kind_inactive`, returns `NULL`.
    - If the `discriminant` is `merge_kind_activation_epoch`, returns a pointer to the `stake` in the `activation_epoch` inner structure.
    - If the `discriminant` is `merge_kind_fully_active`, returns a pointer to the `stake` in the `fully_active` inner structure.
    - If the `discriminant` is invalid, logs an error message.
- **Output**: Returns a pointer to the active `fd_stake_t` structure or `NULL` if inactive.


---
### get\_if\_mergeable<!-- {{#callable:get_if_mergeable}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L814>)

Determines if a stake account can be merged based on its state and conditions.
- **Inputs**:
    - `invoke_context`: Pointer to the execution instruction context, used for logging and accessing system variables.
    - `stake_state`: Pointer to the current state of the stake account, which contains metadata and stake information.
    - `stake_lamports`: The amount of lamports associated with the stake account.
    - `clock`: Pointer to the system clock variable, providing the current epoch information.
    - `stake_history`: Pointer to the history of stake changes, used to determine activation and deactivation status.
    - `out`: Pointer to a `merge_kind_t` structure where the result of the mergeability check will be stored.
    - `custom_err`: Pointer to a variable for storing custom error codes.
- **Logic and Control Flow**:
    - Checks the discriminant of the `stake_state` to determine its type (stake or initialized).
    - If the state is a stake, it retrieves metadata, stake, and stake flags.
    - Reads the epoch schedule from the system variable cache.
    - Calculates the new rate activation epoch based on the current transaction context.
    - Determines the activation and deactivation status of the stake using the [`stake_activating_and_deactivating`](<#stake_activating_and_deactivating>) function.
    - Based on the status, sets the output `merge_kind_t` to indicate if the stake is inactive, in an activation epoch, or fully active.
    - If the stake has transient status, logs an error and sets a custom error code.
    - If the state is initialized, sets the output to inactive with the current metadata and active stake.
- **Output**: Returns 0 on success, or an error code indicating the type of failure.
- **Functions Called**:
    - [`fd_new_warmup_cooldown_rate_epoch`](<#fd_new_warmup_cooldown_rate_epoch>)
    - [`stake_activating_and_deactivating`](<#stake_activating_and_deactivating>)


---
### metas\_can\_merge<!-- {{#callable:metas_can_merge}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L894>)

Determines if two stake metadata can be merged.
- **Inputs**:
    - `invoke_context`: Pointer to the execution context for logging.
    - `stake`: Pointer to the first stake metadata.
    - `source`: Pointer to the second stake metadata.
    - `clock`: Pointer to the system clock for time-related checks.
    - `custom_err`: Pointer to a variable for storing custom error codes.
- **Logic and Control Flow**:
    - Checks if the lockup conditions of both stake metadata are the same or if both are not in force.
    - Compares the authorized fields of both stake metadata.
    - If both checks pass, returns 0 indicating success.
    - If checks fail, logs an error message and sets a custom error code.
- **Output**: Returns 0 if the metadata can be merged, otherwise returns an error code.
- **Functions Called**:
    - [`lockup_is_in_force`](<#lockup_is_in_force>)


---
### active\_delegations\_can\_merge<!-- {{#callable:active_delegations_can_merge}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L917>)

Determines if two active delegations can be merged based on voter public key and deactivation epoch.
- **Inputs**:
    - `invoke_context`: Pointer to the execution context for logging and state management.
    - `stake`: Pointer to the first `fd_delegation_t` structure representing the first delegation.
    - `source`: Pointer to the second `fd_delegation_t` structure representing the second delegation.
    - `custom_err`: Pointer to a variable for storing custom error codes.
- **Logic and Control Flow**:
    - Compares the `voter_pubkey` of both delegations using `memcmp`.
    - If the keys do not match, logs an error message and sets `custom_err` to `FD_STAKE_ERR_MERGE_MISMATCH`.
    - If both delegations have `deactivation_epoch` set to `ULONG_MAX`, returns 0 indicating they can merge.
    - If the deactivation epochs are not both `ULONG_MAX`, logs an error message and sets `custom_err` to `FD_STAKE_ERR_MERGE_MISMATCH`.
- **Output**: Returns 0 if the delegations can merge, or an error code if they cannot.


---
### stake\_weighted\_credits\_observed<!-- {{#callable:stake_weighted_credits_observed}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L937>)

Calculates stake-weighted credits observed based on the stake and absorbed values.
- **Inputs**:
    - `stake`: Pointer to a `fd_stake_t` structure containing stake information.
    - `absorbed_lamports`: The amount of lamports absorbed.
    - `absorbed_credits_observed`: The number of credits observed that have been absorbed.
    - `out`: Pointer to a variable where the result will be stored.
- **Logic and Control Flow**:
    - Checks if `stake->credits_observed` equals `absorbed_credits_observed`.
    - If they are equal, assigns `stake->credits_observed` to `*out` and returns 1.
    - Calculates `total_stake` by adding `stake->delegation.stake` and `absorbed_lamports`.
    - If the addition overflows, returns 0.
    - Calculates `stake_weighted_credits` by multiplying `stake->credits_observed` and `stake->delegation.stake`.
    - Calculates `absorbed_weighted_credits` by multiplying `absorbed_credits_observed` and `absorbed_lamports`.
    - Adds `stake_weighted_credits` and `absorbed_weighted_credits` to get `total_weighted_credits_partial_one`.
    - Adds `total_weighted_credits_partial_one` and `total_stake` to get `total_weighted_credits_partial_two`.
    - Decrements `total_weighted_credits_partial_two` by 1 to get `total_weighted_credits`.
    - Divides `total_weighted_credits` by `total_stake` to get the final result.
- **Output**: Returns 1 on success and stores the result in `*out`, or returns 0 on failure.


---
### merge\_delegation\_stake\_and\_credits\_observed<!-- {{#callable:merge_delegation_stake_and_credits_observed}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L1020>)

Merges the delegation stake and credits observed into a stake structure.
- **Inputs**:
    - `invoke_context`: A constant pointer to the execution instruction context.
    - `stake`: A pointer to the `fd_stake_t` structure that holds the stake information.
    - `absorbed_lamports`: An unsigned long representing the amount of lamports to be absorbed.
    - `absorbed_credits_observed`: An unsigned long representing the amount of credits observed to be absorbed.
- **Logic and Control Flow**:
    - Calls [`stake_weighted_credits_observed`](<#stake_weighted_credits_observed>) to calculate the weighted credits observed based on the stake and absorbed values.
    - If the calculation fails, it returns an arithmetic overflow error.
    - Uses `fd_ulong_checked_add` to add the absorbed lamports to the stake's delegation stake.
    - If the addition fails, it returns the error code from the addition operation.
    - Returns 0 on success.
- **Output**: Returns 0 on success, or an error code indicating the type of failure.
- **Functions Called**:
    - [`stake_weighted_credits_observed`](<#stake_weighted_credits_observed>)


---
### merge\_kind\_merge<!-- {{#callable:merge_kind_merge}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L1035>)

Merges two `merge_kind_t` structures and updates the output state based on their types.
- **Inputs**:
    - `self`: The first `merge_kind_t` structure to merge.
    - `invoke_context`: A pointer to the execution context, which is not constant to allow logging.
    - `source`: The second `merge_kind_t` structure to merge.
    - `clock`: A pointer to a constant `fd_sol_sysvar_clock_t` structure representing the current clock.
    - `out`: A pointer to an `fd_stake_state_v2_t` structure where the merged state will be stored.
    - `is_some`: A pointer to an integer that indicates if the merge resulted in a valid state.
    - `custom_err`: A pointer to a custom error code that may be set during the merge process.
- **Logic and Control Flow**:
    - Check if the metadata of the two `merge_kind_t` structures can be merged using [`metas_can_merge`](<#metas_can_merge>).
    - If the metadata cannot be merged, return the error code.
    - Retrieve the active stakes from both `self` and `source` using [`active_stake`](<#active_stake>).
    - If both stakes are present, check if their delegations can be merged using [`active_delegations_can_merge`](<#active_delegations_can_merge>).
    - If the delegations cannot be merged, return the error code.
    - Initialize a temporary merged state structure.
    - Determine the type of merge based on the discriminants of `self` and `source`.
    - Handle each case of merging based on the types of `self` and `source`.
    - If the merged state is NULL, set `is_some` to 0 and return 0.
    - If the merge is successful, set `is_some` to 1 and copy the merged state to `out`.
- **Output**: Returns 0 on success, or an error code if the merge fails.
- **Functions Called**:
    - [`metas_can_merge`](<#metas_can_merge>)
    - [`meta`](<#meta>)
    - [`active_stake`](<#active_stake>)
    - [`active_delegations_can_merge`](<#active_delegations_can_merge>)
    - [`merge_delegation_stake_and_credits_observed`](<#merge_delegation_stake_and_credits_observed>)


---
### get\_stake\_status<!-- {{#callable:get_stake_status}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L1139>)

Retrieves the activation status of a stake account.
- **Inputs**:
    - `invoke_context`: Pointer to the execution context containing system variables.
    - `stake`: Pointer to the stake structure representing the stake account.
    - `clock`: Pointer to the system clock variable providing the current epoch.
    - `out`: Pointer to store the resulting stake activation status.
- **Logic and Control Flow**:
    - Checks if the stake history in the system variable cache is valid.
    - Reads the epoch schedule from the system variable cache.
    - Determines the new rate activation epoch based on the current transaction context.
    - Joins the stake history from the system variable cache.
    - Calculates the activation status of the stake based on the current epoch and stake history.
    - Stores the activation status in the output parameter.
- **Output**: Returns 0 on success or an error code if any checks fail.
- **Functions Called**:
    - [`fd_new_warmup_cooldown_rate_epoch`](<#fd_new_warmup_cooldown_rate_epoch>)
    - [`stake_activating_and_deactivating`](<#stake_activating_and_deactivating>)


---
### get\_credits<!-- {{#callable:get_credits}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L1174>)

Returns the number of credits from the last epoch in the `vote_state`.
- **Inputs**:
    - `vote_state`: A pointer to a constant `fd_vote_state_t` structure that contains the voting state information.
- **Logic and Control Flow**:
    - Checks if the `epoch_credits` queue in `vote_state` is empty using `deq_fd_vote_epoch_credits_t_empty`.
    - If empty, returns 0.
    - If not empty, retrieves the last element in the `epoch_credits` queue using `deq_fd_vote_epoch_credits_t_peek_index`.
    - Returns the `credits` value from the last element.
- **Output**: Returns an unsigned long integer representing the number of credits from the last epoch.


---
### redelegate\_stake<!-- {{#callable:redelegate_stake}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L1186>)

Processes the redelegation of stake to a new voter account.
- **Inputs**:
    - `ctx`: A pointer to the execution context containing transaction details.
    - `stake`: A pointer to the `fd_stake_t` structure representing the stake account.
    - `stake_lamports`: The amount of lamports to be staked.
    - `voter_pubkey`: A pointer to the public key of the new voter account.
    - `vote_state`: A pointer to the `fd_vote_state_t` structure containing vote state information.
    - `clock`: A pointer to the `fd_sol_sysvar_clock_t` structure providing the current clock information.
    - `stake_history`: A pointer to the `fd_stake_history_t` structure containing historical stake data.
    - `custom_err`: A pointer to a variable for storing custom error codes.
- **Logic and Control Flow**:
    - Reads the epoch schedule from the system variable cache.
    - Determines if a new warmup cooldown rate epoch is needed.
    - Checks if the current delegation stake is valid for redelegation.
    - If the current voter public key matches the new voter public key and the epoch is the same as the deactivation epoch, it resets the deactivation epoch.
    - Updates the stake delegation details with the new values.
    - Records the observed credits from the vote state.
- **Output**: Returns 0 on success or an error code indicating the failure reason.
- **Functions Called**:
    - [`fd_new_warmup_cooldown_rate_epoch`](<#fd_new_warmup_cooldown_rate_epoch>)
    - [`delegation_stake`](<#delegation_stake>)
    - [`get_credits`](<#get_credits>)


---
### new\_stake<!-- {{#callable:new_stake}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L1232>)

Creates a new stake structure with specified parameters.
- **Inputs**:
    - `stake`: The amount of stake to be assigned.
    - `voter_pubkey`: A pointer to the public key of the voter.
    - `vote_state`: A pointer to the current vote state.
    - `activation_epoch`: The epoch in which the stake will be activated.
- **Logic and Control Flow**:
    - Returns a new `fd_stake_t` structure initialized with the provided `stake`, `voter_pubkey`, and `activation_epoch`.
    - Sets the `deactivation_epoch` to `ULONG_MAX` and the `warmup_cooldown_rate` to `DEFAULT_WARMUP_COOLDOWN_RATE`.
    - Calls [`get_credits`](<#get_credits>) to retrieve the credits observed from the `vote_state`.
- **Output**: Returns a new `fd_stake_t` structure containing the initialized delegation and credits observed.
- **Functions Called**:
    - [`get_credits`](<#get_credits>)


---
### initialize<!-- {{#callable:initialize}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L1249>)

Initializes a stake account with specified parameters.
- **Inputs**:
    - `stake_account`: A pointer to a `fd_borrowed_account_t` structure representing the stake account to be initialized.
    - `authorized`: A pointer to a `fd_stake_authorized_t` structure containing the authorized staker and withdrawer.
    - `lockup`: A pointer to a `fd_stake_lockup_t` structure defining the lockup parameters for the stake account.
    - `rent`: A pointer to a `fd_rent_t` structure that provides rent-related information.
- **Logic and Control Flow**:
    - Checks if the data length of the `stake_account` matches the expected size.
    - Retrieves the current state of the stake account.
    - If the state is uninitialized, calculates the rent-exempt reserve.
    - Checks if the account has sufficient funds to cover the rent-exempt reserve.
    - If sufficient funds are available, initializes the stake account with the provided parameters.
    - If the account is already initialized or has insufficient funds, returns an error.
- **Output**: Returns 0 on success, or an error code indicating the type of failure.
- **Functions Called**:
    - [`stake_state_v2_size_of`](<#stake_state_v2_size_of>)
    - [`get_state`](<#get_state>)
    - [`set_state`](<#set_state>)


---
### authorize<!-- {{#callable:authorize}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L1293>)

Processes authorization of a stake account.
- **Inputs**:
    - `stake_account`: Pointer to the `fd_borrowed_account_t` structure representing the stake account.
    - `signers`: Array of pointers to `fd_pubkey_t` representing the signers for the transaction.
    - `new_authority`: Pointer to `fd_pubkey_t` representing the new authority for the stake account.
    - `stake_authorize`: Pointer to `fd_stake_authorize_t` indicating the type of authorization being requested.
    - `clock`: Pointer to `fd_sol_sysvar_clock_t` providing the current clock information.
    - `custodian`: Pointer to `fd_pubkey_t` representing the custodian for the lockup, if applicable.
    - `custom_err`: Pointer to a `uint` for returning custom error codes.
- **Logic and Control Flow**:
    - Calls [`get_state`](<#get_state>) to retrieve the current state of the stake account.
    - Checks the discriminant of the stake state to determine its type.
    - If the state is `fd_stake_state_v2_enum_stake`, it processes authorization for a stake account.
    - If the state is `fd_stake_state_v2_enum_initialized`, it processes authorization for an initialized stake account.
    - If the state is neither, it returns an error indicating invalid account data.
- **Output**: Returns an integer indicating success or an error code.
- **Functions Called**:
    - [`get_state`](<#get_state>)
    - [`authorized_authorize`](<#authorized_authorize>)
    - [`set_state`](<#set_state>)


---
### authorize\_with\_seed<!-- {{#callable:authorize_with_seed}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L1351>)

Authorizes a new authority for a stake account using a seed.
- **Inputs**:
    - `ctx`: A constant pointer to the execution instruction context.
    - `stake_account`: A pointer to the borrowed stake account.
    - `authority_base_index`: The index of the base account that is a signer.
    - `authority_seed`: A pointer to the seed used to generate the new authority's public key.
    - `authority_seed_len`: The length of the authority seed.
    - `authority_owner`: A pointer to the public key of the authority owner.
    - `new_authority`: A pointer to the public key of the new authority.
    - `stake_authorize`: A pointer to the stake authorization structure.
    - `clock`: A pointer to the system clock variable.
    - `custodian`: A pointer to the public key of the custodian.
- **Logic and Control Flow**:
    - Checks if the account at `authority_base_index` is a signer.
    - Retrieves the public key of the base account.
    - Generates a new public key using `fd_pubkey_create_with_seed`.
    - Sets the new public key as a signer.
    - Calls the [`authorize`](<#authorize>) function to authorize the new authority.
- **Output**: Returns an integer indicating success or an error code.
- **Functions Called**:
    - [`authorize`](<#authorize>)


---
### delegate<!-- {{#callable:delegate}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L1393>)

Processes the delegation of stake to a specified vote account.
- **Inputs**:
    - `ctx`: A pointer to the execution instruction context containing transaction details.
    - `stake_account_index`: The index of the stake account in the instruction accounts.
    - `vote_account_index`: The index of the vote account in the instruction accounts.
    - `clock`: A pointer to the system clock variable containing the current epoch.
    - `stake_history`: A pointer to the stake history variable for tracking stake changes.
    - `signers`: An array of public keys representing the signers of the transaction.
- **Logic and Control Flow**:
    - Borrow the vote account using `FD_TRY_BORROW_INSTR_ACCOUNT_DEFAULT_ERR_CHECK`.
    - Check if the owner of the vote account matches the expected program ID.
    - Retrieve the public key of the vote account.
    - Get the current state of the vote account using [`fd_vote_get_state`](<fd_vote_program.c.md#fd_vote_get_state>).
    - Drop the borrowed vote account.
    - Borrow the stake account and retrieve its state.
    - Check the state of the stake account and handle it based on its discriminant.
    - If the state is initialized, perform authorization checks and validate the delegated amount.
    - Create a new stake and set the new stake state.
    - If the state is already a stake, perform authorization checks and redelegate the stake.
- **Output**: Returns an integer indicating the success or failure of the operation.
- **Functions Called**:
    - [`fd_vote_get_state`](<fd_vote_program.c.md#fd_vote_get_state>)
    - [`get_state`](<#get_state>)
    - [`authorized_check`](<#authorized_check>)
    - [`validate_delegated_amount`](<#validate_delegated_amount>)
    - [`fd_vote_convert_to_current`](<fd_vote_program.c.md#fd_vote_convert_to_current>)
    - [`new_stake`](<#new_stake>)
    - [`set_state`](<#set_state>)
    - [`redelegate_stake`](<#redelegate_stake>)


---
### deactivate<!-- {{#callable:deactivate}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L1508>)

Deactivates a stake account if it is in a valid state.
- **Inputs**:
    - `stake_account`: Pointer to the `fd_borrowed_account_t` structure representing the stake account to deactivate.
    - `clock`: Pointer to the `fd_sol_sysvar_clock_t` structure providing the current clock information.
    - `signers`: Array of pointers to `fd_pubkey_t` representing the signers authorized to perform the deactivation.
    - `custom_err`: Pointer to a `uint` variable to store custom error codes.
- **Logic and Control Flow**:
    - Retrieve the state of the stake account using [`get_state`](<#get_state>).
    - Check if the state discriminant indicates a valid stake account.
    - Perform an authorization check using [`authorized_check`](<#authorized_check>) to ensure the signers are authorized.
    - Call [`stake_deactivate`](<#stake_deactivate>) to deactivate the stake.
    - Update the state of the stake account using [`set_state`](<#set_state>).
    - Return an error if the account is not in a valid state.
- **Output**: Returns 0 on success or an error code indicating the failure reason.
- **Functions Called**:
    - [`get_state`](<#get_state>)
    - [`authorized_check`](<#authorized_check>)
    - [`stake_deactivate`](<#stake_deactivate>)
    - [`set_state`](<#set_state>)


---
### set\_lockup<!-- {{#callable:set_lockup}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L1539>)

Sets the lockup parameters for a stake account.
- **Inputs**:
    - `stake_account`: A pointer to the `fd_borrowed_account_t` structure representing the stake account.
    - `lockup`: A pointer to the `fd_lockup_args_t` structure containing the lockup parameters.
    - `signers`: An array of pointers to `fd_pubkey_t` representing the signers for the transaction.
    - `clock`: A pointer to the `fd_sol_sysvar_clock_t` structure providing the current clock time.
- **Logic and Control Flow**:
    - Initializes a variable `state` of type `fd_stake_state_v2_t`.
    - Calls [`get_state`](<#get_state>) to retrieve the current state of the stake account.
    - Checks the `discriminant` of the state to determine its type.
    - If the state is `initialized`, it updates the lockup metadata using [`set_lockup_meta`](<#set_lockup_meta>).
    - If the state is `stake`, it also updates the lockup metadata using [`set_lockup_meta`](<#set_lockup_meta>).
    - If the state is neither, it returns an error indicating invalid account data.
    - Finally, it calls [`set_state`](<#set_state>) to save the updated state back to the stake account.
- **Output**: Returns 0 on success or an error code on failure.
- **Functions Called**:
    - [`get_state`](<#get_state>)
    - [`set_lockup_meta`](<#set_lockup_meta>)
    - [`set_state`](<#set_state>)


---
### split<!-- {{#callable:split}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L1573>)

Splits a stake account into two accounts with specified lamports.
- **Inputs**:
    - `ctx`: A constant pointer to the execution instruction context.
    - `stake_account_index`: An index for the stake account to be split.
    - `lamports`: The amount of lamports to split from the stake account.
    - `split_index`: An index for the new split account.
    - `signers`: An array of public keys for the signers of the transaction.
- **Logic and Control Flow**:
    - Borrow the split account using `FD_TRY_BORROW_INSTR_ACCOUNT_DEFAULT_ERR_CHECK`.
    - Check if the owner of the split account matches the expected program ID.
    - Verify the data length of the split account.
    - Retrieve the state of the split account and check if it is uninitialized.
    - Borrow the stake account and check if it has sufficient funds.
    - Retrieve the state of the stake account.
    - Check the discriminant of the stake account state to determine the type of stake.
    - Perform authorization checks for the signers.
    - Validate the split amount and ensure it meets minimum delegation requirements.
    - Calculate the remaining stake and the amount for the new split stake.
    - Perform the actual split operation and update the states of both accounts.
- **Output**: Returns 0 on success or an error code on failure.
- **Functions Called**:
    - [`stake_state_v2_size_of`](<#stake_state_v2_size_of>)
    - [`get_state`](<#get_state>)
    - [`authorized_check`](<#authorized_check>)
    - [`get_minimum_delegation`](<#get_minimum_delegation>)
    - [`get_stake_status`](<#get_stake_status>)
    - [`validate_split_amount`](<#validate_split_amount>)
    - [`stake_split`](<#stake_split>)
    - [`set_state`](<#set_state>)


---
### merge<!-- {{#callable:merge}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L1817>)

Merges two stake accounts into one.
- **Inputs**:
    - `ctx`: Pointer to the execution instruction context.
    - `stake_account_index`: Index of the destination stake account.
    - `source_account_index`: Index of the source stake account.
    - `clock`: Pointer to the system clock variable.
    - `stake_history`: Pointer to the stake history.
    - `signers`: Array of public keys of the signers.
- **Logic and Control Flow**:
    - Borrow the source account and check if it belongs to the correct program.
    - Get the indices of the stake and source accounts in the transaction.
    - Check if the stake account and source account are the same, returning an error if they are.
    - Borrow the stake account and retrieve its state.
    - Check if the destination stake account is mergeable.
    - Perform an authorization check on the destination stake account.
    - Borrow the source account and retrieve its state.
    - Check if the source stake account is mergeable.
    - Merge the two stake accounts if both are mergeable.
    - Set the new state for the destination stake account and mark the source account as uninitialized.
    - Transfer lamports from the source account to the destination account.
- **Output**: Returns 0 on success or an error code on failure.
- **Functions Called**:
    - [`get_state`](<#get_state>)
    - [`get_if_mergeable`](<#get_if_mergeable>)
    - [`authorized_check`](<#authorized_check>)
    - [`meta`](<#meta>)
    - [`merge_kind_merge`](<#merge_kind_merge>)
    - [`set_state`](<#set_state>)


---
### move\_stake\_or\_lamports\_shared\_checks<!-- {{#callable:move_stake_or_lamports_shared_checks}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L1925>)

Performs shared checks for moving stake or lamports between accounts.
- **Inputs**:
    - `invoke_context`: Pointer to the execution instruction context.
    - `source_account`: Pointer to the source account from which funds are moved.
    - `lamports`: Amount of lamports to move.
    - `destination_account`: Pointer to the destination account to which funds are moved.
    - `stake_authority_index`: Index of the stake authority in the instruction.
    - `source_merge_kind`: Pointer to store the merge kind of the source account.
    - `destination_merge_kind`: Pointer to store the merge kind of the destination account.
    - `custom_err`: Pointer to store custom error codes.
- **Logic and Control Flow**:
    - Check if the stake authority has signed the transaction.
    - Retrieve the public key of the stake authority.
    - Verify that both source and destination accounts are owned by the stake program.
    - Ensure that source and destination accounts are not the same.
    - Check if both accounts are writable.
    - Validate that the amount of lamports to move is greater than zero.
    - Read the current clock from the system variable cache.
    - Check if the stake history is available.
    - Get the state of the source account and check if it is mergeable.
    - Perform an authorized check on the source account.
    - Get the state of the destination account and check if it is mergeable.
    - Check if the metadata of both accounts can be merged.
- **Output**: Returns 0 on success or an error code on failure.
- **Functions Called**:
    - [`get_state`](<#get_state>)
    - [`get_if_mergeable`](<#get_if_mergeable>)
    - [`authorized_check`](<#authorized_check>)
    - [`meta`](<#meta>)
    - [`metas_can_merge`](<#metas_can_merge>)


---
### move\_stake<!-- {{#callable:move_stake}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L2014>)

Moves stake or lamports from one account to another.
- **Inputs**:
    - `ctx`: Pointer to the execution instruction context.
    - `source_account_index`: Index of the source account from which to move funds.
    - `lamports`: Amount of lamports to move.
    - `destination_account_index`: Index of the destination account to which funds will be moved.
    - `stake_authority_index`: Index of the stake authority account.
    - `custom_err`: Pointer to a variable for custom error codes.
- **Logic and Control Flow**:
    - Borrow the source account and check for errors.
    - Borrow the destination account and check for errors.
    - Perform shared checks for moving stake or lamports.
    - Check if the data length of both accounts is valid.
    - Verify that the source account is fully active.
    - Calculate the minimum delegation required.
    - Check if the source account has enough stake to move.
    - Calculate the final stake for the source account after moving the specified lamports.
    - Handle the case where the destination account is fully active or inactive.
    - Update the state of the source and destination accounts accordingly.
    - Adjust the lamport balances of both accounts.
- **Output**: Returns success or an error code indicating the result of the operation.
- **Functions Called**:
    - [`move_stake_or_lamports_shared_checks`](<#move_stake_or_lamports_shared_checks>)
    - [`stake_state_v2_size_of`](<#stake_state_v2_size_of>)
    - [`get_minimum_delegation`](<#get_minimum_delegation>)
    - [`merge_delegation_stake_and_credits_observed`](<#merge_delegation_stake_and_credits_observed>)
    - [`set_state`](<#set_state>)


---
### move\_lamports<!-- {{#callable:move_lamports}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L2171>)

Moves `lamports` from a source account to a destination account.
- **Inputs**:
    - `ctx`: Pointer to the execution instruction context, which holds the state of the transaction.
    - `source_account_index`: Index of the source account from which `lamports` will be deducted.
    - `lamports`: The amount of `lamports` to move from the source account.
    - `destination_account_index`: Index of the destination account to which `lamports` will be added.
    - `stake_authority_index`: Index of the account that has the authority to perform the transfer.
- **Logic and Control Flow**:
    - Borrow the source account using `FD_TRY_BORROW_INSTR_ACCOUNT_DEFAULT_ERR_CHECK`.
    - Borrow the destination account using `FD_TRY_BORROW_INSTR_ACCOUNT_DEFAULT_ERR_CHECK`.
    - Perform shared checks to validate the move operation using [`move_stake_or_lamports_shared_checks`](<#move_stake_or_lamports_shared_checks>).
    - Determine the available `lamports` in the source account based on its merge kind.
    - Check if the requested `lamports` to move exceeds the available amount.
    - Deduct the `lamports` from the source account using `fd_borrowed_account_checked_sub_lamports`.
    - Add the `lamports` to the destination account using `fd_borrowed_account_checked_add_lamports`.
- **Output**: Returns `FD_EXECUTOR_INSTR_SUCCESS` on successful transfer, or an error code on failure.
- **Functions Called**:
    - [`move_stake_or_lamports_shared_checks`](<#move_stake_or_lamports_shared_checks>)


---
### withdraw<!-- {{#callable:withdraw}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L2236>)

Processes a withdrawal from a stake account.
- **Inputs**:
    - `ctx`: Pointer to the execution context containing instruction details.
    - `stake_account_index`: Index of the stake account from which to withdraw.
    - `lamports`: Amount of lamports to withdraw.
    - `to_index`: Index of the account to which the lamports will be sent.
    - `clock`: Pointer to the system clock variable.
    - `stake_history`: Pointer to the stake history variable.
    - `withdraw_authority_index`: Index of the account authorized to withdraw.
    - `custodian_index`: Pointer to the index of the custodian account.
    - `new_rate_activation_epoch`: Pointer to store the new rate activation epoch.
- **Logic and Control Flow**:
    - Retrieve the public key of the withdraw authority using `fd_exec_instr_ctx_get_key_of_account_at_index`.
    - Check if the withdraw authority is a signer using `fd_instr_acc_is_signer_idx`.
    - Borrow the stake account using `FD_TRY_BORROW_INSTR_ACCOUNT_DEFAULT_ERR_CHECK`.
    - Get the state of the stake account using [`get_state`](<#get_state>).
    - Check the discriminant of the stake state to determine its type (stake, initialized, uninitialized).
    - Perform authorization checks based on the stake state type.
    - Calculate the amount of staked lamports available for withdrawal.
    - Check if the withdrawal is allowed based on the lockup conditions.
    - Check if the requested withdrawal amount is valid against the account balance.
    - Adjust the stake account balance and the destination account balance accordingly.
- **Output**: Returns 0 on success or an error code on failure.
- **Functions Called**:
    - [`get_state`](<#get_state>)
    - [`authorized_check`](<#authorized_check>)
    - [`delegation_stake`](<#delegation_stake>)
    - [`lockup_is_in_force`](<#lockup_is_in_force>)
    - [`set_state`](<#set_state>)


---
### deactivate\_delinquent<!-- {{#callable:deactivate_delinquent}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L2398>)

Deactivates a delinquent stake account if certain conditions are met.
- **Inputs**:
    - `ctx`: A pointer to the execution instruction context.
    - `stake_account`: A pointer to the borrowed account representing the stake.
    - `delinquent_vote_account_index`: The index of the delinquent vote account.
    - `reference_vote_account_index`: The index of the reference vote account.
    - `current_epoch`: The current epoch number.
    - `custom_err`: A pointer to a variable for custom error codes.
- **Logic and Control Flow**:
    - Retrieve the public key of the delinquent vote account using `fd_exec_instr_ctx_get_key_of_account_at_index`.
    - Borrow the delinquent vote account and check its owner against the expected program ID.
    - Get the state of the delinquent vote account and convert it to the current version.
    - Borrow the reference vote account and check its owner against the expected program ID.
    - Get the state of the reference vote account and convert it to the current version.
    - Check if the reference vote account has sufficient credits for deactivation.
    - Retrieve the state of the stake account.
    - Check if the stake account is valid and matches the delinquent vote account.
    - Check if the delinquent vote account is eligible for deactivation.
    - Deactivate the stake if eligible and update the state.
- **Output**: Returns an integer indicating success or an error code.
- **Functions Called**:
    - [`fd_vote_get_state`](<fd_vote_program.c.md#fd_vote_get_state>)
    - [`fd_vote_convert_to_current`](<fd_vote_program.c.md#fd_vote_convert_to_current>)
    - [`acceptable_reference_epoch_credits`](<#acceptable_reference_epoch_credits>)
    - [`get_state`](<#get_state>)
    - [`eligible_for_deactivate_delinquent`](<#eligible_for_deactivate_delinquent>)
    - [`stake_deactivate`](<#stake_deactivate>)
    - [`set_state`](<#set_state>)


---
### get\_optional\_pubkey<!-- {{#callable:get_optional_pubkey}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L2485>)

Retrieves an optional public key from the execution context.
- **Inputs**:
    - `ctx`: Pointer to the execution instruction context.
    - `acc_idx`: Index of the account to retrieve.
    - `should_be_signer`: Flag indicating if the account should be a signer.
    - `pubkey`: Pointer to store the retrieved public key.
- **Logic and Control Flow**:
    - Check if the account index is within the valid range.
    - If the account index is valid, check if it should be a signer and if it is not, return an error.
    - Retrieve the public key of the account at the specified index.
    - If the account index is invalid, set the output public key to NULL.
- **Output**: Returns 0 on success, or an error code if any checks fail.


---
### get\_stake\_account<!-- {{#callable:get_stake_account}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L2506>)

Attempts to borrow a stake account and checks its ownership.
- **Inputs**:
    - `ctx`: A pointer to the execution instruction context.
    - `out`: A pointer to a `fd_borrowed_account_t` structure to store the borrowed account.
- **Logic and Control Flow**:
    - Calls `fd_exec_instr_ctx_try_borrow_instr_account` to attempt to borrow the account.
    - If borrowing fails, returns the error code.
    - Checks if the owner of the borrowed account matches the expected Solana stake program ID.
    - If the ownership check fails, returns an error for invalid account owner.
    - Returns success if all checks pass.
- **Output**: Returns an error code indicating success or failure of the operation.


---
### fd\_stake\_program\_execute<!-- {{#callable:fd_stake_program_execute}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L2525>)

Executes stake program instructions based on the provided execution context.
- **Inputs**:
    - `ctx`: Pointer to the execution instruction context of type `fd_exec_instr_ctx_t`.
- **Logic and Control Flow**:
    - Checks if the migrated native programs feature is active and returns an error if it is.
    - Updates compute units for the execution context.
    - Retrieves signers from the execution context.
    - Validates the instruction data and returns an error if it is NULL.
    - Decodes the instruction data into a specific instruction structure.
    - Checks if the decoded instruction data exceeds a predefined size limit.
    - Checks if the epoch rewards system variable is active and sets a custom error if necessary.
    - Processes the instruction based on its discriminant using a switch-case structure, handling various stake operations.
- **Output**: Returns an integer indicating the result of the execution, which can be a success code or an error code.
- **Functions Called**:
    - [`get_stake_account`](<#get_stake_account>)
    - [`initialize`](<#initialize>)
    - [`get_optional_pubkey`](<#get_optional_pubkey>)
    - [`authorize`](<#authorize>)
    - [`authorize_with_seed`](<#authorize_with_seed>)
    - [`delegate`](<#delegate>)
    - [`split`](<#split>)
    - [`merge`](<#merge>)
    - [`fd_new_warmup_cooldown_rate_epoch`](<#fd_new_warmup_cooldown_rate_epoch>)
    - [`withdraw`](<#withdraw>)
    - [`deactivate`](<#deactivate>)
    - [`set_lockup`](<#set_lockup>)
    - [`get_minimum_delegation`](<#get_minimum_delegation>)
    - [`deactivate_delinquent`](<#deactivate_delinquent>)
    - [`move_stake`](<#move_stake>)
    - [`move_lamports`](<#move_lamports>)


---
### write\_stake\_config<!-- {{#callable:write_stake_config}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L3239>)

Writes the stake configuration to a transaction account.
- **Inputs**:
    - `accdb`: Pointer to the user account database.
    - `xid`: Pointer to the transaction identifier.
    - `stake_config`: Pointer to the stake configuration structure.
- **Logic and Control Flow**:
    - Calculate the size of the stake configuration using `fd_stake_config_size`.
    - Obtain the public key for the stake program configuration.
    - Prepare a transaction account record and initialize it using `fd_txn_account_init_from_funk_mutable`.
    - Set the lamports and executable status for the transaction account.
    - Encode the stake configuration into the transaction account data using `fd_stake_config_encode`.
    - Set the data for the transaction account with the encoded stake configuration.
    - Finalize the mutable transaction account.
- **Output**: No return value; the function modifies the transaction account directly.


---
### fd\_stake\_program\_config\_init<!-- {{#callable:fd_stake_program_config_init}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L3264>)

Initializes the stake program configuration with default values.
- **Inputs**:
    - `accdb`: Pointer to the user account database.
    - `xid`: Pointer to the transaction identifier.
- **Logic and Control Flow**:
    - Creates a `fd_stake_config_t` structure and initializes its fields with default values.
    - Calls the [`write_stake_config`](<#write_stake_config>) function to write the initialized configuration to the account database.
- **Output**: The function does not return a value; it writes the configuration to the account database.
- **Functions Called**:
    - [`write_stake_config`](<#write_stake_config>)


---
### fd\_stake\_get\_state<!-- {{#callable:fd_stake_get_state}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L3275>)

Retrieves the state of a stake account.
- **Inputs**:
    - `self`: Pointer to a constant `fd_txn_account_t` structure representing the stake account.
    - `out`: Pointer to a `fd_stake_state_v2_t` structure where the state will be stored.
- **Logic and Control Flow**:
    - Calls the [`get_state`](<#get_state>) function with `self` and `out` as arguments.
    - Returns the result of the [`get_state`](<#get_state>) function.
- **Output**: Returns an integer indicating success or an error code.
- **Functions Called**:
    - [`get_state`](<#get_state>)


---
### fd\_stake\_activating\_and\_deactivating<!-- {{#callable:fd_stake_activating_and_deactivating}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_stake_program.c#L3281>)

Processes stake activation and deactivation based on the target epoch.
- **Inputs**:
    - `self`: Pointer to a `fd_delegation_t` structure representing the current stake delegation.
    - `target_epoch`: An `ulong` representing the epoch at which the stake activation or deactivation is targeted.
    - `stake_history`: Pointer to a `fd_stake_history_t` structure containing historical stake data.
    - `new_rate_activation_epoch`: Pointer to an `ulong` that will be updated with the new rate activation epoch.
- **Logic and Control Flow**:
    - Calls the [`stake_activating_and_deactivating`](<#stake_activating_and_deactivating>) function with the provided parameters.
    - Returns the result of the [`stake_activating_and_deactivating`](<#stake_activating_and_deactivating>) function.
- **Output**: Returns a `fd_stake_history_entry_t` structure containing the effective, deactivating, and activating stake values.
- **Functions Called**:
    - [`stake_activating_and_deactivating`](<#stake_activating_and_deactivating>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)