<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for managing and executing loader v4 program instructions, including deployment, retraction, and authority transfer.

# Purpose
The code is a C implementation of a program loader for version 4 (v4) of a system, likely related to a blockchain or distributed ledger technology. It provides a set of functions to manage the lifecycle of program accounts, including deploying, retracting, writing, copying, setting program length, transferring authority, and finalizing programs. The code defines several functions that operate on `fd_loader_v4_state_t` structures, which represent the state of a program account. These functions include [`fd_loader_v4_status_is_deployed`](<#fd_loader_v4_status_is_deployed>), [`fd_loader_v4_status_is_retracted`](<#fd_loader_v4_status_is_retracted>), and [`fd_loader_v4_status_is_finalized`](<#fd_loader_v4_status_is_finalized>), which check the status of a program account.

The main functionality is encapsulated in functions like [`fd_loader_v4_program_instruction_write`](<#fd_loader_v4_program_instruction_write>), [`fd_loader_v4_program_instruction_copy`](<#fd_loader_v4_program_instruction_copy>), [`fd_loader_v4_program_instruction_set_program_length`](<#fd_loader_v4_program_instruction_set_program_length>), [`fd_loader_v4_program_instruction_deploy`](<#fd_loader_v4_program_instruction_deploy>), [`fd_loader_v4_program_instruction_retract`](<#fd_loader_v4_program_instruction_retract>), [`fd_loader_v4_program_instruction_transfer_authority`](<#fd_loader_v4_program_instruction_transfer_authority>), and [`fd_loader_v4_program_instruction_finalize`](<#fd_loader_v4_program_instruction_finalize>). These functions handle specific instructions related to program accounts, such as writing data to an account, copying data from another account, resizing an account, deploying a program, retracting a program, transferring authority, and finalizing a program. The code also includes a main execution function, [`fd_loader_v4_program_execute`](<#fd_loader_v4_program_execute>), which serves as the entry point for processing loader v4 instructions and any programs owned by loader v4. This function checks the program ID and dispatches the appropriate instruction handler based on the instruction's discriminant.
# Imports and Dependencies

---
- `fd_loader_v4_program.h`


# Functions

---
### fd\_loader\_v4\_status\_is\_deployed<!-- {{#callable:fd_loader_v4_status_is_deployed}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_loader_v4_program.c#L4>)

Checks if the status of a given `fd_loader_v4_state_t` is `FD_LOADER_V4_STATUS_ENUM_DELOYED`.
- **Inputs**:
    - `state`: A pointer to a constant `fd_loader_v4_state_t` structure representing the state to check.
- **Logic and Control Flow**:
    - Accesses the `status` field of the `state` structure.
    - Compares the `status` field to the `FD_LOADER_V4_STATUS_ENUM_DELOYED` constant.
    - Returns the result of the comparison as an unsigned char.
- **Output**: Returns 1 if the status is `FD_LOADER_V4_STATUS_ENUM_DELOYED`, otherwise returns 0.


---
### fd\_loader\_v4\_status\_is\_retracted<!-- {{#callable:fd_loader_v4_status_is_retracted}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_loader_v4_program.c#L9>)

Checks if the status of a given `fd_loader_v4_state_t` is `FD_LOADER_V4_STATUS_ENUM_RETRACTED`.
- **Inputs**:
    - `state`: A pointer to a constant `fd_loader_v4_state_t` structure representing the state to check.
- **Logic and Control Flow**:
    - Compares the `status` field of the `state` structure with `FD_LOADER_V4_STATUS_ENUM_RETRACTED`.
    - Returns the result of the comparison as an unsigned char.
- **Output**: Returns 1 if the status is `FD_LOADER_V4_STATUS_ENUM_RETRACTED`, otherwise returns 0.


---
### fd\_loader\_v4\_status\_is\_finalized<!-- {{#callable:fd_loader_v4_status_is_finalized}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_loader_v4_program.c#L14>)

Checks if the status of a given `fd_loader_v4_state_t` is `FD_LOADER_V4_STATUS_ENUM_FINALIZED`.
- **Inputs**:
    - `state`: A pointer to a constant `fd_loader_v4_state_t` structure representing the state to check.
- **Logic and Control Flow**:
    - Accesses the `status` field of the `state` structure.
    - Compares the `status` field to the constant `FD_LOADER_V4_STATUS_ENUM_FINALIZED`.
    - Returns the result of the comparison as a boolean value (1 if true, 0 if false).
- **Output**: Returns an `uchar` (unsigned char) indicating whether the status is `FD_LOADER_V4_STATUS_ENUM_FINALIZED` (1 if true, 0 if false).


---
### fd\_loader\_v4\_get\_state\_mut<!-- {{#callable:fd_loader_v4_get_state_mut}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_loader_v4_program.c#L26>)

Transmutes a mutable pointer to account data into a loader v4 state if the data length is sufficient.
- **Inputs**:
    - ``data``: A mutable pointer to the account's writable data.
    - ``dlen``: The length of the data pointed to by `data`.
    - ``err``: A pointer to an integer where the function will store an error code.
- **Logic and Control Flow**:
    - Set `*err` to `FD_EXECUTOR_INSTR_SUCCESS` to indicate initial success.
    - Check if `dlen` is less than `LOADER_V4_PROGRAM_DATA_OFFSET`.
    - If `dlen` is too small, set `*err` to `FD_EXECUTOR_INSTR_ERR_ACC_DATA_TOO_SMALL` and return `NULL`.
    - If `dlen` is sufficient, return the result of `fd_type_pun(data)`.
- **Output**: Returns a pointer to `fd_loader_v4_state_t` if successful, or `NULL` if the data length is insufficient.


---
### fd\_loader\_v4\_get\_state<!-- {{#callable:fd_loader_v4_get_state}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_loader_v4_program.c#L49>)

Retrieves the state of a program account as a constant pointer to a `fd_loader_v4_state_t` structure, setting an error code if the account data is too small.
- **Inputs**:
    - `program`: A constant pointer to a `fd_txn_account_t` structure representing the program account whose state is to be retrieved.
    - `err`: A pointer to an integer where the function will store the error code, indicating success or failure of the operation.
- **Logic and Control Flow**:
    - Initialize `*err` to `FD_EXECUTOR_INSTR_SUCCESS` to indicate success by default.
    - Check if the data length of the `program` account is less than `LOADER_V4_PROGRAM_DATA_OFFSET`.
    - If the data length is insufficient, set `*err` to `FD_EXECUTOR_INSTR_ERR_ACC_DATA_TOO_SMALL` and return `NULL`.
    - If the data length is sufficient, retrieve the data from the `program` account and return it as a constant pointer to `fd_loader_v4_state_t` using `fd_type_pun_const`.
- **Output**: Returns a constant pointer to `fd_loader_v4_state_t` representing the state of the program account, or `NULL` if the account data is too small.


---
### check\_program\_account<!-- {{#callable:check_program_account}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_loader_v4_program.c#L67>)

Validates the state of a program account and checks various conditions to ensure it is ready for further operations.
- **Inputs**:
    - `instr_ctx`: A pointer to the instruction context, which contains execution-related information.
    - `program`: A constant pointer to the borrowed account representing the program to be checked.
    - `authority_address`: A constant pointer to the public key of the authority address to be verified.
    - `err`: A pointer to an integer where the function stores error codes if any checks fail.
- **Logic and Control Flow**:
    - Set `err` to `FD_EXECUTOR_INSTR_SUCCESS` to indicate no error initially.
    - Compare the owner of the `program` account with the expected loader program ID; if they do not match, log an error and set `err` to `FD_EXECUTOR_INSTR_ERR_INVALID_ACC_OWNER`, then return `NULL`.
    - Retrieve the state of the program account using [`fd_loader_v4_get_state`](<#fd_loader_v4_get_state>); if an error occurs, return `NULL`.
    - Check if the `program` account is writable; if not, log an error and set `err` to `FD_EXECUTOR_INSTR_ERR_INVALID_ARG`, then return `NULL`.
    - Verify if the authority has signed the instruction; if not, log an error and set `err` to `FD_EXECUTOR_INSTR_ERR_MISSING_REQUIRED_SIGNATURE`, then return `NULL`.
    - Compare the `authority_address` with the `state->authority_address_or_next_version`; if they do not match, log an error and set `err` to `FD_EXECUTOR_INSTR_ERR_INCORRECT_AUTHORITY`, then return `NULL`.
    - Check if the program state is finalized; if it is, log an error and set `err` to `FD_EXECUTOR_INSTR_ERR_ACC_IMMUTABLE`, then return `NULL`.
    - If all checks pass, return the `state` of the program account.
- **Output**: Returns a constant pointer to the `fd_loader_v4_state_t` structure representing the program account's state if all checks pass, or `NULL` if any check fails.
- **Functions Called**:
    - [`fd_loader_v4_get_state`](<#fd_loader_v4_get_state>)
    - [`fd_loader_v4_status_is_finalized`](<#fd_loader_v4_status_is_finalized>)


---
### fd\_loader\_v4\_program\_instruction\_write<!-- {{#callable:fd_loader_v4_program_instruction_write}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_loader_v4_program.c#L132>)

Writes ELF data into an undeployed program account if the program is in a retracted state.
- **Inputs**:
    - ``instr_ctx``: A pointer to the instruction execution context (`fd_exec_instr_ctx_t`).
    - ``write``: A pointer to the structure containing the write instruction details (`fd_loader_v4_program_instruction_write_t`).
- **Logic and Control Flow**:
    - Initialize variables `err`, `offset`, `bytes`, and `bytes_len` from the `write` structure.
    - Borrow the program account using `FD_TRY_BORROW_INSTR_ACCOUNT_DEFAULT_ERR_CHECK` with `instr_ctx` and index `0UL`.
    - Retrieve the authority address using `fd_exec_instr_ctx_get_key_of_account_at_index` with `instr_ctx` and index `1UL`.
    - Check the program account state using [`check_program_account`](<#check_program_account>) with `instr_ctx`, `program`, and `authority_address`.
    - Verify if the program is in a retracted state using [`fd_loader_v4_status_is_retracted`](<#fd_loader_v4_status_is_retracted>). If not, log a message and return an error.
    - Calculate `destination_offset` by adding `offset` to `LOADER_V4_PROGRAM_DATA_OFFSET`.
    - Get mutable data and its length from the program account using `fd_borrowed_account_get_data_mut`.
    - Check if the write operation is within bounds by comparing `destination_offset + bytes_len` with `dlen`. If out of bounds, log a message and return an error.
    - If `bytes_len` is greater than 0, copy `bytes` to the program data at `destination_offset` using `fd_memcpy`.
    - Return `FD_EXECUTOR_INSTR_SUCCESS` on successful completion.
- **Output**: Returns an integer status code indicating success or the type of error encountered.
- **Functions Called**:
    - [`check_program_account`](<#check_program_account>)
    - [`fd_loader_v4_status_is_retracted`](<#fd_loader_v4_status_is_retracted>)


---
### fd\_loader\_v4\_program\_instruction\_copy<!-- {{#callable:fd_loader_v4_program_instruction_copy}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_loader_v4_program.c#L199>)

Copies ELF data from a source program account to a destination program account, ensuring the program is in a retracted state and the source is a valid program.
- **Inputs**:
    - ``instr_ctx``: A pointer to the instruction execution context (`fd_exec_instr_ctx_t`).
    - ``copy``: A pointer to the structure containing the copy instruction details (`fd_loader_v4_program_instruction_copy_t`).
- **Logic and Control Flow**:
    - Initialize variables for error handling, destination offset, source offset, and length from the `copy` structure.
    - Borrow the program account at index 0 and check for errors.
    - Retrieve the authority address from the account at index 1 and check for errors.
    - Borrow the source program account at index 2 and check for errors.
    - Check the program account's state to ensure it is retracted and validate the authority address.
    - Verify the source program's owner and adjust the source offset based on the program type.
    - Check if the source data length is sufficient for the copy operation and log an error if not.
    - Get mutable data from the destination program account and check for errors.
    - Adjust the destination offset and verify the destination data length is sufficient for the copy operation.
    - Perform the memory copy from the source to the destination program account.
- **Output**: Returns an integer status code indicating success (`FD_EXECUTOR_INSTR_SUCCESS`) or an error code if any checks fail.
- **Functions Called**:
    - [`check_program_account`](<#check_program_account>)
    - [`fd_loader_v4_status_is_retracted`](<#fd_loader_v4_status_is_retracted>)


---
### fd\_loader\_v4\_program\_instruction\_set\_program\_length<!-- {{#callable:fd_loader_v4_program_instruction_set_program_length}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_loader_v4_program.c#L286>)

Resizes an undeployed program account to a specified size, handling initialization and lamport adjustments as needed.
- **Inputs**:
    - ``instr_ctx``: A pointer to the instruction execution context, which contains information about the current transaction and accounts.
    - ``set_program_length``: A pointer to a structure containing the new size for the program account.
- **Logic and Control Flow**:
    - Retrieve the new size from `set_program_length` and initialize a `program` account structure.
    - Check if the program is in the initialization phase by comparing its data length with `LOADER_V4_PROGRAM_DATA_OFFSET`.
    - If initializing, verify the program's ownership, writability, and authority signature.
    - If not initializing, validate the program account state and ensure it is retracted.
    - Read the rent sysvar to calculate the required lamports for the new program size.
    - Compare the program's current lamports with the required lamports and handle excess or insufficient funds accordingly.
    - If the new size is zero, set the program's data length to zero, effectively closing it.
    - If the new size is non-zero, adjust the program's data length and, if initializing, set it as executable and update its state.
- **Output**: Returns `FD_EXECUTOR_INSTR_SUCCESS` on success or an error code if any validation or operation fails.
- **Functions Called**:
    - [`check_program_account`](<#check_program_account>)
    - [`fd_loader_v4_status_is_retracted`](<#fd_loader_v4_status_is_retracted>)
    - [`fd_loader_v4_get_state_mut`](<#fd_loader_v4_get_state_mut>)


---
### fd\_loader\_v4\_program\_instruction\_deploy<!-- {{#callable:fd_loader_v4_program_instruction_deploy}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_loader_v4_program.c#L456>)

Deploys a program by verifying its state and data, ensuring it meets specific conditions, and updating its status to deployed.
- **Inputs**:
    - `instr_ctx`: A pointer to the `fd_exec_instr_ctx_t` structure, which contains the execution context for the instruction.
- **Logic and Control Flow**:
    - Initialize a `fd_guarded_borrowed_account_t` structure for the program and check for errors using `FD_TRY_BORROW_INSTR_ACCOUNT_DEFAULT_ERR_CHECK`.
    - Retrieve the authority address from the instruction context and check for errors.
    - Validate the program account's state using [`check_program_account`](<#check_program_account>) and handle any errors.
    - Read the current slot from the system clock using `fd_sysvar_cache_clock_read` and check for errors.
    - Check if the program has been deployed recently by comparing the current slot with the program's slot and the deployment cooldown; log a message and return an error if the cooldown is still in effect.
    - Verify that the program is in a retracted state using [`fd_loader_v4_status_is_retracted`](<#fd_loader_v4_status_is_retracted>); log a message and return an error if not.
    - Check if the program data length is sufficient and retrieve the program data; return an error if the data is too small.
    - Deploy the program using [`fd_deploy_program`](<fd_bpf_loader_program.c.md#fd_deploy_program>) and handle any errors.
    - Retrieve mutable data for the program account, update the program's slot to the current slot, and set its status to deployed.
- **Output**: Returns `FD_EXECUTOR_INSTR_SUCCESS` on successful deployment, or an error code if any checks or operations fail.
- **Functions Called**:
    - [`check_program_account`](<#check_program_account>)
    - [`fd_loader_v4_status_is_retracted`](<#fd_loader_v4_status_is_retracted>)
    - [`fd_deploy_program`](<fd_bpf_loader_program.c.md#fd_deploy_program>)
    - [`fd_loader_v4_get_state_mut`](<#fd_loader_v4_get_state_mut>)


---
### fd\_loader\_v4\_program\_instruction\_retract<!-- {{#callable:fd_loader_v4_program_instruction_retract}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_loader_v4_program.c#L551>)

Retracts a deployed program, making it writable and uninvokable.
- **Inputs**:
    - `instr_ctx`: A pointer to the `fd_exec_instr_ctx_t` structure, which provides the execution context for the instruction.
- **Logic and Control Flow**:
    - Initialize a `fd_guarded_borrowed_account_t` structure for the program account and check for errors.
    - Retrieve the authority address from the instruction context and check for errors.
    - Validate the program account using [`check_program_account`](<#check_program_account>) and check for errors.
    - Read the current slot from the system clock using `fd_sysvar_cache_clock_read` and check for errors.
    - Check if the program was deployed recently and if the cooldown period is still in effect; if so, log a message and return an error.
    - Verify if the program is currently deployed; if not, log a message and return an error.
    - Retrieve mutable data from the program account and check for errors.
    - Update the program's state to `FD_LOADER_V4_STATUS_ENUM_RETRACTED`.
- **Output**: Returns `FD_EXECUTOR_INSTR_SUCCESS` on success or an error code if any step fails.
- **Functions Called**:
    - [`check_program_account`](<#check_program_account>)
    - [`fd_loader_v4_status_is_deployed`](<#fd_loader_v4_status_is_deployed>)
    - [`fd_loader_v4_get_state_mut`](<#fd_loader_v4_get_state_mut>)


---
### fd\_loader\_v4\_program\_instruction\_transfer\_authority<!-- {{#callable:fd_loader_v4_program_instruction_transfer_authority}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_loader_v4_program.c#L619>)

Transfers the authority of a program account to a new authority.
- **Inputs**:
    - ``instr_ctx``: A pointer to the `fd_exec_instr_ctx_t` structure, which provides the execution context for the instruction.
- **Logic and Control Flow**:
    - Initialize a `fd_guarded_borrowed_account_t` structure for the program account and check for errors.
    - Retrieve the current authority's public key from the instruction context and check for errors.
    - Retrieve the new authority's public key from the instruction context and check for errors.
    - Validate the program account using [`check_program_account`](<#check_program_account>) and ensure the current authority is correct.
    - Check if the new authority has signed the transaction; if not, log an error and return a missing signature error code.
    - Compare the new authority's address with the current authority's address; if they are the same, log a 'No change' message and return an invalid argument error code.
    - Retrieve mutable data from the program account and check for errors.
    - Update the program account's authority to the new authority's address.
- **Output**: Returns `FD_EXECUTOR_INSTR_SUCCESS` on successful authority transfer, or an error code if any step fails.
- **Functions Called**:
    - [`check_program_account`](<#check_program_account>)
    - [`fd_loader_v4_get_state_mut`](<#fd_loader_v4_get_state_mut>)


---
### fd\_loader\_v4\_program\_instruction\_finalize<!-- {{#callable:fd_loader_v4_program_instruction_finalize}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_loader_v4_program.c#L694>)

Finalizes a program account by verifying its deployment status, authority, and next version, then updates its state to finalized.
- **Inputs**:
    - `instr_ctx`: A pointer to the `fd_exec_instr_ctx_t` structure, which provides the execution context for the instruction.
- **Logic and Control Flow**:
    - Initialize a `fd_guarded_borrowed_account_t` structure for the program and check its account using `FD_TRY_BORROW_INSTR_ACCOUNT_DEFAULT_ERR_CHECK`.
    - Retrieve the authority address from the instruction context using `fd_exec_instr_ctx_get_key_of_account_at_index`.
    - Validate the program account by calling [`check_program_account`](<#check_program_account>) and ensure it is deployed using [`fd_loader_v4_status_is_deployed`](<#fd_loader_v4_status_is_deployed>).
    - Drop the program account reference and initialize a `fd_guarded_borrowed_account_t` structure for the next version.
    - Verify the ownership of the next version account and retrieve its state using [`fd_loader_v4_get_state`](<#fd_loader_v4_get_state>).
    - Check that the next version has the same authority and is not finalized.
    - Retrieve the public key of the next version and drop the next version account reference.
    - Re-borrow the program account, retrieve its mutable data, and update its state to finalized with the next version's address.
- **Output**: Returns `FD_EXECUTOR_INSTR_SUCCESS` on successful finalization or an error code if any validation fails.
- **Functions Called**:
    - [`check_program_account`](<#check_program_account>)
    - [`fd_loader_v4_status_is_deployed`](<#fd_loader_v4_status_is_deployed>)
    - [`fd_loader_v4_get_state`](<#fd_loader_v4_get_state>)
    - [`fd_loader_v4_status_is_finalized`](<#fd_loader_v4_status_is_finalized>)
    - [`fd_loader_v4_get_state_mut`](<#fd_loader_v4_get_state_mut>)


---
### fd\_loader\_v4\_program\_execute<!-- {{#callable:fd_loader_v4_program_execute}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_loader_v4_program.c#L784>)

Executes a program instruction in the Loader V4 environment, handling various instruction types and ensuring program validity.
- **Inputs**:
    - `instr_ctx`: A pointer to the `fd_exec_instr_ctx_t` structure, which contains the execution context for the instruction.
- **Logic and Control Flow**:
    - Check if the Loader V4 feature is active for the bank in the transaction context; return an error if not.
    - Begin a scratchpad frame for temporary data storage during execution.
    - Retrieve the last program key from the instruction context; return an error if retrieval fails.
    - Compare the retrieved program ID with the Loader V4 program ID; if they match, decode the instruction data and execute the corresponding instruction based on its discriminant.
    - If the program ID does not match, attempt to borrow the last program account and check its state; return an error if the program is not deployed or is retracted.
    - Check the program's cache entry for executability; return an error if the program is not executable.
    - Execute the program using the BPF executor if all checks pass.
    - Return the result code from the executed instruction or error checks.
- **Output**: Returns an integer status code indicating success or the type of error encountered during execution.
- **Functions Called**:
    - [`fd_loader_v4_program_instruction_write`](<#fd_loader_v4_program_instruction_write>)
    - [`fd_loader_v4_program_instruction_copy`](<#fd_loader_v4_program_instruction_copy>)
    - [`fd_loader_v4_program_instruction_set_program_length`](<#fd_loader_v4_program_instruction_set_program_length>)
    - [`fd_loader_v4_program_instruction_deploy`](<#fd_loader_v4_program_instruction_deploy>)
    - [`fd_loader_v4_program_instruction_retract`](<#fd_loader_v4_program_instruction_retract>)
    - [`fd_loader_v4_program_instruction_transfer_authority`](<#fd_loader_v4_program_instruction_transfer_authority>)
    - [`fd_loader_v4_program_instruction_finalize`](<#fd_loader_v4_program_instruction_finalize>)
    - [`fd_loader_v4_get_state`](<#fd_loader_v4_get_state>)
    - [`fd_loader_v4_status_is_retracted`](<#fd_loader_v4_status_is_retracted>)
    - [`fd_bpf_execute`](<fd_bpf_loader_program.c.md#fd_bpf_execute>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)