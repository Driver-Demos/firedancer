<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements precompiled signature verification for Ed25519, Secp256k1, and Secp256r1 in a runtime environment.

# Purpose
The code is a C source file that implements cryptographic signature verification for three different algorithms: Ed25519, Secp256k1, and Secp256r1. It is part of a larger system that likely deals with transaction processing or blockchain technology, as indicated by the inclusion of cryptographic libraries and references to Solana documentation. The file defines structures and functions to handle signature offsets and data serialization for these algorithms. It provides functions to verify signatures by extracting and processing data from instructions, handling different serialization formats, and performing cryptographic operations to ensure data integrity and authenticity.

The file includes several header files that provide necessary cryptographic functions and data structures. It defines specific data structures for handling signature offsets for each algorithm, ensuring that the data is packed efficiently. The functions [`fd_precompile_ed25519_verify`](<#fd_precompile_ed25519_verify>), [`fd_precompile_secp256k1_verify`](<#fd_precompile_secp256k1_verify>), and [`fd_precompile_secp256r1_verify`](<#fd_precompile_secp256r1_verify>) are responsible for verifying signatures by checking data sizes, extracting necessary data, and using cryptographic functions to validate the signatures. The code also includes error handling to manage different edge cases and ensure robust execution. The file is intended to be part of a larger application, likely serving as a library or module that provides cryptographic verification capabilities.
# Imports and Dependencies

---
- `fd_precompiles.h`
- `../fd_bank.h`
- `../fd_executor_err.h`
- `../../../ballet/keccak256/fd_keccak256.h`
- `../../../ballet/ed25519/fd_ed25519.h`
- `../../../ballet/secp256k1/fd_secp256k1.h`
- `../../../ballet/secp256r1/fd_secp256r1.h`


# Data Structures

---
### fd\_precompile\_sig\_offsets
- **Type**: ``struct``
- **Members**:
    - ``sig_offset``: Stores the offset of the signature in the data.
    - ``sig_instr_idx``: Stores the instruction index for the signature.
    - ``pubkey_offset``: Stores the offset of the public key in the data.
    - ``pubkey_instr_idx``: Stores the instruction index for the public key.
    - ``msg_offset``: Stores the offset of the message in the data.
    - ``msg_data_sz``: Stores the size of the message data.
    - ``msg_instr_idx``: Stores the instruction index for the message.
- **Description**: Defines offsets and indices for signature, public key, and message data used in cryptographic operations, ensuring precise data retrieval and processing within a packed structure.


---
### fd\_ed25519\_signature\_offsets\_t
- **Type**: ``struct``
- **Members**:
    - ``sig_offset``: Stores the offset of the signature in the data.
    - ``sig_instr_idx``: Stores the instruction index for the signature.
    - ``pubkey_offset``: Stores the offset of the public key in the data.
    - ``pubkey_instr_idx``: Stores the instruction index for the public key.
    - ``msg_offset``: Stores the offset of the message in the data.
    - ``msg_data_sz``: Stores the size of the message data.
    - ``msg_instr_idx``: Stores the instruction index for the message.
- **Description**: Defines offsets and indices for signature, public key, and message data in a serialized format, used for verifying Ed25519 signatures in a precompiled context.


---
### fd\_secp256r1\_signature\_offsets\_t
- **Type**: ``typedef struct fd_precompile_sig_offsets fd_secp256r1_signature_offsets_t;``
- **Members**:
    - `sig_offset`: The offset of the signature in the data.
    - `sig_instr_idx`: The instruction index for the signature.
    - `pubkey_offset`: The offset of the public key in the data.
    - `pubkey_instr_idx`: The instruction index for the public key.
    - `msg_offset`: The offset of the message in the data.
    - `msg_data_sz`: The size of the message data.
    - `msg_instr_idx`: The instruction index for the message.
- **Description**: Defines offsets and indices for signature, public key, and message data used in cryptographic operations, specifically for the secp256r1 signature scheme.


---
### fd\_precompile\_one\_byte\_idx\_sig\_offsets
- **Type**: ``struct``
- **Members**:
    - `sig_offset`: Stores the offset of the signature within the data.
    - `sig_instr_idx`: Stores the index of the instruction for the signature, using a single byte.
    - `pubkey_offset`: Stores the offset of the public key within the data.
    - `pubkey_instr_idx`: Stores the index of the instruction for the public key, using a single byte.
    - `msg_offset`: Stores the offset of the message within the data.
    - `msg_data_sz`: Stores the size of the message data.
    - `msg_instr_idx`: Stores the index of the instruction for the message, using a single byte.
- **Description**: Defines offsets and instruction indices for signature, public key, and message data, specifically for the Secp256k1 signature verification process, using a compact format with single-byte instruction indices.


---
### fd\_secp256k1\_signature\_offsets\_t
- **Type**: ``struct``
- **Members**:
    - ``sig_offset``: Stores the offset of the signature in the data.
    - ``sig_instr_idx``: Stores the instruction index for the signature.
    - ``pubkey_offset``: Stores the offset of the public key in the data.
    - ``pubkey_instr_idx``: Stores the instruction index for the public key.
    - ``msg_offset``: Stores the offset of the message in the data.
    - ``msg_data_sz``: Stores the size of the message data.
    - ``msg_instr_idx``: Stores the instruction index for the message.
- **Description**: Defines offsets and instruction indices for handling secp256k1 signatures, public keys, and messages in a serialized data format, using a compact representation with 8-bit instruction indices.


# Functions

---
### fd\_precompile\_get\_instr\_data<!-- {{#callable:fd_precompile_get_instr_data}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_precompiles.c#L78>)

Fetches instruction data based on the given index and offset, handling special cases for different instruction types.
- **Inputs**:
    - `ctx`: A pointer to the `fd_exec_instr_ctx_t` structure, which contains the execution context and instruction data.
    - `index`: An unsigned short representing the instruction index; a special value `USHORT_MAX` indicates the current instruction.
    - `offset`: An unsigned short representing the offset within the instruction data.
    - `sz`: An unsigned short representing the size of the data to fetch.
    - `res`: A pointer to a pointer to `uchar` where the function will store the address of the fetched data.
- **Logic and Control Flow**:
    - Check if `index` is `USHORT_MAX`; if true, use the current instruction's data and size from `ctx->instr`.
    - If `index` is not `USHORT_MAX`, verify that `index` is within bounds of `ctx->txn_ctx->instr_info_cnt`; if not, return `FD_EXECUTOR_PRECOMPILE_ERR_DATA_OFFSET`.
    - Retrieve the instruction data and size from `ctx->txn_ctx->instr_infos[index]`.
    - Check if the sum of `offset` and `sz` exceeds `data_sz`; if true, return `FD_EXECUTOR_PRECOMPILE_ERR_SIGNATURE`.
    - Set `*res` to point to the data at the calculated offset.
    - Return 0 to indicate success.
- **Output**: Returns 0 on success, or an error code (`FD_EXECUTOR_PRECOMPILE_ERR_DATA_OFFSET` or `FD_EXECUTOR_PRECOMPILE_ERR_SIGNATURE`) on failure.


---
### fd\_precompile\_ed25519\_verify<!-- {{#callable:fd_precompile_ed25519_verify}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_precompiles.c#L120>)

Verifies Ed25519 signatures by checking data size, extracting signature, public key, and message, and using the `fd_ed25519_verify` function.
- **Inputs**:
    - `ctx`: A pointer to `fd_exec_instr_ctx_t` structure containing the execution context, including instruction data and transaction context.
- **Logic and Control Flow**:
    - Check if `data_sz` is less than `DATA_START`; if true, handle the edge case where `data_sz` is 2 and `data[0]` is 0, returning success, otherwise set a custom error and return an error code.
    - Extract the signature count `sig_cnt` from `data[0]`; if `sig_cnt` is 0, set a custom error and return an error code.
    - Calculate `expected_data_size` based on `sig_cnt`; if `data_sz` is less than `expected_data_size`, set a custom error and return an error code.
    - Iterate over each signature using `sig_cnt` to extract signature offsets, signature, public key, and message data using [`fd_precompile_get_instr_data`](<#fd_precompile_get_instr_data>).
    - For each signature, verify it using `fd_ed25519_verify`; if verification fails, set a custom error and return an error code.
    - If all signatures are verified successfully, return success.
- **Output**: Returns `FD_EXECUTOR_INSTR_SUCCESS` on successful verification of all signatures, or an error code if any verification step fails.
- **Functions Called**:
    - [`fd_precompile_get_instr_data`](<#fd_precompile_get_instr_data>)


---
### fd\_precompile\_secp256k1\_verify<!-- {{#callable:fd_precompile_secp256k1_verify}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_precompiles.c#L224>)

Verifies secp256k1 signatures by processing instruction data and checking the validity of each signature against the provided public key and message.
- **Inputs**:
    - `ctx`: A pointer to `fd_exec_instr_ctx_t`, which contains the execution context including instruction data and transaction context.
- **Logic and Control Flow**:
    - Retrieve `data` and `data_sz` from `ctx->instr`.
    - Check if `data_sz` is less than `SECP256K1_DATA_START`; if true, handle special case where `data_sz` is 1 and `data[0]` is 0, returning success if so, otherwise set custom error and return error.
    - Extract `sig_cnt` from `data[0]` and check if it is 0 while `data_sz` is greater than 1; if true, set custom error and return error.
    - Calculate `expected_data_size` based on `sig_cnt` and check if `data_sz` is less than this value; if true, set custom error and return error.
    - Iterate over each signature count `sig_cnt`, extracting signature offsets from `data`.
    - For each signature, retrieve the signature, public key, and message data using [`fd_precompile_get_instr_data`](<#fd_precompile_get_instr_data>).
    - Hash the message using `fd_keccak256_hash`.
    - Attempt to recover the public key from the signature and message hash using `fd_secp256k1_recover`; if recovery fails, set custom error and return error.
    - Hash the recovered public key and compare it with the provided Ethereum address; if they do not match, set custom error and return error.
    - If all checks pass, return success.
- **Output**: Returns `FD_EXECUTOR_INSTR_SUCCESS` if all signatures are valid, otherwise returns `FD_EXECUTOR_INSTR_ERR_CUSTOM_ERR` with a specific error code set in `ctx->txn_ctx->custom_err`.
- **Functions Called**:
    - [`fd_precompile_get_instr_data`](<#fd_precompile_get_instr_data>)


---
### fd\_precompile\_secp256r1\_verify<!-- {{#callable:fd_precompile_secp256r1_verify}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_precompiles.c#L422>)

Always returns a fatal error code indicating the function is not supported.
- **Inputs**:
    - ``ctx``: Unused parameter of type `fd_exec_instr_ctx_t *`.
- **Logic and Control Flow**:
    - The function is defined under a preprocessor condition `#ifdef FD_HAS_S2NBIGNUM`, but the provided code is under the `#else` condition, indicating the absence of `FD_HAS_S2NBIGNUM`.
    - Returns the constant `FD_EXECUTOR_INSTR_ERR_FATAL`, indicating a fatal error.
- **Output**: Returns `FD_EXECUTOR_INSTR_ERR_FATAL`, a constant indicating a fatal error.



---
Made with ❤️ by [Driver](https://www.driver.ai/)