<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a vote program with functions for managing vote states, processing votes, and handling account operations.

# Purpose
The code is a C implementation of a voting program, which is part of a larger system, likely a blockchain or distributed ledger technology. It provides functionality for managing vote accounts, processing votes, and handling various vote-related operations. The code includes definitions for constants, inline functions, and static functions that implement the core logic of the voting program. It interacts with other components through included headers and external interfaces, such as `fd_borrowed_account`, `fd_executor`, and `fd_pubkey_utils`.

Key components of the code include functions for initializing vote accounts, authorizing voters, processing votes, updating vote states, and handling vote state updates. The code also includes functions for managing authorized voters and handling vote state versions. The main entry point for the voting program is the [`fd_vote_program_execute`](<#fd_vote_program_execute>) function, which processes different types of vote instructions based on their discriminant values. The code is structured to handle various scenarios, such as vote authorization, vote state updates, and commission updates, while ensuring data integrity and consistency through checks and validations.
# Imports and Dependencies

---
- `fd_vote_program.h`
- `../fd_borrowed_account.h`
- `../fd_executor.h`
- `../fd_pubkey_utils.h`
- `../sysvar/fd_sysvar_rent.h`
- `../sysvar/fd_sysvar.h`
- `../fd_system_ids.h`
- `limits.h`
- `math.h`
- `stdio.h`
- `string.h`


# Functions

---
### size\_of\_versioned<!-- {{#callable:size_of_versioned}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L62>)

Returns the size of the versioned vote state based on whether it is current or not.
- **Inputs**:
    - `is_current`: An integer indicating if the version is current (1 for current, 0 for previous).
- **Logic and Control Flow**:
    - Calls `fd_ulong_if` with `is_current`, `FD_VOTE_STATE_V3_SZ`, and `FD_VOTE_STATE_V2_SZ`.
    - Returns `FD_VOTE_STATE_V3_SZ` if `is_current` is true, otherwise returns `FD_VOTE_STATE_V2_SZ`.
- **Output**: Returns an unsigned long representing the size of the vote state for the specified version.


---
### lockout<!-- {{#callable:lockout}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L72>)

Calculates the lockout duration based on the confirmation count.
- **Inputs**:
    - `self`: Pointer to a `fd_vote_lockout_t` structure containing the confirmation count.
- **Logic and Control Flow**:
    - Retrieve the `confirmation_count` from the `self` structure.
    - Limit the `confirmation_count` to a maximum of `MAX_LOCKOUT_HISTORY` using `fd_ulong_min`.
    - Calculate the lockout duration by shifting `1UL` left by the `confirmation_count`.
- **Output**: Returns the calculated lockout duration as an unsigned long integer.


---
### last\_locked\_out\_slot<!-- {{#callable:last_locked_out_slot}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L81>)

Calculates the last locked out slot based on the current slot and the lockout period.
- **Inputs**:
    - `self`: Pointer to a `fd_vote_lockout_t` structure that contains the current slot and confirmation count.
- **Logic and Control Flow**:
    - Calls the [`lockout`](<#lockout>) function to determine the lockout period based on the confirmation count.
    - Uses `fd_ulong_sat_add` to safely add the current slot and the calculated lockout period.
- **Output**: Returns the last locked out slot as an unsigned long integer.
- **Functions Called**:
    - [`lockout`](<#lockout>)


---
### is\_locked\_out\_at\_slot<!-- {{#callable:is_locked_out_at_slot}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L87>)

Determines if a `fd_vote_lockout_t` is locked out at a specific slot.
- **Inputs**:
    - `self`: Pointer to a `fd_vote_lockout_t` structure that contains lockout information.
    - `slot`: The slot number to check against the lockout.
- **Logic and Control Flow**:
    - Calls `last_locked_out_slot(self)` to get the last slot that was locked out.
    - Compares the result of `last_locked_out_slot(self)` with the provided `slot`.
- **Output**: Returns a non-zero value if the last locked out slot is greater than or equal to the provided slot, indicating that the lockout is active at that slot.
- **Functions Called**:
    - [`last_locked_out_slot`](<#last_locked_out_slot>)


---
### increase\_confirmation\_count<!-- {{#callable:increase_confirmation_count}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L93>)

Increases the `confirmation_count` of a `fd_vote_lockout_t` structure.
- **Inputs**:
    - `self`: A pointer to a `fd_vote_lockout_t` structure that holds the current confirmation count.
    - `by`: An unsigned integer that specifies the amount to increase the confirmation count by.
- **Logic and Control Flow**:
    - Calls `fd_uint_sat_add` to safely add the value of `by` to the current `confirmation_count`.
    - Updates the `confirmation_count` field of the `fd_vote_lockout_t` structure with the result.
- **Output**: This function does not return a value; it modifies the `confirmation_count` in place.


---
### from\_vote\_state\_1\_14\_11<!-- {{#callable:from_vote_state_1_14_11}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L109>)

Converts a current `fd_vote_state_t` object to an older version `fd_vote_state_1_14_11_t`.
- **Inputs**:
    - `vote_state`: Pointer to the current `fd_vote_state_t` object to convert.
    - `vote_state_1_14_11`: Pointer to the output `fd_vote_state_1_14_11_t` object that will hold the converted state.
    - `spad`: Pointer to the `fd_spad_t` allocator used for memory allocation during conversion.
- **Logic and Control Flow**:
    - Copies basic fields from `vote_state` to `vote_state_1_14_11`.
    - Checks if `vote_state->votes` is not null.
    - Allocates memory for `deque_mem` using `fd_spad_alloc`.
    - Creates a new deque for `votes` in `vote_state_1_14_11`.
    - Iterates through each landed vote in `vote_state->votes`.
    - Pushes each landed vote's lockout to the new `votes` deque.
    - Copies additional fields from `vote_state` to `vote_state_1_14_11`.
    - Clears moved objects in `vote_state`.
- **Output**: The function does not return a value but populates the `vote_state_1_14_11` object with the converted state.


---
### get\_state<!-- {{#callable:get_state}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L151>)

Decodes the state of a transaction account and handles errors.
- **Inputs**:
    - `self`: Pointer to a constant `fd_txn_account_t` structure representing the transaction account.
    - `spad`: Pointer to a `fd_spad_t` structure used for memory allocation.
    - `err`: Pointer to an integer where the error code will be stored.
- **Logic and Control Flow**:
    - Calls `fd_bincode_decode_spad` to decode the state from the `spad` using the account's data.
    - Checks if decoding resulted in an error using `decode_err`.
    - If an error occurred, sets the error code to `FD_EXECUTOR_INSTR_ERR_INVALID_ACC_DATA` and returns NULL.
    - If no error occurred, sets the error code to `FD_EXECUTOR_INSTR_SUCCESS` and returns the decoded state.
- **Output**: Returns a pointer to a `fd_vote_state_versioned_t` structure representing the decoded state, or NULL if an error occurred.


---
### set\_state<!-- {{#callable:set_state}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L169>)

Sets the state of a borrowed account with a serialized vote state.
- **Inputs**:
    - `self`: Pointer to a `fd_borrowed_account_t` structure representing the account to be updated.
    - `state`: Pointer to a `fd_vote_state_versioned_t` structure containing the new vote state to set.
- **Logic and Control Flow**:
    - Retrieve mutable data and length from the borrowed account using `fd_borrowed_account_get_data_mut`.
    - Check if the retrieved data length is sufficient for the serialized size of the new state.
    - Initialize an encoding context with the retrieved data.
    - Encode the new state into the data using `fd_vote_state_versioned_encode`.
    - Return success or an error code based on the operations performed.
- **Output**: Returns `FD_EXECUTOR_INSTR_SUCCESS` on success, or an error code if any operation fails.


---
### authorized\_voters\_new<!-- {{#callable:authorized_voters_new}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L202>)

Allocates and initializes a new `fd_vote_authorized_voters_t` structure.
- **Inputs**:
    - `epoch`: The current epoch number.
    - `pubkey`: A pointer to the public key of the authorized voter.
    - `spad`: A pointer to the scratchpad allocator.
    - `authorized_voters`: A pointer to the output structure to hold the authorized voters.
- **Logic and Control Flow**:
    - Allocates memory for the voter pool using `fd_spad_alloc`.
    - Creates a new pool for authorized voters and joins it to the `authorized_voters` structure.
    - Allocates memory for a treap structure using `fd_spad_alloc`.
    - Creates a new treap for authorized voters and joins it to the `authorized_voters` structure.
    - Checks if the pool is empty and logs an error if it is.
    - Acquires an element from the pool and sets its epoch, public key, and priority.
    - Inserts the new voter element into the treap.
- **Output**: The function initializes the `authorized_voters` structure with a new pool and treap, and populates it with the provided epoch and public key.


---
### authorized\_voters\_is\_empty<!-- {{#callable:authorized_voters_is_empty}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L230>)

Checks if the authorized voters treap is empty.
- **Inputs**:
    - `self`: Pointer to a `fd_vote_authorized_voters_t` structure.
- **Logic and Control Flow**:
    - Calls `fd_vote_authorized_voters_treap_ele_cnt` with `self->treap` to get the count of elements.
    - Returns 1 if the count is 0, indicating the treap is empty; otherwise, returns 0.
- **Output**: Returns 1 if the treap is empty, otherwise returns 0.


---
### authorized\_voters\_contains<!-- {{#callable:authorized_voters_contains}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L236>)

Checks if an `epoch` is present in the authorized voters.
- **Inputs**:
    - `self`: Pointer to an instance of `fd_vote_authorized_voters_t`, which contains the treap of authorized voters.
    - `epoch`: An unsigned long integer representing the epoch to check for presence in the authorized voters.
- **Logic and Control Flow**:
    - Calls `fd_vote_authorized_voters_treap_ele_query` with `self->treap`, `epoch`, and `self->pool` to check if the epoch exists.
    - The result of the query is converted to a boolean value using the double negation operator `!!`.
- **Output**: Returns 1 if the epoch is found in the authorized voters, otherwise returns 0.


---
### authorized\_voters\_last<!-- {{#callable:authorized_voters_last}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L242>)

Returns the last authorized voter from the authorized voters treap.
- **Inputs**:
    - `self`: Pointer to an `fd_vote_authorized_voters_t` structure that contains the treap of authorized voters.
- **Logic and Control Flow**:
    - Initializes a reverse iterator for the treap using `fd_vote_authorized_voters_treap_rev_iter_init`.
    - Retrieves the last element from the iterator using `fd_vote_authorized_voters_treap_rev_iter_ele`.
- **Output**: Returns a pointer to the last `fd_vote_authorized_voter_t` structure in the treap.


---
### authorized\_voters\_purge\_authorized\_voters<!-- {{#callable:authorized_voters_purge_authorized_voters}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L250>)

Removes expired authorized voters from the authorized voters treap.
- **Inputs**:
    - `self`: Pointer to the `fd_vote_authorized_voters_t` structure containing the authorized voters.
    - `current_epoch`: The current epoch number used to determine expiration.
    - `ctx`: Pointer to the execution instruction context containing transaction context.
- **Logic and Control Flow**:
    - Allocates memory for expired keys based on the number of elements in the treap.
    - Iterates through the treap to find authorized voters whose epoch is less than the current epoch.
    - Stores the expired keys in an array.
    - Removes each expired authorized voter from the treap and releases its memory.
    - Checks that the authorized voters treap is not empty after purging.
- **Output**: The function does not return a value; it modifies the state of the `self` structure by purging expired voters.
- **Functions Called**:
    - [`authorized_voters_is_empty`](<#authorized_voters_is_empty>)


---
### authorized\_voters\_get\_or\_calculate\_authorized\_voter\_for\_epoch<!-- {{#callable:authorized_voters_get_or_calculate_authorized_voter_for_epoch}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L286>)

Retrieves or calculates the authorized voter for a given epoch.
- **Inputs**:
    - `self`: Pointer to an instance of `fd_vote_authorized_voters_t`, which contains the authorized voters data.
    - `epoch`: An unsigned long representing the epoch for which the authorized voter is requested.
    - `existed`: Pointer to an integer that indicates whether the authorized voter already exists.
- **Logic and Control Flow**:
    - Initializes `*existed` to 0.
    - Queries the treap for an authorized voter corresponding to the specified `epoch`.
    - If the voter does not exist, iterates through the treap to find the latest authorized voter from previous epochs.
    - Updates `latest_epoch` and `res` if a valid previous voter is found.
    - Sets `*existed` to 1 if the voter exists, otherwise leaves it as 0.
- **Output**: Returns a pointer to the `fd_vote_authorized_voter_t` structure representing the authorized voter for the specified epoch.


---
### authorized\_voters\_get\_and\_cache\_authorized\_voter\_for\_epoch<!-- {{#callable:authorized_voters_get_and_cache_authorized_voter_for_epoch}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L318>)

Retrieves and caches an authorized voter for a specific epoch.
- **Inputs**:
    - `self`: Pointer to an instance of `fd_vote_authorized_voters_t`, representing the authorized voters.
    - `epoch`: An unsigned long integer representing the epoch for which the authorized voter is requested.
- **Logic and Control Flow**:
    - Calls [`authorized_voters_get_or_calculate_authorized_voter_for_epoch`](<#authorized_voters_get_or_calculate_authorized_voter_for_epoch>) to retrieve or calculate the authorized voter for the specified epoch.
    - Checks if the retrieved voter exists; if not, it proceeds to insert a new voter into the cache.
    - If the voter does not exist, it acquires a new element from the pool, sets its properties, and inserts it into the treap.
- **Output**: Returns a pointer to the `fd_vote_authorized_voter_t` representing the authorized voter for the specified epoch, or NULL if no voter is found.
- **Functions Called**:
    - [`authorized_voters_get_or_calculate_authorized_voter_for_epoch`](<#authorized_voters_get_or_calculate_authorized_voter_for_epoch>)


---
### landed\_votes\_from\_lockouts<!-- {{#callable:landed_votes_from_lockouts}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L347>)

Creates a list of landed votes from given lockouts.
- **Inputs**:
    - `lockouts`: Pointer to a `fd_vote_lockout_t` structure containing vote lockouts.
    - `spad`: Pointer to a `fd_spad_t` structure used for memory allocation.
- **Logic and Control Flow**:
    - Check if `lockouts` is NULL; if so, return NULL.
    - Count the number of lockouts using `deq_fd_vote_lockout_t_cnt`.
    - Determine the maximum count of lockouts, ensuring it does not exceed `MAX_LOCKOUT_HISTORY`.
    - Allocate memory for landed votes using `fd_spad_alloc`.
    - Create a new deque for landed votes using `deq_fd_landed_vote_t_new`.
    - Iterate through each lockout using `deq_fd_vote_lockout_t_iter_init`.
    - For each lockout, create a new landed vote and set its properties.
    - Push the new landed vote to the deque.
- **Output**: Returns a pointer to a `fd_landed_vote_t` structure containing the list of landed votes.


---
### is\_uninitialized<!-- {{#callable:is_uninitialized}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L379>)

Checks if the `fd_vote_state_versioned_t` structure is uninitialized based on its version.
- **Inputs**:
    - `self`: A pointer to a `fd_vote_state_versioned_t` structure that contains the vote state version information.
- **Logic and Control Flow**:
    - Evaluates the `discriminant` field of the `self` structure to determine the version of the vote state.
    - For version `fd_vote_state_versioned_enum_v0_23_5`, compares the `authorized_voter` field with a default `pubkey` initialized to zero.
    - For version `fd_vote_state_versioned_enum_v1_14_11` and `fd_vote_state_versioned_enum_current`, checks if the list of authorized voters is empty using the [`authorized_voters_is_empty`](<#authorized_voters_is_empty>) function.
    - Logs an error if the `discriminant` does not match any known version.
- **Output**: Returns 1 if the vote state is uninitialized, otherwise returns 0.
- **Functions Called**:
    - [`authorized_voters_is_empty`](<#authorized_voters_is_empty>)


---
### convert\_to\_current<!-- {{#callable:convert_to_current}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L397>)

Converts a versioned vote state to the current version based on its discriminant.
- **Inputs**:
    - `self`: Pointer to a `fd_vote_state_versioned_t` structure representing the vote state to convert.
    - `spad`: Pointer to a `fd_spad_t` structure used for memory allocation during the conversion.
- **Logic and Control Flow**:
    - Checks the `discriminant` field of the `self` structure to determine the version of the vote state.
    - If the version is `fd_vote_state_versioned_enum_v0_23_5`, it initializes a new `fd_vote_state_t` structure with values from the corresponding versioned state.
    - If the version is `fd_vote_state_versioned_enum_v1_14_11`, it initializes a new `fd_vote_state_t` structure with values from that versioned state.
    - If the version is `fd_vote_state_versioned_enum_current`, no action is taken.
    - If the version is unsupported, an error is logged.
- **Output**: The function does not return a value but updates the `self` structure to contain the current version of the vote state.
- **Functions Called**:
    - [`authorized_voters_new`](<#authorized_voters_new>)
    - [`landed_votes_from_lockouts`](<#landed_votes_from_lockouts>)


---
### vote\_state\_new<!-- {{#callable:vote_state_new}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L477>)

Initializes a new voting state based on provided initialization parameters.
- **Inputs**:
    - `vote_init`: Pointer to a `fd_vote_init_t` structure containing initialization data for the vote state.
    - `clock`: Pointer to a `fd_sol_sysvar_clock_t` structure providing the current epoch information.
    - `spad`: Pointer to a `fd_spad_t` structure used for memory allocation.
    - `vote_state`: Pointer to a `fd_vote_state_t` structure where the initialized vote state will be stored.
- **Logic and Control Flow**:
    - Sets the `node_pubkey` of `vote_state` from `vote_init`.
    - Calls [`authorized_voters_new`](<#authorized_voters_new>) to initialize the `authorized_voters` field of `vote_state` using the current epoch and the authorized voter from `vote_init`.
    - Sets the `authorized_withdrawer` and `commission` fields of `vote_state` from `vote_init`.
    - Initializes the `prior_voters` field of `vote_state` with default values.
- **Output**: The function does not return a value but initializes the `vote_state` structure with the new voting state.
- **Functions Called**:
    - [`authorized_voters_new`](<#authorized_voters_new>)


---
### verify\_authorized\_signer<!-- {{#callable:verify_authorized_signer}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L494>)

Verifies if the `authorized` public key is present in the `signers` array.
- **Inputs**:
    - `authorized`: A pointer to the `fd_pubkey_t` structure representing the authorized public key.
    - `signers`: An array of pointers to `fd_pubkey_t` structures representing the signers.
- **Logic and Control Flow**:
    - Calls the `fd_signers_contains` function with `signers` and `authorized` as arguments.
    - If `fd_signers_contains` returns true, the function returns `FD_EXECUTOR_INSTR_SUCCESS`.
    - If `fd_signers_contains` returns false, the function returns `FD_EXECUTOR_INSTR_ERR_MISSING_REQUIRED_SIGNATURE`.
- **Output**: Returns an integer indicating success or an error code.


---
### verify<!-- {{#callable:verify}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L504>)

Processes the verification of authorized signers for a voting operation.
- **Inputs**:
    - `epoch_authorized_voter`: Pointer to the public key of the authorized voter for the current epoch.
    - `authorized_withdrawer_signer`: Integer indicating if the authorized withdrawer is a signer (1 for true, 0 for false).
    - `signers`: Array of pointers to public keys representing the signers for the transaction.
- **Logic and Control Flow**:
    - Checks if the `authorized_withdrawer_signer` is true.
    - If true, returns 0 indicating successful verification.
    - If false, calls [`verify_authorized_signer`](<#verify_authorized_signer>) with `epoch_authorized_voter` and `signers`.
    - Returns the result of [`verify_authorized_signer`](<#verify_authorized_signer>).
- **Output**: Returns 0 if the authorized withdrawer is a signer; otherwise, returns the result of the [`verify_authorized_signer`](<#verify_authorized_signer>) function.
- **Functions Called**:
    - [`verify_authorized_signer`](<#verify_authorized_signer>)


---
### pop\_expired\_votes<!-- {{#callable:pop_expired_votes}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L515>)

Removes expired votes from the vote state.
- **Inputs**:
    - `self`: Pointer to the `fd_vote_state_t` structure representing the current vote state.
    - `next_vote_slot`: The slot number for the next vote, used to determine if votes are expired.
- **Logic and Control Flow**:
    - Enters a loop that continues until there are no votes left in the queue.
    - Peeks at the tail of the votes queue to get the most recent vote.
    - Checks if the vote is locked out at the specified `next_vote_slot`.
    - If the vote is not locked out, it removes the vote from the queue.
    - If the vote is locked out, it breaks the loop, stopping further removals.
- **Output**: The function does not return a value; it modifies the votes in place by removing expired votes.
- **Functions Called**:
    - [`is_locked_out_at_slot`](<#is_locked_out_at_slot>)


---
### double\_lockouts<!-- {{#callable:double_lockouts}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L528>)

Processes the lockout confirmation counts for each landed vote in the vote state.
- **Inputs**:
    - `self`: A pointer to the `fd_vote_state_t` structure representing the current vote state.
- **Logic and Control Flow**:
    - Retrieve the count of landed votes from `self->votes` and store it in `stack_depth`.
    - Initialize a loop to iterate over each landed vote using an iterator.
    - For each vote, check if the `stack_depth` is greater than the sum of the current index and the confirmation count of the vote.
    - If the condition is met, increment the confirmation count of the vote.
- **Output**: The function does not return a value but modifies the confirmation counts of the votes in the `fd_vote_state_t` structure.
- **Functions Called**:
    - [`increase_confirmation_count`](<#increase_confirmation_count>)


---
### compute\_vote\_latency<!-- {{#callable:compute_vote_latency}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L552>)

Computes the latency of a vote based on the slot voted for and the current slot.
- **Inputs**:
    - `voted_for_slot`: The slot number that was voted for.
    - `current_slot`: The current slot number.
- **Logic and Control Flow**:
    - Calculates the difference between `current_slot` and `voted_for_slot` using `fd_ulong_sat_sub`.
    - Ensures the result does not exceed `UCHAR_MAX` using `fd_ulong_min`.
- **Output**: Returns the computed latency as an unsigned char.


---
### credits\_for\_vote\_at\_index<!-- {{#callable:credits_for_vote_at_index}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L558>)

Calculates the credits awarded for a vote at a specific index based on latency.
- **Inputs**:
    - `self`: Pointer to the `fd_vote_state_t` structure representing the current vote state.
    - `index`: Index of the vote in the votes deque to evaluate.
- **Logic and Control Flow**:
    - Retrieve the landed vote at the specified `index` from the `votes` deque.
    - Check if the retrieved `landed_vote` is NULL; if so, set `latency` to 0.
    - Define `max_credits` as the maximum credits per slot.
    - If `latency` is 0, return 1 credit.
    - Calculate the difference between `latency` and `VOTE_CREDITS_GRACE_SLOTS`.
    - If the difference is non-positive or an underflow occurs, return `max_credits`.
    - Calculate the credits by subtracting the difference from `max_credits`.
    - If an underflow occurs or credits are zero, return 1 credit.
    - Return the calculated credits.
- **Output**: Returns the number of credits awarded for the vote at the specified index.


---
### increment\_credits<!-- {{#callable:increment_credits}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L591>)

Increments the credits for a specific epoch in the `fd_vote_state_t` structure.
- **Inputs**:
    - `self`: Pointer to a `fd_vote_state_t` structure that holds the vote state.
    - `epoch`: The epoch for which the credits are being incremented.
    - `credits`: The number of credits to add to the current total for the specified epoch.
- **Logic and Control Flow**:
    - Check if the `epoch_credits` deque is empty; if so, initialize it with the current epoch and zero credits.
    - If the deque is not empty, check if the provided epoch is different from the last epoch in the deque.
    - If the epoch is different, retrieve the last credits and previous credits from the deque.
    - If the last credits are not equal to previous credits, check if the deque has reached its maximum capacity.
    - If at capacity, remove the oldest entry from the deque before adding the new entry.
    - If the epoch is the same as the last one, update the epoch value in the last entry.
    - Finally, increment the credits for the last entry in the deque by the specified amount.
- **Output**: The function does not return a value; it modifies the `epoch_credits` deque in place.


---
### process\_next\_vote\_slot<!-- {{#callable:process_next_vote_slot}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L649>)

Processes the next vote slot in the voting state.
- **Inputs**:
    - `self`: Pointer to the current vote state.
    - `next_vote_slot`: The slot number for the next vote.
    - `epoch`: The current epoch number.
    - `current_slot`: The current slot number.
- **Logic and Control Flow**:
    - Check if the last voted slot is greater than or equal to the next vote slot; if so, return early.
    - Call [`pop_expired_votes`](<#pop_expired_votes>) to remove any expired votes from the state.
    - Compute the latency of the vote and create a new `landed_vote` structure.
    - If the number of landed votes reaches `MAX_LOCKOUT_HISTORY`, pop the oldest vote and update the root slot.
    - Push the new `landed_vote` to the votes deque.
    - Call [`double_lockouts`](<#double_lockouts>) to update the lockout counts for the votes.
- **Output**: No return value; modifies the vote state in place.
- **Functions Called**:
    - [`last_voted_slot`](<#last_voted_slot>)
    - [`pop_expired_votes`](<#pop_expired_votes>)
    - [`compute_vote_latency`](<#compute_vote_latency>)
    - [`credits_for_vote_at_index`](<#credits_for_vote_at_index>)
    - [`increment_credits`](<#increment_credits>)
    - [`double_lockouts`](<#double_lockouts>)


---
### get\_and\_update\_authorized\_voter<!-- {{#callable:get_and_update_authorized_voter}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L678>)

Retrieves and updates the authorized voter for the current epoch.
- **Inputs**:
    - `self`: Pointer to the `fd_vote_state_t` structure representing the current vote state.
    - `current_epoch`: The current epoch number to retrieve the authorized voter for.
    - `pubkey`: Pointer to a pointer where the public key of the authorized voter will be stored.
    - `ctx`: Pointer to the execution instruction context.
- **Logic and Control Flow**:
    - Calls [`authorized_voters_get_and_cache_authorized_voter_for_epoch`](<#authorized_voters_get_and_cache_authorized_voter_for_epoch>) to retrieve the authorized voter for the specified epoch.
    - Checks if the retrieved authorized voter is valid; if not, returns an error code.
    - Stores the public key of the authorized voter in the provided output pointer.
    - Calls [`authorized_voters_purge_authorized_voters`](<#authorized_voters_purge_authorized_voters>) to remove any expired authorized voters for the current epoch.
- **Output**: Returns `FD_EXECUTOR_INSTR_SUCCESS` on success or an error code if the operation fails.
- **Functions Called**:
    - [`authorized_voters_get_and_cache_authorized_voter_for_epoch`](<#authorized_voters_get_and_cache_authorized_voter_for_epoch>)
    - [`authorized_voters_purge_authorized_voters`](<#authorized_voters_purge_authorized_voters>)


---
### set\_new\_authorized\_voter<!-- {{#callable:set_new_authorized_voter}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L696>)

Sets a new authorized voter for a voting state.
- **Inputs**:
    - `self`: Pointer to the current voting state.
    - `authorized_pubkey`: Pointer to the public key of the new authorized voter.
    - `current_epoch`: The current epoch number.
    - `target_epoch`: The target epoch number for the new authorization.
    - `authorized_withdrawer_signer`: Indicates if the authorized withdrawer is a signer.
    - `signers`: Array of public keys of the signers.
    - `ctx`: Pointer to the execution instruction context.
- **Logic and Control Flow**:
    - Calls [`get_and_update_authorized_voter`](<#get_and_update_authorized_voter>) to retrieve and update the current authorized voter.
    - Verifies the current authorized voter against the provided signer.
    - Checks if the target epoch is too soon for reauthorization.
    - Retrieves the latest authorized voter and checks if the new authorized voter is different.
    - Updates the prior voters list if the new authorized voter is different.
    - Acquires a new authorized voter element from the pool and sets its properties.
    - Inserts the new authorized voter into the treap structure.
- **Output**: Returns 0 on success or an error code on failure.
- **Functions Called**:
    - [`get_and_update_authorized_voter`](<#get_and_update_authorized_voter>)
    - [`verify`](<#verify>)
    - [`authorized_voters_contains`](<#authorized_voters_contains>)
    - [`authorized_voters_last`](<#authorized_voters_last>)


---
### process\_timestamp<!-- {{#callable:process_timestamp}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L770>)

Processes a timestamp for a voting state.
- **Inputs**:
    - `self`: Pointer to the `fd_vote_state_t` structure representing the current voting state.
    - `slot`: An unsigned long representing the slot number associated with the timestamp.
    - `timestamp`: A long integer representing the timestamp to be processed.
    - `ctx`: Pointer to the execution instruction context containing transaction context.
- **Logic and Control Flow**:
    - Checks if the provided `slot` and `timestamp` are valid compared to the last recorded values.
    - If the new values are invalid, sets a custom error in the transaction context and returns an error code.
    - If valid, updates the last recorded `slot` and `timestamp` in the voting state.
- **Output**: Returns 0 on success or an error code if the timestamp is too old.


---
### set\_vote\_account\_state<!-- {{#callable:set_vote_account_state}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L794>)

Updates the state of a vote account based on the provided vote state.
- **Inputs**:
    - `vote_account`: Pointer to the `fd_borrowed_account_t` structure representing the vote account.
    - `vote_state`: Pointer to the `fd_vote_state_t` structure containing the new vote state.
    - `ctx`: Pointer to the `fd_exec_instr_ctx_t` structure containing execution context information.
- **Logic and Control Flow**:
    - Calculate the size of the versioned vote state using `size_of_versioned(1)`.
    - Read the rent information from the system variable cache.
    - Check if the vote account needs resizing based on its current data length.
    - Determine if the account is rent-exempt based on the required size.
    - If resizing is needed and the account is rent-exempt, attempt to resize the account.
    - If resizing fails or the account is not rent-exempt, convert the current vote state to an older version and set it.
    - If resizing is not needed or successful, create a new versioned state from the current vote state and set it.
- **Output**: Returns an integer indicating success or failure of the operation.
- **Functions Called**:
    - [`size_of_versioned`](<#size_of_versioned>)
    - [`from_vote_state_1_14_11`](<#from_vote_state_1_14_11>)
    - [`set_state`](<#set_state>)


---
### last\_lockout<!-- {{#callable:last_lockout}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L833>)

Returns the last lockout from the `fd_vote_state_t` structure.
- **Inputs**:
    - `self`: A pointer to an `fd_vote_state_t` structure that contains the vote state.
- **Logic and Control Flow**:
    - Checks if the `votes` deque in `self` is empty using `deq_fd_landed_vote_t_empty`.
    - If the deque is empty, returns `NULL`.
    - If not empty, retrieves the last vote using `deq_fd_landed_vote_t_peek_tail`.
    - Returns a pointer to the `lockout` field of the last vote.
- **Output**: Returns a pointer to the last `fd_vote_lockout_t` structure, or `NULL` if there are no votes.


---
### last\_voted\_slot<!-- {{#callable:last_voted_slot}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L841>)

Returns a pointer to the last voted slot in the vote state.
- **Inputs**:
    - `self`: A pointer to the `fd_vote_state_t` structure representing the current vote state.
- **Logic and Control Flow**:
    - Calls the [`last_lockout`](<#last_lockout>) function to retrieve the last lockout structure.
    - Checks if the last lockout is NULL using `FD_UNLIKELY`. If it is NULL, the function returns NULL.
    - If the last lockout is valid, it returns a pointer to the `slot` field of the last lockout.
- **Output**: A pointer to the `ulong` representing the last voted slot, or NULL if there is no last lockout.
- **Functions Called**:
    - [`last_lockout`](<#last_lockout>)


---
### contains\_slot<!-- {{#callable:contains_slot}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L849>)

Checks if a specific `slot` exists in the `vote_state`.
- **Inputs**:
    - `vote_state`: Pointer to a `fd_vote_state_t` structure that contains the current voting state.
    - `slot`: An unsigned long integer representing the slot number to check for existence.
- **Logic and Control Flow**:
    - Retrieve the count of votes in `vote_state` using `deq_fd_landed_vote_t_cnt`.
    - If the count is zero, return 0 indicating the slot does not exist.
    - Initialize a variable `base` to 0 for binary search.
    - While the size of votes is greater than 1, perform a binary search to find the position of the slot.
    - Calculate the midpoint and retrieve the slot at that index.
    - Adjust the `base` index based on the comparison of `slot` and `mid_slot`.
    - Reduce the size by half for the next iteration.
    - After exiting the loop, check if the slot at the `base` index matches the input `slot`.
- **Output**: Returns 1 if the `slot` exists in the `vote_state`, otherwise returns 0.


---
### check\_and\_filter\_proposed\_vote\_state<!-- {{#callable:check_and_filter_proposed_vote_state}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L869>)

Validates and filters the proposed vote state based on existing vote state and lockouts.
- **Inputs**:
    - `vote_state`: Pointer to the current vote state structure.
    - `proposed_lockouts`: Pointer to the proposed lockouts to be validated.
    - `proposed_has_root`: Pointer to a flag indicating if the proposed state has a root.
    - `proposed_root`: Pointer to the proposed root slot.
    - `proposed_hash`: Pointer to the proposed hash for the vote.
    - `slot_hashes`: Pointer to the deque of slot hashes.
    - `ctx`: Pointer to the execution context.
- **Logic and Control Flow**:
    - Check if proposed lockouts are empty; if so, set an error and return.
    - Retrieve the last vote from the current vote state if it exists.
    - If the last vote exists, check if the proposed lockout is older; if so, set an error and return.
    - Check if the slot hashes are empty; if so, set an error and return.
    - Check if the proposed vote is too old based on the slot hashes; if so, set an error and return.
    - If the proposed root exists, check if it is too old; if so, update the root based on existing votes.
    - Iterate through proposed lockouts and slot hashes to validate each proposed vote.
    - Filter out any proposed lockouts that do not match the slot history.
    - Check if the proposed hash matches the expected hash for the last slot; if not, set an error and return.
    - Return success if all checks pass.
- **Output**: Returns success if the proposed vote state is valid; otherwise, returns an error code.
- **Functions Called**:
    - [`contains_slot`](<#contains_slot>)


---
### check\_slots\_are\_valid<!-- {{#callable:check_slots_are_valid}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L1139>)

Validates the voting slots and their corresponding hashes against the current vote state.
- **Inputs**:
    - `vote_state`: Pointer to the current vote state structure of type `fd_vote_state_t`.
    - `vote_slots`: Pointer to an array of vote slots of type `ulong`.
    - `vote_hash`: Pointer to a hash of type `fd_hash_t` representing the expected hash for the vote.
    - `slot_hashes`: Pointer to a deque of slot hashes of type `fd_slot_hash_t`.
    - `ctx`: Pointer to the execution context of type `fd_exec_instr_ctx_t`.
- **Logic and Control Flow**:
    - Initialize index variables `i` for vote slots and `j` for slot hashes.
    - Loop while `i` is less than the length of `vote_slots` and `j` is greater than 0.
    - Check if the last voted slot is greater than or equal to the current vote slot.
    - If the current vote slot does not match the latest slot hash, decrement `j` and continue.
    - Increment `i` and decrement `j` when a valid slot is found.
    - After the loop, check if all slots were validated and if the final hash matches the expected hash.
- **Output**: Returns 0 if all checks pass, otherwise returns an error code indicating the type of validation failure.
- **Functions Called**:
    - [`last_voted_slot`](<#last_voted_slot>)


---
### process\_new\_vote\_state<!-- {{#callable:process_new_vote_state}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L1196>)

Processes a new vote state and updates the current vote state accordingly.
- **Inputs**:
    - `vote_state`: Pointer to the current vote state structure.
    - `new_state`: Pointer to the new landed vote state to be processed.
    - `has_new_root`: Flag indicating if there is a new root slot.
    - `new_root`: The new root slot value.
    - `has_timestamp`: Flag indicating if a timestamp is provided.
    - `timestamp`: The timestamp associated with the new vote state.
    - `epoch`: The current epoch value.
    - `current_slot`: The current slot value.
    - `ctx`: Pointer to the execution context.
- **Logic and Control Flow**:
    - Checks if the new state is empty and asserts it is not.
    - Validates the count of new votes against the maximum allowed.
    - Handles the case where a new root is provided and checks for rollback conditions.
    - Iterates through the new votes to validate their confirmation counts and order.
    - Accumulates credits for newly rooted slots based on the current vote state.
    - Sets the latency for new votes based on the current slot.
    - Updates the vote state with the new root and timestamp if applicable.
    - Removes all previous votes and replaces them with the new state.
- **Output**: Returns a status code indicating success or an error.
- **Functions Called**:
    - [`last_locked_out_slot`](<#last_locked_out_slot>)
    - [`credits_for_vote_at_index`](<#credits_for_vote_at_index>)
    - [`compute_vote_latency`](<#compute_vote_latency>)
    - [`increment_credits`](<#increment_credits>)
    - [`process_timestamp`](<#process_timestamp>)


---
### authorize<!-- {{#callable:authorize}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L1440>)

Processes authorization for a voting account.
- **Inputs**:
    - `vote_account`: Pointer to the `fd_borrowed_account_t` structure representing the voting account.
    - `authorized`: Pointer to the `fd_pubkey_t` structure containing the public key of the new authorized voter.
    - `vote_authorize`: Structure of type `fd_vote_authorize_t` indicating the type of authorization (voter or withdrawer).
    - `signers`: Array of pointers to `fd_pubkey_t` structures representing the signers for the transaction.
    - `clock`: Pointer to the `fd_sol_sysvar_clock_t` structure containing the current clock information.
    - `ctx`: Pointer to the `fd_exec_instr_ctx_t` structure containing execution context information.
- **Logic and Control Flow**:
    - Initialize return code `rc` to 0.
    - Retrieve the current state of the vote account using [`get_state`](<#get_state>).
    - Check for errors in retrieving the state; return error code if any.
    - Convert the vote state to the current version using [`convert_to_current`](<#convert_to_current>).
    - Switch based on the `discriminant` of `vote_authorize` to determine the type of authorization.
    - For voter authorization, verify if the signer is authorized and calculate the target epoch.
    - Set the new authorized voter using [`set_new_authorized_voter`](<#set_new_authorized_voter>) and check for errors.
    - For withdrawer authorization, verify the signer and update the authorized withdrawer.
    - Return the result of [`set_vote_account_state`](<#set_vote_account_state>) to update the vote account state.
- **Output**: Returns an integer indicating success or an error code.
- **Functions Called**:
    - [`get_state`](<#get_state>)
    - [`convert_to_current`](<#convert_to_current>)
    - [`verify_authorized_signer`](<#verify_authorized_signer>)
    - [`set_new_authorized_voter`](<#set_new_authorized_voter>)
    - [`set_vote_account_state`](<#set_vote_account_state>)


---
### update\_validator\_identity<!-- {{#callable:update_validator_identity}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L1504>)

Updates the identity of a validator in the voting system.
- **Inputs**:
    - `vote_account`: Pointer to a `fd_borrowed_account_t` structure representing the vote account.
    - `node_pubkey`: Pointer to a `fd_pubkey_t` structure containing the new node public key.
    - `signers`: Array of pointers to `fd_pubkey_t` structures representing the authorized signers.
    - `ctx`: Pointer to a `fd_exec_instr_ctx_t` structure containing execution context.
- **Logic and Control Flow**:
    - Initialize return code `rc` to 0.
    - Retrieve the current vote state using [`get_state`](<#get_state>) and check for errors.
    - Convert the retrieved state to the current version using [`convert_to_current`](<#convert_to_current>).
    - Verify if the `signers` include the authorized withdrawer using [`verify_authorized_signer`](<#verify_authorized_signer>).
    - Check if the `signers` include the new `node_pubkey` using [`verify_authorized_signer`](<#verify_authorized_signer>).
    - Update the `node_pubkey` in the vote state.
    - Set the updated vote state back to the account using [`set_vote_account_state`](<#set_vote_account_state>).
- **Output**: Returns 0 on success or an error code on failure.
- **Functions Called**:
    - [`get_state`](<#get_state>)
    - [`convert_to_current`](<#convert_to_current>)
    - [`verify_authorized_signer`](<#verify_authorized_signer>)
    - [`set_vote_account_state`](<#set_vote_account_state>)


---
### is\_commission\_update\_allowed<!-- {{#callable:is_commission_update_allowed}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L1535>)

Determines if a commission update is allowed based on the current slot and epoch schedule.
- **Inputs**:
    - `slot`: The current slot number.
    - `epoch_schedule`: A pointer to a structure containing the epoch schedule.
- **Logic and Control Flow**:
    - Checks if `slots_per_epoch` in `epoch_schedule` is greater than 0.
    - Calculates the `relative_slot` by subtracting `first_normal_slot` from `slot`.
    - Computes the modulo of `relative_slot` with `slots_per_epoch`.
    - Returns 1 if `relative_slot` multiplied by 2 is less than or equal to `slots_per_epoch`.
    - If `slots_per_epoch` is not greater than 0, returns 1.
- **Output**: Returns 1 if the commission update is allowed, otherwise returns 0.


---
### update\_commission<!-- {{#callable:update_commission}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L1548>)

Updates the commission rate for a voting account.
- **Inputs**:
    - `vote_account`: Pointer to the `fd_borrowed_account_t` structure representing the voting account.
    - `commission`: Unsigned character representing the new commission rate.
    - `signers`: Array of pointers to `fd_pubkey_t` representing the authorized signers.
    - `epoch_schedule`: Pointer to the `fd_epoch_schedule_t` structure containing epoch scheduling information.
    - `clock`: Pointer to the `fd_sol_sysvar_clock_t` structure providing the current clock information.
    - `ctx`: Pointer to the `fd_exec_instr_ctx_t` structure containing execution context.
- **Logic and Control Flow**:
    - Initialize return code `rc` to 0.
    - Retrieve the current vote state versioned structure using [`get_state`](<#get_state>).
    - If the retrieval is successful, convert the state to the current version.
    - Check if the new commission is greater than the current commission.
    - If the commission update is allowed, check if the update is within the allowed time frame using [`is_commission_update_allowed`](<#is_commission_update_allowed>).
    - If the vote state is not available, retrieve it again and convert it to the current version.
    - Verify that the signer is authorized to make the commission update.
    - Update the commission in the vote state.
    - Set the updated vote state back to the account using [`set_vote_account_state`](<#set_vote_account_state>).
- **Output**: Returns an integer indicating success or an error code.
- **Functions Called**:
    - [`get_state`](<#get_state>)
    - [`convert_to_current`](<#convert_to_current>)
    - [`is_commission_update_allowed`](<#is_commission_update_allowed>)
    - [`verify_authorized_signer`](<#verify_authorized_signer>)
    - [`set_vote_account_state`](<#set_vote_account_state>)


---
### withdraw<!-- {{#callable:withdraw}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L1598>)

Processes a withdrawal from a vote account.
- **Inputs**:
    - `ctx`: A constant pointer to the execution instruction context.
    - `vote_account`: A pointer to the borrowed account from which funds are withdrawn.
    - `lamports`: The amount of lamports to withdraw.
    - `to_account_index`: The index of the account to which the lamports are transferred.
    - `signers`: An array of public keys representing the signers for the transaction.
    - `rent_sysvar`: A pointer to the rent system variable.
    - `clock`: A pointer to the system clock variable.
- **Logic and Control Flow**:
    - Retrieve the current state of the vote account using [`get_state`](<#get_state>).
    - Convert the state to the current version using [`convert_to_current`](<#convert_to_current>).
    - Verify if the signer is authorized to withdraw using [`verify_authorized_signer`](<#verify_authorized_signer>).
    - Check if the requested withdrawal amount exceeds the available balance.
    - Calculate the remaining balance after the withdrawal.
    - If the remaining balance is zero, check if the account can be closed based on the last epoch with credits.
    - If the account cannot be closed, set the account state to a default state.
    - If the remaining balance is sufficient, check if it meets the minimum rent-exempt balance.
    - Subtract the lamports from the vote account using `fd_borrowed_account_checked_sub_lamports`.
    - Drop the borrowed account.
    - Add the lamports to the target account using `fd_borrowed_account_checked_add_lamports`.
- **Output**: Returns 0 on success or an error code on failure.
- **Functions Called**:
    - [`get_state`](<#get_state>)
    - [`convert_to_current`](<#convert_to_current>)
    - [`verify_authorized_signer`](<#verify_authorized_signer>)
    - [`set_vote_account_state`](<#set_vote_account_state>)


---
### process\_vote\_unfiltered<!-- {{#callable:process_vote_unfiltered}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L1684>)

Processes unfiltered votes by validating slots and updating the vote state.
- **Inputs**:
    - `vote_state`: Pointer to the current vote state structure.
    - `vote_slots`: Array of vote slots to be processed.
    - `vote`: Pointer to the vote structure containing vote details.
    - `slot_hashes`: Pointer to a deque of slot hashes for validation.
    - `epoch`: Current epoch number.
    - `current_slot`: Current slot number.
    - `ctx`: Pointer to the execution context.
- **Logic and Control Flow**:
    - Calls [`check_slots_are_valid`](<#check_slots_are_valid>) to validate the provided vote slots against the current vote state and slot hashes.
    - If validation fails, returns the error code from [`check_slots_are_valid`](<#check_slots_are_valid>).
    - Iterates over each slot in `vote_slots` using a deque iterator.
    - For each slot, calls [`process_next_vote_slot`](<#process_next_vote_slot>) to update the vote state with the current slot, epoch, and current slot.
- **Output**: Returns 0 on success or an error code if any validation fails.
- **Functions Called**:
    - [`check_slots_are_valid`](<#check_slots_are_valid>)
    - [`process_next_vote_slot`](<#process_next_vote_slot>)


---
### process\_vote<!-- {{#callable:process_vote}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L1707>)

Processes a vote by validating and filtering the vote slots.
- **Inputs**:
    - `vote_state`: Pointer to the current state of the vote.
    - `vote`: Pointer to the vote structure containing slots.
    - `slot_hashes`: Pointer to a deque of slot hashes.
    - `epoch`: Current epoch number.
    - `current_slot`: Current slot number.
    - `ctx`: Pointer to the execution context.
- **Logic and Control Flow**:
    - Check if the `vote->slots` deque is empty; if so, set a custom error and return an error code.
    - Determine the earliest slot in history from `slot_hashes` if it is not empty.
    - Allocate memory for the vote slots and join the slots from `vote->slots` into a new array.
    - Iterate through the slots in `vote->slots`, filtering out any slots that are older than the earliest slot in history.
    - If no valid slots remain after filtering, set a custom error and return an error code.
    - Call [`process_vote_unfiltered`](<#process_vote_unfiltered>) with the filtered vote slots and other parameters.
- **Output**: Returns the result of the [`process_vote_unfiltered`](<#process_vote_unfiltered>) function, which processes the valid vote slots.
- **Functions Called**:
    - [`process_vote_unfiltered`](<#process_vote_unfiltered>)


---
### initialize\_account<!-- {{#callable:initialize_account}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L1751>)

Initializes a voting account with the provided parameters.
- **Inputs**:
    - `vote_account`: Pointer to the `fd_borrowed_account_t` structure representing the voting account to be initialized.
    - `vote_init`: Pointer to the `fd_vote_init_t` structure containing initialization parameters for the vote account.
    - `signers`: Array of pointers to `fd_pubkey_t` representing the authorized signers for the transaction.
    - `clock`: Pointer to the `fd_sol_sysvar_clock_t` structure providing the current system clock information.
    - `ctx`: Pointer to the `fd_exec_instr_ctx_t` structure containing execution context and feature set.
- **Logic and Control Flow**:
    - Retrieve the data length of the `vote_account` using `fd_borrowed_account_get_data_len`.
    - Check if the data length matches the expected size using [`size_of_versioned`](<#size_of_versioned>).
    - If the data length is incorrect, return an error code `FD_EXECUTOR_INSTR_ERR_INVALID_ACC_DATA`.
    - Get the current state of the vote account using [`get_state`](<#get_state>).
    - If an error occurs while retrieving the state, return the error code.
    - Check if the account is uninitialized using [`is_uninitialized`](<#is_uninitialized>).
    - If the account is already initialized, return an error code `FD_EXECUTOR_INSTR_ERR_ACC_ALREADY_INITIALIZED`.
    - Verify the authorized signer using [`verify_authorized_signer`](<#verify_authorized_signer>).
    - If the signer verification fails, return the corresponding error code.
    - Reset the vote state object using `fd_vote_state_versioned_new`.
    - Initialize the vote state with the provided parameters using [`vote_state_new`](<#vote_state_new>).
    - Set the new state of the vote account using [`set_vote_account_state`](<#set_vote_account_state>).
- **Output**: Returns an integer indicating success or an error code.
- **Functions Called**:
    - [`size_of_versioned`](<#size_of_versioned>)
    - [`get_state`](<#get_state>)
    - [`is_uninitialized`](<#is_uninitialized>)
    - [`verify_authorized_signer`](<#verify_authorized_signer>)
    - [`vote_state_new`](<#vote_state_new>)
    - [`set_vote_account_state`](<#set_vote_account_state>)


---
### verify\_and\_get\_vote\_state<!-- {{#callable:verify_and_get_vote_state}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L1798>)

Verifies the vote account state and retrieves the current vote state.
- **Inputs**:
    - `vote_account`: Pointer to a `fd_borrowed_account_t` structure representing the vote account.
    - `clock`: Pointer to a `fd_sol_sysvar_clock_t` structure containing the current clock information.
    - `signers`: Array of pointers to `fd_pubkey_t` representing the signers for the transaction.
    - `vote_state`: Pointer to an output `fd_vote_state_t` structure where the current vote state will be stored.
    - `ctx`: Pointer to a `fd_exec_instr_ctx_t` structure providing execution context.
- **Logic and Control Flow**:
    - Initialize return code `rc` to 0.
    - Call [`get_state`](<#get_state>) to retrieve the versioned vote state from the `vote_account`.
    - If [`get_state`](<#get_state>) returns an error, return the error code.
    - Check if the retrieved state is uninitialized; if so, return an error code for uninitialized account.
    - Convert the versioned state to the current format and store it in `vote_state`.
    - Call [`get_and_update_authorized_voter`](<#get_and_update_authorized_voter>) to retrieve the authorized voter for the current epoch.
    - If this call returns an error, return the error code.
    - Call [`verify_authorized_signer`](<#verify_authorized_signer>) to check if the authorized voter is among the signers.
    - If this call returns an error, return the error code.
    - Return success code.
- **Output**: Returns `FD_EXECUTOR_INSTR_SUCCESS` on success, or an error code indicating the type of failure.
- **Functions Called**:
    - [`get_state`](<#get_state>)
    - [`is_uninitialized`](<#is_uninitialized>)
    - [`convert_to_current`](<#convert_to_current>)
    - [`get_and_update_authorized_voter`](<#get_and_update_authorized_voter>)
    - [`verify_authorized_signer`](<#verify_authorized_signer>)


---
### process\_vote\_with\_account<!-- {{#callable:process_vote_with_account}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L1833>)

Processes a vote using the provided account and updates the vote state.
- **Inputs**:
    - `vote_account`: Pointer to a `fd_borrowed_account_t` structure representing the account that holds the vote.
    - `slot_hashes`: Pointer to a constant `fd_slot_hash_t` structure representing the deque of slot hashes.
    - `clock`: Pointer to a constant `fd_sol_sysvar_clock_t` structure representing the current clock time.
    - `vote`: Pointer to a `fd_vote_t` structure containing the vote details.
    - `signers`: Array of pointers to `fd_pubkey_t` representing the signers for the transaction.
    - `ctx`: Pointer to a constant `fd_exec_instr_ctx_t` structure representing the execution context.
- **Logic and Control Flow**:
    - Calls [`verify_and_get_vote_state`](<#verify_and_get_vote_state>) to validate the vote account and retrieve the current vote state.
    - If the verification fails, returns the error code.
    - Calls [`process_vote`](<#process_vote>) to apply the vote to the current vote state.
    - If the processing fails, returns the error code.
    - Checks if the vote has a timestamp; if so, processes the timestamp.
    - If the timestamp processing fails, returns the error code.
    - Calls [`set_vote_account_state`](<#set_vote_account_state>) to update the vote account with the new vote state.
- **Output**: Returns an integer indicating the success or failure of the operation.
- **Functions Called**:
    - [`verify_and_get_vote_state`](<#verify_and_get_vote_state>)
    - [`process_vote`](<#process_vote>)
    - [`process_timestamp`](<#process_timestamp>)
    - [`set_vote_account_state`](<#set_vote_account_state>)


---
### do\_process\_vote\_state\_update<!-- {{#callable:do_process_vote_state_update}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L1881>)

Processes updates to the vote state based on proposed changes.
- **Inputs**:
    - `vote_state`: Pointer to the current vote state structure.
    - `slot_hashes`: Pointer to a deque of slot hashes.
    - `epoch`: Current epoch number.
    - `slot`: Current slot number.
    - `vote_state_update`: Pointer to the structure containing updates to the vote state.
    - `ctx`: Pointer to the execution context containing feature set information.
- **Logic and Control Flow**:
    - Calls [`check_and_filter_proposed_vote_state`](<#check_and_filter_proposed_vote_state>) to validate the proposed updates.
    - Allocates memory for the new landed votes based on the proposed lockouts.
    - Iterates through the proposed lockouts to populate the new landed votes.
    - Calls [`process_new_vote_state`](<#process_new_vote_state>) to apply the updates to the current vote state.
- **Output**: Returns an integer indicating success or an error code.
- **Functions Called**:
    - [`check_and_filter_proposed_vote_state`](<#check_and_filter_proposed_vote_state>)
    - [`process_new_vote_state`](<#process_new_vote_state>)


---
### process\_vote\_state\_update<!-- {{#callable:process_vote_state_update}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L1925>)

Processes updates to the vote state of a voting account.
- **Inputs**:
    - `vote_account`: Pointer to the `fd_borrowed_account_t` structure representing the vote account.
    - `slot_hashes`: Pointer to an array of `fd_slot_hash_t` representing the hashes of slots.
    - `clock`: Pointer to `fd_sol_sysvar_clock_t` structure containing the current clock information.
    - `vote_state_update`: Pointer to `fd_vote_state_update_t` structure containing the updates to apply.
    - `signers`: Array of pointers to `fd_pubkey_t` representing the signers of the transaction.
    - `ctx`: Pointer to `fd_exec_instr_ctx_t` structure containing execution context.
- **Logic and Control Flow**:
    - Checks if the bank hash comparison context is available and processes the bank hash if it is.
    - Locks the vote states and retrieves the current vote state for the specified account.
    - Verifies the vote state and checks for errors.
    - Processes the vote state update by calling [`do_process_vote_state_update`](<#do_process_vote_state_update>).
    - Sets the updated vote state back to the account.
- **Output**: Returns an integer indicating success or an error code.
- **Functions Called**:
    - [`verify_and_get_vote_state`](<#verify_and_get_vote_state>)
    - [`do_process_vote_state_update`](<#do_process_vote_state_update>)
    - [`set_vote_account_state`](<#set_vote_account_state>)


---
### do\_process\_tower\_sync<!-- {{#callable:do_process_tower_sync}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L1990>)

Processes the synchronization of tower state with the current vote state.
- **Inputs**:
    - `vote_state`: Pointer to the current vote state structure.
    - `slot_hashes`: Pointer to a deque of slot hashes.
    - `epoch`: The current epoch number.
    - `slot`: The current slot number.
    - `tower_sync`: Pointer to the tower synchronization structure.
    - `ctx`: Pointer to the execution instruction context.
- **Logic and Control Flow**:
    - Calls [`check_and_filter_proposed_vote_state`](<#check_and_filter_proposed_vote_state>) to validate the proposed vote state against the current state.
    - If the validation fails, returns the error immediately.
    - Begins a stack frame for memory allocation.
    - Calls [`process_new_vote_state`](<#process_new_vote_state>) to update the vote state with the new tower synchronization data.
    - Returns any error from the processing function.
- **Output**: Returns an integer indicating success or an error code.
- **Functions Called**:
    - [`check_and_filter_proposed_vote_state`](<#check_and_filter_proposed_vote_state>)
    - [`process_new_vote_state`](<#process_new_vote_state>)
    - [`landed_votes_from_lockouts`](<#landed_votes_from_lockouts>)


---
### process\_tower\_sync<!-- {{#callable:process_tower_sync}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L2026>)

Processes synchronization of vote state with tower data.
- **Inputs**:
    - `vote_account`: Pointer to a `fd_borrowed_account_t` structure representing the vote account.
    - `slot_hashes`: Pointer to a constant `fd_slot_hash_t` structure representing the deque of slot hashes.
    - `clock`: Pointer to a constant `fd_sol_sysvar_clock_t` structure representing the current clock state.
    - `tower_sync`: Pointer to a `fd_tower_sync_t` structure containing synchronization data.
    - `signers`: Array of pointers to constant `fd_pubkey_t` structures representing the signers.
    - `ctx`: Pointer to a constant `fd_exec_instr_ctx_t` structure representing the execution context.
- **Logic and Control Flow**:
    - Checks if the bank hash comparison context is available and processes the lockouts if not empty.
    - Verifies and retrieves the current vote state from the vote account.
    - Processes the tower synchronization using the retrieved vote state and provided slot hashes.
    - Updates the vote account state with the new vote state after processing.
- **Output**: Returns an integer indicating success or an error code.
- **Functions Called**:
    - [`verify_and_get_vote_state`](<#verify_and_get_vote_state>)
    - [`do_process_tower_sync`](<#do_process_tower_sync>)
    - [`set_vote_account_state`](<#set_vote_account_state>)


---
### fd\_vote\_commission\_split<!-- {{#callable:fd_vote_commission_split}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L2129>)

Calculates the split of a commission between voters and stakers.
- **Inputs**:
    - `commission`: The percentage of commission to be split, represented as an unsigned character.
    - `on`: The total amount to be split, represented as an unsigned long.
    - `result`: A pointer to a `fd_commission_split_t` structure that will hold the output values.
- **Logic and Control Flow**:
    - Limits the `commission` value to a maximum of 100 using `fd_uint_min`.
    - Determines if the commission is split by checking if it is neither 0 nor 100.
    - If the commission is 0, sets the `voter_portion` to 0 and the `staker_portion` to `on`.
    - If the commission is 100, sets the `voter_portion` to `on` and the `staker_portion` to 0.
    - For other commission values, calculates the `voter_portion` and `staker_portion` based on the commission percentage.
- **Output**: The function populates the `result` structure with the calculated `voter_portion`, `staker_portion`, and a boolean indicating if the commission was split.


---
### process\_authorize\_with\_seed\_instruction<!-- {{#callable:process_authorize_with_seed_instruction}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L2171>)

Processes the authorization of a vote account using a derived key and seed.
- **Inputs**:
    - `ctx`: A pointer to the execution context containing instruction and transaction details.
    - `vote_account`: A pointer to the account being authorized.
    - `new_authority`: A pointer to the public key of the new authority.
    - `authorization_type`: The type of authorization being requested.
    - `current_authority_derived_key_owner`: A pointer to the public key of the current authority's derived key owner.
    - `current_authority_derived_key_seed`: A pointer to the seed used to derive the current authority's key.
    - `current_authority_derived_key_seed_len`: The length of the seed used for key derivation.
- **Logic and Control Flow**:
    - Check if the required system variable account is present using `fd_sysvar_instr_acct_check`.
    - Read the current clock state from the system variable cache.
    - Check if the instruction has at least three accounts.
    - If the third account is a signer, retrieve its public key.
    - Create a new public key using the seed and base public key.
    - Call the [`authorize`](<#authorize>) function to perform the authorization with the new authority.
- **Output**: Returns an integer indicating success or an error code.
- **Functions Called**:
    - [`authorize`](<#authorize>)


---
### fd\_vote\_program\_execute<!-- {{#callable:fd_vote_program_execute}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L2231>)

Executes the voting program based on the provided execution context.
- **Inputs**:
    - `ctx`: Pointer to the execution instruction context of type `fd_exec_instr_ctx_t`.
- **Logic and Control Flow**:
    - Initializes the return code to `FD_EXECUTOR_INSTR_SUCCESS`.
    - Updates compute units for the execution context.
    - Checks if the account count in the instruction is less than 1, returning an error if true.
    - Attempts to borrow the first account from the context, handling errors appropriately.
    - Checks if the owner of the borrowed account matches the expected program ID.
    - Retrieves the signers from the execution context.
    - Checks if the instruction data is NULL, returning an error if true.
    - Decodes the instruction data into a `fd_vote_instruction_t` structure.
    - Processes the instruction based on its discriminant using a switch-case structure, handling various vote-related operations.
- **Output**: Returns an integer indicating the success or failure of the execution.
- **Functions Called**:
    - [`initialize_account`](<#initialize_account>)
    - [`authorize`](<#authorize>)
    - [`process_authorize_with_seed_instruction`](<#process_authorize_with_seed_instruction>)
    - [`update_validator_identity`](<#update_validator_identity>)
    - [`update_commission`](<#update_commission>)
    - [`process_vote_with_account`](<#process_vote_with_account>)
    - [`process_vote_state_update`](<#process_vote_state_update>)
    - [`fd_vote_decode_compact_update`](<#fd_vote_decode_compact_update>)
    - [`process_tower_sync`](<#process_tower_sync>)
    - [`withdraw`](<#withdraw>)


---
### fd\_vote\_state\_versions\_is\_correct\_and\_initialized<!-- {{#callable:fd_vote_state_versions_is_correct_and_initialized}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L2781>)

Checks if the vote state versions in the `vote_account` are correct and initialized.
- **Inputs**:
    - `vote_account`: Pointer to a `fd_txn_account_t` structure representing the vote account.
- **Logic and Control Flow**:
    - Retrieve the data length of the `vote_account` and check if it matches `FD_VOTE_STATE_V3_SZ`.
    - Create a zeroed array `test_data` of size `DEFAULT_PRIOR_VOTERS_OFFSET`.
    - Compare the data in `vote_account` at the offset `VERSION_OFFSET` with `test_data`.
    - If both the data length check and the data comparison are true, return 1.
    - Check if the data length matches `FD_VOTE_STATE_V2_SZ` and create another zeroed array `test_data_1_14_11`.
    - Compare the data in `vote_account` at the offset `VERSION_OFFSET` with `test_data_1_14_11`.
    - Return the result of the data comparison and length check.
- **Output**: Returns 1 if the vote state versions are correct and initialized, otherwise returns 0.


---
### fd\_vote\_get\_state<!-- {{#callable:fd_vote_get_state}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L2801>)

Retrieves the current vote state from a transaction account.
- **Inputs**:
    - `self`: Pointer to a constant `fd_txn_account_t` structure representing the transaction account.
    - `spad`: Pointer to a `fd_spad_t` structure used for memory allocation.
    - `versioned`: Pointer to a pointer that will hold the output of type `fd_vote_state_versioned_t`.
- **Logic and Control Flow**:
    - Initialize an error variable `err` to 0.
    - Call [`get_state`](<#get_state>) with `self`, `spad`, and the address of `err` to retrieve the vote state.
    - Assign the result of [`get_state`](<#get_state>) to `*versioned`.
    - Return the error code `err`.
- **Output**: Returns an integer error code indicating success or failure of the operation.
- **Functions Called**:
    - [`get_state`](<#get_state>)


---
### fd\_vote\_convert\_to\_current<!-- {{#callable:fd_vote_convert_to_current}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L2810>)

Converts a versioned vote state to the current version.
- **Inputs**:
    - `self`: Pointer to a `fd_vote_state_versioned_t` structure representing the vote state to be converted.
    - `spad`: Pointer to a `fd_spad_t` structure used for memory allocation during the conversion.
- **Logic and Control Flow**:
    - Calls the [`convert_to_current`](<#convert_to_current>) function with the provided `self` and `spad` arguments to perform the conversion.
- **Output**: The function does not return a value; it modifies the `self` structure in place to represent the current version of the vote state.
- **Functions Called**:
    - [`convert_to_current`](<#convert_to_current>)


---
### fd\_vote\_store\_account<!-- {{#callable:fd_vote_store_account}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L2816>)

Stores the voting account state in the bank.
- **Inputs**:
    - `vote_account`: Pointer to the `fd_txn_account_t` structure representing the voting account.
    - `bank`: Pointer to the `fd_bank_t` structure representing the bank.
- **Logic and Control Flow**:
    - Locks the vote states for modification using `fd_bank_vote_states_locking_modify`.
    - Checks if the lamports in `vote_account` are zero; if so, removes the account from vote states and ends the lock.
    - Validates if the vote state version is correct and initialized; if not, removes the account from vote states and ends the lock.
    - Updates the vote states from the account data using `fd_vote_states_update_from_account`.
    - Ends the lock on the vote states.
- **Output**: No return value; modifies the state of the bank and vote states based on the account data.
- **Functions Called**:
    - [`fd_vote_state_versions_is_correct_and_initialized`](<#fd_vote_state_versions_is_correct_and_initialized>)


# Function Declarations (Public API)

---
### last\_voted\_slot<!-- {{#callable_declaration:last_voted_slot}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_vote_program.c#L645>)

Returns the last voted slot from the vote state.
- **Description**: Use this function to get a pointer to the last voted slot in the given vote state. It is useful when you need to access or modify the last slot that was voted on. Ensure that the vote state is properly initialized and contains at least one vote before calling this function. If the vote state has no votes, the function returns `NULL`, indicating that there is no last voted slot available.
- **Inputs**:
    - `self`: A pointer to a `fd_vote_state_t` structure representing the vote state. The vote state must be initialized and may contain votes. The caller retains ownership and must ensure the pointer is valid.
- **Output**: A pointer to an `ulong` representing the last voted slot, or `NULL` if there are no votes in the vote state.
- **See Also**: [`last_voted_slot`](<#last_voted_slot>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)