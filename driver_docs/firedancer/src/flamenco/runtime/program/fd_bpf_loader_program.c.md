<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for deploying, executing, and managing BPF programs in the Firedancer runtime.

# Purpose
The code is a C implementation of a BPF (Berkeley Packet Filter) loader program for the Solana blockchain. It provides functionality for deploying, managing, and executing BPF programs within the Solana runtime environment. The code includes functions for handling various program instructions, such as deploying programs, writing program data, setting authorities, and closing accounts. It also includes error handling and logging mechanisms to ensure proper execution and debugging.

The main components of the code include functions like [`fd_deploy_program`](<#fd_deploy_program>), which handles the deployment of BPF programs, and [`fd_bpf_loader_program_execute`](<#fd_bpf_loader_program_execute>), which executes the BPF programs. The code also defines several helper functions for managing program states, handling errors, and interacting with the Solana runtime environment. The code is structured to support the upgradeable loader program, allowing for program upgrades and authority management. It interfaces with various Solana-specific data structures and utilities, such as `fd_exec_instr_ctx_t` and `fd_bpf_upgradeable_loader_state_t`, to manage program execution and state transitions.
# Imports and Dependencies

---
- `fd_bpf_loader_program.h`
- `../../progcache/fd_prog_load.h`
- `../fd_pubkey_utils.h`
- `../../../ballet/sbpf/fd_sbpf_loader.h`
- `../sysvar/fd_sysvar.h`
- `fd_bpf_loader_serialization.h`
- `fd_builtin_programs.h`
- `fd_native_cpi.h`
- `../fd_borrowed_account.h`
- `../fd_system_ids.h`


# Functions

---
### program\_error\_to\_instr\_error<!-- {{#callable:program_error_to_instr_error}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_bpf_loader_program.c#L16>)

Maps a program error code to an instruction error code, optionally setting a custom error code.
- **Inputs**:
    - ``err``: An unsigned long integer representing the program error code.
    - ``custom_err``: A pointer to an unsigned integer where a custom error code may be stored.
- **Logic and Control Flow**:
    - Checks the value of `err` against predefined error codes using a `switch` statement.
    - For `CUSTOM_ZERO`, sets `*custom_err` to 0 and returns `FD_EXECUTOR_INSTR_ERR_CUSTOM_ERR`.
    - For each predefined error code, returns a corresponding instruction error code without modifying `*custom_err`.
    - If `err` does not match any predefined error code, checks if the high bits of `err` are zero using a bit shift operation.
    - If the high bits are zero, sets `*custom_err` to `err` and returns `FD_EXECUTOR_INSTR_ERR_CUSTOM_ERR`.
    - If none of the conditions are met, returns `FD_EXECUTOR_INSTR_ERR_INVALID_ERR`.
- **Output**: An integer representing the mapped instruction error code.


---
### calculate\_heap\_cost<!-- {{#callable:calculate_heap_cost}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_bpf_loader_program.c#L83>)

Calculates the cost of a heap based on its size and a cost multiplier.
- **Inputs**:
    - `heap_size`: The initial size of the heap in bytes.
    - `heap_cost`: The cost multiplier for the heap.
- **Logic and Control Flow**:
    - Defines constants `KIBIBYTE_MUL_PAGES` as 32768 and `KIBIBYTE_MUL_PAGES_SUB_1` as 32767.
    - Adds `KIBIBYTE_MUL_PAGES_SUB_1` to `heap_size` using `fd_ulong_sat_add`.
    - Divides the adjusted `heap_size` by `KIBIBYTE_MUL_PAGES`, subtracts 1, and multiplies the result by `heap_cost` using `fd_ulong_sat_mul`.
    - Returns the calculated heap cost.
- **Output**: The function returns the calculated heap cost as an unsigned long integer.


---
### fd\_deploy\_program<!-- {{#callable:fd_deploy_program}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_bpf_loader_program.c#L117>)

Deploys a program by setting up the execution environment, loading, validating, and queuing the program for reverification.
- **Inputs**:
    - ``instr_ctx``: A pointer to the instruction context (`fd_exec_instr_ctx_t`) which contains transaction context and other execution details.
    - ``program_key``: A constant pointer to the public key (`fd_pubkey_t`) of the program to be deployed.
    - ``programdata``: A constant pointer to the program data (`uchar`) to be deployed.
    - ``programdata_size``: The size (`ulong`) of the program data.
    - ``spad``: A pointer to the scratchpad (`fd_spad_t`) used for memory allocations during deployment.
- **Logic and Control Flow**:
    - Initialize deployment mode and feature flags for direct mapping and stricter ABI/runtime constraints.
    - Allocate and register system calls using `fd_sbpf_syscalls_new` and `fd_vm_syscall_register_slot`.
    - Load the executable by peeking into the ELF data using `fd_sbpf_elf_peek` and configure loader settings.
    - Allocate memory for read-only data and the program buffer using `fd_spad_alloc`.
    - Create a new program instance with `fd_sbpf_program_new` and load the program using `fd_sbpf_program_load`.
    - Initialize a virtual machine (`fd_vm_t`) and configure it with program and execution context details.
    - Validate the program using `fd_vm_validate` to ensure it meets execution requirements.
    - Queue the program for reverification by adding its key to the `programs_to_reverify` list in the transaction context.
    - Return success or appropriate error codes based on the success of each step.
- **Output**: Returns an integer status code indicating success (`FD_EXECUTOR_INSTR_SUCCESS`) or specific error codes for various failure scenarios.


---
### write\_program\_data<!-- {{#callable:write_program_data}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_bpf_loader_program.c#L222>)

Writes a specified number of bytes to a program's data section at a given offset, ensuring no overflow occurs.
- **Inputs**:
    - `instr_ctx`: A pointer to the `fd_exec_instr_ctx_t` structure, which provides the execution context for the instruction.
    - `instr_acc_idx`: An unsigned short representing the index of the instruction account to access.
    - `program_data_offset`: An unsigned long indicating the offset within the program's data section where writing begins.
    - `bytes`: A pointer to an array of unsigned characters representing the data to write.
    - `bytes_len`: An unsigned long specifying the length of the data to write.
- **Logic and Control Flow**:
    - Initialize a `fd_guarded_borrowed_account_t` structure for the program and check for errors using `FD_TRY_BORROW_INSTR_ACCOUNT_DEFAULT_ERR_CHECK` macro.
    - Retrieve a mutable pointer to the program's data and its length using `fd_borrowed_account_get_data_mut`.
    - Calculate the write offset by adding `program_data_offset` and `bytes_len` using `fd_ulong_sat_add`.
    - Check if the calculated write offset exceeds the program's data length; if so, log an overflow error and return `FD_EXECUTOR_INSTR_ERR_ACC_DATA_TOO_SMALL`.
    - Verify that `program_data_offset` is within the bounds of the data length; if not, return `FD_EXECUTOR_INSTR_ERR_ACC_DATA_TOO_SMALL`.
    - If `bytes_len` is non-zero, copy the data from `bytes` to the program's data at the specified offset using `fd_memcpy`.
    - Return `FD_EXECUTOR_INSTR_SUCCESS` to indicate successful execution.
- **Output**: Returns an integer status code: `FD_EXECUTOR_INSTR_SUCCESS` on success, or an error code if an error occurs during execution.


---
### fd\_bpf\_loader\_program\_get\_state<!-- {{#callable:fd_bpf_loader_program_get_state}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_bpf_loader_program.c#L261>)

Retrieves the state of a BPF loader program from a transaction account and optionally sets an error code.
- **Inputs**:
    - ``acct``: A pointer to a `fd_txn_account_t` structure representing the transaction account from which to retrieve the program state.
    - ``spad``: A pointer to a `fd_spad_t` structure used for decoding the program state.
    - ``opt_err``: An optional pointer to an integer where the function can store an error code if an error occurs during state retrieval.
- **Logic and Control Flow**:
    - Call `fd_bincode_decode_spad` to decode the program state from the transaction account data using the provided `spad` and store the result in `res`.
    - Check if `opt_err` is not null; if so, set the value pointed to by `opt_err` to `FD_EXECUTOR_INSTR_ERR_INVALID_ACC_DATA` if an error occurred, or `FD_EXECUTOR_INSTR_SUCCESS` if successful.
    - Return `NULL` if an error occurred during decoding, otherwise return the decoded program state `res`.
- **Output**: A pointer to a `fd_bpf_upgradeable_loader_state_t` structure representing the program state, or `NULL` if an error occurred.


---
### fd\_bpf\_loader\_v3\_program\_set\_state<!-- {{#callable:fd_bpf_loader_v3_program_set_state}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_bpf_loader_program.c#L282>)

Sets the state of a borrowed account to a given BPF upgradeable loader state.
- **Inputs**:
    - ``borrowed_acct``: A pointer to an `fd_borrowed_account_t` structure representing the account whose state is to be set.
    - ``state``: A pointer to an `fd_bpf_upgradeable_loader_state_t` structure representing the new state to set for the account.
- **Logic and Control Flow**:
    - Calculate the size of the `state` using `fd_bpf_upgradeable_loader_state_size` function.
    - Initialize `data` and `dlen` to `NULL` and `0UL`, respectively.
    - Call `fd_borrowed_account_get_data_mut` to get mutable access to the account's data and its length.
    - If the function returns an error, return the error code.
    - Check if `state_size` is greater than `dlen`; if true, return `FD_EXECUTOR_INSTR_ERR_ACC_DATA_TOO_SMALL`.
    - Initialize a `fd_bincode_encode_ctx_t` structure with `data` and `data + state_size`.
    - Call `fd_bpf_upgradeable_loader_state_encode` to encode the `state` into the context.
    - If encoding fails, return `FD_EXECUTOR_INSTR_ERR_GENERIC_ERR`.
    - Return `FD_BINCODE_SUCCESS` if all operations succeed.
- **Output**: Returns an integer status code indicating success (`FD_BINCODE_SUCCESS`) or an error code if an operation fails.


---
### common\_close\_account<!-- {{#callable:common_close_account}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_bpf_loader_program.c#L313>)

Closes an account by transferring its lamports to a recipient and setting its state to uninitialized.
- **Inputs**:
    - ``authority_address``: A pointer to the public key of the authority that is allowed to close the account.
    - ``instr_ctx``: A pointer to the instruction context, which contains information about the current transaction and accounts involved.
    - ``state``: A pointer to the state of the BPF upgradeable loader, which will be set to uninitialized after closing the account.
- **Logic and Control Flow**:
    - Checks if `authority_address` is NULL and returns an error if true.
    - Retrieves the account key at index 2 from `instr_ctx` and checks for errors.
    - Compares `authority_address` with the retrieved account key and returns an error if they do not match.
    - Checks if the account at index 2 is a signer and returns an error if not.
    - Borrows the account to be closed and the recipient account using `FD_TRY_BORROW_INSTR_ACCOUNT_DEFAULT_ERR_CHECK`.
    - Transfers lamports from the account to be closed to the recipient account and checks for errors.
    - Sets the lamports of the account to be closed to zero and checks for errors.
    - Sets the state discriminant to uninitialized and updates the account state using [`fd_bpf_loader_v3_program_set_state`](<#fd_bpf_loader_v3_program_set_state>).
    - Returns success if all operations complete without errors.
- **Output**: Returns an integer status code indicating success or the type of error encountered.
- **Functions Called**:
    - [`fd_bpf_loader_v3_program_set_state`](<#fd_bpf_loader_v3_program_set_state>)


---
### fd\_bpf\_execute<!-- {{#callable:fd_bpf_execute}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_bpf_loader_program.c#L374>)

Executes a BPF program within a virtual machine context, handling input serialization, VM initialization, execution, and error handling.
- **Inputs**:
    - ``instr_ctx``: A pointer to `fd_exec_instr_ctx_t`, which provides the execution context for the instruction.
    - ``cache_entry``: A constant pointer to `fd_progcache_rec_t`, representing the cached program entry to be executed.
    - ``is_deprecated``: An unsigned character indicating whether the program is deprecated.
- **Logic and Control Flow**:
    - Initialize error code to `FD_EXECUTOR_INSTR_SUCCESS` and allocate syscalls using `fd_sbpf_syscalls_new`.
    - Check if syscall allocation fails and log a critical error if it does.
    - Register the syscall slot using `fd_vm_syscall_register_slot`.
    - Initialize input serialization parameters and serialize them using [`fd_bpf_loader_input_serialize_parameters`](<fd_bpf_loader_serialization.c.md#fd_bpf_loader_input_serialize_parameters>).
    - Check for errors in input serialization and return the error if any.
    - Initialize SHA256 and VM instances using `fd_sha256_new` and `fd_vm_new`.
    - Calculate heap cost and consume compute units using `fd_exec_consume_cus`.
    - Check for errors in heap cost consumption and return an error if any.
    - Initialize the VM using `fd_vm_init` with various parameters including input memory regions and constraints.
    - Check if VM initialization fails and log a warning if it does.
    - Execute the VM using `fd_vm_exec` and update the compute meter.
    - If VM tracing is enabled, join and initialize VM trace using `fd_vm_trace_join` and `fd_vm_trace_new`.
    - Log consumed compute units and return data using `fd_log_collector_program_consumed` and `fd_log_collector_program_return`.
    - Handle non-zero return status with successful VM execution by checking the status register and converting program errors to instruction errors.
    - Handle execution errors by checking for specific error kinds and returning appropriate error codes.
    - Deserialize input parameters using [`fd_bpf_loader_input_deserialize_parameters`](<fd_bpf_loader_serialization.c.md#fd_bpf_loader_input_deserialize_parameters>) and check for errors.
    - Return `FD_EXECUTOR_INSTR_SUCCESS` if execution completes successfully.
- **Output**: Returns an integer status code indicating the success or failure of the BPF program execution.
- **Functions Called**:
    - [`fd_bpf_loader_input_serialize_parameters`](<fd_bpf_loader_serialization.c.md#fd_bpf_loader_input_serialize_parameters>)
    - [`calculate_heap_cost`](<#calculate_heap_cost>)
    - [`program_error_to_instr_error`](<#program_error_to_instr_error>)
    - [`fd_bpf_loader_input_deserialize_parameters`](<fd_bpf_loader_serialization.c.md#fd_bpf_loader_input_deserialize_parameters>)


---
### common\_extend\_program<!-- {{#callable:common_extend_program}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_bpf_loader_program.c#L631>)

Extends a program's data account by a specified number of bytes, ensuring necessary conditions and permissions are met.
- **Inputs**:
    - ``instr_ctx``: A pointer to the instruction context (`fd_exec_instr_ctx_t`) that contains execution details and state.
    - ``additional_bytes``: An unsigned integer specifying the number of additional bytes to extend the program's data account.
    - ``check_authority``: A `uchar` flag indicating whether to check the upgrade authority's signature (non-zero value means check).
- **Logic and Control Flow**:
    - Retrieve the last program key from `instr_ctx` and check for errors.
    - Define account indices for program data, program, and authority accounts.
    - Determine the optional payer account index based on `check_authority`.
    - Check if `additional_bytes` is zero and log an error if true, returning an invalid instruction data error.
    - Borrow the program data account and verify its ownership and writability.
    - Borrow the program account and verify its ownership and writability.
    - Retrieve the program state and verify it matches the program data account.
    - Calculate the new length of the program data and check against the maximum permitted length.
    - Read the current clock slot from the system variable cache.
    - Retrieve the program data state and verify it is upgradeable and not already extended in the current block.
    - If `check_authority` is true, verify the authority's key and signature.
    - Calculate the required payment for rent exemption and perform a transfer if necessary.
    - Set the new data length for the program data account and deploy the program with the new data.
    - Update the program data state with the new slot and authority information.
    - Log the successful extension of the program data account.
- **Output**: Returns an integer status code indicating success (`FD_EXECUTOR_INSTR_SUCCESS`) or an error code if any checks or operations fail.
- **Functions Called**:
    - [`fd_bpf_loader_program_get_state`](<#fd_bpf_loader_program_get_state>)
    - [`fd_native_cpi_create_account_meta`](<fd_native_cpi.c.md#fd_native_cpi_create_account_meta>)
    - [`fd_native_cpi_native_invoke`](<fd_native_cpi.c.md#fd_native_cpi_native_invoke>)
    - [`fd_deploy_program`](<#fd_deploy_program>)
    - [`fd_bpf_loader_v3_program_set_state`](<#fd_bpf_loader_v3_program_set_state>)


---
### process\_loader\_upgradeable\_instruction<!-- {{#callable:process_loader_upgradeable_instruction}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_bpf_loader_program.c#L904>)

Processes upgradeable loader instructions for BPF programs.
- **Inputs**:
    - `instr_ctx`: A pointer to the `fd_exec_instr_ctx_t` structure, which contains the execution context for the instruction.
- **Logic and Control Flow**:
    - Retrieve the instruction data and shared program address data (spad) from `instr_ctx`.
    - Decode the instruction using `fd_bincode_decode_spad` and check for errors.
    - Retrieve the last program key using `fd_exec_instr_ctx_get_last_program_key` and check for errors.
    - Switch on the instruction's discriminant to determine the type of operation to perform.
    - For each case, perform specific operations such as checking account numbers, borrowing accounts, verifying states, and updating states.
    - Handle errors and return appropriate error codes for each operation.
    - Return `FD_EXECUTOR_INSTR_SUCCESS` if the instruction is processed successfully.
- **Output**: Returns an integer status code indicating success or a specific error.
- **Functions Called**:
    - [`fd_bpf_loader_program_get_state`](<#fd_bpf_loader_program_get_state>)
    - [`fd_bpf_loader_v3_program_set_state`](<#fd_bpf_loader_v3_program_set_state>)
    - [`write_program_data`](<#write_program_data>)
    - [`fd_native_cpi_create_account_meta`](<fd_native_cpi.c.md#fd_native_cpi_create_account_meta>)
    - [`fd_native_cpi_native_invoke`](<fd_native_cpi.c.md#fd_native_cpi_native_invoke>)
    - [`fd_deploy_program`](<#fd_deploy_program>)
    - [`common_close_account`](<#common_close_account>)
    - [`common_extend_program`](<#common_extend_program>)


---
### fd\_bpf\_loader\_program\_execute<!-- {{#callable:fd_bpf_loader_program_execute}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_bpf_loader_program.c#L2415>)

Executes a BPF program by managing program accounts, checking program validity, and invoking the program if valid.
- **Inputs**:
    - ``ctx``: A pointer to `fd_exec_instr_ctx_t`, which contains the execution context for the instruction.
- **Logic and Control Flow**:
    - Begin a scoped frame using `FD_SPAD_FRAME_BEGIN` with the shared program address data (`spad`) from the transaction context.
    - Attempt to borrow the last program account using `fd_exec_instr_ctx_try_borrow_last_program_account`; return error if unsuccessful.
    - Retrieve the last program key using `fd_exec_instr_ctx_get_last_program_key`; return error if unsuccessful.
    - Check if the program is a management instruction by comparing the program account owner with `fd_solana_native_loader_id`.
    - If it is a management instruction, drop the program account and check the program ID against known loader IDs to determine the appropriate action or return an error if unsupported.
    - If the program is not a management instruction, check if the program is executable and return an error if it is not.
    - Check the program's state to ensure it is not in a 'DelayVisibility' or 'Closed' state, returning an error if it is.
    - Retrieve the program from the cache using `fd_progcache_pull`; return an error if the program is not cached or not executable.
    - Drop the program account and execute the program using [`fd_bpf_execute`](<#fd_bpf_execute>) with the cache entry and deprecation status.
    - End the scoped frame using `FD_SPAD_FRAME_END`.
- **Output**: Returns an integer status code indicating success or the type of error encountered during execution.
- **Functions Called**:
    - [`process_loader_upgradeable_instruction`](<#process_loader_upgradeable_instruction>)
    - [`fd_bpf_loader_program_get_state`](<#fd_bpf_loader_program_get_state>)
    - [`fd_is_non_migrating_builtin_program`](<fd_builtin_programs.c.md#fd_is_non_migrating_builtin_program>)
    - [`fd_bpf_execute`](<#fd_bpf_execute>)


---
### fd\_directly\_invoke\_loader\_v3\_deploy<!-- {{#callable:fd_directly_invoke_loader_v3_deploy}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_bpf_loader_program.c#L2615>)

Attempts to deploy a BPF program using a transaction context and instruction context setup, but is currently not implemented.
- **Inputs**:
    - ``bank``: A pointer to an `fd_bank_t` structure representing the bank context.
    - ``accdb_shfunk``: A pointer to a shared function for account database operations.
    - ``xid``: A constant pointer to an `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``program_key``: A constant pointer to an `fd_pubkey_t` structure representing the public key of the program to be deployed.
    - ``elf``: A constant pointer to an unsigned character array containing the ELF binary data of the program.
    - ``elf_sz``: An unsigned long integer representing the size of the ELF binary data.
- **Logic and Control Flow**:
    - Logs an error message indicating that the function is not implemented and returns 0.
    - Sets up a dummy instruction and transaction context using `fd_exec_txn_ctx_join` and `fd_exec_txn_ctx_new`.
    - Configures the transaction context with `fd_exec_txn_ctx_setup` and `fd_exec_txn_ctx_setup_basic`.
    - Initializes an instruction context within the transaction context's instruction stack.
    - Notes that the function is called at the epoch boundary and does not handle the `programs_to_reverify` field.
    - Attempts to deploy the program using [`fd_deploy_program`](<#fd_deploy_program>), but this part is unreachable due to the early return.
- **Output**: Returns 0 after logging an error message, indicating that the function is not implemented.
- **Functions Called**:
    - [`fd_deploy_program`](<#fd_deploy_program>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)