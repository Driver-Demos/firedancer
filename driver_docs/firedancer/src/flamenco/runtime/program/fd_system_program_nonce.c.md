<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for managing nonce accounts in a Solana-like system, including initialization, authorization, and transaction age verification.

# Purpose
The code is a C implementation of a system program for managing nonce accounts, which are used in transaction processing within a blockchain environment. The primary functionality of this code is to handle various operations related to nonce accounts, such as advancing, withdrawing, initializing, authorizing, and upgrading nonce accounts. These operations are crucial for ensuring the security and validity of transactions by managing unique identifiers (nonces) that prevent replay attacks.

The code defines several static functions that perform specific tasks, such as [`require_acct`](<#require_acct>), [`require_acct_rent`](<#require_acct_rent>), and [`require_acct_recent_blockhashes`](<#require_acct_recent_blockhashes>), which are used to validate account requirements and retrieve necessary data. The main functions, such as [`fd_system_program_exec_advance_nonce_account`](<#fd_system_program_exec_advance_nonce_account>), [`fd_system_program_exec_withdraw_nonce_account`](<#fd_system_program_exec_withdraw_nonce_account>), and [`fd_system_program_exec_initialize_nonce_account`](<#fd_system_program_exec_initialize_nonce_account>), implement the logic for executing the corresponding system instructions. These functions interact with the transaction context and account data to perform the necessary operations, ensuring that the nonce accounts are correctly managed according to the rules defined by the Solana Labs system. The code also includes error handling to manage various failure scenarios, ensuring robust transaction processing.
# Imports and Dependencies

---
- `fd_system_program.h`
- `../fd_borrowed_account.h`
- `../fd_acc_mgr.h`
- `../fd_system_ids.h`
- `../context/fd_exec_txn_ctx.h`
- `../sysvar/fd_sysvar_rent.h`
- `../sysvar/fd_sysvar_recent_hashes.h`


# Functions

---
### require\_acct<!-- {{#callable:require_acct}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_system_program_nonce.c#L9>)

Validates if the account at a given index in the execution context matches a specified public key.
- **Inputs**:
    - `ctx`: A pointer to the `fd_exec_instr_ctx_t` structure, representing the execution context.
    - `idx`: An unsigned short integer representing the index of the account to check within the execution context.
    - `pubkey`: A pointer to a constant `fd_pubkey_t` structure, representing the public key to compare against.
- **Logic and Control Flow**:
    - Initialize a pointer `acc_key` to `NULL` to store the account key retrieved from the context.
    - Call `fd_exec_instr_ctx_get_key_of_account_at_index` with `ctx`, `idx`, and `acc_key` to retrieve the account key at the specified index.
    - If the retrieval function returns an error, return the error code immediately.
    - Compare the retrieved account key `acc_key` with the provided `pubkey` using `memcmp`.
    - If the keys do not match, return `FD_EXECUTOR_INSTR_ERR_INVALID_ARG`.
    - If the keys match, return `FD_EXECUTOR_INSTR_SUCCESS`.
- **Output**: Returns an integer status code: `FD_EXECUTOR_INSTR_SUCCESS` if the account key matches the public key, or an error code if there is a mismatch or retrieval error.


---
### require\_acct\_rent<!-- {{#callable:require_acct_rent}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_system_program_nonce.c#L25>)

Ensures the account at the specified index is the rent sysvar account and reads the rent data from the sysvar cache.
- **Inputs**:
    - `ctx`: A pointer to `fd_exec_instr_ctx_t`, which provides the execution context for the instruction.
    - `idx`: An unsigned short integer representing the index of the account to check.
    - `rent`: A pointer to `fd_rent_t` where the function will store the rent data if successful.
- **Logic and Control Flow**:
    - Calls [`require_acct`](<#require_acct>) to verify that the account at the given index matches the rent sysvar account ID (`fd_sysvar_rent_id`).
    - If [`require_acct`](<#require_acct>) returns an error, the function returns this error immediately.
    - Attempts to read the rent data from the sysvar cache using `fd_sysvar_cache_rent_read`.
    - If reading the rent data fails, returns `FD_EXECUTOR_INSTR_ERR_UNSUPPORTED_SYSVAR`.
    - If all checks pass, returns `FD_EXECUTOR_INSTR_SUCCESS`.
- **Output**: Returns an integer status code: `FD_EXECUTOR_INSTR_SUCCESS` on success, or an error code if any step fails.
- **Functions Called**:
    - [`require_acct`](<#require_acct>)


---
### require\_acct\_recent\_blockhashes<!-- {{#callable:require_acct_recent_blockhashes}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_system_program_nonce.c#L41>)

Validates the presence and validity of the recent blockhashes account in the execution context.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_exec_instr_ctx_t` structure, which contains the execution context for the instruction.
    - ``idx``: An unsigned short integer representing the index of the account to check in the execution context.
- **Logic and Control Flow**:
    - Calls the [`require_acct`](<#require_acct>) function to check if the account at the given index matches the `fd_sysvar_recent_block_hashes_id` public key.
    - If [`require_acct`](<#require_acct>) returns an error, the function returns this error immediately.
    - Checks if the recent blockhashes in the system variable cache are valid using `fd_sysvar_cache_recent_hashes_is_valid`.
    - If the recent blockhashes are not valid, returns `FD_EXECUTOR_INSTR_ERR_UNSUPPORTED_SYSVAR`.
    - If all checks pass, returns `FD_EXECUTOR_INSTR_SUCCESS`.
- **Output**: Returns an integer indicating success (`FD_EXECUTOR_INSTR_SUCCESS`) or an error code if the account is invalid or the recent blockhashes are not supported.
- **Functions Called**:
    - [`require_acct`](<#require_acct>)


---
### most\_recent\_block\_hash<!-- {{#callable:most_recent_block_hash}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_system_program_nonce.c#L59>)

Retrieves the most recent block hash from the block hash queue and stores it in the provided output variable.
- **Inputs**:
    - ``ctx``: A pointer to a `fd_exec_instr_ctx_t` structure, which contains the transaction context and other execution-related data.
    - ``out``: A pointer to a `fd_hash_t` structure where the function will store the most recent block hash.
- **Logic and Control Flow**:
    - Query the block hash queue from the bank using `fd_bank_block_hash_queue_query` with `ctx->txn_ctx->bank`.
    - Retrieve the last block hash from the queue using `fd_blockhashes_peek_last`.
    - Check if the retrieved block hash is `NULL`. If it is, set a custom error in `ctx->txn_ctx->custom_err` and return `FD_EXECUTOR_INSTR_ERR_CUSTOM_ERR`.
    - If the block hash is not `NULL`, copy it to the `out` parameter.
    - Return `FD_EXECUTOR_INSTR_SUCCESS` to indicate success.
- **Output**: Returns an integer status code: `FD_EXECUTOR_INSTR_SUCCESS` on success or `FD_EXECUTOR_INSTR_ERR_CUSTOM_ERR` if no recent block hashes are available.


---
### fd\_durable\_nonce\_from\_blockhash<!-- {{#callable:fd_durable_nonce_from_blockhash}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_system_program_nonce.c#L77>)

Generates a durable nonce by hashing a predefined string with a given blockhash.
- **Inputs**:
    - ``out``: A pointer to an `fd_hash_t` where the resulting durable nonce will be stored.
    - ``blockhash``: A constant pointer to an `fd_hash_t` representing the blockhash to be used in the nonce generation.
- **Logic and Control Flow**:
    - Declare a buffer `buf` of 45 bytes.
    - Copy the string "DURABLE_NONCE" into the first 13 bytes of `buf`.
    - Copy the contents of `blockhash` into `buf` starting at the 14th byte.
    - Call `fd_sha256_hash` to hash the entire `buf` and store the result in `out`.
- **Output**: The function does not return a value but outputs the durable nonce through the `out` parameter.


---
### fd\_system\_program\_set\_nonce\_state<!-- {{#callable:fd_system_program_set_nonce_state}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_system_program_nonce.c#L92>)

Updates the state of a nonce account with a new nonce state if the account's data buffer is large enough.
- **Inputs**:
    - ``account``: A pointer to an `fd_borrowed_account_t` structure representing the nonce account to update.
    - ``new_state``: A pointer to a constant `fd_nonce_state_versions_t` structure representing the new nonce state to set.
- **Logic and Control Flow**:
    - Initialize `data` and `dlen` to hold the account's data and its length, respectively.
    - Call `fd_borrowed_account_get_data_mut` to get a mutable reference to the account's data buffer; return the error code if it fails.
    - Check if the size of `new_state` exceeds the account's data length using `fd_nonce_state_versions_size` and `fd_borrowed_account_get_data_len`; return `FD_EXECUTOR_INSTR_ERR_ACC_DATA_TOO_SMALL` if true.
    - Create an `fd_bincode_encode_ctx_t` structure to encode the new state into the account's data buffer.
    - Call `fd_nonce_state_versions_encode` to encode `new_state` into the data buffer; return `FD_EXECUTOR_INSTR_ERR_GENERIC_ERR` if encoding fails.
    - Return `FD_EXECUTOR_INSTR_SUCCESS` to indicate successful update.
- **Output**: Returns an integer status code: `FD_EXECUTOR_INSTR_SUCCESS` on success, or an error code if an error occurs during data retrieval, size check, or encoding.


---
### fd\_system\_program\_advance\_nonce\_account<!-- {{#callable:fd_system_program_advance_nonce_account}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_system_program_nonce.c#L128>)

Advances the nonce account by updating its state and durable nonce if conditions are met.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_exec_instr_ctx_t` structure, which provides the execution context for the instruction.
    - ``account``: A pointer to the `fd_borrowed_account_t` structure, representing the nonce account to be advanced.
    - ``instr_acc_idx``: An unsigned short integer representing the index of the instruction account.
- **Logic and Control Flow**:
    - Checks if the account at `instr_acc_idx` is writable; logs an error and returns if not.
    - Decodes the nonce state versions from the account data; returns an error if decoding fails.
    - Determines the current state of the nonce account based on its discriminant (legacy or current).
    - If the state is initialized, checks if the authority is a signer; logs an error and returns if not.
    - Retrieves the most recent block hash and computes the next durable nonce.
    - Checks if the current durable nonce matches the next durable nonce; logs an error and returns if they match.
    - Creates a new nonce state with the updated durable nonce and fee calculator.
    - Sets the new nonce state in the account; returns an error if setting fails.
    - If the state is uninitialized, logs an error and returns.
- **Output**: Returns `FD_EXECUTOR_INSTR_SUCCESS` on success, or an error code if any checks or operations fail.
- **Functions Called**:
    - [`most_recent_block_hash`](<#most_recent_block_hash>)
    - [`fd_durable_nonce_from_blockhash`](<#fd_durable_nonce_from_blockhash>)
    - [`fd_system_program_set_nonce_state`](<#fd_system_program_set_nonce_state>)


---
### fd\_system\_program\_exec\_advance\_nonce\_account<!-- {{#callable:fd_system_program_exec_advance_nonce_account}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_system_program_nonce.c#L241>)

Advances a nonce account by verifying account conditions and updating its state with a new durable nonce.
- **Inputs**:
    - `ctx`: A pointer to `fd_exec_instr_ctx_t`, which provides the execution context for the instruction.
- **Logic and Control Flow**:
    - Check if the account count in `ctx->instr` is less than 1; if true, return `FD_EXECUTOR_INSTR_ERR_NOT_ENOUGH_ACC_KEYS`.
    - Set `instr_acc_idx` to 0 and initialize a `fd_guarded_borrowed_account_t` structure named `account`.
    - Attempt to borrow the instruction account using `FD_TRY_BORROW_INSTR_ACCOUNT_DEFAULT_ERR_CHECK`; if it fails, return the error.
    - Call [`require_acct_recent_blockhashes`](<#require_acct_recent_blockhashes>) to ensure recent blockhashes are available; if it fails, return the error.
    - Join the recent blockhashes from `ctx->sysvar_cache` and check if the blockhash queue is empty; if true, log a message, set a custom error, and return `FD_EXECUTOR_INSTR_ERR_CUSTOM_ERR`.
    - Call [`fd_system_program_advance_nonce_account`](<#fd_system_program_advance_nonce_account>) with `ctx`, `account`, and `instr_acc_idx` to advance the nonce account.
    - Return the result of [`fd_system_program_advance_nonce_account`](<#fd_system_program_advance_nonce_account>).
- **Output**: Returns an integer error code indicating success or the type of error encountered during execution.
- **Functions Called**:
    - [`require_acct_recent_blockhashes`](<#require_acct_recent_blockhashes>)
    - [`fd_system_program_advance_nonce_account`](<#fd_system_program_advance_nonce_account>)


---
### fd\_system\_program\_withdraw\_nonce\_account<!-- {{#callable:fd_system_program_withdraw_nonce_account}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_system_program_nonce.c#L289>)

Processes the withdrawal of lamports from a nonce account, ensuring account validity and sufficient funds.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_exec_instr_ctx_t` structure, which provides the execution context for the instruction.
    - ``requested_lamports``: The amount of lamports requested to be withdrawn from the nonce account.
    - ``rent``: A pointer to a constant `fd_rent_t` structure, which provides rent-related information for the account.
- **Logic and Control Flow**:
    - Initialize variables for account indices and attempt to borrow the 'from' account using `FD_TRY_BORROW_INSTR_ACCOUNT_DEFAULT_ERR_CHECK`.
    - Check if the 'from' account is writable; if not, log an error and return `FD_EXECUTOR_INSTR_ERR_INVALID_ARG`.
    - Decode the nonce state from the 'from' account data using `fd_bincode_decode_spad` and handle any errors.
    - Determine the current state of the nonce account (uninitialized or initialized) and handle each case separately.
    - For uninitialized state, check if the requested lamports exceed the available lamports; if so, log an error and return `FD_EXECUTOR_INSTR_ERR_INSUFFICIENT_FUNDS`.
    - For initialized state, if the requested lamports equal the available lamports, check the blockhash and update the nonce state if necessary.
    - If the requested lamports do not equal the available lamports, calculate the minimum balance and check for sufficient funds.
    - Ensure the signer is valid by checking if any required signatures are present; if not, log an error and return `FD_EXECUTOR_INSTR_ERR_MISSING_REQUIRED_SIGNATURE`.
    - Subtract the requested lamports from the 'from' account using `fd_borrowed_account_checked_sub_lamports` and handle any errors.
    - Drop the 'from' account using `fd_borrowed_account_drop`.
    - Borrow the 'to' account and add the requested lamports using `fd_borrowed_account_checked_add_lamports`, handling any errors.
    - Return `FD_EXECUTOR_INSTR_SUCCESS` upon successful completion.
- **Output**: Returns an integer status code indicating success (`FD_EXECUTOR_INSTR_SUCCESS`) or an error code if an error occurs during processing.
- **Functions Called**:
    - [`most_recent_block_hash`](<#most_recent_block_hash>)
    - [`fd_durable_nonce_from_blockhash`](<#fd_durable_nonce_from_blockhash>)
    - [`fd_system_program_set_nonce_state`](<#fd_system_program_set_nonce_state>)


---
### fd\_system\_program\_exec\_withdraw\_nonce\_account<!-- {{#callable:fd_system_program_exec_withdraw_nonce_account}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_system_program_nonce.c#L462>)

Executes the withdrawal of lamports from a nonce account in the Solana system program.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_exec_instr_ctx_t` structure, which provides the execution context for the instruction.
    - ``requested_lamports``: The amount of lamports requested to be withdrawn from the nonce account.
- **Logic and Control Flow**:
    - Check if the account count in `ctx` is less than 2; if true, return `FD_EXECUTOR_INSTR_ERR_NOT_ENOUGH_ACC_KEYS`.
    - Call [`require_acct_recent_blockhashes`](<#require_acct_recent_blockhashes>) with `ctx` and index 2 to ensure the recent blockhashes account is present; return any error encountered.
    - Declare a `fd_rent_t` array and call [`require_acct_rent`](<#require_acct_rent>) with `ctx`, index 3, and the rent array to ensure the rent account is present; return any error encountered.
    - Call [`fd_system_program_withdraw_nonce_account`](<#fd_system_program_withdraw_nonce_account>) with `ctx`, `requested_lamports`, and the rent array to perform the withdrawal operation.
- **Output**: Returns an integer status code indicating success or the type of error encountered during execution.
- **Functions Called**:
    - [`require_acct_recent_blockhashes`](<#require_acct_recent_blockhashes>)
    - [`require_acct_rent`](<#require_acct_rent>)
    - [`fd_system_program_withdraw_nonce_account`](<#fd_system_program_withdraw_nonce_account>)


---
### fd\_system\_program\_initialize\_nonce\_account<!-- {{#callable:fd_system_program_initialize_nonce_account}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_system_program_nonce.c#L495>)

Initializes a nonce account by setting its state to initialized with a durable nonce and an authorized authority.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_exec_instr_ctx_t` structure, which provides the execution context for the instruction.
    - ``account``: A pointer to the `fd_borrowed_account_t` structure, representing the account to be initialized as a nonce account.
    - ``authorized``: A pointer to the `fd_pubkey_t` structure, representing the public key of the authority that will be authorized to manage the nonce account.
    - ``rent``: A pointer to the `fd_rent_t` structure, which provides rent-related information for the account.
- **Logic and Control Flow**:
    - Check if the `account` is writable; if not, log an error and return `FD_EXECUTOR_INSTR_ERR_INVALID_ARG`.
    - Decode the account's data to get the current nonce state versions; if decoding fails, return `FD_EXECUTOR_INSTR_ERR_INVALID_ACC_DATA`.
    - Determine the current state of the nonce account from the decoded versions.
    - If the state is `uninitialized`, calculate the minimum balance required for rent exemption.
    - Check if the account has sufficient lamports; if not, log an error and return `FD_EXECUTOR_INSTR_ERR_INSUFFICIENT_FUNDS`.
    - Retrieve the most recent block hash and derive a durable nonce from it.
    - Create a new nonce state with the `initialized` state, setting the authority, durable nonce, and fee calculator.
    - Set the new nonce state in the account; if setting fails, return the error code.
    - If the state is `initialized`, log an error and return `FD_EXECUTOR_INSTR_ERR_INVALID_ACC_DATA`.
    - Return `FD_EXECUTOR_INSTR_SUCCESS` on successful initialization.
- **Output**: Returns an integer status code indicating success (`FD_EXECUTOR_INSTR_SUCCESS`) or an error code if initialization fails.
- **Functions Called**:
    - [`most_recent_block_hash`](<#most_recent_block_hash>)
    - [`fd_durable_nonce_from_blockhash`](<#fd_durable_nonce_from_blockhash>)
    - [`fd_system_program_set_nonce_state`](<#fd_system_program_set_nonce_state>)


---
### fd\_system\_program\_exec\_initialize\_nonce\_account<!-- {{#callable:fd_system_program_exec_initialize_nonce_account}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_system_program_nonce.c#L606>)

Initializes a nonce account in the Solana system program with a specified authorized public key.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_exec_instr_ctx_t` structure, which provides the execution context for the instruction.
    - ``authorized``: A pointer to a `fd_pubkey_t` structure representing the public key that will be authorized to manage the nonce account.
- **Logic and Control Flow**:
    - Check if the number of accounts in `ctx->instr` is less than 1; if so, return `FD_EXECUTOR_INSTR_ERR_NOT_ENOUGH_ACC_KEYS`.
    - Set `instr_acc_idx` to 0 and initialize a `fd_guarded_borrowed_account_t` structure named `account`.
    - Attempt to borrow the instruction account at index `instr_acc_idx` using `FD_TRY_BORROW_INSTR_ACCOUNT_DEFAULT_ERR_CHECK`.
    - Call [`require_acct_recent_blockhashes`](<#require_acct_recent_blockhashes>) to ensure recent blockhashes are available; return an error if not.
    - Check if the recent blockhash list is empty; if so, log a message and return `FD_EXECUTOR_INSTR_ERR_CUSTOM_ERR`.
    - Call [`require_acct_rent`](<#require_acct_rent>) to ensure the rent account is available; return an error if not.
    - Call [`fd_system_program_initialize_nonce_account`](<#fd_system_program_initialize_nonce_account>) with the context, account, authorized public key, and rent information.
    - Return the result of the [`fd_system_program_initialize_nonce_account`](<#fd_system_program_initialize_nonce_account>) call.
- **Output**: Returns an integer error code, where 0 indicates success and non-zero indicates an error.
- **Functions Called**:
    - [`require_acct_recent_blockhashes`](<#require_acct_recent_blockhashes>)
    - [`require_acct_rent`](<#require_acct_rent>)
    - [`fd_system_program_initialize_nonce_account`](<#fd_system_program_initialize_nonce_account>)


---
### fd\_system\_program\_authorize\_nonce\_account<!-- {{#callable:fd_system_program_authorize_nonce_account}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_system_program_nonce.c#L665>)

Authorizes a nonce account by updating its authority if the account is writable, initialized, and signed by the current authority.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_exec_instr_ctx_t` structure, which provides the execution context for the instruction.
    - ``account``: A pointer to the `fd_borrowed_account_t` structure, representing the nonce account to be authorized.
    - ``instr_acc_idx``: An unsigned short integer representing the index of the account in the instruction's account list.
    - ``nonce_authority``: A pointer to the `fd_pubkey_t` structure, representing the new authority for the nonce account.
- **Logic and Control Flow**:
    - Check if the account at `instr_acc_idx` is writable; if not, log an error and return `FD_EXECUTOR_INSTR_ERR_INVALID_ARG`.
    - Decode the nonce state versions from the account data; if decoding fails, return `FD_EXECUTOR_INSTR_ERR_INVALID_ACC_DATA`.
    - Determine the current state of the nonce account based on its version discriminant.
    - Check if the nonce account is initialized; if not, log an error and return `FD_EXECUTOR_INSTR_ERR_INVALID_ACC_DATA`.
    - Verify that the current authority has signed the transaction; if not, log an error and return `FD_EXECUTOR_INSTR_ERR_MISSING_REQUIRED_SIGNATURE`.
    - Create a new nonce state with the updated authority and the same durable nonce and fee calculator.
    - Create a new versioned state based on the current version discriminant and the new nonce state.
    - Set the new nonce state in the account using [`fd_system_program_set_nonce_state`](<#fd_system_program_set_nonce_state>); if this fails, return the error code.
    - Return `FD_EXECUTOR_INSTR_SUCCESS` to indicate success.
- **Output**: Returns an integer status code, `FD_EXECUTOR_INSTR_SUCCESS` on success, or an error code on failure.
- **Functions Called**:
    - [`fd_system_program_set_nonce_state`](<#fd_system_program_set_nonce_state>)


---
### fd\_system\_program\_exec\_authorize\_nonce\_account<!-- {{#callable:fd_system_program_exec_authorize_nonce_account}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_system_program_nonce.c#L771>)

Authorizes a nonce account using a given nonce authority.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_exec_instr_ctx_t` structure, which provides the execution context for the instruction.
    - ``nonce_authority``: A pointer to the `fd_pubkey_t` structure representing the public key of the nonce authority.
- **Logic and Control Flow**:
    - Check if the account count in `ctx->instr` is less than 1; if true, return `FD_EXECUTOR_INSTR_ERR_NOT_ENOUGH_ACC_KEYS`.
    - Attempt to borrow the instruction account at index 0 using `fd_exec_instr_ctx_try_borrow_instr_account`; if an error occurs, return the error.
    - Call [`fd_system_program_authorize_nonce_account`](<#fd_system_program_authorize_nonce_account>) with the context, borrowed account, index 0, and `nonce_authority`.
    - Return the result of [`fd_system_program_authorize_nonce_account`](<#fd_system_program_authorize_nonce_account>).
- **Output**: Returns an integer error code, where 0 indicates success and non-zero indicates an error.
- **Functions Called**:
    - [`fd_system_program_authorize_nonce_account`](<#fd_system_program_authorize_nonce_account>)


---
### fd\_system\_program\_exec\_upgrade\_nonce\_account<!-- {{#callable:fd_system_program_exec_upgrade_nonce_account}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_system_program_nonce.c#L801>)

Upgrades a nonce account from a legacy version to the current version if it meets specific conditions.
- **Inputs**:
    - ``ctx``: A pointer to an `fd_exec_instr_ctx_t` structure that provides the execution context for the instruction.
- **Logic and Control Flow**:
    - Check if the account count in `ctx->instr` is less than 1; if true, return `FD_EXECUTOR_INSTR_ERR_NOT_ENOUGH_ACC_KEYS`.
    - Attempt to borrow the nonce account using `FD_TRY_BORROW_INSTR_ACCOUNT_DEFAULT_ERR_CHECK`; if it fails, return the error.
    - Verify that the account owner matches `fd_solana_system_program_id.key`; if not, return `FD_EXECUTOR_INSTR_ERR_INVALID_ACC_OWNER`.
    - Check if the account is writable using `fd_instr_acc_is_writable_idx`; if not, return `FD_EXECUTOR_INSTR_ERR_INVALID_ARG`.
    - Decode the nonce state versions from the account data using `fd_bincode_decode_spad`; if it fails, return `FD_EXECUTOR_INSTR_ERR_INVALID_ACC_DATA`.
    - Ensure the nonce state version is `fd_nonce_state_versions_enum_legacy`; if not, return `FD_EXECUTOR_INSTR_ERR_INVALID_ARG`.
    - Ensure the nonce state is `fd_nonce_state_enum_initialized`; if not, return `FD_EXECUTOR_INSTR_ERR_INVALID_ARG`.
    - Update the durable nonce using [`fd_durable_nonce_from_blockhash`](<#fd_durable_nonce_from_blockhash>).
    - Create a new state with `fd_nonce_state_versions_enum_current` and set it to the account using [`fd_system_program_set_nonce_state`](<#fd_system_program_set_nonce_state>); if it fails, return the error.
    - Return `FD_EXECUTOR_INSTR_SUCCESS` on success.
- **Output**: Returns an integer status code indicating success (`FD_EXECUTOR_INSTR_SUCCESS`) or a specific error code.
- **Functions Called**:
    - [`fd_durable_nonce_from_blockhash`](<#fd_durable_nonce_from_blockhash>)
    - [`fd_system_program_set_nonce_state`](<#fd_system_program_set_nonce_state>)


---
### fd\_check\_transaction\_age<!-- {{#callable:fd_check_transaction_age}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_system_program_nonce.c#L869>)

Validates the age of a transaction by checking its blockhash against recent blockhashes and verifying nonce account conditions.
- **Inputs**:
    - ``txn_ctx``: A pointer to a `fd_exec_txn_ctx_t` structure representing the transaction context.
- **Logic and Control Flow**:
    - Query the block hash queue from the bank using `fd_bank_block_hash_queue_query` and get the last blockhash using `fd_blockhashes_peek_last`.
    - If the last blockhash is not found, return `FD_RUNTIME_TXN_ERR_BLOCKHASH_NOT_FOUND`.
    - Generate a durable nonce from the last blockhash using [`fd_durable_nonce_from_blockhash`](<#fd_durable_nonce_from_blockhash>).
    - Retrieve the recent blockhash from the transaction payload using the offset `recent_blockhash_off`.
    - Check if the recent blockhash is within the last 151 blockhashes using `fd_blockhashes_check_age`. If valid, return `FD_RUNTIME_EXECUTE_SUCCESS`.
    - If the recent blockhash matches the next durable nonce, return `FD_RUNTIME_TXN_ERR_BLOCKHASH_NOT_FOUND`.
    - Verify the transaction has instructions and check the first instruction for system program ID and advance nonce account instruction.
    - Ensure the nonce account is writable and included in the transaction account keys if required.
    - Initialize a durable nonce account from the transaction context and verify its owner is the system program.
    - Decode the nonce state and verify it is not legacy or uninitialized, and compare the durable nonce with the recent blockhash.
    - Check if any accounts in the nonce instruction are signers and match the authority, then update the nonce account state and return `FD_RUNTIME_EXECUTE_SUCCESS`.
    - If none of the conditions are met, return `FD_RUNTIME_TXN_ERR_BLOCKHASH_NOT_FOUND`.
- **Output**: Returns an integer status code indicating success (`FD_RUNTIME_EXECUTE_SUCCESS`) or various error conditions (`FD_RUNTIME_TXN_ERR_BLOCKHASH_NOT_FOUND`).
- **Functions Called**:
    - [`fd_durable_nonce_from_blockhash`](<#fd_durable_nonce_from_blockhash>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)