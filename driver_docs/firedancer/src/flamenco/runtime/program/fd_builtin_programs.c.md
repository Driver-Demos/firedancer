<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines and initializes built-in and stateless programs, precompiles, and migration configurations for the Firedancer runtime.

# Purpose
The code defines and manages a set of built-in programs and configurations for a blockchain runtime environment, specifically for Solana. It includes definitions for various built-in programs, stateless programs, and precompiled programs, each with specific configurations and migration settings. The code uses macros to define these programs and their configurations, such as `BUILTIN_PROGRAM`, `STATELESS_BUILTIN`, and `PRECOMPILE`, which help in organizing the program details like program IDs, feature offsets, and migration configurations.

The code also includes functions to initialize these built-in programs within a bank, check if a program is a BPF (Berkeley Packet Filter) program, and manage the migration of programs to BPF. The [`fd_builtin_programs_init`](<#fd_builtin_programs_init>) function is responsible for setting up the built-in programs in the bank, ensuring that they are correctly initialized based on the current bank slot and feature activation status. Additionally, the code provides functions to retrieve the list of built-in programs, stateless programs, and precompiled programs, as well as to check if a program is migrating or non-migrating. This setup is crucial for the execution and management of programs within the Solana blockchain environment.
# Imports and Dependencies

---
- `fd_builtin_programs.h`
- `fd_precompiles.h`
- `../fd_runtime.h`
- `../fd_acc_mgr.h`
- `../fd_system_ids.h`
- `../fd_system_ids_pp.h`
- `../../../util/tmpl/fd_map_perfect.c`


# Global Variables

---
### BUILTIN\_TO\_CORE\_BPF\_STAKE\_PROGRAM\_CONFIG
- **Type**: ``fd_core_bpf_migration_config_t``
- **Description**: Defines a configuration for migrating the Solana stake program to the core BPF (Berkeley Packet Filter) system. It includes pointers to the program's buffer address and ID, an offset for enabling the migration feature, and a target identifier for the migration.
- **Use**: Used to configure the migration of the Solana stake program to the core BPF system.


---
### MIGRATE\_BUILTIN\_TO\_CORE\_BPF\_STAKE\_PROGRAM\_CONFIG
- **Type**: ``fd_core_bpf_migration_config_t * const``
- **Description**: A pointer to a constant `fd_core_bpf_migration_config_t` structure that holds the configuration for migrating the Solana stake program to the core BPF (Berkeley Packet Filter) system. This configuration includes details such as the source buffer address, feature offset, and program ID.
- **Use**: Used to reference the migration configuration for the Solana stake program to the core BPF system.


---
### BUILTIN\_TO\_CORE\_BPF\_CONFIG\_PROGRAM\_CONFIG
- **Type**: ``fd_core_bpf_migration_config_t``
- **Description**: Defines a configuration for migrating the Solana config program to the core BPF (Berkeley Packet Filter) system. It includes pointers to the program's buffer address and ID, an offset for enabling the migration feature, and a target type indicating the migration target as a built-in program.
- **Use**: Used to configure the migration of the Solana config program to the core BPF system.


---
### MIGRATE\_BUILTIN\_TO\_CORE\_BPF\_CONFIG\_PROGRAM\_CONFIG
- **Type**: ``fd_core_bpf_migration_config_t * const``
- **Description**: A pointer to a constant `fd_core_bpf_migration_config_t` structure that holds configuration details for migrating the built-in configuration program to the core BPF system. This structure includes addresses and offsets related to the migration process.
- **Use**: Used to reference the migration configuration for the built-in configuration program in the core BPF system.


---
### BUILTIN\_TO\_CORE\_BPF\_ADDRESS\_LOOKUP\_TABLE\_PROGRAM\_CONFIG
- **Type**: ``fd_core_bpf_migration_config_t``
- **Description**: Defines a configuration for migrating the Address Lookup Table program to the Core BPF system. It includes pointers to the program's buffer address and ID, an offset for enabling the migration feature, and a target type indicating it is a built-in program.
- **Use**: Used to configure the migration of the Address Lookup Table program to the Core BPF system.


---
### MIGRATE\_BUILTIN\_TO\_CORE\_BPF\_ADDRESS\_LOOKUP\_TABLE\_PROGRAM\_CONFIG
- **Type**: ``fd_core_bpf_migration_config_t * const``
- **Description**: A pointer to a constant `fd_core_bpf_migration_config_t` structure that holds the configuration for migrating the Address Lookup Table program to the Core BPF system. This configuration includes the buffer address, feature offset, and program ID related to the migration process.
- **Use**: Used to reference the migration configuration for the Address Lookup Table program in the Core BPF system.


---
### STATELESS\_TO\_CORE\_BPF\_FEATURE\_GATE\_PROGRAM\_CONFIG
- **Type**: ``fd_core_bpf_migration_config_t``
- **Description**: Defines a configuration for migrating a feature gate program from a stateless to a core BPF environment. It includes addresses for the program buffer and program ID, an offset for enabling the feature, and a target migration type.
- **Use**: Used to configure the migration of the feature gate program to a core BPF environment.


---
### MIGRATE\_STATELESS\_TO\_CORE\_BPF\_FEATURE\_GATE\_PROGRAM\_CONFIG
- **Type**: ``fd_core_bpf_migration_config_t * const``
- **Description**: A pointer to a constant `fd_core_bpf_migration_config_t` structure that holds configuration details for migrating the stateless feature gate program to the core BPF system. This configuration includes the buffer address, feature offset, and program ID related to the migration process.
- **Use**: Used to reference the configuration for migrating the stateless feature gate program to the core BPF system.


---
### fd\_solana\_slashing\_program\_verified\_build\_hash\_simd\_204
- **Type**: ``fd_hash_t``
- **Description**: Contains a hash value for the Solana slashing program using SIMD 204. The hash is represented as an array of unsigned characters.
- **Use**: Used to verify the build of the Solana slashing program.


---
### STATELESS\_TO\_CORE\_BPF\_SLASHING\_PROGRAM\_CONFIG
- **Type**: ``fd_core_bpf_migration_config_t``
- **Description**: Defines a configuration for migrating a stateless slashing program to the core BPF system. It includes addresses, feature offsets, and identifiers necessary for the migration process.
- **Use**: Used to configure the migration of the slashing program to the core BPF system.


---
### MIGRATE\_STATELESS\_TO\_CORE\_BPF\_SLASHING\_PROGRAM\_CONFIG
- **Type**: ``fd_core_bpf_migration_config_t * const``
- **Description**: A pointer to a constant `fd_core_bpf_migration_config_t` structure that holds configuration details for migrating the stateless slashing program to the core BPF environment. This configuration includes addresses, feature offsets, and program identifiers necessary for the migration process.
- **Use**: Used to reference the configuration for migrating the stateless slashing program to the core BPF environment.


---
### stateless\_programs\_builtins
- **Type**: ``fd_stateless_builtin_program_t[]``
- **Description**: An array of `fd_stateless_builtin_program_t` structures that define stateless built-in programs. It includes the `FEATURE_PROGRAM_BUILTIN` and `SLASHING_PROGRAM_BUILTIN` entries.
- **Use**: Used to store and manage stateless built-in programs for the system.


---
### precompiles
- **Type**: ``fd_precompile_program_t[]``
- **Description**: An array of precompiled program configurations, each represented by an `fd_precompile_program_t` structure. This array includes precompiled programs for SECP256R1, KECCAK SECP, and ED25519 signature verification.
- **Use**: Used to store and manage precompiled program configurations for cryptographic operations.


---
### builtin\_programs
- **Type**: ``fd_builtin_program_t const[]``
- **Description**: An array of constant `fd_builtin_program_t` structures that define various built-in programs. Each element in the array represents a specific built-in program with its associated program ID, name, feature offset, and migration configuration.
- **Use**: Used to store and manage the built-in programs available in the system.


---
### migrating\_builtins
- **Type**: ``fd_core_bpf_migration_config_t const *` array`
- **Description**: An array of pointers to `fd_core_bpf_migration_config_t` structures. Each element in the array represents a configuration for migrating a specific built-in program to the Core BPF (Berkeley Packet Filter) system.
- **Use**: Used to store configurations for migrating built-in programs to Core BPF.


# Functions

---
### fd\_builtin\_is\_bpf<!-- {{#callable:fd_builtin_is_bpf}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_builtin_programs.c#L185>)

Checks if a given account is owned by the BPF loader upgradeable program.
- **Inputs**:
    - ``funk``: A pointer to an `fd_funk_t` structure, representing the current state of the transaction.
    - ``xid``: A pointer to a constant `fd_funk_txn_xid_t` structure, representing the transaction ID.
    - ``pubkey``: A pointer to a constant `fd_pubkey_t` structure, representing the public key of the account to check.
- **Logic and Control Flow**:
    - Initialize a transaction account record `rec` using `fd_txn_account_init_from_funk_readonly` with the provided `pubkey`, `funk`, and `xid`.
    - If the initialization returns an error (`err` is non-zero), return 0, indicating the account is not owned by the BPF loader upgradeable program.
    - Retrieve the owner of the account using `fd_txn_account_get_owner`.
    - Compare the retrieved owner with `fd_solana_bpf_loader_upgradeable_program_id` using `memcmp`.
    - Return 1 if the owner matches `fd_solana_bpf_loader_upgradeable_program_id`, otherwise return 0.
- **Output**: Returns an integer: 1 if the account is owned by the BPF loader upgradeable program, otherwise 0.


---
### fd\_write\_builtin\_account<!-- {{#callable:fd_write_builtin_account}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_builtin_programs.c#L207>)

Writes a built-in account to the bank with specified data and updates the bank's capitalization.
- **Inputs**:
    - `bank`: A pointer to `fd_bank_t`, representing the bank where the account will be written.
    - `accdb`: A pointer to `fd_accdb_user_t`, representing the account database user.
    - `xid`: A pointer to `fd_funk_txn_xid_t`, representing the transaction ID.
    - `capture_ctx`: A pointer to `fd_capture_ctx_t`, representing the capture context.
    - `pubkey`: A constant `fd_pubkey_t`, representing the public key of the account.
    - `data`: A constant character pointer, representing the data to be written to the account.
    - `sz`: An unsigned long, representing the size of the data to be written.
- **Logic and Control Flow**:
    - Initialize a transaction account record `rec` and a preparation structure `prepare`.
    - Call `fd_txn_account_init_from_funk_mutable` to initialize the account from the mutable funk with the given parameters and check if it succeeds.
    - Compute the previous hash of the account using `fd_hashes_account_lthash`.
    - Set the account data, lamports, executable flag, and owner using `fd_txn_account_set_data`, `fd_txn_account_set_lamports`, `fd_txn_account_set_executable`, and `fd_txn_account_set_owner` respectively.
    - Update the long-term hash with `fd_hashes_update_lthash`.
    - Finalize the mutable transaction account with `fd_txn_account_mutable_fini`.
    - Increment the bank's capitalization by 1 using `fd_bank_capitalization_set`.
- **Output**: No return value; the function modifies the bank and account state directly.


---
### write\_inline\_spl\_native\_mint\_program\_account<!-- {{#callable:write_inline_spl_native_mint_program_account}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_builtin_programs.c#L243>)

Initializes a mutable transaction account for the SPL native mint program with predefined data and settings.
- **Inputs**:
    - ``accdb``: A pointer to `fd_accdb_user_t`, representing the account database user context.
    - ``xid``: A pointer to `fd_funk_txn_xid_t`, representing the transaction ID context.
- **Logic and Control Flow**:
    - Immediately returns due to a placeholder condition (`if( true )`) that indicates a hack related to the cluster type field in Agave.
    - Defines a constant pointer `key` to the SPL native mint ID and an array `rec` for the transaction account.
    - Defines a static array `data` with predefined values to be used as account data.
    - Initializes a mutable transaction account using `fd_txn_account_init_from_funk_mutable` with the key, account database, transaction ID, and data size.
    - Checks the success of the account initialization with `FD_TEST`.
    - Sets the lamports of the account to 1,000,000,000 using `fd_txn_account_set_lamports`.
    - Sets the account as non-executable using `fd_txn_account_set_executable`.
    - Sets the owner of the account to the SPL token ID using `fd_txn_account_set_owner`.
    - Sets the account data using `fd_txn_account_set_data` with the predefined `data` array.
    - Finalizes the mutable transaction account with `fd_txn_account_mutable_fini`.
- **Output**: No output is returned as the function is of type `void`.


---
### fd\_builtin\_programs\_init<!-- {{#callable:fd_builtin_programs_init}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_builtin_programs.c#L277>)

Initializes built-in programs in a bank by writing executable accounts for each program based on specific conditions.
- **Inputs**:
    - ``bank``: A pointer to `fd_bank_t`, representing the bank where the built-in programs will be initialized.
    - ``accdb``: A pointer to `fd_accdb_user_t`, representing the account database user context.
    - ``xid``: A constant pointer to `fd_funk_txn_xid_t`, representing the transaction ID context.
    - ``capture_ctx``: A pointer to `fd_capture_ctx_t`, representing the capture context for the operation.
- **Logic and Control Flow**:
    - Retrieve the list of built-in programs using `fd_builtins()`.
    - Iterate over each built-in program using a loop from 0 to `fd_num_builtins()`.
    - For each program, check if the bank slot is 0, the feature offset is `NO_ENABLE_FEATURE_ID`, and the program is not a BPF program using `fd_builtin_is_bpf()`. If true, write the built-in account using `fd_write_builtin_account()`.
    - If the program has a core BPF migration config and the feature is active, skip writing the account.
    - If the program has an enable feature offset and the feature is not active, skip writing the account.
    - Otherwise, write the built-in account using `fd_write_builtin_account()`.
    - Check the bank's cluster version. If the major version is 1, write precompiled accounts with data set to 1. Otherwise, write them with empty data.
    - Write the inline SPL token mint program account using `write_inline_spl_native_mint_program_account()`.
- **Output**: No return value; the function operates by modifying the state of the bank and account database.
- **Functions Called**:
    - [`fd_builtins`](<#fd_builtins>)
    - [`fd_num_builtins`](<#fd_num_builtins>)
    - [`fd_builtin_is_bpf`](<#fd_builtin_is_bpf>)
    - [`fd_write_builtin_account`](<#fd_write_builtin_account>)
    - [`write_inline_spl_native_mint_program_account`](<#write_inline_spl_native_mint_program_account>)


---
### fd\_builtins<!-- {{#callable:fd_builtins}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_builtin_programs.c#L316>)

Returns a pointer to the array of built-in programs.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the `builtin_programs` array.
- **Output**: A pointer to the `builtin_programs` array, which is of type `fd_builtin_program_t const *`.


---
### fd\_num\_builtins<!-- {{#callable:fd_num_builtins}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_builtin_programs.c#L321>)

Returns the total number of built-in programs defined in the system.
- **Inputs**: None
- **Logic and Control Flow**:
    - Accesses the `BUILTIN_PROGRAMS_COUNT` macro, which represents the number of built-in programs.
    - Returns the value of `BUILTIN_PROGRAMS_COUNT`.
- **Output**: An unsigned long integer representing the number of built-in programs.


---
### fd\_stateless\_builtins<!-- {{#callable:fd_stateless_builtins}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_builtin_programs.c#L326>)

Returns a pointer to the array of stateless built-in programs.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the value of the `stateless_programs_builtins` array.
- **Output**: A pointer to a constant `fd_stateless_builtin_program_t` array, specifically `stateless_programs_builtins`.


---
### fd\_num\_stateless\_builtins<!-- {{#callable:fd_num_stateless_builtins}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_builtin_programs.c#L331>)

Returns the number of stateless built-in programs.
- **Inputs**: None
- **Logic and Control Flow**:
    - Accesses the `STATELESS_BUILTINS_COUNT` macro, which calculates the number of stateless built-in programs by dividing the size of the `stateless_programs_builtins` array by the size of a single `fd_stateless_builtin_program_t` element.
    - Returns the value of `STATELESS_BUILTINS_COUNT`.
- **Output**: An unsigned long integer representing the number of stateless built-in programs.


---
### fd\_precompiles<!-- {{#callable:fd_precompiles}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_builtin_programs.c#L336>)

Returns a pointer to the `precompiles` array.
- **Inputs**: None
- **Logic and Control Flow**:
    - The function directly returns the `precompiles` array without any additional logic or computation.
- **Output**: A pointer to a constant `fd_precompile_program_t` array named `precompiles`.


---
### fd\_num\_precompiles<!-- {{#callable:fd_num_precompiles}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_builtin_programs.c#L341>)

Returns the number of precompiled programs defined in the system.
- **Inputs**: None
- **Logic and Control Flow**:
    - Accesses the `PRECOMPILE_PROGRAMS_COUNT` macro, which represents the number of precompiled programs.
    - Returns the value of `PRECOMPILE_PROGRAMS_COUNT`.
- **Output**: An unsigned long integer representing the number of precompiled programs.


---
### fd\_is\_migrating\_builtin\_program<!-- {{#callable:fd_is_migrating_builtin_program}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_builtin_programs.c#L346>)

Checks if a given program identified by `pubkey` is migrating to BPF and updates `migrated_yet` accordingly.
- **Inputs**:
    - `txn_ctx`: A pointer to a `fd_exec_txn_ctx_t` structure containing transaction context information, including the current slot and feature set.
    - `pubkey`: A pointer to a `fd_pubkey_t` structure representing the public key of the program to check for migration.
    - `migrated_yet`: A pointer to an `uchar` that will be set to 1 if the program has migrated to BPF, otherwise it remains 0.
- **Logic and Control Flow**:
    - Initialize `*migrated_yet` to 0, indicating no migration by default.
    - Iterate over each migration configuration in `migrating_builtins`.
    - For each configuration, compare the `pubkey` with the `builtin_program_id` in the configuration using `memcmp`.
    - If a match is found, check if the `enable_feature_offset` is not `NO_ENABLE_FEATURE_ID` and if the feature is active using `FD_FEATURE_ACTIVE_OFFSET`.
    - If the feature is active, set `*migrated_yet` to 1, indicating the program has migrated to BPF.
    - Return 1 if a matching configuration is found, otherwise return 0 after the loop.
- **Output**: Returns 1 if the program is found in the migration configurations and has migrated, otherwise returns 0.


---
### fd\_is\_non\_migrating\_builtin\_program<!-- {{#callable:fd_is_non_migrating_builtin_program}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_builtin_programs.c#L369>)

Checks if a given public key corresponds to a non-migrating built-in program.
- **Inputs**:
    - `pubkey`: A pointer to a `fd_pubkey_t` structure representing the public key to check.
- **Logic and Control Flow**:
    - Calls the function `fd_non_migrating_builtins_tbl_contains` with the provided `pubkey` to check if it is in the non-migrating built-ins table.
    - Returns the result of the check as a boolean value, converted to an unsigned char.
- **Output**: Returns an unsigned char (0 or 1) indicating whether the public key is a non-migrating built-in program.



---
Made with ❤️ by [Driver](https://www.driver.ai/)