<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for executing and managing compute budget instructions in a transaction context.

# Purpose
The code is a C implementation for managing and executing compute budget programs within a transaction execution context. It includes functions to determine the type of program being executed, check if an instruction is related to compute budget, and calculate default compute unit limits based on the number of instructions. The code also provides functionality to sanitize requested heap sizes and compute unit limits, ensuring they fall within predefined constraints. The main function, [`fd_executor_compute_budget_program_execute_instructions`](<#fd_executor_compute_budget_program_execute_instructions>), processes each instruction in a transaction, updating the compute budget details and handling errors related to invalid or duplicate instructions.

The code is structured to interact with a transaction context, represented by `fd_exec_txn_ctx_t`, and uses several helper functions and macros to perform operations like checking program types and calculating limits. It defines constants for default compute unit limits and includes references to external resources for further details on the implementation. The code is intended to be part of a larger system, likely a blockchain or distributed ledger, where compute budgets are crucial for managing resource allocation during transaction execution.
# Imports and Dependencies

---
- `fd_compute_budget_program.h`
- `../fd_runtime_err.h`
- `../fd_system_ids.h`
- `../fd_executor.h`
- `../context/fd_exec_txn_ctx.h`
- `fd_builtin_programs.h`
- `../fd_compute_budget_details.h`


# Functions

---
### get\_program\_kind<!-- {{#callable:get_program_kind}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_compute_budget_program.c#L16>)

Determines the kind of program (builtin, migrating builtin, or not builtin) based on the transaction context and instruction.
- **Inputs**:
    - `txn_ctx`: A pointer to a `fd_exec_txn_ctx_t` structure that contains the transaction context.
    - `instr`: A pointer to a `fd_txn_instr_t` structure that represents the transaction instruction.
- **Logic and Control Flow**:
    - Retrieve the account addresses from the transaction context using `fd_txn_get_acct_addrs` and store them in `txn_accs`.
    - Get the program public key from `txn_accs` using the program ID from `instr` and store it in `program_pubkey`.
    - Check if the program is a non-migrating builtin using [`fd_is_non_migrating_builtin_program`](<fd_builtin_programs.c.md#fd_is_non_migrating_builtin_program>); if true, return `FD_PROGRAM_KIND_BUILTIN`.
    - Check if the program is a migrating builtin using [`fd_is_migrating_builtin_program`](<fd_builtin_programs.c.md#fd_is_migrating_builtin_program>); if true and not migrated yet, return `FD_PROGRAM_KIND_BUILTIN`.
    - If the program is a migrating builtin and has been migrated, return `FD_PROGRAM_KIND_MIGRATING_BUILTIN`.
    - If none of the above conditions are met, return `FD_PROGRAM_KIND_NOT_BUILTIN`.
- **Output**: Returns an `uchar` indicating the program kind: `FD_PROGRAM_KIND_BUILTIN`, `FD_PROGRAM_KIND_MIGRATING_BUILTIN`, or `FD_PROGRAM_KIND_NOT_BUILTIN`.
- **Functions Called**:
    - [`fd_is_non_migrating_builtin_program`](<fd_builtin_programs.c.md#fd_is_non_migrating_builtin_program>)
    - [`fd_is_migrating_builtin_program`](<fd_builtin_programs.c.md#fd_is_migrating_builtin_program>)


---
### is\_compute\_budget\_instruction<!-- {{#callable:is_compute_budget_instruction}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_compute_budget_program.c#L44>)

Checks if a given transaction instruction is a compute budget instruction by comparing the program public key with a predefined compute budget program ID.
- **Inputs**:
    - `txn`: A pointer to the `fd_txn_t` structure representing the transaction.
    - `txn_payload`: A pointer to the transaction payload data.
    - `instr`: A pointer to the `fd_txn_instr_t` structure representing the transaction instruction to check.
- **Logic and Control Flow**:
    - Retrieve the account addresses associated with the transaction using `fd_txn_get_acct_addrs` and store them in `txn_accs`.
    - Get the program public key from `txn_accs` using the `program_id` from `instr` and store it in `program_pubkey`.
    - Compare `program_pubkey` with the predefined compute budget program ID `fd_solana_compute_budget_program_id.key` using `memcmp`.
    - Return the result of the comparison, which is 0 if they match, indicating the instruction is a compute budget instruction.
- **Output**: Returns an integer that is 0 if the instruction is a compute budget instruction, otherwise a non-zero value.


---
### calculate\_default\_compute\_unit\_limit<!-- {{#callable:calculate_default_compute_unit_limit}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_compute_budget_program.c#L58>)

Calculates the default compute unit limit based on the number of builtin and non-builtin instructions.
- **Inputs**:
    - `num_builtin_instrs`: The number of builtin instructions.
    - `num_non_builtin_instrs`: The number of non-builtin instructions.
- **Logic and Control Flow**:
    - Multiply `num_builtin_instrs` by `MAX_BUILTIN_ALLOCATION_COMPUTE_UNIT_LIMIT` using `fd_ulong_sat_mul`.
    - Multiply `num_non_builtin_instrs` by `DEFAULT_INSTRUCTION_COMPUTE_UNIT_LIMIT` using `fd_ulong_sat_mul`.
    - Add the results of the two multiplications using `fd_ulong_sat_add`.
- **Output**: Returns the sum of the computed values as an unsigned long integer.


---
### sanitize\_requested\_heap\_size<!-- {{#callable:sanitize_requested_heap_size}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_compute_budget_program.c#L68>)

Validates if a given heap size in bytes is within specified limits and aligned to a defined granularity.
- **Inputs**:
    - `bytes`: The requested heap size in bytes to validate.
- **Logic and Control Flow**:
    - Checks if `bytes` is greater than `FD_MAX_HEAP_FRAME_BYTES` or less than `FD_MIN_HEAP_FRAME_BYTES`.
    - Checks if `bytes` is not a multiple of `FD_HEAP_FRAME_BYTES_GRANULARITY`.
    - Returns 0 if any of the above conditions are true, indicating an invalid heap size.
    - Returns 1 if none of the conditions are true, indicating a valid heap size.
- **Output**: Returns an integer: 1 if the heap size is valid, 0 if it is invalid.


---
### fd\_sanitize\_compute\_unit\_limits<!-- {{#callable:fd_sanitize_compute_unit_limits}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_compute_budget_program.c#L73>)

Sanitizes and computes limits for compute units, heap size, and loaded accounts data size in a transaction context.
- **Inputs**:
    - `ctx`: A pointer to `fd_exec_txn_ctx_t`, which contains the transaction context and compute budget details.
- **Logic and Control Flow**:
    - Retrieve `compute_budget_details` from the transaction context `ctx`.
    - If `has_requested_heap_size` is true, check if the `heap_size` is valid using [`sanitize_requested_heap_size`](<#sanitize_requested_heap_size>). If invalid, log an error and return `FD_RUNTIME_TXN_ERR_INSTRUCTION_ERROR`.
    - If `has_compute_units_limit_update` is false, calculate the default compute unit limit using [`calculate_default_compute_unit_limit`](<#calculate_default_compute_unit_limit>) and assign it to `compute_unit_limit`.
    - Set `compute_unit_limit` to the minimum of `FD_MAX_COMPUTE_UNIT_LIMIT` and the current `compute_unit_limit`.
    - Set `compute_meter` to the value of `compute_unit_limit`.
    - If `has_loaded_accounts_data_size_limit_update` is true, check if `loaded_accounts_data_size_limit` is zero. If so, return `FD_RUNTIME_TXN_ERR_INVALID_LOADED_ACCOUNTS_DATA_SIZE_LIMIT`.
    - Set `loaded_accounts_data_size_limit` to the minimum of `FD_VM_LOADED_ACCOUNTS_DATA_SIZE_LIMIT` and the current `loaded_accounts_data_size_limit`.
    - Return `FD_RUNTIME_EXECUTE_SUCCESS` to indicate successful execution.
- **Output**: Returns an integer status code, either `FD_RUNTIME_EXECUTE_SUCCESS` for success or an error code for specific failures.
- **Functions Called**:
    - [`sanitize_requested_heap_size`](<#sanitize_requested_heap_size>)
    - [`calculate_default_compute_unit_limit`](<#calculate_default_compute_unit_limit>)


---
### fd\_executor\_compute\_budget\_program\_execute\_instructions<!-- {{#callable:fd_executor_compute_budget_program_execute_instructions}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_compute_budget_program.c#L115>)

Processes transaction instructions to update compute budget details and checks for errors or duplicates.
- **Inputs**:
    - ``ctx``: A pointer to `fd_exec_txn_ctx_t`, which contains the transaction context and compute budget details.
- **Logic and Control Flow**:
    - Initialize `details` to point to `ctx->compute_budget_details`.
    - Iterate over each instruction in the transaction using a loop.
    - For each instruction, determine if it is a builtin or non-builtin and update the respective counters in `details`.
    - Check if the instruction is a compute budget instruction; if not, continue to the next instruction.
    - Deserialize the instruction data into a `fd_compute_budget_program_instruction_t` structure.
    - Check for errors during deserialization and return an error code if any are found.
    - Use a switch statement to handle different types of compute budget instructions, updating `details` accordingly.
    - Check for duplicate instructions and return an error code if any are found.
    - Return `FD_RUNTIME_EXECUTE_SUCCESS` if all instructions are processed without errors.
- **Output**: Returns an integer status code indicating success or a specific error related to instruction processing.
- **Functions Called**:
    - [`get_program_kind`](<#get_program_kind>)
    - [`is_compute_budget_instruction`](<#is_compute_budget_instruction>)


---
### fd\_compute\_budget\_program\_execute<!-- {{#callable:fd_compute_budget_program_execute}} -->
[View Source →](<../../../../../../src/flamenco/runtime/program/fd_compute_budget_program.c#L195>)

Updates the compute units in the execution context and returns a success status.
- **Inputs**:
    - `ctx`: A pointer to an `fd_exec_instr_ctx_t` structure, which represents the execution instruction context.
- **Logic and Control Flow**:
    - Calls the macro `FD_EXEC_CU_UPDATE` with `ctx` and `DEFAULT_COMPUTE_UNITS` to update the compute units in the execution context.
    - Returns the constant `FD_EXECUTOR_INSTR_SUCCESS` to indicate successful execution.
- **Output**: Returns an integer status code `FD_EXECUTOR_INSTR_SUCCESS` indicating successful execution.



---
Made with ❤️ by [Driver](https://www.driver.ai/)