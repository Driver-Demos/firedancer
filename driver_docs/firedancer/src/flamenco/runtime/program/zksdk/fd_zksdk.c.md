<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for processing and verifying zero-knowledge proofs in a runtime environment.

# Purpose
The code defines two functions, [`fd_zksdk_process_close_context_state`](<#fd_zksdk_process_close_context_state>) and [`fd_zksdk_process_verify_proof`](<#fd_zksdk_process_verify_proof>), which are part of a system for handling zero-knowledge proofs (ZKP) in a blockchain context. These functions are designed to process and verify cryptographic proofs related to account transactions. The [`fd_zksdk_process_close_context_state`](<#fd_zksdk_process_close_context_state>) function manages the closing of a proof context by borrowing account data, verifying ownership, and transferring lamports (a unit of currency) between accounts. It ensures that the proof and destination accounts are distinct and that the owner of the proof context is valid before performing the transfer and resetting the proof account's state.

The [`fd_zksdk_process_verify_proof`](<#fd_zksdk_process_verify_proof>) function verifies different types of zero-knowledge proofs based on an instruction identifier. It uses a switch-case structure to select the appropriate verification function for each proof type. The function handles proof data either from instruction data or from account data, ensuring the data's validity and integrity. If additional accounts are provided, it creates a context state by borrowing account data and setting up the proof context account with the necessary authority and data. Both functions return specific error codes if any validation or operation fails, ensuring robust error handling in the execution of blockchain instructions.
# Imports and Dependencies

---
- `fd_zksdk_private.h`
- `../../fd_borrowed_account.h`
- `../../fd_system_ids.h`


# Functions

---
### fd\_zksdk\_process\_close\_context\_state<!-- {{#callable:fd_zksdk_process_close_context_state}} -->
[View Source →](<../../../../../../../src/flamenco/runtime/program/zksdk/fd_zksdk.c#L7>)

Processes the closure of a context state by verifying account signatures, transferring lamports, and resetting account data.
- **Inputs**:
    - `ctx`: A pointer to `fd_exec_instr_ctx_t`, which contains the execution context and instruction data.
- **Logic and Control Flow**:
    - Define constants for account indices: `ACC_IDX_PROOF`, `ACC_IDX_DEST`, and `ACC_IDX_OWNER`.
    - Initialize arrays for public keys: `owner_pubkey`, `proof_pubkey`, and `dest_pubkey`.
    - Borrow the owner account and verify it is a signer; if not, return an error code.
    - Borrow the proof and destination accounts to obtain their public keys.
    - Check if the proof and destination public keys are equal; if so, return an error.
    - Re-borrow the proof account and verify its data length is sufficient.
    - Retrieve the expected owner address from the proof context state metadata.
    - Verify the owner public key matches the expected owner address; if not, return an error.
    - Re-borrow the destination account and transfer lamports from the proof account to the destination account.
    - Set the lamports, data length, and owner of the proof account to zero and the system program ID, respectively.
    - Return success if all operations complete without errors.
- **Output**: Returns an integer status code indicating success or a specific error condition.


---
### fd\_zksdk\_process\_verify\_proof<!-- {{#callable:fd_zksdk_process_verify_proof}} -->
[View Source →](<../../../../../../../src/flamenco/runtime/program/zksdk/fd_zksdk.c#L101>)

Verifies a zero-knowledge proof (ZKP) based on the instruction data and updates the context state if necessary.
- **Inputs**:
    - `ctx`: A pointer to `fd_exec_instr_ctx_t` structure containing the execution context, including instruction data and account information.
- **Logic and Control Flow**:
    - Initialize variables and define buffer sizes for proof context state and auxiliary memory.
    - Determine the specific verification function to use based on the instruction ID (`instr_id`).
    - Check if the instruction data size is exactly 5 bytes to decide whether to read proof data from an account or directly from instruction data.
    - If reading from an account, borrow the proof data account, calculate the proof data offset, and verify the data length.
    - If reading from instruction data, verify the data size matches the expected proof data size.
    - Call the specific verification function to verify the ZKP using the context and proof data.
    - If additional accounts are provided, create or update the context state by borrowing the necessary accounts and setting the data in the proof context account.
    - Return success or an error code based on the verification and context state update results.
- **Output**: Returns `FD_EXECUTOR_INSTR_SUCCESS` on successful verification and context update, or an error code if verification fails or data is invalid.



---
Made with ❤️ by [Driver](https://www.driver.ai/)