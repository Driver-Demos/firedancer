<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements Strobe-128 internals and Merlin transcript functions for cryptographic operations.

# Purpose
The code implements a cryptographic protocol using the Strobe-128 framework, which is a variant of the Strobe protocol designed for lightweight cryptographic operations. The code provides functions to initialize and manage a cryptographic transcript using the `fd_merlin_transcript_t` structure. The main operations include initializing the transcript with a label, appending messages and 64-bit unsigned integers to the transcript, and generating challenge bytes. These operations are built on top of the Strobe-128 functions, which handle absorbing and squeezing data, as well as managing cryptographic operations with specific flags.

The code defines several static functions for internal use, such as [`strobe128_run_f`](<#strobe128_run_f>), [`strobe128_absorb`](<#strobe128_absorb>), [`strobe128_squeeze`](<#strobe128_squeeze>), and [`strobe128_begin_op`](<#strobe128_begin_op>), which manage the state of the Strobe-128 context (`fd_merlin_strobe128_t`). The [`fd_merlin_transcript_init`](<#fd_merlin_transcript_init>) function initializes the transcript with a domain separation label, while [`fd_merlin_transcript_append_message`](<#fd_merlin_transcript_append_message>) and [`fd_merlin_transcript_append_u64`](<#fd_merlin_transcript_append_u64>) allow appending data to the transcript. The [`fd_merlin_transcript_challenge_bytes`](<#fd_merlin_transcript_challenge_bytes>) function generates a cryptographic challenge by squeezing bytes from the Strobe-128 state. The code relies on the Keccak-256 cryptographic hash function, as indicated by the inclusion of `fd_keccak256_private.h`, to perform core cryptographic operations.
# Imports and Dependencies

---
- `fd_merlin.h`
- `../../../../../ballet/keccak256/fd_keccak256_private.h`


# Functions

---
### strobe128\_run\_f<!-- {{#callable:strobe128_run_f}} -->
[View Source →](<../../../../../../../../src/flamenco/runtime/program/zksdk/merlin/fd_merlin.c#L16>)

Performs a transformation on the state of a `fd_merlin_strobe128_t` context using bitwise operations and a Keccak-256 permutation.
- **Inputs**:
    - `ctx`: A pointer to a `fd_merlin_strobe128_t` structure that holds the state and position information for the Strobe-128 protocol.
- **Logic and Control Flow**:
    - XORs the byte at the current position in `ctx->state_bytes` with `ctx->pos_begin`.
    - XORs the byte at the next position in `ctx->state_bytes` with `0x04`.
    - XORs the byte at position `STROBE_R + 1` in `ctx->state_bytes` with `0x80`.
    - Calls `fd_keccak256_core` to apply the Keccak-256 permutation on `ctx->state`.
    - Resets `ctx->pos` and `ctx->pos_begin` to 0.
- **Output**: No return value; modifies the state of the `fd_merlin_strobe128_t` context in place.


---
### strobe128\_absorb<!-- {{#callable:strobe128_absorb}} -->
[View Source →](<../../../../../../../../src/flamenco/runtime/program/zksdk/merlin/fd_merlin.c#L26>)

Processes input data by XORing it with the current state and triggers a permutation when the state buffer is full.
- **Inputs**:
    - `ctx`: A pointer to the `fd_merlin_strobe128_t` context structure, which holds the current state and position.
    - `data`: A pointer to the input data array to be absorbed into the state.
    - `data_len`: The length of the input data array.
- **Logic and Control Flow**:
    - Iterates over each byte of the input data array.
    - XORs each byte of the input data with the byte at the current position in the `state_bytes` array of the context.
    - Increments the position index `pos` after processing each byte.
    - Checks if the position index `pos` equals `STROBE_R` (166).
    - Calls [`strobe128_run_f`](<#strobe128_run_f>) to perform a permutation on the state if the position index reaches `STROBE_R`.
- **Output**: No direct output; modifies the state within the `ctx` structure.
- **Functions Called**:
    - [`strobe128_run_f`](<#strobe128_run_f>)


---
### strobe128\_squeeze<!-- {{#callable:strobe128_squeeze}} -->
[View Source →](<../../../../../../../../src/flamenco/runtime/program/zksdk/merlin/fd_merlin.c#L39>)

Extracts bytes from the internal state of the context and writes them to the output buffer, resetting the state bytes to zero and running a permutation function when necessary.
- **Inputs**:
    - `ctx`: A pointer to the `fd_merlin_strobe128_t` context structure, which holds the internal state and position.
    - `data`: A pointer to the output buffer where the extracted bytes will be written.
    - `data_len`: The number of bytes to extract and write to the output buffer.
- **Logic and Control Flow**:
    - Iterates over each byte to be extracted, as specified by `data_len`.
    - For each byte, writes the current byte from `ctx->state_bytes` at position `ctx->pos` to the `data` buffer.
    - Sets the byte in `ctx->state_bytes` at position `ctx->pos` to zero.
    - Increments `ctx->pos` to move to the next byte position.
    - Checks if `ctx->pos` equals `STROBE_R`, and if so, calls `strobe128_run_f(ctx)` to run a permutation function and reset the position.
- **Output**: The function does not return a value; it modifies the `data` buffer and the `ctx` state in place.
- **Functions Called**:
    - [`strobe128_run_f`](<#strobe128_run_f>)


---
### strobe128\_begin\_op<!-- {{#callable:strobe128_begin_op}} -->
[View Source →](<../../../../../../../../src/flamenco/runtime/program/zksdk/merlin/fd_merlin.c#L53>)

Initializes a new operation in the Strobe-128 protocol by setting flags and absorbing initial data.
- **Inputs**:
    - `ctx`: A pointer to the `fd_merlin_strobe128_t` context structure, which maintains the state of the Strobe-128 protocol.
    - `flags`: An unsigned character representing the operation flags to set for the new operation.
- **Logic and Control Flow**:
    - Store the current `pos_begin` value in `old_begin`.
    - Update `pos_begin` to the current position plus one.
    - Set `cur_flags` to the provided `flags`.
    - Create a data array containing `old_begin` and `flags`.
    - Call [`strobe128_absorb`](<#strobe128_absorb>) to absorb the data array into the context.
    - Determine if the permutation should be forced by checking if `flags` has `FLAG_C` or `FLAG_K` set.
    - If permutation is forced and `pos` is not zero, call [`strobe128_run_f`](<#strobe128_run_f>) to run the permutation.
- **Output**: No direct output; modifies the state of the `ctx` structure.
- **Functions Called**:
    - [`strobe128_absorb`](<#strobe128_absorb>)
    - [`strobe128_run_f`](<#strobe128_run_f>)


---
### strobe128\_meta\_ad<!-- {{#callable:strobe128_meta_ad}} -->
[View Source →](<../../../../../../../../src/flamenco/runtime/program/zksdk/merlin/fd_merlin.c#L87>)

Processes metadata associated with additional data in a Strobe-128 context.
- **Inputs**:
    - `ctx`: A pointer to the `fd_merlin_strobe128_t` context structure.
    - `data`: A pointer to the input data to be absorbed.
    - `data_len`: The length of the input data.
    - `more`: A flag indicating whether this is a continuation of a previous operation (non-zero) or a new operation (zero).
- **Logic and Control Flow**:
    - If `more` is zero, calls [`strobe128_begin_op`](<#strobe128_begin_op>) with the `FLAG_M` and `FLAG_A` flags to begin a new operation.
    - Calls [`strobe128_absorb`](<#strobe128_absorb>) to absorb the input data into the context.
- **Output**: No direct output; modifies the state of the `ctx` structure.
- **Functions Called**:
    - [`strobe128_begin_op`](<#strobe128_begin_op>)
    - [`strobe128_absorb`](<#strobe128_absorb>)


---
### strobe128\_ad<!-- {{#callable:strobe128_ad}} -->
[View Source →](<../../../../../../../../src/flamenco/runtime/program/zksdk/merlin/fd_merlin.c#L98>)

Processes associated data by optionally beginning a new operation and absorbing the data into the Strobe-128 context.
- **Inputs**:
    - `ctx`: A pointer to the `fd_merlin_strobe128_t` context structure.
    - `data`: A pointer to the data to be absorbed, represented as an array of unsigned characters.
    - `data_len`: The length of the data to be absorbed, represented as an unsigned long integer.
    - `more`: An unsigned character flag indicating whether to continue an existing operation (non-zero) or begin a new one (zero).
- **Logic and Control Flow**:
    - Check if `more` is zero; if so, call [`strobe128_begin_op`](<#strobe128_begin_op>) with `ctx` and `FLAG_A` to begin a new operation.
    - Call [`strobe128_absorb`](<#strobe128_absorb>) with `ctx`, `data`, and `data_len` to absorb the data into the context.
- **Output**: No direct output; modifies the state of the `fd_merlin_strobe128_t` context.
- **Functions Called**:
    - [`strobe128_begin_op`](<#strobe128_begin_op>)
    - [`strobe128_absorb`](<#strobe128_absorb>)


---
### strobe128\_prf<!-- {{#callable:strobe128_prf}} -->
[View Source →](<../../../../../../../../src/flamenco/runtime/program/zksdk/merlin/fd_merlin.c#L109>)

Performs a pseudo-random function operation using the Strobe-128 protocol.
- **Inputs**:
    - `ctx`: A pointer to the `fd_merlin_strobe128_t` context structure.
    - `data`: A pointer to the buffer where the output data will be stored.
    - `data_len`: The length of the data to be processed.
    - `more`: A flag indicating whether this is a continuation of a previous operation (non-zero) or a new operation (zero).
- **Logic and Control Flow**:
    - If `more` is zero, calls [`strobe128_begin_op`](<#strobe128_begin_op>) with flags `FLAG_I | FLAG_A | FLAG_C` to initialize a new operation.
    - Calls [`strobe128_squeeze`](<#strobe128_squeeze>) to extract `data_len` bytes of output data into the `data` buffer.
- **Output**: No direct output; modifies the `data` buffer with the pseudo-random output.
- **Functions Called**:
    - [`strobe128_begin_op`](<#strobe128_begin_op>)
    - [`strobe128_squeeze`](<#strobe128_squeeze>)


---
### strobe128\_init<!-- {{#callable:strobe128_init}} -->
[View Source →](<../../../../../../../../src/flamenco/runtime/program/zksdk/merlin/fd_merlin.c#L120>)

Initializes the Strobe-128 context with a given label and prepares it for further operations.
- **Inputs**:
    - `ctx`: A pointer to the `fd_merlin_strobe128_t` structure that holds the Strobe-128 context.
    - `label`: A pointer to an array of unsigned characters representing the label to initialize the context with.
    - `label_len`: The length of the label in bytes.
- **Logic and Control Flow**:
    - Initialize an array `init` with specific values that represent the initial state of the Strobe-128 protocol.
    - Set the `state_bytes` of the context to zero using `fd_memset`.
    - Copy the `init` array into the first 18 bytes of `state_bytes` using `fd_memcpy`.
    - Call `fd_keccak256_core` to process the initial state of the context.
    - Set the `pos`, `pos_begin`, and `cur_flags` fields of the context to zero.
    - Call [`strobe128_meta_ad`](<#strobe128_meta_ad>) with the context, label, label length, and a zero value to absorb the label into the context.
- **Output**: No direct output; modifies the `ctx` structure to initialize the Strobe-128 context.
- **Functions Called**:
    - [`strobe128_meta_ad`](<#strobe128_meta_ad>)


---
### fd\_merlin\_transcript\_init<!-- {{#callable:fd_merlin_transcript_init}} -->
[View Source →](<../../../../../../../../src/flamenco/runtime/program/zksdk/merlin/fd_merlin.c#L140>)

Initializes a Merlin transcript context with a specified label.
- **Inputs**:
    - `mctx`: A pointer to an `fd_merlin_transcript_t` structure that will be initialized.
    - `label`: A constant character pointer to the label used for domain separation.
    - `label_len`: An unsigned integer representing the length of the label.
- **Logic and Control Flow**:
    - Calls [`strobe128_init`](<#strobe128_init>) to initialize the Strobe-128 context within the Merlin transcript with the literal 'Merlin v1.0'.
    - Calls [`fd_merlin_transcript_append_message`](<#fd_merlin_transcript_append_message>) to append a domain separation message to the transcript using the provided label.
- **Output**: No return value; the function initializes the provided `fd_merlin_transcript_t` structure.
- **Functions Called**:
    - [`strobe128_init`](<#strobe128_init>)
    - [`fd_merlin_transcript_append_message`](<#fd_merlin_transcript_append_message>)


---
### fd\_merlin\_transcript\_append\_message<!-- {{#callable:fd_merlin_transcript_append_message}} -->
[View Source →](<../../../../../../../../src/flamenco/runtime/program/zksdk/merlin/fd_merlin.c#L148>)

Appends a labeled message to the Merlin transcript using Strobe-128 operations.
- **Inputs**:
    - `mctx`: A pointer to the `fd_merlin_transcript_t` structure, which holds the context for the transcript.
    - `label`: A constant character pointer to the label of the message.
    - `label_len`: An unsigned integer representing the length of the label.
    - `message`: A constant unsigned character pointer to the message data to append.
    - `message_len`: An unsigned integer representing the length of the message.
- **Logic and Control Flow**:
    - Calls [`strobe128_meta_ad`](<#strobe128_meta_ad>) to absorb the label into the Strobe-128 context with the `FLAG_M | FLAG_A` flags.
    - Calls [`strobe128_meta_ad`](<#strobe128_meta_ad>) to absorb the message length into the Strobe-128 context with the `FLAG_M | FLAG_A` flags and the `more` parameter set to 1.
    - Calls [`strobe128_ad`](<#strobe128_ad>) to absorb the actual message into the Strobe-128 context with the `FLAG_A` flag.
- **Output**: No return value; the function modifies the `fd_merlin_transcript_t` context in place.
- **Functions Called**:
    - [`strobe128_meta_ad`](<#strobe128_meta_ad>)
    - [`strobe128_ad`](<#strobe128_ad>)


---
### fd\_merlin\_transcript\_append\_u64<!-- {{#callable:fd_merlin_transcript_append_u64}} -->
[View Source →](<../../../../../../../../src/flamenco/runtime/program/zksdk/merlin/fd_merlin.c#L159>)

Appends a 64-bit unsigned integer to a Merlin transcript with a specified label.
- **Inputs**:
    - ``mctx``: A pointer to the `fd_merlin_transcript_t` structure that represents the Merlin transcript context.
    - ``label``: A constant character pointer to the label associated with the message.
    - ``label_len``: An unsigned integer representing the length of the label.
    - ``message_u64``: A constant unsigned long integer representing the 64-bit message to append.
- **Logic and Control Flow**:
    - Calls [`fd_merlin_transcript_append_message`](<#fd_merlin_transcript_append_message>) with the provided `mctx`, `label`, `label_len`, and a pointer to `message_u64` cast to `uchar *`, along with a message length of 8 bytes.
- **Output**: No output is returned as the function is of type `void`.
- **Functions Called**:
    - [`fd_merlin_transcript_append_message`](<#fd_merlin_transcript_append_message>)


---
### fd\_merlin\_transcript\_challenge\_bytes<!-- {{#callable:fd_merlin_transcript_challenge_bytes}} -->
[View Source →](<../../../../../../../../src/flamenco/runtime/program/zksdk/merlin/fd_merlin.c#L167>)

Generates a challenge byte sequence using the Strobe-128 protocol based on a label and buffer length.
- **Inputs**:
    - `mctx`: A pointer to the `fd_merlin_transcript_t` structure, which maintains the state of the transcript.
    - `label`: A constant character pointer to the label used in the challenge, which is a string.
    - `label_len`: An unsigned integer representing the length of the label.
    - `buffer`: A pointer to an unsigned character array where the generated challenge bytes will be stored.
    - `buffer_len`: An unsigned integer representing the length of the buffer, indicating how many bytes to generate.
- **Logic and Control Flow**:
    - Calls [`strobe128_meta_ad`](<#strobe128_meta_ad>) to absorb the label into the Strobe-128 context with the `FLAG_M | FLAG_A` flags.
    - Calls [`strobe128_meta_ad`](<#strobe128_meta_ad>) again to absorb the buffer length into the Strobe-128 context with the `FLAG_M | FLAG_A` flags and a `more` parameter set to 1.
    - Calls [`strobe128_prf`](<#strobe128_prf>) to generate the pseudo-random function output, which fills the buffer with the specified number of bytes.
- **Output**: The function does not return a value but fills the provided `buffer` with `buffer_len` bytes of challenge data.
- **Functions Called**:
    - [`strobe128_meta_ad`](<#strobe128_meta_ad>)
    - [`strobe128_prf`](<#strobe128_prf>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)