<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Unit test for verifying public key validity using zk-SDK in the Firedancer codebase.

# Purpose
The code is a unit test for verifying the validity of public keys using zero-knowledge proof (ZKP) techniques. It is designed to be executed as part of a test suite, specifically through the command `make run-test-vectors`. The test focuses on the function [`test_pubkey_validity`](<#test_pubkey_validity>), which checks the correctness of the public key validity proof by loading test transaction data, setting up the execution context, and validating the proof using several functions from the `fd_zksdk` library. The test includes scenarios for both valid and invalid proofs, ensuring that the verification functions return the expected results.

The code includes several key components: the [`load_test_tx`](<#load_test_tx>) function, which decodes hexadecimal transaction data into a byte array; the [`create_test_ctx`](<#create_test_ctx>) function, which initializes the execution context for the test; and the [`test_pubkey_validity`](<#test_pubkey_validity>) function, which performs the actual verification tests. The code also contains a benchmarking section, which is conditionally compiled based on the `BENCH` macro, to measure the performance of the proof verification function. The [`main`](<#main>) function initializes the random number generator, runs the test, and logs the result. The code is structured to be part of a larger testing framework, with dependencies on external libraries and test data.
# Imports and Dependencies

---
- `fd_zksdk_private.h`
- `../../../../ballet/hex/fd_hex.h`
- `instructions/test_fd_zksdk_pubkey_validity.h`


# Functions

---
### load\_test\_tx<!-- {{#callable:load_test_tx}} -->
[View Source →](<../../../../../../../src/flamenco/runtime/program/zksdk/test_zksdk.c#L13>)

Converts an array of hexadecimal strings into a byte array and calculates its length.
- **Inputs**:
    - `hex`: An array of strings, each representing a hexadecimal value.
    - `hex_sz`: The size of the `hex` array in bytes.
    - `tx_len`: A pointer to an unsigned long where the function will store the length of the resulting byte array.
- **Logic and Control Flow**:
    - Initialize `hex_len` to 0 to keep track of the total length of hexadecimal strings.
    - Iterate over each string in the `hex` array, calculate its length using `strlen`, and accumulate this length in `hex_len`.
    - Divide `hex_len` by 2 to determine the length of the byte array and store this value in `*tx_len`.
    - Allocate memory for the byte array `tx` with a size of `hex_len / 2`.
    - Reset `hex_len` to 0 to reuse it for tracking the position in the byte array.
    - Iterate over each string in the `hex` array again, decode each hexadecimal string into bytes using `fd_hex_decode`, and store the result in the `tx` array.
    - Return the pointer to the byte array `tx`.
- **Output**: A pointer to the allocated byte array containing the decoded bytes from the hexadecimal strings.


---
### create\_test\_ctx<!-- {{#callable:create_test_ctx}} -->
[View Source →](<../../../../../../../src/flamenco/runtime/program/zksdk/test_zksdk.c#L32>)

Initializes a test execution context for zero-knowledge proof verification by setting up instruction and transaction contexts.
- **Inputs**:
    - `ctx`: A pointer to `fd_exec_instr_ctx_t` where the function will store the execution instruction context.
    - `txn_ctx`: A pointer to `fd_exec_txn_ctx_t` which represents the transaction context to be associated with the execution context.
    - `instr`: A pointer to `fd_instr_info_t` where the function will store instruction-related data.
    - `tx`: A pointer to an array of unsigned characters representing the transaction data.
    - `tx_len`: An unsigned long integer representing the length of the transaction data.
    - `instr_off`: An unsigned long integer representing the offset within the transaction data where the instruction data begins.
    - `compute_meter`: An unsigned long integer representing the compute meter value to be set in the transaction context.
- **Logic and Control Flow**:
    - Assigns `txn_ctx` to `ctx->txn_ctx` to link the transaction context with the execution context.
    - Sets the `compute_meter` in `txn_ctx->compute_budget_details` to the provided `compute_meter` value.
    - Assigns `instr` to `ctx->instr` to link the instruction information with the execution context.
    - Sets `instr->data` to point to the transaction data starting at `instr_off`.
    - Calculates `instr->data_sz` as the difference between `tx_len` and `instr_off`, casting it to `ushort`.
    - Sets `instr->acct_cnt` to 0 to avoid filling the proof context account.
    - Initializes the log collector in `ctx->txn_ctx` with a call to `fd_log_collector_init`.
- **Output**: No return value; the function modifies the contents of the provided pointers to set up the execution context.


---
### log\_bench<!-- {{#callable:log_bench}} -->
[View Source →](<../../../../../../../src/flamenco/runtime/program/zksdk/test_zksdk.c#L51>)

Logs the performance metrics of a benchmark test, including the rate of iterations per second and the time per call.
- **Inputs**:
    - `descr`: A constant character pointer that describes the benchmark being logged.
    - `iter`: An unsigned long integer representing the number of iterations performed in the benchmark.
    - `dt`: A long integer representing the total time taken for the iterations in microseconds.
- **Logic and Control Flow**:
    - Calculate the rate of iterations per second in kilohertz (`khz`) by multiplying 1,000,000 by the number of iterations and dividing by the time taken.
    - Calculate the average time per call in nanoseconds (`tau`) by dividing the time taken by the number of iterations.
    - Log the description, rate of iterations per second, and time per call using the `FD_LOG_NOTICE` macro.
- **Output**: No return value; the function logs the performance metrics using a logging macro.


---
### test\_pubkey\_validity<!-- {{#callable:test_pubkey_validity}} -->
[View Source →](<../../../../../../../src/flamenco/runtime/program/zksdk/test_zksdk.c#L60>)

Tests the validity of a public key by verifying proofs and handling both valid and invalid cases.
- **Inputs**:
    - ``rng``: A pointer to a random number generator of type `fd_rng_t`, which is not used in the function.
- **Logic and Control Flow**:
    - Initialize variables for transaction data, offsets, context size, and compute units.
    - Load test transaction data using [`load_test_tx`](<#load_test_tx>) and create a test context with [`create_test_ctx`](<#create_test_ctx>).
    - Define pointers to the context and proof within the transaction data.
    - Verify the validity of the proof using `fd_zksdk_instr_verify_proof_pubkey_validity`, [`fd_zksdk_process_verify_proof`](<fd_zksdk.c.md#fd_zksdk_process_verify_proof>), and `fd_executor_zk_elgamal_proof_program_execute` for valid cases.
    - Modify the proof to simulate an invalid proof and verify that the functions return error codes for invalid proofs.
    - Alter the instruction data size to simulate invalid data and verify that the function returns an error code.
    - Optionally, run benchmarks if the `BENCH` macro is set, measuring the performance of the proof verification function.
    - Free the allocated transaction data memory.
- **Output**: No output is returned, but the function performs tests and logs results to verify the correctness of public key validity proofs.
- **Functions Called**:
    - [`load_test_tx`](<#load_test_tx>)
    - [`create_test_ctx`](<#create_test_ctx>)
    - [`fd_zksdk_process_verify_proof`](<fd_zksdk.c.md#fd_zksdk_process_verify_proof>)
    - [`log_bench`](<#log_bench>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../../../src/flamenco/runtime/program/zksdk/test_zksdk.c#L111>)

Initializes the environment, runs a test for public key validity, and then cleans up resources before exiting.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
- **Logic and Control Flow**:
    - Call `fd_boot` to initialize the environment with command-line arguments.
    - Create a random number generator `rng` using `fd_rng_new` and `fd_rng_join`.
    - Call [`test_pubkey_validity`](<#test_pubkey_validity>) with `rng` to run the public key validity test.
    - Clean up the random number generator by calling `fd_rng_leave` and `fd_rng_delete`.
    - Log a notice message 'pass' using `FD_LOG_NOTICE`.
    - Call `fd_halt` to terminate the program.
    - Return 0 to indicate successful execution.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`test_pubkey_validity`](<#test_pubkey_validity>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)