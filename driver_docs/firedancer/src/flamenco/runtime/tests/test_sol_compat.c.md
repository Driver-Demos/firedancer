<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests Protobuf fixtures for solfuzz/sol_compat/protosol with support for parallel and tile-based execution.

# Purpose
The `test_sol_compat.c` file is a C program designed to execute tests on Protobuf fixtures related to the `solfuzz` framework. It supports both single-threaded and multi-threaded execution modes, allowing for parallel processing of test cases. The program reads test files from specified directories, executes them using various fixture functions, and logs the results. The main components include functions for running individual tests, recursively walking through directories to find test files, and managing execution in both single-threaded and multi-threaded environments. The code uses several external libraries and headers, such as `fd_solfuzz.h`, to facilitate its operations.

The program defines a public API through its [`main`](<#main>) function, which processes command-line arguments to configure the execution environment, such as page size, page count, and workspace options. It initializes necessary resources, such as memory caches and runners, to execute the tests. The code also includes mechanisms for handling errors and logging warnings or informational messages. The multi-threaded execution is managed by distributing tasks across available tiles, with flow-control mechanisms to handle backpressure. The program is structured to handle different types of test fixtures, such as instruction, transaction, and system call tests, by identifying the test type from the file path and invoking the appropriate fixture function.
# Imports and Dependencies

---
- `fd_solfuzz.h`
- `errno.h`
- `dirent.h`
- `fcntl.h`
- `sched.h`
- `stdio.h`
- `sys/types.h`
- `sys/stat.h`
- `unistd.h`
- `../../../ballet/nanopb/pb_firedancer.h`
- `../../../tango/fd_tango.h`


# Global Variables

---
### g\_fail\_fast
- **Type**: `int`
- **Description**: A static integer variable that determines if the program should stop execution immediately after encountering the first error.
- **Use**: Used in the `visit_sync` function to decide whether to continue processing after an error occurs.


---
### g\_error\_occurred
- **Type**: `int`
- **Description**: `g_error_occurred` is a static integer variable that indicates whether an error has occurred during the execution of tests.
- **Use**: Used to track if any test has failed, setting it to 1 when a failure is detected.


---
### shutdown\_signal
- **Type**: ``uint``
- **Description**: A static global variable that is aligned to a 64-byte boundary.
- **Use**: Used to signal a shutdown condition in the program, particularly in multi-threaded execution contexts.


# Data Structures

---
### walkdir\_state
- **Type**: ``struct``
- **Members**:
    - `mcache`: Pointer to `fd_frag_meta_t`, used for metadata caching.
    - `dcache`: Pointer to `uchar`, used for data caching.
    - `depth`: Unsigned long representing the depth of the cache.
    - `chunk0`: Unsigned long representing the initial chunk index.
    - `wmark`: Unsigned long representing the watermark for cache management.
    - `seq`: Unsigned long representing the current sequence number.
    - `chunk`: Unsigned long representing the current chunk index.
    - `cr_avail`: Unsigned long representing the available credits for flow control.
    - `worker_cnt`: Unsigned long representing the number of workers.
    - `fseqs`: Pointer to an array of unsigned long pointers, used for sequence tracking by workers.
- **Description**: Manages the state for directory walking operations, including metadata and data caching, sequence tracking, and flow control for multi-threaded execution.


---
### walkdir\_state\_t
- **Type**: ``struct``
- **Members**:
    - `mcache`: Pointer to `fd_frag_meta_t`, used for metadata caching.
    - `dcache`: Pointer to `uchar`, used for data caching.
    - `depth`: Unsigned long representing the depth of the cache.
    - `chunk0`: Unsigned long indicating the initial chunk index.
    - `wmark`: Unsigned long representing the watermark for cache compaction.
    - `seq`: Unsigned long for sequence number tracking.
    - `chunk`: Unsigned long for the current chunk index.
    - `cr_avail`: Unsigned long for available credits for flow control.
    - `worker_cnt`: Unsigned long indicating the number of workers.
    - `fseqs`: Pointer to an array of unsigned long pointers, used for sequence tracking of workers.
- **Description**: `walkdir_state_t` is a structure used to manage the state of a directory walking operation in a multi-threaded environment. It includes pointers to metadata and data caches, as well as various unsigned long fields for managing cache depth, chunk indices, sequence numbers, and flow control credits. The structure also tracks the number of workers and their sequence states, facilitating parallel processing of directory entries.


---
### mt\_state
- **Type**: ``struct``
- **Members**:
    - `runners`: Pointer to an array of `fd_solfuzz_runner_t` pointers.
    - `worker_cnt`: Number of workers or threads.
    - `mcache`: Pointer to `fd_frag_meta_t`, representing metadata cache.
    - `dcache`: Pointer to `uchar`, representing data cache.
    - `fseqs`: Pointer to an array of `ulong` pointers, representing flow sequence numbers.
- **Description**: Manages the state for multi-threaded execution, including runner instances, worker count, metadata cache, data cache, and flow sequence numbers.


---
### mt\_state\_t
- **Type**: ``struct``
- **Members**:
    - `runners`: Pointer to an array of `fd_solfuzz_runner_t` pointers.
    - `worker_cnt`: Number of worker threads or processes.
    - `mcache`: Pointer to `fd_frag_meta_t`, representing metadata cache.
    - `dcache`: Pointer to a `uchar` array, representing data cache.
    - `fseqs`: Pointer to an array of `ulong` pointers, representing sequence numbers for flow control.
- **Description**: Represents the state for multi-threaded execution, managing resources like runners, metadata cache, data cache, and flow control sequences for worker threads.


# Functions

---
### run\_test1<!-- {{#callable:run_test1}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/test_sol_compat.c#L25>)

Executes a test based on the file path and returns success or failure.
- **Inputs**:
    - `runner`: A pointer to `fd_solfuzz_runner_t`, which is used to manage the test execution environment.
    - `path`: A constant character pointer representing the file path to the test file.
- **Logic and Control Flow**:
    - Open the file at the given `path` in read-only mode.
    - If the file cannot be opened, log a warning and return 0 (failure).
    - Retrieve the file's status using `fstat` to determine its size.
    - If `fstat` fails, log a warning and return 0 (failure).
    - Allocate memory for the file content using `fd_spad_alloc`.
    - Read the file content into the allocated buffer using `fd_io_read`.
    - Close the file after reading its content.
    - Initialize `ok` to 0, indicating test failure by default.
    - Log a debug message indicating the test is running.
    - Determine the type of test to run based on the `path` string and execute the corresponding fixture function.
    - If the test type is unknown, log a warning.
    - Log an info message if the test passes or a warning if it fails.
    - Return `ok`, which is 1 for success and 0 for failure.
- **Output**: Returns an integer, 1 for success and 0 for failure.
- **Functions Called**:
    - [`fd_solfuzz_instr_fixture`](<fd_solfuzz_exec.c.md#fd_solfuzz_instr_fixture>)
    - [`fd_solfuzz_txn_fixture`](<fd_solfuzz_exec.c.md#fd_solfuzz_txn_fixture>)
    - [`fd_solfuzz_elf_loader_fixture`](<fd_solfuzz_exec.c.md#fd_solfuzz_elf_loader_fixture>)
    - [`fd_solfuzz_syscall_fixture`](<fd_solfuzz_exec.c.md#fd_solfuzz_syscall_fixture>)
    - [`fd_solfuzz_vm_interp_fixture`](<fd_solfuzz_exec.c.md#fd_solfuzz_vm_interp_fixture>)
    - [`fd_solfuzz_block_fixture`](<fd_solfuzz_exec.c.md#fd_solfuzz_block_fixture>)


---
### run\_test<!-- {{#callable:run_test}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/test_sol_compat.c#L77>)

Executes a test using a specified runner and path, ensuring memory and frame usage remain consistent before and after the test.
- **Inputs**:
    - `runner`: A pointer to an `fd_solfuzz_runner_t` structure, which manages the test execution environment.
    - `path`: A constant character pointer to the path of the test file to be executed.
- **Logic and Control Flow**:
    - Store the initial frame and memory usage from `runner->spad` into `frames_used_pre_test` and `mem_used_pre_test` respectively.
    - Call `fd_spad_push` to save the current state of the scratchpad (`spad`).
    - Execute [`run_test1`](<#run_test1>) with `runner` and `path`, storing the result in `ok`.
    - Call `fd_spad_pop` to restore the previous state of the scratchpad (`spad`).
    - Store the final frame and memory usage from `runner->spad` into `frames_used_post_test` and `mem_used_post_test` respectively.
    - Use `FD_TEST` to assert that the frame and memory usage before and after the test are equal.
    - Return the result of the test execution stored in `ok`.
- **Output**: Returns an integer, 1 if the test is successful, 0 if it fails.
- **Functions Called**:
    - [`run_test1`](<#run_test1>)


---
### recursive\_walk1<!-- {{#callable:recursive_walk1}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/test_sol_compat.c#L102>)

Recursively traverses directories, processing files with a specific suffix and optionally following symbolic links.
- **Inputs**:
    - ``dir``: A pointer to a `DIR` structure representing the directory to traverse.
    - ``path``: A character array representing the current path, with a maximum length defined by `PATH_MAX`.
    - ``path_len``: The current length of the path stored in `path`.
    - ``visit``: A function pointer to a callback function that processes files with the specified suffix.
    - ``visit_ctx``: A pointer to user-defined data passed to the `visit` function.
- **Logic and Control Flow**:
    - Initialize `errno` to 0 and set `ok` to 1 to track success.
    - Iterate over directory entries using `readdir`.
    - Skip entries named '.' and '..'.
    - Calculate the length of the entry name and check if the new path length exceeds `PATH_MAX`; log a warning and continue if it does.
    - Append the entry name to the current path.
    - If the entry is a directory (`DT_DIR`), attempt to open it and recursively call `recursive_walk1` on it; close the directory afterward.
    - If the entry is a regular file (`DT_REG`), check if it has the '.fix' suffix and call the `visit` function if it does.
    - If the entry is a symbolic link (`DT_LNK`), attempt to open it as a directory; if successful, treat it as a directory, otherwise treat it as a file if the error is `ENOTDIR`.
    - Return `ok` to indicate success or failure.
- **Output**: Returns an integer `ok`, which is 1 if all operations were successful, or 0 if any operation failed.


---
### recursive\_walk<!-- {{#callable:recursive_walk}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/test_sol_compat.c#L160>)

Traverses a directory tree recursively, applying a user-defined function to each file or directory path encountered.
- **Inputs**:
    - ``path``: A constant character pointer representing the root directory path to start the traversal.
    - ``visit``: A function pointer of type `visit_path` that is called for each file or directory path encountered.
    - ``visit_ctx``: A void pointer to user-defined context data that is passed to the `visit` function.
- **Logic and Control Flow**:
    - Initialize a character array `path1` to store the path and calculate the length of the input `path`.
    - Check if the length of `path` exceeds `PATH_MAX`; if so, log a warning and return 0.
    - Initialize `path1` with the input `path` and open the directory specified by `path1`.
    - If the directory cannot be opened and the error is `ENOTDIR`, call the `visit` function with `visit_ctx`, `path1`, and `path_len`, then return the result.
    - If the directory cannot be opened for other reasons, log a warning and return 0.
    - Call the helper function [`recursive_walk1`](<#recursive_walk1>) to recursively process the directory contents.
    - Close the directory and return the result of [`recursive_walk1`](<#recursive_walk1>).
- **Output**: Returns an integer indicating success (non-zero) or failure (zero) of the directory traversal and processing.
- **Functions Called**:
    - [`recursive_walk1`](<#recursive_walk1>)


---
### visit\_sync<!-- {{#callable:visit_sync}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/test_sol_compat.c#L186>)

Executes a test on a given path and updates global error state based on the test result.
- **Inputs**:
    - `ctx`: A pointer to a `fd_solfuzz_runner_t` structure, which is used to execute the test.
    - `path`: A constant character pointer representing the file path to be tested.
    - `path_len`: An unsigned long integer representing the length of the path, which is not used in the function.
- **Logic and Control Flow**:
    - Cast `ctx` to a `fd_solfuzz_runner_t` pointer and assign it to `runner`.
    - Call [`run_test`](<#run_test>) with `runner` and `path` to execute the test and store the result in `ok`.
    - If `ok` is false, set `g_error_occurred` to 1.
    - If `g_fail_fast` is true and `ok` is false, return 0 to stop further processing.
    - Return 1 to indicate successful execution or continuation.
- **Output**: Returns 1 if the test passes or if `g_fail_fast` is false and the test fails; returns 0 if the test fails and `g_fail_fast` is true.
- **Functions Called**:
    - [`run_test`](<#run_test>)


---
### run\_single\_threaded<!-- {{#callable:run_single_threaded}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/test_sol_compat.c#L200>)

Executes a single-threaded recursive directory walk, processing each path with a specified function.
- **Inputs**:
    - `runner`: A pointer to an `fd_solfuzz_runner_t` structure used for running tests.
    - `argc`: An integer representing the number of command-line arguments.
    - `argv`: An array of strings representing the command-line arguments, where each element is a path to process.
- **Logic and Control Flow**:
    - Iterates over each command-line argument starting from index 1.
    - For each argument, calls [`recursive_walk`](<#recursive_walk>) with the current path, `visit_sync` function, and `runner` as context.
    - Checks the return value of [`recursive_walk`](<#recursive_walk>); if it is not successful, logs a warning and stops further processing.
- **Output**: No return value; the function operates through side effects such as logging and processing paths.
- **Functions Called**:
    - [`recursive_walk`](<#recursive_walk>)


---
### walkdir\_backpressure<!-- {{#callable:walkdir_backpressure}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/test_sol_compat.c#L231>)

Monitors and manages backpressure in a multi-threaded directory walking process by checking available credits and yielding the processor when necessary.
- **Inputs**:
    - `state`: A pointer to a `walkdir_state_t` structure that contains the state of the directory walking process, including worker count, sequence number, available credits, and an array of sequence numbers for each worker.
- **Logic and Control Flow**:
    - Initialize `worker_cnt` and `seq_pub` from the `state` structure.
    - Enter a loop that continues until there are available credits (`cr_avail`).
    - Check if the `shutdown_signal` is set; if so, return 0 to indicate termination.
    - Call `sched_yield()` to yield the processor, allowing other threads to run.
    - Set `cr_avail` to `ULONG_MAX` to start with the maximum possible credits.
    - Iterate over each worker, calculate the lag using `fd_seq_diff`, and adjust it to be non-negative using `fd_long_max`.
    - Update `cr_avail` to the minimum of its current value and the difference between `MCACHE_DEPTH` and the lag for each worker using `fd_ulong_min`.
    - Exit the loop when `cr_avail` is non-zero, indicating that there are available credits.
    - Update the `cr_avail` field in the `state` structure with the calculated value.
    - Return 1 to indicate that the process can continue.
- **Output**: Returns 1 if there are available credits to continue processing, or 0 if a shutdown signal is detected.


---
### walkdir\_publish<!-- {{#callable:walkdir_publish}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/test_sol_compat.c#L250>)

Publishes a directory path to a shared memory cache with flow-control management.
- **Inputs**:
    - `ctx`: A pointer to a `walkdir_state_t` structure that holds the state of the directory walk and publication process.
    - `path`: A constant character pointer to the directory path to be published.
    - `path_len`: An unsigned long integer representing the length of the path.
- **Logic and Control Flow**:
    - Check if flow-control credits are available; if not, call [`walkdir_backpressure`](<#walkdir_backpressure>) to wait for credits to replenish.
    - Convert the current chunk in the data cache to a local address and append the path to it.
    - Update the chunk to the next compacted position in the data cache.
    - Publish a fragment descriptor to the memory cache with the current sequence number and chunk.
    - Increment the sequence number and decrement the available flow-control credits.
    - Return 1 to indicate successful publication.
- **Output**: Returns an integer 1 if the path is successfully published, or 0 if blocked by flow-control.
- **Functions Called**:
    - [`walkdir_backpressure`](<#walkdir_backpressure>)


---
### walkdir\_tile<!-- {{#callable:walkdir_tile}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/test_sol_compat.c#L275>)

Executes a directory walk and processes files using a multi-threaded approach, updating sequence numbers in a memory cache.
- **Inputs**:
    - ``mcache``: A pointer to a `fd_frag_meta_t` structure used for memory caching.
    - ``dcache``: A pointer to an unsigned character array used for data caching.
    - ``fseqs``: A pointer to an array of unsigned long pointers representing sequence numbers for worker threads.
    - ``worker_cnt``: An unsigned long representing the number of worker threads.
    - ``argc``: An integer representing the number of command-line arguments.
    - ``argv``: An array of character pointers representing the command-line arguments.
- **Logic and Control Flow**:
    - Initializes a `walkdir_state_t` structure with the provided cache pointers, worker count, and sequence numbers.
    - Sets the initial chunk and available credits in the state structure.
    - Iterates over command-line arguments starting from index 1, calling [`recursive_walk`](<#recursive_walk>) for each directory path.
    - If [`recursive_walk`](<#recursive_walk>) returns false, logs a warning and stops further processing.
    - Updates the sequence number in the memory cache using `fd_mcache_seq_update`.
- **Output**: No return value; the function operates by side effects, updating the state and logging warnings if necessary.
- **Functions Called**:
    - [`recursive_walk`](<#recursive_walk>)


---
### exec\_tile<!-- {{#callable:exec_tile}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/test_sol_compat.c#L314>)

Executes tests on data chunks in a multi-threaded environment, managing sequence and flow control.
- **Inputs**:
    - `runner`: A pointer to a `fd_solfuzz_runner_t` structure used to execute tests.
    - `mcache`: A pointer to a constant `fd_frag_meta_t` structure representing the metadata cache.
    - `dcache`: A pointer to an unsigned character array representing the data cache.
    - `fseq`: A pointer to an unsigned long integer representing the sequence number for flow control.
    - `idx`: An unsigned long integer representing the index of the current worker.
    - `cnt`: An unsigned long integer representing the total number of workers.
- **Logic and Control Flow**:
    - Initialize `depth` with the depth of the metadata cache and set `seq` to 0 and `ok` to 1.
    - Enter an infinite loop to process data chunks.
    - Calculate the metadata line index using `fd_mcache_line_idx` and query the sequence number using `fd_frag_meta_seq_query`.
    - If the sequence number does not match, check for a shutdown signal and pause if not set, then continue to the next iteration.
    - If the sequence number matches the worker index (`seq%cnt==idx`), convert the chunk to a path and run the test using [`run_test`](<#run_test>).
    - If `fail_fast` is set and the test fails, set the shutdown signal and break the loop.
    - Increment the sequence number using `fd_seq_inc` and update the flow control sequence `fseq`.
    - Repeat the loop until a shutdown signal is received or all chunks are processed.
- **Output**: Returns an integer indicating success (1) or failure (0) of the test execution.
- **Functions Called**:
    - [`run_test`](<#run_test>)


---
### exec\_task<!-- {{#callable:exec_task}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/test_sol_compat.c#L350>)

Executes a task on a specific worker tile using the provided state and arguments.
- **Inputs**:
    - `argc`: The index of the worker tile to execute the task on, cast to an unsigned long.
    - `argv`: A pointer to an array of arguments, which is type-punned to a constant pointer to `mt_state_t`.
- **Logic and Control Flow**:
    - Cast `argc` to an unsigned long to get `worker_idx`.
    - Type-pun `argv` to a constant pointer to `mt_state_t` to get `state`.
    - Call [`exec_tile`](<#exec_tile>) with the appropriate parameters from `state` and `worker_idx`.
    - Return the result of [`exec_tile`](<#exec_tile>).
- **Output**: Returns the result of the [`exec_tile`](<#exec_tile>) function, which is an integer indicating success or failure.
- **Functions Called**:
    - [`exec_tile`](<#exec_tile>)


---
### run\_multi\_threaded<!-- {{#callable:run_multi_threaded}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/test_sol_compat.c#L358>)

Executes tasks in parallel using multiple threads to process files and manage execution flow.
- **Inputs**:
    - `runners`: An array of pointers to `fd_solfuzz_runner_t` structures, representing the runners for executing tasks.
    - `worker_cnt`: The number of worker threads to be used for execution.
    - `argc`: The count of command-line arguments.
    - `argv`: An array of command-line arguments.
    - `mcache`: A pointer to `fd_frag_meta_t`, used for managing metadata cache.
    - `dcache`: A pointer to an unsigned character array, used for managing data cache.
    - `fseqs`: An array of pointers to unsigned long integers, used for managing sequence numbers for flow control.
- **Logic and Control Flow**:
    - Initialize a `mt_state_t` structure with the provided inputs.
    - Create a new execution tile for each worker by calling `fd_tile_exec_new` with the task `exec_task`.
    - Call [`walkdir_tile`](<#walkdir_tile>) to process directories and files, distributing tasks among the worker threads.
    - Set the `shutdown_signal` to 1 to indicate that processing should stop.
    - Iterate over each worker to delete the execution tile using `fd_tile_exec_delete`, checking if each tile completed successfully.
    - Query the sequence number from `mcache` to determine the number of processed files.
    - Log a notice or warning based on whether all tasks completed successfully.
    - Return the success status of the operation.
- **Output**: Returns an integer indicating success (1) or failure (0) of the multi-threaded execution.
- **Functions Called**:
    - [`walkdir_tile`](<#walkdir_tile>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/test_sol_compat.c#L394>)

Executes a test application that processes command-line arguments, sets up a workspace, and runs tests either in single-threaded or multi-threaded mode.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of strings representing the command-line arguments.
- **Logic and Control Flow**:
    - Checks if the '--help' option is present in the command-line arguments and displays usage information if true.
    - Initializes the environment using `fd_boot` with the command-line arguments.
    - Parses command-line options for page size, page count, workspace name, workspace seed, workspace tag, and fail-fast option using `fd_env_strip_cmdline_*` functions.
    - Converts the page size string to a memory page size using `fd_cstr_to_shmem_page_sz`.
    - Determines the number of worker threads based on the number of tiles available.
    - Attaches to an existing workspace or creates a new one based on the presence of a workspace name and page count.
    - Allocates memory for runners, mcache, dcache, and fseqs using `fd_wksp_alloc_laddr`.
    - Initializes runners with `fd_solfuzz_runner_new` and checks for initialization failures.
    - Creates mcache and dcache objects and joins them using `fd_mcache_join` and `fd_dcache_join`.
    - Runs tests in single-threaded mode if only one tile is available, otherwise runs in multi-threaded mode using [`run_multi_threaded`](<#run_multi_threaded>).
    - Sets the exit code based on whether errors occurred and the fail-fast option.
    - Frees allocated memory and detaches or deletes the workspace before halting the environment with `fd_halt`.
- **Output**: Returns an integer exit code indicating success (0) or failure (1 or 255).
- **Functions Called**:
    - [`fd_wksp_demand_paged_new`](<fd_solfuzz.c.md#fd_wksp_demand_paged_new>)
    - [`run_single_threaded`](<#run_single_threaded>)
    - [`run_multi_threaded`](<#run_multi_threaded>)
    - [`fd_solfuzz_runner_delete`](<fd_solfuzz.c.md#fd_solfuzz_runner_delete>)
    - [`fd_wksp_demand_paged_delete`](<fd_solfuzz.c.md#fd_wksp_demand_paged_delete>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)