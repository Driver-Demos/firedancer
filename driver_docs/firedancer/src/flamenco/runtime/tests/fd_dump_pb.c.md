<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for dumping various contexts and states to protobuf format, including transactions, blocks, instructions, and virtual machine syscalls.

# Purpose
The code is a C source file that provides functionality for dumping various data structures related to transactions, accounts, and blocks into Protocol Buffers (protobuf) format. It includes functions to serialize and write data to files, which can be used for testing or debugging purposes. The file imports several header files, indicating dependencies on other modules for handling protobuf encoding, system identifiers, bank operations, and program address lookups.

Key components of the code include structures and functions for managing account keys using a red-black tree, utility functions for checking if an account is a built-in account, and functions for dumping features, account states, transactions, and block contexts. The code defines public APIs for dumping instruction, transaction, block, and virtual machine syscall contexts to protobuf, as well as functions for handling ELF files. The file is part of a larger system, likely related to blockchain or distributed ledger technology, given the references to transactions, accounts, and blocks.
# Imports and Dependencies

---
- `fd_dump_pb.h`
- `generated/block.pb.h`
- `generated/invoke.pb.h`
- `generated/txn.pb.h`
- `generated/vm.pb.h`
- `../fd_system_ids.h`
- `../fd_bank.h`
- `../program/fd_address_lookup_table_program.h`
- `../../../ballet/nanopb/pb_encode.h`
- `../../progcache/fd_prog_load.h`
- `stdio.h`
- `sys/mman.h`
- `unistd.h`
- `../../../util/tmpl/fd_sort.c`
- `../../../util/tmpl/fd_redblack.c`


# Global Variables

---
### fd\_dump\_sysvar\_ids
- **Type**: ``fd_pubkey_t const * []``
- **Description**: An array of pointers to `fd_pubkey_t` constants representing system variable identifiers. Each element in the array points to a specific system variable ID, such as `fd_sysvar_recent_block_hashes_id` or `fd_sysvar_clock_id`. These identifiers are used to reference various system variables within the program.
- **Use**: Used to store and access a collection of system variable identifiers for operations that require referencing these system variables.


---
### num\_sysvar\_entries
- **Type**: `ulong`
- **Description**: `num_sysvar_entries` is a constant variable that holds the number of system variable entries in the `fd_dump_sysvar_ids` array.
- **Use**: Used to determine the number of system variable entries for operations involving system variables.


---
### fd\_dump\_builtin\_ids
- **Type**: ``fd_pubkey_t const *` array`
- **Description**: An array of pointers to `fd_pubkey_t` constants representing the IDs of built-in programs in the Solana blockchain environment. Each element in the array points to a specific program ID, such as the system program, vote program, stake program, and various BPF loader programs.
- **Use**: Used to store and access the IDs of built-in programs for operations that require knowledge of these specific program IDs.


---
### num\_loaded\_builtins
- **Type**: `ulong`
- **Description**: `num_loaded_builtins` is a constant variable that represents the number of built-in program identifiers loaded in the system. It is calculated by dividing the size of the `fd_dump_builtin_ids` array by the size of a pointer to `fd_pubkey_t`. This calculation gives the total count of built-in program identifiers stored in the `fd_dump_builtin_ids` array.
- **Use**: Used to determine the number of built-in program identifiers available in the system.


# Data Structures

---
### fd\_dump\_account\_key\_node
- **Type**: ``struct``
- **Members**:
    - ``key``: Stores the public key of the account.
    - ``redblack_parent``: Holds the index of the parent node in the red-black tree.
    - ``redblack_left``: Holds the index of the left child node in the red-black tree.
    - ``redblack_right``: Holds the index of the right child node in the red-black tree.
    - ``redblack_color``: Indicates the color of the node in the red-black tree, typically red or black.
- **Description**: Defines a node in a red-black tree structure, where each node represents an account key with associated metadata for maintaining the tree's properties. The `key` field stores the account's public key, while the `redblack_parent`, `redblack_left`, and `redblack_right` fields manage the node's position within the tree. The `redblack_color` field helps maintain the balance of the tree by indicating the node's color.


---
### fd\_dump\_account\_key\_node\_t
- **Type**: ``struct``
- **Members**:
    - ``key``: Stores the public key associated with the account.
    - ``redblack_parent``: Holds the index of the parent node in the red-black tree.
    - ``redblack_left``: Holds the index of the left child node in the red-black tree.
    - ``redblack_right``: Holds the index of the right child node in the red-black tree.
    - ``redblack_color``: Indicates the color of the node in the red-black tree, typically red or black.
- **Description**: Defines a node in a red-black tree structure used to manage account keys, where each node contains a public key and pointers to its parent and child nodes, along with a color attribute for maintaining tree balance.


# Functions

---
### fd\_dump\_account\_key\_map\_compare<!-- {{#callable:fd_dump_account_key_map_compare}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.c#L32>)

Compares two `fd_dump_account_key_node_t` structures based on their `key.uc` fields using `memcmp`.
- **Inputs**:
    - `left`: A pointer to the first `fd_dump_account_key_node_t` structure to compare.
    - `right`: A pointer to the second `fd_dump_account_key_node_t` structure to compare.
- **Logic and Control Flow**:
    - Use `memcmp` to compare the `key.uc` fields of the `left` and `right` structures.
    - The comparison is done over the size of `fd_pubkey_t`.
- **Output**: Returns a `long` integer that indicates the result of the comparison: a negative value if `left` is less than `right`, zero if they are equal, and a positive value if `left` is greater than `right`.


---
### is\_builtin\_account<!-- {{#callable:is_builtin_account}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.c#L73>)

Checks if a given account key matches any of the predefined built-in account keys.
- **Inputs**:
    - `account_key`: A pointer to a `fd_pubkey_t` structure representing the account key to check.
- **Logic and Control Flow**:
    - Iterates over the array `fd_dump_builtin_ids` which contains pointers to built-in account keys.
    - For each built-in account key, compares it with the provided `account_key` using `memcmp`.
    - If a match is found, returns 1 indicating the account is a built-in account.
    - If no match is found after checking all built-in account keys, returns 0.
- **Output**: Returns 1 if the account key is a built-in account, otherwise returns 0.


---
### dump\_sorted\_features<!-- {{#callable:dump_sorted_features}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.c#L84>)

Sorts and dumps enabled features from a feature set into a provided output structure.
- **Inputs**:
    - ``features``: A pointer to a `fd_features_t` structure containing the feature set to process.
    - ``output_feature_set``: A pointer to a `fd_exec_test_feature_set_t` structure where the sorted features will be stored.
    - ``spad``: A pointer to a `fd_spad_t` structure used for memory allocation during processing.
- **Logic and Control Flow**:
    - Allocate memory for `unsorted_features` using `fd_spad_alloc` with alignment and size based on `FD_FEATURE_ID_CNT`.
    - Initialize `num_features` to zero to count enabled features.
    - Iterate over all features using `fd_feature_iter_init`, `fd_feature_iter_done`, and `fd_feature_iter_next`.
    - For each feature, check if it is not `FD_FEATURE_DISABLED`; if enabled, add its ID to `unsorted_features` and increment `num_features`.
    - Allocate memory for sorting using `fd_spad_alloc` with alignment and footprint based on `num_features`.
    - Sort `unsorted_features` using `sort_uint64_t_stable_fast` and store the result in `sorted_features`.
    - Set `features_count` and `features` in `output_feature_set` to `num_features` and `sorted_features`, respectively.
- **Output**: The function does not return a value; it modifies `output_feature_set` to contain the sorted list of enabled feature IDs.


---
### dump\_account\_state<!-- {{#callable:dump_account_state}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.c#L106>)

Copies the state of a transaction account to an output account structure.
- **Inputs**:
    - ``txn_account``: A pointer to a `fd_txn_account_t` structure representing the transaction account to be dumped.
    - ``output_account``: A pointer to a `fd_exec_test_acct_state_t` structure where the account state will be stored.
    - ``spad``: A pointer to a `fd_spad_t` structure used for memory allocation.
- **Logic and Control Flow**:
    - Copies the public key from `txn_account` to `output_account->address` using `fd_memcpy`.
    - Retrieves the lamports from `txn_account` and assigns it to `output_account->lamports`.
    - Allocates memory for `output_account->data` using `fd_spad_alloc` and sets its size.
    - Copies the account data from `txn_account` to `output_account->data->bytes` using `fd_memcpy`.
    - Checks if the account is executable and assigns the result to `output_account->executable`.
    - Copies the owner public key from `txn_account` to `output_account->owner` using `fd_memcpy`.
- **Output**: The function does not return a value; it modifies the `output_account` structure in place.


---
### account\_already\_dumped<!-- {{#callable:account_already_dumped}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.c#L128>)

Checks if a given account key is already present in a list of dumped accounts.
- **Inputs**:
    - `dumped_accounts`: A pointer to an array of `fd_exec_test_acct_state_t` structures representing the dumped accounts.
    - `dumped_cnt`: An unsigned long integer representing the number of dumped accounts in the array.
    - `account_key`: A pointer to an `fd_pubkey_t` structure representing the account key to check.
- **Logic and Control Flow**:
    - Iterates over the `dumped_accounts` array up to `dumped_cnt` times.
    - For each account in the array, compares the `account_key` with the account's address using `memcmp`.
    - If a match is found, returns 1 indicating the account is already dumped.
    - If no match is found after checking all accounts, returns 0.
- **Output**: Returns 1 if the account key is found in the dumped accounts, otherwise returns 0.


---
### dump\_account\_if\_not\_already\_dumped<!-- {{#callable:dump_account_if_not_already_dumped}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.c#L144>)

Checks if an account has already been dumped and dumps it if not, while optionally setting up a borrowed account.
- **Inputs**:
    - ``funk``: A pointer to a `fd_funk_t` structure, representing the current state of the system.
    - ``xid``: A pointer to a `fd_funk_txn_xid_t` structure, representing the transaction ID.
    - ``account_key``: A pointer to a `fd_pubkey_t` structure, representing the public key of the account to check and possibly dump.
    - ``spad``: A pointer to a `fd_spad_t` structure, used for memory allocation during the dumping process.
    - ``out_acct_states``: A pointer to an array of `fd_exec_test_acct_state_t` structures, where the dumped account state will be stored if the account is not already dumped.
    - ``out_acct_states_cnt``: A pointer to a `pb_size_t` variable, representing the count of dumped account states, which will be incremented if a new account is dumped.
    - ``opt_out_borrowed_account``: An optional pointer to a `fd_txn_account_t` structure, where the account information will be copied if provided.
- **Logic and Control Flow**:
    - Initialize a `fd_txn_account_t` array `account` with one element.
    - Call `fd_txn_account_init_from_funk_readonly` to initialize `account` with the account data from `funk` using `account_key` and `xid`.
    - If the initialization fails, return 1.
    - Check if the account is already dumped using [`account_already_dumped`](<#account_already_dumped>).
    - If the account is not already dumped, call [`dump_account_state`](<#dump_account_state>) to dump the account state into `out_acct_states` at the index `*out_acct_states_cnt`, and increment `*out_acct_states_cnt`.
    - If `opt_out_borrowed_account` is not NULL, copy the `account` data to `*opt_out_borrowed_account`.
    - Return 0.
- **Output**: Returns 0 if the account exists and is processed, or 1 if the account does not exist.
- **Functions Called**:
    - [`account_already_dumped`](<#account_already_dumped>)
    - [`dump_account_state`](<#dump_account_state>)


---
### dump\_executable\_account\_if\_exists<!-- {{#callable:dump_executable_account_if_exists}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.c#L168>)

Checks if a given program account is an executable account and dumps its associated program data account if it exists.
- **Inputs**:
    - ``funk``: A pointer to `fd_funk_t`, representing the current state of the system.
    - ``xid``: A pointer to `fd_funk_txn_xid_t`, representing the transaction identifier.
    - ``program_account``: A pointer to `fd_exec_test_acct_state_t`, representing the program account to check.
    - ``spad``: A pointer to `fd_spad_t`, used for temporary memory allocation.
    - ``out_account_states``: A pointer to an array of `fd_exec_test_acct_state_t` where the function will store dumped account states.
    - ``out_account_states_count``: A pointer to `pb_size_t` that keeps track of the number of dumped account states.
- **Logic and Control Flow**:
    - Check if the `program_account` is owned by the `fd_solana_bpf_loader_upgradeable_program_id` key; if not, return immediately.
    - Decode the program account's data into a `fd_bpf_upgradeable_loader_state_t` structure using `fd_bincode_decode_spad`; if decoding fails, return.
    - Check if the decoded state represents a program using `fd_bpf_upgradeable_loader_state_is_program`; if not, return.
    - Retrieve the `programdata_address` from the decoded state and call [`dump_account_if_not_already_dumped`](<#dump_account_if_not_already_dumped>) to dump the program data account.
- **Output**: No direct output is returned; the function modifies `out_account_states` and `out_account_states_count` to include any newly dumped account states.
- **Functions Called**:
    - [`dump_account_if_not_already_dumped`](<#dump_account_if_not_already_dumped>)


---
### dump\_sanitized\_transaction<!-- {{#callable:dump_sanitized_transaction}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.c#L196>)

Processes a transaction descriptor and payload to populate a sanitized transaction structure with detailed transaction information.
- **Inputs**:
    - ``funk``: A pointer to `fd_funk_t`, representing the transaction context.
    - ``xid``: A constant pointer to `fd_funk_txn_xid_t`, representing the transaction ID.
    - ``txn_descriptor``: A constant pointer to `fd_txn_t`, representing the transaction descriptor.
    - ``txn_payload``: A constant pointer to `uchar`, representing the transaction payload.
    - ``spad``: A pointer to `fd_spad_t`, used for memory allocation.
    - ``sanitized_transaction``: A pointer to `fd_exec_test_sanitized_transaction_t`, where the sanitized transaction data will be stored.
- **Logic and Control Flow**:
    - Retrieve address lookup tables from the transaction descriptor.
    - Set `has_message` to true and initialize the message structure in the sanitized transaction.
    - Determine if the transaction is legacy and set `is_legacy` accordingly.
    - Populate the message header with signature counts and account information from the transaction descriptor.
    - Allocate memory for account keys and copy them from the transaction payload.
    - Retrieve and copy the recent blockhash into the message structure.
    - Allocate and populate the instructions array with compiled instructions from the transaction descriptor.
    - If the transaction is not legacy, process address table lookups and populate the corresponding fields in the message structure.
    - Allocate memory for signatures and copy them from the transaction payload into the sanitized transaction.
- **Output**: Populates the `sanitized_transaction` structure with detailed information about the transaction, including message, header, account keys, recent blockhash, instructions, address table lookups, and signatures.


---
### dump\_blockhash\_queue<!-- {{#callable:dump_blockhash_queue}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.c#L323>)

Iterates over a blockhash queue and copies each blockhash to an output array, updating the count of copied blockhashes.
- **Inputs**:
    - ``queue``: A pointer to a `fd_blockhashes_t` structure representing the blockhash queue to process.
    - ``spad``: A pointer to a `fd_spad_t` structure used for memory allocation.
    - ``output_blockhash_queue``: A pointer to an array of `pb_bytes_array_t` pointers where the function will store the copied blockhashes.
    - ``output_blockhash_queue_count``: A pointer to a `pb_size_t` variable where the function will store the count of copied blockhashes.
- **Logic and Control Flow**:
    - Calculate the size of the blockhash queue to process using `fd_ulong_min` and `fd_blockhash_deq_cnt`.
    - Initialize a counter `cnt` to zero for tracking the number of blockhashes processed.
    - Iterate over the blockhash queue in reverse order using `fd_blockhash_deq_iter_init_rev` and `fd_blockhash_deq_iter_prev`.
    - For each blockhash, allocate memory for a `pb_bytes_array_t` using `fd_spad_alloc`.
    - Copy the blockhash from the queue element to the allocated `pb_bytes_array_t` using `fd_memcpy`.
    - Store the pointer to the `pb_bytes_array_t` in the `output_blockhash_queue` array at the calculated index.
    - Increment the counter `cnt` after processing each blockhash.
    - Update `output_blockhash_queue_count` with the total number of blockhashes processed.
- **Output**: The function outputs the copied blockhashes in the `output_blockhash_queue` array and updates `output_blockhash_queue_count` with the number of blockhashes copied.


---
### add\_account\_to\_dumped\_accounts<!-- {{#callable:add_account_to_dumped_accounts}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.c#L352>)

Adds an account to the dumped accounts set if it does not already exist.
- **Inputs**:
    - ``pool``: A pointer to the memory pool of `fd_dump_account_key_node_t` structures.
    - ``root``: A double pointer to the root of the red-black tree representing the dumped accounts.
    - ``pubkey``: A constant pointer to the public key of the account to be added.
- **Logic and Control Flow**:
    - Create a `fd_dump_account_key_node_t` structure `node` with the key set to the value pointed to by `pubkey`.
    - Check if the key already exists in the red-black tree using `fd_dump_account_key_map_find`.
    - If the key exists, return 0 to indicate the account is already present.
    - If the key does not exist, acquire a new node from the pool using `fd_dump_account_key_map_acquire`.
    - Set the key of the new node to the value pointed to by `pubkey`.
    - Insert the new node into the red-black tree using `fd_dump_account_key_map_insert`.
    - Return 1 to indicate the account was added successfully.
- **Output**: Returns 0 if the account already exists, and 1 if the account was added successfully.


---
### add\_account\_and\_programdata\_to\_dumped\_accounts<!-- {{#callable:add_account_and_programdata_to_dumped_accounts}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.c#L373>)

Adds an account and its associated programdata account to the dumped accounts set if they are not already present.
- **Inputs**:
    - ``funk``: A pointer to `fd_funk_t`, representing the Funk context.
    - ``xid``: A constant pointer to `fd_funk_txn_xid_t`, representing the transaction ID.
    - ``pool``: A pointer to `fd_dump_account_key_node_t`, representing the pool of account key nodes.
    - ``root``: A double pointer to `fd_dump_account_key_node_t`, representing the root of the dumped accounts set.
    - ``pubkey``: A constant pointer to `fd_pubkey_t`, representing the public key of the account to be added.
- **Logic and Control Flow**:
    - Calls [`add_account_to_dumped_accounts`](<#add_account_to_dumped_accounts>) to add the current account to the dumped accounts set.
    - If the account is already present, the function returns immediately.
    - Initializes a `fd_txn_account_t` structure to read the account from Funk in a read-only mode.
    - Checks if the account is owned by the v3 loader using `memcmp` and returns if it is not.
    - Decodes the program account state using `fd_bincode_decode_static`.
    - Checks if the account state is a program using `fd_bpf_upgradeable_loader_state_is_program` and returns if it is not.
    - Adds the programdata address to the dumped accounts set using [`add_account_to_dumped_accounts`](<#add_account_to_dumped_accounts>).
- **Output**: No explicit output; modifies the dumped accounts set by adding the account and its programdata account if applicable.
- **Functions Called**:
    - [`add_account_to_dumped_accounts`](<#add_account_to_dumped_accounts>)


---
### add\_lut\_accounts\_to\_dumped\_accounts<!-- {{#callable:add_lut_accounts_to_dumped_accounts}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.c#L420>)

Adds an address lookup table account and all pubkeys in the lookup table to the dumped accounts set if they do not exist already.
- **Inputs**:
    - ``funk``: A pointer to an `fd_funk_t` structure, representing the current state of the transaction.
    - ``xid``: A constant pointer to an `fd_funk_txn_xid_t` structure, representing the transaction ID.
    - ``pool``: A pointer to a pool of `fd_dump_account_key_node_t` structures, used for managing dumped account keys.
    - ``root``: A double pointer to the root of the dumped accounts set, used to manage the red-black tree of dumped accounts.
    - ``pubkey``: A constant pointer to an `fd_pubkey_t` structure, representing the public key of the account to be added.
- **Logic and Control Flow**:
    - Call [`add_account_to_dumped_accounts`](<#add_account_to_dumped_accounts>) to add the current account to the dumped accounts set.
    - Initialize a `lut_account` and call `fd_txn_account_init_from_funk_readonly` to read the account data from `funk` using `pubkey` and `xid`.
    - If the account initialization fails, return immediately.
    - Retrieve the account data and its length using `fd_txn_account_get_data` and `fd_txn_account_get_data_len`.
    - Check if the data length is valid for a lookup table; if not, return immediately.
    - Calculate the number of lookup addresses and iterate over them.
    - For each lookup address, call [`add_account_and_programdata_to_dumped_accounts`](<#add_account_and_programdata_to_dumped_accounts>) to add the referenced pubkey to the dumped accounts set.
- **Output**: No explicit output; the function modifies the dumped accounts set by adding new accounts.
- **Functions Called**:
    - [`add_account_to_dumped_accounts`](<#add_account_to_dumped_accounts>)
    - [`add_account_and_programdata_to_dumped_accounts`](<#add_account_and_programdata_to_dumped_accounts>)


---
### create\_synthetic\_vote\_account\_from\_vote\_state<!-- {{#callable:create_synthetic_vote_account_from_vote_state}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.c#L456>)

Creates a synthetic vote account from a given vote state and populates it with default values and encoded data.
- **Inputs**:
    - ``vote_state``: A pointer to a `fd_vote_state_ele_t` structure representing the vote state to use for creating the synthetic vote account.
    - ``spad``: A pointer to an `fd_spad_t` structure used for memory allocation.
    - ``out_vote_account``: A pointer to an `fd_exec_test_vote_account_t` structure where the synthetic vote account will be stored.
- **Logic and Control Flow**:
    - Set `has_vote_account` to true in `out_vote_account`.
    - Copy the `vote_account` address from `vote_state` to `out_vote_account`.
    - Set `executable` to false and `lamports` to 100000 in `out_vote_account`.
    - Copy the `owner` from `fd_solana_vote_program_id` to `out_vote_account`.
    - Set the `stake` in `out_vote_account` from `vote_state`.
    - Initialize a `fd_vote_state_versioned_t` structure with current vote state details from `vote_state`.
    - Create a synthetic vote state and initialize its `votes` with 32 default `fd_landed_vote_t` elements.
    - Allocate memory for `authorized_voters` pool and treap, and join them to the synthetic vote state.
    - Calculate the encoded size of the vote state and allocate memory for it in `out_vote_account`.
    - Encode the vote state into the allocated memory.
- **Output**: The function does not return a value but populates the `out_vote_account` with a synthetic vote account based on the input `vote_state`.


---
### dump\_prior\_vote\_accounts<!-- {{#callable:dump_prior_vote_accounts}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.c#L524>)

Iterates over vote states to add vote accounts to a dumped accounts set and creates synthetic vote accounts from these states.
- **Inputs**:
    - ``vote_states``: A pointer to `fd_vote_states_t` containing the vote states to process.
    - ``dumped_accounts_pool``: A pointer to a pool of `fd_dump_account_key_node_t` used to manage dumped accounts.
    - ``dumped_accounts_root``: A pointer to the root of the dumped accounts tree.
    - ``out_vote_accounts``: An array of `fd_exec_test_vote_account_t` where synthetic vote accounts will be stored.
    - ``out_vote_accounts_count``: A pointer to a `pb_size_t` that tracks the number of vote accounts processed.
    - ``spad``: A pointer to `fd_spad_t` used for memory allocation during processing.
- **Logic and Control Flow**:
    - Initialize an iterator `iter_` for the `vote_states`.
    - Loop through each vote state using the iterator until all states are processed.
    - For each vote state, retrieve the vote account and add it to the dumped accounts using [`add_account_to_dumped_accounts`](<#add_account_to_dumped_accounts>).
    - Create a synthetic vote account from the current vote state using [`create_synthetic_vote_account_from_vote_state`](<#create_synthetic_vote_account_from_vote_state>) and store it in `out_vote_accounts`.
    - Increment the `out_vote_accounts_count` to reflect the addition of a new synthetic vote account.
- **Output**: No direct output is returned; the function modifies `out_vote_accounts` and `out_vote_accounts_count` to reflect the processed vote accounts.
- **Functions Called**:
    - [`add_account_to_dumped_accounts`](<#add_account_to_dumped_accounts>)
    - [`create_synthetic_vote_account_from_vote_state`](<#create_synthetic_vote_account_from_vote_state>)


---
### create\_block\_context\_protobuf\_from\_block<!-- {{#callable:create_block_context_protobuf_from_block}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.c#L546>)

Captures the block context from before the current block execution and prepares it for dumping in the block finalize step.
- **Inputs**:
    - ``dump_ctx``: A pointer to `fd_block_dump_ctx_t` structure that holds the context for dumping the block.
    - ``banks``: A pointer to `fd_banks_t` structure representing the collection of banks.
    - ``bank``: A pointer to `fd_bank_t` structure representing the current bank.
    - ``funk``: A pointer to `fd_funk_t` structure used for transaction operations.
- **Logic and Control Flow**:
    - Retrieve the parent bank and slots for the current and parent banks.
    - Initialize the block context and allocate memory for transactions to be dumped.
    - Iterate over transactions to dump sanitized transactions and associated accounts.
    - Dump sysvars, builtins, stake accounts, and vote accounts for the current epoch.
    - Dump vote accounts for previous epochs (T-1 and T-2).
    - Iterate over dumped accounts to initialize and dump account states.
    - Dump the blockhash queue and set slot context details.
    - Set fee rate governor and epoch context details including features and inflation.
- **Output**: No direct output; modifies the `dump_ctx` to include the prepared block context for dumping.
- **Functions Called**:
    - [`dump_sanitized_transaction`](<#dump_sanitized_transaction>)
    - [`add_account_and_programdata_to_dumped_accounts`](<#add_account_and_programdata_to_dumped_accounts>)
    - [`add_lut_accounts_to_dumped_accounts`](<#add_lut_accounts_to_dumped_accounts>)
    - [`add_account_to_dumped_accounts`](<#add_account_to_dumped_accounts>)
    - [`dump_prior_vote_accounts`](<#dump_prior_vote_accounts>)
    - [`dump_account_state`](<#dump_account_state>)
    - [`dump_blockhash_queue`](<#dump_blockhash_queue>)
    - [`dump_sorted_features`](<#dump_sorted_features>)


---
### create\_txn\_context\_protobuf\_from\_txn<!-- {{#callable:create_txn_context_protobuf_from_txn}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.c#L753>)

Creates a transaction context protobuf from a transaction by processing account data, LUT accounts, sysvars, and other transaction-related information.
- **Inputs**:
    - `txn_context_msg`: A pointer to `fd_exec_test_txn_context_t` where the transaction context protobuf will be stored.
    - `txn_ctx`: A pointer to `fd_exec_txn_ctx_t` containing the transaction context information.
    - `spad`: A pointer to `fd_spad_t` used for memory allocation during the process.
- **Logic and Control Flow**:
    - Initialize `txn_descriptor` and `txn_payload` from `txn_ctx`.
    - Allocate memory for `account_shared_data` in `txn_context_msg` using `fd_spad_alloc`.
    - Iterate over regular accounts in `txn_ctx`, initialize them, and dump their state if they are not built-in accounts.
    - Process LUT accounts by iterating over `address_lookup_tables`, initializing them, and dumping their state.
    - Dump any account state referenced in ALUTs by iterating over writable and readonly LUT indices.
    - Dump programdata accounts for potential v3-owned program accounts by iterating over previously dumped accounts.
    - Dump sysvars by iterating over `fd_dump_sysvar_ids`, initializing them, and dumping their state if not already present.
    - Set `has_tx` to true and dump the sanitized transaction into `txn_context_msg->tx`.
    - Allocate memory for `blockhash_queue` and dump the blockhash queue into it.
    - Set `has_epoch_ctx` to true and dump sorted features into `txn_context_msg->epoch_ctx.features`.
    - Set `has_slot_ctx` to true and assign the slot from `txn_ctx` to `txn_context_msg->slot_ctx`.
- **Output**: The function does not return a value; it modifies the `txn_context_msg` to contain the transaction context protobuf.
- **Functions Called**:
    - [`is_builtin_account`](<#is_builtin_account>)
    - [`dump_account_state`](<#dump_account_state>)
    - [`dump_executable_account_if_exists`](<#dump_executable_account_if_exists>)
    - [`dump_sanitized_transaction`](<#dump_sanitized_transaction>)
    - [`dump_blockhash_queue`](<#dump_blockhash_queue>)
    - [`dump_sorted_features`](<#dump_sorted_features>)


---
### create\_instr\_context\_protobuf\_from\_instructions<!-- {{#callable:create_instr_context_protobuf_from_instructions}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.c#L887>)

Creates a protobuf instruction context from given transaction and instruction data.
- **Inputs**:
    - ``instr_context``: A pointer to `fd_exec_test_instr_context_t` where the function will store the generated instruction context.
    - ``txn_ctx``: A constant pointer to `fd_exec_txn_ctx_t` containing transaction context information.
    - ``instr``: A constant pointer to `fd_instr_info_t` containing instruction information.
- **Logic and Control Flow**:
    - Copies the program ID from the transaction context to the instruction context.
    - Allocates memory for accounts in the instruction context and copies account data from the transaction context.
    - Adds sysvar cache variables to the instruction context if they are not already present.
    - Adds executable accounts to the instruction context if they are not already present.
    - Allocates memory for instruction accounts and copies account details from the instruction data.
    - Allocates memory for instruction data and copies the data from the instruction information.
    - Sets available compute units in the instruction context from the transaction context.
    - Sets slot and epoch context flags to true and dumps sorted features into the epoch context.
- **Output**: The function does not return a value; it modifies the `instr_context` structure in place.
- **Functions Called**:
    - [`dump_account_state`](<#dump_account_state>)
    - [`dump_sorted_features`](<#dump_sorted_features>)


---
### fd\_dump\_instr\_to\_protobuf<!-- {{#callable:fd_dump_instr_to_protobuf}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.c#L979>)

Encodes transaction instruction data into a protobuf format and writes it to a file if the transaction signature matches a specified filter.
- **Inputs**:
    - `txn_ctx`: A pointer to the `fd_exec_txn_ctx_t` structure, which contains the transaction context including transaction data and capture context.
    - `instr`: A pointer to the `fd_instr_info_t` structure, which contains information about the instruction to be processed.
    - `instruction_idx`: An unsigned short integer representing the index of the instruction within the transaction.
- **Logic and Control Flow**:
    - Begin a frame in the scratchpad memory using [`FD_SPAD_FRAME_BEGIN`](<#fd_dump_txn_to_protobuffd_spad_frame_begin>) macro.
    - Retrieve the base58-encoded transaction signature from the transaction context.
    - Check if a signature filter is set in the capture context; if so, compare it with the encoded signature and return early if they do not match.
    - Initialize an instruction context structure using `FD_EXEC_TEST_INSTR_CONTEXT_INIT_DEFAULT`.
    - Call [`create_instr_context_protobuf_from_instructions`](<#create_instr_context_protobuf_from_instructions>) to populate the instruction context with data from the transaction and instruction.
    - Allocate a buffer for output and create a protobuf stream from it.
    - Encode the instruction context into the protobuf stream using `pb_encode`.
    - If encoding is successful, construct a file path using the capture context's output directory, encoded signature, and instruction index.
    - Open the file in write-binary mode, write the encoded data to it, and close the file.
    - End the frame in the scratchpad memory using `FD_SPAD_FRAME_END` macro.
- **Output**: Writes the encoded instruction context to a file in protobuf format if the signature matches the filter.
- **Functions Called**:
    - [`fd_dump_txn_to_protobuf::FD_SPAD_FRAME_BEGIN`](<#fd_dump_txn_to_protobuffd_spad_frame_begin>)
    - [`create_instr_context_protobuf_from_instructions`](<#create_instr_context_protobuf_from_instructions>)


---
### fd\_dump\_txn\_to\_protobuf<!-- {{#callable:fd_dump_txn_to_protobuf}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.c#L1019>)

Encodes a transaction context into a protobuf format and writes it to a file if the transaction signature matches a specified filter.
- **Inputs**:
    - `txn_ctx`: A pointer to `fd_exec_txn_ctx_t`, which contains the transaction context to be processed.
    - `spad`: A pointer to `fd_spad_t`, which is used for memory allocation during the function execution.
- **Logic and Control Flow**:
    - Begin a SPAD frame using `FD_SPAD_FRAME_BEGIN` macro with `spad`.
    - Retrieve the transaction signature using `fd_txn_get_signatures` and copy the first signature.
    - Encode the signature to base58 format using `fd_base58_encode_64`.
    - Check if `dump_proto_sig_filter` is set in `txn_ctx->capture_ctx`; if so, compare it with the encoded signature.
    - If the signature does not match the filter, terminate the function early.
    - Initialize a `fd_exec_test_txn_context_t` structure with default values.
    - Call [`create_txn_context_protobuf_from_txn`](<#create_txn_context_protobuf_from_txn>) to populate the protobuf message with transaction context data.
    - Allocate memory for the output buffer using `fd_spad_alloc` with a size of 100 MB.
    - Create a protobuf output stream using `pb_ostream_from_buffer`.
    - Encode the transaction context message into the protobuf stream using `pb_encode`.
    - If encoding is successful, construct the output file path using `snprintf`.
    - Open the file in write-binary mode using `fopen`.
    - If the file is successfully opened, write the encoded data to the file using `fwrite` and close the file with `fclose`.
    - End the SPAD frame using `FD_SPAD_FRAME_END` macro.
- **Output**: Writes the encoded protobuf transaction context to a file if the signature matches the filter.
- **Functions Called**:
    - [`create_txn_context_protobuf_from_txn`](<#create_txn_context_protobuf_from_txn>)


---
### FD\_SPAD\_FRAME\_BEGIN<!-- {{#callable:fd_dump_txn_to_protobuf::FD_SPAD_FRAME_BEGIN}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.c#L1021>)

Encodes a transaction context into a protobuf format and writes it to a file if the transaction signature matches a specified filter.
- **Inputs**:
    - `spad`: A pointer to `fd_spad_t`, which is a shared memory allocator used for temporary allocations.
- **Logic and Control Flow**:
    - Retrieve the base58-encoded transaction signature from the transaction context.
    - Check if a signature filter is set in the transaction context's capture context.
    - If a signature filter is set, compare it with the encoded signature and return early if they do not match.
    - Initialize a `fd_exec_test_txn_context_t` structure with default values.
    - Call [`create_txn_context_protobuf_from_txn`](<#create_txn_context_protobuf_from_txn>) to populate the transaction context protobuf structure.
    - Allocate a buffer of 100 MB using `fd_spad_alloc` for the output protobuf data.
    - Create a protobuf output stream from the allocated buffer.
    - Encode the transaction context protobuf structure into the output stream using `pb_encode`.
    - If encoding is successful, construct the output file path using the encoded signature.
    - Open the file in write-binary mode and write the encoded data to the file.
    - Close the file after writing.
- **Output**: No explicit return value; writes the encoded transaction context to a file if conditions are met.
- **Functions Called**:
    - [`create_txn_context_protobuf_from_txn`](<#create_txn_context_protobuf_from_txn>)


---
### fd\_dump\_block\_to\_protobuf\_collect\_tx<!-- {{#callable:fd_dump_block_to_protobuf_collect_tx}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.c#L1055>)

Adds a transaction to the dump context if the maximum transaction count is not exceeded.
- **Inputs**:
    - ``dump_ctx``: A pointer to an `fd_block_dump_ctx_t` structure that holds the context for dumping transactions.
    - ``txn``: A pointer to a constant `fd_txn_p_t` structure representing the transaction to be added to the dump context.
- **Logic and Control Flow**:
    - Check if the current transaction count in `dump_ctx` is greater than or equal to `FD_BLOCK_DUMP_CTX_MAX_TXN_CNT`.
    - If the transaction count exceeds the limit, log an error message and return without adding the transaction.
    - If the transaction count is within the limit, copy the transaction data from `txn` to the `txns_to_dump` array in `dump_ctx` and increment the transaction count.
- **Output**: No return value; the function modifies the `dump_ctx` structure in place.


---
### fd\_dump\_block\_to\_protobuf<!-- {{#callable:fd_dump_block_to_protobuf}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.c#L1065>)

Dumps block context to a protobuf file for a given block and its associated data.
- **Inputs**:
    - ``dump_ctx``: A pointer to `fd_block_dump_ctx_t`, which holds the context for dumping the block.
    - ``banks``: A pointer to `fd_banks_t`, representing the collection of banks involved in the block.
    - ``bank``: A pointer to `fd_bank_t`, representing the specific bank for which the block context is being dumped.
    - ``funk``: A pointer to `fd_funk_t`, representing the transaction manager used to access transaction data.
    - ``capture_ctx``: A constant pointer to `fd_capture_ctx_t`, which provides the context for capturing and outputting the protobuf data.
- **Logic and Control Flow**:
    - Check if `capture_ctx` is NULL and log a warning if true, then return.
    - Check if `dump_ctx` is NULL and log a warning if true, then return.
    - Call [`create_block_context_protobuf_from_block`](<#create_block_context_protobuf_from_block>) to populate the block context in `dump_ctx`.
    - Allocate a 1 GB buffer using `fd_spad_alloc` for output data.
    - Initialize a protobuf output stream with the allocated buffer.
    - Encode the block context into the protobuf stream using `pb_encode`.
    - If encoding is successful, construct the output file path using `snprintf`.
    - Open the file at the constructed path in write-binary mode.
    - If the file is successfully opened, write the encoded data to the file and close it.
- **Output**: No return value; outputs the block context to a protobuf file.
- **Functions Called**:
    - [`fd_dump_txn_to_protobuf::FD_SPAD_FRAME_BEGIN`](<#fd_dump_txn_to_protobuffd_spad_frame_begin>)
    - [`create_block_context_protobuf_from_block`](<#create_block_context_protobuf_from_block>)


---
### fd\_dump\_vm\_syscall\_to\_protobuf<!-- {{#callable:fd_dump_vm_syscall_to_protobuf}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.c#L1101>)

Serializes the virtual machine's syscall context to a protobuf file if a unique filename is generated.
- **Inputs**:
    - `vm`: A pointer to a constant `fd_vm_t` structure representing the virtual machine context.
    - `fn_name`: A constant character pointer representing the function name to include in the filename.
- **Logic and Control Flow**:
    - Begin a stack frame using [`FD_SPAD_FRAME_BEGIN`](<#fd_dump_txn_to_protobuffd_spad_frame_begin>) with the scratchpad from the transaction context.
    - Copy the transaction signature from the payload and encode it using Base58.
    - Generate a unique filename using the function name, encoded signature, current instruction index, instruction stack size, and compute units.
    - Check if the file already exists using `access`; return if it does.
    - Initialize a `fd_exec_test_syscall_context_t` structure with zero values.
    - Populate the `vm_ctx` fields of the syscall context with data from the virtual machine context, including heap size, rodata, registers, entry point, and return data.
    - Populate the `instr_ctx` field by calling [`create_instr_context_protobuf_from_instructions`](<#create_instr_context_protobuf_from_instructions>).
    - Populate the `syscall_invocation` fields with the function name, heap prefix, and stack prefix.
    - Allocate a buffer for output and create a protobuf stream from it.
    - Encode the syscall context into the protobuf stream using `pb_encode`.
    - If encoding is successful, open the file for writing, write the encoded data, and close the file.
- **Output**: No return value; outputs the serialized syscall context to a file.
- **Functions Called**:
    - [`fd_dump_txn_to_protobuf::FD_SPAD_FRAME_BEGIN`](<#fd_dump_txn_to_protobuffd_spad_frame_begin>)
    - [`create_instr_context_protobuf_from_instructions`](<#create_instr_context_protobuf_from_instructions>)


---
### fd\_dump\_elf\_to\_protobuf<!-- {{#callable:fd_dump_elf_to_protobuf}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.c#L1219>)

Serializes ELF data from a transaction context to a protobuf file if the file does not already exist.
- **Inputs**:
    - ``txn_ctx``: A pointer to `fd_exec_txn_ctx_t`, which contains the transaction context including the scratchpad, transaction payload, and other relevant data.
    - ``program_acc``: A pointer to `fd_txn_account_t`, representing the program account from which ELF data is to be loaded.
- **Logic and Control Flow**:
    - Begin a scratchpad frame using [`FD_SPAD_FRAME_BEGIN`](<#fd_dump_txn_to_protobuffd_spad_frame_begin>) with `txn_ctx->spad`.
    - Load the ELF data for the given program account using `fd_prog_load_elf`.
    - Check if the ELF data is `NULL`; if so, return immediately.
    - Copy the transaction signature from the transaction payload and encode it using Base58.
    - Generate a unique filename using the encoded signature, program account public key, and slot number.
    - Check if a file with the generated filename already exists using `access`; if it does, return immediately.
    - Initialize an `fd_exec_test_elf_loader_ctx_t` structure and set its fields for ELF data, features, and deploy checks.
    - Allocate memory for the ELF data and copy the loaded ELF data into it.
    - Dump sorted features from the transaction context into the ELF loader context.
    - Set `deploy_checks` to `true`.
    - Allocate a buffer for the output file and create a protobuf stream from it.
    - Encode the ELF loader context into the protobuf stream using `pb_encode`.
    - Open the file with the generated filename for writing in binary mode.
    - Write the encoded data to the file and close the file.
    - End the scratchpad frame using `FD_SPAD_FRAME_END`.
- **Output**: No return value; the function writes the serialized ELF data to a file.
- **Functions Called**:
    - [`fd_dump_txn_to_protobuf::FD_SPAD_FRAME_BEGIN`](<#fd_dump_txn_to_protobuffd_spad_frame_begin>)
    - [`dump_sorted_features`](<#dump_sorted_features>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)