<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests type decoding and serialization to binary and YAML formats in the Firedancer runtime.

# Purpose
The code is a C source file that implements functionality for decoding and serializing data types, specifically for use in a fuzz testing environment. It includes a custom serializer, `CustomerSerializer`, which is used to walk through and serialize various data types into a file. The serialization process handles different data types such as integers, floats, and custom types like `FD_FLAMENCO_TYPE_HASH256` and `FD_FLAMENCO_TYPE_SIG512`. The serialization is done in a format that can be written to a file, and the code supports both binary and YAML representations of the data.

The main function, [`fd_runtime_fuzz_decode_type_run`](<#fd_runtime_fuzz_decode_type_run>), is responsible for decoding input data based on a type ID, serializing the decoded data, and generating a YAML representation. It uses a type metadata structure to determine how to decode and serialize each type. The function [`fd_solfuzz_type_run`](<#fd_solfuzz_type_run>) acts as an interface to execute the decoding and serialization process, managing memory allocation and handling the output of serialized and YAML data. The code is designed to be part of a larger system, likely involving fuzz testing, where it processes input data, decodes it, and outputs serialized and YAML representations for further analysis or testing.
# Imports and Dependencies

---
- `fd_solfuzz.h`
- `../../types/fd_types_yaml.h`
- `../../types/fd_types_reflect.h`
- `stdio.h`
- `generated/type.pb.h`


# Data Structures

---
### CustomerSerializer
- **Type**: ``struct``
- **Members**:
    - ``file``: Pointer to a file stream used for serialization.
- **Description**: Facilitates the serialization of customer data by writing it to a file stream. The `CustomerSerializer` structure contains a single member, `file`, which is a pointer to a file stream. This file stream is used in the `custom_serializer_walk` function to serialize various data types by writing their representations to the file. The structure is used in conjunction with functions that walk through data structures and serialize their contents into a specified format.


# Functions

---
### custom\_serializer\_walk<!-- {{#callable:custom_serializer_walk}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_types_harness.c#L13>)

Serializes various data types to a file based on the provided type identifier.
- **Inputs**:
    - `_self`: A pointer to a `CustomerSerializer` object that contains a file pointer for output.
    - `arg`: A pointer to the data to serialize, with the type specified by `type`.
    - `name`: A string representing the name of the data, which is unused in this function.
    - `type`: An integer representing the type of the data to serialize.
    - `type_name`: A string representing the type name, which is unused in this function.
    - `level`: An unsigned integer representing the level of nesting, which is unused in this function.
    - `varint`: An unsigned integer flag indicating whether to encode the data as a variable-length integer.
- **Logic and Control Flow**:
    - Cast `_self` to a `CustomerSerializer` and retrieve the file pointer.
    - Use a `switch` statement to handle different `type` values.
    - For each `type`, perform specific serialization logic, such as printing the value to the file in a specific format.
    - For integer types with `varint` set, encode the integer as a variable-length integer before printing.
    - For floating-point types, print each byte of the value in hexadecimal format.
    - For hash and signature types, print each byte of the value as an unsigned integer.
    - For string types, print the string enclosed in single quotes, or print a comma if `arg` is `NULL`.
    - Log a critical error if an unknown `type` is encountered.
- **Output**: No return value; the function writes serialized data to the file specified in the `CustomerSerializer`.


---
### fd\_runtime\_fuzz\_decode\_type\_run<!-- {{#callable:fd_runtime_fuzz_decode_type_run}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_types_harness.c#L164>)

Decodes a type from input data, serializes it, and generates a YAML representation, storing the results in the output buffer.
- **Inputs**:
    - `runner`: A pointer to an `fd_solfuzz_runner_t` structure, which manages the shared memory allocation.
    - `input`: A pointer to the input data buffer containing the type ID and data to decode.
    - `input_sz`: The size of the input data buffer.
    - `output`: A pointer to the buffer where the serialized and YAML data will be stored.
    - `output_sz`: A pointer to a variable that will store the size of the output data.
- **Logic and Control Flow**:
    - Check if `input_sz` is less than 1; if true, set `output_sz` to 0 and return 0.
    - Extract the type ID from the first byte of `input` and validate it against `fd_types_vt_list_cnt`; if invalid, log a warning, set `output_sz` to 0, and return 0.
    - Retrieve the type metadata from `fd_types_vt_list` using the type ID.
    - Initialize a decode context with the input data starting from the second byte.
    - Calculate the size needed for the decoded object using `decode_footprint`; if unsuccessful, set `output_sz` to 0 and return 0.
    - Allocate memory for the decoded object using `fd_spad_alloc`; if allocation fails, set `output_sz` to 0 and return 0.
    - Decode the object using the type's `decode` function; if decoding fails, set `output_sz` to 0 and return 0.
    - Prepare the output buffer by reserving space for the serialized size and initializing a `CustomerSerializer`.
    - Serialize the decoded object into the output buffer; if serialization fails, set `output_sz` to 0 and return 0.
    - Write the serialized size to the output buffer.
    - Generate a YAML representation of the decoded object and store it in the output buffer; if YAML generation fails, set `output_sz` to 0 and return 0.
    - Calculate the total size of the output data and store it in `output_sz`, then return 1.
- **Output**: Returns 1 on success and 0 on failure, with `output_sz` updated to reflect the size of the serialized and YAML data in the output buffer.


---
### fd\_solfuzz\_type\_run<!-- {{#callable:fd_solfuzz_type_run}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_types_harness.c#L292>)

Processes input data to decode and serialize it into a structured format, storing the results in an output buffer.
- **Inputs**:
    - `runner`: A pointer to an `fd_solfuzz_runner_t` structure used for managing the fuzzing execution context.
    - `input_`: A constant pointer to the input data, expected to be of type `fd_exec_test_type_context_t`.
    - `output_`: A pointer to a location where the function will store the address of the output effects structure.
    - `output_buf`: A pointer to the buffer where the function will store the serialized and YAML data.
    - `output_bufsz`: The size of the `output_buf` in bytes.
- **Logic and Control Flow**:
    - Initialize pointers to input and output structures using type punning.
    - Calculate the end of the output buffer to prevent overflow.
    - Allocate memory for the effects structure in the scratch buffer.
    - Check if the input is valid and return 0 if it is not.
    - Initialize the effects structure with default values.
    - Calculate the maximum content size that can be processed without exceeding the buffer size.
    - Call [`fd_runtime_fuzz_decode_type_run`](<#fd_runtime_fuzz_decode_type_run>) to decode the input data into a temporary buffer.
    - If decoding fails or results in zero size, set the result in effects to 1 and return.
    - Extract the serialized size from the decoded data and allocate memory for the representation.
    - Copy the serialized data into the allocated memory for representation.
    - Calculate the size of the YAML data and allocate memory for it.
    - Copy the YAML data into the allocated memory.
    - Finalize the scratch allocation and store the effects structure in the output pointer.
    - Return the number of bytes used in the output buffer.
- **Output**: Returns the number of bytes used in the `output_buf`, or 0 if an error occurs.
- **Functions Called**:
    - [`fd_runtime_fuzz_decode_type_run`](<#fd_runtime_fuzz_decode_type_run>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)