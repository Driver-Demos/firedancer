<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

A test harness for fuzzing and executing Solana transactions within the Firedancer runtime environment.

# Purpose
The code is a C module designed for fuzz testing of transaction execution within a blockchain runtime environment. It includes functions to create and execute transaction contexts, serialize transactions, and manage transaction execution results. The module imports several headers related to transaction handling, runtime execution, and system variables, indicating its integration with a larger system for blockchain transaction processing.

Key components include macros for safely appending data to transaction buffers, functions for creating transaction execution contexts ([`fd_runtime_fuzz_txn_ctx_create`](<#fd_runtime_fuzz_txn_ctx_create>)), and executing transactions ([`fd_runtime_fuzz_txn_ctx_exec`](<#fd_runtime_fuzz_txn_ctx_exec>)). The [`fd_solfuzz_txn_run`](<#fd_solfuzz_txn_run>) function orchestrates the fuzz testing process by setting up transaction contexts, executing transactions, and capturing execution results. The module handles various aspects of transaction processing, such as account management, fee calculation, and error handling, making it a specialized tool for testing and validating transaction execution in a blockchain environment.
# Imports and Dependencies

---
- `fd_solfuzz.h`
- `fd_solfuzz_private.h`
- `fd_txn_harness.h`
- `../fd_runtime.h`
- `../fd_executor.h`
- `../fd_txn_account.h`
- `../program/fd_builtin_programs.h`
- `../sysvar/fd_sysvar_clock.h`
- `../sysvar/fd_sysvar_epoch_schedule.h`
- `../sysvar/fd_sysvar_recent_hashes.h`
- `../sysvar/fd_sysvar_rent.h`
- `../sysvar/fd_sysvar_slot_hashes.h`
- `../sysvar/fd_sysvar_stake_history.h`
- `../../../disco/pack/fd_pack.h`
- `assert.h`


# Functions

---
### fd\_runtime\_fuzz\_xid\_cancel<!-- {{#callable:fd_runtime_fuzz_xid_cancel}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_txn_harness.c#L35>)

Cancels a transaction identified by `xid` and clears the program cache.
- **Inputs**:
    - `runner`: A pointer to an `fd_solfuzz_runner_t` structure, which contains administrative data for account and program cache management.
    - `xid`: A pointer to an `fd_funk_txn_xid_t` structure, which identifies the transaction to cancel.
- **Logic and Control Flow**:
    - Check if `xid` is NULL; if so, return immediately.
    - Call `fd_accdb_cancel` to cancel the transaction identified by `xid` using the account database admin from `runner`.
    - Call `fd_progcache_clear` to clear the program cache using the program cache admin from `runner`.
- **Output**: No output is returned as the function has a void return type.


---
### fd\_runtime\_fuzz\_txn\_ctx\_create<!-- {{#callable:fd_runtime_fuzz_txn_ctx_create}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_txn_harness.c#L45>)

Creates a transaction execution context for a test case and returns a parsed transaction descriptor on success or NULL on failure.
- **Inputs**:
    - `runner`: A pointer to an `fd_solfuzz_runner_t` structure that manages the execution environment.
    - `test_ctx`: A constant pointer to an `fd_exec_test_txn_context_t` structure containing the test case context.
- **Logic and Control Flow**:
    - Retrieve the account database and funk from the runner.
    - Determine the slot from `test_ctx` or use a default value of 10.
    - Set up the funk transaction with a new transaction ID (`xid`) and attach it to the parent transaction ID (`parent_xid`).
    - Clear the bank in the runner and restore feature flags from `test_ctx`.
    - Set bank variables such as slot, parent slot, and initialize built-in accounts.
    - Load account states into funk using the shared data from `test_ctx`.
    - Configure the bank manager with lamports per signature and fee rate governor settings.
    - Set up epoch schedule, rent, slot hashes, stake history, and clock from system variables.
    - Initialize vote states dummy accounts and attach them to the bank.
    - Initialize blockhash queue and recent block hashes from `test_ctx` or use default values.
    - Restore system variables from the account context.
    - Allocate memory for a raw transaction and serialize it using `test_ctx`.
    - Parse the serialized transaction and return the transaction descriptor if successful, otherwise return NULL.
- **Output**: A pointer to an `fd_txn_p_t` structure representing the parsed transaction descriptor, or NULL if the function fails.
- **Functions Called**:
    - [`fd_runtime_fuzz_restore_features`](<fd_harness_common.c.md#fd_runtime_fuzz_restore_features>)
    - [`fd_runtime_fuzz_load_account`](<fd_harness_common.c.md#fd_runtime_fuzz_load_account>)
    - [`fd_runtime_fuzz_serialize_txn`](<#fd_runtime_fuzz_serialize_txn>)


---
### fd\_runtime\_fuzz\_serialize\_txn<!-- {{#callable:fd_runtime_fuzz_serialize_txn}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_txn_harness.c#L224>)

Serializes a transaction into a raw byte format for execution in a Solana runtime environment.
- **Inputs**:
    - `txn_raw_begin`: A pointer to the beginning of the raw transaction byte array where the serialized transaction will be stored.
    - `tx`: A pointer to a `fd_exec_test_sanitized_transaction_t` structure containing the transaction data to be serialized.
- **Logic and Control Flow**:
    - Initialize `txn_raw_cur_ptr` to point to `txn_raw_begin`.
    - Calculate the number of signatures, ensuring at least one signature is present, and add it to the transaction data.
    - Iterate over each signature, load it, and add it to the transaction data.
    - Determine the number of required signatures, adjust for versioned transactions, and add the header byte if necessary.
    - Add the message header, including the number of required signatures and readonly accounts, to the transaction data.
    - Serialize the account keys as a compact array and add them to the transaction data.
    - Load and add the recent blockhash to the transaction data, using a default if none is provided.
    - Serialize the instructions, including program ID, account addresses, and instruction data, and add them to the transaction data.
    - For non-legacy transactions, serialize address table lookups, including account keys and index arrays, and add them to the transaction data.
    - Return the size of the serialized transaction by calculating the difference between `txn_raw_cur_ptr` and `txn_raw_begin`.
- **Output**: Returns the size of the serialized transaction as an unsigned long integer, or `ULONG_MAX` if an error occurs during serialization.


---
### fd\_runtime\_fuzz\_txn\_ctx\_exec<!-- {{#callable:fd_runtime_fuzz_txn_ctx_exec}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_txn_harness.c#L335>)

Executes a transaction context within a fuzzing runtime environment and returns the execution context.
- **Inputs**:
    - `runner`: A pointer to an `fd_solfuzz_runner_t` structure, which manages the fuzzing runtime environment.
    - `xid`: A constant pointer to an `fd_funk_txn_xid_t` structure, representing the transaction identifier.
    - `txn`: A pointer to an `fd_txn_p_t` structure, representing the transaction to execute.
    - `exec_res`: A pointer to an integer where the function stores the result of the transaction execution.
- **Logic and Control Flow**:
    - Allocate memory for the transaction context using `fd_spad_alloc_check` and initialize it with `fd_exec_txn_ctx_new` and `fd_exec_txn_ctx_join`.
    - Set the `flags` field of the transaction context to `FD_TXN_P_FLAGS_SANITIZE_SUCCESS`.
    - Join the `funk` component of the transaction context to the shared memory of the runner's account database using `fd_funk_join`.
    - Allocate scratch memory for the program cache and join it to the transaction context using `fd_progcache_join`.
    - Set the `bank_hash_cmp` field to `NULL` and configure the `fuzz_config` based on the runner's settings.
    - Copy the transaction identifier `xid` into the transaction context.
    - Call `fd_runtime_prepare_and_execute_txn` to prepare and execute the transaction, storing the result in `exec_res`.
    - Return the initialized and executed transaction context.
- **Output**: Returns a pointer to an `fd_exec_txn_ctx_t` structure, representing the executed transaction context.


---
### fd\_solfuzz\_txn\_run<!-- {{#callable:fd_solfuzz_txn_run}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_txn_harness.c#L367>)

Executes a transaction in a fuzzing environment, captures the results, and returns the size of the output data.
- **Inputs**:
    - `runner`: A pointer to `fd_solfuzz_runner_t`, which manages the fuzzing environment.
    - `input_`: A constant pointer to the input transaction context, cast to `void`.
    - `output_`: A pointer to a pointer where the function will store the address of the transaction result.
    - `output_buf`: A pointer to a buffer where the function will store the transaction execution results.
    - `output_bufsz`: The size of the `output_buf` buffer.
- **Logic and Control Flow**:
    - Initialize the transaction context using [`fd_runtime_fuzz_txn_ctx_create`](<#fd_runtime_fuzz_txn_ctx_create>) with the provided `runner` and `input_`.
    - Create a transaction ID (`xid`) using the current bank slot from `runner`.
    - If transaction context creation fails, cancel the transaction ID and return 0.
    - Execute the transaction using [`fd_runtime_fuzz_txn_ctx_exec`](<#fd_runtime_fuzz_txn_ctx_exec>), capturing the execution result in `exec_res`.
    - Initialize scratch allocation for storing transaction results in `output_buf`.
    - Allocate memory for `fd_exec_test_txn_result_t` and initialize it to zero.
    - Capture basic result fields such as execution success, sanitization error, and status.
    - If a sanitization error occurs, handle fee details and instruction errors, then cancel the transaction ID and return the size of the output data.
    - If no sanitization error, capture instruction errors and fee details, and calculate executed units.
    - If return data is present, allocate space and copy it to the result structure.
    - Allocate space for captured account states and populate them with account data from the transaction context.
    - Finalize the scratch allocation, cancel the transaction ID, and set the `output` pointer to the transaction result.
    - Return the size of the output data written to `output_buf`.
- **Output**: Returns the size of the output data written to `output_buf`, which contains the transaction execution results.
- **Functions Called**:
    - [`fd_runtime_fuzz_txn_ctx_create`](<#fd_runtime_fuzz_txn_ctx_create>)
    - [`fd_runtime_fuzz_xid_cancel`](<#fd_runtime_fuzz_xid_cancel>)
    - [`fd_runtime_fuzz_txn_ctx_exec`](<#fd_runtime_fuzz_txn_ctx_exec>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)