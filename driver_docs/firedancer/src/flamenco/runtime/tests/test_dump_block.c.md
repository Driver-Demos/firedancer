<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Unit tests for block dumping functionality in `fd_dump_pb.c`, including setup, teardown, and round-trip verification.

# Purpose
The `test_dump_block.c` file is a unit test suite designed to verify the block dumping functionality of the `fd_dump_pb.c` module. It includes various components and dependencies necessary for setting up a testing environment, executing tests, and validating the results. The file imports several headers that provide access to functionalities such as block dumping, transaction handling, and context management. It defines constants for test configurations, such as workspace page count and size, and sets up a directory for test output.

The code defines a `test_ctx_t` structure to hold the testing context, including workspace, account database, banks, and contexts for block dumping and capturing. The [`test_ctx_setup`](<#test_ctx_setup>) function initializes this context, allocating memory and setting up necessary components like banks and transaction contexts. The [`test_block_round_trip`](<#test_block_round_trip>) function is a helper that tests the block dumping process by simulating a round-trip verification of block contexts. It decodes input block contexts, sets up banks and transactions, and verifies that the output matches the expected results. The [`main`](<#main>) function orchestrates the setup, execution, and teardown of tests, ensuring that all components are properly initialized and cleaned up.
# Imports and Dependencies

---
- `fd_dump_pb.h`
- `fd_txn_harness.h`
- `../../../util/fd_util.h`
- `../context/fd_capture_ctx.h`
- `../fd_bank.h`
- `../fd_blockhashes.h`
- `../fd_system_ids.h`
- `../../stakes/fd_vote_states.h`
- `../../stakes/fd_stake_delegations.h`
- `../program/fd_stake_program.h`
- `../program/fd_vote_program.h`
- `../../../ballet/nanopb/pb_decode.h`
- `generated/block.pb.h`
- `stdio.h`
- `stdlib.h`
- `sys/stat.h`
- `unistd.h`


# Data Structures

---
### test\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``wksp``: Pointer to a workspace of type `fd_wksp_t`.
    - ``accdb_admin``: Array of one `fd_accdb_admin_t` for account database administration.
    - ``accdb``: Array of one `fd_accdb_user_t` for user account database.
    - ``parent_xid``: Identifier for the parent funk transaction.
    - ``child_xid``: Identifier for the child funk transaction.
    - ``banks``: Pointer to a `fd_banks_t` structure for bank management.
    - ``parent_bank``: Pointer to the parent bank of type `fd_bank_t`.
    - ``child_bank``: Pointer to the child bank of type `fd_bank_t`.
    - ``spad``: Pointer to a scratch pad of type `fd_spad_t` for temporary allocations.
    - ``dump_ctx``: Pointer to a block dump context of type `fd_block_dump_ctx_t`.
    - ``capture_ctx``: Pointer to a capture context of type `fd_capture_ctx_t`.
- **Description**: `test_ctx_t` is a structure that holds the context for testing block dumping functionality. It includes pointers to various components such as workspace, account databases, transaction identifiers, bank management structures, a scratch pad for temporary allocations, and contexts for block dumping and capturing. This structure is used to manage and organize the resources and states required for testing operations.


# Functions

---
### test\_ctx\_setup<!-- {{#callable:test_ctx_setup}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/test_dump_block.c#L63>)

Initializes and sets up a testing context with various components like workspace, account database, banks, and contexts for block dumping and capturing.
- **Inputs**: None
- **Logic and Control Flow**:
    - Retrieve page size and count from environment variables or use defaults.
    - Convert page size string to a memory page size and verify it.
    - Create a new anonymous workspace with the specified page size and count.
    - Allocate and initialize a `test_ctx_t` structure in the workspace.
    - Allocate memory for the account database ('funk') and initialize it.
    - Allocate memory for banks and initialize them, including setting up stake delegations.
    - Create and initialize a parent bank with vote states and previous vote states.
    - Create a child bank by cloning from the parent bank.
    - Allocate and initialize a scratch pad for temporary allocations.
    - Allocate and initialize a block dump context.
    - Allocate and initialize a capture context, setting up parameters for dumping.
    - Create the output directory if it does not exist.
    - Return the initialized `test_ctx_t` structure.
- **Output**: Returns a pointer to an initialized `test_ctx_t` structure containing the setup testing context.
- **Functions Called**:
    - [`fd_block_dump_context_footprint`](<fd_dump_pb.h.md#fd_block_dump_context_footprint>)
    - [`fd_block_dump_context_align`](<fd_dump_pb.h.md#fd_block_dump_context_align>)
    - [`fd_block_dump_context_join`](<fd_dump_pb.h.md#fd_block_dump_context_join>)
    - [`fd_block_dump_context_new`](<fd_dump_pb.h.md#fd_block_dump_context_new>)


---
### test\_ctx\_teardown<!-- {{#callable:test_ctx_teardown}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/test_dump_block.c#L167>)

Releases resources and memory associated with a `test_ctx_t` structure.
- **Inputs**:
    - `test_ctx`: A pointer to a `test_ctx_t` structure that holds various contexts and resources to be cleaned up.
- **Logic and Control Flow**:
    - Check if `test_ctx` is NULL; if so, return immediately.
    - Call `fd_capture_ctx_leave` on `test_ctx->capture_ctx`, then delete and free the capture context.
    - Call [`fd_block_dump_context_leave`](<fd_dump_pb.h.md#fd_block_dump_context_leave>) on `test_ctx->dump_ctx`, then delete and free the dump context.
    - Call `fd_spad_leave` on `test_ctx->spad`, then delete and free the scratch pad.
    - Call `fd_banks_leave` on `test_ctx->banks`, then delete and free the banks context.
    - Leave the user account database (`accdb`) and the admin account database (`accdb_admin`).
    - If `shfunk` is not NULL, delete and free the funk context.
    - Free the `test_ctx` structure itself.
    - Finally, delete the anonymous workspace associated with `test_ctx->wksp`.
- **Output**: No return value; the function performs cleanup operations.
- **Functions Called**:
    - [`fd_block_dump_context_delete`](<fd_dump_pb.h.md#fd_block_dump_context_delete>)
    - [`fd_block_dump_context_leave`](<fd_dump_pb.h.md#fd_block_dump_context_leave>)


---
### restore\_features\_from\_proto<!-- {{#callable:restore_features_from_proto}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/test_dump_block.c#L197>)

Restores feature states from a protobuf feature set by initializing all features as disabled and then activating specified features.
- **Inputs**:
    - ``features``: A pointer to an `fd_features_t` structure where the function will store the restored feature states.
    - ``feature_set``: A constant pointer to an `fd_exec_test_feature_set_t` structure containing the feature IDs to activate.
- **Logic and Control Flow**:
    - Initialize all features in `features` as disabled by setting each element in `features->f` to `FD_FEATURE_DISABLED`.
    - Iterate over each feature ID in `feature_set->features` using a loop.
    - For each feature ID, query its corresponding `fd_feature_id_t` using `fd_feature_id_query`.
    - If the query returns a valid `feature_id`, activate the feature by setting `features->f[feature_id->index]` to `0UL`.
    - If the query returns `NULL`, log a warning message indicating an unknown feature ID.
    - Continue to the next feature ID in the loop.
    - Return `1` to indicate successful completion.
- **Output**: Returns `1` to indicate successful restoration of features.


---
### register\_vote\_account\_from\_funk<!-- {{#callable:register_vote_account_from_funk}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/test_dump_block.c#L217>)

Registers a vote account from a given account in the `funk` database if it meets specific criteria.
- **Inputs**:
    - ``funk``: A pointer to the `fd_funk_t` structure representing the account database.
    - ``xid``: A constant pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``vote_states``: A pointer to the `fd_vote_states_t` structure where the vote state will be updated.
    - ``pubkey``: A pointer to the `fd_pubkey_t` structure representing the public key of the account.
    - ``spad``: A pointer to the `fd_spad_t` structure used for temporary allocations.
- **Logic and Control Flow**:
    - Initialize a transaction account from the `funk` database in read-only mode using the provided `pubkey` and `xid`.
    - Return immediately if the account initialization fails.
    - Check if the account is owned by the vote program; return if not.
    - Check if the account has more than 0 lamports; return if not.
    - Verify if the account is correctly initialized; return if not.
    - Retrieve the vote state from the account data using `fd_vote_get_state`; return if an error occurs.
    - Update the `vote_states` with the account's public key and data.
- **Output**: No output is returned; the function updates the `vote_states` structure if the account meets all criteria.


---
### register\_stake\_delegation\_from\_funk<!-- {{#callable:register_stake_delegation_from_funk}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/test_dump_block.c#L258>)

Registers a stake delegation from an account in the `funk` database if certain conditions are met.
- **Inputs**:
    - ``funk``: A pointer to the `fd_funk_t` structure representing the account database.
    - ``xid``: A constant pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``stake_delegations``: A pointer to the `fd_stake_delegations_t` structure where the stake delegation will be registered.
    - ``pubkey``: A pointer to the `fd_pubkey_t` structure representing the public key of the account to be checked.
- **Logic and Control Flow**:
    - Initialize a transaction account `acc` from the `funk` database in read-only mode using `pubkey` and `xid`.
    - If the account initialization fails, exit the function.
    - Check if the account is owned by the stake program; if not, exit the function.
    - Check if the account has more than 0 lamports; if not, exit the function.
    - Retrieve the stake state from the account and check if it is correctly initialized; if not, exit the function.
    - Check if the account has a non-zero stake; if not, exit the function.
    - Update the `stake_delegations` with the account's stake delegation details.
- **Output**: No output is returned; the function updates the `stake_delegations` structure if conditions are met.


---
### load\_accounts\_from\_proto<!-- {{#callable:load_accounts_from_proto}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/test_dump_block.c#L302>)

Loads account data from a protobuf structure into a Funk account database, skipping accounts with zero lamports.
- **Inputs**:
    - ``accdb``: A pointer to the `fd_accdb_user_t` structure representing the account database where accounts will be loaded.
    - ``xid``: A constant pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID for the current operation.
    - ``acct_states``: A constant pointer to an array of `fd_exec_test_acct_state_t` structures containing the account states to be loaded.
    - ``acct_states_count``: A `pb_size_t` value indicating the number of account states in the `acct_states` array.
- **Logic and Control Flow**:
    - Iterates over each account state in the `acct_states` array.
    - Checks if the account has zero lamports and skips it if true.
    - Calculates the size of the account data if it exists.
    - Copies the account's public key from the state to a local variable.
    - Initializes a mutable transaction account from the Funk database using the public key and transaction ID.
    - If initialization fails, skips to the next account state.
    - Sets the account data if it exists and has a size greater than zero.
    - Sets the account's metadata including lamports, executable flag, owner, and readonly status.
    - Finalizes the mutable transaction account in the Funk database.
- **Output**: No return value; the function modifies the account database `accdb` directly.


---
### test\_block\_round\_trip<!-- {{#callable:test_block_round_trip}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/test_dump_block.c#L344>)

Performs a round-trip test of block context serialization and deserialization, verifying that the input and output contexts match.
- **Inputs**:
    - ``test_ctx``: A pointer to the `test_ctx_t` structure containing the test context and resources.
    - ``block_ctx_data``: A pointer to the block context data to be tested, in the form of a byte array.
    - ``block_ctx_sz``: The size of the block context data in bytes.
    - ``test_name``: A string representing the name of the test being executed.
- **Logic and Control Flow**:
    - Log the start of the test with the given `test_name`.
    - Decode the input block context from the provided data buffer into `input_ctx`.
    - Extract slot information from `input_ctx` to determine `parent_slot` and `child_slot`.
    - Clear existing funk transactions from the previous test using `fd_accdb_clear`.
    - Verify and set up the parent bank using data from `input_ctx`, including slot, block height, and various bank parameters.
    - Set the parent bank hash and lthash using data from `input_ctx`.
    - Restore features from the protobuf feature set and apply them to the parent bank.
    - If present, configure the fee rate governor and inflation settings for the parent bank.
    - Populate previous epoch vote accounts and previous-to-previous epoch vote accounts from `input_ctx`.
    - Initialize and populate the blockhash queue from `input_ctx`, reversing the order for serialization.
    - Create a parent funk transaction and attach it to the account database.
    - Load accounts from `input_ctx` into the funk account database.
    - Initialize and populate stake delegations and current epoch vote states from accounts.
    - Verify and set up the child bank using data from `input_ctx`, including slot, block height, and POH.
    - Create a child funk transaction and attach it to the account database.
    - Reset the dump context and serialize transactions from `input_ctx` for collection.
    - Call the dump function to serialize the block context to a file.
    - Verify that the output file was created and read its contents into `output_buf`.
    - Decode the output block context from `output_buf` into `output_ctx`.
    - Verify that the basic fields, POH, parent bank hash, epoch context fields, inflation, features, parent lthash, fee rate governor, parent signature count, blockhash queue, account states, vote accounts, and transactions match between `input_ctx` and `output_ctx`.
    - Delete the output file after verification.
    - Log the successful completion of the test with the given `test_name`.
    - Free the allocated `output_buf`.
- **Output**: No return value; the function performs verification and logging as side effects.
- **Functions Called**:
    - [`restore_features_from_proto`](<#restore_features_from_proto>)
    - [`load_accounts_from_proto`](<#load_accounts_from_proto>)
    - [`register_vote_account_from_funk`](<#register_vote_account_from_funk>)
    - [`register_stake_delegation_from_funk`](<#register_stake_delegation_from_funk>)
    - [`fd_block_dump_context_reset`](<fd_dump_pb.h.md#fd_block_dump_context_reset>)
    - [`fd_runtime_fuzz_serialize_txn`](<fd_txn_harness.c.md#fd_runtime_fuzz_serialize_txn>)
    - [`fd_dump_block_to_protobuf_collect_tx`](<fd_dump_pb.c.md#fd_dump_block_to_protobuf_collect_tx>)
    - [`fd_dump_block_to_protobuf`](<fd_dump_pb.c.md#fd_dump_block_to_protobuf>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/test_dump_block.c#L854>)

Initializes the test environment, runs block round-trip tests, and cleans up resources.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Sets up the test context by calling [`test_ctx_setup`](<#test_ctx_setup>).
    - Verifies the test context is valid using `FD_TEST`.
    - Runs the [`test_block_round_trip`](<#test_block_round_trip>) function twice with different block contexts to test block dumping and round-trip verification.
    - Cleans up the test context by calling [`test_ctx_teardown`](<#test_ctx_teardown>).
    - Logs a notice that all tests passed using `FD_LOG_NOTICE`.
    - Calls `fd_halt` to terminate the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`test_ctx_setup`](<#test_ctx_setup>)
    - [`test_block_round_trip`](<#test_block_round_trip>)
    - [`test_ctx_teardown`](<#test_ctx_teardown>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)