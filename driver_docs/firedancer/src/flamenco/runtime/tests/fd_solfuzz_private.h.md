<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Internal components for the solfuzz Protobuf shim, including account management and feature activation.

# Purpose
The `fd_solfuzz_private.h` file contains internal components for the `solfuzz` Protobuf shim, which is part of a testing framework. This header file is not intended for public use but rather for internal operations within the `solfuzz` testing environment. It includes several function prototypes and utility functions that facilitate the manipulation and testing of account states and feature sets within a runtime environment. The file includes headers for encoding and decoding Protobuf messages using the `nanopb` library, indicating its role in handling serialized data.

Key functions in this file include [`fd_runtime_fuzz_load_account`](<#fd_runtime_fuzz_load_account>), which manages account states in a testing context, and [`fd_runtime_fuzz_restore_features`](<#fd_runtime_fuzz_restore_features>), which activates specific features in the runtime based on a given feature set. The file also defines a function pointer type `exec_test_run_fn_t` for executing test runs and provides a wrapper function [`fd_solfuzz_execute_wrapper`](<#fd_solfuzz_execute_wrapper>) to manage execution buffers. Additionally, utility functions such as [`sol_compat_decode_lenient`](<#sol_compat_decode_lenient>), [`sol_compat_decode`](<#sol_compat_decode>), and [`sol_compat_encode`](<#sol_compat_encode>) are provided for decoding and encoding Protobuf messages, ensuring compatibility and correctness of data handling within the testing framework.
# Imports and Dependencies

---
- `fd_solfuzz.h`
- `../../features/fd_features.h`
- `../../../ballet/nanopb/pb_encode.h`
- `../../../ballet/nanopb/pb_decode.h`
- `generated/context.pb.h`


# Functions

---
### fd\_solfuzz\_execute\_wrapper<!-- {{#callable:fd_solfuzz_execute_wrapper}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_solfuzz_private.h#L37>)

Executes a test run function with a specified runner and input, allocating output buffer space and handling the output.
- **Inputs**:
    - `runner`: A pointer to `fd_solfuzz_runner_t`, which is the runner context for the execution.
    - `input`: A pointer to the input data for the test run function.
    - `output`: A pointer to a pointer where the output data will be stored.
    - `exec_test_run_fn`: A pointer to the function of type `exec_test_run_fn_t` that will be executed.
- **Logic and Control Flow**:
    - Allocate 100 MB of buffer space using `fd_spad_alloc` for the output.
    - Check if the allocated buffer size is within the maximum allowed size using `FD_TEST`.
    - Call the `exec_test_run_fn` function with the runner, input, output, allocated buffer, and buffer size.
    - If the function returns zero (indicating no output was used), set the `output` pointer to `NULL`.
- **Output**: The function does not return a value, but it modifies the `output` pointer to point to the result of the execution or `NULL` if no output was used.


---
### sol\_compat\_decode\_lenient<!-- {{#callable:sol_compat_decode_lenient}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_solfuzz_private.h#L56>)

Decodes a Protobuf message from a buffer into a provided structure without initializing the structure.
- **Inputs**:
    - `decoded`: A pointer to the structure where the decoded message will be stored.
    - `in`: A pointer to the input buffer containing the encoded Protobuf message.
    - `in_sz`: The size of the input buffer in bytes.
    - `decode_type`: A pointer to the Protobuf message descriptor that defines the structure of the message to decode.
- **Logic and Control Flow**:
    - Create an input stream `istream` from the buffer `in` with size `in_sz`.
    - Attempt to decode the message from `istream` into `decoded` using the message descriptor `decode_type` without initializing `decoded`.
    - If decoding fails, release any resources associated with `decoded` and return `NULL`.
    - If decoding succeeds, return the pointer `decoded`.
- **Output**: Returns a pointer to the decoded structure if successful, or `NULL` if decoding fails.


---
### sol\_compat\_decode<!-- {{#callable:sol_compat_decode}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_solfuzz_private.h#L70>)

Decodes a Protobuf message from a buffer and verifies its size.
- **Inputs**:
    - `decoded`: A pointer to the memory where the decoded message will be stored.
    - `in`: A pointer to the input buffer containing the encoded Protobuf message.
    - `in_sz`: The size of the input buffer in bytes.
    - `decode_type`: A pointer to the Protobuf message descriptor that defines the structure of the message to decode.
- **Logic and Control Flow**:
    - Initialize a Protobuf input stream from the input buffer using `pb_istream_from_buffer`.
    - Attempt to decode the message from the input stream into the `decoded` memory using `pb_decode_ex`.
    - If decoding fails, release any allocated resources using `pb_release` and return `NULL`.
    - Retrieve the encoded size of the decoded message using `pb_get_encoded_size`.
    - If retrieving the size fails or if the size does not match `in_sz`, release resources and return `NULL`.
    - If all checks pass, return the pointer to the decoded message.
- **Output**: Returns a pointer to the decoded message if successful, or `NULL` if decoding fails or the size check fails.


---
### sol\_compat\_encode<!-- {{#callable:sol_compat_encode}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_solfuzz_private.h#L93>)

Encodes a given data structure into a Protobuf format and writes it to a buffer.
- **Inputs**:
    - ``out``: A pointer to the buffer where the encoded data will be written.
    - ``out_sz``: A pointer to a variable that holds the size of the buffer; it will be updated with the number of bytes written.
    - ``to_encode``: A pointer to the data structure that needs to be encoded.
    - ``encode_type``: A pointer to the Protobuf message descriptor that defines the encoding format.
- **Logic and Control Flow**:
    - Initialize a Protobuf output stream `ostream` using the buffer `out` and its size `*out_sz`.
    - Call `pb_encode` to encode `to_encode` using `encode_type` and write the result to `ostream`.
    - Check if `pb_encode` was successful; if not, return `NULL`.
    - Update `*out_sz` with the number of bytes written to the buffer.
    - Return the pointer `to_encode` if encoding is successful.
- **Output**: Returns a pointer to the original data `to_encode` if encoding is successful, otherwise returns `NULL`.


# Function Declarations (Public API)

---
### fd\_runtime\_fuzz\_load\_account<!-- {{#callable_declaration:fd_runtime_fuzz_load_account}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_solfuzz_private.h#L13>)

Creates or overwrites an account in the database based on the provided account state.
- **Description**: Use this function to create or update an account in the database with the specified account state. It loads the account into the provided `acc` structure. If `reject_zero_lamports` is set to a non-zero value, the function will not load accounts with zero lamports. Ensure that the account does not already exist in the database before calling this function. The function returns a success indicator.
- **Inputs**:
    - `acc`: A pointer to an `fd_txn_account_t` structure where the account will be loaded. Must not be null.
    - `funk`: A pointer to an `fd_funk_t` structure representing the database. Must not be null.
    - `xid`: A pointer to an `fd_funk_txn_xid_t` structure representing the transaction ID. Must not be null.
    - `state`: A pointer to an `fd_exec_test_acct_state_t` structure containing the account state to load. Must not be null.
    - `reject_zero_lamports`: An unsigned char flag. If non-zero, accounts with zero lamports will not be loaded.
- **Output**: Returns 1 on success, or 0 if the account already exists or if a zero-lamport account is rejected.
- **See Also**: [`fd_runtime_fuzz_load_account`](<fd_harness_common.c.md#fd_runtime_fuzz_load_account>)  (Implementation)


---
### fd\_runtime\_fuzz\_restore\_features<!-- {{#callable_declaration:fd_runtime_fuzz_restore_features}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_solfuzz_private.h#L27>)

Activates features in the runtime based on a given feature set.
- **Description**: Use this function to enable specific features in the runtime environment by providing a set of feature identifiers. It disables all features initially and then selectively enables those specified in the input feature set. This function must be called with a valid feature set, and it will return an error if any feature in the set is not supported. Ensure that the `features` parameter is a valid pointer to a `fd_features_t` structure, and the `feature_set` parameter is a valid pointer to a `fd_exec_test_feature_set_t` structure.
- **Inputs**:
    - `features`: A pointer to an `fd_features_t` structure where the function will activate the specified features. Must not be null.
    - `feature_set`: A pointer to a `fd_exec_test_feature_set_t` structure containing the features to activate. Must not be null. The function will return an error if any feature in this set is unsupported.
- **Output**: Returns 1 on success, indicating all specified features were activated. Returns 0 if any feature in the set is unsupported.
- **See Also**: [`fd_runtime_fuzz_restore_features`](<fd_harness_common.c.md#fd_runtime_fuzz_restore_features>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)