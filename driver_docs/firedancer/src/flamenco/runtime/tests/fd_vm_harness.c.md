<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Test harness for fuzz testing a virtual machine's system calls and execution context.

# Purpose
The code is a C source file that implements a set of functions for executing and testing virtual machine (VM) instructions and syscalls in a fuzzing environment. It includes functions for setting up and running a VM, handling syscalls, and capturing the effects of these operations. The file imports several headers that provide necessary data structures and functions, such as `fd_executor.h`, `fd_system_ids.h`, and `fd_vm.h`, indicating that it relies on external components for execution context and VM management.

Key functions in the code include [`fd_runtime_fuzz_vm_syscall_noop`](<#fd_runtime_fuzz_vm_syscall_noop>), which defines a no-operation syscall, and [`fd_runtime_fuzz_lookup_syscall_func`](<#fd_runtime_fuzz_lookup_syscall_func>), which searches for a syscall function by name. The [`fd_solfuzz_vm_interp_run`](<#fd_solfuzz_vm_interp_run>) and [`fd_solfuzz_syscall_run`](<#fd_solfuzz_syscall_run>) functions are responsible for executing VM instructions and syscalls, respectively, capturing the resulting state and effects. These functions perform tasks such as setting up execution contexts, initializing VM state, and handling input and output data regions. The code is designed to be part of a larger system that tests the behavior of VM instructions and syscalls under various conditions, likely for the purpose of identifying bugs or vulnerabilities.
# Imports and Dependencies

---
- `fd_instr_harness.h`
- `../fd_executor.h`
- `../fd_system_ids.h`
- `../program/fd_bpf_loader_serialization.h`
- `../context/fd_exec_txn_ctx.h`
- `../../../ballet/sbpf/fd_sbpf_loader.h`
- `../../vm/fd_vm.h`
- `../../vm/test_vm_util.h`
- `generated/vm.pb.h`


# Functions

---
### fd\_runtime\_fuzz\_vm\_syscall\_noop<!-- {{#callable:fd_runtime_fuzz_vm_syscall_noop}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_vm_harness.c#L11>)

Implements a no-operation (noop) syscall for a virtual machine, setting the return value to zero.
- **Inputs**:
    - `_vm`: A pointer to the virtual machine instance, which is not used in this function.
    - `arg0`: An unsigned long integer argument, which is not used in this function.
    - `arg1`: An unsigned long integer argument, which is not used in this function.
    - `arg2`: An unsigned long integer argument, which is not used in this function.
    - `arg3`: An unsigned long integer argument, which is not used in this function.
    - `arg4`: An unsigned long integer argument, which is not used in this function.
    - `_ret`: A pointer to an unsigned long integer where the function stores the return value, set to zero.
- **Logic and Control Flow**:
    - The function casts the `_vm` pointer to a `fd_vm_t` type and comments out the code to deduct compute units (CUs) from the virtual machine.
    - All input arguments (`_vm`, `arg0`, `arg1`, `arg2`, `arg3`, `arg4`) are explicitly marked as unused using `(void)` to avoid compiler warnings.
    - Sets the value pointed to by `_ret` to zero, indicating a no-operation result.
    - Returns zero to indicate successful execution.
- **Output**: Returns zero, indicating successful execution, and sets the value pointed to by `_ret` to zero.


---
### fd\_runtime\_fuzz\_lookup\_syscall\_func<!-- {{#callable:fd_runtime_fuzz_lookup_syscall_func}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_vm_harness.c#L34>)

Searches for a syscall in the `syscalls` array that matches the given `syscall_name` and `len`, and returns a pointer to it if found.
- **Inputs**:
    - `syscalls`: An array of `fd_sbpf_syscalls_t` structures representing available syscalls.
    - `syscall_name`: A pointer to a character string representing the name of the syscall to search for.
    - `len`: The length of the `syscall_name` string.
- **Logic and Control Flow**:
    - Check if `syscall_name` is NULL; if so, return NULL immediately.
    - Iterate over the `syscalls` array using a loop from 0 to the count of syscall slots.
    - For each syscall, check if the syscall key is valid, the syscall name is not NULL, and the length of the syscall name matches `len`.
    - If the above conditions are met, compare the syscall name with `syscall_name` using `memcmp`.
    - If `memcmp` returns 0, indicating a match, return a pointer to the matching syscall.
    - If no match is found after the loop, return NULL.
- **Output**: A pointer to the `fd_sbpf_syscalls_t` structure that matches the given `syscall_name` and `len`, or NULL if no match is found.


---
### fd\_runtime\_fuzz\_load\_from\_vm\_input\_regions<!-- {{#callable:fd_runtime_fuzz_load_from_vm_input_regions}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_vm_harness.c#L53>)

Loads data from virtual machine input regions into an output buffer, ensuring the buffer is large enough and copying data as needed.
- **Inputs**:
    - ``input``: A pointer to an array of `fd_vm_input_region_t` structures representing the input regions.
    - ``input_count``: The number of input regions in the `input` array.
    - ``output``: A pointer to a pointer where the function will store the address of the allocated output regions.
    - ``output_count``: A pointer to a `pb_size_t` where the function will store the number of output regions.
    - ``output_buf``: A pointer to the buffer where the output data will be stored.
    - ``output_bufsz``: The size of the `output_buf` in bytes.
- **Logic and Control Flow**:
    - Calculate the total size of all input regions by iterating over `input` and summing `region_sz` for each region.
    - Check if the total size of input regions is zero or if `output_bufsz` is less than the total size; if so, set `*output` to `NULL`, `*output_count` to 0, and return 0.
    - Initialize a scratch allocator with `output_buf` and allocate memory for `output` to hold `input_count` elements of type `fd_exec_test_input_data_region_t`.
    - Set `*output_count` to `input_count`.
    - Iterate over each input region, copying `is_writable` and `vaddr_offset` to the corresponding output region.
    - If an input region's size is greater than zero, allocate memory for its content in the output region, copy the content from the input region's `haddr`, and set the size.
    - Finalize the scratch allocator and return the number of bytes written to `output_buf`.
- **Output**: Returns the number of bytes written to `output_buf`.


---
### fd\_solfuzz\_vm\_interp\_run<!-- {{#callable:fd_solfuzz_vm_interp_run}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_vm_harness.c#L101>)

Executes a virtual machine (VM) instruction set using a given runner and input, and captures the effects of the execution.
- **Inputs**:
    - `runner`: A pointer to an `fd_solfuzz_runner_t` structure that manages the execution context.
    - `input_`: A constant pointer to the input data, which is cast to `fd_exec_test_syscall_context_t`.
    - `output_`: A pointer to a pointer where the function will store the address of the output effects.
    - `output_buf`: A pointer to a buffer where the function will store the output data.
    - `output_bufsz`: The size of the `output_buf` buffer in bytes.
- **Logic and Control Flow**:
    - Casts `input_` to `fd_exec_test_syscall_context_t` and `output_` to `fd_exec_test_syscall_effects_t` pointers.
    - Creates an execution context using [`fd_runtime_fuzz_instr_ctx_create`](<fd_instr_harness.c.md#fd_runtime_fuzz_instr_ctx_create>) and checks for VM context availability.
    - Initializes a scratch allocation for output effects and checks buffer size constraints.
    - Sets up regions, including read-only data (`rodata`) and input memory regions, and handles deprecated program IDs.
    - Pushes the instruction onto the stack and serializes accounts into input memory regions.
    - Configures call destinations (`calldests`) and syscalls, setting them as no-ops.
    - Initializes the VM with the prepared context, memory regions, and syscalls.
    - Sets up VM registers and validates the VM state.
    - Copies stack and heap prefixes if provided in the input.
    - Executes the VM with or without tracing based on the `enable_vm_tracing` flag.
    - Captures execution results, including errors, register states, and memory regions.
    - Compresses the stack by removing trailing zeros and captures the final state of the VM.
    - Finalizes the scratch allocation and returns the size of the output data written.
- **Output**: Returns the number of bytes written to the `output_buf`, and stores the execution effects in the `output_` pointer.
- **Functions Called**:
    - [`fd_runtime_fuzz_instr_ctx_create`](<fd_instr_harness.c.md#fd_runtime_fuzz_instr_ctx_create>)
    - [`fd_runtime_fuzz_instr_ctx_destroy`](<fd_instr_harness.c.md#fd_runtime_fuzz_instr_ctx_destroy>)
    - [`fd_runtime_fuzz_load_from_vm_input_regions`](<#fd_runtime_fuzz_load_from_vm_input_regions>)


---
### fd\_solfuzz\_syscall\_run<!-- {{#callable:fd_solfuzz_syscall_run}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_vm_harness.c#L382>)

Executes a syscall in a fuzzing environment, capturing its effects and returning the size of the output data.
- **Inputs**:
    - ``runner``: A pointer to an `fd_solfuzz_runner_t` structure that manages the execution context.
    - ``input_``: A constant pointer to the input data, which is cast to `fd_exec_test_syscall_context_t`.
    - ``output_``: A pointer to a pointer where the function will store the address of the output effects.
    - ``output_buf``: A pointer to a buffer where the function will store the output data.
    - ``output_bufsz``: The size of the `output_buf` buffer in bytes.
- **Logic and Control Flow**:
    - Cast `input_` to `fd_exec_test_syscall_context_t` and `output_` to `fd_exec_test_syscall_effects_t` pointers.
    - Create an execution context using [`fd_runtime_fuzz_instr_ctx_create`](<fd_instr_harness.c.md#fd_runtime_fuzz_instr_ctx_create>) and check for errors.
    - Initialize the output buffer and allocate space for `fd_exec_test_syscall_effects_t`.
    - Copy return data from `input` to the transaction context if available.
    - Set up the VM instance, including memory regions and syscalls.
    - Override VM registers and memory with data from `input` if specified.
    - Look up the syscall function to execute using [`fd_runtime_fuzz_lookup_syscall_func`](<#fd_runtime_fuzz_lookup_syscall_func>).
    - Invoke the syscall and handle any errors, logging if necessary.
    - Capture the effects of the syscall, including errors, register states, and memory regions.
    - Return the size of the output data written to `output_buf`.
- **Output**: Returns the number of bytes written to `output_buf`, or 0 if an error occurs.
- **Functions Called**:
    - [`fd_runtime_fuzz_instr_ctx_create`](<fd_instr_harness.c.md#fd_runtime_fuzz_instr_ctx_create>)
    - [`fd_runtime_fuzz_lookup_syscall_func`](<#fd_runtime_fuzz_lookup_syscall_func>)
    - [`fd_runtime_fuzz_load_from_vm_input_regions`](<#fd_runtime_fuzz_load_from_vm_input_regions>)
    - [`fd_runtime_fuzz_instr_ctx_destroy`](<fd_instr_harness.c.md#fd_runtime_fuzz_instr_ctx_destroy>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)