<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Runs ledger tests in parallel using multiple CPU batches and handles command execution errors.

# Purpose
This script is designed to execute a series of shell commands in parallel using multiple CPU cores. It reads commands from a specified file and distributes them across available CPU cores, grouped into batches. The script defines two functions, [`group_cpus_by_batch_size`](<#group_cpus_by_batch_size>) and [`group_cpus_by_num_batches`](<#group_cpus_by_num_batches>), to organize CPU cores into batches based on either a specified batch size or a specified number of batches. These batches are used to define parameter ranges for the commands.

The script uses the `multiprocessing` module to manage parallel execution. It creates a pool of worker processes, each responsible for executing commands with specific CPU parameters. The [`worker`](<#worker>) function retrieves commands from a queue, executes them, and handles any errors that occur during execution. If an error occurs, it sets an event to signal all workers to stop processing. The script ensures that all commands are processed and checks for errors before terminating. The script is intended to be run as a standalone program, taking a file path as a command-line argument to specify the file containing the commands to execute.
# Imports and Dependencies

---
- `subprocess`
- `multiprocessing`
- `multiprocessing.Queue`
- `multiprocessing.Value`
- `multiprocessing.Event`
- `os`
- `sys`


# Functions

---
### group\_cpus\_by\_batch\_size<!-- {{#callable:firedancer/src/flamenco/runtime/tests/run_ledger_tests_all.group_cpus_by_batch_size}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/run_ledger_tests_all.py#L7>)

Groups available CPUs into batches of a specified size, with a maximum limit of 128 CPUs.
- **Inputs**:
    - `batch_size`: The number of CPUs to include in each batch, with a default value of 8.
- **Logic and Control Flow**:
    - Import the `os` module to access CPU information.
    - Get the total number of available CPUs using `os.cpu_count()`.
    - Limit the number of CPUs to 128 if the available count exceeds 128.
    - Print the total number of CPUs available.
    - Create batches of CPUs starting from index 2 up to the total number of CPUs, with each batch containing up to `batch_size` CPUs.
    - Return the list of CPU batches.
- **Output**: A list of lists, where each inner list contains indices representing a batch of CPUs.


---
### group\_cpus\_by\_num\_batches<!-- {{#callable:firedancer/src/flamenco/runtime/tests/run_ledger_tests_all.group_cpus_by_num_batches}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/run_ledger_tests_all.py#L19>)

Groups available CPUs into a specified number of batches.
- **Inputs**:
    - `num_batches`: The number of batches to divide the CPUs into, default is 4.
- **Logic and Control Flow**:
    - Import the `os` module to access system-level information.
    - Get the total number of available CPUs using `os.cpu_count()`.
    - Calculate the `batch_size` by dividing `num_cpus` by `num_batches`.
    - Create a list of CPU batches using a list comprehension, where each batch is a list of CPU indices.
    - Limit the number of batches to `num_batches` by slicing the list of batches.
    - Return the list of CPU batches.
- **Output**: A list of lists, where each inner list contains indices of CPUs grouped into a batch.


---
### worker<!-- {{#callable:firedancer/src/flamenco/runtime/tests/run_ledger_tests_all.worker}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/run_ledger_tests_all.py#L32>)

Executes commands from a queue using available parameters and handles errors during execution.
- **Inputs**:
    - `command_queue`: A queue containing commands to execute.
    - `available_params`: A queue containing available parameters for command execution.
    - `error_occurred`: A shared integer value to indicate if an error occurred.
    - `error_event`: An event object to signal if an error has occurred.
- **Logic and Control Flow**:
    - Continuously checks if the `error_event` is set; if not, retrieves a command from `command_queue`.
    - If the command is `None`, breaks the loop to stop the worker.
    - Retrieves a parameter from `available_params` to use with the command.
    - Attempts to execute the command with the parameter using `subprocess.run`.
    - If the command execution fails, prints an error message, sets `error_occurred` to 1, sets `error_event`, and breaks the loop.
    - Releases the parameter back to `available_params` after command execution.
- **Output**: No direct output; performs command execution and error handling.


---
### main<!-- {{#callable:firedancer/src/flamenco/runtime/tests/run_ledger_tests_all.main}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/run_ledger_tests_all.py#L55>)

Executes commands from a file using multiprocessing with CPU batch parameters and handles errors.
- **Inputs**:
    - `file_path`: The path to the file containing commands to execute.
- **Logic and Control Flow**:
    - Calls [`group_cpus_by_batch_size`](<#group_cpus_by_batch_size>) to get CPU batches and limits to the first 5 batches.
    - Prints the CPU batches and defines parameter ranges for each batch.
    - Opens the file at `file_path` and reads commands into a list, stripping whitespace.
    - Creates a `multiprocessing.Manager` to manage shared queues and values across processes.
    - Initializes a queue `available_params` with parameter ranges and a queue `command_queue` with commands.
    - Initializes a shared integer `error_occurred` to track errors and an `Event` `error_event` for error signaling.
    - Creates and starts a process for each CPU batch, targeting the `worker` function with necessary arguments.
    - Signals workers to stop by putting `None` in the `command_queue` for each process.
    - Waits for all processes to complete using `join`.
    - Checks if any process failed by examining `error_occurred`; if so, terminates all processes and exits with an error code.
- **Output**: None. The function performs actions and prints output but does not return a value.
- **Functions Called**:
    - [`firedancer/src/flamenco/runtime/tests/run_ledger_tests_all.group_cpus_by_batch_size`](<#group_cpus_by_batch_size>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)