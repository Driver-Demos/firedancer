<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

A test harness for loading and executing ELF files using the Solfuzz framework.

# Purpose
The code defines a function [`fd_solfuzz_elf_loader_run`](<#fd_solfuzz_elf_loader_run>) that is part of a fuzz testing framework for loading and analyzing ELF (Executable and Linkable Format) files. The function is designed to process input data related to ELF files, execute specific loading operations, and capture the effects of these operations. It uses several components from the `fd_solfuzz`, `fd_sbpf_loader`, and related modules to handle ELF file parsing and loading. The function checks for the presence of ELF data, allocates necessary memory for processing, and uses a series of operations to load and analyze the ELF file, including handling program sections and system calls.

The function is structured to handle errors gracefully, returning early if any step fails. It uses a scratch buffer for memory allocation and captures the results of the ELF loading process in a structure `fd_exec_test_elf_loader_effects_t`. This structure includes information such as the size of the read-only data section, entry point, and call destinations. The function also sorts the call destinations to ensure they are in ascending order. The code is part of a larger system that likely involves testing and validating ELF files in a secure and controlled manner, using fuzzing techniques to identify potential issues or vulnerabilities.
# Imports and Dependencies

---
- `fd_solfuzz.h`
- `fd_solfuzz_private.h`
- `generated/elf.pb.h`
- `../../../ballet/sbpf/fd_sbpf_loader.h`
- `../program/fd_bpf_loader_program.h`
- `../../vm/fd_vm_base.h`
- `../../progcache/fd_prog_load.h`
- `../../../util/tmpl/fd_sort.c`


# Functions

---
### fd\_solfuzz\_elf\_loader\_run<!-- {{#callable:fd_solfuzz_elf_loader_run}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_elf_harness.c#L14>)

Loads and processes an ELF binary, capturing its effects and returning the size of the processed data.
- **Inputs**:
    - `runner`: A pointer to `fd_solfuzz_runner_t`, which contains the shared program address data (spad) used for memory allocation.
    - `input_`: A constant pointer to the input data, which is cast to `fd_exec_test_elf_loader_ctx_t` to access ELF and feature information.
    - `output_`: A pointer to a pointer where the function will store the address of the allocated `fd_exec_test_elf_loader_effects_t` structure.
    - `output_buf`: A pointer to the buffer where the function will allocate memory for the ELF effects.
    - `output_bufsz`: The size of the `output_buf` buffer.
- **Logic and Control Flow**:
    - Check if the input has an ELF binary; if not, return 0.
    - Initialize ELF size and binary pointers based on input data availability.
    - Calculate the end of the output buffer and initialize scratch allocation.
    - Allocate memory for `fd_exec_test_elf_loader_effects_t` and check if allocation exceeds buffer size; return 0 if it does.
    - Initialize feature set and loader configuration based on input features and deploy checks.
    - Peek into the ELF binary to gather information; exit if an error occurs.
    - Allocate memory for read-only data, program, and syscalls using the shared program address data (spad).
    - Register syscalls based on the active feature set.
    - Load the ELF program into memory; exit if an error occurs.
    - Capture and store the read-only data size and content in the effects structure.
    - Store text section count, offset, and entry point in the effects structure.
    - Calculate the maximum size for call destinations and allocate memory for them.
    - Add the entry point and other call destinations to the effects structure, ensuring no duplicates.
    - Sort the call destinations in ascending order.
    - Store the error code in the effects structure and finalize the scratch allocation.
    - Set the output pointer to the effects structure and return the size of the processed data.
- **Output**: Returns the size of the processed data as an unsigned long integer, or 0 if an error occurs during processing.
- **Functions Called**:
    - [`fd_runtime_fuzz_restore_features`](<fd_harness_common.c.md#fd_runtime_fuzz_restore_features>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)