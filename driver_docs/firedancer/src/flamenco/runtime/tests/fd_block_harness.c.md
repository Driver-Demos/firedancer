<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for testing block execution and leader schedule management in a Solana-like runtime environment.

# Purpose
The code is a C source file that implements a fuzz testing framework for a blockchain runtime, specifically targeting the Solana blockchain. It includes functions to set up and execute block contexts, register vote accounts, and manage stake delegations. The file imports several header files that provide necessary data structures and functions for handling transactions, accounts, and system variables. The primary purpose of this code is to simulate and test the execution of blocks within the Solana runtime environment, allowing for the validation of transaction processing and state transitions.

Key components of the code include functions for initializing and refreshing vote accounts, registering stake delegations, and executing transactions against the runtime. The code also includes logic for building leader schedules and handling epoch transitions. The [`fd_runtime_fuzz_block_ctx_create`](<#fd_runtime_fuzz_block_ctx_create>) function sets up the execution context for a block, while [`fd_runtime_fuzz_block_ctx_exec`](<#fd_runtime_fuzz_block_ctx_exec>) executes the transactions within that context. The code uses a variety of data structures, such as `fd_vote_states_t` and `fd_stake_delegations_t`, to manage the state of vote accounts and stake delegations. Additionally, the code includes mechanisms for capturing execution results and generating effects, which are used to verify the correctness of the runtime's behavior during fuzz testing.
# Imports and Dependencies

---
- `fd_solfuzz_private.h`
- `../fd_cost_tracker.h`
- `fd_txn_harness.h`
- `../fd_runtime.h`
- `../fd_system_ids.h`
- `../fd_txn_account.h`
- `../fd_runtime_stack.h`
- `../program/fd_stake_program.h`
- `../program/fd_vote_program.h`
- `../sysvar/fd_sysvar_epoch_schedule.h`
- `../sysvar/fd_sysvar_rent.h`
- `../sysvar/fd_sysvar_recent_hashes.h`
- `../../rewards/fd_rewards.h`
- `../../stakes/fd_stakes.h`
- `../../types/fd_types.h`
- `../../../disco/pack/fd_pack.h`
- `generated/block.pb.h`
- `../../../util/tmpl/fd_sort.c`


# Data Structures

---
### pk\_with\_pos\_t
- **Type**: ``struct``
- **Members**:
    - ``pk``: A public key of type `fd_pubkey_t`.
    - ``sched_pos``: An unsigned long integer that tracks the original position in the `sched[]` array.
- **Description**: Represents a structure that combines a public key with its original position in a schedule array. This structure is useful for sorting or tracking the order of public keys in a scheduling context.


# Functions

---
### fd\_runtime\_fuzz\_block\_refresh\_vote\_accounts<!-- {{#callable:fd_runtime_fuzz_block_refresh_vote_accounts}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_block_harness.c#L35>)

Updates the vote accounts' stake delegations using the current and previous epoch's vote states and stake delegations.
- **Inputs**:
    - ``vote_states``: A pointer to the current vote states cache to update with new stake delegations.
    - ``vote_states_prev_prev``: A pointer to the vote states cache from two epochs ago, used to determine previous stakes.
    - ``stake_delegations``: A pointer to the stake delegations cache, which contains the current stake delegation information.
    - ``epoch``: The current epoch number, used to determine how to update the `stake_t_2` field.
- **Logic and Control Flow**:
    - Initialize an iterator for the `stake_delegations` and iterate through each stake delegation.
    - For each stake delegation, retrieve the voter public key and stake amount.
    - Query the `vote_states` for the corresponding vote state using the voter public key.
    - If the vote state exists, update its `stake` and `stake_t_2` fields by adding the current stake amount.
    - Initialize an iterator for the `vote_states_prev_prev` and iterate through each vote state.
    - For each vote state, query the `vote_states_prev_prev` for the corresponding previous vote state using the vote account public key.
    - Determine the `t_2_stake` based on whether the previous vote state exists and the current epoch number.
    - Update the `stake_t_2` field of the current vote state based on the `t_2_stake` or the current stake.
- **Output**: The function does not return a value; it updates the `vote_states` in place.


---
### fd\_runtime\_fuzz\_block\_register\_vote\_account<!-- {{#callable:fd_runtime_fuzz_block_register_vote_account}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_block_harness.c#L77>)

Registers a vote account into the current vote states cache if it meets specific criteria.
- **Inputs**:
    - ``funk``: A pointer to an `fd_funk_t` structure, representing the current transaction context.
    - ``xid``: A pointer to a constant `fd_funk_txn_xid_t` structure, representing the transaction ID.
    - ``vote_states``: A pointer to an `fd_vote_states_t` structure, representing the current vote states cache.
    - ``pubkey``: A pointer to an `fd_pubkey_t` structure, representing the public key of the account to register.
    - ``spad``: A pointer to an `fd_spad_t` structure, used for temporary storage during processing.
- **Logic and Control Flow**:
    - Initialize a transaction account from the `funk` context using the provided `pubkey` and `xid` in read-only mode.
    - If the account initialization fails, exit the function.
    - Check if the account is owned by the vote program; if not, exit the function.
    - Verify that the account has more than 0 lamports; if not, exit the function.
    - Ensure the account is correctly initialized; if not, exit the function.
    - Retrieve the vote state from the account data into a `fd_vote_state_versioned_t` structure.
    - If retrieving the vote state fails, exit the function.
    - Update the `vote_states` cache with the account's public key and data.
- **Output**: No explicit return value; the function updates the `vote_states` cache if the account meets all criteria.


---
### fd\_runtime\_fuzz\_block\_register\_stake\_delegation<!-- {{#callable:fd_runtime_fuzz_block_register_stake_delegation}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_block_harness.c#L119>)

Stores an entry in the stake delegations cache for a given vote account by deserializing and using the current account state to derive delegation information.
- **Inputs**:
    - ``funk``: A pointer to `fd_funk_t`, representing the current transaction context.
    - ``xid``: A constant pointer to `fd_funk_txn_xid_t`, representing the transaction identifier.
    - ``stake_delegations``: A pointer to `fd_stake_delegations_t`, representing the stake delegations cache to update.
    - ``pubkey``: A pointer to `fd_pubkey_t`, representing the public key of the account to register.
- **Logic and Control Flow**:
    - Initialize a transaction account from the `funk` context using the provided `pubkey` and `xid` in read-only mode.
    - If the account initialization fails, return immediately.
    - Check if the account is owned by the stake program; if not, return immediately.
    - Check if the account has more than 0 lamports; if not, return immediately.
    - Retrieve the stake state from the account and check if it is initialized correctly; if not, return immediately.
    - Check if the account has a non-zero stake; if not, return immediately.
    - Update the `stake_delegations` cache with the account's delegation information.
- **Output**: No explicit output is returned; the function updates the `stake_delegations` cache with the account's delegation information if all conditions are met.


---
### fd\_runtime\_fuzz\_block\_update\_prev\_epoch\_votes\_cache<!-- {{#callable:fd_runtime_fuzz_block_update_prev_epoch_votes_cache}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_block_harness.c#L163>)

Updates the previous epoch's vote cache with vote account data and stake information.
- **Inputs**:
    - ``vote_states``: A pointer to `fd_vote_states_t`, representing the vote states to update.
    - ``vote_accounts``: A pointer to an array of `fd_exec_test_vote_account_t`, representing the vote accounts to process.
    - ``vote_accounts_cnt``: A `pb_size_t` value indicating the number of vote accounts in the `vote_accounts` array.
    - ``spad``: A pointer to `fd_spad_t`, used for temporary storage during processing.
- **Logic and Control Flow**:
    - Begins a frame for temporary storage using `FD_SPAD_FRAME_BEGIN` with `spad`.
    - Iterates over each vote account in `vote_accounts` using a for loop.
    - For each vote account, retrieves the account state, stake, and vote data.
    - Copies the vote account's address into a `fd_pubkey_t` variable `vote_address`.
    - Attempts to decode the vote state from the account data using `fd_bincode_decode_spad`.
    - If decoding is successful, updates the vote states with the account data using `fd_vote_states_update_from_account`.
    - Queries the updated vote state using `fd_vote_states_query`.
    - Increments the `stake` and `stake_t_2` fields of the vote state by the account's stake.
    - Ends the temporary storage frame using `FD_SPAD_FRAME_END`.
- **Output**: No return value; the function updates the vote states in place.


---
### FD\_SPAD\_FRAME\_BEGIN<!-- {{#callable:fd_runtime_fuzz_block_update_prev_epoch_votes_cache::FD_SPAD_FRAME_BEGIN}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_block_harness.c#L168>)

Processes vote accounts to update their stake information in the vote states cache.
- **Inputs**:
    - `spad`: A pointer to a `fd_spad_t` structure used for temporary storage during the function execution.
- **Logic and Control Flow**:
    - Iterates over each vote account in the `vote_accounts` array.
    - For each vote account, retrieves the vote account data and attempts to decode it using `fd_bincode_decode_spad`.
    - If decoding is successful, updates the vote states cache with the decoded data.
    - Queries the vote states cache for the current vote account and updates its stake information.
- **Output**: No direct output; updates the vote states cache with the processed vote account data.


---
### fd\_runtime\_fuzz\_block\_ctx\_destroy<!-- {{#callable:fd_runtime_fuzz_block_ctx_destroy}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_block_harness.c#L194>)

Clears the account database and program cache for a given runner.
- **Inputs**:
    - ``runner``: A pointer to an `fd_solfuzz_runner_t` structure, which contains the account database and program cache to be cleared.
- **Logic and Control Flow**:
    - Calls `fd_accdb_clear` to clear the account database associated with `runner->accdb_admin`.
    - Calls `fd_progcache_clear` to clear the program cache associated with `runner->progcache_admin`.
- **Output**: No return value; the function operates directly on the `runner` structure.


---
### fd\_runtime\_fuzz\_block\_ctx\_create<!-- {{#callable:fd_runtime_fuzz_block_ctx_create}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_block_harness.c#L202>)

Sets up a block execution context from a test case to execute against the runtime and returns transaction pointers on success or NULL on failure.
- **Inputs**:
    - `runner`: A pointer to `fd_solfuzz_runner_t`, which contains the runtime environment and resources needed for execution.
    - `runtime_stack`: A pointer to `fd_runtime_stack_t`, which is used to manage the runtime stack during execution.
    - `test_ctx`: A constant pointer to `fd_exec_test_block_context_t`, which provides the context and data for the test block to be executed.
    - `out_txn_cnt`: A pointer to `ulong` where the function will store the count of transactions processed.
- **Logic and Control Flow**:
    - Initialize various components from the `runner` such as `accdb`, `funk`, `bank`, and `banks`.
    - Clear the bank using `fd_banks_clear_bank`.
    - Generate a unique transaction ID (`xid`) and set up temporary transaction and slot/epoch contexts.
    - Restore feature flags from `test_ctx` and set them in the bank.
    - Set up the slot context using values from `test_ctx`.
    - Modify various bank parameters such as slot, parent slot, block height, capitalization, and fee rate governor using values from `test_ctx`.
    - Initialize vote states and stake delegations for the current epoch.
    - Load accounts with non-zero lamports from `test_ctx` and update vote accounts and stake delegations caches.
    - Reset vote stakes to avoid leakage across tests.
    - Read and set epoch schedule and rent sysvars from the bank.
    - Update vote caches for previous epochs and refresh vote accounts to calculate stake delegations.
    - Update the leader schedule using `fd_runtime_update_leaders`.
    - Initialize the blockhash queue and recent blockhashes sysvar.
    - Set the genesis hash to zero and update lamports per signature using recent blockhashes.
    - Create a new funk transaction and set the initial lthash from `test_ctx`.
    - Populate the blockhash queue and recent blockhashes sysvar with data from `test_ctx`.
    - Restore the sysvar cache.
    - Prepare raw transaction pointers and serialize transactions from `test_ctx`.
    - Check for transaction size and parsing errors, returning NULL if any issues are found.
    - Store the transaction count in `out_txn_cnt` and return the transaction pointers.
- **Output**: Returns a pointer to an array of `fd_txn_p_t` structures representing the transactions to be executed, or NULL if an error occurs during setup.
- **Functions Called**:
    - [`fd_runtime_fuzz_restore_features`](<fd_harness_common.c.md#fd_runtime_fuzz_restore_features>)
    - [`fd_runtime_fuzz_load_account`](<fd_harness_common.c.md#fd_runtime_fuzz_load_account>)
    - [`fd_runtime_fuzz_block_register_vote_account`](<#fd_runtime_fuzz_block_register_vote_account>)
    - [`fd_runtime_fuzz_block_register_stake_delegation`](<#fd_runtime_fuzz_block_register_stake_delegation>)
    - [`fd_runtime_fuzz_block_update_prev_epoch_votes_cache`](<#fd_runtime_fuzz_block_update_prev_epoch_votes_cache>)
    - [`fd_runtime_fuzz_block_refresh_vote_accounts`](<#fd_runtime_fuzz_block_refresh_vote_accounts>)
    - [`fd_runtime_fuzz_serialize_txn`](<fd_txn_harness.c.md#fd_runtime_fuzz_serialize_txn>)


---
### fd\_runtime\_fuzz\_block\_ctx\_exec<!-- {{#callable:fd_runtime_fuzz_block_ctx_exec}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_block_harness.c#L439>)

Executes a series of transactions within a runtime context, handling preparation, execution, and finalization phases.
- **Inputs**:
    - ``runner``: A pointer to an `fd_solfuzz_runner_t` structure, which manages the execution environment and resources.
    - ``runtime_stack``: A pointer to an `fd_runtime_stack_t` structure, which represents the runtime stack used during execution.
    - ``xid``: A constant pointer to an `fd_funk_txn_xid_t` structure, representing the transaction ID for the current execution context.
    - ``txn_ptrs``: A pointer to an array of `fd_txn_p_t` structures, each representing a transaction to be executed.
    - ``txn_cnt``: An unsigned long integer representing the number of transactions in the `txn_ptrs` array.
- **Logic and Control Flow**:
    - Initialize the result variable `res` to 0.
    - Begin a scoped memory allocation frame using [`FD_SPAD_FRAME_BEGIN`](<#fd_runtime_fuzz_block_update_prev_epoch_votes_cachefd_spad_frame_begin>) with `runner->spad`.
    - Check if `runner->solcap` is set; if so, allocate memory for `capture_ctx` and initialize it.
    - Recalculate partitioned rewards using `fd_rewards_recalculate_partitioned_rewards`.
    - Process new epoch conditions with `fd_runtime_block_pre_execute_process_new_epoch`, updating `is_epoch_boundary`.
    - Prepare the runtime block for execution using `fd_runtime_block_execute_prepare`; return early if it fails.
    - Iterate over each transaction in `txn_ptrs` using a for-loop.
    - For each transaction, execute it using [`fd_runtime_fuzz_txn_ctx_exec`](<fd_txn_harness.c.md#fd_runtime_fuzz_txn_ctx_exec>) and check for execution success.
    - If a transaction fails, break out of the loop.
    - Finalize each transaction using `fd_runtime_finalize_txn`.
    - Finalize the entire block execution using `fd_runtime_block_execute_finalize`.
    - End the scoped memory allocation frame with `FD_SPAD_FRAME_END`.
- **Output**: Returns an integer `res`, which indicates the success or failure of the execution process.
- **Functions Called**:
    - [`fd_runtime_fuzz_block_update_prev_epoch_votes_cache::FD_SPAD_FRAME_BEGIN`](<#fd_runtime_fuzz_block_update_prev_epoch_votes_cachefd_spad_frame_begin>)
    - [`fd_runtime_fuzz_txn_ctx_exec`](<fd_txn_harness.c.md#fd_runtime_fuzz_txn_ctx_exec>)


---
### fd\_hash\_epoch\_leaders<!-- {{#callable:fd_hash_epoch_leaders}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_block_harness.c#L513>)

Computes a hash of unique public keys and their mapped indices from a leader schedule, storing the result in a provided output buffer.
- **Inputs**:
    - `runner`: A pointer to an `fd_solfuzz_runner_t` structure, which contains the shared memory space for allocations.
    - `leaders`: A constant pointer to an `fd_epoch_leaders_t` structure, which contains the leader schedule data.
    - `seed`: An unsigned long integer used as the seed for the hash function.
    - `out`: A pointer to an array of 16 unsigned characters where the function will store the resulting hash.
- **Logic and Control Flow**:
    - Allocate a contiguous memory buffer for temporary storage of public keys and their mapped indices.
    - Iterate over the leader schedule to gather valid public keys and their original positions, skipping invalid entries.
    - If no valid leaders are found, set the output hash to zero and return zero.
    - Sort the gathered public keys by their values.
    - Remove duplicate public keys and map their indices to a new array, `sched_mapped`.
    - Reconstruct a contiguous array of unique public keys for hashing.
    - Compute a hash of the sorted unique public keys and store it in the output buffer.
    - Compute a hash of the mapped indices and store it in the output buffer after the first hash.
    - Return the count of unique public keys.
- **Output**: Returns the count of unique public keys as an unsigned long integer.


---
### fd\_runtime\_fuzz\_build\_leader\_schedule\_effects<!-- {{#callable:fd_runtime_fuzz_build_leader_schedule_effects}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_block_harness.c#L582>)

Builds the leader schedule effects for a given epoch based on the current and previous vote accounts and stake delegations.
- **Inputs**:
    - ``runner``: A pointer to `fd_solfuzz_runner_t`, which contains the runtime context and resources needed for execution.
    - ``xid``: A constant pointer to `fd_funk_txn_xid_t`, representing the transaction ID used for accessing the database.
    - ``effects``: A pointer to `fd_exec_test_block_effects_t`, where the function will store the resulting leader schedule effects.
    - ``test_ctx``: A constant pointer to `fd_exec_test_block_context_t`, providing the test context including epoch and account states.
- **Logic and Control Flow**:
    - Read the epoch schedule sysvar using `fd_sysvar_epoch_schedule_read` and verify it is not NULL.
    - Determine the parent slot and calculate the Agave epoch, slot0, and slots in the epoch using the schedule.
    - Create temporary vote states for building stake weights using `fd_vote_states_new` and `fd_vote_states_join`.
    - Select the stake source based on the Agave-consistent epoch and update the vote states cache accordingly.
    - If the Agave epoch is the same as the parent epoch, use `vote_accounts_t_1`; if one before, use `vote_accounts_t_2`; if one ahead, use current account states.
    - Build weights from the selected stake source using `fd_stake_weights_by_node`.
    - Allocate memory for the ephemeral leader schedule and create it using `fd_epoch_leaders_new` and `fd_epoch_leaders_join`.
    - Fill out the `effects` structure with the leader schedule information and hash the epoch leaders using [`fd_hash_epoch_leaders`](<#fd_hash_epoch_leaders>).
- **Output**: The function outputs the leader schedule effects in the `effects` structure, including the epoch, slot0, slot count, schedule count, and leader public key count.
- **Functions Called**:
    - [`fd_runtime_fuzz_block_update_prev_epoch_votes_cache`](<#fd_runtime_fuzz_block_update_prev_epoch_votes_cache>)
    - [`fd_runtime_fuzz_load_account`](<fd_harness_common.c.md#fd_runtime_fuzz_load_account>)
    - [`fd_runtime_fuzz_block_register_vote_account`](<#fd_runtime_fuzz_block_register_vote_account>)
    - [`fd_runtime_fuzz_block_register_stake_delegation`](<#fd_runtime_fuzz_block_register_stake_delegation>)
    - [`fd_runtime_fuzz_block_refresh_vote_accounts`](<#fd_runtime_fuzz_block_refresh_vote_accounts>)
    - [`fd_hash_epoch_leaders`](<#fd_hash_epoch_leaders>)


---
### fd\_solfuzz\_block\_run<!-- {{#callable:fd_solfuzz_block_run}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_block_harness.c#L684>)

Executes a block of transactions in a fuzzing environment and captures the execution effects.
- **Inputs**:
    - ``runner``: A pointer to an `fd_solfuzz_runner_t` structure that manages the execution environment.
    - ``input_``: A constant pointer to the input block context, cast to `void`.
    - ``output_``: A pointer to a location where the function will store the address of the output effects structure.
    - ``output_buf``: A pointer to a buffer where the function will store the execution results.
    - ``output_bufsz``: The size of the `output_buf` in bytes.
- **Logic and Control Flow**:
    - Cast `input_` to `fd_exec_test_block_context_t` and `output_` to `fd_exec_test_block_effects_t` pointers.
    - Begin a scratchpad frame using `runner->spad`.
    - Allocate memory for a runtime stack in the scratchpad.
    - Create a block execution context using [`fd_runtime_fuzz_block_ctx_create`](<#fd_runtime_fuzz_block_ctx_create>).
    - If transaction pointers are `NULL`, destroy the context and return 0.
    - Execute the block using [`fd_runtime_fuzz_block_ctx_exec`](<#fd_runtime_fuzz_block_ctx_exec>).
    - Initialize scratchpad allocation for output buffer and check for overflow.
    - Allocate memory for `fd_exec_test_block_effects_t` and initialize it to zero.
    - Capture error status, capitalization, bank hash, and cost tracker into `effects`.
    - Build leader schedule effects using [`fd_runtime_fuzz_build_leader_schedule_effects`](<#fd_runtime_fuzz_build_leader_schedule_effects>).
    - Finalize scratchpad allocation and destroy the block context.
    - Store the effects pointer in `output_` and return the size of the used output buffer.
- **Output**: Returns the number of bytes used in the `output_buf` after storing the execution effects.
- **Functions Called**:
    - [`fd_runtime_fuzz_block_update_prev_epoch_votes_cache::FD_SPAD_FRAME_BEGIN`](<#fd_runtime_fuzz_block_update_prev_epoch_votes_cachefd_spad_frame_begin>)
    - [`fd_runtime_fuzz_block_ctx_create`](<#fd_runtime_fuzz_block_ctx_create>)
    - [`fd_runtime_fuzz_block_ctx_destroy`](<#fd_runtime_fuzz_block_ctx_destroy>)
    - [`fd_runtime_fuzz_block_ctx_exec`](<#fd_runtime_fuzz_block_ctx_exec>)
    - [`fd_runtime_fuzz_build_leader_schedule_effects`](<#fd_runtime_fuzz_build_leader_schedule_effects>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)