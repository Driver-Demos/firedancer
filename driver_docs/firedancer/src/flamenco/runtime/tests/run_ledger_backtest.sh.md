<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

A Bash script to configure and run a ledger backtest, including options for downloading, extracting, and verifying ledger data.

# Purpose
This Bash script is an executable file designed to manage the download, extraction, and testing of ledger data for a specific application. It sets up various configuration parameters and environment variables, such as `DUMP_DIR`, `LEDGER`, and `OBJDIR`, to control the behavior of the script. The script includes functions to download ledger data from a cloud storage service, verify its integrity, and configure the environment for running a backtest using the `firedancer-dev` tool. It generates a configuration file in TOML format based on the provided options and executes the backtest, logging the results and handling any errors that occur during the process. The script is intended for use in a continuous integration environment, as indicated by the conditional logic for the `CI` variable.
# Imports and Dependencies

---
- `contrib/test/ledger_common.sh`
- `gcloud`
- `zstd`
- `tee`
- `tar`
- `sed`


# Global Variables

---
### POSITION\_ARGS
- **Type**: `array`
- **Description**: An empty array that stores positional arguments passed to the script that do not match any predefined options. These arguments are collected and stored for later use in the script.
- **Use**: Collects and stores non-option command-line arguments for processing.


---
### OBJDIR
- **Type**: `string`
- **Description**: Defines the directory path where the build artifacts are stored. The variable uses a default value of 'build/native/gcc' if not already set in the environment.
- **Use**: Used to specify the location for storing build outputs and related files.


---
### LEDGER
- **Type**: ``string``
- **Description**: Represents the path or identifier for a ledger used in the script. The variable is initially set to an empty string and can be modified by command-line arguments.
- **Use**: Used to specify the ledger for operations such as downloading, extracting, and running backtests.


---
### RESTORE\_ARCHIVE
- **Type**: ``string``
- **Description**: Stores the path to the archive that needs to be restored. It is constructed by appending a given archive name to the `LEDGER` path.
- **Use**: Used to specify the archive path for restoration operations.


---
### END\_SLOT
- **Type**: `string`
- **Description**: The `END_SLOT` variable is a global variable that holds a string value representing a slot number, initialized to "1010". It is used in the configuration of the archiver tile to specify the end slot for processing.
- **Use**: Used to define the end slot for the archiver tile in the configuration settings.


---
### FUNK\_PAGES
- **Type**: ``string``
- **Description**: Defines the size of the heap in gibibytes for the 'funk' section of the configuration. It is used to set the `heap_size_gib` parameter in the configuration file.
- **Use**: Sets the heap size for the 'funk' section in the configuration file.


---
### INDEX\_MAX
- **Type**: `string`
- **Description**: The `INDEX_MAX` variable is a global variable defined in the script with a default value of "5000000". It represents the maximum number of account records that can be stored in the system.
- **Use**: Used to set the `max_account_records` parameter in the configuration for the `firedancer-dev` backtest.


---
### TRASH\_HASH
- **Type**: `string`
- **Description**: The `TRASH_HASH` variable is a string that is initialized as an empty string. It is used to store a command-line option for trash hash functionality, which can be set by the `-t` or `--trash` command-line argument.
- **Use**: Stores the command-line option for trash hash functionality when specified by the user.


---
### LOG
- **Type**: `string`
- **Description**: Stores the path to a temporary log file for ledger operations. The path includes the process ID to ensure uniqueness.
- **Use**: Used to specify the location where log data for ledger operations is written.


---
### TILE\_CPUS
- **Type**: `string`
- **Description**: Specifies a range of CPU cores to use for tiling operations. The value is a string that includes the option `--tile-cpus` followed by a range of CPU core numbers, in this case, `5-15`. This indicates that CPU cores 5 through 15 are designated for tiling tasks.
- **Use**: Used to define the CPU core range for tiling operations in the script.


---
### THREAD\_MEM\_BOUND
- **Type**: `string`
- **Description**: Specifies a command-line option for setting a memory bound for threads. The value is a string that includes the option flag `--thread-mem-bound` followed by a numeric value, which in this case is `0`. This indicates that there is no memory bound set for threads.
- **Use**: Used to configure the memory bound for threads in a command-line execution context.


---
### INGEST\_MODE
- **Type**: ``string``
- **Description**: Specifies the mode of data ingestion used by the system. The default value is set to 'rocksdb', indicating that the system uses RocksDB for data ingestion.
- **Use**: Used to configure the data ingestion method in the system's configuration.


---
### CLUSTER\_VERSION
- **Type**: `string`
- **Description**: Stores the version of the cluster used in the replay process. It is set via the `-c` or `--cluster-version` command-line option.
- **Use**: Used to specify the cluster version in the configuration for the replay process.


---
### DUMP\_DIR
- **Type**: `string`
- **Description**: Specifies the directory path where dump files are stored. The default value is './dump', but it can be overridden by setting the 'DUMP_DIR' environment variable or using the '-d' or '--dump-dir' command-line option.
- **Use**: Used to determine the location for storing dump files and generating configuration files for backtesting.


---
### ONE\_OFFS
- **Type**: ``string``
- **Description**: A global variable that stores a string value. It is initialized as an empty string and can be set via the `-o` or `--one-offs` command-line option.
- **Use**: Used to store and pass specific one-off configuration options to the script, which are formatted and included in the configuration file for the replay process.


---
### HUGE\_TLBFS\_MOUNT\_PATH
- **Type**: `string`
- **Description**: Specifies the file system path where the HugeTLBFS (Huge Translation Lookaside Buffer File System) is mounted. This variable is used to configure the location for huge pages, which are memory pages larger than the default size, to improve performance in certain applications.
- **Use**: Used to set the mount path for HugeTLBFS in the configuration file for the backtest process.


---
### HUGE\_TLBFS\_ALLOW\_HUGEPAGE\_INCREASE
- **Type**: `string`
- **Description**: Indicates if the system allows an increase in the number of huge pages in the HugeTLBFS (Huge Translation Lookaside Buffer Filesystem). The variable is set to 'true' by default, which means the system permits such an increase.
- **Use**: Used to configure the HugeTLBFS settings in the generated TOML configuration file.


---
### HAS\_INCREMENTAL
- **Type**: ``string``
- **Description**: Indicates if incremental snapshots are enabled. The default value is set to 'false', meaning incremental snapshots are not enabled by default.
- **Use**: Used to configure the `incremental_snapshots` setting in the configuration file for ledger processing.


---
### REDOWNLOAD
- **Type**: `integer`
- **Description**: The `REDOWNLOAD` variable is an integer that indicates whether the system should redownload resources. It is set to 1 by default, meaning redownload is enabled.
- **Use**: Used to control the redownload behavior of resources, with a value of 1 enabling redownload and 0 disabling it.


---
### SKIP\_CHECKSUM
- **Type**: `integer`
- **Description**: This variable is an integer that determines whether the checksum verification step should be skipped during the ledger processing. A value of `1` means the checksum step is skipped, while a value of `0` means the checksum step is performed.
- **Use**: Used to control whether checksum verification is executed in the ledger processing script.


---
### DEBUG
- **Type**: `array`
- **Description**: The `DEBUG` variable is an array that is initially empty. It is used to store debugging commands when the `--debug` option is specified.
- **Use**: Stores debugging commands to execute the `firedancer-dev` binary with debugging options.


---
### WATCH
- **Type**: `array`
- **Description**: The `WATCH` variable is an array that is initially empty. It is used to store command-line options related to watching functionality.
- **Use**: The `WATCH` variable is used to pass options to the `firedancer-dev` command, specifically to disable watching when the `CI` environment variable is set.


---
### LOG\_LEVEL\_STDERR
- **Type**: `string`
- **Description**: Defines the logging level for standard error output. The default value is set to `NOTICE`, but it changes to `INFO` when the `CI` environment variable is set.
- **Use**: Controls the verbosity of log messages sent to standard error.


---
### FORMATTED\_ONE\_OFFS
- **Type**: `string`
- **Description**: The `FORMATTED_ONE_OFFS` variable is a string that contains a formatted version of the `ONE_OFFS` variable. It uses the `sed` command to wrap each comma-separated item in `ONE_OFFS` with double quotes.
- **Use**: Used to format the `ONE_OFFS` variable for inclusion in configuration settings.


---
### LLVM\_PROFILE\_FILE
- **Type**: `string`
- **Description**: Specifies the file path for storing LLVM profiling data. The path is constructed using the `OBJDIR` variable and includes the ledger name as part of the file name.
- **Use**: Used to define the location where LLVM profiling data is saved during the execution of the script.


---
### DUMP
- **Type**: `string`
- **Description**: `DUMP` is a global variable that stores the absolute path to the directory specified by `DUMP_DIR`. It is initialized using the `realpath` command to ensure the path is absolute.
- **Use**: Used to define the location where ledger data and related files are stored and managed.


# Functions

---
### download\_and\_extract\_ledger
Downloads and extracts a ledger archive from a Google Cloud Storage bucket if it does not already exist locally.
- **Inputs**:
    - `None`: The function does not take any direct input arguments, but it uses several environment variables and script variables such as `DUMP`, `LEDGER`, and `ZST`.
- **Logic and Control Flow**:
    - Checks if the ledger directory does not exist and `SKIP_INGEST` is 0.
    - If a pending download exists, it removes the incomplete download directory.
    - Determines the file extension (`.zst` or `.gz`) based on the presence of the `ZST` variable.
    - Checks if the Google Cloud authentication is set up; if not, it attempts to activate service accounts using key files.
    - Creates a pending directory for the ledger download.
    - Downloads the ledger archive from the Google Cloud Storage bucket using `gcloud storage cat` and extracts it using `tar`.
    - If the download and extraction succeed, it moves the pending directory to the final ledger directory.
    - If the download fails, it cleans up the pending directory and exits with an error.
- **Output**: The function does not return a value but creates a directory with the extracted ledger files if successful.



---
Made with ❤️ by [Driver](https://www.driver.ai/)