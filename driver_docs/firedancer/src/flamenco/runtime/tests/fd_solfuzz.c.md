<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Support routines for creating, managing, and deleting demand-paged workspaces and solfuzz runners.

# Purpose
The code in `fd_solfuzz.c` provides support routines for managing memory workspaces and running a fuzz testing framework. It defines functions to create and delete demand-paged workspaces and to manage a `fd_solfuzz_runner_t` structure, which is used to execute fuzz tests. The [`fd_wksp_demand_paged_new`](<#fd_wksp_demand_paged_new>) function initializes a new workspace with demand-paged memory, aligning the memory footprint to the nearest huge page size and using transparent huge pages for efficient memory management. It also registers the shared memory region for use. The [`fd_wksp_demand_paged_delete`](<#fd_wksp_demand_paged_delete>) function cleans up by unregistering and freeing the allocated memory.

The [`fd_solfuzz_runner_new`](<#fd_solfuzz_runner_new>) function sets up a new fuzz test runner by allocating and initializing various components such as transaction memory, program cache, scratch space, and shared memory banks. It ensures that all necessary resources are allocated and initialized correctly, logging warnings if any step fails. The [`fd_solfuzz_runner_delete`](<#fd_solfuzz_runner_delete>) function handles the cleanup of these resources, ensuring that all allocated memory is freed and any shared resources are properly released. Additionally, the [`fd_solfuzz_runner_leak_check`](<#fd_solfuzz_runner_leak_check>) function checks for memory leaks in the fuzz test runner, specifically looking for unfreed frames in the scratchpad and unfinished transactions in the funk transaction index.
# Imports and Dependencies

---
- `fd_solfuzz.h`
- `../fd_bank.h`
- `../fd_runtime.h`
- `errno.h`
- `sys/mman.h`
- `../../../util/shmem/fd_shmem_private.h`


# Functions

---
### fd\_wksp\_demand\_paged\_new<!-- {{#callable:fd_wksp_demand_paged_new}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_solfuzz.c#L11>)

Creates a new demand-paged workspace with specified parameters and registers it as a shared memory region.
- **Inputs**:
    - ``name``: A constant character pointer representing the name of the workspace.
    - ``seed``: An unsigned integer used as a seed for workspace creation.
    - ``part_max``: An unsigned long integer specifying the maximum number of partitions.
    - ``data_max``: An unsigned long integer specifying the maximum data size.
- **Logic and Control Flow**:
    - Calculate the memory footprint using `fd_wksp_footprint` with `part_max` and `data_max` as inputs.
    - Check if the calculated footprint is valid; if not, log a warning and return `NULL`.
    - Align the footprint to the nearest huge page size using `fd_ulong_align_up`.
    - Acquire anonymous demand-paged memory using `fd_shmem_private_map_rand` with the aligned footprint and huge page size.
    - If memory mapping fails, log a warning and return `NULL`.
    - Advise the kernel to use huge pages as a backing store with `madvise`; if it fails, log a warning, unmap the memory, and return `NULL`.
    - Create a new workspace using `fd_wksp_new` and join it with `fd_wksp_join`; if it fails, log a warning, unmap the memory, and return `NULL`.
    - Calculate the number of fake pages by shifting the footprint by `FD_SHMEM_HUGE_LG_PAGE_SZ`.
    - Register the shared memory region using `fd_shmem_join_anonymous`; if it fails, log a warning, delete the workspace, unmap the memory, and return `NULL`.
    - Return the created workspace.
- **Output**: A pointer to the newly created `fd_wksp_t` workspace, or `NULL` if an error occurs.


---
### fd\_wksp\_demand\_paged\_delete<!-- {{#callable:fd_wksp_demand_paged_delete}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_solfuzz.c#L68>)

Deletes a demand-paged workspace by leaving and deleting shared memory.
- **Inputs**:
    - ``wksp``: A pointer to the `fd_wksp_t` workspace to delete.
- **Logic and Control Flow**:
    - Calls `fd_shmem_leave_anonymous` to leave the anonymous shared memory associated with the workspace.
    - Calls `fd_wksp_leave` to leave the workspace and then `fd_wksp_delete` to delete it.
    - Uses `FD_TEST` to ensure that the deletion of the workspace is successful.
- **Output**: No return value; the function performs cleanup operations on the provided workspace.


---
### fd\_solfuzz\_runner\_new<!-- {{#callable:fd_solfuzz_runner_new}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_solfuzz.c#L74>)

Initializes a new `fd_solfuzz_runner_t` object by allocating and setting up necessary memory and components.
- **Inputs**:
    - `wksp`: A pointer to a `fd_wksp_t` workspace where memory allocations will occur.
    - `wksp_tag`: An unsigned long integer used as a tag for memory allocations.
    - `options`: A pointer to a `fd_solfuzz_runner_options_t` structure containing configuration options for the runner.
- **Logic and Control Flow**:
    - Allocate memory for the runner and related components using `fd_wksp_alloc_laddr` with specified alignments and footprints.
    - Check if any memory allocation fails and log a warning message, then jump to cleanup if necessary.
    - Initialize the `runner` object and set its workspace pointer.
    - Create shared memory objects `shfunk` and `shpcache` using `fd_funk_new` and check for failures.
    - Join various components to the runner, such as `accdb_admin`, `accdb`, `progcache`, and `progcache_admin`, and check for failures.
    - Initialize and join `spad` and `banks` components, and initialize a bank within `banks`, checking for failures.
    - Set the `enable_vm_tracing` option from the provided `options` structure.
    - Return the initialized `runner` object if successful.
    - If any step fails, perform cleanup by freeing allocated memory and logging a failure message, then return `NULL`.
- **Output**: A pointer to the newly created `fd_solfuzz_runner_t` object, or `NULL` if initialization fails.


---
### fd\_solfuzz\_runner\_delete<!-- {{#callable:fd_solfuzz_runner_delete}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_solfuzz.c#L143>)

Releases resources associated with a `fd_solfuzz_runner_t` instance and its components.
- **Inputs**:
    - `runner`: A pointer to the `fd_solfuzz_runner_t` instance to delete.
- **Logic and Control Flow**:
    - Call `fd_accdb_user_leave` to leave the user account database associated with `runner->accdb`.
    - Initialize `shfunk` to `NULL` and call `fd_accdb_admin_leave` to leave the admin account database, storing any returned shared function pointer in `shfunk`.
    - If `shfunk` is not `NULL`, call `fd_funk_delete` to delete the shared function and `fd_wksp_free_laddr` to free its address.
    - Call `fd_progcache_leave` to leave the program cache associated with `runner->progcache`.
    - Initialize `shpcache` to `NULL` and call `fd_progcache_admin_leave` to leave the admin program cache, storing any returned shared program cache pointer in `shpcache`.
    - If `shpcache` is not `NULL`, call `fd_funk_delete` to delete the shared program cache and `fd_wksp_free_laddr` to free its address.
    - If `runner->spad` is not `NULL`, call `fd_spad_leave` to leave the scratchpad, `fd_spad_delete` to delete it, and `fd_wksp_free_laddr` to free its address.
    - If `runner->banks` is not `NULL`, call `fd_banks_leave` to leave the banks, `fd_banks_delete` to delete them, and `fd_wksp_free_laddr` to free their address.
    - Finally, call `fd_wksp_free_laddr` to free the address of `runner`.
- **Output**: No return value; the function performs cleanup operations.


---
### fd\_solfuzz\_runner\_leak\_check<!-- {{#callable:fd_solfuzz_runner_leak_check}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_solfuzz.c#L161>)

Checks for memory leaks in the `fd_solfuzz_runner_t` structure.
- **Inputs**:
    - `runner`: A pointer to an `fd_solfuzz_runner_t` structure that contains the resources to check for leaks.
- **Logic and Control Flow**:
    - Check if the `spad` frame in the `runner` is used by calling `fd_spad_frame_used`.
    - If the `spad` frame is used, log a critical error message indicating a leaked spad frame.
    - Check if the transaction index in the `runner`'s `accdb` is not null by calling `fd_funk_txn_idx_is_null`.
    - If the transaction index is not null, log a critical error message indicating a leaked funk transaction.
- **Output**: No return value; logs critical errors if leaks are detected.



---
Made with ❤️ by [Driver](https://www.driver.ai/)