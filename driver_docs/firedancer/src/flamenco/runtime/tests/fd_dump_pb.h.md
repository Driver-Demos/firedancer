<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

APIs for dumping syscalls, instructions, transactions, and blocks into Protobuf messages for debugging.

# Purpose
The `fd_dump_pb.h` file defines APIs for converting various components such as syscalls, instructions, transactions, and blocks into Protobuf messages. These messages are digestible and replayable, which is useful for debugging ledger test mismatches, collecting seed corpora, and testing new harnesses with real data. The file provides a set of command-line arguments that can be used to specify the output directory and filters for dumping specific instructions, transactions, blocks, syscalls, and ELF files. The file also includes references to other header files necessary for its functionality, such as `fd_instr_info.h`, `fd_vm.h`, and several generated Protobuf headers.

The file defines a structure `fd_block_dump_ctx_t` that maintains the state for block dumping, including dynamic memory allocations and transaction descriptors. It provides functions to manage this context, such as creating, joining, deleting, and resetting the context. Additionally, the file includes functions to dump instructions, transactions, blocks, syscalls, and ELF files into Protobuf format. The block dumping process is divided into two stages: collecting transaction descriptors and finalizing the block by converting these descriptors into Protobuf messages. This file is intended to be included in other C files and does not define a standalone executable.
# Imports and Dependencies

---
- `../info/fd_instr_info.h`
- `../../vm/fd_vm.h`
- `generated/block.pb.h`
- `generated/elf.pb.h`
- `../../../disco/fd_txn_p.h`


# Data Structures

---
### fd\_block\_dump\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``block_context``: Holds the block context message.
    - ``txns_to_dump``: Array of transactions to be dumped.
    - ``txns_to_dump_cnt``: Count of transactions to be dumped.
    - ``spad``: Pointer to a spad for dynamic memory allocations.
- **Description**: Maintains the state for block dumping, including dynamic memory allocations and the block context message. It stores transactions to be dumped and uses a spad for memory management.


# Functions

---
### fd\_block\_dump\_context\_align<!-- {{#callable:fd_block_dump_context_align}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.h#L85>)

Returns the alignment requirement of the `fd_block_dump_ctx_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `alignof` to determine the alignment requirement of the `fd_block_dump_ctx_t` structure.
    - Returns the alignment value obtained from `alignof`.
- **Output**: An `ulong` representing the alignment requirement of the `fd_block_dump_ctx_t` structure.


---
### fd\_block\_dump\_context\_footprint<!-- {{#callable:fd_block_dump_context_footprint}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.h#L90>)

Calculates the memory footprint required for a block dump context, including its alignment and spad memory.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize `l` with `FD_LAYOUT_INIT`.
    - Append the alignment and size of `fd_block_dump_ctx_t` to `l` using `FD_LAYOUT_APPEND`.
    - Append the alignment and footprint of the spad memory to `l` using `FD_LAYOUT_APPEND`, with the maximum spad memory size defined by `FD_BLOCK_DUMP_CTX_SPAD_MEM_MAX`.
    - Finalize the layout with `FD_LAYOUT_FINI` using the spad alignment.
    - Return the calculated footprint `l`.
- **Output**: Returns the calculated memory footprint as an `ulong` value.


---
### fd\_block\_dump\_context\_new<!-- {{#callable:fd_block_dump_context_new}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.h#L99>)

Allocates and initializes a new block dump context using the provided memory.
- **Inputs**:
    - `mem`: A pointer to the memory where the block dump context will be allocated and initialized.
- **Logic and Control Flow**:
    - Initialize a scratch allocator `l` with the provided `mem`.
    - Allocate memory for a `fd_block_dump_ctx_t` structure using the scratch allocator and assign it to `ctx`.
    - Allocate memory for a `fd_spad_t` structure using the scratch allocator and assign it to `spad`.
    - Initialize the `spad` field of `ctx` by calling `fd_spad_new` with the allocated `spad` and `FD_BLOCK_DUMP_CTX_SPAD_MEM_MAX`.
    - Set the `txns_to_dump_cnt` field of `ctx` to 0.
    - Return the pointer to the initialized `fd_block_dump_ctx_t` structure `ctx`.
- **Output**: A pointer to the newly allocated and initialized `fd_block_dump_ctx_t` structure.


---
### fd\_block\_dump\_context\_join<!-- {{#callable:fd_block_dump_context_join}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.h#L110>)

Validates and joins a memory block to a block dump context if it is non-null and properly aligned.
- **Inputs**:
    - `mem`: A pointer to the memory block intended to be joined to the block dump context.
- **Logic and Control Flow**:
    - Check if `mem` is NULL; if true, log an error and return NULL.
    - Check if `mem` is aligned according to [`fd_block_dump_context_align`](<#fd_block_dump_context_align>); if not, log an error and return NULL.
    - Cast `mem` to a `fd_block_dump_ctx_t` pointer and assign it to `ctx`.
    - Join the `spad` field of `ctx` using `fd_spad_join`.
    - Return the `ctx` pointer.
- **Output**: Returns a pointer to the `fd_block_dump_ctx_t` structure if successful, or NULL if the input is invalid.
- **Functions Called**:
    - [`fd_block_dump_context_align`](<#fd_block_dump_context_align>)


---
### fd\_block\_dump\_context\_delete<!-- {{#callable:fd_block_dump_context_delete}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.h#L127>)

Checks if the input memory pointer is NULL and returns it.
- **Inputs**:
    - `mem`: A pointer to memory that the function will check for NULL.
- **Logic and Control Flow**:
    - Check if `mem` is NULL using `FD_UNLIKELY` macro.
    - If `mem` is NULL, log a warning message 'NULL mem' using `FD_LOG_WARNING`.
    - Return NULL if `mem` is NULL.
    - Return the `mem` pointer if it is not NULL.
- **Output**: Returns the input memory pointer `mem`, or NULL if `mem` is NULL.


---
### fd\_block\_dump\_context\_leave<!-- {{#callable:fd_block_dump_context_leave}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.h#L136>)

Returns the input context pointer if it is not NULL, otherwise logs a warning and returns NULL.
- **Inputs**:
    - `ctx`: A pointer to an `fd_block_dump_ctx_t` structure, representing the block dump context to leave.
- **Logic and Control Flow**:
    - Check if `ctx` is NULL using `FD_UNLIKELY`.
    - If `ctx` is NULL, log a warning message 'NULL ctx' using `FD_LOG_WARNING` and return NULL.
    - If `ctx` is not NULL, cast `ctx` to a `void *` and return it.
- **Output**: A `void *` pointer to the input context if it is not NULL, otherwise NULL.


---
### fd\_block\_dump\_context\_reset<!-- {{#callable:fd_block_dump_context_reset}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.h#L146>)

Resets the block dump context to prepare for the next block by clearing the block context, resetting the spad, and setting the transaction count to zero.
- **Inputs**:
    - `ctx`: A pointer to an `fd_block_dump_ctx_t` structure that holds the block dump context to reset.
- **Logic and Control Flow**:
    - Call `fd_memset` to set the memory of `ctx->block_context` to zero, effectively clearing the block context.
    - Call `fd_spad_reset` to reset the spad associated with the context, clearing any dynamic memory allocations.
    - Set `ctx->txns_to_dump_cnt` to zero, indicating no transactions are queued for dumping.
- **Output**: No return value; the function modifies the provided context in place.


# Function Declarations (Public API)

---
### fd\_dump\_instr\_to\_protobuf<!-- {{#callable_declaration:fd_dump_instr_to_protobuf}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.h#L155>)

Dumps an instruction to a Protobuf message file.
- **Description**: Use this function to serialize an instruction into a Protobuf message and save it to a file. This is useful for debugging and testing purposes. The function requires a transaction context, an instruction, and an instruction index. It checks if a signature filter is set and only proceeds if the instruction's signature matches the filter. The output file is saved in a specified directory with a name format that includes the base58-encoded signature and the instruction index.
- **Inputs**:
    - `txn_ctx`: A pointer to a `fd_exec_txn_ctx_t` structure representing the transaction context. Must not be null.
    - `instr`: A pointer to a `fd_instr_info_t` structure representing the instruction to dump. Must not be null.
    - `instruction_idx`: An unsigned short representing the index of the instruction. Used in the output file name.
- **Output**: None
- **See Also**: [`fd_dump_instr_to_protobuf`](<fd_dump_pb.c.md#fd_dump_instr_to_protobuf>)  (Implementation)


---
### fd\_dump\_txn\_to\_protobuf<!-- {{#callable_declaration:fd_dump_txn_to_protobuf}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.h#L160>)

Dumps a transaction context to a Protobuf message.
- **Description**: Use this function to serialize a transaction context into a Protobuf message and write it to a file. This is useful for debugging and testing purposes. The function checks if a signature filter is set and only proceeds if the transaction's signature matches the filter. Ensure that the `txn_ctx` and `spad` are properly initialized before calling this function. The output directory must be specified in the transaction context's capture context.
- **Inputs**:
    - `txn_ctx`: A pointer to a `fd_exec_txn_ctx_t` structure representing the transaction context. Must not be null and must be properly initialized.
    - `spad`: A pointer to a `fd_spad_t` structure used for dynamic memory allocation during the operation. Must not be null and must be properly initialized.
- **Output**: None
- **See Also**: [`fd_dump_txn_to_protobuf`](<fd_dump_pb.c.md#fd_dump_txn_to_protobuf>)  (Implementation)


---
### fd\_dump\_block\_to\_protobuf\_collect\_tx<!-- {{#callable_declaration:fd_dump_block_to_protobuf_collect_tx}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.h#L191>)

Adds a transaction to the block dump context for later Protobuf conversion.
- **Description**: Use this function to add a transaction to the block dump context, which will later be converted into a Protobuf message during block finalization. Ensure that the number of transactions does not exceed the maximum allowed (`FD_BLOCK_DUMP_CTX_MAX_TXN_CNT`). If the limit is reached, the function logs an error and does not add the transaction. This function is typically used during transaction execution in a replay tile.
- **Inputs**:
    - `dump_ctx`: A pointer to an `fd_block_dump_ctx_t` structure that maintains the state of the block dump. Must not be null and should be properly initialized before use.
    - `txn`: A pointer to a constant `fd_txn_p_t` structure representing the transaction to add. Must not be null.
- **Output**: None
- **See Also**: [`fd_dump_block_to_protobuf_collect_tx`](<fd_dump_pb.c.md#fd_dump_block_to_protobuf_collect_tx>)  (Implementation)


---
### fd\_dump\_block\_to\_protobuf<!-- {{#callable_declaration:fd_dump_block_to_protobuf}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.h#L195>)

Dumps block data into a Protobuf message.
- **Description**: Use this function to serialize block data into a Protobuf message for debugging or data collection purposes. Ensure that both `dump_ctx` and `capture_ctx` are not null before calling this function. The function writes the serialized data to a file in the directory specified by `capture_ctx`. It is important to call this function after all transactions for the block have been collected and before resetting the block dump context.
- **Inputs**:
    - `dump_ctx`: A pointer to a `fd_block_dump_ctx_t` structure that maintains the state for block dumping. Must not be null.
    - `banks`: A pointer to an `fd_banks_t` structure representing the banks involved in the block. The function does not modify this parameter.
    - `bank`: A pointer to an `fd_bank_t` structure representing the specific bank for the block. The function does not modify this parameter.
    - `funk`: A pointer to an `fd_funk_t` structure representing the funk context. The function does not modify this parameter.
    - `capture_ctx`: A constant pointer to an `fd_capture_ctx_t` structure that specifies the output directory for the Protobuf message. Must not be null.
- **Output**: None
- **See Also**: [`fd_dump_block_to_protobuf`](<fd_dump_pb.c.md#fd_dump_block_to_protobuf>)  (Implementation)


---
### fd\_dump\_vm\_syscall\_to\_protobuf<!-- {{#callable_declaration:fd_dump_vm_syscall_to_protobuf}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.h#L202>)

Dumps a VM syscall context to a Protobuf file.
- **Description**: Use this function to serialize and store the context of a virtual machine (VM) syscall into a Protobuf file. This is useful for debugging and replaying syscalls. The function generates a unique filename based on the syscall details and writes the serialized context to this file. If a file with the generated name already exists, the function returns without writing. Ensure that the VM context is correctly initialized before calling this function.
- **Inputs**:
    - `vm`: A pointer to a constant `fd_vm_t` structure representing the virtual machine context. Must not be null. The function reads various fields from this structure to construct the syscall context.
    - `fn_name`: A pointer to a constant character string representing the name of the function being called in the syscall. Must not be null. The function uses this name to generate the output filename.
- **Output**: None
- **See Also**: [`fd_dump_vm_syscall_to_protobuf`](<fd_dump_pb.c.md#fd_dump_vm_syscall_to_protobuf>)  (Implementation)


---
### fd\_dump\_elf\_to\_protobuf<!-- {{#callable_declaration:fd_dump_elf_to_protobuf}} -->
[View Source →](<../../../../../../src/flamenco/runtime/tests/fd_dump_pb.h#L206>)

Dumps ELF data to a Protobuf file.
- **Description**: Use this function to serialize ELF data associated with a transaction context and a program account into a Protobuf message, which is then saved to a file. This function is useful for debugging and testing purposes, especially when you need to capture and replay transaction data. Ensure that the transaction context and program account are valid and initialized before calling this function. The function will not overwrite existing files with the same name, and it will silently return if the file already exists.
- **Inputs**:
    - `txn_ctx`: A pointer to a `fd_exec_txn_ctx_t` structure representing the transaction context. Must be valid and properly initialized. The caller retains ownership.
    - `program_acc`: A pointer to a `fd_txn_account_t` structure representing the program account. Must be valid and properly initialized. The caller retains ownership.
- **Output**: None
- **See Also**: [`fd_dump_elf_to_protobuf`](<fd_dump_pb.c.md#fd_dump_elf_to_protobuf>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)