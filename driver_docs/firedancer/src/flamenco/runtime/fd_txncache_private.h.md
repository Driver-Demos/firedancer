<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines data structures and constants for managing transaction caches in a concurrent environment.

# Purpose
The code is a C header file that defines private structures and constants for managing a transaction cache in a concurrent environment. It is part of a larger system, likely related to blockchain or distributed ledger technology, given the use of terms like "transaction", "blockhash", and "fork". The file includes several data structures, such as `fd_txncache_single_txn`, `fd_txncache_txnpage`, and `fd_txncache_blockcache_shmem`, which are used to store and manage transactions and their associated metadata. These structures facilitate the organization of transactions into pages and blocks, allowing efficient access and modification.

The header file also defines several macros and includes templates for implementing pools, maps, and lists, which are used to manage collections of transaction-related data. The use of read-write locks (`fd_rwlock_t`) indicates that the transaction cache is designed to be accessed by multiple threads concurrently, with specific operations requiring write locks to ensure data integrity. The file defines constants such as `FD_TXNCACHE_TXNS_PER_PAGE` and `FD_TXNCACHE_MAX_BLOCKHASH_DISTANCE`, which configure the behavior and constraints of the transaction cache. Additionally, the file provides function prototypes for calculating the maximum number of transaction pages per blockhash and the overall maximum number of transaction pages, which are essential for managing the cache's capacity and performance.
# Imports and Dependencies

---
- `fd_txncache_shmem.h`
- `../types/fd_types_custom.h`
- `../fd_rwlock.h`
- `../../util/tmpl/fd_pool.c`
- `../../util/tmpl/fd_map_chain.c`
- `../../util/tmpl/fd_slist.c`
- `../../util/tmpl/fd_set_dynamic.c`


# Data Structures

---
### fd\_txncache\_single\_txn
- **Type**: ``struct``
- **Members**:
    - `blockcache_next`: Pointer to the next element in the blockcache hash chain containing this entry from the pool.
    - `fork_id`: Fork that the transaction was executed on, allowing multiple entries for transactions executed on multiple forks.
    - `txnhash`: The transaction message hash, truncated to 20 bytes, starting at an arbitrary offset given by the `txnhash_offset` value of the containing blockcache entry.
- **Description**: Represents a single transaction entry in a transaction cache, including a pointer to the next transaction in a blockcache chain, the fork identifier where the transaction was executed, and a truncated transaction hash for efficient storage and retrieval.


---
### fd\_txncache\_single\_txn\_t
- **Type**: ``struct``
- **Members**:
    - ``blockcache_next``: Pointer to the next element in the blockcache hash chain containing this entry from the pool.
    - ``fork_id``: Fork that the transaction was executed on, allowing multiple entries for transactions executed on multiple forks.
    - ``txnhash``: The transaction message hash, truncated to 20 bytes, starting at an arbitrary offset given by the `txnhash_offset` value of the containing blockcache entry.
- **Description**: Represents a single transaction entry in a transaction cache, including metadata such as the fork it was executed on and a truncated hash of the transaction message.


---
### fd\_txncache\_txnpage
- **Type**: ``struct``
- **Members**:
    - `free`: The number of free transaction entries in this page.
    - `txns`: The transactions in the page, stored as an array of `fd_txncache_single_txn_t`.
- **Description**: Represents a page in a transaction cache, containing a fixed number of transaction entries and tracking how many of those entries are free.


---
### fd\_txncache\_txnpage\_t
- **Type**: ``struct``
- **Members**:
    - ``free``: The number of free transaction entries in this page.
    - ``txns``: The transactions in the page, with a fixed size defined by `FD_TXNCACHE_TXNS_PER_PAGE`.
- **Description**: Represents a page of transactions in a transaction cache, where each page can hold a fixed number of transactions (`FD_TXNCACHE_TXNS_PER_PAGE`). The `free` member indicates how many transaction entries are available in the page, while the `txns` array stores the actual transactions.


---
### fd\_txncache\_blockcache\_shmem
- **Type**: ``struct``
- **Members**:
    - `parent_id`: Stores the fork ID of the parent.
    - `child_id`: Stores the fork ID of the child.
    - `sibling_id`: Stores the fork ID of the sibling.
    - `frozen`: Indicates if the blockcache is frozen and should not be modified.
    - `blockhash`: Stores the blockhash for this entry.
    - `txnhash_offset`: Stores the offset used for truncating transaction hashes to 20 bytes.
    - `pages_cnt`: Indicates the number of transaction pages currently in use.
    - `pool`: Contains a `next` field for managing the pool of blockcache entries.
    - `slist`: Contains a `next` field for managing a singly linked list of blockcache entries.
    - `blockhash_map`: Contains `next` and `prev` fields for managing a map of blockhashes.
    - `fork_map`: Contains `next` and `prev` fields for managing a map of forks.
- **Description**: Manages blockcache entries in a transaction cache system, including fork relationships, blockhash information, and transaction page management. It uses various fields to track the state and relationships of blockcache entries, such as parent, child, and sibling fork IDs, and includes mechanisms for handling transaction hash offsets and page counts. The structure also supports linked list and map operations for efficient management of blockcache entries.


---
### fd\_txncache\_blockcache\_shmem\_t
- **Type**: ``struct``
- **Members**:
    - `parent_id`: Stores the fork ID of the parent fork.
    - `child_id`: Stores the fork ID of the child fork.
    - `sibling_id`: Stores the fork ID of the sibling fork.
    - `frozen`: Indicates if the blockcache is frozen and should not be modified.
    - `blockhash`: Stores the blockhash for this entry.
    - `txnhash_offset`: Specifies the offset for truncating transaction hashes to 20 bytes.
    - `pages_cnt`: Indicates the number of transaction pages currently in use.
    - `pool`: Contains a `next` field for managing the pool of blockcache entries.
    - `slist`: Contains a `next` field for managing a singly linked list of blockcache entries.
    - `blockhash_map`: Contains `next` and `prev` fields for managing a blockhash map.
    - `fork_map`: Contains `next` and `prev` fields for managing a fork map.
- **Description**: Represents a shared memory structure for managing transaction blockcache entries, including fork relationships, blockhash information, and transaction page management. It includes fields for managing the state of the blockcache, such as whether it is frozen, and for handling the organization of blockcache entries in various data structures like pools, singly linked lists, and maps.


---
### fd\_txncache\_shmem\_private
- **Type**: ``struct``
- **Members**:
    - ``lock``: An array of read-write locks aligned to 128 bytes to prevent false sharing.
    - ``txn_per_slot_max``: The maximum number of transactions allowed per slot.
    - ``active_slots_max``: The maximum number of active slots.
    - ``txnpages_per_blockhash_max``: The maximum number of transaction pages per blockhash.
    - ``max_txnpages``: The maximum number of transaction pages.
    - ``txnpages_free_cnt``: The count of transaction pages that are not in use.
    - ``root_cnt``: The count of root forks in the singly linked list.
    - ``root_ll``: A singly linked list of root forks, with the tail as the most recent and the head as the oldest.
    - ``magic``: A magic number used for validation, equal to `FD_TXNCACHE_MAGIC`.
- **Description**: Represents a concurrent transaction cache structure accessed by multiple threads, where insertion and querying operations are lockless, but other operations require a write lock. The structure includes configuration parameters for transaction and slot limits, a mechanism to track free transaction pages, and a linked list to manage root forks for pruning purposes. The `magic` field is used to verify the integrity of the structure.


# Function Declarations (Public API)

---
### fd\_txncache\_max\_txnpages\_per\_blockhash<!-- {{#callable_declaration:fd_txncache_max_txnpages_per_blockhash}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_txncache_private.h#L138>)

Calculates the maximum number of transaction pages needed for a blockhash.
- **Description**: Use this function to determine the maximum number of transaction pages required to store all transactions that could be associated with a single blockhash, given the maximum number of active slots and transactions per slot. This function is useful when planning memory allocation for transaction storage. It assumes that every transaction in every active slot could reference the same blockhash. If the calculated number of pages exceeds the maximum value representable by an unsigned short, the function returns 0.
- **Inputs**:
    - `max_active_slots`: The maximum number of active slots. Must be a non-negative integer. Represents the number of slots that can simultaneously reference the same blockhash.
    - `max_txn_per_slot`: The maximum number of transactions per slot. Must be a non-negative integer. Represents the number of transactions that can occur in a single slot.
- **Output**: Returns the maximum number of transaction pages as an unsigned short. If the result exceeds the maximum value of an unsigned short, returns 0.
- **See Also**: [`fd_txncache_max_txnpages_per_blockhash`](<fd_txncache_shmem.c.md#fd_txncache_max_txnpages_per_blockhash>)  (Implementation)


---
### fd\_txncache\_max\_txnpages<!-- {{#callable_declaration:fd_txncache_max_txnpages}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_txncache_private.h#L144>)

Calculates the maximum number of transaction pages needed.
- **Description**: Use this function to determine the maximum number of transaction pages required to store transactions across all active slots. This calculation considers the potential for each slot to be fully occupied with transactions and accounts for page wastage. The function returns zero if the calculated number of pages exceeds the maximum value representable by an unsigned short.
- **Inputs**:
    - `max_active_slots`: The maximum number of active slots. Must be a positive integer. Represents the total slots that can be simultaneously active.
    - `max_txn_per_slot`: The maximum number of transactions per slot. Must be a positive integer. Represents the maximum transactions that can be stored in a single slot.
- **Output**: Returns the maximum number of transaction pages as an unsigned short. Returns zero if the result exceeds the maximum value for an unsigned short.
- **See Also**: [`fd_txncache_max_txnpages`](<fd_txncache_shmem.c.md#fd_txncache_max_txnpages>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)