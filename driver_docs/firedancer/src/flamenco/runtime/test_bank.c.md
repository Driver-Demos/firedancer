<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for bank advancement and fork tree management in a runtime environment.

# Purpose
The code is a C test suite designed to validate the functionality of a banking system that manages a tree of bank states. It uses a fork tree structure to simulate the creation and management of bank branches, where each branch can have multiple child branches. The test suite checks the ability to advance the root of the tree when certain conditions are met, such as when reference counts (`refcnts`) of specific branches drop to zero. The test ensures that the system correctly prunes branches with zero reference counts and advances the root to the appropriate branch.

The code includes a [`main`](<#main>) function that initializes the banking system, sets up initial conditions, and performs various operations on the bank states, such as setting and querying bank slots, managing stake delegations, and handling epoch leaders. It also tests the copy-on-write (CoW) fields and ensures that the system correctly handles the allocation and deallocation of resources. The test suite uses assertions (`FD_TEST`) to verify that each operation produces the expected result, ensuring the integrity and correctness of the banking system's functionality.
# Imports and Dependencies

---
- `fd_bank.h`


# Functions

---
### test\_bank\_advancing<!-- {{#callable:test_bank_advancing}} -->
[View Source →](<../../../../../src/flamenco/runtime/test_bank.c#L3>)

Tests the ability to advance the root of a bank tree structure by manipulating reference counts and verifying the correct pruning of banks.
- **Inputs**:
    - ``mem``: A pointer to memory used to initialize the bank structure.
- **Logic and Control Flow**:
    - Initialize a bank structure with [`fd_banks_new`](<fd_bank.c.md#fd_banks_new>) and join it with [`fd_banks_join`](<fd_bank.c.md#fd_banks_join>).
    - Create a tree of banks with specific reference counts using [`fd_banks_new_bank`](<fd_bank.c.md#fd_banks_new_bank>) and [`fd_banks_clone_from_parent`](<fd_bank.c.md#fd_banks_clone_from_parent>).
    - Set initial reference counts and verify bank existence with `FD_TEST`.
    - Attempt to advance the root of the bank tree using [`fd_banks_advance_root_prepare`](<fd_bank.c.md#fd_banks_advance_root_prepare>) and [`fd_banks_advance_root`](<fd_bank.c.md#fd_banks_advance_root>).
    - Verify that banks with zero reference counts are pruned from the tree.
    - Decrement reference counts and attempt to advance the root further, verifying the new root and pruned banks.
    - Ensure the final structure matches the expected result and verify reference counts after publishing.
- **Output**: No return value; the function performs tests and assertions to verify the correct behavior of bank advancing and pruning.
- **Functions Called**:
    - [`fd_banks_join`](<fd_bank.c.md#fd_banks_join>)
    - [`fd_banks_new`](<fd_bank.c.md#fd_banks_new>)
    - [`fd_banks_init_bank`](<fd_bank.c.md#fd_banks_init_bank>)
    - [`fd_banks_new_bank`](<fd_bank.c.md#fd_banks_new_bank>)
    - [`fd_banks_clone_from_parent`](<fd_bank.c.md#fd_banks_clone_from_parent>)
    - [`fd_banks_mark_bank_frozen`](<fd_bank.c.md#fd_banks_mark_bank_frozen>)
    - [`fd_banks_bank_query`](<fd_bank.h.md#fd_banks_bank_query>)
    - [`fd_banks_advance_root_prepare`](<fd_bank.c.md#fd_banks_advance_root_prepare>)
    - [`fd_banks_advance_root`](<fd_bank.c.md#fd_banks_advance_root>)
    - [`fd_banks_root`](<fd_bank.h.md#fd_banks_root>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/flamenco/runtime/test_bank.c#L254>)

Initializes and manages a series of bank operations, including stake delegations and bank cloning, while testing various conditions and states.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Defines a series of public keys (`fd_pubkey_t`) with unique identifiers.
    - Determines the NUMA index and creates a new anonymous workspace with a specified page size and CPU index.
    - Allocates memory for the workspace and initializes it for bank operations.
    - Joins the workspace to create a bank structure and initializes a bank with a specific slot.
    - Sets the bank's capitalization and verifies it through assertions.
    - Modifies stake delegations in the bank, updates them, and verifies the changes through queries and assertions.
    - Creates additional banks by cloning from parent banks and sets their properties, including capitalization and slot numbers.
    - Performs updates on stake delegations in new banks and verifies the integrity of these updates.
    - Marks banks as frozen and verifies the state of epoch leaders and stake delegations.
    - Advances the root of the bank structure and verifies the pruning of direct and competing forks.
    - Tests the creation of new banks and verifies the state of vote states and epoch leaders.
    - Clears a bank and verifies the release of resources and pool indices.
    - Calls [`test_bank_advancing`](<#test_bank_advancing>) to further test bank advancement logic.
    - Logs a notice of successful execution and halts the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`fd_banks_align`](<fd_bank.c.md#fd_banks_align>)
    - [`fd_banks_footprint`](<fd_bank.c.md#fd_banks_footprint>)
    - [`fd_banks_new`](<fd_bank.c.md#fd_banks_new>)
    - [`fd_banks_join`](<fd_bank.c.md#fd_banks_join>)
    - [`fd_banks_init_bank`](<fd_bank.c.md#fd_banks_init_bank>)
    - [`fd_bank_stake_delegations_delta_locking_modify`](<fd_bank.h.md#fd_bank_stake_delegations_delta_locking_modify>)
    - [`fd_bank_stake_delegations_delta_end_locking_modify`](<fd_bank.h.md#fd_bank_stake_delegations_delta_end_locking_modify>)
    - [`fd_bank_stake_delegations_frontier_query`](<fd_bank.c.md#fd_bank_stake_delegations_frontier_query>)
    - [`fd_banks_new_bank`](<fd_bank.c.md#fd_banks_new_bank>)
    - [`fd_banks_clone_from_parent`](<fd_bank.c.md#fd_banks_clone_from_parent>)
    - [`fd_banks_mark_bank_frozen`](<fd_bank.c.md#fd_banks_mark_bank_frozen>)
    - [`fd_banks_advance_root`](<fd_bank.c.md#fd_banks_advance_root>)
    - [`fd_banks_bank_query`](<fd_bank.h.md#fd_banks_bank_query>)
    - [`fd_banks_stake_delegations_root_query`](<fd_bank.c.md#fd_banks_stake_delegations_root_query>)
    - [`fd_banks_clear_bank`](<fd_bank.c.md#fd_banks_clear_bank>)
    - [`fd_banks_leave`](<fd_bank.c.md#fd_banks_leave>)
    - [`fd_banks_delete`](<fd_bank.c.md#fd_banks_delete>)
    - [`test_bank_advancing`](<#test_bank_advancing>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)