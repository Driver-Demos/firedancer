<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions and macros for managing bank structures, including alignment, footprint calculations, and operations on copy-on-write (CoW) pools.

# Purpose
The code defines a C module for managing a system of banks, which are data structures used to track and manage resources in a concurrent environment. The module provides functions to create, join, leave, delete, and manipulate banks and their associated pools. It uses a combination of macros and functions to handle different types of bank fields, including those that require copy-on-write (CoW) semantics and those that do not. The code also includes mechanisms for managing locks to ensure thread safety when accessing or modifying bank data.

The module defines several key functions, such as [`fd_banks_new`](<#fd_banks_new>), which initializes a new bank system in shared memory, and [`fd_banks_join`](<#fd_banks_join>), which allows a process to join an existing bank system. It also provides functions for managing the lifecycle of banks, such as [`fd_banks_init_bank`](<#fd_banks_init_bank>) to initialize a bank, [`fd_banks_clone_from_parent`](<#fd_banks_clone_from_parent>) to create a new bank from a parent bank, and [`fd_banks_advance_root`](<#fd_banks_advance_root>) to update the root bank in the system. The code uses macros to define accessor and modifier functions for bank fields, supporting both locked and unlocked access patterns. Additionally, the module includes functions for managing stake delegations and applying deltas to update the state of the bank system.
# Imports and Dependencies

---
- `fd_bank.h`
- `fd_runtime_const.h`


# Functions

---
### fd\_bank\_align<!-- {{#callable:fd_bank_align}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.c#L4>)

Returns the alignment requirement of the `fd_bank_t` type.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls the `alignof` operator on `fd_bank_t` to determine its alignment requirement.
    - Returns the result of the `alignof` operator.
- **Output**: An `ulong` representing the alignment requirement of `fd_bank_t`.


---
### fd\_bank\_footprint<!-- {{#callable:fd_bank_footprint}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.c#L9>)

Calculates the memory footprint required for a `fd_bank_t` structure with proper alignment.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize `l` with `FD_LAYOUT_INIT`.
    - Append the size of `fd_bank_t` to `l` using `FD_LAYOUT_APPEND`, aligned by `fd_bank_align()`.
    - Finalize the layout with `FD_LAYOUT_FINI`, aligned by `fd_bank_align()`.
- **Output**: Returns the calculated memory footprint as an unsigned long integer.
- **Functions Called**:
    - [`fd_bank_align`](<#fd_bank_align>)


---
### fd\_banks\_align<!-- {{#callable:fd_banks_align}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.c#L130>)

Returns a constant alignment value of 128 for bank structures.
- **Inputs**: None
- **Logic and Control Flow**:
    - The function contains a comment indicating that the 'magic number' 128 might be removable.
    - Returns the constant value 128UL.
- **Output**: An unsigned long integer with the value 128.


---
### fd\_banks\_footprint<!-- {{#callable:fd_banks_footprint}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.c#L136>)

Calculates the memory footprint required for a set of banks and their associated pools based on the maximum number of banks and fork width.
- **Inputs**:
    - `max_total_banks`: The maximum number of banks that can be created.
    - `max_fork_width`: The maximum width of forks that can be handled.
- **Logic and Control Flow**:
    - Initialize a layout variable `l` with `FD_LAYOUT_INIT`.
    - Append the alignment and size of `fd_banks_t` to `l` using `FD_LAYOUT_APPEND`.
    - Append the alignment and footprint of the banks pool to `l` using `fd_banks_pool_align` and `fd_banks_pool_footprint` with `max_total_banks`.
    - Append the alignment and footprint of the cost tracker pool to `l` using `fd_bank_cost_tracker_pool_align` and `fd_bank_cost_tracker_pool_footprint` with `max_fork_width`.
    - Iterate over each bank field using the `FD_BANKS_ITER` macro, applying different footprint calculations based on whether the field has copy-on-write (CoW) and fork width limitations.
    - For fields with CoW and fork width limitations, append their alignment and footprint using `max_fork_width`.
    - For fields with CoW but no fork width limitations, append their alignment and footprint using `max_total_banks`.
    - Finalize the layout `l` using `FD_LAYOUT_FINI` and return the result.
- **Output**: Returns the total memory footprint as an unsigned long integer.
- **Functions Called**:
    - [`fd_banks_align`](<#fd_banks_align>)


---
### fd\_banks\_new<!-- {{#callable:fd_banks_new}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.c#L170>)

Initializes a new `fd_banks_t` structure in shared memory with specified maximum banks and fork width, setting up various pools and locks.
- **Inputs**:
    - `shmem`: Pointer to shared memory where the `fd_banks_t` structure will be initialized.
    - `max_total_banks`: Maximum number of banks that can be managed.
    - `max_fork_width`: Maximum fork width for the cost tracker pool and other related pools.
- **Logic and Control Flow**:
    - Cast `shmem` to `fd_banks_t` pointer `banks` and check if it is NULL or misaligned, returning NULL if so.
    - Initialize the read-write lock in `banks` to unlocked state.
    - Allocate memory for `fd_banks_t`, bank pool, and cost tracker pool using `FD_SCRATCH_ALLOC_APPEND`.
    - Iterate over CoW pools using macros to allocate memory for each pool based on `max_fork_width` or `max_total_banks`.
    - Verify the memory layout with `FD_SCRATCH_ALLOC_FINI` and return NULL if the layout is incorrect.
    - Create and join the bank pool, marking all banks as uninitialized, and set the bank pool in `banks`.
    - Create and join the cost tracker pool, setting it in `banks`, and initialize cost trackers with a placeholder seed.
    - Iterate over CoW pools again to create and join each pool, setting them in `banks`.
    - Assign offsets for all pools in each bank and set the cost tracker pool for each bank.
    - Set `max_total_banks`, `max_fork_width`, and `root_idx` in `banks`.
    - Create the stake delegations root and return NULL if creation fails.
    - Set the `magic` field in `banks` to `FD_BANKS_MAGIC` and return `shmem`.
- **Output**: Returns the pointer to the initialized shared memory (`shmem`) or NULL if initialization fails.
- **Functions Called**:
    - [`fd_banks_align`](<#fd_banks_align>)
    - [`fd_banks_footprint`](<#fd_banks_footprint>)
    - [`fd_banks_set_bank_pool`](<fd_bank.h.md#fd_banks_set_bank_pool>)
    - [`fd_banks_set_cost_tracker_pool`](<fd_bank.h.md#fd_banks_set_cost_tracker_pool>)
    - [`fd_banks_get_cost_tracker_pool`](<fd_bank.h.md#fd_banks_get_cost_tracker_pool>)
    - [`fd_bank_set_cost_tracker_pool`](<fd_bank.h.md#fd_bank_set_cost_tracker_pool>)


---
### fd\_banks\_join<!-- {{#callable:fd_banks_join}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.c#L333>)

Validates and initializes a `fd_banks_t` structure from shared memory, ensuring proper alignment and magic number, and joins associated pools.
- **Inputs**:
    - `mem`: A pointer to the shared memory region that contains the `fd_banks_t` structure.
- **Logic and Control Flow**:
    - Cast `mem` to a `fd_banks_t` pointer named `banks`.
    - Check if `banks` is NULL; if so, log a warning and return NULL.
    - Check if `banks` is aligned according to `fd_banks_align()`; if not, log a warning and return NULL.
    - Check if `banks->magic` equals `FD_BANKS_MAGIC`; if not, log a warning and return NULL.
    - Initialize scratch allocation with `FD_SCRATCH_ALLOC_INIT` and append memory for `banks`, `pool_mem`, and `cost_tracker_pool_mem`.
    - Iterate over all Copy-on-Write (CoW) pools using macros to append memory for each pool based on alignment and footprint.
    - Finalize scratch allocation with `FD_SCRATCH_ALLOC_FINI`.
    - Retrieve the bank pool using [`fd_banks_get_bank_pool`](<fd_bank.h.md#fd_banks_get_bank_pool>) and check if it is NULL; if so, log a warning and return NULL.
    - Join the bank pool using `fd_banks_pool_join` and check if it matches `banks_pool`; if not, log a warning and return NULL.
    - Retrieve the cost tracker pool using [`fd_banks_get_cost_tracker_pool`](<fd_bank.h.md#fd_banks_get_cost_tracker_pool>) and check if it is NULL; if so, log a warning and return NULL.
    - Join the cost tracker pool using `fd_bank_cost_tracker_pool_join` and check if it matches `cost_tracker_pool`; if not, log a warning and return NULL.
    - Iterate over all CoW pools using macros to join each pool and check for errors, logging warnings and returning NULL if any join fails.
    - Return the `banks` pointer.
- **Output**: A pointer to the initialized `fd_banks_t` structure, or NULL if any validation or joining step fails.
- **Functions Called**:
    - [`fd_banks_align`](<#fd_banks_align>)
    - [`fd_banks_get_bank_pool`](<fd_bank.h.md#fd_banks_get_bank_pool>)
    - [`fd_banks_get_cost_tracker_pool`](<fd_bank.h.md#fd_banks_get_cost_tracker_pool>)


---
### fd\_banks\_leave<!-- {{#callable:fd_banks_leave}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.c#L424>)

Returns the input `fd_banks_t` pointer if it is not NULL, otherwise logs a warning and returns NULL.
- **Inputs**:
    - `banks`: A pointer to an `fd_banks_t` structure, which represents a collection of bank data.
- **Logic and Control Flow**:
    - Check if the `banks` pointer is NULL using `FD_UNLIKELY`.
    - If `banks` is NULL, log a warning message 'NULL banks' using `FD_LOG_WARNING` and return NULL.
    - If `banks` is not NULL, cast it to a `void *` and return it.
- **Output**: A `void *` pointer to the `fd_banks_t` structure if it is not NULL, otherwise NULL.


---
### fd\_banks\_delete<!-- {{#callable:fd_banks_delete}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.c#L435>)

Deletes a bank by setting its magic number to zero and returns the shared memory pointer if valid.
- **Inputs**:
    - `shmem`: A pointer to the shared memory representing the bank to delete.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL; if so, log a warning and return NULL.
    - Check if `shmem` is aligned according to [`fd_banks_align`](<#fd_banks_align>); if not, log a warning and return NULL.
    - Cast `shmem` to a `fd_banks_t` pointer and set its `magic` field to 0UL.
    - Return the `shmem` pointer.
- **Output**: Returns the `shmem` pointer if the input is valid and aligned, otherwise returns NULL.
- **Functions Called**:
    - [`fd_banks_align`](<#fd_banks_align>)


---
### fd\_banks\_init\_bank<!-- {{#callable:fd_banks_init_bank}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.c#L454>)

Initializes a new bank from a pool within a given banks structure, setting up its fields and locks.
- **Inputs**:
    - `banks`: A pointer to an `fd_banks_t` structure representing the collection of banks.
- **Logic and Control Flow**:
    - Check if `banks` is NULL; if so, log a warning and return NULL.
    - Retrieve the bank pool from `banks` using [`fd_banks_get_bank_pool`](<fd_bank.h.md#fd_banks_get_bank_pool>).
    - Acquire a write lock on `banks->rwlock`.
    - Check if there is a free bank in the pool; if not, log a warning, release the lock, and return NULL.
    - Acquire a bank from the pool using `fd_banks_pool_ele_acquire`.
    - Initialize fields of the bank based on whether they are Copy-on-Write (CoW) or not, using macros `HAS_COW_1` and `HAS_COW_0`.
    - Set the bank's index and initialize its sibling, parent, and child indices to null.
    - Set all CoW fields to null using the `HAS_COW_1` macro.
    - Release any locks associated with the bank using the `HAS_LOCK_1` macro.
    - Set the cost tracker pool for the bank and initialize its index to null.
    - Set the bank's flags to indicate it is initialized and frozen, and set its reference count to zero.
    - Record the current time for `first_fec_set_received_nanos` and initialize other time fields to zero.
    - Update the root index of `banks` to the new bank's index.
    - Release the write lock on `banks->rwlock`.
    - Return the initialized bank.
- **Output**: A pointer to the newly initialized `fd_bank_t` structure, or NULL if initialization fails.
- **Functions Called**:
    - [`fd_banks_get_bank_pool`](<fd_bank.h.md#fd_banks_get_bank_pool>)
    - [`fd_bank_set_cost_tracker_pool`](<fd_bank.h.md#fd_bank_set_cost_tracker_pool>)
    - [`fd_banks_get_cost_tracker_pool`](<fd_bank.h.md#fd_banks_get_cost_tracker_pool>)
    - [`fd_bank_get_cost_tracker_pool`](<fd_bank.h.md#fd_bank_get_cost_tracker_pool>)


---
### fd\_banks\_clone\_from\_parent<!-- {{#callable:fd_banks_clone_from_parent}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.c#L537>)

Clones a child bank from a parent bank by copying relevant fields and setting up necessary locks and resources.
- **Inputs**:
    - ``banks``: A pointer to the `fd_banks_t` structure that contains the bank pool and other related resources.
    - ``child_bank_idx``: The index of the child bank in the bank pool that will be cloned from the parent bank.
    - ``parent_bank_idx``: The index of the parent bank in the bank pool from which the child bank will be cloned.
- **Logic and Control Flow**:
    - Acquire a write lock on the `banks` structure to ensure thread safety.
    - Retrieve the bank pool from the `banks` structure.
    - Validate the existence and initialization of the child bank using `child_bank_idx`.
    - Validate the existence and frozen state of the parent bank using `parent_bank_idx`.
    - Copy non-Copy-On-Write (non-CoW) fields from the parent bank to the child bank using `fd_memcpy`.
    - Set up Copy-On-Write (CoW) fields by copying pool indices from the parent bank to the child bank and resetting dirty flags.
    - Initialize non-templatized fields such as the cost tracker pool for the child bank.
    - Release locks for the child bank to mark them as free.
    - If the parent bank is marked as dead, mark the child bank as dead as well.
    - Set the child bank's reference count to zero and mark it as replayable.
    - Release the write lock on the `banks` structure.
- **Output**: Returns a pointer to the cloned child bank (`fd_bank_t`).
- **Functions Called**:
    - [`fd_banks_get_bank_pool`](<fd_bank.h.md#fd_banks_get_bank_pool>)
    - [`fd_bank_get_cost_tracker_pool`](<fd_bank.h.md#fd_bank_get_cost_tracker_pool>)


---
### fd\_banks\_stake\_delegations\_apply\_delta<!-- {{#callable:fd_banks_stake_delegations_apply_delta}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.c#L640>)

Applies stake delegation changes from a bank's delta to a base stake delegation structure if the delta is marked as dirty.
- **Inputs**:
    - ``bank``: A pointer to an `fd_bank_t` structure representing the bank whose stake delegations delta is to be applied.
    - ``stake_delegations_base``: A pointer to an `fd_stake_delegations_t` structure representing the base stake delegations to which the delta will be applied.
- **Logic and Control Flow**:
    - Check if the `stake_delegations_delta_dirty` flag in the `bank` is not set; if not set, return immediately.
    - Join the `stake_delegations_delta` from the `bank` to get a pointer to the delta structure.
    - Initialize an iterator for the `stake_delegations_delta`.
    - Iterate over each stake delegation in the delta using the iterator.
    - For each stake delegation, check if it is not marked as a tombstone.
    - If not a tombstone, update the `stake_delegations_base` with the current stake delegation's details.
    - If it is a tombstone, remove the corresponding stake account from the `stake_delegations_base`.
- **Output**: No output is returned; the function modifies the `stake_delegations_base` in place.


---
### fd\_bank\_stake\_delegation\_apply\_deltas<!-- {{#callable:fd_bank_stake_delegation_apply_deltas}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.c#L679>)

Applies stake delegation deltas from a bank's ancestry to a full stake delegations object.
- **Inputs**:
    - ``banks``: A pointer to an `fd_banks_t` structure representing the collection of banks.
    - ``bank``: A pointer to an `fd_bank_t` structure representing the bank from which to start applying deltas.
    - ``stake_delegations``: A pointer to an `fd_stake_delegations_t` structure where the deltas will be applied.
- **Logic and Control Flow**:
    - Initialize an array `pool_indicies` to store indices of banks whose deltas need to be applied, and set its length to zero.
    - Retrieve the bank pool from `banks` using [`fd_banks_get_bank_pool`](<fd_bank.h.md#fd_banks_get_bank_pool>).
    - Determine the current index of `bank` in the pool and iterate backwards through its ancestry, storing each bank's index in `pool_indicies` until reaching a null parent index.
    - Iterate over `pool_indicies` in reverse order, applying each bank's stake delegation delta to `stake_delegations` using [`fd_banks_stake_delegations_apply_delta`](<#fd_banks_stake_delegations_apply_delta>).
- **Output**: No return value; the function modifies the `stake_delegations` object in place.
- **Functions Called**:
    - [`fd_banks_get_bank_pool`](<fd_bank.h.md#fd_banks_get_bank_pool>)
    - [`fd_banks_stake_delegations_apply_delta`](<#fd_banks_stake_delegations_apply_delta>)


---
### fd\_bank\_stake\_delegations\_frontier\_query<!-- {{#callable:fd_bank_stake_delegations_frontier_query}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.c#L711>)

Queries the stake delegations frontier by copying the rooted state and applying updates from a specified bank and its ancestors.
- **Inputs**:
    - `banks`: A pointer to an `fd_banks_t` structure representing the collection of banks.
    - `bank`: A pointer to an `fd_bank_t` structure representing the specific bank whose updates are to be applied.
- **Logic and Control Flow**:
    - Acquire a write lock on the `banks` structure using `fd_rwlock_write` to ensure thread safety.
    - Copy the rooted state from `banks->stake_delegations_root` to `banks->stake_delegations_frontier` using `memcpy`.
    - Join the `stake_delegations_frontier` to get a pointer to `fd_stake_delegations_t`.
    - Apply all updates from the specified `bank` and its ancestors to the `stake_delegations` using [`fd_bank_stake_delegation_apply_deltas`](<#fd_bank_stake_delegation_apply_deltas>).
    - Release the write lock on the `banks` structure using `fd_rwlock_unwrite`.
    - Return the updated `stake_delegations`.
- **Output**: Returns a pointer to an `fd_stake_delegations_t` structure representing the updated stake delegations frontier.
- **Functions Called**:
    - [`fd_bank_stake_delegation_apply_deltas`](<#fd_bank_stake_delegation_apply_deltas>)


---
### fd\_banks\_stake\_delegations\_root\_query<!-- {{#callable:fd_banks_stake_delegations_root_query}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.c#L729>)

Queries the root stake delegations from a given bank structure.
- **Inputs**:
    - `banks`: A pointer to an `fd_banks_t` structure, which contains the root stake delegations to query.
- **Logic and Control Flow**:
    - Calls `fd_stake_delegations_join` with the `stake_delegations_root` from the `banks` structure.
    - Returns the result of the `fd_stake_delegations_join` function call.
- **Output**: A pointer to an `fd_stake_delegations_t` structure representing the root stake delegations.


---
### fd\_banks\_advance\_root<!-- {{#callable:fd_banks_advance_root}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.c#L734>)

Advances the root bank in a bank tree structure by replacing the old root with a new root and removing non-descendant banks.
- **Inputs**:
    - `banks`: A pointer to the `fd_banks_t` structure representing the bank tree.
    - `root_bank_idx`: An unsigned long integer representing the index of the new root bank.
- **Logic and Control Flow**:
    - Acquire a write lock on the `banks` structure using `fd_rwlock_write`.
    - Retrieve the bank pool using [`fd_banks_get_bank_pool`](<fd_bank.h.md#fd_banks_get_bank_pool>).
    - Get the index representing a null bank using `fd_banks_pool_idx_null`.
    - Retrieve the current root bank using [`fd_banks_root`](<fd_bank.h.md#fd_banks_root>) and check for null or non-zero reference count, logging critical errors if found.
    - Query the new root bank using [`fd_banks_bank_query`](<fd_bank.h.md#fd_banks_bank_query>) and check for null or invalid parent index, logging critical errors if found.
    - Join the stake delegations root and apply deltas to the new root using [`fd_bank_stake_delegation_apply_deltas`](<#fd_bank_stake_delegation_apply_deltas>).
    - Set the `stake_delegations_delta_dirty` flag of the new root to 0.
    - Iterate over the old root's children, updating tail pointers and checking reference counts, logging critical errors if found.
    - Release and free resources for non-descendant banks, including CoW fields, using macros `HAS_COW_1` and `HAS_COW_0`.
    - Set the new root's parent index to null and update the `banks` root index.
    - Release the write lock on the `banks` structure using `fd_rwlock_unwrite`.
- **Output**: Returns a pointer to the new root bank (`fd_bank_t const *`).
- **Functions Called**:
    - [`fd_banks_get_bank_pool`](<fd_bank.h.md#fd_banks_get_bank_pool>)
    - [`fd_banks_root`](<fd_bank.h.md#fd_banks_root>)
    - [`fd_banks_bank_query`](<fd_bank.h.md#fd_banks_bank_query>)
    - [`fd_bank_stake_delegation_apply_deltas`](<#fd_bank_stake_delegation_apply_deltas>)


---
### fd\_banks\_clear\_bank<!-- {{#callable:fd_banks_clear_bank}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.c#L847>)

Clears a bank's non-copy-on-write (non-CoW) data and resets its copy-on-write (CoW) pools to match its parent bank.
- **Inputs**:
    - ``banks``: A pointer to the `fd_banks_t` structure, which contains the bank pool and associated locks.
    - ``bank``: A pointer to the `fd_bank_t` structure, representing the bank to be cleared.
- **Logic and Control Flow**:
    - Acquire a read lock on the `banks` structure using `fd_rwlock_read` to ensure thread safety.
    - Retrieve the parent bank of the given `bank` using its `parent_idx`.
    - Clear the non-CoW data of the `bank` by setting it to zero using `fd_memset`.
    - Iterate over each potential CoW field using the `FD_BANKS_ITER` macro and check if the `dirty` flag is set for each field.
    - If a CoW field is dirty, release its pool index and set the bank's pool index to match the parent bank's pool index or set it to null if no parent exists.
    - Acquire a new cost tracker pool index for the `bank` and release the old one if it exists.
    - Reset the `stake_delegations_delta_dirty` flag to 0.
    - Release the read lock on the `banks` structure using `fd_rwlock_unread`.
- **Output**: The function does not return a value; it modifies the `bank` in place.
- **Functions Called**:
    - [`fd_banks_get_bank_pool`](<fd_bank.h.md#fd_banks_get_bank_pool>)
    - [`fd_bank_get_cost_tracker_pool`](<fd_bank.h.md#fd_bank_get_cost_tracker_pool>)


---
### fd\_banks\_subtree\_can\_be\_pruned<!-- {{#callable:fd_banks_subtree_can_be_pruned}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.c#L894>)

Determines if a subtree of banks can be pruned based on reference counts and child nodes.
- **Inputs**:
    - ``bank_pool``: A pointer to the pool of banks (`fd_bank_t`) used to access child banks.
    - ``bank``: A pointer to the bank (`fd_bank_t`) that is the root of the subtree to check for pruning eligibility.
- **Logic and Control Flow**:
    - Check if `bank` is NULL and log a critical error if true.
    - Return 0 if the reference count (`refcnt`) of `bank` is not zero, indicating it cannot be pruned.
    - Initialize `child_idx` with the index of the first child of `bank`.
    - Iterate over all children of `bank` using `child_idx`.
    - For each child, recursively call `fd_banks_subtree_can_be_pruned` to check if the child's subtree can be pruned.
    - If any child subtree cannot be pruned, return 0.
    - If all checks pass, return 1 indicating the subtree can be pruned.
- **Output**: Returns 1 if the subtree can be pruned, otherwise returns 0.


---
### fd\_banks\_subtree\_mark\_dead<!-- {{#callable:fd_banks_subtree_mark_dead}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.c#L919>)

Marks a bank and all its descendants in a bank pool as dead, ensuring they are not rooted.
- **Inputs**:
    - ``bank_pool``: A pointer to the pool of banks (`fd_bank_t`) where the bank and its descendants are located.
    - ``bank``: A pointer to the bank (`fd_bank_t`) that is the root of the subtree to be marked as dead.
- **Logic and Control Flow**:
    - Checks if the `bank` is `NULL` and logs a critical error if true.
    - Checks if the `bank` is rooted by examining its flags and logs a critical error if true.
    - Sets the `FD_BANK_FLAGS_DEAD` flag on the `bank` to mark it as dead.
    - Initializes `child_idx` with the index of the first child of the `bank`.
    - Iterates over each child of the `bank` using `child_idx`, retrieves the child bank, and recursively calls `fd_banks_subtree_mark_dead` on each child.
    - Updates `child_idx` to the next sibling index until all children are processed.
- **Output**: No return value; the function operates by modifying the flags of the bank and its descendants in place.


---
### fd\_banks\_advance\_root\_prepare<!-- {{#callable:fd_banks_advance_root_prepare}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.c#L939>)

Prepares to advance the root bank in a bank tree structure by marking nodes and checking conditions for advancement.
- **Inputs**:
    - `banks`: A pointer to the `fd_banks_t` structure representing the bank tree.
    - `target_bank_idx`: The index of the target bank to which the root is intended to advance.
    - `advanceable_bank_idx_out`: A pointer to an `ulong` where the function will store the index of the bank that can be advanced to.
- **Logic and Control Flow**:
    - Retrieve the bank pool from the `banks` structure and acquire a read lock on the `rwlock`.
    - Get the current root bank using [`fd_banks_root`](<fd_bank.h.md#fd_banks_root>). If the root is not found, log a warning and return 0.
    - Check if the `target_bank_idx` is the same as the current root's index. If so, log a warning and return 0.
    - Check if the root bank's reference count is not zero. If so, return 0 as the root cannot be advanced.
    - Retrieve the target bank from the bank pool using `target_bank_idx`. If not found, log a critical error.
    - Mark nodes from the target bank up to the root as rooted, and determine the oldest non-rooted ancestor of the target bank.
    - If the target bank is not a direct descendant of the root, log a critical error.
    - Mark the old root bank as dead.
    - Check if each sibling of the potential new root can be pruned. If any cannot be pruned, return 0.
    - Store the index of the advanceable bank in `advanceable_bank_idx_out`, release the read lock, and return 1.
- **Output**: Returns 1 if the root can be advanced, otherwise returns 0.
- **Functions Called**:
    - [`fd_banks_get_bank_pool`](<fd_bank.h.md#fd_banks_get_bank_pool>)
    - [`fd_banks_root`](<fd_bank.h.md#fd_banks_root>)
    - [`fd_banks_subtree_mark_dead`](<#fd_banks_subtree_mark_dead>)
    - [`fd_banks_subtree_can_be_pruned`](<#fd_banks_subtree_can_be_pruned>)


---
### fd\_banks\_new\_bank<!-- {{#callable:fd_banks_new_bank}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.c#L1022>)

Creates a new child bank in the bank pool and links it to a specified parent bank.
- **Inputs**:
    - `banks`: A pointer to the `fd_banks_t` structure that manages the bank pool.
    - `parent_bank_idx`: The index of the parent bank in the bank pool.
    - `now`: A timestamp indicating the current time in nanoseconds.
- **Logic and Control Flow**:
    - Acquires a write lock on the `banks` structure to ensure thread safety.
    - Retrieves the bank pool from the `banks` structure.
    - Checks if the bank pool is available and has free indices; logs a critical error if not.
    - Acquires a new index for the child bank from the bank pool.
    - Validates the newly acquired child bank to ensure it is not already initialized; logs a critical error if it is.
    - Initializes the child bank's indices and flags, setting it as uninitialized and linking it to the parent bank.
    - Validates the parent bank to ensure it exists and is initialized; logs a critical error if not.
    - Links the child bank to the parent bank as the left-most child if no other children exist, or as the right-most sibling otherwise.
    - Sets the initial timestamps for the child bank's transaction and FEC set events.
    - Releases the write lock on the `banks` structure.
- **Output**: Returns a pointer to the newly created and initialized `fd_bank_t` child bank.
- **Functions Called**:
    - [`fd_banks_get_bank_pool`](<fd_bank.h.md#fd_banks_get_bank_pool>)


---
### fd\_banks\_mark\_bank\_dead<!-- {{#callable:fd_banks_mark_bank_dead}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.c#L1103>)

Marks a specified bank and its subtree as dead in a bank management system.
- **Inputs**:
    - ``banks``: A pointer to an `fd_banks_t` structure representing the bank management system.
    - ``bank``: A pointer to an `fd_bank_t` structure representing the bank to be marked as dead.
- **Logic and Control Flow**:
    - Acquires a write lock on the `rwlock` of the `banks` structure to ensure exclusive access.
    - Calls [`fd_banks_subtree_mark_dead`](<#fd_banks_subtree_mark_dead>) to mark the specified bank and its subtree as dead.
    - Releases the write lock on the `rwlock` of the `banks` structure.
- **Output**: No return value; the function operates by side effect on the `banks` and `bank` structures.
- **Functions Called**:
    - [`fd_banks_subtree_mark_dead`](<#fd_banks_subtree_mark_dead>)
    - [`fd_banks_get_bank_pool`](<fd_bank.h.md#fd_banks_get_bank_pool>)


---
### fd\_banks\_mark\_bank\_frozen<!-- {{#callable:fd_banks_mark_bank_frozen}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.c#L1113>)

Marks a bank as frozen and updates its cost tracker pool index.
- **Inputs**:
    - `banks`: A pointer to the `fd_banks_t` structure, which manages multiple banks.
    - `bank`: A pointer to the `fd_bank_t` structure representing the bank to be marked as frozen.
- **Logic and Control Flow**:
    - Checks if the bank is already marked as frozen by examining the `FD_BANK_FLAGS_FROZEN` flag in `bank->flags` and logs a critical error if true.
    - Acquires a write lock on `banks->rwlock` to ensure thread safety during modifications.
    - Sets the `FD_BANK_FLAGS_FROZEN` flag in `bank->flags` to mark the bank as frozen.
    - Checks if the `bank->cost_tracker_pool_idx` is null by comparing it with the result of `fd_bank_cost_tracker_pool_idx_null` and logs a critical error if true.
    - Releases the current cost tracker pool index using `fd_bank_cost_tracker_pool_idx_release`.
    - Sets `bank->cost_tracker_pool_idx` to null using `fd_bank_cost_tracker_pool_idx_null`.
    - Releases the write lock on `banks->rwlock`.
- **Output**: No return value; the function operates by modifying the state of the `bank` and `banks` structures.
- **Functions Called**:
    - [`fd_bank_get_cost_tracker_pool`](<fd_bank.h.md#fd_bank_get_cost_tracker_pool>)


---
### fd\_banks\_validate<!-- {{#callable:fd_banks_validate}} -->
[View Source →](<../../../../../src/flamenco/runtime/fd_bank.c#L1131>)

Validates that the number of elements acquired by Copy-on-Write (CoW) pools does not exceed the number of elements in the bank pool.
- **Inputs**:
    - `banks`: A pointer to an `fd_banks_t` structure representing the banks to validate.
- **Logic and Control Flow**:
    - Acquire a read lock on the `rwlock` of the `banks` structure.
    - Retrieve the bank pool using [`fd_banks_get_bank_pool`](<fd_bank.h.md#fd_banks_get_bank_pool>).
    - Log the number of free elements in the bank pool using `FD_LOG_INFO`.
    - Iterate over each CoW pool using the `FD_BANKS_ITER` macro.
    - For each CoW pool, check if the number of elements used exceeds the number of elements used in the bank pool.
    - If any CoW pool has more elements acquired than the bank pool, log a warning and return 1.
    - Release the read lock on the `rwlock`.
    - Return 0 if all checks pass.
- **Output**: Returns 0 if validation passes, otherwise returns 1 if any CoW pool has more elements acquired than the bank pool.
- **Functions Called**:
    - [`fd_banks_get_bank_pool`](<fd_bank.h.md#fd_banks_get_bank_pool>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)