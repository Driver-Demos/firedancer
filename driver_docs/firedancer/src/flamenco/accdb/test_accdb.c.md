<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for the functionality and integrity of the `accdb` component, including initialization, verification, and random operations.

# Purpose
The code is a C program designed to test the functionality and integrity of a data structure management system, specifically focusing on transaction and record management within a workspace. It includes functions to initialize, verify, and manipulate records and transactions in a shared memory environment. The program uses a series of test functions to ensure that the data structures maintain their invariants and that operations such as record insertion, transaction attachment, and root advancement are correctly implemented.

The main components of the code include functions for initializing records ([`init_funk`](<#init_funk>)), verifying that records and transactions are empty ([`verify_accdb_empty`](<#verify_accdb_empty>), [`verify_recs_empty`](<#verify_recs_empty>), [`verify_txns_empty`](<#verify_txns_empty>)), and performing random operations to test the system's robustness ([`test_random_ops`](<#test_random_ops>)). The program also includes a [`main`](<#main>) function that sets up the environment, parses command-line arguments, and executes the test suite. The code is structured to be executed as a standalone program, with the primary purpose of validating the correctness of the data structure operations in a controlled test environment.
# Imports and Dependencies

---
- `fd_accdb_admin.h`
- `fd_accdb_user.h`
- `../../funk/test_funk_common.h`
- `../../funk/test_funk_common.c`


# Functions

---
### init\_funk<!-- {{#callable:init_funk}} -->
[View Source →](<../../../../../src/flamenco/accdb/test_accdb.c#L11>)

Initializes unallocated records and transactions in a shared funk instance.
- **Inputs**:
    - `shfunk`: A pointer to the shared funk instance to initialize.
- **Logic and Control Flow**:
    - Declare a local `fd_funk_t` array `funk` with one element.
    - Join the shared funk instance using `fd_funk_join` and check the result with `FD_TEST`.
    - Retrieve the maximum number of records `rec_max` from `funk->rec_pool->ele_max`.
    - Iterate over each record in `funk->rec_pool->ele` and initialize its fields to default values.
    - Retrieve the maximum number of transactions `txn_max` from `funk->txn_pool->ele_max`.
    - Iterate over each transaction in `funk->txn_pool->ele` and initialize its fields to default values.
    - Leave the funk instance using `fd_funk_leave`.
- **Output**: No return value; the function operates on the shared funk instance pointed to by `shfunk`.


---
### visit\_rec<!-- {{#callable:visit_rec}} -->
[View Source →](<../../../../../src/flamenco/accdb/test_accdb.c#L50>)

Validates the state of a `fd_funk_rec_t` record and sets its `tag` to 1.
- **Inputs**:
    - `rec`: A pointer to a `fd_funk_rec_t` record that needs validation and tagging.
- **Logic and Control Flow**:
    - Check if `rec->tag` is 0 using `FD_TEST` macro.
    - Verify that `rec->next_idx` and `rec->prev_idx` are equal to `UINT_MAX`.
    - Ensure `rec->val_sz` and `rec->val_max` are 0.
    - Confirm `rec->val_gaddr` is 0UL.
    - Check that all elements of `rec->pair.key->ul` are 0UL.
    - Set `rec->tag` to 1.
- **Output**: No return value; the function modifies the `rec` structure in place.


---
### verify\_recs\_empty<!-- {{#callable:verify_recs_empty}} -->
[View Source →](<../../../../../src/flamenco/accdb/test_accdb.c#L65>)

Verifies that all record hash chains are empty and unlocked, and that all records are in the object pool and properly initialized.
- **Inputs**:
    - ``admin``: A pointer to an `fd_accdb_admin_t` structure, which contains the `funk` instance to verify.
- **Logic and Control Flow**:
    - Retrieve the record map from the `admin` structure's `funk` instance.
    - Determine the number of hash chains in the record map.
    - Iterate over each hash chain to verify that it is empty and unlocked by checking the version count, version, and head index.
    - Retrieve the record pool from the `admin` structure's `funk` instance.
    - Set the `tag` of each record in the record pool to 0, indicating they are uninitialized.
    - Iterate over stack-allocated free objects, validate each record, and mark it as visited using the [`visit_rec`](<#visit_rec>) function.
    - Iterate over bump-allocated free objects, validate each record, and mark it as visited using the [`visit_rec`](<#visit_rec>) function.
    - Verify that all records in the record pool have been marked as visited by checking their `tag` values.
- **Output**: None (void function).
- **Functions Called**:
    - [`visit_rec`](<#visit_rec>)


---
### verify\_txns\_empty<!-- {{#callable:verify_txns_empty}} -->
[View Source →](<../../../../../src/flamenco/accdb/test_accdb.c#L103>)

Verifies that all transaction hash chains are empty and unlocked, and that all transaction elements are in the object pool and properly initialized.
- **Inputs**:
    - ``admin``: A pointer to an `fd_accdb_admin_t` structure, which contains the transaction map and pool to verify.
- **Logic and Control Flow**:
    - Retrieve the transaction map from the `admin` structure.
    - Get the number of chains in the transaction map using `fd_funk_txn_map_chain_cnt`.
    - Iterate over each chain and verify that the version count is zero, the version is even, and the head index is `ULONG_MAX`.
    - Retrieve the transaction pool from the `admin` structure.
    - Set the `tag` of each transaction in the pool to zero.
    - Peek at the first transaction in the pool using `fd_funk_txn_pool_peek`.
    - Iterate over each transaction in the pool, verifying that it is within bounds, untagged, and has specific fields set to `UINT_MAX` or zero.
    - Log a notice if a transaction's `child_head_cidx` is not `UINT_MAX`.
    - Set the `tag` of each verified transaction to one.
- **Output**: No return value; the function performs verification and logging.


---
### verify\_accdb\_empty<!-- {{#callable:verify_accdb_empty}} -->
[View Source →](<../../../../../src/flamenco/accdb/test_accdb.c#L139>)

Verifies that a funk instance is empty, with no records or transactions, and that all resources are returned to their pools.
- **Inputs**:
    - `admin`: A pointer to an `fd_accdb_admin_t` structure representing the admin interface to the funk instance to verify.
- **Logic and Control Flow**:
    - Call [`verify_recs_empty`](<#verify_recs_empty>) with `admin` to check that all record chains are empty and all records are returned to the pool.
    - Call [`verify_txns_empty`](<#verify_txns_empty>) with `admin` to check that all transaction chains are empty and all transactions are returned to the pool.
    - Use `FD_TEST` to assert that the allocation associated with `admin->funk` is empty, indicating no memory leaks.
- **Output**: No return value; the function performs assertions to verify the state of the funk instance.
- **Functions Called**:
    - [`verify_recs_empty`](<#verify_recs_empty>)
    - [`verify_txns_empty`](<#verify_txns_empty>)


---
### test\_random\_ops<!-- {{#callable:test_random_ops}} -->
[View Source →](<../../../../../src/flamenco/accdb/test_accdb.c#L154>)

Performs random operations on a fork graph, including node creation, record insertion, and node rooting, while verifying correctness through invariants and replication.
- **Inputs**:
    - ``wksp``: A pointer to a `fd_wksp_t` workspace used for memory allocation.
    - ``rng``: A pointer to a `fd_rng_t` random number generator used for generating random values.
    - ``txn_max``: The maximum number of transactions allowed.
    - ``rec_max``: The maximum number of records allowed.
    - ``iter_max``: The maximum number of iterations to perform.
- **Logic and Control Flow**:
    - Initialize a random seed and calculate the footprint for the fork graph.
    - Allocate memory for the fork graph and initialize it with `fd_funk_new`.
    - Create a reference fork graph and join admin and user accounts to the fork graph.
    - Verify that the fork graph is initially empty.
    - Iterate up to `iter_max` times, performing random operations based on a random value `op`.
    - For `op >= 3`, attempt to insert a record if the fork graph is not full and there are transactions available.
    - For `op >= 1`, attempt to attach a child transaction if the fork graph is not full.
    - For `op < 1`, attempt to advance the root transaction if there are transactions available.
    - Verify the fork graph's correctness at regular intervals and after all iterations.
    - Clear and verify the fork graph is empty before leaving the admin and user accounts.
    - Free allocated memory and delete the reference fork graph.
- **Output**: No return value; the function performs operations and checks for correctness through assertions.
- **Functions Called**:
    - [`init_funk`](<#init_funk>)
    - [`fd_accdb_user_join`](<fd_accdb_user.c.md#fd_accdb_user_join>)
    - [`verify_accdb_empty`](<#verify_accdb_empty>)
    - [`fd_accdb_verify`](<fd_accdb_admin.c.md#fd_accdb_verify>)
    - [`fd_accdb_attach_child`](<fd_accdb_admin.c.md#fd_accdb_attach_child>)
    - [`fd_accdb_advance_root`](<fd_accdb_admin.c.md#fd_accdb_advance_root>)
    - [`fd_accdb_clear`](<fd_accdb_admin.c.md#fd_accdb_clear>)
    - [`fd_accdb_user_leave`](<fd_accdb_user.c.md#fd_accdb_user_leave>)
    - [`fd_accdb_admin_leave`](<fd_accdb_admin.c.md#fd_accdb_admin_leave>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/flamenco/accdb/test_accdb.c#L271>)

Initializes the environment, parses command-line arguments, sets up a random number generator and workspace, performs random operations, and cleans up resources before exiting.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - If `VERBOSE` is defined, sets log levels for stderr and logfile to 0.
    - Parses command-line arguments for page size, page count, near CPU, seed, transaction max, record max, and iteration max, with default values if not provided.
    - Initializes a random number generator with the parsed seed value.
    - Logs the configuration of the anonymous local workspace being used.
    - Creates a new anonymous workspace with the specified page size, page count, and near CPU.
    - Checks if the workspace creation was successful; logs an error and exits if not.
    - Calls [`test_random_ops`](<#test_random_ops>) to perform random operations using the workspace and random number generator.
    - Deletes the anonymous workspace and the random number generator after operations are complete.
    - Logs a 'pass' message and calls `fd_halt` to terminate the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`test_random_ops`](<#test_random_ops>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)