<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Synchronous blocking APIs for speculative zero-copy reads and in-place transactional writes in an account database.

# Purpose
The `fd_accdb_sync.h` file provides synchronous blocking APIs for interacting with an account database. It includes functionality for both speculative zero-copy reads and in-place transactional writes. The file defines a structure `fd_accdb_peek_t`, which is used to perform speculative reads on the account database cache. This structure allows for lock-free, read-only access to account data, and includes functions such as `fd_accdb_peek`, [`fd_accdb_peek_test`](<#fd_accdb_peek_test>), and [`fd_accdb_peek_drop`](<#fd_accdb_peek_drop>) to manage the lifecycle of these speculative reads. The `fd_accdb_peek` function initiates a speculative read, [`fd_accdb_peek_test`](<#fd_accdb_peek_test>) checks the validity of the read data, and [`fd_accdb_peek_drop`](<#fd_accdb_peek_drop>) releases the reference to the account data.

Additionally, the file provides APIs for transactional writes, including [`fd_accdb_modify_prepare`](<#fd_accdb_modify_prepare>) and [`fd_accdb_write_publish`](<#fd_accdb_write_publish>). The [`fd_accdb_modify_prepare`](<#fd_accdb_modify_prepare>) function prepares an account for modification by creating a copy of its previous version, while [`fd_accdb_write_publish`](<#fd_accdb_write_publish>) finalizes and publishes the changes made to the account. These functions are designed to ensure data integrity during concurrent access and modifications. The header file includes other necessary headers such as `fd_accdb_user.h` and `fd_accdb_ref.h`, which are likely used to manage user sessions and references within the account database.
# Imports and Dependencies

---
- `fd_accdb_user.h`
- `fd_accdb_ref.h`


# Data Structures

---
### fd\_accdb\_peek
- **Type**: ``struct``
- **Members**:
    - ``acc``: An array of one `fd_accdb_ro_t` element representing a read-only pointer to an account.
    - ``spec``: An array of one `fd_accdb_spec_t` element used for speculative reference management.
- **Description**: The `fd_accdb_peek` structure provides a lock-free, read-only pointer to an account in a database cache, allowing speculative reads. It contains an array of one `fd_accdb_ro_t` element for accessing account data and an array of one `fd_accdb_spec_t` element for managing speculative references.


---
### fd\_accdb\_peek\_t
- **Type**: ``struct``
- **Members**:
    - ``acc``: An array of one `fd_accdb_ro_t` element representing a read-only pointer to an account.
    - ``spec``: An array of one `fd_accdb_spec_t` element used for speculative reference management.
- **Description**: Provides an ephemeral, lock-free, read-only pointer to an account in the database cache, allowing speculative reads of account data without locking mechanisms.


# Functions

---
### fd\_accdb\_peek\_test<!-- {{#callable:fd_accdb_peek_test}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_sync.h#L53>)

Checks if a previously taken speculative read (`peek`) still refers to valid account data.
- **Inputs**:
    - `peek`: A constant pointer to `fd_accdb_peek_t`, representing a speculative read of an account.
- **Logic and Control Flow**:
    - Calls the function [`fd_accdb_spec_test`](<fd_accdb_ref.h.md#fd_accdb_spec_test>) with `peek->spec` as an argument.
    - Returns the result of [`fd_accdb_spec_test`](<fd_accdb_ref.h.md#fd_accdb_spec_test>), which indicates the validity of the speculative read.
- **Output**: Returns 1 if the speculative read is still valid, otherwise returns 0 if a conflict is detected.
- **Functions Called**:
    - [`fd_accdb_spec_test`](<fd_accdb_ref.h.md#fd_accdb_spec_test>)


---
### fd\_accdb\_peek\_drop<!-- {{#callable:fd_accdb_peek_drop}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_sync.h#L60>)

Releases the caller's interest in a speculative read of an account by dropping the associated specification.
- **Inputs**:
    - ``peek``: A pointer to an `fd_accdb_peek_t` structure, which contains a speculative reference to an account in the database cache.
- **Logic and Control Flow**:
    - Calls the function [`fd_accdb_spec_drop`](<fd_accdb_ref.h.md#fd_accdb_spec_drop>) with the `spec` member of the `peek` structure to release the speculative reference.
- **Output**: No output is returned as the function is of type `void`.
- **Functions Called**:
    - [`fd_accdb_spec_drop`](<fd_accdb_ref.h.md#fd_accdb_spec_drop>)


# Function Declarations (Public API)

---
### fd\_accdb\_modify\_prepare<!-- {{#callable_declaration:fd_accdb_modify_prepare}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_sync.h#L65>)

Prepares an account modification by creating a copy of the previous account version.
- **Description**: Use this function to prepare for modifying an account in the database. It creates a copy of the current account state, allowing for modifications. This function must be called before any account modification operations. It handles cases where the account does not exist, is mutable, or is frozen, and it can create a new account if specified. Ensure that the transaction ID is valid and that the account database is properly initialized before calling this function.
- **Inputs**:
    - `accdb`: A pointer to an `fd_accdb_user_t` structure representing the account database. Must not be null. The caller retains ownership.
    - `rw`: A pointer to an `fd_accdb_rw_t` structure used for the modification. Must not be null. The caller retains ownership.
    - `txn_id`: A pointer to a `fd_funk_txn_xid_t` structure representing the transaction ID. Must not be null. The caller retains ownership.
    - `address`: A pointer to the address of the account to modify. Must not be null. The caller retains ownership.
    - `data_min`: An unsigned long specifying the minimum size of the data to be allocated for the account. Must be a valid size value.
    - `do_create`: An integer flag indicating whether to create the account if it does not exist. Non-zero to create, zero otherwise.
- **Output**: Returns a pointer to an `fd_accdb_rw_t` structure if successful, or NULL if the account does not exist and `do_create` is zero.
- **See Also**: [`fd_accdb_modify_prepare`](<fd_accdb_user.c.md#fd_accdb_modify_prepare>)  (Implementation)


---
### fd\_accdb\_write\_publish<!-- {{#callable_declaration:fd_accdb_write_publish}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_sync.h#L86>)

Publishes a previously prepared account write.
- **Description**: Use this function to finalize and publish an account modification that was previously prepared. It must be called after a successful call to `fd_accdb_modify_prepare`. Ensure that the `accdb` structure is in a valid state with an active transaction before calling this function. The function decreases the active read-write reference count in the `accdb` structure. If the write has not been published and the transaction index is at its maximum, the function logs a critical error. This function is intended for use in environments where synchronous blocking APIs are appropriate.
- **Inputs**:
    - `accdb`: A pointer to an `fd_accdb_user_t` structure representing the account database. It must not be null and must have an active transaction.
    - `write`: A pointer to an `fd_accdb_rw_t` structure representing the prepared write. It must not be null and is destroyed after the function call.
- **Output**: None
- **See Also**: [`fd_accdb_write_publish`](<fd_accdb_user.c.md#fd_accdb_write_publish>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)