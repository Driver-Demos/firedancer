<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines account database handle classes and related structures for read-only, read-write, and speculative access.

# Purpose
The `fd_accdb_ref.h` file defines a set of classes and functions for handling account database entries in a C++ application. It provides an abstraction layer between the database and runtime layers, focusing on account database cache entries. The file defines several types of handles: `accdb_ref` as an opaque handle, `accdb_ro` for read-only access, and `accdb_rw` for read-write access. These handles facilitate interaction with account database records, allowing for operations such as reading and writing account data, managing lamports, and setting ownership and execution flags.

Additionally, the file introduces lock guard structures, `accdb_guardr` and `accdb_guardw`, which manage read-only and exclusive locks, respectively. It also includes `accdb_spec`, a speculative read guard that tracks speculative access to shared resources. The file provides inline functions for manipulating account data, such as setting data size, lamports, and owner information. These components are designed to work with the underlying database and runtime systems, abstracting the specifics of the database while offering no runtime protections.
# Imports and Dependencies

---
- `../fd_flamenco_base.h`
- `../../funk/fd_funk_rec.h`
- `../../funk/fd_funk_val.h`


# Data Structures

---
### fd\_accdb\_ref<!-- {{#data_structure:fd_accdb_ref}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_ref.h#L24>)

- **Type**: ``struct``
- **Members**:
    - ``rec_laddr``: Stores the logical address of a record.
    - ``meta_laddr``: Stores the logical address of metadata.
- **Description**: Defines an opaque handle for an account database cache entry, encapsulating logical addresses for both the record and its associated metadata.


---
### fd\_accdb\_ref\_t<!-- {{#data_structure:fd_accdb_ref_t}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_ref.h#L28>)

- **Type**: `struct`
- **Members**:
    - ``rec_laddr``: Stores the logical address of the record.
    - ``meta_laddr``: Stores the logical address of the metadata.
- **Description**: Represents an opaque handle to an account database cache entry, encapsulating the logical addresses of both the record and its associated metadata.


---
### fd\_accdb\_ro<!-- {{#data_structure:fd_accdb_ro}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_ref.h#L32>)

- **Type**: `union`
- **Members**:
    - ``ref``: An array of one `fd_accdb_ref_t` element.
    - ``rec``: A pointer to a constant `fd_funk_rec_t` structure.
    - ``meta``: A pointer to a constant `fd_account_meta_t` structure.
- **Description**: Represents a read-only account database handle, providing access to account record and metadata through a union structure that allows either direct reference or structured access.


---
### fd\_accdb\_ro\_t<!-- {{#data_structure:fd_accdb_ro_t}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_ref.h#L39>)

- **Type**: `union`
- **Members**:
    - ``ref``: An array of one `fd_accdb_ref_t` object.
    - ``rec``: A pointer to a constant `fd_funk_rec_t` object.
    - ``meta``: A pointer to a constant `fd_account_meta_t` object.
- **Description**: Represents a read-only handle to an account database, providing access to account record and metadata through pointers to `fd_funk_rec_t` and `fd_account_meta_t` structures.


---
### fd\_accdb\_rw\_t<!-- {{#data_structure:fd_accdb_rw_t}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_ref.h#L93>)

- **Type**: `union`
- **Members**:
    - ``ref``: An array of one `fd_accdb_ref_t` object.
    - ``ro``: An array of one `fd_accdb_ro_t` object.
    - ``rec``: A pointer to a `fd_funk_rec_t` object.
    - ``meta``: A pointer to a `fd_account_meta_t` object.
    - ``published``: A 1-bit unsigned integer indicating if the record is published.
- **Description**: Represents a writable account database handle that extends both `fd_accdb_ref_t` and `fd_accdb_ro_t`, allowing read and write operations on account database records. It includes pointers to record and metadata structures and a flag to indicate if the record is published. This union is typically used for invisible or in-preparation records, with rare cases allowing direct writes to globally visible records.


---
### fd\_accdb\_guardr\_t<!-- {{#data_structure:fd_accdb_guardr_t}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_ref.h#L180>)

- **Type**: ``struct``
- **Members**:
    - ``rwlock``: A pointer to a read-write lock (`fd_rwlock_t`) that is held as read-only.
- **Description**: Tracks a read-write lock being held in a read-only mode. When this guard object is destroyed, it detaches the caller's thread from the read-write lock, ensuring that the lock is properly released.


---
### fd\_accdb\_guardw<!-- {{#data_structure:fd_accdb_guardw}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_ref.h#L186>)

- **Type**: ``struct``
- **Members**:
    - ``rwlock``: A pointer to a read-write lock (`fd_rwlock_t`) that the guard holds exclusively.
- **Description**: Tracks an exclusive lock on a read-write lock (`rwlock`). When the guard is destroyed, it detaches the thread from the lock, ensuring exclusive access is properly managed and released.


---
### fd\_accdb\_guardw\_t<!-- {{#data_structure:fd_accdb_guardw_t}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_ref.h#L190>)

- **Type**: `struct`
- **Members**:
    - ``rwlock``: A pointer to an `fd_rwlock_t` that represents the lock being held exclusively.
- **Description**: Tracks an `rwlock` being held exclusively, and destroying this guard object detaches the caller's thread from the lock.


---
### fd\_accdb\_spec<!-- {{#data_structure:fd_accdb_spec}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_ref.h#L195>)

- **Type**: ``struct``
- **Members**:
    - ``keyp``: A pointer to a shared key of type `fd_funk_rec_key_t`.
    - ``key``: An expected key of type `fd_funk_rec_key_t`.
- **Description**: Tracks a speculative access to a shared resource by maintaining a pointer to a shared key and an expected key. It is used to verify if the speculative access has not been invalidated by comparing the shared key with the expected key.


---
### fd\_accdb\_spec\_t<!-- {{#data_structure:fd_accdb_spec_t}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_ref.h#L200>)

- **Type**: `struct`
- **Members**:
    - ``keyp``: A pointer to a shared key of type `fd_funk_rec_key_t`.
    - ``key``: An expected key of type `fd_funk_rec_key_t`.
- **Description**: Tracks a speculative access to a shared resource, using a shared key and an expected key to manage access. The structure is used to determine if a speculative access has been invalidated or if it has seen a conflict, such as a torn read or use-after-free. The `fd_accdb_spec_test` function checks the validity of the speculative access, while `fd_accdb_spec_drop` marks the end of the speculative access.


# Functions

---
### fd\_accdb\_ref\_data\_const<!-- {{#callable:fd_accdb_ref_data_const}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_ref.h#L41>)

Returns a pointer to the data section of a read-only account database handle.
- **Inputs**:
    - ``ro``: A pointer to a `fd_accdb_ro_t` structure, representing a read-only account database handle.
- **Logic and Control Flow**:
    - Accesses the `meta` member of the `fd_accdb_ro_t` structure pointed to by `ro`.
    - Calculates the address of the data section by incrementing the `meta` pointer by one.
    - Casts the calculated address to a `void const *` and returns it.
- **Output**: A `void const *` pointer to the data section of the account database handle.


---
### fd\_accdb\_ref\_data\_sz<!-- {{#callable:fd_accdb_ref_data_sz}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_ref.h#L48>)

Returns the size of the data associated with a read-only account database handle.
- **Inputs**:
    - ``ro``: A pointer to a `fd_accdb_ro_t` structure, which is a read-only account database handle.
- **Logic and Control Flow**:
    - Accesses the `meta` member of the `fd_accdb_ro_t` structure pointed to by `ro`.
    - Returns the `dlen` member of the `meta` structure, which represents the size of the data.
- **Output**: The function returns an `ulong` representing the size of the data associated with the read-only account database handle.


---
### fd\_accdb\_ref\_lamports<!-- {{#callable:fd_accdb_ref_lamports}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_ref.h#L53>)

Retrieves the number of lamports from a read-only account database handle.
- **Inputs**:
    - ``ro``: A pointer to a `fd_accdb_ro_t` structure, which is a read-only account database handle.
- **Logic and Control Flow**:
    - Accesses the `meta` member of the `fd_accdb_ro_t` structure pointed to by `ro`.
    - Returns the `lamports` value from the `meta` structure.
- **Output**: The function returns an `ulong` representing the number of lamports in the account.


---
### fd\_accdb\_ref\_owner<!-- {{#callable:fd_accdb_ref_owner}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_ref.h#L58>)

Retrieves the owner information from a read-only account database handle.
- **Inputs**:
    - ``ro``: A pointer to a `fd_accdb_ro_t` structure, representing a read-only account database handle.
- **Logic and Control Flow**:
    - Accesses the `meta` member of the `fd_accdb_ro_t` structure pointed to by `ro`.
    - Returns the `owner` field from the `meta` structure.
- **Output**: A constant pointer to the owner information stored in the `meta` structure of the read-only account database handle.


---
### fd\_accdb\_ref\_exec\_bit<!-- {{#callable:fd_accdb_ref_exec_bit}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_ref.h#L63>)

Returns a boolean indicating if the account is executable.
- **Inputs**:
    - ``ro``: A pointer to a `fd_accdb_ro_t` structure representing a read-only account database handle.
- **Logic and Control Flow**:
    - Accesses the `meta` member of the `ro` structure to retrieve the `executable` field.
    - Converts the `executable` field to a boolean value using the double negation operator `!!`.
    - Returns the boolean value.
- **Output**: A `uint` representing a boolean value: `1` if the account is executable, `0` otherwise.


---
### fd\_accdb\_ref\_slot<!-- {{#callable:fd_accdb_ref_slot}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_ref.h#L68>)

Retrieves the `slot` value from the `meta` field of a read-only account database handle.
- **Inputs**:
    - ``ro``: A pointer to a `fd_accdb_ro_t` structure, which is a read-only account database handle.
- **Logic and Control Flow**:
    - Access the `meta` field of the `ro` structure.
    - Return the `slot` value from the `meta` field.
- **Output**: The function returns an `ulong` representing the `slot` value from the `meta` field of the provided read-only account database handle.


---
### fd\_accdb\_ref\_data\_max<!-- {{#callable:fd_accdb_ref_data_max}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_ref.h#L95>)

Calculates the maximum data size available in an account record by subtracting the size of `fd_account_meta_t` from `rw->rec->val_max` and logs a critical error if an overflow occurs.
- **Inputs**:
    - ``rw``: A pointer to a `fd_accdb_rw_t` structure, which represents a writable account database handle.
- **Logic and Control Flow**:
    - Declare a variable `data_max` of type `ulong`.
    - Check if subtracting `sizeof(fd_account_meta_t)` from `rw->rec->val_max` results in an overflow using `__builtin_usubl_overflow`.
    - If an overflow occurs, log a critical error with the message indicating the invalid `rec->val_max` and the account record pointer.
    - Return the calculated `data_max`.
- **Output**: The function returns the maximum data size (`ulong`) available in the account record.


---
### fd\_accdb\_ref\_data<!-- {{#callable:fd_accdb_ref_data}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_ref.h#L109>)

Returns a pointer to the data section of the account metadata in a writable account database handle.
- **Inputs**:
    - ``rw``: A pointer to a `fd_accdb_rw_t` structure, which is a writable account database handle.
- **Logic and Control Flow**:
    - Access the `meta` member of the `rw` structure, which is a pointer to `fd_account_meta_t`.
    - Increment the `meta` pointer by 1 to skip the metadata header and point to the data section.
    - Cast the resulting pointer to `void *` and return it.
- **Output**: A `void *` pointer to the data section immediately following the metadata in the account database handle.


---
### fd\_accdb\_ref\_data\_set<!-- {{#callable:fd_accdb_ref_data_set}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_ref.h#L114>)

Sets the data in a writable account database handle, ensuring the data size does not exceed the maximum allowed.
- **Inputs**:
    - ``rw``: A pointer to a `fd_accdb_rw_t` structure, representing a writable account database handle.
    - ``data``: A pointer to the data to be set in the account database.
    - ``data_sz``: The size of the data to be set, in bytes.
- **Logic and Control Flow**:
    - Calculate the maximum data size allowed using [`fd_accdb_ref_data_max`](<#fd_accdb_ref_data_max>) with the `rw` handle.
    - Check if `data_sz` exceeds the maximum allowed size (`data_max`).
    - If `data_sz` exceeds `data_max`, log a critical error and terminate the operation.
    - Copy the data from the `data` pointer to the location returned by [`fd_accdb_ref_data`](<#fd_accdb_ref_data>) using `fd_memcpy`.
    - Update the `dlen` field in the `meta` structure of `rw` to the value of `data_sz`.
    - Update the `val_sz` field in the `rec` structure of `rw` to the size of the metadata plus `data_sz`, masked with `FD_FUNK_REC_VAL_MAX-1`.
- **Output**: None (the function modifies the `rw` handle in place).
- **Functions Called**:
    - [`fd_accdb_ref_data_max`](<#fd_accdb_ref_data_max>)
    - [`fd_accdb_ref_data`](<#fd_accdb_ref_data>)


---
### fd\_accdb\_ref\_data\_sz\_set<!-- {{#callable:fd_accdb_ref_data_sz_set}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_ref.h#L128>)

Sets the size of the reference data in a writable account database handle and zeroes out any newly allocated space if the size increases.
- **Inputs**:
    - ``rw``: A pointer to a `fd_accdb_rw_t` structure, representing a writable account database handle.
    - ``data_sz``: An unsigned long integer representing the new size of the reference data.
- **Logic and Control Flow**:
    - Retrieve the current data length from `rw->meta->dlen` and store it in `prev_sz`.
    - If `data_sz` is greater than `prev_sz`, calculate the maximum allowable data size using `fd_accdb_ref_data_max(rw)`.
    - If `data_sz` exceeds the maximum allowable size, log a critical error and terminate the function.
    - Calculate the pointer to the tail of the data and zero out the memory from `prev_sz` to `data_sz`.
    - Update `rw->meta->dlen` to the new `data_sz`.
    - Update `rw->rec->val_sz` to reflect the new total size of the account metadata and data, ensuring it does not exceed `FD_FUNK_REC_VAL_MAX`.
- **Output**: No return value; the function modifies the `rw` structure in place.
- **Functions Called**:
    - [`fd_accdb_ref_data_max`](<#fd_accdb_ref_data_max>)
    - [`fd_accdb_ref_data`](<#fd_accdb_ref_data>)


---
### fd\_accdb\_ref\_lamports\_set<!-- {{#callable:fd_accdb_ref_lamports_set}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_ref.h#L146>)

Sets the `lamports` field in the `meta` structure of a writable account database handle.
- **Inputs**:
    - ``rw``: A pointer to a `fd_accdb_rw_t` structure, which is a writable account database handle.
    - ``lamports``: An unsigned long integer representing the number of lamports to set.
- **Logic and Control Flow**:
    - Access the `meta` field of the `rw` structure.
    - Set the `lamports` field of the `meta` structure to the value of `lamports`.
- **Output**: No return value.


---
### fd\_accdb\_ref\_owner\_set<!-- {{#callable:fd_accdb_ref_owner_set}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_ref.h#L152>)

Sets the owner field in the metadata of a writable account database handle.
- **Inputs**:
    - ``rw``: A pointer to a `fd_accdb_rw_t` structure, representing a writable account database handle.
    - ``owner``: A constant pointer to the owner data to be copied into the metadata.
- **Logic and Control Flow**:
    - Use `memcpy` to copy 32 bytes from the `owner` pointer to the `owner` field in the `meta` structure of the `rw` handle.
- **Output**: None (the function returns void).


---
### fd\_accdb\_ref\_exec\_bit\_set<!-- {{#callable:fd_accdb_ref_exec_bit_set}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_ref.h#L158>)

Sets the executable bit in the metadata of a writable account database handle.
- **Inputs**:
    - ``rw``: A pointer to a `fd_accdb_rw_t` structure, representing a writable account database handle.
    - ``exec_bit``: An unsigned integer representing the new value for the executable bit.
- **Logic and Control Flow**:
    - Access the `meta` member of the `rw` structure.
    - Set the `executable` field of the `meta` structure to the boolean value of `exec_bit`.
- **Output**: None (the function modifies the `rw` structure in place).


---
### fd\_accdb\_ref\_slot\_set<!-- {{#callable:fd_accdb_ref_slot_set}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_ref.h#L164>)

Sets the `slot` value in the `meta` structure of a writable account database handle.
- **Inputs**:
    - ``rw``: A pointer to a `fd_accdb_rw_t` structure, representing a writable account database handle.
    - ``slot``: An unsigned long integer representing the slot value to set.
- **Logic and Control Flow**:
    - Access the `meta` member of the `rw` structure.
    - Set the `slot` member of the `meta` structure to the provided `slot` value.
- **Output**: No return value (void function).


---
### fd\_accdb\_spec\_test<!-- {{#callable:fd_accdb_spec_test}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_ref.h#L207>)

Checks if a speculative access to a shared resource has not been invalidated by comparing keys.
- **Inputs**:
    - ``spec``: A pointer to a `fd_accdb_spec_t` structure containing the shared key and the expected key.
- **Logic and Control Flow**:
    - Retrieve the key from the shared resource using `FD_VOLATILE_CONST` and store it in `key_found`.
    - Compare `key_found` with the expected key in `spec` using `fd_funk_rec_key_eq`.
    - Return 1 if the keys are equal, indicating no invalidation; otherwise, return 0.
- **Output**: An integer value: 1 if the speculative access is valid (no invalidation), or 0 if it may have seen a conflict.


---
### fd\_accdb\_spec\_drop<!-- {{#callable:fd_accdb_spec_drop}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_ref.h#L215>)

Marks the end of a speculative access without requiring central synchronization.
- **Inputs**:
    - ``spec``: A pointer to an `fd_accdb_spec_t` structure representing a speculative access to a shared resource.
- **Logic and Control Flow**:
    - The function takes a pointer to an `fd_accdb_spec_t` structure as input.
    - The function does not perform any operations on the input or produce any side effects.
    - The function does not require central synchronization, so it does not inform the holder of the resource about the drop.
    - The function effectively does nothing with the input, as indicated by the `(void)spec;` statement.
- **Output**: No output is produced.



---
Made with ❤️ by [Driver](https://www.driver.ai/)