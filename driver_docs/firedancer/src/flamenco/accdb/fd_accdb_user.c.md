<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for managing user accounts in a database, including joining, leaving, and modifying accounts.

# Purpose
The code is a C source file that provides functions for managing user accounts in a database system. It includes operations for joining and leaving user accounts, searching and modifying account records, and handling transactions. The file defines several functions that interact with a database structure, `fd_accdb_user_t`, and perform operations such as joining a user to a database ([`fd_accdb_user_join`](<#fd_accdb_user_join>)), leaving a user from a database ([`fd_accdb_user_leave`](<#fd_accdb_user_leave>)), and searching for records within a database chain ([`fd_accdb_search_chain`](<#fd_accdb_search_chain>)). 

The code also includes functions for loading transaction forks ([`fd_accdb_load_fork`](<#fd_accdb_load_fork>) and [`fd_accdb_load_fork_slow`](<#fd_accdb_load_fork_slow>)), preparing accounts for creation or modification ([`fd_accdb_prep_create`](<#fd_accdb_prep_create>) and [`fd_accdb_prep_inplace`](<#fd_accdb_prep_inplace>)), and publishing changes to the database ([`fd_accdb_write_publish`](<#fd_accdb_write_publish>)). The functions use various helper functions and macros, such as `FD_UNLIKELY`, `FD_LOG_CRIT`, and `FD_SPIN_PAUSE`, to handle error logging and control flow. The file appears to be part of a larger system that manages database transactions and account records, with a focus on ensuring data integrity and handling concurrent modifications.
# Imports and Dependencies

---
- `fd_accdb_sync.h`


# Functions

---
### fd\_accdb\_user\_join<!-- {{#callable:fd_accdb_user_join}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_user.c#L3>)

Initializes an `fd_accdb_user_t` structure and joins it to a shared function context.
- **Inputs**:
    - `ljoin`: A pointer to an `fd_accdb_user_t` structure that will be initialized and joined.
    - `shfunk`: A pointer to a shared function context that `ljoin` will join.
- **Logic and Control Flow**:
    - Check if `ljoin` is NULL; if so, log a warning and return NULL.
    - Check if `shfunk` is NULL; if so, log a warning and return NULL.
    - Initialize the memory of `ljoin` to zero using `memset`.
    - Attempt to join `ljoin->funk` to `shfunk` using `fd_funk_join`; if it fails, log a critical error.
    - Return the initialized `ljoin` pointer.
- **Output**: Returns the initialized `fd_accdb_user_t` pointer if successful, or NULL if either input is NULL.


---
### fd\_accdb\_user\_leave<!-- {{#callable:fd_accdb_user_leave}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_user.c#L23>)

Facilitates the departure of a user from a shared resource, ensuring proper cleanup and logging critical errors if necessary.
- **Inputs**:
    - ``user``: A pointer to an `fd_accdb_user_t` structure representing the user to be removed from the shared resource.
    - ``opt_shfunk``: An optional pointer to a shared function or resource that may be affected by the user's departure.
- **Logic and Control Flow**:
    - Check if `user` is NULL; if so, log a critical error and terminate the program.
    - Attempt to leave the shared resource using `fd_funk_leave` with `user->funk` and `opt_shfunk`; if this fails, log a critical error and terminate the program.
    - Return the `user` pointer.
- **Output**: Returns the `user` pointer after attempting to leave the shared resource.


---
### fd\_accdb\_has\_xid<!-- {{#callable:fd_accdb_has_xid}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_user.c#L33>)

Checks if a given transaction ID exists in the account database's fork.
- **Inputs**:
    - ``accdb``: A pointer to a `fd_accdb_user_t` structure representing the account database user.
    - ``rec_xid``: A pointer to a `fd_funk_txn_xid_t` structure representing the transaction ID to check for.
- **Logic and Control Flow**:
    - Retrieve the `fork_depth` from the `accdb` structure.
    - Iterate over the `fork` array in the `accdb` structure up to `fork_depth`.
    - For each element in the `fork` array, check if it equals `rec_xid` using the `fd_funk_txn_xid_eq` function.
    - If a match is found, return 1.
    - If no match is found after the loop, return 0.
- **Output**: Returns 1 if the transaction ID is found in the fork, otherwise returns 0.


---
### fd\_accdb\_search\_chain<!-- {{#callable:fd_accdb_search_chain}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_user.c#L44>)

Searches a specified chain in the account database for a record matching a given key and returns the record if found.
- **Inputs**:
    - ``accdb``: A pointer to a constant `fd_accdb_user_t` structure representing the account database to search.
    - ``chain_idx``: An unsigned long integer representing the index of the chain to search within the account database.
    - ``key``: A pointer to a constant `fd_funk_rec_key_t` structure representing the key of the record to search for.
    - ``out_rec``: A pointer to a pointer to `fd_funk_rec_t` where the function will store the address of the found record, if any.
- **Logic and Control Flow**:
    - Initialize `*out_rec` to `NULL` to indicate no record found initially.
    - Retrieve the shared memory map and chain table from the account database.
    - Calculate the version count of the chain and check if the chain is locked; if locked, return `FD_MAP_ERR_AGAIN`.
    - Iterate over the records in the chain, checking if each record's key matches the given key and if it belongs to the current fork.
    - If a matching record is found, set `best` to this record and break the loop.
    - Check for chain version changes during the search; if detected, return `FD_MAP_ERR_AGAIN`.
    - Set `*out_rec` to the best matching record found, if any, and return `FD_MAP_SUCCESS`.
- **Output**: Returns `FD_MAP_SUCCESS` if a matching record is found and `FD_MAP_ERR_AGAIN` if the chain is locked or if a version change is detected during the search.
- **Functions Called**:
    - [`fd_accdb_has_xid`](<#fd_accdb_has_xid>)


---
### fd\_accdb\_load\_fork\_slow<!-- {{#callable:fd_accdb_load_fork_slow}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_user.c#L102>)

Traverses a transaction graph to load a fork into the account database, handling overruns and setting the fork depth and tip transaction index.
- **Inputs**:
    - ``accdb``: A pointer to an `fd_accdb_user_t` structure representing the account database user.
    - ``xid``: A pointer to a `fd_funk_txn_xid_t` structure representing the transaction ID to start loading the fork from.
- **Logic and Control Flow**:
    - Initialize `next_xid` with the value pointed to by `xid` and set `accdb->fork_depth` to 0.
    - Determine the maximum number of transactions using `fd_funk_txn_pool_ele_max`.
    - Iterate up to `FD_ACCDB_DEPTH_MAX` times to traverse the transaction graph.
    - In each iteration, attempt to query the transaction map with `fd_funk_txn_map_query_try`.
    - If the query returns `FD_MAP_ERR_AGAIN`, pause and retry; if it returns `FD_MAP_ERR_KEY`, exit the loop.
    - If the query is successful, retrieve the candidate transaction and its parent index.
    - Verify the transaction still exists in the map with `fd_funk_txn_map_query_test`; if not, retry the query.
    - Check for memory corruption by comparing `found_xid` with `next_xid`.
    - Store `next_xid` in `accdb->fork` and update `next_xid` to `parent_xid` if the parent index is not null.
    - If the parent index is null, increment `i` and break the loop, indicating the root is reached.
    - Set `accdb->fork_depth` to `i` and ensure the fork depth does not exceed `FD_ACCDB_DEPTH_MAX`.
    - Set the root transaction ID in the fork if the fork depth is less than `FD_ACCDB_DEPTH_MAX`.
    - Query the tip transaction using `fd_funk_txn_query` and set `accdb->tip_txn_idx` accordingly.
    - If the tip transaction is found, assert its state is active with `fd_funk_txn_state_assert`.
- **Output**: No return value; modifies the `accdb` structure in place.


---
### fd\_accdb\_load\_fork<!-- {{#callable:fd_accdb_load_fork}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_user.c#L189>)

Switches the account database to a different transaction fork if necessary.
- **Inputs**:
    - ``accdb``: A pointer to an `fd_accdb_user_t` structure representing the account database user.
    - ``xid``: A pointer to a `fd_funk_txn_xid_t` structure representing the transaction ID to switch to.
- **Logic and Control Flow**:
    - Checks if the current fork is already the correct one by comparing `accdb->fork[0]` with `xid` and returns immediately if true.
    - Logs a critical error if there is an active read/write operation (`accdb->rw_active` is true) and the requested `xid` does not match the active one.
    - Calls [`fd_accdb_load_fork_slow`](<#fd_accdb_load_fork_slow>) to switch to the correct fork if the current fork is not correct.
- **Output**: No output is returned as the function is of type `void`.
- **Functions Called**:
    - [`fd_accdb_load_fork_slow`](<#fd_accdb_load_fork_slow>)


---
### fd\_accdb\_peek1<!-- {{#callable:fd_accdb_peek1}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_user.c#L202>)

Retrieves a record from the account database based on a transaction ID and address, and populates a peek structure with the record's details.
- **Inputs**:
    - ``accdb``: A pointer to an `fd_accdb_user_t` structure representing the account database user context.
    - ``peek``: A pointer to an `fd_accdb_peek_t` structure where the function will store the retrieved record details.
    - ``xid``: A constant pointer to an `fd_funk_txn_xid_t` structure representing the transaction ID to search for.
    - ``address``: A constant pointer to a memory location containing the address to search for in the database.
- **Logic and Control Flow**:
    - Copy the `address` into a `fd_funk_rec_key_t` structure named `key`.
    - Create a `fd_funk_xid_key_pair_t` structure named `pair` and copy `xid` and `key` into it.
    - Calculate a hash value for `pair` using the seed from the record map and determine the chain index by applying a mask with the chain count minus one.
    - Enter a loop to search the chain at the calculated index for a record matching `key`.
    - Call [`fd_accdb_search_chain`](<#fd_accdb_search_chain>) to find the record; if successful, break the loop, otherwise pause and retry.
    - If no record is found, return `NULL`.
    - If a record is found, populate the `peek` structure with the record and its metadata, then return `peek`.
- **Output**: A pointer to the `fd_accdb_peek_t` structure containing the record details, or `NULL` if no record is found.
- **Functions Called**:
    - [`fd_accdb_search_chain`](<#fd_accdb_search_chain>)


---
### fd\_accdb\_peek<!-- {{#callable:fd_accdb_peek}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_user.c#L241>)

Retrieves a record from the account database based on a transaction ID and address.
- **Inputs**:
    - ``accdb``: A pointer to an `fd_accdb_user_t` structure representing the account database user.
    - ``peek``: A pointer to an `fd_accdb_peek_t` structure where the result will be stored.
    - ``xid``: A constant pointer to an `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``address``: A constant pointer to a memory address used to identify the record.
- **Logic and Control Flow**:
    - Checks if `accdb` is NULL or if its `funk->shmem` is NULL, and logs a critical error if so.
    - Calls [`fd_accdb_load_fork`](<#fd_accdb_load_fork>) to ensure the account database is on the correct fork for the given transaction ID.
    - Calls [`fd_accdb_peek1`](<#fd_accdb_peek1>) to retrieve the record associated with the given transaction ID and address, and returns the result.
- **Output**: Returns a pointer to an `fd_accdb_peek_t` structure containing the retrieved record, or NULL if the record is not found.
- **Functions Called**:
    - [`fd_accdb_load_fork`](<#fd_accdb_load_fork>)
    - [`fd_accdb_peek1`](<#fd_accdb_peek1>)


---
### fd\_accdb\_copy\_account<!-- {{#callable:fd_accdb_copy_account}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_user.c#L251>)

Copies account metadata and data from a read-only account reference to specified output locations.
- **Inputs**:
    - ``out_meta``: A pointer to `fd_account_meta_t` where the function will store the copied account metadata.
    - ``out_data``: A pointer to a memory location where the function will store the copied account data.
    - ``acc``: A constant pointer to `fd_accdb_ro_t` representing the read-only account reference from which data is copied.
- **Logic and Control Flow**:
    - Initialize `out_meta` to zero using `memset`.
    - Retrieve the number of lamports from `acc` and store it in `out_meta->lamports`.
    - If `out_meta->lamports` is non-zero, proceed to copy additional data.
    - Copy the account owner from `acc` to `out_meta->owner` using `memcpy`.
    - Set `out_meta->executable` based on the executable bit from `acc`.
    - Retrieve the data size from `acc` and store it in `out_meta->dlen`.
    - Copy the account data from `acc` to `out_data` using `fd_memcpy` with the size `out_meta->dlen`.
- **Output**: No return value; the function modifies the contents of `out_meta` and `out_data` directly.
- **Functions Called**:
    - [`fd_accdb_ref_lamports`](<fd_accdb_ref.h.md#fd_accdb_ref_lamports>)
    - [`fd_accdb_ref_owner`](<fd_accdb_ref.h.md#fd_accdb_ref_owner>)
    - [`fd_accdb_ref_exec_bit`](<fd_accdb_ref.h.md#fd_accdb_ref_exec_bit>)
    - [`fd_accdb_ref_data_sz`](<fd_accdb_ref.h.md#fd_accdb_ref_data_sz>)
    - [`fd_accdb_ref_data_const`](<fd_accdb_ref.h.md#fd_accdb_ref_data_const>)


---
### fd\_accdb\_prep\_create<!-- {{#callable:fd_accdb_prep_create}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_user.c#L268>)

Prepares a writable handle for a newly created account in the database.
- **Inputs**:
    - `rw`: A pointer to `fd_accdb_rw_t` where the function will store the writable handle.
    - `accdb`: A pointer to `fd_accdb_user_t` representing the account database user context.
    - `xid`: A constant pointer to `fd_funk_txn_xid_t` representing the transaction ID.
    - `address`: A constant pointer to a memory location representing the account address.
    - `val`: A pointer to a memory location where the account's value is stored.
    - `val_sz`: An unsigned long representing the size of the account's value.
    - `val_max`: An unsigned long representing the maximum size of the account's value.
- **Logic and Control Flow**:
    - Acquire a new record from the record pool using `fd_funk_rec_pool_acquire`.
    - If the record acquisition fails, log a critical error and terminate.
    - Initialize the acquired record with zero values using `memset`.
    - Set the record's value global address using `fd_wksp_gaddr_fast`.
    - Set the record's value size and maximum size using `fd_ulong_min` and bitwise operations.
    - Copy the account address into the record's key using `memcpy`.
    - Copy the transaction ID into the record's XID using `fd_funk_txn_xid_copy`.
    - Initialize the record's tag, previous index, and next index to zero or null values.
    - Set the slot in the account metadata to the first element of the transaction ID.
    - Increment the active writable handle count in the account database user context.
    - Initialize the writable handle with the record, metadata, and a published flag set to zero.
    - Return the pointer to the writable handle.
- **Output**: Returns a pointer to `fd_accdb_rw_t` representing the prepared writable handle.


---
### fd\_accdb\_prep\_inplace<!-- {{#callable:fd_accdb_prep_inplace}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_user.c#L303>)

Prepares a writable handle for a mutable record in an account database.
- **Inputs**:
    - `rw`: A pointer to an `fd_accdb_rw_t` structure where the function will store the prepared writable handle.
    - `accdb`: A pointer to an `fd_accdb_user_t` structure representing the account database user context.
    - `rec`: A pointer to an `fd_funk_rec_t` structure representing the record to be prepared for in-place modification.
- **Logic and Control Flow**:
    - Checks if the `rec` has a valid `val_gaddr`; logs a critical error if not.
    - Increments the `rw_active` counter in the `accdb` structure to indicate an active writable operation.
    - Initializes the `rw` structure with the `rec`, its metadata obtained via `fd_funk_val`, and sets `published` to 1.
    - Checks if the `lamports` field in the `rw->meta` is zero; if so, it zeroes out the `rw->meta` structure.
- **Output**: Returns a pointer to the prepared `fd_accdb_rw_t` structure.


---
### fd\_accdb\_modify\_prepare<!-- {{#callable:fd_accdb_modify_prepare}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_user.c#L324>)

Prepares a writable handle for modifying an account record in a database, handling cases for mutable, frozen, or non-existent records.
- **Inputs**:
    - `accdb`: A pointer to the `fd_accdb_user_t` structure representing the account database user context.
    - `rw`: A pointer to the `fd_accdb_rw_t` structure where the prepared writable handle will be stored.
    - `xid`: A constant pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID for the operation.
    - `address`: A constant pointer to the address of the account record to be modified.
    - `data_min`: An unsigned long integer specifying the minimum size of the data to be allocated for the account record.
    - `do_create`: An integer flag indicating whether to create a new record if the specified account does not exist (non-zero to create, zero otherwise).
- **Logic and Control Flow**:
    - Load the transaction fork associated with the given `xid` using [`fd_accdb_load_fork`](<#fd_accdb_load_fork>).
    - Check if the transaction index `txn_idx` is valid and not rooted or corrupted.
    - Retrieve the transaction from the transaction pool and verify its `xid` matches the provided `xid`.
    - Check if the transaction is frozen, logging a critical error if it is.
    - Attempt to peek at the existing record using [`fd_accdb_peek1`](<#fd_accdb_peek1>).
    - If the record is not found and `do_create` is false, return `NULL`.
    - If the record is not found and `do_create` is true, allocate memory for a new record, initialize it, and prepare it for creation using [`fd_accdb_prep_create`](<#fd_accdb_prep_create>).
    - If a mutable record is found, modify it in-place using [`fd_accdb_prep_inplace`](<#fd_accdb_prep_inplace>).
    - If a frozen record is found, copy it to a new object, zero out trailing data if necessary, and prepare it for creation using [`fd_accdb_prep_create`](<#fd_accdb_prep_create>).
- **Output**: Returns a pointer to the `fd_accdb_rw_t` structure containing the prepared writable handle, or `NULL` if the record is not found and `do_create` is false.
- **Functions Called**:
    - [`fd_accdb_load_fork`](<#fd_accdb_load_fork>)
    - [`fd_accdb_peek1`](<#fd_accdb_peek1>)
    - [`fd_accdb_prep_create`](<#fd_accdb_prep_create>)
    - [`fd_accdb_ref_data_sz`](<fd_accdb_ref.h.md#fd_accdb_ref_data_sz>)
    - [`fd_accdb_prep_inplace`](<#fd_accdb_prep_inplace>)
    - [`fd_accdb_copy_account`](<#fd_accdb_copy_account>)
    - [`fd_accdb_peek_test`](<fd_accdb_sync.h.md#fd_accdb_peek_test>)


---
### fd\_accdb\_write\_publish<!-- {{#callable:fd_accdb_write_publish}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_user.c#L412>)

Publishes a write operation to the account database if it is not already published and decrements the active reference count.
- **Inputs**:
    - ``accdb``: A pointer to an `fd_accdb_user_t` structure representing the account database user.
    - ``write``: A pointer to an `fd_accdb_rw_t` structure representing the write operation to be published.
- **Logic and Control Flow**:
    - Check if `accdb->rw_active` is zero and log a critical error if true, indicating a reference count underflow.
    - Check if `write->published` is false, indicating the write operation is not yet published.
    - If the write is not published, check if `accdb->tip_txn_idx` is `ULONG_MAX` and log a critical error if true, indicating the user is not joined to a transaction.
    - Retrieve the transaction from the transaction pool using `accdb->tip_txn_idx`.
    - Prepare the record for publishing by setting up a `fd_funk_rec_prepare_t` structure with the record and transaction indices.
    - Call `fd_funk_rec_publish` to publish the record to the database.
    - Decrement `accdb->rw_active` to reflect the completion of the write operation.
- **Output**: No return value; the function modifies the state of the account database and the write operation.



---
Made with ❤️ by [Driver](https://www.driver.ai/)