<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for managing and manipulating transactions and records in a database administration context.

# Purpose
The code is a C module that manages transaction operations within a database-like system. It provides functions to join and leave an administrative context ([`fd_accdb_admin_join`](<#fd_accdb_admin_join>) and [`fd_accdb_admin_leave`](<#fd_accdb_admin_leave>)), manage transactions, and handle transaction states such as canceling, publishing, and advancing the root transaction. The module operates on data structures related to transactions (`fd_funk_txn_t`) and records (`fd_funk_rec_t`), ensuring that operations are performed safely and consistently, with logging for critical errors and warnings.

The module includes functions for transaction-level operations, such as attaching child transactions ([`fd_accdb_attach_child`](<#fd_accdb_attach_child>)), canceling transactions and their children ([`fd_accdb_txn_cancel_tree`](<#fd_accdb_txn_cancel_tree>)), and publishing transactions ([`fd_accdb_txn_publish_one`](<#fd_accdb_txn_publish_one>)). It also provides mechanisms to clear all transactions and records ([`fd_accdb_clear`](<#fd_accdb_clear>)) and verify the integrity of the transaction system ([`fd_accdb_verify`](<#fd_accdb_verify>)). The code is designed to be part of a larger system, likely interacting with other components through defined interfaces and data structures, and it includes error handling and logging to maintain system stability and traceability.
# Imports and Dependencies

---
- `fd_accdb_admin.h`


# Functions

---
### fd\_accdb\_admin\_join<!-- {{#callable:fd_accdb_admin_join}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_admin.c#L3>)

Initializes an `fd_accdb_admin_t` structure and joins it with a shared function object.
- **Inputs**:
    - `ljoin`: A pointer to an `fd_accdb_admin_t` structure to initialize and join.
    - `shfunk`: A pointer to a shared function object to join with the `fd_accdb_admin_t` structure.
- **Logic and Control Flow**:
    - Check if `ljoin` is NULL; if true, log a warning and return NULL.
    - Check if `shfunk` is NULL; if true, log a warning and return NULL.
    - Initialize the memory of `ljoin` to zero using `memset`.
    - Attempt to join `ljoin->funk` with `shfunk` using `fd_funk_join`; if it fails, log a critical error.
    - Return the initialized and joined `ljoin` structure.
- **Output**: Returns a pointer to the initialized and joined `fd_accdb_admin_t` structure, or NULL if an input is invalid.


---
### fd\_accdb\_admin\_leave<!-- {{#callable:fd_accdb_admin_leave}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_admin.c#L23>)

Leaves the `fd_accdb_admin_t` instance by calling `fd_funk_leave` and returns the `admin` pointer.
- **Inputs**:
    - `admin`: A pointer to an `fd_accdb_admin_t` structure that represents the admin instance to leave.
    - `opt_shfunk`: An optional pointer to a `void*` that may be used by `fd_funk_leave`.
- **Logic and Control Flow**:
    - Check if `admin` is NULL; if so, log a critical error and terminate.
    - Call `fd_funk_leave` with `admin->funk` and `opt_shfunk`; if it fails, log a critical error and terminate.
    - Return the `admin` pointer.
- **Output**: Returns the `admin` pointer if successful.


---
### fd\_accdb\_attach\_child<!-- {{#callable:fd_accdb_attach_child}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_admin.c#L37>)

Attaches a new transaction as a child to a parent transaction in the database.
- **Inputs**:
    - ``db``: A pointer to the `fd_accdb_admin_t` structure representing the database.
    - ``xid_parent``: A pointer to the `fd_funk_txn_xid_t` structure representing the parent transaction ID.
    - ``xid_new``: A pointer to the `fd_funk_txn_xid_t` structure representing the new transaction ID to be attached as a child.
- **Logic and Control Flow**:
    - Logs the creation of a new transaction with its parent transaction IDs.
    - Calls `fd_funk_txn_prepare` to prepare the new transaction as a child of the parent transaction in the database.
- **Output**: No return value; the function operates by side effects on the database.


---
### fd\_accdb\_txn\_cancel\_one<!-- {{#callable:fd_accdb_txn_cancel_one}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_admin.c#L47>)

Cancels a transaction by changing its state, detaching and removing its records, and removing it from the transaction graph and index.
- **Inputs**:
    - ``admin``: A pointer to an `fd_accdb_admin_t` structure, which contains the administrative context for the transaction.
    - ``txn``: A pointer to an `fd_funk_txn_t` structure, representing the transaction to be canceled.
- **Logic and Control Flow**:
    - Logs the cancellation attempt with transaction details.
    - Checks if the transaction state is active; if not, logs a critical error.
    - Checks if the transaction has child transactions; if so, logs a critical error.
    - Locks the transaction for writing and sets its state to cancel.
    - Detaches all records from the transaction by setting head and tail indices to null.
    - Iterates over each record, verifies ownership, removes it from the map, marks it as invalid, and frees it.
    - Logs the number of records freed during cancellation.
    - Removes the transaction from the fork graph by updating sibling and parent pointers.
    - Removes the transaction from the transaction index, logging an error if removal fails.
    - Frees the transaction object by resetting its indices and state, and releasing it back to the pool.
- **Output**: No return value; the function operates by modifying the transaction and administrative structures directly.


---
### fd\_accdb\_txn\_cancel\_tree<!-- {{#callable:fd_accdb_txn_cancel_tree}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_admin.c#L157>)

Cancels a transaction and all its child transactions recursively.
- **Inputs**:
    - ``accdb``: A pointer to the `fd_accdb_admin_t` structure, which manages the transaction database.
    - ``txn``: A pointer to the `fd_funk_txn_t` structure representing the transaction to cancel.
- **Logic and Control Flow**:
    - Enter an infinite loop to process child transactions.
    - Retrieve the index of the first child transaction using `fd_funk_txn_idx` on `txn->child_head_cidx`.
    - Check if the child index is null using `fd_funk_txn_idx_is_null`; if true, exit the loop.
    - If not null, retrieve the child transaction from the transaction pool using the child index.
    - Recursively call `fd_accdb_txn_cancel_tree` to cancel the child transaction and its descendants.
    - After processing all children, call [`fd_accdb_txn_cancel_one`](<#fd_accdb_txn_cancel_one>) to cancel the current transaction.
- **Output**: No return value; the function operates by side effects on the transaction database.
- **Functions Called**:
    - [`fd_accdb_txn_cancel_one`](<#fd_accdb_txn_cancel_one>)


---
### fd\_accdb\_txn\_cancel\_prev\_list<!-- {{#callable:fd_accdb_txn_cancel_prev_list}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_admin.c#L171>)

Cancels all previous sibling transactions of a given transaction in a fork graph.
- **Inputs**:
    - ``accdb``: A pointer to an `fd_accdb_admin_t` structure, which manages the transaction database.
    - ``txn``: A pointer to an `fd_funk_txn_t` structure, representing the transaction whose previous siblings are to be canceled.
- **Logic and Control Flow**:
    - Calculate the index of the current transaction (`self_idx`) in the transaction pool.
    - Enter a loop to process each previous sibling transaction.
    - Retrieve the index of the previous sibling transaction (`prev_idx`) using `fd_funk_txn_idx` and `txn->sibling_prev_cidx`.
    - Check for a cycle in the fork graph by comparing `prev_idx` with `self_idx`. If a cycle is detected, log a critical error and terminate.
    - If `prev_idx` is null, exit the loop as there are no more previous siblings.
    - Retrieve the previous sibling transaction from the transaction pool using `prev_idx`.
    - Call [`fd_accdb_txn_cancel_tree`](<#fd_accdb_txn_cancel_tree>) to cancel the previous sibling transaction and its children.
- **Output**: No direct output; the function modifies the state of transactions in the transaction pool by canceling previous siblings.
- **Functions Called**:
    - [`fd_accdb_txn_cancel_tree`](<#fd_accdb_txn_cancel_tree>)


---
### fd\_accdb\_txn\_cancel\_next\_list<!-- {{#callable:fd_accdb_txn_cancel_next_list}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_admin.c#L184>)

Cancels all right siblings of a given transaction in a fork graph.
- **Inputs**:
    - ``accdb``: A pointer to the `fd_accdb_admin_t` structure, which manages the transaction database.
    - ``txn``: A pointer to the `fd_funk_txn_t` structure representing the transaction whose right siblings are to be canceled.
- **Logic and Control Flow**:
    - Calculate the index of the current transaction (`self_idx`) in the transaction pool.
    - Enter an infinite loop to process each right sibling of the transaction.
    - Retrieve the index of the next sibling (`next_idx`) using `fd_funk_txn_idx` on `txn->sibling_next_cidx`.
    - Check if `next_idx` is equal to `self_idx`, indicating a cycle in the fork graph, and log a critical error if so.
    - Break the loop if `next_idx` is null, indicating no more siblings.
    - Retrieve the sibling transaction from the transaction pool using `next_idx`.
    - Call [`fd_accdb_txn_cancel_tree`](<#fd_accdb_txn_cancel_tree>) to cancel the sibling transaction and its children.
- **Output**: No return value; the function operates by side effects on the transaction database.
- **Functions Called**:
    - [`fd_accdb_txn_cancel_tree`](<#fd_accdb_txn_cancel_tree>)


---
### fd\_accdb\_cancel<!-- {{#callable:fd_accdb_cancel}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_admin.c#L197>)

Cancels a transaction and its related transactions in the database.
- **Inputs**:
    - ``accdb``: A pointer to the `fd_accdb_admin_t` structure representing the database administration context.
    - ``xid``: A pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID to be canceled.
- **Logic and Control Flow**:
    - Retrieve the `fd_funk_t` instance from the `accdb` structure.
    - Query the transaction using `xid` from the transaction map in `funk`.
    - If the transaction is not found, log a critical error and exit.
    - Call [`fd_accdb_txn_cancel_next_list`](<#fd_accdb_txn_cancel_next_list>) to cancel all right siblings of the transaction.
    - Call [`fd_accdb_txn_cancel_tree`](<#fd_accdb_txn_cancel_tree>) to cancel the transaction and all its child transactions.
- **Output**: No return value; the function performs operations directly on the database context.
- **Functions Called**:
    - [`fd_accdb_txn_cancel_next_list`](<#fd_accdb_txn_cancel_next_list>)
    - [`fd_accdb_txn_cancel_tree`](<#fd_accdb_txn_cancel_tree>)


---
### fd\_accdb\_chain\_gc\_root<!-- {{#callable:fd_accdb_chain_gc_root}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_admin.c#L214>)

Cleans up a stale 'rooted' version of a record in the database.
- **Inputs**:
    - ``accdb``: A pointer to an `fd_accdb_admin_t` structure, representing the database administration context.
    - ``pair``: A constant pointer to an `fd_funk_xid_key_pair_t` structure, representing the key pair of the record to be cleaned up.
- **Logic and Control Flow**:
    - Retrieve the `fd_funk_t` instance from the `accdb` structure.
    - Attempt to remove the record from the map using `fd_funk_rec_map_remove`.
    - If the record is not found (`rm_err==FD_MAP_ERR_KEY`), exit the function.
    - If the removal fails for any other reason, log a critical error and exit.
    - Invalidate the record by setting its `pair` field to zero and ensuring memory consistency with `FD_COMPILER_MFENCE`.
    - Set the `map_next` field of the record to `FD_FUNK_REC_IDX_NULL`.
    - Flush the record's value using `fd_funk_val_flush`.
    - Release the record back to the pool using `fd_funk_rec_pool_release`.
- **Output**: No output is returned; the function performs cleanup operations on the record.


---
### fd\_accdb\_publish\_recs<!-- {{#callable:fd_accdb_publish_recs}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_admin.c#L246>)

Moves all records in a transaction to the database root by iterating through the transaction's record list and updating each record's state and position.
- **Inputs**:
    - ``accdb``: A pointer to the `fd_accdb_admin_t` structure, representing the database administration context.
    - ``txn``: A pointer to the `fd_funk_txn_t` structure, representing the transaction whose records are to be published to the root.
- **Logic and Control Flow**:
    - Initialize `head` with the index of the first record in the transaction's record list.
    - Set the transaction's `rec_head_idx` and `rec_tail_idx` to `FD_FUNK_REC_IDX_NULL` to detach the record list from the transaction.
    - Iterate through the record list using `head` as the current record index.
    - For each record, retrieve the record from the record pool using the current index `head`.
    - Copy the record's key to a temporary `fd_funk_xid_key_pair_t` structure and set its `xid` to root.
    - Call [`fd_accdb_chain_gc_root`](<#fd_accdb_chain_gc_root>) to clean up any previous version of the record in the hash chain.
    - Update the record's `prev_idx` and `next_idx` to `FD_FUNK_REC_IDX_NULL` to detach it from the list.
    - Set the record's `xid` to root using `fd_funk_txn_xid_st_atomic`.
    - Move to the next record in the list by updating `head` to the current record's `next_idx`.
- **Output**: No direct output is returned from this function; it modifies the state of the records and the transaction in the database context.
- **Functions Called**:
    - [`fd_accdb_chain_gc_root`](<#fd_accdb_chain_gc_root>)


---
### fd\_accdb\_txn\_publish\_one<!-- {{#callable:fd_accdb_txn_publish_one}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_admin.c#L276>)

Publishes a transaction by marking it as the last published, migrating its records, and removing it from the transaction graph and index.
- **Inputs**:
    - ``accdb``: A pointer to the `fd_accdb_admin_t` structure, which manages the database context.
    - ``txn``: A pointer to the `fd_funk_txn_t` structure, representing the transaction to be published.
- **Logic and Control Flow**:
    - Copy the transaction ID (`xid`) and check if the transaction's parent is the last published transaction; log a critical error if not.
    - Set the transaction as the last published in shared memory and log the publishing event.
    - Acquire a write lock on the transaction and set its state to `FD_FUNK_TXN_STATE_PUBLISH`.
    - Call [`fd_accdb_publish_recs`](<#fd_accdb_publish_recs>) to migrate all records from the transaction to the database root.
    - Adjust the parent pointers of the transaction's children to point to `FD_FUNK_TXN_IDX_NULL`, effectively removing the transaction from the fork graph.
    - Remove the transaction from the transaction index using `fd_funk_txn_map_remove`; log a critical error if removal fails.
    - Release the write lock, set the transaction state to `FD_FUNK_TXN_STATE_FREE`, and reset all child and sibling indices to `UINT_MAX`.
    - Release the transaction object back to the transaction pool.
- **Output**: No return value; the function operates by side effects on the transaction and database structures.
- **Functions Called**:
    - [`fd_accdb_publish_recs`](<#fd_accdb_publish_recs>)


---
### fd\_accdb\_advance\_root<!-- {{#callable:fd_accdb_advance_root}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_admin.c#L336>)

Advances a transaction to become the root in the transaction graph, updating its children and canceling its siblings.
- **Inputs**:
    - ``accdb``: A pointer to an `fd_accdb_admin_t` structure representing the database administration context.
    - ``xid``: A pointer to a `fd_funk_txn_xid_t` structure representing the transaction ID to advance to root.
- **Logic and Control Flow**:
    - Query the transaction using `xid` from the transaction map in `funk`.
    - If the transaction is not found, log a critical error and exit.
    - Check if the transaction's parent is not null; if it is not null, log a critical error and exit.
    - Log an informational message indicating the transaction is advancing to root.
    - Cancel all previous and next sibling transactions using [`fd_accdb_txn_cancel_prev_list`](<#fd_accdb_txn_cancel_prev_list>) and [`fd_accdb_txn_cancel_next_list`](<#fd_accdb_txn_cancel_next_list>).
    - Set the transaction's `sibling_prev_cidx` and `sibling_next_cidx` to `UINT_MAX`.
    - Update the root's child head and tail indices to the transaction's child head and tail indices.
    - Publish the transaction using [`fd_accdb_txn_publish_one`](<#fd_accdb_txn_publish_one>).
- **Output**: None (void function).
- **Functions Called**:
    - [`fd_accdb_txn_cancel_prev_list`](<#fd_accdb_txn_cancel_prev_list>)
    - [`fd_accdb_txn_cancel_next_list`](<#fd_accdb_txn_cancel_next_list>)
    - [`fd_accdb_txn_publish_one`](<#fd_accdb_txn_publish_one>)


---
### reset\_rec\_map<!-- {{#callable:reset_rec_map}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_admin.c#L368>)

Frees all records in a `fd_funk_t` instance by iterating through the record map and releasing resources.
- **Inputs**:
    - `funk`: A pointer to a `fd_funk_t` structure containing the workspace, allocator, record map, and record pool to be reset.
- **Logic and Control Flow**:
    - Retrieve the workspace, allocator, record map, and record pool from the `funk` structure.
    - Determine the number of chains in the record map using `fd_funk_rec_map_chain_cnt`.
    - Iterate over each chain in the record map.
    - For each chain, initialize an iterator using `fd_funk_rec_map_iter`.
    - While the iterator is not done, perform the following steps:
    - Retrieve the current record using `fd_funk_rec_map_iter_ele`.
    - Get the index of the next record using `fd_funk_rec_map_private_idx`.
    - Remove the current record from the map using `fd_funk_rec_map_remove`.
    - If removal fails, log a critical error and exit.
    - Reset the record's `map_next`, `next_idx`, and `prev_idx` to `FD_FUNK_REC_IDX_NULL`.
    - Clear the record's key pair using `memset`.
    - Flush the record's value using `fd_funk_val_flush`.
    - Release the record back to the pool using `fd_funk_rec_pool_release`.
    - Update the iterator to point to the next record.
- **Output**: No return value; the function operates directly on the `fd_funk_t` structure to free resources.


---
### clear\_txn\_list<!-- {{#callable:clear_txn_list}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_admin.c#L405>)

Performs a depth-first traversal of a transaction tree to remove all transactions.
- **Inputs**:
    - ``funk``: A pointer to a `fd_funk_t` structure that contains the transaction pool and map.
    - ``txn_head_idx``: The index of the head transaction in the transaction pool to start clearing from.
- **Logic and Control Flow**:
    - Initialize `txn_pool` and `txn_map` from `funk`.
    - Iterate over transactions starting from `txn_head_idx` until a null index is encountered.
    - For each transaction, assert that it is in the active state.
    - Retrieve the next sibling and child transaction indices.
    - Set the transaction's record indices and child/sibling indices to null or maximum values.
    - Recursively call `clear_txn_list` for the child transaction index.
    - Remove the transaction from the transaction map and log a critical error if removal fails.
    - Set the transaction state to free and release it from the transaction pool, logging a critical error if release fails.
    - Update the index to the next sibling transaction index.
    - After the loop, set the shared memory's child head and tail indices to maximum values.
- **Output**: No return value; the function modifies the transaction pool and map to remove transactions.


---
### fd\_accdb\_clear<!-- {{#callable:fd_accdb_clear}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_admin.c#L437>)

Clears all transactions and records from the given `fd_accdb_admin_t` cache.
- **Inputs**:
    - ``cache``: A pointer to an `fd_accdb_admin_t` structure representing the cache to clear.
- **Logic and Control Flow**:
    - Retrieve the `fd_funk_t` instance from the `cache`.
    - Call [`clear_txn_list`](<#clear_txn_list>) to remove all transactions starting from the head of the transaction list.
    - Call [`reset_rec_map`](<#reset_rec_map>) to free all records in the `fd_funk_t` instance.
- **Output**: No return value; the function operates directly on the provided `cache`.
- **Functions Called**:
    - [`clear_txn_list`](<#clear_txn_list>)
    - [`reset_rec_map`](<#reset_rec_map>)


---
### fd\_accdb\_verify<!-- {{#callable:fd_accdb_verify}} -->
[View Source →](<../../../../../src/flamenco/accdb/fd_accdb_admin.c#L444>)

Verifies the integrity of the `funk` component within the `admin` structure.
- **Inputs**:
    - `admin`: A pointer to an `fd_accdb_admin_t` structure, which contains the `funk` component to verify.
- **Logic and Control Flow**:
    - Calls the `fd_funk_verify` function with the `funk` component of the `admin` structure.
    - Asserts that the result of `fd_funk_verify` is equal to `FD_FUNK_SUCCESS`.
- **Output**: No output is returned; the function performs an assertion to verify the `funk` component.



---
Made with ❤️ by [Driver](https://www.driver.ai/)