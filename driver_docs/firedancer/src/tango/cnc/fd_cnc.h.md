<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

APIs and data structures for managing out-of-band command-and-control signals in high-performance applications.

# Purpose
The code is a C header file that defines a command-and-control (CNC) interface for managing low-bandwidth signals between high-performance application threads and control or monitoring threads. The primary component is the `fd_cnc_t` structure, which acts as an opaque handle for CNC operations. This interface allows application threads to communicate their state and receive commands from CNC threads, facilitating operations such as starting, stopping, and handling user-defined signals. The CNC state machine includes states like `BOOT`, `RUN`, `USER`, `HALT`, and `FAIL`, which define the lifecycle and transitions of an application thread.

The header file provides several macros and functions to manage CNC operations. Macros such as `FD_CNC_ALIGN`, `FD_CNC_FOOTPRINT`, and `FD_CNC_SIGNAL_*` define alignment, memory footprint, and standard signal values, respectively. Functions like [`fd_cnc_new`](<#fd_cnc_new>), [`fd_cnc_join`](<#fd_cnc_join>), [`fd_cnc_leave`](<#fd_cnc_leave>), and [`fd_cnc_delete`](<#fd_cnc_delete>) manage the lifecycle of CNC objects, while [`fd_cnc_signal`](<#fd_cnc_signal>), [`fd_cnc_heartbeat`](<#fd_cnc_heartbeat>), and [`fd_cnc_wait`](<#fd_cnc_wait>) handle signal transitions and heartbeat updates. The file also includes error codes and utility functions for error handling and signal conversion. This interface is designed to be used in performance-critical paths, with inlining and memory fencing to ensure efficient operation.
# Imports and Dependencies

---
- `../fd_tango_base.h`


# Data Structures

---
### fd\_cnc\_private
- **Type**: ``struct``
- **Members**:
    - `magic`: A unique identifier set to `FD_CNC_MAGIC` to verify the structure's integrity.
    - `app_sz`: Specifies the size of the application-specific region within the structure.
    - `type`: An application-defined field to distinguish between different types of command-and-control signals.
    - `heartbeat0`: Stores the initial heartbeat value when the structure is created.
    - `heartbeat`: Tracks the current heartbeat value to monitor the application's status.
    - `lock`: Used to manage access control to the structure, ensuring thread safety.
    - `signal`: Holds the current signal value, indicating the state or command for the application.
- **Description**: The `fd_cnc_private` structure is aligned to `FD_CNC_ALIGN` and is used for managing command-and-control signals in a high-performance application. It includes fields for identifying the structure (`magic`), defining application-specific parameters (`app_sz`, `type`), and managing the application's operational state (`heartbeat0`, `heartbeat`, `lock`, `signal`). The structure facilitates communication between application threads and command-and-control threads, supporting state transitions and signal processing as part of the application's lifecycle.


---
### fd\_cnc\_t
- **Type**: ``struct``
- **Members**:
    - ``magic``: A unique identifier for the `fd_cnc_t` structure, set to `FD_CNC_MAGIC`.
    - ``app_sz``: The size of the application-specific region within the `fd_cnc_t`.
    - ``type``: An application-defined type field to distinguish supported signals.
    - ``heartbeat0``: The initial heartbeat value assigned when the `fd_cnc_t` is created.
    - ``heartbeat``: The current heartbeat value, used to monitor the app thread's status.
    - ``lock``: A lock field used to manage access to the `fd_cnc_t`.
    - ``signal``: The current signal posted to the `fd_cnc_t`, indicating its state or command.
- **Description**: The `fd_cnc_t` structure is an opaque handle for a command-and-control object used in high-performance applications to manage out-of-band signals between application threads and command/control or monitoring threads. It includes fields for managing the state, type, and heartbeat of the application, as well as a lock and signal field for synchronization and communication. The structure is aligned to `FD_CNC_ALIGN` and includes padding to ensure proper alignment of its application-specific region.


# Functions

---
### fd\_cnc\_app\_sz<!-- {{#callable:fd_cnc_app_sz}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.h#L203>)

Returns the size of the application region of a given `fd_cnc_t` object.
- **Inputs**:
    - `cnc`: A pointer to a constant `fd_cnc_t` object, which represents a command-and-control object.
- **Logic and Control Flow**:
    - Accesses the `app_sz` member of the `fd_cnc_t` structure pointed to by `cnc`.
    - Returns the value of `app_sz`.
- **Output**: The size of the application region as an `ulong`.


---
### fd\_cnc\_app\_laddr<!-- {{#callable:fd_cnc_app_laddr}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.h#L211>)

Returns the local address of the application region of a `fd_cnc_t` object.
- **Inputs**:
    - `cnc`: A pointer to a `fd_cnc_t` object, which represents a command-and-control object.
- **Logic and Control Flow**:
    - Casts the `cnc` pointer to an unsigned long integer.
    - Adds 64 to the casted value to offset to the application region.
    - Casts the result back to a `void *` pointer type.
- **Output**: A `void *` pointer to the local address of the application region of the `fd_cnc_t` object.


---
### fd\_cnc\_app\_laddr\_const<!-- {{#callable:fd_cnc_app_laddr_const}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.h#L212>)

Returns the local address of the application region of a `fd_cnc_t` object with constant correctness.
- **Inputs**:
    - `cnc`: A pointer to a constant `fd_cnc_t` object, representing a command-and-control object.
- **Logic and Control Flow**:
    - Casts the `cnc` pointer to an unsigned long integer.
    - Adds 64 to the casted value to offset to the application region.
    - Casts the result back to a constant void pointer.
- **Output**: A constant void pointer to the local address of the application region of the `fd_cnc_t` object.


---
### fd\_cnc\_type<!-- {{#callable:fd_cnc_type}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.h#L217>)

Retrieves the application-defined type of a command-and-control object.
- **Inputs**:
    - `cnc`: A pointer to a constant `fd_cnc_t` structure, representing a command-and-control object.
- **Logic and Control Flow**:
    - Accesses the `type` field of the `fd_cnc_t` structure pointed to by `cnc`.
    - Returns the value of the `type` field.
- **Output**: The function returns an `ulong` representing the application-defined type of the command-and-control object.


---
### fd\_cnc\_heartbeat0<!-- {{#callable:fd_cnc_heartbeat0}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.h#L222>)

Returns the initial heartbeat value assigned to a `fd_cnc_t` object when it was created.
- **Inputs**:
    - `cnc`: A pointer to a constant `fd_cnc_t` object, which represents a command-and-control object.
- **Logic and Control Flow**:
    - Accesses the `heartbeat0` field of the `fd_cnc_t` structure pointed to by `cnc`.
    - Returns the value of the `heartbeat0` field.
- **Output**: The function returns a `long` integer representing the initial heartbeat value of the `fd_cnc_t` object.


---
### fd\_cnc\_heartbeat\_query<!-- {{#callable:fd_cnc_heartbeat_query}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.h#L229>)

Returns the current value of the heartbeat from a `fd_cnc_t` object, ensuring memory consistency with compiler memory fences.
- **Inputs**:
    - `cnc`: A pointer to a constant `fd_cnc_t` object from which the heartbeat value is queried.
- **Logic and Control Flow**:
    - Execute a compiler memory fence to ensure memory operations are completed before reading the heartbeat.
    - Read the `heartbeat` value from the `cnc` object using a volatile read to prevent compiler optimizations that could reorder operations.
    - Execute another compiler memory fence to ensure memory operations are completed after reading the heartbeat.
    - Return the read heartbeat value.
- **Output**: The function returns a `long` integer representing the current heartbeat value of the `fd_cnc_t` object.


---
### fd\_cnc\_heartbeat<!-- {{#callable:fd_cnc_heartbeat}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.h#L251>)

Updates the heartbeat of a command-and-control object to the current time.
- **Inputs**:
    - `cnc`: A pointer to a `fd_cnc_t` structure representing the command-and-control object whose heartbeat is to be updated.
    - `now`: A `long` integer representing the current time or heartbeat value to be set.
- **Logic and Control Flow**:
    - Executes a compiler memory fence to ensure memory operations are completed before updating the heartbeat.
    - Sets the `heartbeat` field of the `cnc` structure to the value of `now` using a volatile write to ensure visibility across threads.
    - Executes another compiler memory fence to ensure the heartbeat update is visible to other threads.
- **Output**: No return value; the function updates the `heartbeat` field of the `cnc` structure in place.


---
### fd\_cnc\_signal\_query<!-- {{#callable:fd_cnc_signal_query}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.h#L264>)

Queries the current signal from a command-and-control object.
- **Inputs**:
    - `cnc`: A pointer to a constant `fd_cnc_t` structure representing the command-and-control object.
- **Logic and Control Flow**:
    - Executes a compiler memory fence to ensure memory operations are completed before proceeding.
    - Reads the `signal` field from the `cnc` structure using a volatile read to ensure the most recent value is obtained.
    - Executes another compiler memory fence to ensure the read operation is completed before returning the value.
    - Returns the value of the `signal` field.
- **Output**: Returns the current signal value as an unsigned long integer.


---
### fd\_cnc\_signal<!-- {{#callable:fd_cnc_signal}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.h#L314>)

Atomically transitions the command-and-control (CNC) object to a specified signal state.
- **Inputs**:
    - `cnc`: A pointer to an `fd_cnc_t` object, representing the command-and-control object to be signaled.
    - `s`: An unsigned long integer representing the signal to transition the CNC object to.
- **Logic and Control Flow**:
    - Executes a memory fence to ensure memory operations are completed before signaling.
    - Sets the `signal` field of the `cnc` object to the value of `s` using a volatile write to ensure visibility across threads.
    - Executes another memory fence to ensure the signal update is visible to other threads.
- **Output**: No return value; the function modifies the `signal` field of the `cnc` object in place.


---
### fd\_cnc\_close<!-- {{#callable:fd_cnc_close}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.h#L369>)

Ends the current command session on a `fd_cnc_t` object by releasing the lock.
- **Inputs**:
    - `cnc`: A pointer to a `fd_cnc_t` object representing the command-and-control object whose session is to be closed.
- **Logic and Control Flow**:
    - Executes a memory fence to ensure memory operations are completed before proceeding.
    - Sets the `lock` field of the `fd_cnc_t` object to `0UL`, indicating the session is closed.
    - Executes another memory fence to ensure the lock release is visible to other threads.
- **Output**: No return value; the function operates directly on the `fd_cnc_t` object pointed to by `cnc`.


# Function Declarations (Public API)

---
### fd\_cnc\_align<!-- {{#callable_declaration:fd_cnc_align}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.h#L140>)

Returns the required alignment for a command-and-control object.
- **Description**: Use this function to obtain the alignment requirement for a memory region intended for use as a command-and-control (cnc) object. This alignment is necessary to ensure proper memory access and performance. The function is useful when setting up memory regions for cnc objects, ensuring they meet the alignment constraints specified by the system.
- **Inputs**: None
- **Output**: Returns an unsigned long integer representing the alignment requirement, which is a power of 2.
- **See Also**: [`fd_cnc_align`](<fd_cnc.c.md#fd_cnc_align>)  (Implementation)


---
### fd\_cnc\_footprint<!-- {{#callable_declaration:fd_cnc_footprint}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.h#L151>)

Calculates the memory footprint required for a CNC object.
- **Description**: Use this function to determine the memory size needed for a command-and-control (CNC) object based on the application-specific size provided. This function is useful for validating CNC configuration parameters by ensuring the calculated footprint does not exceed the maximum allowable size. If the application size is too large, resulting in an overflow, the function returns zero, indicating an invalid configuration.
- **Inputs**:
    - `app_sz`: Specifies the size of the application-specific region within the CNC object. Must be a non-negative value that does not cause the total footprint to exceed ULONG_MAX. If the value is too large, the function returns zero to indicate an overflow.
- **Output**: Returns the calculated memory footprint size in bytes for the CNC object, or zero if the application size causes an overflow.
- **See Also**: [`fd_cnc_footprint`](<fd_cnc.c.md#fd_cnc_footprint>)  (Implementation)


---
### fd\_cnc\_new<!-- {{#callable_declaration:fd_cnc_new}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.h#L164>)

Formats a memory region for use as a command-and-control object.
- **Description**: Use this function to initialize a memory region as a command-and-control (CNC) object for communication between application and control threads. The memory region must be non-null, properly aligned, and have a valid footprint size. The function sets the CNC to the BOOT state with the specified type and initial heartbeat. It returns the formatted memory region on success or NULL on failure, logging details of any errors.
- **Inputs**:
    - `shmem`: Pointer to the memory region to format as a CNC. Must not be null and must be aligned according to `fd_cnc_align()`. Caller retains ownership.
    - `app_sz`: Size of the application-specific region within the CNC. Must be valid and not exceed the maximum footprint size.
    - `type`: Application-defined type identifier for the CNC. Should be within the range [0, UINT_MAX].
    - `now`: Initial heartbeat value for the CNC. Typically represents the current time or a starting counter value.
- **Output**: Returns a pointer to the formatted CNC memory region on success, or NULL on failure.
- **See Also**: [`fd_cnc_new`](<fd_cnc.c.md#fd_cnc_new>)  (Implementation)


---
### fd\_cnc\_join<!-- {{#callable_declaration:fd_cnc_join}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.h#L180>)

Joins the caller to a command-and-control object.
- **Description**: Use this function to join a caller to a command-and-control (CNC) object, which facilitates communication between application threads and command/control threads. The function requires a pointer to the shared memory region backing the CNC. It returns a pointer to the CNC object on success or NULL if the input is invalid. Ensure the memory region is correctly aligned and initialized before calling this function. A successful join should be followed by a corresponding leave operation.
- **Inputs**:
    - `shcnc`: A pointer to the first byte of the memory region backing the CNC in the caller's address space. Must not be NULL and must be aligned according to `fd_cnc_align()`. If the pointer is NULL or misaligned, the function logs a warning and returns NULL.
- **Output**: Returns a pointer to the CNC object on success, or NULL if the input is invalid.
- **See Also**: [`fd_cnc_join`](<fd_cnc.c.md#fd_cnc_join>)  (Implementation)


---
### fd\_cnc\_leave<!-- {{#callable_declaration:fd_cnc_leave}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.h#L188>)

Leaves a current local join of a command-and-control object.
- **Description**: Use this function to leave a current local join of a `fd_cnc_t` object. This is typically done when the caller no longer needs to interact with the command-and-control object. It is important to ensure that every successful join has a corresponding leave to maintain proper resource management. The function returns a pointer to the underlying shared memory region on success, or NULL if the input is invalid, such as when the input is NULL.
- **Inputs**:
    - `cnc`: A pointer to a `fd_cnc_t` object representing the current local join. Must not be NULL. If NULL, the function logs a warning and returns NULL.
- **Output**: Returns a pointer to the underlying shared memory region on success, or NULL if the input is invalid.
- **See Also**: [`fd_cnc_leave`](<fd_cnc.c.md#fd_cnc_leave>)  (Implementation)


---
### fd\_cnc\_delete<!-- {{#callable_declaration:fd_cnc_delete}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.h#L197>)

Unformats a memory region used as a command-and-control object.
- **Description**: Use this function to unformat a memory region that was previously formatted for use as a command-and-control (cnc) object. Ensure that no threads are currently joined to the cnc before calling this function. This function transfers ownership of the memory region back to the caller upon success. It returns a pointer to the underlying shared memory region or NULL if the input is invalid, such as when the pointer does not point to a valid cnc object. The function logs details of any errors encountered.
- **Inputs**:
    - `shcnc`: A pointer to the memory region to unformat. Must not be null and must be aligned according to `fd_cnc_align()`. The memory region must have been previously formatted as a cnc and must not be currently joined by any thread. If the pointer is null or misaligned, or if the memory region does not represent a valid cnc, the function returns NULL and logs a warning.
- **Output**: Returns a pointer to the underlying shared memory region on success, or NULL if the input is invalid.
- **See Also**: [`fd_cnc_delete`](<fd_cnc.c.md#fd_cnc_delete>)  (Implementation)


---
### fd\_cnc\_wait<!-- {{#callable_declaration:fd_cnc_wait}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.h#L358>)

Waits for a CNC signal to change or a timeout to occur.
- **Description**: Use this function to wait for a command-and-control (CNC) signal to change from a specified test value within a given time period. This is useful in scenarios where you need to synchronize with or monitor the state of a CNC object. The function will return immediately if the signal is different from the test value or if the specified time duration elapses. It is designed to be OS-friendly, allowing other threads to run on the same core without blocking. If the optional `_opt_now` parameter is provided, it will be updated with the wallclock time just before the last signal query.
- **Inputs**:
    - `cnc`: A pointer to a constant `fd_cnc_t` object representing the CNC to monitor. Must not be null and should be a valid, joined CNC object.
    - `test`: An unsigned long value representing the signal to test against. The function waits for the CNC signal to differ from this value.
    - `dt`: A long integer specifying the maximum time to wait in nanoseconds. A value of `LONG_MAX` indicates a blocking wait, while a value less than or equal to zero results in a single poll.
    - `_opt_now`: An optional pointer to a long integer. If non-null, it will be updated with the wallclock time observed just before the last CNC signal query.
- **Output**: Returns the last observed CNC signal as an unsigned long, which indicates the result of the wait operation.
- **See Also**: [`fd_cnc_wait`](<fd_cnc.c.md#fd_cnc_wait>)  (Implementation)


---
### fd\_cnc\_strerror<!-- {{#callable_declaration:fd_cnc_strerror}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.h#L380>)

Converts an error code to a human-readable string.
- **Description**: Use this function to obtain a descriptive string for a given error code related to command-and-control operations. This is useful for logging or displaying error messages to users. The function accepts an error code and returns a constant string that describes the error. The returned string is always non-null and has an infinite lifetime, meaning it does not need to be freed or managed by the caller.
- **Inputs**:
    - `err`: An integer representing the error code to convert. Valid values are predefined error codes such as `FD_CNC_SUCCESS`, `FD_CNC_ERR_UNSUP`, `FD_CNC_ERR_INVAL`, `FD_CNC_ERR_AGAIN`, and `FD_CNC_ERR_FAIL`. If the error code is not recognized, the function returns a default string indicating an unknown error.
- **Output**: A constant character pointer to a string describing the error. The string is non-null and has an infinite lifetime.
- **See Also**: [`fd_cnc_strerror`](<fd_cnc.c.md#fd_cnc_strerror>)  (Implementation)


---
### fd\_cstr\_to\_cnc\_signal<!-- {{#callable_declaration:fd_cstr_to_cnc_signal}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.h#L387>)

Converts a string to a CNC signal value.
- **Description**: Use this function to convert a string representation of a CNC signal into its corresponding numeric value. This is useful when interpreting command-and-control signals from string inputs. The function recognizes the strings "run", "boot", "fail", and "halt", returning their respective predefined signal values. If the input string does not match any of these, the function attempts to convert the string to an unsigned long integer. If the input is null, the function defaults to returning the signal for "run".
- **Inputs**:
    - `cstr`: A pointer to a null-terminated string representing a CNC signal. Valid strings are "run", "boot", "fail", and "halt". If the string does not match these, it should be convertible to an unsigned long integer. The pointer must not be null, as null input defaults to "run".
- **Output**: Returns an unsigned long integer representing the CNC signal value. If the input string is null, it returns the signal value for "run". If the string matches a known signal, it returns the corresponding predefined value. Otherwise, it returns the result of converting the string to an unsigned long integer.
- **See Also**: [`fd_cstr_to_cnc_signal`](<fd_cnc.c.md#fd_cstr_to_cnc_signal>)  (Implementation)


---
### fd\_cnc\_signal\_cstr<!-- {{#callable_declaration:fd_cnc_signal_cstr}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.h#L399>)

Converts a CNC signal value to a human-readable string.
- **Description**: Use this function to convert a CNC signal value into a human-readable string representation. This is useful for logging or displaying the current state of a CNC signal. The function requires a buffer to store the resulting string, which must have a capacity of at least `FD_CNC_SIGNAL_CSTR_BUF_MAX` bytes. The function always returns the provided buffer, and if the buffer is non-NULL, it will contain a null-terminated string on return. Ensure the buffer is valid and non-NULL to avoid undefined behavior.
- **Inputs**:
    - `signal`: The CNC signal value to convert. It can be one of the predefined signals like `FD_CNC_SIGNAL_RUN`, `FD_CNC_SIGNAL_BOOT`, `FD_CNC_SIGNAL_FAIL`, `FD_CNC_SIGNAL_HALT`, or any user-defined signal value.
    - `buf`: A pointer to a character buffer where the resulting string will be stored. The buffer must have at least `FD_CNC_SIGNAL_CSTR_BUF_MAX` bytes. Must not be NULL.
- **Output**: Returns the pointer to the provided buffer `buf`. If `buf` is non-NULL, it will contain a null-terminated string representing the signal.
- **See Also**: [`fd_cnc_signal_cstr`](<fd_cnc.c.md#fd_cnc_signal_cstr>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)