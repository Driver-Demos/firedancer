<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for managing and interacting with a CNC (Command and Control) structure in shared memory.

# Purpose
The code is a C source file that provides functionality for managing a control and command (CNC) structure, which is used for inter-process communication and synchronization. The file includes functions to create, join, leave, and delete a CNC instance, as well as to open a command session with the CNC. The [`fd_cnc_new`](<#fd_cnc_new>) function initializes a new CNC instance in shared memory, setting up its size, type, and initial state. The [`fd_cnc_join`](<#fd_cnc_join>) and [`fd_cnc_leave`](<#fd_cnc_leave>) functions allow processes to join and leave an existing CNC instance, respectively. The [`fd_cnc_delete`](<#fd_cnc_delete>) function is used to delete a CNC instance, ensuring that it is properly deallocated.

The file also includes functions for handling signals within the CNC framework. The [`fd_cnc_open`](<#fd_cnc_open>) function attempts to open a command session with the CNC, acquiring a lock and checking the status of the application thread. It handles various states and errors, such as when the application thread is not running or when another process has an open session. The [`fd_cnc_wait`](<#fd_cnc_wait>) function waits for a signal change or a timeout, and [`fd_cnc_strerror`](<#fd_cnc_strerror>) provides human-readable error messages for CNC-related errors. Additionally, the file includes utility functions like [`fd_cstr_to_cnc_signal`](<#fd_cstr_to_cnc_signal>) and [`fd_cnc_signal_cstr`](<#fd_cnc_signal_cstr>) for converting between string representations and signal codes. The code is designed to be used in a hosted environment with atomic operations, as indicated by the conditional compilation directives.
# Imports and Dependencies

---
- `fd_cnc.h`
- `errno.h`
- `signal.h`
- `sched.h`


# Functions

---
### fd\_cnc\_align<!-- {{#callable:fd_cnc_align}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.c#L3>)

Returns the alignment requirement for CNC data structures.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the value of the macro `FD_CNC_ALIGN`.
- **Output**: The alignment requirement for CNC data structures as defined by `FD_CNC_ALIGN`.


---
### fd\_cnc\_footprint<!-- {{#callable:fd_cnc_footprint}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.c#L8>)

Calculates the memory footprint required for an application size, ensuring it does not exceed a maximum limit.
- **Inputs**:
    - `app_sz`: The size of the application for which the memory footprint is calculated, given as an unsigned long integer.
- **Logic and Control Flow**:
    - Checks if `app_sz` is greater than `ULONG_MAX-191UL` using `FD_UNLIKELY` to determine if an overflow would occur.
    - If an overflow is detected, returns 0UL to indicate an error.
    - If no overflow is detected, calls `FD_CNC_FOOTPRINT` with `app_sz` to calculate and return the required memory footprint.
- **Output**: Returns the calculated memory footprint as an unsigned long integer, or 0UL if an overflow condition is detected.


---
### fd\_cnc\_new<!-- {{#callable:fd_cnc_new}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.c#L14>)

Initializes a `fd_cnc_t` structure in shared memory with specified parameters and returns a pointer to it.
- **Inputs**:
    - `shmem`: Pointer to the shared memory where the `fd_cnc_t` structure will be initialized.
    - `app_sz`: Size of the application-specific data to be accommodated in the `fd_cnc_t` structure.
    - `type`: Type identifier for the `fd_cnc_t` structure.
    - `now`: Current time to initialize the heartbeat fields in the `fd_cnc_t` structure.
- **Logic and Control Flow**:
    - Cast `shmem` to a `fd_cnc_t` pointer named `cnc`.
    - Check if `shmem` is NULL; if so, log a warning and return NULL.
    - Check if `shmem` is aligned according to [`fd_cnc_align`](<#fd_cnc_align>); if not, log a warning and return NULL.
    - Calculate the footprint using [`fd_cnc_footprint`](<#fd_cnc_footprint>) with `app_sz`; if the footprint is zero, log a warning and return NULL.
    - Clear the memory at `cnc` using `fd_memset` with the calculated footprint.
    - Set `cnc->app_sz` to `app_sz`, `cnc->type` to `type`, `cnc->heartbeat0` and `cnc->heartbeat` to `now`, `cnc->lock` to 0, and `cnc->signal` to `FD_CNC_SIGNAL_BOOT`.
    - Use `FD_COMPILER_MFENCE` to ensure memory ordering before and after setting `cnc->magic` to `FD_CNC_MAGIC`.
    - Return the pointer to `cnc`.
- **Output**: Returns a pointer to the initialized `fd_cnc_t` structure, or NULL if an error occurs.
- **Functions Called**:
    - [`fd_cnc_align`](<#fd_cnc_align>)
    - [`fd_cnc_footprint`](<#fd_cnc_footprint>)


---
### fd\_cnc\_join<!-- {{#callable:fd_cnc_join}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.c#L53>)

Validates and returns a pointer to a `fd_cnc_t` structure if the input shared memory is correctly aligned and initialized.
- **Inputs**:
    - `shcnc`: A pointer to shared memory that is expected to contain a `fd_cnc_t` structure.
- **Logic and Control Flow**:
    - Check if `shcnc` is NULL; if so, log a warning and return NULL.
    - Check if `shcnc` is aligned according to `fd_cnc_align()`; if not, log a warning and return NULL.
    - Cast `shcnc` to a `fd_cnc_t` pointer and store it in `cnc`.
    - Check if `cnc->magic` equals `FD_CNC_MAGIC`; if not, log a warning and return NULL.
    - Return the `cnc` pointer.
- **Output**: A pointer to a `fd_cnc_t` structure if all checks pass, otherwise NULL.
- **Functions Called**:
    - [`fd_cnc_align`](<#fd_cnc_align>)


---
### fd\_cnc\_leave<!-- {{#callable:fd_cnc_leave}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.c#L76>)

Returns a non-const pointer to the given `fd_cnc_t` object, or NULL if the input is NULL.
- **Inputs**:
    - `cnc`: A pointer to a constant `fd_cnc_t` object.
- **Logic and Control Flow**:
    - Check if `cnc` is NULL using `FD_UNLIKELY`; if true, log a warning and return NULL.
    - Return a non-const pointer to `cnc` by casting it to `void *`.
- **Output**: A non-const pointer to the `fd_cnc_t` object, or NULL if the input is NULL.


---
### fd\_cnc\_delete<!-- {{#callable:fd_cnc_delete}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.c#L87>)

Deletes a CNC object by validating and resetting its magic number.
- **Inputs**:
    - `shcnc`: A pointer to the shared CNC object to delete.
- **Logic and Control Flow**:
    - Check if `shcnc` is NULL; if true, log a warning and return NULL.
    - Check if `shcnc` is aligned according to [`fd_cnc_align`](<#fd_cnc_align>); if not, log a warning and return NULL.
    - Cast `shcnc` to a `fd_cnc_t` pointer named `cnc`.
    - Check if `cnc->magic` is equal to `FD_CNC_MAGIC`; if not, log a warning and return NULL.
    - Use memory fences to ensure memory operations are completed before and after setting `cnc->magic` to 0.
    - Return the `cnc` pointer cast back to `void *`.
- **Output**: A pointer to the deleted CNC object, or NULL if an error occurred.
- **Functions Called**:
    - [`fd_cnc_align`](<#fd_cnc_align>)


---
### fd\_cnc\_open<!-- {{#callable:fd_cnc_open}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.c#L281>)

Logs a warning and returns an unsupported error code for the current build target.
- **Inputs**:
    - `cnc`: A pointer to an `fd_cnc_t` structure, which is not used in this function.
- **Logic and Control Flow**:
    - Logs a warning message indicating that the function is unsupported for the current build target.
    - Returns the error code `FD_CNC_ERR_UNSUP`.
- **Output**: Returns `FD_CNC_ERR_UNSUP`, indicating the function is unsupported for the current build target.


---
### fd\_cnc\_wait<!-- {{#callable:fd_cnc_wait}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.c#L290>)

Waits for a signal change or a timeout and returns the observed signal.
- **Inputs**:
    - ``cnc``: A pointer to a constant `fd_cnc_t` structure representing the CNC (Command and Control) object to query.
    - ``test``: An unsigned long integer representing the signal value to test against.
    - ``dt``: A long integer representing the maximum time duration to wait in wall clock time.
    - ``_opt_now``: An optional pointer to a long integer where the function will store the current wall clock time if provided.
- **Logic and Control Flow**:
    - Initialize `then` and `now` with the current wall clock time using `fd_log_wallclock()`.
    - Enter an infinite loop to repeatedly query the signal from the CNC using `fd_cnc_signal_query(cnc)` and store it in `obs`.
    - Calculate `done` as true if the observed signal `obs` is not equal to `test` or if the elapsed time exceeds `dt`.
    - Use `FD_COMPILER_FORGET(done)` to prevent compiler misoptimization.
    - If `done` is true, break the loop to exit.
    - Call `FD_YIELD()` to yield the processor, allowing other threads to run.
    - Update `now` with the current wall clock time using `fd_log_wallclock()`.
    - After exiting the loop, if `_opt_now` is not null, store the current time in `_opt_now`.
- **Output**: Returns the observed signal as an unsigned long integer.
- **Functions Called**:
    - [`fd_cnc_signal_query`](<fd_cnc.h.md#fd_cnc_signal_query>)


---
### fd\_cnc\_strerror<!-- {{#callable:fd_cnc_strerror}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.c#L312>)

Maps an error code to a corresponding error message string.
- **Inputs**:
    - `err`: An integer representing the error code to be translated into a string message.
- **Logic and Control Flow**:
    - Use a `switch` statement to check the value of `err`.
    - If `err` matches `FD_CNC_SUCCESS`, return the string "success".
    - If `err` matches `FD_CNC_ERR_UNSUP`, return the string "unsupported here".
    - If `err` matches `FD_CNC_ERR_INVAL`, return the string "bad inputs".
    - If `err` matches `FD_CNC_ERR_AGAIN`, return the string "try again later".
    - If `err` matches `FD_CNC_ERR_FAIL`, return the string "app thread failed".
    - If `err` does not match any known error codes, return the string "unknown---possibly not a cnc error code".
- **Output**: A constant character pointer to a string that describes the error corresponding to the input error code.


---
### fd\_cstr\_to\_cnc\_signal<!-- {{#callable:fd_cstr_to_cnc_signal}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.c#L325>)

Converts a string representation of a CNC signal to its corresponding unsigned long value.
- **Inputs**:
    - `cstr`: A constant character pointer representing the string to convert to a CNC signal.
- **Logic and Control Flow**:
    - Check if `cstr` is NULL; if true, return `FD_CNC_SIGNAL_RUN`.
    - Compare `cstr` with the string "run" using `fd_cstr_casecmp`; if they match, return `FD_CNC_SIGNAL_RUN`.
    - Compare `cstr` with the string "boot" using `fd_cstr_casecmp`; if they match, return `FD_CNC_SIGNAL_BOOT`.
    - Compare `cstr` with the string "fail" using `fd_cstr_casecmp`; if they match, return `FD_CNC_SIGNAL_FAIL`.
    - Compare `cstr` with the string "halt" using `fd_cstr_casecmp`; if they match, return `FD_CNC_SIGNAL_HALT`.
    - If none of the above conditions are met, convert `cstr` to an unsigned long using `fd_cstr_to_ulong` and return the result.
- **Output**: Returns an unsigned long representing the CNC signal corresponding to the input string, or the result of converting the string to an unsigned long if no match is found.


---
### fd\_cnc\_signal\_cstr<!-- {{#callable:fd_cnc_signal_cstr}} -->
[View Source →](<../../../../../src/tango/cnc/fd_cnc.c#L335>)

Converts a signal code to its corresponding string representation and stores it in a buffer.
- **Inputs**:
    - `signal`: An unsigned long integer representing the signal code to convert.
    - `buf`: A pointer to a character buffer where the string representation of the signal will be stored.
- **Logic and Control Flow**:
    - Check if `buf` is not NULL using `FD_LIKELY` macro.
    - Use a `switch` statement to match the `signal` with predefined signal codes: `FD_CNC_SIGNAL_RUN`, `FD_CNC_SIGNAL_BOOT`, `FD_CNC_SIGNAL_FAIL`, and `FD_CNC_SIGNAL_HALT`.
    - For each matched case, copy the corresponding string ('run', 'boot', 'fail', 'halt') into `buf` using `strcpy`.
    - If the `signal` does not match any predefined codes, use `fd_cstr_printf` to format the `signal` as a string and store it in `buf`.
- **Output**: Returns the pointer to the buffer `buf` containing the string representation of the signal.



---
Made with ❤️ by [Driver](https://www.driver.ai/)