<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for managing a transactional cache, including creation, joining, leaving, and deletion.

# Purpose
The code defines a set of functions for managing a data structure referred to as a "tcache" (likely short for "transaction cache" or similar). The primary operations include creating a new tcache ([`fd_tcache_new`](<#fd_tcache_new>)), joining an existing tcache ([`fd_tcache_join`](<#fd_tcache_join>)), leaving a tcache ([`fd_tcache_leave`](<#fd_tcache_leave>)), and deleting a tcache ([`fd_tcache_delete`](<#fd_tcache_delete>)). These functions handle memory alignment and validation checks to ensure the integrity of the tcache structure. The [`fd_tcache_align`](<#fd_tcache_align>) function returns the required memory alignment for a tcache, while [`fd_tcache_footprint`](<#fd_tcache_footprint>) calculates the memory footprint needed based on the specified depth and map count.

The code includes error handling through the use of `FD_UNLIKELY` macros, which help identify and log warnings for invalid inputs or states, such as null pointers, misaligned memory, or incorrect magic numbers. The [`fd_tcache_new`](<#fd_tcache_new>) function initializes the tcache in shared memory, setting its depth and map count, and ensuring it is properly aligned. The [`fd_tcache_join`](<#fd_tcache_join>) function verifies the integrity of an existing tcache before allowing access, while [`fd_tcache_delete`](<#fd_tcache_delete>) marks a tcache as deleted by resetting its magic number. The code is intended to be part of a larger system, likely involving shared memory management, and provides a specific interface for handling tcache objects.
# Imports and Dependencies

---
- `fd_tcache.h`


# Functions

---
### fd\_tcache\_align<!-- {{#callable:fd_tcache_align}} -->
[View Source →](<../../../../../src/tango/tcache/fd_tcache.c#L3>)

Returns the alignment requirement for a tcache.
- **Inputs**: None
- **Logic and Control Flow**:
    - Return the value of `FD_TCACHE_ALIGN`.
- **Output**: The alignment requirement for a tcache as defined by `FD_TCACHE_ALIGN`.


---
### fd\_tcache\_footprint<!-- {{#callable:fd_tcache_footprint}} -->
[View Source →](<../../../../../src/tango/tcache/fd_tcache.c#L8>)

Calculates the memory footprint required for a tcache structure based on the given depth and map count.
- **Inputs**:
    - `depth`: The number of elements the tcache can hold.
    - `map_cnt`: The number of map entries; if zero, a default value based on depth is used.
- **Logic and Control Flow**:
    - If `map_cnt` is zero, set it to the default value using `fd_tcache_map_cnt_default(depth)`.
    - Check if `depth` is zero, `map_cnt` is less than `depth + 2`, or `map_cnt` is not a power of two; return 0 if any condition is true.
    - Calculate `cnt` as `4 + depth`; return 0 if overflow occurs.
    - Add `map_cnt` to `cnt`; return 0 if overflow occurs.
    - Check if `cnt` multiplied by `sizeof(ulong)` exceeds `ULONG_MAX`; return 0 if true.
    - Multiply `cnt` by `sizeof(ulong)` to get the total size in bytes.
    - Align the total size to `FD_TCACHE_ALIGN` using `fd_ulong_align_up`; return 0 if overflow occurs.
    - Return the aligned footprint size.
- **Output**: The aligned memory footprint size in bytes, or 0 if any validation fails.
- **Functions Called**:
    - [`fd_tcache_map_cnt_default`](<fd_tcache.h.md#fd_tcache_map_cnt_default>)


---
### fd\_tcache\_new<!-- {{#callable:fd_tcache_new}} -->
[View Source →](<../../../../../src/tango/tcache/fd_tcache.c#L23>)

Initializes a new transaction cache in shared memory with specified depth and map count.
- **Inputs**:
    - `shmem`: Pointer to the shared memory where the transaction cache will be initialized.
    - `depth`: The depth of the transaction cache, representing the number of entries it can hold.
    - `map_cnt`: The number of map entries; if zero, a default value based on depth is used.
- **Logic and Control Flow**:
    - If `map_cnt` is zero, set it to the default value using [`fd_tcache_map_cnt_default`](<fd_tcache.h.md#fd_tcache_map_cnt_default>) with `depth`.
    - Check if `shmem` is NULL; if so, log a warning and return NULL.
    - Check if `shmem` is aligned according to [`fd_tcache_align`](<#fd_tcache_align>); if not, log a warning and return NULL.
    - Calculate the memory footprint using [`fd_tcache_footprint`](<#fd_tcache_footprint>) with `depth` and `map_cnt`; if zero, log a warning and return NULL.
    - Clear the memory at `shmem` with the calculated footprint using `fd_memset`.
    - Cast `shmem` to a `fd_tcache_t` pointer and initialize its `depth`, `map_cnt`, and `oldest` fields.
    - Set the `magic` field of the cache to `FD_TCACHE_MAGIC` using memory fences to ensure proper ordering.
    - Return the `shmem` pointer.
- **Output**: Returns a pointer to the initialized shared memory if successful, or NULL if an error occurs.
- **Functions Called**:
    - [`fd_tcache_map_cnt_default`](<fd_tcache.h.md#fd_tcache_map_cnt_default>)
    - [`fd_tcache_align`](<#fd_tcache_align>)
    - [`fd_tcache_footprint`](<#fd_tcache_footprint>)
    - [`fd_tcache_reset`](<fd_tcache.h.md#fd_tcache_reset>)
    - [`fd_tcache_ring_laddr`](<fd_tcache.h.md#fd_tcache_ring_laddr>)
    - [`fd_tcache_map_laddr`](<fd_tcache.h.md#fd_tcache_map_laddr>)


---
### fd\_tcache\_join<!-- {{#callable:fd_tcache_join}} -->
[View Source →](<../../../../../src/tango/tcache/fd_tcache.c#L60>)

Validates and returns a pointer to a `fd_tcache_t` structure if the input `_tcache` is valid and properly aligned.
- **Inputs**:
    - `_tcache`: A pointer to a memory location that is expected to be a `fd_tcache_t` structure.
- **Logic and Control Flow**:
    - Check if `_tcache` is `NULL`; if true, log a warning and return `NULL`.
    - Check if `_tcache` is aligned according to `fd_tcache_align()`; if not, log a warning and return `NULL`.
    - Cast `_tcache` to a `fd_tcache_t` pointer and store it in `tcache`.
    - Check if `tcache->magic` equals `FD_TCACHE_MAGIC`; if not, log a warning and return `NULL`.
    - Return the `tcache` pointer.
- **Output**: A pointer to a `fd_tcache_t` structure if all checks pass, otherwise `NULL`.
- **Functions Called**:
    - [`fd_tcache_align`](<#fd_tcache_align>)


---
### fd\_tcache\_leave<!-- {{#callable:fd_tcache_leave}} -->
[View Source →](<../../../../../src/tango/tcache/fd_tcache.c#L82>)

Returns the input `tcache` pointer if it is not NULL, otherwise logs a warning and returns NULL.
- **Inputs**:
    - `tcache`: A pointer to an `fd_tcache_t` structure that is to be left.
- **Logic and Control Flow**:
    - Check if `tcache` is NULL using `FD_UNLIKELY`.
    - If `tcache` is NULL, log a warning message 'NULL tcache' and return NULL.
    - If `tcache` is not NULL, cast it to a `void *` and return it.
- **Output**: Returns a `void *` pointer to the `tcache` if it is not NULL, otherwise returns NULL.


---
### fd\_tcache\_delete<!-- {{#callable:fd_tcache_delete}} -->
[View Source →](<../../../../../src/tango/tcache/fd_tcache.c#L93>)

Removes a `tcache` object by validating and resetting its magic number.
- **Inputs**:
    - `_tcache`: A pointer to the `tcache` object to delete.
- **Logic and Control Flow**:
    - Check if `_tcache` is NULL; if true, log a warning and return NULL.
    - Check if `_tcache` is aligned according to [`fd_tcache_align`](<#fd_tcache_align>); if not, log a warning and return NULL.
    - Cast `_tcache` to `fd_tcache_t *` and check if its `magic` field matches `FD_TCACHE_MAGIC`; if not, log a warning and return NULL.
    - Use `FD_COMPILER_MFENCE` to ensure memory ordering before and after setting the `magic` field to 0.
    - Return the `_tcache` pointer.
- **Output**: Returns the `_tcache` pointer if successful, or NULL if any validation fails.
- **Functions Called**:
    - [`fd_tcache_align`](<#fd_tcache_align>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)