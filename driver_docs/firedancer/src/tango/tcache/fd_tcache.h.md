<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Header file for a 64-bit tag cache system optimized for deduplication and performance-critical contexts.

# Purpose
The code is a C header file that defines a data structure and associated functions for managing a cache of unique 64-bit tags, referred to as `fd_tcache_t`. This cache is designed to store the most recently observed unique tags, which is useful for deduplication tasks, such as filtering out duplicate network packets based on their hash values. The implementation is optimized for large cache sizes and scenarios where tag duplication is common and temporally localized. The cache is structured to minimize memory footprint while maintaining computational efficiency, and it is recommended to be backed by a single NUMA page to avoid TLB thrashing in performance-critical contexts.

The header file defines several macros and functions to manage the cache, including `FD_TCACHE_ALIGN` and `FD_TCACHE_FOOTPRINT` for memory alignment and footprint calculations, and `FD_TCACHE_TAG_NULL` to represent a null tag. It provides functions to create, join, leave, and delete a cache, as well as to query and manipulate the cache's contents. The cache uses a ring buffer to maintain the order of tags and a sparse linear probed map for fast tag lookup. The file also includes macros for inserting and querying tags, ensuring efficient operations even in performance-critical environments. The design assumes that tags behave like IID random values, which allows for optimized memory and computational efficiency.
# Imports and Dependencies

---
- `../fd_tango_base.h`


# Global Variables

---
### \_fti\_tag\_oldest
- **Type**: `ulong`
- **Description**: Stores the value of the oldest tag in the `fd_tcache_t` ring buffer before it is replaced by a new tag.
- **Use**: Used to temporarily hold the oldest tag value during the insertion of a new tag into the tcache, allowing for the removal of the oldest tag from the map.


# Data Structures

---
### fd\_tcache\_private
- **Type**: ``struct``
- **Members**:
    - ``magic``: A magic number used to identify the structure, expected to be `FD_TCACHE_MAGIC`.
    - ``depth``: Indicates the number of most recent unique tags the tcache will maintain.
    - ``map_cnt``: Specifies the number of slots in the sparse linear probed key-only map.
    - ``oldest``: Tracks the index of the oldest tag in the tcache, within the range [0, `depth`).
- **Description**: The `fd_tcache_private` structure is a cache for the most recently observed unique 64-bit tags, optimized for deduplication of traffic based on a thumbprint, hash, or signature. It maintains a history of tags up to a specified `depth` and uses a sparse map to track current tags, allowing for efficient operations even with high duplication and temporal clustering of tags. The structure is aligned to `FD_TCACHE_ALIGN` to mitigate false sharing and is designed for performance-critical contexts, with considerations for memory footprint and computational efficiency.


---
### fd\_tcache\_t
- **Type**: ``struct``
- **Members**:
    - ``magic``: A magic number used to verify the integrity of the `fd_tcache_t` structure.
    - ``depth``: The number of unique tags that the cache can store.
    - ``map_cnt``: The number of slots in the tag map, which must be a power of 2 and at least `depth + 2`.
    - ``oldest``: An index indicating the oldest tag in the cache, ranging from 0 to `depth - 1`.
- **Description**: A `fd_tcache_t` is a data structure that caches the most recently observed unique 64-bit tags, useful for deduplication of traffic based on a tag or hash. It maintains a history of tags with a theoretically unlimited depth, optimized for large depths and situations with common, temporally localized duplication. The structure includes a cyclic ring buffer to track the order of tags and a sparse linear probed map for efficient tag lookup. The implementation is designed to minimize memory footprint and computational overhead, especially in performance-critical contexts.


# Functions

---
### fd\_tcache\_map\_cnt\_default<!-- {{#callable:fd_tcache_map_cnt_default}} -->
[View Source →](<../../../../../src/tango/tcache/fd_tcache.h#L109>)

Calculates the default `map_cnt` for a given `depth`, returning 0 if the `depth` is invalid or results in an overflow.
- **Inputs**:
    - `depth`: The number of unique tags that can be stored in the tcache, must be a positive integer.
- **Logic and Control Flow**:
    - Check if `depth` is zero or equals `ULONG_MAX`, return 0 if true.
    - Calculate `lg_map_cnt` using `fd_ulong_find_msb` on `depth + 1` and add `FD_TCACHE_SPARSE_DEFAULT`.
    - Check if `lg_map_cnt` is greater than 63, return 0 if true.
    - Return `1UL << lg_map_cnt` as the default `map_cnt`.
- **Output**: Returns the calculated default `map_cnt` as an unsigned long integer, or 0 if the input `depth` is invalid or causes overflow.


---
### fd\_tcache\_depth<!-- {{#callable:fd_tcache_depth}} -->
[View Source →](<../../../../../src/tango/tcache/fd_tcache.h#L220>)

Retrieves the depth of the tag cache from a given `fd_tcache_t` structure.
- **Inputs**:
    - `tcache`: A pointer to a constant `fd_tcache_t` structure from which the depth is retrieved.
- **Logic and Control Flow**:
    - Accesses the `depth` field of the `fd_tcache_t` structure pointed to by `tcache`.
    - Returns the value of the `depth` field.
- **Output**: Returns an `ulong` representing the depth of the tag cache.


---
### fd\_tcache\_map\_cnt<!-- {{#callable:fd_tcache_map_cnt}} -->
[View Source →](<../../../../../src/tango/tcache/fd_tcache.h#L221>)

Retrieves the `map_cnt` value from a given `fd_tcache_t` structure.
- **Inputs**:
    - `tcache`: A pointer to a constant `fd_tcache_t` structure from which to retrieve the `map_cnt` value.
- **Logic and Control Flow**:
    - Accesses the `map_cnt` field of the `fd_tcache_t` structure pointed to by `tcache`.
    - Returns the value of the `map_cnt` field.
- **Output**: Returns the `map_cnt` value as an unsigned long integer (`ulong`).


---
### fd\_tcache\_oldest\_laddr<!-- {{#callable:fd_tcache_oldest_laddr}} -->
[View Source →](<../../../../../src/tango/tcache/fd_tcache.h#L223>)

Returns a pointer to the location of the oldest tag in the `fd_tcache_t` structure.
- **Inputs**:
    - `tcache`: A pointer to an `fd_tcache_t` structure, which represents a cache of the most recently observed unique 64-bit tags.
- **Logic and Control Flow**:
    - Accesses the `oldest` field of the `fd_tcache_t` structure.
    - Returns the address of the `oldest` field.
- **Output**: A pointer to the `oldest` field within the `fd_tcache_t` structure.


---
### fd\_tcache\_ring\_laddr<!-- {{#callable:fd_tcache_ring_laddr}} -->
[View Source →](<../../../../../src/tango/tcache/fd_tcache.h#L224>)

Calculates the local address of the ring buffer within a `fd_tcache_t` structure.
- **Inputs**:
    - `tcache`: A pointer to a `fd_tcache_t` structure, which represents a cache of the most recently observed unique 64-bit tags.
- **Logic and Control Flow**:
    - Converts the `tcache` pointer to a `ulong` pointer.
    - Adds an offset of 4 to the `ulong` pointer to calculate the address of the ring buffer.
- **Output**: Returns a pointer to the start of the ring buffer within the `fd_tcache_t` structure.


---
### fd\_tcache\_map\_laddr<!-- {{#callable:fd_tcache_map_laddr}} -->
[View Source →](<../../../../../src/tango/tcache/fd_tcache.h#L225>)

Calculates the local address of the map section in a `fd_tcache_t` structure.
- **Inputs**:
    - `tcache`: A pointer to a `fd_tcache_t` structure, which represents a cache of recently observed unique 64-bit tags.
- **Logic and Control Flow**:
    - Calculate the base address of the map section by casting the `tcache` pointer to a `ulong` pointer and adding 4 to it.
    - Add the `depth` value from the `tcache` structure to the base address to get the final address of the map section.
- **Output**: Returns a pointer to the start of the map section in the `fd_tcache_t` structure.


---
### fd\_tcache\_tag\_is\_null<!-- {{#callable:fd_tcache_tag_is_null}} -->
[View Source →](<../../../../../src/tango/tcache/fd_tcache.h#L230>)

Checks if a given tag is equal to the null tag value `FD_TCACHE_TAG_NULL`.
- **Inputs**:
    - `tag`: The 64-bit unsigned long integer to check against the null tag value.
- **Logic and Control Flow**:
    - Compares the input `tag` with the constant `FD_TCACHE_TAG_NULL`.
    - Returns the result of the comparison as an integer.
- **Output**: Returns a non-zero integer if `tag` is equal to `FD_TCACHE_TAG_NULL`, otherwise returns zero.


---
### fd\_tcache\_reset<!-- {{#callable:fd_tcache_reset}} -->
[View Source →](<../../../../../src/tango/tcache/fd_tcache.h#L237>)

Resets the `ring` and `map` arrays to an empty state by setting all elements to `FD_TCACHE_TAG_NULL`.
- **Inputs**:
    - `ring`: A pointer to an array of `ulong` representing the cache ring to reset.
    - `depth`: The number of elements in the `ring` array.
    - `map`: A pointer to an array of `ulong` representing the cache map to reset.
    - `map_cnt`: The number of elements in the `map` array.
- **Logic and Control Flow**:
    - Iterates over the `ring` array from index 0 to `depth - 1`, setting each element to `FD_TCACHE_TAG_NULL`.
    - Iterates over the `map` array from index 0 to `map_cnt - 1`, setting each element to `FD_TCACHE_TAG_NULL`.
    - Returns 0UL, which represents the initial index for the oldest element in the cache.
- **Output**: Returns 0UL, indicating the reset position for the oldest element in the cache.


---
### fd\_tcache\_map\_start<!-- {{#callable:fd_tcache_map_start}} -->
[View Source →](<../../../../../src/tango/tcache/fd_tcache.h#L256>)

Calculates the starting index for probing a tag in a tcache map.
- **Inputs**:
    - `tag`: The tag value for which to find the starting index in the map.
    - `map_cnt`: The number of slots in the map, which must be a positive integer power of 2.
- **Logic and Control Flow**:
    - Compute the starting index by performing a bitwise AND operation between `tag` and `map_cnt-1UL`.
- **Output**: Returns the starting index for probing the tag in the map.


---
### fd\_tcache\_map\_next<!-- {{#callable:fd_tcache_map_next}} -->
[View Source →](<../../../../../src/tango/tcache/fd_tcache.h#L257>)

Calculates the next index in a circular buffer given the current index and the buffer size.
- **Inputs**:
    - `idx`: The current index in the circular buffer.
    - `map_cnt`: The total number of slots in the circular buffer, which must be a power of 2.
- **Logic and Control Flow**:
    - Increment `idx` by 1.
    - Apply a bitwise AND operation between the incremented `idx` and `map_cnt-1UL` to ensure the result wraps around if it exceeds `map_cnt`.
- **Output**: The next index in the circular buffer, wrapped around if necessary.


---
### fd\_tcache\_remove<!-- {{#callable:fd_tcache_remove}} -->
[View Source →](<../../../../../src/tango/tcache/fd_tcache.h#L306>)

Removes a specified tag from a cache map if it exists and is not null.
- **Inputs**:
    - `map`: A pointer to an array of unsigned long integers representing the cache map.
    - `map_cnt`: The number of slots in the cache map, which must be a positive integer power of two.
    - `tag`: The tag to be removed from the cache map, represented as an unsigned long integer.
- **Logic and Control Flow**:
    - Check if the `tag` is not null using [`fd_tcache_tag_is_null`](<#fd_tcache_tag_is_null>); if it is null, exit the function.
    - Use `FD_TCACHE_QUERY` to search for the `tag` in the `map`. If the `tag` is not found, exit the function.
    - If the `tag` is found, set the corresponding slot in the `map` to `FD_TCACHE_TAG_NULL` to remove the `tag`.
    - Enter a loop to find the next non-null tag in the `map` and determine if it should be moved to fill the hole left by the removed `tag`.
    - Continue this process until a null tag is encountered, indicating the end of the chain, and exit the function.
- **Output**: The function does not return a value; it modifies the `map` in place to remove the specified `tag`.
- **Functions Called**:
    - [`fd_tcache_tag_is_null`](<#fd_tcache_tag_is_null>)
    - [`fd_tcache_map_next`](<#fd_tcache_map_next>)
    - [`fd_tcache_map_start`](<#fd_tcache_map_start>)


# Function Declarations (Public API)

---
### fd\_tcache\_align<!-- {{#callable_declaration:fd_tcache_align}} -->
[View Source →](<../../../../../src/tango/tcache/fd_tcache.h#L154>)

Returns the required memory alignment for a tcache.
- **Description**: Use this function to obtain the alignment requirement for a memory region intended to be used as a tcache. This is necessary to ensure that the memory region is correctly aligned for optimal performance and to avoid issues related to memory access. The alignment value is predefined and does not change, making it suitable for compile-time declarations.
- **Inputs**: None
- **Output**: The function returns an unsigned long integer representing the alignment requirement for a tcache, which is a constant value.
- **See Also**: [`fd_tcache_align`](<fd_tcache.c.md#fd_tcache_align>)  (Implementation)


---
### fd\_tcache\_footprint<!-- {{#callable_declaration:fd_tcache_footprint}} -->
[View Source →](<../../../../../src/tango/tcache/fd_tcache.h#L157>)

Calculates the memory footprint for a tcache with specified depth and map count.
- **Description**: Use this function to determine the memory footprint required for a tcache with a given depth and map count. If the map count is zero, the function uses a default value based on the depth. The function returns zero if the depth is not positive, the map count is not a power of two, or if the calculated footprint exceeds ULONG_MAX. This function is useful for validating tcache configuration parameters before allocation.
- **Inputs**:
    - `depth`: Specifies the number of unique tags the tcache can store. Must be a positive value.
    - `map_cnt`: Specifies the number of slots in the tag map. If zero, the function uses a default value based on the depth. Must be a power of two and at least depth+2 if not zero.
- **Output**: Returns the calculated memory footprint in bytes, or zero if the input parameters are invalid or result in an overflow.
- **See Also**: [`fd_tcache_footprint`](<fd_tcache.c.md#fd_tcache_footprint>)  (Implementation)


---
### fd\_tcache\_new<!-- {{#callable_declaration:fd_tcache_new}} -->
[View Source →](<../../../../../src/tango/tcache/fd_tcache.h#L175>)

Formats a memory region for use as a tag cache.
- **Description**: Use this function to initialize a memory region as a tag cache, which stores a history of unique 64-bit tags for deduplication purposes. The memory region must be properly aligned and have sufficient size based on the specified depth and map count. The function returns the formatted memory region on success or NULL if the input parameters are invalid, logging details of the failure. Ensure that the memory region is not in use by other processes before calling this function.
- **Inputs**:
    - `shmem`: A non-NULL pointer to a memory region that will be formatted as a tag cache. The memory must be aligned according to `fd_tcache_align()` and have a footprint as specified by `fd_tcache_footprint()`. If the pointer is NULL or misaligned, the function returns NULL.
    - `depth`: The number of unique tags the cache can store. It must be a positive integer. If the depth is invalid, the function returns NULL.
    - `map_cnt`: The number of slots in the tag map. If set to 0, a default value is used based on the depth. The value must be a power of 2 and at least `depth + 2`. If invalid, the function returns NULL.
- **Output**: Returns the pointer to the formatted memory region on success, or NULL on failure.
- **See Also**: [`fd_tcache_new`](<fd_tcache.c.md#fd_tcache_new>)  (Implementation)


---
### fd\_tcache\_join<!-- {{#callable_declaration:fd_tcache_join}} -->
[View Source →](<../../../../../src/tango/tcache/fd_tcache.h#L191>)

Joins the caller to a tcache.
- **Description**: Use this function to join a caller to a tcache, allowing access to its entries. Ensure that the pointer provided is correctly aligned and points to a valid tcache memory region. This function returns a pointer to the tcache's entries on success, or NULL if the provided pointer is invalid, misaligned, or does not point to a valid tcache. Each successful join should be matched with a corresponding leave to ensure proper resource management.
- **Inputs**:
    - `_tcache`: A pointer to the first byte of the memory region backing the tcache in the caller's address space. Must not be null, must be properly aligned, and must point to a valid tcache. If invalid, the function logs a warning and returns NULL.
- **Output**: Returns a pointer to the tcache's entries on success, or NULL if the input is invalid.
- **See Also**: [`fd_tcache_join`](<fd_tcache.c.md#fd_tcache_join>)  (Implementation)


---
### fd\_tcache\_leave<!-- {{#callable_declaration:fd_tcache_leave}} -->
[View Source →](<../../../../../src/tango/tcache/fd_tcache.h#L199>)

Leaves a current local join of a tcache.
- **Description**: Use this function to leave a current local join of a tcache. It returns a pointer to the underlying shared memory region if successful. This function should be called after a successful join to ensure proper resource management. If the input is null, it logs a warning and returns null.
- **Inputs**:
    - `tcache`: A pointer to the tcache object to leave. Must not be null. If null, the function logs a warning and returns null.
- **Output**: Returns a pointer to the underlying shared memory region on success, or null if the input is null.
- **See Also**: [`fd_tcache_leave`](<fd_tcache.c.md#fd_tcache_leave>)  (Implementation)


---
### fd\_tcache\_delete<!-- {{#callable_declaration:fd_tcache_delete}} -->
[View Source →](<../../../../../src/tango/tcache/fd_tcache.h#L208>)

Unformats a memory region used as a tcache.
- **Description**: Use this function to unformat a memory region that was previously formatted as a tcache. Ensure that no threads are joined to the tcache before calling this function. This function transfers ownership of the memory region back to the caller. It logs a warning and returns NULL if the provided pointer is not a valid tcache or if it is misaligned.
- **Inputs**:
    - `_tcache`: A pointer to the memory region that is formatted as a tcache. Must not be NULL, must be properly aligned, and must have a valid magic number. If these conditions are not met, the function logs a warning and returns NULL.
- **Output**: Returns a pointer to the underlying shared memory region if successful, or NULL if the input is invalid.
- **See Also**: [`fd_tcache_delete`](<fd_tcache.c.md#fd_tcache_delete>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)