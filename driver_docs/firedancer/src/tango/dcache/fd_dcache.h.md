<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Header file for managing a dcache, including alignment, footprint calculations, and memory management functions.

# Purpose
The code is a C header file that defines a set of macros, functions, and data structures for managing a "dcache" (data cache) in a shared memory environment. The primary purpose of this file is to provide an interface for creating, configuring, and managing a dcache, which is a memory region used to store data fragments. The file includes definitions for alignment and footprint calculations, construction and accessor APIs, and functions to ensure safe and efficient data storage and retrieval in a concurrent processing environment.

Key components include macros such as `FD_DCACHE_ALIGN` and `FD_DCACHE_FOOTPRINT` for determining memory alignment and size requirements, and functions like [`fd_dcache_new`](<#fd_dcache_new>), [`fd_dcache_join`](<#fd_dcache_join>), and [`fd_dcache_leave`](<#fd_dcache_leave>) for managing the lifecycle of a dcache. The file also provides functions to calculate the required data size ([`fd_dcache_req_data_sz`](<#fd_dcache_req_data_sz>)) and to check if a dcache can safely store data fragments compactly ([`fd_dcache_compact_is_safe`](<#fd_dcache_compact_is_safe>)). The header defines a public API for external use, allowing other parts of a program to interact with the dcache, ensuring that data is stored and accessed efficiently while maintaining alignment and size constraints.
# Imports and Dependencies

---
- `../fd_tango_base.h`


# Functions

---
### fd\_dcache\_compact\_chunk0<!-- {{#callable:fd_dcache_compact_chunk0}} -->
[View Source →](<../../../../../src/tango/dcache/fd_dcache.h#L198>)

Calculates the starting chunk index of a data cache relative to a base address.
- **Inputs**:
    - `base`: A pointer to the base address used for chunk indexing.
    - `dcache`: A pointer to the data cache whose starting chunk index is to be calculated.
- **Logic and Control Flow**:
    - Convert `dcache` and `base` pointers to unsigned long integers.
    - Subtract the `base` address from the `dcache` address to get the offset.
    - Right shift the offset by `FD_CHUNK_LG_SZ` to calculate the starting chunk index.
- **Output**: Returns the starting chunk index as an unsigned long integer.


---
### fd\_dcache\_compact\_chunk1<!-- {{#callable:fd_dcache_compact_chunk1}} -->
[View Source →](<../../../../../src/tango/dcache/fd_dcache.h#L204>)

Calculates the upper bound of chunk indices for a data cache's data region relative to a base address.
- **Inputs**:
    - `base`: A pointer to the base address used for chunk indexing.
    - `dcache`: A pointer to the data cache whose data region's chunk index upper bound is being calculated.
- **Logic and Control Flow**:
    - Convert `dcache` to an unsigned long integer.
    - Add the size of the data region of `dcache` (obtained by calling [`fd_dcache_data_sz`](<fd_dcache.c.md#fd_dcache_data_sz>)) to the converted `dcache` value.
    - Subtract the converted `base` value from the result.
    - Right shift the result by `FD_CHUNK_LG_SZ` to calculate the chunk index.
- **Output**: Returns an unsigned long integer representing the upper bound of chunk indices for the data cache's data region.
- **Functions Called**:
    - [`fd_dcache_data_sz`](<fd_dcache.c.md#fd_dcache_data_sz>)


---
### fd\_dcache\_compact\_wmark<!-- {{#callable:fd_dcache_compact_wmark}} -->
[View Source →](<../../../../../src/tango/dcache/fd_dcache.h#L210>)

Calculates the watermark chunk index for a dcache based on the maximum transmission unit (MTU).
- **Inputs**:
    - `base`: A pointer to the base address used for chunk indexing.
    - `dcache`: A pointer to the dcache's data region.
    - `mtu`: The maximum transmission unit size in bytes.
- **Logic and Control Flow**:
    - Calculate `chunk_mtu` by adjusting `mtu` to align with chunk boundaries and doubling it.
    - Call [`fd_dcache_compact_chunk1`](<#fd_dcache_compact_chunk1>) to get the end chunk index of the dcache's data region.
    - Subtract `chunk_mtu` from the result of [`fd_dcache_compact_chunk1`](<#fd_dcache_compact_chunk1>) to get the watermark chunk index.
- **Output**: Returns the watermark chunk index as an unsigned long integer.
- **Functions Called**:
    - [`fd_dcache_compact_chunk1`](<#fd_dcache_compact_chunk1>)


---
### fd\_dcache\_compact\_next<!-- {{#callable:fd_dcache_compact_next}} -->
[View Source →](<../../../../../src/tango/dcache/fd_dcache.h#L262>)

Calculates the next chunk index for compact dcache storage, wrapping to the start if necessary.
- **Inputs**:
    - `chunk`: The current chunk index, assumed to be within the range [chunk0, wmark].
    - `sz`: The size of the data to be stored, assumed to be within the range [0, mtu].
    - `chunk0`: The starting chunk index, obtained from `fd_dcache_compact_chunk0`.
    - `wmark`: The watermark chunk index, obtained from `fd_dcache_compact_wmark`.
- **Logic and Control Flow**:
    - Calculate the number of chunks needed to store the data by adding `sz` to `2*FD_CHUNK_SZ-1`, right-shifting by `1+FD_CHUNK_LG_SZ`, and then left-shifting by 1.
    - Add the calculated number of chunks to the current `chunk` index to determine the next chunk index.
    - Use `fd_ulong_if` to check if the new chunk index exceeds `wmark`. If it does, return `chunk0`; otherwise, return the new chunk index.
- **Output**: Returns the next chunk index, which will be within the range [chunk0, wmark].


# Function Declarations (Public API)

---
### fd\_dcache\_req\_data\_sz<!-- {{#callable_declaration:fd_dcache_req_data_sz}} -->
[View Source →](<../../../../../src/tango/dcache/fd_dcache.h#L57>)

Calculates the required data region size for a dcache.
- **Description**: Use this function to determine the size of the data region needed for a dcache when the producer writes fragment payloads up to a specified maximum transmission unit (MTU) size. The function considers the number of payloads that can be visible to consumers (depth) and the number of payloads the producer can prepare concurrently (burst). The compact parameter indicates if the storage should be compact. The function returns zero if any input is zero or if the calculated size exceeds the maximum allowable size.
- **Inputs**:
    - `mtu`: The maximum size of a fragment payload in bytes. Must be greater than zero. If zero, the function returns zero.
    - `depth`: The maximum number of fragment payloads visible to consumers. Must be greater than zero. If zero, the function returns zero.
    - `burst`: The maximum number of fragment payloads the producer can prepare concurrently. Must be greater than zero. If zero, the function returns zero.
    - `compact`: An integer indicating if the storage should be compact. Non-zero values enable compact storage, while zero disables it.
- **Output**: Returns the size of the data region in bytes, or zero if any input is invalid or if the size calculation overflows.
- **See Also**: [`fd_dcache_req_data_sz`](<fd_dcache.c.md#fd_dcache_req_data_sz>)  (Implementation)


---
### fd\_dcache\_align<!-- {{#callable_declaration:fd_dcache_align}} -->
[View Source →](<../../../../../src/tango/dcache/fd_dcache.h#L81>)

Returns the required alignment for a dcache.
- **Description**: Use this function to obtain the alignment requirement for a dcache. This alignment is necessary to ensure proper memory access and performance. The function is useful when setting up memory regions for dcache usage, ensuring they meet the alignment constraints. It is a constant value and does not depend on any input parameters.
- **Inputs**: None
- **Output**: Returns an unsigned long representing the alignment requirement for a dcache.
- **See Also**: [`fd_dcache_align`](<fd_dcache.c.md#fd_dcache_align>)  (Implementation)


---
### fd\_dcache\_footprint<!-- {{#callable_declaration:fd_dcache_footprint}} -->
[View Source →](<../../../../../src/tango/dcache/fd_dcache.h#L84>)

Calculates the memory footprint for a dcache with specified data and application sizes.
- **Description**: Use this function to determine the total memory footprint required for a dcache that includes a data region and an application region. This function is useful for validating dcache configuration parameters. It returns the footprint in bytes, which includes alignment and header considerations. If the calculated footprint exceeds `ULONG_MAX`, the function returns 0, indicating an invalid configuration. This function can handle zero values for `data_sz` and `app_sz`, which are valid inputs.
- **Inputs**:
    - `data_sz`: The size in bytes of the data region. Must be a valid size such that the total footprint does not exceed `ULONG_MAX`. Zero is a valid input.
    - `app_sz`: The size in bytes of the application region. Must be a valid size such that the total footprint does not exceed `ULONG_MAX`. Zero is a valid input.
- **Output**: Returns the total memory footprint in bytes for the specified dcache configuration, or 0 if the configuration is invalid (e.g., if the footprint exceeds `ULONG_MAX`).
- **See Also**: [`fd_dcache_footprint`](<fd_dcache.c.md#fd_dcache_footprint>)  (Implementation)


---
### fd\_dcache\_new<!-- {{#callable_declaration:fd_dcache_new}} -->
[View Source →](<../../../../../src/tango/dcache/fd_dcache.h#L100>)

Formats a memory region for use as a dcache.
- **Description**: Use this function to prepare a memory region for use as a dcache, which includes a data region and an application region. The memory region must be aligned and have a sufficient footprint for the specified sizes. The function initializes the data and application regions to zero. It returns a pointer to the formatted memory region on success or NULL on failure, logging details of any errors. Ensure that the `shmem` pointer is not NULL and is properly aligned before calling this function.
- **Inputs**:
    - `shmem`: A non-NULL pointer to the memory region to format as a dcache. The memory must be aligned according to `fd_dcache_align()` and have a sufficient footprint for the specified sizes. If `shmem` is NULL or misaligned, the function returns NULL.
    - `data_sz`: The size in bytes of the data region within the dcache. Zero is a valid value. If the size is invalid, the function returns NULL.
    - `app_sz`: The size in bytes of the application region within the dcache. Zero is a valid value. If the size is invalid, the function returns NULL.
- **Output**: Returns a pointer to the formatted memory region on success, or NULL on failure.
- **See Also**: [`fd_dcache_new`](<fd_dcache.c.md#fd_dcache_new>)  (Implementation)


---
### fd\_dcache\_join<!-- {{#callable_declaration:fd_dcache_join}} -->
[View Source →](<../../../../../src/tango/dcache/fd_dcache.h#L120>)

Joins the caller to a dcache.
- **Description**: Use this function to join a caller to a dcache by providing a pointer to the memory region backing the dcache. The function returns a pointer to the dcache's data region in the local address space if successful. Ensure that the `shdcache` pointer is correctly aligned and points to a valid dcache memory region. A successful join must be followed by a corresponding leave operation. The function logs a warning and returns NULL if the `shdcache` is NULL, misaligned, or does not have the correct magic number.
- **Inputs**:
    - `shdcache`: A pointer to the first byte of the memory region backing the dcache. Must not be NULL, must be aligned according to `fd_dcache_align()`, and must point to a valid dcache with the correct magic number. If invalid, the function logs a warning and returns NULL.
- **Output**: Returns a pointer to the dcache's data region in the local address space on success, or NULL on failure.
- **See Also**: [`fd_dcache_join`](<fd_dcache.c.md#fd_dcache_join>)  (Implementation)


---
### fd\_dcache\_leave<!-- {{#callable_declaration:fd_dcache_leave}} -->
[View Source →](<../../../../../src/tango/dcache/fd_dcache.h#L128>)

Leaves a current local join of a dcache.
- **Description**: Use this function to leave a current local join of a dcache. It returns a pointer to the underlying shared memory region if successful. If the input is null, it logs a warning and returns null. Ensure that the dcache is not null before calling this function.
- **Inputs**:
    - `dcache`: A pointer to the dcache to leave. Must not be null. If null, the function logs a warning and returns null.
- **Output**: Returns a pointer to the underlying shared memory region on success, or null if the input is null.
- **See Also**: [`fd_dcache_leave`](<fd_dcache.c.md#fd_dcache_leave>)  (Implementation)


---
### fd\_dcache\_delete<!-- {{#callable_declaration:fd_dcache_delete}} -->
[View Source →](<../../../../../src/tango/dcache/fd_dcache.h#L137>)

Unformats a memory region used as a dcache.
- **Description**: Use this function to unformat a memory region that was previously formatted as a dcache. Ensure that no threads are joined to the dcache before calling this function. This function transfers ownership of the memory region back to the caller. It returns a pointer to the underlying shared memory region or NULL if the input is invalid, such as when the input is not a valid dcache. The function logs details of any errors encountered.
- **Inputs**:
    - `shdcache`: A pointer to the memory region that is currently formatted as a dcache. Must not be NULL and must be aligned according to `fd_dcache_align()`. The memory region should have been previously formatted as a dcache and should not have any active joins. If the pointer is NULL or misaligned, the function returns NULL and logs a warning.
- **Output**: Returns a pointer to the underlying shared memory region if successful, or NULL if the input is invalid.
- **See Also**: [`fd_dcache_delete`](<fd_dcache.c.md#fd_dcache_delete>)  (Implementation)


---
### fd\_dcache\_data\_sz<!-- {{#callable_declaration:fd_dcache_data_sz}} -->
[View Source →](<../../../../../src/tango/dcache/fd_dcache.h#L145>)

Returns the size of the data region in a dcache.
- **Description**: Use this function to get the size of the data region in a dcache. It is important to ensure that the dcache is a current local join before calling this function. This function does not modify the dcache or any other state.
- **Inputs**:
    - `dcache`: A pointer to the dcache from which to retrieve the data region size. Must not be null and must point to a valid dcache that is a current local join.
- **Output**: The size of the data region in bytes as an unsigned long integer.
- **See Also**: [`fd_dcache_data_sz`](<fd_dcache.c.md#fd_dcache_data_sz>)  (Implementation)


---
### fd\_dcache\_app\_sz<!-- {{#callable_declaration:fd_dcache_app_sz}} -->
[View Source →](<../../../../../src/tango/dcache/fd_dcache.h#L146>)

Returns the size of the application region in a dcache.
- **Description**: Use this function to obtain the size of the application-specific region within a dcache. This function assumes that the dcache is a current local join, meaning the caller is already joined to the dcache. It is important to ensure that the dcache pointer is valid and points to a properly initialized dcache structure.
- **Inputs**:
    - `dcache`: A pointer to the dcache from which to retrieve the application region size. Must not be null and must point to a valid dcache that is currently joined.
- **Output**: The size of the application region in the dcache, as an unsigned long integer.
- **See Also**: [`fd_dcache_app_sz`](<fd_dcache.c.md#fd_dcache_app_sz>)  (Implementation)


---
### fd\_dcache\_app\_laddr\_const<!-- {{#callable_declaration:fd_dcache_app_laddr_const}} -->
[View Source →](<../../../../../src/tango/dcache/fd_dcache.h#L155>)

Returns the local address of the application-specific memory region.
- **Description**: Use this function to get the address of the application-specific memory region within a dcache. This function assumes that the dcache is a current local join. The returned pointer is valid for the duration of the join and provides access to a memory region aligned to FD_DCACHE_ALIGN and sized according to fd_dcache_app_sz. Ensure that the dcache is properly joined before calling this function to avoid undefined behavior.
- **Inputs**:
    - `dcache`: A pointer to the dcache from which to retrieve the application-specific memory region. Must not be null and must point to a valid, currently joined dcache.
- **Output**: A pointer to the application-specific memory region within the dcache, aligned to FD_DCACHE_ALIGN.
- **See Also**: [`fd_dcache_app_laddr_const`](<fd_dcache.c.md#fd_dcache_app_laddr_const>)  (Implementation)


---
### fd\_dcache\_app\_laddr<!-- {{#callable_declaration:fd_dcache_app_laddr}} -->
[View Source →](<../../../../../src/tango/dcache/fd_dcache.h#L156>)

Returns the local address of the application-specific memory region.
- **Description**: Use this function to get the starting address of the application-specific region within a dcache. This function assumes that the dcache is currently joined in the local context. The returned address is aligned to FD_DCACHE_ALIGN and the size of the region is determined by `fd_dcache_app_sz`. The lifetime of the returned pointer is tied to the duration of the join.
- **Inputs**:
    - `dcache`: A pointer to the dcache from which to retrieve the application-specific memory address. It must not be null and must point to a currently joined dcache.
- **Output**: A pointer to the start of the application-specific memory region within the dcache.
- **See Also**: [`fd_dcache_app_laddr`](<fd_dcache.c.md#fd_dcache_app_laddr>)  (Implementation)


---
### fd\_dcache\_compact\_is\_safe<!-- {{#callable_declaration:fd_dcache_compact_is_safe}} -->
[View Source →](<../../../../../src/tango/dcache/fd_dcache.h#L184>)

Checks if a dcache can safely store fragments compactly.
- **Description**: Use this function to determine if a dcache can safely store fragments in a compact manner, which is necessary for efficient data handling. Ensure that both `base` and `dcache` are double chunk aligned and that `dcache` is a current local join. The function requires that `base` and `dcache` are relatively spaced identically across different thread groups and that the address space is small enough to allow 32-bit chunk indexing. The `mtu` and `depth` parameters must be positive, and the function will log warnings if any conditions are not met, returning 0 in such cases.
- **Inputs**:
    - `base`: A pointer to the base address used for chunk indexing. Must be double chunk aligned. If not aligned, the function logs a warning and returns 0.
    - `dcache`: A pointer to the dcache. Must not be null and must be double chunk aligned. If null or not aligned, the function logs a warning and returns 0.
    - `mtu`: The maximum fragment size that a producer might write into the dcache. Must be greater than zero. If zero, the function logs a warning and returns 0.
    - `depth`: The maximum number of fragments that might be concurrently accessed in the dcache. Must be greater than zero. If zero, the function logs a warning and returns 0.
- **Output**: Returns 1 if the dcache is safe for compact storage, otherwise returns 0 with warnings logged.
- **See Also**: [`fd_dcache_compact_is_safe`](<fd_dcache.c.md#fd_dcache_compact_is_safe>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)