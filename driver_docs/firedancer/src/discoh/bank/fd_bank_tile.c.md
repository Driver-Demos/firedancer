<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a bank tile for processing transactions, including transaction execution, commitment, and metrics tracking.

# Purpose
The code is a C module that implements a banking system for processing transactions in a distributed computing environment. It defines a structure `fd_bank_ctx_t` that holds the context for transaction processing, including memory pointers, transaction metrics, and workspace configurations. The module includes functions for initializing the banking context, handling transactions, and managing transaction metrics. It uses various external libraries and components, such as Blake3 for hashing and a Merkle tree for transaction verification.

The module provides functions to load, execute, and commit transactions, as well as to handle microblocks and bundles of transactions. It includes mechanisms for transaction validation, execution, and error handling. The code also defines external interfaces for executing and committing transaction bundles, which suggests that it is part of a larger system where these functions are called by other components. The module is designed to be integrated into a distributed system, as indicated by its use of distributed cache and workspace management functions.
# Imports and Dependencies

---
- `fd_bank_abi.h`
- `../../disco/tiles.h`
- `../../disco/pack/fd_pack.h`
- `../../disco/pack/fd_pack_cost.h`
- `../../ballet/blake3/fd_blake3.h`
- `../../ballet/bmtree/fd_bmtree.h`
- `../../disco/metrics/fd_metrics.h`
- `../../util/pod/fd_pod_format.h`
- `../../disco/pack/fd_pack_rebate_sum.h`
- `../../disco/metrics/generated/fd_metrics_bank.h`
- `../../disco/stem/fd_stem.c`


# Global Variables

---
### fd\_tile\_bank
- **Type**: ``fd_topo_run_tile_t``
- **Description**: A global variable of type `fd_topo_run_tile_t` that represents a tile configuration for a bank in a distributed system. It includes function pointers and parameters necessary for initializing and running the tile.
- **Use**: Used to define the configuration and behavior of a bank tile in the system.


# Data Structures

---
### fd\_bank\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``kind_id``: Stores the unique identifier for the kind of bank context.
    - ``blake3``: Pointer to a `fd_blake3_t` structure for Blake3 hashing.
    - ``bmtree``: Pointer to a binary merkle tree structure.
    - ``txn_abi_mem``: Pointer to memory for transaction ABI data.
    - ``txn_sidecar_mem``: Pointer to memory for transaction sidecar data.
    - ``_bank``: Internal pointer to the bank data.
    - ``_pack_idx``: Stores the index of the current pack.
    - ``_txn_idx``: Stores the index of the current transaction.
    - ``_is_bundle``: Indicates if the current context is a bundle.
    - ``busy_fseq``: Pointer to a sequence number indicating busy state.
    - ``pack_in_mem``: Pointer to workspace memory for input packing.
    - ``pack_in_chunk0``: Stores the initial chunk index for input packing.
    - ``pack_in_wmark``: Stores the watermark for input packing.
    - ``out_mem``: Pointer to workspace memory for output.
    - ``out_chunk0``: Stores the initial chunk index for output.
    - ``out_wmark``: Stores the watermark for output.
    - ``out_chunk``: Stores the current chunk index for output.
    - ``rebate_mem``: Pointer to workspace memory for rebates.
    - ``rebate_chunk0``: Stores the initial chunk index for rebates.
    - ``rebate_wmark``: Stores the watermark for rebates.
    - ``rebate_chunk``: Stores the current chunk index for rebates.
    - ``rebates_for_slot``: Stores the number of rebates for the current slot.
    - ``rebater``: Array of `fd_pack_rebate_sum_t` for rebate calculations.
    - ``metrics``: Structure containing various metrics related to transactions.
- **Description**: Manages the context for a bank, including transaction processing, memory management, and metrics tracking. It contains pointers to various memory regions for transaction data, hashing, and rebate calculations. The structure also maintains indices and flags for transaction and pack management, as well as a metrics sub-structure to track transaction outcomes and performance.


# Functions

---
### scratch\_align<!-- {{#callable:scratch_align}} -->
[View Source →](<../../../../../src/discoh/bank/fd_bank_tile.c#L58>)

Returns a constant alignment value of 128.
- **Inputs**: None
- **Logic and Control Flow**:
    - The function is defined as `static inline` and `FD_FN_CONST`, indicating it is a constant function that returns a fixed value.
    - The function body contains a single return statement that returns the unsigned long integer `128UL`.
- **Output**: An unsigned long integer value of 128.


---
### scratch\_footprint<!-- {{#callable:scratch_footprint}} -->
[View Source →](<../../../../../src/discoh/bank/fd_bank_tile.c#L63>)

Calculates the memory footprint required for various components in a bank context.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure, which is not used in the function.
- **Logic and Control Flow**:
    - Initialize `l` with `FD_LAYOUT_INIT` to start the layout calculation.
    - Append the size and alignment of `fd_bank_ctx_t` to `l` using `FD_LAYOUT_APPEND`.
    - Append the size and alignment of BLAKE3 footprint to `l`.
    - Append the size and alignment of BMTREE commit footprint with zero parameter to `l`.
    - Append the size and alignment of maximum transactions per microblock footprint to `l`.
    - Append the size and alignment of the maximum sidecar footprint to `l`.
    - Finalize the layout with `FD_LAYOUT_FINI` using the alignment from [`scratch_align`](<#scratch_align>) and return the result.
- **Output**: Returns an `ulong` representing the total memory footprint required.
- **Functions Called**:
    - [`scratch_align`](<#scratch_align>)


---
### metrics\_write<!-- {{#callable:metrics_write}} -->
[View Source →](<../../../../../src/discoh/bank/fd_bank_tile.c#L75>)

Updates various transaction metrics in the `fd_bank_ctx_t` context.
- **Inputs**:
    - `ctx`: A pointer to an `fd_bank_ctx_t` structure containing transaction metrics to update.
- **Logic and Control Flow**:
    - Copies the `txn_load_address_lookup_tables` metrics from `ctx` to the `BANK` context using `FD_MCNT_ENUM_COPY` macro.
    - Copies the `transaction_result` metrics from `ctx` to the `BANK` context using `FD_MCNT_ENUM_COPY` macro.
    - Sets the `processing_failed` metric in the `BANK` context using `FD_MCNT_SET` macro with the value from `ctx`.
    - Sets the `fee_only` metric in the `BANK` context using `FD_MCNT_SET` macro with the value from `ctx`.
    - Sets the `exec_failed` metric in the `BANK` context using `FD_MCNT_SET` macro with the value from `ctx`.
    - Sets the `success` metric in the `BANK` context using `FD_MCNT_SET` macro with the value from `ctx`.
- **Output**: No return value; the function updates metrics in the `BANK` context.


---
### before\_frag<!-- {{#callable:before_frag}} -->
[View Source →](<../../../../../src/discoh/bank/fd_bank_tile.c#L86>)

Checks if a given signature corresponds to a microblock and matches the context's kind ID.
- **Inputs**:
    - ``ctx``: A pointer to a `fd_bank_ctx_t` structure that contains the context information, including the kind ID.
    - ``in_idx``: An unsigned long integer representing the input index, which is not used in the function.
    - ``seq``: An unsigned long integer representing the sequence number, which is not used in the function.
    - ``sig``: An unsigned long integer representing the signature to be checked.
- **Logic and Control Flow**:
    - Ignore `in_idx` and `seq` as they are not used in the function logic.
    - Check if the packet type of the signature `sig` is not `POH_PKT_TYPE_MICROBLOCK` using `fd_disco_poh_sig_pkt_type`. If true, return 1.
    - Determine the target bank index from the signature `sig` using `fd_disco_poh_sig_bank_tile`.
    - Check if the target bank index does not match `ctx->kind_id`. If true, return 1.
    - If both checks pass, return 0.
- **Output**: Returns 0 if the signature corresponds to a microblock and matches the context's kind ID; otherwise, returns 1.


---
### during\_frag<!-- {{#callable:during_frag}} -->
[View Source →](<../../../../../src/discoh/bank/fd_bank_tile.c#L108>)

Copies data from a source memory location to a destination memory location and updates context with trailer information.
- **Inputs**:
    - `ctx`: A pointer to `fd_bank_ctx_t` structure that holds context information for the bank.
    - `in_idx`: An unused parameter of type `ulong`.
    - `seq`: An unused parameter of type `ulong`.
    - `sig`: An unused parameter of type `ulong`.
    - `chunk`: An `ulong` representing the index of the chunk in the input memory.
    - `sz`: An `ulong` representing the size of the data to be copied.
    - `ctl`: An unused parameter of type `ulong`.
- **Logic and Control Flow**:
    - Convert the `chunk` index to a source address `src` using `fd_chunk_to_laddr` with `ctx->pack_in_mem`.
    - Convert the `ctx->out_chunk` index to a destination address `dst` using `fd_chunk_to_laddr` with `ctx->out_mem`.
    - Check if `chunk` is outside the valid range or if `sz` exceeds `USHORT_MAX`; log an error if true.
    - Copy data from `src` to `dst`, excluding the size of `fd_microblock_bank_trailer_t`.
    - Retrieve the trailer from the end of the source data and update `ctx` with the trailer's bank, pack index, transaction index, and bundle status.
- **Output**: No return value; updates the `ctx` structure with trailer information.


---
### hash\_transactions<!-- {{#callable:hash_transactions}} -->
[View Source →](<../../../../../src/discoh/bank/fd_bank_tile.c#L131>)

Hashes transactions and updates the mixin with the resulting Merkle root.
- **Inputs**:
    - `mem`: A pointer to memory used for initializing the Merkle tree.
    - `txns`: An array of transaction pointers to be processed.
    - `txn_cnt`: The number of transactions in the `txns` array.
    - `mixin`: A pointer to a buffer where the resulting Merkle root will be stored.
- **Logic and Control Flow**:
    - Initialize a Merkle tree using `fd_bmtree_commit_init` with the provided memory.
    - Iterate over each transaction in the `txns` array.
    - For each transaction, check if it has the `FD_TXN_P_FLAGS_EXECUTE_SUCCESS` flag set; if not, skip it.
    - For each signature in a successful transaction, hash the signature data using `fd_bmtree_hash_leaf` and append the hash to the Merkle tree using `fd_bmtree_commit_append`.
    - Finalize the Merkle tree using `fd_bmtree_commit_fini` to get the root hash.
    - Copy the root hash to the `mixin` buffer using `fd_memcpy`.
- **Output**: The function does not return a value but updates the `mixin` buffer with the Merkle root of the hashed transactions.


---
### handle\_microblock<!-- {{#callable:handle_microblock}} -->
[View Source →](<../../../../../src/discoh/bank/fd_bank_tile.c#L152>)

Processes a microblock by sanitizing transactions, executing them, updating metrics, and publishing results.
- **Inputs**:
    - `ctx`: A pointer to `fd_bank_ctx_t`, which contains the context for the bank operations.
    - `seq`: An unsigned long integer representing the sequence number of the microblock.
    - `sig`: An unsigned long integer representing the signature of the microblock.
    - `sz`: An unsigned long integer representing the size of the microblock.
    - `begin_tspub`: An unsigned long integer representing the timestamp when the microblock processing began.
    - `stem`: A pointer to `fd_stem_context_t`, which is used for publishing the results.
- **Logic and Control Flow**:
    - Convert the output memory chunk to a local address using `fd_chunk_to_laddr`.
    - Calculate the slot and transaction count from the signature and size, respectively.
    - Initialize arrays for writable addresses, processing results, transaction errors, consumed compute units, timestamps, and tips.
    - Iterate over each transaction to sanitize and initialize them using [`fd_bank_abi_txn_init`](<fd_bank_abi.c.md#fd_bank_abi_txn_init>).
    - Update metrics based on the result of transaction initialization.
    - Execute sanitized transactions using `fd_ext_bank_load_and_execute_txns` and update metrics based on execution results.
    - Iterate over transactions to update flags, compute units, and metrics based on execution success or failure.
    - Commit transactions using `fd_ext_bank_commit_txns` and update the sequence number using `fd_fseq_update`.
    - Prepare rebates and update the rebate sum using `fd_pack_rebate_sum_add_txn`.
    - Hash transactions for inclusion in the PoH hash using [`hash_transactions`](<#hash_transactions>).
    - Calculate and update transaction timing percentages in the microblock trailer.
    - Write metrics using [`metrics_write`](<#metrics_write>).
    - Publish the microblock using `fd_stem_publish` and update the output chunk.
- **Output**: No return value; the function operates on the provided context and updates it accordingly.
- **Functions Called**:
    - [`fd_bank_abi_txn_init`](<fd_bank_abi.c.md#fd_bank_abi_txn_init>)
    - [`fd_bank_abi_get_lookup_addresses`](<fd_bank_abi.c.md#fd_bank_abi_get_lookup_addresses>)
    - [`hash_transactions`](<#hash_transactions>)
    - [`metrics_write`](<#metrics_write>)


---
### handle\_bundle<!-- {{#callable:handle_bundle}} -->
[View Source →](<../../../../../src/discoh/bank/fd_bank_tile.c#L333>)

Processes a bundle of transactions, executing and committing them, updating metrics, and publishing results.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_bank_ctx_t` context structure containing transaction and memory information.
    - ``seq``: An unsigned long integer representing the sequence number of the transaction bundle.
    - ``sig``: An unsigned long integer representing the signature of the transaction bundle.
    - ``sz``: An unsigned long integer representing the size of the transaction bundle.
    - ``begin_tspub``: An unsigned long integer representing the timestamp when processing began.
    - ``stem``: A pointer to the `fd_stem_context_t` structure used for publishing results.
- **Logic and Control Flow**:
    - Convert the output memory chunk to a local address and cast it to a transaction pointer array.
    - Calculate the slot and transaction count from the signature and size, respectively.
    - Initialize writable address lookup tables and set execution success to true.
    - Iterate over each transaction, initializing ABI transactions and updating metrics; mark transactions as sanitized if successful.
    - Execute and commit the bundle of transactions if all transactions are sanitized successfully.
    - Update metrics and transaction flags based on execution success or failure.
    - Update the sequence number to indicate processing completion.
    - Iterate over transactions to calculate consumed compute units and update rebate and consumed metrics.
    - Add transactions to the rebate sum and prepare them for publishing.
    - Publish each transaction separately into its own microblock, updating the trailer with execution details and timestamps.
    - Write metrics to the context.
- **Output**: No return value; the function updates the context and publishes transaction results.
- **Functions Called**:
    - [`fd_bank_abi_txn_init`](<fd_bank_abi.c.md#fd_bank_abi_txn_init>)
    - [`fd_bank_abi_get_lookup_addresses`](<fd_bank_abi.c.md#fd_bank_abi_get_lookup_addresses>)
    - [`hash_transactions`](<#hash_transactions>)
    - [`metrics_write`](<#metrics_write>)


---
### after\_frag<!-- {{#callable:after_frag}} -->
[View Source →](<../../../../../src/discoh/bank/fd_bank_tile.c#L493>)

Processes a fragment by handling either a bundle or a microblock, updating rebates, and publishing results.
- **Inputs**:
    - ``ctx``: A pointer to the `fd_bank_ctx_t` context structure containing the state and configuration for the bank.
    - ``in_idx``: An unused input index.
    - ``seq``: The sequence number of the fragment.
    - ``sig``: The signature of the fragment, used to determine the slot.
    - ``sz``: The size of the fragment.
    - ``tsorig``: The original timestamp of the fragment.
    - ``tspub``: The publication timestamp of the fragment.
    - ``stem``: A pointer to the `fd_stem_context_t` structure used for publishing.
- **Logic and Control Flow**:
    - Calculate the slot from the signature using `fd_disco_poh_sig_slot`.
    - Check if the slot is different from `ctx->rebates_for_slot`; if so, clear the rebates and update `ctx->rebates_for_slot`.
    - Determine if the context is a bundle or a microblock using `ctx->_is_bundle` and call [`handle_bundle`](<#handle_bundle>) or [`handle_microblock`](<#handle_microblock>) accordingly.
    - In a loop, report the rebate sum using `fd_pack_rebate_sum_report` and publish the result using `fd_stem_publish`.
    - Update `ctx->rebate_chunk` using `fd_dcache_compact_next` after each publication.
- **Output**: No return value; the function operates through side effects on the context and publishes results.
- **Functions Called**:
    - [`handle_bundle`](<#handle_bundle>)
    - [`handle_microblock`](<#handle_microblock>)


---
### unprivileged\_init<!-- {{#callable:unprivileged_init}} -->
[View Source →](<../../../../../src/discoh/bank/fd_bank_tile.c#L525>)

Initializes the unprivileged context for a bank tile using the provided topology and tile information.
- **Inputs**:
    - `topo`: A pointer to an `fd_topo_t` structure representing the topology of the system.
    - `tile`: A pointer to an `fd_topo_tile_t` structure representing the specific tile to initialize.
- **Logic and Control Flow**:
    - Allocate scratch memory using `fd_topo_obj_laddr` to get the local address of the tile object ID.
    - Initialize a scratch allocator with `FD_SCRATCH_ALLOC_INIT`.
    - Allocate memory for `fd_bank_ctx_t`, Blake3, and BMTREE using `FD_SCRATCH_ALLOC_APPEND`.
    - Set up transaction ABI memory and sidecar memory using `FD_SCRATCH_ALLOC_APPEND`.
    - Ensure non-null pointers for Blake3 and BMTREE using the `NONNULL` macro.
    - Set the `kind_id` of the context to the tile's `kind_id`.
    - Join the Blake3 and BMTREE contexts using `fd_blake3_join` and `fd_pack_rebate_sum_join`.
    - Query and join the busy flag sequence using `fd_pod_queryf_ulong` and `fd_fseq_join`.
    - Initialize metrics to zero using `memset`.
    - Configure input and output memory workspaces and chunks using `fd_dcache_compact_chunk0` and `fd_dcache_compact_wmark`.
- **Output**: No return value; the function initializes the context in place.



---
Made with ❤️ by [Driver](https://www.driver.ai/)