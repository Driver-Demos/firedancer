<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a transaction resolution system with blockhash management, transaction stashing, and metrics tracking.

# Purpose
The code is a C module that implements a transaction resolution system for a blockchain or distributed ledger environment. It manages the processing and validation of transactions by maintaining a history of recent blockhashes and handling transaction fragments. The module includes several key components, such as a blockhash ring to track recent blockhashes, a pool for managing transaction memory, and a map for associating blockhashes with their respective slots. It also includes logic to handle different types of transaction inputs, such as bank and fragment types, and processes them accordingly.

The module defines several data structures, such as `blockhash_t`, `blockhash_map_t`, and `fd_resolv_ctx_t`, which are used to store and manage transaction-related data. It uses macros and templates to implement data structures like maps and lists, which are used to efficiently manage and query transaction data. The code also includes functions for initializing the resolution context, processing transaction fragments, and publishing transactions. Additionally, it handles metrics collection to track various transaction processing statistics. The module is designed to be integrated into a larger system, as indicated by its use of external headers and its definition of a `fd_topo_run_tile_t` structure for integration with a topology-based execution framework.
# Imports and Dependencies

---
- `../bank/fd_bank_abi.h`
- `../../disco/tiles.h`
- `../../disco/fd_txn_m.h`
- `../../disco/metrics/fd_metrics.h`
- `../../flamenco/runtime/fd_system_ids.h`
- `../../flamenco/runtime/fd_system_ids_pp.h`
- `../../util/simd/fd_avx.h`
- `../../util/tmpl/fd_map.c`
- `../../util/tmpl/fd_pool.c`
- `../../util/tmpl/fd_dlist.c`
- `../../util/tmpl/fd_map_chain.c`
- `../../disco/stem/fd_stem.c`


# Global Variables

---
### null\_blockhash
- **Type**: ``blockhash_t``
- **Description**: A constant variable of type `blockhash_t` initialized with all zero values. It represents a blockhash with no valid data.
- **Use**: Used as a null or invalid key in blockhash-related operations, such as in maps or comparisons.


---
### \_fd\_ext\_resolv\_tile\_cnt
- **Type**: `ulong`
- **Description**: A static global variable that holds the count of resolution tiles in the system.
- **Use**: Used to store and access the number of resolution tiles, particularly in the `unprivileged_init` function to set the count when the tile kind ID is zero.


---
### fd\_tile\_resolv
- **Type**: ``fd_topo_run_tile_t``
- **Description**: Defines a tile configuration for the 'resolv' tile in the system. It includes function pointers and parameters necessary for the tile's operation, such as alignment, footprint, initialization, and execution functions.
- **Use**: Used to configure and manage the execution of the 'resolv' tile within the system's topology.


# Data Structures

---
### blockhash
- **Type**: ``struct``
- **Members**:
    - ``b``: An array of 32 unsigned characters (`uchar`) representing the block hash.
- **Description**: The `blockhash` structure is a simple data structure that contains a single member, `b`, which is an array of 32 unsigned characters. This array is used to store a block hash, which is a fixed-size representation of a block in a blockchain or similar system. The `blockhash` structure is used in various parts of the code to manage and compare block hashes, particularly in the context of identifying and managing transactions based on their associated block hashes.


---
### blockhash\_t
- **Type**: ``struct``
- **Members**:
    - ``b``: An array of 32 `uchar` elements representing the block hash.
- **Description**: Defines a `struct` named `blockhash` that contains a single member `b`, which is an array of 32 unsigned characters (`uchar`). This structure is used to store a block hash, which is a fixed-size representation of a block's hash value in a blockchain or similar system. The `blockhash_t` type is a typedef for this structure, allowing it to be used more conveniently in the code.


---
### blockhash\_map
- **Type**: ``struct``
- **Members**:
    - ``key``: A `blockhash_t` type that serves as the key in the map.
    - ``slot``: An `ulong` type that represents the slot associated with the key.
- **Description**: Maps a `blockhash_t` key to a corresponding slot number, facilitating the tracking of blockhashes and their expiration slots in a blockchain system.


---
### blockhash\_map\_t
- **Type**: ``struct``
- **Members**:
    - ``key``: A `blockhash_t` structure that serves as the key for the map.
    - ``slot``: An `ulong` value that represents the slot associated with the blockhash.
- **Description**: Maps a `blockhash_t` key to a slot number, which helps track the expiration of transactions based on their blockhashes. This structure is part of a larger system that manages blockhashes and their associated slots to ensure transactions are processed within their valid timeframes.


---
### fd\_stashed\_txn\_m\_t
- **Type**: ``struct``
- **Members**:
    - ``pool_next``: Stores the index of the next element in the pool when the transaction is released.
    - ``lru_next``: Stores the index of the next element in the LRU list when the transaction is acquired.
    - ``lru_prev``: Stores the index of the previous element in the LRU list.
    - ``map_next``: Stores the index of the next element in the map chain.
    - ``map_prev``: Stores the index of the previous element in the map chain.
    - ``blockhash``: Points to a `blockhash_t` structure representing the blockhash associated with the transaction.
    - ``_``: An array of `uchar` aligned to `fd_txn_m_t`, used to store transaction data.
- **Description**: `fd_stashed_txn_m_t` is a structure used to manage transactions in a pool, LRU list, and map chain. It uses a union to store either `pool_next` or `lru_next`, depending on whether the transaction is released or acquired. The structure also includes pointers and indices for managing the transaction's position in various data structures, as well as a blockhash pointer and a data array for storing transaction details.


---
### fd\_resolv\_in\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``kind``: An integer that specifies the type of input context.
    - ``mem``: A pointer to a `fd_wksp_t` structure, representing a memory workspace.
    - ``chunk0``: An unsigned long that indicates the starting chunk index.
    - ``wmark``: An unsigned long that represents the watermark or upper limit for chunks.
    - ``mtu``: An unsigned long that specifies the maximum transmission unit size.
- **Description**: Defines a structure used to manage input contexts in a resolution process, including type identification, memory workspace, and chunk management parameters.


---
### fd\_resolv\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``round_robin_idx``: Stores the current index for round-robin processing.
    - ``round_robin_cnt``: Stores the total count for round-robin processing.
    - ``bundle_failed``: Indicates if the current bundle processing has failed.
    - ``bundle_id``: Stores the identifier for the current bundle.
    - ``root_bank``: Points to the root bank structure.
    - ``root_slot``: Stores the slot number of the root bank.
    - ``blockhash_map``: Points to a map of blockhashes.
    - ``flushing_slot``: Stores the slot number currently being flushed.
    - ``flush_pool_idx``: Stores the index of the pool being flushed.
    - ``pool``: Points to a pool of stashed transactions.
    - ``map_chain``: Points to a map chain structure.
    - ``lru_list``: Stores a list for least recently used transactions.
    - ``completed_slot``: Stores the slot number of the last completed transaction.
    - ``blockhash_ring_idx``: Stores the current index in the blockhash ring.
    - ``blockhash_ring``: Stores a ring buffer of blockhashes.
    - ``_bank_msg``: Stores a message related to the bank, sized to `fd_completed_bank_t`.
    - ``metrics``: Stores various metrics related to transaction resolution.
    - ``in``: Stores an array of input contexts for transaction resolution.
    - ``out_mem``: Points to the output memory workspace.
    - ``out_chunk0``: Stores the initial chunk index for output.
    - ``out_wmark``: Stores the watermark for output chunks.
    - ``out_chunk``: Stores the current output chunk index.
- **Description**: Manages the context for resolving transactions, including round-robin processing, bundle management, blockhash tracking, and transaction stashing. It maintains various indices and pointers to manage transaction flow, metrics, and memory allocation for input and output operations.


# Functions

---
### scratch\_align<!-- {{#callable:scratch_align}} -->
[View Source →](<../../../../../src/discoh/resolv/fd_resolv_tile.c#L157>)

Returns the alignment requirement of the `fd_resolv_ctx_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls the `alignof` operator on the `fd_resolv_ctx_t` type to determine its alignment requirement.
    - Returns the result of the `alignof` operation.
- **Output**: An `ulong` representing the alignment requirement of the `fd_resolv_ctx_t` structure.


---
### scratch\_footprint<!-- {{#callable:scratch_footprint}} -->
[View Source →](<../../../../../src/discoh/resolv/fd_resolv_tile.c#L162>)

Calculates the memory footprint required for a scratch space based on various alignment and size requirements.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure, which is not used in the function.
- **Logic and Control Flow**:
    - Initialize `l` with `FD_LAYOUT_INIT`.
    - Append the size and alignment of `fd_resolv_ctx_t` to `l` using `FD_LAYOUT_APPEND`.
    - Append the alignment and footprint of a pool with `1UL<<16UL` elements to `l`.
    - Append the alignment and footprint of a map chain with `8192UL` elements to `l`.
    - Append the alignment and footprint of a map to `l`.
    - Finalize the layout with `FD_LAYOUT_FINI` using `scratch_align()` and return the result.
- **Output**: Returns an `ulong` representing the total memory footprint required for the scratch space.
- **Functions Called**:
    - [`scratch_align`](<#scratch_align>)


---
### fd\_ext\_resolv\_tile\_cnt<!-- {{#callable:fd_ext_resolv_tile_cnt}} -->
[View Source →](<../../../../../src/discoh/resolv/fd_resolv_tile.c#L177>)

Waits for the volatile variable `_fd_ext_resolv_tile_cnt` to become non-zero and then returns its value.
- **Inputs**: None
- **Logic and Control Flow**:
    - Enters a `while` loop that continues as long as `_fd_ext_resolv_tile_cnt` is zero.
    - Uses the `FD_VOLATILE` macro to access `_fd_ext_resolv_tile_cnt` to ensure the compiler does not optimize away the loop.
    - Exits the loop once `_fd_ext_resolv_tile_cnt` is non-zero.
    - Returns the value of `_fd_ext_resolv_tile_cnt`.
- **Output**: Returns the value of the volatile variable `_fd_ext_resolv_tile_cnt` as an unsigned long integer.


---
### metrics\_write<!-- {{#callable:metrics_write}} -->
[View Source →](<../../../../../src/discoh/resolv/fd_resolv_tile.c#L183>)

Writes metrics data from the `fd_resolv_ctx_t` context to the metrics system.
- **Inputs**:
    - `ctx`: A pointer to an `fd_resolv_ctx_t` structure containing metrics data to write.
- **Logic and Control Flow**:
    - Set the `BLOCKHASH_EXPIRED` metric using `ctx->metrics.blockhash_expired`.
    - Copy the `LUT_RESOLVED` metrics from `ctx->metrics.lut` using an enumeration copy operation.
    - Copy the `STASH_OPERATION` metrics from `ctx->metrics.stash` using an enumeration copy operation.
    - Set the `TRANSACTION_BUNDLE_PEER_FAILURE` metric using `ctx->metrics.bundle_peer_failure_cnt`.
- **Output**: No return value; the function writes metrics data to the metrics system.


---
### before\_frag<!-- {{#callable:before_frag}} -->
[View Source →](<../../../../../src/discoh/resolv/fd_resolv_tile.c#L191>)

Determines if a fragment should be processed based on its type and a round-robin scheduling mechanism.
- **Inputs**:
    - `ctx`: A pointer to a `fd_resolv_ctx_t` structure that contains context information for resolution.
    - `in_idx`: An unsigned long integer representing the index of the input in the context's input array.
    - `seq`: An unsigned long integer representing the sequence number of the fragment.
    - `sig`: An unsigned long integer representing a signature, which is unused in this function.
- **Logic and Control Flow**:
    - Ignore the `sig` parameter as it is not used in the function.
    - Check if the input kind at index `in_idx` in `ctx` is `FD_RESOLV_IN_KIND_BANK`; if true, return 0, indicating the fragment should not be processed.
    - Calculate the modulus of `seq` by `ctx->round_robin_cnt` and compare it to `ctx->round_robin_idx`.
    - Return the result of the comparison, which determines if the fragment should be processed based on the round-robin index.
- **Output**: Returns an integer: 0 if the fragment is of kind `FD_RESOLV_IN_KIND_BANK` or if the round-robin condition is not met, otherwise returns 1.


---
### during\_frag<!-- {{#callable:during_frag}} -->
[View Source →](<../../../../../src/discoh/resolv/fd_resolv_tile.c#L203>)

Processes a fragment by verifying its validity and copying data based on its type.
- **Inputs**:
    - `ctx`: A pointer to a `fd_resolv_ctx_t` structure that contains context information for resolution.
    - `in_idx`: An index indicating which input context to use from the `ctx->in` array.
    - `seq`: An unused parameter, marked with `FD_PARAM_UNUSED`.
    - `sig`: An unused parameter, marked with `FD_PARAM_UNUSED`.
    - `chunk`: The chunk identifier to process.
    - `sz`: The size of the data to process.
    - `ctl`: An unused parameter, marked with `FD_PARAM_UNUSED`.
- **Logic and Control Flow**:
    - Checks if the `chunk` is within the valid range defined by `ctx->in[in_idx].chunk0` and `ctx->in[in_idx].wmark`, and if `sz` is less than or equal to `ctx->in[in_idx].mtu`; logs an error if not.
    - Switches based on `ctx->in[in_idx].kind` to determine the type of input.
    - If the input kind is `FD_RESOLV_IN_KIND_BANK`, copies data from the source address to `ctx->_bank_msg`.
    - If the input kind is `FD_RESOLV_IN_KIND_FRAGMENT`, copies data from the source address to the destination address in `ctx->out_mem`.
    - Logs an error if the input kind is unknown.
- **Output**: No return value; the function performs operations based on the input parameters and context.


---
### publish\_txn<!-- {{#callable:publish_txn}} -->
[View Source →](<../../../../../src/discoh/resolv/fd_resolv_tile.c#L230>)

Publishes a transaction by copying it to an output memory location, resolving address lookup tables if necessary, and updating metrics.
- **Inputs**:
    - ``ctx``: A pointer to a `fd_resolv_ctx_t` structure that contains context information for transaction resolution and publication.
    - ``stem``: A pointer to a `fd_stem_context_t` structure used for publishing the transaction.
    - ``stashed``: A constant pointer to a `fd_stashed_txn_m_t` structure representing the transaction to be published.
- **Logic and Control Flow**:
    - Convert the output memory chunk to a local address and copy the stashed transaction data to it.
    - Retrieve the transaction metadata from the copied transaction data.
    - Set the transaction's reference slot to the context's flushing slot.
    - Check if the transaction has additional address table counts; if so, resolve address lookup tables using the root bank if available.
    - If address resolution fails, increment the 'no bank drop' metric and return 0.
    - Calculate the realized size of the transaction and the publication timestamp.
    - Publish the transaction using `fd_stem_publish` with the calculated parameters.
    - Update the output chunk to the next compacted position.
    - Return 1 to indicate successful publication.
- **Output**: Returns an integer indicating success (1) or failure (0) of the transaction publication.


---
### after\_credit<!-- {{#callable:after_credit}} -->
[View Source →](<../../../../../src/discoh/resolv/fd_resolv_tile.c#L262>)

Manages the post-transaction processing by updating metrics, releasing resources, and preparing for the next transaction.
- **Inputs**:
    - `ctx`: A pointer to the `fd_resolv_ctx_t` structure, which contains the context for the resolution process.
    - `stem`: A pointer to the `fd_stem_context_t` structure, which is used for transaction publishing.
    - `opt_poll_in`: A pointer to an integer that indicates whether polling is needed.
    - `charge_busy`: A pointer to an integer that indicates whether the system is busy.
- **Logic and Control Flow**:
    - Check if `ctx->flush_pool_idx` is equal to `ULONG_MAX`; if true, return immediately.
    - Set `*charge_busy` to 1 and `*opt_poll_in` to 0 to indicate the system is busy and polling is not needed.
    - Calculate the next index in the chain using `map_chain_idx_next_const` and store it in `next`.
    - Remove the current index from the map chain using `map_chain_idx_remove_fast`.
    - Attempt to publish the transaction using [`publish_txn`](<#publish_txn>); if successful, increment the published metric, otherwise increment the removed metric.
    - Remove the current index from the LRU list using `lru_list_idx_remove`.
    - Release the current index back to the pool using `pool_idx_release`.
    - Update `ctx->flush_pool_idx` to the next index.
- **Output**: No return value; the function modifies the state of the input pointers and context.
- **Functions Called**:
    - [`publish_txn`](<#publish_txn>)


---
### fd\_resolv\_is\_durable\_nonce<!-- {{#callable:fd_resolv_is_durable_nonce}} -->
[View Source →](<../../../../../src/discoh/resolv/fd_resolv_tile.c#L287>)

Determines if a transaction is a durable nonce transaction by checking specific conditions on its first instruction.
- **Inputs**:
    - `txn`: A pointer to a `fd_txn_t` structure representing the transaction to check.
    - `payload`: A pointer to a constant unsigned character array representing the transaction payload.
- **Logic and Control Flow**:
    - Check if the transaction's instruction count is zero; if so, return 0.
    - Retrieve the first instruction from the transaction and the program ID from the account addresses.
    - Compare the program ID with the system program ID; if they do not match, return 0.
    - Check if the first instruction has exactly three accounts and a data size of four bytes; if not, return 0.
    - Load a 4-byte unsigned integer from the payload at the data offset of the first instruction and check if it equals 4; return 1 if true, otherwise return 0.
- **Output**: Returns 1 if the transaction may be a durable nonce transaction, otherwise returns 0.


---
### after\_frag<!-- {{#callable:after_frag}} -->
[View Source →](<../../../../../src/discoh/resolv/fd_resolv_tile.c#L305>)

Processes transaction fragments and updates context based on the type of input and signature.
- **Inputs**:
    - ``ctx``: Pointer to the `fd_resolv_ctx_t` context structure.
    - ``in_idx``: Index of the input in the context's input array.
    - ``seq``: Sequence number of the fragment (unused in the function).
    - ``sig``: Signature indicating the type of fragment.
    - ``sz``: Size of the fragment (unused in the function).
    - ``tsorig``: Original timestamp of the fragment.
    - ``_tspub``: Publication timestamp (unused in the function).
    - ``stem``: Pointer to the `fd_stem_context_t` structure for publishing transactions.
- **Logic and Control Flow**:
    - Checks if the input kind is `FD_RESOLV_IN_KIND_BANK`; if true, processes based on `sig` value.
    - For `sig` 0, updates the root bank and slot in the context.
    - For `sig` 1, updates the blockhash ring and map, and sets the completed slot.
    - If `sig` is unknown, logs an error and returns.
    - If the input kind is not `FD_RESOLV_IN_KIND_BANK`, processes the transaction fragment.
    - Checks if the transaction is part of a bundle and updates the bundle status.
    - Queries the blockhash map to find the reference slot for the transaction.
    - Handles cases where the blockhash is not found by stashing the transaction or updating metrics.
    - If the transaction has address table entries, resolves them using the root bank.
    - Publishes the transaction using `fd_stem_publish` and updates the output chunk.
- **Output**: No return value; updates the context and publishes transactions as needed.
- **Functions Called**:
    - [`fd_resolv_is_durable_nonce`](<#fd_resolv_is_durable_nonce>)


---
### unprivileged\_init<!-- {{#callable:unprivileged_init}} -->
[View Source →](<../../../../../src/discoh/resolv/fd_resolv_tile.c#L461>)

Initializes an unprivileged context for a tile in a topology, setting up memory allocations and context parameters.
- **Inputs**:
    - ``topo``: A pointer to a `fd_topo_t` structure representing the topology.
    - ``tile``: A pointer to a `fd_topo_tile_t` structure representing the tile to initialize.
- **Logic and Control Flow**:
    - Allocate scratch memory for the tile using `fd_topo_obj_laddr` and `FD_SCRATCH_ALLOC_INIT`.
    - Create and initialize a `fd_resolv_ctx_t` context structure in the scratch memory.
    - Set `round_robin_cnt` and `round_robin_idx` based on the tile's name and kind ID.
    - Initialize various context fields such as `bundle_failed`, `bundle_id`, `completed_slot`, `blockhash_ring_idx`, and `flush_pool_idx`.
    - Join a pool and map chain using `pool_join` and `map_chain_join`, and verify their success with `FD_TEST`.
    - Initialize the LRU list and verify its success with `FD_TEST`.
    - If the tile's kind ID is zero, set `_fd_ext_resolv_tile_cnt` to `round_robin_cnt`.
    - Set `root_bank` to `NULL` and clear `blockhash_ring` and `metrics` using `memset`.
    - Join a blockhash map using `map_join` and verify its success with `FD_TEST`.
    - For each input link of the tile, determine its kind and initialize the corresponding `in` context fields.
    - Initialize output memory and chunk parameters using `fd_dcache_compact_chunk0` and `fd_dcache_compact_wmark`.
    - Finalize scratch memory allocation with `FD_SCRATCH_ALLOC_FINI` and check for overflow errors.
- **Output**: No return value; the function initializes the context in place.
- **Functions Called**:
    - [`scratch_footprint`](<#scratch_footprint>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)