<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a store tile for managing and processing data fragments in a distributed system.

# Purpose
The code defines a module for managing data storage and processing within a distributed system. It includes structures and functions to handle memory contexts (`fd_store_ctx_t` and `fd_store_in_ctx_t`) and provides mechanisms to initialize and manage data fragments. The module interfaces with an external blockstore, which is a storage system for data blocks, through the [`fd_ext_store_initialize`](<#fd_ext_store_initialize>) function and the [`fd_ext_blockstore_insert_shreds`](<#fd_ext_blockstore_insert_shreds>) function. These functions facilitate the initialization and insertion of data shreds into the blockstore.

The code also includes callback functions [`during_frag`](<#during_frag>) and [`after_frag`](<#after_frag>), which are used during the processing of data fragments. These functions perform operations such as data validation, memory copying, and insertion of data into the blockstore. The [`unprivileged_init`](<#unprivileged_init>) function initializes the storage context and waits for the blockstore to become available. The module is designed to be part of a larger system, as indicated by the inclusion of external headers and the use of macros for configuration. The `fd_tile_store` structure defines the entry points for running this module within a distributed topology, specifying functions for alignment, footprint calculation, initialization, and execution.
# Imports and Dependencies

---
- `../../disco/tiles.h`
- `../../disco/metrics/fd_metrics.h`
- `../../disco/stem/fd_stem.c`


# Global Variables

---
### fd\_ext\_blockstore
- **Type**: ``void const *``
- **Description**: A pointer to a constant memory location that represents an external blockstore. This variable is used to store the address of the blockstore that is initialized by the `fd_ext_store_initialize` function.
- **Use**: Used to hold the address of the blockstore for operations that require access to the blockstore, such as inserting shreds.


---
### fd\_tile\_store
- **Type**: ``fd_topo_run_tile_t``
- **Description**: Defines a tile configuration for a store operation in a distributed system. It includes function pointers for alignment, footprint calculation, initialization, and execution.
- **Use**: Used to configure and manage the execution of a store tile in a distributed topology.


# Data Structures

---
### fd\_store\_in\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``mem``: A pointer to an `fd_wksp_t` structure, representing a memory workspace.
    - ``chunk0``: An unsigned long integer representing the starting chunk index.
    - ``wmark``: An unsigned long integer representing the watermark or upper limit for chunk indices.
- **Description**: `fd_store_in_ctx_t` is a structure that holds context information for a memory workspace, including a pointer to the workspace, a starting chunk index, and a watermark indicating the upper limit for chunk indices. This structure is used to manage and track memory allocation and usage within a specific range of chunks.


---
### fd\_store\_ctx\_t
- **Type**: ``struct``
- **Members**:
    - ``mem``: An array of unsigned characters aligned to 32 bytes with a size defined by `FD_SHRED_STORE_MTU`.
    - ``disable_blockstore_from_slot``: An unsigned long integer that indicates whether to disable the blockstore from a specific slot.
    - ``in``: An array of 32 `fd_store_in_ctx_t` structures.
- **Description**: `fd_store_ctx_t` is a structure that manages memory and input contexts for a store operation. It contains a memory buffer `mem` for storing data, a flag `disable_blockstore_from_slot` to control blockstore operations, and an array `in` of `fd_store_in_ctx_t` structures to handle input contexts.


# Functions

---
### scratch\_align<!-- {{#callable:scratch_align}} -->
[View Source →](<../../../../../src/discoh/store/fd_store_tile.c#L18>)

Returns a constant alignment value of 128.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the constant value `128UL`.
- **Output**: The function returns an unsigned long integer with the value `128UL`.


---
### scratch\_footprint<!-- {{#callable:scratch_footprint}} -->
[View Source →](<../../../../../src/discoh/store/fd_store_tile.c#L23>)

Calculates the memory footprint required for a scratch space aligned to a specific boundary.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure, which is not used in the function.
- **Logic and Control Flow**:
    - Initialize a variable `l` with `FD_LAYOUT_INIT`.
    - Append the layout of `fd_store_ctx_t` to `l` using `FD_LAYOUT_APPEND`, considering its alignment and size.
    - Finalize the layout with `FD_LAYOUT_FINI`, aligning it to the value returned by `scratch_align()`.
- **Output**: Returns an `ulong` representing the calculated memory footprint for the scratch space.
- **Functions Called**:
    - [`scratch_align`](<#scratch_align>)


---
### fd\_ext\_store\_initialize<!-- {{#callable:fd_ext_store_initialize}} -->
[View Source →](<../../../../../src/discoh/store/fd_store_tile.c#L33>)

Initializes the external blockstore pointer and enforces a memory fence.
- **Inputs**:
    - `blockstore`: A pointer to the blockstore that will be stored in the `fd_ext_blockstore` variable.
- **Logic and Control Flow**:
    - Assigns the input `blockstore` to the static variable `fd_ext_blockstore`.
    - Calls `FD_COMPILER_MFENCE()` to ensure memory ordering and prevent reordering of memory operations.
- **Output**: No output is returned as the function has a `void` return type.


---
### during\_frag<!-- {{#callable:during_frag}} -->
[View Source →](<../../../../../src/discoh/store/fd_store_tile.c#L39>)

Copies a fragment of data from a source memory location to a destination memory location within a context, after validating the fragment's size and chunk range.
- **Inputs**:
    - `ctx`: A pointer to `fd_store_ctx_t`, which contains memory and input context information.
    - `in_idx`: An index to select the input context from the `ctx->in` array.
    - `seq`: An unused parameter, marked with `FD_PARAM_UNUSED`.
    - `sig`: An unused parameter, marked with `FD_PARAM_UNUSED`.
    - `chunk`: The chunk identifier to locate the source memory within the input context.
    - `sz`: The size of the data fragment to copy.
    - `ctl`: An unused parameter, marked with `FD_PARAM_UNUSED`.
- **Logic and Control Flow**:
    - Checks if `chunk` is within the valid range defined by `ctx->in[in_idx].chunk0` and `ctx->in[in_idx].wmark`, and if `sz` is within the valid size range (greater than or equal to 32 and less than or equal to `FD_SHRED_STORE_MTU`).
    - Logs an error and exits if the above conditions are not met.
    - Converts the `chunk` identifier to a source memory address using `fd_chunk_to_laddr`.
    - Copies `sz` bytes of data from the source memory address to the destination memory (`ctx->mem`) using `fd_memcpy`.
- **Output**: No return value; performs operations directly on the provided context.


---
### after\_frag<!-- {{#callable:after_frag}} -->
[View Source →](<../../../../../src/discoh/store/fd_store_tile.c#L64>)

Inserts shreds into an external blockstore after performing validation checks.
- **Inputs**:
    - `ctx`: A pointer to `fd_store_ctx_t`, which contains context information including memory and blockstore settings.
    - `in_idx`: An unused index of the input context.
    - `seq`: An unused sequence number.
    - `sig`: A signature flag used to indicate if the shreds are trusted.
    - `sz`: The size of the data to be processed.
    - `tsorig`: An unused original timestamp.
    - `tspub`: An unused publication timestamp.
    - `stem`: An unused pointer to `fd_stem_context_t`.
- **Logic and Control Flow**:
    - Casts `ctx->mem` to a `fd_shred34_t` pointer named `shred34`.
    - Performs validation checks on `shred34` to ensure `shred_sz` is less than or equal to `stride`, `offset` is less than `sz`, `shred_cnt` is less than or equal to 34, and the calculated memory range does not exceed `sz`.
    - Checks if `disable_blockstore_from_slot` is set and if the current slot is greater than or equal to it, in which case the function returns early.
    - Calls `fd_ext_blockstore_insert_shreds` to insert shreds into the external blockstore using the validated parameters.
    - Increments the transaction count metric `TRANSACTIONS_INSERTED` by `shred34->est_txn_cnt`.
- **Output**: No return value; performs operations on external resources and updates metrics.


---
### unprivileged\_init<!-- {{#callable:unprivileged_init}} -->
[View Source →](<../../../../../src/discoh/store/fd_store_tile.c#L97>)

Initializes the unprivileged context for a tile by setting up memory and waiting for blockstore availability.
- **Inputs**:
    - ``topo``: A pointer to an `fd_topo_t` structure representing the topology of the system.
    - ``tile``: A pointer to an `fd_topo_tile_t` structure representing the specific tile to initialize.
- **Logic and Control Flow**:
    - Obtain a local address for the tile's object ID using `fd_topo_obj_laddr` and store it in `scratch`.
    - Initialize scratch memory allocation with `FD_SCRATCH_ALLOC_INIT`.
    - Allocate memory for `fd_store_ctx_t` using `FD_SCRATCH_ALLOC_APPEND`.
    - Log a message indicating the start of blockstore acquisition.
    - Enter a loop that pauses until `fd_ext_blockstore` is available, then break the loop.
    - Use `FD_COMPILER_MFENCE` to ensure memory ordering after acquiring the blockstore.
    - Log a message indicating successful acquisition of the blockstore.
    - Set `ctx->disable_blockstore_from_slot` from `tile->store.disable_blockstore_from_slot`.
    - Iterate over each input link of the tile, setting up memory, chunk0, and watermark for each link using `fd_dcache_compact_chunk0` and `fd_dcache_compact_wmark`.
    - Finalize the scratch memory allocation with `FD_SCRATCH_ALLOC_FINI`.
    - Check for scratch memory overflow and log an error if it occurs.
- **Output**: No return value; the function initializes the context and sets up memory for the tile.
- **Functions Called**:
    - [`scratch_footprint`](<#scratch_footprint>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)