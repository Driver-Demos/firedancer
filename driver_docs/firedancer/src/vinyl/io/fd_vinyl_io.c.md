<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for managing and appending data blocks in a vinyl I/O stream, with support for LZ4 compression.

# Purpose
The code is a C source file that provides functions for handling input/output operations related to a data structure named `fd_vinyl_io_t`. It includes functions for finalizing the I/O operations, estimating scratchpad memory requirements, and appending various types of data blocks to a stream. The functions [`fd_vinyl_io_append_pair_raw`](<#fd_vinyl_io_append_pair_raw>), [`fd_vinyl_io_append_dead`](<#fd_vinyl_io_append_dead>), [`fd_vinyl_io_append_move`](<#fd_vinyl_io_append_move>), [`fd_vinyl_io_append_part`](<#fd_vinyl_io_append_part>), and [`fd_vinyl_io_append_pair_inplace`](<#fd_vinyl_io_append_pair_inplace>) are responsible for appending different types of data blocks, such as raw data pairs, dead records, move records, and partition records, to a data stream. These functions ensure data integrity by checking for corruption and using hash functions to maintain data consistency.

The file includes the header `fd_vinyl_io.h` and the LZ4 compression library, indicating that it supports data compression using the LZ4 algorithm. The function [`fd_vinyl_io_append_pair_inplace`](<#fd_vinyl_io_append_pair_inplace>) specifically handles the compression of data pairs if they exceed a certain size threshold, using LZ4 to reduce the data size before appending it to the stream. The code is structured to handle different styles of data, such as raw and LZ4-compressed, and uses critical checks to ensure that operations are performed correctly. The functions are designed to be part of a larger system, likely involving a data streaming or storage mechanism, and they provide a public API for managing data I/O operations within this context.
# Imports and Dependencies

---
- `fd_vinyl_io.h`
- `lz4.h`


# Functions

---
### fd\_vinyl\_io\_fini<!-- {{#callable:fd_vinyl_io_fini}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.c#L8>)

Finalizes the `fd_vinyl_io_t` object by calling its `fini` method if it is not NULL.
- **Inputs**:
    - `io`: A pointer to an `fd_vinyl_io_t` object that needs to be finalized.
- **Logic and Control Flow**:
    - Check if the `io` pointer is NULL.
    - If `io` is NULL, log a warning message 'NULL io' and return NULL.
    - If `io` is not NULL, call the `fini` method of the `impl` member of `io` and return its result.
- **Output**: Returns the result of the `fini` method of the `impl` member of `io`, or NULL if `io` is NULL.


---
### fd\_vinyl\_io\_spad\_est<!-- {{#callable:fd_vinyl_io_spad_est}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.c#L17>)

Estimates the size of a scratchpad required for a vinyl I/O operation using LZ4 compression.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `LZ4_COMPRESSBOUND` with `FD_VINYL_VAL_MAX` to determine the maximum compressed size of a value.
    - Casts the result of `LZ4_COMPRESSBOUND` to `ulong`.
    - Calls `fd_vinyl_bstream_pair_sz` with the result to get the size of a bstream pair.
    - Multiplies the result by 2UL to estimate the total scratchpad size.
    - Returns the calculated size.
- **Output**: Returns an `ulong` representing the estimated size of the scratchpad.


---
### fd\_vinyl\_io\_append\_pair\_raw<!-- {{#callable:fd_vinyl_io_append_pair_raw}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.c#L22>)

Appends a raw key-value pair to a vinyl I/O stream after formatting and hashing it.
- **Inputs**:
    - `io`: A pointer to the `fd_vinyl_io_t` structure representing the vinyl I/O stream.
    - `key`: A pointer to the `fd_vinyl_key_t` structure representing the key of the pair.
    - `info`: A pointer to the `fd_vinyl_info_t` structure containing metadata about the value, including its size.
    - `val`: A pointer to the value data to be appended.
- **Logic and Control Flow**:
    - Retrieve the size of the value from `info` and check if it is within the allowed maximum size.
    - Calculate the total size needed for the pair and allocate memory for it using [`fd_vinyl_io_alloc`](<fd_vinyl_io.h.md#fd_vinyl_io_alloc>).
    - Initialize a pointer `dst` to the start of the allocated memory and set `dst_rem` to the remaining size.
    - Create a pair header at the start of the allocated memory, setting control, key, and info fields.
    - Advance `dst` past the header and decrease `dst_rem` accordingly.
    - Copy the value data into the allocated memory if the value size is greater than zero.
    - Advance `dst` past the value data and decrease `dst_rem` accordingly.
    - Compute a hash for the pair using `fd_vinyl_bstream_pair_hash`.
    - Append the formatted and hashed pair to the vinyl I/O stream using [`fd_vinyl_io_append`](<fd_vinyl_io.h.md#fd_vinyl_io_append>).
- **Output**: Returns the result of the [`fd_vinyl_io_append`](<fd_vinyl_io.h.md#fd_vinyl_io_append>) function, which is an unsigned long integer.
- **Functions Called**:
    - [`fd_vinyl_io_alloc`](<fd_vinyl_io.h.md#fd_vinyl_io_alloc>)
    - [`fd_vinyl_io_seed`](<fd_vinyl_io.h.md#fd_vinyl_io_seed>)
    - [`fd_vinyl_io_append`](<fd_vinyl_io.h.md#fd_vinyl_io_append>)


---
### fd\_vinyl\_io\_append\_dead<!-- {{#callable:fd_vinyl_io_append_dead}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.c#L62>)

Appends a 'dead' block to the vinyl I/O stream with specified header and optional information.
- **Inputs**:
    - ``io``: A pointer to the `fd_vinyl_io_t` structure, representing the vinyl I/O context.
    - ``phdr``: A pointer to a constant `fd_vinyl_bstream_phdr_t` structure, representing the block header to append.
    - ``info``: A pointer to a constant void, representing additional information to include in the block, or NULL if no additional information is provided.
    - ``info_sz``: An unsigned long integer representing the size of the additional information, or 0 if no additional information is provided.
- **Logic and Control Flow**:
    - If `info` is NULL, set `info_sz` to 0.
    - Check if `info_sz` is less than or equal to `FD_VINYL_BSTREAM_DEAD_INFO_MAX`. If not, trigger a critical error indicating corruption.
    - Allocate memory for a `fd_vinyl_bstream_block_t` block using [`fd_vinyl_io_alloc`](<fd_vinyl_io.h.md#fd_vinyl_io_alloc>) with blocking flag.
    - Initialize the allocated block memory to zero using `memset`.
    - Set the control field of the block to a 'dead' type using `fd_vinyl_bstream_ctl`.
    - Set the sequence number of the block to `io->seq_future`.
    - Copy the provided `phdr` into the block's header field.
    - Set the block's information size field to `info_sz`.
    - If `info_sz` is greater than 0, copy the `info` data into the block's information field.
    - Compute the hash of the block using `fd_vinyl_bstream_block_hash`.
    - Append the block to the vinyl I/O stream using [`fd_vinyl_io_append`](<fd_vinyl_io.h.md#fd_vinyl_io_append>) and return the result.
- **Output**: Returns an unsigned long integer indicating the result of the append operation.
- **Functions Called**:
    - [`fd_vinyl_io_alloc`](<fd_vinyl_io.h.md#fd_vinyl_io_alloc>)
    - [`fd_vinyl_io_seed`](<fd_vinyl_io.h.md#fd_vinyl_io_seed>)
    - [`fd_vinyl_io_append`](<fd_vinyl_io.h.md#fd_vinyl_io_append>)


---
### fd\_vinyl\_io\_append\_move<!-- {{#callable:fd_vinyl_io_append_move}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.c#L89>)

Appends a move operation to the vinyl I/O stream by creating and initializing a block with move control information, source, destination, and optional additional information.
- **Inputs**:
    - ``io``: A pointer to the `fd_vinyl_io_t` structure, representing the vinyl I/O context.
    - ``src``: A pointer to the `fd_vinyl_bstream_phdr_t` structure, representing the source header for the move operation.
    - ``dst``: A pointer to the `fd_vinyl_key_t` structure, representing the destination key for the move operation.
    - ``info``: A pointer to additional information to include in the move operation, or `NULL` if no additional information is provided.
    - ``info_sz``: The size of the additional information in bytes, or 0 if `info` is `NULL`.
- **Logic and Control Flow**:
    - If `info` is `NULL`, set `info_sz` to 0.
    - Check if `info_sz` is less than or equal to `FD_VINYL_BSTREAM_MOVE_INFO_MAX`. If not, trigger a critical error indicating corruption.
    - Allocate a block of size `FD_VINYL_BSTREAM_BLOCK_SZ` using [`fd_vinyl_io_alloc`](<fd_vinyl_io.h.md#fd_vinyl_io_alloc>) with blocking flag.
    - Initialize the allocated block to zero using `memset`.
    - Set the move control information in the block using `fd_vinyl_bstream_ctl` with move type and raw style.
    - Set the sequence number in the block to `io->seq_future`.
    - Copy the source header and destination key into the block.
    - Set the size of the additional information in the block to `info_sz`.
    - If `info_sz` is greater than 0, copy the additional information into the block.
    - Compute the hash of the block using `fd_vinyl_bstream_block_hash`.
    - Append the block to the vinyl I/O stream using [`fd_vinyl_io_append`](<fd_vinyl_io.h.md#fd_vinyl_io_append>) and return the result.
- **Output**: Returns the result of the [`fd_vinyl_io_append`](<fd_vinyl_io.h.md#fd_vinyl_io_append>) function, which is an unsigned long integer representing the status of the append operation.
- **Functions Called**:
    - [`fd_vinyl_io_alloc`](<fd_vinyl_io.h.md#fd_vinyl_io_alloc>)
    - [`fd_vinyl_io_seed`](<fd_vinyl_io.h.md#fd_vinyl_io_seed>)
    - [`fd_vinyl_io_append`](<fd_vinyl_io.h.md#fd_vinyl_io_append>)


---
### fd\_vinyl\_io\_append\_part<!-- {{#callable:fd_vinyl_io_append_part}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.c#L118>)

Appends a part block to the vinyl I/O stream with specified sequence and count information.
- **Inputs**:
    - `io`: A pointer to the `fd_vinyl_io_t` structure representing the vinyl I/O context.
    - `seq0`: An unsigned long integer representing the initial sequence number for the part.
    - `dead_cnt`: An unsigned long integer representing the count of dead entries in the part.
    - `move_cnt`: An unsigned long integer representing the count of move entries in the part.
    - `info`: A pointer to a constant void type representing additional information for the part.
    - `info_sz`: An unsigned long integer representing the size of the additional information.
- **Logic and Control Flow**:
    - If `info` is NULL, set `info_sz` to 0.
    - Check if `info_sz` is less than or equal to `FD_VINYL_BSTREAM_PART_INFO_MAX`; if not, trigger a critical error.
    - Allocate memory for a `fd_vinyl_bstream_block_t` block using [`fd_vinyl_io_alloc`](<fd_vinyl_io.h.md#fd_vinyl_io_alloc>) with blocking flag.
    - Initialize the allocated block memory to zero using `memset`.
    - Set the control, sequence, sequence0, dead count, move count, and info size fields of the part block.
    - If `info_sz` is greater than 0, copy the `info` data into the block's info field using `memcpy`.
    - Compute the hash for the block using `fd_vinyl_bstream_block_hash`.
    - Append the block to the vinyl I/O stream using [`fd_vinyl_io_append`](<fd_vinyl_io.h.md#fd_vinyl_io_append>).
- **Output**: Returns an unsigned long integer representing the result of the append operation.
- **Functions Called**:
    - [`fd_vinyl_io_alloc`](<fd_vinyl_io.h.md#fd_vinyl_io_alloc>)
    - [`fd_vinyl_io_seed`](<fd_vinyl_io.h.md#fd_vinyl_io_seed>)
    - [`fd_vinyl_io_append`](<fd_vinyl_io.h.md#fd_vinyl_io_append>)


---
### fd\_vinyl\_io\_append\_pair\_inplace<!-- {{#callable:fd_vinyl_io_append_pair_inplace}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.c#L149>)

Appends a data pair to a stream, optionally compressing it with LZ4 if beneficial.
- **Inputs**:
    - `io`: A pointer to the `fd_vinyl_io_t` structure, representing the I/O context.
    - `style`: An integer indicating the desired style of the data pair, either raw or LZ4 compressed.
    - `phdr`: A pointer to the `fd_vinyl_bstream_phdr_t` structure, representing the pair header to append.
    - `_style`: A pointer to an integer where the function will store the style used for the appended pair.
    - `_val_esz`: A pointer to an unsigned long where the function will store the effective size of the value after processing.
- **Logic and Control Flow**:
    - Retrieve the value size from the `phdr` structure and verify it does not exceed `FD_VINYL_VAL_MAX`.
    - Calculate the pair size using `fd_vinyl_bstream_pair_sz` and verify the control style and size in `phdr_ctl`.
    - If `style` is `FD_VINYL_BSTREAM_CTL_STYLE_RAW`, append the pair in place without compression.
    - If `style` is `FD_VINYL_BSTREAM_CTL_STYLE_LZ4`, check if the value size exceeds `FD_VINYL_BSTREAM_LZ4_VAL_THRESH`.
    - If compression is beneficial, allocate memory for the compressed pair, compress the value using LZ4, and append the compressed pair.
    - If compression is not beneficial or fails, append the uncompressed pair.
    - Update `_style` and `_val_esz` with the final style and effective size used.
- **Output**: Returns an unsigned long representing the result of the append operation, which is the size of the appended data.
- **Functions Called**:
    - [`fd_vinyl_io_alloc`](<fd_vinyl_io.h.md#fd_vinyl_io_alloc>)
    - [`fd_vinyl_io_trim`](<fd_vinyl_io.h.md#fd_vinyl_io_trim>)
    - [`fd_vinyl_io_seed`](<fd_vinyl_io.h.md#fd_vinyl_io_seed>)
    - [`fd_vinyl_io_append`](<fd_vinyl_io.h.md#fd_vinyl_io_append>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)