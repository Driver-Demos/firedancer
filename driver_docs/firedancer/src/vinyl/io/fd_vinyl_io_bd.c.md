<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements block device I/O operations for the Vinyl streaming system, including read, write, append, and sync functionalities.

# Purpose
The code defines a C module for managing block device input/output operations in a streaming context, specifically for a system called "vinyl." It provides a set of functions to read from, write to, and manage a block device, which is a type of storage device that reads and writes data in fixed-size blocks. The module includes functions for immediate and queued read operations ([`fd_vinyl_io_bd_read_imm`](<#fd_vinyl_io_bd_read_imm>), [`fd_vinyl_io_bd_read`](<#fd_vinyl_io_bd_read>)), appending data ([`fd_vinyl_io_bd_append`](<#fd_vinyl_io_bd_append>)), committing changes ([`fd_vinyl_io_bd_commit`](<#fd_vinyl_io_bd_commit>)), and synchronizing the state of the block device ([`fd_vinyl_io_bd_sync`](<#fd_vinyl_io_bd_sync>)). It also includes utility functions for memory allocation ([`fd_vinyl_io_bd_alloc`](<#fd_vinyl_io_bd_alloc>)), copying data ([`fd_vinyl_io_bd_copy`](<#fd_vinyl_io_bd_copy>)), and managing the sequence of operations ([`fd_vinyl_io_bd_forget`](<#fd_vinyl_io_bd_forget>), [`fd_vinyl_io_bd_rewind`](<#fd_vinyl_io_bd_rewind>)).

The module is structured around a data structure `fd_vinyl_io_bd_t`, which holds the state of the block device, including file descriptors, offsets, and sequence numbers for managing data streams. The code uses inline functions for low-level read and write operations ([`bd_read`](<#bd_read>), [`bd_write`](<#bd_write>)) and provides error handling through logging macros (`FD_LOG_CRIT`, `FD_LOG_WARNING`). The module is designed to be initialized with [`fd_vinyl_io_bd_init`](<#fd_vinyl_io_bd_init>), which sets up the block device for either a new or existing data stream, depending on the `reset` parameter. The module is intended to be part of a larger system, as indicated by its use of specific data types and macros related to the "vinyl" system, and it defines an implementation structure `fd_vinyl_io_impl_t` to provide a consistent interface for block device operations.
# Imports and Dependencies

---
- `fd_vinyl_io.h`
- `errno.h`
- `unistd.h`


# Global Variables

---
### fd\_vinyl\_io\_bd\_impl
- **Type**: ``fd_vinyl_io_impl_t` array`
- **Description**: An array of type `fd_vinyl_io_impl_t` that contains function pointers for various block device operations. These operations include reading, writing, polling, appending, committing, hinting, allocating, copying, forgetting, rewinding, syncing, and finalizing block device I/O.
- **Use**: Used to implement block device I/O operations by providing a set of function pointers for handling different I/O tasks.


# Data Structures

---
### fd\_vinyl\_io\_bd\_rd\_t
- **Type**: ``struct``
- **Members**:
    - ``ctx``: Must mirror `fd_vinyl_io_rd_t`.
    - ``seq``: Must mirror `fd_vinyl_io_rd_t`.
    - ``dst``: Must mirror `fd_vinyl_io_rd_t`.
    - ``sz``: Must mirror `fd_vinyl_io_rd_t`.
    - ``next``: Pointer to the next element in the block device read queue.
- **Description**: Represents a node in a queue for block device read operations, containing context, sequence, destination buffer, size, and a pointer to the next node in the queue.


---
### fd\_vinyl\_io\_bd\_rd
- **Type**: ``struct``
- **Members**:
    - ``ctx``: Must mirror `fd_vinyl_io_rd_t`.
    - ``seq``: Must mirror `fd_vinyl_io_rd_t`.
    - ``dst``: Must mirror `fd_vinyl_io_rd_t`.
    - ``sz``: Must mirror `fd_vinyl_io_rd_t`.
    - ``next``: Next element in bd rd queue.
- **Description**: Defines a structure for managing read operations in a block device queue, with fields that mirror those in `fd_vinyl_io_rd_t` and a pointer to the next element in the queue.


---
### fd\_vinyl\_io\_bd
- **Type**: ``struct``
- **Members**:
    - ``base``: An array of one `fd_vinyl_io_t` structure, serving as the base for the block device I/O operations.
    - ``dev_fd``: File descriptor of the block device.
    - ``dev_sync``: Offset to the block that holds the bstream sync, aligned to `BLOCK_SZ`.
    - ``dev_base``: Offset to the first block, aligned to `BLOCK_SZ`.
    - ``dev_sz``: Byte size of the block store, aligned to `BLOCK_SZ`.
    - ``rd_head``: Pointer to the head of the read queue.
    - ``rd_tail_next``: Pointer to the next tail in the queue or to `rd_head` if the queue is empty.
    - ``sync``: An array of one `fd_vinyl_bstream_block_t` structure for synchronization.
- **Description**: Manages block device I/O operations for a vinyl bstream, including synchronization, read, and write operations, using a queue for read requests and maintaining offsets and sizes aligned to block size multiples.


---
### fd\_vinyl\_io\_bd\_t
- **Type**: ``struct``
- **Members**:
    - ``base``: An array of one `fd_vinyl_io_t` structure, representing the base I/O interface.
    - ``dev_fd``: File descriptor of the block device.
    - ``dev_sync``: Offset to the block that holds the bstream sync, aligned to block size.
    - ``dev_base``: Offset to the first block, aligned to block size.
    - ``dev_sz``: Byte size of the block store, aligned to block size.
    - ``rd_head``: Pointer to the head of the read queue.
    - ``rd_tail_next``: Pointer to the next element in the read queue or to `rd_head` if the queue is empty.
    - ``sync``: An array of one `fd_vinyl_bstream_block_t` structure, used for synchronization.
- **Description**: Defines a structure for managing block device I/O operations in a vinyl streaming context, including fields for device file descriptor, synchronization offsets, and read queue management.


# Functions

---
### bd\_read<!-- {{#callable:bd_read}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io_bd.c#L6>)

Reads data from a file descriptor into a buffer at a specified offset and size, logging critical errors if the read operation fails.
- **Inputs**:
    - `fd`: The file descriptor from which to read data.
    - `off`: The offset in the file from where to start reading.
    - `buf`: The buffer where the read data will be stored.
    - `sz`: The number of bytes to read from the file.
- **Logic and Control Flow**:
    - Calls `pread` to read `sz` bytes from the file descriptor `fd` into the buffer `buf`, starting at offset `off`.
    - Checks if the number of bytes read (`ssz`) is equal to `sz` using `FD_LIKELY`; if true, the function returns immediately.
    - If `ssz` is less than zero, logs a critical error with the error number and message using `FD_LOG_CRIT`.
    - If `ssz` is not equal to `sz`, logs a critical error indicating an unexpected size was read.
- **Output**: No output is returned; the function logs critical errors if the read operation does not succeed as expected.


---
### bd\_write<!-- {{#callable:bd_write}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io_bd.c#L17>)

Writes data from a buffer to a file descriptor at a specified offset and logs critical errors if the write operation fails.
- **Inputs**:
    - `fd`: The file descriptor where data will be written.
    - `off`: The offset in the file where the data will be written.
    - `buf`: A pointer to the buffer containing the data to write.
    - `sz`: The size of the data to write from the buffer.
- **Logic and Control Flow**:
    - Calls `pwrite` to write `sz` bytes from `buf` to the file descriptor `fd` at offset `off`.
    - Checks if the number of bytes written (`ssz`) is equal to `sz`; if true, the function returns immediately.
    - If `ssz` is less than 0, logs a critical error with the error number and message using `FD_LOG_CRIT`.
    - If `ssz` is not equal to `sz`, logs a critical error indicating an unexpected size was written.
- **Output**: No output is returned; the function logs errors and returns void.


---
### fd\_vinyl\_io\_bd\_read\_imm<!-- {{#callable:fd_vinyl_io_bd_read_imm}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io_bd.c#L53>)

Performs an immediate read operation from a block device into a destination buffer, ensuring alignment and sequence validity.
- **Inputs**:
    - `io`: A pointer to an `fd_vinyl_io_t` structure, which must be non-NULL.
    - `seq0`: The starting sequence number for the read operation.
    - `_dst`: A pointer to the destination buffer where data will be read into.
    - `sz`: The size of the data to read, in bytes.
- **Logic and Control Flow**:
    - Check if `sz` is zero; if so, return immediately as there is nothing to read.
    - Cast `io` to `fd_vinyl_io_bd_t` and `_dst` to `uchar *`.
    - Calculate `seq1` as `seq0 + sz`.
    - Retrieve `seq_past` and `seq_present` from the base of the block device structure.
    - Check for alignment and validity of `seq0`, `dst`, and `sz` using `FD_VINYL_BSTREAM_BLOCK_SZ`.
    - Verify that the read request is within the valid sequence range (`seq_past` to `seq_present`).
    - Log a critical error and exit if any alignment or sequence validity checks fail.
    - Calculate the device offset `dev_off` as `seq0 % dev_sz`.
    - Determine the read size `rsz` as the minimum of `sz` and the remaining space in the device from `dev_off`.
    - Perform the read operation using [`bd_read`](<#bd_read>) for `rsz` bytes from the calculated offset.
    - If there is remaining data to read (`sz` is still greater than zero), perform another [`bd_read`](<#bd_read>) from the start of the device.
- **Output**: No return value; the function writes data directly into the provided destination buffer.
- **Functions Called**:
    - [`bd_read`](<#bd_read>)


---
### fd\_vinyl\_io\_bd\_read<!-- {{#callable:fd_vinyl_io_bd_read}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io_bd.c#L102>)

Handles reading data from a block device into a specified destination buffer, ensuring alignment and sequence validity.
- **Inputs**:
    - ``io``: A pointer to an `fd_vinyl_io_t` structure, which must be non-NULL.
    - ``_rd``: A pointer to an `fd_vinyl_io_rd_t` structure, which contains the read request details.
- **Logic and Control Flow**:
    - Cast `io` to `fd_vinyl_io_bd_t` and `_rd` to `fd_vinyl_io_bd_rd_t`.
    - Initialize the read request by setting `rd->next` to NULL and updating the read queue pointers.
    - Extract `seq0`, `dst`, and `sz` from the `rd` structure.
    - If `sz` is zero, return immediately as there is nothing to read.
    - Calculate `seq1` as `seq0 + sz`.
    - Retrieve `seq_past` and `seq_present` from the base structure of `bd`.
    - Check for alignment and sequence validity using `fd_ulong_is_aligned` and sequence comparison functions.
    - If any alignment or sequence checks fail, log a critical error and exit.
    - Calculate the device offset `dev_off` using `seq0 % dev_sz`.
    - Determine the read size `rsz` as the minimum of `sz` and the remaining space in the device from `dev_off`.
    - Perform the read operation using [`bd_read`](<#bd_read>) for `rsz` bytes.
    - If there is remaining data to read (`sz` is not zero), perform another [`bd_read`](<#bd_read>) from the start of the device.
- **Output**: No explicit return value; the function performs the read operation and logs errors if any issues occur.
- **Functions Called**:
    - [`bd_read`](<#bd_read>)


---
### fd\_vinyl\_io\_bd\_poll<!-- {{#callable:fd_vinyl_io_bd_poll}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io_bd.c#L157>)

Polls the block device read queue and returns the next read request if available.
- **Inputs**:
    - ``io``: A pointer to `fd_vinyl_io_t`, which must be non-NULL and is cast to `fd_vinyl_io_bd_t`.
    - ``_rd``: A pointer to a pointer of type `fd_vinyl_io_rd_t`, which will be set to the next read request if available.
    - ``flags``: An integer representing flags, which is currently unused in the function.
- **Logic and Control Flow**:
    - Cast `io` to `fd_vinyl_io_bd_t` and assign it to `bd`.
    - Check if `bd->rd_head` is NULL, indicating an empty read queue.
    - If the read queue is empty, set `*_rd` to NULL and return `FD_VINYL_ERR_EMPTY`.
    - If the read queue is not empty, retrieve the head of the queue `rd` and the next read request `rd_next`.
    - Update `bd->rd_head` to `rd_next`.
    - Update `bd->rd_tail_next` to point to the next element or reset to `&bd->rd_head` if the queue is empty.
    - Set `*_rd` to the current read request `rd` and return `FD_VINYL_SUCCESS`.
- **Output**: Returns `FD_VINYL_SUCCESS` if a read request is available, otherwise returns `FD_VINYL_ERR_EMPTY` if the queue is empty.


---
### fd\_vinyl\_io\_bd\_append<!-- {{#callable:fd_vinyl_io_bd_append}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io_bd.c#L181>)

Appends data to a block device stream, updating sequence numbers and handling device wrap-around.
- **Inputs**:
    - ``io``: A pointer to an `fd_vinyl_io_t` structure, representing the block device stream.
    - ``_src``: A pointer to the source data to append.
    - ``sz``: The size of the data to append, in bytes.
- **Logic and Control Flow**:
    - Cast `io` to `fd_vinyl_io_bd_t` and `_src` to `uchar const *` for internal use.
    - Retrieve and validate the current sequence numbers and device parameters from the `bd` structure.
    - Check for invalid input conditions: null source, misaligned source or size, and insufficient device capacity.
    - Log a critical error and terminate if any invalid conditions are detected.
    - Calculate the device offset for the append operation using the current sequence number and device size.
    - Update the future sequence number to reflect the appended data size.
    - Write data to the device, handling wrap-around if the data exceeds the device's end.
    - Return the initial sequence number before the append operation.
- **Output**: Returns the sequence number at which the append operation started.
- **Functions Called**:
    - [`bd_write`](<#bd_write>)


---
### fd\_vinyl\_io\_bd\_commit<!-- {{#callable:fd_vinyl_io_bd_commit}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io_bd.c#L226>)

Commits the current state of a block device by updating sequence numbers and resetting scratchpad usage.
- **Inputs**:
    - ``io``: A pointer to `fd_vinyl_io_t`, which must be non-NULL.
    - ``flags``: An integer representing flags, though it is not used in this function.
- **Logic and Control Flow**:
    - Cast `io` to `fd_vinyl_io_bd_t` pointer `bd`.
    - Set `bd->base->seq_present` to `bd->base->seq_future`.
    - Set `bd->base->spad_used` to 0UL.
    - Return `FD_VINYL_SUCCESS`.
- **Output**: Returns `FD_VINYL_SUCCESS` to indicate successful commit.


---
### fd\_vinyl\_io\_bd\_hint<!-- {{#callable:fd_vinyl_io_bd_hint}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io_bd.c#L238>)

Checks if a given size is aligned and within the capacity of a block device, returning the future sequence number if valid.
- **Inputs**:
    - ``io``: A pointer to `fd_vinyl_io_t`, which must be non-NULL.
    - ``sz``: The size to check for alignment and capacity constraints.
- **Logic and Control Flow**:
    - Cast `io` to `fd_vinyl_io_bd_t` pointer `bd`.
    - Retrieve `seq_future`, `seq_ancient`, and `dev_sz` from `bd`.
    - If `sz` is zero, return `seq_future`.
    - Check if `sz` is aligned with `FD_VINYL_BSTREAM_BLOCK_SZ` and if `sz` fits within the available device capacity (`dev_sz - (seq_future - seq_ancient)`).
    - If `sz` is misaligned or exceeds capacity, log a critical error and terminate.
    - Return `seq_future`.
- **Output**: Returns the future sequence number `seq_future` from the block device.


---
### fd\_vinyl\_io\_bd\_alloc<!-- {{#callable:fd_vinyl_io_bd_alloc}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io_bd.c#L255>)

Allocates a block of memory from a scratch pad within a block device, ensuring alignment and size constraints are met.
- **Inputs**:
    - ``io``: A pointer to an `fd_vinyl_io_t` structure, which must be non-NULL.
    - ``sz``: The size of the memory block to allocate, in bytes.
    - ``flags``: An integer representing flags that may affect the allocation process.
- **Logic and Control Flow**:
    - Cast `io` to `fd_vinyl_io_bd_t` and check if `sz` is zero; if so, return the current position in the scratch pad.
    - Check if `sz` is aligned to `FD_VINYL_BSTREAM_BLOCK_SZ` and if `sz` exceeds `spad_max`; log a critical error if either condition is true.
    - Check if `sz` exceeds the available space in the scratch pad; if so, commit the current state and reset `spad_used` to zero.
    - Update `spad_used` by adding `sz` to it.
    - Return a pointer to the allocated memory block within the scratch pad.
- **Output**: A pointer to the allocated memory block, or `NULL` if allocation fails due to insufficient space or alignment issues.
- **Functions Called**:
    - [`fd_vinyl_io_bd_commit`](<#fd_vinyl_io_bd_commit>)


---
### fd\_vinyl\_io\_bd\_copy<!-- {{#callable:fd_vinyl_io_bd_copy}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io_bd.c#L279>)

Copies a specified size of data from a source sequence to a destination sequence in a block device, handling alignment and capacity constraints.
- **Inputs**:
    - `io`: A pointer to an `fd_vinyl_io_t` structure, which must be non-NULL.
    - `seq_src0`: The starting sequence number of the source data to copy.
    - `sz`: The size of the data to copy, in bytes.
- **Logic and Control Flow**:
    - Cast `io` to `fd_vinyl_io_bd_t` and retrieve various sequence and device parameters.
    - Check if `sz` is zero; if so, return `seq_future`.
    - Calculate `seq_src1` as `seq_src0 + sz`.
    - Validate input arguments for alignment, capacity, and sequence order constraints.
    - If any validation fails, log a critical error and exit.
    - If `sz` exceeds available scratch pad space, commit current data and reset `spad_used`.
    - Allocate buffer space from the scratch pad.
    - Update `seq_future` to reflect the new data size.
    - Enter a loop to copy data from source to destination, handling device wrap-around and buffer space constraints.
    - In each iteration, calculate offsets and copy sizes, read from source, write to destination, and update sequence numbers.
    - Exit the loop when all data is copied.
    - Return the updated sequence number `seq`.
- **Output**: Returns the updated sequence number after the copy operation.
- **Functions Called**:
    - [`fd_vinyl_io_bd_commit`](<#fd_vinyl_io_bd_commit>)
    - [`bd_read`](<#bd_read>)
    - [`bd_write`](<#bd_write>)


---
### fd\_vinyl\_io\_bd\_forget<!-- {{#callable:fd_vinyl_io_bd_forget}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io_bd.c#L350>)

Updates the `seq_past` value of a block device to a specified sequence number after validating input conditions.
- **Inputs**:
    - ``io``: A pointer to `fd_vinyl_io_t`, representing the block device interface.
    - ``seq``: The sequence number to which the `seq_past` should be updated.
- **Logic and Control Flow**:
    - Cast `io` to `fd_vinyl_io_bd_t` pointer `bd`.
    - Retrieve `seq_past`, `seq_present`, and `seq_future` from `bd->base`.
    - Check if `seq` is aligned with `FD_VINYL_BSTREAM_BLOCK_SZ`.
    - Verify `seq` is within the bounds of `seq_past` and `seq_present`.
    - Ensure no reads are in progress by checking `bd->rd_head`.
    - Confirm no appends or copies are in progress by comparing `seq_present` and `seq_future`.
    - Log a critical error and exit if any validation fails.
    - Update `bd->base->seq_past` to `seq` if all checks pass.
- **Output**: No return value; updates the `seq_past` field of the block device structure.


---
### fd\_vinyl\_io\_bd\_rewind<!-- {{#callable:fd_vinyl_io_bd_rewind}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io_bd.c#L382>)

Rewinds the sequence numbers of a block device to a specified sequence number, ensuring alignment and no ongoing operations.
- **Inputs**:
    - ``io``: A pointer to an `fd_vinyl_io_t` structure, which must be non-NULL.
    - ``seq``: The sequence number to which the block device should be rewound.
- **Logic and Control Flow**:
    - Cast `io` to `fd_vinyl_io_bd_t` and store it in `bd`.
    - Retrieve sequence numbers `seq_ancient`, `seq_past`, `seq_present`, and `seq_future` from `bd->base`.
    - Check for invalid conditions: misaligned `seq`, `seq` greater than `seq_present`, ongoing reads, or ongoing appends/copies.
    - Log a critical error and exit if any invalid condition is true.
    - Update `seq_ancient`, `seq_past`, `seq_present`, and `seq_future` in `bd->base` to reflect the new `seq`.
- **Output**: No return value; updates the sequence numbers in the `fd_vinyl_io_bd_t` structure.


---
### fd\_vinyl\_io\_bd\_sync<!-- {{#callable:fd_vinyl_io_bd_sync}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io_bd.c#L414>)

Synchronizes the block device's state by updating and writing the sync block with current sequence numbers and hash values.
- **Inputs**:
    - ``io``: A pointer to a `fd_vinyl_io_t` structure, which must be non-NULL.
    - ``flags``: An integer representing flags, which is not used in this function.
- **Logic and Control Flow**:
    - Cast `io` to a `fd_vinyl_io_bd_t` pointer and store it in `bd`.
    - Retrieve `seed`, `seq_past`, and `seq_present` from `bd->base`.
    - Retrieve `dev_fd` and `dev_sync` from `bd`.
    - Get the sync block from `bd->sync`.
    - Update `block->sync.seq_past` and `block->sync.seq_present` with `seq_past` and `seq_present`.
    - Set `block->sync.hash_trail` and `block->sync.hash_blocks` to 0.
    - Call `fd_vinyl_bstream_block_hash` with `seed` and `block` to update the hash values.
    - Write the sync block to the device using [`bd_write`](<#bd_write>) with `dev_fd`, `dev_sync`, and the block size.
    - Update `bd->base->seq_ancient` to `seq_past`.
    - Return `FD_VINYL_SUCCESS`.
- **Output**: Returns `FD_VINYL_SUCCESS` to indicate successful synchronization.
- **Functions Called**:
    - [`bd_write`](<#bd_write>)


---
### fd\_vinyl\_io\_bd\_fini<!-- {{#callable:fd_vinyl_io_bd_fini}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io_bd.c#L446>)

Finalizes the `fd_vinyl_io_bd_t` structure by checking for outstanding reads and uncommitted blocks, and logs warnings if necessary.
- **Inputs**:
    - ``io``: A pointer to an `fd_vinyl_io_t` structure, which must be non-NULL.
- **Logic and Control Flow**:
    - Cast the `io` pointer to an `fd_vinyl_io_bd_t` pointer named `bd`.
    - Retrieve `seq_present` and `seq_future` from `bd->base`.
    - Check if `bd->rd_head` is non-NULL, indicating outstanding reads, and log a warning if true.
    - Check if `seq_present` is not equal to `seq_future`, indicating uncommitted blocks, and log a warning if true.
    - Return the `io` pointer.
- **Output**: Returns the input `io` pointer.


---
### fd\_vinyl\_io\_bd\_align<!-- {{#callable:fd_vinyl_io_bd_align}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io_bd.c#L476>)

Returns the alignment requirement of the `fd_vinyl_io_bd_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Calls `alignof` to get the alignment requirement of the `fd_vinyl_io_bd_t` structure.
    - Returns the alignment value.
- **Output**: The function returns an `ulong` representing the alignment requirement of the `fd_vinyl_io_bd_t` structure.


---
### fd\_vinyl\_io\_bd\_footprint<!-- {{#callable:fd_vinyl_io_bd_footprint}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io_bd.c#L481>)

Calculates the memory footprint required for a `fd_vinyl_io_bd_t` structure with a given scratchpad size.
- **Inputs**:
    - `spad_max`: The maximum size of the scratchpad memory in bytes, which must be greater than 0, less than 2^63, and aligned to `FD_VINYL_BSTREAM_BLOCK_SZ`.
- **Logic and Control Flow**:
    - Checks if `spad_max` is greater than 0, less than 2^63, and aligned to `FD_VINYL_BSTREAM_BLOCK_SZ` using `fd_ulong_is_aligned`.
    - If any of the conditions are not met, returns 0.
    - If all conditions are met, calculates and returns the sum of the size of `fd_vinyl_io_bd_t` and `spad_max`.
- **Output**: Returns the total memory footprint in bytes as an unsigned long integer, or 0 if the input conditions are not met.


---
### fd\_vinyl\_io\_bd\_init<!-- {{#callable:fd_vinyl_io_bd_init}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io_bd.c#L488>)

Initializes a block device-based vinyl I/O structure, either starting a new bstream or resuming an existing one.
- **Inputs**:
    - `mem`: Pointer to memory where the `fd_vinyl_io_bd_t` structure will be initialized.
    - `spad_max`: Maximum size of the scratchpad memory in bytes.
    - `dev_fd`: File descriptor of the block device.
    - `reset`: Flag indicating whether to start a new bstream (1) or resume an existing one (0).
    - `info`: Pointer to additional information to be stored in the sync block, used only if `reset` is true.
    - `info_sz`: Size of the additional information in bytes, used only if `reset` is true.
    - `io_seed`: Seed value for I/O operations, used for initializing or validating the sync block.
- **Logic and Control Flow**:
    - Cast `mem` to `fd_vinyl_io_bd_t` and check for null or misalignment.
    - Calculate the footprint using [`fd_vinyl_io_bd_footprint`](<#fd_vinyl_io_bd_footprint>) and validate `spad_max`.
    - Determine the size of the block device using `lseek` and validate it against minimum and maximum constraints.
    - If `reset` is true, validate `info` and `info_sz`, then initialize the sync block and write it to the device.
    - If `reset` is false, read the sync block from the device, validate its contents, and update internal state based on it.
    - Log the configuration details and return the initialized `fd_vinyl_io_t` base pointer.
- **Output**: Returns a pointer to the initialized `fd_vinyl_io_t` structure, or `NULL` if initialization fails.
- **Functions Called**:
    - [`fd_vinyl_io_bd_align`](<#fd_vinyl_io_bd_align>)
    - [`fd_vinyl_io_bd_footprint`](<#fd_vinyl_io_bd_footprint>)
    - [`fd_vinyl_io_bd_sync`](<#fd_vinyl_io_bd_sync>)
    - [`bd_read`](<#bd_read>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)