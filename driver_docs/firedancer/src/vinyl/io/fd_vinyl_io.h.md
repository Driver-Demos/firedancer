<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Header file for asynchronous I/O operations on a bstream, supporting reads, appends, and recovery.

# Purpose
The `fd_vinyl_io.h` file is a C header file that defines an interface for managing input/output operations on a bstream, which is a data stream stored in a physical layer, typically non-volatile storage. The interface supports asynchronous concurrent reads and appends, and it is designed to be resilient to unexpected interruptions such as power failures. The API is plugin-friendly, allowing for different implementations to be used at runtime, which makes it adaptable to various physical storage layers and interfaces.

The file defines several key components, including the `fd_vinyl_io_t` structure, which serves as an opaque handle for an I/O instance, and the `fd_vinyl_io_rd_t` structure, which describes a read request. It also declares a set of function pointers within the `fd_vinyl_io_impl_t` structure, which represent operations such as reading, appending, committing, and synchronizing data. These operations are implemented by specific I/O implementations, identified by constants like `FD_VINYL_IO_TYPE_MM` and `FD_VINYL_IO_TYPE_BD`. The header file provides inline functions for performing these operations, ensuring that they are executed efficiently. Additionally, it includes helper functions for estimating scratch pad sizes and appending data in various formats. The file is intended to be included in other C source files that require access to the bstream I/O functionalities.
# Imports and Dependencies

---
- `../bstream/fd_vinyl_bstream.h`


# Data Structures

---
### fd\_vinyl\_io\_rd
- **Type**: ``struct``
- **Members**:
    - ``ctx``: An arbitrary user-defined value.
    - ``seq``: The starting sequence number for the read operation.
    - ``dst``: A pointer to the destination buffer where data will be read into.
    - ``sz``: The size of the data to read, in bytes.
    - ``_``: A reserved space for additional information, sized to fill the structure to `FD_VINYL_IO_READ_SZ`.
- **Description**: Describes a read request to the underlying I/O implementation, specifying the sequence number, destination buffer, and size of the data to read from the bstream's past. The structure includes a user-defined context value and a reserved space for additional information, ensuring alignment and size requirements are met.


---
### fd\_vinyl\_io\_rd\_t
- **Type**: ``struct``
- **Members**:
    - ``ctx``: An arbitrary user-defined value.
    - ``seq``: The sequence number indicating the start of the read range in the bstream's past.
    - ``dst``: A pointer to the destination where the read data will be stored.
    - ``sz``: The size of the data to read, which should be aligned to `FD_VINYL_BSTREAM_BLOCK_SZ`.
    - ``_``: A padding array to ensure the structure size is `FD_VINYL_IO_READ_SZ`.
- **Description**: Describes a read request to the underlying I/O implementation, specifying a contiguous range of blocks to read from the bstream's past into a destination buffer. The fields `seq`, `dst`, and `sz` must be aligned to `FD_VINYL_BSTREAM_BLOCK_SZ`, and the structure allows for additional information to be added by the underlying I/O implementations as needed.


---
### fd\_vinyl\_io\_t
- **Type**: ``struct``
- **Members**:
    - ``type``: Stores the type of I/O implementation in use.
    - ``seed``: Stores a seed value for data integrity hashing.
    - ``seq_ancient``: Tracks the sequence number of the oldest block in the bstream's antiquity.
    - ``seq_past``: Tracks the sequence number of the oldest block in the bstream's past.
    - ``seq_present``: Tracks the sequence number of the current block in the bstream's present.
    - ``seq_future``: Tracks the sequence number of the next block in the bstream's future.
    - ``spad_max``: Indicates the maximum size of the append scratch pad.
    - ``spad_used``: Indicates the amount of the append scratch pad currently in use.
    - ``impl``: Points to the implementation-specific functions for I/O operations.
- **Description**: `fd_vinyl_io_t` is an opaque handle for managing I/O operations on a bstream stored in a physical layer, typically non-volatile storage. It supports asynchronous concurrent reads and appends, and can recover from unexpected interruptions. The structure includes fields for tracking sequence numbers of blocks in different states (ancient, past, present, future), managing the append scratch pad, and a pointer to implementation-specific functions. This design allows for flexible integration with various physical storage interfaces.


---
### fd\_vinyl\_io\_impl
- **Type**: ``struct``
- **Members**:
    - ``read_imm``: A function pointer for immediate blocking read operations.
    - ``read``: A function pointer for starting read operations.
    - ``poll``: A function pointer for checking the completion of read operations.
    - ``append``: A function pointer for appending blocks to the bstream.
    - ``commit``: A function pointer for finalizing append operations.
    - ``hint``: A function pointer for indicating contiguous block requirements.
    - ``alloc``: A function pointer for allocating memory from the append scratch pad.
    - ``copy``: A function pointer for copying blocks within the bstream.
    - ``forget``: A function pointer for forgetting blocks before a certain sequence number.
    - ``rewind``: A function pointer for moving blocks back to the bstream's future.
    - ``sync``: A function pointer for updating the recovery range of the bstream.
    - ``fini``: A function pointer for finalizing and cleaning up the I/O implementation.
- **Description**: Defines a set of function pointers for various I/O operations on a bstream, allowing for reading, appending, memory allocation, and synchronization tasks, tailored to support asynchronous and concurrent operations on different physical storage layers.


---
### fd\_vinyl\_io\_impl\_t
- **Type**: ``struct``
- **Members**:
    - `read_imm`: Function pointer for immediate blocking read operation.
    - `read`: Function pointer for starting a read operation.
    - `poll`: Function pointer for checking completion of read operations.
    - `append`: Function pointer for appending data to the bstream.
    - `commit`: Function pointer for committing appended data.
    - `hint`: Function pointer for indicating contiguous block requirements.
    - `alloc`: Function pointer for allocating memory from the append scratch pad.
    - `copy`: Function pointer for copying blocks from past to present in the bstream.
    - `forget`: Function pointer for moving blocks from past to antiquity.
    - `rewind`: Function pointer for moving blocks from past to future.
    - `sync`: Function pointer for synchronizing the bstream state.
    - `fini`: Function pointer for finalizing and cleaning up the I/O implementation.
- **Description**: Defines a structure containing function pointers for various I/O operations on a bstream, allowing for reading, appending, committing, and managing memory and block states in a flexible and implementation-specific manner.


---
### fd\_vinyl\_io\_private
- **Type**: ``struct``
- **Members**:
    - ``type``: An integer that identifies the type of I/O implementation in use.
    - ``seed``: An unsigned long integer used as a seed for data integrity hashing.
    - ``seq_ancient``: An unsigned long integer representing the sequence number of the oldest block in the bstream's antiquity.
    - ``seq_past``: An unsigned long integer representing the sequence number of the oldest block in the bstream's past.
    - ``seq_present``: An unsigned long integer representing the sequence number of the current block in the bstream's present.
    - ``seq_future``: An unsigned long integer representing the sequence number of the next block in the bstream's future.
    - ``spad_max``: An unsigned long integer indicating the maximum size of the append scratch pad.
    - ``spad_used``: An unsigned long integer indicating the current used size of the append scratch pad.
    - ``impl``: A pointer to `fd_vinyl_io_impl_t`, which contains implementation-specific functions for I/O operations.
- **Description**: The `fd_vinyl_io_private` structure is a private data structure used to manage the state and operations of a vinyl I/O instance. It includes fields for tracking the type of I/O implementation, sequence numbers for different stages of the bstream (ancient, past, present, future), and the state of the append scratch pad. The structure also holds a pointer to an implementation-specific function table, allowing for flexible and customizable I/O operations. This structure is integral to managing the reading and appending of data in a bstream, supporting asynchronous and concurrent operations.


# Functions

---
### fd\_vinyl\_io\_type<!-- {{#callable:fd_vinyl_io_type}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L146>)

Returns the type of the I/O implementation used by the `fd_vinyl_io_t` instance.
- **Inputs**:
    - `io`: A pointer to a constant `fd_vinyl_io_t` structure, which represents an instance of the vinyl I/O system.
- **Logic and Control Flow**:
    - Accesses the `type` field of the `fd_vinyl_io_t` structure pointed to by `io`.
    - Returns the value of the `type` field.
- **Output**: An integer representing the type of the I/O implementation.


---
### fd\_vinyl\_io\_seed<!-- {{#callable:fd_vinyl_io_seed}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L157>)

Returns the `seed` value from a `fd_vinyl_io_t` structure.
- **Inputs**:
    - `io`: A pointer to a constant `fd_vinyl_io_t` structure from which the `seed` value is retrieved.
- **Logic and Control Flow**:
    - Accesses the `seed` member of the `fd_vinyl_io_t` structure pointed to by `io`.
    - Returns the value of the `seed` member.
- **Output**: The function returns an `ulong` representing the `seed` value of the `fd_vinyl_io_t` structure.


---
### fd\_vinyl\_io\_seq\_ancient<!-- {{#callable:fd_vinyl_io_seq_ancient}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L159>)

Returns the `seq_ancient` field from a `fd_vinyl_io_t` structure.
- **Inputs**:
    - `io`: A pointer to a constant `fd_vinyl_io_t` structure from which the `seq_ancient` field is retrieved.
- **Logic and Control Flow**:
    - Accesses the `seq_ancient` field of the `fd_vinyl_io_t` structure pointed to by `io`.
    - Returns the value of the `seq_ancient` field.
- **Output**: The function returns an `ulong` representing the `seq_ancient` field of the `fd_vinyl_io_t` structure.


---
### fd\_vinyl\_io\_seq\_past<!-- {{#callable:fd_vinyl_io_seq_past}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L160>)

Returns the sequence number of the past state in the `fd_vinyl_io_t` structure.
- **Inputs**:
    - `io`: A pointer to a constant `fd_vinyl_io_t` structure, representing the I/O instance from which to retrieve the past sequence number.
- **Logic and Control Flow**:
    - Accesses the `seq_past` field of the `fd_vinyl_io_t` structure pointed to by `io`.
    - Returns the value of the `seq_past` field.
- **Output**: The function returns an `ulong` representing the sequence number of the past state in the `fd_vinyl_io_t` structure.


---
### fd\_vinyl\_io\_seq\_present<!-- {{#callable:fd_vinyl_io_seq_present}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L161>)

Returns the current sequence number of the present state in the `fd_vinyl_io_t` structure.
- **Inputs**:
    - `io`: A pointer to a constant `fd_vinyl_io_t` structure, representing the I/O instance from which to retrieve the present sequence number.
- **Logic and Control Flow**:
    - Accesses the `seq_present` field of the `fd_vinyl_io_t` structure pointed to by `io`.
    - Returns the value of the `seq_present` field.
- **Output**: The function returns an `ulong` representing the sequence number of the present state in the `fd_vinyl_io_t` structure.


---
### fd\_vinyl\_io\_seq\_future<!-- {{#callable:fd_vinyl_io_seq_future}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L162>)

Returns the future sequence number from a `fd_vinyl_io_t` instance.
- **Inputs**:
    - `io`: A pointer to a constant `fd_vinyl_io_t` structure from which the future sequence number is retrieved.
- **Logic and Control Flow**:
    - Accesses the `seq_future` field of the `fd_vinyl_io_t` structure pointed to by `io`.
    - Returns the value of the `seq_future` field.
- **Output**: The function returns an `ulong` representing the future sequence number of the `fd_vinyl_io_t` instance.


---
### fd\_vinyl\_io\_spad\_max<!-- {{#callable:fd_vinyl_io_spad_max}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L164>)

Returns the maximum size of the append scratch pad for a given `fd_vinyl_io_t` instance.
- **Inputs**:
    - `io`: A pointer to a constant `fd_vinyl_io_t` structure, representing the I/O instance from which to retrieve the maximum scratch pad size.
- **Logic and Control Flow**:
    - Accesses the `spad_max` field of the `fd_vinyl_io_t` structure pointed to by `io`.
    - Returns the value of the `spad_max` field.
- **Output**: The function returns an `ulong` representing the maximum size of the append scratch pad (`spad_max`) for the specified I/O instance.


---
### fd\_vinyl\_io\_spad\_used<!-- {{#callable:fd_vinyl_io_spad_used}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L165>)

Returns the amount of scratch pad memory currently used in a `fd_vinyl_io_t` instance.
- **Inputs**:
    - `io`: A pointer to a constant `fd_vinyl_io_t` structure, representing the I/O instance to query.
- **Logic and Control Flow**:
    - Accesses the `spad_used` field of the `fd_vinyl_io_t` structure pointed to by `io`.
    - Returns the value of the `spad_used` field.
- **Output**: The function returns an `ulong` representing the amount of scratch pad memory currently used.


---
### fd\_vinyl\_io\_spad\_free<!-- {{#callable:fd_vinyl_io_spad_free}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L166>)

Calculates the available space in the append scratch pad of a `fd_vinyl_io_t` instance.
- **Inputs**:
    - `io`: A pointer to a constant `fd_vinyl_io_t` structure representing the I/O instance.
- **Logic and Control Flow**:
    - Subtracts the `spad_used` field from the `spad_max` field of the `fd_vinyl_io_t` structure pointed to by `io`.
- **Output**: Returns the difference as an `ulong`, representing the free space in the append scratch pad.


---
### fd\_vinyl\_io\_dev\_used<!-- {{#callable:fd_vinyl_io_dev_used}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L168>)

Calculates the number of blocks currently used in the vinyl I/O device by subtracting the sequence number of the oldest block from the sequence number of the future block.
- **Inputs**:
    - `io`: A pointer to a constant `fd_vinyl_io_t` structure, representing the vinyl I/O instance.
- **Logic and Control Flow**:
    - Accesses the `seq_future` field of the `fd_vinyl_io_t` structure pointed to by `io`.
    - Accesses the `seq_ancient` field of the `fd_vinyl_io_t` structure pointed to by `io`.
    - Subtracts `seq_ancient` from `seq_future` to determine the number of blocks used.
- **Output**: Returns an `ulong` representing the number of blocks currently used in the vinyl I/O device.


---
### fd\_vinyl\_io\_read\_imm<!-- {{#callable:fd_vinyl_io_read_imm}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L178>)

Performs an immediate blocking read from a specified sequence in the bstream's past into a destination buffer.
- **Inputs**:
    - ``io``: A pointer to an `fd_vinyl_io_t` structure representing the I/O instance.
    - ``seq``: An unsigned long integer representing the starting sequence number in the bstream's past from which to read.
    - ``dst``: A pointer to the destination buffer where the read data will be stored.
    - ``sz``: An unsigned long integer representing the size of the data to read, which should be aligned to `FD_VINYL_BSTREAM_BLOCK_SZ`.
- **Logic and Control Flow**:
    - Calls the `read_imm` function from the `impl` field of the `io` structure, passing `io`, `seq`, `dst`, and `sz` as arguments.
- **Output**: No return value; the function performs the read operation directly.


---
### fd\_vinyl\_io\_read<!-- {{#callable:fd_vinyl_io_read}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L198>)

Executes a read operation on a vinyl I/O stream using the specified read command.
- **Inputs**:
    - ``io``: A pointer to an `fd_vinyl_io_t` structure representing the vinyl I/O instance.
    - ``rd``: A pointer to an `fd_vinyl_io_rd_t` structure that describes the read request to be executed.
- **Logic and Control Flow**:
    - Calls the `read` function from the `impl` field of the `io` structure, passing `io` and `rd` as arguments.
- **Output**: No return value; the function performs the read operation as specified by the `rd` parameter.


---
### fd\_vinyl\_io\_poll<!-- {{#callable:fd_vinyl_io_poll}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L215>)

Completes an outstanding read operation for a given I/O instance.
- **Inputs**:
    - ``io``: A pointer to an `fd_vinyl_io_t` structure representing the I/O instance.
    - ``_rd``: A pointer to a pointer of type `fd_vinyl_io_rd_t`, which will be set to the read request that has completed.
    - ``flags``: An integer representing flags that modify the behavior of the poll operation, such as allowing the call to block.
- **Logic and Control Flow**:
    - Calls the `poll` function from the `impl` field of the `io` structure.
    - Passes the `io`, `_rd`, and `flags` arguments to the `poll` function.
    - Returns the result of the `poll` function call.
- **Output**: Returns an integer indicating the status of the poll operation, which can be success, no pending commands, or no ready commands.


---
### fd\_vinyl\_io\_append<!-- {{#callable:fd_vinyl_io_append}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L282>)

Appends a specified number of bytes from a source to a bstream using the provided I/O implementation.
- **Inputs**:
    - ``io``: A pointer to an `fd_vinyl_io_t` structure representing the I/O instance where the data will be appended.
    - ``src``: A pointer to the source data to append to the bstream.
    - ``sz``: The size in bytes of the data to append, which should be aligned to `FD_VINYL_BSTREAM_BLOCK_SZ`.
- **Logic and Control Flow**:
    - Calls the `append` function from the `impl` field of the `io` structure, passing `io`, `src`, and `sz` as arguments.
    - Returns the sequence number where the data is appended in the bstream.
- **Output**: Returns an `ulong` representing the sequence number in the bstream where the data is appended.


---
### fd\_vinyl\_io\_commit<!-- {{#callable:fd_vinyl_io_commit}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L289>)

Executes the `commit` operation on the `fd_vinyl_io_t` instance using the provided flags.
- **Inputs**:
    - `io`: A pointer to an `fd_vinyl_io_t` instance, representing the I/O context on which to perform the commit operation.
    - `flags`: An integer representing flags that modify the behavior of the commit operation, such as allowing the operation to block.
- **Logic and Control Flow**:
    - Calls the `commit` function from the `impl` field of the `io` structure, passing `io` and `flags` as arguments.
    - Returns the result of the `commit` function call.
- **Output**: Returns an integer indicating the success or failure of the commit operation, with `0` for success and a negative value for failure.


---
### fd\_vinyl\_io\_hint<!-- {{#callable:fd_vinyl_io_hint}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L295>)

Calls the `hint` function of the `impl` field in the `fd_vinyl_io_t` structure to ensure the next `sz` bytes appended are contiguous.
- **Inputs**:
    - `io`: A pointer to an `fd_vinyl_io_t` structure, which contains the implementation details for the I/O operations.
    - `sz`: An unsigned long integer representing the size in bytes that must be contiguous in the physical storage.
- **Logic and Control Flow**:
    - Accesses the `impl` field of the `fd_vinyl_io_t` structure pointed to by `io`.
    - Calls the `hint` function from the `impl` field, passing `io` and `sz` as arguments.
    - Returns the result of the `hint` function call.
- **Output**: Returns an unsigned long integer, which is the potentially updated sequence number for the future block in the bstream.


---
### fd\_vinyl\_io\_alloc<!-- {{#callable:fd_vinyl_io_alloc}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L301>)

Allocates memory from the append scratch pad of a `fd_vinyl_io_t` instance using the implementation-specific `alloc` function.
- **Inputs**:
    - `io`: A pointer to a `fd_vinyl_io_t` instance, representing the I/O context from which to allocate memory.
    - `sz`: The size of the memory to allocate, which should be aligned to `FD_VINYL_BSTREAM_BLOCK_SZ`.
    - `flags`: Flags that modify the allocation behavior, such as allowing the call to block.
- **Logic and Control Flow**:
    - Calls the `alloc` function from the `impl` field of the `io` structure, passing `io`, `sz`, and `flags` as arguments.
    - Returns the result of the `alloc` function call, which is a pointer to the allocated memory.
- **Output**: A pointer to the allocated memory, or `NULL` if the allocation fails (only possible for non-blocking calls).


---
### fd\_vinyl\_io\_trim<!-- {{#callable:fd_vinyl_io_trim}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L308>)

Reduces the `spad_used` field of a `fd_vinyl_io_t` structure by a specified size.
- **Inputs**:
    - `io`: A pointer to a `fd_vinyl_io_t` structure, representing the I/O instance whose scratch pad usage is to be trimmed.
    - `sz`: An unsigned long integer representing the size to subtract from the `spad_used` field.
- **Logic and Control Flow**:
    - Subtracts the value of `sz` from the `spad_used` field of the `fd_vinyl_io_t` structure pointed to by `io`.
- **Output**: No return value; the function modifies the `spad_used` field of the `fd_vinyl_io_t` structure in place.


---
### fd\_vinyl\_io\_copy<!-- {{#callable:fd_vinyl_io_copy}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L314>)

Appends a contiguous range of blocks from the bstream's past to the end of the bstream's present.
- **Inputs**:
    - `io`: A pointer to an `fd_vinyl_io_t` structure, representing the I/O instance.
    - `seq`: An unsigned long integer representing the starting sequence number of the blocks to copy, which should be aligned to `FD_VINYL_BSTREAM_BLOCK_SZ`.
    - `sz`: An unsigned long integer representing the size of the blocks to copy, which should be aligned to `FD_VINYL_BSTREAM_BLOCK_SZ`.
- **Logic and Control Flow**:
    - Calls the `copy` function from the `impl` field of the `io` structure, passing `io`, `seq`, and `sz` as arguments.
- **Output**: Returns an unsigned long integer, which is the result of the `copy` function call.


---
### fd\_vinyl\_io\_forget<!-- {{#callable:fd_vinyl_io_forget}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L332>)

Forgets all blocks before a given sequence number in a `fd_vinyl_io_t` instance.
- **Inputs**:
    - ``io``: A pointer to a `fd_vinyl_io_t` instance, representing the I/O context.
    - ``seq``: An unsigned long integer representing the sequence number up to which blocks should be forgotten.
- **Logic and Control Flow**:
    - Calls the `forget` function from the `impl` field of the `fd_vinyl_io_t` structure, passing `io` and `seq` as arguments.
- **Output**: No return value; the function operates by side effect on the `fd_vinyl_io_t` instance.


---
### fd\_vinyl\_io\_rewind<!-- {{#callable:fd_vinyl_io_rewind}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L351>)

Moves blocks from the bstream's past to its future, updating sequence numbers as necessary.
- **Inputs**:
    - ``io``: A pointer to an `fd_vinyl_io_t` structure representing the I/O instance.
    - ``seq``: An unsigned long integer representing the sequence number up to which blocks should be moved.
- **Logic and Control Flow**:
    - Calls the `rewind` function from the `impl` field of the `io` structure, passing `io` and `seq` as arguments.
- **Output**: No return value; the function operates by side effect on the `io` structure.


---
### fd\_vinyl\_io\_sync<!-- {{#callable:fd_vinyl_io_sync}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L368>)

Executes the `sync` operation on the `fd_vinyl_io_t` instance to update the bstream's past range for recovery.
- **Inputs**:
    - `io`: A pointer to an `fd_vinyl_io_t` instance, representing the I/O context on which to perform the sync operation.
    - `flags`: An integer representing flags that modify the behavior of the sync operation, such as allowing the call to block.
- **Logic and Control Flow**:
    - Calls the `sync` function from the `impl` field of the `io` structure, passing `io` and `flags` as arguments.
    - Returns the result of the `sync` function call.
- **Output**: Returns an integer indicating the success or failure of the sync operation, with `FD_VINYL_SUCCESS` (0) on success and `FD_VINYL_ERR_AGAIN` (negative) if the call would block (only for non-blocking calls).


# Function Declarations (Public API)

---
### fd\_vinyl\_io\_fini<!-- {{#callable_declaration:fd_vinyl_io_fini}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L384>)

Finalizes the I/O instance and returns the memory region used for its state.
- **Description**: Use this function to properly finalize an I/O instance, ensuring that any in-progress reads are completed and any in-progress appends are canceled. This function can block the caller during its execution. It is important to note that this function does not perform a synchronization of the bstream before finalization, which can be useful if the application is terminating due to an error and does not want to sync to avoid overwriting a known good state.
- **Inputs**:
    - `io`: A pointer to a `fd_vinyl_io_t` instance. Must not be null. If null, the function logs a warning and returns null.
- **Output**: Returns a pointer to the memory region used for the I/O implementation state, or null if the input is null.
- **See Also**: [`fd_vinyl_io_fini`](<fd_vinyl_io.c.md#fd_vinyl_io_fini>)  (Implementation)


---
### fd\_vinyl\_io\_spad\_est<!-- {{#callable_declaration:fd_vinyl_io_spad_est}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L398>)

Estimates the minimum required size for a scratch pad.
- **Description**: Use this function to determine the smallest scratch pad size needed for most applications. It calculates the size based on the worst-case scenario for loading and compressing an object footprint. This is useful for ensuring that the scratch pad is adequately sized to handle compression tasks without running out of memory.
- **Inputs**: None
- **Output**: Returns an unsigned long integer representing the estimated minimum scratch pad size.
- **See Also**: [`fd_vinyl_io_spad_est`](<fd_vinyl_io.c.md#fd_vinyl_io_spad_est>)  (Implementation)


---
### fd\_vinyl\_io\_append\_pair\_raw<!-- {{#callable_declaration:fd_vinyl_io_append_pair_raw}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L411>)

Appends a key-value pair to a vinyl I/O stream.
- **Description**: Use this function to append a key-value pair to the end of a vinyl I/O stream. It formats the pair with the provided key, info, and value, and then appends it to the stream. This function assumes that the size of the value, as specified in the `info` parameter, does not exceed the maximum allowed size (`FD_VINYL_VAL_MAX`). The function does not perform input validation, so ensure that all inputs are valid before calling. It returns the sequence number where the data is appended.
- **Inputs**:
    - `io`: A pointer to a `fd_vinyl_io_t` structure representing the vinyl I/O stream. Must not be null. The caller retains ownership.
    - `key`: A pointer to a `fd_vinyl_key_t` structure representing the key of the pair. Must not be null. The caller retains ownership.
    - `info`: A pointer to a `fd_vinyl_info_t` structure containing metadata about the value. Must not be null. The caller retains ownership. The `_val_sz` field in `info` must be within the range [0, FD_VINYL_VAL_MAX].
    - `val`: A pointer to the value data to append. The size of the data must match the `_val_sz` field in `info`. The caller retains ownership.
- **Output**: Returns the sequence number where the data is appended in the vinyl I/O stream.
- **See Also**: [`fd_vinyl_io_append_pair_raw`](<fd_vinyl_io.c.md#fd_vinyl_io_append_pair_raw>)  (Implementation)


---
### fd\_vinyl\_io\_append\_dead<!-- {{#callable_declaration:fd_vinyl_io_append_dead}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L417>)

Appends a 'dead' block to the bstream.
- **Description**: Use this function to append a 'dead' block to the bstream associated with the given I/O instance. This function is typically used to mark a block as 'dead' or erased in the bstream. It requires a valid I/O instance and a pair header. The function can handle a null `info` pointer by treating the `info_sz` as zero. Ensure that `info_sz` does not exceed the maximum allowed size for dead info. The function will return the sequence number where the data is appended.
- **Inputs**:
    - `io`: A pointer to a `fd_vinyl_io_t` instance representing the I/O context. Must not be null.
    - `phdr`: A pointer to a `fd_vinyl_bstream_phdr_t` structure representing the pair header of the erased pair. Must not be null.
    - `info`: A pointer to additional information to append. Can be null, in which case `info_sz` is treated as zero.
    - `info_sz`: The size of the additional information in bytes. Must be in the range [0, FD_VINYL_BSTREAM_DEAD_INFO_MAX]. If `info` is null, this is treated as zero.
- **Output**: Returns the sequence number where the 'dead' block is appended in the bstream.
- **See Also**: [`fd_vinyl_io_append_dead`](<fd_vinyl_io.c.md#fd_vinyl_io_append_dead>)  (Implementation)


---
### fd\_vinyl\_io\_append\_move<!-- {{#callable_declaration:fd_vinyl_io_append_move}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L423>)

Appends a move operation to the bstream.
- **Description**: Use this function to append a move operation to the bstream managed by the given I/O instance. This operation involves moving a source pair to a destination key, optionally including additional information. Ensure that the `info_sz` does not exceed the maximum allowed size. If `info` is null, `info_sz` is treated as zero. The function returns the sequence number where the data is appended.
- **Inputs**:
    - `io`: A pointer to a `fd_vinyl_io_t` instance representing the I/O context. Must not be null.
    - `src`: A pointer to a `fd_vinyl_bstream_phdr_t` structure representing the source pair header. Must not be null.
    - `dst`: A pointer to a `fd_vinyl_key_t` structure representing the destination key. Must not be null.
    - `info`: A pointer to additional information to include in the move operation. Can be null, in which case `info_sz` is treated as zero.
    - `info_sz`: The size of the additional information in bytes. Must be in the range [0, FD_VINYL_BSTREAM_MOVE_INFO_MAX]. If `info` is null, this is treated as zero.
- **Output**: Returns the sequence number where the move operation is appended in the bstream.
- **See Also**: [`fd_vinyl_io_append_move`](<fd_vinyl_io.c.md#fd_vinyl_io_append_move>)  (Implementation)


---
### fd\_vinyl\_io\_append\_part<!-- {{#callable_declaration:fd_vinyl_io_append_part}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L430>)

Appends a partition block to the bstream.
- **Description**: Use this function to append a partition block to the bstream associated with the given I/O instance. This function prepares the partition block with the specified sequence number, dead count, move count, and additional information. It is important to ensure that the `info` parameter is not null if `info_sz` is greater than zero. The function will handle a null `info` by setting `info_sz` to zero. The function assumes that the `info_sz` does not exceed `FD_VINYL_BSTREAM_PART_INFO_MAX`. The function returns the sequence number where the data is appended.
- **Inputs**:
    - `io`: A pointer to a `fd_vinyl_io_t` instance representing the I/O context. Must not be null.
    - `seq0`: An unsigned long representing the starting sequence number for the partition. No specific range is enforced.
    - `dead_cnt`: An unsigned long representing the number of dead blocks in the partition. No specific range is enforced.
    - `move_cnt`: An unsigned long representing the number of move blocks in the partition. No specific range is enforced.
    - `info`: A pointer to a constant void representing additional information to include in the partition. Can be null, in which case `info_sz` is treated as zero.
    - `info_sz`: An unsigned long representing the size of the `info` data. Must not exceed `FD_VINYL_BSTREAM_PART_INFO_MAX`. If `info` is null, this is treated as zero.
- **Output**: Returns an unsigned long representing the sequence number where the partition block is appended.
- **See Also**: [`fd_vinyl_io_append_part`](<fd_vinyl_io.c.md#fd_vinyl_io_append_part>)  (Implementation)


---
### fd\_vinyl\_io\_append\_pair\_inplace<!-- {{#callable_declaration:fd_vinyl_io_append_pair_inplace}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L459>)

Appends a pair to the bstream with optional compression.
- **Description**: Use this function to append a pair to the bstream, optionally compressing it if the specified style is LZ4 and compression is beneficial. The function will append the pair in the specified style if possible, or fall back to appending it in RAW style if compression is not advantageous. The function updates the style and encoded value size through the provided pointers. Ensure that the `io` and `phdr` pointers are valid and that the `style` is supported. The function assumes a read interest on the pair's header and value regions and a write interest on the pair's zero padding and footer regions until the next append or commit.
- **Inputs**:
    - `io`: A pointer to a `fd_vinyl_io_t` instance representing the I/O context. Must not be null.
    - `style`: An integer specifying the desired style for appending. Supported styles include `FD_VINYL_BSTREAM_CTL_STYLE_RAW` and `FD_VINYL_BSTREAM_CTL_STYLE_LZ4`. If an unsupported style is provided, the function logs a critical error.
    - `phdr`: A pointer to a `fd_vinyl_bstream_phdr_t` structure representing the pair header. Must not be null.
    - `_style`: A pointer to an integer where the function will store the actual style used for appending. Must not be null.
    - `_val_esz`: A pointer to an unsigned long where the function will store the encoded value size in bytes. Must not be null.
- **Output**: Returns the location in the bstream where the pair was appended.
- **See Also**: [`fd_vinyl_io_append_pair_inplace`](<fd_vinyl_io.c.md#fd_vinyl_io_append_pair_inplace>)  (Implementation)


---
### fd\_vinyl\_io\_bd\_align<!-- {{#callable_declaration:fd_vinyl_io_bd_align}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L502>)

Returns the alignment requirement for a block device bstream.
- **Description**: Use this function to obtain the alignment requirement for a block device bstream in the vinyl I/O system. This alignment is necessary for ensuring that data structures are correctly aligned in memory, which is important for performance and correctness when accessing block devices. This function does not require any parameters and can be called at any time to retrieve the alignment value.
- **Inputs**: None
- **Output**: Returns an unsigned long integer representing the alignment requirement for a block device bstream.
- **See Also**: [`fd_vinyl_io_bd_align`](<fd_vinyl_io_bd.c.md#fd_vinyl_io_bd_align>)  (Implementation)


---
### fd\_vinyl\_io\_bd\_footprint<!-- {{#callable_declaration:fd_vinyl_io_bd_footprint}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L503>)

Calculates the memory footprint for a block device bstream with a given scratch pad size.
- **Description**: Use this function to determine the memory footprint required for a block device bstream when you have a specific maximum size for the append scratch pad. This function is useful when setting up or configuring a bstream on a block device, ensuring that the memory allocation is appropriate for the given scratch pad size. The function returns zero if the provided `spad_max` is invalid, which includes being non-positive, exceeding a certain large value, or not being properly aligned.
- **Inputs**:
    - `spad_max`: Specifies the maximum size of the append scratch pad in bytes. It must be greater than zero, less than 2^63, and aligned to `FD_VINYL_BSTREAM_BLOCK_SZ`. If these conditions are not met, the function returns zero.
- **Output**: Returns the total memory footprint in bytes if `spad_max` is valid; otherwise, returns zero.
- **See Also**: [`fd_vinyl_io_bd_footprint`](<fd_vinyl_io_bd.c.md#fd_vinyl_io_bd_footprint>)  (Implementation)


---
### fd\_vinyl\_io\_bd\_init<!-- {{#callable_declaration:fd_vinyl_io_bd_init}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L505>)

Initializes a block device as a bstream store.
- **Description**: Use this function to start using a file as a bstream store, which supports asynchronous concurrent reads and appends, and can recover from unexpected interruptions. The function requires a memory region with suitable alignment and footprint to hold the bstream's state. If the `reset` parameter is non-zero, it will start a new bstream, ignoring existing file contents. Otherwise, it will attempt to resume from the last synchronization point. The function returns a handle to the bstream on success, with ownership of the memory and file descriptor, or NULL on failure.
- **Inputs**:
    - `mem`: A pointer to a memory region with suitable alignment and footprint to hold the bstream's state. Must not be null.
    - `spad_max`: The size of the append scratch pad, which should be a multiple of `FD_VINYL_BSTREAM_BLOCK_SZ`. Must be valid to avoid returning NULL.
    - `dev_fd`: A file descriptor for the block device or large file. The file should already exist and be sized appropriately.
    - `reset`: An integer flag indicating whether to start a new bstream (non-zero) or resume from the last synchronization point (zero).
    - `info`: A pointer to user-defined metadata to set in the bstream if `reset` is non-zero. Ignored if `reset` is zero. Can be null if `info_sz` is zero.
    - `info_sz`: The size of the user-defined metadata. Must not exceed `FD_VINYL_BSTREAM_SYNC_INFO_MAX` if `reset` is non-zero.
    - `io_seed`: A seed for data integrity hashing. Used only if `reset` is non-zero; otherwise, it is ignored.
- **Output**: Returns a handle to the bstream on success, or NULL on failure. On success, the function takes ownership of `mem` and `dev_fd`.
- **See Also**: [`fd_vinyl_io_bd_init`](<fd_vinyl_io_bd.c.md#fd_vinyl_io_bd_init>)  (Implementation)


---
### fd\_vinyl\_io\_mm\_align<!-- {{#callable_declaration:fd_vinyl_io_mm_align}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L528>)

Returns the alignment requirement for memory-mapped I/O operations.
- **Description**: Use this function to obtain the alignment requirement for memory-mapped I/O operations in the context of the vinyl I/O system. This is useful when allocating memory or configuring memory-mapped files to ensure they meet the necessary alignment constraints. The function does not require any parameters and can be called at any time to retrieve the alignment value.
- **Inputs**: None
- **Output**: Returns an unsigned long integer representing the alignment requirement.
- **See Also**: [`fd_vinyl_io_mm_align`](<fd_vinyl_io_mm.c.md#fd_vinyl_io_mm_align>)  (Implementation)


---
### fd\_vinyl\_io\_mm\_footprint<!-- {{#callable_declaration:fd_vinyl_io_mm_footprint}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L529>)

Calculates the memory footprint for a vinyl I/O instance with a given scratch pad size.
- **Description**: Use this function to determine the total memory footprint required for a vinyl I/O instance when specifying a maximum size for the append scratch pad. This function is useful when planning memory allocation for vinyl I/O operations. The function expects the scratch pad size to be a positive value, less than 2^63, and aligned to the block size defined by `FD_VINYL_BSTREAM_BLOCK_SZ`. If these conditions are not met, the function returns 0, indicating an invalid input.
- **Inputs**:
    - `spad_max`: Specifies the maximum size of the append scratch pad in bytes. It must be greater than 0, less than 2^63, and aligned to `FD_VINYL_BSTREAM_BLOCK_SZ`. If these conditions are not met, the function returns 0.
- **Output**: Returns the total memory footprint in bytes if the input is valid, otherwise returns 0.
- **See Also**: [`fd_vinyl_io_mm_footprint`](<fd_vinyl_io_mm.c.md#fd_vinyl_io_mm_footprint>)  (Implementation)


---
### fd\_vinyl\_io\_mm\_init<!-- {{#callable_declaration:fd_vinyl_io_mm_init}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L531>)

Initializes a memory-mapped I/O instance for a bstream.
- **Description**: Use this function to initialize a memory-mapped I/O instance for a bstream, which allows reading from and appending to a bstream stored in a specified memory region. This function supports both starting a new bstream and resuming an existing one. Ensure that the memory and device pointers are aligned correctly and that the device size is within valid limits. If starting a new bstream, provide optional metadata information and a seed for data integrity. The function returns a handle to the initialized I/O instance or NULL if initialization fails due to invalid parameters or alignment issues.
- **Inputs**:
    - `mem`: Pointer to a memory region for the I/O instance. Must not be null and must be aligned according to `fd_vinyl_io_mm_align()`.
    - `spad_max`: Maximum size of the append scratch pad. Must be a valid size for the application.
    - `dev`: Pointer to the memory region used as the block device. Must not be null and must be aligned to `FD_VINYL_BSTREAM_BLOCK_SZ`.
    - `dev_sz`: Size of the device memory region. Must be at least a minimum size calculated internally and aligned to `FD_VINYL_BSTREAM_BLOCK_SZ`. Must not exceed `LONG_MAX`.
    - `reset`: Integer flag indicating whether to start a new bstream (non-zero) or resume an existing one (zero).
    - `info`: Pointer to metadata information for the bstream. Can be null if `reset` is zero.
    - `info_sz`: Size of the metadata information. Must not exceed `FD_VINYL_BSTREAM_SYNC_INFO_MAX` if `reset` is non-zero.
    - `io_seed`: Seed for data integrity hashing. Used only if `reset` is non-zero.
- **Output**: Returns a pointer to the initialized `fd_vinyl_io_t` instance on success, or NULL on failure.
- **See Also**: [`fd_vinyl_io_mm_init`](<fd_vinyl_io_mm.c.md#fd_vinyl_io_mm_init>)  (Implementation)


---
### fd\_vinyl\_mmio<!-- {{#callable_declaration:fd_vinyl_mmio}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L551>)

Returns a pointer to the memory-mapped I/O region if supported.
- **Description**: Use this function to obtain a pointer to the memory-mapped I/O region of a `fd_vinyl_io_t` instance when the I/O type is `FD_VINYL_IO_TYPE_MM`. This function is useful for accessing the raw bstream storage directly in memory. It must be called only when the I/O type is set to memory-mapped mode. If the I/O type is not `FD_VINYL_IO_TYPE_MM`, the function returns `NULL`, indicating that memory-mapped I/O is not supported for the given instance.
- **Inputs**:
    - `io`: A pointer to a `fd_vinyl_io_t` instance. The I/O type must be `FD_VINYL_IO_TYPE_MM` for the function to return a valid pointer. If the type is not `FD_VINYL_IO_TYPE_MM`, the function returns `NULL`. The caller retains ownership of the pointer.
- **Output**: Returns a pointer to the memory-mapped I/O region if the I/O type is `FD_VINYL_IO_TYPE_MM`; otherwise, returns `NULL`.
- **See Also**: [`fd_vinyl_mmio`](<fd_vinyl_io_mm.c.md#fd_vinyl_mmio>)  (Implementation)


---
### fd\_vinyl\_mmio\_sz<!-- {{#callable_declaration:fd_vinyl_mmio_sz}} -->
[View Source →](<../../../../../src/vinyl/io/fd_vinyl_io.h#L552>)

Returns the size of the memory-mapped I/O region.
- **Description**: Use this function to get the size of the memory-mapped I/O region associated with a given `fd_vinyl_io_t` instance. This function is applicable only when the I/O type is memory-mapped (`FD_VINYL_IO_TYPE_MM`). If the I/O type is not memory-mapped, the function returns 0. This function is useful for determining the extent of the memory region available for operations that require direct memory access.
- **Inputs**:
    - `io`: A pointer to an `fd_vinyl_io_t` instance. The pointer must not be null, and the instance must be properly initialized. The function checks if the I/O type is memory-mapped and returns 0 if it is not.
- **Output**: Returns the size of the memory-mapped I/O region as an unsigned long. If the I/O type is not memory-mapped, returns 0.
- **See Also**: [`fd_vinyl_mmio_sz`](<fd_vinyl_io_mm.c.md#fd_vinyl_mmio_sz>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)