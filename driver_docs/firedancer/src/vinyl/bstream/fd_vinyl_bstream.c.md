<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for hashing, testing, and validating vinyl bstream blocks, including control style conversion.

# Purpose
The code provides a set of functions for handling and testing data blocks in a streaming context, specifically for a system that uses a format called "vinyl bstream." The primary operations include hashing, testing, and validating different types of data blocks such as pairs, dead blocks, move blocks, partitions, and zero-padding blocks. The functions [`fd_vinyl_bstream_pair_hash`](<#fd_vinyl_bstream_pair_hash>), [`fd_vinyl_bstream_pair_test`](<#fd_vinyl_bstream_pair_test>), and [`fd_vinyl_bstream_pair_test_fast`](<#fd_vinyl_bstream_pair_test_fast>) are used to compute and verify hashes for data pairs, ensuring data integrity. The [`fd_vinyl_bstream_dead_test`](<#fd_vinyl_bstream_dead_test>), [`fd_vinyl_bstream_move_test`](<#fd_vinyl_bstream_move_test>), and [`fd_vinyl_bstream_part_test`](<#fd_vinyl_bstream_part_test>) functions perform validation checks on dead, move, and partition blocks, respectively, ensuring that the blocks conform to expected formats and constraints.

Additionally, the code includes utility functions for converting control styles to strings and vice versa, such as [`fd_vinyl_bstream_ctl_style_cstr`](<#fd_vinyl_bstream_ctl_style_cstr>) and [`fd_cstr_to_vinyl_bstream_ctl_style`](<#fd_cstr_to_vinyl_bstream_ctl_style>). These functions facilitate the interpretation and conversion of control styles used in the vinyl bstream format. The code is structured to handle specific data block types and their associated operations, making it a specialized component for managing and verifying data integrity in a streaming data system.
# Imports and Dependencies

---
- `fd_vinyl_bstream.h`


# Functions

---
### fd\_vinyl\_bstream\_pair\_hash<!-- {{#callable:fd_vinyl_bstream_pair_hash}} -->
[View Source →](<../../../../../src/vinyl/bstream/fd_vinyl_bstream.c#L3>)

Calculates and sets hash values for a vinyl bstream pair using a given seed and header.
- **Inputs**:
    - `seed`: An unsigned long integer used as the initial seed for hash calculations.
    - `hdr`: A pointer to a `fd_vinyl_bstream_block_t` structure representing the header of the bstream pair.
- **Logic and Control Flow**:
    - Retrieve the control value from the header and calculate the value size using [`fd_vinyl_bstream_ctl_sz`](<fd_vinyl_bstream.h.md#fd_vinyl_bstream_ctl_sz>) function.
    - Calculate the total pair size using [`fd_vinyl_bstream_pair_sz`](<fd_vinyl_bstream.h.md#fd_vinyl_bstream_pair_sz>) function.
    - Determine the footer position by offsetting the header pointer by the pair size minus the block size.
    - Calculate the offset for zero padding and footer, and determine the size of the zero padding area.
    - Set the zero padding area to zero using `memset`.
    - Compute the hash for the trailing data using [`fd_vinyl_bstream_hash`](<fd_vinyl_bstream.h.md#fd_vinyl_bstream_hash>) with the seed and data from the header.
    - Compute the hash for the blocks using [`fd_vinyl_bstream_hash`](<fd_vinyl_bstream.h.md#fd_vinyl_bstream_hash>) with the trailing hash and the header data.
    - Store the computed hash values in the footer's `hash_trail` and `hash_blocks` fields.
- **Output**: No return value; the function modifies the `hdr` structure in place by setting hash values in its footer.
- **Functions Called**:
    - [`fd_vinyl_bstream_ctl_sz`](<fd_vinyl_bstream.h.md#fd_vinyl_bstream_ctl_sz>)
    - [`fd_vinyl_bstream_pair_sz`](<fd_vinyl_bstream.h.md#fd_vinyl_bstream_pair_sz>)
    - [`fd_vinyl_bstream_hash`](<fd_vinyl_bstream.h.md#fd_vinyl_bstream_hash>)


---
### fd\_vinyl\_bstream\_pair\_test<!-- {{#callable:fd_vinyl_bstream_pair_test}} -->
[View Source →](<../../../../../src/vinyl/bstream/fd_vinyl_bstream.c#L26>)

Validates a vinyl bstream pair by checking control type, value size, buffer size, and hash values.
- **Inputs**:
    - `seed`: A seed value used for hash calculations.
    - `seq`: A sequence number, which is not used in the function.
    - `hdr`: A pointer to the header of the vinyl bstream block.
    - `buf_sz`: The size of the buffer containing the bstream block.
- **Logic and Control Flow**:
    - Check if `hdr` is NULL and return "NULL buf" if true.
    - Check if `buf_sz` is less than `FD_VINYL_BSTREAM_BLOCK_SZ` and return "buf_sz too small" if true.
    - Retrieve control type and value size from `hdr` and calculate the pair size.
    - Check if the control type is not `FD_VINYL_BSTREAM_CTL_TYPE_PAIR` and return "unexpected type" if true.
    - Check if the value size exceeds `FD_VINYL_VAL_MAX` and return "unexpected val size" if true.
    - Check if `buf_sz` is less than the calculated pair size and return "truncated pair" if true.
    - Calculate the footer position and retrieve hash values from it.
    - Set the hash values in the footer to zero.
    - Check if the hash of the data excluding the footer does not match `hash_trail` and return "unexpected trailing hash" if true.
    - Check if the hash of the header does not match `hash_blocks` and return "unexpected pair hash" if true.
- **Output**: Returns NULL if all checks pass, otherwise returns a string describing the first encountered error.
- **Functions Called**:
    - [`fd_vinyl_bstream_ctl_type`](<fd_vinyl_bstream.h.md#fd_vinyl_bstream_ctl_type>)
    - [`fd_vinyl_bstream_ctl_sz`](<fd_vinyl_bstream.h.md#fd_vinyl_bstream_ctl_sz>)
    - [`fd_vinyl_bstream_pair_sz`](<fd_vinyl_bstream.h.md#fd_vinyl_bstream_pair_sz>)
    - [`fd_vinyl_bstream_hash`](<fd_vinyl_bstream.h.md#fd_vinyl_bstream_hash>)


---
### fd\_vinyl\_bstream\_pair\_test\_fast<!-- {{#callable:fd_vinyl_bstream_pair_test_fast}} -->
[View Source →](<../../../../../src/vinyl/bstream/fd_vinyl_bstream.c#L66>)

Validates a pair of vinyl bstream blocks by checking control types, sizes, and hash values.
- **Inputs**:
    - `seed`: A `ulong` value used as the seed for hash calculations.
    - `seq`: A `ulong` value representing the sequence number, which is not used in this function.
    - `hdr`: A pointer to a constant `fd_vinyl_bstream_block_t` structure representing the header block.
    - `ftr`: A pointer to a `fd_vinyl_bstream_block_t` structure representing the footer block.
- **Logic and Control Flow**:
    - Check if `hdr` or `ftr` is NULL and return an error message if so.
    - Extract control information from `hdr` and calculate the expected pair size.
    - Verify that the control type is `FD_VINYL_BSTREAM_CTL_TYPE_PAIR` and the value size does not exceed `FD_VINYL_VAL_MAX`.
    - Store and then reset the hash values in `ftr`.
    - Check if the calculated hash of the footer matches the stored hash trail, returning an error if not.
    - Check if the calculated hash of the header matches the stored hash blocks, returning an error if not.
    - Return NULL if all checks pass, indicating success.
- **Output**: Returns a `char const *` error message if validation fails, or `NULL` if successful.
- **Functions Called**:
    - [`fd_vinyl_bstream_ctl_type`](<fd_vinyl_bstream.h.md#fd_vinyl_bstream_ctl_type>)
    - [`fd_vinyl_bstream_ctl_sz`](<fd_vinyl_bstream.h.md#fd_vinyl_bstream_ctl_sz>)
    - [`fd_vinyl_bstream_pair_sz`](<fd_vinyl_bstream.h.md#fd_vinyl_bstream_pair_sz>)
    - [`fd_vinyl_bstream_hash`](<fd_vinyl_bstream.h.md#fd_vinyl_bstream_hash>)


---
### fd\_vinyl\_bstream\_dead\_test<!-- {{#callable:fd_vinyl_bstream_dead_test}} -->
[View Source →](<../../../../../src/vinyl/bstream/fd_vinyl_bstream.c#L102>)

Validates a 'dead' block in a vinyl bstream structure against expected control, sequence, and size parameters.
- **Inputs**:
    - `seed`: A seed value used for block testing.
    - `seq`: The expected sequence number for the block.
    - `block`: A pointer to the 'dead' block to be tested.
- **Logic and Control Flow**:
    - Check if `block` is NULL and return "NULL block" if true.
    - Retrieve `dead_info_sz` from `block->dead.info_sz`.
    - Calculate several boolean flags (`bad_ctl`, `bad_match`, `bad_seq`, `bad_pair_type`, `bad_pair_val_sz`, `bad_info_sz`) to check for various mismatches and misalignments in the block's control, sequence, and size parameters.
    - If any of the boolean flags are true, return a corresponding error message indicating the type of mismatch or misalignment.
    - Iterate over the zero padding area of the block and return "data in zero padding" if any non-zero data is found.
    - Call [`fd_vinyl_bstream_block_test`](<fd_vinyl_bstream.h.md#fd_vinyl_bstream_block_test>) with `seed` and `block` to check for block corruption and return "corrupt block" if the test fails.
    - Return NULL if all checks pass, indicating the block is valid.
- **Output**: Returns a string describing the first error encountered or NULL if the block is valid.
- **Functions Called**:
    - [`fd_vinyl_bstream_ctl`](<fd_vinyl_bstream.h.md#fd_vinyl_bstream_ctl>)
    - [`fd_vinyl_seq_ne`](<fd_vinyl_bstream.h.md#fd_vinyl_seq_ne>)
    - [`fd_vinyl_bstream_ctl_type`](<fd_vinyl_bstream.h.md#fd_vinyl_bstream_ctl_type>)
    - [`fd_vinyl_bstream_block_test`](<fd_vinyl_bstream.h.md#fd_vinyl_bstream_block_test>)


---
### fd\_vinyl\_bstream\_move\_test<!-- {{#callable:fd_vinyl_bstream_move_test}} -->
[View Source →](<../../../../../src/vinyl/bstream/fd_vinyl_bstream.c#L136>)

Validates the integrity and correctness of a move operation between two `fd_vinyl_bstream_block_t` structures.
- **Inputs**:
    - `seed`: A `ulong` value used for hashing operations.
    - `seq`: A `ulong` value representing the expected sequence number for validation.
    - `block`: A pointer to the `fd_vinyl_bstream_block_t` structure representing the source block of the move operation.
    - `dst`: A pointer to the `fd_vinyl_bstream_block_t` structure representing the destination block of the move operation.
- **Logic and Control Flow**:
    - Check if `block` or `dst` is `NULL` and return an error message if so.
    - Retrieve the size of the move information from `block`.
    - Perform a series of checks to validate the control type, sequence alignment, source type, source value size, key equality, information size, destination type, destination key, and destination information.
    - If any validation check fails, return a specific error message indicating the type of failure.
    - Iterate over the zero padding area of the move information and check for non-zero data, returning an error if found.
    - Call [`fd_vinyl_bstream_block_test`](<fd_vinyl_bstream.h.md#fd_vinyl_bstream_block_test>) to further validate the `block` and return an error if it is corrupt.
    - Return `NULL` if all checks pass, indicating successful validation.
- **Output**: Returns a `char const *` error message if validation fails, or `NULL` if the move operation is valid.
- **Functions Called**:
    - [`fd_vinyl_bstream_ctl`](<fd_vinyl_bstream.h.md#fd_vinyl_bstream_ctl>)
    - [`fd_vinyl_seq_ne`](<fd_vinyl_bstream.h.md#fd_vinyl_seq_ne>)
    - [`fd_vinyl_bstream_ctl_type`](<fd_vinyl_bstream.h.md#fd_vinyl_bstream_ctl_type>)
    - [`fd_vinyl_bstream_block_test`](<fd_vinyl_bstream.h.md#fd_vinyl_bstream_block_test>)


---
### fd\_vinyl\_bstream\_part\_test<!-- {{#callable:fd_vinyl_bstream_part_test}} -->
[View Source →](<../../../../../src/vinyl/bstream/fd_vinyl_bstream.c#L181>)

Validates a `fd_vinyl_bstream_block_t` partition block against expected control, sequence, and size constraints.
- **Inputs**:
    - `seed`: A `ulong` value used for hashing operations.
    - `seq`: A `ulong` value representing the expected sequence number of the partition.
    - `block`: A pointer to a `fd_vinyl_bstream_block_t` structure representing the partition block to test.
- **Logic and Control Flow**:
    - Check if `block` is NULL and return "NULL block" if true.
    - Extract partition sequence, sequence0, dead count, move count, and info size from `block`.
    - Calculate `part_block_cnt` as the difference between `part_seq` and `part_seq0` divided by `FD_VINYL_BSTREAM_BLOCK_SZ`.
    - Evaluate several conditions to check for invalid control, sequence alignment, order, and size constraints.
    - If any condition is true, return a corresponding error message indicating the specific issue.
    - Iterate over the zero padding area of the partition info and return "data in zero padding" if any non-zero data is found.
    - Call [`fd_vinyl_bstream_block_test`](<fd_vinyl_bstream.h.md#fd_vinyl_bstream_block_test>) with `seed` and `block` and return "corrupt block" if it returns a non-zero value.
    - Return NULL if all checks pass, indicating the partition block is valid.
- **Output**: Returns a `char const *` error message if the partition block is invalid, or NULL if it is valid.
- **Functions Called**:
    - [`fd_vinyl_bstream_ctl`](<fd_vinyl_bstream.h.md#fd_vinyl_bstream_ctl>)
    - [`fd_vinyl_seq_ne`](<fd_vinyl_bstream.h.md#fd_vinyl_seq_ne>)
    - [`fd_vinyl_seq_gt`](<fd_vinyl_bstream.h.md#fd_vinyl_seq_gt>)
    - [`fd_vinyl_bstream_block_test`](<fd_vinyl_bstream.h.md#fd_vinyl_bstream_block_test>)


---
### fd\_vinyl\_bstream\_zpad\_test<!-- {{#callable:fd_vinyl_bstream_zpad_test}} -->
[View Source →](<../../../../../src/vinyl/bstream/fd_vinyl_bstream.c#L228>)

Checks if the zero padding in a `fd_vinyl_bstream_block_t` block is correctly set to zero.
- **Inputs**:
    - `seed`: An unused parameter in the function.
    - `seq`: An unused parameter in the function.
    - `block`: A pointer to a `fd_vinyl_bstream_block_t` structure that contains the zero padding to be checked.
- **Logic and Control Flow**:
    - Ignore `seed` and `seq` parameters as they are not used in the function.
    - Check if `block` is NULL; if true, return "NULL block".
    - Cast the `zpad` field of `block` to a `ulong` pointer `buf`.
    - Calculate `cnt` as the size of the zero padding in `ulong` units.
    - Iterate over each `ulong` in `buf` and check if it is non-zero; if any are non-zero, return "data in zero padding".
    - If all elements are zero, return NULL.
- **Output**: Returns a string indicating an error if the block is NULL or if there is data in the zero padding; otherwise, returns NULL.


---
### fd\_vinyl\_bstream\_ctl\_style\_cstr<!-- {{#callable:fd_vinyl_bstream_ctl_style_cstr}} -->
[View Source →](<../../../../../src/vinyl/bstream/fd_vinyl_bstream.c#L244>)

Maps an integer style code to its corresponding string representation.
- **Inputs**:
    - `style`: An integer representing the style code to be converted to a string.
- **Logic and Control Flow**:
    - Use a `switch` statement to check the value of `style`.
    - If `style` is `FD_VINYL_BSTREAM_CTL_STYLE_RAW`, return the string "raw".
    - If `style` is `FD_VINYL_BSTREAM_CTL_STYLE_LZ4`, return the string "lz4".
    - For any other value of `style`, return the string "unk".
- **Output**: A constant character pointer to the string representation of the style.


---
### fd\_cstr\_to\_vinyl\_bstream\_ctl\_style<!-- {{#callable:fd_cstr_to_vinyl_bstream_ctl_style}} -->
[View Source →](<../../../../../src/vinyl/bstream/fd_vinyl_bstream.c#L254>)

Converts a string to a corresponding vinyl bstream control style constant.
- **Inputs**:
    - `cstr`: A constant character pointer to the input string that represents a control style.
- **Logic and Control Flow**:
    - Check if `cstr` is NULL; if true, return -1.
    - Compare `cstr` with the string "raw" using `fd_cstr_casecmp`; if they match, return `FD_VINYL_BSTREAM_CTL_STYLE_RAW`.
    - Compare `cstr` with the string "lz4" using `fd_cstr_casecmp`; if they match, return `FD_VINYL_BSTREAM_CTL_STYLE_LZ4`.
    - If no match is found, return -1.
- **Output**: Returns an integer representing the control style constant if a match is found, otherwise returns -1.



---
Made with ❤️ by [Driver](https://www.driver.ai/)