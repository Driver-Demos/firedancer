<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements fast query and removal operations for metadata elements in a hash map structure.

# Purpose
The code defines a set of functions and macros for managing a hash map structure that stores metadata elements, specifically for a system related to `fd_vinyl`. The primary components include macros that define the types and operations for keys and elements within the map, such as `MAP_KEY_T` for key type and `MAP_ELE_T` for element type. The macros also define operations for key comparison and hashing, as well as element management, such as checking if an element is free or moving elements within the map. The code includes the implementation of a hash map using a template file `fd_map_slot_para.c`, which is included with specific parameters set by the macros.

The functions [`fd_vinyl_meta_query_fast`](<#fd_vinyl_meta_query_fast>) and [`fd_vinyl_meta_remove_fast`](<#fd_vinyl_meta_remove_fast>) provide operations for querying and removing elements from the map. [`fd_vinyl_meta_query_fast`](<#fd_vinyl_meta_query_fast>) searches for an element by its key and returns its index if found, handling potential hash collisions. [`fd_vinyl_meta_remove_fast`](<#fd_vinyl_meta_remove_fast>) removes an element from the map and ensures the integrity of the map by maintaining the probe sequences of elements, which is crucial for concurrent read operations. The function locks the necessary range of elements to prevent interference with concurrent operations and updates the underlying data structures to reflect changes. The code is part of a larger system, likely intended to be used as a library or module within a broader application, and it does not define a public API or external interfaces directly.
# Imports and Dependencies

---
- `fd_vinyl_meta.h`
- `../../util/tmpl/fd_map_slot_para.c`


# Functions

---
### fd\_vinyl\_meta\_query\_fast<!-- {{#callable:fd_vinyl_meta_query_fast}} -->
[View Source →](<../../../../../src/vinyl/meta/fd_vinyl_meta.c#L18>)

Searches for a key in a hash table and returns the index of the element if found, or an error code if not.
- **Inputs**:
    - ``ele0``: A pointer to the first element of an array of `fd_vinyl_meta_ele_t` structures, representing the hash table.
    - ``ele_max``: The maximum number of elements in the hash table.
    - ``key``: A pointer to the `fd_vinyl_key_t` structure representing the key to search for.
    - ``memo``: A precomputed hash value for the key, used to optimize the search.
    - ``_ele_idx``: A pointer to an `ulong` where the function will store the index of the found element or the index where the key would be inserted if not found.
- **Logic and Control Flow**:
    - Initialize `ele_idx` using the bitwise AND of `memo` and `ele_max-1UL` to determine the starting index for the search.
    - Set `err` to `FD_VINYL_ERR_CORRUPT` to indicate a potential corruption error by default.
    - Iterate over the hash table with a loop that decrements `rem` from `ele_max` to 0, ensuring finite termination even if the table is corrupted.
    - In each iteration, calculate the current element pointer `ele` using `ele0` and `ele_idx`.
    - Check if the current element is unoccupied by evaluating `!ele->phdr.ctl`; if true, set `*_ele_idx` to `ele_idx`, set `err` to `FD_VINYL_ERR_KEY`, and break the loop.
    - If the current element's `memo` matches the input `memo` and the keys are equal (`fd_vinyl_key_eq`), set `*_ele_idx` to `ele_idx`, set `err` to `FD_VINYL_SUCCESS`, and break the loop.
    - If a collision occurs, increment `ele_idx` and wrap it around using `ele_max-1UL`.
    - After the loop, use `FD_CRIT` to check if `rem` is non-zero, indicating no corruption was detected.
- **Output**: Returns an integer error code: `FD_VINYL_SUCCESS` if the key is found, `FD_VINYL_ERR_KEY` if not found, or `FD_VINYL_ERR_CORRUPT` if corruption is detected.


---
### fd\_vinyl\_meta\_remove\_fast<!-- {{#callable:fd_vinyl_meta_remove_fast}} -->
[View Source →](<../../../../../src/vinyl/meta/fd_vinyl_meta.c#L56>)

Removes an element from a cyclically occupied range in a metadata array while maintaining probe sequence integrity and ensuring concurrent read safety.
- **Inputs**:
    - `ele0`: Pointer to the array of metadata elements (`fd_vinyl_meta_ele_t`).
    - `ele_max`: Maximum number of elements in the metadata array.
    - `lock`: Pointer to the lock array used for managing concurrent access.
    - `lock_shift`: Shift value used to calculate lock indices.
    - `line`: Pointer to the array of lines (`fd_vinyl_line_t`) associated with the metadata elements.
    - `line_cnt`: Number of lines in the `line` array.
    - `ele_idx`: Index of the element to be removed from the metadata array.
- **Logic and Control Flow**:
    - Initialize `contig_cnt` to find the number of contiguous occupied elements starting from `ele_idx`.
    - Verify that `contig_cnt` is less than `ele_max` to ensure no corruption.
    - Calculate the range of locks needed to cover the contiguous elements and lock them to protect concurrent readers.
    - Set the control field of the element at `ele_idx` to zero to mark it as unoccupied, creating a hole.
    - Iterate over the remaining contiguous elements to repair any broken probe sequences by moving elements to fill the hole.
    - For each element, check if its probe sequence is broken due to the hole and move it if necessary, updating the hole index.
    - Unlock the range of locks after the removal and repair operations are complete.
- **Output**: No return value; the function modifies the metadata array and lock array in place.
- **Functions Called**:
    - [`fd_vinyl_meta_lock_update_fast`](<fd_vinyl_meta.h.md#fd_vinyl_meta_lock_update_fast>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)