<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Header file for managing lock-free concurrent metadata caching and querying of key-value pairs in DRAM.

# Purpose
The code is a C header file that defines the structure and operations for managing metadata in a lock-free, concurrent environment. It is part of a system that caches metadata for key-value pairs in DRAM, allowing for fast O(1) operations to query this metadata by key. The metadata is managed using a structure called `fd_vinyl_meta_t`, which is implemented as a `fd_map_slot_para`. This structure supports a single writer and multiple concurrent readers under normal operation, and multiple concurrent readers and writers during recovery. The metadata cache can be shared between threads in different processes and is designed to be reconstructed from past data streams, making it suitable for post-mortem debugging.

The file defines several key components, including the `fd_vinyl_meta_ele_t` structure, which holds metadata elements, and various functions for querying and modifying these elements. Functions such as [`fd_vinyl_meta_query_fast`](<#fd_vinyl_meta_query_fast>) and [`fd_vinyl_meta_remove_fast`](<#fd_vinyl_meta_remove_fast>) provide mechanisms for querying and removing metadata elements, respectively, under the assumption of a single active writer. The file also includes macros and inline functions to handle metadata element locking and updates efficiently. The header file does not define a public API for external use but provides internal mechanisms for managing metadata in a concurrent environment.
# Imports and Dependencies

---
- `../bstream/fd_vinyl_bstream.h`
- `../../util/tmpl/fd_map_slot_para.c`


# Data Structures

---
### fd\_vinyl\_meta\_ele
- **Type**: ``struct``
- **Members**:
    - `memo`: Stores a unique identifier for the key, calculated using `fd_vinyl_key_memo`.
    - `phdr`: Holds the pair header information of type `fd_vinyl_bstream_phdr_t`.
    - `seq`: Indicates the sequence number of the most recent version of the pair in the bstream.
    - `line_idx`: Specifies the cache line index assigned to the pair if its value is cached, or `ULONG_MAX` if not.
- **Description**: Represents metadata for a key-value pair in a vinyl tile, including a memoized key identifier, pair header, sequence number, and cache line index. The `memo` and `phdr` fields are used for key identification and header information, while `seq` and `line_idx` are specific to the vinyl tile's internal operations and are ignored by concurrent readers.


---
### fd\_vinyl\_meta\_ele\_t
- **Type**: ``struct``
- **Members**:
    - ``memo``: Stores the memoized key value using `fd_vinyl_key_memo`.
    - ``phdr``: Holds the pair header information of type `fd_vinyl_bstream_phdr_t`.
    - ``seq``: Indicates the sequence number of the most recent version of the pair in the bstream's past.
    - ``line_idx``: Specifies the cache line index assigned to the pair's decoded value, or `ULONG_MAX` if not cached.
- **Description**: `fd_vinyl_meta_ele_t` is a structure used to represent metadata elements in a vinyl meta cache. It includes fields for memoization of keys, pair header information, sequence numbers for version tracking, and cache line indices for cached values. This structure supports concurrent reading and writing operations, allowing efficient querying and updating of metadata in a lock-free manner. It is part of a larger system that manages key-value pairs in a bstream, optimizing for single-writer and multiple-reader scenarios.


---
### fd\_vinyl\_line\_t
- **Type**: ``struct``
- **Description**: `fd_vinyl_line_t` is a forward declaration of a structure named `fd_vinyl_line`. The actual definition of the structure is not provided in the given code, so no details about its members or purpose can be described. It is used in the context of the `fd_vinyl_meta_remove_fast` function, indicating it may relate to managing or updating vinyl cache lines.


# Functions

---
### fd\_vinyl\_meta\_ele\_in\_use<!-- {{#callable:fd_vinyl_meta_ele_in_use}} -->
[View Source →](<../../../../../src/vinyl/meta/fd_vinyl_meta.h#L104>)

Checks if a given `fd_vinyl_meta_ele_t` element is in use by evaluating its control field.
- **Inputs**:
    - `ele`: A pointer to a constant `fd_vinyl_meta_ele_t` structure representing the element to check.
- **Logic and Control Flow**:
    - Evaluate the control field `ele->phdr.ctl` of the given element.
    - Return 1 if `ele->phdr.ctl` is non-zero, indicating the element is in use.
    - Return 0 if `ele->phdr.ctl` is zero, indicating the element is not in use.
- **Output**: Returns an integer: 1 if the element is in use, 0 otherwise.


---
### fd\_vinyl\_meta\_ele\_in\_bstream<!-- {{#callable:fd_vinyl_meta_ele_in_bstream}} -->
[View Source →](<../../../../../src/vinyl/meta/fd_vinyl_meta.h#L122>)

Checks if a metadata element is present in the bstream at the current sequence.
- **Inputs**:
    - `ele`: A pointer to a constant `fd_vinyl_meta_ele_t` structure representing the metadata element to check.
- **Logic and Control Flow**:
    - Accesses the `phdr.ctl` field of the `ele` structure.
    - Compares `phdr.ctl` to `ULONG_MAX`.
    - Returns 1 if `phdr.ctl` is not equal to `ULONG_MAX`, indicating the element is present in the bstream.
    - Returns 0 if `phdr.ctl` is equal to `ULONG_MAX`, indicating the element is not present in the bstream.
- **Output**: Returns an integer: 1 if the element is present in the bstream, 0 otherwise.


---
### fd\_vinyl\_meta\_ele\_in\_cache<!-- {{#callable:fd_vinyl_meta_ele_in_cache}} -->
[View Source →](<../../../../../src/vinyl/meta/fd_vinyl_meta.h#L123>)

Checks if a `fd_vinyl_meta_ele_t` element has allocated space in the vinyl's data cache.
- **Inputs**:
    - `ele`: A pointer to a constant `fd_vinyl_meta_ele_t` structure representing the metadata element to check.
- **Logic and Control Flow**:
    - Check if the `line_idx` field of the `ele` structure is not equal to `ULONG_MAX`.
    - Return 1 if the condition is true, indicating the element is in the cache.
    - Return 0 if the condition is false, indicating the element is not in the cache.
- **Output**: Returns 1 if the element is in the cache, otherwise returns 0.


---
### fd\_vinyl\_meta\_lock\_update\_fast<!-- {{#callable:fd_vinyl_meta_lock_update_fast}} -->
[View Source →](<../../../../../src/vinyl/meta/fd_vinyl_meta.h#L141>)

Updates a lock version by adding a direction value and ensures memory ordering with memory fences.
- **Inputs**:
    - ``lock``: A pointer to an unsigned long integer representing the lock version to update.
    - ``dir``: A long integer indicating the direction and magnitude of the update to apply to the lock version.
- **Logic and Control Flow**:
    - Calculate the new version by adding the `dir` value to the current value pointed to by `lock`.
    - Execute a memory fence to ensure memory ordering before updating the lock.
    - Update the lock with the new version value.
    - Execute another memory fence to ensure memory ordering after updating the lock.
- **Output**: No return value; the function updates the lock version in place.


---
### fd\_vinyl\_meta\_query<!-- {{#callable:fd_vinyl_meta_query}} -->
[View Source →](<../../../../../src/vinyl/meta/fd_vinyl_meta.h#L212>)

Queries metadata for a given key in a lock-free manner and populates the provided info structure with the result.
- **Inputs**:
    - `meta`: A pointer to the `fd_vinyl_meta_t` structure representing the metadata cache.
    - `key`: A constant pointer to the `fd_vinyl_key_t` structure representing the key to query.
    - `_info`: A pointer to a memory region compatible with `fd_vinyl_info_t` where the function will store the query result.
- **Logic and Control Flow**:
    - Initializes a `fd_vinyl_meta_query_t` structure for the query.
    - Enters an infinite loop to repeatedly attempt the query until successful or an error occurs.
    - Calls `fd_vinyl_meta_query_try` to attempt querying the metadata for the given key with blocking behavior.
    - If an error occurs during the query attempt, returns the error code immediately.
    - Retrieves the metadata element using `fd_vinyl_meta_query_ele_const` and extracts the control and info fields.
    - Copies the `info` field from the metadata element to the `_info` output parameter.
    - Checks if the query test passes using `fd_vinyl_meta_query_test`; if it does not pass, breaks the loop.
    - If the query test fails, pauses the execution briefly using `FD_SPIN_PAUSE` and retries the query.
    - After exiting the loop, returns `FD_MAP_SUCCESS` if the control field is not `ULONG_MAX`, otherwise returns `FD_MAP_ERR_KEY`.
- **Output**: Returns `FD_MAP_SUCCESS` if the key exists in the metadata cache and populates `_info` with the key's metadata; returns `FD_MAP_ERR_KEY` if the key does not exist.


# Function Declarations (Public API)

---
### fd\_vinyl\_meta\_query\_fast<!-- {{#callable_declaration:fd_vinyl_meta_query_fast}} -->
[View Source →](<../../../../../src/vinyl/meta/fd_vinyl_meta.h#L169>)

Queries a metadata cache for a specific key.
- **Description**: Use this function to search for a key in a metadata cache when you are the only active writer and no other preparations are in progress. It performs a lock-free query and returns the index of the metadata element associated with the key if found. If the key is not found, it provides an index suitable for storing new metadata. Ensure that the metadata cache is not at full capacity before calling this function. The function will log a critical error if it detects any corruption during the query process.
- **Inputs**:
    - `ele0`: A pointer to the first element of the metadata array. It must be a valid pointer to an array of `fd_vinyl_meta_ele_t` elements indexed from 0 to `ele_max`.
    - `ele_max`: The maximum number of elements in the metadata array. It must be a power of 2.
    - `key`: A pointer to the key to query. It must be a valid pointer to a `fd_vinyl_key_t` structure.
    - `memo`: A precomputed memoization value for the key, typically obtained using `fd_vinyl_key_memo`. It is used to optimize the query process.
    - `_ele_idx`: A pointer to an unsigned long where the function will store the index of the found element or the index suitable for storing new metadata if the key is not found. It must be a valid pointer.
- **Output**: Returns `FD_VINYL_SUCCESS` (0) if the key is found, or a negative `FD_VINYL_ERR` code if not. On success or failure, `_ele_idx` is updated with the relevant index.
- **See Also**: [`fd_vinyl_meta_query_fast`](<fd_vinyl_meta.c.md#fd_vinyl_meta_query_fast>)  (Implementation)


---
### fd\_vinyl\_meta\_remove\_fast<!-- {{#callable_declaration:fd_vinyl_meta_remove_fast}} -->
[View Source →](<../../../../../src/vinyl/meta/fd_vinyl_meta.h#L182>)

Removes a metadata element from the meta structure.
- **Description**: Use this function to remove a metadata element at a specified index from the meta structure when you are the only active writer and no meta prepares are in progress. This function ensures that the removal process does not interfere with concurrent readers by locking the necessary range of elements. It is important to note that this function assumes there is at least one unoccupied element in the meta and that the element at the specified index is occupied. The function cannot fail from the caller's perspective, but it will log a critical error if corruption is detected in the meta or line during removal.
- **Inputs**:
    - `ele0`: A pointer to the array of metadata elements. The array must have at least one unoccupied element.
    - `ele_max`: The maximum number of elements in the array, which must be a power of 2 and at least 2.
    - `lock`: A pointer to the lock array used to protect concurrent readers during the removal process.
    - `lock_shift`: The shift value used to calculate the lock index, which is the logarithm base 2 of the ratio of ele_max to the number of locks.
    - `line`: A pointer to the array of vinyl line structures, indexed from 0 to line_cnt.
    - `line_cnt`: The number of vinyl line structures, which must be between 3 and FD_VINYL_LINE_MAX.
    - `ele_idx`: The index of the element to remove, which must be occupied.
- **Output**: None
- **See Also**: [`fd_vinyl_meta_remove_fast`](<fd_vinyl_meta.c.md#fd_vinyl_meta_remove_fast>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)