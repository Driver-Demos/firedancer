<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for concurrent operations on vinyl metadata, including insert, remove, modify, and query functions.

# Purpose
The code is a C program designed to test the functionality and concurrency of a data structure referred to as `fd_vinyl_meta`. It includes several components that simulate concurrent operations on this data structure, which appears to be a metadata management system. The program uses multiple threads (referred to as "tiles") to perform various operations such as inserting, removing, querying, and modifying metadata elements. These operations are executed in a concurrent environment to test the robustness and correctness of the `fd_vinyl_meta` under different conditions.

The program defines several functions, including [`tile_main`](<#tile_main>), [`writer_main`](<#writer_main>), and [`reader_main`](<#reader_main>), which are responsible for executing different types of operations on the metadata. The [`tile_main`](<#tile_main>) function handles concurrent operations, while [`writer_main`](<#writer_main>) and [`reader_main`](<#reader_main>) focus on single-writer and multiple-reader scenarios, respectively. The main function initializes the environment, sets up the metadata structure, and orchestrates the execution of these functions across multiple threads. The program also includes mechanisms for memory allocation and synchronization to ensure that operations are performed correctly and efficiently. The use of random number generation and diagnostic logging helps in simulating realistic scenarios and tracking the progress of the tests.
# Imports and Dependencies

---
- `../fd_vinyl.h`


# Global Variables

---
### shmem
- **Type**: ``uchar[]``
- **Description**: Represents a static array of unsigned characters with a maximum size defined by `SHMEM_MAX`. This array is used to allocate shared memory for various operations in the program.
- **Use**: Used to allocate and manage shared memory space for concurrent operations.


---
### shmem\_cnt
- **Type**: ``ulong``
- **Description**: Represents the current offset in the shared memory buffer `shmem`. It is initialized to zero and is used to track the amount of memory allocated from the buffer.
- **Use**: Tracks the current allocation position in the `shmem` buffer for memory management.


---
### tile\_meta
- **Type**: ``fd_vinyl_meta_t *``
- **Description**: Points to a `fd_vinyl_meta_t` structure, which is used to manage metadata for vinyl operations. This structure is involved in various operations such as querying, inserting, and removing metadata elements.
- **Use**: Used as a global pointer to access and manipulate vinyl metadata across different functions.


---
### tile\_iter\_cnt
- **Type**: `ulong`
- **Description**: `tile_iter_cnt` is a static global variable of type `ulong` that stores the number of iterations to perform in the `tile_main` and `writer_main` functions.
- **Use**: Used to control the number of iterations for operations on the `fd_vinyl_meta_t` structure in concurrent tile operations.


---
### tile\_go
- **Type**: `ulong`
- **Description**: `tile_go` is a static global variable of type `ulong`.
- **Use**: It is used as a flag to control the execution flow of concurrent operations on tiles.


---
### \_meta\_key
- **Type**: ``fd_vinyl_key_t *``
- **Description**: A pointer to a `fd_vinyl_key_t` structure, initialized to `NULL`. This variable is used to store keys in a shared memory context for concurrent operations.
- **Use**: Used to manage and store keys for operations on the `fd_vinyl_meta_t` structure in a concurrent environment.


---
### \_meta\_cnt
- **Type**: `ulong`
- **Description**: `_meta_cnt` is a static global variable of type `ulong` initialized to 0UL. It is used to keep track of the number of metadata keys currently stored in the `_meta_key` array.
- **Use**: Tracks the count of metadata keys in the `_meta_key` array for operations in the `writer_main` and `reader_main` functions.


# Functions

---
### shmem\_alloc<!-- {{#callable:shmem_alloc}} -->
[View Source →](<../../../../../src/vinyl/meta/test_vinyl_meta.c#L8>)

Allocates a block of memory from a shared memory pool with a specified alignment and size.
- **Inputs**:
    - `a`: The alignment requirement for the memory block, specified as an unsigned long integer.
    - `s`: The size of the memory block to allocate, specified as an unsigned long integer.
- **Logic and Control Flow**:
    - Calculate the aligned memory address `m` by adjusting the current position in the shared memory (`shmem + shmem_cnt`) to meet the alignment requirement `a` using `fd_ulong_align_up`.
    - Update `shmem_cnt` to reflect the new position in the shared memory after allocating the block of size `s`.
    - Check if the updated `shmem_cnt` exceeds the maximum allowed shared memory size `SHMEM_MAX` using `FD_TEST`.
    - Return the aligned memory address `m` cast to a `void *`.
- **Output**: A pointer to the allocated memory block, cast to a `void *`.


---
### tile\_main<!-- {{#callable:tile_main}} -->
[View Source →](<../../../../../src/vinyl/meta/test_vinyl_meta.c#L21>)

Executes concurrent operations on a shared metadata structure using multiple threads.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: The array of command-line arguments.
- **Logic and Control Flow**:
    - Initialize local variables and context for the tile, including metadata and random number generator.
    - Wait for a signal to start operations by checking the volatile `tile_go` variable.
    - Perform a loop for a specified number of iterations (`iter_cnt`), executing various operations based on a randomly selected operation code (`op`).
    - Operations include inserting, removing, modifying, and querying keys in the metadata, with checks for conditions like key existence and concurrency flags.
    - Use a switch-case structure to handle different operations, each with specific logic for handling metadata elements and keys.
    - After completing the iterations, clean up by removing all keys from the metadata and restoring shared memory state.
    - Delete the random number generator and return 0 to indicate successful execution.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`shmem_alloc`](<#shmem_alloc>)


---
### writer\_main<!-- {{#callable:writer_main}} -->
[View Source →](<../../../../../src/vinyl/meta/test_vinyl_meta.c#L467>)

Performs various writer-side operations on a shared metadata structure in a concurrent environment.
- **Inputs**:
    - `argc`: The number of command-line arguments, used to determine the tile index.
    - `argv`: The command-line arguments, used to determine the tile count.
- **Logic and Control Flow**:
    - Initialize local variables and context for the tile, including metadata and random number generator.
    - Wait for a signal to start operations by checking the volatile `tile_go` variable.
    - Iterate over a specified number of iterations (`iter_cnt`), performing random operations based on a generated random number.
    - For each iteration, select an operation (query, insert, remove, modify) based on the random number and execute it on the metadata structure.
    - Use a switch-case structure to handle different operations, such as querying for existing keys, inserting new keys, removing keys, and modifying keys.
    - Perform diagnostic logging and verification at regular intervals.
    - After completing the iterations, clean up by removing all keys from the metadata structure.
    - Signal completion by setting `tile_go` to 2 and clean up the random number generator.
- **Output**: Returns 0 to indicate successful execution.


---
### reader\_main<!-- {{#callable:reader_main}} -->
[View Source →](<../../../../../src/vinyl/meta/test_vinyl_meta.c#L697>)

Continuously queries a shared metadata structure for keys published by a writer and verifies the results.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: The array of command-line arguments.
- **Logic and Control Flow**:
    - Initialize local variables and random number generator using `argc` and `argv`.
    - Wait for a signal (`tile_go`) to start processing.
    - Enter an infinite loop to continuously query the metadata while the writer is active.
    - Check if `tile_go` is not equal to 1, and if so, break the loop.
    - Retrieve the count of metadata entries (`_meta_cnt`).
    - If `_meta_cnt` is zero, pause and continue to the next iteration.
    - Select a random key from `_meta_key` using the random number generator.
    - Query the metadata for the selected key using `fd_vinyl_meta_query` and handle errors if the key is not found.
    - Verify the integrity of the retrieved information by checking specific conditions.
    - Attempt to query a key that is known to be absent in the metadata and verify the expected error.
    - Clean up by deleting the random number generator and return 0.
- **Output**: Returns 0 after completing the querying process.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/vinyl/meta/test_vinyl_meta.c#L761>)

Initializes and tests a concurrent vinyl metadata system using multiple tiles.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Extracts configuration parameters (`ele_max`, `lock_cnt`, `probe_max`, `seed`, `iter_cnt`) from the command line or uses default values.
    - Logs the configuration parameters for testing.
    - Initializes a random number generator `rng`.
    - Allocates and initializes shared memory for vinyl meta elements and metadata.
    - Creates and joins a vinyl meta structure with the allocated memory.
    - Sets up the global `tile_meta` and `tile_iter_cnt` variables for tile operations.
    - Iterates over the number of tiles (`tile_max`) to test concurrent operations.
    - For each tile count, initializes `tile_go` to 0, starts additional tiles using `fd_tile_exec_new`, and waits for a short period.
    - Sets `tile_go` to 1 to start tile operations and calls [`tile_main`](<#tile_main>) for the main tile.
    - Deletes additional tiles after operations complete and verifies the vinyl meta structure.
    - Tests single writer and concurrent reader operations by setting up shared memory and executing [`writer_main`](<#writer_main>) and `reader_main` functions.
    - Verifies the vinyl meta structure after each test.
    - Leaves and destroys the vinyl meta structure, deletes the random number generator, and halts the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`shmem_alloc`](<#shmem_alloc>)
    - [`tile_main`](<#tile_main>)
    - [`writer_main`](<#writer_main>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)