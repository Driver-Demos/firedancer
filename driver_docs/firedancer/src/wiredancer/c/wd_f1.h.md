<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Header file for PCI management and ED25519 verification in the Wiredancer project.

# Purpose
The code is a C header file that defines structures, constants, and function prototypes for managing PCI (Peripheral Component Interconnect) interactions and ED25519 signature verification in a hardware-accelerated environment. It includes several standard and specialized libraries, such as `fpga_pci.h` and `fpga_mgmt.h`, which suggest that the code interfaces with FPGA (Field-Programmable Gate Array) hardware. The file defines constants like `WD_PCI_MAGIC`, `WD_N_PCI_SLOTS`, and `WD_N_PCI_STREAMS`, which are used to configure the PCI slots and streams.

The file defines several data structures, including `wd_pci_st_t`, `wd_pci_t`, and `wd_wksp_t`, which are used to manage PCI configurations and ED25519 verification requests. The functions [`wd_init_pci`](<#wd_init_pci>) and [`wd_free_pci`](<#wd_free_pci>) are used to initialize and free PCI resources, respectively. The file also provides functions for resetting and reading counters, as well as functions for ED25519 signature verification, such as [`wd_ed25519_verify_req`](<#wd_ed25519_verify_req>). These functions facilitate sending verification requests to the hardware and managing the internal state of the request and response paths. The header file is intended to be included in other C source files that require these functionalities.
# Imports and Dependencies

---
- `fcntl.h`
- `unistd.h`
- `stdio.h`
- `stdarg.h`
- `sys/mman.h`
- `immintrin.h`
- `fpga_pci.h`
- `fpga_mgmt.h`
- `utils/lcd.h`
- `fpga_mgmt_internal.h`
- `../../tango/mcache/fd_mcache.h`


# Data Structures

---
### wd\_pci\_st\_t
- **Type**: ``struct``
- **Members**:
    - ``a``: Stores the address as a 64-bit unsigned integer.
    - ``b``: Stores the base as a 64-bit unsigned integer.
    - ``m``: Stores the mask as a 64-bit unsigned integer.
- **Description**: Defines a structure with three 64-bit unsigned integer fields: `a`, `b`, and `m`, which are used to store an address, a base, and a mask, respectively. This structure is likely used to represent a PCI configuration or mapping in a hardware or FPGA context.


---
### wd\_pci\_t
- **Type**: ``struct``
- **Members**:
    - ``bar0``: A handle to the first PCI Base Address Register (BAR).
    - ``bar4``: A handle to the fourth PCI Base Address Register (BAR).
    - ``bar4_addr``: A pointer to the memory-mapped address of the fourth PCI BAR.
    - ``stream``: An array of `wd_pci_st_t` structures, with a size defined by `WD_N_PCI_STREAMS`, representing PCI streams.
- **Description**: Defines a structure for managing PCI resources, including handles to specific PCI Base Address Registers and an array of streams for data transfer.


---
### wd\_ed25519\_verify\_t
- **Type**: ``struct``
- **Members**:
    - ``req_slot``: A 32-bit unsigned integer that specifies the request slot.
    - ``req_depth``: A 64-bit unsigned integer that specifies the request depth.
- **Description**: Defines a structure used to hold information about a verification request in the ED25519 verification process, specifically the request slot and depth.


---
### wd\_wksp\_t
- **Type**: ``struct``
- **Members**:
    - `initialized`: Indicates if the workspace is initialized.
    - `pci_slots`: Stores the number of PCI slots available.
    - `stream_buf`: Points to a buffer for stream data.
    - `pci`: Array of `wd_pci_t` structures representing PCI configurations.
    - `sv`: Holds the state for ED25519 verification.
- **Description**: Manages the state and configuration for a wiredancer workspace, including PCI slot information, stream buffer, and ED25519 verification state.


# Function Declarations (Public API)

---
### wd\_init\_pci<!-- {{#callable_declaration:wd_init_pci}} -->
[View Source →](<../../../../../src/wiredancer/c/wd_f1.h#L60>)

Initializes PCI slots for a workspace.
- **Description**: Use this function to initialize the PCI slots in a `wd_wksp_t` structure. It sets up the necessary PCI bars and streams for each slot specified by the `slots` bitmask. This function must be called before any PCI operations are performed on the workspace. It returns an error if it cannot attach to the specified slots. Ensure that the `wd` parameter is a valid pointer to a `wd_wksp_t` structure and that the `slots` parameter correctly represents the slots to initialize.
- **Inputs**:
    - `wd`: A pointer to a `wd_wksp_t` structure. Must not be null. The function initializes the PCI slots and streams within this structure.
    - `slots`: A 64-bit bitmask indicating which PCI slots to initialize. Each bit represents a slot, and a set bit indicates that the corresponding slot should be initialized. Invalid or unsupported slots are ignored.
- **Output**: Returns 0 on success. Returns -1 if it fails to attach to any specified slot.
- **See Also**: [`wd_init_pci`](<wd_f1.c.md#wd_init_pci>)  (Implementation)


---
### wd\_free\_pci<!-- {{#callable_declaration:wd_free_pci}} -->
[View Source →](<../../../../../src/wiredancer/c/wd_f1.h#L61>)

Releases resources associated with a PCI workspace.
- **Description**: Use this function to release resources that were previously allocated for a PCI workspace. It is important to call this function when the workspace is no longer needed to ensure proper cleanup and resource management. This function must be called after the workspace has been initialized and used. It does not perform any operations on the workspace itself, and it always returns success.
- **Inputs**:
    - `wd`: A pointer to a `wd_wksp_t` structure representing the PCI workspace. The pointer must not be null, and the workspace should have been previously initialized.
- **Output**: Returns 0 to indicate successful execution.
- **See Also**: [`wd_free_pci`](<wd_f1.c.md#wd_free_pci>)  (Implementation)


---
### wd\_rst\_cntrs<!-- {{#callable_declaration:wd_rst_cntrs}} -->
[View Source →](<../../../../../src/wiredancer/c/wd_f1.h#L63>)

Resets the counters for a specified PCI slot.
- **Description**: Use this function to reset the counters associated with a specific PCI slot in the `wd_wksp_t` workspace. This function is useful when you need to clear the counter values for a slot before starting new operations. Ensure that the slot specified is valid and currently in use, as indicated by the `pci_slots` bitmask in the `wd_wksp_t` structure. If the slot is not valid or not in use, the function will return immediately without performing any action.
- **Inputs**:
    - `wd`: A pointer to a `wd_wksp_t` structure representing the workspace. This must not be null, and the workspace should be properly initialized before calling this function.
    - `slot`: An unsigned 32-bit integer representing the PCI slot to reset. The value must correspond to a valid slot that is currently in use, as indicated by the `pci_slots` bitmask in the `wd_wksp_t` structure.
- **Output**: None
- **See Also**: [`wd_rst_cntrs`](<wd_f1.c.md#wd_rst_cntrs>)  (Implementation)


---
### wd\_snp\_cntrs<!-- {{#callable_declaration:wd_snp_cntrs}} -->
[View Source →](<../../../../../src/wiredancer/c/wd_f1.h#L64>)

Snapshots the counters for a specified PCI slot.
- **Description**: Use this function to capture the current state of counters for a specific PCI slot in the workspace. It is important to ensure that the specified slot is valid and enabled in the `pci_slots` bitmask of the `wd_wksp_t` structure before calling this function. If the slot is not enabled, the function will return immediately without making any changes. This function is typically used in environments where monitoring or logging of PCI slot activity is required.
- **Inputs**:
    - `wd`: A pointer to a `wd_wksp_t` structure that represents the workspace. This must not be null and must be properly initialized before calling the function.
    - `slot`: An unsigned 32-bit integer representing the PCI slot to snapshot. The slot must be within the valid range of slots and must be enabled in the `pci_slots` bitmask of the `wd_wksp_t` structure. If the slot is not enabled, the function will return without performing any action.
- **Output**: None
- **See Also**: [`wd_snp_cntrs`](<wd_f1.c.md#wd_snp_cntrs>)  (Implementation)


---
### wd\_rd\_cntr<!-- {{#callable_declaration:wd_rd_cntr}} -->
[View Source →](<../../../../../src/wiredancer/c/wd_f1.h#L65>)

Reads a counter value from a specified PCI slot.
- **Description**: Use this function to read a counter value from a specific PCI slot in the workspace. The function checks if the specified slot is valid and enabled before attempting to read the counter. If the slot is not enabled, the function returns zero. This function is typically used in environments where PCI slot management is necessary, and it assumes that the workspace has been properly initialized and configured.
- **Inputs**:
    - `wd`: A pointer to a `wd_wksp_t` structure representing the workspace. Must not be null and should be properly initialized.
    - `slot`: An unsigned 32-bit integer representing the PCI slot number. Must be within the valid range of slots available in the workspace.
    - `ci`: An unsigned 32-bit integer representing the counter index to read. The function uses this index to perform the read operation.
- **Output**: Returns the counter value as a 32-bit unsigned integer if the slot is enabled; otherwise, returns zero.
- **See Also**: [`wd_rd_cntr`](<wd_f1.c.md#wd_rd_cntr>)  (Implementation)


---
### wd\_rd\_ts<!-- {{#callable_declaration:wd_rd_ts}} -->
[View Source →](<../../../../../src/wiredancer/c/wd_f1.h#L66>)

Reads a timestamp from a specified PCI slot.
- **Description**: Use this function to read a timestamp from a specific PCI slot in the workspace. The function checks if the specified slot is active by verifying the `pci_slots` bitmask. If the slot is not active, the function returns zero. This function is useful for obtaining timing information from a PCI slot, and it must be called with a valid workspace and slot number.
- **Inputs**:
    - `wd`: A pointer to a `wd_wksp_t` structure representing the workspace. Must not be null. The workspace must be properly initialized before calling this function.
    - `slot`: A 32-bit unsigned integer representing the PCI slot number. Valid slot numbers are determined by the `pci_slots` bitmask in the `wd_wksp_t` structure. If the slot is not active, the function returns zero.
- **Output**: Returns a 64-bit unsigned integer representing the timestamp read from the specified PCI slot, or zero if the slot is not active.
- **See Also**: [`wd_rd_ts`](<wd_f1.c.md#wd_rd_ts>)  (Implementation)


---
### wd\_zprintf<!-- {{#callable_declaration:wd_zprintf}} -->
[View Source →](<../../../../../src/wiredancer/c/wd_f1.h#L69>)

Formats and prints a string with '0' characters replaced by underscores.
- **Description**: Use this function to format a string according to a specified format and print it to the standard output. It replaces all '0' characters in the formatted string with underscores before printing. This function is useful when you need to ensure that '0' characters are not present in the output. The function does not perform any error checking on the format string or the arguments, so ensure that the format string is valid and matches the provided arguments.
- **Inputs**:
    - `format`: A C-style format string that specifies how to format the subsequent arguments. Must not be null. The format string should be compatible with `printf`-style formatting.
- **Output**: None
- **See Also**: [`wd_zprintf`](<wd_f1.c.md#wd_zprintf>)  (Implementation)


---
### wd\_ed25519\_verify\_init\_req<!-- {{#callable_declaration:wd_ed25519_verify_init_req}} -->
[View Source →](<../../../../../src/wiredancer/c/wd_f1.h#L73>)

Initialize the internal state for ED25519 verification request processing.
- **Description**: Use this function to set up the internal state necessary for processing ED25519 verification requests. It configures the workspace with the specified memory cache depth and address, and sets up the PCI slots for communication. This function must be called before sending any verification requests to ensure the system is correctly initialized. It does not perform input validation, so ensure that all parameters are valid before calling.
- **Inputs**:
    - `wd`: A pointer to a `wd_wksp_t` structure representing the workspace. Must not be null. The caller retains ownership.
    - `send_fails`: A `uint8_t` value indicating the number of send failures to configure. Valid values are implementation-specific.
    - `mcache_depth`: A `uint64_t` value specifying the depth of the memory cache. Must be a valid depth value for the system.
    - `mcache_addr`: A pointer to the memory cache address. Must not be null. The caller retains ownership.
- **Output**: None
- **See Also**: [`wd_ed25519_verify_init_req`](<wd_f1.c.md#wd_ed25519_verify_init_req>)  (Implementation)


---
### wd\_ed25519\_verify\_init\_resp<!-- {{#callable_declaration:wd_ed25519_verify_init_resp}} -->
[View Source →](<../../../../../src/wiredancer/c/wd_f1.h#L81>)

Initializes the internal state of the response path for ED25519 verification.
- **Description**: Use this function to prepare the response path for ED25519 verification operations. It must be called before any response-related operations are performed. This function does not perform any operations on the input parameter and does not return any value. Ensure that the workspace is properly initialized before calling this function.
- **Inputs**:
    - `wd`: A pointer to a `wd_wksp_t` structure. The caller must ensure that this pointer is valid and points to an initialized workspace. The function does not modify the contents of the structure.
- **Output**: None
- **See Also**: [`wd_ed25519_verify_init_resp`](<wd_f1.c.md#wd_ed25519_verify_init_resp>)  (Implementation)


---
### wd\_ed25519\_verify\_req<!-- {{#callable_declaration:wd_ed25519_verify_req}} -->
[View Source →](<../../../../../src/wiredancer/c/wd_f1.h#L103>)

Sends a verification request to hardware for ED25519 signature verification.
- **Description**: Use this function to send a request to the hardware to verify a message's signature using the ED25519 standard. The function blocks until it can send the request. It requires a workspace initialized with `wd_ed25519_verify_init_req` or `wd_ed25519_verify_init_resp`. The message, signature, and public key must be valid memory regions, with the message size specified by `sz`. The function does not perform input validation, so ensure all inputs are correct before calling. The control parameter `m_ctrl` indicates packet boundaries. The function returns zero on success.
- **Inputs**:
    - `wd`: A pointer to an initialized `wd_wksp_t` structure. Must not be null.
    - `msg`: A pointer to the message to verify. Can be null if `sz` is zero.
    - `sz`: The size of the message in bytes. Can be zero.
    - `sig`: A pointer to a 64-byte memory region containing the message's signature. Must not be null.
    - `public_key`: A pointer to a 32-byte memory region containing the public key. Must not be null.
    - `m_seq`: A sequence number for the message. Used for internal tracking.
    - `m_chunk`: A chunk identifier for the message. Used for internal tracking.
    - `m_ctrl`: A control parameter indicating start and end of packet boundaries. Must be correctly set by the caller.
    - `m_sz`: A size parameter for internal use. Must be correctly set by the caller.
- **Output**: Returns zero on success. Returns -1 if the request cannot be sent due to backpressure.
- **See Also**: [`wd_ed25519_verify_req`](<wd_f1.c.md#wd_ed25519_verify_req>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)