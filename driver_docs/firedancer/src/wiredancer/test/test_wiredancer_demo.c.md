<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

A unit test for the Wiredancer system, designed to run on AWS-F1, comparing Wiredancer's performance against x86 by replaying network packets and verifying transactions.

# Purpose
The code is a unit test for the Wiredancer system, designed to be executed in an AWS-F1 environment. Its primary function is to validate the performance and correctness of the Wiredancer system against an x86-based system. The test involves a series of components, including a "replay" tile that feeds network packets to a "parser" tile. The parser processes these packets, assuming one transaction per packet, and sends signature verification requests downstream. These requests can be processed by either an x86-based "verify" tile or the Wiredancer system. The "checker" tile then compares the outputs from the x86 system and Wiredancer by matching sequence numbers to ensure consistency.

The code is structured into several main components, each represented by a function that runs on a separate tile (or thread). These components include the [`replay_tile_main`](<#replay_tile_main>), [`parser_tile_main`](<#parser_tile_main>), [`v_x86_tile_main`](<#v_x86_tile_main>), and [`vcheck_tile_main`](<#vcheck_tile_main>) functions, which handle the replay, parsing, x86 verification, and result checking processes, respectively. The test configuration is managed through a `test_cfg` structure, which holds various parameters and state information needed for the test execution. The code also includes mechanisms for handling command-line arguments to configure the test environment, such as the number of FPGA slots, test duration, and whether to enable random transaction corruption. The main function orchestrates the setup, execution, and teardown of the test, ensuring that all components are properly initialized and synchronized.
# Imports and Dependencies

---
- `fd_replay_loop.h`
- `../../util/net/fd_eth.h`
- `../../util/net/fd_ip4.h`
- `../../util/net/fd_udp.h`
- `../../ballet/txn/fd_txn.h`
- `../../ballet/ed25519/fd_ed25519_private.h`
- `../../ballet/ed25519/fd_ed25519.h`
- `../../ballet/sha512/fd_sha512.h`
- `../c/wd_f1.h`
- `wd_f1_mon.h`
- `pthread.h`
- `stdio.h`
- `signal.h`


# Global Variables

---
### test\_halt
- **Type**: `ulong`
- **Description**: `test_halt` is a global variable of type `ulong` initialized to `0UL`. It is used to signal the main function to halt execution when a specific condition is met, such as receiving a POSIX signal.
- **Use**: Used to indicate when the main function should stop running.


# Data Structures

---
### parsed\_txn\_compressed\_meta
- **Type**: ``union``
- **Members**:
    - ``all``: A `ulong` that represents the entire union as a single value.
    - ``msg_sz``: A `ushort` that specifies the message size.
    - ``msg_off``: A `ushort` that indicates the message offset from the start of the packet.
    - ``signature_off``: A `ushort` that indicates the signature offset from the start of the packet.
    - ``public_key_off``: A `ushort` that indicates the public key offset from the start of the packet.
- **Description**: The `parsed_txn_compressed_meta` union is a data structure that can represent transaction metadata in two ways: as a single `ulong` value (`all`) or as a structured set of `ushort` values (`msg_sz`, `msg_off`, `signature_off`, `public_key_off`) that provide specific offsets and sizes related to a transaction's message, signature, and public key within a packet.


---
### parsed\_txn\_compressed\_meta\_t
- **Type**: ``union``
- **Members**:
    - ``all``: A `ulong` that represents the entire compressed metadata as a single value.
    - ``value``: A `struct` containing individual fields for message size, message offset, signature offset, and public key offset.
    - ``msg_sz``: A `ushort` indicating the size of the message.
    - ``msg_off``: A `ushort` indicating the offset of the message from the start of the packet.
    - ``signature_off``: A `ushort` indicating the offset of the signature from the start of the packet.
    - ``public_key_off``: A `ushort` indicating the offset of the public key from the start of the packet.
- **Description**: The `parsed_txn_compressed_meta_t` is a `union` that encapsulates metadata for a parsed transaction in a compressed form. It allows access to the metadata either as a single `ulong` value or as a `struct` with individual fields for message size, message offset, signature offset, and public key offset. This structure is used to efficiently store and access transaction metadata within a fixed size, ensuring that the total size of the union matches the size of a `ulong`.


---
### test\_cfg
- **Type**: ``struct``
- **Members**:
    - ``wksp``: Pointer to a workspace of type `fd_wksp_t`.
    - ``replay_cnc``: Pointer to a command and control structure for replay of type `fd_cnc_t`.
    - ``replay_pcap``: Pointer to a constant character string representing the replay pcap file.
    - ``replay_mtu``: Unsigned long representing the maximum transmission unit for replay.
    - ``replay_orig``: Unsigned long representing the original replay value.
    - ``replay_mcache``: Pointer to a replay metadata cache of type `fd_frag_meta_t`.
    - ``replay_dcache``: Pointer to a replay data cache of type `uchar`.
    - ``replay_cr_max``: Unsigned long representing the maximum replay credit.
    - ``replay_lazy``: Long representing the replay laziness factor.
    - ``replay_seed``: Unsigned integer representing the seed for replay randomness.
    - ``replay_fseq``: Pointer to an array of unsigned long pointers representing replay flow sequences.
    - ``replay_fseq_cnt``: Unsigned long representing the count of replay flow sequences.
    - ``parser_cnc``: Pointer to a command and control structure for parser of type `fd_cnc_t`.
    - ``parser_mcache``: Pointer to a parser metadata cache of type `fd_frag_meta_t`.
    - ``parser_lazy``: Integer representing the parser laziness factor.
    - ``parser_seed``: Unsigned integer representing the seed for parser randomness.
    - ``parser_enabled``: Integer indicating if the parser is enabled.
    - ``parser_replay_fseq``: Pointer to an unsigned long representing the parser replay flow sequence.
    - ``parser_rand_txn_corrupt``: Integer indicating if random transaction corruption is enabled for the parser.
    - ``v_x86_cnc``: Pointer to a command and control structure for x86 verification of type `fd_cnc_t`.
    - ``v_x86_mcache``: Pointer to an x86 verification metadata cache of type `fd_frag_meta_t`.
    - ``v_x86_lazy``: Integer representing the x86 verification laziness factor.
    - ``v_x86_seed``: Unsigned integer representing the seed for x86 verification randomness.
    - ``v_x86_enabled``: Integer indicating if x86 verification is enabled.
    - ``v__wd_enabled``: Integer indicating if Wiredancer verification is enabled.
    - ``v__wd_mcache``: Pointer to a Wiredancer verification metadata cache of type `fd_frag_meta_t`.
    - ``vcheck_cnc``: Pointer to a command and control structure for verification check of type `fd_cnc_t`.
    - ``vcheck_seed``: Unsigned integer representing the seed for verification check randomness.
    - ``vcheck_lazy``: Integer representing the verification check laziness factor.
    - ``test_version``: Integer representing the version of the test.
    - ``wd_slots``: Unsigned long representing the Wiredancer FPGA slots.
    - ``wd_split``: Integer indicating if Wiredancer split is enabled.
- **Description**: Defines configuration parameters for a unit test involving replay, parsing, and verification of network packets using both x86 and Wiredancer platforms. It includes pointers to various command and control structures, metadata caches, and configuration settings such as MTU, randomness seeds, and laziness factors for different components of the test.


---
### test\_cfg\_t
- **Type**: ``struct``
- **Members**:
    - ``wksp``: Pointer to a workspace structure.
    - ``replay_cnc``: Pointer to a command and control structure for replay.
    - ``replay_pcap``: Constant character pointer to the replay pcap file path.
    - ``replay_mtu``: Maximum transmission unit for replay.
    - ``replay_orig``: Original replay value.
    - ``replay_mcache``: Pointer to a replay memory cache structure.
    - ``replay_dcache``: Pointer to a replay data cache.
    - ``replay_cr_max``: Maximum replay credit.
    - ``replay_lazy``: Replay laziness parameter.
    - ``replay_seed``: Seed for replay random number generation.
    - ``replay_fseq``: Pointer to an array of replay flow sequence pointers.
    - ``replay_fseq_cnt``: Count of replay flow sequences.
    - ``parser_cnc``: Pointer to a command and control structure for the parser.
    - ``parser_mcache``: Pointer to a parser memory cache structure.
    - ``parser_lazy``: Parser laziness parameter.
    - ``parser_seed``: Seed for parser random number generation.
    - ``parser_enabled``: Flag indicating if the parser is enabled.
    - ``parser_replay_fseq``: Pointer to the parser's replay flow sequence.
    - ``parser_rand_txn_corrupt``: Flag for random transaction corruption in the parser.
    - ``v_x86_cnc``: Pointer to a command and control structure for x86 verification.
    - ``v_x86_mcache``: Pointer to an x86 verification memory cache structure.
    - ``v_x86_lazy``: x86 verification laziness parameter.
    - ``v_x86_seed``: Seed for x86 verification random number generation.
    - ``v_x86_enabled``: Flag indicating if x86 verification is enabled.
    - ``v__wd_enabled``: Flag indicating if Wiredancer verification is enabled.
    - ``v__wd_mcache``: Pointer to a Wiredancer verification memory cache structure.
    - ``vcheck_cnc``: Pointer to a command and control structure for verification checking.
    - ``vcheck_seed``: Seed for verification checking random number generation.
    - ``vcheck_lazy``: Verification checking laziness parameter.
    - ``test_version``: Version of the test being conducted.
    - ``wd_slots``: Number of Wiredancer slots.
    - ``wd_split``: Flag indicating if Wiredancer is split.
- **Description**: The `test_cfg_t` structure is a configuration data structure used for setting up and managing various components of a unit test for the Wiredancer system. It includes pointers to command and control structures, memory caches, and data caches for different test components such as replay, parser, x86 verification, and Wiredancer verification. It also contains parameters for controlling the behavior of these components, such as laziness, random number generation seeds, and flags for enabling or disabling specific functionalities. The structure is designed to facilitate the configuration and execution of tests that compare the performance and correctness of Wiredancer against x86-based systems.


# Functions

---
### sha512\_modq\_lsB<!-- {{#callable:sha512_modq_lsB}} -->
[View Source →](<../../../../../src/wiredancer/test/test_wiredancer_demo.c#L179>)

Computes a SHA-512 hash of a message, signature, and public key, reduces it modulo a large prime, and returns the least significant byte of the result.
- **Inputs**:
    - `msg`: Pointer to the message data to hash.
    - `sz`: Size of the message data in bytes.
    - `sig`: Pointer to the signature data, expected to be at least 32 bytes.
    - `public_key`: Pointer to the public key data, expected to be at least 32 bytes.
    - `sha`: Pointer to an `fd_sha512_t` structure used for SHA-512 operations.
- **Logic and Control Flow**:
    - Cast the `sig` pointer to a `uchar` pointer and assign it to `r`.
    - Initialize a 64-byte array `h` to store the hash result.
    - Initialize the SHA-512 context using `fd_sha512_init` with `sha`.
    - Append the first 32 bytes of `sig` to the SHA-512 context using `fd_sha512_append`.
    - Append the first 32 bytes of `public_key` to the SHA-512 context using `fd_sha512_append`.
    - Append the message data to the SHA-512 context using `fd_sha512_append`.
    - Finalize the SHA-512 hash computation using `fd_sha512_fini`, storing the result in `h`.
    - Reduce the hash `h` modulo a large prime using `fd_ed25519_sc_reduce`.
    - Return the least significant byte of the reduced hash as an integer.
- **Output**: Returns the least significant byte of the reduced hash as an integer.


---
### replay\_tile\_main<!-- {{#callable:replay_tile_main}} -->
[View Source →](<../../../../../src/wiredancer/test/test_wiredancer_demo.c#L223>)

Initializes and runs the replay tile loop for packet processing in a network test environment.
- **Inputs**:
    - `argc`: The number of arguments passed to the function, which is not used in this function.
    - `argv`: An array of arguments, where the first element is cast to a `test_cfg_t` structure containing configuration settings for the replay tile.
- **Logic and Control Flow**:
    - Logs the activation of the `replay_tile_main` function.
    - Initializes a random number generator (`rng`) using the `replay_seed` from the configuration.
    - Allocates a scratch buffer with a size and alignment defined by `FD_REPLAY_TILE_SCRATCH_FOOTPRINT` and `FD_REPLAY_TILE_SCRATCH_ALIGN`.
    - Calls [`fd_replay_tile_loop`](<fd_replay_loop.c.md#fd_replay_tile_loop>) with various configuration parameters and checks its return value with `FD_TEST`.
    - Deletes the random number generator and returns 0, indicating successful execution.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`fd_replay_tile_loop`](<fd_replay_loop.c.md#fd_replay_tile_loop>)


---
### parser\_tile\_main<!-- {{#callable:parser_tile_main}} -->
[View Source →](<../../../../../src/wiredancer/test/test_wiredancer_demo.c#L264>)

Processes network packets by parsing transactions, verifying signatures, and managing flow control between different components.
- **Inputs**:
    - `argc`: The number of arguments passed to the function, used to initialize `parser_idx`.
    - `argv`: An array of arguments, where the first element is a pointer to a `test_cfg_t` structure containing configuration data for the parser.
- **Logic and Control Flow**:
    - Initialize `parser_idx`, `cfg`, and `wksp` from `argc` and `argv`.
    - Log the activation of the function using `FD_LOG_NOTICE`.
    - Set up connections to various components such as `cnc`, `mcache`, `fseq`, and `out_mcache` using the configuration in `cfg`.
    - Initialize diagnostic counters for packets, transactions, and signatures.
    - Initialize random number generator and configure random transaction corruption if enabled.
    - Initialize Wiredancer workspace and verify setup with `wd_init_pci` and `wd_ed25519_verify_init_req`.
    - Enter the main loop, signaling the start with `fd_cnc_signal`.
    - In each iteration, wait for a fragment sequence and perform housekeeping tasks if necessary.
    - Process received fragments by parsing Ethernet, IPv4, and UDP headers, and verify transaction signatures.
    - If transactions are valid, update diagnostic counters and publish results to output caches.
    - Handle both x86 and Wiredancer verification paths, updating sequences and diagnostics accordingly.
    - Check for overruns during processing and handle errors with `FD_LOG_ERR`.
    - Wind up for the next iteration by incrementing sequence numbers.
    - On exit, clean up resources, signal completion, and return 0.
- **Output**: Returns 0 upon successful completion of the function.


---
### v\_x86\_tile\_main<!-- {{#callable:v_x86_tile_main}} -->
[View Source →](<../../../../../src/wiredancer/test/test_wiredancer_demo.c#L522>)

Processes incoming transaction fragments, verifies signatures using either Ed25519 or SHA512ModQ, and publishes results to an output cache.
- **Inputs**:
    - `argc`: The number of arguments passed to the function, used to initialize `v_x86_idx`.
    - `argv`: An array of arguments, cast to a `test_cfg_t` structure pointer to access configuration settings.
- **Logic and Control Flow**:
    - Initialize `v_x86_idx` with `argc` and cast `argv` to `test_cfg_t` to access configuration.
    - Log the activation of the function using `FD_LOG_NOTICE`.
    - Retrieve the test version from the configuration to determine the verification method.
    - Connect to the command-and-control (CNC) and parser CNC using configuration settings.
    - Initialize diagnostic counters for transactions and signals.
    - Connect to the parser's metadata cache (`mcache`) and output cache (`out_mcache`) to manage data flow.
    - Initialize a random number generator with a seed from the configuration.
    - Enter the main loop, signaling the CNC to run and waiting for the parser to produce data.
    - In the loop, perform housekeeping by sending heartbeats and checking for halt signals.
    - Throttle processing based on the difference between parser and current sequence numbers.
    - Wait for and process incoming transaction fragments, checking for overruns.
    - Extract message, signature, and public key from the fragment using metadata offsets.
    - Verify the signature using the specified method (Ed25519 or SHA512ModQ) and publish the result to the output cache.
    - Increment sequence numbers and update diagnostic counters.
    - Check for overruns during processing and handle errors.
    - Signal the CNC to boot and clean up resources before returning.
- **Output**: Returns 0 upon successful completion.
- **Functions Called**:
    - [`sha512_modq_lsB`](<#sha512_modq_lsb>)


---
### vcheck\_tile\_main<!-- {{#callable:vcheck_tile_main}} -->
[View Source →](<../../../../../src/wiredancer/test/test_wiredancer_demo.c#L701>)

Executes a verification process comparing x86 and Wiredancer outputs, handling command and control signals, and managing diagnostic information.
- **Inputs**:
    - `argc`: The number of arguments passed to the function.
    - `argv`: An array of arguments, where the first argument is a pointer to a `test_cfg_t` structure containing configuration data.
- **Logic and Control Flow**:
    - Initialize variables and log the start of the function.
    - Connect to the command and control (CNC) interface using the configuration from `argv`.
    - Initialize diagnostic counters for CNC.
    - Check if x86 and Wiredancer producers are enabled using the configuration.
    - Set up connections to x86 and Wiredancer memory caches if they are enabled.
    - Initialize a random number generator with a seed from the configuration.
    - Initialize Wiredancer PCI and verification response.
    - Enter the main loop, signaling the CNC to run.
    - Poll x86 and Wiredancer caches for new data, handling overruns and command signals.
    - Extract and compare signature data from x86 and Wiredancer, updating diagnostic counters.
    - If both x86 and Wiredancer are enabled, compare their outputs and update validation counters.
    - Increment the expected signature for the next iteration.
    - On exit, free resources and signal the CNC to boot.
- **Output**: Returns 0 upon successful completion of the function.


---
### test\_sigaction<!-- {{#callable:test_sigaction}} -->
[View Source →](<../../../../../src/wiredancer/test/test_wiredancer_demo.c#L944>)

Handles a POSIX signal by logging the signal number and setting a halt flag.
- **Inputs**:
    - `sig`: The signal number received.
    - `info`: A pointer to a `siginfo_t` structure, which is not used in this function.
    - `context`: A pointer to a context, which is not used in this function.
- **Logic and Control Flow**:
    - Ignores the `info` and `context` parameters by casting them to void.
    - Logs a notice message indicating the receipt of a POSIX signal with the signal number.
    - Sets the global variable `test_halt` to 1UL to indicate a halt condition.
- **Output**: No return value; the function operates by side effects, specifically logging and setting a global variable.


---
### test\_signal\_trap<!-- {{#callable:test_signal_trap}} -->
[View Source →](<../../../../../src/wiredancer/test/test_wiredancer_demo.c#L954>)

Sets up a signal handler for a specified signal to execute a custom action when the signal is received.
- **Inputs**:
    - `sig`: The signal number for which the handler is being set.
- **Logic and Control Flow**:
    - Declare a `sigaction` structure `act` to hold the signal action configuration.
    - Assign the `test_sigaction` function to `act->sa_sigaction` to handle the signal.
    - Call `sigemptyset` to initialize the signal set in `act->sa_mask` to exclude all signals, logging an error if it fails.
    - Set `act->sa_flags` to `SA_SIGINFO | SA_RESETHAND` to receive additional signal information and reset the handler to default after handling the signal.
    - Call `sigaction` to set the action for the specified signal `sig`, logging an error if it fails.
- **Output**: No return value; the function sets up a signal handler.


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../../src/wiredancer/test/test_wiredancer_demo.c#L1309>)

Initializes the environment, logs a warning, and halts the program if certain capabilities are not present.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line arguments.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with `argc` and `argv`.
    - Logs a warning message indicating that the unit test requires specific capabilities (`FD_HAS_HOSTED`, `FD_HAS_X86`, and `FD_HAS_WIREDANCER`).
    - Calls `fd_halt` to terminate the program.
    - Returns 0 to indicate successful execution.
- **Output**: Returns an integer value 0, indicating successful execution.



---
Made with ❤️ by [Driver](https://www.driver.ai/)