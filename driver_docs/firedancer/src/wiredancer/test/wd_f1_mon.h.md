<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines a monitoring state structure and functions for thread management and TSC calibration.

# Purpose
The code is a C header file that defines a monitoring structure and functionality for a system related to the `wiredancer` project. It includes necessary headers for system-level operations and defines a structure `wd_mon_state_t` that holds various counters and state information for monitoring purposes. These counters include received and sent message counts, replay and parser rates, and signal pass/fail counts, among others. The structure also includes a workspace object `wd_wksp_t` from the `wd_f1` module, indicating integration with other components of the `wiredancer` system.

Additionally, the file declares a function [`mon_thread`](<#mon_thread>), which is intended to be used as a thread function, likely for monitoring operations in a concurrent environment. It also provides a static inline function [`get_tsc_ticks_ns`](<#get_tsc_ticks_ns>) that performs a simple calibration of the Time Stamp Counter (TSC) to measure the number of ticks per nanosecond. This function uses the `clock_gettime` function to measure elapsed time and a loop to create a computational workload, allowing the calculation of TSC frequency. The header file is designed to be included in other C source files that require these monitoring capabilities and TSC calibration functionality.
# Imports and Dependencies

---
- `stdint.h`
- `string.h`
- `stdio.h`
- `stdlib.h`
- `sys/mman.h`
- `time.h`
- `signal.h`
- `unistd.h`
- `pthread.h`
- `../c/wd_f1.h`
- `../../util/fd_util_base.h`


# Data Structures

---
### wd\_mon\_state\_t
- **Type**: ``struct``
- **Members**:
    - `recv_cnt`: An array of two `uint64_t` values that likely track received counts.
    - `send_cnt`: A `uint64_t` value that tracks the count of sent items.
    - `cnt_replay`: A `uint64_t` value that tracks the count of replay events.
    - `cnt_parser`: A `uint64_t` value that tracks the count of parser events.
    - `cnt_x86`: A `uint64_t` value that tracks the count of x86 events.
    - `cnt__wd`: A `uint64_t` value that tracks the count of wd events.
    - `rate_replay`: A `uint64_t` value that tracks the rate of replay events.
    - `rate_parser`: A `uint64_t` value that tracks the rate of parser events.
    - `rate_x86`: A `uint64_t` value that tracks the rate of x86 events.
    - `rate__wd`: A `uint64_t` value that tracks the rate of wd events.
    - `sig_pass`: A `uint64_t` value that tracks the count of successful signals.
    - `sig_fail`: A `uint64_t` value that tracks the count of failed signals.
    - `cnt_checked`: A `uint64_t` value that tracks the count of checked items.
    - `running`: A `uint32_t` value that indicates if the system is running.
    - `running_recv`: A `uint32_t` value that indicates if the receiving process is running.
    - `slot`: A `uint32_t` value that likely represents a slot identifier.
    - `wd`: A `wd_wksp_t` type that represents a workspace or context.
- **Description**: The `wd_mon_state_t` structure is used to monitor various counts and rates related to events and signals in a system, including received and sent counts, replay and parser events, and signal success and failure. It also includes indicators for running states and a workspace context.


# Functions

---
### get\_tsc\_ticks\_ns<!-- {{#callable:get_tsc_ticks_ns}} -->
[View Source →](<../../../../../src/wiredancer/test/wd_f1_mon.h#L42>)

Calculates the number of TSC (Time Stamp Counter) ticks per nanosecond by measuring the time taken for a loop to execute.
- **Inputs**: None
- **Logic and Control Flow**:
    - Initialize `ts_start`, `ts_end`, `rdtsc_start`, `rdtsc_end`, and `i` variables.
    - Call `clock_gettime` with `CLOCK_MONOTONIC` to get the start time and store it in `ts_start`.
    - Call `fd_tickcount` to get the starting TSC value and store it in `rdtsc_start`.
    - Execute a loop 100,000,000 times to simulate a compute-intensive task.
    - Call `fd_tickcount` again to get the ending TSC value and store it in `rdtsc_end`.
    - Call `clock_gettime` with `CLOCK_MONOTONIC` to get the end time and store it in `ts_end`.
    - Calculate the difference between `ts_end` and `ts_start` to get the elapsed time in `ts_diff`.
    - Adjust `ts_diff` if `ts_diff.tv_nsec` is negative by decrementing `ts_diff.tv_sec` and adding 1,000,000,000 to `ts_diff.tv_nsec`.
    - Convert the elapsed time in `ts_diff` to nanoseconds and store it in `ns`.
    - Return the ratio of the difference in TSC values to the elapsed time in nanoseconds as a `double`.
- **Output**: Returns a `double` representing the number of TSC ticks per nanosecond.


# Function Declarations (Public API)

---
### mon\_thread<!-- {{#callable_declaration:mon_thread}} -->
[View Source →](<../../../../../src/wiredancer/test/wd_f1_mon.h#L38>)

Executes a monitoring thread for hardware counters.
- **Description**: Use this function to start a monitoring thread that periodically reads and processes hardware counters. It must be called with a valid pointer to a `wd_mon_state_t` structure, which contains the state information for the monitoring process. The function runs in a loop, updating and displaying counter data until the `running` flag in the state structure is cleared. Ensure that the `wd_mon_state_t` structure is properly initialized and that the `running` flag is set before calling this function. The function is designed to be used in a multithreaded environment and will return when the monitoring is complete.
- **Inputs**:
    - `arg`: A pointer to a `wd_mon_state_t` structure. This structure must be initialized and must not be null. The caller retains ownership of the structure. The function will read from and modify this structure during execution.
- **Output**: Returns a null pointer when the monitoring thread completes.
- **See Also**: [`mon_thread`](<wd_f1_mon.c.md#mon_thread>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)