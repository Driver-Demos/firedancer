<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements functions for replaying pcap file streams with flow control and diagnostic logging.

# Purpose
The code is a C source file that implements functionality for replaying packet capture (pcap) files in a controlled environment. It is designed to work on systems with hosted environments and x86 architecture, as indicated by the preprocessor directives. The file includes functions [`fd_replay_tile`](<#fd_replay_tile>) and [`fd_replay_tile_loop`](<#fd_replay_tile_loop>), which are responsible for reading packets from a pcap file and publishing them to a memory cache (`mcache`) for further processing. The code handles flow control, diagnostics, and synchronization with a command-and-control (CNC) system to manage the replay process.

The primary components of the code include initialization of CNC state, pcap stream handling, output fragment stream management, and flow control configuration. The functions use various utility functions and macros to manage memory alignment, flow control credits, and diagnostic information. The code also includes mechanisms for handling backpressure and performing housekeeping tasks at regular intervals. The functions are designed to be part of a larger system, likely involving network packet processing, where replaying pcap files is necessary for testing or simulation purposes.
# Imports and Dependencies

---
- `fd_replay_loop.h`
- `../../util/net/fd_pcap.h`
- `stdio.h`
- `errno.h`
- `unistd.h`


# Functions

---
### fd\_replay\_tile\_scratch\_align<!-- {{#callable:fd_replay_tile_scratch_align}} -->
[View Source →](<../../../../../src/wiredancer/test/fd_replay_loop.c#L12>)

Returns the alignment requirement for the replay tile scratch memory.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the value of the macro `FD_REPLAY_TILE_SCRATCH_ALIGN`.
- **Output**: The function returns an `ulong` representing the alignment requirement for the replay tile scratch memory.


---
### fd\_replay\_tile\_scratch\_footprint<!-- {{#callable:fd_replay_tile_scratch_footprint}} -->
[View Source →](<../../../../../src/wiredancer/test/fd_replay_loop.c#L17>)

Calculates the memory footprint required for a replay tile scratch space based on the number of output streams.
- **Inputs**:
    - `out_cnt`: The number of output streams for which the scratch space footprint is calculated.
- **Logic and Control Flow**:
    - Checks if `out_cnt` exceeds `FD_REPLAY_TILE_OUT_MAX`; if true, returns 0.
    - Initializes `l` with `FD_LAYOUT_INIT`.
    - Appends the alignment and footprint of the flow control (`fctl`) to `l` using `FD_LAYOUT_APPEND`.
    - Finalizes the layout with `FD_LAYOUT_FINI` using the alignment from [`fd_replay_tile_scratch_align`](<#fd_replay_tile_scratch_align>) and returns the result.
- **Output**: Returns the calculated memory footprint as an unsigned long integer, or 0 if `out_cnt` is too large.
- **Functions Called**:
    - [`fd_replay_tile_scratch_align`](<#fd_replay_tile_scratch_align>)


---
### fd\_replay\_tile<!-- {{#callable:fd_replay_tile}} -->
[View Source →](<../../../../../src/wiredancer/test/fd_replay_loop.c#L25>)

Replays packets from a pcap file stream into a memory cache with flow control and diagnostics.
- **Inputs**:
    - `cnc`: A pointer to the command-and-control structure for managing the replay tile's state and diagnostics.
    - `pcap_path`: A constant character pointer to the path of the pcap file to be replayed.
    - `pkt_max`: The maximum packet size to be processed from the pcap file.
    - `orig`: The origin identifier for the packet metadata.
    - `mcache`: A pointer to the memory cache where packet metadata will be published.
    - `dcache`: A pointer to the data cache where packet data will be stored.
    - `out_cnt`: The number of output sequences for flow control.
    - `out_fseq`: A pointer to an array of pointers to output sequence numbers for flow control.
    - `cr_max`: The maximum number of flow control credits available.
    - `lazy`: The lazy parameter for configuring housekeeping frequency.
    - `rng`: A pointer to a random number generator used for timing.
    - `scratch`: A pointer to a scratch space used for temporary allocations.
- **Logic and Control Flow**:
    - Initialize diagnostic and state variables for command-and-control, pcap stream, and output fragment stream.
    - Check and log configuration parameters, ensuring they are valid and aligned.
    - Open the pcap file and initialize an iterator for reading packets.
    - Initialize the memory cache and data cache for storing packet metadata and data.
    - Set up flow control using the provided output sequences and configure flow control parameters.
    - Enter a loop to replay packets, checking for command-and-control signals and flow control credits.
    - Perform housekeeping tasks periodically, updating synchronization and diagnostic information.
    - Read packets from the pcap file, apply filtering logic, and publish valid packets to the memory cache.
    - Handle backpressure by waiting for flow control credits before continuing to process packets.
    - On receiving a halt signal, clean up resources, close the pcap file, and signal the end of the replay.
- **Output**: Returns 0 on successful completion or 1 if an error occurs during initialization or execution.
- **Functions Called**:
    - [`fd_replay_tile_scratch_align`](<#fd_replay_tile_scratch_align>)


---
### fd\_replay\_tile\_loop<!-- {{#callable:fd_replay_tile_loop}} -->
[View Source →](<../../../../../src/wiredancer/test/fd_replay_loop.c#L325>)

Replays packets from a pcap file stream, managing flow control and diagnostics, and publishes them to a specified output.
- **Inputs**:
    - `cnc`: A pointer to `fd_cnc_t`, used for command-and-control signaling and diagnostics.
    - `pcap_path`: A constant character pointer to the path of the pcap file to be replayed.
    - `pkt_max`: An unsigned long specifying the maximum packet size to process.
    - `orig`: An unsigned long representing the origin identifier for the packets.
    - `mcache`: A pointer to `fd_frag_meta_t`, used for metadata caching of the replayed packets.
    - `dcache`: A pointer to an unsigned char array, used for data caching of the replayed packets.
    - `out_cnt`: An unsigned long indicating the number of output sequences.
    - `out_fseq`: A pointer to an array of unsigned long pointers, representing the output flow sequence numbers.
    - `cr_max`: An unsigned long specifying the maximum flow control credits available.
    - `lazy`: A long integer that determines the laziness of housekeeping operations.
    - `rng`: A pointer to `fd_rng_t`, used for random number generation in timing operations.
    - `scratch`: A void pointer to a scratch space used for temporary allocations.
- **Logic and Control Flow**:
    - Initialize diagnostic and state variables for command-and-control, pcap stream, output fragment stream, flow control, and housekeeping.
    - Check and log initial conditions, such as `out_cnt`, `scratch` alignment, and `cnc` state.
    - Open the pcap file and initialize the pcap iterator.
    - Initialize output fragment stream state, including sequence number and data cache chunk management.
    - Configure flow control using `fd_fctl_t` and validate output sequences.
    - Set up housekeeping parameters based on `lazy` value and start the replay loop.
    - In the loop, perform housekeeping tasks, update diagnostics, and handle command-and-control signals.
    - Check for backpressure and wait for flow control credits if necessary.
    - Load packets from the pcap file into the data cache, applying any filtering logic.
    - Publish packet metadata to the metadata cache and update sequence numbers and diagnostics.
    - On receiving a halt signal, clean up resources, close the pcap file, and reset the command-and-control signal.
- **Output**: Returns 0 on successful completion or 1 on encountering an error.
- **Functions Called**:
    - [`fd_replay_tile_scratch_align`](<#fd_replay_tile_scratch_align>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)