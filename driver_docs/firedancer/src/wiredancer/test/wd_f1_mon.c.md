<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Monitors and displays performance metrics for AWS-F1 FPGA and x86 systems using ASCII charts.

# Purpose
The code is a C program that appears to be part of a monitoring system for an AWS-F1 FPGA setup. It includes functionality for reading and displaying performance counters related to data processing and communication between an FPGA and an x86 system. The program uses several system libraries such as `string.h`, `stdio.h`, `stdlib.h`, and others for memory management, input/output operations, and threading. It defines a `state_t` structure to maintain the state of the monitoring process, including counters for received and sent data, and a pointer to a workspace structure `wd_wksp_t`.

The program includes functions for timing ([`tiff`](<#tiff>)), printing counters ([`print_counters`](<#print_counters>)), handling interrupts ([`intHandler`](<#inthandler>)), and managing ASCII-based visual output ([`ascii_move_to`](<#ascii_move_to>), [`ascii_color`](<#ascii_color>)). The [`mon_thread`](<#mon_thread>) function is a key component that runs in a separate thread to periodically read hardware counters, calculate data rates, and update a visual ASCII chart with the current state of the system. The code uses a combination of hardware counter snapshots and software calculations to provide real-time monitoring of data flow and processing rates, which are displayed in a formatted ASCII chart. The program is designed to be part of a larger system, as indicated by the inclusion of an external function [`_wd_read_32`](<#_wd_read_32>) and the use of a custom header file `wd_f1_mon.h`.
# Imports and Dependencies

---
- `string.h`
- `stdio.h`
- `stdlib.h`
- `sys/mman.h`
- `time.h`
- `signal.h`
- `unistd.h`
- `pthread.h`
- `wd_f1_mon.h`


# Global Variables

---
### keepRunning
- **Type**: ``int``
- **Description**: A static volatile integer variable that controls the execution of a loop or process. It is initialized to 1, indicating that the process should continue running.
- **Use**: Used to determine whether a loop or process should continue running or terminate.


---
### \_state\_p
- **Type**: ``state_t*``
- **Description**: A pointer to a `state_t` structure, which contains various counters and state information for a system. The structure includes fields for receive and send counters, running states, a slot identifier, and a workspace of type `wd_wksp_t`. This pointer is used to access and modify the state information throughout the program.
- **Use**: Used to access and modify the state information of the system, including counters and running states, in various functions.


---
### ascii\_chart
- **Type**: `char*[]`
- **Description**: An array of strings that visually represents a diagram of the AWS-F1 FPGA and AWS-F1 x86 architecture. The diagram includes components such as 'Scheduler', 'SHA-MOD', 'Parser', 'Sigverify', and 'Reorder', and shows their interconnections.
- **Use**: Used to display a visual ASCII representation of the AWS-F1 architecture in the console.


---
### cnt\_data
- **Type**: ``uint32_t``
- **Description**: `cnt_data` is a two-dimensional array of unsigned 32-bit integers. Each row in the array represents a set of parameters for a specific counter, including its position on a display (`line` and `col`), type (`cnt_type`), color (`cnt_color`), print width (`print_width`), hardware counter index (`hw_cnt_idx`), and PCIe slot (`pcie_slot`). The array ends with a row of zeros as an end marker.
- **Use**: Stores configuration data for various counters used in monitoring and displaying system performance metrics.


# Data Structures

---
### state\_t
- **Type**: ``struct``
- **Members**:
    - ``recv_cnt``: An array of two `uint64_t` elements to store the receive counters.
    - ``send_cnt``: A `uint64_t` variable to store the send counter.
    - ``running``: A `uint32_t` variable to indicate if the process is running.
    - ``running_recv``: A `uint32_t` variable to indicate if the receive process is running.
    - ``slot``: A `uint32_t` variable to store the slot number.
    - ``wd``: A `wd_wksp_t` type variable to store workspace data.
- **Description**: The `state_t` structure is used to maintain the state of a process, including counters for received and sent data, flags to indicate running status, and a workspace for additional data management.


# Functions

---
### tiff<!-- {{#callable:tiff}} -->
[View Source →](<../../../../../src/wiredancer/test/wd_f1_mon.c#L43>)

Calculates the time difference in seconds between two `timespec` structures.
- **Inputs**:
    - `t0`: A `timespec` structure representing the start time.
    - `t1`: A `timespec` structure representing the end time.
- **Logic and Control Flow**:
    - Calculate the difference in seconds between `t1` and `t0` by subtracting `t0.tv_sec` from `t1.tv_sec` and store it in `seconds`.
    - Calculate the difference in nanoseconds between `t1` and `t0` by subtracting `t0.tv_nsec` from `t1.tv_nsec` and store it in `nanoseconds`.
    - Convert `seconds` to a double and `nanoseconds` to a double, then multiply `nanoseconds` by `1e-9` to convert it to seconds.
    - Return the sum of the converted `seconds` and `nanoseconds` as a double.
- **Output**: Returns the time difference as a double representing seconds.


---
### print\_counters<!-- {{#callable:print_counters}} -->
[View Source →](<../../../../../src/wiredancer/test/wd_f1_mon.c#L50>)

Prints the values of 16 counters from a given workspace.
- **Inputs**:
    - `wd`: A pointer to a `wd_wksp_t` structure representing the workspace from which to read the counters.
- **Logic and Control Flow**:
    - Iterates over a loop 16 times, corresponding to the number of counters.
    - For each iteration, calls `wd_rd_cntr` to read the counter value at the current index from the workspace.
    - Formats and prints the counter index and its value using `wd_zprintf`.
- **Output**: No return value; outputs formatted counter values to the standard output.


---
### intHandler<!-- {{#callable:intHandler}} -->
[View Source →](<../../../../../src/wiredancer/test/wd_f1_mon.c#L55>)

Handles an interrupt signal by printing counters and stopping the running state.
- **Inputs**:
    - `dummy`: An integer parameter that is not used in the function body.
- **Logic and Control Flow**:
    - Ignores the input parameter `dummy` by casting it to void.
    - Calls the [`print_counters`](<#print_counters>) function with the address of `_state_p->wd` to print hardware counters.
    - Sets the global variable `keepRunning` to 0 to indicate that the process should stop running.
    - Sets the `_state_p->running` state to 0 to indicate that the process is no longer running.
- **Output**: No return value as the function is of type `void`.
- **Functions Called**:
    - [`print_counters`](<#print_counters>)


---
### ascii\_move\_to<!-- {{#callable:ascii_move_to}} -->
[View Source →](<../../../../../src/wiredancer/test/wd_f1_mon.c#L166>)

Moves the cursor from a starting position to a target position using ANSI escape codes.
- **Inputs**:
    - `from`: An array of two `uint32_t` values representing the starting row and column positions.
    - `to`: An array of two `uint32_t` values representing the target row and column positions.
- **Logic and Control Flow**:
    - Check if the starting row (`from[0]`) is less than the target row (`to[0]`); if true, move the cursor down by the difference using the escape code `\033[%dB`.
    - If the starting row is greater than the target row, move the cursor up by the difference using the escape code `\033[%dA`.
    - Check if the starting column (`from[1]`) is less than the target column (`to[1]`); if true, move the cursor right by the difference using the escape code `\033[%dC`.
    - If the starting column is greater than the target column, move the cursor left by the difference using the escape code `\033[%dD`.
- **Output**: No return value; the function directly manipulates the cursor position on the terminal.


---
### ascii\_color<!-- {{#callable:ascii_color}} -->
[View Source →](<../../../../../src/wiredancer/test/wd_f1_mon.c#L180>)

Sets the terminal text color based on the input color code.
- **Inputs**:
    - `col`: A `uint32_t` representing the color code to set the terminal text color.
- **Logic and Control Flow**:
    - Uses a `switch` statement to determine the action based on the value of `col`.
    - If `col` is 0, it resets the text color to default using the escape code `\033[0m`.
    - If `col` is 1, it sets the text color to green using the escape code `\033[32m`.
    - If `col` is 2, it sets the text color to yellow using the escape code `\033[33m`.
    - If `col` is 3, it sets the text color to red using the escape code `\033[31m`.
    - If `col` is 4, it sets the text color to magenta using the escape code `\033[35m`.
- **Output**: No return value; the function directly affects the terminal output by changing the text color.


---
### pretty\_num<!-- {{#callable:pretty_num}} -->
[View Source →](<../../../../../src/wiredancer/test/wd_f1_mon.c#L201>)

Formats a numeric count into a human-readable string with appropriate suffixes and returns a selection index based on the magnitude of the count.
- **Inputs**:
    - `st`: A pointer to a character array where the formatted string will be stored.
    - `cnt`: A 64-bit unsigned integer representing the count to format.
    - `suffix`: A pointer to a character string that will be appended to the formatted count.
- **Logic and Control Flow**:
    - Initialize `sel` to 0.
    - If `cnt` is 0, set `sel` to 0 and format `st` as "<0> " followed by `suffix`.
    - If `cnt` is less than `THOUSAND`, set `sel` to 0 and format `st` as the count followed by `suffix`.
    - If `cnt` is less than `MILLION`, set `sel` to 0 and format `st` as the count in thousands (K) followed by `suffix`.
    - If `cnt` is less than `TENMILLION`, set `sel` to 1 and format `st` as the count in millions (M) with one decimal place followed by `suffix`.
    - If `cnt` is less than `BILLION`, set `sel` to 2 and format `st` as the count in millions (M) followed by `suffix`.
    - If `cnt` is less than `TENBILLION`, set `sel` to 3 and format `st` as the count in billions (G) with one decimal place followed by `suffix`.
    - Otherwise, set `sel` to 4 and format `st` as the count in billions (G) followed by `suffix`.
    - Return the value of `sel`.
- **Output**: An integer `sel` indicating the magnitude category of the count: 0 for less than a million, 1 for less than ten million, 2 for less than a billion, 3 for less than ten billion, and 4 for ten billion or more.


---
### mon\_thread<!-- {{#callable:mon_thread}} -->
[View Source →](<../../../../../src/wiredancer/test/wd_f1_mon.c#L242>)

Monitors hardware counters and updates a visual ASCII chart with performance metrics.
- **Inputs**:
    - `arg`: A pointer to a `wd_mon_state_t` structure that contains the state of the monitoring process.
- **Logic and Control Flow**:
    - Initialize local variables including counters, state, and timing variables.
    - Enter a loop that continues while `state->running` is true and `state->running_recv` is false.
    - Sleep for a specified interval (`millis` milliseconds) to control the monitoring frequency.
    - Calculate the time elapsed since the last cycle and update `millis_inv` based on this elapsed time.
    - If not the first iteration, reset the cursor position using [`ascii_move_to`](<#ascii_move_to>).
    - Capture snapshots of hardware counters using `wd_snp_cntrs`.
    - Read and update counter values from the hardware and state structure, storing them in `cnts`.
    - Calculate the difference (delta) between current and previous counter values.
    - Format the counter values into strings with appropriate units and colors using [`pretty_num`](<#pretty_num>).
    - Update the `cnt_data` array with the formatted counter strings and their display properties.
    - Iterate over the `ascii_chart` to print the updated chart, inserting counter values at specified positions.
    - Flush the output buffer to ensure all data is printed to the console.
- **Output**: Returns a null pointer (`0`) upon completion.
- **Functions Called**:
    - [`get_tsc_ticks_ns`](<wd_f1_mon.h.md#get_tsc_ticks_ns>)
    - [`ascii_move_to`](<#ascii_move_to>)
    - [`pretty_num`](<#pretty_num>)
    - [`ascii_color`](<#ascii_color>)


# Function Declarations (Public API)

---
### \_wd\_read\_32<!-- {{#callable_declaration:_wd_read_32}} -->
[View Source →](<../../../../../src/wiredancer/test/wd_f1_mon.c#L18>)

Reads a 32-bit value from a specified address on an FPGA device.
- **Description**: Use this function to read a 32-bit value from a specific address on an FPGA device through a PCI interface. It requires a valid `wd_pci_t` structure that represents the PCI device and an address from which to read. The function returns the value read from the specified address. If the read operation fails, an error is logged, but the function still returns a value, which may be undefined in case of an error. Ensure that the PCI device is properly initialized before calling this function.
- **Inputs**:
    - `pci`: A pointer to a `wd_pci_t` structure representing the PCI device. Must not be null. The caller retains ownership.
    - `addr`: A 32-bit unsigned integer representing the address to read from. Must be a valid address within the device's address space.
- **Output**: Returns the 32-bit value read from the specified address. The value may be undefined if an error occurs during the read operation.
- **See Also**: [`_wd_read_32`](<../c/wd_f1.c.md#_wd_read_32>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)