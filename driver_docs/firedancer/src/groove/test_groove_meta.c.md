<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for concurrent operations and memory management in the `fd_groove_meta_map` component.

# Purpose
The code is a C program designed to test the functionality and performance of a concurrent data structure, specifically a "groove meta map." It includes a main function that initializes the environment, sets up parameters for the test, and manages the lifecycle of the groove meta map. The program uses shared memory for allocation and performs various operations on the map, such as insertions, removals, modifications, and queries, to simulate concurrent access by multiple threads or "tiles." The operations are executed in a loop to stress-test the map under different conditions, ensuring its correctness and efficiency.

The program defines several static variables and functions to manage shared memory and execute the main testing logic. The [`shmem_alloc`](<#shmem_alloc>) function is used to allocate memory from a pre-defined shared memory buffer. The [`tile_main`](<#tile_main>) function is the core of the test, performing a series of operations on the groove meta map, including handling concurrent operations and verifying the map's state. The program also includes mechanisms to log progress and results, ensuring that the map behaves as expected under concurrent access. The use of random number generation and various flags allows the program to simulate different scenarios and test the robustness of the groove meta map implementation.
# Imports and Dependencies

---
- `fd_groove.h`


# Global Variables

---
### shmem
- **Type**: ``uchar[]``
- **Description**: An array of unsigned characters with a maximum size defined by `SHMEM_MAX`, which is set to 1 megabyte (1UL<<20).
- **Use**: Used as a shared memory buffer for dynamic memory allocation within the program.


---
### shmem\_cnt
- **Type**: ``ulong``
- **Description**: A static global variable of type `ulong` that is initialized to 0UL. It is used to track the current offset in the shared memory array `shmem`.
- **Use**: Tracks the current offset in the shared memory array `shmem` for memory allocation purposes.


---
### tile\_map
- **Type**: ``fd_groove_meta_map_t *``
- **Description**: Points to a `fd_groove_meta_map_t` structure, which is used to manage a map of metadata elements in a shared memory context. This map is used to perform various operations such as insert, remove, modify, and query on metadata elements.
- **Use**: Used as a global pointer to access and manipulate the metadata map throughout the program.


---
### tile\_iter\_cnt
- **Type**: ``ulong``
- **Description**: Stores the number of iterations to perform in the `tile_main` function. It is a static variable, meaning it is limited to the file scope and retains its value between function calls.
- **Use**: Used to control the number of iterations for concurrent operations in the `tile_main` function.


---
### tile\_go
- **Type**: ``ulong``
- **Description**: A static global variable of type `ulong` that is used as a flag to control the execution flow in a concurrent environment. It is initialized to zero and is set to one to signal the start of operations in the `tile_main` function.
- **Use**: Used to synchronize the start of concurrent operations across multiple tiles by being checked in a loop until it is set to one.


# Functions

---
### shmem\_alloc<!-- {{#callable:shmem_alloc}} -->
[View Source →](<../../../../src/groove/test_groove_meta.c#L8>)

Allocates a block of memory from a shared memory pool with specified alignment and size.
- **Inputs**:
    - `a`: The alignment requirement for the memory block.
    - `s`: The size of the memory block to allocate.
- **Logic and Control Flow**:
    - Aligns the current position in the shared memory pool `shmem` to the specified alignment `a` using `fd_ulong_align_up` function.
    - Calculates the new position in the shared memory pool by adding the size `s` to the aligned position.
    - Updates the global counter `shmem_cnt` to reflect the new position in the shared memory pool.
    - Checks if the updated `shmem_cnt` does not exceed the maximum allowed size `SHMEM_MAX` using `FD_TEST`.
    - Returns a pointer to the allocated memory block.
- **Output**: A pointer to the allocated memory block in the shared memory pool.


---
### tile\_main<!-- {{#callable:tile_main}} -->
[View Source →](<../../../../src/groove/test_groove_meta.c#L21>)

Executes concurrent operations on a shared memory map using multiple tiles, simulating various map operations like insert, remove, modify, and query.
- **Inputs**:
    - `argc`: The number of command-line arguments, used to determine the tile index.
    - `argv`: The command-line arguments, used to determine the number of tiles.
- **Logic and Control Flow**:
    - Initialize local variables and context for the tile, including map, iteration count, and random number generator.
    - Wait for a signal to start operations by checking the `tile_go` variable.
    - Perform a loop for a specified number of iterations (`iter_cnt`), executing random operations on the map.
    - Select an operation type based on a random number and execute the corresponding case in the switch statement.
    - Each case in the switch statement performs a specific map operation (e.g., insert, remove, modify, query) with error handling and validation checks.
    - After completing the iterations, clean up by removing all keys from the map and restoring shared memory state.
    - Delete the random number generator and return 0 to indicate successful execution.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`shmem_alloc`](<#shmem_alloc>)
    - [`fd_groove_key_eq`](<fd_groove_base.h.md#fd_groove_key_eq>)
    - [`fd_groove_meta_bits_used`](<fd_groove_meta.h.md#fd_groove_meta_bits_used>)
    - [`fd_groove_key_init_ulong`](<fd_groove_base.h.md#fd_groove_key_init_ulong>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../src/groove/test_groove_meta.c#L433>)

Initializes and tests a concurrent groove meta map using command-line parameters and random operations.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Extracts command-line parameters for `ele_max`, `lock_cnt`, `probe_max`, `seed`, and `iter_cnt` using `fd_env_strip_cmdline_ulong`.
    - Logs the testing parameters using `FD_LOG_NOTICE`.
    - Initializes a random number generator `rng` with `fd_rng_new` and `fd_rng_join`.
    - Performs 100,000,000 iterations of random bit manipulation and validation using `fd_groove_meta_bits_*` functions.
    - Allocates and initializes shared memory for groove meta store and map using [`shmem_alloc`](<#shmem_alloc>) and `memset`.
    - Calculates alignment and footprint for the groove meta map and allocates memory for it.
    - Creates a new groove meta map with `fd_groove_meta_map_new` and joins it with `fd_groove_meta_map_join`.
    - Sets global variables `tile_map` and `tile_iter_cnt` for concurrent operations.
    - Iterates over the number of tiles, performing concurrent operations using `fd_tile_exec_new` and [`tile_main`](<#tile_main>).
    - Verifies the groove meta map after concurrent operations using `fd_groove_meta_map_verify`.
    - Leaves and deletes the groove meta map using `fd_groove_meta_map_leave` and `fd_groove_meta_map_delete`.
    - Deletes the random number generator with `fd_rng_delete` and `fd_rng_leave`.
    - Logs the completion of the test and halts the program with `fd_halt`.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`fd_groove_meta_bits_used`](<fd_groove_meta.h.md#fd_groove_meta_bits_used>)
    - [`fd_groove_meta_bits_cold`](<fd_groove_meta.h.md#fd_groove_meta_bits_cold>)
    - [`fd_groove_meta_bits_hot`](<fd_groove_meta.h.md#fd_groove_meta_bits_hot>)
    - [`fd_groove_meta_bits_val_sz`](<fd_groove_meta.h.md#fd_groove_meta_bits_val_sz>)
    - [`fd_groove_meta_bits_val_max`](<fd_groove_meta.h.md#fd_groove_meta_bits_val_max>)
    - [`fd_groove_meta_bits`](<fd_groove_meta.h.md#fd_groove_meta_bits>)
    - [`shmem_alloc`](<#shmem_alloc>)
    - [`main::FD_VOLATILE`](<#mainfd_volatile>)
    - [`tile_main`](<#tile_main>)


---
### FD\_VOLATILE<!-- {{#callable:main::FD_VOLATILE}} -->
[View Source →](<../../../../src/groove/test_groove_meta.c#L498>)

Sets the `tile_go` variable to 0 and enforces a memory fence to ensure memory ordering.
- **Inputs**:
    - `tile_go`: A variable that is set to 0, likely used as a control flag for synchronization.
- **Logic and Control Flow**:
    - Set `tile_go` to 0, indicating a reset or stop condition.
    - Call `FD_COMPILER_MFENCE()` to enforce a memory fence, ensuring that all previous memory operations are completed before any subsequent operations.
- **Output**: No output is returned as this is a macro operation affecting memory state.



---
Made with ❤️ by [Driver](https://www.driver.ai/)