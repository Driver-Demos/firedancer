<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Tests for the `fd_groove_data` module, including memory allocation, volume management, and data integrity.

# Purpose
The code is a C program that tests the functionality of a memory management system using a concept called "groove data." It includes static assertions to verify the correctness of various constants and configurations related to memory alignment, footprint, and types. The program defines a shared memory space and provides functions to allocate and manage memory blocks within this space. It uses a test suite to validate the allocation, deallocation, and integrity of memory blocks, ensuring that they adhere to specified alignment and size constraints.

The program is structured to run in a multi-threaded environment, where it manages memory allocations across different threads using locks and atomic operations. It includes a main function that initializes the environment, sets up shared memory, and executes tests on memory allocation and deallocation. The code also handles error cases and logs notices for various operations, providing a comprehensive test of the groove data memory management system. The program is designed to be executed as a standalone application, with the main function serving as the entry point.
# Imports and Dependencies

---
- `fd_groove.h`


# Global Variables

---
### shmem
- **Type**: ``uchar[]``
- **Description**: An array of unsigned characters with a size defined by `SHMEM_MAX`, which is set to 1 megabyte (1UL<<20).
- **Use**: Stores shared memory data for allocation and management within the program.


---
### shmem\_cnt
- **Type**: ``ulong``
- **Description**: A static global variable of type `ulong` initialized to 0UL. It is used to track the current offset in the shared memory array `shmem`.
- **Use**: Tracks the current offset in the `shmem` array for memory allocation purposes.


---
### volume\_avail\_pmap
- **Type**: ``ulong``
- **Description**: `volume_avail_pmap` is a static global variable of type `ulong` initialized to 0UL. It is used to track the availability of volumes in a bitmap format, where each bit represents the availability of a corresponding volume.
- **Use**: Used to manage and track available volumes in a thread-safe manner during volume allocation and deallocation operations.


---
### test\_slot
- **Type**: ``struct``
- **Description**: `test_slot` is an array of structures, each aligned to 128 bytes, containing fields for managing memory allocations. Each structure in the array includes a lock, a pointer to memory, alignment, size, tag, and a pattern for memory validation.
- **Use**: Used to manage and validate memory allocations in a multi-threaded environment, with each slot in the array representing a potential memory allocation.


---
### \_go
- **Type**: ``int``
- **Description**: A global integer variable initialized to 0.
- **Use**: Used as a flag to control the start of operations across multiple threads.


---
### \_shdata
- **Type**: `void *`
- **Description**: Points to shared data memory used in the program.
- **Use**: Used to store a pointer to shared data memory for operations involving groove data.


---
### \_volume
- **Type**: `void *`
- **Description**: A global pointer variable initialized to `NULL`.
- **Use**: Used to store a reference to a memory volume for groove data operations.


---
### \_volume\_cnt
- **Type**: ``ulong``
- **Description**: Stores the count of volumes in the system. It is initialized to zero and can be modified during the program execution.
- **Use**: Tracks the number of volumes available or used in the system.


---
### \_alloc\_cnt
- **Type**: `ulong`
- **Description**: A global variable that is initialized to zero and used to store the count of allocations.
- **Use**: Tracks the number of memory allocations performed.


---
### \_sz\_max
- **Type**: ``ulong``
- **Description**: A global variable of type `ulong` initialized to `0UL`.
- **Use**: Stores the maximum size for allocations in the test.


# Functions

---
### shmem\_alloc<!-- {{#callable:shmem_alloc}} -->
[View Source →](<../../../../src/groove/test_groove_data.c#L26>)

Allocates a block of memory from a shared memory pool with specified alignment and size.
- **Inputs**:
    - `a`: The alignment requirement for the memory block, specified as an unsigned long integer.
    - `s`: The size of the memory block to allocate, specified as an unsigned long integer.
- **Logic and Control Flow**:
    - Aligns the current position in the shared memory pool `shmem` to the specified alignment `a` using `fd_ulong_align_up`.
    - Calculates the new position in the shared memory pool by adding the size `s` to the aligned position `m`.
    - Updates the shared memory counter `shmem_cnt` to reflect the new position in the memory pool.
    - Checks if the updated `shmem_cnt` exceeds the maximum allowed size `SHMEM_MAX` using `FD_TEST`.
    - Returns the aligned memory address `m` cast to a `void *`.
- **Output**: Returns a pointer to the allocated memory block, cast to `void *`.


---
### grow\_data<!-- {{#callable:grow_data}} -->
[View Source →](<../../../../src/groove/test_groove_data.c#L37>)

Adds a randomly selected available volume to the groove data structure.
- **Inputs**:
    - ``data``: A pointer to the `fd_groove_data_t` structure representing the groove data.
    - ``rng``: A pointer to the `fd_rng_t` structure used for generating random numbers.
- **Logic and Control Flow**:
    - Retrieve the base pointer to the first volume using [`fd_groove_data_volume0`](<fd_groove_data.h.md#fd_groove_data_volume0>) and the maximum number of volumes using [`fd_groove_data_volume_max`](<fd_groove_data.h.md#fd_groove_data_volume_max>).
    - Initialize `idx` to -1 to indicate no volume has been selected yet.
    - Enter a thread-safe block using `FD_TURNSTILE_BEGIN` to select an available volume index randomly.
    - If `volume_avail_pmap` is non-zero, calculate a random starting point `sr` and a shift `sl` to find an available volume index `idx`.
    - Update `volume_avail_pmap` to mark the selected volume as used.
    - Exit the thread-safe block with `FD_TURNSTILE_END`.
    - If no volume was selected (`idx < 0`), log an error and return `FD_GROOVE_ERR_FULL`.
    - Log the addition of the selected volume and call [`fd_groove_data_volume_add`](<fd_groove_data.h.md#fd_groove_data_volume_add>) to add the volume to the groove data.
- **Output**: Returns the result of [`fd_groove_data_volume_add`](<fd_groove_data.h.md#fd_groove_data_volume_add>), which is typically a success code or an error code if the operation fails.
- **Functions Called**:
    - [`fd_groove_data_volume0`](<fd_groove_data.h.md#fd_groove_data_volume0>)
    - [`fd_groove_data_volume_max`](<fd_groove_data.h.md#fd_groove_data_volume_max>)
    - [`fd_groove_data_volume_add`](<fd_groove_data.h.md#fd_groove_data_volume_add>)


---
### tile\_main<!-- {{#callable:tile_main}} -->
[View Source →](<../../../../src/groove/test_groove_data.c#L91>)

Executes a memory allocation and deallocation test on a shared data structure across multiple threads, ensuring data integrity and synchronization.
- **Inputs**:
    - `argc`: The number of command-line arguments (unused in this function).
    - `argv`: The array of command-line arguments (unused in this function).
- **Logic and Control Flow**:
    - Initialize `tile_idx` and `cgroup_hint` using `fd_tile_idx` and `fd_ulong_hash` respectively.
    - Retrieve volatile constants for shared data, volume, volume count, allocation count, and maximum size.
    - Determine the maximum alignment using `fd_ulong_find_msb`.
    - Initialize a random number generator `rng` with a unique seed based on `tile_idx`.
    - Join the shared data structure using [`fd_groove_data_join`](<fd_groove_data.c.md#fd_groove_data_join>).
    - If `tile_idx` is zero, set the volatile `_go` flag to 1; otherwise, wait until `_go` is set to 1 by another thread.
    - Iterate `2 * alloc_cnt` times to perform memory allocation and deallocation tests.
    - In each iteration, select a random slot and attempt to lock it using atomic operations if available.
    - If the slot is not allocated, determine random size and alignment, allocate memory, and fill it with a unique pattern.
    - If allocation fails due to full memory, call [`grow_data`](<#grow_data>) to expand the data structure and retry the iteration.
    - If the slot is already allocated, verify the integrity of the data pattern and optionally free the memory based on a random condition.
    - Release the lock on the slot after processing.
    - Leave the shared data structure and delete the random number generator before returning.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`fd_groove_data_join`](<fd_groove_data.c.md#fd_groove_data_join>)
    - [`fd_groove_data_alloc`](<fd_groove_data.c.md#fd_groove_data_alloc>)
    - [`grow_data`](<#grow_data>)
    - [`fd_groove_data_alloc_align`](<fd_groove_data.h.md#fd_groove_data_alloc_align>)
    - [`fd_groove_data_alloc_sz`](<fd_groove_data.h.md#fd_groove_data_alloc_sz>)
    - [`fd_groove_data_alloc_tag`](<fd_groove_data.h.md#fd_groove_data_alloc_tag>)
    - [`fd_groove_data_alloc_start`](<fd_groove_data.h.md#fd_groove_data_alloc_start>)
    - [`fd_groove_data_alloc_stop`](<fd_groove_data.h.md#fd_groove_data_alloc_stop>)
    - [`fd_groove_data_alloc_start_const`](<fd_groove_data.h.md#fd_groove_data_alloc_start_const>)
    - [`fd_groove_data_alloc_stop_const`](<fd_groove_data.h.md#fd_groove_data_alloc_stop_const>)
    - [`fd_groove_data_free`](<fd_groove_data.h.md#fd_groove_data_free>)
    - [`fd_groove_data_leave`](<fd_groove_data.c.md#fd_groove_data_leave>)


---
### main<!-- {{#callable:main}} -->
[View Source →](<../../../../src/groove/test_groove_data.c#L242>)

Initializes and tests a groove data volume pool using shared memory, handling command-line arguments for configuration.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
- **Logic and Control Flow**:
    - Calls `fd_boot` to initialize the environment with command-line arguments.
    - Initializes a random number generator `rng`.
    - Parses command-line arguments to configure the groove data volume pool, including `--name`, `--volume-cnt`, `--page-sz`, `--near-cpu`, `--alloc-cnt`, and `--sz-max`.
    - Determines the number of tiles available using `fd_tile_cnt`.
    - Logs the creation of a test volume pool.
    - Checks if a `--name` is provided to join an existing shared memory volume or creates a new anonymous shared memory volume.
    - Calculates `volume_avail_pmap` to track available volumes.
    - Logs and tests groove data construction, including alignment and footprint checks.
    - Allocates shared memory for groove data and initializes it.
    - Tests groove data joining with various error cases and verifies the data.
    - Logs and tests groove data accessors and internals, including header and superblock verification.
    - Tests groove data volume addition and removal, including error cases.
    - Starts remote tiles for parallel execution using `fd_tile_exec_new`.
    - Runs the main tile function [`tile_main`](<#tile_main>) locally and waits for remote tiles to finish.
    - Frees outstanding allocations and verifies groove data integrity.
    - Logs groove data destruction and cleans up resources.
    - Calls `fd_halt` to terminate the program.
- **Output**: Returns 0 to indicate successful execution.
- **Functions Called**:
    - [`fd_groove_data_align`](<fd_groove_data.h.md#fd_groove_data_align>)
    - [`fd_groove_data_footprint`](<fd_groove_data.h.md#fd_groove_data_footprint>)
    - [`fd_groove_data_new`](<fd_groove_data.c.md#fd_groove_data_new>)
    - [`shmem_alloc`](<#shmem_alloc>)
    - [`fd_groove_data_join`](<fd_groove_data.c.md#fd_groove_data_join>)
    - [`fd_groove_data_verify`](<fd_groove_data.c.md#fd_groove_data_verify>)
    - [`fd_groove_data_volume_verify`](<fd_groove_data.c.md#fd_groove_data_volume_verify>)
    - [`fd_groove_data_shdata`](<fd_groove_data.h.md#fd_groove_data_shdata>)
    - [`fd_groove_data_shdata_const`](<fd_groove_data.h.md#fd_groove_data_shdata_const>)
    - [`fd_groove_data_volume0`](<fd_groove_data.h.md#fd_groove_data_volume0>)
    - [`fd_groove_data_volume0_const`](<fd_groove_data.h.md#fd_groove_data_volume0_const>)
    - [`fd_groove_data_volume_max`](<fd_groove_data.h.md#fd_groove_data_volume_max>)
    - [`fd_groove_data_cgroup_hint`](<fd_groove_data.h.md#fd_groove_data_cgroup_hint>)
    - [`fd_groove_data_volume1`](<fd_groove_data.h.md#fd_groove_data_volume1>)
    - [`fd_groove_data_volume1_const`](<fd_groove_data.h.md#fd_groove_data_volume1_const>)
    - [`fd_groove_data_object_hdr_const`](<fd_groove_data.h.md#fd_groove_data_object_hdr_const>)
    - [`fd_groove_data_hdr_type`](<fd_groove_data.h.md#fd_groove_data_hdr_type>)
    - [`fd_groove_data_hdr_idx`](<fd_groove_data.h.md#fd_groove_data_hdr_idx>)
    - [`fd_groove_data_hdr_szc`](<fd_groove_data.h.md#fd_groove_data_hdr_szc>)
    - [`fd_groove_data_hdr_align`](<fd_groove_data.h.md#fd_groove_data_hdr_align>)
    - [`fd_groove_data_hdr_sz`](<fd_groove_data.h.md#fd_groove_data_hdr_sz>)
    - [`fd_groove_data_hdr_info`](<fd_groove_data.h.md#fd_groove_data_hdr_info>)
    - [`fd_groove_data_hdr_t::fd_groove_data_hdr`](<fd_groove_data.h.md#fd_groove_data_hdr_tfd_groove_data_hdr>)
    - [`fd_groove_data_szc`](<fd_groove_data.h.md#fd_groove_data_szc>)
    - [`fd_groove_data_superblock_hdr_const`](<fd_groove_data.h.md#fd_groove_data_superblock_hdr_const>)
    - [`fd_groove_data_volume_add`](<fd_groove_data.h.md#fd_groove_data_volume_add>)
    - [`fd_groove_data_volume_remove`](<fd_groove_data.h.md#fd_groove_data_volume_remove>)
    - [`fd_groove_data_alloc`](<fd_groove_data.c.md#fd_groove_data_alloc>)
    - [`fd_groove_data_free`](<fd_groove_data.h.md#fd_groove_data_free>)
    - [`tile_main`](<#tile_main>)
    - [`fd_groove_data_leave`](<fd_groove_data.c.md#fd_groove_data_leave>)
    - [`fd_groove_data_delete`](<fd_groove_data.c.md#fd_groove_data_delete>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)