<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

APIs for managing funk records, including structures, queries, preparation, and publishing functions.

# Purpose
The `fd_funk_rec.h` file is a C header file that provides APIs for managing "funk" records within a transactional system. It defines the structure and operations related to `fd_funk_rec_t`, which represents a funk record. The file includes definitions for alignment and footprint of the records, as well as constants like `FD_FUNK_REC_IDX_NULL` to represent a null index in the record map. The `fd_funk_rec` structure contains fields for transaction ID and record key pairs, user-managed data, and internal fields for managing record indices and values.

The file also includes macros and templates for managing pools and maps of funk records, allowing for efficient indexing and retrieval of records by their transaction ID and key pairs. Functions such as [`fd_funk_rec_query_try`](<#fd_funk_rec_query_try>) and [`fd_funk_rec_query_try_global`](<#fd_funk_rec_query_try_global>) provide mechanisms to query records within transactions, while [`fd_funk_rec_prepare`](<#fd_funk_rec_prepare>) and [`fd_funk_rec_publish`](<#fd_funk_rec_publish>) handle the preparation and publication of new records. The file ensures that records are managed in a way that supports transactional integrity and efficient access, with additional functions for verifying the integrity of the record map.
# Imports and Dependencies

---
- `fd_funk_txn.h`
- `../util/tmpl/fd_pool_para.c`
- `../util/tmpl/fd_map_chain_para.c`


# Data Structures

---
### fd\_funk\_rec
- **Type**: ``struct fd_funk_rec``
- **Members**:
    - ``pair``: Transaction id and record key pair.
    - ``map_next``: Internal use by map.
    - ``user``: User-managed data array of 12 bytes.
    - ``next_idx``: Record map index of next record in its transaction.
    - ``prev_idx``: Record map index of previous record in its transaction.
    - ``val_sz``: Number of bytes in record value, in [0,val_max].
    - ``val_max``: Maximum byte in record value, in [0,FD_FUNK_REC_VAL_MAX], 0 if val_gaddr is 0.
    - ``tag``: Used for internal validation.
    - ``val_gaddr``: Workspace global address on record value if any, 0 if val_max is 0.
- **Description**: Describes a funk record with fields managed by the funk's record map, user, and funk itself. It includes transaction id and record key pair, internal map management fields, user data, and fields for managing record indices and value sizes. The structure is aligned to `FD_FUNK_REC_ALIGN` and has constraints on value sizes and addresses.


---
### fd\_funk\_rec\_t
- **Type**: ``struct fd_funk_rec``
- **Members**:
    - ``pair``: Contains the transaction id and record key pair.
    - ``map_next``: Used internally by the map for navigation.
    - ``user``: A user-managed field of 12 bytes.
    - ``next_idx``: Index of the next record in the transaction.
    - ``prev_idx``: Index of the previous record in the transaction.
    - ``val_sz``: Number of bytes in the record value, ranging from 0 to `val_max`.
    - ``val_max``: Maximum number of bytes in the record value, 0 if `val_gaddr` is 0.
    - ``tag``: Used for internal validation purposes.
    - ``val_gaddr``: Workspace global address of the record value, 0 if `val_max` is 0.
- **Description**: Describes a funk record with fields for transaction management, user data, and internal validation. It includes fields for linking records within a transaction, managing user data, and handling record values with size and address information. The structure is aligned to 32 bytes and is used in conjunction with a map for efficient record management.


---
### \_fd\_funk\_rec\_prepare
- **Type**: ``struct``
- **Members**:
    - ``rec``: A pointer to a `fd_funk_rec_t` structure representing a funk record.
    - ``rec_head_idx``: A pointer to an unsigned integer representing the index of the head of the record list.
    - ``rec_tail_idx``: A pointer to an unsigned integer representing the index of the tail of the record list.
- **Description**: Represents a new funk record that has been prepared but not yet inserted into the map, containing pointers to the record itself and indices for the head and tail of the record list.


---
### fd\_funk\_rec\_prepare\_t
- **Type**: ``struct _fd_funk_rec_prepare``
- **Members**:
    - ``rec``: Pointer to a `fd_funk_rec_t` structure representing the record being prepared.
    - ``rec_head_idx``: Pointer to an unsigned integer representing the index of the head of the record list.
    - ``rec_tail_idx``: Pointer to an unsigned integer representing the index of the tail of the record list.
- **Description**: Represents a new record that has been prepared but not yet inserted into the map. It contains pointers to the record itself and to the indices of the head and tail of the record list, facilitating the management of records in preparation for insertion into a transaction.


# Functions

---
### fd\_funk\_rec\_idx\_is\_null<!-- {{#callable:fd_funk_rec_idx_is_null}} -->
[View Source →](<../../../../src/funk/fd_funk_rec.h#L101>)

Checks if a given index is equal to `FD_FUNK_REC_IDX_NULL`.
- **Inputs**:
    - `idx`: An unsigned integer representing the index to check against `FD_FUNK_REC_IDX_NULL`.
- **Logic and Control Flow**:
    - Compares the input `idx` with the constant `FD_FUNK_REC_IDX_NULL`.
    - Returns 1 if `idx` is equal to `FD_FUNK_REC_IDX_NULL`.
    - Returns 0 if `idx` is not equal to `FD_FUNK_REC_IDX_NULL`.
- **Output**: An integer value, 1 if the index is `FD_FUNK_REC_IDX_NULL`, otherwise 0.


---
### fd\_funk\_rec\_pair<!-- {{#callable:fd_funk_rec_pair}} -->
[View Source →](<../../../../src/funk/fd_funk_rec.h#L171>)

Returns a pointer to the `fd_funk_xid_key_pair_t` structure within a given `fd_funk_rec_t` record.
- **Inputs**:
    - `rec`: A pointer to a constant `fd_funk_rec_t` structure, representing a funk record.
- **Logic and Control Flow**:
    - Accesses the `pair` field of the `fd_funk_rec_t` structure pointed to by `rec`.
    - Returns the address of the `pair` field.
- **Output**: A constant pointer to the `fd_funk_xid_key_pair_t` structure within the provided `fd_funk_rec_t` record.


---
### fd\_funk\_rec\_xid<!-- {{#callable:fd_funk_rec_xid}} -->
[View Source →](<../../../../src/funk/fd_funk_rec.h#L172>)

Accesses the transaction ID of a given funk record.
- **Inputs**:
    - ``rec``: A pointer to a constant `fd_funk_rec_t` structure representing the funk record.
- **Logic and Control Flow**:
    - Returns the transaction ID (`xid`) from the `pair` field of the `fd_funk_rec_t` structure pointed to by `rec`.
- **Output**: A constant pointer to `fd_funk_txn_xid_t`, representing the transaction ID of the funk record.


---
### fd\_funk\_rec\_key<!-- {{#callable:fd_funk_rec_key}} -->
[View Source →](<../../../../src/funk/fd_funk_rec.h#L173>)

Returns a pointer to the record key of a given funk record.
- **Inputs**:
    - `rec`: A pointer to a constant `fd_funk_rec_t` structure representing a funk record.
- **Logic and Control Flow**:
    - Accesses the `pair` field of the `fd_funk_rec_t` structure pointed to by `rec`.
    - Returns the `key` field from the `pair` structure.
- **Output**: A constant pointer to a `fd_funk_rec_key_t` representing the record key.


# Function Declarations (Public API)

---
### fd\_funk\_rec\_query\_try<!-- {{#callable_declaration:fd_funk_rec_query_try}} -->
[View Source →](<../../../../src/funk/fd_funk_rec.h#L137>)

Queries a transaction for a record by key.
- **Description**: Use this function to find a record in a specified transaction or in the last published transaction if the transaction is null. It returns a pointer to the record if found, or null if the record does not exist. Ensure that the `funk`, `xid`, `key`, and `query` parameters are not null before calling this function. The function assumes no concurrent operations on the provided parameters. The `query` parameter is used to store the query result for later validation. Be aware that the function may return records marked as erased, and the application should handle such cases appropriately.
- **Inputs**:
    - `funk`: A pointer to an `fd_funk_t` structure representing the current local join. Must not be null.
    - `xid`: A pointer to an `fd_funk_txn_xid_t` structure representing the transaction ID. Must not be null.
    - `key`: A pointer to an `fd_funk_rec_key_t` structure representing the record key. Must not be null.
    - `query`: A pointer to an `fd_funk_rec_query_t` structure used to store the query result. Must not be null.
- **Output**: Returns a pointer to the `fd_funk_rec_t` record if found, or null if the record does not exist or an error occurs.
- **See Also**: [`fd_funk_rec_query_try`](<fd_funk_rec.c.md#fd_funk_rec_query_try>)  (Implementation)


---
### fd\_funk\_rec\_query\_try\_global<!-- {{#callable_declaration:fd_funk_rec_query_try_global}} -->
[View Source →](<../../../../src/funk/fd_funk_rec.h#L157>)

Queries a record in a transaction and its ancestors.
- **Description**: Use this function to find a record with a specific key in a given transaction and its ancestor transactions. It searches from the youngest to the oldest ancestor if the key is not part of the specified transaction. This function is useful when you need to find the most recent transaction containing the key. Ensure that `funk`, `key`, and `query` are not null before calling this function. The function will return null if the record is a tombstone, but it will still set `xid_out` to the relevant transaction.
- **Inputs**:
    - `funk`: A pointer to a `fd_funk_t` structure representing the funk context. Must not be null.
    - `xid`: A pointer to a `fd_funk_txn_xid_t` structure representing the transaction ID. Can be null to search the last published transaction.
    - `key`: A pointer to a `fd_funk_rec_key_t` structure representing the record key to query. Must not be null.
    - `xid_out`: A pointer to a `fd_funk_txn_xid_t` where the function will store the transaction ID of the found record. Can be null if the transaction ID is not needed.
    - `query`: A pointer to a `fd_funk_rec_query_t` structure used to store query information for later validity testing. Must not be null.
- **Output**: Returns a pointer to the found `fd_funk_rec_t` record if successful, or null if the record is not found or is a tombstone.
- **See Also**: [`fd_funk_rec_query_try_global`](<fd_funk_rec.c.md#fd_funk_rec_query_try_global>)  (Implementation)


---
### fd\_funk\_rec\_prepare<!-- {{#callable_declaration:fd_funk_rec_prepare}} -->
[View Source →](<../../../../src/funk/fd_funk_rec.h#L184>)

Creates an unpublished funk record entry.
- **Description**: Use this function to create a new funk record entry that is not yet published. This is the initial step in adding a record to a transaction. The function may fail if the record pool is exhausted or if the transaction is not writable. The created record is not visible to query or iteration operations until it is published. It is safe to prepare records concurrently.
- **Inputs**:
    - `funk`: A pointer to an `fd_funk_t` structure. Must not be null. Represents the funk context in which the record is prepared.
    - `xid`: A pointer to a `fd_funk_txn_xid_t` structure. Must not be null. Represents the transaction ID for which the record is being prepared.
    - `key`: A pointer to a `fd_funk_rec_key_t` structure. Represents the key of the record to be prepared. Can be null if not used.
    - `prepare`: A pointer to an `fd_funk_rec_prepare_t` structure. Must not be null. Used to store preparation details of the record.
    - `opt_err`: An optional pointer to an integer. If not null, it will store error codes if the function fails. Possible error codes include `FD_FUNK_ERR_FROZEN` and `FD_FUNK_ERR_REC`.
- **Output**: Returns a pointer to the prepared `fd_funk_rec_t` record on success, or null on failure. If `opt_err` is provided, it will contain error information on failure.
- **See Also**: [`fd_funk_rec_prepare`](<fd_funk_rec.c.md#fd_funk_rec_prepare>)  (Implementation)


---
### fd\_funk\_rec\_publish<!-- {{#callable_declaration:fd_funk_rec_publish}} -->
[View Source →](<../../../../src/funk/fd_funk_rec.h#L197>)

Makes a prepared record globally visible.
- **Description**: Use this function to make a record, which was previously prepared, visible to all operations that query or iterate over records. This function registers the record with the transaction's record list and inserts it into the record map. It is safe to call this function concurrently, even for the same transaction. However, if the same transaction and key pair is published more than once, the application will crash. Ensure that the record is prepared before calling this function.
- **Inputs**:
    - `funk`: A pointer to an `fd_funk_t` structure representing the funk context. Must not be null. The caller retains ownership.
    - `prepare`: A pointer to an `fd_funk_rec_prepare_t` structure representing the prepared record. Must not be null. The caller retains ownership.
- **Output**: None
- **See Also**: [`fd_funk_rec_publish`](<fd_funk_rec.c.md#fd_funk_rec_publish>)  (Implementation)


---
### fd\_funk\_rec\_verify<!-- {{#callable_declaration:fd_funk_rec_verify}} -->
[View Source →](<../../../../src/funk/fd_funk_rec.h#L209>)

Verifies the integrity of the record map.
- **Description**: Use this function to check the integrity of the record map within a `fd_funk_t` structure. It returns a success code if the map is intact and an error code if it is not. This function is typically called as part of a larger verification process and assumes that the `fd_funk_t` structure and its associated maps have been previously verified. It logs details of any verification failures.
- **Inputs**:
    - `funk`: A pointer to a `fd_funk_t` structure. Must not be null. The function assumes that the `fd_funk_t` structure and its associated maps have been previously verified.
- **Output**: Returns `FD_FUNK_SUCCESS` if the record map is intact, or `FD_FUNK_ERR_INVAL` if it is not.
- **See Also**: [`fd_funk_rec_verify`](<fd_funk_rec.c.md#fd_funk_rec_verify>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)