<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a transaction map and pool for managing transaction states and relationships in the Firedancer system.

# Purpose
The code provides an implementation for managing transactions within a system, specifically using a transaction map and pool. It includes definitions and macros to set up a transaction pool (`fd_funk_txn_pool`) and a transaction map (`fd_funk_txn_map`) using parameterized templates. The transaction map is designed to handle elements of type `fd_funk_txn_t` and uses a key of type `fd_funk_txn_xid_t`. The map and pool are implemented with specific styles and configurations, as indicated by the macros such as `POOL_IMPL_STYLE` and `MAP_IMPL_STYLE`.

The code defines several functions and macros to manage transaction states and transitions. The [`fd_funk_txn_prepare`](<#fd_funk_txn_prepare>) function prepares a new transaction by checking for valid input parameters, ensuring the transaction ID is not already in use, and acquiring a new transaction from the pool. It also manages the hierarchical relationship between transactions, linking child transactions to their parents. The [`fd_funk_txn_verify`](<#fd_funk_txn_verify>) function verifies the integrity of the transaction map and pool, ensuring that all transactions are correctly linked and that there are no cycles or invalid states. The code uses logging to report critical errors and state changes, and it includes mechanisms to handle atomic state transitions when supported by the system.
# Imports and Dependencies

---
- `fd_funk_txn.h`
- `fd_funk.h`
- `../util/tmpl/fd_pool_para.c`
- `../util/tmpl/fd_map_chain_para.c`


# Functions

---
### fd\_funk\_txn\_prepare<!-- {{#callable:fd_funk_txn_prepare}} -->
[View Source →](<../../../../src/funk/fd_funk_txn.c#L56>)

Prepares a new transaction in the transaction map, ensuring it is not already in use and correctly linking it to its parent transaction.
- **Inputs**:
    - ``funk``: A pointer to the `fd_funk_t` structure, representing the transaction context.
    - ``parent_xid``: A pointer to the `fd_funk_txn_xid_t` structure, representing the parent transaction ID.
    - ``xid``: A pointer to the `fd_funk_txn_xid_t` structure, representing the transaction ID to prepare.
- **Logic and Control Flow**:
    - Check if `funk`, `parent_xid`, or `xid` is NULL and log a critical error if any are NULL.
    - Check if `xid` is the root or the last published transaction ID and log an error if true.
    - Query the transaction map to ensure `xid` is not already in use, logging an error if it is.
    - Determine the parent transaction index and child indices based on whether `parent_xid` is the last published transaction ID.
    - Acquire a new transaction from the transaction pool and copy the `xid` into it.
    - Link the new transaction to its parent and siblings, updating child head and tail indices as necessary.
    - Transition the transaction state from FREE to ACTIVE.
    - Insert the new transaction into the transaction map with blocking flag.
- **Output**: No return value; the function logs errors and critical issues if encountered.
- **Functions Called**:
    - [`fd_funk_txn_xid_eq_root`](<fd_funk_base.h.md#fd_funk_txn_xid_eq_root>)
    - [`fd_funk_txn_xid_eq`](<fd_funk_base.h.md#fd_funk_txn_xid_eq>)
    - [`fd_funk_txn_state_assert`](<fd_funk_txn.h.md#fd_funk_txn_state_assert>)
    - [`fd_funk_txn_xid_copy`](<fd_funk_base.h.md#fd_funk_txn_xid_copy>)
    - [`fd_funk_txn_idx`](<fd_funk_txn.h.md#fd_funk_txn_idx>)
    - [`fd_funk_txn_idx_is_null`](<fd_funk_txn.h.md#fd_funk_txn_idx_is_null>)
    - [`fd_funk_txn_cidx`](<fd_funk_txn.h.md#fd_funk_txn_cidx>)


---
### fd\_funk\_txn\_verify<!-- {{#callable:fd_funk_txn_verify}} -->
[View Source →](<../../../../src/funk/fd_funk_txn.c#L146>)

Verifies the integrity and consistency of transactions in a transaction pool, ensuring no cycles and correct parent-child relationships.
- **Inputs**:
    - ``funk``: A pointer to an `fd_funk_t` structure representing the transaction context to verify.
- **Logic and Control Flow**:
    - Initialize `txn_map`, `txn_pool`, and `txn_max` from `funk`.
    - Retrieve `funk_child_head_idx` and `funk_child_tail_idx` from `funk->shmem`.
    - Retrieve `last_publish` from `funk->shmem`.
    - Define macros `TEST` and `IS_VALID` for condition checks and validation.
    - Verify `txn_map` and `txn_pool` using `fd_funk_txn_map_verify` and `fd_funk_txn_pool_verify`.
    - Tag all transactions in `txn_pool` as not visited by setting `tag` to 0.
    - Traverse transactions from oldest to youngest, marking them as visited and checking for cycles and parent-child relationships.
    - Repeat the traversal from youngest to oldest to verify reverse link integrity.
    - Return `FD_FUNK_SUCCESS` if all checks pass.
- **Output**: Returns `FD_FUNK_SUCCESS` if the transaction pool is valid, otherwise returns `FD_FUNK_ERR_INVAL` if any validation fails.
- **Functions Called**:
    - [`fd_funk_txn_idx`](<fd_funk_txn.h.md#fd_funk_txn_idx>)
    - [`fd_funk_txn_idx_is_null`](<fd_funk_txn.h.md#fd_funk_txn_idx_is_null>)
    - [`fd_funk_txn_cidx`](<fd_funk_txn.h.md#fd_funk_txn_cidx>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)