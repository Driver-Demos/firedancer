<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

APIs for managing funk transactions, including preparation, publishing, and cancellation, with thread-safety considerations.

# Purpose
The code is a C header file that defines APIs for managing transactions in a system referred to as "funk." It provides functionality for preparing, publishing, and canceling transactions, which are referred to as "funk transactions." The file is not intended to be included directly; instead, it should be accessed through another header file, `fd_funk.h`. The operations defined in this file are not thread-safe, and external synchronization is required when performing transaction operations concurrently with other operations.

The file defines a structure, `fd_funk_txn_t`, which represents an in-preparation funk transaction. This structure includes fields for transaction management, such as transaction IDs, parent and child relationships, and state information. The file also includes macros and inline functions for handling transaction indices and states, as well as functions for querying and preparing transactions. The header file uses templates to implement a pool and map for managing transactions, allowing transactions to be indexed by their IDs. Additionally, it defines several transaction states and provides utility functions for verifying transaction maps and asserting transaction states.
# Imports and Dependencies

---
- `fd_funk_base.h`
- `../flamenco/fd_rwlock.h`
- `../util/tmpl/fd_pool_para.c`
- `../util/tmpl/fd_map_chain_para.c`


# Data Structures

---
### fd\_funk\_txn\_private
- **Type**: ``struct``
- **Members**:
    - ``xid``: Transaction id, unique among all in-prepare and the last published transaction.
    - ``map_next``: Used internally by the map for linking transactions.
    - ``parent_cidx``: Compressed map index of the in-preparation parent transaction, or `FD_FUNK_TXN_IDX_NULL` if a funk child.
    - ``child_head_cidx``: Compressed map index of the oldest child transaction, or `FD_FUNK_TXN_IDX_NULL` if childless.
    - ``child_tail_cidx``: Compressed map index of the youngest child transaction, or `FD_FUNK_TXN_IDX_NULL` if childless.
    - ``sibling_prev_cidx``: Compressed map index of the older sibling transaction, or `FD_FUNK_TXN_IDX_NULL` if the oldest sibling.
    - ``sibling_next_cidx``: Compressed map index of the younger sibling transaction, or `FD_FUNK_TXN_IDX_NULL` if the youngest sibling.
    - ``stack_cidx``: Used internally by funk for stack operations.
    - ``tag``: Used internally by funk for tagging transactions.
    - ``rec_head_idx``: Record map index of the first record, or `FD_FUNK_REC_IDX_NULL` if none.
    - ``rec_tail_idx``: Record map index of the last record, or `FD_FUNK_REC_IDX_NULL` if none.
    - ``state``: Represents the state of the transaction, one of `FD_FUNK_TXN_STATE_*`.
    - ``lock``: Read-write lock for synchronizing access to the transaction.
- **Description**: Represents a private structure for managing funk transactions, including fields for transaction identification, parent-child relationships, sibling relationships, and internal management by the funk system. The structure is aligned according to `FD_FUNK_TXN_ALIGN` and includes a lock for thread synchronization. It is used internally by the funk's transaction map and the funk system to manage transaction states and relationships.


---
### fd\_funk\_txn\_t
- **Type**: ``struct``
- **Members**:
    - ``xid``: Transaction id, unique among all in-prepare and the last published transaction.
    - ``map_next``: Used internally by the map for transaction indexing.
    - ``parent_cidx``: Compressed map index of the in-preparation parent transaction.
    - ``child_head_cidx``: Compressed map index of the oldest child transaction.
    - ``child_tail_cidx``: Compressed map index of the youngest child transaction.
    - ``sibling_prev_cidx``: Compressed map index of the older sibling transaction.
    - ``sibling_next_cidx``: Compressed map index of the younger sibling transaction.
    - ``stack_cidx``: Used internally by funk for stack operations.
    - ``tag``: Used internally by funk for tagging purposes.
    - ``rec_head_idx``: Record map index of the first record in the transaction.
    - ``rec_tail_idx``: Record map index of the last record in the transaction.
    - ``state``: Current state of the transaction, one of `FD_FUNK_TXN_STATE_*`.
    - ``lock``: Read-write lock for synchronizing access to the transaction.
- **Description**: Represents an in-preparation funk transaction with fields for transaction management, including unique identifiers, parent-child relationships, sibling relationships, and state management. The structure is aligned to `FD_FUNK_TXN_ALIGN` and has a footprint of `FD_FUNK_TXN_FOOTPRINT`. It is used internally by the funk's transaction map and requires external synchronization for thread safety.


---
### fd\_funk\_rec\_t
- **Type**: ``fd_funk_rec_t``
- **Members**:
    - ``xid``: Transaction id, unique among all in-prepare and the last published transaction.
    - ``map_next``: Used internally by the map for transaction management.
    - ``parent_cidx``: Compressed map index of the in-prep parent transaction, or `FD_FUNK_TXN_IDX_NULL` if a funk child.
    - ``child_head_cidx``: Compressed map index of the oldest child transaction, or `FD_FUNK_TXN_IDX_NULL` if childless.
    - ``child_tail_cidx``: Compressed map index of the youngest child transaction, or `FD_FUNK_TXN_IDX_NULL` if childless.
    - ``sibling_prev_cidx``: Compressed map index of the older sibling transaction, or `FD_FUNK_TXN_IDX_NULL` if the oldest sibling.
    - ``sibling_next_cidx``: Compressed map index of the younger sibling transaction, or `FD_FUNK_TXN_IDX_NULL` if the youngest sibling.
    - ``stack_cidx``: Used internally by funk for stack management.
    - ``tag``: Used internally by funk for tagging purposes.
    - ``rec_head_idx``: Record map index of the first record, or `FD_FUNK_REC_IDX_NULL` if none.
    - ``rec_tail_idx``: Record map index of the last record.
    - ``state``: Indicates the state of the transaction, one of `FD_FUNK_TXN_STATE_*`.
    - ``lock``: Read-write lock for synchronizing access to the transaction.
- **Description**: `fd_funk_rec_t` is a structure representing a funk transaction record, containing fields for transaction management, parent-child relationships, sibling relationships, and internal use by the funk system. It includes a transaction id (`xid`), indices for managing transaction hierarchy and records, a state indicator, and a lock for synchronization. The structure is aligned to `FD_FUNK_TXN_ALIGN` and is used in the context of managing funk transactions, which are not thread-safe and require external synchronization.


# Functions

---
### fd\_funk\_txn\_cidx<!-- {{#callable:fd_funk_txn_cidx}} -->
[View Source →](<../../../../src/funk/fd_funk_txn.h#L92>)

Converts an unsigned long index to an unsigned integer compressed index.
- **Inputs**:
    - `idx`: An unsigned long integer representing the index to convert to a compressed index.
- **Logic and Control Flow**:
    - Casts the input `idx` from an unsigned long to an unsigned integer.
- **Output**: Returns the compressed index as an unsigned integer.


---
### fd\_funk\_txn\_idx<!-- {{#callable:fd_funk_txn_idx}} -->
[View Source →](<../../../../src/funk/fd_funk_txn.h#L97>)

Converts a compressed transaction index (`cidx`) to an unsigned long integer.
- **Inputs**:
    - `cidx`: A compressed transaction index of type `uint`.
- **Logic and Control Flow**:
    - Casts the input `cidx` from `uint` to `ulong`.
- **Output**: Returns the `cidx` as an `ulong`.


---
### fd\_funk\_txn\_idx\_is\_null<!-- {{#callable:fd_funk_txn_idx_is_null}} -->
[View Source →](<../../../../src/funk/fd_funk_txn.h#L102>)

Checks if a given transaction index is equal to the null transaction index.
- **Inputs**:
    - `idx`: An unsigned long integer representing the transaction index to check.
- **Logic and Control Flow**:
    - Compares the input `idx` with the constant `FD_FUNK_TXN_IDX_NULL`.
    - Returns 1 if `idx` is equal to `FD_FUNK_TXN_IDX_NULL`, otherwise returns 0.
- **Output**: An integer value, 1 if the transaction index is null, 0 otherwise.


---
### fd\_funk\_txn\_xid<!-- {{#callable:fd_funk_txn_xid}} -->
[View Source →](<../../../../src/funk/fd_funk_txn.h#L137>)

Returns a pointer to the transaction ID of an in-preparation transaction.
- **Inputs**:
    - `txn`: A pointer to a `fd_funk_txn_t` structure representing an in-preparation transaction.
- **Logic and Control Flow**:
    - Accesses the `xid` field of the `fd_funk_txn_t` structure pointed to by `txn`.
    - Returns the address of the `xid` field.
- **Output**: A pointer to the `fd_funk_txn_xid_t` representing the transaction ID of the in-preparation transaction.


---
### fd\_funk\_txn\_is\_frozen<!-- {{#callable:fd_funk_txn_is_frozen}} -->
[View Source →](<../../../../src/funk/fd_funk_txn.h#L185>)

Checks if a transaction is frozen by determining if it has any children.
- **Inputs**:
    - `txn`: A pointer to a `fd_funk_txn_t` structure representing the transaction to check.
- **Logic and Control Flow**:
    - Calls [`fd_funk_txn_idx`](<#fd_funk_txn_idx>) with `txn->child_head_cidx` to get the index of the child head.
    - Checks if the index is null by calling [`fd_funk_txn_idx_is_null`](<#fd_funk_txn_idx_is_null>).
    - Returns the negation of the result from [`fd_funk_txn_idx_is_null`](<#fd_funk_txn_idx_is_null>), indicating if the transaction is frozen (has children).
- **Output**: Returns 1 if the transaction is frozen (has children), otherwise returns 0.
- **Functions Called**:
    - [`fd_funk_txn_idx_is_null`](<#fd_funk_txn_idx_is_null>)
    - [`fd_funk_txn_idx`](<#fd_funk_txn_idx>)


---
### fd\_funk\_txn\_state\_str<!-- {{#callable:fd_funk_txn_state_str}} -->
[View Source →](<../../../../src/funk/fd_funk_txn.h#L238>)

Converts a transaction state code to its corresponding string representation.
- **Inputs**:
    - `state`: An unsigned integer representing the transaction state, which can be one of `FD_FUNK_TXN_STATE_FREE`, `FD_FUNK_TXN_STATE_ACTIVE`, `FD_FUNK_TXN_STATE_CANCEL`, or `FD_FUNK_TXN_STATE_PUBLISH`.
- **Logic and Control Flow**:
    - Use a `switch` statement to evaluate the `state` input.
    - If `state` is `FD_FUNK_TXN_STATE_FREE`, return the string "free".
    - If `state` is `FD_FUNK_TXN_STATE_ACTIVE`, return the string "alive".
    - If `state` is `FD_FUNK_TXN_STATE_CANCEL`, return the string "cancel".
    - If `state` is `FD_FUNK_TXN_STATE_PUBLISH`, return the string "publish".
    - If `state` does not match any of the predefined states, return the string "unknown".
- **Output**: A constant character pointer to a string that describes the transaction state.


---
### fd\_funk\_txn\_state\_assert<!-- {{#callable:fd_funk_txn_state_assert}} -->
[View Source →](<../../../../src/funk/fd_funk_txn.h#L251>)

Checks if a transaction's current state matches the expected state and logs a critical error if it does not.
- **Inputs**:
    - `txn`: A pointer to a `fd_funk_txn_t` structure representing the transaction whose state is to be checked.
    - `want`: An unsigned integer representing the expected state of the transaction.
- **Logic and Control Flow**:
    - Retrieve the current state of the transaction using `FD_VOLATILE_CONST` macro and store it in `have`.
    - Compare the current state (`have`) with the expected state (`want`).
    - If the states do not match, log a critical error message using `FD_LOG_CRIT`, including both the expected and actual states with their string representations obtained from [`fd_funk_txn_state_str`](<#fd_funk_txn_state_str>).
- **Output**: No return value; logs a critical error if the transaction state does not match the expected state.
- **Functions Called**:
    - [`fd_funk_txn_state_str`](<#fd_funk_txn_state_str>)


---
### fd\_funk\_txn\_xid\_assert<!-- {{#callable:fd_funk_txn_xid_assert}} -->
[View Source →](<../../../../src/funk/fd_funk_txn.h#L262>)

Checks if a transaction's ID and state are valid, logging a critical error if not.
- **Inputs**:
    - `txn`: A pointer to a `fd_funk_txn_t` structure representing the transaction to check.
    - `xid`: A pointer to a `fd_funk_txn_xid_t` structure representing the expected transaction ID.
- **Logic and Control Flow**:
    - Retrieve the current state of the transaction using `FD_VOLATILE_CONST` on `txn->state` and store it in `found_state`.
    - Retrieve the current transaction ID using `FD_VOLATILE_CONST` on `txn->xid` and store it in `found_xid`.
    - Check if the retrieved transaction ID matches the expected ID using [`fd_funk_txn_xid_eq`](<fd_funk_base.h.md#fd_funk_txn_xid_eq>) and store the result in `xid_ok`.
    - Check if the transaction state is `FD_FUNK_TXN_STATE_ACTIVE` and store the result in `state_ok`.
    - If either `xid_ok` or `state_ok` is false, log a critical error using `FD_LOG_CRIT`.
    - If `xid_ok` is false, log a 'use-after-free' error message with the transaction pointer and ID.
    - If `state_ok` is false, log an 'invalid state' error message with the transaction pointer, ID, state, and state description.
- **Output**: No return value; logs a critical error if the transaction ID or state is invalid.
- **Functions Called**:
    - [`fd_funk_txn_xid_eq`](<fd_funk_base.h.md#fd_funk_txn_xid_eq>)
    - [`fd_funk_txn_state_str`](<#fd_funk_txn_state_str>)


# Function Declarations (Public API)

---
### fd\_funk\_txn\_prepare<!-- {{#callable_declaration:fd_funk_txn_prepare}} -->
[View Source →](<../../../../src/funk/fd_funk_txn.h#L223>)

Starts preparation of a new transaction.
- **Description**: Use this function to begin preparing a new transaction that will be a child of the specified parent transaction. The function requires a valid `funk` object and unique transaction identifiers for both the parent and the new transaction. It is important to ensure that the `xid` is not already in use and is not the root transaction. This function is not thread-safe, so external synchronization is necessary if other transaction operations might occur concurrently.
- **Inputs**:
    - `funk`: A pointer to a `fd_funk_t` object representing the funk context. Must not be null. The caller retains ownership.
    - `parent_xid`: A pointer to a `fd_funk_txn_xid_t` object representing the parent transaction ID. Must not be null. The caller retains ownership.
    - `xid`: A pointer to a `fd_funk_txn_xid_t` object representing the new transaction ID. Must not be null and must be unique among all in-preparation transactions, the root transaction, and the last published transaction. The caller retains ownership.
- **Output**: None
- **See Also**: [`fd_funk_txn_prepare`](<fd_funk_txn.c.md#fd_funk_txn_prepare>)  (Implementation)


---
### fd\_funk\_txn\_verify<!-- {{#callable_declaration:fd_funk_txn_verify}} -->
[View Source →](<../../../../src/funk/fd_funk_txn.h#L235>)

Verifies the integrity of a transaction map.
- **Description**: Use this function to check if a transaction map is intact. It returns a success code if the map is valid and an error code if it is not. This function is typically called as part of a larger verification process. Ensure that the transaction map is not being modified concurrently by other threads, as this function is not thread-safe.
- **Inputs**:
    - `funk`: A pointer to a `fd_funk_t` structure representing the transaction map to verify. Must not be null. The caller retains ownership and must ensure that no concurrent modifications occur during the verification process.
- **Output**: Returns `FD_FUNK_SUCCESS` if the transaction map is intact, or `FD_FUNK_ERR_INVAL` if the map is invalid.
- **See Also**: [`fd_funk_txn_verify`](<fd_funk_txn.c.md#fd_funk_txn_verify>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)