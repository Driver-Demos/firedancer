<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

APIs for managing funk record values, including accessors, resizing, initialization, and verification functions.

# Purpose
The code in this file provides APIs for managing values associated with funk records. It is a C header file that defines functions and macros to handle the size, allocation, and manipulation of record values within a funk system. The file is not intended to be included directly; instead, it should be accessed through `fd_funk.h`. The primary functionality includes accessing the current size and maximum allocation of a record's value, retrieving pointers to the value, and resizing the value storage. The file defines constants such as `FD_FUNK_REC_VAL_MAX` for the maximum size of a record value and `FD_FUNK_VAL_ALIGN` for alignment purposes.

The file includes several static inline functions for accessing and manipulating record values, such as [`fd_funk_val_sz`](<#fd_funk_val_sz>), [`fd_funk_val_max`](<#fd_funk_val_max>), [`fd_funk_val`](<#fd_funk_val>), and [`fd_funk_val_const`](<#fd_funk_val_const>). It also provides a function [`fd_funk_val_truncate`](<#fd_funk_val_truncate>) to resize a record's value, ensuring efficient memory usage. Additionally, there are internal utility functions like [`fd_funk_val_init`](<#fd_funk_val_init>) and [`fd_funk_val_flush`](<#fd_funk_val_flush>) for initializing and discarding record values, respectively. The [`fd_funk_val_verify`](<#fd_funk_val_verify>) function is used to verify the integrity of record values. The file assumes that no concurrent operations are performed on the records and that the records are part of a local join in the funk system.
# Imports and Dependencies

---
- `fd_funk_rec.h`


# Functions

---
### fd\_funk\_val\_sz<!-- {{#callable:fd_funk_val_sz}} -->
[View Source →](<../../../../src/funk/fd_funk_val.h#L14>)

Returns the current size of the value associated with a funk record.
- **Inputs**:
    - `rec`: A pointer to a `fd_funk_rec_t` structure, assumed to be in the caller's address space and pointing to a live funk record.
- **Logic and Control Flow**:
    - Accesses the `val_sz` field of the `fd_funk_rec_t` structure pointed to by `rec`.
    - Casts the `val_sz` field to an `ulong` type.
    - Returns the casted value.
- **Output**: The current size of the record's value in bytes as an `ulong`.


---
### fd\_funk\_val\_max<!-- {{#callable:fd_funk_val_max}} -->
[View Source →](<../../../../src/funk/fd_funk_val.h#L29>)

Returns the current maximum size of a record's value allocation in bytes.
- **Inputs**:
    - `rec`: A pointer to a `fd_funk_rec_t` structure, assumed to be in the caller's address space and pointing to a live funk record.
- **Logic and Control Flow**:
    - Casts the `val_max` field of the `rec` structure to an `ulong` type.
    - Returns the casted value, which represents the maximum size of the record's value allocation in bytes.
- **Output**: The function returns an `ulong` representing the current maximum size of the record's value allocation in bytes.


---
### fd\_funk\_val<!-- {{#callable:fd_funk_val}} -->
[View Source →](<../../../../src/funk/fd_funk_val.h#L42>)

Returns a pointer to the current value associated with a record or NULL if the value is not present.
- **Inputs**:
    - `rec`: A pointer to a live `fd_funk_rec_t` record in the caller's address space.
    - `wksp`: A pointer to a `fd_wksp_t` workspace, which should be the result of `fd_funk_wksp(funk)` where `funk` is a current local join.
- **Logic and Control Flow**:
    - Retrieve the global address of the value from the `rec` structure using `rec->val_gaddr`.
    - Check if `val_gaddr` is zero; if so, return NULL, indicating no value is present or the record is marked for erasure.
    - If `val_gaddr` is not zero, use `fd_wksp_laddr_fast` to convert the global address to a local address in the caller's address space and return it.
- **Output**: A pointer to the value in the caller's address space, or NULL if the value is not present or the record is marked for erasure.


---
### fd\_funk\_val\_const<!-- {{#callable:fd_funk_val_const}} -->
[View Source →](<../../../../src/funk/fd_funk_val.h#L50>)

Returns a constant pointer to the current value associated with a funk record, or NULL if the value is not present.
- **Inputs**:
    - `rec`: A pointer to a live funk record in the caller's address space.
    - `wksp`: A pointer to the workspace, which should be the result of `fd_funk_wksp(funk)` where `funk` is a current local join.
- **Logic and Control Flow**:
    - Retrieve the global address of the value from the `rec` structure.
    - Check if the global address is zero; if so, return NULL, indicating no value is present or the record is marked for erasure.
    - If the global address is non-zero, convert it to a local address using `fd_wksp_laddr_fast` and return the result.
- **Output**: A constant pointer to the value associated with the record, or NULL if the value is not present.


---
### fd\_funk\_val\_init<!-- {{#callable:fd_funk_val_init}} -->
[View Source →](<../../../../src/funk/fd_funk_val.h#L93>)

Initializes a funk record's value metadata to represent a NULL value.
- **Inputs**:
    - `rec`: A pointer to a `fd_funk_rec_t` structure assumed to be in the caller's address space with uninitialized value metadata.
- **Logic and Control Flow**:
    - Set `rec->val_sz` to 0U, indicating the current size of the value is zero.
    - Set `rec->val_max` to 0U, indicating no workspace is allocated for the value.
    - Set `rec->val_gaddr` to 0UL, indicating the global address of the value is uninitialized.
    - Return the pointer `rec`.
- **Output**: Returns the pointer to the initialized `fd_funk_rec_t` record.


---
### fd\_funk\_val\_flush<!-- {{#callable:fd_funk_val_flush}} -->
[View Source →](<../../../../src/funk/fd_funk_val.h#L104>)

Sets a funk record to a NULL value and frees any associated memory if necessary.
- **Inputs**:
    - ``rec``: A pointer to a live funk record in the caller's address space.
    - ``alloc``: A pointer to an allocator, obtained from `fd_funk_alloc(funk, wksp)`.
    - ``wksp``: A pointer to a workspace, obtained from `fd_funk_wksp(funk)` where `funk` is a current local join.
- **Logic and Control Flow**:
    - Retrieve the global address of the value from the record (`val_gaddr`).
    - Call `fd_funk_val_init(rec)` to initialize the record's value metadata to NULL.
    - Execute a memory fence (`FD_COMPILER_MFENCE`) to prevent double freeing during crash recovery.
    - If `val_gaddr` is non-zero, free the allocated memory using `fd_alloc_free` with the local address obtained from `fd_wksp_laddr_fast(wksp, val_gaddr)`.
    - Return the pointer to the record (`rec`).
- **Output**: Returns a pointer to the funk record (`rec`).
- **Functions Called**:
    - [`fd_funk_val_init`](<#fd_funk_val_init>)


# Function Declarations (Public API)

---
### fd\_funk\_val\_truncate<!-- {{#callable_declaration:fd_funk_val_truncate}} -->
[View Source →](<../../../../src/funk/fd_funk_val.h#L80>)

Resizes a record's value to a specified size.
- **Description**: Use this function to change the size of a record's value to a specified number of bytes. It is important to ensure that the record is live and in the caller's address space, and that no concurrent operations are performed on it. The function attempts to minimize excess allocation, which may invalidate existing pointers to the record's value storage. If the operation is successful, it returns a pointer to the resized value memory. If it fails, it returns NULL and the current value remains unchanged. The function can fail due to invalid input parameters or memory allocation issues.
- **Inputs**:
    - `rec`: A pointer to a live `fd_funk_rec_t` record in the caller's address space. Must not be NULL.
    - `alloc`: A pointer to an `fd_alloc_t` allocator. Must not be NULL.
    - `wksp`: A pointer to an `fd_wksp_t` workspace. Must not be NULL.
    - `align`: The alignment for the allocation, which must be a power of 2. If 0, the default alignment is used.
    - `sz`: The new size for the record's value, which must be between 0 and `FD_FUNK_REC_VAL_MAX`. If outside this range, the function returns NULL.
    - `opt_err`: An optional pointer to an integer where the function can store an error code. If non-NULL, it will contain `FD_FUNK_SUCCESS` on success or an error code on failure.
- **Output**: Returns a pointer to the resized value memory on success, or NULL on failure. If `opt_err` is provided, it will contain an error code indicating success or the reason for failure.
- **See Also**: [`fd_funk_val_truncate`](<fd_funk_val.c.md#fd_funk_val_truncate>)  (Implementation)


---
### fd\_funk\_val\_verify<!-- {{#callable_declaration:fd_funk_val_verify}} -->
[View Source →](<../../../../src/funk/fd_funk_val.h#L121>)

Verifies the integrity of record values.
- **Description**: Use this function to check if the record values in a funk instance are intact. It returns a success code if all values are valid and an error code if any value is invalid. This function should be called as part of a comprehensive verification process, assuming that the funk instance is non-null and its workspace, record map, and workspace tag have been previously verified.
- **Inputs**:
    - `funk`: A pointer to a `fd_funk_t` instance. It must not be null and should point to a valid funk instance with verified workspace, record map, and workspace tag.
- **Output**: Returns `FD_FUNK_SUCCESS` if all record values are intact, or `FD_FUNK_ERR_INVAL` if any value is invalid.
- **See Also**: [`fd_funk_val_verify`](<fd_funk_val.c.md#fd_funk_val_verify>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)