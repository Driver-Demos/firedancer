<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Defines data structures and functions for a "mini-funk" transaction and record management system.

# Purpose
The code is a C header file that defines a "mini-funk" implementation for reference and testing purposes. It provides a set of data structures and functions to manage transactions (`txn_t`) and records (`rec_t`) within a "funk" context (`funk_t`). The header file includes definitions for transaction and record structures, along with their associated linked list pointers and metadata. The `txn_t` structure represents a transaction, which can have a hierarchical relationship with other transactions, while the `rec_t` structure represents a record associated with a transaction.

The file defines several inline functions and prototypes for managing transactions and records, such as [`txn_prepare`](<#txn_prepare>), [`txn_cancel`](<#txn_cancel>), [`txn_publish`](<#txn_publish>), [`rec_query`](<#rec_query>), and [`rec_insert`](<#rec_insert>). These functions provide an API for creating, querying, and manipulating transactions and records. Additionally, the file includes utility functions for testing, such as [`xid_unique`](<#xid_unique>) and `key_set`, which help in generating unique transaction identifiers and setting record keys. The header file is intended to be included in other C source files, providing a modular approach to transaction and record management within the "mini-funk" system.
# Imports and Dependencies

---
- `fd_funk_base.h`


# Data Structures

---
### txn\_t
- **Type**: ``struct txn``
- **Members**:
    - ``xid``: A unique identifier for the transaction.
    - ``parent``: A pointer to the parent transaction in a transaction hierarchy.
    - ``child_head``: A pointer to the first child transaction in a linked list of child transactions.
    - ``child_tail``: A pointer to the last child transaction in a linked list of child transactions.
    - ``sibling_prev``: A pointer to the previous sibling transaction in a linked list of sibling transactions.
    - ``sibling_next``: A pointer to the next sibling transaction in a linked list of sibling transactions.
    - ``map_prev``: A pointer to the previous transaction in a map-based linked list.
    - ``map_next``: A pointer to the next transaction in a map-based linked list.
    - ``rec_head``: A pointer to the first record in a linked list of records associated with the transaction.
    - ``rec_tail``: A pointer to the last record in a linked list of records associated with the transaction.
- **Description**: Represents a transaction in a hierarchical transaction system, where each transaction can have a parent, children, and siblings, and is linked to a list of records. The structure supports navigation through transaction hierarchies and record associations, facilitating operations such as transaction preparation, cancellation, and publishing.


---
### rec\_t
- **Type**: ``struct``
- **Members**:
    - `txn`: Pointer to a `txn_t` structure, representing the transaction associated with the record.
    - `key`: Unsigned long integer representing the key of the record.
    - `prev`: Pointer to the previous `rec_t` in a linked list.
    - `next`: Pointer to the next `rec_t` in a linked list.
    - `map_prev`: Pointer to the previous `rec_t` in a map-based linked list.
    - `map_next`: Pointer to the next `rec_t` in a map-based linked list.
    - `erase`: Integer flag indicating if the record is marked for erasure.
    - `val`: Unsigned integer representing the value associated with the record.
- **Description**: `rec_t` is a structure that represents a record in a transactional system. It contains pointers to manage its position in both a standard and a map-based linked list, a key to identify the record, a transaction pointer to associate it with a transaction, and a value field. The `erase` field indicates whether the record is marked for deletion.


---
### rec
- **Type**: ``struct``
- **Members**:
    - `txn`: Pointer to a `txn_t` structure, representing a transaction associated with the record.
    - `key`: Unsigned long integer representing the unique key of the record.
    - `prev`: Pointer to the previous `rec_t` structure in a linked list.
    - `next`: Pointer to the next `rec_t` structure in a linked list.
    - `map_prev`: Pointer to the previous `rec_t` structure in a map-based linked list.
    - `map_next`: Pointer to the next `rec_t` structure in a map-based linked list.
    - `erase`: Integer flag indicating whether the record is marked for erasure.
    - `val`: Unsigned integer representing the value associated with the record.
- **Description**: Defines a record structure used in a transactional system, with pointers for linked list navigation, a unique key, a transaction association, and a flag for erasure.


---
### txn
- **Type**: ``struct``
- **Members**:
    - `xid`: A unique identifier for the transaction.
    - `parent`: A pointer to the parent transaction.
    - `child_head`: A pointer to the first child transaction.
    - `child_tail`: A pointer to the last child transaction.
    - `sibling_prev`: A pointer to the previous sibling transaction.
    - `sibling_next`: A pointer to the next sibling transaction.
    - `map_prev`: A pointer to the previous transaction in a map.
    - `map_next`: A pointer to the next transaction in a map.
    - `rec_head`: A pointer to the first record in the transaction.
    - `rec_tail`: A pointer to the last record in the transaction.
- **Description**: Represents a transaction in a hierarchical transaction system, where each transaction can have a parent, children, and siblings, and is linked to a series of records. The structure allows navigation through the transaction hierarchy and the associated records, facilitating operations such as transaction preparation, cancellation, and publishing.


---
### funk
- **Type**: ``struct``
- **Members**:
    - `last_publish`: Stores the timestamp of the last publish operation.
    - `child_head`: Points to the first child transaction in a linked list.
    - `child_tail`: Points to the last child transaction in a linked list.
    - `txn_map_head`: Points to the first transaction in a transaction map.
    - `txn_map_tail`: Points to the last transaction in a transaction map.
    - `txn_cnt`: Stores the count of transactions.
    - `rec_head`: Points to the first record in a linked list.
    - `rec_tail`: Points to the last record in a linked list.
    - `rec_map_head`: Points to the first record in a record map.
    - `rec_map_tail`: Points to the last record in a record map.
    - `rec_cnt`: Stores the count of records.
- **Description**: Manages transactions and records, maintaining linked lists and maps for both, and tracking their counts and the last publish timestamp.


---
### funk\_t
- **Type**: ``struct funk``
- **Members**:
    - ``last_publish``: Stores the timestamp of the last publish operation.
    - ``child_head``: Points to the first child transaction in a linked list.
    - ``child_tail``: Points to the last child transaction in a linked list.
    - ``txn_map_head``: Points to the first transaction in a transaction map linked list.
    - ``txn_map_tail``: Points to the last transaction in a transaction map linked list.
    - ``txn_cnt``: Counts the number of transactions.
    - ``rec_head``: Points to the first record in a linked list.
    - ``rec_tail``: Points to the last record in a linked list.
    - ``rec_map_head``: Points to the first record in a record map linked list.
    - ``rec_map_tail``: Points to the last record in a record map linked list.
    - ``rec_cnt``: Counts the number of records.
- **Description**: Represents a data structure for managing transactions and records, with linked lists for child transactions and records, as well as maps for organizing these elements. It includes counters for tracking the number of transactions and records, and timestamps for the last publish operation.


# Functions

---
### txn\_is\_frozen<!-- {{#callable:txn_is_frozen}} -->
[View Source →](<../../../../src/funk/test_funk_common.h#L54>)

Checks if a transaction has any child transactions.
- **Inputs**:
    - `txn`: A pointer to a `txn_t` structure representing the transaction to check.
- **Logic and Control Flow**:
    - Evaluate the `child_head` member of the `txn` structure.
    - Return a non-zero value if `child_head` is not NULL, indicating the transaction has children.
    - Return zero if `child_head` is NULL, indicating the transaction has no children.
- **Output**: An integer value: non-zero if the transaction has children, zero if it does not.


---
### txn\_is\_only\_child<!-- {{#callable:txn_is_only_child}} -->
[View Source →](<../../../../src/funk/test_funk_common.h#L60>)

Checks if a transaction is the only child in its sibling list.
- **Inputs**:
    - `txn`: A pointer to a `txn_t` structure representing the transaction to check.
- **Logic and Control Flow**:
    - Evaluate if `txn->sibling_prev` is NULL, indicating there is no previous sibling.
    - Evaluate if `txn->sibling_next` is NULL, indicating there is no next sibling.
    - Return true (non-zero) if both conditions are met, otherwise return false (zero).
- **Output**: Returns an integer that is non-zero if the transaction is the only child, otherwise returns zero.


---
### txn\_ancestor<!-- {{#callable:txn_ancestor}} -->
[View Source →](<../../../../src/funk/test_funk_common.h#L62>)

Finds the nearest ancestor transaction that is not the only child in its parent's transaction list.
- **Inputs**:
    - `txn`: A pointer to a `txn_t` structure representing the current transaction.
- **Logic and Control Flow**:
    - Enter an infinite loop to traverse the transaction hierarchy.
    - Check if the current transaction is the only child using `txn_is_only_child(txn)`; if not, exit the loop.
    - Check if the current transaction has no parent; if so, return `NULL`.
    - Move to the parent transaction by setting `txn` to `txn->parent`.
    - Return the current transaction when it is not the only child.
- **Output**: A pointer to the nearest ancestor `txn_t` that is not the only child, or `NULL` if no such ancestor exists.
- **Functions Called**:
    - [`txn_is_only_child`](<#txn_is_only_child>)


---
### txn\_descendant<!-- {{#callable:txn_descendant}} -->
[View Source →](<../../../../src/funk/test_funk_common.h#L72>)

Finds the deepest descendant transaction that is the only child in its hierarchy.
- **Inputs**:
    - `txn`: A pointer to a `txn_t` structure representing the starting transaction.
- **Logic and Control Flow**:
    - Check if the input transaction `txn` is the only child using [`txn_is_only_child`](<#txn_is_only_child>); if not, return `NULL`.
    - Enter a loop to traverse the child transactions.
    - In each iteration, check if the current transaction has a child and if that child is the only child using [`txn_is_only_child`](<#txn_is_only_child>).
    - If either condition is false, break the loop.
    - If both conditions are true, move to the child transaction.
    - Return the deepest descendant transaction found.
- **Output**: A pointer to the deepest descendant `txn_t` structure that is the only child, or `NULL` if no such descendant exists.
- **Functions Called**:
    - [`txn_is_only_child`](<#txn_is_only_child>)


---
### txn\_cancel\_children<!-- {{#callable:txn_cancel_children}} -->
[View Source →](<../../../../src/funk/test_funk_common.h#L102>)

Cancels all child transactions of a given transaction or the root transaction in a funk.
- **Inputs**:
    - `funk`: A pointer to a `funk_t` structure, which represents the root transaction context.
    - `txn`: A pointer to a `txn_t` structure, which represents the parent transaction whose children are to be canceled. If `txn` is NULL, the function cancels the children of the root transaction in `funk`.
- **Logic and Control Flow**:
    - Initialize `child` to the head of the child list of `txn` if `txn` is not NULL, otherwise to the head of the child list of `funk`.
    - Enter a loop that continues as long as `child` is not NULL.
    - Inside the loop, store the next sibling of `child` in `next`.
    - Call [`txn_cancel`](<test_funk_common.c.md#txn_cancel>) to cancel the current `child` transaction.
    - Update `child` to `next` to proceed to the next sibling.
- **Output**: Returns the original `txn` pointer.
- **Functions Called**:
    - [`txn_cancel`](<test_funk_common.c.md#txn_cancel>)


---
### txn\_cancel\_siblings<!-- {{#callable:txn_cancel_siblings}} -->
[View Source →](<../../../../src/funk/test_funk_common.h#L114>)

Cancels all sibling transactions of a given transaction except the transaction itself.
- **Inputs**:
    - `funk`: A pointer to a `funk_t` structure representing the transaction system.
    - `txn`: A pointer to a `txn_t` structure representing the transaction whose siblings are to be canceled.
- **Logic and Control Flow**:
    - Determine the starting child transaction based on whether `txn` has a parent; if it does, start with the parent's first child, otherwise start with the first child of `funk`.
    - Iterate over each child transaction in the sibling list.
    - For each child transaction, check if it is not the same as `txn`.
    - If the child transaction is not `txn`, call [`txn_cancel`](<test_funk_common.c.md#txn_cancel>) to cancel it.
    - Move to the next sibling transaction in the list.
- **Output**: Returns a pointer to the `txn` transaction that was passed as input.
- **Functions Called**:
    - [`txn_cancel`](<test_funk_common.c.md#txn_cancel>)


---
### funk\_is\_frozen<!-- {{#callable:funk_is_frozen}} -->
[View Source →](<../../../../src/funk/test_funk_common.h#L151>)

Checks if a `funk_t` structure has any child transactions.
- **Inputs**:
    - `funk`: A pointer to a `funk_t` structure to check for child transactions.
- **Logic and Control Flow**:
    - Evaluate the `child_head` member of the `funk` structure.
    - Return a non-zero value if `child_head` is not NULL, indicating the presence of child transactions.
    - Return zero if `child_head` is NULL, indicating no child transactions.
- **Output**: An integer that is non-zero if the `funk` has child transactions, and zero if it does not.


---
### funk\_descendant<!-- {{#callable:funk_descendant}} -->
[View Source →](<../../../../src/funk/test_funk_common.h#L153>)

Returns the deepest descendant transaction of a given funk structure.
- **Inputs**:
    - `funk`: A pointer to a `funk_t` structure, which represents the root of a transaction tree.
- **Logic and Control Flow**:
    - Check if `funk->child_head` is not NULL.
    - If `funk->child_head` is not NULL, call [`txn_descendant`](<#txn_descendant>) with `funk->child_head` to find the deepest descendant transaction.
    - If `funk->child_head` is NULL, return NULL.
- **Output**: A pointer to the deepest descendant `txn_t` structure if it exists, otherwise NULL.
- **Functions Called**:
    - [`txn_descendant`](<#txn_descendant>)


---
### xid\_set<!-- {{#callable:xid_set}} -->
[View Source →](<../../../../src/funk/test_funk_common.h#L163>)

Sets both elements of the `ul` array in a `fd_funk_txn_xid_t` structure to a given unsigned long value.
- **Inputs**:
    - `xid`: A pointer to a `fd_funk_txn_xid_t` structure where the `ul` array will be set.
    - `_xid`: An unsigned long value to set both elements of the `ul` array in the `xid` structure.
- **Logic and Control Flow**:
    - Assigns the value of `_xid` to the first element of the `ul` array in the `xid` structure.
    - Assigns the value of `_xid` to the second element of the `ul` array in the `xid` structure.
    - Returns the pointer to the `xid` structure.
- **Output**: Returns a pointer to the `fd_funk_txn_xid_t` structure with its `ul` array elements set to the specified value.


---
### xid\_eq<!-- {{#callable:xid_eq}} -->
[View Source →](<../../../../src/funk/test_funk_common.h#L170>)

Compares a transaction ID with a given unsigned long value for equality.
- **Inputs**:
    - `xid`: A pointer to a `fd_funk_txn_xid_t` structure representing the transaction ID to compare.
    - `_xid`: An unsigned long integer representing the transaction ID to compare against.
- **Logic and Control Flow**:
    - Declare a temporary `fd_funk_txn_xid_t` array `tmp` with one element.
    - Call the [`xid_set`](<#xid_set>) function to set the value of `tmp` using `_xid`.
    - Call the [`fd_funk_txn_xid_eq`](<fd_funk_base.h.md#fd_funk_txn_xid_eq>) function to compare `xid` with the value set in `tmp`.
    - Return the result of the comparison.
- **Output**: Returns an integer indicating whether the transaction ID in `xid` is equal to `_xid`.
- **Functions Called**:
    - [`fd_funk_txn_xid_eq`](<fd_funk_base.h.md#fd_funk_txn_xid_eq>)
    - [`xid_set`](<#xid_set>)


# Function Declarations (Public API)

---
### txn\_prepare<!-- {{#callable_declaration:txn_prepare}} -->
[View Source →](<../../../../src/funk/test_funk_common.h#L82>)

Prepares a new transaction in the given funk context.
- **Description**: Use this function to create a new transaction within a specified funk context. It initializes a transaction with a unique identifier and optionally associates it with a parent transaction. This function must be called with a valid funk context and a unique transaction identifier. The function allocates memory for the transaction, so ensure sufficient memory is available. It links the new transaction into the funk's transaction map and, if a parent is provided, into the parent's child transaction list. The caller is responsible for managing the transaction's lifecycle, including cancellation or publishing.
- **Inputs**:
    - `funk`: A pointer to a `funk_t` structure representing the funk context in which the transaction is prepared. Must not be null.
    - `parent`: A pointer to a `txn_t` structure representing the parent transaction. Can be null if the transaction has no parent.
    - `xid`: An unsigned long integer representing the unique identifier for the transaction. Must be unique within the funk context.
- **Output**: Returns a pointer to the newly prepared `txn_t` structure. If memory allocation fails, the function logs an error and does not return.
- **See Also**: [`txn_prepare`](<test_funk_common.c.md#txn_prepare>)  (Implementation)


---
### txn\_cancel<!-- {{#callable_declaration:txn_cancel}} -->
[View Source →](<../../../../src/funk/test_funk_common.h#L87>)

Cancels a transaction and its associated records.
- **Description**: Use this function to cancel a transaction and all its associated records within a given context. This operation will unmap all records linked to the transaction and remove the transaction from its context. It is important to ensure that the transaction is no longer needed before calling this function, as it will remove all associated data. This function does not return a value and does not provide feedback on the success of the operation.
- **Inputs**:
    - `funk`: A pointer to a `funk_t` structure representing the context in which the transaction exists. Must not be null.
    - `txn`: A pointer to a `txn_t` structure representing the transaction to cancel. Must not be null.
- **Output**: None
- **See Also**: [`txn_cancel`](<test_funk_common.c.md#txn_cancel>)  (Implementation)


---
### txn\_publish<!-- {{#callable_declaration:txn_publish}} -->
[View Source →](<../../../../src/funk/test_funk_common.h#L91>)

Publishes a transaction and its records to the global state.
- **Description**: Use this function to publish a transaction and its associated records to the global state. It processes the transaction and its parent transactions recursively, updating the global state with the records from the transaction. This function also handles the removal of old records and updates the transaction hierarchy by canceling sibling transactions and detaching child transactions. It must be called with a valid transaction and is typically used when the transaction is ready to be committed to the global state.
- **Inputs**:
    - `funk`: A pointer to a `funk_t` structure representing the global state. Must not be null. The caller retains ownership.
    - `txn`: A pointer to a `txn_t` structure representing the transaction to publish. Must not be null. The caller retains ownership.
    - `cnt`: An unsigned long integer representing the current count of published transactions. It is used as a counter and is incremented by the function.
- **Output**: Returns the incremented count of published transactions as an unsigned long integer.
- **See Also**: [`txn_publish`](<test_funk_common.c.md#txn_publish>)  (Implementation)


---
### rec\_query<!-- {{#callable_declaration:rec_query}} -->
[View Source →](<../../../../src/funk/test_funk_common.h#L128>)

Searches for a record with a specified key in a transaction or funk.
- **Description**: Use this function to find a record with a given key within a specified transaction or, if no transaction is provided, within the funk. This function is useful when you need to retrieve a record based on its key. If a transaction is provided, the search is limited to the records associated with that transaction. If no transaction is provided, the search is conducted on the records associated with the funk. The function returns a pointer to the record if found, or `NULL` if no matching record exists.
- **Inputs**:
    - `funk`: A pointer to a `funk_t` structure. This must not be null. It represents the collection of records to search if no transaction is specified.
    - `txn`: A pointer to a `txn_t` structure, or null. If provided, the search is limited to the records associated with this transaction.
    - `key`: An unsigned long integer representing the key of the record to search for. There are no specific constraints on the value of the key.
- **Output**: A pointer to a `rec_t` structure representing the found record, or `NULL` if no record with the specified key is found.
- **See Also**: [`rec_query`](<test_funk_common.c.md#rec_query>)  (Implementation)


---
### rec\_query\_global<!-- {{#callable_declaration:rec_query_global}} -->
[View Source →](<../../../../src/funk/test_funk_common.h#L133>)

Searches for a record in a transaction and its ancestors.
- **Description**: Use this function to find a record with a specific key in a given transaction and its ancestor transactions. It searches through the transaction hierarchy starting from the specified transaction and moving up to its ancestors until it finds a matching record or reaches the top of the hierarchy. This function is useful when you need to locate a record that might have been modified or inserted in any of the ancestor transactions. Ensure that the transaction and funk structures are properly initialized before calling this function.
- **Inputs**:
    - `funk`: A pointer to a `funk_t` structure representing the context in which the transaction operates. Must not be null.
    - `txn`: A pointer to a `txn_t` structure representing the starting transaction for the search. Can be null, in which case the search will start from the top-level transaction.
    - `key`: An unsigned long integer representing the key of the record to search for. There are no specific constraints on the value of the key.
- **Output**: A pointer to a `rec_t` structure if a record with the specified key is found; otherwise, null.
- **See Also**: [`rec_query_global`](<test_funk_common.c.md#rec_query_global>)  (Implementation)


---
### rec\_insert<!-- {{#callable_declaration:rec_insert}} -->
[View Source →](<../../../../src/funk/test_funk_common.h#L138>)

Inserts a new record with a specified key into a transaction or global context.
- **Description**: Use this function to add a new record with a given key to a specified transaction or the global context if no transaction is provided. The function assumes that no record with the same key already exists in the specified context. It allocates memory for the new record and initializes its key and value. The function links the new record into the appropriate data structures for both the transaction and the global context. Ensure that the `funk` parameter is valid and that there is sufficient memory available for allocation.
- **Inputs**:
    - `funk`: A pointer to a `funk_t` structure representing the global context. Must not be null.
    - `txn`: A pointer to a `txn_t` structure representing the transaction context, or null to use the global context. The caller retains ownership.
    - `key`: An unsigned long integer representing the key for the new record. Must be unique within the specified context.
- **Output**: Returns a pointer to the newly inserted `rec_t` structure. If memory allocation fails, the function logs an error and does not return.
- **See Also**: [`rec_insert`](<test_funk_common.c.md#rec_insert>)  (Implementation)


---
### funk\_delete<!-- {{#callable_declaration:funk_delete}} -->
[View Source →](<../../../../src/funk/test_funk_common.h#L148>)

Deletes a funk object and its associated resources.
- **Description**: Use this function to release all resources associated with a `funk_t` object. It cancels all child transactions and frees all records linked to the `funk_t` object. This function must be called when the `funk_t` object is no longer needed to prevent memory leaks. Ensure that no other operations are performed on the `funk_t` object after calling this function, as it will be in an invalid state.
- **Inputs**:
    - `funk`: A pointer to a `funk_t` object to delete. Must not be null. The function will free all resources associated with this object, including child transactions and records.
- **Output**: None
- **See Also**: [`funk_delete`](<test_funk_common.c.md#funk_delete>)  (Implementation)


---
### xid\_unique<!-- {{#callable_declaration:xid_unique}} -->
[View Source →](<../../../../src/funk/test_funk_common.h#L160>)

Generates a unique transaction identifier.
- **Description**: Use this function to obtain a unique identifier for transactions. It is useful in scenarios where each transaction must have a distinct identifier to ensure proper tracking and management. The function guarantees uniqueness by incrementing a static counter each time it is called. It does not require any input parameters and can be called at any time to retrieve the next unique identifier.
- **Inputs**: None
- **Output**: Returns an unsigned long integer representing a unique transaction identifier.
- **See Also**: [`xid_unique`](<test_funk_common.c.md#xid_unique>)  (Implementation)


---
### key\_eq<!-- {{#callable_declaration:key_eq}} -->
[View Source →](<../../../../src/funk/test_funk_common.h#L184>)

Compares a record key with a given key value.
- **Description**: Use this function to check if a `fd_funk_rec_key_t` key matches a specified `ulong` key value. It is useful in scenarios where you need to verify key equality in a record-keeping or transaction system. Ensure that the `key` parameter is a valid pointer to a `fd_funk_rec_key_t` structure before calling this function. The function returns an integer indicating whether the keys are equal.
- **Inputs**:
    - `key`: A pointer to a `fd_funk_rec_key_t` structure representing the key to compare. Must not be null.
    - `_key`: An `ulong` value representing the key to compare against. Any `ulong` value is valid.
- **Output**: Returns an integer that is non-zero if the keys are equal, and zero if they are not.
- **See Also**: [`key_eq`](<test_funk_common.c.md#key_eq>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)