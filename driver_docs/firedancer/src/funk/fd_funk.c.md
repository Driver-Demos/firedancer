<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Functions for managing and verifying shared memory structures in the Firedancer codebase.

# Purpose
The code is a C source file that provides functionality for managing a shared memory structure referred to as `fd_funk`. It includes functions for creating, joining, leaving, deleting, and verifying instances of `fd_funk`. The file imports two header files, `fd_funk.h` and `fd_funk_base.h`, which likely define the data structures and constants used in this implementation. The primary operations involve memory alignment, footprint calculation, and the management of transaction and record maps within a shared memory workspace.

Key functions include [`fd_funk_new`](<#fd_funk_new>), which initializes a new `fd_funk` instance in shared memory, and [`fd_funk_join`](<#fd_funk_join>), which allows a process to join an existing `fd_funk` instance. The [`fd_funk_delete`](<#fd_funk_delete>) and [`fd_funk_delete_fast`](<#fd_funk_delete_fast>) functions handle the cleanup and deallocation of resources associated with a `fd_funk` instance. The [`fd_funk_verify`](<#fd_funk_verify>) function checks the integrity of a `fd_funk` instance, ensuring that its internal structures are consistent and valid. The code is designed to work within a shared memory environment, using workspace tags and alignment checks to manage memory efficiently.
# Imports and Dependencies

---
- `fd_funk.h`
- `fd_funk_base.h`
- `stdio.h`


# Functions

---
### fd\_funk\_align<!-- {{#callable:fd_funk_align}} -->
[View Source →](<../../../../src/funk/fd_funk.c#L5>)

Returns the alignment requirement for the `fd_funk` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Returns the value of the macro `FD_FUNK_ALIGN`.
- **Output**: The alignment requirement for the `fd_funk` structure as defined by `FD_FUNK_ALIGN`.


---
### fd\_funk\_footprint<!-- {{#callable:fd_funk_footprint}} -->
[View Source →](<../../../../src/funk/fd_funk.c#L10>)

Calculates the memory footprint required for a given number of transactions and records.
- **Inputs**:
    - `txn_max`: The maximum number of transactions.
    - `rec_max`: The maximum number of records.
- **Logic and Control Flow**:
    - Check if `rec_max` exceeds `UINT_MAX`; if true, return 0.
    - Initialize `l` with `FD_LAYOUT_INIT`.
    - Append the size and alignment of `fd_funk_shmem_t` to `l`.
    - Estimate the transaction chain count using `fd_funk_txn_map_chain_cnt_est` and append the transaction map footprint to `l`.
    - Append the transaction pool footprint and the size of `fd_funk_txn_t` multiplied by `txn_max` to `l`.
    - Estimate the record chain count using `fd_funk_rec_map_chain_cnt_est` and append the record map footprint to `l`.
    - Append the record pool footprint and the size of `fd_funk_rec_t` multiplied by `rec_max` to `l`.
    - Append the allocation footprint to `l`.
    - Return the calculated footprint `l`.
- **Output**: The total memory footprint as an unsigned long integer.


---
### fd\_funk\_new<!-- {{#callable:fd_funk_new}} -->
[View Source →](<../../../../src/funk/fd_funk.c#L38>)

Initializes a new `fd_funk_shmem_t` structure in shared memory with specified parameters and returns a pointer to it.
- **Inputs**:
    - `shmem`: Pointer to the shared memory where the `fd_funk_shmem_t` structure will be initialized.
    - `wksp_tag`: Tag for the workspace, must be non-zero.
    - `seed`: Seed value for initializing maps.
    - `txn_max`: Maximum number of transactions, must not exceed `FD_FUNK_TXN_IDX_NULL`.
    - `rec_max`: Maximum number of records, must not exceed `UINT_MAX`.
- **Logic and Control Flow**:
    - Check if `shmem` is NULL or misaligned, log a warning, and return NULL if true.
    - Check if `wksp_tag` is zero, log a warning, and return NULL if true.
    - Check if `shmem` is part of a workspace, log a warning, and return NULL if not.
    - Check if `txn_max` exceeds `FD_FUNK_TXN_IDX_NULL`, log a warning, and return NULL if true.
    - Check if `rec_max` exceeds `UINT_MAX`, log a warning, and return NULL if true.
    - Initialize scratch allocation for transaction and record maps and pools.
    - Set up transaction and record maps and pools with the given parameters.
    - Initialize locks and states for each transaction element.
    - Set root and last publish transaction IDs to root.
    - Set up allocation in the workspace.
    - Set the `magic` field to `FD_FUNK_MAGIC` to indicate successful initialization.
    - Return a pointer to the initialized `fd_funk_shmem_t` structure.
- **Output**: Returns a pointer to the initialized `fd_funk_shmem_t` structure, or NULL if initialization fails.
- **Functions Called**:
    - [`fd_funk_align`](<#fd_funk_align>)
    - [`fd_funk_footprint`](<#fd_funk_footprint>)
    - [`fd_funk_txn_cidx`](<fd_funk_txn.h.md#fd_funk_txn_cidx>)
    - [`fd_funk_txn_xid_set_root`](<fd_funk_base.h.md#fd_funk_txn_xid_set_root>)


---
### fd\_funk\_join<!-- {{#callable:fd_funk_join}} -->
[View Source →](<../../../../src/funk/fd_funk.c#L137>)

Joins a shared memory funk object to a local funk object, ensuring alignment and integrity checks.
- **Inputs**:
    - `ljoin`: A pointer to a local `fd_funk_t` object that will be initialized and joined with the shared memory funk.
    - `shfunk`: A pointer to the shared memory funk object to join, which must be aligned and part of a workspace.
- **Logic and Control Flow**:
    - Check if `shfunk` is NULL and log a warning if true, then return NULL.
    - Verify if `shfunk` is aligned according to `fd_funk_align()`; log a warning and return NULL if not aligned.
    - Determine the workspace containing `shfunk` using `fd_wksp_containing`; log a warning and return NULL if not part of a workspace.
    - Cast `shfunk` to `fd_funk_shmem_t` and check its `magic` value; log a warning and return NULL if the magic value is incorrect.
    - Check if `ljoin` is NULL; log a warning and return NULL if true.
    - Optionally protect the workspace memory if `FD_FUNK_WKSP_PROTECT` is defined.
    - Initialize the `ljoin` object by zeroing its memory and setting its `shmem` and `wksp` fields.
    - Join the transaction pool, transaction map, record map, and record pool using their respective join functions; log warnings and return NULL if any join fails.
    - Set the `alloc` field of `ljoin` and join the allocator; log a warning and return NULL if the join fails.
    - Return the initialized `ljoin` object.
- **Output**: Returns a pointer to the initialized `fd_funk_t` object if successful, or NULL if any checks or joins fail.
- **Functions Called**:
    - [`fd_funk_align`](<#fd_funk_align>)


---
### fd\_funk\_leave<!-- {{#callable:fd_funk_leave}} -->
[View Source →](<../../../../src/funk/fd_funk.c#L206>)

Clears the `fd_funk_t` structure and optionally returns its shared memory pointer.
- **Inputs**:
    - `funk`: A pointer to an `fd_funk_t` structure that will be cleared.
    - `opt_shfunk`: An optional pointer to a pointer where the function will store the shared memory pointer of `funk`.
- **Logic and Control Flow**:
    - Check if `funk` is NULL; if so, log a warning, set `*opt_shfunk` to NULL if `opt_shfunk` is not NULL, and return NULL.
    - Retrieve the shared memory pointer from `funk->shmem`.
    - Clear the `fd_funk_t` structure using `memset`.
    - If `opt_shfunk` is not NULL, set `*opt_shfunk` to the retrieved shared memory pointer.
    - Return the cleared `fd_funk_t` structure cast to a `void *`.
- **Output**: Returns a pointer to the cleared `fd_funk_t` structure, or NULL if `funk` was NULL.


---
### fd\_funk\_delete<!-- {{#callable:fd_funk_delete}} -->
[View Source →](<../../../../src/funk/fd_funk.c#L223>)

Deletes a `fd_funk` instance by freeing its resources and resetting its state.
- **Inputs**:
    - `shfunk`: A pointer to the shared memory object representing the `fd_funk` instance to delete.
- **Logic and Control Flow**:
    - Check if `shfunk` is NULL; if so, log a warning and return NULL.
    - Check if `shfunk` is aligned according to [`fd_funk_align`](<#fd_funk_align>); if not, log a warning and return NULL.
    - Determine the workspace containing `shfunk`; if not found, log a warning and return NULL.
    - Cast `shfunk` to `fd_funk_shmem_t` and check its `magic` value; if it does not match `FD_FUNK_MAGIC`, log a warning and return NULL.
    - Join the allocator associated with `shfunk` using `fd_alloc_join`.
    - Join the record map using `fd_funk_rec_map_join`; if it fails, log an error and return NULL.
    - Iterate over each chain in the record map and flush each record using [`fd_funk_val_flush`](<fd_funk_val.h.md#fd_funk_val_flush>).
    - Leave the record map using `fd_funk_rec_map_leave`.
    - Delete the allocator instance using `fd_alloc_delete` and free its address using `fd_wksp_free_laddr`.
    - Reset the `magic` field of `shmem` to 0 using memory fences to ensure proper ordering.
- **Output**: Returns the pointer to the `fd_funk_shmem_t` instance if successful, or NULL if any checks fail.
- **Functions Called**:
    - [`fd_funk_align`](<#fd_funk_align>)
    - [`fd_funk_val_flush`](<fd_funk_val.h.md#fd_funk_val_flush>)


---
### fd\_funk\_delete\_fast<!-- {{#callable:fd_funk_delete_fast}} -->
[View Source →](<../../../../src/funk/fd_funk.c#L284>)

Releases a shared memory object from a workspace by freeing its associated tag.
- **Inputs**:
    - `shfunk`: A pointer to the shared memory object to be deleted.
- **Logic and Control Flow**:
    - Check if `shfunk` is NULL and log a warning if true.
    - Check if `shfunk` is not aligned according to `fd_funk_align()` and log a warning if true.
    - Cast `shfunk` to `fd_funk_shmem_t *` and store it in `shmem`.
    - Check if `shmem->magic` is not equal to `FD_FUNK_MAGIC` and log a warning if true.
    - Retrieve the workspace containing `shmem` using `fd_wksp_containing()` and store it in `wksp`.
    - Check if `wksp` is NULL and log a warning if true.
    - Create an array `tags` with one element, `shmem->wksp_tag`.
    - Call `fd_wksp_tag_free()` to free the tag from the workspace.
- **Output**: No return value.
- **Functions Called**:
    - [`fd_funk_align`](<#fd_funk_align>)


---
### fd\_funk\_verify<!-- {{#callable:fd_funk_verify}} -->
[View Source →](<../../../../src/funk/fd_funk.c#L310>)

Verifies the integrity and consistency of a `fd_funk_t` structure and its associated components.
- **Inputs**:
    - `join`: A pointer to a `fd_funk_t` structure that represents the joined state of a funk instance.
- **Logic and Control Flow**:
    - Check if `funk` is not NULL.
    - Verify that `funk->magic` equals `FD_FUNK_MAGIC`.
    - Check if `funk_gaddr` is valid and matches the workspace address of `funk`.
    - Verify that `wksp_tag` is non-zero.
    - Ensure `funk->cycle_tag` is greater than 2.
    - Check that `txn_max` is less than or equal to `FD_FUNK_TXN_IDX_NULL`.
    - Verify `txn_map_gaddr` is valid and matches the expected transaction map properties.
    - Check the consistency of child transaction indices (`child_head_idx` and `child_tail_idx`).
    - Ensure the root transaction ID is valid and equals the root.
    - Verify `last_publish` is not NULL.
    - Check the validity of the transaction map using [`fd_funk_txn_verify`](<fd_funk_txn.c.md#fd_funk_txn_verify>).
    - Verify `rec_max` is less than or equal to `FD_FUNK_TXN_IDX_NULL`.
    - Check `rec_map_gaddr` is valid and matches the expected record map properties.
    - Verify the record map using [`fd_funk_rec_verify`](<fd_funk_rec.c.md#fd_funk_rec_verify>).
    - Check `alloc_gaddr` is valid and `alloc` is not NULL.
    - Verify the values using [`fd_funk_val_verify`](<fd_funk_val.c.md#fd_funk_val_verify>).
- **Output**: Returns `FD_FUNK_SUCCESS` if all checks pass, otherwise returns `FD_FUNK_ERR_INVAL` if any check fails.
- **Functions Called**:
    - [`fd_funk_wksp`](<fd_funk.h.md#fd_funk_wksp>)
    - [`fd_funk_wksp_tag`](<fd_funk.h.md#fd_funk_wksp_tag>)
    - [`fd_funk_txn_idx`](<fd_funk_txn.h.md#fd_funk_txn_idx>)
    - [`fd_funk_txn_idx_is_null`](<fd_funk_txn.h.md#fd_funk_txn_idx_is_null>)
    - [`fd_funk_root`](<fd_funk.h.md#fd_funk_root>)
    - [`fd_funk_txn_xid_eq_root`](<fd_funk_base.h.md#fd_funk_txn_xid_eq_root>)
    - [`fd_funk_txn_verify`](<fd_funk_txn.c.md#fd_funk_txn_verify>)
    - [`fd_funk_rec_verify`](<fd_funk_rec.c.md#fd_funk_rec_verify>)
    - [`fd_funk_alloc`](<fd_funk.h.md#fd_funk_alloc>)
    - [`fd_funk_val_verify`](<fd_funk_val.c.md#fd_funk_val_verify>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)