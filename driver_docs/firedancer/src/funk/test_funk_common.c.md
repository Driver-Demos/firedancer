<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements transaction and record management functions for testing purposes in the Firedancer codebase.

# Purpose
The code is a C implementation of a transaction management system, which provides functionality for handling transactions (`txn_t`) and records (`rec_t`) within a data structure referred to as `funk_t`. The code includes functions to create, manage, and delete transactions and records, as well as to query and insert records. The primary operations include preparing, canceling, and publishing transactions, as well as querying and inserting records within the context of these transactions.

The code defines several static functions for internal operations, such as [`txn_unmap`](<#txn_unmap>), [`txn_leave`](<#txn_leave>), [`rec_leave`](<#rec_leave>), and [`rec_unmap`](<#rec_unmap>), which manage the linking and unlinking of transactions and records within the `funk_t` structure. The [`txn_prepare`](<#txn_prepare>), [`txn_cancel`](<#txn_cancel>), and [`txn_publish`](<#txn_publish>) functions provide the main transaction lifecycle operations, allowing transactions to be prepared, canceled, or published. The [`rec_query`](<#rec_query>), [`rec_query_global`](<#rec_query_global>), and [`rec_insert`](<#rec_insert>) functions handle record operations, enabling the querying and insertion of records within transactions. The [`funk_new`](<#funk_new>) and [`funk_delete`](<#funk_delete>) functions manage the creation and deletion of the `funk_t` structure, ensuring proper memory management. Additionally, utility functions like [`xid_unique`](<#xid_unique>) and [`key_eq`](<#key_eq>) support the generation of unique transaction identifiers and key comparison, respectively.
# Imports and Dependencies

---
- `test_funk_common.h`
- `stdlib.h`


# Functions

---
### txn\_unmap<!-- {{#callable:txn_unmap}} -->
[View Source →](<../../../../src/funk/test_funk_common.c#L6>)

Removes a transaction from a linked list and frees its memory.
- **Inputs**:
    - ``funk``: A pointer to a `funk_t` structure, which manages the transaction map and count.
    - ``txn``: A pointer to a `txn_t` structure, representing the transaction to unmap and free.
- **Logic and Control Flow**:
    - Retrieve the previous and next transactions linked to `txn` using `txn->map_prev` and `txn->map_next`.
    - If `prev` is not NULL, set `prev->map_next` to `next`; otherwise, set `funk->txn_map_head` to `next`.
    - If `next` is not NULL, set `next->map_prev` to `prev`; otherwise, set `funk->txn_map_tail` to `prev`.
    - Decrement the transaction count in `funk` by 1.
    - Free the memory allocated for `txn`.
- **Output**: No return value; the function operates by side effects on the `funk` and `txn` structures.


---
### txn\_leave<!-- {{#callable:txn_leave}} -->
[View Source →](<../../../../src/funk/test_funk_common.c#L23>)

Removes a transaction from its parent's child list or the main list in `funk`.
- **Inputs**:
    - ``funk``: A pointer to a `funk_t` structure, which manages transactions and records.
    - ``txn``: A pointer to a `txn_t` structure, representing the transaction to be removed.
- **Logic and Control Flow**:
    - Determine the head and tail pointers for the transaction's sibling list based on whether the transaction has a parent or not.
    - Retrieve the previous and next siblings of the transaction.
    - If the transaction has a previous sibling, update its `sibling_next` pointer to skip the current transaction; otherwise, update the head pointer to the next sibling.
    - If the transaction has a next sibling, update its `sibling_prev` pointer to skip the current transaction; otherwise, update the tail pointer to the previous sibling.
    - Return the transaction pointer.
- **Output**: Returns a pointer to the `txn_t` structure that was removed.


---
### rec\_leave<!-- {{#callable:rec_leave}} -->
[View Source →](<../../../../src/funk/test_funk_common.c#L41>)

Removes a record from a linked list within a transaction or a global context.
- **Inputs**:
    - ``funk``: A pointer to a `funk_t` structure, representing the global context or transaction manager.
    - ``rec``: A pointer to a `rec_t` structure, representing the record to be removed from the list.
- **Logic and Control Flow**:
    - Determine the head and tail pointers based on whether the record is part of a transaction or the global context.
    - Retrieve the previous and next records linked to the current record.
    - If a previous record exists, update its `next` pointer to skip the current record; otherwise, update the head pointer to the next record.
    - If a next record exists, update its `prev` pointer to skip the current record; otherwise, update the tail pointer to the previous record.
    - Return the record that was removed.
- **Output**: Returns a pointer to the `rec_t` structure that was removed from the list.


---
### rec\_unmap<!-- {{#callable:rec_unmap}} -->
[View Source →](<../../../../src/funk/test_funk_common.c#L59>)

Removes a record from a doubly linked list and frees its memory.
- **Inputs**:
    - ``funk``: A pointer to a `funk_t` structure, which contains the head and tail of the record map and the record count.
    - ``rec``: A pointer to a `rec_t` structure, representing the record to be removed from the map.
- **Logic and Control Flow**:
    - Retrieve the previous and next records in the map using `rec->map_prev` and `rec->map_next`.
    - If `map_prev` is not NULL, set `map_prev->map_next` to `map_next`; otherwise, set `funk->rec_map_head` to `map_next`.
    - If `map_next` is not NULL, set `map_next->map_prev` to `map_prev`; otherwise, set `funk->rec_map_tail` to `map_prev`.
    - Decrement the record count in `funk` by 1.
    - Free the memory allocated for `rec`.
- **Output**: No return value.


---
### txn\_prepare<!-- {{#callable:txn_prepare}} -->
[View Source →](<../../../../src/funk/test_funk_common.c#L78>)

Allocates and initializes a new transaction, linking it to the given parent transaction and the global transaction map.
- **Inputs**:
    - ``funk``: A pointer to a `funk_t` structure, which manages the global state of transactions.
    - ``parent``: A pointer to a `txn_t` structure representing the parent transaction, or `NULL` if there is no parent.
    - ``xid``: An unsigned long integer representing the unique transaction identifier.
- **Logic and Control Flow**:
    - Allocate memory for a new `txn_t` structure and check for successful allocation.
    - Initialize the transaction's `xid`, `rec_head`, and `rec_tail` to the provided `xid` and `NULL`, respectively.
    - Link the new transaction into the global transaction map by updating pointers in `funk` and the previous transaction, if any.
    - Increment the transaction count in `funk`.
    - Determine the appropriate head and tail pointers for the transaction's family based on whether a parent transaction is provided.
    - Link the new transaction into its family by updating sibling pointers and the parent's child pointers, if applicable.
    - Return the pointer to the newly created transaction.
- **Output**: A pointer to the newly created `txn_t` structure.


---
### txn\_cancel<!-- {{#callable:txn_cancel}} -->
[View Source →](<../../../../src/funk/test_funk_common.c#L125>)

Cancels a transaction by unmapping and freeing its records and then unmapping the transaction itself.
- **Inputs**:
    - ``funk``: A pointer to a `funk_t` structure, which represents the context or environment in which the transaction operates.
    - ``txn``: A pointer to a `txn_t` structure, which represents the transaction to be canceled.
- **Logic and Control Flow**:
    - Initialize `rec` to the head of the transaction's record list (`txn->rec_head`).
    - Iterate over each record in the transaction's record list.
    - For each record, store the next record in `next`, unmap the current record using [`rec_unmap`](<#rec_unmap>), and move to the next record.
    - After processing all records, call [`txn_cancel_children`](<test_funk_common.h.md#txn_cancel_children>) to handle any child transactions.
    - Call [`txn_leave`](<#txn_leave>) to detach the transaction from its parent or the global list.
    - Finally, call [`txn_unmap`](<#txn_unmap>) to unmap and free the transaction itself.
- **Output**: No return value; the function performs operations to cancel and clean up the specified transaction.
- **Functions Called**:
    - [`rec_unmap`](<#rec_unmap>)
    - [`txn_unmap`](<#txn_unmap>)
    - [`txn_leave`](<#txn_leave>)
    - [`txn_cancel_children`](<test_funk_common.h.md#txn_cancel_children>)


---
### txn\_publish<!-- {{#callable:txn_publish}} -->
[View Source →](<../../../../src/funk/test_funk_common.c#L141>)

Publishes a transaction and its ancestors, updating records and transaction relationships.
- **Inputs**:
    - `funk`: A pointer to a `funk_t` structure representing the transaction system.
    - `txn`: A pointer to a `txn_t` structure representing the transaction to publish.
    - `cnt`: An unsigned long integer representing the current count of published transactions.
- **Logic and Control Flow**:
    - If the transaction has a parent, recursively publish the parent transaction and update `cnt`.
    - Iterate over each record in the transaction's record list.
    - For each record, query for an existing record with the same key in the global context.
    - If an existing record is found, remove it from the map.
    - Update the record's transaction pointer to `NULL` and adjust its position in the global record list.
    - Cancel all sibling transactions of the current transaction.
    - Update the parent pointers of all child transactions to `NULL` and adjust the global child transaction list.
    - Set the `last_publish` field of `funk` to the transaction's ID (`xid`).
    - Unmap the transaction from the transaction map.
    - Return the incremented count of published transactions.
- **Output**: Returns the updated count of published transactions as an unsigned long integer.
- **Functions Called**:
    - [`txn_publish`](<#txn_publish>)
    - [`rec_query`](<#rec_query>)
    - [`rec_unmap`](<#rec_unmap>)
    - [`rec_leave`](<#rec_leave>)
    - [`txn_cancel_siblings`](<test_funk_common.h.md#txn_cancel_siblings>)
    - [`txn_unmap`](<#txn_unmap>)


---
### txn\_merge<!-- {{#callable:txn_merge}} -->
[View Source →](<../../../../src/funk/test_funk_common.c#L188>)

Merges records from a child transaction into its parent transaction.
- **Inputs**:
    - ``funk``: A pointer to a `funk_t` structure, which manages transactions and records.
    - ``txn``: A pointer to a `txn_t` structure, representing a childless only child of an unpublished transaction.
- **Logic and Control Flow**:
    - Initialize `dst_txn` as the parent of `txn`.
    - Iterate over each record in `txn` using a while loop.
    - For each record, query the parent transaction `dst_txn` for an existing record with the same key using [`rec_query`](<#rec_query>).
    - If a record with the same key exists in `dst_txn`, remove the old version using [`rec_unmap`](<#rec_unmap>) and [`rec_leave`](<#rec_leave>).
    - Update the current record's transaction pointer to `dst_txn`, set its previous pointer to the current tail of `dst_txn`, and set its next pointer to `NULL`.
    - If there is a previous record, update its next pointer to the current record; otherwise, set the head of `dst_txn` to the current record.
    - Update the tail of `dst_txn` to the current record.
    - Move to the next record in `txn`.
    - After processing all records, unmap `txn` from the transaction map using [`txn_unmap`](<#txn_unmap>) and [`txn_leave`](<#txn_leave>).
- **Output**: No return value; the function modifies the parent transaction by merging records from the child transaction.
- **Functions Called**:
    - [`rec_query`](<#rec_query>)
    - [`rec_unmap`](<#rec_unmap>)
    - [`rec_leave`](<#rec_leave>)
    - [`txn_unmap`](<#txn_unmap>)
    - [`txn_leave`](<#txn_leave>)


---
### rec\_query<!-- {{#callable:rec_query}} -->
[View Source →](<../../../../src/funk/test_funk_common.c#L226>)

Searches for a record with a specified key in a transaction or a funk structure.
- **Inputs**:
    - `funk`: A pointer to a `funk_t` structure, which represents the main data structure containing records and transactions.
    - `txn`: A pointer to a `txn_t` structure, which represents a transaction that may contain records.
    - `key`: An unsigned long integer representing the key of the record to search for.
- **Logic and Control Flow**:
    - Initialize `rec` to point to the head of the record list in the transaction if `txn` is not NULL, otherwise point to the head of the record list in `funk`.
    - Iterate through the linked list of records starting from `rec`.
    - For each record, check if the `key` matches the specified key.
    - If a matching record is found, exit the loop.
    - Return the record if found, otherwise return NULL.
- **Output**: A pointer to the `rec_t` structure representing the record with the specified key, or NULL if no such record is found.


---
### rec\_query\_global<!-- {{#callable:rec_query_global}} -->
[View Source →](<../../../../src/funk/test_funk_common.c#L235>)

Searches for a record with a given key in a transaction and its parent transactions, returning the first match found.
- **Inputs**:
    - ``funk``: A pointer to a `funk_t` structure, which represents the context or environment in which transactions and records are managed.
    - ``txn``: A pointer to a `txn_t` structure, representing the current transaction in which to start the search for the record.
    - ``key``: An unsigned long integer representing the key of the record to search for.
- **Logic and Control Flow**:
    - While `txn` is not null, call [`rec_query`](<#rec_query>) with `funk`, `txn`, and `key` to search for the record in the current transaction.
    - If [`rec_query`](<#rec_query>) returns a non-null record, return this record immediately.
    - If no record is found, set `txn` to its parent transaction and repeat the search.
    - If all parent transactions are exhausted without finding the record, call [`rec_query`](<#rec_query>) with `funk`, a null transaction, and `key` to search in the global context.
    - Return the result of the final [`rec_query`](<#rec_query>) call.
- **Output**: A pointer to a `rec_t` structure representing the found record, or null if no record with the specified key is found.
- **Functions Called**:
    - [`rec_query`](<#rec_query>)


---
### rec\_insert<!-- {{#callable:rec_insert}} -->
[View Source →](<../../../../src/funk/test_funk_common.c#L247>)

Inserts a new record with a specified key into a transaction or global record map.
- **Inputs**:
    - `funk`: A pointer to a `funk_t` structure representing the global context or database.
    - `txn`: A pointer to a `txn_t` structure representing the transaction context, or `NULL` for global operations.
    - `key`: An unsigned long integer representing the key of the record to insert.
- **Logic and Control Flow**:
    - Call [`rec_query`](<#rec_query>) to check if a record with the given key already exists in the specified transaction or globally.
    - If the record exists, log an error indicating a user error and terminate the function.
    - Allocate memory for a new `rec_t` record structure.
    - If memory allocation fails, log an error indicating insufficient memory and terminate the function.
    - Initialize the new record's key with the provided key and set its value to 0.
    - Insert the new record into the global record map by updating the `map_prev` and `map_next` pointers and adjusting the head and tail pointers of the map.
    - Increment the global record count `rec_cnt`.
    - Associate the new record with the specified transaction by updating the `txn` pointer.
    - Insert the new record into the transaction's record list by updating the `prev` and `next` pointers and adjusting the head and tail pointers of the transaction's record list.
    - Return the pointer to the newly inserted record.
- **Output**: A pointer to the newly inserted `rec_t` record structure.
- **Functions Called**:
    - [`rec_query`](<#rec_query>)


---
### funk\_new<!-- {{#callable:funk_new}} -->
[View Source →](<../../../../src/funk/test_funk_common.c#L299>)

Allocates and initializes a new `funk_t` structure.
- **Inputs**: None
- **Logic and Control Flow**:
    - Allocate memory for a `funk_t` structure and assign it to the pointer `funk`.
    - Check if the memory allocation was successful; if not, log an error message.
    - Initialize `funk->last_publish` to `ULONG_MAX`.
    - Set `funk->child_head`, `funk->child_tail`, `funk->txn_map_head`, and `funk->txn_map_tail` to `NULL`.
    - Initialize `funk->txn_cnt` to `0UL`.
    - Set `funk->rec_head`, `funk->rec_tail`, `funk->rec_map_head`, and `funk->rec_map_tail` to `NULL`.
    - Initialize `funk->rec_cnt` to `0UL`.
    - Return the pointer `funk`.
- **Output**: A pointer to the newly allocated and initialized `funk_t` structure.


---
### funk\_delete<!-- {{#callable:funk_delete}} -->
[View Source →](<../../../../src/funk/test_funk_common.c#L320>)

Deletes a `funk_t` object and all its associated records and transactions.
- **Inputs**:
    - ``funk``: A pointer to the `funk_t` object to delete.
- **Logic and Control Flow**:
    - Calls [`txn_cancel_children`](<test_funk_common.h.md#txn_cancel_children>) to cancel all child transactions of `funk`.
    - Initializes `rec` to the head of the record map in `funk`.
    - Iterates over each record in the record map, freeing each record and moving to the next.
    - Frees the `funk` object itself.
- **Output**: No return value.
- **Functions Called**:
    - [`txn_cancel_children`](<test_funk_common.h.md#txn_cancel_children>)


---
### xid\_unique<!-- {{#callable:xid_unique}} -->
[View Source →](<../../../../src/funk/test_funk_common.c#L334>)

Generates a unique transaction identifier by incrementing a static counter.
- **Inputs**: None
- **Logic and Control Flow**:
    - Declare a static variable `xid` initialized to 0 of type `ulong`.
    - Increment the `xid` variable by 1.
    - Return the incremented value of `xid`.
- **Output**: Returns an incremented `ulong` value representing a unique transaction identifier.


---
### key\_eq<!-- {{#callable:key_eq}} -->
[View Source →](<../../../../src/funk/test_funk_common.c#L340>)

Compares a given key with a transformed version of an unsigned long key.
- **Inputs**:
    - ``key``: A pointer to a `fd_funk_rec_key_t` structure representing the key to compare.
    - ``_key``: An unsigned long integer representing the key to transform and compare.
- **Logic and Control Flow**:
    - Create a temporary `fd_funk_rec_key_t` array `tmp` with one element.
    - Transform the unsigned long `_key` into a `fd_funk_rec_key_t` using `key_set` and store it in `tmp`.
    - Call [`fd_funk_rec_key_eq`](<fd_funk_base.h.md#fd_funk_rec_key_eq>) to compare the original `key` with the transformed key in `tmp`.
    - Return the result of the comparison.
- **Output**: An integer result from [`fd_funk_rec_key_eq`](<fd_funk_base.h.md#fd_funk_rec_key_eq>), indicating whether the keys are equal.
- **Functions Called**:
    - [`fd_funk_rec_key_eq`](<fd_funk_base.h.md#fd_funk_rec_key_eq>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)