<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Header file for a high-performance hybrid database and version control system designed for blockchain applications, detailing data structures, memory management, and transaction handling.

# Purpose
The `fd_funk.h` file defines a hybrid system that combines elements of a database and a version control system, specifically designed for high-performance blockchain applications. The core data model is a flat table of records, where each record is a pair consisting of a transaction ID (`xid`) and a key-value pair. The system allows for efficient O(1) indexing of records by their `xid` or key, and supports operations such as creation, updating, and deletion of records. The transaction model is more advanced than typical databases, allowing for a rich history of updates that can be traced back to a root transaction. This model supports speculative work on multiple transaction branches, which is useful in blockchain applications where consensus might not be immediately achieved.

The file also outlines the memory management and concurrency model, which uses NUMA and TLB optimized shared memory to allow concurrent operations across multiple threads and processes. The system is designed to minimize algorithmic complexity and memory usage, with most operations being O(1) in time and space. The `fd_funk.h` file provides a set of functions and data structures for managing the lifecycle of a `funk` instance, including creation, joining, leaving, and deletion of instances. It also includes accessors for various internal components such as transaction maps, record maps, and memory allocators. The file ensures that operations are fortified against memory corruption and supports persistent and relocatable shared memory, allowing for seamless process restarts and real-time monitoring.
# Imports and Dependencies

---
- `fd_funk_val.h`


# Data Structures

---
### fd\_funk\_shmem\_private
- **Type**: ``struct``
- **Members**:
    - `magic`: Stores a magic number to identify the structure, set to `FD_FUNK_MAGIC`.
    - `funk_gaddr`: Holds the workspace global address of this structure, must be non-zero.
    - `wksp_tag`: Tag used for workspace allocations, must be positive.
    - `seed`: Seed for hashing functions, arbitrary value.
    - `cycle_tag`: Next cycle tag for internal data integrity checks.
    - `txn_max`: Maximum number of transactions that can be in preparation, up to `FD_FUNK_TXN_IDX_NULL`.
    - `txn_map_gaddr`: Workspace global address of the transaction map, must be non-zero.
    - `txn_pool_gaddr`: Workspace global address of the transaction pool.
    - `txn_ele_gaddr`: Workspace global address of the transaction elements.
    - `child_head_cidx`: Compressed index of the oldest child transaction, or `FD_FUNK_TXN_IDX_NULL` if none.
    - `child_tail_cidx`: Compressed index of the youngest child transaction, or `FD_FUNK_TXN_IDX_NULL` if none.
    - `root`: Array holding the root transaction ID.
    - `last_publish`: Array holding the ID of the last published transaction.
    - `rec_max`: Maximum number of records that can exist in this structure.
    - `rec_map_gaddr`: Workspace global address of the record map, must be non-zero.
    - `rec_pool_gaddr`: Workspace global address of the record pool.
    - `rec_ele_gaddr`: Workspace global address of the record elements.
    - `alloc_gaddr`: Workspace global address for allocation, must be non-zero.
- **Description**: The `fd_funk_shmem_private` structure is a data structure used in high-performance blockchain applications to manage transactions and records in a shared memory workspace. It includes metadata for identifying and managing the structure, such as magic numbers and workspace addresses, as well as fields for handling transactions and records, including maximum counts and global addresses for maps and pools. The structure supports transaction preparation and record management, with fields for tracking child transactions and published transaction IDs. It is aligned to `FD_FUNK_ALIGN` and designed for efficient memory use and integrity checks.


---
### fd\_funk\_private
- **Type**: ``struct``
- **Members**:
    - ``shmem``: Pointer to shared memory for the funk instance.
    - ``txn_map``: Array of transaction maps, each containing one element.
    - ``txn_pool``: Array of transaction pools, each containing one element.
    - ``rec_map``: Array of record maps, each containing one element.
    - ``rec_pool``: Array of record pools, each containing one element.
    - ``wksp``: Pointer to the workspace used by the funk instance.
    - ``alloc``: Pointer to the allocator used for record values.
- **Description**: Aligns to `FD_FUNK_JOIN_ALIGN` and encapsulates the core components of a funk instance, including shared memory, transaction and record maps and pools, workspace, and allocator pointers, facilitating high-performance operations in blockchain applications.


# Functions

---
### fd\_funk\_wksp<!-- {{#callable:fd_funk_wksp}} -->
[View Source →](<../../../../src/funk/fd_funk.h#L351>)

Returns the workspace associated with a given `fd_funk_t` instance.
- **Inputs**:
    - `funk`: A pointer to a constant `fd_funk_t` structure representing the current local join of a funk instance.
- **Logic and Control Flow**:
    - Accesses the `wksp` member of the `fd_funk_t` structure pointed to by `funk`.
    - Returns the value of the `wksp` member, which is a pointer to the workspace backing the funk.
- **Output**: A pointer to an `fd_wksp_t` structure representing the workspace associated with the funk instance.


---
### fd\_funk\_wksp\_tag<!-- {{#callable:fd_funk_wksp_tag}} -->
[View Source →](<../../../../src/funk/fd_funk.h#L357>)

Retrieves the workspace allocation tag used by the `fd_funk_t` instance for its workspace allocations.
- **Inputs**:
    - `funk`: A pointer to an `fd_funk_t` instance, which must be a current local join.
- **Logic and Control Flow**:
    - Access the `shmem` member of the `fd_funk_t` structure pointed to by `funk`.
    - Return the `wksp_tag` member of the `fd_funk_shmem_private` structure.
- **Output**: Returns an `ulong` representing the workspace allocation tag, which is a positive value.


---
### fd\_funk\_seed<!-- {{#callable:fd_funk_seed}} -->
[View Source →](<../../../../src/funk/fd_funk.h#L363>)

Retrieves the hash seed used by the `fd_funk_t` instance for various hash functions.
- **Inputs**:
    - `funk`: A pointer to an `fd_funk_t` structure, which must be a current local join.
- **Logic and Control Flow**:
    - Access the `shmem` member of the `fd_funk_t` structure pointed to by `funk`.
    - Return the `seed` member from the `shmem` structure.
- **Output**: Returns an `ulong` representing the hash seed used by the `fd_funk_t` instance.


---
### fd\_funk\_txn\_max<!-- {{#callable:fd_funk_txn_max}} -->
[View Source →](<../../../../src/funk/fd_funk.h#L369>)

Returns the maximum number of transactions that can be in preparation for a given `fd_funk_t` instance.
- **Inputs**:
    - `funk`: A pointer to an `fd_funk_t` instance, representing the funk object whose transaction capacity is being queried.
- **Logic and Control Flow**:
    - Accesses the `txn_pool` member of the `fd_funk_t` structure pointed to by `funk`.
    - Returns the `ele_max` member of the `txn_pool`, which indicates the maximum number of transactions that can be in preparation.
- **Output**: An unsigned long integer representing the maximum number of transactions that can be in preparation.


---
### fd\_funk\_root<!-- {{#callable:fd_funk_root}} -->
[View Source →](<../../../../src/funk/fd_funk.h#L409>)

Returns a pointer to the transaction ID of the root transaction in the given funk instance.
- **Inputs**:
    - `funk`: A pointer to a constant `fd_funk_t` structure representing the funk instance.
- **Logic and Control Flow**:
    - Accesses the `shmem` member of the `funk` structure.
    - Returns the `root` member of the `shmem` structure, which is a pointer to the root transaction ID.
- **Output**: A constant pointer to `fd_funk_txn_xid_t`, representing the root transaction ID.


---
### fd\_funk\_last\_publish<!-- {{#callable:fd_funk_last_publish}} -->
[View Source →](<../../../../src/funk/fd_funk.h#L417>)

Returns a pointer to the transaction ID of the last published transaction in the `fd_funk_t` instance.
- **Inputs**:
    - `funk`: A pointer to a constant `fd_funk_t` structure representing the current local join of the funk instance.
- **Logic and Control Flow**:
    - Accesses the `last_publish` member of the `shmem` structure within the `fd_funk_t` instance.
    - Returns the pointer to the `last_publish` transaction ID.
- **Output**: A constant pointer to `fd_funk_txn_xid_t`, representing the transaction ID of the last published transaction.


---
### fd\_funk\_last\_publish\_is\_frozen<!-- {{#callable:fd_funk_last_publish_is_frozen}} -->
[View Source →](<../../../../src/funk/fd_funk.h#L423>)

Checks if the last published transaction in the `fd_funk_t` instance is frozen by verifying if it has any child transactions.
- **Inputs**:
    - `funk`: A pointer to a constant `fd_funk_t` structure representing the funk instance to check.
- **Logic and Control Flow**:
    - Retrieve the `child_head_cidx` from the `shmem` member of the `funk` structure.
    - Call [`fd_funk_txn_idx`](<fd_funk_txn.h.md#fd_funk_txn_idx>) with `child_head_cidx` to get the transaction index.
    - Compare the transaction index with `FD_FUNK_TXN_IDX_NULL`.
    - Return 1 if the index is not equal to `FD_FUNK_TXN_IDX_NULL`, indicating the last published transaction is frozen.
    - Return 0 if the index is equal to `FD_FUNK_TXN_IDX_NULL`, indicating the last published transaction is not frozen.
- **Output**: Returns an integer: 1 if the last published transaction is frozen (has children), or 0 if it is not frozen (childless).
- **Functions Called**:
    - [`fd_funk_txn_idx`](<fd_funk_txn.h.md#fd_funk_txn_idx>)


---
### fd\_funk\_rec\_max<!-- {{#callable:fd_funk_rec_max}} -->
[View Source →](<../../../../src/funk/fd_funk.h#L432>)

Returns the maximum number of records that can be held in the `fd_funk_t` instance.
- **Inputs**:
    - `funk`: A pointer to an `fd_funk_t` instance, representing the funk object whose record capacity is being queried.
- **Logic and Control Flow**:
    - Accesses the `rec_pool` member of the `fd_funk_t` structure pointed to by `funk`.
    - Returns the `ele_max` member of the `rec_pool`, which indicates the maximum number of records.
- **Output**: An unsigned long integer representing the maximum number of records that the funk can hold.


---
### fd\_funk\_alloc<!-- {{#callable:fd_funk_alloc}} -->
[View Source →](<../../../../src/funk/fd_funk.h#L447>)

Returns a pointer to the allocator used by the `fd_funk_t` instance.
- **Inputs**:
    - `funk`: A pointer to an `fd_funk_t` instance, which represents a local join to a funk instance.
- **Logic and Control Flow**:
    - Accesses the `alloc` member of the `fd_funk_t` structure pointed to by `funk`.
    - Returns the value of the `alloc` member, which is a pointer to the `fd_alloc_t` allocator.
- **Output**: A pointer to the `fd_alloc_t` allocator associated with the `fd_funk_t` instance.


---
### fd\_funk\_rec\_is\_full<!-- {{#callable:fd_funk_rec_is_full}} -->
[View Source →](<../../../../src/funk/fd_funk.h#L452>)

Checks if the record pool in the `fd_funk_t` structure is empty, indicating that no more records can be allocated.
- **Inputs**:
    - `funk`: A pointer to an `fd_funk_t` structure, which represents the current state of the funk instance.
- **Logic and Control Flow**:
    - Calls the function `fd_funk_rec_pool_is_empty` with `funk->rec_pool` as the argument.
    - Returns the result of `fd_funk_rec_pool_is_empty`, which is 1 if the record pool is empty and 0 otherwise.
- **Output**: Returns 1 if the record pool is empty (indicating it is full and cannot allocate more records), otherwise returns 0.


---
### fd\_funk\_txn\_is\_full<!-- {{#callable:fd_funk_txn_is_full}} -->
[View Source →](<../../../../src/funk/fd_funk.h#L460>)

Checks if the transaction pool in a `fd_funk_t` instance is empty, indicating that no more in-preparation transactions are allowed.
- **Inputs**:
    - `funk`: A pointer to a `fd_funk_t` structure, which represents the current state of the funk instance.
- **Logic and Control Flow**:
    - Calls the function `fd_funk_txn_pool_is_empty` with `funk->txn_pool` as the argument.
    - Returns the result of `fd_funk_txn_pool_is_empty`, which is an integer indicating whether the transaction pool is empty.
- **Output**: Returns an integer: 1 if the transaction pool is empty (indicating it is full and no more transactions can be prepared), or 0 otherwise.


# Function Declarations (Public API)

---
### fd\_funk\_align<!-- {{#callable_declaration:fd_funk_align}} -->
[View Source →](<../../../../src/funk/fd_funk.h#L262>)

Return the alignment requirement for a funk.
- **Description**: Use this function to obtain the alignment requirement for a funk instance. This alignment is necessary when allocating memory for a funk to ensure proper memory access and performance. The alignment value is a constant and is a power of 2, which is typical for memory alignment requirements in systems programming.
- **Inputs**: None
- **Output**: Returns an unsigned long integer representing the alignment requirement for a funk.
- **See Also**: [`fd_funk_align`](<fd_funk.c.md#fd_funk_align>)  (Implementation)


---
### fd\_funk\_footprint<!-- {{#callable_declaration:fd_funk_footprint}} -->
[View Source →](<../../../../src/funk/fd_funk.h#L275>)

Calculates the memory footprint for a funk instance.
- **Description**: Use this function to determine the memory size required for a funk instance and its auxiliary data structures based on the maximum number of transactions and records. This function is useful for planning memory allocation in applications that use the funk system. It returns zero if the maximum number of records exceeds the allowable limit, indicating an invalid configuration.
- **Inputs**:
    - `txn_max`: The maximum number of transactions that can be in preparation. Must be a non-negative integer.
    - `rec_max`: The maximum number of records that can be held. Must be a non-negative integer and not exceed `UINT_MAX`. If `rec_max` is greater than `UINT_MAX`, the function returns zero.
- **Output**: Returns the calculated memory footprint in bytes as an unsigned long integer. Returns zero if `rec_max` exceeds `UINT_MAX`.
- **See Also**: [`fd_funk_footprint`](<fd_funk.c.md#fd_funk_footprint>)  (Implementation)


---
### fd\_funk\_new<!-- {{#callable_declaration:fd_funk_new}} -->
[View Source →](<../../../../src/funk/fd_funk.h#L292>)

Creates a new funk instance in shared memory.
- **Description**: Use this function to initialize a new funk instance in a shared memory region. The function requires a valid shared memory pointer, a workspace tag, a seed for hashing, and maximum limits for transactions and records. It returns a pointer to the initialized funk instance on success or NULL on failure. Preconditions include ensuring the shared memory is part of a workspace and properly aligned. The workspace tag must be non-zero, and the maximum transaction and record counts must not exceed their respective limits. This function logs warnings for invalid inputs and does not join the caller to the funk instance.
- **Inputs**:
    - `shmem`: Pointer to the shared memory region where the funk instance will be created. Must not be null and must be aligned according to `fd_funk_align()`. The shared memory must be part of a workspace.
    - `wksp_tag`: Unsigned long representing the workspace tag for allocations. Must be a positive, non-zero value.
    - `seed`: Unsigned long used as a seed for hashing functions. Can be any arbitrary value.
    - `txn_max`: Unsigned long specifying the maximum number of transactions in preparation. Must not exceed `FD_FUNK_TXN_IDX_NULL`.
    - `rec_max`: Unsigned long specifying the maximum number of records. Must not exceed `UINT_MAX`.
- **Output**: Returns a pointer to the initialized funk instance on success, or NULL on failure.
- **See Also**: [`fd_funk_new`](<fd_funk.c.md#fd_funk_new>)  (Implementation)


---
### fd\_funk\_join<!-- {{#callable_declaration:fd_funk_join}} -->
[View Source →](<../../../../src/funk/fd_funk.h#L310>)

Joins a caller to a funk instance.
- **Description**: Use this function to join a caller to a funk instance, allowing interaction with the funk's data structures. Ensure that `ljoin` points to a valid memory region in the caller's address space and `shfunk` points to the memory region backing the funk. This function returns a handle to the local join on success, or NULL on failure. It is important to match every successful join with a corresponding leave to maintain proper resource management. The function logs details of any failure, such as NULL or misaligned inputs, or if `shfunk` is not backed by a workspace.
- **Inputs**:
    - `ljoin`: A pointer to a `fd_funk_t` compatible memory region in the caller's address space. Must not be NULL. The caller transfers ownership of this region to the join.
    - `shfunk`: A pointer to the first byte of the memory region backing the funk in the caller's address space. Must not be NULL and must be aligned according to `fd_funk_align()`. The memory must be part of a workspace and have a valid magic number.
- **Output**: Returns a handle to the caller's local join on success, or NULL on failure.
- **See Also**: [`fd_funk_join`](<fd_funk.c.md#fd_funk_join>)  (Implementation)


---
### fd\_funk\_leave<!-- {{#callable_declaration:fd_funk_leave}} -->
[View Source →](<../../../../src/funk/fd_funk.h#L319>)

Leaves a funk join and optionally retrieves the shared memory pointer.
- **Description**: Use this function to leave a previously joined funk instance. It is important to call this function to properly release resources associated with the join. If the `funk` parameter is null, the function logs a warning and returns null. This function can also provide the shared memory pointer of the funk if the `opt_shfunk` parameter is not null. Ensure that the funk instance is valid and currently joined before calling this function.
- **Inputs**:
    - `funk`: A pointer to the funk instance to leave. Must not be null. If null, the function logs a warning and returns null.
    - `opt_shfunk`: An optional pointer to a void pointer where the shared memory pointer of the funk will be stored. Can be null if the shared memory pointer is not needed.
- **Output**: Returns a pointer to the memory region used for the join on success, or null if the `funk` parameter is null.
- **See Also**: [`fd_funk_leave`](<fd_funk.c.md#fd_funk_leave>)  (Implementation)


---
### fd\_funk\_delete<!-- {{#callable_declaration:fd_funk_delete}} -->
[View Source →](<../../../../src/funk/fd_funk.h#L330>)

Unformats a workspace allocation used as a funk.
- **Description**: Use this function to remove the formatting of a workspace allocation that was previously used as a funk. It also frees all workspace allocations associated with that funk. Ensure that no threads are joined to the funk before calling this function. It returns the original shared memory pointer on success or NULL on failure. Failures can occur if the input is NULL, misaligned, or not part of a workspace.
- **Inputs**:
    - `shfunk`: A pointer to the shared memory region representing the funk. Must not be NULL, must be properly aligned, and must be part of a workspace. If these conditions are not met, the function logs a warning and returns NULL.
- **Output**: Returns the original shared memory pointer on success, or NULL on failure.
- **See Also**: [`fd_funk_delete`](<fd_funk.c.md#fd_funk_delete>)  (Implementation)


---
### fd\_funk\_delete\_fast<!-- {{#callable_declaration:fd_funk_delete_fast}} -->
[View Source →](<../../../../src/funk/fd_funk.h#L342>)

Deletes a funk instance and its associated workspace allocations.
- **Description**: Use this function to delete a funk instance and free all associated workspace allocations. It is an optimized version of `fd_funk_delete` and assumes that the funk was created with a unique workspace tag distinct from other tags in the workspace. This function should be used when you are certain that no other allocations in the workspace share the same tag, as it will free all allocations with the matching tag. Ensure that no threads are joined to the funk before calling this function.
- **Inputs**:
    - `shfunk`: A pointer to the funk instance to delete. Must not be null, must be aligned according to `fd_funk_align()`, and must be part of a workspace. If these conditions are not met, the function logs a warning and does not perform the deletion.
- **Output**: None
- **See Also**: [`fd_funk_delete_fast`](<fd_funk.c.md#fd_funk_delete_fast>)  (Implementation)


---
### fd\_funk\_verify<!-- {{#callable_declaration:fd_funk_verify}} -->
[View Source →](<../../../../src/funk/fd_funk.h#L472>)

Verifies the integrity of a funk instance.
- **Description**: Use this function to check the integrity of a funk instance. It should be called when you need to ensure that the funk instance is intact and functioning correctly. This function must be called on a valid local join of a funk instance. If the provided funk instance is null or invalid, the function will return an error code and log details of the failure.
- **Inputs**:
    - `join`: A pointer to a `fd_funk_t` structure representing a local join of a funk instance. This must not be null and must point to a valid funk instance. If invalid, the function returns an error code.
- **Output**: Returns `FD_FUNK_SUCCESS` if the funk instance is intact, or `FD_FUNK_ERR_INVAL` if it is not.
- **See Also**: [`fd_funk_verify`](<fd_funk.c.md#fd_funk_verify>)  (Implementation)



---
Made with ❤️ by [Driver](https://www.driver.ai/)