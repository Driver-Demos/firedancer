<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements the record map for the Firedancer database, including transaction management and verification.

# Purpose
The code is a C source file that implements a record management system for a transactional database. It provides functionality to manage records within a transactional context, including querying, preparing, and publishing records. The code defines a record pool and a record map, which are used to manage the storage and retrieval of records. The record pool is defined using macros such as `POOL_NAME`, `POOL_ELE_T`, and `POOL_IDX_T`, which are included from a template file. Similarly, the record map is defined using macros like `MAP_NAME`, `MAP_ELE_T`, and `MAP_KEY_T`, which are also included from a template file.

The file includes several static functions that handle transactions and records, such as [`fd_funk_rec_txn_borrow`](<#fd_funk_rec_txn_borrow>), [`fd_funk_rec_txn_release`](<#fd_funk_rec_txn_release>), and [`fd_funk_rec_key_set_pair`](<#fd_funk_rec_key_set_pair>). These functions manage the lifecycle of transactions and records, ensuring that records are correctly associated with transactions and that data integrity is maintained. The file also includes functions for querying records ([`fd_funk_rec_query_try`](<#fd_funk_rec_query_try>) and [`fd_funk_rec_query_try_global`](<#fd_funk_rec_query_try_global>)), preparing records for modification ([`fd_funk_rec_prepare`](<#fd_funk_rec_prepare>)), and publishing records ([`fd_funk_rec_publish`](<#fd_funk_rec_publish>)). Additionally, the file contains a verification function, [`fd_funk_rec_verify`](<#fd_funk_rec_verify>), which checks the integrity of the record map and pool. The code is designed to be part of a larger system, as indicated by the inclusion of header files and template files, and it defines internal functions that are not intended to be part of a public API.
# Imports and Dependencies

---
- `fd_funk_private.h`
- `../util/racesan/fd_racesan_target.h`
- `../util/tmpl/fd_pool_para.c`
- `../util/tmpl/fd_map_chain_para.c`


# Functions

---
### fd\_funk\_rec\_txn\_borrow<!-- {{#callable:fd_funk_rec_txn_borrow}} -->
[View Source →](<../../../../src/funk/fd_funk_rec.c#L28>)

Attempts to borrow a transaction from the transaction map using a given transaction ID, ensuring it is active and not the last published transaction.
- **Inputs**:
    - ``funk``: A pointer to a `fd_funk_t` structure representing the current funk context.
    - ``xid``: A pointer to a `fd_funk_txn_xid_t` structure representing the transaction ID to query.
    - ``query``: A pointer to a `fd_funk_txn_map_query_t` structure to store the query result.
- **Logic and Control Flow**:
    - Initialize the `query` structure to zero.
    - Check if the transaction ID `xid` is equal to the last published transaction ID in `funk`; if so, return `NULL`.
    - Enter a loop to attempt querying the transaction map with `fd_funk_txn_map_query_try`.
    - If the query returns `FD_MAP_ERR_AGAIN`, retry the query.
    - If the query fails with an error other than `FD_MAP_SUCCESS`, log a critical error and exit.
    - Retrieve the transaction element from the query result using `fd_funk_txn_map_query_ele`.
    - Check if the transaction state is `FD_FUNK_TXN_STATE_ACTIVE`; if not, log a critical error and exit.
    - Return the transaction pointer.
- **Output**: A pointer to a `fd_funk_txn_t` structure representing the borrowed transaction, or `NULL` if the transaction is the last published one.
- **Functions Called**:
    - [`fd_funk_txn_xid_eq`](<fd_funk_base.h.md#fd_funk_txn_xid_eq>)
    - [`fd_funk_txn_state_str`](<fd_funk_txn.h.md#fd_funk_txn_state_str>)


---
### fd\_funk\_rec\_txn\_release<!-- {{#callable:fd_funk_rec_txn_release}} -->
[View Source →](<../../../../src/funk/fd_funk_rec.c#L56>)

Releases a transaction query if it is valid and logs a critical error if a data race is detected.
- **Inputs**:
    - ``query``: A pointer to a constant `fd_funk_txn_map_query_t` structure that represents the transaction query to release.
- **Logic and Control Flow**:
    - Check if `query->ele` is NULL; if so, return immediately.
    - Call `fd_funk_txn_map_query_test` with `query` to verify the query's validity.
    - If the test does not return `FD_MAP_SUCCESS`, log a critical error indicating a potential data race.
- **Output**: No output is returned as the function is of type `void`.


---
### fd\_funk\_rec\_key\_set\_pair<!-- {{#callable:fd_funk_rec_key_set_pair}} -->
[View Source →](<../../../../src/funk/fd_funk_rec.c#L64>)

Copies the transaction ID and record key into a key pair structure.
- **Inputs**:
    - ``key_pair``: A pointer to an `fd_funk_xid_key_pair_t` structure where the transaction ID and record key will be stored.
    - ``xid``: A constant pointer to an `fd_funk_txn_xid_t` structure representing the transaction ID to be copied.
    - ``key``: A constant pointer to an `fd_funk_rec_key_t` structure representing the record key to be copied.
- **Logic and Control Flow**:
    - Call [`fd_funk_txn_xid_copy`](<fd_funk_base.h.md#fd_funk_txn_xid_copy>) to copy the transaction ID from `xid` to `key_pair->xid`.
    - Call [`fd_funk_rec_key_copy`](<fd_funk_base.h.md#fd_funk_rec_key_copy>) to copy the record key from `key` to `key_pair->key`.
- **Output**: No return value; the function modifies the `key_pair` structure in place.
- **Functions Called**:
    - [`fd_funk_txn_xid_copy`](<fd_funk_base.h.md#fd_funk_txn_xid_copy>)
    - [`fd_funk_rec_key_copy`](<fd_funk_base.h.md#fd_funk_rec_key_copy>)


---
### fd\_funk\_rec\_query\_try<!-- {{#callable:fd_funk_rec_query_try}} -->
[View Source →](<../../../../src/funk/fd_funk_rec.c#L72>)

Attempts to query a record in the `fd_funk_rec_map` using a transaction ID and record key, returning the record if found.
- **Inputs**:
    - ``funk``: A pointer to an `fd_funk_t` structure representing the database context.
    - ``xid``: A constant pointer to an `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``key``: A constant pointer to an `fd_funk_rec_key_t` structure representing the record key.
    - ``query``: A pointer to an `fd_funk_rec_query_t` structure where the query result will be stored.
- **Logic and Control Flow**:
    - Check if any of the input pointers (`funk`, `xid`, `key`, `query`) are NULL and log a critical error if so.
    - Initialize a `fd_funk_xid_key_pair_t` structure `pair` and set its `xid` field to the root if `xid` matches `funk->shmem->last_publish`, otherwise copy `xid` to `pair->xid`.
    - Copy `key` to `pair->key`.
    - Enter a loop to attempt querying the record map using `fd_funk_rec_map_query_try`.
    - If the query is successful (`FD_MAP_SUCCESS`), break the loop.
    - If the query returns `FD_MAP_ERR_KEY`, return NULL indicating the record was not found.
    - If the query returns `FD_MAP_ERR_AGAIN`, continue the loop to retry the query.
    - Log a critical error if the query returns any other error code.
    - Return the record element from the query result using `fd_funk_rec_map_query_ele`.
- **Output**: Returns a pointer to the `fd_funk_rec_t` record if found, or NULL if the record is not found.
- **Functions Called**:
    - [`fd_funk_txn_xid_eq`](<fd_funk_base.h.md#fd_funk_txn_xid_eq>)
    - [`fd_funk_txn_xid_set_root`](<fd_funk_base.h.md#fd_funk_txn_xid_set_root>)
    - [`fd_funk_txn_xid_copy`](<fd_funk_base.h.md#fd_funk_txn_xid_copy>)
    - [`fd_funk_rec_key_copy`](<fd_funk_base.h.md#fd_funk_rec_key_copy>)


---
### fd\_funk\_rec\_query\_try\_global<!-- {{#callable:fd_funk_rec_query_try_global}} -->
[View Source →](<../../../../src/funk/fd_funk_rec.c#L100>)

Attempts to find a record in the global transaction context using a specified key and transaction ID.
- **Inputs**:
    - `funk`: A pointer to the `fd_funk_t` structure representing the global transaction context.
    - `xid`: A pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID to query.
    - `key`: A pointer to the `fd_funk_rec_key_t` structure representing the key of the record to find.
    - `txn_out`: A pointer to an `fd_funk_txn_xid_t` structure where the function will store the transaction ID of the found record, if any.
    - `query`: A pointer to an `fd_funk_rec_query_t` structure where the function will store query results.
- **Logic and Control Flow**:
    - Checks if `funk`, `key`, or `query` are NULL and logs a critical error if any are.
    - Initializes a transaction query and attempts to borrow a transaction using [`fd_funk_rec_txn_borrow`](<#fd_funk_rec_txn_borrow>).
    - Sets up a key pair using [`fd_funk_rec_key_set_pair`](<#fd_funk_rec_key_set_pair>) and calculates the hash and chain index for the record map.
    - Initializes a speculative record map transaction and attempts to lock the chain using `fd_funk_rec_map_txn_try`.
    - Iterates over the hash chain to find a record with a matching key using `fd_funk_rec_map_iter` and [`fd_funk_rec_key_eq`](<fd_funk_base.h.md#fd_funk_rec_key_eq>).
    - For each matching record, checks if it belongs to the transaction path from `txn` to the root using [`fd_funk_txn_xid_eq`](<fd_funk_base.h.md#fd_funk_txn_xid_eq>) or [`fd_funk_txn_xid_eq_root`](<fd_funk_base.h.md#fd_funk_txn_xid_eq_root>).
    - If a match is found, updates `txn_out` and `query` with the transaction ID and record, then exits the loop.
    - If the speculative transaction fails, retries the operation.
    - Releases the transaction query using [`fd_funk_rec_txn_release`](<#fd_funk_rec_txn_release>).
- **Output**: Returns a pointer to the found `fd_funk_rec_t` record if successful, or NULL if no matching record is found.
- **Functions Called**:
    - [`fd_funk_rec_txn_borrow`](<#fd_funk_rec_txn_borrow>)
    - [`fd_funk_rec_key_set_pair`](<#fd_funk_rec_key_set_pair>)
    - [`fd_funk_rec_key_eq`](<fd_funk_base.h.md#fd_funk_rec_key_eq>)
    - [`fd_funk_txn_xid_eq`](<fd_funk_base.h.md#fd_funk_txn_xid_eq>)
    - [`fd_funk_txn_xid_eq_root`](<fd_funk_base.h.md#fd_funk_txn_xid_eq_root>)
    - [`fd_funk_last_publish`](<fd_funk.h.md#fd_funk_last_publish>)
    - [`fd_funk_txn_xid_assert`](<fd_funk_txn.h.md#fd_funk_txn_xid_assert>)
    - [`fd_funk_rec_txn_release`](<#fd_funk_rec_txn_release>)


---
### fd\_funk\_rec\_prepare<!-- {{#callable:fd_funk_rec_prepare}} -->
[View Source →](<../../../../src/funk/fd_funk_rec.c#L189>)

Prepares a new record for a transaction in the Funk database system, handling transaction state and error conditions.
- **Inputs**:
    - ``funk``: A pointer to the `fd_funk_t` structure representing the Funk database context.
    - ``xid``: A pointer to the `fd_funk_txn_xid_t` structure representing the transaction ID.
    - ``key``: A pointer to the `fd_funk_rec_key_t` structure representing the record key.
    - ``prepare``: A pointer to the `fd_funk_rec_prepare_t` structure where preparation details will be stored.
    - ``opt_err``: An optional pointer to an integer where error codes will be stored if an error occurs.
- **Logic and Control Flow**:
    - Check if `funk`, `xid`, or `prepare` are NULL and log a critical error if any are.
    - Borrow a transaction using [`fd_funk_rec_txn_borrow`](<#fd_funk_rec_txn_borrow>) and store the result in `txn`.
    - Initialize the `prepare` structure to zero.
    - If `txn` is NULL, check if the last published transaction is frozen; if so, set `opt_err` to `FD_FUNK_ERR_FROZEN` and return NULL.
    - If `txn` is not NULL, check if the transaction is frozen; if so, set `opt_err` to `FD_FUNK_ERR_FROZEN` and return NULL.
    - Acquire a new record from the record pool using `fd_funk_rec_pool_acquire` and store it in `prepare->rec`.
    - If the record pool is corrupt, log a critical error.
    - If no record is acquired, set `opt_err` to `FD_FUNK_ERR_REC` and return NULL.
    - Initialize the record's value using [`fd_funk_val_init`](<fd_funk_val.h.md#fd_funk_val_init>).
    - Set the record's transaction ID and key based on whether `txn` is NULL or not.
    - Set the record's `tag`, `prev_idx`, and `next_idx` to initial values.
    - Release the transaction query using [`fd_funk_rec_txn_release`](<#fd_funk_rec_txn_release>).
    - Return the prepared record.
- **Output**: A pointer to the prepared `fd_funk_rec_t` record, or NULL if an error occurs.
- **Functions Called**:
    - [`fd_funk_rec_txn_borrow`](<#fd_funk_rec_txn_borrow>)
    - [`fd_funk_last_publish_is_frozen`](<fd_funk.h.md#fd_funk_last_publish_is_frozen>)
    - [`fd_funk_rec_txn_release`](<#fd_funk_rec_txn_release>)
    - [`fd_funk_txn_is_frozen`](<fd_funk_txn.h.md#fd_funk_txn_is_frozen>)
    - [`fd_funk_val_init`](<fd_funk_val.h.md#fd_funk_val_init>)
    - [`fd_funk_txn_xid_set_root`](<fd_funk_base.h.md#fd_funk_txn_xid_set_root>)
    - [`fd_funk_txn_xid_copy`](<fd_funk_base.h.md#fd_funk_txn_xid_copy>)
    - [`fd_funk_rec_key_copy`](<fd_funk_base.h.md#fd_funk_rec_key_copy>)


---
### fd\_funk\_rec\_push\_tail<!-- {{#callable:fd_funk_rec_push_tail}} -->
[View Source →](<../../../../src/funk/fd_funk_rec.c#L294>)

Appends a record to the tail of a doubly linked list within a transaction context.
- **Inputs**:
    - ``funk``: A pointer to the `fd_funk_t` structure, representing the transaction context.
    - ``prepare``: A pointer to the `fd_funk_rec_prepare_t` structure, containing the record to append and indices for the head and tail of the list.
- **Logic and Control Flow**:
    - Retrieve the record from the `prepare` structure and calculate its index in the record pool.
    - Retrieve the current tail index from `prepare` and update it to the new record index.
    - Set the previous index of the new record to the current tail index and its next index to `FD_FUNK_REC_IDX_NULL`.
    - If the current tail index is null, update the head index to the new record index.
    - Otherwise, update the next index of the current tail record to point to the new record index.
- **Output**: No return value; the function modifies the linked list structure in place.
- **Functions Called**:
    - [`fd_funk_rec_idx_is_null`](<fd_funk_rec.h.md#fd_funk_rec_idx_is_null>)


---
### fd\_funk\_rec\_publish<!-- {{#callable:fd_funk_rec_publish}} -->
[View Source →](<../../../../src/funk/fd_funk_rec.c#L314>)

Publishes a prepared record to the record map and updates its linked list pointers.
- **Inputs**:
    - ``funk``: A pointer to the `fd_funk_t` structure, which contains the record map and other related data.
    - ``prepare``: A pointer to the `fd_funk_rec_prepare_t` structure, which contains the prepared record and its linked list indices.
- **Logic and Control Flow**:
    - Set the `prev_idx` and `next_idx` of the record in `prepare` to `FD_FUNK_REC_IDX_NULL` to initialize the record's linked list pointers.
    - Check if `prepare->rec_head_idx` is not null, indicating that the record should be added to a linked list, and call `fd_funk_rec_push_tail` to append the record to the tail of the list.
    - Call `fd_racesan_hook` with the string "funk_rec_publish:map_insert" to insert a hook for race condition analysis.
    - Attempt to insert the record into the record map using `fd_funk_rec_map_insert` with `FD_MAP_FLAG_BLOCKING` flag.
    - If `fd_funk_rec_map_insert` returns an error, log a critical error message with the error code and description.
- **Output**: No return value; the function modifies the record map and linked list in place.


---
### fd\_funk\_rec\_verify<!-- {{#callable:fd_funk_rec_verify}} -->
[View Source →](<../../../../src/funk/fd_funk_rec.c#L332>)

Verifies the integrity and consistency of records and transactions in a `fd_funk_t` structure.
- **Inputs**:
    - ``funk``: A pointer to a `fd_funk_t` structure that contains the record map and pool to verify.
- **Logic and Control Flow**:
    - Define a macro `TEST` to log a warning and return `FD_FUNK_ERR_INVAL` if a condition is false.
    - Verify the record map and pool using `fd_funk_rec_map_verify` and `fd_funk_rec_pool_verify`.
    - Iterate over all record chains and verify each record's linkage and transaction status.
    - Clear all record tags in the pool and verify membership by iterating over all records and transactions.
    - Ensure that each record is correctly linked and tagged, and verify the consistency of the record list in each transaction.
- **Output**: Returns `FD_FUNK_SUCCESS` if all verifications pass, otherwise returns `FD_FUNK_ERR_INVAL` if any verification fails.
- **Functions Called**:
    - [`fd_funk_rec_xid`](<fd_funk_rec.h.md#fd_funk_rec_xid>)
    - [`fd_funk_txn_xid_eq_root`](<fd_funk_base.h.md#fd_funk_txn_xid_eq_root>)
    - [`fd_funk_rec_idx_is_null`](<fd_funk_rec.h.md#fd_funk_rec_idx_is_null>)
    - [`fd_funk_all_iter_new`](<fd_funk_private.h.md#fd_funk_all_iter_new>)
    - [`fd_funk_all_iter_done`](<fd_funk_private.h.md#fd_funk_all_iter_done>)
    - [`fd_funk_all_iter_next`](<fd_funk_private.h.md#fd_funk_all_iter_next>)
    - [`fd_funk_all_iter_ele`](<fd_funk_private.h.md#fd_funk_all_iter_ele>)
    - [`fd_funk_txn_all_iter_new`](<fd_funk_private.h.md#fd_funk_txn_all_iter_new>)
    - [`fd_funk_txn_all_iter_done`](<fd_funk_private.h.md#fd_funk_txn_all_iter_done>)
    - [`fd_funk_txn_all_iter_next`](<fd_funk_private.h.md#fd_funk_txn_all_iter_next>)
    - [`fd_funk_txn_all_iter_ele_const`](<fd_funk_private.h.md#fd_funk_txn_all_iter_ele_const>)
    - [`fd_funk_rec_query_try`](<#fd_funk_rec_query_try>)



---
Made with ❤️ by [Driver](https://www.driver.ai/)