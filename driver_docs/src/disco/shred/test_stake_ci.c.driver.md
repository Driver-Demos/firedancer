# Purpose
This C source code file is designed to test and validate the functionality of a staking and destination management system, likely within a blockchain or distributed ledger context. The code is structured around a series of test functions that simulate various scenarios involving the staking and unstaking of nodes, the addition and removal of destinations, and the transition of nodes between staked and unstaked states. The primary technical components include functions for generating stake messages, managing destination addresses, and verifying the correctness of destination assignments across different epochs. The code utilizes a series of static functions to encapsulate these operations, ensuring that the tests are self-contained and do not affect external state.

The file is not intended to be a standalone executable but rather a test suite for validating the behavior of the staking system. It includes a [`main`](#main) function that initializes the test environment, executes a series of test cases, and logs the results. The tests cover a wide range of scenarios, including transitions between staked and unstaked states, handling of identity changes, and validation of system limits. The code relies on a set of predefined constants and data structures, such as `fd_stake_ci_t` and `fd_shred_dest_weighted_t`, which are likely defined in the included header file "fd_stake_ci.h". The file does not define public APIs or external interfaces but instead focuses on internal validation of the staking logic.
# Imports and Dependencies

---
- `fd_stake_ci.h`


# Global Variables

---
### \_info
- **Type**: `fd_stake_ci_t[1]`
- **Description**: The variable `_info` is a global array of type `fd_stake_ci_t` with a single element. It is used to store information related to the stake cluster interface, which is likely part of a larger system managing stake distribution and validation in a network.
- **Use**: This variable is used to initialize and manage stake cluster information throughout the program, particularly in functions that handle stake message generation and destination checking.


---
### stake\_msg
- **Type**: `uchar array`
- **Description**: The `stake_msg` is a global variable defined as an array of unsigned characters with a size determined by the constant `FD_STAKE_CI_STAKE_MSG_SZ`. This array is used to store stake messages, which are likely related to the staking process in a distributed system.
- **Use**: The `stake_msg` array is used to hold data for stake messages generated by the `generate_stake_msg` function, which are then used in various staking operations and tests.


---
### identity\_key
- **Type**: `fd_pubkey_t[1]`
- **Description**: The `identity_key` is a global variable defined as an array of one `fd_pubkey_t` element. It is used to store a public key that represents the identity of a node or entity in the system.
- **Use**: This variable is used to initialize and manage the identity of a node in the stake management and testing functions.


# Data Structures

---
### stake\_msg\_hdr\_t
- **Type**: `struct`
- **Members**:
    - `epoch`: Represents the current epoch number.
    - `staked_cnt`: Indicates the count of staked entities.
    - `start_slot`: Denotes the starting slot number for the epoch.
    - `slot_cnt`: Specifies the number of slots in the epoch.
    - `excluded_stake`: Represents the amount of stake that is excluded.
    - `weights`: An array of fd_stake_weight_t structures representing the weights of the stakes.
- **Description**: The `stake_msg_hdr_t` structure is used to encapsulate information about staking in a given epoch. It includes details such as the epoch number, the count of staked entities, the starting slot, the number of slots in the epoch, and the amount of excluded stake. Additionally, it contains an array of `fd_stake_weight_t` structures that hold the weights of the stakes, allowing for dynamic allocation of stake weights based on the number of stakers.


# Functions

---
### generate\_stake\_msg<!-- {{#callable:generate_stake_msg}} -->
The `generate_stake_msg` function initializes a buffer with stake message data for a given epoch and list of stakers.
- **Inputs**:
    - `_buf`: A pointer to a buffer where the stake message will be stored.
    - `epoch`: An unsigned long integer representing the epoch number for which the stake message is being generated.
    - `stakers`: A constant character pointer to a string representing the list of stakers.
- **Control Flow**:
    - Cast the input buffer `_buf` to a `stake_msg_hdr_t` pointer `buf`.
    - Set the `epoch` field of `buf` to the input `epoch`.
    - Calculate and set the `start_slot` field of `buf` as `epoch * SLOTS_PER_EPOCH`.
    - Set the `slot_cnt` field of `buf` to `SLOTS_PER_EPOCH`.
    - Set the `staked_cnt` field of `buf` to the length of the `stakers` string.
    - Initialize the `excluded_stake` field of `buf` to 0.
    - Iterate over each character in the `stakers` string, setting the `key.uc` field of each `weights` entry in `buf` to the current staker character and calculating the `stake` as `1000UL/(i+1UL)` for each staker.
- **Output**: Returns the pointer to the buffer `_buf` containing the initialized stake message.


---
### generate\_dest\_add<!-- {{#callable:generate_dest_add}} -->
The `generate_dest_add` function initializes an array of `fd_shred_dest_weighted_t` structures with destination characters and a fixed stake value.
- **Inputs**:
    - `buf`: A pointer to an array of `fd_shred_dest_weighted_t` structures that will be initialized.
    - `destinations`: A constant character pointer representing a string of destination characters to be used for initialization.
- **Control Flow**:
    - Initialize a counter `i` to 0.
    - Iterate over each character in the `destinations` string until the null terminator is reached.
    - For each character, use `memset` to fill the `buf[i]` structure with the character value, effectively setting the `pubkey` field of the structure.
    - Set the `stake_lamports` field of `buf[i]` to the constant value `0xDEADBEEF0BADF00DUL`.
    - Increment the counter `i` after processing each character.
- **Output**: Returns the number of destination characters processed, which is the same as the number of initialized structures in the `buf` array.


---
### check\_destinations<!-- {{#callable:check_destinations}} -->
The `check_destinations` function verifies that the staked and unstaked destinations for a given epoch are consistent with expected values and checks the leader schedule for the epoch.
- **Inputs**:
    - `info`: A pointer to a constant `fd_stake_ci_t` structure containing stake configuration information.
    - `epoch`: An unsigned long integer representing the epoch number to check.
    - `staked_dests`: A constant character pointer to a string representing the expected staked destinations.
    - `unstaked_dests`: A constant character pointer to a string representing the expected unstaked destinations.
- **Control Flow**:
    - Calculate `min_slot` and `max_slot` for the given epoch using `SLOTS_PER_EPOCH`.
    - Check that the staked destination and leader schedule for the first and last slot of the epoch are the same using `FD_TEST`.
    - If `staked_dests` is NULL, verify that `unstaked_dests` is also NULL and that there are no staked destinations or leader schedules, then return.
    - Retrieve the staked destination for `min_slot` and verify it is not NULL.
    - Check that the number of staked and unstaked destinations matches the lengths of `staked_dests` and `unstaked_dests` respectively.
    - For each character in `staked_dests`, verify that it matches the corresponding public key in the staked destinations.
    - For each character in `unstaked_dests`, verify that it matches the corresponding public key in the unstaked destinations.
    - Retrieve the leader schedule for `min_slot` and verify that there are no leaders for slots outside the epoch range.
    - Count the number of leader slots for each character in `staked_dests` and verify that all slots are accounted for.
- **Output**: The function does not return a value; it performs checks and assertions to ensure the consistency of destination and leader schedule data.
- **Functions called**:
    - [`fd_stake_ci_get_sdest_for_slot`](fd_stake_ci.c.driver.md#fd_stake_ci_get_sdest_for_slot)
    - [`fd_stake_ci_get_lsched_for_slot`](fd_stake_ci.c.driver.md#fd_stake_ci_get_lsched_for_slot)
    - [`fd_shred_dest_cnt_staked`](fd_shred_dest.h.driver.md#fd_shred_dest_cnt_staked)
    - [`fd_shred_dest_idx_to_dest`](fd_shred_dest.h.driver.md#fd_shred_dest_idx_to_dest)
    - [`fd_shred_dest_cnt_unstaked`](fd_shred_dest.h.driver.md#fd_shred_dest_cnt_unstaked)


---
### test\_staked\_only<!-- {{#callable:test_staked_only}} -->
The `test_staked_only` function tests the behavior of the staking system by initializing, modifying, and verifying stake messages and their corresponding destinations across different epochs.
- **Inputs**: None
- **Control Flow**:
    - Initialize a `fd_stake_ci_t` structure using [`fd_stake_ci_new`](fd_stake_ci.c.driver.md#fd_stake_ci_new) and [`fd_stake_ci_join`](fd_stake_ci.c.driver.md#fd_stake_ci_join).
    - Generate and initialize a stake message for epoch 0 with stakers 'ABC', finalize it, and check destinations for epoch 0.
    - Generate and initialize a stake message for epoch 1 with stakers 'ABCDE', finalize it, and check destinations for epochs 0 and 1.
    - Generate and initialize a stake message for epoch 2 with stakers 'ABCF', finalize it, and check destinations for epochs 2 and 1.
    - Generate and initialize a stake message for epoch 3 with staker 'I', finalize it, and check destinations for epochs 2 and 3.
    - Clean up by leaving and deleting the `fd_stake_ci_t` structure.
- **Output**: The function does not return any value; it performs tests and assertions to verify the correctness of stake message handling and destination checking.
- **Functions called**:
    - [`fd_stake_ci_join`](fd_stake_ci.c.driver.md#fd_stake_ci_join)
    - [`fd_stake_ci_new`](fd_stake_ci.c.driver.md#fd_stake_ci_new)
    - [`fd_stake_ci_stake_msg_init`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_init)
    - [`generate_stake_msg`](#generate_stake_msg)
    - [`fd_stake_ci_stake_msg_fini`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_fini)
    - [`check_destinations`](#check_destinations)
    - [`fd_stake_ci_delete`](fd_stake_ci.c.driver.md#fd_stake_ci_delete)
    - [`fd_stake_ci_leave`](fd_stake_ci.c.driver.md#fd_stake_ci_leave)


---
### test\_unstaked\_only<!-- {{#callable:test_unstaked_only}} -->
The `test_unstaked_only` function tests the behavior of the staking system when only unstaked nodes are added and modified.
- **Inputs**: None
- **Control Flow**:
    - Initialize a `fd_stake_ci_t` structure by joining a new stake cluster info with an identity key.
    - Generate a stake message for epoch 0 with a single staked node 'I' and finalize it.
    - Check that the destinations for epoch 0 are correctly set to 'I' as staked and none as unstaked.
    - Add unstaked destinations 'ABC' and finalize, then check that the unstaked destinations are updated correctly.
    - Add unstaked destinations 'ABCDEF' and finalize, then check that the unstaked destinations are updated correctly.
    - Re-add unstaked destinations 'ABC' and finalize, then check that the unstaked destinations revert correctly.
    - Delete the stake cluster info by leaving the joined structure.
- **Output**: The function does not return any value; it performs tests and assertions to verify the correct behavior of the staking system.
- **Functions called**:
    - [`fd_stake_ci_join`](fd_stake_ci.c.driver.md#fd_stake_ci_join)
    - [`fd_stake_ci_new`](fd_stake_ci.c.driver.md#fd_stake_ci_new)
    - [`fd_stake_ci_stake_msg_init`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_init)
    - [`generate_stake_msg`](#generate_stake_msg)
    - [`fd_stake_ci_stake_msg_fini`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_fini)
    - [`check_destinations`](#check_destinations)
    - [`fd_stake_ci_dest_add_fini`](fd_stake_ci.c.driver.md#fd_stake_ci_dest_add_fini)
    - [`generate_dest_add`](#generate_dest_add)
    - [`fd_stake_ci_dest_add_init`](fd_stake_ci.c.driver.md#fd_stake_ci_dest_add_init)
    - [`fd_stake_ci_delete`](fd_stake_ci.c.driver.md#fd_stake_ci_delete)
    - [`fd_stake_ci_leave`](fd_stake_ci.c.driver.md#fd_stake_ci_leave)


---
### test\_transitions<!-- {{#callable:test_transitions}} -->
The `test_transitions` function tests various transitions between staked and unstaked states for a set of validators over multiple epochs, verifying the correctness of destination assignments.
- **Inputs**: None
- **Control Flow**:
    - Initialize a `fd_stake_ci_t` structure by joining a new instance with an identity key.
    - Generate and initialize a stake message for epoch 0 with stakers 'ABCD', finalize it, and add destinations 'ABCDEFGH'.
    - Check the destinations for epoch 0, expecting 'ABCD' staked and 'EFGHI' unstaked.
    - Transition half of the unstaked validators to staked by generating a stake message for epoch 1 with stakers 'ABCDEF', finalize it, and check destinations for epochs 0 and 1.
    - Transition the validators back by generating a stake message for epoch 2 with stakers 'AB', finalize it, and check destinations for epochs 1 and 2.
    - Completely swap the validators by generating a stake message for epoch 3 with stakers 'GI', finalize it, and check destinations for epochs 2 and 3.
    - Delete a bunch of unstaked validators by finalizing an empty destination addition, and check destinations for epochs 2 and 3.
    - Add new unstaked validators 'KL', finalize the addition, and check destinations for epochs 2 and 3.
    - Delete the `fd_stake_ci_t` structure by leaving and deleting the instance.
- **Output**: The function does not return any value; it performs tests and assertions to verify the correctness of transitions between staked and unstaked states.
- **Functions called**:
    - [`fd_stake_ci_join`](fd_stake_ci.c.driver.md#fd_stake_ci_join)
    - [`fd_stake_ci_new`](fd_stake_ci.c.driver.md#fd_stake_ci_new)
    - [`fd_stake_ci_stake_msg_init`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_init)
    - [`generate_stake_msg`](#generate_stake_msg)
    - [`fd_stake_ci_stake_msg_fini`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_fini)
    - [`fd_stake_ci_dest_add_fini`](fd_stake_ci.c.driver.md#fd_stake_ci_dest_add_fini)
    - [`generate_dest_add`](#generate_dest_add)
    - [`fd_stake_ci_dest_add_init`](fd_stake_ci.c.driver.md#fd_stake_ci_dest_add_init)
    - [`check_destinations`](#check_destinations)
    - [`fd_stake_ci_delete`](fd_stake_ci.c.driver.md#fd_stake_ci_delete)
    - [`fd_stake_ci_leave`](fd_stake_ci.c.driver.md#fd_stake_ci_leave)


---
### test\_startup<!-- {{#callable:test_startup}} -->
The `test_startup` function initializes and tests the behavior of a stake cluster information system by simulating stake messages and checking the resulting destinations for different epochs.
- **Inputs**: None
- **Control Flow**:
    - Initialize a stake cluster information object `info` using [`fd_stake_ci_join`](fd_stake_ci.c.driver.md#fd_stake_ci_join) and [`fd_stake_ci_new`](fd_stake_ci.c.driver.md#fd_stake_ci_new).
    - Check that no epoch information is known initially by calling [`check_destinations`](#check_destinations) with `NULL` for staked and unstaked destinations for epochs 0 and 1.
    - Simulate a stake message for epoch 0 with a single staker 'I' using [`fd_stake_ci_stake_msg_init`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_init) and [`generate_stake_msg`](#generate_stake_msg), then finalize with [`fd_stake_ci_stake_msg_fini`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_fini).
    - Verify the destinations for epoch 0, expecting 'I' as staked and no unstaked destinations.
    - Simulate a stake message for epoch 1 with a single staker 'A', finalize it, and check the destinations, expecting 'A' as staked and 'I' as unstaked.
    - Delete the current stake cluster information object using [`fd_stake_ci_delete`](fd_stake_ci.c.driver.md#fd_stake_ci_delete) and [`fd_stake_ci_leave`](fd_stake_ci.c.driver.md#fd_stake_ci_leave).
    - Reinitialize the stake cluster information object and simulate a stake message for epoch 0 with 'A' as the staker, finalize it, and check the destinations, expecting 'A' as staked and 'I' as unstaked.
    - Delete the stake cluster information object again.
- **Output**: The function does not return any value; it performs tests and assertions to verify the behavior of the stake cluster information system.
- **Functions called**:
    - [`fd_stake_ci_join`](fd_stake_ci.c.driver.md#fd_stake_ci_join)
    - [`fd_stake_ci_new`](fd_stake_ci.c.driver.md#fd_stake_ci_new)
    - [`check_destinations`](#check_destinations)
    - [`fd_stake_ci_stake_msg_init`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_init)
    - [`generate_stake_msg`](#generate_stake_msg)
    - [`fd_stake_ci_stake_msg_fini`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_fini)
    - [`fd_stake_ci_delete`](fd_stake_ci.c.driver.md#fd_stake_ci_delete)
    - [`fd_stake_ci_leave`](fd_stake_ci.c.driver.md#fd_stake_ci_leave)


---
### test\_skip\_ahead<!-- {{#callable:test_skip_ahead}} -->
The `test_skip_ahead` function tests the behavior of the staking system when epochs are skipped, ensuring that the system correctly handles non-sequential epoch updates and maintains accurate destination checks.
- **Inputs**: None
- **Control Flow**:
    - Initialize a `fd_stake_ci_t` object by joining a new stake cluster info instance with an identity key.
    - Generate and initialize a stake message for epoch 0 with stakers 'ABC', finalize the message, and check destinations for epoch 0.
    - Generate and initialize a stake message for epoch 1 with stakers 'ABCDE', finalize the message, and check destinations for epochs 0 and 1.
    - Simulate skipping a few epochs by generating and initializing a stake message for epoch 6 with stakers 'ABCF', finalize the message, and check destinations for epoch 6.
    - Generate and initialize a stake message for epoch 9 with stakers 'GH', finalize the message, and check destinations for epoch 9.
    - Delete the stake cluster info instance after leaving it.
- **Output**: The function does not return any value; it performs tests and assertions to verify the correct behavior of the staking system when epochs are skipped.
- **Functions called**:
    - [`fd_stake_ci_join`](fd_stake_ci.c.driver.md#fd_stake_ci_join)
    - [`fd_stake_ci_new`](fd_stake_ci.c.driver.md#fd_stake_ci_new)
    - [`fd_stake_ci_stake_msg_init`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_init)
    - [`generate_stake_msg`](#generate_stake_msg)
    - [`fd_stake_ci_stake_msg_fini`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_fini)
    - [`check_destinations`](#check_destinations)
    - [`fd_stake_ci_delete`](fd_stake_ci.c.driver.md#fd_stake_ci_delete)
    - [`fd_stake_ci_leave`](fd_stake_ci.c.driver.md#fd_stake_ci_leave)


---
### test\_cancel<!-- {{#callable:test_cancel}} -->
The `test_cancel` function tests the behavior of stake and destination management when certain operations are intentionally left incomplete.
- **Inputs**: None
- **Control Flow**:
    - Initialize a `fd_stake_ci_t` structure by joining a new stake cluster info instance.
    - Generate and initialize a stake message for epoch 0 with stakers 'ABC', then finalize it.
    - Check the destinations for epoch 0, expecting 'ABC' as staked and 'I' as unstaked.
    - Generate and initialize a stake message for epoch 1 with stakers 'ABCDE', but do not finalize it.
    - Check the destinations for epoch 0 and 1, expecting 'ABC' as staked and 'I' as unstaked for epoch 0, and no destinations for epoch 1.
    - Add destinations 'EFG' and finalize the addition, then check the destinations for epoch 0 and 1, expecting 'ABC' as staked and 'EFGI' as unstaked for epoch 0, and no destinations for epoch 1.
    - Generate additional destinations 'EFGHIJ' without finalizing, then check the destinations again, expecting the same results as before.
    - Delete the stake cluster info instance by leaving and deleting the `fd_stake_ci_t` structure.
- **Output**: The function does not return any value; it performs tests and checks using assertions.
- **Functions called**:
    - [`fd_stake_ci_join`](fd_stake_ci.c.driver.md#fd_stake_ci_join)
    - [`fd_stake_ci_new`](fd_stake_ci.c.driver.md#fd_stake_ci_new)
    - [`fd_stake_ci_stake_msg_init`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_init)
    - [`generate_stake_msg`](#generate_stake_msg)
    - [`fd_stake_ci_stake_msg_fini`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_fini)
    - [`check_destinations`](#check_destinations)
    - [`fd_stake_ci_dest_add_fini`](fd_stake_ci.c.driver.md#fd_stake_ci_dest_add_fini)
    - [`generate_dest_add`](#generate_dest_add)
    - [`fd_stake_ci_dest_add_init`](fd_stake_ci.c.driver.md#fd_stake_ci_dest_add_init)
    - [`fd_stake_ci_delete`](fd_stake_ci.c.driver.md#fd_stake_ci_delete)
    - [`fd_stake_ci_leave`](fd_stake_ci.c.driver.md#fd_stake_ci_leave)


---
### test\_ordering<!-- {{#callable:test_ordering}} -->
The `test_ordering` function tests the ordering and management of stake and destination messages in a stake cluster information system.
- **Inputs**: None
- **Control Flow**:
    - Initialize a stake cluster information object `info` using [`fd_stake_ci_join`](fd_stake_ci.c.driver.md#fd_stake_ci_join) and [`fd_stake_ci_new`](fd_stake_ci.c.driver.md#fd_stake_ci_new).
    - Generate a stake message for epoch 0 with stakers 'ABC' and initialize it in `info` using [`fd_stake_ci_stake_msg_init`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_init), then finalize it with [`fd_stake_ci_stake_msg_fini`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_fini).
    - Check the destinations for epoch 0 to ensure they match the expected staked and unstaked destinations using [`check_destinations`](#check_destinations).
    - Generate a stake message for epoch 1 with stakers 'BCA', initialize and finalize it, then check the destinations for both epoch 0 and 1.
    - Add new destinations 'EFG' using [`fd_stake_ci_dest_add_init`](fd_stake_ci.c.driver.md#fd_stake_ci_dest_add_init) and [`fd_stake_ci_dest_add_fini`](fd_stake_ci.c.driver.md#fd_stake_ci_dest_add_fini), then check the updated destinations for both epochs.
    - Add another set of destinations 'LKJ', finalize the addition, and check the updated destinations for both epochs.
    - Delete the stake cluster information object `info` using [`fd_stake_ci_leave`](fd_stake_ci.c.driver.md#fd_stake_ci_leave) and [`fd_stake_ci_delete`](fd_stake_ci.c.driver.md#fd_stake_ci_delete).
- **Output**: The function does not return any value; it performs tests and assertions to verify the correct ordering and management of stake and destination messages.
- **Functions called**:
    - [`fd_stake_ci_join`](fd_stake_ci.c.driver.md#fd_stake_ci_join)
    - [`fd_stake_ci_new`](fd_stake_ci.c.driver.md#fd_stake_ci_new)
    - [`fd_stake_ci_stake_msg_init`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_init)
    - [`generate_stake_msg`](#generate_stake_msg)
    - [`fd_stake_ci_stake_msg_fini`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_fini)
    - [`check_destinations`](#check_destinations)
    - [`fd_stake_ci_dest_add_fini`](fd_stake_ci.c.driver.md#fd_stake_ci_dest_add_fini)
    - [`generate_dest_add`](#generate_dest_add)
    - [`fd_stake_ci_dest_add_init`](fd_stake_ci.c.driver.md#fd_stake_ci_dest_add_init)
    - [`fd_stake_ci_delete`](fd_stake_ci.c.driver.md#fd_stake_ci_delete)
    - [`fd_stake_ci_leave`](fd_stake_ci.c.driver.md#fd_stake_ci_leave)


---
### test\_destaking<!-- {{#callable:test_destaking}} -->
The `test_destaking` function tests the behavior of staking and destination management in a cluster information system by simulating various staking and destination scenarios and verifying the expected outcomes.
- **Inputs**: None
- **Control Flow**:
    - Initialize a `fd_stake_ci_t` structure by joining a new cluster information instance with an identity key.
    - Generate and initialize a stake message for epoch 0 with stakers 'ABCDEF', finalize the message, and check the destinations to ensure 'ABCDEF' are staked and 'I' is unstaked.
    - Add a new destination 'ABCH', finalize the addition, and check the destinations to ensure 'ABCDEF' are staked and 'HI' is unstaked.
    - Generate and initialize a stake message for epoch 1 with stakers 'DCAF', finalize the message, and check the destinations for both epoch 0 and 1 to ensure the correct staked and unstaked destinations.
    - Generate and initialize a stake message for epoch 2 with staker 'H', finalize the message, and check the destinations for both epoch 1 and 2 to ensure the correct staked and unstaked destinations.
    - Generate and initialize a stake message for epoch 3 with staker 'A', finalize the message, and check the destinations for both epoch 2 and 3 to ensure the correct staked and unstaked destinations.
    - Delete the cluster information instance by leaving and deleting the `fd_stake_ci_t` structure.
- **Output**: The function does not return any value; it performs tests and assertions to verify the correctness of staking and destination management logic.
- **Functions called**:
    - [`fd_stake_ci_join`](fd_stake_ci.c.driver.md#fd_stake_ci_join)
    - [`fd_stake_ci_new`](fd_stake_ci.c.driver.md#fd_stake_ci_new)
    - [`fd_stake_ci_stake_msg_init`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_init)
    - [`generate_stake_msg`](#generate_stake_msg)
    - [`fd_stake_ci_stake_msg_fini`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_fini)
    - [`check_destinations`](#check_destinations)
    - [`fd_stake_ci_dest_add_fini`](fd_stake_ci.c.driver.md#fd_stake_ci_dest_add_fini)
    - [`generate_dest_add`](#generate_dest_add)
    - [`fd_stake_ci_dest_add_init`](fd_stake_ci.c.driver.md#fd_stake_ci_dest_add_init)
    - [`fd_stake_ci_delete`](fd_stake_ci.c.driver.md#fd_stake_ci_delete)
    - [`fd_stake_ci_leave`](fd_stake_ci.c.driver.md#fd_stake_ci_leave)


---
### test\_changing\_contact\_info<!-- {{#callable:test_changing_contact_info}} -->
The `test_changing_contact_info` function tests the process of changing contact information for stake destinations and verifies the correctness of the changes.
- **Inputs**: None
- **Control Flow**:
    - Initialize a stake cluster information object `info` using [`fd_stake_ci_join`](fd_stake_ci.c.driver.md#fd_stake_ci_join) and [`fd_stake_ci_new`](fd_stake_ci.c.driver.md#fd_stake_ci_new).
    - Generate and initialize a stake message for epoch 0 with staker 'A' using [`generate_stake_msg`](#generate_stake_msg) and [`fd_stake_ci_stake_msg_init`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_init), then finalize it with [`fd_stake_ci_stake_msg_fini`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_fini).
    - Verify the destinations for epoch 0 using [`check_destinations`](#check_destinations), expecting 'A' as staked and 'I' as unstaked.
    - Add new destinations 'AB' using [`fd_stake_ci_dest_add_init`](fd_stake_ci.c.driver.md#fd_stake_ci_dest_add_init), [`generate_dest_add`](#generate_dest_add), and [`fd_stake_ci_dest_add_fini`](fd_stake_ci.c.driver.md#fd_stake_ci_dest_add_fini), then verify the updated destinations with [`check_destinations`](#check_destinations).
    - Initialize a new set of destinations, modify their IP and port values, and finalize the addition using [`fd_stake_ci_dest_add_fini`](fd_stake_ci.c.driver.md#fd_stake_ci_dest_add_fini).
    - Retrieve the shred destination for slot 0 using [`fd_stake_ci_get_sdest_for_slot`](fd_stake_ci.c.driver.md#fd_stake_ci_get_sdest_for_slot) and verify the IP and port values of the destinations using `FD_TEST`.
    - Clean up by deleting the stake cluster information object using [`fd_stake_ci_delete`](fd_stake_ci.c.driver.md#fd_stake_ci_delete) and [`fd_stake_ci_leave`](fd_stake_ci.c.driver.md#fd_stake_ci_leave).
- **Output**: The function does not return any value; it performs tests and assertions to verify the correctness of contact information changes.
- **Functions called**:
    - [`fd_stake_ci_join`](fd_stake_ci.c.driver.md#fd_stake_ci_join)
    - [`fd_stake_ci_new`](fd_stake_ci.c.driver.md#fd_stake_ci_new)
    - [`fd_stake_ci_stake_msg_init`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_init)
    - [`generate_stake_msg`](#generate_stake_msg)
    - [`fd_stake_ci_stake_msg_fini`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_fini)
    - [`check_destinations`](#check_destinations)
    - [`fd_stake_ci_dest_add_fini`](fd_stake_ci.c.driver.md#fd_stake_ci_dest_add_fini)
    - [`generate_dest_add`](#generate_dest_add)
    - [`fd_stake_ci_dest_add_init`](fd_stake_ci.c.driver.md#fd_stake_ci_dest_add_init)
    - [`fd_stake_ci_get_sdest_for_slot`](fd_stake_ci.c.driver.md#fd_stake_ci_get_sdest_for_slot)
    - [`fd_shred_dest_idx_to_dest`](fd_shred_dest.h.driver.md#fd_shred_dest_idx_to_dest)
    - [`fd_stake_ci_delete`](fd_stake_ci.c.driver.md#fd_stake_ci_delete)
    - [`fd_stake_ci_leave`](fd_stake_ci.c.driver.md#fd_stake_ci_leave)


---
### test\_limits<!-- {{#callable:test_limits}} -->
The `test_limits` function tests the handling of cluster information and stake weights when they exceed predefined limits, ensuring that excess entries are truncated and managed correctly.
- **Inputs**: None
- **Control Flow**:
    - Initialize a stake cluster information object using [`fd_stake_ci_join`](fd_stake_ci.c.driver.md#fd_stake_ci_join) and [`fd_stake_ci_new`](fd_stake_ci.c.driver.md#fd_stake_ci_new).
    - Iterate over `stake_weight_cnt` from 40198 to 40201, setting up a `stake_msg_hdr_t` buffer with epoch, start slot, slot count, staked count, and excluded stake.
    - For each `stake_weight_cnt`, iterate over each stake weight, calculating the stake and populating the buffer with public keys and stakes, truncating and counting excess stakes as excluded.
    - Initialize and finalize the stake message using [`fd_stake_ci_stake_msg_init`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_init) and [`fd_stake_ci_stake_msg_fini`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_fini).
    - Iterate over `cluster_info_cnt` from 40198 to 40201, initializing destination weights and populating them with public keys, truncating excess entries.
    - Finalize the destination addition with [`fd_stake_ci_dest_add_fini`](fd_stake_ci.c.driver.md#fd_stake_ci_dest_add_fini), ensuring the count does not exceed 40199.
    - Perform tests using `FD_TEST` to verify the correct retrieval of scheduled destinations and leader schedules for the given slot.
    - Delete the stake cluster information object using [`fd_stake_ci_delete`](fd_stake_ci.c.driver.md#fd_stake_ci_delete) and [`fd_stake_ci_leave`](fd_stake_ci.c.driver.md#fd_stake_ci_leave).
- **Output**: The function does not return any value; it performs tests to ensure correct behavior when limits are exceeded.
- **Functions called**:
    - [`fd_stake_ci_join`](fd_stake_ci.c.driver.md#fd_stake_ci_join)
    - [`fd_stake_ci_new`](fd_stake_ci.c.driver.md#fd_stake_ci_new)
    - [`fd_stake_ci_stake_msg_init`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_init)
    - [`fd_stake_ci_stake_msg_fini`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_fini)
    - [`fd_stake_ci_dest_add_init`](fd_stake_ci.c.driver.md#fd_stake_ci_dest_add_init)
    - [`fd_stake_ci_dest_add_fini`](fd_stake_ci.c.driver.md#fd_stake_ci_dest_add_fini)
    - [`fd_stake_ci_get_sdest_for_slot`](fd_stake_ci.c.driver.md#fd_stake_ci_get_sdest_for_slot)
    - [`fd_stake_ci_get_lsched_for_slot`](fd_stake_ci.c.driver.md#fd_stake_ci_get_lsched_for_slot)
    - [`fd_stake_ci_delete`](fd_stake_ci.c.driver.md#fd_stake_ci_delete)
    - [`fd_stake_ci_leave`](fd_stake_ci.c.driver.md#fd_stake_ci_leave)


---
### test\_set\_identity<!-- {{#callable:test_set_identity}} -->
The `test_set_identity` function tests the behavior of setting a new identity in a stake cluster information context and verifies the correct migration of staked and unstaked destinations.
- **Inputs**: None
- **Control Flow**:
    - Initialize a stake cluster information context `info` using [`fd_stake_ci_join`](fd_stake_ci.c.driver.md#fd_stake_ci_join) and [`fd_stake_ci_new`](fd_stake_ci.c.driver.md#fd_stake_ci_new).
    - Generate and initialize a stake message with stakers 'ABCDEF' and finalize it using [`fd_stake_ci_stake_msg_init`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_init) and [`fd_stake_ci_stake_msg_fini`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_fini).
    - Add unstaked destinations 'ABCHJZ' using [`fd_stake_ci_dest_add_fini`](fd_stake_ci.c.driver.md#fd_stake_ci_dest_add_fini) and [`generate_dest_add`](#generate_dest_add).
    - Set a new identity 'N' and verify the migration of unstaked destinations using `fd_stake_ci_set_identity` and [`check_destinations`](#check_destinations).
    - Generate a new stake message with stakers 'ABCDN', finalize it, and verify the destinations.
    - Set a new identity 'H', verify the migration of staked to unstaked destinations, and check the results.
    - Set a new identity 'A', verify the migration of unstaked to staked destinations, and check the results.
    - Set a new identity 'B', verify the migration of staked to staked destinations, and check the results.
- **Output**: The function does not return any value; it performs tests and uses assertions to verify the correctness of identity setting and destination migrations.
- **Functions called**:
    - [`fd_stake_ci_join`](fd_stake_ci.c.driver.md#fd_stake_ci_join)
    - [`fd_stake_ci_new`](fd_stake_ci.c.driver.md#fd_stake_ci_new)
    - [`fd_stake_ci_stake_msg_init`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_init)
    - [`generate_stake_msg`](#generate_stake_msg)
    - [`fd_stake_ci_stake_msg_fini`](fd_stake_ci.c.driver.md#fd_stake_ci_stake_msg_fini)
    - [`fd_stake_ci_dest_add_fini`](fd_stake_ci.c.driver.md#fd_stake_ci_dest_add_fini)
    - [`generate_dest_add`](#generate_dest_add)
    - [`fd_stake_ci_dest_add_init`](fd_stake_ci.c.driver.md#fd_stake_ci_dest_add_init)
    - [`check_destinations`](#check_destinations)


---
### main<!-- {{#callable:main}} -->
The `main` function initializes the environment, calculates the maximum shred destination footprint, verifies it, sets up an identity key, and runs a series of tests to validate various staking and unstaking scenarios.
- **Inputs**:
    - `argc`: An integer representing the number of command-line arguments.
    - `argv`: An array of strings representing the command-line arguments.
- **Control Flow**:
    - Call `fd_boot` to initialize the environment with command-line arguments.
    - Initialize `max` to zero and iterate over possible staked values to calculate the maximum shred destination footprint using `fd_ulong_max` and [`fd_shred_dest_footprint`](fd_shred_dest.c.driver.md#fd_shred_dest_footprint).
    - Check if the calculated `max` matches `MAX_SHRED_DEST_FOOTPRINT` and log an error if it does not.
    - Set the `identity_key` to a predefined value using `memset`.
    - Sequentially call a series of test functions ([`test_staked_only`](#test_staked_only), [`test_unstaked_only`](#test_unstaked_only), etc.) to validate different staking scenarios.
    - Log a notice indicating the tests passed.
    - Call `fd_halt` to terminate the program.
- **Output**: The function returns an integer value `0`, indicating successful execution.
- **Functions called**:
    - [`fd_shred_dest_footprint`](fd_shred_dest.c.driver.md#fd_shred_dest_footprint)
    - [`test_staked_only`](#test_staked_only)
    - [`test_unstaked_only`](#test_unstaked_only)
    - [`test_transitions`](#test_transitions)
    - [`test_startup`](#test_startup)
    - [`test_skip_ahead`](#test_skip_ahead)
    - [`test_cancel`](#test_cancel)
    - [`test_ordering`](#test_ordering)
    - [`test_destaking`](#test_destaking)
    - [`test_changing_contact_info`](#test_changing_contact_info)
    - [`test_limits`](#test_limits)
    - [`test_set_identity`](#test_set_identity)


