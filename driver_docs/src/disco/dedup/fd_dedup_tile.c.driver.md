# Purpose
The provided C code is part of a software system designed to handle the deduplication of transaction streams. It is a specialized module that processes multiple input streams of transaction fragments, identifies duplicates, and presents a unified stream to consumers. The code is structured around a "dedup tile," which acts as a wrapper around a "mux tile," adding functionality to check transaction signatures for duplicates and filter them out. This deduplication process is crucial for ensuring that consumers receive a clean, non-redundant stream of transactions, which can be a mix of reliable and unreliable sources.

Key technical components include the `fd_dedup_ctx_t` structure, which maintains the state necessary for deduplication, including transaction caches and metrics for tracking deduplication failures. The code also defines several inline functions, such as [`during_frag`](#during_frag) and [`after_frag`](#after_frag), which handle the processing of transaction fragments, including bounds checking, signature parsing, and deduplication logic. The module is designed to be integrated into a larger system, as indicated by its use of external headers and its definition of a `fd_topo_run_tile_t` structure, which specifies initialization and execution functions for the deduplication tile. This code is not a standalone executable but rather a component intended to be part of a larger application, providing a specific service within a broader transaction processing pipeline.
# Imports and Dependencies

---
- `../tiles.h`
- `generated/fd_dedup_tile_seccomp.h`
- `../verify/fd_verify_tile.h`
- `../metrics/fd_metrics.h`
- `linux/unistd.h`
- `../stem/fd_stem.c`


# Global Variables

---
### fd\_tile\_dedup
- **Type**: `fd_topo_run_tile_t`
- **Description**: The `fd_tile_dedup` is a global variable of type `fd_topo_run_tile_t`, which is a structure that encapsulates the configuration and operational functions for a deduplication tile in a network topology. This tile is responsible for deduplicating multiple streams of input fragments and presenting them to consumers as if they were generated by a single producer, while also checking for duplicate transaction signatures and filtering them out.
- **Use**: This variable is used to define and manage the deduplication tile's behavior, including its initialization, security policies, and execution within the network topology.


# Data Structures

---
### fd\_dedup\_in\_ctx\_t
- **Type**: `struct`
- **Members**:
    - `mem`: A pointer to an fd_wksp_t structure, representing the memory workspace associated with the context.
    - `chunk0`: An unsigned long integer representing the starting chunk index in the memory workspace.
    - `wmark`: An unsigned long integer representing the watermark or the upper limit of the chunk index in the memory workspace.
- **Description**: The `fd_dedup_in_ctx_t` structure is a context object used for each input (producer) memory cache connected to the deduplication tile. It holds information about the memory workspace, the starting chunk index, and the watermark, which defines the range of valid chunks in the workspace. This structure is essential for managing and tracking the state of input streams in the deduplication process, ensuring that data is correctly processed and deduplicated.


---
### fd\_dedup\_ctx\_t
- **Type**: `struct`
- **Members**:
    - `tcache_depth`: Represents the depth of the deduplication's transaction cache.
    - `tcache_map_cnt`: Indicates the number of slots used for the transaction cache map.
    - `tcache_sync`: Points to the local join to the oldest key in the transaction cache.
    - `tcache_ring`: Pointer to the transaction cache ring structure.
    - `tcache_map`: Pointer to the transaction cache map structure.
    - `in_kind`: Array indicating the kind of input for each producer mcache connected to the dedup tile.
    - `in`: Array of input contexts for each producer mcache connected to the dedup tile.
    - `bundle_failed`: Flag indicating if the current bundle has failed.
    - `bundle_id`: Identifier for the current transaction bundle.
    - `bundle_idx`: Index within the current transaction bundle.
    - `bundle_signatures`: Array storing signatures of transactions within the current bundle.
    - `out_mem`: Pointer to the workspace memory for output transactions.
    - `out_chunk0`: Initial chunk index for output transactions.
    - `out_wmark`: Watermark for output transactions.
    - `out_chunk`: Current chunk index for output transactions.
    - `hashmap_seed`: Seed value used for hashing in deduplication.
    - `metrics`: Structure containing metrics for bundle peer failures and deduplication failures.
- **Description**: The `fd_dedup_ctx_t` structure is a context object used in the deduplication process of transaction streams. It manages the state and configuration necessary for deduplicating multiple input streams and presenting them as a single output stream. The structure includes fields for managing transaction cache depth and mapping, input contexts for each producer, bundle management, output memory handling, and metrics tracking. It is designed to facilitate the deduplication of transactions by checking for duplicates and filtering them out, ensuring that only unique transactions are processed further.


# Functions

---
### scratch\_align<!-- {{#callable:scratch_align}} -->
The `scratch_align` function returns the alignment requirement of the `fd_dedup_ctx_t` structure.
- **Inputs**: None
- **Control Flow**:
    - The function uses the `alignof` operator to determine the alignment requirement of the `fd_dedup_ctx_t` type.
    - It returns this alignment value as an unsigned long integer.
- **Output**: The function returns an unsigned long integer representing the alignment requirement of the `fd_dedup_ctx_t` structure.


---
### scratch\_footprint<!-- {{#callable:scratch_footprint}} -->
The `scratch_footprint` function calculates the memory footprint required for a deduplication context and its associated tcache based on the given tile's configuration.
- **Inputs**:
    - `tile`: A pointer to a `fd_topo_tile_t` structure, which contains configuration details for the deduplication tile, including the tcache depth.
- **Control Flow**:
    - Initialize a variable `l` with `FD_LAYOUT_INIT` to start the layout calculation.
    - Append the size and alignment of `fd_dedup_ctx_t` to `l` using `FD_LAYOUT_APPEND`.
    - Append the footprint of the tcache, calculated using `fd_tcache_footprint` with the tcache depth from the tile, to `l` using `FD_LAYOUT_APPEND`.
    - Finalize the layout calculation with `FD_LAYOUT_FINI`, using the alignment of `fd_dedup_ctx_t`, and return the result.
- **Output**: Returns an `ulong` representing the total memory footprint required for the deduplication context and its tcache.
- **Functions called**:
    - [`scratch_align`](#scratch_align)


---
### metrics\_write<!-- {{#callable:metrics_write}} -->
The `metrics_write` function updates the deduplication metrics by setting the transaction bundle peer failure and deduplication failure counts in the metrics system.
- **Inputs**:
    - `ctx`: A pointer to an `fd_dedup_ctx_t` structure, which contains the deduplication context and metrics to be updated.
- **Control Flow**:
    - The function takes a single argument, `ctx`, which is a pointer to an `fd_dedup_ctx_t` structure.
    - It uses the `FD_MCNT_SET` macro to update the `TRANSACTION_BUNDLE_PEER_FAILURE` metric with the value of `ctx->metrics.bundle_peer_failure_cnt`.
    - It uses the `FD_MCNT_SET` macro to update the `TRANSACTION_DEDUP_FAILURE` metric with the value of `ctx->metrics.dedup_fail_cnt`.
- **Output**: The function does not return any value; it updates the metrics system with the current failure counts from the context.


---
### during\_frag<!-- {{#callable:during_frag}} -->
The `during_frag` function performs bounds checking and data copying for incoming data fragments, ensuring they are within valid ranges and handling them based on their type.
- **Inputs**:
    - `ctx`: A pointer to the `fd_dedup_ctx_t` context structure, which contains state information for the deduplication process.
    - `in_idx`: An index indicating which input stream (or producer) the fragment is coming from.
    - `seq`: A sequence number for the fragment, marked as unused in this function.
    - `sig`: A signature for the fragment, marked as unused in this function.
    - `chunk`: The chunk identifier for the fragment, used to locate the data in memory.
    - `sz`: The size of the fragment in bytes.
    - `ctl`: A control parameter for the fragment, marked as unused in this function.
- **Control Flow**:
    - Check if the `chunk` is within the valid range defined by `chunk0` and `wmark` for the input stream, and if `sz` is less than or equal to `FD_TPU_PARSED_MTU`; log an error if not.
    - Convert the `chunk` identifier to a memory address for both the source (`src`) and destination (`dst`).
    - Check if the input kind is `IN_KIND_GOSSIP`; if so, ensure `sz` is less than or equal to `FD_TPU_MTU` and log an error if not.
    - If the input kind is `IN_KIND_GOSSIP`, set the payload size in the destination transaction structure, copy the data from `src` to the payload, and set the `bundle_id` to 0.
    - If the input kind is not `IN_KIND_GOSSIP`, simply copy the data from `src` to `dst`.
- **Output**: The function does not return a value; it performs operations on the data in memory and logs errors if conditions are not met.


---
### after\_frag<!-- {{#callable:after_frag}} -->
The `after_frag` function processes a transaction fragment after it has been fully received, checking for duplicates and handling deduplication logic.
- **Inputs**:
    - `ctx`: A pointer to the `fd_dedup_ctx_t` context structure containing state information for deduplication.
    - `in_idx`: An index indicating the input source of the transaction fragment.
    - `seq`: The sequence number of the transaction fragment (unused in this function).
    - `sig`: The signature of the transaction fragment (unused in this function).
    - `sz`: The size of the transaction fragment (unused in this function).
    - `tsorig`: The original timestamp of the transaction fragment.
    - `_tspub`: The publication timestamp of the transaction fragment (unused in this function).
    - `stem`: A pointer to the `fd_stem_context_t` structure used for publishing the transaction.
- **Control Flow**:
    - The function begins by casting the output memory chunk to a transaction memory structure (`fd_txn_m_t`).
    - It checks if the transaction belongs to a different bundle than the current context and resets the bundle state if necessary.
    - If the transaction is part of a failed bundle, it increments the bundle peer failure count and exits.
    - If the transaction is from a gossip link, it parses the transaction to extract the signature for deduplication.
    - It checks if the transaction is a duplicate by computing a hash of the signature and checking against a transaction cache or bundle signatures.
    - If the transaction is a duplicate, it increments the deduplication failure count and marks the bundle as failed if applicable.
    - If the transaction is not a duplicate, it calculates the realized size, computes a publication timestamp, publishes the transaction, and updates the output chunk.
- **Output**: The function does not return a value; it modifies the context and metrics to reflect the deduplication process and publishes the transaction if it is not a duplicate.


---
### privileged\_init<!-- {{#callable:privileged_init}} -->
The `privileged_init` function initializes a deduplication context for a tile in a topology, setting up memory allocation and seeding a random number generator for secure operations.
- **Inputs**:
    - `topo`: A pointer to an `fd_topo_t` structure representing the topology configuration.
    - `tile`: A pointer to an `fd_topo_tile_t` structure representing the specific tile configuration within the topology.
- **Control Flow**:
    - Retrieve a local address for the tile object using `fd_topo_obj_laddr` with the provided topology and tile object ID.
    - Initialize a scratch memory allocator using `FD_SCRATCH_ALLOC_INIT`.
    - Allocate memory for a `fd_dedup_ctx_t` structure using `FD_SCRATCH_ALLOC_APPEND`, ensuring proper alignment and size.
    - Securely generate a random seed for the `hashmap_seed` field of the context using `fd_rng_secure`.
- **Output**: The function does not return a value; it initializes the deduplication context in the provided memory space.


---
### unprivileged\_init<!-- {{#callable:unprivileged_init}} -->
The `unprivileged_init` function initializes the deduplication context and transaction cache for a tile in a topology, setting up input and output memory contexts and ensuring proper memory allocation.
- **Inputs**:
    - `topo`: A pointer to an `fd_topo_t` structure representing the topology configuration.
    - `tile`: A pointer to an `fd_topo_tile_t` structure representing the specific tile configuration within the topology.
- **Control Flow**:
    - Allocate scratch memory for the deduplication context using `fd_topo_obj_laddr` and `FD_SCRATCH_ALLOC_INIT`.
    - Append a new `fd_dedup_ctx_t` context to the scratch memory using `FD_SCRATCH_ALLOC_APPEND`.
    - Create and join a new transaction cache (`tcache`) using `fd_tcache_new` and `fd_tcache_join`, and handle errors if `tcache` creation fails.
    - Initialize the deduplication context (`ctx`) fields such as `bundle_failed`, `bundle_id`, `bundle_idx`, and `metrics`.
    - Set up the transaction cache parameters in the context (`ctx`) using `fd_tcache_depth`, `fd_tcache_map_cnt`, `fd_tcache_oldest_laddr`, `fd_tcache_ring_laddr`, and `fd_tcache_map_laddr`.
    - Verify the number of input links does not exceed the context's capacity using `FD_TEST`.
    - For each input link, retrieve the link and workspace information, and initialize the input context (`ctx->in`) with memory, chunk, and watermark values.
    - Determine the kind of each input link (GOSSIP or VERIFY) and store it in `ctx->in_kind`, logging an error if the link name is unexpected.
    - Set up the output memory context (`ctx->out_mem`, `ctx->out_chunk0`, `ctx->out_wmark`, `ctx->out_chunk`) using the topology's output link information.
    - Finalize the scratch memory allocation with `FD_SCRATCH_ALLOC_FINI` and check for memory overflow, logging an error if overflow occurs.
- **Output**: The function does not return a value; it initializes the deduplication context and transaction cache for the specified tile.
- **Functions called**:
    - [`scratch_footprint`](#scratch_footprint)


---
### populate\_allowed\_seccomp<!-- {{#callable:populate_allowed_seccomp}} -->
The `populate_allowed_seccomp` function populates a seccomp filter policy for a deduplication tile and returns the instruction count of the policy.
- **Inputs**:
    - `topo`: A pointer to a constant `fd_topo_t` structure, representing the topology configuration.
    - `tile`: A pointer to a constant `fd_topo_tile_t` structure, representing the tile configuration.
    - `out_cnt`: An unsigned long integer representing the count of output filters to be populated.
    - `out`: A pointer to a `struct sock_filter` array where the seccomp filter policy will be populated.
- **Control Flow**:
    - The function begins by explicitly ignoring the `topo` and `tile` parameters, indicating they are not used in the function body.
    - It calls the [`populate_sock_filter_policy_fd_dedup_tile`](generated/fd_dedup_tile_seccomp.h.driver.md#populate_sock_filter_policy_fd_dedup_tile) function with `out_cnt`, `out`, and the file descriptor obtained from `fd_log_private_logfile_fd()` to populate the seccomp filter policy.
    - The function returns the value of `sock_filter_policy_fd_dedup_tile_instr_cnt`, which presumably represents the number of instructions in the populated seccomp filter policy.
- **Output**: The function returns an unsigned long integer representing the instruction count of the populated seccomp filter policy.
- **Functions called**:
    - [`populate_sock_filter_policy_fd_dedup_tile`](generated/fd_dedup_tile_seccomp.h.driver.md#populate_sock_filter_policy_fd_dedup_tile)


---
### populate\_allowed\_fds<!-- {{#callable:populate_allowed_fds}} -->
The `populate_allowed_fds` function populates an array with file descriptors that are allowed for use, specifically including standard error and optionally a log file descriptor.
- **Inputs**:
    - `topo`: A pointer to a constant `fd_topo_t` structure, which is not used in this function.
    - `tile`: A pointer to a constant `fd_topo_tile_t` structure, which is not used in this function.
    - `out_fds_cnt`: An unsigned long integer representing the maximum number of file descriptors that can be stored in the `out_fds` array.
    - `out_fds`: A pointer to an integer array where the allowed file descriptors will be stored.
- **Control Flow**:
    - The function begins by casting `topo` and `tile` to void to indicate they are unused.
    - It checks if `out_fds_cnt` is less than 2, and if so, logs an error and terminates the program.
    - Initializes `out_cnt` to 0 and assigns the file descriptor for standard error (2) to `out_fds[0]`, then increments `out_cnt`.
    - Checks if the log file descriptor is valid (not -1) using `fd_log_private_logfile_fd()`, and if valid, assigns it to `out_fds[out_cnt]` and increments `out_cnt`.
    - Returns the count of file descriptors added to `out_fds`.
- **Output**: The function returns an unsigned long integer representing the number of file descriptors that have been populated in the `out_fds` array.


