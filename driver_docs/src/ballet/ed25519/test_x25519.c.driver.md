# Purpose
This C source code file is designed to test and benchmark the X25519 elliptic curve Diffie-Hellman (ECDH) key exchange protocol. The file includes test vectors, simulation functions, and benchmarking routines to ensure the correctness and performance of the X25519 implementation. It imports necessary headers for X25519 operations and hexadecimal formatting, and it includes a test suite from "test_x25519_wycheproof.c" to verify the implementation against known test cases. The code defines a structure `fd_x25519_test_vector` to hold test vectors, which are used to validate the key exchange process by comparing computed shared secrets against expected values.

The main function initializes a random number generator and executes a series of tests and benchmarks. It first verifies the implementation using predefined test vectors and Wycheproof test cases, which are a set of cryptographic test vectors designed to check for vulnerabilities. The code then simulates multiple ECDH exchanges to ensure robustness and logs the results. Additionally, it benchmarks the key exchange and public key derivation processes by measuring the time taken to perform a large number of operations, providing performance metrics in terms of operations per second and time per call. The file is structured as an executable program, with a clear focus on testing and performance evaluation of the X25519 cryptographic operations.
# Imports and Dependencies

---
- `fd_x25519.h`
- `../hex/fd_hex.h`
- `test_x25519_wycheproof.c`


# Global Variables

---
### test\_x25519\_vector
- **Type**: ``fd_x25519_test_vector_t[]``
- **Description**: The `test_x25519_vector` is a static constant array of `fd_x25519_test_vector_t` structures, each containing three 32-byte arrays: `self`, `peer`, and `secret`. These arrays represent test vectors for the X25519 elliptic curve Diffie-Hellman (ECDH) key exchange, with `self` and `peer` being the private and public keys, respectively, and `secret` being the expected shared secret.
- **Use**: This variable is used to validate the correctness of the X25519 ECDH implementation by comparing computed shared secrets against expected values.


# Data Structures

---
### fd\_x25519\_test\_vector
- **Type**: `struct`
- **Members**:
    - `self`: An array of 32 unsigned characters representing the private key of the entity itself.
    - `peer`: An array of 32 unsigned characters representing the public key of the peer entity.
    - `secret`: An array of 32 unsigned characters representing the shared secret derived from the key exchange.
- **Description**: The `fd_x25519_test_vector` structure is used to store test vectors for the X25519 key exchange algorithm, which is a Diffie-Hellman function over the Curve25519 elliptic curve. It contains three 32-byte arrays: `self` for the private key of the entity, `peer` for the public key of the peer, and `secret` for the resulting shared secret after the key exchange. This structure is primarily used for testing and verifying the correctness of the X25519 implementation.


---
### fd\_x25519\_test\_vector\_t
- **Type**: `struct`
- **Members**:
    - `self`: An array of 32 unsigned characters representing the private key of the entity itself.
    - `peer`: An array of 32 unsigned characters representing the public key of the peer entity.
    - `secret`: An array of 32 unsigned characters representing the shared secret derived from the key exchange.
- **Description**: The `fd_x25519_test_vector_t` structure is used to represent test vectors for the X25519 key exchange algorithm. It contains three 32-byte arrays: `self`, `peer`, and `secret`. The `self` array holds the private key of the entity, the `peer` array holds the public key of the peer, and the `secret` array holds the expected shared secret resulting from the key exchange. This structure is primarily used for testing and verifying the correctness of the X25519 implementation by comparing the computed shared secret with the expected value.


# Functions

---
### simulate\_ecdh<!-- {{#callable:simulate_ecdh}} -->
The `simulate_ecdh` function simulates an Elliptic Curve Diffie-Hellman (ECDH) key exchange using random secret keys to generate public keys and shared secrets, and verifies the consistency of the shared secrets.
- **Inputs**:
    - `rng`: A pointer to a random number generator object (`fd_rng_t`) used to generate random bytes for the secret keys.
- **Control Flow**:
    - Initialize two 32-byte arrays `secret0` and `secret1` with random bytes using the `fd_rng_uchar` function.
    - Generate public keys `pubkey0` and `pubkey1` from `secret0` and `secret1` respectively using the `fd_x25519_public` function.
    - Compute shared secrets `_shared0` and `_shared1` using the `fd_x25519_exchange` function with the opposite public key and secret key pairs.
    - Check if either `shared0` or `shared1` is NULL, indicating a failure in the key exchange, and log an error if so.
    - Compare the two shared secrets using `memcmp` to ensure they are identical, logging an error if they differ.
- **Output**: The function does not return a value but logs errors if the shared secrets are inconsistent or if the key exchange fails.


---
### log\_bench<!-- {{#callable:log_bench}} -->
The `log_bench` function logs the performance metrics of a benchmark, specifically the rate of operations per second per core and the average time per call, using the provided description, iteration count, and elapsed time.
- **Inputs**:
    - `descr`: A constant character pointer representing the description of the benchmark being logged.
    - `iter`: An unsigned long integer representing the number of iterations or operations performed during the benchmark.
    - `dt`: A long integer representing the elapsed time in some time unit (likely microseconds) for the benchmark.
- **Control Flow**:
    - Calculate the operations per second per core (`khz`) by multiplying 1,000,000 by the number of iterations and dividing by the elapsed time.
    - Calculate the average time per call (`tau`) by dividing the elapsed time by the number of iterations.
    - Log the description, operations per second per core, and average time per call using the `FD_LOG_NOTICE` macro.
- **Output**: The function does not return any value; it logs the benchmark results using a logging macro.


---
### test\_wycheproofs<!-- {{#callable:test_wycheproofs}} -->
The `test_wycheproofs` function validates the correctness of the X25519 key exchange implementation against a set of predefined test vectors from the Wycheproof project.
- **Inputs**: None
- **Control Flow**:
    - Initialize a character array `cstr` for logging purposes.
    - Declare a 32-byte array `shared` to store the shared secret generated by the key exchange.
    - Iterate over each test vector in `x25519_verify_wycheproofs` until a test vector with a null comment is encountered.
    - For each test vector, perform the X25519 key exchange using `fd_x25519_exchange` with the private and public keys from the test vector, storing the result in `shared`.
    - Check if the result of the key exchange matches the expected outcome (`proof->ok`) and log the result using `FD_TEST_CUSTOM`.
    - If the test vector expects a successful exchange (`proof->ok` is true), verify that the computed shared secret matches the expected shared secret (`proof->shared`) and log the result.
    - After all test vectors are processed, log a notice indicating the completion of the Wycheproof tests.
- **Output**: The function does not return a value; it logs the results of the tests and any discrepancies found during the validation process.


---
### main<!-- {{#callable:main}} -->
The `main` function initializes the environment, tests X25519 key exchange using predefined vectors, simulates ECDH exchanges, and benchmarks key exchange and public key derivation operations.
- **Inputs**:
    - `argc`: The number of command-line arguments.
    - `argv`: An array of command-line argument strings.
- **Control Flow**:
    - Initialize the environment with `fd_boot` and set up a random number generator `rng`.
    - Call [`test_wycheproofs`](#test_wycheproofs) to verify X25519 key exchange against known test vectors.
    - Iterate over `test_x25519_vector` to perform X25519 key exchanges and compare results with expected secrets, logging errors if mismatches occur.
    - Simulate 10,000 ECDH key exchanges using [`simulate_ecdh`](#simulate_ecdh) and log the result.
    - Generate random secret keys `secret0` and `secret1`, derive their public keys `pubkey0` and `pubkey1`, and prepare for benchmarking.
    - Benchmark the X25519 key exchange by repeatedly exchanging keys and measuring the time taken, logging the performance.
    - Benchmark the public key derivation by modifying `secret0` and deriving `pubkey0` repeatedly, measuring the time taken, and logging the performance.
    - Clean up the random number generator and log a success message before halting the program.
- **Output**: The function returns an integer `0` indicating successful execution.
- **Functions called**:
    - [`test_wycheproofs`](#test_wycheproofs)
    - [`simulate_ecdh`](#simulate_ecdh)
    - [`log_bench`](#log_bench)


