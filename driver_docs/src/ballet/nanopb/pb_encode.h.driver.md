# Purpose
The `pb_encode.h` file is a C header file that provides the interface for encoding protocol buffer messages using the Nanopb library. It defines the structures and functions necessary for converting C structures into the protocol buffer binary format, which is a compact and efficient way to serialize structured data. The primary function, [`pb_encode`](#pb_encode), is responsible for encoding a single protocol buffer message from a C structure into a specified output stream. This file also includes an extended version of the encoding function, [`pb_encode_ex`](#pb_encode_ex), which offers additional options for controlling the encoding process, such as prepending the message length or appending a null byte for termination.

The header file defines a custom output stream structure, `pb_ostream_s`, which allows users to specify how and where the encoded data should be written, such as to a file or a network socket. It also provides several helper functions for encoding different data types and field headers, as well as for manipulating streams. These functions include [`pb_encode_varint`](#pb_encode_varint), [`pb_encode_string`](#pb_encode_string), and [`pb_encode_fixed32`](#pb_encode_fixed32), among others. The file is designed to be used in conjunction with `pb_encode.c`, and it requires field descriptions generated by the `nanopb_generator.py` script. Overall, `pb_encode.h` serves as a crucial component for developers looking to implement protocol buffer encoding in their C applications using the Nanopb library.
# Imports and Dependencies

---
- `pb_firedancer.h`


# Data Structures

---
### pb\_ostream\_s
- **Type**: `struct`
- **Members**:
    - `callback`: A function pointer used for writing bytes to a storage medium, or an int pointer in buffer-only configuration.
    - `state`: A void pointer used by the callback function to store custom data.
    - `max_size`: Specifies the maximum number of bytes that can be written to the stream.
    - `bytes_written`: Tracks the number of bytes that have been written to the stream so far.
    - `errmsg`: A pointer to a constant string that holds an error message when decoding fails.
- **Description**: The `pb_ostream_s` structure is used to define custom output streams for encoding protocol buffers in C. It includes a callback function for writing data, a state pointer for storing custom data, and fields to manage the size and track the number of bytes written. The structure is designed to be flexible, allowing for different configurations depending on whether the buffer-only mode is enabled. It also includes an optional error message field for handling decoding errors.


# Function Declarations (Public API)

---
### pb\_get\_encoded\_size<!-- {{#callable_declaration:pb_get_encoded_size}} -->
Calculate the size of an encoded protocol buffer message.
- **Description**: Use this function to determine the size of a protocol buffer message when encoded, without actually encoding the data. This is useful for allocating the correct amount of memory for the encoded message. The function requires a valid message descriptor and a source structure that matches the descriptor. It returns false if encoding fails, which may occur if the source structure does not match the descriptor or if there are other encoding errors.
- **Inputs**:
    - `size`: A pointer to a size_t variable where the function will store the size of the encoded message. Must not be null.
    - `fields`: A pointer to a pb_msgdesc_t structure that describes the fields of the message to be encoded. Must not be null.
    - `src_struct`: A pointer to the source structure containing the data to be encoded. This structure must match the description provided in fields. Must not be null.
- **Output**: Returns true if the size calculation is successful and false if there is an error during encoding.
- **See also**: [`pb_get_encoded_size`](pb_encode.c.driver.md#pb_get_encoded_size)  (Implementation)


---
### pb\_ostream\_from\_buffer<!-- {{#callable_declaration:pb_ostream_from_buffer}} -->
Create an output stream for writing into a memory buffer.
- **Description**: Use this function to initialize a `pb_ostream_t` structure for encoding protocol buffer messages directly into a memory buffer. This function is typically called before encoding a message to ensure that the output stream is properly set up. The stream will track the number of bytes written, and it is important to ensure that the buffer provided is large enough to hold the encoded message. This function is essential for applications that need to encode data into a pre-allocated memory space.
- **Inputs**:
    - `buf`: A pointer to the memory buffer where the encoded data will be written. The buffer must be allocated by the caller and must not be null.
    - `bufsize`: The size of the buffer in bytes. It defines the maximum number of bytes that can be written to the buffer.
- **Output**: Returns a `pb_ostream_t` structure initialized to write to the provided buffer, with `bytes_written` set to 0.
- **See also**: [`pb_ostream_from_buffer`](pb_encode.c.driver.md#pb_ostream_from_buffer)  (Implementation)


---
### pb\_encode\_tag\_for\_field<!-- {{#callable_declaration:pb_encode_tag_for_field}} -->
Encodes a field header based on its type and field number.
- **Description**: Use this function to encode the header of a protocol buffer field before writing its contents. It determines the appropriate wire type based on the field's type and encodes the field's tag into the provided output stream. This function should be called from a callback before writing out the field contents. It is essential to ensure that the field type is valid, as invalid types will result in an error and the function will return false.
- **Inputs**:
    - `stream`: A pointer to a `pb_ostream_t` structure representing the output stream where the encoded tag will be written. The stream must be properly initialized and must not be null.
    - `field`: A pointer to a `pb_field_iter_t` structure representing the field to be encoded. This structure must contain valid type and tag information, and must not be null.
- **Output**: Returns true if the field header is successfully encoded and written to the stream; returns false if an invalid field type is encountered or if writing to the stream fails.
- **See also**: [`pb_encode_tag_for_field`](pb_encode.c.driver.md#pb_encode_tag_for_field)  (Implementation)


---
### pb\_encode\_float\_as\_double<!-- {{#callable_declaration:pb_encode_float_as_double}} -->
Encodes a float value as a double into a protocol buffer stream.
- **Description**: Use this function to encode a 32-bit float value as a 64-bit double in a protocol buffer stream. This is useful when you need to ensure that a float is represented with double precision in the encoded message. The function must be called with a valid output stream that has been properly initialized. It handles special float values like NaN and zero, ensuring they are correctly encoded as doubles. The function returns a boolean indicating success or failure, which can occur if the stream encounters an I/O error.
- **Inputs**:
    - `stream`: A pointer to a pb_ostream_t structure representing the output stream. The stream must be initialized and ready for writing. The caller retains ownership and must ensure it is not null.
    - `value`: A float value to be encoded as a double. There are no restrictions on the value, as special cases like NaN and zero are handled internally.
- **Output**: Returns true if the float was successfully encoded as a double into the stream, or false if an I/O error occurred during the encoding process.
- **See also**: [`pb_encode_float_as_double`](pb_encode.c.driver.md#pb_encode_float_as_double)  (Implementation)


